<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 25220:c680423af71f9cc93a50876c0218967b85a8995b</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ c680423af71f9cc93a50876c0218967b85a8995b" />
<meta property="og:url" content="/comm-central/rev/c680423af71f9cc93a50876c0218967b85a8995b" />
<meta property="og:description" content="Bug 1498041 - Turn on ESLint in mail/base; r=aceman" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / c680423af71f9cc93a50876c0218967b85a8995b 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/c680423af71f9cc93a50876c0218967b85a8995b">shortlog</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/c680423af71f9cc93a50876c0218967b85a8995b">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b">files</a> |
changeset |
<a href="/comm-central/raw-rev/c680423af71f9cc93a50876c0218967b85a8995b">raw</a>  | <a href="/comm-central/archive/c680423af71f9cc93a50876c0218967b85a8995b.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1498041">Bug 1498041</a> - Turn on ESLint in mail/base; r=aceman
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Sun, 18 Nov 2018 23:31:01 +1300</td></tr>

<tr>
 <td>changeset 25220</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/c680423af71f9cc93a50876c0218967b85a8995b">c680423af71f9cc93a50876c0218967b85a8995b</a></td>
</tr>



<tr>
<td>parent 25219</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/ffda4a36eba4288f242646b7ebc89a0dcf96019e">ffda4a36eba4288f242646b7ebc89a0dcf96019e</a>
</td>
</tr>

<tr>
<td>child 25221</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/38c2cc49dccc59a155c9060ef557dcadc2b978d3">38c2cc49dccc59a155c9060ef557dcadc2b978d3</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=c680423af71f9cc93a50876c0218967b85a8995b">15138</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Sun, 18 Nov 2018 10:32:24 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@c680423af71f [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=c680423af71f9cc93a50876c0218967b85a8995b">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=c680423af71f9cc93a50876c0218967b85a8995b&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c680423af71f9cc93a50876c0218967b85a8995b&newProject=comm-central&newRevision=c680423af71f9cc93a50876c0218967b85a8995b&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c680423af71f9cc93a50876c0218967b85a8995b&newProject=comm-central&newRevision=c680423af71f9cc93a50876c0218967b85a8995b&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c680423af71f9cc93a50876c0218967b85a8995b&newProject=comm-central&newRevision=c680423af71f9cc93a50876c0218967b85a8995b&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28aceman%29&revcount=50">aceman</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1498041">1498041</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1498041">Bug 1498041</a> - Turn on ESLint in mail/base; r=aceman</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/.eslintignore">.eslintignore</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/.eslintignore">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/.eslintignore">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/.eslintignore">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/.eslintignore">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/.eslintignore">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/.eslintrc.js">mail/base/content/.eslintrc.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/.eslintrc.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/.eslintrc.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/.eslintrc.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/.eslintrc.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/.eslintrc.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/ABSearchDialog.js">mail/base/content/ABSearchDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/ABSearchDialog.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/ABSearchDialog.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/ABSearchDialog.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/ABSearchDialog.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/ABSearchDialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/FilterListDialog.js">mail/base/content/FilterListDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/FilterListDialog.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/FilterListDialog.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/FilterListDialog.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/FilterListDialog.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/FilterListDialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/SearchDialog.js">mail/base/content/SearchDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/SearchDialog.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/SearchDialog.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/SearchDialog.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/SearchDialog.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/SearchDialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/aboutAddonsExtra.js">mail/base/content/aboutAddonsExtra.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/aboutAddonsExtra.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/aboutAddonsExtra.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/aboutAddonsExtra.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/aboutAddonsExtra.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/aboutAddonsExtra.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/aboutDialog-appUpdater.js">mail/base/content/aboutDialog-appUpdater.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/aboutDialog-appUpdater.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/aboutDialog-appUpdater.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/aboutDialog-appUpdater.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/aboutDialog-appUpdater.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/aboutDialog-appUpdater.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/aboutDialog.js">mail/base/content/aboutDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/aboutDialog.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/aboutDialog.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/aboutDialog.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/aboutDialog.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/aboutDialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/browserRequest.js">mail/base/content/browserRequest.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/browserRequest.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/browserRequest.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/browserRequest.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/browserRequest.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/browserRequest.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/commandglue.js">mail/base/content/commandglue.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/commandglue.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/commandglue.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/commandglue.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/commandglue.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/commandglue.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/contentAreaClick.js">mail/base/content/contentAreaClick.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/contentAreaClick.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/contentAreaClick.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/contentAreaClick.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/contentAreaClick.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/contentAreaClick.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/editContactPanel.js">mail/base/content/editContactPanel.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/editContactPanel.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/editContactPanel.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/editContactPanel.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/editContactPanel.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/editContactPanel.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/folderDisplay.js">mail/base/content/folderDisplay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/folderDisplay.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/folderDisplay.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/folderDisplay.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/folderDisplay.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/folderDisplay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/folderPane.js">mail/base/content/folderPane.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/folderPane.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/folderPane.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/folderPane.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/folderPane.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/folderPane.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/foldersummary.js">mail/base/content/foldersummary.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/foldersummary.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/foldersummary.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/foldersummary.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/foldersummary.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/foldersummary.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/glodaFacetBindings.xml">mail/base/content/glodaFacetBindings.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/glodaFacetBindings.xml">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/glodaFacetBindings.xml">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/glodaFacetBindings.xml">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/glodaFacetBindings.xml">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/glodaFacetBindings.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/glodaFacetTab.js">mail/base/content/glodaFacetTab.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/glodaFacetTab.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/glodaFacetTab.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/glodaFacetTab.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/glodaFacetTab.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/glodaFacetTab.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/glodaFacetView.js">mail/base/content/glodaFacetView.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/glodaFacetView.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/glodaFacetView.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/glodaFacetView.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/glodaFacetView.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/glodaFacetView.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/glodaFacetVis.js">mail/base/content/glodaFacetVis.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/glodaFacetVis.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/glodaFacetVis.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/glodaFacetVis.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/glodaFacetVis.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/glodaFacetVis.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/hiddenWindow.js">mail/base/content/hiddenWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/hiddenWindow.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/hiddenWindow.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/hiddenWindow.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/hiddenWindow.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/hiddenWindow.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/macMessengerMenu.js">mail/base/content/macMessengerMenu.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/macMessengerMenu.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/macMessengerMenu.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/macMessengerMenu.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/macMessengerMenu.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/macMessengerMenu.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mail-compacttheme.js">mail/base/content/mail-compacttheme.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mail-compacttheme.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mail-compacttheme.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mail-compacttheme.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mail-compacttheme.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mail-compacttheme.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mail-offline.js">mail/base/content/mail-offline.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mail-offline.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mail-offline.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mail-offline.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mail-offline.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mail-offline.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mail3PaneWindowCommands.js">mail/base/content/mail3PaneWindowCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mail3PaneWindowCommands.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mail3PaneWindowCommands.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mail3PaneWindowCommands.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mail3PaneWindowCommands.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mail3PaneWindowCommands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailCommands.js">mail/base/content/mailCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailCommands.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailCommands.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailCommands.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailCommands.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailContextMenus.js">mail/base/content/mailContextMenus.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailContextMenus.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailContextMenus.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailContextMenus.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailContextMenus.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailContextMenus.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailCore.js">mail/base/content/mailCore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailCore.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailCore.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailCore.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailCore.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailCore.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailTabs.js">mail/base/content/mailTabs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailTabs.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailTabs.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailTabs.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailTabs.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailTabs.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailWidgets.xml">mail/base/content/mailWidgets.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailWidgets.xml">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailWidgets.xml">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailWidgets.xml">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailWidgets.xml">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailWidgets.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailWindow.js">mail/base/content/mailWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailWindow.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailWindow.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailWindow.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailWindow.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailWindow.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailWindowOverlay.js">mail/base/content/mailWindowOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailWindowOverlay.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailWindowOverlay.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailWindowOverlay.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailWindowOverlay.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/mailWindowOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/messageDisplay.js">mail/base/content/messageDisplay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/messageDisplay.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/messageDisplay.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/messageDisplay.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/messageDisplay.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/messageDisplay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/messageWindow.js">mail/base/content/messageWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/messageWindow.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/messageWindow.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/messageWindow.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/messageWindow.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/messageWindow.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/messageWindow.xul">mail/base/content/messageWindow.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/messageWindow.xul">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/messageWindow.xul">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/messageWindow.xul">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/messageWindow.xul">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/messageWindow.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/msgHdrView.js">mail/base/content/msgHdrView.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/msgHdrView.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/msgHdrView.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/msgHdrView.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/msgHdrView.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/msgHdrView.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/msgMail3PaneWindow.js">mail/base/content/msgMail3PaneWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/msgMail3PaneWindow.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/msgMail3PaneWindow.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/msgMail3PaneWindow.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/msgMail3PaneWindow.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/msgMail3PaneWindow.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/msgViewNavigation.js">mail/base/content/msgViewNavigation.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/msgViewNavigation.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/msgViewNavigation.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/msgViewNavigation.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/msgViewNavigation.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/msgViewNavigation.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/multimessageview.js">mail/base/content/multimessageview.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/multimessageview.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/multimessageview.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/multimessageview.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/multimessageview.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/multimessageview.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/newTagDialog.js">mail/base/content/newTagDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/newTagDialog.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/newTagDialog.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/newTagDialog.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/newTagDialog.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/newTagDialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/nsContextMenu.js">mail/base/content/nsContextMenu.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/nsContextMenu.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/nsContextMenu.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/nsContextMenu.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/nsContextMenu.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/nsContextMenu.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/nsDragAndDrop.js">mail/base/content/nsDragAndDrop.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/nsDragAndDrop.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/nsDragAndDrop.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/nsDragAndDrop.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/nsDragAndDrop.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/nsDragAndDrop.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/phishingDetector.js">mail/base/content/phishingDetector.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/phishingDetector.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/phishingDetector.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/phishingDetector.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/phishingDetector.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/phishingDetector.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/plugins.js">mail/base/content/plugins.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/plugins.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/plugins.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/plugins.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/plugins.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/plugins.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/quickFilterBar.js">mail/base/content/quickFilterBar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/quickFilterBar.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/quickFilterBar.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/quickFilterBar.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/quickFilterBar.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/quickFilterBar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/safeMode.js">mail/base/content/safeMode.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/safeMode.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/safeMode.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/safeMode.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/safeMode.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/safeMode.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/sanitize.js">mail/base/content/sanitize.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/sanitize.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/sanitize.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/sanitize.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/sanitize.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/sanitize.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/sanitizeDialog.js">mail/base/content/sanitizeDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/sanitizeDialog.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/sanitizeDialog.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/sanitizeDialog.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/sanitizeDialog.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/sanitizeDialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/search.xml">mail/base/content/search.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/search.xml">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/search.xml">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/search.xml">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/search.xml">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/search.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/searchBar.js">mail/base/content/searchBar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/searchBar.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/searchBar.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/searchBar.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/searchBar.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/searchBar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/specialTabs.js">mail/base/content/specialTabs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/specialTabs.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/specialTabs.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/specialTabs.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/specialTabs.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/specialTabs.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/systemIntegrationDialog.js">mail/base/content/systemIntegrationDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/systemIntegrationDialog.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/systemIntegrationDialog.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/systemIntegrationDialog.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/systemIntegrationDialog.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/systemIntegrationDialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/tabmail.xml">mail/base/content/tabmail.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/tabmail.xml">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/tabmail.xml">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/tabmail.xml">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/tabmail.xml">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/tabmail.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/threadPane.js">mail/base/content/threadPane.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/threadPane.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/threadPane.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/threadPane.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/threadPane.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/threadPane.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/toolbarIconColor.js">mail/base/content/toolbarIconColor.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/toolbarIconColor.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/toolbarIconColor.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/toolbarIconColor.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/toolbarIconColor.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/toolbarIconColor.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/utilityOverlay.js">mail/base/content/utilityOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/utilityOverlay.js">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/utilityOverlay.js">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/utilityOverlay.js">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/utilityOverlay.js">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/content/utilityOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/jar.mn">mail/base/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/jar.mn">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/jar.mn">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/jar.mn">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/jar.mn">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/base/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/locales/en-US/chrome/messenger/messenger.properties">mail/locales/en-US/chrome/messenger/messenger.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c680423af71f9cc93a50876c0218967b85a8995b/mail/locales/en-US/chrome/messenger/messenger.properties">file</a> |
<a href="/comm-central/annotate/c680423af71f9cc93a50876c0218967b85a8995b/mail/locales/en-US/chrome/messenger/messenger.properties">annotate</a> |
<a href="/comm-central/diff/c680423af71f9cc93a50876c0218967b85a8995b/mail/locales/en-US/chrome/messenger/messenger.properties">diff</a> |
<a href="/comm-central/comparison/c680423af71f9cc93a50876c0218967b85a8995b/mail/locales/en-US/chrome/messenger/messenger.properties">comparison</a> |
<a href="/comm-central/log/c680423af71f9cc93a50876c0218967b85a8995b/mail/locales/en-US/chrome/messenger/messenger.properties">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/.eslintignore</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/.eslintignore</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -44,17 +44,17 @@ mailnews/news/*</span>
<a href="#l1.4"></a><span id="l1.4"> mailnews/test/*</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> # mailnews/extensions exclusions</span>
<a href="#l1.7"></a><span id="l1.7"> mailnews/extensions/*</span>
<a href="#l1.8"></a><span id="l1.8"> !mailnews/extensions/newsblog</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> # mail exclusions</span>
<a href="#l1.11"></a><span id="l1.11"> mail/app/**</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-mail/base/content/**</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+mail/base/content/protovis-r2.6-modded.js</span>
<a href="#l1.14"></a><span id="l1.14"> mail/branding/**</span>
<a href="#l1.15"></a><span id="l1.15"> mail/config/**</span>
<a href="#l1.16"></a><span id="l1.16"> mail/extensions/**</span>
<a href="#l1.17"></a><span id="l1.17"> mail/installer/**</span>
<a href="#l1.18"></a><span id="l1.18"> mail/locales/**</span>
<a href="#l1.19"></a><span id="l1.19"> mail/test/**</span>
<a href="#l1.20"></a><span id="l1.20"> mail/themes/**</span>
<a href="#l1.21"></a><span id="l1.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">new file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- /dev/null</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ b/mail/base/content/.eslintrc.js</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -0,0 +1,7 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineplus">+</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineplus">+module.exports = {</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineplus">+  &quot;rules&quot;: {</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+    &quot;no-undef&quot;: &quot;off&quot;,</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+  },</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/content/ABSearchDialog.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/content/ABSearchDialog.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -22,35 +22,34 @@ var gAddressBookBundle;</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5"> var gSearchStopButton;</span>
<a href="#l3.6"></a><span id="l3.6"> var gPropertiesCmd;</span>
<a href="#l3.7"></a><span id="l3.7"> var gComposeCmd;</span>
<a href="#l3.8"></a><span id="l3.8"> var gDeleteCmd;</span>
<a href="#l3.9"></a><span id="l3.9"> var gSearchPhoneticName = &quot;false&quot;;</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11"> var gSearchAbViewListener = {</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  onSelectionChanged: function() {</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  onSelectionChanged() {</span>
<a href="#l3.14"></a><span id="l3.14">     UpdateCardView();</span>
<a href="#l3.15"></a><span id="l3.15">   },</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-  onCountChanged: function(aTotal) {</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+  onCountChanged(aTotal) {</span>
<a href="#l3.18"></a><span id="l3.18">     let statusText;</span>
<a href="#l3.19"></a><span id="l3.19">     if (aTotal == 0) {</span>
<a href="#l3.20"></a><span id="l3.20">       statusText = gAddressBookBundle.getString(&quot;noMatchFound&quot;);</span>
<a href="#l3.21"></a><span id="l3.21">     } else {</span>
<a href="#l3.22"></a><span id="l3.22">       statusText = PluralForm</span>
<a href="#l3.23"></a><span id="l3.23">         .get(aTotal, gAddressBookBundle.getString(&quot;matchesFound1&quot;))</span>
<a href="#l3.24"></a><span id="l3.24">         .replace(&quot;#1&quot;, aTotal);</span>
<a href="#l3.25"></a><span id="l3.25">     }</span>
<a href="#l3.26"></a><span id="l3.26"> </span>
<a href="#l3.27"></a><span id="l3.27">     gStatusText.setAttribute(&quot;label&quot;, statusText);</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-  }</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+  },</span>
<a href="#l3.30"></a><span id="l3.30"> };</span>
<a href="#l3.31"></a><span id="l3.31"> </span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-function searchOnLoad()</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-{</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+function searchOnLoad() {</span>
<a href="#l3.35"></a><span id="l3.35">   initializeSearchWidgets();</span>
<a href="#l3.36"></a><span id="l3.36">   initializeSearchWindowWidgets();</span>
<a href="#l3.37"></a><span id="l3.37"> </span>
<a href="#l3.38"></a><span id="l3.38">   gSearchBundle = document.getElementById(&quot;bundle_search&quot;);</span>
<a href="#l3.39"></a><span id="l3.39">   gSearchStopButton.setAttribute(&quot;label&quot;, gSearchBundle.getString(&quot;labelForSearchButton&quot;));</span>
<a href="#l3.40"></a><span id="l3.40">   gSearchStopButton.setAttribute(&quot;accesskey&quot;, gSearchBundle.getString(&quot;labelForSearchButton.accesskey&quot;));</span>
<a href="#l3.41"></a><span id="l3.41">   gAddressBookBundle = document.getElementById(&quot;bundle_addressBook&quot;);</span>
<a href="#l3.42"></a><span id="l3.42">   gSearchSession = Cc[searchSessionContractID].createInstance(Ci.nsIMsgSearchSession);</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineat">@@ -67,109 +66,97 @@ function searchOnLoad()</span>
<a href="#l3.44"></a><span id="l3.44">     SelectDirectory(window.arguments[0].directory);</span>
<a href="#l3.45"></a><span id="l3.45">   else</span>
<a href="#l3.46"></a><span id="l3.46">     SelectDirectory(document.getElementById(&quot;abPopup-menupopup&quot;)</span>
<a href="#l3.47"></a><span id="l3.47">                             .firstChild.value);</span>
<a href="#l3.48"></a><span id="l3.48"> </span>
<a href="#l3.49"></a><span id="l3.49">   onMore(null);</span>
<a href="#l3.50"></a><span id="l3.50"> }</span>
<a href="#l3.51"></a><span id="l3.51"> </span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-function searchOnUnload()</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-{</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+function searchOnUnload() {</span>
<a href="#l3.55"></a><span id="l3.55">   CloseAbView();</span>
<a href="#l3.56"></a><span id="l3.56"> }</span>
<a href="#l3.57"></a><span id="l3.57"> </span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-function disableCommands()</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">-{</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+function disableCommands() {</span>
<a href="#l3.61"></a><span id="l3.61">   gPropertiesCmd.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l3.62"></a><span id="l3.62">   gComposeCmd.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l3.63"></a><span id="l3.63">   gDeleteCmd.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l3.64"></a><span id="l3.64"> }</span>
<a href="#l3.65"></a><span id="l3.65"> </span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-function initializeSearchWindowWidgets()</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-{</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+function initializeSearchWindowWidgets() {</span>
<a href="#l3.69"></a><span id="l3.69">   gSearchStopButton = document.getElementById(&quot;search-button&quot;);</span>
<a href="#l3.70"></a><span id="l3.70">   gPropertiesCmd = document.getElementById(&quot;cmd_properties&quot;);</span>
<a href="#l3.71"></a><span id="l3.71">   gComposeCmd = document.getElementById(&quot;cmd_compose&quot;);</span>
<a href="#l3.72"></a><span id="l3.72">   gDeleteCmd = document.getElementById(&quot;cmd_deleteCard&quot;);</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-  gStatusText = document.getElementById('statusText');</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+  gStatusText = document.getElementById(&quot;statusText&quot;);</span>
<a href="#l3.75"></a><span id="l3.75">   disableCommands();</span>
<a href="#l3.76"></a><span id="l3.76">   // matchAll doesn't make sense for address book search</span>
<a href="#l3.77"></a><span id="l3.77">   hideMatchAllItem();</span>
<a href="#l3.78"></a><span id="l3.78"> }</span>
<a href="#l3.79"></a><span id="l3.79"> </span>
<a href="#l3.80"></a><span id="l3.80" class="difflineminus">-function onSearchStop()</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-{</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+function onSearchStop() {</span>
<a href="#l3.83"></a><span id="l3.83"> }</span>
<a href="#l3.84"></a><span id="l3.84"> </span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-function onAbSearchReset(event)</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineminus">-{</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+function onAbSearchReset(event) {</span>
<a href="#l3.88"></a><span id="l3.88">   disableCommands();</span>
<a href="#l3.89"></a><span id="l3.89">   CloseAbView();</span>
<a href="#l3.90"></a><span id="l3.90"> </span>
<a href="#l3.91"></a><span id="l3.91">   onReset(event);</span>
<a href="#l3.92"></a><span id="l3.92">   gStatusText.setAttribute(&quot;label&quot;, &quot;&quot;);</span>
<a href="#l3.93"></a><span id="l3.93"> }</span>
<a href="#l3.94"></a><span id="l3.94"> </span>
<a href="#l3.95"></a><span id="l3.95" class="difflineminus">-function SelectDirectory(aURI)</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineminus">-{</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+function SelectDirectory(aURI) {</span>
<a href="#l3.98"></a><span id="l3.98">   var selectedAB = aURI;</span>
<a href="#l3.99"></a><span id="l3.99"> </span>
<a href="#l3.100"></a><span id="l3.100">   if (!selectedAB)</span>
<a href="#l3.101"></a><span id="l3.101">     selectedAB = kPersonalAddressbookURI;</span>
<a href="#l3.102"></a><span id="l3.102"> </span>
<a href="#l3.103"></a><span id="l3.103">   // set popup with address book names</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineminus">-  var abPopup = document.getElementById('abPopup');</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineminus">-  if ( abPopup )</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+  var abPopup = document.getElementById(&quot;abPopup&quot;);</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+  if (abPopup)</span>
<a href="#l3.108"></a><span id="l3.108">     abPopup.value = selectedAB;</span>
<a href="#l3.109"></a><span id="l3.109"> </span>
<a href="#l3.110"></a><span id="l3.110">   setSearchScope(GetScopeForDirectoryURI(selectedAB));</span>
<a href="#l3.111"></a><span id="l3.111"> }</span>
<a href="#l3.112"></a><span id="l3.112"> </span>
<a href="#l3.113"></a><span id="l3.113" class="difflineminus">-function GetScopeForDirectoryURI(aURI)</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineminus">-{</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+function GetScopeForDirectoryURI(aURI) {</span>
<a href="#l3.116"></a><span id="l3.116">   var directory = MailServices.ab.getDirectory(aURI);</span>
<a href="#l3.117"></a><span id="l3.117">   var booleanAnd = gSearchBooleanRadiogroup.selectedItem.value == &quot;and&quot;;</span>
<a href="#l3.118"></a><span id="l3.118"> </span>
<a href="#l3.119"></a><span id="l3.119">   if (directory.isRemote) {</span>
<a href="#l3.120"></a><span id="l3.120">     if (booleanAnd)</span>
<a href="#l3.121"></a><span id="l3.121">       return nsMsgSearchScope.LDAPAnd;</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineminus">-    else</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineminus">-      return nsMsgSearchScope.LDAP;</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+    return nsMsgSearchScope.LDAP;</span>
<a href="#l3.125"></a><span id="l3.125">   }</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineminus">-  else {</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineminus">-    if (booleanAnd)</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-      return nsMsgSearchScope.LocalABAnd;</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineminus">-    else</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineminus">-      return nsMsgSearchScope.LocalAB;</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineplus">+</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+  if (booleanAnd) {</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineplus">+    return nsMsgSearchScope.LocalABAnd;</span>
<a href="#l3.134"></a><span id="l3.134">   }</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+  return nsMsgSearchScope.LocalAB;</span>
<a href="#l3.136"></a><span id="l3.136"> }</span>
<a href="#l3.137"></a><span id="l3.137"> </span>
<a href="#l3.138"></a><span id="l3.138" class="difflineminus">-function onEnterInSearchTerm()</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineminus">-{</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineplus">+function onEnterInSearchTerm() {</span>
<a href="#l3.141"></a><span id="l3.141">   // on enter</span>
<a href="#l3.142"></a><span id="l3.142">   // if not searching, start the search</span>
<a href="#l3.143"></a><span id="l3.143">   // if searching, stop and then start again</span>
<a href="#l3.144"></a><span id="l3.144">   if (gSearchStopButton.getAttribute(&quot;label&quot;) == gSearchBundle.getString(&quot;labelForSearchButton&quot;)) {</span>
<a href="#l3.145"></a><span id="l3.145">      onSearch();</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineminus">-  }</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineminus">-  else {</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineplus">+  } else {</span>
<a href="#l3.149"></a><span id="l3.149">      onSearchStop();</span>
<a href="#l3.150"></a><span id="l3.150">      onSearch();</span>
<a href="#l3.151"></a><span id="l3.151">   }</span>
<a href="#l3.152"></a><span id="l3.152"> }</span>
<a href="#l3.153"></a><span id="l3.153"> </span>
<a href="#l3.154"></a><span id="l3.154" class="difflineminus">-function onSearch()</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineminus">-{</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineplus">+function onSearch() {</span>
<a href="#l3.157"></a><span id="l3.157">     gStatusText.setAttribute(&quot;label&quot;, &quot;&quot;);</span>
<a href="#l3.158"></a><span id="l3.158">     disableCommands();</span>
<a href="#l3.159"></a><span id="l3.159"> </span>
<a href="#l3.160"></a><span id="l3.160">     gSearchSession.clearScopes();</span>
<a href="#l3.161"></a><span id="l3.161"> </span>
<a href="#l3.162"></a><span id="l3.162" class="difflineminus">-    var currentAbURI = document.getElementById('abPopup').getAttribute('value');</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineplus">+    var currentAbURI = document.getElementById(&quot;abPopup&quot;).getAttribute(&quot;value&quot;);</span>
<a href="#l3.164"></a><span id="l3.164"> </span>
<a href="#l3.165"></a><span id="l3.165">     gSearchSession.addDirectoryScopeTerm(GetScopeForDirectoryURI(currentAbURI));</span>
<a href="#l3.166"></a><span id="l3.166">     saveSearchTerms(gSearchSession.searchTerms, gSearchSession);</span>
<a href="#l3.167"></a><span id="l3.167"> </span>
<a href="#l3.168"></a><span id="l3.168">     var searchUri = currentAbURI + &quot;?(&quot;;</span>
<a href="#l3.169"></a><span id="l3.169">     for (let i = 0; i &lt; gSearchSession.searchTerms.length; i++) {</span>
<a href="#l3.170"></a><span id="l3.170">       let searchTerm = gSearchSession.searchTerms.queryElementAt(i, nsIMsgSearchTerm);</span>
<a href="#l3.171"></a><span id="l3.171"> </span>
<a href="#l3.172"></a><span id="l3.172" class="difflineat">@@ -181,28 +168,29 @@ function onSearch()</span>
<a href="#l3.173"></a><span id="l3.173">          searchUri += &quot;or&quot;;</span>
<a href="#l3.174"></a><span id="l3.174">       }</span>
<a href="#l3.175"></a><span id="l3.175"> </span>
<a href="#l3.176"></a><span id="l3.176">       var attrs;</span>
<a href="#l3.177"></a><span id="l3.177"> </span>
<a href="#l3.178"></a><span id="l3.178">       switch (searchTerm.attrib) {</span>
<a href="#l3.179"></a><span id="l3.179">        case nsMsgSearchAttrib.Name:</span>
<a href="#l3.180"></a><span id="l3.180">          if (gSearchPhoneticName != &quot;true&quot;)</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineminus">-           attrs = [&quot;DisplayName&quot;,&quot;FirstName&quot;,&quot;LastName&quot;,&quot;NickName&quot;,&quot;_AimScreenName&quot;];</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineplus">+           attrs = [&quot;DisplayName&quot;, &quot;FirstName&quot;, &quot;LastName&quot;, &quot;NickName&quot;, &quot;_AimScreenName&quot;];</span>
<a href="#l3.183"></a><span id="l3.183">          else</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineminus">-           attrs = [&quot;DisplayName&quot;,&quot;FirstName&quot;,&quot;LastName&quot;,&quot;NickName&quot;,&quot;_AimScreenName&quot;,&quot;PhoneticFirstName&quot;,&quot;PhoneticLastName&quot;];</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineplus">+           attrs = [&quot;DisplayName&quot;, &quot;FirstName&quot;, &quot;LastName&quot;, &quot;NickName&quot;,</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineplus">+                    &quot;_AimScreenName&quot;, &quot;PhoneticFirstName&quot;, &quot;PhoneticLastName&quot;];</span>
<a href="#l3.187"></a><span id="l3.187">          break;</span>
<a href="#l3.188"></a><span id="l3.188">        case nsMsgSearchAttrib.DisplayName:</span>
<a href="#l3.189"></a><span id="l3.189">          attrs = [&quot;DisplayName&quot;];</span>
<a href="#l3.190"></a><span id="l3.190">          break;</span>
<a href="#l3.191"></a><span id="l3.191">        case nsMsgSearchAttrib.Email:</span>
<a href="#l3.192"></a><span id="l3.192">          attrs = [&quot;PrimaryEmail&quot;];</span>
<a href="#l3.193"></a><span id="l3.193">          break;</span>
<a href="#l3.194"></a><span id="l3.194">        case nsMsgSearchAttrib.PhoneNumber:</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineminus">-         attrs = [&quot;HomePhone&quot;,&quot;WorkPhone&quot;,&quot;FaxNumber&quot;,&quot;PagerNumber&quot;,&quot;CellularNumber&quot;];</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineplus">+         attrs = [&quot;HomePhone&quot;, &quot;WorkPhone&quot;, &quot;FaxNumber&quot;, &quot;PagerNumber&quot;, &quot;CellularNumber&quot;];</span>
<a href="#l3.197"></a><span id="l3.197">          break;</span>
<a href="#l3.198"></a><span id="l3.198">        case nsMsgSearchAttrib.Organization:</span>
<a href="#l3.199"></a><span id="l3.199">          attrs = [&quot;Company&quot;];</span>
<a href="#l3.200"></a><span id="l3.200">          break;</span>
<a href="#l3.201"></a><span id="l3.201">        case nsMsgSearchAttrib.Department:</span>
<a href="#l3.202"></a><span id="l3.202">          attrs = [&quot;Department&quot;];</span>
<a href="#l3.203"></a><span id="l3.203">          break;</span>
<a href="#l3.204"></a><span id="l3.204">        case nsMsgSearchAttrib.City:</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineat">@@ -272,77 +260,69 @@ function onSearch()</span>
<a href="#l3.206"></a><span id="l3.206">         opStr = &quot;c&quot;;</span>
<a href="#l3.207"></a><span id="l3.207">         break;</span>
<a href="#l3.208"></a><span id="l3.208">       }</span>
<a href="#l3.209"></a><span id="l3.209"> </span>
<a href="#l3.210"></a><span id="l3.210">       // currently, we can't do &quot;and&quot; and &quot;or&quot; searches at the same time</span>
<a href="#l3.211"></a><span id="l3.211">       // (it's either all &quot;and&quot;s or all &quot;or&quot;s)</span>
<a href="#l3.212"></a><span id="l3.212">       var max_attrs = attrs.length;</span>
<a href="#l3.213"></a><span id="l3.213"> </span>
<a href="#l3.214"></a><span id="l3.214" class="difflineminus">-      for (var j=0;j&lt;max_attrs;j++) {</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineplus">+      for (var j = 0; j &lt; max_attrs; j++) {</span>
<a href="#l3.216"></a><span id="l3.216">        // append the term(s) to the searchUri</span>
<a href="#l3.217"></a><span id="l3.217">        searchUri += &quot;(&quot; + attrs[j] + &quot;,&quot; + opStr + &quot;,&quot; + encodeABTermValue(searchTerm.value.str) + &quot;)&quot;;</span>
<a href="#l3.218"></a><span id="l3.218">       }</span>
<a href="#l3.219"></a><span id="l3.219">     }</span>
<a href="#l3.220"></a><span id="l3.220"> </span>
<a href="#l3.221"></a><span id="l3.221">     searchUri += &quot;)&quot;;</span>
<a href="#l3.222"></a><span id="l3.222">     SetAbView(searchUri);</span>
<a href="#l3.223"></a><span id="l3.223"> }</span>
<a href="#l3.224"></a><span id="l3.224"> </span>
<a href="#l3.225"></a><span id="l3.225"> // used to toggle functionality for Search/Stop button.</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineminus">-function onSearchButton(event)</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineminus">-{</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineplus">+function onSearchButton(event) {</span>
<a href="#l3.229"></a><span id="l3.229">     if (event.target.label == gSearchBundle.getString(&quot;labelForSearchButton&quot;))</span>
<a href="#l3.230"></a><span id="l3.230">         onSearch();</span>
<a href="#l3.231"></a><span id="l3.231">     else</span>
<a href="#l3.232"></a><span id="l3.232">         onSearchStop();</span>
<a href="#l3.233"></a><span id="l3.233"> }</span>
<a href="#l3.234"></a><span id="l3.234"> </span>
<a href="#l3.235"></a><span id="l3.235" class="difflineminus">-function GetAbViewListener()</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineminus">-{</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineplus">+function GetAbViewListener() {</span>
<a href="#l3.238"></a><span id="l3.238">   return gSearchAbViewListener;</span>
<a href="#l3.239"></a><span id="l3.239"> }</span>
<a href="#l3.240"></a><span id="l3.240"> </span>
<a href="#l3.241"></a><span id="l3.241" class="difflineminus">-function onProperties()</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineminus">-{</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineplus">+function onProperties() {</span>
<a href="#l3.244"></a><span id="l3.244">   if (!gPropertiesCmd.hasAttribute(&quot;disabled&quot;))</span>
<a href="#l3.245"></a><span id="l3.245">     AbEditSelectedCard();</span>
<a href="#l3.246"></a><span id="l3.246"> }</span>
<a href="#l3.247"></a><span id="l3.247"> </span>
<a href="#l3.248"></a><span id="l3.248" class="difflineminus">-function onCompose()</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineminus">-{</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineplus">+function onCompose() {</span>
<a href="#l3.251"></a><span id="l3.251">   if (!gComposeCmd.hasAttribute(&quot;disabled&quot;))</span>
<a href="#l3.252"></a><span id="l3.252">     AbNewMessage();</span>
<a href="#l3.253"></a><span id="l3.253"> }</span>
<a href="#l3.254"></a><span id="l3.254"> </span>
<a href="#l3.255"></a><span id="l3.255" class="difflineminus">-function onDelete()</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineminus">-{</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineplus">+function onDelete() {</span>
<a href="#l3.258"></a><span id="l3.258">   if (!gDeleteCmd.hasAttribute(&quot;disabled&quot;))</span>
<a href="#l3.259"></a><span id="l3.259">     AbDelete();</span>
<a href="#l3.260"></a><span id="l3.260"> }</span>
<a href="#l3.261"></a><span id="l3.261"> </span>
<a href="#l3.262"></a><span id="l3.262" class="difflineminus">-function AbResultsPaneKeyPress(event)</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineminus">-{</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineplus">+function AbResultsPaneKeyPress(event) {</span>
<a href="#l3.265"></a><span id="l3.265">   switch (event.keyCode) {</span>
<a href="#l3.266"></a><span id="l3.266">   case KeyEvent.DOM_VK_RETURN:</span>
<a href="#l3.267"></a><span id="l3.267">     onProperties();</span>
<a href="#l3.268"></a><span id="l3.268">     break;</span>
<a href="#l3.269"></a><span id="l3.269">   case KeyEvent.DOM_VK_DELETE:</span>
<a href="#l3.270"></a><span id="l3.270">   case KeyEvent.DOM_VK_BACK_SPACE:</span>
<a href="#l3.271"></a><span id="l3.271">     onDelete();</span>
<a href="#l3.272"></a><span id="l3.272">   }</span>
<a href="#l3.273"></a><span id="l3.273"> }</span>
<a href="#l3.274"></a><span id="l3.274"> </span>
<a href="#l3.275"></a><span id="l3.275" class="difflineminus">-function AbResultsPaneDoubleClick(card)</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineminus">-{</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineplus">+function AbResultsPaneDoubleClick(card) {</span>
<a href="#l3.278"></a><span id="l3.278">   AbEditCard(card);</span>
<a href="#l3.279"></a><span id="l3.279"> }</span>
<a href="#l3.280"></a><span id="l3.280"> </span>
<a href="#l3.281"></a><span id="l3.281" class="difflineminus">-function UpdateCardView()</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineminus">-{</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineplus">+function UpdateCardView() {</span>
<a href="#l3.284"></a><span id="l3.284">   disableCommands();</span>
<a href="#l3.285"></a><span id="l3.285">   let numSelected = GetNumSelectedCards();</span>
<a href="#l3.286"></a><span id="l3.286"> </span>
<a href="#l3.287"></a><span id="l3.287">   if (!numSelected)</span>
<a href="#l3.288"></a><span id="l3.288">     return;</span>
<a href="#l3.289"></a><span id="l3.289"> </span>
<a href="#l3.290"></a><span id="l3.290">   if (MailServices.accounts.allIdentities.length &gt; 0)</span>
<a href="#l3.291"></a><span id="l3.291">     gComposeCmd.removeAttribute(&quot;disabled&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/base/content/FilterListDialog.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/base/content/FilterListDialog.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -21,82 +21,72 @@ var gDownButton = null;</span>
<a href="#l4.4"></a><span id="l4.4"> var gBottomButton = null;</span>
<a href="#l4.5"></a><span id="l4.5"> var gSearchBox = null;</span>
<a href="#l4.6"></a><span id="l4.6"> var gRunFiltersFolder = null;</span>
<a href="#l4.7"></a><span id="l4.7"> var gRunFiltersButton = null;</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> var gFilterBundle = null;</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11"> var msgMoveMotion = {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  Up     : 0,</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-  Down   : 1,</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-  Top    : 2,</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-  Bottom : 3</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-}</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+  Up: 0,</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+  Down: 1,</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+  Top: 2,</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+  Bottom: 3,</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+};</span>
<a href="#l4.22"></a><span id="l4.22"> </span>
<a href="#l4.23"></a><span id="l4.23"> var gStatusFeedback = {</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineminus">-  progressMeterVisible : false,</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+  progressMeterVisible: false,</span>
<a href="#l4.26"></a><span id="l4.26"> </span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-  showStatusString: function(status)</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-  {</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+  showStatusString(status) {</span>
<a href="#l4.30"></a><span id="l4.30">     document.getElementById(&quot;statusText&quot;).setAttribute(&quot;value&quot;, status);</span>
<a href="#l4.31"></a><span id="l4.31">   },</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-  startMeteors: function()</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-  {</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+  startMeteors() {</span>
<a href="#l4.35"></a><span id="l4.35">     // change run button to be a stop button</span>
<a href="#l4.36"></a><span id="l4.36">     gRunFiltersButton.setAttribute(&quot;label&quot;, gRunFiltersButton.getAttribute(&quot;stoplabel&quot;));</span>
<a href="#l4.37"></a><span id="l4.37">     gRunFiltersButton.setAttribute(&quot;accesskey&quot;, gRunFiltersButton.getAttribute(&quot;stopaccesskey&quot;));</span>
<a href="#l4.38"></a><span id="l4.38"> </span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-    if (!this.progressMeterVisible)</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-    {</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-      document.getElementById('statusbar-progresspanel').removeAttribute('collapsed');</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+    if (!this.progressMeterVisible) {</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+      document.getElementById(&quot;statusbar-progresspanel&quot;).removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l4.44"></a><span id="l4.44">       this.progressMeterVisible = true;</span>
<a href="#l4.45"></a><span id="l4.45">     }</span>
<a href="#l4.46"></a><span id="l4.46"> </span>
<a href="#l4.47"></a><span id="l4.47">     document.getElementById(&quot;statusbar-icon&quot;).removeAttribute(&quot;value&quot;);</span>
<a href="#l4.48"></a><span id="l4.48">   },</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-  stopMeteors: function()</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-  {</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+  stopMeteors() {</span>
<a href="#l4.52"></a><span id="l4.52">     try {</span>
<a href="#l4.53"></a><span id="l4.53">       // change run button to be a stop button</span>
<a href="#l4.54"></a><span id="l4.54">       gRunFiltersButton.setAttribute(&quot;label&quot;, gRunFiltersButton.getAttribute(&quot;runlabel&quot;));</span>
<a href="#l4.55"></a><span id="l4.55">       gRunFiltersButton.setAttribute(&quot;accesskey&quot;, gRunFiltersButton.getAttribute(&quot;runaccesskey&quot;));</span>
<a href="#l4.56"></a><span id="l4.56"> </span>
<a href="#l4.57"></a><span id="l4.57" class="difflineminus">-      if (this.progressMeterVisible)</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineminus">-      {</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineminus">-        document.getElementById('statusbar-progresspanel').collapsed = true;</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+      if (this.progressMeterVisible) {</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+        document.getElementById(&quot;statusbar-progresspanel&quot;).collapsed = true;</span>
<a href="#l4.62"></a><span id="l4.62">         this.progressMeterVisible = true;</span>
<a href="#l4.63"></a><span id="l4.63">       }</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineminus">-    }</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineminus">-    catch (ex) {</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+    } catch (ex) {</span>
<a href="#l4.67"></a><span id="l4.67">       // can get here if closing window when running filters</span>
<a href="#l4.68"></a><span id="l4.68">     }</span>
<a href="#l4.69"></a><span id="l4.69">   },</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineminus">-  showProgress: function(percentage)</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineminus">-  {</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+  showProgress(percentage) {</span>
<a href="#l4.73"></a><span id="l4.73">   },</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineminus">-  closeWindow: function()</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineminus">-  {</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineminus">-  }</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+  closeWindow() {</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+  },</span>
<a href="#l4.79"></a><span id="l4.79"> };</span>
<a href="#l4.80"></a><span id="l4.80"> </span>
<a href="#l4.81"></a><span id="l4.81"> var filterEditorQuitObserver = {</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineminus">-  observe: function(aSubject, aTopic, aData)</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineminus">-  {</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l4.85"></a><span id="l4.85">     // Check whether or not we want to veto the quit request (unless another</span>
<a href="#l4.86"></a><span id="l4.86">     // observer already did.</span>
<a href="#l4.87"></a><span id="l4.87">     if (aTopic == &quot;quit-application-requested&quot; &amp;&amp;</span>
<a href="#l4.88"></a><span id="l4.88">         (aSubject instanceof Ci.nsISupportsPRBool) &amp;&amp;</span>
<a href="#l4.89"></a><span id="l4.89">         !aSubject.data)</span>
<a href="#l4.90"></a><span id="l4.90">       aSubject.data = !onFilterClose();</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineminus">-  }</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineminus">-}</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+  },</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+};</span>
<a href="#l4.95"></a><span id="l4.95"> </span>
<a href="#l4.96"></a><span id="l4.96" class="difflineminus">-function onLoad()</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineminus">-{</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+function onLoad() {</span>
<a href="#l4.99"></a><span id="l4.99">     gFilterListMsgWindow = Cc[&quot;@mozilla.org/messenger/msgwindow;1&quot;]</span>
<a href="#l4.100"></a><span id="l4.100">                              .createInstance(Ci.nsIMsgWindow);</span>
<a href="#l4.101"></a><span id="l4.101">     gFilterListMsgWindow.domWindow = window;</span>
<a href="#l4.102"></a><span id="l4.102">     gFilterListMsgWindow.rootDocShell.appType = Ci.nsIDocShell.APP_TYPE_MAIL;</span>
<a href="#l4.103"></a><span id="l4.103">     gFilterListMsgWindow.statusFeedback = gStatusFeedback;</span>
<a href="#l4.104"></a><span id="l4.104"> </span>
<a href="#l4.105"></a><span id="l4.105">     gServerMenu       = document.getElementById(&quot;serverMenu&quot;);</span>
<a href="#l4.106"></a><span id="l4.106">     gFilterListbox    = document.getElementById(&quot;filterList&quot;);</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineat">@@ -127,18 +117,17 @@ function onLoad()</span>
<a href="#l4.108"></a><span id="l4.108">  *                    { arg1: value1, arg2: value2, ... }</span>
<a href="#l4.109"></a><span id="l4.109">  */</span>
<a href="#l4.110"></a><span id="l4.110"> function processWindowArguments(aArguments) {</span>
<a href="#l4.111"></a><span id="l4.111">   // If a specific folder was requested, try to select it</span>
<a href="#l4.112"></a><span id="l4.112">   // if we don't already show its server.</span>
<a href="#l4.113"></a><span id="l4.113">   if (!gServerMenu._folder ||</span>
<a href="#l4.114"></a><span id="l4.114">       ((&quot;folder&quot; in aArguments) &amp;&amp;</span>
<a href="#l4.115"></a><span id="l4.115">       (aArguments.folder != gServerMenu._folder) &amp;&amp;</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineminus">-      (aArguments.folder.rootFolder != gServerMenu._folder)))</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineminus">-  {</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+      (aArguments.folder.rootFolder != gServerMenu._folder))) {</span>
<a href="#l4.119"></a><span id="l4.119">     let wantedFolder;</span>
<a href="#l4.120"></a><span id="l4.120">     if (&quot;folder&quot; in aArguments)</span>
<a href="#l4.121"></a><span id="l4.121">       wantedFolder = aArguments.folder;</span>
<a href="#l4.122"></a><span id="l4.122"> </span>
<a href="#l4.123"></a><span id="l4.123">     // Get the folder where filters should be defined, if that server</span>
<a href="#l4.124"></a><span id="l4.124">     // can accept filters.</span>
<a href="#l4.125"></a><span id="l4.125">     let firstItem = getFilterFolderForSelection(wantedFolder);</span>
<a href="#l4.126"></a><span id="l4.126"> </span>
<a href="#l4.127"></a><span id="l4.127" class="difflineat">@@ -166,40 +155,37 @@ function processWindowArguments(aArgumen</span>
<a href="#l4.128"></a><span id="l4.128"> </span>
<a href="#l4.129"></a><span id="l4.129"> /**</span>
<a href="#l4.130"></a><span id="l4.130">  * This is called from OpenOrFocusWindow() if the dialog is already open.</span>
<a href="#l4.131"></a><span id="l4.131">  * New filters could have been created by operations outside the dialog.</span>
<a href="#l4.132"></a><span id="l4.132">  *</span>
<a href="#l4.133"></a><span id="l4.133">  * @param aArguments  An object of arguments having the same format</span>
<a href="#l4.134"></a><span id="l4.134">  *                    as window.arguments[0].</span>
<a href="#l4.135"></a><span id="l4.135">  */</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineminus">-function refresh(aArguments)</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineminus">-{</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineplus">+function refresh(aArguments) {</span>
<a href="#l4.139"></a><span id="l4.139">   // As we really don't know what has changed, clear the search box</span>
<a href="#l4.140"></a><span id="l4.140">   // undonditionally so that the changed/added filters are surely visible.</span>
<a href="#l4.141"></a><span id="l4.141">   resetSearchBox();</span>
<a href="#l4.142"></a><span id="l4.142"> </span>
<a href="#l4.143"></a><span id="l4.143">   processWindowArguments(aArguments);</span>
<a href="#l4.144"></a><span id="l4.144"> }</span>
<a href="#l4.145"></a><span id="l4.145"> </span>
<a href="#l4.146"></a><span id="l4.146" class="difflineminus">-function CanRunFiltersAfterTheFact(aServer)</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineminus">-{</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineplus">+function CanRunFiltersAfterTheFact(aServer) {</span>
<a href="#l4.149"></a><span id="l4.149">   // filter after the fact is implement using search</span>
<a href="#l4.150"></a><span id="l4.150">   // so if you can't search, you can't filter after the fact</span>
<a href="#l4.151"></a><span id="l4.151">   return aServer.canSearchMessages;</span>
<a href="#l4.152"></a><span id="l4.152"> }</span>
<a href="#l4.153"></a><span id="l4.153"> </span>
<a href="#l4.154"></a><span id="l4.154"> /**</span>
<a href="#l4.155"></a><span id="l4.155">  * Change the root server for which we are managing filters.</span>
<a href="#l4.156"></a><span id="l4.156">  *</span>
<a href="#l4.157"></a><span id="l4.157">  * @param msgFolder The nsIMsgFolder server containing filters</span>
<a href="#l4.158"></a><span id="l4.158">  *                  (or a folder for NNTP server).</span>
<a href="#l4.159"></a><span id="l4.159">  */</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineminus">-function setFilterFolder(msgFolder)</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineminus">-{</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineplus">+function setFilterFolder(msgFolder) {</span>
<a href="#l4.163"></a><span id="l4.163">   if (!msgFolder || msgFolder == gServerMenu._folder)</span>
<a href="#l4.164"></a><span id="l4.164">     return;</span>
<a href="#l4.165"></a><span id="l4.165"> </span>
<a href="#l4.166"></a><span id="l4.166">   // Save the current filters to disk before switching because</span>
<a href="#l4.167"></a><span id="l4.167">   // the dialog may be closed and we'll lose current filters.</span>
<a href="#l4.168"></a><span id="l4.168">   if (gCurrentFilterList)</span>
<a href="#l4.169"></a><span id="l4.169">     gCurrentFilterList.saveToDefaultFile();</span>
<a href="#l4.170"></a><span id="l4.170"> </span>
<a href="#l4.171"></a><span id="l4.171" class="difflineat">@@ -289,18 +275,17 @@ function setRunFolder(aFolder) {</span>
<a href="#l4.172"></a><span id="l4.172">   updateButtons();</span>
<a href="#l4.173"></a><span id="l4.173"> }</span>
<a href="#l4.174"></a><span id="l4.174"> </span>
<a href="#l4.175"></a><span id="l4.175"> /**</span>
<a href="#l4.176"></a><span id="l4.176">  * Toggle enabled state of a filter, in both the filter properties and the UI.</span>
<a href="#l4.177"></a><span id="l4.177">  *</span>
<a href="#l4.178"></a><span id="l4.178">  * @param aFilterItem  an item (row) of the filter list to be toggled</span>
<a href="#l4.179"></a><span id="l4.179">  */</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineminus">-function toggleFilter(aFilterItem, aSetForEvent)</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineminus">-{</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineplus">+function toggleFilter(aFilterItem, aSetForEvent) {</span>
<a href="#l4.183"></a><span id="l4.183">   let filter = aFilterItem._filter;</span>
<a href="#l4.184"></a><span id="l4.184">   if (filter.unparseable &amp;&amp; !filter.enabled) {</span>
<a href="#l4.185"></a><span id="l4.185">     Services.prompt.alert(window, null, gFilterBundle.getString(&quot;cannotEnableFilter&quot;));</span>
<a href="#l4.186"></a><span id="l4.186">     return;</span>
<a href="#l4.187"></a><span id="l4.187">   }</span>
<a href="#l4.188"></a><span id="l4.188">   filter.enabled = aSetForEvent === undefined ? !filter.enabled : aSetForEvent;</span>
<a href="#l4.189"></a><span id="l4.189"> </span>
<a href="#l4.190"></a><span id="l4.190">   // Now update the checkbox</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineat">@@ -335,24 +320,22 @@ function selectFilter(aFilter) {</span>
<a href="#l4.192"></a><span id="l4.192">   }</span>
<a href="#l4.193"></a><span id="l4.193">   return false;</span>
<a href="#l4.194"></a><span id="l4.194"> }</span>
<a href="#l4.195"></a><span id="l4.195"> </span>
<a href="#l4.196"></a><span id="l4.196"> /**</span>
<a href="#l4.197"></a><span id="l4.197">  * Returns the currently selected filter. If multiple filters are selected,</span>
<a href="#l4.198"></a><span id="l4.198">  * returns the first one. If none are selected, returns null.</span>
<a href="#l4.199"></a><span id="l4.199">  */</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineminus">-function currentFilter()</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineminus">-{</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineplus">+function currentFilter() {</span>
<a href="#l4.203"></a><span id="l4.203">   let currentItem = gFilterListbox.selectedItem;</span>
<a href="#l4.204"></a><span id="l4.204">   return currentItem ? currentItem._filter : null;</span>
<a href="#l4.205"></a><span id="l4.205"> }</span>
<a href="#l4.206"></a><span id="l4.206"> </span>
<a href="#l4.207"></a><span id="l4.207" class="difflineminus">-function onEditFilter()</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineminus">-{</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineplus">+function onEditFilter() {</span>
<a href="#l4.210"></a><span id="l4.210">   if (gEditButton.disabled)</span>
<a href="#l4.211"></a><span id="l4.211">     return;</span>
<a href="#l4.212"></a><span id="l4.212"> </span>
<a href="#l4.213"></a><span id="l4.213">   let selectedFilter = currentFilter();</span>
<a href="#l4.214"></a><span id="l4.214">   if (!selectedFilter)</span>
<a href="#l4.215"></a><span id="l4.215">     return;</span>
<a href="#l4.216"></a><span id="l4.216"> </span>
<a href="#l4.217"></a><span id="l4.217">   let args = {filter: selectedFilter, filterList: gCurrentFilterList};</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineat">@@ -365,27 +348,25 @@ function onEditFilter()</span>
<a href="#l4.219"></a><span id="l4.219">     rebuildFilterList();</span>
<a href="#l4.220"></a><span id="l4.220">   }</span>
<a href="#l4.221"></a><span id="l4.221"> }</span>
<a href="#l4.222"></a><span id="l4.222"> </span>
<a href="#l4.223"></a><span id="l4.223"> /**</span>
<a href="#l4.224"></a><span id="l4.224">  * Handler function for the 'New...' buttons.</span>
<a href="#l4.225"></a><span id="l4.225">  * Opens the filter dialog for creating a new filter.</span>
<a href="#l4.226"></a><span id="l4.226">  */</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineminus">-function onNewFilter()</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineminus">-{</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineplus">+function onNewFilter() {</span>
<a href="#l4.230"></a><span id="l4.230">   calculatePositionAndShowCreateFilterDialog({});</span>
<a href="#l4.231"></a><span id="l4.231"> }</span>
<a href="#l4.232"></a><span id="l4.232"> </span>
<a href="#l4.233"></a><span id="l4.233"> /**</span>
<a href="#l4.234"></a><span id="l4.234">  * Handler function for the 'Copy...' button.</span>
<a href="#l4.235"></a><span id="l4.235">  * Opens the filter dialog for copying the selected filter.</span>
<a href="#l4.236"></a><span id="l4.236">  */</span>
<a href="#l4.237"></a><span id="l4.237" class="difflineminus">-function onCopyToNewFilter()</span>
<a href="#l4.238"></a><span id="l4.238" class="difflineminus">-{</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineplus">+function onCopyToNewFilter() {</span>
<a href="#l4.240"></a><span id="l4.240">   if (gCopyToNewButton.disabled)</span>
<a href="#l4.241"></a><span id="l4.241">     return;</span>
<a href="#l4.242"></a><span id="l4.242"> </span>
<a href="#l4.243"></a><span id="l4.243">   let selectedFilter = currentFilter();</span>
<a href="#l4.244"></a><span id="l4.244">   if (!selectedFilter)</span>
<a href="#l4.245"></a><span id="l4.245">     return;</span>
<a href="#l4.246"></a><span id="l4.246"> </span>
<a href="#l4.247"></a><span id="l4.247">   let args = {copiedFilter: selectedFilter};</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineat">@@ -397,18 +378,17 @@ function onCopyToNewFilter()</span>
<a href="#l4.249"></a><span id="l4.249">  * Calculates the position for inserting the new filter,</span>
<a href="#l4.250"></a><span id="l4.250">  * and then displays the create dialog.</span>
<a href="#l4.251"></a><span id="l4.251">  *</span>
<a href="#l4.252"></a><span id="l4.252">  * @param args  The object containing the arguments for the dialog,</span>
<a href="#l4.253"></a><span id="l4.253">  *              passed to the filterEditorOnLoad() function.</span>
<a href="#l4.254"></a><span id="l4.254">  *              It will be augmented with the insertion position</span>
<a href="#l4.255"></a><span id="l4.255">  *              and global filters list properties by this function.</span>
<a href="#l4.256"></a><span id="l4.256">  */</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineminus">-function calculatePositionAndShowCreateFilterDialog(args)</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineminus">-{</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineplus">+function calculatePositionAndShowCreateFilterDialog(args) {</span>
<a href="#l4.260"></a><span id="l4.260">   let selectedFilter = currentFilter();</span>
<a href="#l4.261"></a><span id="l4.261">   // If no filter is selected use the first position.</span>
<a href="#l4.262"></a><span id="l4.262">   let position = 0;</span>
<a href="#l4.263"></a><span id="l4.263">   if (selectedFilter) {</span>
<a href="#l4.264"></a><span id="l4.264">     // Get the position in the unfiltered list.</span>
<a href="#l4.265"></a><span id="l4.265">     // - this is where the new filter should be inserted!</span>
<a href="#l4.266"></a><span id="l4.266">     let filterCount = gCurrentFilterList.filterCount;</span>
<a href="#l4.267"></a><span id="l4.267">     for (let i = 0; i &lt; filterCount; i++) {</span>
<a href="#l4.268"></a><span id="l4.268" class="difflineat">@@ -436,32 +416,31 @@ function calculatePositionAndShowCreateF</span>
<a href="#l4.269"></a><span id="l4.269">       Cu.reportError(&quot;Filter created at an unexpected position!&quot;);</span>
<a href="#l4.270"></a><span id="l4.270">   }</span>
<a href="#l4.271"></a><span id="l4.271"> }</span>
<a href="#l4.272"></a><span id="l4.272"> </span>
<a href="#l4.273"></a><span id="l4.273"> /**</span>
<a href="#l4.274"></a><span id="l4.274">  * Delete selected filters.</span>
<a href="#l4.275"></a><span id="l4.275">  *  'Selected' is not to be confused with active (checkbox checked)</span>
<a href="#l4.276"></a><span id="l4.276">  */</span>
<a href="#l4.277"></a><span id="l4.277" class="difflineminus">-function onDeleteFilter()</span>
<a href="#l4.278"></a><span id="l4.278" class="difflineminus">-{</span>
<a href="#l4.279"></a><span id="l4.279" class="difflineplus">+function onDeleteFilter() {</span>
<a href="#l4.280"></a><span id="l4.280">   if (gDeleteButton.disabled)</span>
<a href="#l4.281"></a><span id="l4.281">     return;</span>
<a href="#l4.282"></a><span id="l4.282"> </span>
<a href="#l4.283"></a><span id="l4.283">   let items = gFilterListbox.selectedItems;</span>
<a href="#l4.284"></a><span id="l4.284">   if (!items.length)</span>
<a href="#l4.285"></a><span id="l4.285">     return;</span>
<a href="#l4.286"></a><span id="l4.286"> </span>
<a href="#l4.287"></a><span id="l4.287" class="difflineminus">-  let checkValue = {value:false};</span>
<a href="#l4.288"></a><span id="l4.288" class="difflineplus">+  let checkValue = {value: false};</span>
<a href="#l4.289"></a><span id="l4.289">   if ((Services.prefs.getBoolPref(&quot;mailnews.filters.confirm_delete&quot;)) &amp;&amp;</span>
<a href="#l4.290"></a><span id="l4.290">       (Services.prompt.confirmEx(window, null,</span>
<a href="#l4.291"></a><span id="l4.291">                                  gFilterBundle.getString(&quot;deleteFilterConfirmation&quot;),</span>
<a href="#l4.292"></a><span id="l4.292">                                  Services.prompt.STD_YES_NO_BUTTONS,</span>
<a href="#l4.293"></a><span id="l4.293" class="difflineminus">-                                 '', '', '',</span>
<a href="#l4.294"></a><span id="l4.294" class="difflineminus">-                                 gFilterBundle.getString('dontWarnAboutDeleteCheckbox'),</span>
<a href="#l4.295"></a><span id="l4.295" class="difflineplus">+                                 &quot;&quot;, &quot;&quot;, &quot;&quot;,</span>
<a href="#l4.296"></a><span id="l4.296" class="difflineplus">+                                 gFilterBundle.getString(&quot;dontWarnAboutDeleteCheckbox&quot;),</span>
<a href="#l4.297"></a><span id="l4.297">                                  checkValue)))</span>
<a href="#l4.298"></a><span id="l4.298">     return;</span>
<a href="#l4.299"></a><span id="l4.299"> </span>
<a href="#l4.300"></a><span id="l4.300">   if (checkValue.value)</span>
<a href="#l4.301"></a><span id="l4.301">      Services.prefs.setBoolPref(&quot;mailnews.filters.confirm_delete&quot;, false);</span>
<a href="#l4.302"></a><span id="l4.302"> </span>
<a href="#l4.303"></a><span id="l4.303">   // Save filter position before the first selected one.</span>
<a href="#l4.304"></a><span id="l4.304">   let newSelectionIndex = gFilterListbox.selectedIndex - 1;</span>
<a href="#l4.305"></a><span id="l4.305" class="difflineat">@@ -531,17 +510,17 @@ function moveFilter(motion) {</span>
<a href="#l4.306"></a><span id="l4.306">   // At the moment, do not allow moving groups of filters.</span>
<a href="#l4.307"></a><span id="l4.307">   let selectedFilter = currentFilter();</span>
<a href="#l4.308"></a><span id="l4.308">   if (!selectedFilter)</span>
<a href="#l4.309"></a><span id="l4.309">     return;</span>
<a href="#l4.310"></a><span id="l4.310"> </span>
<a href="#l4.311"></a><span id="l4.311">   var relativeStep = 0;</span>
<a href="#l4.312"></a><span id="l4.312">   var moveFilterNative = null;</span>
<a href="#l4.313"></a><span id="l4.313"> </span>
<a href="#l4.314"></a><span id="l4.314" class="difflineminus">-  switch(motion) {</span>
<a href="#l4.315"></a><span id="l4.315" class="difflineplus">+  switch (motion) {</span>
<a href="#l4.316"></a><span id="l4.316">     case msgMoveMotion.Top:</span>
<a href="#l4.317"></a><span id="l4.317">       if (selectedFilter) {</span>
<a href="#l4.318"></a><span id="l4.318">         gCurrentFilterList.removeFilter(selectedFilter);</span>
<a href="#l4.319"></a><span id="l4.319">         gCurrentFilterList.insertFilterAt(0, selectedFilter);</span>
<a href="#l4.320"></a><span id="l4.320">         rebuildFilterList();</span>
<a href="#l4.321"></a><span id="l4.321">       }</span>
<a href="#l4.322"></a><span id="l4.322">       return;</span>
<a href="#l4.323"></a><span id="l4.323">     case msgMoveMotion.Bottom:</span>
<a href="#l4.324"></a><span id="l4.324" class="difflineat">@@ -585,55 +564,51 @@ function moveFilter(motion) {</span>
<a href="#l4.325"></a><span id="l4.325">   if (motion == msgMoveMotion.Down)</span>
<a href="#l4.326"></a><span id="l4.326">     newIndex += relativeStep;</span>
<a href="#l4.327"></a><span id="l4.327"> </span>
<a href="#l4.328"></a><span id="l4.328">   gCurrentFilterList.insertFilterAt(newIndex, selectedFilter);</span>
<a href="#l4.329"></a><span id="l4.329"> </span>
<a href="#l4.330"></a><span id="l4.330">   rebuildFilterList();</span>
<a href="#l4.331"></a><span id="l4.331"> }</span>
<a href="#l4.332"></a><span id="l4.332"> </span>
<a href="#l4.333"></a><span id="l4.333" class="difflineminus">-function viewLog()</span>
<a href="#l4.334"></a><span id="l4.334" class="difflineminus">-{</span>
<a href="#l4.335"></a><span id="l4.335" class="difflineplus">+function viewLog() {</span>
<a href="#l4.336"></a><span id="l4.336">   var args = {filterList: gCurrentFilterList};</span>
<a href="#l4.337"></a><span id="l4.337"> </span>
<a href="#l4.338"></a><span id="l4.338">   window.openDialog(&quot;chrome://messenger/content/viewLog.xul&quot;, &quot;FilterLog&quot;, &quot;chrome,modal,titlebar,resizable,centerscreen&quot;, args);</span>
<a href="#l4.339"></a><span id="l4.339"> }</span>
<a href="#l4.340"></a><span id="l4.340"> </span>
<a href="#l4.341"></a><span id="l4.341" class="difflineminus">-function onFilterUnload()</span>
<a href="#l4.342"></a><span id="l4.342" class="difflineminus">-{</span>
<a href="#l4.343"></a><span id="l4.343" class="difflineplus">+function onFilterUnload() {</span>
<a href="#l4.344"></a><span id="l4.344">   gCurrentFilterList.saveToDefaultFile();</span>
<a href="#l4.345"></a><span id="l4.345">   Services.obs.removeObserver(filterEditorQuitObserver,</span>
<a href="#l4.346"></a><span id="l4.346">                               &quot;quit-application-requested&quot;);</span>
<a href="#l4.347"></a><span id="l4.347"> }</span>
<a href="#l4.348"></a><span id="l4.348"> </span>
<a href="#l4.349"></a><span id="l4.349" class="difflineminus">-function onFilterClose()</span>
<a href="#l4.350"></a><span id="l4.350" class="difflineminus">-{</span>
<a href="#l4.351"></a><span id="l4.351" class="difflineplus">+function onFilterClose() {</span>
<a href="#l4.352"></a><span id="l4.352">   if (gRunFiltersButton.getAttribute(&quot;label&quot;) ==</span>
<a href="#l4.353"></a><span id="l4.353">       gRunFiltersButton.getAttribute(&quot;stoplabel&quot;)) {</span>
<a href="#l4.354"></a><span id="l4.354">     let promptTitle = gFilterBundle.getString(&quot;promptTitle&quot;);</span>
<a href="#l4.355"></a><span id="l4.355">     let promptMsg = gFilterBundle.getString(&quot;promptMsg&quot;);</span>
<a href="#l4.356"></a><span id="l4.356">     let stopButtonLabel = gFilterBundle.getString(&quot;stopButtonLabel&quot;);</span>
<a href="#l4.357"></a><span id="l4.357">     let continueButtonLabel = gFilterBundle.getString(&quot;continueButtonLabel&quot;);</span>
<a href="#l4.358"></a><span id="l4.358"> </span>
<a href="#l4.359"></a><span id="l4.359">     let result = Services.prompt.confirmEx(window, promptTitle, promptMsg,</span>
<a href="#l4.360"></a><span id="l4.360">                (Services.prompt.BUTTON_TITLE_IS_STRING * Services.prompt.BUTTON_POS_0) +</span>
<a href="#l4.361"></a><span id="l4.361">                (Services.prompt.BUTTON_TITLE_IS_STRING * Services.prompt.BUTTON_POS_1),</span>
<a href="#l4.362"></a><span id="l4.362" class="difflineminus">-               continueButtonLabel, stopButtonLabel, null, null, {value:0});</span>
<a href="#l4.363"></a><span id="l4.363" class="difflineplus">+               continueButtonLabel, stopButtonLabel, null, null, {value: 0});</span>
<a href="#l4.364"></a><span id="l4.364"> </span>
<a href="#l4.365"></a><span id="l4.365">     if (result)</span>
<a href="#l4.366"></a><span id="l4.366">       gFilterListMsgWindow.StopUrls();</span>
<a href="#l4.367"></a><span id="l4.367">     else</span>
<a href="#l4.368"></a><span id="l4.368">       return false;</span>
<a href="#l4.369"></a><span id="l4.369">   }</span>
<a href="#l4.370"></a><span id="l4.370"> </span>
<a href="#l4.371"></a><span id="l4.371">   return true;</span>
<a href="#l4.372"></a><span id="l4.372"> }</span>
<a href="#l4.373"></a><span id="l4.373"> </span>
<a href="#l4.374"></a><span id="l4.374" class="difflineminus">-function runSelectedFilters()</span>
<a href="#l4.375"></a><span id="l4.375" class="difflineminus">-{</span>
<a href="#l4.376"></a><span id="l4.376" class="difflineplus">+function runSelectedFilters() {</span>
<a href="#l4.377"></a><span id="l4.377">   // if run button has &quot;stop&quot; label, do stop.</span>
<a href="#l4.378"></a><span id="l4.378">   if (gRunFiltersButton.getAttribute(&quot;label&quot;) ==</span>
<a href="#l4.379"></a><span id="l4.379">       gRunFiltersButton.getAttribute(&quot;stoplabel&quot;)) {</span>
<a href="#l4.380"></a><span id="l4.380">     gFilterListMsgWindow.StopUrls();</span>
<a href="#l4.381"></a><span id="l4.381">     return;</span>
<a href="#l4.382"></a><span id="l4.382">   }</span>
<a href="#l4.383"></a><span id="l4.383"> </span>
<a href="#l4.384"></a><span id="l4.384">   let folder = gRunFiltersFolder._folder || gRunFiltersFolder.selectedItem._folder;</span>
<a href="#l4.385"></a><span id="l4.385" class="difflineat">@@ -652,50 +627,47 @@ function runSelectedFilters()</span>
<a href="#l4.386"></a><span id="l4.386">   let index = 0;</span>
<a href="#l4.387"></a><span id="l4.387">   for (let item of gFilterListbox.selectedItems) {</span>
<a href="#l4.388"></a><span id="l4.388">     filterList.insertFilterAt(index++, item._filter);</span>
<a href="#l4.389"></a><span id="l4.389">   }</span>
<a href="#l4.390"></a><span id="l4.390"> </span>
<a href="#l4.391"></a><span id="l4.391">   MailServices.filters.applyFiltersToFolders(filterList, folders, gFilterListMsgWindow);</span>
<a href="#l4.392"></a><span id="l4.392"> }</span>
<a href="#l4.393"></a><span id="l4.393"> </span>
<a href="#l4.394"></a><span id="l4.394" class="difflineminus">-function moveCurrentFilter(motion)</span>
<a href="#l4.395"></a><span id="l4.395" class="difflineminus">-{</span>
<a href="#l4.396"></a><span id="l4.396" class="difflineplus">+function moveCurrentFilter(motion) {</span>
<a href="#l4.397"></a><span id="l4.397">   let filter = currentFilter();</span>
<a href="#l4.398"></a><span id="l4.398">   if (!filter)</span>
<a href="#l4.399"></a><span id="l4.399">     return;</span>
<a href="#l4.400"></a><span id="l4.400"> </span>
<a href="#l4.401"></a><span id="l4.401">   gCurrentFilterList.moveFilter(filter, motion);</span>
<a href="#l4.402"></a><span id="l4.402">   rebuildFilterList();</span>
<a href="#l4.403"></a><span id="l4.403"> }</span>
<a href="#l4.404"></a><span id="l4.404"> </span>
<a href="#l4.405"></a><span id="l4.405"> /**</span>
<a href="#l4.406"></a><span id="l4.406">  * Redraws the list of filters. Takes the search box value into account.</span>
<a href="#l4.407"></a><span id="l4.407">  *</span>
<a href="#l4.408"></a><span id="l4.408">  * This function should perform very fast even in case of high number of filters.</span>
<a href="#l4.409"></a><span id="l4.409">  * Therefore there are some optimizations (e.g. listelement.itemChildren[] instead of</span>
<a href="#l4.410"></a><span id="l4.410">  * list.getItemAtIndex()), that favour speed vs. semantical perfection.</span>
<a href="#l4.411"></a><span id="l4.411">  */</span>
<a href="#l4.412"></a><span id="l4.412" class="difflineminus">-function rebuildFilterList()</span>
<a href="#l4.413"></a><span id="l4.413" class="difflineminus">-{</span>
<a href="#l4.414"></a><span id="l4.414" class="difflineplus">+function rebuildFilterList() {</span>
<a href="#l4.415"></a><span id="l4.415">   // Get filters that match the search box.</span>
<a href="#l4.416"></a><span id="l4.416">   let aTempFilterList = onFindFilter();</span>
<a href="#l4.417"></a><span id="l4.417"> </span>
<a href="#l4.418"></a><span id="l4.418">   let searchBoxFocus = false;</span>
<a href="#l4.419"></a><span id="l4.419">   let activeElement = document.activeElement;</span>
<a href="#l4.420"></a><span id="l4.420"> </span>
<a href="#l4.421"></a><span id="l4.421">   // Find if the currently focused element is a child inside the search box</span>
<a href="#l4.422"></a><span id="l4.422">   // (probably html:input). Traverse up the parents until the first element</span>
<a href="#l4.423"></a><span id="l4.423">   // with an ID is found. If it is not searchBox, return false.</span>
<a href="#l4.424"></a><span id="l4.424">   while (activeElement != null) {</span>
<a href="#l4.425"></a><span id="l4.425">     if (activeElement == gSearchBox) {</span>
<a href="#l4.426"></a><span id="l4.426">       searchBoxFocus = true;</span>
<a href="#l4.427"></a><span id="l4.427">       break;</span>
<a href="#l4.428"></a><span id="l4.428" class="difflineminus">-    }</span>
<a href="#l4.429"></a><span id="l4.429" class="difflineminus">-    else if (activeElement.id) {</span>
<a href="#l4.430"></a><span id="l4.430" class="difflineplus">+    } else if (activeElement.id) {</span>
<a href="#l4.431"></a><span id="l4.431">       searchBoxFocus = false;</span>
<a href="#l4.432"></a><span id="l4.432">       break;</span>
<a href="#l4.433"></a><span id="l4.433">     }</span>
<a href="#l4.434"></a><span id="l4.434">     activeElement = activeElement.parentNode;</span>
<a href="#l4.435"></a><span id="l4.435">   }</span>
<a href="#l4.436"></a><span id="l4.436"> </span>
<a href="#l4.437"></a><span id="l4.437">   // Make a note of which filters were previously selected</span>
<a href="#l4.438"></a><span id="l4.438">   let selectedNames = [];</span>
<a href="#l4.439"></a><span id="l4.439" class="difflineat">@@ -727,19 +699,17 @@ function rebuildFilterList()</span>
<a href="#l4.440"></a><span id="l4.440">       continue;</span>
<a href="#l4.441"></a><span id="l4.441"> </span>
<a href="#l4.442"></a><span id="l4.442">     if (listitemCount &gt; listitemIndex) {</span>
<a href="#l4.443"></a><span id="l4.443">       // If there is a free existing listitem, reuse it.</span>
<a href="#l4.444"></a><span id="l4.444">       // Use .itemChildren[] instead of .getItemAtIndex() as it is much faster.</span>
<a href="#l4.445"></a><span id="l4.445">       listitem = gFilterListbox.itemChildren[listitemIndex];</span>
<a href="#l4.446"></a><span id="l4.446">       nameCell = listitem.firstChild;</span>
<a href="#l4.447"></a><span id="l4.447">       enabledCell = nameCell.nextSibling;</span>
<a href="#l4.448"></a><span id="l4.448" class="difflineminus">-    }</span>
<a href="#l4.449"></a><span id="l4.449" class="difflineminus">-    else</span>
<a href="#l4.450"></a><span id="l4.450" class="difflineminus">-    {</span>
<a href="#l4.451"></a><span id="l4.451" class="difflineplus">+    } else {</span>
<a href="#l4.452"></a><span id="l4.452">       // If there are not enough listitems in the list, create a new one.</span>
<a href="#l4.453"></a><span id="l4.453">       listitem = document.createElement(&quot;richlistitem&quot;);</span>
<a href="#l4.454"></a><span id="l4.454">       listitem.setAttribute(&quot;align&quot;, &quot;center&quot;);</span>
<a href="#l4.455"></a><span id="l4.455">       listitem.setAttribute(&quot;role&quot;, &quot;checkbox&quot;);</span>
<a href="#l4.456"></a><span id="l4.456">       nameCell = document.createElement(&quot;label&quot;);</span>
<a href="#l4.457"></a><span id="l4.457">       nameCell.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l4.458"></a><span id="l4.458">       enabledCell = document.createElement(&quot;checkbox&quot;);</span>
<a href="#l4.459"></a><span id="l4.459">       enabledCell.setAttribute(&quot;style&quot;, &quot;padding-inline-start: 25px;&quot;);</span>
<a href="#l4.460"></a><span id="l4.460" class="difflineat">@@ -776,18 +746,17 @@ function rebuildFilterList()</span>
<a href="#l4.461"></a><span id="l4.461">   // If before rebuilding the list the searchbox was focused, focus it again.</span>
<a href="#l4.462"></a><span id="l4.462">   // In any other case, focus the list.</span>
<a href="#l4.463"></a><span id="l4.463">   if (searchBoxFocus)</span>
<a href="#l4.464"></a><span id="l4.464">     gSearchBox.focus();</span>
<a href="#l4.465"></a><span id="l4.465">   else</span>
<a href="#l4.466"></a><span id="l4.466">     gFilterListbox.focus();</span>
<a href="#l4.467"></a><span id="l4.467"> }</span>
<a href="#l4.468"></a><span id="l4.468"> </span>
<a href="#l4.469"></a><span id="l4.469" class="difflineminus">-function updateViewPosition(firstVisibleRowIndex)</span>
<a href="#l4.470"></a><span id="l4.470" class="difflineminus">-{</span>
<a href="#l4.471"></a><span id="l4.471" class="difflineplus">+function updateViewPosition(firstVisibleRowIndex) {</span>
<a href="#l4.472"></a><span id="l4.472">   if (firstVisibleRowIndex == -1)</span>
<a href="#l4.473"></a><span id="l4.473">     firstVisibleRowIndex = gFilterListbox.getIndexOfFirstVisibleRow();</span>
<a href="#l4.474"></a><span id="l4.474"> </span>
<a href="#l4.475"></a><span id="l4.475">   // Restore to the extent possible the scroll position.</span>
<a href="#l4.476"></a><span id="l4.476">   if (firstVisibleRowIndex &amp;&amp; gFilterListbox.itemCount)</span>
<a href="#l4.477"></a><span id="l4.477">     gFilterListbox.scrollToIndex(Math.min(firstVisibleRowIndex,</span>
<a href="#l4.478"></a><span id="l4.478">                                           gFilterListbox.itemCount - 1));</span>
<a href="#l4.479"></a><span id="l4.479"> </span>
<a href="#l4.480"></a><span id="l4.480" class="difflineat">@@ -805,18 +774,17 @@ function updateViewPosition(firstVisible</span>
<a href="#l4.481"></a><span id="l4.481"> </span>
<a href="#l4.482"></a><span id="l4.482"> /**</span>
<a href="#l4.483"></a><span id="l4.483">  * Try to only enable buttons that make sense</span>
<a href="#l4.484"></a><span id="l4.484">  *  - moving filters is currently only enabled for single selection</span>
<a href="#l4.485"></a><span id="l4.485">  *    also movement is restricted by searchBox and current selection position</span>
<a href="#l4.486"></a><span id="l4.486">  *  - edit only for single filters</span>
<a href="#l4.487"></a><span id="l4.487">  *  - delete / run only for one or more selected filters</span>
<a href="#l4.488"></a><span id="l4.488">  */</span>
<a href="#l4.489"></a><span id="l4.489" class="difflineminus">-function updateButtons()</span>
<a href="#l4.490"></a><span id="l4.490" class="difflineminus">-{</span>
<a href="#l4.491"></a><span id="l4.491" class="difflineplus">+function updateButtons() {</span>
<a href="#l4.492"></a><span id="l4.492">     var numFiltersSelected = gFilterListbox.selectedItems.length;</span>
<a href="#l4.493"></a><span id="l4.493">     var oneFilterSelected = (numFiltersSelected == 1);</span>
<a href="#l4.494"></a><span id="l4.494"> </span>
<a href="#l4.495"></a><span id="l4.495">     // &quot;edit&quot; is disabled when not exactly one filter is selected</span>
<a href="#l4.496"></a><span id="l4.496">     // or if we couldn't parse that filter</span>
<a href="#l4.497"></a><span id="l4.497">     let disabled = !oneFilterSelected || currentFilter().unparseable;</span>
<a href="#l4.498"></a><span id="l4.498">     gEditButton.disabled = disabled;</span>
<a href="#l4.499"></a><span id="l4.499"> </span>
<a href="#l4.500"></a><span id="l4.500" class="difflineat">@@ -849,90 +817,82 @@ function updateButtons()</span>
<a href="#l4.501"></a><span id="l4.501"> /**</span>
<a href="#l4.502"></a><span id="l4.502">  * Given a selected folder, returns the folder where filters should</span>
<a href="#l4.503"></a><span id="l4.503">  *  be defined (the root folder except for news) if the server can</span>
<a href="#l4.504"></a><span id="l4.504">  *  accept filters.</span>
<a href="#l4.505"></a><span id="l4.505">  *</span>
<a href="#l4.506"></a><span id="l4.506">  * @param   nsIMsgFolder aFolder - selected folder, from window args</span>
<a href="#l4.507"></a><span id="l4.507">  * @returns an nsIMsgFolder where the filter is defined</span>
<a href="#l4.508"></a><span id="l4.508">  */</span>
<a href="#l4.509"></a><span id="l4.509" class="difflineminus">-function getFilterFolderForSelection(aFolder)</span>
<a href="#l4.510"></a><span id="l4.510" class="difflineminus">-{</span>
<a href="#l4.511"></a><span id="l4.511" class="difflineplus">+function getFilterFolderForSelection(aFolder) {</span>
<a href="#l4.512"></a><span id="l4.512">   let rootFolder = aFolder &amp;&amp; aFolder.server ? aFolder.server.rootFolder : null;</span>
<a href="#l4.513"></a><span id="l4.513">   if (rootFolder &amp;&amp; rootFolder.isServer &amp;&amp; rootFolder.server.canHaveFilters)</span>
<a href="#l4.514"></a><span id="l4.514">     return (aFolder.server.type == &quot;nntp&quot;) ? aFolder : rootFolder;</span>
<a href="#l4.515"></a><span id="l4.515"> </span>
<a href="#l4.516"></a><span id="l4.516">   return null;</span>
<a href="#l4.517"></a><span id="l4.517"> }</span>
<a href="#l4.518"></a><span id="l4.518"> </span>
<a href="#l4.519"></a><span id="l4.519"> /**</span>
<a href="#l4.520"></a><span id="l4.520">  * If the selected server cannot have filters, get the default server.</span>
<a href="#l4.521"></a><span id="l4.521">  * If the default server cannot have filters, check all accounts</span>
<a href="#l4.522"></a><span id="l4.522">  * and get a server that can have filters.</span>
<a href="#l4.523"></a><span id="l4.523">  *</span>
<a href="#l4.524"></a><span id="l4.524">  * @returns an nsIMsgIncomingServer</span>
<a href="#l4.525"></a><span id="l4.525">  */</span>
<a href="#l4.526"></a><span id="l4.526" class="difflineminus">-function getServerThatCanHaveFilters()</span>
<a href="#l4.527"></a><span id="l4.527" class="difflineminus">-{</span>
<a href="#l4.528"></a><span id="l4.528" class="difflineplus">+function getServerThatCanHaveFilters() {</span>
<a href="#l4.529"></a><span id="l4.529">     let defaultIncomingServer = MailServices.accounts.defaultAccount.incomingServer;</span>
<a href="#l4.530"></a><span id="l4.530">     // Check to see if default server can have filters.</span>
<a href="#l4.531"></a><span id="l4.531">     if (defaultIncomingServer.canHaveFilters)</span>
<a href="#l4.532"></a><span id="l4.532">       return defaultIncomingServer;</span>
<a href="#l4.533"></a><span id="l4.533"> </span>
<a href="#l4.534"></a><span id="l4.534">     // If it cannot, check all accounts to find a server</span>
<a href="#l4.535"></a><span id="l4.535">     // that can have filters.</span>
<a href="#l4.536"></a><span id="l4.536">     let allServers = MailServices.accounts.allServers;</span>
<a href="#l4.537"></a><span id="l4.537" class="difflineminus">-    for (let currentServer of fixIterator(allServers,</span>
<a href="#l4.538"></a><span id="l4.538" class="difflineminus">-                                          Ci.nsIMsgIncomingServer))</span>
<a href="#l4.539"></a><span id="l4.539" class="difflineminus">-    {</span>
<a href="#l4.540"></a><span id="l4.540" class="difflineplus">+    for (let currentServer of fixIterator(allServers, Ci.nsIMsgIncomingServer)) {</span>
<a href="#l4.541"></a><span id="l4.541">       if (currentServer.canHaveFilters)</span>
<a href="#l4.542"></a><span id="l4.542">         return currentServer;</span>
<a href="#l4.543"></a><span id="l4.543">     }</span>
<a href="#l4.544"></a><span id="l4.544"> </span>
<a href="#l4.545"></a><span id="l4.545">     return null;</span>
<a href="#l4.546"></a><span id="l4.546"> }</span>
<a href="#l4.547"></a><span id="l4.547"> </span>
<a href="#l4.548"></a><span id="l4.548" class="difflineminus">-function onFilterClick(event)</span>
<a href="#l4.549"></a><span id="l4.549" class="difflineminus">-{</span>
<a href="#l4.550"></a><span id="l4.550" class="difflineplus">+function onFilterClick(event) {</span>
<a href="#l4.551"></a><span id="l4.551">     // we only care about button 0 (left click) events</span>
<a href="#l4.552"></a><span id="l4.552">     if (event.button != 0) {</span>
<a href="#l4.553"></a><span id="l4.553">       return;</span>
<a href="#l4.554"></a><span id="l4.554">     }</span>
<a href="#l4.555"></a><span id="l4.555"> </span>
<a href="#l4.556"></a><span id="l4.556">     toggleFilter(this.parentNode, !this.checked);</span>
<a href="#l4.557"></a><span id="l4.557"> }</span>
<a href="#l4.558"></a><span id="l4.558"> </span>
<a href="#l4.559"></a><span id="l4.559" class="difflineminus">-function onFilterDoubleClick(event)</span>
<a href="#l4.560"></a><span id="l4.560" class="difflineminus">-{</span>
<a href="#l4.561"></a><span id="l4.561" class="difflineplus">+function onFilterDoubleClick(event) {</span>
<a href="#l4.562"></a><span id="l4.562">     // we only care about button 0 (left click) events</span>
<a href="#l4.563"></a><span id="l4.563">     if (event.button != 0)</span>
<a href="#l4.564"></a><span id="l4.564">       return;</span>
<a href="#l4.565"></a><span id="l4.565"> </span>
<a href="#l4.566"></a><span id="l4.566">     onEditFilter();</span>
<a href="#l4.567"></a><span id="l4.567"> }</span>
<a href="#l4.568"></a><span id="l4.568"> </span>
<a href="#l4.569"></a><span id="l4.569" class="difflineminus">-function onFilterListKeyPress(aEvent)</span>
<a href="#l4.570"></a><span id="l4.570" class="difflineminus">-{</span>
<a href="#l4.571"></a><span id="l4.571" class="difflineplus">+function onFilterListKeyPress(aEvent) {</span>
<a href="#l4.572"></a><span id="l4.572">   if (aEvent.keyCode) {</span>
<a href="#l4.573"></a><span id="l4.573">     switch (aEvent.keyCode) {</span>
<a href="#l4.574"></a><span id="l4.574">       case KeyEvent.DOM_VK_INSERT:</span>
<a href="#l4.575"></a><span id="l4.575">         if (!document.getElementById(&quot;newButton&quot;).disabled)</span>
<a href="#l4.576"></a><span id="l4.576">           onNewFilter();</span>
<a href="#l4.577"></a><span id="l4.577">         break;</span>
<a href="#l4.578"></a><span id="l4.578">       case KeyEvent.DOM_VK_DELETE:</span>
<a href="#l4.579"></a><span id="l4.579">         if (!document.getElementById(&quot;deleteButton&quot;).disabled)</span>
<a href="#l4.580"></a><span id="l4.580">           onDeleteFilter();</span>
<a href="#l4.581"></a><span id="l4.581">         break;</span>
<a href="#l4.582"></a><span id="l4.582">       case KeyEvent.DOM_VK_RETURN:</span>
<a href="#l4.583"></a><span id="l4.583">         if (!document.getElementById(&quot;editButton&quot;).disabled)</span>
<a href="#l4.584"></a><span id="l4.584">           onEditFilter();</span>
<a href="#l4.585"></a><span id="l4.585">         break;</span>
<a href="#l4.586"></a><span id="l4.586">     }</span>
<a href="#l4.587"></a><span id="l4.587" class="difflineminus">-  }</span>
<a href="#l4.588"></a><span id="l4.588" class="difflineminus">-  else if (!aEvent.ctrlKey &amp;&amp; !aEvent.altKey &amp;&amp; !aEvent.metaKey) {</span>
<a href="#l4.589"></a><span id="l4.589" class="difflineplus">+  } else if (!aEvent.ctrlKey &amp;&amp; !aEvent.altKey &amp;&amp; !aEvent.metaKey) {</span>
<a href="#l4.590"></a><span id="l4.590">     switch (aEvent.charCode) {</span>
<a href="#l4.591"></a><span id="l4.591">       case KeyEvent.DOM_VK_SPACE:</span>
<a href="#l4.592"></a><span id="l4.592">         for (let item of gFilterListbox.selectedItems) {</span>
<a href="#l4.593"></a><span id="l4.593">           toggleFilter(item);</span>
<a href="#l4.594"></a><span id="l4.594">         }</span>
<a href="#l4.595"></a><span id="l4.595">         break;</span>
<a href="#l4.596"></a><span id="l4.596">       default:</span>
<a href="#l4.597"></a><span id="l4.597">         gSearchBox.focus();</span>
<a href="#l4.598"></a><span id="l4.598" class="difflineat">@@ -946,28 +906,26 @@ function onFilterListKeyPress(aEvent)</span>
<a href="#l4.599"></a><span id="l4.599">  *</span>
<a href="#l4.600"></a><span id="l4.600">  * @param  aFilter   nsIMsgFilter to check</span>
<a href="#l4.601"></a><span id="l4.601">  * @param  aKeyword  the string to find in the filter name</span>
<a href="#l4.602"></a><span id="l4.602">  *</span>
<a href="#l4.603"></a><span id="l4.603">  * @return  True if the filter name contains the searched keyword.</span>
<a href="#l4.604"></a><span id="l4.604">             Otherwise false. In the future this may be extended to match</span>
<a href="#l4.605"></a><span id="l4.605">             other filter attributes.</span>
<a href="#l4.606"></a><span id="l4.606">  */</span>
<a href="#l4.607"></a><span id="l4.607" class="difflineminus">-function filterSearchMatch(aFilter, aKeyword)</span>
<a href="#l4.608"></a><span id="l4.608" class="difflineminus">-{</span>
<a href="#l4.609"></a><span id="l4.609" class="difflineminus">-  return (aFilter.filterName.toLocaleLowerCase().includes(aKeyword))</span>
<a href="#l4.610"></a><span id="l4.610" class="difflineplus">+function filterSearchMatch(aFilter, aKeyword) {</span>
<a href="#l4.611"></a><span id="l4.611" class="difflineplus">+  return (aFilter.filterName.toLocaleLowerCase().includes(aKeyword));</span>
<a href="#l4.612"></a><span id="l4.612"> }</span>
<a href="#l4.613"></a><span id="l4.613"> </span>
<a href="#l4.614"></a><span id="l4.614"> /**</span>
<a href="#l4.615"></a><span id="l4.615">  * Called from rebuildFilterList when the list needs to be redrawn.</span>
<a href="#l4.616"></a><span id="l4.616">  * @return  Uses the search term in search box, to produce an array of</span>
<a href="#l4.617"></a><span id="l4.617">  *          row (filter) numbers (indexes) that match the search term.</span>
<a href="#l4.618"></a><span id="l4.618">  */</span>
<a href="#l4.619"></a><span id="l4.619" class="difflineminus">-function onFindFilter()</span>
<a href="#l4.620"></a><span id="l4.620" class="difflineminus">-{</span>
<a href="#l4.621"></a><span id="l4.621" class="difflineplus">+function onFindFilter() {</span>
<a href="#l4.622"></a><span id="l4.622">   let keyWord = gSearchBox.value.toLocaleLowerCase();</span>
<a href="#l4.623"></a><span id="l4.623"> </span>
<a href="#l4.624"></a><span id="l4.624">   // If searchbox is empty, just return and let rebuildFilterList</span>
<a href="#l4.625"></a><span id="l4.625">   // create an unfiltered list.</span>
<a href="#l4.626"></a><span id="l4.626">   if (!keyWord)</span>
<a href="#l4.627"></a><span id="l4.627">     return null;</span>
<a href="#l4.628"></a><span id="l4.628"> </span>
<a href="#l4.629"></a><span id="l4.629">   // Rematch everything in the list, remove what doesn't match the search box.</span>
<a href="#l4.630"></a><span id="l4.630" class="difflineat">@@ -985,28 +943,26 @@ function onFindFilter()</span>
<a href="#l4.631"></a><span id="l4.631"> </span>
<a href="#l4.632"></a><span id="l4.632"> /**</span>
<a href="#l4.633"></a><span id="l4.633">  * Clear the search term in the search box if needed.</span>
<a href="#l4.634"></a><span id="l4.634">  *</span>
<a href="#l4.635"></a><span id="l4.635">  * @param aFilter  If this nsIMsgFilter matches the search term,</span>
<a href="#l4.636"></a><span id="l4.636">  *                 do not reset the box. If this is null,</span>
<a href="#l4.637"></a><span id="l4.637">  *                 reset unconditionally.</span>
<a href="#l4.638"></a><span id="l4.638">  */</span>
<a href="#l4.639"></a><span id="l4.639" class="difflineminus">-function resetSearchBox(aFilter)</span>
<a href="#l4.640"></a><span id="l4.640" class="difflineminus">-{</span>
<a href="#l4.641"></a><span id="l4.641" class="difflineplus">+function resetSearchBox(aFilter) {</span>
<a href="#l4.642"></a><span id="l4.642">   let keyword = gSearchBox.value.toLocaleLowerCase();</span>
<a href="#l4.643"></a><span id="l4.643">   if (keyword &amp;&amp; (!aFilter || !filterSearchMatch(aFilter, keyword)))</span>
<a href="#l4.644"></a><span id="l4.644">     gSearchBox.reset();</span>
<a href="#l4.645"></a><span id="l4.645"> }</span>
<a href="#l4.646"></a><span id="l4.646"> </span>
<a href="#l4.647"></a><span id="l4.647"> /**</span>
<a href="#l4.648"></a><span id="l4.648">  * Display &quot;1 item&quot;,  &quot;11 items&quot; or &quot;4 of 10&quot; if list is filtered via search box.</span>
<a href="#l4.649"></a><span id="l4.649">  */</span>
<a href="#l4.650"></a><span id="l4.650" class="difflineminus">-function updateCountBox()</span>
<a href="#l4.651"></a><span id="l4.651" class="difflineminus">-{</span>
<a href="#l4.652"></a><span id="l4.652" class="difflineplus">+function updateCountBox() {</span>
<a href="#l4.653"></a><span id="l4.653">   let countBox = document.getElementById(&quot;countBox&quot;);</span>
<a href="#l4.654"></a><span id="l4.654">   let sum = gCurrentFilterList.filterCount;</span>
<a href="#l4.655"></a><span id="l4.655">   let len = gFilterListbox.itemCount;</span>
<a href="#l4.656"></a><span id="l4.656"> </span>
<a href="#l4.657"></a><span id="l4.657">   if (len == sum) {</span>
<a href="#l4.658"></a><span id="l4.658">     // &quot;N items&quot;</span>
<a href="#l4.659"></a><span id="l4.659">     countBox.value = PluralForm.get(len, gFilterBundle.getString(&quot;filterCountItems&quot;))</span>
<a href="#l4.660"></a><span id="l4.660">                                .replace(&quot;#1&quot;, len);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/base/content/SearchDialog.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/base/content/SearchDialog.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -27,21 +27,19 @@ var gDataSourceSearchListener;</span>
<a href="#l5.4"></a><span id="l5.4"> var gViewSearchListener;</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6"> var gSearchStopButton;</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> // Should we try to search online?</span>
<a href="#l5.9"></a><span id="l5.9"> var gSearchOnline = false;</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11"> // Controller object for search results thread pane</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-var nsSearchResultsController =</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-{</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-    supportsCommand: function(command)</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-    {</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-        switch(command) {</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+var nsSearchResultsController = {</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+    supportsCommand(command) {</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+        switch (command) {</span>
<a href="#l5.20"></a><span id="l5.20">         case &quot;cmd_delete&quot;:</span>
<a href="#l5.21"></a><span id="l5.21">         case &quot;cmd_shiftDelete&quot;:</span>
<a href="#l5.22"></a><span id="l5.22">         case &quot;button_delete&quot;:</span>
<a href="#l5.23"></a><span id="l5.23">         case &quot;cmd_open&quot;:</span>
<a href="#l5.24"></a><span id="l5.24">         case &quot;file_message_button&quot;:</span>
<a href="#l5.25"></a><span id="l5.25">         case &quot;open_in_folder_button&quot;:</span>
<a href="#l5.26"></a><span id="l5.26">         case &quot;saveas_vf_button&quot;:</span>
<a href="#l5.27"></a><span id="l5.27">         case &quot;cmd_selectAll&quot;:</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineat">@@ -49,18 +47,17 @@ var nsSearchResultsController =</span>
<a href="#l5.29"></a><span id="l5.29">         default:</span>
<a href="#l5.30"></a><span id="l5.30">             return false;</span>
<a href="#l5.31"></a><span id="l5.31">         }</span>
<a href="#l5.32"></a><span id="l5.32">     },</span>
<a href="#l5.33"></a><span id="l5.33"> </span>
<a href="#l5.34"></a><span id="l5.34">     // this controller only handles commands</span>
<a href="#l5.35"></a><span id="l5.35">     // that rely on items being selected in</span>
<a href="#l5.36"></a><span id="l5.36">     // the search results pane.</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-    isCommandEnabled: function(command)</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-    {</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+    isCommandEnabled(command) {</span>
<a href="#l5.40"></a><span id="l5.40">         var enabled = true;</span>
<a href="#l5.41"></a><span id="l5.41"> </span>
<a href="#l5.42"></a><span id="l5.42">         switch (command) {</span>
<a href="#l5.43"></a><span id="l5.43">           case &quot;open_in_folder_button&quot;:</span>
<a href="#l5.44"></a><span id="l5.44">             if (gFolderDisplay.selectedCount != 1)</span>
<a href="#l5.45"></a><span id="l5.45">               enabled = false;</span>
<a href="#l5.46"></a><span id="l5.46">             break;</span>
<a href="#l5.47"></a><span id="l5.47">           case &quot;cmd_delete&quot;:</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineat">@@ -79,19 +76,18 @@ var nsSearchResultsController =</span>
<a href="#l5.49"></a><span id="l5.49">             if (gFolderDisplay.selectedCount &lt;= 0)</span>
<a href="#l5.50"></a><span id="l5.50">               enabled = false;</span>
<a href="#l5.51"></a><span id="l5.51">             break;</span>
<a href="#l5.52"></a><span id="l5.52">         }</span>
<a href="#l5.53"></a><span id="l5.53"> </span>
<a href="#l5.54"></a><span id="l5.54">         return enabled;</span>
<a href="#l5.55"></a><span id="l5.55">     },</span>
<a href="#l5.56"></a><span id="l5.56"> </span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-    doCommand: function(command)</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-    {</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-        switch(command) {</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+    doCommand(command) {</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+        switch (command) {</span>
<a href="#l5.62"></a><span id="l5.62">         case &quot;cmd_open&quot;:</span>
<a href="#l5.63"></a><span id="l5.63">             MsgOpenSelectedMessages();</span>
<a href="#l5.64"></a><span id="l5.64">             return true;</span>
<a href="#l5.65"></a><span id="l5.65"> </span>
<a href="#l5.66"></a><span id="l5.66">         case &quot;cmd_delete&quot;:</span>
<a href="#l5.67"></a><span id="l5.67">         case &quot;button_delete&quot;:</span>
<a href="#l5.68"></a><span id="l5.68">             MsgDeleteSelectedMessages(nsMsgViewCommandType.deleteMsg);</span>
<a href="#l5.69"></a><span id="l5.69">             return true;</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineat">@@ -114,73 +110,69 @@ var nsSearchResultsController =</span>
<a href="#l5.71"></a><span id="l5.71">             return true;</span>
<a href="#l5.72"></a><span id="l5.72"> </span>
<a href="#l5.73"></a><span id="l5.73">         default:</span>
<a href="#l5.74"></a><span id="l5.74">             return false;</span>
<a href="#l5.75"></a><span id="l5.75">         }</span>
<a href="#l5.76"></a><span id="l5.76"> </span>
<a href="#l5.77"></a><span id="l5.77">     },</span>
<a href="#l5.78"></a><span id="l5.78"> </span>
<a href="#l5.79"></a><span id="l5.79" class="difflineminus">-    onEvent: function(event)</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineminus">-    {</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineminus">-    }</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineminus">-}</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+    onEvent(event) {</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+    },</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+};</span>
<a href="#l5.86"></a><span id="l5.86"> </span>
<a href="#l5.87"></a><span id="l5.87" class="difflineminus">-function UpdateMailSearch(caller)</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineminus">-{</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineminus">-  document.commandDispatcher.updateCommands('mail-search');</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+function UpdateMailSearch(caller) {</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+  document.commandDispatcher.updateCommands(&quot;mail-search&quot;);</span>
<a href="#l5.92"></a><span id="l5.92"> }</span>
<a href="#l5.93"></a><span id="l5.93"> /**</span>
<a href="#l5.94"></a><span id="l5.94">  * FolderDisplayWidget currently calls this function when the command updater</span>
<a href="#l5.95"></a><span id="l5.95">  *  notification for updateCommandStatus is called.  We don't have a toolbar,</span>
<a href="#l5.96"></a><span id="l5.96">  *  but our 'mail-search' command set serves the same purpose.</span>
<a href="#l5.97"></a><span id="l5.97">  */</span>
<a href="#l5.98"></a><span id="l5.98"> var UpdateMailToolbar = UpdateMailSearch;</span>
<a href="#l5.99"></a><span id="l5.99"> </span>
<a href="#l5.100"></a><span id="l5.100"> /**</span>
<a href="#l5.101"></a><span id="l5.101">  * No-op clear message pane function for FolderDisplayWidget.</span>
<a href="#l5.102"></a><span id="l5.102">  */</span>
<a href="#l5.103"></a><span id="l5.103"> function ClearMessagePane() {</span>
<a href="#l5.104"></a><span id="l5.104"> }</span>
<a href="#l5.105"></a><span id="l5.105"> </span>
<a href="#l5.106"></a><span id="l5.106" class="difflineminus">-function SetAdvancedSearchStatusText(aNumHits)</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineminus">-{</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineplus">+function SetAdvancedSearchStatusText(aNumHits) {</span>
<a href="#l5.109"></a><span id="l5.109"> }</span>
<a href="#l5.110"></a><span id="l5.110"> </span>
<a href="#l5.111"></a><span id="l5.111"> /**</span>
<a href="#l5.112"></a><span id="l5.112">  * Subclass the FolderDisplayWidget to deal with UI specific to the search</span>
<a href="#l5.113"></a><span id="l5.113">  *  window.</span>
<a href="#l5.114"></a><span id="l5.114">  */</span>
<a href="#l5.115"></a><span id="l5.115"> function SearchFolderDisplayWidget(aMessageDisplay) {</span>
<a href="#l5.116"></a><span id="l5.116">   FolderDisplayWidget.call(this, /* no tab info */ null, aMessageDisplay);</span>
<a href="#l5.117"></a><span id="l5.117"> }</span>
<a href="#l5.118"></a><span id="l5.118"> </span>
<a href="#l5.119"></a><span id="l5.119"> SearchFolderDisplayWidget.prototype = {</span>
<a href="#l5.120"></a><span id="l5.120">   __proto__: FolderDisplayWidget.prototype,</span>
<a href="#l5.121"></a><span id="l5.121"> </span>
<a href="#l5.122"></a><span id="l5.122" class="difflineminus">-  /// folder display will want to show the thread pane; we need do nothing</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineminus">-  _showThreadPane: function () {},</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineplus">+  // folder display will want to show the thread pane; we need do nothing</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+  _showThreadPane() {},</span>
<a href="#l5.126"></a><span id="l5.126"> </span>
<a href="#l5.127"></a><span id="l5.127" class="difflineminus">-  onSearching: function SearchFolderDisplayWidget_onSearch(aIsSearching) {</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+  onSearching(aIsSearching) {</span>
<a href="#l5.129"></a><span id="l5.129">     if (aIsSearching) {</span>
<a href="#l5.130"></a><span id="l5.130">       // Search button becomes the &quot;stop&quot; button</span>
<a href="#l5.131"></a><span id="l5.131">       gSearchStopButton.setAttribute(</span>
<a href="#l5.132"></a><span id="l5.132">         &quot;label&quot;, gSearchBundle.getString(&quot;labelForStopButton&quot;));</span>
<a href="#l5.133"></a><span id="l5.133">       gSearchStopButton.setAttribute(</span>
<a href="#l5.134"></a><span id="l5.134">         &quot;accesskey&quot;, gSearchBundle.getString(&quot;labelForStopButton.accesskey&quot;));</span>
<a href="#l5.135"></a><span id="l5.135"> </span>
<a href="#l5.136"></a><span id="l5.136">       // update our toolbar equivalent</span>
<a href="#l5.137"></a><span id="l5.137">       UpdateMailSearch(&quot;new-search&quot;);</span>
<a href="#l5.138"></a><span id="l5.138">       // spin the meteors</span>
<a href="#l5.139"></a><span id="l5.139">       gStatusFeedback._startMeteors();</span>
<a href="#l5.140"></a><span id="l5.140">       // tell the user that we're searching</span>
<a href="#l5.141"></a><span id="l5.141">       gStatusFeedback.showStatusString(</span>
<a href="#l5.142"></a><span id="l5.142">         gSearchBundle.getString(&quot;searchingMessage&quot;));</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineminus">-    }</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineminus">-    else {</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+    } else {</span>
<a href="#l5.146"></a><span id="l5.146">       // Stop button resumes being the &quot;search&quot; button</span>
<a href="#l5.147"></a><span id="l5.147">       gSearchStopButton.setAttribute(</span>
<a href="#l5.148"></a><span id="l5.148">         &quot;label&quot;, gSearchBundle.getString(&quot;labelForSearchButton&quot;));</span>
<a href="#l5.149"></a><span id="l5.149">       gSearchStopButton.setAttribute(</span>
<a href="#l5.150"></a><span id="l5.150">         &quot;accesskey&quot;, gSearchBundle.getString(&quot;labelForSearchButton.accesskey&quot;));</span>
<a href="#l5.151"></a><span id="l5.151"> </span>
<a href="#l5.152"></a><span id="l5.152">       // update our toolbar equivalent</span>
<a href="#l5.153"></a><span id="l5.153">       UpdateMailSearch(&quot;done-search&quot;);</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineat">@@ -190,43 +182,41 @@ SearchFolderDisplayWidget.prototype = {</span>
<a href="#l5.155"></a><span id="l5.155">       this.updateStatusResultText();</span>
<a href="#l5.156"></a><span id="l5.156">     }</span>
<a href="#l5.157"></a><span id="l5.157">   },</span>
<a href="#l5.158"></a><span id="l5.158"> </span>
<a href="#l5.159"></a><span id="l5.159">   /**</span>
<a href="#l5.160"></a><span id="l5.160">    * If messages were removed, we might have lost some search results and so</span>
<a href="#l5.161"></a><span id="l5.161">    *  should update our search result text.  Also, defer to our super-class.</span>
<a href="#l5.162"></a><span id="l5.162">    */</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineminus">-  onMessagesRemoved: function SearchFolderDisplayWidget_onMessagesRemoved() {</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineplus">+  onMessagesRemoved() {</span>
<a href="#l5.165"></a><span id="l5.165">     // result text is only for when we are not searching</span>
<a href="#l5.166"></a><span id="l5.166">     if (!this.view.searching)</span>
<a href="#l5.167"></a><span id="l5.167">       this.updateStatusResultText();</span>
<a href="#l5.168"></a><span id="l5.168">     this.__proto__.__proto__.onMessagesRemoved.call(this);</span>
<a href="#l5.169"></a><span id="l5.169">   },</span>
<a href="#l5.170"></a><span id="l5.170"> </span>
<a href="#l5.171"></a><span id="l5.171" class="difflineminus">-  updateStatusResultText: function() {</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineplus">+  updateStatusResultText() {</span>
<a href="#l5.173"></a><span id="l5.173">     let rowCount = this.view.dbView.rowCount;</span>
<a href="#l5.174"></a><span id="l5.174">     let statusMsg;</span>
<a href="#l5.175"></a><span id="l5.175"> </span>
<a href="#l5.176"></a><span id="l5.176">     if (rowCount == 0) {</span>
<a href="#l5.177"></a><span id="l5.177">       statusMsg = gSearchBundle.getString(&quot;noMatchesFound&quot;);</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineminus">-    }</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineminus">-    else {</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineplus">+    } else {</span>
<a href="#l5.181"></a><span id="l5.181">       statusMsg = PluralForm.get(rowCount,</span>
<a href="#l5.182"></a><span id="l5.182">                                  gSearchBundle.getString(&quot;matchesFound&quot;));</span>
<a href="#l5.183"></a><span id="l5.183">       statusMsg = statusMsg.replace(&quot;#1&quot;, rowCount);</span>
<a href="#l5.184"></a><span id="l5.184">     }</span>
<a href="#l5.185"></a><span id="l5.185"> </span>
<a href="#l5.186"></a><span id="l5.186">     gStatusFeedback.showStatusString(statusMsg);</span>
<a href="#l5.187"></a><span id="l5.187">   },</span>
<a href="#l5.188"></a><span id="l5.188"> };</span>
<a href="#l5.189"></a><span id="l5.189"> </span>
<a href="#l5.190"></a><span id="l5.190"> </span>
<a href="#l5.191"></a><span id="l5.191" class="difflineminus">-function searchOnLoad()</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineminus">-{</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineplus">+function searchOnLoad() {</span>
<a href="#l5.194"></a><span id="l5.194">   initializeSearchWidgets();</span>
<a href="#l5.195"></a><span id="l5.195">   initializeSearchWindowWidgets();</span>
<a href="#l5.196"></a><span id="l5.196">   messenger = Cc[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l5.197"></a><span id="l5.197">                 .createInstance(Ci.nsIMessenger);</span>
<a href="#l5.198"></a><span id="l5.198"> </span>
<a href="#l5.199"></a><span id="l5.199">   gSearchBundle = document.getElementById(&quot;bundle_search&quot;);</span>
<a href="#l5.200"></a><span id="l5.200">   gSearchStopButton.setAttribute(&quot;label&quot;, gSearchBundle.getString(&quot;labelForSearchButton&quot;));</span>
<a href="#l5.201"></a><span id="l5.201">   gSearchStopButton.setAttribute(&quot;accesskey&quot;, gSearchBundle.getString(&quot;labelForSearchButton.accesskey&quot;));</span>
<a href="#l5.202"></a><span id="l5.202" class="difflineat">@@ -252,27 +242,25 @@ function searchOnLoad()</span>
<a href="#l5.203"></a><span id="l5.203">       updateSearchFolderPicker(window.arguments[0].folder);</span>
<a href="#l5.204"></a><span id="l5.204"> </span>
<a href="#l5.205"></a><span id="l5.205">   // trigger searchTermOverlay.js to create the first criterion</span>
<a href="#l5.206"></a><span id="l5.206">   onMore(null);</span>
<a href="#l5.207"></a><span id="l5.207">   // make sure all the buttons are configured</span>
<a href="#l5.208"></a><span id="l5.208">   UpdateMailSearch(&quot;onload&quot;);</span>
<a href="#l5.209"></a><span id="l5.209"> }</span>
<a href="#l5.210"></a><span id="l5.210"> </span>
<a href="#l5.211"></a><span id="l5.211" class="difflineminus">-function searchOnUnload()</span>
<a href="#l5.212"></a><span id="l5.212" class="difflineminus">-{</span>
<a href="#l5.213"></a><span id="l5.213" class="difflineplus">+function searchOnUnload() {</span>
<a href="#l5.214"></a><span id="l5.214">   gFolderDisplay.close();</span>
<a href="#l5.215"></a><span id="l5.215">   top.controllers.removeController(nsSearchResultsController);</span>
<a href="#l5.216"></a><span id="l5.216"> </span>
<a href="#l5.217"></a><span id="l5.217">   // release this early because msgWindow holds a weak reference</span>
<a href="#l5.218"></a><span id="l5.218">   msgWindow.rootDocShell = null;</span>
<a href="#l5.219"></a><span id="l5.219"> }</span>
<a href="#l5.220"></a><span id="l5.220"> </span>
<a href="#l5.221"></a><span id="l5.221" class="difflineminus">-function initializeSearchWindowWidgets()</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineminus">-{</span>
<a href="#l5.223"></a><span id="l5.223" class="difflineplus">+function initializeSearchWindowWidgets() {</span>
<a href="#l5.224"></a><span id="l5.224">     gFolderPicker = document.getElementById(&quot;searchableFolders&quot;);</span>
<a href="#l5.225"></a><span id="l5.225">     gSearchStopButton = document.getElementById(&quot;search-button&quot;);</span>
<a href="#l5.226"></a><span id="l5.226">     hideMatchAllItem();</span>
<a href="#l5.227"></a><span id="l5.227"> </span>
<a href="#l5.228"></a><span id="l5.228">     msgWindow = Cc[&quot;@mozilla.org/messenger/msgwindow;1&quot;]</span>
<a href="#l5.229"></a><span id="l5.229">                   .createInstance(nsIMsgWindow);</span>
<a href="#l5.230"></a><span id="l5.230">     msgWindow.domWindow = window;</span>
<a href="#l5.231"></a><span id="l5.231">     msgWindow.rootDocShell.appType = Ci.nsIDocShell.APP_TYPE_MAIL;</span>
<a href="#l5.232"></a><span id="l5.232" class="difflineat">@@ -292,66 +280,56 @@ function onSearchStop() {</span>
<a href="#l5.233"></a><span id="l5.233"> </span>
<a href="#l5.234"></a><span id="l5.234"> function onResetSearch(event) {</span>
<a href="#l5.235"></a><span id="l5.235">   onReset(event);</span>
<a href="#l5.236"></a><span id="l5.236">   gFolderDisplay.view.search.clear();</span>
<a href="#l5.237"></a><span id="l5.237"> </span>
<a href="#l5.238"></a><span id="l5.238">   gStatusFeedback.showStatusString(&quot;&quot;);</span>
<a href="#l5.239"></a><span id="l5.239"> }</span>
<a href="#l5.240"></a><span id="l5.240"> </span>
<a href="#l5.241"></a><span id="l5.241" class="difflineminus">-function updateSearchFolderPicker(folder)</span>
<a href="#l5.242"></a><span id="l5.242" class="difflineminus">-{</span>
<a href="#l5.243"></a><span id="l5.243" class="difflineplus">+function updateSearchFolderPicker(folder) {</span>
<a href="#l5.244"></a><span id="l5.244">   gCurrentFolder = folder;</span>
<a href="#l5.245"></a><span id="l5.245">   gFolderPicker.menupopup.selectFolder(folder);</span>
<a href="#l5.246"></a><span id="l5.246"> </span>
<a href="#l5.247"></a><span id="l5.247">   var searchOnline = document.getElementById(&quot;checkSearchOnline&quot;);</span>
<a href="#l5.248"></a><span id="l5.248">   // We will hide and disable the search online checkbox if we are offline, or</span>
<a href="#l5.249"></a><span id="l5.249">   // if the folder does not support online search.</span>
<a href="#l5.250"></a><span id="l5.250"> </span>
<a href="#l5.251"></a><span id="l5.251">   // Any offlineSupportLevel &gt; 0 is an online server like IMAP or news.</span>
<a href="#l5.252"></a><span id="l5.252" class="difflineminus">-  if (gCurrentFolder.server.offlineSupportLevel &amp;&amp;</span>
<a href="#l5.253"></a><span id="l5.253" class="difflineminus">-      !Services.io.offline)</span>
<a href="#l5.254"></a><span id="l5.254" class="difflineminus">-  {</span>
<a href="#l5.255"></a><span id="l5.255" class="difflineplus">+  if (gCurrentFolder.server.offlineSupportLevel &amp;&amp; !Services.io.offline) {</span>
<a href="#l5.256"></a><span id="l5.256">     searchOnline.hidden = false;</span>
<a href="#l5.257"></a><span id="l5.257">     searchOnline.disabled = false;</span>
<a href="#l5.258"></a><span id="l5.258" class="difflineminus">-  }</span>
<a href="#l5.259"></a><span id="l5.259" class="difflineminus">-  else</span>
<a href="#l5.260"></a><span id="l5.260" class="difflineminus">-  {</span>
<a href="#l5.261"></a><span id="l5.261" class="difflineplus">+  } else {</span>
<a href="#l5.262"></a><span id="l5.262">     searchOnline.hidden = true;</span>
<a href="#l5.263"></a><span id="l5.263">     searchOnline.disabled = true;</span>
<a href="#l5.264"></a><span id="l5.264">   }</span>
<a href="#l5.265"></a><span id="l5.265">   setSearchScope(GetScopeForFolder(gCurrentFolder));</span>
<a href="#l5.266"></a><span id="l5.266"> }</span>
<a href="#l5.267"></a><span id="l5.267"> </span>
<a href="#l5.268"></a><span id="l5.268" class="difflineminus">-function updateSearchLocalSystem()</span>
<a href="#l5.269"></a><span id="l5.269" class="difflineminus">-{</span>
<a href="#l5.270"></a><span id="l5.270" class="difflineplus">+function updateSearchLocalSystem() {</span>
<a href="#l5.271"></a><span id="l5.271">   setSearchScope(GetScopeForFolder(gCurrentFolder));</span>
<a href="#l5.272"></a><span id="l5.272"> }</span>
<a href="#l5.273"></a><span id="l5.273"> </span>
<a href="#l5.274"></a><span id="l5.274" class="difflineminus">-function UpdateAfterCustomHeaderChange()</span>
<a href="#l5.275"></a><span id="l5.275" class="difflineminus">-{</span>
<a href="#l5.276"></a><span id="l5.276" class="difflineplus">+function UpdateAfterCustomHeaderChange() {</span>
<a href="#l5.277"></a><span id="l5.277">   updateSearchAttributes();</span>
<a href="#l5.278"></a><span id="l5.278"> }</span>
<a href="#l5.279"></a><span id="l5.279"> </span>
<a href="#l5.280"></a><span id="l5.280" class="difflineminus">-function onEnterInSearchTerm()</span>
<a href="#l5.281"></a><span id="l5.281" class="difflineminus">-{</span>
<a href="#l5.282"></a><span id="l5.282" class="difflineplus">+function onEnterInSearchTerm() {</span>
<a href="#l5.283"></a><span id="l5.283">   // on enter</span>
<a href="#l5.284"></a><span id="l5.284">   // if not searching, start the search</span>
<a href="#l5.285"></a><span id="l5.285">   // if searching, stop and then start again</span>
<a href="#l5.286"></a><span id="l5.286">   if (gSearchStopButton.getAttribute(&quot;label&quot;) == gSearchBundle.getString(&quot;labelForSearchButton&quot;)) {</span>
<a href="#l5.287"></a><span id="l5.287">      onSearch();</span>
<a href="#l5.288"></a><span id="l5.288" class="difflineminus">-  }</span>
<a href="#l5.289"></a><span id="l5.289" class="difflineminus">-  else {</span>
<a href="#l5.290"></a><span id="l5.290" class="difflineplus">+  } else {</span>
<a href="#l5.291"></a><span id="l5.291">      onSearchStop();</span>
<a href="#l5.292"></a><span id="l5.292">      onSearch();</span>
<a href="#l5.293"></a><span id="l5.293">   }</span>
<a href="#l5.294"></a><span id="l5.294"> }</span>
<a href="#l5.295"></a><span id="l5.295"> </span>
<a href="#l5.296"></a><span id="l5.296" class="difflineminus">-function onSearch()</span>
<a href="#l5.297"></a><span id="l5.297" class="difflineminus">-{</span>
<a href="#l5.298"></a><span id="l5.298" class="difflineplus">+function onSearch() {</span>
<a href="#l5.299"></a><span id="l5.299">   let viewWrapper = gFolderDisplay.view;</span>
<a href="#l5.300"></a><span id="l5.300">   let searchTerms = getSearchTerms();</span>
<a href="#l5.301"></a><span id="l5.301"> </span>
<a href="#l5.302"></a><span id="l5.302">   viewWrapper.beginViewUpdate();</span>
<a href="#l5.303"></a><span id="l5.303">   viewWrapper.search.userTerms = searchTerms.length ? searchTerms : null;</span>
<a href="#l5.304"></a><span id="l5.304">   viewWrapper.search.onlineSearch = gSearchOnline;</span>
<a href="#l5.305"></a><span id="l5.305">   viewWrapper.searchFolders = getSearchFolders();</span>
<a href="#l5.306"></a><span id="l5.306">   viewWrapper.endViewUpdate();</span>
<a href="#l5.307"></a><span id="l5.307" class="difflineat">@@ -411,40 +389,35 @@ function AddSubFolders(folder, outFolder</span>
<a href="#l5.308"></a><span id="l5.308">       if (!nextFolder.noSelect)</span>
<a href="#l5.309"></a><span id="l5.309">         outFolders.push(nextFolder);</span>
<a href="#l5.310"></a><span id="l5.310"> </span>
<a href="#l5.311"></a><span id="l5.311">       AddSubFolders(nextFolder, outFolders);</span>
<a href="#l5.312"></a><span id="l5.312">     }</span>
<a href="#l5.313"></a><span id="l5.313">   }</span>
<a href="#l5.314"></a><span id="l5.314"> }</span>
<a href="#l5.315"></a><span id="l5.315"> </span>
<a href="#l5.316"></a><span id="l5.316" class="difflineminus">-function AddSubFoldersToURI(folder)</span>
<a href="#l5.317"></a><span id="l5.317" class="difflineminus">-{</span>
<a href="#l5.318"></a><span id="l5.318" class="difflineplus">+function AddSubFoldersToURI(folder) {</span>
<a href="#l5.319"></a><span id="l5.319">   var returnString = &quot;&quot;;</span>
<a href="#l5.320"></a><span id="l5.320"> </span>
<a href="#l5.321"></a><span id="l5.321">   var subFolders = folder.subFolders;</span>
<a href="#l5.322"></a><span id="l5.322"> </span>
<a href="#l5.323"></a><span id="l5.323" class="difflineminus">-  while (subFolders.hasMoreElements())</span>
<a href="#l5.324"></a><span id="l5.324" class="difflineminus">-  {</span>
<a href="#l5.325"></a><span id="l5.325" class="difflineplus">+  while (subFolders.hasMoreElements()) {</span>
<a href="#l5.326"></a><span id="l5.326">     var nextFolder =</span>
<a href="#l5.327"></a><span id="l5.327">       subFolders.getNext().QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l5.328"></a><span id="l5.328"> </span>
<a href="#l5.329"></a><span id="l5.329" class="difflineminus">-    if (!(nextFolder.flags &amp; Ci.nsMsgFolderFlags.Virtual))</span>
<a href="#l5.330"></a><span id="l5.330" class="difflineminus">-    {</span>
<a href="#l5.331"></a><span id="l5.331" class="difflineminus">-      if (!nextFolder.noSelect &amp;&amp; !nextFolder.isServer)</span>
<a href="#l5.332"></a><span id="l5.332" class="difflineminus">-      {</span>
<a href="#l5.333"></a><span id="l5.333" class="difflineplus">+    if (!(nextFolder.flags &amp; Ci.nsMsgFolderFlags.Virtual)) {</span>
<a href="#l5.334"></a><span id="l5.334" class="difflineplus">+      if (!nextFolder.noSelect &amp;&amp; !nextFolder.isServer) {</span>
<a href="#l5.335"></a><span id="l5.335">         if (returnString.length &gt; 0)</span>
<a href="#l5.336"></a><span id="l5.336" class="difflineminus">-          returnString += '|';</span>
<a href="#l5.337"></a><span id="l5.337" class="difflineplus">+          returnString += &quot;|&quot;;</span>
<a href="#l5.338"></a><span id="l5.338">         returnString += nextFolder.URI;</span>
<a href="#l5.339"></a><span id="l5.339">       }</span>
<a href="#l5.340"></a><span id="l5.340">       var subFoldersString = AddSubFoldersToURI(nextFolder);</span>
<a href="#l5.341"></a><span id="l5.341" class="difflineminus">-      if (subFoldersString.length &gt; 0)</span>
<a href="#l5.342"></a><span id="l5.342" class="difflineminus">-      {</span>
<a href="#l5.343"></a><span id="l5.343" class="difflineplus">+      if (subFoldersString.length &gt; 0) {</span>
<a href="#l5.344"></a><span id="l5.344">         if (returnString.length &gt; 0)</span>
<a href="#l5.345"></a><span id="l5.345" class="difflineminus">-          returnString += '|';</span>
<a href="#l5.346"></a><span id="l5.346" class="difflineplus">+          returnString += &quot;|&quot;;</span>
<a href="#l5.347"></a><span id="l5.347">         returnString += subFoldersString;</span>
<a href="#l5.348"></a><span id="l5.348">       }</span>
<a href="#l5.349"></a><span id="l5.349">     }</span>
<a href="#l5.350"></a><span id="l5.350">   }</span>
<a href="#l5.351"></a><span id="l5.351">   return returnString;</span>
<a href="#l5.352"></a><span id="l5.352"> }</span>
<a href="#l5.353"></a><span id="l5.353"> </span>
<a href="#l5.354"></a><span id="l5.354"> /**</span>
<a href="#l5.355"></a><span id="l5.355" class="difflineat">@@ -457,39 +430,34 @@ function AddSubFoldersToURI(folder)</span>
<a href="#l5.356"></a><span id="l5.356">  *</span>
<a href="#l5.357"></a><span id="l5.357">  * The available search capabilities also depend on whether the user is</span>
<a href="#l5.358"></a><span id="l5.358">  *  currently online or offline. Although that is also checked by the server,</span>
<a href="#l5.359"></a><span id="l5.359">  *  we do it ourselves because we have a more complex response to offline</span>
<a href="#l5.360"></a><span id="l5.360">  *  than the server's searchScope attribute provides.</span>
<a href="#l5.361"></a><span id="l5.361">  *</span>
<a href="#l5.362"></a><span id="l5.362">  * This method only works for real folders.</span>
<a href="#l5.363"></a><span id="l5.363">  */</span>
<a href="#l5.364"></a><span id="l5.364" class="difflineminus">-function GetScopeForFolder(folder)</span>
<a href="#l5.365"></a><span id="l5.365" class="difflineminus">-{</span>
<a href="#l5.366"></a><span id="l5.366" class="difflineplus">+function GetScopeForFolder(folder) {</span>
<a href="#l5.367"></a><span id="l5.367">   let searchOnline = document.getElementById(&quot;checkSearchOnline&quot;);</span>
<a href="#l5.368"></a><span id="l5.368" class="difflineminus">-  if (!searchOnline.disabled &amp;&amp; searchOnline.checked)</span>
<a href="#l5.369"></a><span id="l5.369" class="difflineminus">-  {</span>
<a href="#l5.370"></a><span id="l5.370" class="difflineplus">+  if (!searchOnline.disabled &amp;&amp; searchOnline.checked) {</span>
<a href="#l5.371"></a><span id="l5.371">     gSearchOnline = true;</span>
<a href="#l5.372"></a><span id="l5.372">     return folder.server.searchScope;</span>
<a href="#l5.373"></a><span id="l5.373">   }</span>
<a href="#l5.374"></a><span id="l5.374">   gSearchOnline = false;</span>
<a href="#l5.375"></a><span id="l5.375"> </span>
<a href="#l5.376"></a><span id="l5.376">   // We are going to search offline. The proper search scope may depend on</span>
<a href="#l5.377"></a><span id="l5.377">   // whether we have the body and/or junk available or not.</span>
<a href="#l5.378"></a><span id="l5.378">   let localType;</span>
<a href="#l5.379"></a><span id="l5.379" class="difflineminus">-  try</span>
<a href="#l5.380"></a><span id="l5.380" class="difflineminus">-  {</span>
<a href="#l5.381"></a><span id="l5.381" class="difflineplus">+  try {</span>
<a href="#l5.382"></a><span id="l5.382">     localType = folder.server.localStoreType;</span>
<a href="#l5.383"></a><span id="l5.383" class="difflineminus">-  }</span>
<a href="#l5.384"></a><span id="l5.384" class="difflineminus">-  catch (e) {} // On error, we'll just assume the default mailbox type</span>
<a href="#l5.385"></a><span id="l5.385" class="difflineplus">+  } catch (e) {} // On error, we'll just assume the default mailbox type</span>
<a href="#l5.386"></a><span id="l5.386"> </span>
<a href="#l5.387"></a><span id="l5.387">   let hasBody = folder.getFlag(Ci.nsMsgFolderFlags.Offline);</span>
<a href="#l5.388"></a><span id="l5.388">   let nsMsgSearchScope = Ci.nsMsgSearchScope;</span>
<a href="#l5.389"></a><span id="l5.389" class="difflineminus">-  switch (localType)</span>
<a href="#l5.390"></a><span id="l5.390" class="difflineminus">-  {</span>
<a href="#l5.391"></a><span id="l5.391" class="difflineplus">+  switch (localType) {</span>
<a href="#l5.392"></a><span id="l5.392">     case &quot;news&quot;:</span>
<a href="#l5.393"></a><span id="l5.393">       // News has four offline scopes, depending on whether junk and body</span>
<a href="#l5.394"></a><span id="l5.394">       // are available.</span>
<a href="#l5.395"></a><span id="l5.395">       let hasJunk =</span>
<a href="#l5.396"></a><span id="l5.396">         folder.getInheritedStringProperty(&quot;dobayes.mailnews@mozilla.org#junk&quot;)</span>
<a href="#l5.397"></a><span id="l5.397">                == &quot;true&quot;;</span>
<a href="#l5.398"></a><span id="l5.398">       if (hasJunk &amp;&amp; hasBody)</span>
<a href="#l5.399"></a><span id="l5.399">         return nsMsgSearchScope.localNewsJunkBody;</span>
<a href="#l5.400"></a><span id="l5.400" class="difflineat">@@ -501,18 +469,17 @@ function GetScopeForFolder(folder)</span>
<a href="#l5.401"></a><span id="l5.401">       return nsMsgSearchScope.localNews;</span>
<a href="#l5.402"></a><span id="l5.402"> </span>
<a href="#l5.403"></a><span id="l5.403">     case &quot;imap&quot;:</span>
<a href="#l5.404"></a><span id="l5.404">       // Junk is always enabled for imap, so the offline scope only depends on</span>
<a href="#l5.405"></a><span id="l5.405">       // whether the body is available.</span>
<a href="#l5.406"></a><span id="l5.406"> </span>
<a href="#l5.407"></a><span id="l5.407">       // If we are the root folder, use the server property for body rather</span>
<a href="#l5.408"></a><span id="l5.408">       // than the folder property.</span>
<a href="#l5.409"></a><span id="l5.409" class="difflineminus">-      if (folder.isServer)</span>
<a href="#l5.410"></a><span id="l5.410" class="difflineminus">-      {</span>
<a href="#l5.411"></a><span id="l5.411" class="difflineplus">+      if (folder.isServer) {</span>
<a href="#l5.412"></a><span id="l5.412">         let imapServer = folder.server</span>
<a href="#l5.413"></a><span id="l5.413">                                .QueryInterface(Ci.nsIImapIncomingServer);</span>
<a href="#l5.414"></a><span id="l5.414">         if (imapServer &amp;&amp; imapServer.offlineDownload)</span>
<a href="#l5.415"></a><span id="l5.415">           hasBody = true;</span>
<a href="#l5.416"></a><span id="l5.416">       }</span>
<a href="#l5.417"></a><span id="l5.417"> </span>
<a href="#l5.418"></a><span id="l5.418">       if (!hasBody)</span>
<a href="#l5.419"></a><span id="l5.419">         return nsMsgSearchScope.onlineManual;</span>
<a href="#l5.420"></a><span id="l5.420" class="difflineat">@@ -523,79 +490,72 @@ function GetScopeForFolder(folder)</span>
<a href="#l5.421"></a><span id="l5.421"> </span>
<a href="#l5.422"></a><span id="l5.422"> }</span>
<a href="#l5.423"></a><span id="l5.423"> </span>
<a href="#l5.424"></a><span id="l5.424"> var nsMsgViewSortType = Ci.nsMsgViewSortType;</span>
<a href="#l5.425"></a><span id="l5.425"> var nsMsgViewSortOrder = Ci.nsMsgViewSortOrder;</span>
<a href="#l5.426"></a><span id="l5.426"> var nsMsgViewFlagsType = Ci.nsMsgViewFlagsType;</span>
<a href="#l5.427"></a><span id="l5.427"> var nsMsgViewCommandType = Ci.nsMsgViewCommandType;</span>
<a href="#l5.428"></a><span id="l5.428"> </span>
<a href="#l5.429"></a><span id="l5.429" class="difflineminus">-function goUpdateSearchItems(commandset)</span>
<a href="#l5.430"></a><span id="l5.430" class="difflineminus">-{</span>
<a href="#l5.431"></a><span id="l5.431" class="difflineminus">-  for (var i = 0; i &lt; commandset.childNodes.length; i++)</span>
<a href="#l5.432"></a><span id="l5.432" class="difflineminus">-  {</span>
<a href="#l5.433"></a><span id="l5.433" class="difflineplus">+function goUpdateSearchItems(commandset) {</span>
<a href="#l5.434"></a><span id="l5.434" class="difflineplus">+  for (var i = 0; i &lt; commandset.childNodes.length; i++) {</span>
<a href="#l5.435"></a><span id="l5.435">     var commandID = commandset.childNodes[i].getAttribute(&quot;id&quot;);</span>
<a href="#l5.436"></a><span id="l5.436" class="difflineminus">-    if (commandID)</span>
<a href="#l5.437"></a><span id="l5.437" class="difflineminus">-    {</span>
<a href="#l5.438"></a><span id="l5.438" class="difflineplus">+    if (commandID) {</span>
<a href="#l5.439"></a><span id="l5.439">       goUpdateCommand(commandID);</span>
<a href="#l5.440"></a><span id="l5.440">     }</span>
<a href="#l5.441"></a><span id="l5.441">   }</span>
<a href="#l5.442"></a><span id="l5.442"> }</span>
<a href="#l5.443"></a><span id="l5.443"> </span>
<a href="#l5.444"></a><span id="l5.444"> // used to toggle functionality for Search/Stop button.</span>
<a href="#l5.445"></a><span id="l5.445" class="difflineminus">-function onSearchButton(event)</span>
<a href="#l5.446"></a><span id="l5.446" class="difflineminus">-{</span>
<a href="#l5.447"></a><span id="l5.447" class="difflineplus">+function onSearchButton(event) {</span>
<a href="#l5.448"></a><span id="l5.448">     if (event.target.label == gSearchBundle.getString(&quot;labelForSearchButton&quot;))</span>
<a href="#l5.449"></a><span id="l5.449">         onSearch();</span>
<a href="#l5.450"></a><span id="l5.450">     else</span>
<a href="#l5.451"></a><span id="l5.451">         onSearchStop();</span>
<a href="#l5.452"></a><span id="l5.452"> }</span>
<a href="#l5.453"></a><span id="l5.453"> </span>
<a href="#l5.454"></a><span id="l5.454" class="difflineminus">-function MsgDeleteSelectedMessages(aCommandType)</span>
<a href="#l5.455"></a><span id="l5.455" class="difflineminus">-{</span>
<a href="#l5.456"></a><span id="l5.456" class="difflineplus">+function MsgDeleteSelectedMessages(aCommandType) {</span>
<a href="#l5.457"></a><span id="l5.457">     gFolderDisplay.hintAboutToDeleteMessages();</span>
<a href="#l5.458"></a><span id="l5.458">     gFolderDisplay.doCommand(aCommandType);</span>
<a href="#l5.459"></a><span id="l5.459"> }</span>
<a href="#l5.460"></a><span id="l5.460"> </span>
<a href="#l5.461"></a><span id="l5.461" class="difflineminus">-function MoveMessageInSearch(destFolder)</span>
<a href="#l5.462"></a><span id="l5.462" class="difflineminus">-{</span>
<a href="#l5.463"></a><span id="l5.463" class="difflineplus">+function MoveMessageInSearch(destFolder) {</span>
<a href="#l5.464"></a><span id="l5.464">   // Get the msg folder we're moving messages into.</span>
<a href="#l5.465"></a><span id="l5.465">   // If the id (uri) is not set, use file-uri which is set for</span>
<a href="#l5.466"></a><span id="l5.466">   // &quot;File Here&quot;.</span>
<a href="#l5.467"></a><span id="l5.467" class="difflineminus">-  let destUri = destFolder.getAttribute('id');</span>
<a href="#l5.468"></a><span id="l5.468" class="difflineplus">+  let destUri = destFolder.getAttribute(&quot;id&quot;);</span>
<a href="#l5.469"></a><span id="l5.469">   if (destUri.length == 0)</span>
<a href="#l5.470"></a><span id="l5.470" class="difflineminus">-    destUri = destFolder.getAttribute('file-uri');</span>
<a href="#l5.471"></a><span id="l5.471" class="difflineplus">+    destUri = destFolder.getAttribute(&quot;file-uri&quot;);</span>
<a href="#l5.472"></a><span id="l5.472"> </span>
<a href="#l5.473"></a><span id="l5.473">   let destMsgFolder = MailUtils.getFolderForURI(destUri)</span>
<a href="#l5.474"></a><span id="l5.474">     .QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l5.475"></a><span id="l5.475"> </span>
<a href="#l5.476"></a><span id="l5.476">   gFolderDisplay.hintAboutToDeleteMessages();</span>
<a href="#l5.477"></a><span id="l5.477">   gFolderDisplay.doCommandWithFolder(nsMsgViewCommandType.moveMessages,</span>
<a href="#l5.478"></a><span id="l5.478">                                      destMsgFolder);</span>
<a href="#l5.479"></a><span id="l5.479"> }</span>
<a href="#l5.480"></a><span id="l5.480"> </span>
<a href="#l5.481"></a><span id="l5.481" class="difflineminus">-function OpenInFolder()</span>
<a href="#l5.482"></a><span id="l5.482" class="difflineminus">-{</span>
<a href="#l5.483"></a><span id="l5.483" class="difflineplus">+function OpenInFolder() {</span>
<a href="#l5.484"></a><span id="l5.484">   MailUtils.displayMessageInFolderTab(gFolderDisplay.selectedMessage);</span>
<a href="#l5.485"></a><span id="l5.485"> }</span>
<a href="#l5.486"></a><span id="l5.486"> </span>
<a href="#l5.487"></a><span id="l5.487" class="difflineminus">-function saveAsVirtualFolder()</span>
<a href="#l5.488"></a><span id="l5.488" class="difflineminus">-{</span>
<a href="#l5.489"></a><span id="l5.489" class="difflineplus">+function saveAsVirtualFolder() {</span>
<a href="#l5.490"></a><span id="l5.490">   var searchFolderURIs = gCurrentFolder.URI;</span>
<a href="#l5.491"></a><span id="l5.491"> </span>
<a href="#l5.492"></a><span id="l5.492">   var searchSubfolders = document.getElementById(&quot;checkSearchSubFolders&quot;).checked;</span>
<a href="#l5.493"></a><span id="l5.493" class="difflineminus">-  if (gCurrentFolder &amp;&amp; (searchSubfolders || gCurrentFolder.isServer || gCurrentFolder.noSelect))</span>
<a href="#l5.494"></a><span id="l5.494" class="difflineminus">-  {</span>
<a href="#l5.495"></a><span id="l5.495" class="difflineplus">+  if (gCurrentFolder &amp;&amp; (searchSubfolders || gCurrentFolder.isServer || gCurrentFolder.noSelect)) {</span>
<a href="#l5.496"></a><span id="l5.496">     var subFolderURIs = AddSubFoldersToURI(gCurrentFolder);</span>
<a href="#l5.497"></a><span id="l5.497">     if (subFolderURIs.length &gt; 0)</span>
<a href="#l5.498"></a><span id="l5.498" class="difflineminus">-      searchFolderURIs += '|' + subFolderURIs;</span>
<a href="#l5.499"></a><span id="l5.499" class="difflineplus">+      searchFolderURIs += &quot;|&quot; + subFolderURIs;</span>
<a href="#l5.500"></a><span id="l5.500">   }</span>
<a href="#l5.501"></a><span id="l5.501"> </span>
<a href="#l5.502"></a><span id="l5.502">   var searchOnline = document.getElementById(&quot;checkSearchOnline&quot;);</span>
<a href="#l5.503"></a><span id="l5.503">   var doOnlineSearch = searchOnline.checked &amp;&amp; !searchOnline.disabled;</span>
<a href="#l5.504"></a><span id="l5.504"> </span>
<a href="#l5.505"></a><span id="l5.505" class="difflineminus">-  var dialog = window.openDialog(&quot;chrome://messenger/content/virtualFolderProperties.xul&quot;, &quot;&quot;,</span>
<a href="#l5.506"></a><span id="l5.506" class="difflineminus">-                                 &quot;chrome,titlebar,modal,centerscreen&quot;,</span>
<a href="#l5.507"></a><span id="l5.507" class="difflineminus">-                                 {folder: window.arguments[0].folder,</span>
<a href="#l5.508"></a><span id="l5.508" class="difflineminus">-                                  searchTerms: getSearchTerms(),</span>
<a href="#l5.509"></a><span id="l5.509" class="difflineminus">-                                  searchFolderURIs: searchFolderURIs,</span>
<a href="#l5.510"></a><span id="l5.510" class="difflineminus">-                                  searchOnline: doOnlineSearch});</span>
<a href="#l5.511"></a><span id="l5.511" class="difflineplus">+  window.openDialog(&quot;chrome://messenger/content/virtualFolderProperties.xul&quot;, &quot;&quot;,</span>
<a href="#l5.512"></a><span id="l5.512" class="difflineplus">+                    &quot;chrome,titlebar,modal,centerscreen&quot;,</span>
<a href="#l5.513"></a><span id="l5.513" class="difflineplus">+                    {</span>
<a href="#l5.514"></a><span id="l5.514" class="difflineplus">+                      folder: window.arguments[0].folder,</span>
<a href="#l5.515"></a><span id="l5.515" class="difflineplus">+                      searchTerms: getSearchTerms(),</span>
<a href="#l5.516"></a><span id="l5.516" class="difflineplus">+                      searchFolderURIs,</span>
<a href="#l5.517"></a><span id="l5.517" class="difflineplus">+                      searchOnline: doOnlineSearch,</span>
<a href="#l5.518"></a><span id="l5.518" class="difflineplus">+                    });</span>
<a href="#l5.519"></a><span id="l5.519"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/base/content/aboutAddonsExtra.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/base/content/aboutAddonsExtra.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1,13 +1,13 @@</span>
<a href="#l6.4"></a><span id="l6.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.5"></a><span id="l6.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.6"></a><span id="l6.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8" class="difflineminus">-/* globals AddonManager, Services, gDetailView, gStrings */</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+/* globals AddonManager, Services, gDetailView, gListView, gStrings */</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11"> const { ExtensionSupport } = ChromeUtils.import(&quot;resource:///modules/extensionSupport.jsm&quot;, null);</span>
<a href="#l6.12"></a><span id="l6.12"> </span>
<a href="#l6.13"></a><span id="l6.13"> gStrings.mailExt =</span>
<a href="#l6.14"></a><span id="l6.14">   Services.strings.createBundle(&quot;chrome://messenger/locale/extensionsOverlay.properties&quot;);</span>
<a href="#l6.15"></a><span id="l6.15"> </span>
<a href="#l6.16"></a><span id="l6.16"> (function() {</span>
<a href="#l6.17"></a><span id="l6.17">   window.isCorrectlySigned = function() { return true; };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/base/content/aboutDialog-appUpdater.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/base/content/aboutDialog-appUpdater.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -17,18 +17,17 @@ function onUnload(aEvent) {</span>
<a href="#l7.4"></a><span id="l7.4">   if (gAppUpdater.isChecking)</span>
<a href="#l7.5"></a><span id="l7.5">     gAppUpdater.checker.stopCurrentCheck();</span>
<a href="#l7.6"></a><span id="l7.6">   // Safe to call even when there isn't a download in progress.</span>
<a href="#l7.7"></a><span id="l7.7">   gAppUpdater.removeDownloadListener();</span>
<a href="#l7.8"></a><span id="l7.8">   gAppUpdater = null;</span>
<a href="#l7.9"></a><span id="l7.9"> }</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-function appUpdater()</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-{</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+function appUpdater() {</span>
<a href="#l7.15"></a><span id="l7.15">   this.updateDeck = document.getElementById(&quot;updateDeck&quot;);</span>
<a href="#l7.16"></a><span id="l7.16">   this.promiseAutoUpdateSetting;</span>
<a href="#l7.17"></a><span id="l7.17"> </span>
<a href="#l7.18"></a><span id="l7.18">   // Hide the update deck when there is already an update window open to avoid</span>
<a href="#l7.19"></a><span id="l7.19">   // syncing issues between them.</span>
<a href="#l7.20"></a><span id="l7.20">   if (Services.wm.getMostRecentWindow(&quot;Update:Wizard&quot;)) {</span>
<a href="#l7.21"></a><span id="l7.21">     this.updateDeck.hidden = true;</span>
<a href="#l7.22"></a><span id="l7.22">     return;</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineat">@@ -80,18 +79,17 @@ function appUpdater()</span>
<a href="#l7.24"></a><span id="l7.24">   // That leaves the options</span>
<a href="#l7.25"></a><span id="l7.25">   // &quot;Check for updates, but let me choose whether to install them&quot;, and</span>
<a href="#l7.26"></a><span id="l7.26">   // &quot;Automatically install updates&quot;.</span>
<a href="#l7.27"></a><span id="l7.27">   // In both cases, we check for updates without asking.</span>
<a href="#l7.28"></a><span id="l7.28">   // In the &quot;let me choose&quot; case, we ask before downloading though, in onCheckComplete.</span>
<a href="#l7.29"></a><span id="l7.29">   this.checkForUpdates();</span>
<a href="#l7.30"></a><span id="l7.30"> }</span>
<a href="#l7.31"></a><span id="l7.31"> </span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-appUpdater.prototype =</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-{</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+appUpdater.prototype = {</span>
<a href="#l7.35"></a><span id="l7.35">   // true when there is an update check in progress.</span>
<a href="#l7.36"></a><span id="l7.36">   isChecking: false,</span>
<a href="#l7.37"></a><span id="l7.37"> </span>
<a href="#l7.38"></a><span id="l7.38">   // true when there is an update already staged / ready to be applied.</span>
<a href="#l7.39"></a><span id="l7.39">   get isPending() {</span>
<a href="#l7.40"></a><span id="l7.40">     if (this.update) {</span>
<a href="#l7.41"></a><span id="l7.41">       return this.update.state == &quot;pending&quot; ||</span>
<a href="#l7.42"></a><span id="l7.42">              this.update.state == &quot;pending-service&quot; ||</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineat">@@ -135,17 +133,17 @@ appUpdater.prototype =</span>
<a href="#l7.44"></a><span id="l7.44">   },</span>
<a href="#l7.45"></a><span id="l7.45"> </span>
<a href="#l7.46"></a><span id="l7.46">   /**</span>
<a href="#l7.47"></a><span id="l7.47">    * Sets the panel of the updateDeck.</span>
<a href="#l7.48"></a><span id="l7.48">    *</span>
<a href="#l7.49"></a><span id="l7.49">    * @param  aChildID</span>
<a href="#l7.50"></a><span id="l7.50">    *         The id of the deck's child to select, e.g. &quot;apply&quot;.</span>
<a href="#l7.51"></a><span id="l7.51">    */</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-  selectPanel: function(aChildID) {</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+  selectPanel(aChildID) {</span>
<a href="#l7.54"></a><span id="l7.54">     let panel = document.getElementById(aChildID);</span>
<a href="#l7.55"></a><span id="l7.55"> </span>
<a href="#l7.56"></a><span id="l7.56">     let button = panel.querySelector(&quot;button&quot;);</span>
<a href="#l7.57"></a><span id="l7.57">     if (button) {</span>
<a href="#l7.58"></a><span id="l7.58">       if (aChildID == &quot;downloadAndInstall&quot;) {</span>
<a href="#l7.59"></a><span id="l7.59">         let updateVersion = gAppUpdater.update.displayVersion;</span>
<a href="#l7.60"></a><span id="l7.60">         // Include the build ID if this is an &quot;a#&quot; (nightly) build</span>
<a href="#l7.61"></a><span id="l7.61">         if (/a\d+$/.test(updateVersion)) {</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineat">@@ -166,17 +164,17 @@ appUpdater.prototype =</span>
<a href="#l7.63"></a><span id="l7.63">     } else {</span>
<a href="#l7.64"></a><span id="l7.64">       this.updateDeck.selectedPanel = panel;</span>
<a href="#l7.65"></a><span id="l7.65">     }</span>
<a href="#l7.66"></a><span id="l7.66">   },</span>
<a href="#l7.67"></a><span id="l7.67"> </span>
<a href="#l7.68"></a><span id="l7.68">   /**</span>
<a href="#l7.69"></a><span id="l7.69">    * Check for updates</span>
<a href="#l7.70"></a><span id="l7.70">    */</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineminus">-  checkForUpdates: function() {</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+  checkForUpdates() {</span>
<a href="#l7.73"></a><span id="l7.73">     // Clear prefs that could prevent a user from discovering available updates.</span>
<a href="#l7.74"></a><span id="l7.74">     if (Services.prefs.prefHasUserValue(PREF_APP_UPDATE_CANCELATIONS_OSX)) {</span>
<a href="#l7.75"></a><span id="l7.75">       Services.prefs.clearUserPref(PREF_APP_UPDATE_CANCELATIONS_OSX);</span>
<a href="#l7.76"></a><span id="l7.76">     }</span>
<a href="#l7.77"></a><span id="l7.77">     if (Services.prefs.prefHasUserValue(PREF_APP_UPDATE_ELEVATE_NEVER)) {</span>
<a href="#l7.78"></a><span id="l7.78">       Services.prefs.clearUserPref(PREF_APP_UPDATE_ELEVATE_NEVER);</span>
<a href="#l7.79"></a><span id="l7.79">     }</span>
<a href="#l7.80"></a><span id="l7.80">     this.selectPanel(&quot;checkingForUpdates&quot;);</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineat">@@ -184,54 +182,50 @@ appUpdater.prototype =</span>
<a href="#l7.82"></a><span id="l7.82">     this.checker.checkForUpdates(this.updateCheckListener, true);</span>
<a href="#l7.83"></a><span id="l7.83">     // after checking, onCheckComplete() is called</span>
<a href="#l7.84"></a><span id="l7.84">   },</span>
<a href="#l7.85"></a><span id="l7.85"> </span>
<a href="#l7.86"></a><span id="l7.86">   /**</span>
<a href="#l7.87"></a><span id="l7.87">    * Handles oncommand for the &quot;Restart to Update&quot; button</span>
<a href="#l7.88"></a><span id="l7.88">    * which is presented after the download has been downloaded.</span>
<a href="#l7.89"></a><span id="l7.89">    */</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineminus">-  buttonRestartAfterDownload: function() {</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+  buttonRestartAfterDownload() {</span>
<a href="#l7.92"></a><span id="l7.92">     if (!this.isPending &amp;&amp; !this.isApplied) {</span>
<a href="#l7.93"></a><span id="l7.93">       return;</span>
<a href="#l7.94"></a><span id="l7.94">     }</span>
<a href="#l7.95"></a><span id="l7.95"> </span>
<a href="#l7.96"></a><span id="l7.96">     // Notify all windows that an application quit has been requested.</span>
<a href="#l7.97"></a><span id="l7.97">     let cancelQuit = Cc[&quot;@mozilla.org/supports-PRBool;1&quot;].</span>
<a href="#l7.98"></a><span id="l7.98">                      createInstance(Ci.nsISupportsPRBool);</span>
<a href="#l7.99"></a><span id="l7.99">     Services.obs.notifyObservers(cancelQuit, &quot;quit-application-requested&quot;, &quot;restart&quot;);</span>
<a href="#l7.100"></a><span id="l7.100"> </span>
<a href="#l7.101"></a><span id="l7.101">     // Something aborted the quit process.</span>
<a href="#l7.102"></a><span id="l7.102">     if (cancelQuit.data) {</span>
<a href="#l7.103"></a><span id="l7.103">       return;</span>
<a href="#l7.104"></a><span id="l7.104">     }</span>
<a href="#l7.105"></a><span id="l7.105"> </span>
<a href="#l7.106"></a><span id="l7.106" class="difflineminus">-    let appStartup = Cc[&quot;@mozilla.org/toolkit/app-startup;1&quot;].</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineminus">-                     getService(Ci.nsIAppStartup);</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineminus">-</span>
<a href="#l7.109"></a><span id="l7.109">     // If already in safe mode restart in safe mode (bug 327119)</span>
<a href="#l7.110"></a><span id="l7.110">     if (Services.appinfo.inSafeMode) {</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineminus">-      appStartup.restartInSafeMode(Ci.nsIAppStartup.eAttemptQuit);</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+      Services.startup.restartInSafeMode(Services.startup.eAttemptQuit);</span>
<a href="#l7.113"></a><span id="l7.113">       return;</span>
<a href="#l7.114"></a><span id="l7.114">     }</span>
<a href="#l7.115"></a><span id="l7.115"> </span>
<a href="#l7.116"></a><span id="l7.116" class="difflineminus">-    appStartup.quit(Ci.nsIAppStartup.eAttemptQuit |</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineminus">-                    Ci.nsIAppStartup.eRestart);</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+    Services.startup.quit(Services.startup.eAttemptQuit | Services.startup.eRestart);</span>
<a href="#l7.119"></a><span id="l7.119">   },</span>
<a href="#l7.120"></a><span id="l7.120"> </span>
<a href="#l7.121"></a><span id="l7.121">   /**</span>
<a href="#l7.122"></a><span id="l7.122">    * Implements nsIUpdateCheckListener. The methods implemented by</span>
<a href="#l7.123"></a><span id="l7.123">    * nsIUpdateCheckListener are in a different scope from nsIIncrementalDownload</span>
<a href="#l7.124"></a><span id="l7.124">    * to make it clear which are used by each interface.</span>
<a href="#l7.125"></a><span id="l7.125">    */</span>
<a href="#l7.126"></a><span id="l7.126">   updateCheckListener: {</span>
<a href="#l7.127"></a><span id="l7.127">     /**</span>
<a href="#l7.128"></a><span id="l7.128">      * See nsIUpdateService.idl</span>
<a href="#l7.129"></a><span id="l7.129">      */</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineminus">-    onCheckComplete: function(aRequest, aUpdates, aUpdateCount) {</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineplus">+    onCheckComplete(aRequest, aUpdates, aUpdateCount) {</span>
<a href="#l7.132"></a><span id="l7.132">       gAppUpdater.isChecking = false;</span>
<a href="#l7.133"></a><span id="l7.133">       gAppUpdater.update = gAppUpdater.aus.</span>
<a href="#l7.134"></a><span id="l7.134">                            selectUpdate(aUpdates, aUpdates.length);</span>
<a href="#l7.135"></a><span id="l7.135">       if (!gAppUpdater.update) {</span>
<a href="#l7.136"></a><span id="l7.136">         gAppUpdater.selectPanel(&quot;noUpdatesFound&quot;);</span>
<a href="#l7.137"></a><span id="l7.137">         return;</span>
<a href="#l7.138"></a><span id="l7.138">       }</span>
<a href="#l7.139"></a><span id="l7.139"> </span>
<a href="#l7.140"></a><span id="l7.140" class="difflineat">@@ -261,35 +255,34 @@ appUpdater.prototype =</span>
<a href="#l7.141"></a><span id="l7.141">           gAppUpdater.selectPanel(&quot;downloadAndInstall&quot;);</span>
<a href="#l7.142"></a><span id="l7.142">         }</span>
<a href="#l7.143"></a><span id="l7.143">       });</span>
<a href="#l7.144"></a><span id="l7.144">     },</span>
<a href="#l7.145"></a><span id="l7.145"> </span>
<a href="#l7.146"></a><span id="l7.146">     /**</span>
<a href="#l7.147"></a><span id="l7.147">      * See nsIUpdateService.idl</span>
<a href="#l7.148"></a><span id="l7.148">      */</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineminus">-    onError: function(aRequest, aUpdate) {</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineplus">+    onError(aRequest, aUpdate) {</span>
<a href="#l7.151"></a><span id="l7.151">       // Errors in the update check are treated as no updates found. If the</span>
<a href="#l7.152"></a><span id="l7.152">       // update check fails repeatedly without a success the user will be</span>
<a href="#l7.153"></a><span id="l7.153">       // notified with the normal app update user interface so this is safe.</span>
<a href="#l7.154"></a><span id="l7.154">       gAppUpdater.isChecking = false;</span>
<a href="#l7.155"></a><span id="l7.155">       gAppUpdater.selectPanel(&quot;noUpdatesFound&quot;);</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineminus">-      return;</span>
<a href="#l7.157"></a><span id="l7.157">     },</span>
<a href="#l7.158"></a><span id="l7.158"> </span>
<a href="#l7.159"></a><span id="l7.159">     /**</span>
<a href="#l7.160"></a><span id="l7.160">      * See nsISupports.idl</span>
<a href="#l7.161"></a><span id="l7.161">      */</span>
<a href="#l7.162"></a><span id="l7.162">     QueryInterface: ChromeUtils.generateQI([&quot;nsIUpdateCheckListener&quot;]),</span>
<a href="#l7.163"></a><span id="l7.163">   },</span>
<a href="#l7.164"></a><span id="l7.164"> </span>
<a href="#l7.165"></a><span id="l7.165">   /**</span>
<a href="#l7.166"></a><span id="l7.166">    * Starts the download of an update mar.</span>
<a href="#l7.167"></a><span id="l7.167">    */</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineminus">-  startDownload: function() {</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineplus">+  startDownload() {</span>
<a href="#l7.170"></a><span id="l7.170">     if (!this.update)</span>
<a href="#l7.171"></a><span id="l7.171">       this.update = this.um.activeUpdate;</span>
<a href="#l7.172"></a><span id="l7.172">     this.update.QueryInterface(Ci.nsIWritablePropertyBag);</span>
<a href="#l7.173"></a><span id="l7.173">     this.update.setProperty(&quot;foregroundDownload&quot;, &quot;true&quot;);</span>
<a href="#l7.174"></a><span id="l7.174"> </span>
<a href="#l7.175"></a><span id="l7.175">     this.aus.pauseDownload();</span>
<a href="#l7.176"></a><span id="l7.176">     let state = this.aus.downloadUpdate(this.update, false);</span>
<a href="#l7.177"></a><span id="l7.177">     if (state == &quot;failed&quot;) {</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineat">@@ -298,40 +291,40 @@ appUpdater.prototype =</span>
<a href="#l7.179"></a><span id="l7.179">     }</span>
<a href="#l7.180"></a><span id="l7.180"> </span>
<a href="#l7.181"></a><span id="l7.181">     this.setupDownloadingUI();</span>
<a href="#l7.182"></a><span id="l7.182">   },</span>
<a href="#l7.183"></a><span id="l7.183"> </span>
<a href="#l7.184"></a><span id="l7.184">   /**</span>
<a href="#l7.185"></a><span id="l7.185">    * Switches to the UI responsible for tracking the download.</span>
<a href="#l7.186"></a><span id="l7.186">    */</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineminus">-  setupDownloadingUI: function() {</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineplus">+  setupDownloadingUI() {</span>
<a href="#l7.189"></a><span id="l7.189">     this.downloadStatus = document.getElementById(&quot;downloadStatus&quot;);</span>
<a href="#l7.190"></a><span id="l7.190">     this.downloadStatus.value =</span>
<a href="#l7.191"></a><span id="l7.191">       DownloadUtils.getTransferTotal(0, this.update.selectedPatch.size);</span>
<a href="#l7.192"></a><span id="l7.192">     this.selectPanel(&quot;downloading&quot;);</span>
<a href="#l7.193"></a><span id="l7.193">     this.aus.addDownloadListener(this);</span>
<a href="#l7.194"></a><span id="l7.194">   },</span>
<a href="#l7.195"></a><span id="l7.195"> </span>
<a href="#l7.196"></a><span id="l7.196" class="difflineminus">-  removeDownloadListener: function() {</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineplus">+  removeDownloadListener() {</span>
<a href="#l7.198"></a><span id="l7.198">     if (this.aus) {</span>
<a href="#l7.199"></a><span id="l7.199">       this.aus.removeDownloadListener(this);</span>
<a href="#l7.200"></a><span id="l7.200">     }</span>
<a href="#l7.201"></a><span id="l7.201">   },</span>
<a href="#l7.202"></a><span id="l7.202"> </span>
<a href="#l7.203"></a><span id="l7.203">   /**</span>
<a href="#l7.204"></a><span id="l7.204">    * See nsIRequestObserver.idl</span>
<a href="#l7.205"></a><span id="l7.205">    */</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineminus">-  onStartRequest: function(aRequest, aContext) {</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineplus">+  onStartRequest(aRequest, aContext) {</span>
<a href="#l7.208"></a><span id="l7.208">   },</span>
<a href="#l7.209"></a><span id="l7.209"> </span>
<a href="#l7.210"></a><span id="l7.210">   /**</span>
<a href="#l7.211"></a><span id="l7.211">    * See nsIRequestObserver.idl</span>
<a href="#l7.212"></a><span id="l7.212">    */</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineminus">-  onStopRequest: function(aRequest, aContext, aStatusCode) {</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineplus">+  onStopRequest(aRequest, aContext, aStatusCode) {</span>
<a href="#l7.215"></a><span id="l7.215">     switch (aStatusCode) {</span>
<a href="#l7.216"></a><span id="l7.216">     case Cr.NS_ERROR_UNEXPECTED:</span>
<a href="#l7.217"></a><span id="l7.217">       if (this.update.selectedPatch.state == &quot;download-failed&quot; &amp;&amp;</span>
<a href="#l7.218"></a><span id="l7.218">           (this.update.isCompleteUpdate || this.update.patchCount != 2)) {</span>
<a href="#l7.219"></a><span id="l7.219">         // Verification error of complete patch, informational text is held in</span>
<a href="#l7.220"></a><span id="l7.220">         // the update object.</span>
<a href="#l7.221"></a><span id="l7.221">         this.removeDownloadListener();</span>
<a href="#l7.222"></a><span id="l7.222">         this.selectPanel(&quot;downloadFailed&quot;);</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineat">@@ -342,17 +335,16 @@ appUpdater.prototype =</span>
<a href="#l7.224"></a><span id="l7.224">       break;</span>
<a href="#l7.225"></a><span id="l7.225">     case Cr.NS_BINDING_ABORTED:</span>
<a href="#l7.226"></a><span id="l7.226">       // Do not remove UI listener since the user may resume downloading again.</span>
<a href="#l7.227"></a><span id="l7.227">       break;</span>
<a href="#l7.228"></a><span id="l7.228">     case Cr.NS_OK:</span>
<a href="#l7.229"></a><span id="l7.229">       this.removeDownloadListener();</span>
<a href="#l7.230"></a><span id="l7.230">       if (this.backgroundUpdateEnabled) {</span>
<a href="#l7.231"></a><span id="l7.231">         this.selectPanel(&quot;applying&quot;);</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineminus">-        let update = this.um.activeUpdate;</span>
<a href="#l7.233"></a><span id="l7.233">         let self = this;</span>
<a href="#l7.234"></a><span id="l7.234">         Services.obs.addObserver(function selectPanelOnUpdate(aSubject, aTopic, aData) {</span>
<a href="#l7.235"></a><span id="l7.235">           // Update the UI when the background updater is finished</span>
<a href="#l7.236"></a><span id="l7.236">           let status = aData;</span>
<a href="#l7.237"></a><span id="l7.237">           if (status == &quot;applied&quot; || status == &quot;applied-service&quot; ||</span>
<a href="#l7.238"></a><span id="l7.238">               status == &quot;pending&quot; || status == &quot;pending-service&quot; ||</span>
<a href="#l7.239"></a><span id="l7.239">               status == &quot;pending-elevate&quot;) {</span>
<a href="#l7.240"></a><span id="l7.240">             // If the update is successfully applied, or if the updater has</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineat">@@ -381,23 +373,23 @@ appUpdater.prototype =</span>
<a href="#l7.242"></a><span id="l7.242">       this.selectPanel(&quot;downloadFailed&quot;);</span>
<a href="#l7.243"></a><span id="l7.243">       break;</span>
<a href="#l7.244"></a><span id="l7.244">     }</span>
<a href="#l7.245"></a><span id="l7.245">   },</span>
<a href="#l7.246"></a><span id="l7.246"> </span>
<a href="#l7.247"></a><span id="l7.247">   /**</span>
<a href="#l7.248"></a><span id="l7.248">    * See nsIProgressEventSink.idl</span>
<a href="#l7.249"></a><span id="l7.249">    */</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineminus">-  onStatus: function(aRequest, aContext, aStatus, aStatusArg) {</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineplus">+  onStatus(aRequest, aContext, aStatus, aStatusArg) {</span>
<a href="#l7.252"></a><span id="l7.252">   },</span>
<a href="#l7.253"></a><span id="l7.253"> </span>
<a href="#l7.254"></a><span id="l7.254">   /**</span>
<a href="#l7.255"></a><span id="l7.255">    * See nsIProgressEventSink.idl</span>
<a href="#l7.256"></a><span id="l7.256">    */</span>
<a href="#l7.257"></a><span id="l7.257" class="difflineminus">-  onProgress: function(aRequest, aContext, aProgress, aProgressMax) {</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineplus">+  onProgress(aRequest, aContext, aProgress, aProgressMax) {</span>
<a href="#l7.259"></a><span id="l7.259">     this.downloadStatus.value =</span>
<a href="#l7.260"></a><span id="l7.260">       DownloadUtils.getTransferTotal(aProgress, aProgressMax);</span>
<a href="#l7.261"></a><span id="l7.261">   },</span>
<a href="#l7.262"></a><span id="l7.262"> </span>
<a href="#l7.263"></a><span id="l7.263">   /**</span>
<a href="#l7.264"></a><span id="l7.264">    * See nsISupports.idl</span>
<a href="#l7.265"></a><span id="l7.265">    */</span>
<a href="#l7.266"></a><span id="l7.266">   QueryInterface: ChromeUtils.generateQI([&quot;nsIProgressEventSink&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/base/content/aboutDialog.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/base/content/aboutDialog.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -3,18 +3,17 @@</span>
<a href="#l8.4"></a><span id="l8.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.5"></a><span id="l8.5"> </span>
<a href="#l8.6"></a><span id="l8.6"> &quot;use strict&quot;;</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8"> // Services = object with smart getters for common XPCOM services</span>
<a href="#l8.9"></a><span id="l8.9"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l8.10"></a><span id="l8.10"> ChromeUtils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;);</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-function init(aEvent)</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-{</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+function init(aEvent) {</span>
<a href="#l8.15"></a><span id="l8.15">   if (aEvent.target != document)</span>
<a href="#l8.16"></a><span id="l8.16">     return;</span>
<a href="#l8.17"></a><span id="l8.17"> </span>
<a href="#l8.18"></a><span id="l8.18">   try {</span>
<a href="#l8.19"></a><span id="l8.19">     var distroId = Services.prefs.getCharPref(&quot;distribution.id&quot;);</span>
<a href="#l8.20"></a><span id="l8.20">     if (distroId) {</span>
<a href="#l8.21"></a><span id="l8.21">       var distroVersion = Services.prefs.getCharPref(&quot;distribution.version&quot;);</span>
<a href="#l8.22"></a><span id="l8.22"> </span>
<a href="#l8.23"></a><span id="l8.23" class="difflineat">@@ -24,24 +23,22 @@ function init(aEvent)</span>
<a href="#l8.24"></a><span id="l8.24"> </span>
<a href="#l8.25"></a><span id="l8.25">       try {</span>
<a href="#l8.26"></a><span id="l8.26">         // This is in its own try catch due to bug 895473 and bug 900925.</span>
<a href="#l8.27"></a><span id="l8.27">         var distroAbout = Services.prefs.getComplexValue(&quot;distribution.about&quot;,</span>
<a href="#l8.28"></a><span id="l8.28">           Ci.nsISupportsString);</span>
<a href="#l8.29"></a><span id="l8.29">         var distroField = document.getElementById(&quot;distribution&quot;);</span>
<a href="#l8.30"></a><span id="l8.30">         distroField.value = distroAbout;</span>
<a href="#l8.31"></a><span id="l8.31">         distroField.style.display = &quot;block&quot;;</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-      }</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-      catch (ex) {</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+      } catch (ex) {</span>
<a href="#l8.35"></a><span id="l8.35">         // Pref is unset</span>
<a href="#l8.36"></a><span id="l8.36">         Cu.reportError(ex);</span>
<a href="#l8.37"></a><span id="l8.37">       }</span>
<a href="#l8.38"></a><span id="l8.38">     }</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-  }</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineminus">-  catch (e) {</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+  } catch (e) {</span>
<a href="#l8.42"></a><span id="l8.42">     // Pref is unset</span>
<a href="#l8.43"></a><span id="l8.43">   }</span>
<a href="#l8.44"></a><span id="l8.44"> </span>
<a href="#l8.45"></a><span id="l8.45">   // XXX FIXME</span>
<a href="#l8.46"></a><span id="l8.46">   // Include the build ID and display warning if this is an &quot;a#&quot; (nightly) build</span>
<a href="#l8.47"></a><span id="l8.47">   let versionField = document.getElementById(&quot;version&quot;);</span>
<a href="#l8.48"></a><span id="l8.48">   let version = Services.appinfo.version;</span>
<a href="#l8.49"></a><span id="l8.49">   if (/a\d+$/.test(version)) {</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineat">@@ -88,19 +85,17 @@ function init(aEvent)</span>
<a href="#l8.51"></a><span id="l8.51">     // it may not be sized at this point, and we need its width to calculate its position</span>
<a href="#l8.52"></a><span id="l8.52">     window.sizeToContent();</span>
<a href="#l8.53"></a><span id="l8.53">     window.moveTo((screen.availWidth / 2) - (window.outerWidth / 2), screen.availHeight / 5);</span>
<a href="#l8.54"></a><span id="l8.54">   }</span>
<a href="#l8.55"></a><span id="l8.55"> }</span>
<a href="#l8.56"></a><span id="l8.56"> </span>
<a href="#l8.57"></a><span id="l8.57"> // This function is used to open about: tabs. The caller should ensure the url</span>
<a href="#l8.58"></a><span id="l8.58"> // is only an about: url.</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineminus">-function openAboutTab(url)</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineminus">-{</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineminus">-  let tabmail;</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+function openAboutTab(url) {</span>
<a href="#l8.63"></a><span id="l8.63">   // Check existing windows</span>
<a href="#l8.64"></a><span id="l8.64">   let mailWindow = Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l8.65"></a><span id="l8.65">   if (mailWindow) {</span>
<a href="#l8.66"></a><span id="l8.66">     mailWindow.focus();</span>
<a href="#l8.67"></a><span id="l8.67">     mailWindow.document.getElementById(&quot;tabmail&quot;)</span>
<a href="#l8.68"></a><span id="l8.68">               .openTab(&quot;contentTab&quot;, {contentPage: url,</span>
<a href="#l8.69"></a><span id="l8.69">                                       clickHandler: &quot;specialTabs.aboutClickHandler(event);&quot;});</span>
<a href="#l8.70"></a><span id="l8.70">     return;</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineat">@@ -108,18 +103,17 @@ function openAboutTab(url)</span>
<a href="#l8.72"></a><span id="l8.72"> </span>
<a href="#l8.73"></a><span id="l8.73">   // No existing windows.</span>
<a href="#l8.74"></a><span id="l8.74">   window.openDialog(&quot;chrome://messenger/content/&quot;, &quot;_blank&quot;,</span>
<a href="#l8.75"></a><span id="l8.75">                     &quot;chrome,dialog=no,all&quot;, null,</span>
<a href="#l8.76"></a><span id="l8.76">                     { tabType: &quot;contentTab&quot;,</span>
<a href="#l8.77"></a><span id="l8.77">                       tabParams: {contentPage: url, clickHandler: &quot;specialTabs.aboutClickHandler(event);&quot;} });</span>
<a href="#l8.78"></a><span id="l8.78"> }</span>
<a href="#l8.79"></a><span id="l8.79"> </span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-function openUILink(url, event)</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineminus">-{</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+function openUILink(url, event) {</span>
<a href="#l8.83"></a><span id="l8.83">   if (!event.button) {</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineminus">-    let m = (&quot;messenger&quot; in window) ? messenger :</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+    let m = (&quot;messenger&quot; in window) ? window.messenger :</span>
<a href="#l8.86"></a><span id="l8.86">       Cc[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l8.87"></a><span id="l8.87">         .createInstance(Ci.nsIMessenger);</span>
<a href="#l8.88"></a><span id="l8.88">     m.launchExternalURL(url);</span>
<a href="#l8.89"></a><span id="l8.89">     event.preventDefault();</span>
<a href="#l8.90"></a><span id="l8.90">   }</span>
<a href="#l8.91"></a><span id="l8.91"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/base/content/browserRequest.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/base/content/browserRequest.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -9,47 +9,47 @@ var reporterListener = {</span>
<a href="#l9.4"></a><span id="l9.4">   get securityButton() {</span>
<a href="#l9.5"></a><span id="l9.5">     delete this.securityButton;</span>
<a href="#l9.6"></a><span id="l9.6">     return this.securityButton = document.getElementById(&quot;security-button&quot;);</span>
<a href="#l9.7"></a><span id="l9.7">   },</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9">   QueryInterface: ChromeUtils.generateQI([&quot;nsIWebProgressListener&quot;,</span>
<a href="#l9.10"></a><span id="l9.10">                                           &quot;nsISupportsWeakReference&quot;]),</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  onStateChange: function(/*in nsIWebProgress*/ aWebProgress,</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-                     /*in nsIRequest*/ aRequest,</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-                     /*in unsigned long*/ aStateFlags,</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-                     /*in nsresult*/ aStatus) {</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+  onStateChange(/* in nsIWebProgress*/ aWebProgress,</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+                /* in nsIRequest*/ aRequest,</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+                /* in unsigned long*/ aStateFlags,</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+                /* in nsresult*/ aStatus) {</span>
<a href="#l9.20"></a><span id="l9.20">   },</span>
<a href="#l9.21"></a><span id="l9.21"> </span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-  onProgressChange: function(/*in nsIWebProgress*/ aWebProgress,</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">-                        /*in nsIRequest*/ aRequest,</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">-                        /*in long*/ aCurSelfProgress,</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-                        /*in long */aMaxSelfProgress,</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-                        /*in long */aCurTotalProgress,</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-                        /*in long */aMaxTotalProgress) {</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+  onProgressChange(/* in nsIWebProgress*/ aWebProgress,</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+                   /* in nsIRequest*/ aRequest,</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+                   /* in long*/ aCurSelfProgress,</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+                   /* in long */aMaxSelfProgress,</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+                   /* in long */aCurTotalProgress,</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+                   /* in long */aMaxTotalProgress) {</span>
<a href="#l9.34"></a><span id="l9.34">   },</span>
<a href="#l9.35"></a><span id="l9.35"> </span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-  onLocationChange: function(/*in nsIWebProgress*/ aWebProgress,</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-                        /*in nsIRequest*/ aRequest,</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">-                        /*in nsIURI*/ aLocation) {</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+  onLocationChange(/* in nsIWebProgress*/ aWebProgress,</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+                   /* in nsIRequest*/ aRequest,</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+                   /* in nsIURI*/ aLocation) {</span>
<a href="#l9.42"></a><span id="l9.42">     document.getElementById(&quot;headerMessage&quot;).textContent = aLocation.spec;</span>
<a href="#l9.43"></a><span id="l9.43">   },</span>
<a href="#l9.44"></a><span id="l9.44"> </span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-  onStatusChange: function(/*in nsIWebProgress*/ aWebProgress,</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineminus">-                      /*in nsIRequest*/ aRequest,</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-                      /*in nsresult*/ aStatus,</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineminus">-                      /*in wstring*/ aMessage) {</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+  onStatusChange(/* in nsIWebProgress*/ aWebProgress,</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+                 /* in nsIRequest*/ aRequest,</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+                 /* in nsresult*/ aStatus,</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+                 /* in wstring*/ aMessage) {</span>
<a href="#l9.53"></a><span id="l9.53">   },</span>
<a href="#l9.54"></a><span id="l9.54"> </span>
<a href="#l9.55"></a><span id="l9.55" class="difflineminus">-  onSecurityChange: function(/*in nsIWebProgress*/ aWebProgress,</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineminus">-                        /*in nsIRequest*/ aRequest,</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineminus">-                        /*in unsigned long*/ aOldState,</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineminus">-                        /*in unsigned long*/ aState,</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineminus">-                        /*in AString*/ aContentBlockingLogJSON) {</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+  onSecurityChange(/* in nsIWebProgress*/ aWebProgress,</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+                   /* in nsIRequest*/ aRequest,</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineplus">+                   /* in unsigned long*/ aOldState,</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+                   /* in unsigned long*/ aState,</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+                   /* in AString*/ aContentBlockingLogJSON) {</span>
<a href="#l9.65"></a><span id="l9.65">     const wpl_security_bits = wpl.STATE_IS_SECURE |</span>
<a href="#l9.66"></a><span id="l9.66">                               wpl.STATE_IS_BROKEN |</span>
<a href="#l9.67"></a><span id="l9.67">                               wpl.STATE_IS_INSECURE |</span>
<a href="#l9.68"></a><span id="l9.68">                               wpl.STATE_SECURE_HIGH |</span>
<a href="#l9.69"></a><span id="l9.69">                               wpl.STATE_SECURE_MED |</span>
<a href="#l9.70"></a><span id="l9.70">                               wpl.STATE_SECURE_LOW;</span>
<a href="#l9.71"></a><span id="l9.71">     var browser = document.getElementById(&quot;requestFrame&quot;);</span>
<a href="#l9.72"></a><span id="l9.72">     var level;</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineat">@@ -70,36 +70,32 @@ var reporterListener = {</span>
<a href="#l9.74"></a><span id="l9.74">       this.securityButton.setAttribute(&quot;level&quot;, level);</span>
<a href="#l9.75"></a><span id="l9.75">       this.securityButton.hidden = false;</span>
<a href="#l9.76"></a><span id="l9.76">     } else {</span>
<a href="#l9.77"></a><span id="l9.77">       this.securityButton.hidden = true;</span>
<a href="#l9.78"></a><span id="l9.78">       this.securityButton.removeAttribute(&quot;level&quot;);</span>
<a href="#l9.79"></a><span id="l9.79">     }</span>
<a href="#l9.80"></a><span id="l9.80">     this.securityButton.setAttribute(&quot;tooltiptext&quot;,</span>
<a href="#l9.81"></a><span id="l9.81">                                      browser.securityUI.tooltipText);</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineminus">-  }</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineminus">-}</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineplus">+  },</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineplus">+};</span>
<a href="#l9.86"></a><span id="l9.86"> </span>
<a href="#l9.87"></a><span id="l9.87" class="difflineminus">-function cancelRequest()</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineminus">-{</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineplus">+function cancelRequest() {</span>
<a href="#l9.90"></a><span id="l9.90">   reportUserClosed();</span>
<a href="#l9.91"></a><span id="l9.91">   window.close();</span>
<a href="#l9.92"></a><span id="l9.92"> }</span>
<a href="#l9.93"></a><span id="l9.93"> </span>
<a href="#l9.94"></a><span id="l9.94" class="difflineminus">-function reportUserClosed()</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">-{</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineplus">+function reportUserClosed() {</span>
<a href="#l9.97"></a><span id="l9.97">   let request = window.arguments[0].wrappedJSObject;</span>
<a href="#l9.98"></a><span id="l9.98">   request.cancelled();</span>
<a href="#l9.99"></a><span id="l9.99"> }</span>
<a href="#l9.100"></a><span id="l9.100"> </span>
<a href="#l9.101"></a><span id="l9.101" class="difflineminus">-function loadRequestedUrl()</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineminus">-{</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineplus">+function loadRequestedUrl() {</span>
<a href="#l9.104"></a><span id="l9.104">   let request = window.arguments[0].wrappedJSObject;</span>
<a href="#l9.105"></a><span id="l9.105">   document.getElementById(&quot;headerMessage&quot;).textContent = request.promptText;</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineminus">-  let account = request.account;</span>
<a href="#l9.107"></a><span id="l9.107">   if (request.iconURI != &quot;&quot;)</span>
<a href="#l9.108"></a><span id="l9.108">     document.getElementById(&quot;headerImage&quot;).src = request.iconURI;</span>
<a href="#l9.109"></a><span id="l9.109"> </span>
<a href="#l9.110"></a><span id="l9.110">   var browser = document.getElementById(&quot;requestFrame&quot;);</span>
<a href="#l9.111"></a><span id="l9.111">   browser.addProgressListener(reporterListener,</span>
<a href="#l9.112"></a><span id="l9.112">                               Ci.nsIWebProgress.NOTIFY_ALL);</span>
<a href="#l9.113"></a><span id="l9.113">   var url = request.url;</span>
<a href="#l9.114"></a><span id="l9.114">   if (url != &quot;&quot;) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/base/content/commandglue.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/base/content/commandglue.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1,54 +1,49 @@</span>
<a href="#l10.4"></a><span id="l10.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.5"></a><span id="l10.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l10.6"></a><span id="l10.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8"> /*</span>
<a href="#l10.9"></a><span id="l10.9">  * Command-specific code. This stuff should be called by the widgets</span>
<a href="#l10.10"></a><span id="l10.10">  */</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+var { MailViewConstants } = ChromeUtils.import(&quot;resource:///modules/MailViewManager.jsm&quot;, null);</span>
<a href="#l10.13"></a><span id="l10.13"> ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l10.14"></a><span id="l10.14"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l10.15"></a><span id="l10.15"> </span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-function UpdateMailToolbar(caller)</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-{</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+function UpdateMailToolbar(caller) {</span>
<a href="#l10.19"></a><span id="l10.19">   // If we have a transient selection, we shouldn't update the toolbar. We'll</span>
<a href="#l10.20"></a><span id="l10.20">   // update it once we've restored the original selection.</span>
<a href="#l10.21"></a><span id="l10.21">   if (&quot;gRightMouseButtonSavedSelection&quot; in window &amp;&amp;</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-      gRightMouseButtonSavedSelection)</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+      window.gRightMouseButtonSavedSelection)</span>
<a href="#l10.24"></a><span id="l10.24">     return;</span>
<a href="#l10.25"></a><span id="l10.25"> </span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-  //dump(&quot;XXX update mail-toolbar &quot; + caller + &quot;\n&quot;);</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineminus">-  document.commandDispatcher.updateCommands('mail-toolbar');</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+  // dump(&quot;XXX update mail-toolbar &quot; + caller + &quot;\n&quot;);</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+  document.commandDispatcher.updateCommands(&quot;mail-toolbar&quot;);</span>
<a href="#l10.30"></a><span id="l10.30"> </span>
<a href="#l10.31"></a><span id="l10.31">   // hook for extra toolbar items</span>
<a href="#l10.32"></a><span id="l10.32">   Services.obs.notifyObservers(window, &quot;mail:updateToolbarItems&quot;);</span>
<a href="#l10.33"></a><span id="l10.33"> }</span>
<a href="#l10.34"></a><span id="l10.34"> </span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-function isNewsURI(uri)</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">-{</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-    if (!uri || !uri.startsWith('n')) {</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+function isNewsURI(uri) {</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+    if (!uri) {</span>
<a href="#l10.40"></a><span id="l10.40">         return false;</span>
<a href="#l10.41"></a><span id="l10.41">     }</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineminus">-    else {</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineminus">-        return ((uri.startsWith(&quot;news:/&quot;)) || (uri.startsWith(&quot;news-message:/&quot;)));</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">-    }</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+    return uri.startsWith(&quot;news:/&quot;) || uri.startsWith(&quot;news-message:/&quot;);</span>
<a href="#l10.46"></a><span id="l10.46"> }</span>
<a href="#l10.47"></a><span id="l10.47"> </span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-function SwitchView(command)</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineminus">-{</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+function SwitchView(command) {</span>
<a href="#l10.51"></a><span id="l10.51">   // when switching thread views, we might be coming out of quick search</span>
<a href="#l10.52"></a><span id="l10.52">   // or a message view.</span>
<a href="#l10.53"></a><span id="l10.53">   // first set view picker to all</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineminus">-  if (gFolderDisplay.view.mailViewIndex != kViewItemAll)</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineminus">-    gFolderDisplay.view.setMailView(kViewItemAll);</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+  if (gFolderDisplay.view.mailViewIndex != MailViewConstants.kViewItemAll)</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+    gFolderDisplay.view.setMailView(MailViewConstants.kViewItemAll);</span>
<a href="#l10.58"></a><span id="l10.58"> </span>
<a href="#l10.59"></a><span id="l10.59" class="difflineminus">-  switch(command)</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineminus">-  {</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+  switch (command) {</span>
<a href="#l10.62"></a><span id="l10.62">     // &quot;All&quot; threads and &quot;Unread&quot; threads don't change threading state</span>
<a href="#l10.63"></a><span id="l10.63">     case &quot;cmd_viewAllMsgs&quot;:</span>
<a href="#l10.64"></a><span id="l10.64">       gFolderDisplay.view.showUnreadOnly = false;</span>
<a href="#l10.65"></a><span id="l10.65">       break;</span>
<a href="#l10.66"></a><span id="l10.66">     case &quot;cmd_viewUnreadMsgs&quot;:</span>
<a href="#l10.67"></a><span id="l10.67">       gFolderDisplay.view.showUnreadOnly = true;</span>
<a href="#l10.68"></a><span id="l10.68">       break;</span>
<a href="#l10.69"></a><span id="l10.69">     // &quot;Threads with Unread&quot; and &quot;Watched Threads with Unread&quot; force threading</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineat">@@ -61,54 +56,50 @@ function SwitchView(command)</span>
<a href="#l10.71"></a><span id="l10.71">     // &quot;Ignored Threads&quot; toggles 'ignored' inclusion --</span>
<a href="#l10.72"></a><span id="l10.72">     //   but it also resets 'With Unread' views to 'All'</span>
<a href="#l10.73"></a><span id="l10.73">     case &quot;cmd_viewIgnoredThreads&quot;:</span>
<a href="#l10.74"></a><span id="l10.74">       gFolderDisplay.view.showIgnored = !gFolderDisplay.view.showIgnored;</span>
<a href="#l10.75"></a><span id="l10.75">       break;</span>
<a href="#l10.76"></a><span id="l10.76">   }</span>
<a href="#l10.77"></a><span id="l10.77"> }</span>
<a href="#l10.78"></a><span id="l10.78"> </span>
<a href="#l10.79"></a><span id="l10.79" class="difflineminus">-function SetNewsFolderColumns()</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineminus">-{</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+function SetNewsFolderColumns() {</span>
<a href="#l10.82"></a><span id="l10.82">   var sizeColumn = document.getElementById(&quot;sizeCol&quot;);</span>
<a href="#l10.83"></a><span id="l10.83">   var bundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l10.84"></a><span id="l10.84"> </span>
<a href="#l10.85"></a><span id="l10.85">   if (gDBView.usingLines) {</span>
<a href="#l10.86"></a><span id="l10.86">      sizeColumn.setAttribute(&quot;label&quot;, bundle.getString(&quot;linesColumnHeader&quot;));</span>
<a href="#l10.87"></a><span id="l10.87">      sizeColumn.setAttribute(&quot;tooltiptext&quot;,</span>
<a href="#l10.88"></a><span id="l10.88">                              bundle.getString(&quot;linesColumnTooltip2&quot;));</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineminus">-  }</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineminus">-  else {</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+  } else {</span>
<a href="#l10.92"></a><span id="l10.92">      sizeColumn.setAttribute(&quot;label&quot;, bundle.getString(&quot;sizeColumnHeader&quot;));</span>
<a href="#l10.93"></a><span id="l10.93">      sizeColumn.setAttribute(&quot;tooltiptext&quot;,</span>
<a href="#l10.94"></a><span id="l10.94">                              bundle.getString(&quot;sizeColumnTooltip2&quot;));</span>
<a href="#l10.95"></a><span id="l10.95">   }</span>
<a href="#l10.96"></a><span id="l10.96"> }</span>
<a href="#l10.97"></a><span id="l10.97"> </span>
<a href="#l10.98"></a><span id="l10.98"> /**</span>
<a href="#l10.99"></a><span id="l10.99">  * For non-folder based tabs, message counts don't apply.</span>
<a href="#l10.100"></a><span id="l10.100">  * Therefore hide the counts for those folders. For folder based tabs</span>
<a href="#l10.101"></a><span id="l10.101">  * let the tab decide whether or not to show it in UpdateStatusMessageCounts().</span>
<a href="#l10.102"></a><span id="l10.102">  */</span>
<a href="#l10.103"></a><span id="l10.103"> var statusMessageCountsMonitor = {</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineminus">-  onTabTitleChanged: function() {},</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineminus">-  onTabSwitched: function statusMessageCountsMonitor_onTabSwitched(aTab, aOldTab) {</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineplus">+  onTabTitleChanged() {},</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineplus">+  onTabSwitched(aTab, aOldTab) {</span>
<a href="#l10.108"></a><span id="l10.108">     if (aTab.mode.name != &quot;folder&quot; &amp;&amp; aTab.mode.name != &quot;glodaSearch&quot;) {</span>
<a href="#l10.109"></a><span id="l10.109">       document.getElementById(&quot;unreadMessageCount&quot;).hidden = true;</span>
<a href="#l10.110"></a><span id="l10.110">       document.getElementById(&quot;totalMessageCount&quot;).hidden = true;</span>
<a href="#l10.111"></a><span id="l10.111">     }</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineminus">-  }</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineminus">-}</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineplus">+  },</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineplus">+};</span>
<a href="#l10.116"></a><span id="l10.116"> </span>
<a href="#l10.117"></a><span id="l10.117" class="difflineminus">-function UpdateStatusMessageCounts(folder)</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineminus">-{</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineplus">+function UpdateStatusMessageCounts(folder) {</span>
<a href="#l10.120"></a><span id="l10.120">   var unreadElement = document.getElementById(&quot;unreadMessageCount&quot;);</span>
<a href="#l10.121"></a><span id="l10.121">   var totalElement = document.getElementById(&quot;totalMessageCount&quot;);</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineminus">-  if (folder &amp;&amp; !folder.isServer &amp;&amp; unreadElement &amp;&amp; totalElement)</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineminus">-  {</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineplus">+  if (folder &amp;&amp; !folder.isServer &amp;&amp; unreadElement &amp;&amp; totalElement) {</span>
<a href="#l10.125"></a><span id="l10.125">     var numSelected = gFolderDisplay.selectedCount;</span>
<a href="#l10.126"></a><span id="l10.126">     var bundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l10.127"></a><span id="l10.127"> </span>
<a href="#l10.128"></a><span id="l10.128">     var numUnread = (numSelected &gt; 1) ?</span>
<a href="#l10.129"></a><span id="l10.129">             bundle.getFormattedString(&quot;selectedMsgStatus&quot;, [numSelected]) :</span>
<a href="#l10.130"></a><span id="l10.130">             bundle.getFormattedString(&quot;unreadMsgStatus&quot;,</span>
<a href="#l10.131"></a><span id="l10.131">                                       [folder.getNumUnread(false)]);</span>
<a href="#l10.132"></a><span id="l10.132">     var numTotal = bundle.getFormattedString(&quot;totalMsgStatus&quot;,</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineat">@@ -117,56 +108,53 @@ function UpdateStatusMessageCounts(folde</span>
<a href="#l10.134"></a><span id="l10.134">     unreadElement.setAttribute(&quot;label&quot;, numUnread);</span>
<a href="#l10.135"></a><span id="l10.135">     totalElement.setAttribute(&quot;label&quot;, numTotal);</span>
<a href="#l10.136"></a><span id="l10.136">     unreadElement.hidden = false;</span>
<a href="#l10.137"></a><span id="l10.137">     totalElement.hidden = false;</span>
<a href="#l10.138"></a><span id="l10.138">   }</span>
<a href="#l10.139"></a><span id="l10.139"> }</span>
<a href="#l10.140"></a><span id="l10.140"> </span>
<a href="#l10.141"></a><span id="l10.141"> var gQuotaUICache;</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineminus">-function UpdateStatusQuota(folder)</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineminus">-{</span>
<a href="#l10.144"></a><span id="l10.144" class="difflineplus">+function UpdateStatusQuota(folder) {</span>
<a href="#l10.145"></a><span id="l10.145">   if (!(folder &amp;&amp; // no folder selected</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineminus">-        folder instanceof Ci.nsIMsgImapMailFolder)) // POP etc.</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineminus">-  {</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineplus">+        folder instanceof Ci.nsIMsgImapMailFolder)) { // POP etc.</span>
<a href="#l10.149"></a><span id="l10.149">     if (typeof(gQuotaUICache) == &quot;object&quot;) // ever shown quota</span>
<a href="#l10.150"></a><span id="l10.150">       gQuotaUICache.panel.hidden = true;</span>
<a href="#l10.151"></a><span id="l10.151">     return;</span>
<a href="#l10.152"></a><span id="l10.152">   }</span>
<a href="#l10.153"></a><span id="l10.153">   folder = folder.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l10.154"></a><span id="l10.154"> </span>
<a href="#l10.155"></a><span id="l10.155">   // get element references and prefs</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineminus">-  if (typeof(gQuotaUICache) != &quot;object&quot;)</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineminus">-  {</span>
<a href="#l10.158"></a><span id="l10.158" class="difflineminus">-    gQuotaUICache = new Object();</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineplus">+  if (typeof(gQuotaUICache) != &quot;object&quot;) {</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineplus">+    gQuotaUICache = {};</span>
<a href="#l10.161"></a><span id="l10.161">     gQuotaUICache.meter = document.getElementById(&quot;quotaMeter&quot;);</span>
<a href="#l10.162"></a><span id="l10.162">     gQuotaUICache.panel = document.getElementById(&quot;quotaPanel&quot;);</span>
<a href="#l10.163"></a><span id="l10.163">     gQuotaUICache.label = document.getElementById(&quot;quotaLabel&quot;);</span>
<a href="#l10.164"></a><span id="l10.164">     const kBranch = &quot;mail.quota.mainwindow_threshold.&quot;;</span>
<a href="#l10.165"></a><span id="l10.165">     gQuotaUICache.showTreshold = Services.prefs.getIntPref(kBranch + &quot;show&quot;);</span>
<a href="#l10.166"></a><span id="l10.166">     gQuotaUICache.warningTreshold = Services.prefs.getIntPref(kBranch + &quot;warning&quot;);</span>
<a href="#l10.167"></a><span id="l10.167">     gQuotaUICache.criticalTreshold = Services.prefs.getIntPref(kBranch + &quot;critical&quot;);</span>
<a href="#l10.168"></a><span id="l10.168">   }</span>
<a href="#l10.169"></a><span id="l10.169"> </span>
<a href="#l10.170"></a><span id="l10.170">   var valid = {value: null};</span>
<a href="#l10.171"></a><span id="l10.171">   var used = {value: null};</span>
<a href="#l10.172"></a><span id="l10.172">   var max = {value: null};</span>
<a href="#l10.173"></a><span id="l10.173">   try {</span>
<a href="#l10.174"></a><span id="l10.174">     // get data from backend</span>
<a href="#l10.175"></a><span id="l10.175">     folder.getQuota(valid, used, max);</span>
<a href="#l10.176"></a><span id="l10.176" class="difflineminus">-  } catch (e) { dump(e + &quot;\n&quot;); }</span>
<a href="#l10.177"></a><span id="l10.177" class="difflineminus">-  if (valid.value &amp;&amp; max.value &gt; 0)</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineminus">-  {</span>
<a href="#l10.179"></a><span id="l10.179" class="difflineplus">+  } catch (e) {</span>
<a href="#l10.180"></a><span id="l10.180" class="difflineplus">+    dump(e + &quot;\n&quot;);</span>
<a href="#l10.181"></a><span id="l10.181" class="difflineplus">+  }</span>
<a href="#l10.182"></a><span id="l10.182" class="difflineplus">+  if (valid.value &amp;&amp; max.value &gt; 0) {</span>
<a href="#l10.183"></a><span id="l10.183">     var percent = Math.round(used.value / max.value * 100);</span>
<a href="#l10.184"></a><span id="l10.184"> </span>
<a href="#l10.185"></a><span id="l10.185">     // show in UI</span>
<a href="#l10.186"></a><span id="l10.186" class="difflineminus">-    if (percent &lt; gQuotaUICache.showTreshold)</span>
<a href="#l10.187"></a><span id="l10.187" class="difflineplus">+    if (percent &lt; gQuotaUICache.showTreshold) {</span>
<a href="#l10.188"></a><span id="l10.188">       gQuotaUICache.panel.hidden = true;</span>
<a href="#l10.189"></a><span id="l10.189" class="difflineminus">-    else</span>
<a href="#l10.190"></a><span id="l10.190" class="difflineminus">-    {</span>
<a href="#l10.191"></a><span id="l10.191" class="difflineplus">+    } else {</span>
<a href="#l10.192"></a><span id="l10.192">       gQuotaUICache.panel.hidden = false;</span>
<a href="#l10.193"></a><span id="l10.193">       gQuotaUICache.meter.setAttribute(&quot;value&quot;, percent);</span>
<a href="#l10.194"></a><span id="l10.194">            // do not use value property, because that is imprecise (3%)</span>
<a href="#l10.195"></a><span id="l10.195">            // for optimization that we don't need here</span>
<a href="#l10.196"></a><span id="l10.196">       var bundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l10.197"></a><span id="l10.197">       var label = bundle.getFormattedString(&quot;percent&quot;, [percent]);</span>
<a href="#l10.198"></a><span id="l10.198">       var tooltip = bundle.getFormattedString(&quot;quotaTooltip&quot;,</span>
<a href="#l10.199"></a><span id="l10.199">                                               [used.value, max.value]);</span>
<a href="#l10.200"></a><span id="l10.200" class="difflineat">@@ -174,23 +162,22 @@ function UpdateStatusQuota(folder)</span>
<a href="#l10.201"></a><span id="l10.201">       gQuotaUICache.label.tooltipText = tooltip;</span>
<a href="#l10.202"></a><span id="l10.202">       if (percent &lt; gQuotaUICache.warningTreshold)</span>
<a href="#l10.203"></a><span id="l10.203">         gQuotaUICache.panel.removeAttribute(&quot;alert&quot;);</span>
<a href="#l10.204"></a><span id="l10.204">       else if (percent &lt; gQuotaUICache.criticalTreshold)</span>
<a href="#l10.205"></a><span id="l10.205">         gQuotaUICache.panel.setAttribute(&quot;alert&quot;, &quot;warning&quot;);</span>
<a href="#l10.206"></a><span id="l10.206">       else</span>
<a href="#l10.207"></a><span id="l10.207">         gQuotaUICache.panel.setAttribute(&quot;alert&quot;, &quot;critical&quot;);</span>
<a href="#l10.208"></a><span id="l10.208">     }</span>
<a href="#l10.209"></a><span id="l10.209" class="difflineplus">+  } else {</span>
<a href="#l10.210"></a><span id="l10.210" class="difflineplus">+    gQuotaUICache.panel.hidden = true;</span>
<a href="#l10.211"></a><span id="l10.211">   }</span>
<a href="#l10.212"></a><span id="l10.212" class="difflineminus">-  else</span>
<a href="#l10.213"></a><span id="l10.213" class="difflineminus">-    gQuotaUICache.panel.hidden = true;</span>
<a href="#l10.214"></a><span id="l10.214"> }</span>
<a href="#l10.215"></a><span id="l10.215"> </span>
<a href="#l10.216"></a><span id="l10.216" class="difflineminus">-function ConvertSortTypeToColumnID(sortKey)</span>
<a href="#l10.217"></a><span id="l10.217" class="difflineminus">-{</span>
<a href="#l10.218"></a><span id="l10.218" class="difflineplus">+function ConvertSortTypeToColumnID(sortKey) {</span>
<a href="#l10.219"></a><span id="l10.219">   var columnID;</span>
<a href="#l10.220"></a><span id="l10.220"> </span>
<a href="#l10.221"></a><span id="l10.221">   // Hack to turn this into an integer, if it was a string.</span>
<a href="#l10.222"></a><span id="l10.222">   // It would be a string if it came from XULStore.json.</span>
<a href="#l10.223"></a><span id="l10.223">   sortKey = sortKey - 0;</span>
<a href="#l10.224"></a><span id="l10.224"> </span>
<a href="#l10.225"></a><span id="l10.225">   switch (sortKey) {</span>
<a href="#l10.226"></a><span id="l10.226">     // In the case of None, we default to the date column</span>
<a href="#l10.227"></a><span id="l10.227" class="difflineat">@@ -245,22 +232,20 @@ function ConvertSortTypeToColumnID(sortK</span>
<a href="#l10.228"></a><span id="l10.228">     case nsMsgViewSortType.byJunkStatus:</span>
<a href="#l10.229"></a><span id="l10.229">       columnID = &quot;junkStatusCol&quot;;</span>
<a href="#l10.230"></a><span id="l10.230">       break;</span>
<a href="#l10.231"></a><span id="l10.231">     case nsMsgViewSortType.byAttachments:</span>
<a href="#l10.232"></a><span id="l10.232">       columnID = &quot;attachmentCol&quot;;</span>
<a href="#l10.233"></a><span id="l10.233">       break;</span>
<a href="#l10.234"></a><span id="l10.234">     case nsMsgViewSortType.byCustom:</span>
<a href="#l10.235"></a><span id="l10.235"> </span>
<a href="#l10.236"></a><span id="l10.236" class="difflineminus">-      //TODO: either change try() catch to if (property exists) or restore the getColumnHandler() check</span>
<a href="#l10.237"></a><span id="l10.237" class="difflineminus">-      try //getColumnHandler throws an error when the ID is not handled</span>
<a href="#l10.238"></a><span id="l10.238" class="difflineminus">-      {</span>
<a href="#l10.239"></a><span id="l10.239" class="difflineplus">+      // TODO: either change try() catch to if (property exists) or restore the getColumnHandler() check</span>
<a href="#l10.240"></a><span id="l10.240" class="difflineplus">+      try { // getColumnHandler throws an error when the ID is not handled</span>
<a href="#l10.241"></a><span id="l10.241">         columnID = gDBView.curCustomColumn;</span>
<a href="#l10.242"></a><span id="l10.242" class="difflineminus">-      }</span>
<a href="#l10.243"></a><span id="l10.243" class="difflineminus">-      catch (err) { //error - means no handler</span>
<a href="#l10.244"></a><span id="l10.244" class="difflineplus">+      } catch (err) { // error - means no handler</span>
<a href="#l10.245"></a><span id="l10.245">         dump(&quot;ConvertSortTypeToColumnID: custom sort key but no handler for column '&quot; + columnID + &quot;'\n&quot;);</span>
<a href="#l10.246"></a><span id="l10.246">         columnID = &quot;dateCol&quot;;</span>
<a href="#l10.247"></a><span id="l10.247">       }</span>
<a href="#l10.248"></a><span id="l10.248"> </span>
<a href="#l10.249"></a><span id="l10.249">       break;</span>
<a href="#l10.250"></a><span id="l10.250">     case nsMsgViewSortType.byCorrespondent:</span>
<a href="#l10.251"></a><span id="l10.251">       columnID = &quot;correspondentCol&quot;;</span>
<a href="#l10.252"></a><span id="l10.252">       break;</span>
<a href="#l10.253"></a><span id="l10.253" class="difflineat">@@ -279,54 +264,50 @@ var nsMsgViewCommandType = Ci.nsMsgViewC</span>
<a href="#l10.254"></a><span id="l10.254"> var nsMsgViewType = Ci.nsMsgViewType;</span>
<a href="#l10.255"></a><span id="l10.255"> var nsMsgNavigationType = Ci.nsMsgNavigationType;</span>
<a href="#l10.256"></a><span id="l10.256"> </span>
<a href="#l10.257"></a><span id="l10.257"> var gDBView = null;</span>
<a href="#l10.258"></a><span id="l10.258"> var gCurViewFlags;</span>
<a href="#l10.259"></a><span id="l10.259"> var gCurSortType;</span>
<a href="#l10.260"></a><span id="l10.260"> </span>
<a href="#l10.261"></a><span id="l10.261"> </span>
<a href="#l10.262"></a><span id="l10.262" class="difflineminus">-function ChangeMessagePaneVisibility(now_hidden)</span>
<a href="#l10.263"></a><span id="l10.263" class="difflineminus">-{</span>
<a href="#l10.264"></a><span id="l10.264" class="difflineplus">+function ChangeMessagePaneVisibility(now_hidden) {</span>
<a href="#l10.265"></a><span id="l10.265">   // We also have to disable the Message/Attachments menuitem.</span>
<a href="#l10.266"></a><span id="l10.266">   // It will be enabled when loading a message with attachments</span>
<a href="#l10.267"></a><span id="l10.267">   // (see messageHeaderSink.handleAttachment).</span>
<a href="#l10.268"></a><span id="l10.268">   var node = document.getElementById(&quot;msgAttachmentMenu&quot;);</span>
<a href="#l10.269"></a><span id="l10.269">   if (node &amp;&amp; now_hidden)</span>
<a href="#l10.270"></a><span id="l10.270">     node.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l10.271"></a><span id="l10.271"> </span>
<a href="#l10.272"></a><span id="l10.272">   gMessageDisplay.visible = !now_hidden;</span>
<a href="#l10.273"></a><span id="l10.273"> </span>
<a href="#l10.274"></a><span id="l10.274" class="difflineminus">-  var event = document.createEvent('Events');</span>
<a href="#l10.275"></a><span id="l10.275" class="difflineplus">+  var event = document.createEvent(&quot;Events&quot;);</span>
<a href="#l10.276"></a><span id="l10.276">   if (now_hidden) {</span>
<a href="#l10.277"></a><span id="l10.277" class="difflineminus">-    event.initEvent('messagepane-hide', false, true);</span>
<a href="#l10.278"></a><span id="l10.278" class="difflineminus">-  }</span>
<a href="#l10.279"></a><span id="l10.279" class="difflineminus">-  else {</span>
<a href="#l10.280"></a><span id="l10.280" class="difflineminus">-    event.initEvent('messagepane-unhide', false, true);</span>
<a href="#l10.281"></a><span id="l10.281" class="difflineplus">+    event.initEvent(&quot;messagepane-hide&quot;, false, true);</span>
<a href="#l10.282"></a><span id="l10.282" class="difflineplus">+  } else {</span>
<a href="#l10.283"></a><span id="l10.283" class="difflineplus">+    event.initEvent(&quot;messagepane-unhide&quot;, false, true);</span>
<a href="#l10.284"></a><span id="l10.284">   }</span>
<a href="#l10.285"></a><span id="l10.285">   document.getElementById(&quot;messengerWindow&quot;).dispatchEvent(event);</span>
<a href="#l10.286"></a><span id="l10.286"> }</span>
<a href="#l10.287"></a><span id="l10.287"> </span>
<a href="#l10.288"></a><span id="l10.288" class="difflineminus">-function OnMouseUpThreadAndMessagePaneSplitter()</span>
<a href="#l10.289"></a><span id="l10.289" class="difflineminus">-{</span>
<a href="#l10.290"></a><span id="l10.290" class="difflineplus">+function OnMouseUpThreadAndMessagePaneSplitter() {</span>
<a href="#l10.291"></a><span id="l10.291">   // The collapsed state is the state after we released the mouse,</span>
<a href="#l10.292"></a><span id="l10.292">   // so we take it as it is.</span>
<a href="#l10.293"></a><span id="l10.293">   ChangeMessagePaneVisibility(IsMessagePaneCollapsed());</span>
<a href="#l10.294"></a><span id="l10.294"> }</span>
<a href="#l10.295"></a><span id="l10.295"> </span>
<a href="#l10.296"></a><span id="l10.296"> /**</span>
<a href="#l10.297"></a><span id="l10.297">  * Our multiplexed tabbing model ends up sending synthetic folder pane</span>
<a href="#l10.298"></a><span id="l10.298">  *  selection change notifications.  We want to ignore these because the</span>
<a href="#l10.299"></a><span id="l10.299">  *  user may explicitly re-select a folder intentionally, and we want to</span>
<a href="#l10.300"></a><span id="l10.300">  *  be able to know that.  So we filter out the synthetics here.</span>
<a href="#l10.301"></a><span id="l10.301">  * The tabbing logic sets this global to help us out.</span>
<a href="#l10.302"></a><span id="l10.302">  */</span>
<a href="#l10.303"></a><span id="l10.303"> var gIgnoreSyntheticFolderPaneSelectionChange = false;</span>
<a href="#l10.304"></a><span id="l10.304" class="difflineminus">-function FolderPaneSelectionChange()</span>
<a href="#l10.305"></a><span id="l10.305" class="difflineminus">-{</span>
<a href="#l10.306"></a><span id="l10.306" class="difflineplus">+function FolderPaneSelectionChange() {</span>
<a href="#l10.307"></a><span id="l10.307">   let folders = GetSelectedMsgFolders();</span>
<a href="#l10.308"></a><span id="l10.308">   if (folders.length) {</span>
<a href="#l10.309"></a><span id="l10.309">     let msgFolder = folders[0];</span>
<a href="#l10.310"></a><span id="l10.310">     let locationItem = document.getElementById(&quot;locationFolders&quot;);</span>
<a href="#l10.311"></a><span id="l10.311">     if (locationItem) {</span>
<a href="#l10.312"></a><span id="l10.312">       locationItem.setAttribute(&quot;label&quot;, msgFolder.prettyName);</span>
<a href="#l10.313"></a><span id="l10.313">       document.getElementById(&quot;folderLocationPopup&quot;)</span>
<a href="#l10.314"></a><span id="l10.314">               ._setCssSelectors(msgFolder, locationItem);</span>
<a href="#l10.315"></a><span id="l10.315" class="difflineat">@@ -348,17 +329,15 @@ function FolderPaneSelectionChange()</span>
<a href="#l10.316"></a><span id="l10.316">   // and we don't want to load the contents of the folder.</span>
<a href="#l10.317"></a><span id="l10.317">   if (!folderSelection.isSelected(folderSelection.currentIndex))</span>
<a href="#l10.318"></a><span id="l10.318">     return;</span>
<a href="#l10.319"></a><span id="l10.319"> </span>
<a href="#l10.320"></a><span id="l10.320">   gFolderDisplay.show(folders.length ? folders[0] : null);</span>
<a href="#l10.321"></a><span id="l10.321">   SetGetMsgButtonTooltip();</span>
<a href="#l10.322"></a><span id="l10.322"> }</span>
<a href="#l10.323"></a><span id="l10.323"> </span>
<a href="#l10.324"></a><span id="l10.324" class="difflineminus">-function Undo()</span>
<a href="#l10.325"></a><span id="l10.325" class="difflineminus">-{</span>
<a href="#l10.326"></a><span id="l10.326" class="difflineplus">+function Undo() {</span>
<a href="#l10.327"></a><span id="l10.327">     messenger.undo(msgWindow);</span>
<a href="#l10.328"></a><span id="l10.328"> }</span>
<a href="#l10.329"></a><span id="l10.329"> </span>
<a href="#l10.330"></a><span id="l10.330" class="difflineminus">-function Redo()</span>
<a href="#l10.331"></a><span id="l10.331" class="difflineminus">-{</span>
<a href="#l10.332"></a><span id="l10.332" class="difflineplus">+function Redo() {</span>
<a href="#l10.333"></a><span id="l10.333">     messenger.redo(msgWindow);</span>
<a href="#l10.334"></a><span id="l10.334"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/base/content/contentAreaClick.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/base/content/contentAreaClick.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -11,84 +11,73 @@</span>
<a href="#l11.4"></a><span id="l11.4">    * we return the form action.</span>
<a href="#l11.5"></a><span id="l11.5">    *</span>
<a href="#l11.6"></a><span id="l11.6">    * @return href for the url being clicked</span>
<a href="#l11.7"></a><span id="l11.7">    */</span>
<a href="#l11.8"></a><span id="l11.8"> </span>
<a href="#l11.9"></a><span id="l11.9">   ChromeUtils.import(&quot;resource://gre/modules/PlacesUtils.jsm&quot;);</span>
<a href="#l11.10"></a><span id="l11.10">   ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-  function hRefForClickEvent(aEvent, aDontCheckInputElement)</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-  {</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+  function hRefForClickEvent(aEvent, aDontCheckInputElement) {</span>
<a href="#l11.15"></a><span id="l11.15">     var href;</span>
<a href="#l11.16"></a><span id="l11.16">     var isKeyCommand = (aEvent.type == &quot;command&quot;);</span>
<a href="#l11.17"></a><span id="l11.17">     var target =</span>
<a href="#l11.18"></a><span id="l11.18">       isKeyCommand ? document.commandDispatcher.focusedElement : aEvent.target;</span>
<a href="#l11.19"></a><span id="l11.19"> </span>
<a href="#l11.20"></a><span id="l11.20">     if (target instanceof HTMLAnchorElement ||</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-        target instanceof HTMLAreaElement   ||</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-        target instanceof HTMLLinkElement)</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-    {</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+        target instanceof HTMLAreaElement ||</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+        target instanceof HTMLLinkElement) {</span>
<a href="#l11.26"></a><span id="l11.26">       if (target.hasAttribute(&quot;href&quot;))</span>
<a href="#l11.27"></a><span id="l11.27">         href = target.href;</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-    }</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-    else if (target instanceof HTMLImageElement &amp;&amp;</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-             target.hasAttribute(&quot;overflowing&quot;))</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-    {</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+    } else if (target instanceof HTMLImageElement &amp;&amp;</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+               target.hasAttribute(&quot;overflowing&quot;)) {</span>
<a href="#l11.34"></a><span id="l11.34">       // Return if an image is zoomed, otherwise fall through to see if it has</span>
<a href="#l11.35"></a><span id="l11.35">       // a link node.</span>
<a href="#l11.36"></a><span id="l11.36">       return href;</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-    }</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">-    else if (!aDontCheckInputElement &amp;&amp; ((target instanceof HTMLInputElement) ||</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-                                         (target instanceof HTMLButtonElement)))</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">-    {</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+    } else if (!aDontCheckInputElement &amp;&amp; ((target instanceof HTMLInputElement) ||</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+                                           (target instanceof HTMLButtonElement))) {</span>
<a href="#l11.43"></a><span id="l11.43">       if (target.form &amp;&amp; target.form.action)</span>
<a href="#l11.44"></a><span id="l11.44">         href = target.form.action;</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-    }</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineminus">-    else</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineminus">-    {</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+    } else {</span>
<a href="#l11.49"></a><span id="l11.49">       // We may be nested inside of a link node.</span>
<a href="#l11.50"></a><span id="l11.50">       var linkNode = aEvent.originalTarget;</span>
<a href="#l11.51"></a><span id="l11.51">       while (linkNode &amp;&amp; !(linkNode instanceof HTMLAnchorElement))</span>
<a href="#l11.52"></a><span id="l11.52">         linkNode = linkNode.parentNode;</span>
<a href="#l11.53"></a><span id="l11.53"> </span>
<a href="#l11.54"></a><span id="l11.54">       if (linkNode)</span>
<a href="#l11.55"></a><span id="l11.55">         href = linkNode.href;</span>
<a href="#l11.56"></a><span id="l11.56">     }</span>
<a href="#l11.57"></a><span id="l11.57"> </span>
<a href="#l11.58"></a><span id="l11.58">     return href;</span>
<a href="#l11.59"></a><span id="l11.59">   }</span>
<a href="#l11.60"></a><span id="l11.60"> </span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-function messagePaneOnResize(aEvent)</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-{</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+function messagePaneOnResize(aEvent) {</span>
<a href="#l11.64"></a><span id="l11.64">   // Scale any overflowing images, exclude http content.</span>
<a href="#l11.65"></a><span id="l11.65">   let browser = getBrowser();</span>
<a href="#l11.66"></a><span id="l11.66">   let doc = browser &amp;&amp; browser.contentDocument ? browser.contentDocument : null;</span>
<a href="#l11.67"></a><span id="l11.67">   if (!doc || doc.URL.startsWith(&quot;http&quot;) || !doc.images)</span>
<a href="#l11.68"></a><span id="l11.68">     return;</span>
<a href="#l11.69"></a><span id="l11.69"> </span>
<a href="#l11.70"></a><span id="l11.70" class="difflineminus">-  for (let img of doc.images)</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineminus">-  {</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+  for (let img of doc.images) {</span>
<a href="#l11.73"></a><span id="l11.73">     if (img.clientWidth - doc.body.offsetWidth &gt;= 0 &amp;&amp;</span>
<a href="#l11.74"></a><span id="l11.74">         (img.clientWidth &lt;= img.naturalWidth || !img.naturalWidth))</span>
<a href="#l11.75"></a><span id="l11.75">       img.setAttribute(&quot;overflowing&quot;, true);</span>
<a href="#l11.76"></a><span id="l11.76">     else</span>
<a href="#l11.77"></a><span id="l11.77">       img.removeAttribute(&quot;overflowing&quot;);</span>
<a href="#l11.78"></a><span id="l11.78">   }</span>
<a href="#l11.79"></a><span id="l11.79"> }</span>
<a href="#l11.80"></a><span id="l11.80"> </span>
<a href="#l11.81"></a><span id="l11.81"> /**</span>
<a href="#l11.82"></a><span id="l11.82">  * Check whether the click target's or its ancestor's href</span>
<a href="#l11.83"></a><span id="l11.83">  * points to an anchor on the page.</span>
<a href="#l11.84"></a><span id="l11.84">  *</span>
<a href="#l11.85"></a><span id="l11.85">  * @param HTMLElement aTargetNode - the element node.</span>
<a href="#l11.86"></a><span id="l11.86">  * @return                        - true if link pointing to anchor.</span>
<a href="#l11.87"></a><span id="l11.87">  */</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineminus">-function isLinkToAnchorOnPage(aTargetNode)</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineminus">-{</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+function isLinkToAnchorOnPage(aTargetNode) {</span>
<a href="#l11.91"></a><span id="l11.91">   let url = aTargetNode.ownerDocument.URL;</span>
<a href="#l11.92"></a><span id="l11.92">   if (!url.startsWith(&quot;http&quot;))</span>
<a href="#l11.93"></a><span id="l11.93">     return false;</span>
<a href="#l11.94"></a><span id="l11.94"> </span>
<a href="#l11.95"></a><span id="l11.95">   let linkNode = aTargetNode;</span>
<a href="#l11.96"></a><span id="l11.96">   while (linkNode &amp;&amp; !(linkNode instanceof HTMLAnchorElement))</span>
<a href="#l11.97"></a><span id="l11.97">     linkNode = linkNode.parentNode;</span>
<a href="#l11.98"></a><span id="l11.98"> </span>
<a href="#l11.99"></a><span id="l11.99" class="difflineat">@@ -100,18 +89,17 @@ function isLinkToAnchorOnPage(aTargetNod</span>
<a href="#l11.100"></a><span id="l11.100">   if (makeURI(linkNode.href).specIgnoringRef != makeURI(url).specIgnoringRef)</span>
<a href="#l11.101"></a><span id="l11.101">     return false;</span>
<a href="#l11.102"></a><span id="l11.102"> </span>
<a href="#l11.103"></a><span id="l11.103">   return true;</span>
<a href="#l11.104"></a><span id="l11.104"> }</span>
<a href="#l11.105"></a><span id="l11.105"> </span>
<a href="#l11.106"></a><span id="l11.106"> // Called whenever the user clicks in the content area,</span>
<a href="#l11.107"></a><span id="l11.107"> // should always return true for click to go through.</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineminus">-function contentAreaClick(aEvent)</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineminus">-{</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineplus">+function contentAreaClick(aEvent) {</span>
<a href="#l11.111"></a><span id="l11.111">   let target = aEvent.target;</span>
<a href="#l11.112"></a><span id="l11.112"> </span>
<a href="#l11.113"></a><span id="l11.113">   // If we've loaded a web page url, and the element's or its ancestor's href</span>
<a href="#l11.114"></a><span id="l11.114">   // points to an anchor on the page, let the click go through.</span>
<a href="#l11.115"></a><span id="l11.115">   // Otherwise fall through and open externally.</span>
<a href="#l11.116"></a><span id="l11.116">   if (isLinkToAnchorOnPage(target))</span>
<a href="#l11.117"></a><span id="l11.117">     return true;</span>
<a href="#l11.118"></a><span id="l11.118"> </span>
<a href="#l11.119"></a><span id="l11.119" class="difflineat">@@ -167,28 +155,27 @@ function contentAreaClick(aEvent)</span>
<a href="#l11.120"></a><span id="l11.120"> }</span>
<a href="#l11.121"></a><span id="l11.121"> </span>
<a href="#l11.122"></a><span id="l11.122"> /**</span>
<a href="#l11.123"></a><span id="l11.123">  * Forces a url to open in an external application according to the protocol</span>
<a href="#l11.124"></a><span id="l11.124">  * service settings.</span>
<a href="#l11.125"></a><span id="l11.125">  *</span>
<a href="#l11.126"></a><span id="l11.126">  * @param url  A url string or an nsIURI containing the url to open.</span>
<a href="#l11.127"></a><span id="l11.127">  */</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineminus">-function openLinkExternally(url)</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineminus">-{</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineplus">+function openLinkExternally(url) {</span>
<a href="#l11.131"></a><span id="l11.131">   let uri = url;</span>
<a href="#l11.132"></a><span id="l11.132">   if (!(uri instanceof Ci.nsIURI))</span>
<a href="#l11.133"></a><span id="l11.133">     uri = Services.io.newURI(url);</span>
<a href="#l11.134"></a><span id="l11.134"> </span>
<a href="#l11.135"></a><span id="l11.135">   // This can fail if there is a problem with the places database.</span>
<a href="#l11.136"></a><span id="l11.136">   PlacesUtils.history.insert({</span>
<a href="#l11.137"></a><span id="l11.137">     url, // accepts both string and nsIURI</span>
<a href="#l11.138"></a><span id="l11.138">     visits: [{</span>
<a href="#l11.139"></a><span id="l11.139">       date: new Date(),</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineminus">-    }]</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineplus">+    }],</span>
<a href="#l11.142"></a><span id="l11.142">   }).catch(Cu.reportError);</span>
<a href="#l11.143"></a><span id="l11.143"> </span>
<a href="#l11.144"></a><span id="l11.144">   Cc[&quot;@mozilla.org/uriloader/external-protocol-service;1&quot;]</span>
<a href="#l11.145"></a><span id="l11.145">     .getService(Ci.nsIExternalProtocolService)</span>
<a href="#l11.146"></a><span id="l11.146">     .loadURI(uri);</span>
<a href="#l11.147"></a><span id="l11.147"> }</span>
<a href="#l11.148"></a><span id="l11.148"> </span>
<a href="#l11.149"></a><span id="l11.149"> /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/base/content/editContactPanel.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/base/content/editContactPanel.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -8,54 +8,54 @@ ChromeUtils.import(&quot;resource://gre/modul</span>
<a href="#l12.4"></a><span id="l12.4"> </span>
<a href="#l12.5"></a><span id="l12.5"> var editContactInlineUI = {</span>
<a href="#l12.6"></a><span id="l12.6">   _overlayLoaded: false,</span>
<a href="#l12.7"></a><span id="l12.7">   _overlayLoading: false,</span>
<a href="#l12.8"></a><span id="l12.8">   _cardDetails: null,</span>
<a href="#l12.9"></a><span id="l12.9">   _writeable: true,</span>
<a href="#l12.10"></a><span id="l12.10">   _blockedCommands: [&quot;cmd_close&quot;],</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-  _blockCommands: function () {</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+  _blockCommands() {</span>
<a href="#l12.14"></a><span id="l12.14">     for (var i = 0; i &lt; this._blockedCommands; ++i) {</span>
<a href="#l12.15"></a><span id="l12.15">       var elt = document.getElementById(this._blockedCommands[i]);</span>
<a href="#l12.16"></a><span id="l12.16">       // make sure not to permanetly disable this item</span>
<a href="#l12.17"></a><span id="l12.17">       if (elt.hasAttribute(&quot;wasDisabled&quot;))</span>
<a href="#l12.18"></a><span id="l12.18">         continue;</span>
<a href="#l12.19"></a><span id="l12.19"> </span>
<a href="#l12.20"></a><span id="l12.20" class="difflineminus">-      if (elt.getAttribute(&quot;disabled&quot;) == &quot;true&quot;)</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+      if (elt.getAttribute(&quot;disabled&quot;) == &quot;true&quot;) {</span>
<a href="#l12.22"></a><span id="l12.22">         elt.setAttribute(&quot;wasDisabled&quot;, &quot;true&quot;);</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineminus">-      else {</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+      } else {</span>
<a href="#l12.25"></a><span id="l12.25">         elt.setAttribute(&quot;wasDisabled&quot;, &quot;false&quot;);</span>
<a href="#l12.26"></a><span id="l12.26">         elt.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l12.27"></a><span id="l12.27">       }</span>
<a href="#l12.28"></a><span id="l12.28">     }</span>
<a href="#l12.29"></a><span id="l12.29">   },</span>
<a href="#l12.30"></a><span id="l12.30"> </span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-  _restoreCommandsState: function () {</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+  _restoreCommandsState() {</span>
<a href="#l12.33"></a><span id="l12.33">     for (var i = 0; i &lt; this._blockedCommands; ++i) {</span>
<a href="#l12.34"></a><span id="l12.34">       var elt = document.getElementById(this._blockedCommands[i]);</span>
<a href="#l12.35"></a><span id="l12.35">       if (elt.getAttribute(&quot;wasDisabled&quot;) != &quot;true&quot;)</span>
<a href="#l12.36"></a><span id="l12.36">         elt.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l12.37"></a><span id="l12.37">       elt.removeAttribute(&quot;wasDisabled&quot;);</span>
<a href="#l12.38"></a><span id="l12.38">     }</span>
<a href="#l12.39"></a><span id="l12.39">     document.getElementById(&quot;editContactAddressBookList&quot;).disabled = false;</span>
<a href="#l12.40"></a><span id="l12.40">     document.getElementById(&quot;contactMoveDisabledText&quot;).collapsed = true;</span>
<a href="#l12.41"></a><span id="l12.41">   },</span>
<a href="#l12.42"></a><span id="l12.42"> </span>
<a href="#l12.43"></a><span id="l12.43" class="difflineminus">-  onPopupHidden: function (aEvent) {</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+  onPopupHidden(aEvent) {</span>
<a href="#l12.45"></a><span id="l12.45">     if (aEvent.target == this.panel)</span>
<a href="#l12.46"></a><span id="l12.46">       this._restoreCommandsState();</span>
<a href="#l12.47"></a><span id="l12.47">   },</span>
<a href="#l12.48"></a><span id="l12.48"> </span>
<a href="#l12.49"></a><span id="l12.49" class="difflineminus">-  onPopupShown: function (aEvent) {</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+  onPopupShown(aEvent) {</span>
<a href="#l12.51"></a><span id="l12.51">     if (aEvent.target == this.panel)</span>
<a href="#l12.52"></a><span id="l12.52">       document.getElementById(&quot;editContactName&quot;).focus();</span>
<a href="#l12.53"></a><span id="l12.53">   },</span>
<a href="#l12.54"></a><span id="l12.54"> </span>
<a href="#l12.55"></a><span id="l12.55" class="difflineminus">-  onKeyPress: function (aEvent, aHandleOnlyReadOnly) {</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+  onKeyPress(aEvent, aHandleOnlyReadOnly) {</span>
<a href="#l12.57"></a><span id="l12.57">     // Escape should just close this panel</span>
<a href="#l12.58"></a><span id="l12.58">     if (aEvent.keyCode == KeyEvent.DOM_VK_ESCAPE) {</span>
<a href="#l12.59"></a><span id="l12.59">       this.panel.hidePopup();</span>
<a href="#l12.60"></a><span id="l12.60">       return;</span>
<a href="#l12.61"></a><span id="l12.61">     }</span>
<a href="#l12.62"></a><span id="l12.62"> </span>
<a href="#l12.63"></a><span id="l12.63">     // Return does the default button (done)</span>
<a href="#l12.64"></a><span id="l12.64">     if (aEvent.keyCode == KeyEvent.DOM_VK_RETURN) {</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineat">@@ -79,23 +79,23 @@ var editContactInlineUI = {</span>
<a href="#l12.66"></a><span id="l12.66">     delete this.panel;</span>
<a href="#l12.67"></a><span id="l12.67">     var element = document.getElementById(&quot;editContactPanel&quot;);</span>
<a href="#l12.68"></a><span id="l12.68">     // initially the panel is hidden to avoid impacting startup / new window</span>
<a href="#l12.69"></a><span id="l12.69">     // performance</span>
<a href="#l12.70"></a><span id="l12.70">     element.hidden = false;</span>
<a href="#l12.71"></a><span id="l12.71">     return this.panel = element;</span>
<a href="#l12.72"></a><span id="l12.72">   },</span>
<a href="#l12.73"></a><span id="l12.73"> </span>
<a href="#l12.74"></a><span id="l12.74" class="difflineminus">-  showEditContactPanel: function showEditContactPanel(aCardDetails, aAnchorElement) {</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineplus">+  showEditContactPanel(aCardDetails, aAnchorElement) {</span>
<a href="#l12.76"></a><span id="l12.76">     this._cardDetails = aCardDetails;</span>
<a href="#l12.77"></a><span id="l12.77">     let position = &quot;after_start&quot;;</span>
<a href="#l12.78"></a><span id="l12.78">     this._doShowEditContactPanel(aAnchorElement, position);</span>
<a href="#l12.79"></a><span id="l12.79">   },</span>
<a href="#l12.80"></a><span id="l12.80"> </span>
<a href="#l12.81"></a><span id="l12.81" class="difflineminus">-  _doShowEditContactPanel: function (aAnchorElement, aPosition) {</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+  _doShowEditContactPanel(aAnchorElement, aPosition) {</span>
<a href="#l12.83"></a><span id="l12.83">     this._blockCommands(); // un-done in the popuphiding handler.</span>
<a href="#l12.84"></a><span id="l12.84">     var bundle = document.getElementById(&quot;bundle_editContact&quot;);</span>
<a href="#l12.85"></a><span id="l12.85"> </span>
<a href="#l12.86"></a><span id="l12.86">     // Is this address book writeable?</span>
<a href="#l12.87"></a><span id="l12.87">     this._writeable = !this._cardDetails.book.readOnly;</span>
<a href="#l12.88"></a><span id="l12.88">     var type = this._writeable ? &quot;edit&quot; : &quot;view&quot;;</span>
<a href="#l12.89"></a><span id="l12.89"> </span>
<a href="#l12.90"></a><span id="l12.90">     // Update the labels accordingly.</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineat">@@ -115,18 +115,17 @@ var editContactInlineUI = {</span>
<a href="#l12.92"></a><span id="l12.92">       !this._writeable;</span>
<a href="#l12.93"></a><span id="l12.93"> </span>
<a href="#l12.94"></a><span id="l12.94">     var nameElement = document.getElementById(&quot;editContactName&quot;);</span>
<a href="#l12.95"></a><span id="l12.95"> </span>
<a href="#l12.96"></a><span id="l12.96">     // Set these to read only if we can't write to the directory.</span>
<a href="#l12.97"></a><span id="l12.97">     if (this._writeable) {</span>
<a href="#l12.98"></a><span id="l12.98">       nameElement.removeAttribute(&quot;readonly&quot;);</span>
<a href="#l12.99"></a><span id="l12.99">       nameElement.class = &quot;editContactTextbox&quot;;</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineminus">-    }</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineminus">-    else {</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineplus">+    } else {</span>
<a href="#l12.103"></a><span id="l12.103">       nameElement.readOnly = true;</span>
<a href="#l12.104"></a><span id="l12.104">       nameElement.class = &quot;plain&quot;;</span>
<a href="#l12.105"></a><span id="l12.105">     }</span>
<a href="#l12.106"></a><span id="l12.106"> </span>
<a href="#l12.107"></a><span id="l12.107">     // Fill in the card details</span>
<a href="#l12.108"></a><span id="l12.108">     nameElement.value = this._cardDetails.card.displayName;</span>
<a href="#l12.109"></a><span id="l12.109">     document.getElementById(&quot;editContactEmail&quot;).value =</span>
<a href="#l12.110"></a><span id="l12.110">       aAnchorElement.getAttribute(&quot;emailAddress&quot;);</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineat">@@ -160,28 +159,28 @@ var editContactInlineUI = {</span>
<a href="#l12.112"></a><span id="l12.112">       document.getElementById(&quot;editContactAddressBookList&quot;).disabled = true;</span>
<a href="#l12.113"></a><span id="l12.113"> </span>
<a href="#l12.114"></a><span id="l12.114">     if (inMailList)</span>
<a href="#l12.115"></a><span id="l12.115">       document.getElementById(&quot;contactMoveDisabledText&quot;).collapsed = false;</span>
<a href="#l12.116"></a><span id="l12.116"> </span>
<a href="#l12.117"></a><span id="l12.117">     this.panel.openPopup(aAnchorElement, aPosition, -1, -1);</span>
<a href="#l12.118"></a><span id="l12.118">   },</span>
<a href="#l12.119"></a><span id="l12.119"> </span>
<a href="#l12.120"></a><span id="l12.120" class="difflineminus">-  editDetails: function() {</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineplus">+  editDetails() {</span>
<a href="#l12.122"></a><span id="l12.122">     this.saveChanges();</span>
<a href="#l12.123"></a><span id="l12.123"> </span>
<a href="#l12.124"></a><span id="l12.124">     window.openDialog(&quot;chrome://messenger/content/addressbook/abEditCardDialog.xul&quot;,</span>
<a href="#l12.125"></a><span id="l12.125">                       &quot;&quot;,</span>
<a href="#l12.126"></a><span id="l12.126">                       &quot;chrome,modal,resizable=no,centerscreen&quot;,</span>
<a href="#l12.127"></a><span id="l12.127">                       { abURI: this._cardDetails.book.URI,</span>
<a href="#l12.128"></a><span id="l12.128">                         card: this._cardDetails.card });</span>
<a href="#l12.129"></a><span id="l12.129"> </span>
<a href="#l12.130"></a><span id="l12.130">   },</span>
<a href="#l12.131"></a><span id="l12.131"> </span>
<a href="#l12.132"></a><span id="l12.132" class="difflineminus">-  deleteContact: function() {</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineplus">+  deleteContact() {</span>
<a href="#l12.134"></a><span id="l12.134">     if (this._cardDetails.book.readOnly)</span>
<a href="#l12.135"></a><span id="l12.135">       return; /* double check we can delete this */</span>
<a href="#l12.136"></a><span id="l12.136"> </span>
<a href="#l12.137"></a><span id="l12.137">     /* hide before the dialog or the panel takes the first click */</span>
<a href="#l12.138"></a><span id="l12.138">     this.panel.hidePopup();</span>
<a href="#l12.139"></a><span id="l12.139"> </span>
<a href="#l12.140"></a><span id="l12.140">     var bundle = document.getElementById(&quot;bundle_editContact&quot;);</span>
<a href="#l12.141"></a><span id="l12.141">     if (!Services.prompt.confirm(window,</span>
<a href="#l12.142"></a><span id="l12.142" class="difflineat">@@ -191,17 +190,17 @@ var editContactInlineUI = {</span>
<a href="#l12.143"></a><span id="l12.143"> </span>
<a href="#l12.144"></a><span id="l12.144">     let cardArray = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l12.145"></a><span id="l12.145">                       .createInstance(Ci.nsIMutableArray);</span>
<a href="#l12.146"></a><span id="l12.146">     cardArray.appendElement(this._cardDetails.card);</span>
<a href="#l12.147"></a><span id="l12.147"> </span>
<a href="#l12.148"></a><span id="l12.148">     MailServices.ab.getDirectory(this._cardDetails.book.URI).deleteCards(cardArray);</span>
<a href="#l12.149"></a><span id="l12.149">   },</span>
<a href="#l12.150"></a><span id="l12.150"> </span>
<a href="#l12.151"></a><span id="l12.151" class="difflineminus">-  saveChanges: function() {</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineplus">+  saveChanges() {</span>
<a href="#l12.153"></a><span id="l12.153">     // If we're a popup dialog, just hide the popup and return</span>
<a href="#l12.154"></a><span id="l12.154">     if (!this._writeable) {</span>
<a href="#l12.155"></a><span id="l12.155">       this.panel.hidePopup();</span>
<a href="#l12.156"></a><span id="l12.156">       return;</span>
<a href="#l12.157"></a><span id="l12.157">     }</span>
<a href="#l12.158"></a><span id="l12.158"> </span>
<a href="#l12.159"></a><span id="l12.159">     let originalBook = this._cardDetails.book;</span>
<a href="#l12.160"></a><span id="l12.160"> </span>
<a href="#l12.161"></a><span id="l12.161" class="difflineat">@@ -216,25 +215,24 @@ var editContactInlineUI = {</span>
<a href="#l12.162"></a><span id="l12.162">       this._cardDetails.card.displayName = newName;</span>
<a href="#l12.163"></a><span id="l12.163">       this._cardDetails.card.setProperty(&quot;PreferDisplayName&quot;, true);</span>
<a href="#l12.164"></a><span id="l12.164">     }</span>
<a href="#l12.165"></a><span id="l12.165"> </span>
<a href="#l12.166"></a><span id="l12.166">     // Save the card</span>
<a href="#l12.167"></a><span id="l12.167">     if (this._cardDetails.book.hasCard(this._cardDetails.card)) {</span>
<a href="#l12.168"></a><span id="l12.168">       // Address book wasn't changed.</span>
<a href="#l12.169"></a><span id="l12.169">       this._cardDetails.book.modifyCard(this._cardDetails.card);</span>
<a href="#l12.170"></a><span id="l12.170" class="difflineminus">-    }</span>
<a href="#l12.171"></a><span id="l12.171" class="difflineminus">-    else {</span>
<a href="#l12.172"></a><span id="l12.172" class="difflineplus">+    } else {</span>
<a href="#l12.173"></a><span id="l12.173">       // We changed address books for the card.</span>
<a href="#l12.174"></a><span id="l12.174"> </span>
<a href="#l12.175"></a><span id="l12.175">       // Add it to the chosen address book...</span>
<a href="#l12.176"></a><span id="l12.176">       this._cardDetails.book.addCard(this._cardDetails.card);</span>
<a href="#l12.177"></a><span id="l12.177"> </span>
<a href="#l12.178"></a><span id="l12.178">       // ...and delete it from the old place.</span>
<a href="#l12.179"></a><span id="l12.179">       let cardArray = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l12.180"></a><span id="l12.180">                               .createInstance(Ci.nsIMutableArray);</span>
<a href="#l12.181"></a><span id="l12.181">       cardArray.appendElement(this._cardDetails.card);</span>
<a href="#l12.182"></a><span id="l12.182">       originalBook.deleteCards(cardArray);</span>
<a href="#l12.183"></a><span id="l12.183">     }</span>
<a href="#l12.184"></a><span id="l12.184"> </span>
<a href="#l12.185"></a><span id="l12.185">     this.panel.hidePopup();</span>
<a href="#l12.186"></a><span id="l12.186" class="difflineminus">-  }</span>
<a href="#l12.187"></a><span id="l12.187" class="difflineminus">-}</span>
<a href="#l12.188"></a><span id="l12.188" class="difflineplus">+  },</span>
<a href="#l12.189"></a><span id="l12.189" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/base/content/folderDisplay.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/base/content/folderDisplay.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -37,40 +37,39 @@ var FolderDisplayListenerManager = {</span>
<a href="#l13.4"></a><span id="l13.4">    *   made active.</span>
<a href="#l13.5"></a><span id="l13.5">    *</span>
<a href="#l13.6"></a><span id="l13.6">    * - onActiveMessagesLoaded.  onMessagesLoaded deferred to when the</span>
<a href="#l13.7"></a><span id="l13.7">    *   tab is actually made active.  Use this if the actions you need to take</span>
<a href="#l13.8"></a><span id="l13.8">    *   are based on the folder display actually being visible, such as updating</span>
<a href="#l13.9"></a><span id="l13.9">    *   some UI widget, etc. Not all messages may have been loaded, but some.</span>
<a href="#l13.10"></a><span id="l13.10">    *</span>
<a href="#l13.11"></a><span id="l13.11">    */</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-  registerListener: function FDLM_registerListener(aListener) {</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+  registerListener(aListener) {</span>
<a href="#l13.14"></a><span id="l13.14">     this._listeners.push(aListener);</span>
<a href="#l13.15"></a><span id="l13.15">   },</span>
<a href="#l13.16"></a><span id="l13.16"> </span>
<a href="#l13.17"></a><span id="l13.17">   /**</span>
<a href="#l13.18"></a><span id="l13.18">    * Unregister a previously registered event listener.</span>
<a href="#l13.19"></a><span id="l13.19">    */</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineminus">-  unregisterListener: function FDLM_unregisterListener(aListener) {</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+  unregisterListener(aListener) {</span>
<a href="#l13.22"></a><span id="l13.22">     let idx = this._listeners.indexOf(aListener);</span>
<a href="#l13.23"></a><span id="l13.23">     if (idx &gt;= 0) {</span>
<a href="#l13.24"></a><span id="l13.24">       this._listeners.splice(idx, 1);</span>
<a href="#l13.25"></a><span id="l13.25">     }</span>
<a href="#l13.26"></a><span id="l13.26">   },</span>
<a href="#l13.27"></a><span id="l13.27"> </span>
<a href="#l13.28"></a><span id="l13.28">   /**</span>
<a href="#l13.29"></a><span id="l13.29">    * For use by FolderDisplayWidget to trigger listener invocation.</span>
<a href="#l13.30"></a><span id="l13.30">    */</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-  _fireListeners: function FDBLM__fireListeners(aEventName, aArgs) {</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+  _fireListeners(aEventName, aArgs) {</span>
<a href="#l13.33"></a><span id="l13.33">     for (let listener of this._listeners) {</span>
<a href="#l13.34"></a><span id="l13.34">       if (aEventName in listener) {</span>
<a href="#l13.35"></a><span id="l13.35">         try {</span>
<a href="#l13.36"></a><span id="l13.36">           listener[aEventName].apply(listener, aArgs);</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineminus">-        }</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineminus">-        catch(e) {</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+        } catch (e) {</span>
<a href="#l13.40"></a><span id="l13.40">           Cu.reportError(aEventName + &quot; event listener FAILED; &quot; +</span>
<a href="#l13.41"></a><span id="l13.41">                          e + &quot; at: &quot; + e.stack);</span>
<a href="#l13.42"></a><span id="l13.42">         }</span>
<a href="#l13.43"></a><span id="l13.43">       }</span>
<a href="#l13.44"></a><span id="l13.44">     }</span>
<a href="#l13.45"></a><span id="l13.45">   },</span>
<a href="#l13.46"></a><span id="l13.46"> };</span>
<a href="#l13.47"></a><span id="l13.47"> </span>
<a href="#l13.48"></a><span id="l13.48" class="difflineat">@@ -90,18 +89,18 @@ var FolderDisplayListenerManager = {</span>
<a href="#l13.49"></a><span id="l13.49">  *  class does alter its behavior slightly for the benefit of the standalone</span>
<a href="#l13.50"></a><span id="l13.50">  *  message window.  If no tab info is provided, we avoid touching tabmail</span>
<a href="#l13.51"></a><span id="l13.51">  *  (which is good, because it won't exist!)  And now we guard against treeBox</span>
<a href="#l13.52"></a><span id="l13.52">  *  manipulations...</span>
<a href="#l13.53"></a><span id="l13.53">  */</span>
<a href="#l13.54"></a><span id="l13.54"> function FolderDisplayWidget(aTabInfo, aMessageDisplayWidget) {</span>
<a href="#l13.55"></a><span id="l13.55">   this._tabInfo = aTabInfo;</span>
<a href="#l13.56"></a><span id="l13.56"> </span>
<a href="#l13.57"></a><span id="l13.57" class="difflineminus">-  /// If the folder does not get handled by the DBViewWrapper, stash it here.</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineminus">-  ///  ex: when isServer is true.</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+  // If the folder does not get handled by the DBViewWrapper, stash it here.</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+  //  ex: when isServer is true.</span>
<a href="#l13.61"></a><span id="l13.61">   this._nonViewFolder = null;</span>
<a href="#l13.62"></a><span id="l13.62"> </span>
<a href="#l13.63"></a><span id="l13.63">   this.view = new DBViewWrapper(this);</span>
<a href="#l13.64"></a><span id="l13.64">   this.messageDisplay = aMessageDisplayWidget;</span>
<a href="#l13.65"></a><span id="l13.65">   this.messageDisplay.folderDisplay = this;</span>
<a href="#l13.66"></a><span id="l13.66"> </span>
<a href="#l13.67"></a><span id="l13.67">   /**</span>
<a href="#l13.68"></a><span id="l13.68">    * The XUL tree node, as retrieved by getDocumentElementById.  The caller is</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineat">@@ -164,17 +163,17 @@ function FolderDisplayWidget(aTabInfo, a</span>
<a href="#l13.70"></a><span id="l13.70">   this._notificationsPendingActivation = [];</span>
<a href="#l13.71"></a><span id="l13.71"> </span>
<a href="#l13.72"></a><span id="l13.72">   // Create a DOM node for the fake tree box below.</span>
<a href="#l13.73"></a><span id="l13.73">   let domNode = document.createElementNS(</span>
<a href="#l13.74"></a><span id="l13.74">       &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;, &quot;vbox&quot;);</span>
<a href="#l13.75"></a><span id="l13.75"> </span>
<a href="#l13.76"></a><span id="l13.76">   // We care about onselect events, so add a listener for that.</span>
<a href="#l13.77"></a><span id="l13.77">   let self = this;</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineminus">-  domNode.addEventListener(&quot;select&quot;, function () {</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineplus">+  domNode.addEventListener(&quot;select&quot;, function() {</span>
<a href="#l13.80"></a><span id="l13.80">     self.view.dbView.selectionChanged();</span>
<a href="#l13.81"></a><span id="l13.81">   });</span>
<a href="#l13.82"></a><span id="l13.82"> </span>
<a href="#l13.83"></a><span id="l13.83">   /**</span>
<a href="#l13.84"></a><span id="l13.84">    * Create a fake tree box object for if/when this folder is in the background.</span>
<a href="#l13.85"></a><span id="l13.85">    * We need to give it a DOM object to send events to, including the onselect</span>
<a href="#l13.86"></a><span id="l13.86">    * event we care about and for which we added a handler above, and all the</span>
<a href="#l13.87"></a><span id="l13.87">    * other events we don't care about.</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineat">@@ -221,18 +220,17 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.89"></a><span id="l13.89">    */</span>
<a href="#l13.90"></a><span id="l13.90">   get treeSelection() {</span>
<a href="#l13.91"></a><span id="l13.91">     // If we haven't switched to this tab yet, dbView will exist but</span>
<a href="#l13.92"></a><span id="l13.92">     // dbView.selection won't, so use the fake tree selection instead.</span>
<a href="#l13.93"></a><span id="l13.93">     if (this._fakeTreeSelection)</span>
<a href="#l13.94"></a><span id="l13.94">       return this._fakeTreeSelection;</span>
<a href="#l13.95"></a><span id="l13.95">     if (this.view.dbView)</span>
<a href="#l13.96"></a><span id="l13.96">       return this.view.dbView.selection;</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineminus">-    else</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineminus">-      return null;</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineplus">+    return null;</span>
<a href="#l13.100"></a><span id="l13.100">   },</span>
<a href="#l13.101"></a><span id="l13.101"> </span>
<a href="#l13.102"></a><span id="l13.102">   /**</span>
<a href="#l13.103"></a><span id="l13.103">    * Determine which pane currently has focus (one of the folder pane, thread</span>
<a href="#l13.104"></a><span id="l13.104">    * pane, or message pane). The message pane node is the common ancestor of</span>
<a href="#l13.105"></a><span id="l13.105">    * the single- and multi-message content windows. When changing focus to the</span>
<a href="#l13.106"></a><span id="l13.106">    * message pane, be sure to focus the appropriate content window in addition</span>
<a href="#l13.107"></a><span id="l13.107">    * to the messagepanebox (doing both is required in order to blur the</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineat">@@ -267,17 +265,17 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.109"></a><span id="l13.109">    * @private</span>
<a href="#l13.110"></a><span id="l13.110">    */</span>
<a href="#l13.111"></a><span id="l13.111">   PERF_HEADER_CACHE_SIZE: 100,</span>
<a href="#l13.112"></a><span id="l13.112"> </span>
<a href="#l13.113"></a><span id="l13.113">   /**</span>
<a href="#l13.114"></a><span id="l13.114">    * @name Selection Persistence</span>
<a href="#l13.115"></a><span id="l13.115">    * @private</span>
<a href="#l13.116"></a><span id="l13.116">    */</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineminus">-  //@{</span>
<a href="#l13.118"></a><span id="l13.118" class="difflineplus">+  // @{</span>
<a href="#l13.119"></a><span id="l13.119"> </span>
<a href="#l13.120"></a><span id="l13.120">   /**</span>
<a href="#l13.121"></a><span id="l13.121">    * An optional object, with the following properties:</span>
<a href="#l13.122"></a><span id="l13.122">    * - messages: This is a list where each item is an object with the following</span>
<a href="#l13.123"></a><span id="l13.123">    *       attributes sufficient to re-establish the selected items even in the</span>
<a href="#l13.124"></a><span id="l13.124">    *       face of folder renaming.</span>
<a href="#l13.125"></a><span id="l13.125">    *   - messageId: The value of the message's message-id header.</span>
<a href="#l13.126"></a><span id="l13.126">    *</span>
<a href="#l13.127"></a><span id="l13.127" class="difflineat">@@ -303,81 +301,80 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.128"></a><span id="l13.128">   /**</span>
<a href="#l13.129"></a><span id="l13.129">    * Save the current view selection for when we the view is getting destroyed</span>
<a href="#l13.130"></a><span id="l13.130">    *  or otherwise re-ordered in such a way that the nsITreeSelection will lose</span>
<a href="#l13.131"></a><span id="l13.131">    *  track of things (because it just has a naive view-index 'view' of the</span>
<a href="#l13.132"></a><span id="l13.132">    *  world.)  We just save each message's message-id header.  This is overkill</span>
<a href="#l13.133"></a><span id="l13.133">    *  and ambiguous in the face of duplicate messages (and expensive to</span>
<a href="#l13.134"></a><span id="l13.134">    *  restore), but is also the most reliable option for this use case.</span>
<a href="#l13.135"></a><span id="l13.135">    */</span>
<a href="#l13.136"></a><span id="l13.136" class="difflineminus">-  _saveSelection: function FolderDisplayWidget_saveSelection() {</span>
<a href="#l13.137"></a><span id="l13.137" class="difflineplus">+  _saveSelection() {</span>
<a href="#l13.138"></a><span id="l13.138">     this._savedSelection = {</span>
<a href="#l13.139"></a><span id="l13.139">       messages: this.selectedMessages.map(msgHdr =&gt; ({messageId: msgHdr.messageId})),</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineminus">-      forceSelect: false</span>
<a href="#l13.141"></a><span id="l13.141" class="difflineplus">+      forceSelect: false,</span>
<a href="#l13.142"></a><span id="l13.142">     };</span>
<a href="#l13.143"></a><span id="l13.143">   },</span>
<a href="#l13.144"></a><span id="l13.144"> </span>
<a href="#l13.145"></a><span id="l13.145">   /**</span>
<a href="#l13.146"></a><span id="l13.146">    * Clear the saved selection.</span>
<a href="#l13.147"></a><span id="l13.147">    */</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineminus">-  _clearSavedSelection: function FolderDisplayWidget_clearSavedSelection() {</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineplus">+  _clearSavedSelection() {</span>
<a href="#l13.150"></a><span id="l13.150">     this._savedSelection = null;</span>
<a href="#l13.151"></a><span id="l13.151">   },</span>
<a href="#l13.152"></a><span id="l13.152"> </span>
<a href="#l13.153"></a><span id="l13.153">   /**</span>
<a href="#l13.154"></a><span id="l13.154">    * Restore the view selection if we have a saved selection.  We must be</span>
<a href="#l13.155"></a><span id="l13.155">    *  active!</span>
<a href="#l13.156"></a><span id="l13.156">    *</span>
<a href="#l13.157"></a><span id="l13.157">    * @return true if we were able to restore the selection and there was</span>
<a href="#l13.158"></a><span id="l13.158">    *     a selection, false if there was no selection (anymore).</span>
<a href="#l13.159"></a><span id="l13.159">    */</span>
<a href="#l13.160"></a><span id="l13.160" class="difflineminus">-  _restoreSelection: function FolderDisplayWidget_restoreSelection() {</span>
<a href="#l13.161"></a><span id="l13.161" class="difflineplus">+  _restoreSelection() {</span>
<a href="#l13.162"></a><span id="l13.162">     if (!this._savedSelection || !this._active)</span>
<a href="#l13.163"></a><span id="l13.163">       return false;</span>
<a href="#l13.164"></a><span id="l13.164"> </span>
<a href="#l13.165"></a><span id="l13.165">     // translate message IDs back to messages.  this is O(s(m+n)) where:</span>
<a href="#l13.166"></a><span id="l13.166">     // - s is the number of messages saved in the selection</span>
<a href="#l13.167"></a><span id="l13.167">     // - m is the number of messages in the view (from findIndexOfMsgHdr)</span>
<a href="#l13.168"></a><span id="l13.168">     // - n is the number of messages in the underlying folders (from</span>
<a href="#l13.169"></a><span id="l13.169">     //   DBViewWrapper.getMsgHdrForMessageID).</span>
<a href="#l13.170"></a><span id="l13.170">     // which ends up being O(sn)</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineminus">-    var msgHdr;</span>
<a href="#l13.172"></a><span id="l13.172">     let messages =</span>
<a href="#l13.173"></a><span id="l13.173">       this._savedSelection.messages.</span>
<a href="#l13.174"></a><span id="l13.174">       map(savedInfo =&gt; this.view.getMsgHdrForMessageID(savedInfo.messageId)).</span>
<a href="#l13.175"></a><span id="l13.175">       filter(msgHdr =&gt; !!msgHdr);</span>
<a href="#l13.176"></a><span id="l13.176"> </span>
<a href="#l13.177"></a><span id="l13.177">     this.selectMessages(messages, this._savedSelection.forceSelect, true);</span>
<a href="#l13.178"></a><span id="l13.178">     this._savedSelection = null;</span>
<a href="#l13.179"></a><span id="l13.179"> </span>
<a href="#l13.180"></a><span id="l13.180">     return this.selectedCount != 0;</span>
<a href="#l13.181"></a><span id="l13.181">   },</span>
<a href="#l13.182"></a><span id="l13.182"> </span>
<a href="#l13.183"></a><span id="l13.183">   /**</span>
<a href="#l13.184"></a><span id="l13.184">    * Restore the last expandAll/collapseAll state, for both grouped and threaded</span>
<a href="#l13.185"></a><span id="l13.185">    * views. Not all views respect viewFlags, ie single folder non-virtual.</span>
<a href="#l13.186"></a><span id="l13.186">    */</span>
<a href="#l13.187"></a><span id="l13.187" class="difflineminus">-  restoreThreadState: function() {</span>
<a href="#l13.188"></a><span id="l13.188" class="difflineplus">+  restoreThreadState() {</span>
<a href="#l13.189"></a><span id="l13.189">     if (!this._active || !this.tree || !this.view.dbView.viewFolder)</span>
<a href="#l13.190"></a><span id="l13.190">       return;</span>
<a href="#l13.191"></a><span id="l13.191"> </span>
<a href="#l13.192"></a><span id="l13.192">     if (this.view._threadExpandAll &amp;&amp;</span>
<a href="#l13.193"></a><span id="l13.193">         !(this.view.dbView.viewFlags &amp; nsMsgViewFlagsType.kExpandAll))</span>
<a href="#l13.194"></a><span id="l13.194">       this.view.dbView.doCommand(Ci.nsMsgViewCommandType.expandAll);</span>
<a href="#l13.195"></a><span id="l13.195">     if (!this.view._threadExpandAll &amp;&amp;</span>
<a href="#l13.196"></a><span id="l13.196">         this.view.dbView.viewFlags &amp; nsMsgViewFlagsType.kExpandAll)</span>
<a href="#l13.197"></a><span id="l13.197">       this.view.dbView.doCommand(Ci.nsMsgViewCommandType.collapseAll);</span>
<a href="#l13.198"></a><span id="l13.198">   },</span>
<a href="#l13.199"></a><span id="l13.199" class="difflineminus">-  //@}</span>
<a href="#l13.200"></a><span id="l13.200" class="difflineplus">+  // @}</span>
<a href="#l13.201"></a><span id="l13.201"> </span>
<a href="#l13.202"></a><span id="l13.202">   /**</span>
<a href="#l13.203"></a><span id="l13.203">    * @name Columns</span>
<a href="#l13.204"></a><span id="l13.204">    * @protected Folder Display</span>
<a href="#l13.205"></a><span id="l13.205">    */</span>
<a href="#l13.206"></a><span id="l13.206" class="difflineminus">-  //@{</span>
<a href="#l13.207"></a><span id="l13.207" class="difflineplus">+  // @{</span>
<a href="#l13.208"></a><span id="l13.208"> </span>
<a href="#l13.209"></a><span id="l13.209">   /**</span>
<a href="#l13.210"></a><span id="l13.210">    * The map of all stock sortable columns and their sortType. The key must</span>
<a href="#l13.211"></a><span id="l13.211">    * match the column's xul &lt;treecol&gt; id.</span>
<a href="#l13.212"></a><span id="l13.212">    */</span>
<a href="#l13.213"></a><span id="l13.213">   COLUMNS_MAP: new Map([</span>
<a href="#l13.214"></a><span id="l13.214">     [&quot;accountCol&quot;,       &quot;byAccount&quot;],</span>
<a href="#l13.215"></a><span id="l13.215">     [&quot;attachmentCol&quot;,    &quot;byAttachments&quot;],</span>
<a href="#l13.216"></a><span id="l13.216" class="difflineat">@@ -391,25 +388,25 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.217"></a><span id="l13.217">     [&quot;priorityCol&quot;,      &quot;byPriority&quot;],</span>
<a href="#l13.218"></a><span id="l13.218">     [&quot;receivedCol&quot;,      &quot;byReceived&quot;],</span>
<a href="#l13.219"></a><span id="l13.219">     [&quot;recipientCol&quot;,     &quot;byRecipient&quot;],</span>
<a href="#l13.220"></a><span id="l13.220">     [&quot;sizeCol&quot;,          &quot;bySize&quot;],</span>
<a href="#l13.221"></a><span id="l13.221">     [&quot;statusCol&quot;,        &quot;byStatus&quot;],</span>
<a href="#l13.222"></a><span id="l13.222">     [&quot;subjectCol&quot;,       &quot;bySubject&quot;],</span>
<a href="#l13.223"></a><span id="l13.223">     [&quot;tagsCol&quot;,          &quot;byTags&quot;],</span>
<a href="#l13.224"></a><span id="l13.224">     [&quot;threadCol&quot;,        &quot;byThread&quot;],</span>
<a href="#l13.225"></a><span id="l13.225" class="difflineminus">-    [&quot;unreadButtonColHeader&quot;, &quot;byUnread&quot;]</span>
<a href="#l13.226"></a><span id="l13.226" class="difflineplus">+    [&quot;unreadButtonColHeader&quot;, &quot;byUnread&quot;],</span>
<a href="#l13.227"></a><span id="l13.227">   ]),</span>
<a href="#l13.228"></a><span id="l13.228"> </span>
<a href="#l13.229"></a><span id="l13.229">   /**</span>
<a href="#l13.230"></a><span id="l13.230">    * The map of stock non-sortable columns. The key must match the column's</span>
<a href="#l13.231"></a><span id="l13.231">    *  xul &lt;treecol&gt; id.</span>
<a href="#l13.232"></a><span id="l13.232">    */</span>
<a href="#l13.233"></a><span id="l13.233">   COLUMNS_MAP_NOSORT: new Set([</span>
<a href="#l13.234"></a><span id="l13.234" class="difflineminus">-    &quot;totalCol&quot;, &quot;unreadCol&quot;</span>
<a href="#l13.235"></a><span id="l13.235" class="difflineplus">+    &quot;totalCol&quot;, &quot;unreadCol&quot;,</span>
<a href="#l13.236"></a><span id="l13.236">   ]),</span>
<a href="#l13.237"></a><span id="l13.237"> </span>
<a href="#l13.238"></a><span id="l13.238">   /**</span>
<a href="#l13.239"></a><span id="l13.239">    * The set of potential default columns in their default display order.  Each</span>
<a href="#l13.240"></a><span id="l13.240">    *  column in this list is checked against |COLUMN_DEFAULT_TESTERS| to see if</span>
<a href="#l13.241"></a><span id="l13.241">    *  it is actually an appropriate default for the folder type.</span>
<a href="#l13.242"></a><span id="l13.242">    */</span>
<a href="#l13.243"></a><span id="l13.243">   DEFAULT_COLUMNS: [</span>
<a href="#l13.244"></a><span id="l13.244" class="difflineat">@@ -433,45 +430,45 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.245"></a><span id="l13.245">    *  properties like isMailFolder/isIncomingFolder/isOutgoingFolder allow the</span>
<a href="#l13.246"></a><span id="l13.246">    *  constraint to be expressed concisely.  If a helper does not exist, add</span>
<a href="#l13.247"></a><span id="l13.247">    *  one! (If doing so is out of reach, than access viewWrapper.displayedFolder</span>
<a href="#l13.248"></a><span id="l13.248">    *  to get at the nsIMsgFolder.)</span>
<a href="#l13.249"></a><span id="l13.249">    * If a column does not have a function, it is assumed that it should be</span>
<a href="#l13.250"></a><span id="l13.250">    *  displayed by default.</span>
<a href="#l13.251"></a><span id="l13.251">    */</span>
<a href="#l13.252"></a><span id="l13.252">   COLUMN_DEFAULT_TESTERS: {</span>
<a href="#l13.253"></a><span id="l13.253" class="difflineminus">-    correspondentCol: function (viewWrapper) {</span>
<a href="#l13.254"></a><span id="l13.254" class="difflineplus">+    correspondentCol(viewWrapper) {</span>
<a href="#l13.255"></a><span id="l13.255">       if (Services.prefs.getBoolPref(&quot;mail.threadpane.use_correspondents&quot;)) {</span>
<a href="#l13.256"></a><span id="l13.256">         // Don't show the correspondent for news or RSS where it doesn't make sense.</span>
<a href="#l13.257"></a><span id="l13.257">         return viewWrapper.isMailFolder &amp;&amp; !viewWrapper.isFeedFolder;</span>
<a href="#l13.258"></a><span id="l13.258">       }</span>
<a href="#l13.259"></a><span id="l13.259">       return false;</span>
<a href="#l13.260"></a><span id="l13.260">     },</span>
<a href="#l13.261"></a><span id="l13.261" class="difflineminus">-    senderCol: function (viewWrapper) {</span>
<a href="#l13.262"></a><span id="l13.262" class="difflineplus">+    senderCol(viewWrapper) {</span>
<a href="#l13.263"></a><span id="l13.263">       if (Services.prefs.getBoolPref(&quot;mail.threadpane.use_correspondents&quot;)) {</span>
<a href="#l13.264"></a><span id="l13.264">         // Show the sender even if correspondent is enabled for news and feeds.</span>
<a href="#l13.265"></a><span id="l13.265">         return viewWrapper.isNewsFolder || viewWrapper.isFeedFolder;</span>
<a href="#l13.266"></a><span id="l13.266">       }</span>
<a href="#l13.267"></a><span id="l13.267">       // senderCol = From. You only care in incoming folders.</span>
<a href="#l13.268"></a><span id="l13.268">       return viewWrapper.isIncomingFolder;</span>
<a href="#l13.269"></a><span id="l13.269">     },</span>
<a href="#l13.270"></a><span id="l13.270" class="difflineminus">-    recipientCol: function (viewWrapper) {</span>
<a href="#l13.271"></a><span id="l13.271" class="difflineplus">+    recipientCol(viewWrapper) {</span>
<a href="#l13.272"></a><span id="l13.272">       if (Services.prefs.getBoolPref(&quot;mail.threadpane.use_correspondents&quot;)) {</span>
<a href="#l13.273"></a><span id="l13.273">         // No recipient column if we use correspondent.</span>
<a href="#l13.274"></a><span id="l13.274">         return false;</span>
<a href="#l13.275"></a><span id="l13.275">       }</span>
<a href="#l13.276"></a><span id="l13.276">       // recipientCol = To. You only care in outgoing folders.</span>
<a href="#l13.277"></a><span id="l13.277">       return viewWrapper.isOutgoingFolder;</span>
<a href="#l13.278"></a><span id="l13.278">     },</span>
<a href="#l13.279"></a><span id="l13.279">     // Only show the location column for non-single-folder results</span>
<a href="#l13.280"></a><span id="l13.280" class="difflineminus">-    locationCol: function(viewWrapper) {</span>
<a href="#l13.281"></a><span id="l13.281" class="difflineplus">+    locationCol(viewWrapper) {</span>
<a href="#l13.282"></a><span id="l13.282">       return !viewWrapper.isSingleFolder;</span>
<a href="#l13.283"></a><span id="l13.283">     },</span>
<a href="#l13.284"></a><span id="l13.284">     // core UI does not provide an ability to mark newsgroup messages as spam</span>
<a href="#l13.285"></a><span id="l13.285" class="difflineminus">-    junkStatusCol: function(viewWrapper) {</span>
<a href="#l13.286"></a><span id="l13.286" class="difflineplus">+    junkStatusCol(viewWrapper) {</span>
<a href="#l13.287"></a><span id="l13.287">       return !viewWrapper.isNewsFolder;</span>
<a href="#l13.288"></a><span id="l13.288">     },</span>
<a href="#l13.289"></a><span id="l13.289">   },</span>
<a href="#l13.290"></a><span id="l13.290"> </span>
<a href="#l13.291"></a><span id="l13.291">   /**</span>
<a href="#l13.292"></a><span id="l13.292">    * The property name we use to store the column states on the</span>
<a href="#l13.293"></a><span id="l13.293">    *  dbFolderInfo.</span>
<a href="#l13.294"></a><span id="l13.294">    */</span>
<a href="#l13.295"></a><span id="l13.295" class="difflineat">@@ -479,19 +476,17 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.296"></a><span id="l13.296"> </span>
<a href="#l13.297"></a><span id="l13.297">   /**</span>
<a href="#l13.298"></a><span id="l13.298">    * Given a dbFolderInfo, extract the persisted state from it if there is any.</span>
<a href="#l13.299"></a><span id="l13.299">    *</span>
<a href="#l13.300"></a><span id="l13.300">    * @return null if there was no persisted state, the persisted state in object</span>
<a href="#l13.301"></a><span id="l13.301">    *     form otherwise.  (Ideally the state conforms to the documentation on</span>
<a href="#l13.302"></a><span id="l13.302">    *     |_savedColumnStates| but we can't stop people from doing bad things.)</span>
<a href="#l13.303"></a><span id="l13.303">    */</span>
<a href="#l13.304"></a><span id="l13.304" class="difflineminus">-  _depersistColumnStatesFromDbFolderInfo:</span>
<a href="#l13.305"></a><span id="l13.305" class="difflineminus">-      function FolderDisplayWidget__depersistColumnStatesFromDBFolderInfo(</span>
<a href="#l13.306"></a><span id="l13.306" class="difflineminus">-        aDbFolderInfo) {</span>
<a href="#l13.307"></a><span id="l13.307" class="difflineplus">+  _depersistColumnStatesFromDbFolderInfo(aDbFolderInfo) {</span>
<a href="#l13.308"></a><span id="l13.308">     let columnJsonString =</span>
<a href="#l13.309"></a><span id="l13.309">       aDbFolderInfo.getCharProperty(this.PERSISTED_COLUMN_PROPERTY_NAME);</span>
<a href="#l13.310"></a><span id="l13.310">     if (!columnJsonString)</span>
<a href="#l13.311"></a><span id="l13.311">       return null;</span>
<a href="#l13.312"></a><span id="l13.312"> </span>
<a href="#l13.313"></a><span id="l13.313">     return JSON.parse(columnJsonString);</span>
<a href="#l13.314"></a><span id="l13.314">   },</span>
<a href="#l13.315"></a><span id="l13.315"> </span>
<a href="#l13.316"></a><span id="l13.316" class="difflineat">@@ -503,17 +498,17 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.317"></a><span id="l13.317">    * The caller should only call this when they have reason to suspect that the</span>
<a href="#l13.318"></a><span id="l13.318">    *  column state has been changed.  This could be because there was no</span>
<a href="#l13.319"></a><span id="l13.319">    *  persisted state so we figured out a default one and want to save it.</span>
<a href="#l13.320"></a><span id="l13.320">    *  Otherwise this should be because the user explicitly changed up the column</span>
<a href="#l13.321"></a><span id="l13.321">    *  configurations.  You should not call this willy-nilly.</span>
<a href="#l13.322"></a><span id="l13.322">    *</span>
<a href="#l13.323"></a><span id="l13.323">    * @param aState State to persist.</span>
<a href="#l13.324"></a><span id="l13.324">    */</span>
<a href="#l13.325"></a><span id="l13.325" class="difflineminus">-  _persistColumnStates: function FolderDisplayWidget__persistColumnStates(aState) {</span>
<a href="#l13.326"></a><span id="l13.326" class="difflineplus">+  _persistColumnStates(aState) {</span>
<a href="#l13.327"></a><span id="l13.327">     if (this.view.isSynthetic) {</span>
<a href="#l13.328"></a><span id="l13.328">       let syntheticView = this.view._syntheticView;</span>
<a href="#l13.329"></a><span id="l13.329">       if (&quot;setPersistedSetting&quot; in syntheticView)</span>
<a href="#l13.330"></a><span id="l13.330">         syntheticView.setPersistedSetting(&quot;columns&quot;, aState);</span>
<a href="#l13.331"></a><span id="l13.331">       return;</span>
<a href="#l13.332"></a><span id="l13.332">     }</span>
<a href="#l13.333"></a><span id="l13.333"> </span>
<a href="#l13.334"></a><span id="l13.334">     if (!this.view.displayedFolder || !this.view.displayedFolder.msgDatabase)</span>
<a href="#l13.335"></a><span id="l13.335" class="difflineat">@@ -527,28 +522,28 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.336"></a><span id="l13.336">   },</span>
<a href="#l13.337"></a><span id="l13.337"> </span>
<a href="#l13.338"></a><span id="l13.338">   /**</span>
<a href="#l13.339"></a><span id="l13.339">    * Let us know that the state of the columns has changed.  This is either due</span>
<a href="#l13.340"></a><span id="l13.340">    *  to a re-ordering or hidden-ness being toggled.</span>
<a href="#l13.341"></a><span id="l13.341">    *</span>
<a href="#l13.342"></a><span id="l13.342">    * This method should only be called on (the active) gFolderDisplay.</span>
<a href="#l13.343"></a><span id="l13.343">    */</span>
<a href="#l13.344"></a><span id="l13.344" class="difflineminus">-  hintColumnsChanged: function FolderDisplayWidget_hintColumnsChanged() {</span>
<a href="#l13.345"></a><span id="l13.345" class="difflineplus">+  hintColumnsChanged() {</span>
<a href="#l13.346"></a><span id="l13.346">     // ignore this if we are the ones doing things</span>
<a href="#l13.347"></a><span id="l13.347">     if (this._touchingColumns)</span>
<a href="#l13.348"></a><span id="l13.348">       return;</span>
<a href="#l13.349"></a><span id="l13.349">     this._persistColumnStates(this.getColumnStates());</span>
<a href="#l13.350"></a><span id="l13.350">   },</span>
<a href="#l13.351"></a><span id="l13.351"> </span>
<a href="#l13.352"></a><span id="l13.352">   /**</span>
<a href="#l13.353"></a><span id="l13.353">    * Either inherit the column state of another folder or use heuristics to</span>
<a href="#l13.354"></a><span id="l13.354">    *  figure out the best column state for the current folder.</span>
<a href="#l13.355"></a><span id="l13.355">    */</span>
<a href="#l13.356"></a><span id="l13.356" class="difflineminus">-  _getDefaultColumnsForCurrentFolder: function(aDoNotInherit) {</span>
<a href="#l13.357"></a><span id="l13.357" class="difflineplus">+  _getDefaultColumnsForCurrentFolder(aDoNotInherit) {</span>
<a href="#l13.358"></a><span id="l13.358">     // If the view is synthetic, try asking it for its default columns. If it</span>
<a href="#l13.359"></a><span id="l13.359">     // fails, just return nothing, since most synthetic views don't care about</span>
<a href="#l13.360"></a><span id="l13.360">     // columns anyway.</span>
<a href="#l13.361"></a><span id="l13.361">     if (this.view.isSynthetic) {</span>
<a href="#l13.362"></a><span id="l13.362">       if (&quot;getDefaultSetting&quot; in this.view._syntheticView)</span>
<a href="#l13.363"></a><span id="l13.363">         return this.view._syntheticView.getDefaultSetting(&quot;columns&quot;);</span>
<a href="#l13.364"></a><span id="l13.364">       return {};</span>
<a href="#l13.365"></a><span id="l13.365">     }</span>
<a href="#l13.366"></a><span id="l13.366" class="difflineat">@@ -592,18 +587,17 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.367"></a><span id="l13.367">     let state = {};</span>
<a href="#l13.368"></a><span id="l13.368">     for (let colId of this.DEFAULT_COLUMNS) {</span>
<a href="#l13.369"></a><span id="l13.369">       let shouldShowColumn = true;</span>
<a href="#l13.370"></a><span id="l13.370">       if (colId in this.COLUMN_DEFAULT_TESTERS) {</span>
<a href="#l13.371"></a><span id="l13.371">         // This is potentially going to be used by extensions; avoid them</span>
<a href="#l13.372"></a><span id="l13.372">         //  killing us.</span>
<a href="#l13.373"></a><span id="l13.373">         try {</span>
<a href="#l13.374"></a><span id="l13.374">           shouldShowColumn = this.COLUMN_DEFAULT_TESTERS[colId](this.view);</span>
<a href="#l13.375"></a><span id="l13.375" class="difflineminus">-        }</span>
<a href="#l13.376"></a><span id="l13.376" class="difflineminus">-        catch (ex) {</span>
<a href="#l13.377"></a><span id="l13.377" class="difflineplus">+        } catch (ex) {</span>
<a href="#l13.378"></a><span id="l13.378">           shouldShowColumn = false;</span>
<a href="#l13.379"></a><span id="l13.379">           Cu.reportError(ex);</span>
<a href="#l13.380"></a><span id="l13.380">         }</span>
<a href="#l13.381"></a><span id="l13.381">       }</span>
<a href="#l13.382"></a><span id="l13.382">       state[colId] = {visible: shouldShowColumn};</span>
<a href="#l13.383"></a><span id="l13.383">     }</span>
<a href="#l13.384"></a><span id="l13.384">     return state;</span>
<a href="#l13.385"></a><span id="l13.385">   },</span>
<a href="#l13.386"></a><span id="l13.386" class="difflineat">@@ -621,17 +615,17 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.387"></a><span id="l13.387">    *     |_savedColumnStates|.  If ordinal attributes are omitted then no</span>
<a href="#l13.388"></a><span id="l13.388">    *     re-ordering will be performed.  This is intentional, but potentially a</span>
<a href="#l13.389"></a><span id="l13.389">    *     bad idea.  (Right now only gloda search underspecifies ordinals.)</span>
<a href="#l13.390"></a><span id="l13.390">    * @param [aPersistChanges=false] Should we persist the changes to the view?</span>
<a href="#l13.391"></a><span id="l13.391">    *     This only has an effect if we are active.</span>
<a href="#l13.392"></a><span id="l13.392">    *</span>
<a href="#l13.393"></a><span id="l13.393">    * @public</span>
<a href="#l13.394"></a><span id="l13.394">    */</span>
<a href="#l13.395"></a><span id="l13.395" class="difflineminus">-  setColumnStates: function(aColumnStates, aPersistChanges) {</span>
<a href="#l13.396"></a><span id="l13.396" class="difflineplus">+  setColumnStates(aColumnStates, aPersistChanges) {</span>
<a href="#l13.397"></a><span id="l13.397">     // If we are not active, just overwrite our current state with the provided</span>
<a href="#l13.398"></a><span id="l13.398">     //  state and bail.</span>
<a href="#l13.399"></a><span id="l13.399">     if (!this._active) {</span>
<a href="#l13.400"></a><span id="l13.400">       this._savedColumnStates = aColumnStates;</span>
<a href="#l13.401"></a><span id="l13.401">       return;</span>
<a href="#l13.402"></a><span id="l13.402">     }</span>
<a href="#l13.403"></a><span id="l13.403"> </span>
<a href="#l13.404"></a><span id="l13.404">     this._touchingColumns = true;</span>
<a href="#l13.405"></a><span id="l13.405" class="difflineat">@@ -663,18 +657,17 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.406"></a><span id="l13.406">           if (isHidden != shouldBeHidden) {</span>
<a href="#l13.407"></a><span id="l13.407">             if (shouldBeHidden)</span>
<a href="#l13.408"></a><span id="l13.408">               colChild.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l13.409"></a><span id="l13.409">             else</span>
<a href="#l13.410"></a><span id="l13.410">               colChild.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l13.411"></a><span id="l13.411">           }</span>
<a href="#l13.412"></a><span id="l13.412">         }</span>
<a href="#l13.413"></a><span id="l13.413">       }</span>
<a href="#l13.414"></a><span id="l13.414" class="difflineminus">-    }</span>
<a href="#l13.415"></a><span id="l13.415" class="difflineminus">-    finally {</span>
<a href="#l13.416"></a><span id="l13.416" class="difflineplus">+    } finally {</span>
<a href="#l13.417"></a><span id="l13.417">       this._touchingColumns = false;</span>
<a href="#l13.418"></a><span id="l13.418">     }</span>
<a href="#l13.419"></a><span id="l13.419"> </span>
<a href="#l13.420"></a><span id="l13.420">     if (aPersistChanges)</span>
<a href="#l13.421"></a><span id="l13.421">       this.hintColumnsChanged();</span>
<a href="#l13.422"></a><span id="l13.422">   },</span>
<a href="#l13.423"></a><span id="l13.423"> </span>
<a href="#l13.424"></a><span id="l13.424">   /**</span>
<a href="#l13.425"></a><span id="l13.425" class="difflineat">@@ -688,17 +681,17 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.426"></a><span id="l13.426">   _savedColumnStates: null,</span>
<a href="#l13.427"></a><span id="l13.427"> </span>
<a href="#l13.428"></a><span id="l13.428">   /**</span>
<a href="#l13.429"></a><span id="l13.429">    * Return a dictionary in the form of |_savedColumnStates| representing the</span>
<a href="#l13.430"></a><span id="l13.430">    *  current column states.</span>
<a href="#l13.431"></a><span id="l13.431">    *</span>
<a href="#l13.432"></a><span id="l13.432">    * @public</span>
<a href="#l13.433"></a><span id="l13.433">    */</span>
<a href="#l13.434"></a><span id="l13.434" class="difflineminus">-  getColumnStates: function FolderDisplayWidget_getColumnStates() {</span>
<a href="#l13.435"></a><span id="l13.435" class="difflineplus">+  getColumnStates() {</span>
<a href="#l13.436"></a><span id="l13.436">     if (!this._active)</span>
<a href="#l13.437"></a><span id="l13.437">       return this._savedColumnStates;</span>
<a href="#l13.438"></a><span id="l13.438"> </span>
<a href="#l13.439"></a><span id="l13.439">     let columnStates = {};</span>
<a href="#l13.440"></a><span id="l13.440"> </span>
<a href="#l13.441"></a><span id="l13.441">     let cols = document.getElementById(&quot;threadCols&quot;);</span>
<a href="#l13.442"></a><span id="l13.442">     let colChildren = cols.children;</span>
<a href="#l13.443"></a><span id="l13.443">     for (let iKid = 0; iKid &lt; colChildren.length; iKid++) {</span>
<a href="#l13.444"></a><span id="l13.444" class="difflineat">@@ -713,17 +706,17 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.445"></a><span id="l13.445"> </span>
<a href="#l13.446"></a><span id="l13.446">     return columnStates;</span>
<a href="#l13.447"></a><span id="l13.447">   },</span>
<a href="#l13.448"></a><span id="l13.448"> </span>
<a href="#l13.449"></a><span id="l13.449">   /**</span>
<a href="#l13.450"></a><span id="l13.450">    * For now, just save the visible columns into a dictionary for use in a</span>
<a href="#l13.451"></a><span id="l13.451">    *  subsequent call to |setColumnStates|.</span>
<a href="#l13.452"></a><span id="l13.452">    */</span>
<a href="#l13.453"></a><span id="l13.453" class="difflineminus">-  _saveColumnStates: function FolderDisplayWidget__saveColumnStates() {</span>
<a href="#l13.454"></a><span id="l13.454" class="difflineplus">+  _saveColumnStates() {</span>
<a href="#l13.455"></a><span id="l13.455">     // In the actual nsITreeColumn, the index property indicates the column</span>
<a href="#l13.456"></a><span id="l13.456">     //  number.  This column number is a 0-based index with no gaps; it only</span>
<a href="#l13.457"></a><span id="l13.457">     //  increments the number each time it sees a column.</span>
<a href="#l13.458"></a><span id="l13.458">     // However, this is subservient to the 'ordinal' property which</span>
<a href="#l13.459"></a><span id="l13.459">     //  defines the _apparent content sequence_ provided by GetNextSibling.</span>
<a href="#l13.460"></a><span id="l13.460">     //  The underlying content ordering is still the same, which is how</span>
<a href="#l13.461"></a><span id="l13.461">     //  restoreNaturalOrder can reset things to their XUL definition sequence.</span>
<a href="#l13.462"></a><span id="l13.462">     //  The 'ordinal' stuff works because nsBoxFrame::RelayoutChildAtOrdinal</span>
<a href="#l13.463"></a><span id="l13.463" class="difflineat">@@ -741,122 +734,119 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.464"></a><span id="l13.464">     // restoreNaturalOrder invalidates the tree when it is done re-ordering; I'm</span>
<a href="#l13.465"></a><span id="l13.465">     //  not sure that's entirely necessary...</span>
<a href="#l13.466"></a><span id="l13.466">     this._savedColumnStates = this.getColumnStates();</span>
<a href="#l13.467"></a><span id="l13.467">   },</span>
<a href="#l13.468"></a><span id="l13.468"> </span>
<a href="#l13.469"></a><span id="l13.469">   /**</span>
<a href="#l13.470"></a><span id="l13.470">    * Restores the visible columns saved by |_saveColumnStates|.</span>
<a href="#l13.471"></a><span id="l13.471">    */</span>
<a href="#l13.472"></a><span id="l13.472" class="difflineminus">-  _restoreColumnStates: function FolderDisplayWidget__restoreColumnStates() {</span>
<a href="#l13.473"></a><span id="l13.473" class="difflineplus">+  _restoreColumnStates() {</span>
<a href="#l13.474"></a><span id="l13.474">     if (this._savedColumnStates) {</span>
<a href="#l13.475"></a><span id="l13.475">       this.setColumnStates(this._savedColumnStates);</span>
<a href="#l13.476"></a><span id="l13.476">       this._savedColumnStates = null;</span>
<a href="#l13.477"></a><span id="l13.477">     }</span>
<a href="#l13.478"></a><span id="l13.478">   },</span>
<a href="#l13.479"></a><span id="l13.479" class="difflineminus">-  //@}</span>
<a href="#l13.480"></a><span id="l13.480" class="difflineplus">+  // @}</span>
<a href="#l13.481"></a><span id="l13.481"> </span>
<a href="#l13.482"></a><span id="l13.482">   /**</span>
<a href="#l13.483"></a><span id="l13.483">    * @name What To Display</span>
<a href="#l13.484"></a><span id="l13.484">    * @protected</span>
<a href="#l13.485"></a><span id="l13.485">    */</span>
<a href="#l13.486"></a><span id="l13.486" class="difflineminus">-  //@{</span>
<a href="#l13.487"></a><span id="l13.487" class="difflineminus">-  showFolderUri: function FolderDisplayWidget_showFolderUri(aFolderURI) {</span>
<a href="#l13.488"></a><span id="l13.488" class="difflineplus">+  // @{</span>
<a href="#l13.489"></a><span id="l13.489" class="difflineplus">+  showFolderUri(aFolderURI) {</span>
<a href="#l13.490"></a><span id="l13.490">     return this.show(MailUtils.getFolderForURI(aFolderURI));</span>
<a href="#l13.491"></a><span id="l13.491">   },</span>
<a href="#l13.492"></a><span id="l13.492"> </span>
<a href="#l13.493"></a><span id="l13.493">   /**</span>
<a href="#l13.494"></a><span id="l13.494">    * Invoked by showFolder when it turns out the folder is in fact a server.</span>
<a href="#l13.495"></a><span id="l13.495">    * @private</span>
<a href="#l13.496"></a><span id="l13.496">    */</span>
<a href="#l13.497"></a><span id="l13.497" class="difflineminus">-  _showServer: function FolderDisplayWidget__showServer() {</span>
<a href="#l13.498"></a><span id="l13.498" class="difflineplus">+  _showServer() {</span>
<a href="#l13.499"></a><span id="l13.499">     // currently nothing to do.  makeActive handles everything for us (because</span>
<a href="#l13.500"></a><span id="l13.500">     //  what is displayed needs to be re-asserted each time we are activated</span>
<a href="#l13.501"></a><span id="l13.501">     //  too.)</span>
<a href="#l13.502"></a><span id="l13.502">   },</span>
<a href="#l13.503"></a><span id="l13.503"> </span>
<a href="#l13.504"></a><span id="l13.504">   /**</span>
<a href="#l13.505"></a><span id="l13.505">    * Select a folder for display.</span>
<a href="#l13.506"></a><span id="l13.506">    *</span>
<a href="#l13.507"></a><span id="l13.507">    * @param aFolder The nsIMsgDBFolder to display.</span>
<a href="#l13.508"></a><span id="l13.508">    */</span>
<a href="#l13.509"></a><span id="l13.509" class="difflineminus">-  show: function FolderDisplayWidget_show(aFolder) {</span>
<a href="#l13.510"></a><span id="l13.510" class="difflineplus">+  show(aFolder) {</span>
<a href="#l13.511"></a><span id="l13.511">     if (aFolder == null) {</span>
<a href="#l13.512"></a><span id="l13.512">       this._nonViewFolder = null;</span>
<a href="#l13.513"></a><span id="l13.513">       this.view.close();</span>
<a href="#l13.514"></a><span id="l13.514" class="difflineminus">-    }</span>
<a href="#l13.515"></a><span id="l13.515" class="difflineminus">-    else if (aFolder instanceof Ci.nsIMsgFolder) {</span>
<a href="#l13.516"></a><span id="l13.516" class="difflineplus">+    } else if (aFolder instanceof Ci.nsIMsgFolder) {</span>
<a href="#l13.517"></a><span id="l13.517">       if (aFolder.isServer) {</span>
<a href="#l13.518"></a><span id="l13.518">         this._nonViewFolder = aFolder;</span>
<a href="#l13.519"></a><span id="l13.519">         this._showServer();</span>
<a href="#l13.520"></a><span id="l13.520">         this.view.close();</span>
<a href="#l13.521"></a><span id="l13.521">         // A server is fully loaded immediately, for now.  (When we have the</span>
<a href="#l13.522"></a><span id="l13.522">         //  account summary, we might want to change this to wait for the page</span>
<a href="#l13.523"></a><span id="l13.523">         //  load to complete.)</span>
<a href="#l13.524"></a><span id="l13.524">         this._allMessagesLoaded = true;</span>
<a href="#l13.525"></a><span id="l13.525" class="difflineminus">-      }</span>
<a href="#l13.526"></a><span id="l13.526" class="difflineminus">-      else {</span>
<a href="#l13.527"></a><span id="l13.527" class="difflineplus">+      } else {</span>
<a href="#l13.528"></a><span id="l13.528">         this._nonViewFolder = null;</span>
<a href="#l13.529"></a><span id="l13.529">         this.view.open(aFolder);</span>
<a href="#l13.530"></a><span id="l13.530">       }</span>
<a href="#l13.531"></a><span id="l13.531" class="difflineminus">-    }</span>
<a href="#l13.532"></a><span id="l13.532" class="difflineminus">-    // it must be a synthetic view</span>
<a href="#l13.533"></a><span id="l13.533" class="difflineminus">-    else {</span>
<a href="#l13.534"></a><span id="l13.534" class="difflineplus">+    } else {</span>
<a href="#l13.535"></a><span id="l13.535" class="difflineplus">+      // it must be a synthetic view</span>
<a href="#l13.536"></a><span id="l13.536">       this.view.openSynthetic(aFolder);</span>
<a href="#l13.537"></a><span id="l13.537">     }</span>
<a href="#l13.538"></a><span id="l13.538">     if (this._active)</span>
<a href="#l13.539"></a><span id="l13.539">       this.makeActive();</span>
<a href="#l13.540"></a><span id="l13.540"> </span>
<a href="#l13.541"></a><span id="l13.541">     if (this._tabInfo)</span>
<a href="#l13.542"></a><span id="l13.542" class="difflineminus">-      document.getElementById('tabmail').setTabTitle(this._tabInfo);</span>
<a href="#l13.543"></a><span id="l13.543" class="difflineplus">+      document.getElementById(&quot;tabmail&quot;).setTabTitle(this._tabInfo);</span>
<a href="#l13.544"></a><span id="l13.544">   },</span>
<a href="#l13.545"></a><span id="l13.545"> </span>
<a href="#l13.546"></a><span id="l13.546">   /**</span>
<a href="#l13.547"></a><span id="l13.547">    * Clone an existing view wrapper as the basis for our display.</span>
<a href="#l13.548"></a><span id="l13.548">    */</span>
<a href="#l13.549"></a><span id="l13.549" class="difflineminus">-  cloneView: function FolderDisplayWidget_cloneView(aViewWrapper) {</span>
<a href="#l13.550"></a><span id="l13.550" class="difflineplus">+  cloneView(aViewWrapper) {</span>
<a href="#l13.551"></a><span id="l13.551">     this.view = aViewWrapper.clone(this);</span>
<a href="#l13.552"></a><span id="l13.552">     // generate a view created notification; this will cause us to do the right</span>
<a href="#l13.553"></a><span id="l13.553">     //  thing in terms of associating the view with the tree and such.</span>
<a href="#l13.554"></a><span id="l13.554">     this.onCreatedView();</span>
<a href="#l13.555"></a><span id="l13.555">     if (this._active)</span>
<a href="#l13.556"></a><span id="l13.556">       this.makeActive();</span>
<a href="#l13.557"></a><span id="l13.557">   },</span>
<a href="#l13.558"></a><span id="l13.558"> </span>
<a href="#l13.559"></a><span id="l13.559">   /**</span>
<a href="#l13.560"></a><span id="l13.560">    * Close resources associated with the currently displayed folder because you</span>
<a href="#l13.561"></a><span id="l13.561">    *  no longer care about this FolderDisplayWidget.</span>
<a href="#l13.562"></a><span id="l13.562">    */</span>
<a href="#l13.563"></a><span id="l13.563" class="difflineminus">-  close: function FolderDisplayWidget_close() {</span>
<a href="#l13.564"></a><span id="l13.564" class="difflineplus">+  close() {</span>
<a href="#l13.565"></a><span id="l13.565">     // Mark ourselves as inactive without doing any of the hard work of becoming</span>
<a href="#l13.566"></a><span id="l13.566">     //  inactive.  This saves us from trying to update things as they go away.</span>
<a href="#l13.567"></a><span id="l13.567">     this._active = false;</span>
<a href="#l13.568"></a><span id="l13.568">     // Tell the message display to close itself too.  We do this before we do</span>
<a href="#l13.569"></a><span id="l13.569">     //  anything else because closing the view could theoretically propagate</span>
<a href="#l13.570"></a><span id="l13.570">     //  down to the message display and we don't want it doing anything it</span>
<a href="#l13.571"></a><span id="l13.571">     //  doesn't have to do.</span>
<a href="#l13.572"></a><span id="l13.572">     this.messageDisplay._close();</span>
<a href="#l13.573"></a><span id="l13.573"> </span>
<a href="#l13.574"></a><span id="l13.574">     this.view.close();</span>
<a href="#l13.575"></a><span id="l13.575">     this.messenger.setWindow(null, null);</span>
<a href="#l13.576"></a><span id="l13.576">     this.messenger = null;</span>
<a href="#l13.577"></a><span id="l13.577">     this._fakeTreeBox = null;</span>
<a href="#l13.578"></a><span id="l13.578">     this._fakeTreeSelection = null;</span>
<a href="#l13.579"></a><span id="l13.579">   },</span>
<a href="#l13.580"></a><span id="l13.580" class="difflineminus">-  //@}</span>
<a href="#l13.581"></a><span id="l13.581" class="difflineplus">+  // @}</span>
<a href="#l13.582"></a><span id="l13.582"> </span>
<a href="#l13.583"></a><span id="l13.583">   /*   ===============================   */</span>
<a href="#l13.584"></a><span id="l13.584">   /* ===== IDBViewWrapper Listener ===== */</span>
<a href="#l13.585"></a><span id="l13.585">   /*   ===============================   */</span>
<a href="#l13.586"></a><span id="l13.586"> </span>
<a href="#l13.587"></a><span id="l13.587">   /**</span>
<a href="#l13.588"></a><span id="l13.588">    * @name IDBViewWrapperListener Interface</span>
<a href="#l13.589"></a><span id="l13.589">    * @private</span>
<a href="#l13.590"></a><span id="l13.590">    */</span>
<a href="#l13.591"></a><span id="l13.591" class="difflineminus">-  //@{</span>
<a href="#l13.592"></a><span id="l13.592" class="difflineplus">+  // @{</span>
<a href="#l13.593"></a><span id="l13.593"> </span>
<a href="#l13.594"></a><span id="l13.594">   /**</span>
<a href="#l13.595"></a><span id="l13.595">    * @return true if the mail view picker is visible.  This affects whether the</span>
<a href="#l13.596"></a><span id="l13.596">    *     DBViewWrapper will actually use the persisted mail view or not.</span>
<a href="#l13.597"></a><span id="l13.597">    */</span>
<a href="#l13.598"></a><span id="l13.598">   get shouldUseMailViews() {</span>
<a href="#l13.599"></a><span id="l13.599">     return ViewPickerBinding.isVisible;</span>
<a href="#l13.600"></a><span id="l13.600">   },</span>
<a href="#l13.601"></a><span id="l13.601" class="difflineat">@@ -880,75 +870,74 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.602"></a><span id="l13.602">   },</span>
<a href="#l13.603"></a><span id="l13.603"> </span>
<a href="#l13.604"></a><span id="l13.604">   /**</span>
<a href="#l13.605"></a><span id="l13.605">    * Let the viewWrapper know if it should mark the messages read when leaving</span>
<a href="#l13.606"></a><span id="l13.606">    *  the provided folder.</span>
<a href="#l13.607"></a><span id="l13.607">    *</span>
<a href="#l13.608"></a><span id="l13.608">    * @return true if the preference is set for the folder's server type.</span>
<a href="#l13.609"></a><span id="l13.609">    */</span>
<a href="#l13.610"></a><span id="l13.610" class="difflineminus">-  shouldMarkMessagesReadOnLeavingFolder:</span>
<a href="#l13.611"></a><span id="l13.611" class="difflineminus">-    function FolderDisplayWidget_crazyMarkOnReadChecker (aMsgFolder) {</span>
<a href="#l13.612"></a><span id="l13.612" class="difflineplus">+  shouldMarkMessagesReadOnLeavingFolder(aMsgFolder) {</span>
<a href="#l13.613"></a><span id="l13.613">       return Services.prefs.getBoolPref(&quot;mailnews.mark_message_read.&quot; +</span>
<a href="#l13.614"></a><span id="l13.614">                                         aMsgFolder.server.type);</span>
<a href="#l13.615"></a><span id="l13.615">   },</span>
<a href="#l13.616"></a><span id="l13.616"> </span>
<a href="#l13.617"></a><span id="l13.617">   /**</span>
<a href="#l13.618"></a><span id="l13.618">    * The view wrapper tells us when it starts loading a folder, and we set the</span>
<a href="#l13.619"></a><span id="l13.619">    *  cursor busy.  Setting the cursor busy on a per-tab basis is us being</span>
<a href="#l13.620"></a><span id="l13.620">    *  nice to the future. Loading a folder is a blocking operation that is going</span>
<a href="#l13.621"></a><span id="l13.621">    *  to make us unresponsive and accordingly make it very hard for the user to</span>
<a href="#l13.622"></a><span id="l13.622">    *  change tabs.</span>
<a href="#l13.623"></a><span id="l13.623">    */</span>
<a href="#l13.624"></a><span id="l13.624" class="difflineminus">-  onFolderLoading: function(aFolderLoading) {</span>
<a href="#l13.625"></a><span id="l13.625" class="difflineplus">+  onFolderLoading(aFolderLoading) {</span>
<a href="#l13.626"></a><span id="l13.626">     if (this._tabInfo)</span>
<a href="#l13.627"></a><span id="l13.627">       document.getElementById(&quot;tabmail&quot;).setTabBusy(this._tabInfo,</span>
<a href="#l13.628"></a><span id="l13.628">                                                     aFolderLoading);</span>
<a href="#l13.629"></a><span id="l13.629"> </span>
<a href="#l13.630"></a><span id="l13.630">     FolderDisplayListenerManager._fireListeners(&quot;onFolderLoading&quot;,</span>
<a href="#l13.631"></a><span id="l13.631">                                                 [this, aFolderLoading]);</span>
<a href="#l13.632"></a><span id="l13.632">   },</span>
<a href="#l13.633"></a><span id="l13.633"> </span>
<a href="#l13.634"></a><span id="l13.634">   /**</span>
<a href="#l13.635"></a><span id="l13.635">    * The view wrapper tells us when a search is active, and we mark the tab as</span>
<a href="#l13.636"></a><span id="l13.636">    *  thinking so the user knows something is happening.  'Searching' in this</span>
<a href="#l13.637"></a><span id="l13.637">    *  case is more than just a user-initiated search.  Virtual folders / saved</span>
<a href="#l13.638"></a><span id="l13.638">    *  searches, mail views, plus the more obvious quick search are all based off</span>
<a href="#l13.639"></a><span id="l13.639">    *  of searches and we will receive a notification for them.</span>
<a href="#l13.640"></a><span id="l13.640">    */</span>
<a href="#l13.641"></a><span id="l13.641" class="difflineminus">-  onSearching: function(aIsSearching) {</span>
<a href="#l13.642"></a><span id="l13.642" class="difflineplus">+  onSearching(aIsSearching) {</span>
<a href="#l13.643"></a><span id="l13.643">     if (this._tabInfo) {</span>
<a href="#l13.644"></a><span id="l13.644">       let searchBundle = document.getElementById(&quot;bundle_search&quot;);</span>
<a href="#l13.645"></a><span id="l13.645">       document.getElementById(&quot;tabmail&quot;).setTabThinking(</span>
<a href="#l13.646"></a><span id="l13.646">         this._tabInfo,</span>
<a href="#l13.647"></a><span id="l13.647">         aIsSearching &amp;&amp; searchBundle.getString(&quot;searchingMessage&quot;));</span>
<a href="#l13.648"></a><span id="l13.648">     }</span>
<a href="#l13.649"></a><span id="l13.649"> </span>
<a href="#l13.650"></a><span id="l13.650">     FolderDisplayListenerManager._fireListeners(&quot;onSearching&quot;,</span>
<a href="#l13.651"></a><span id="l13.651">                                                 [this, aIsSearching]);</span>
<a href="#l13.652"></a><span id="l13.652">   },</span>
<a href="#l13.653"></a><span id="l13.653"> </span>
<a href="#l13.654"></a><span id="l13.654">   /**</span>
<a href="#l13.655"></a><span id="l13.655">    * Things we do on creating a view:</span>
<a href="#l13.656"></a><span id="l13.656">    * - notify the observer service so that custom column handler providers can</span>
<a href="#l13.657"></a><span id="l13.657">    *   add their custom columns to our view.</span>
<a href="#l13.658"></a><span id="l13.658">    */</span>
<a href="#l13.659"></a><span id="l13.659" class="difflineminus">-  onCreatedView: function FolderDisplayWidget_onCreatedView() {</span>
<a href="#l13.660"></a><span id="l13.660" class="difflineplus">+  onCreatedView() {</span>
<a href="#l13.661"></a><span id="l13.661">     // All of our messages are not displayed if the view was just created.  We</span>
<a href="#l13.662"></a><span id="l13.662">     //  will get an onMessagesLoaded(true) nearly immediately if this is a local</span>
<a href="#l13.663"></a><span id="l13.663">     //  folder where view creation is synonymous with having all messages.</span>
<a href="#l13.664"></a><span id="l13.664">     this._allMessagesLoaded = false;</span>
<a href="#l13.665"></a><span id="l13.665">     this.messageDisplay.onCreatedView();</span>
<a href="#l13.666"></a><span id="l13.666"> </span>
<a href="#l13.667"></a><span id="l13.667">     FolderDisplayListenerManager._fireListeners(&quot;onCreatedView&quot;,</span>
<a href="#l13.668"></a><span id="l13.668">                                                 [this]);</span>
<a href="#l13.669"></a><span id="l13.669"> </span>
<a href="#l13.670"></a><span id="l13.670">     this._notifyWhenActive(this._activeCreatedView);</span>
<a href="#l13.671"></a><span id="l13.671">   },</span>
<a href="#l13.672"></a><span id="l13.672" class="difflineminus">-  _activeCreatedView: function() {</span>
<a href="#l13.673"></a><span id="l13.673" class="difflineplus">+  _activeCreatedView() {</span>
<a href="#l13.674"></a><span id="l13.674">     gDBView = this.view.dbView;</span>
<a href="#l13.675"></a><span id="l13.675"> </span>
<a href="#l13.676"></a><span id="l13.676">     // A change in view may result in changes to sorts, the view menu, etc.</span>
<a href="#l13.677"></a><span id="l13.677">     // Do this before we 'reroot' the dbview.</span>
<a href="#l13.678"></a><span id="l13.678">     this._updateThreadDisplay();</span>
<a href="#l13.679"></a><span id="l13.679"> </span>
<a href="#l13.680"></a><span id="l13.680">     // this creates a new selection object for the view.</span>
<a href="#l13.681"></a><span id="l13.681">     if (this.treeBox)</span>
<a href="#l13.682"></a><span id="l13.682" class="difflineat">@@ -964,33 +953,31 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.683"></a><span id="l13.683">     //  on creating a custom column assumes gDBView.)</span>
<a href="#l13.684"></a><span id="l13.684">     Services.obs.notifyObservers(this.displayedFolder, &quot;MsgCreateDBView&quot;);</span>
<a href="#l13.685"></a><span id="l13.685">   },</span>
<a href="#l13.686"></a><span id="l13.686"> </span>
<a href="#l13.687"></a><span id="l13.687">   /**</span>
<a href="#l13.688"></a><span id="l13.688">    * If our view is being destroyed and it is coming back, we want to save the</span>
<a href="#l13.689"></a><span id="l13.689">    *  current selection so we can restore it when the view comes back.</span>
<a href="#l13.690"></a><span id="l13.690">    */</span>
<a href="#l13.691"></a><span id="l13.691" class="difflineminus">-  onDestroyingView: function FolderDisplayWidget_onDestroyingView(</span>
<a href="#l13.692"></a><span id="l13.692" class="difflineminus">-      aFolderIsComingBack) {</span>
<a href="#l13.693"></a><span id="l13.693" class="difflineplus">+  onDestroyingView(aFolderIsComingBack) {</span>
<a href="#l13.694"></a><span id="l13.694">     // try and persist the selection's content if we can</span>
<a href="#l13.695"></a><span id="l13.695">     if (this._active) {</span>
<a href="#l13.696"></a><span id="l13.696">       // If saving the selection throws an exception, we still want continue</span>
<a href="#l13.697"></a><span id="l13.697">       // destroying the view. Saving the selection can fail if an underlying</span>
<a href="#l13.698"></a><span id="l13.698">       // local folder has been compacted, invalidating the message keys.</span>
<a href="#l13.699"></a><span id="l13.699">       // See bug 536676 for more info.</span>
<a href="#l13.700"></a><span id="l13.700">       try {</span>
<a href="#l13.701"></a><span id="l13.701">         // If a new selection is coming up, there's no point in trying to</span>
<a href="#l13.702"></a><span id="l13.702">         // persist any selections.</span>
<a href="#l13.703"></a><span id="l13.703">         if (aFolderIsComingBack &amp;&amp; !this._aboutToSelectMessage)</span>
<a href="#l13.704"></a><span id="l13.704">           this._saveSelection();</span>
<a href="#l13.705"></a><span id="l13.705">         else</span>
<a href="#l13.706"></a><span id="l13.706">           this._clearSavedSelection();</span>
<a href="#l13.707"></a><span id="l13.707" class="difflineminus">-      }</span>
<a href="#l13.708"></a><span id="l13.708" class="difflineminus">-      catch (ex) {</span>
<a href="#l13.709"></a><span id="l13.709" class="difflineplus">+      } catch (ex) {</span>
<a href="#l13.710"></a><span id="l13.710">         logException(ex);</span>
<a href="#l13.711"></a><span id="l13.711">       }</span>
<a href="#l13.712"></a><span id="l13.712">       gDBView = null;</span>
<a href="#l13.713"></a><span id="l13.713">     }</span>
<a href="#l13.714"></a><span id="l13.714"> </span>
<a href="#l13.715"></a><span id="l13.715">     FolderDisplayListenerManager._fireListeners(&quot;onDestroyingView&quot;,</span>
<a href="#l13.716"></a><span id="l13.716">                                                 [this, aFolderIsComingBack]);</span>
<a href="#l13.717"></a><span id="l13.717"> </span>
<a href="#l13.718"></a><span id="l13.718" class="difflineat">@@ -1015,44 +1002,43 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.719"></a><span id="l13.719">   },</span>
<a href="#l13.720"></a><span id="l13.720"> </span>
<a href="#l13.721"></a><span id="l13.721">   /**</span>
<a href="#l13.722"></a><span id="l13.722">    * Restore persisted information about what columns to display for the folder.</span>
<a href="#l13.723"></a><span id="l13.723">    *  If we have no persisted information, we leave/set _savedColumnStates null.</span>
<a href="#l13.724"></a><span id="l13.724">    *  The column states will be set to default values in onDisplayingFolder in</span>
<a href="#l13.725"></a><span id="l13.725">    *  that case.</span>
<a href="#l13.726"></a><span id="l13.726">    */</span>
<a href="#l13.727"></a><span id="l13.727" class="difflineminus">-  onLoadingFolder: function FolderDisplayWidget_onLoadingFolder(aDbFolderInfo) {</span>
<a href="#l13.728"></a><span id="l13.728" class="difflineplus">+  onLoadingFolder(aDbFolderInfo) {</span>
<a href="#l13.729"></a><span id="l13.729">     this._savedColumnStates =</span>
<a href="#l13.730"></a><span id="l13.730">       this._depersistColumnStatesFromDbFolderInfo(aDbFolderInfo);</span>
<a href="#l13.731"></a><span id="l13.731"> </span>
<a href="#l13.732"></a><span id="l13.732">     FolderDisplayListenerManager._fireListeners(&quot;onLoadingFolder&quot;,</span>
<a href="#l13.733"></a><span id="l13.733">                                                 [this, aDbFolderInfo]);</span>
<a href="#l13.734"></a><span id="l13.734">   },</span>
<a href="#l13.735"></a><span id="l13.735"> </span>
<a href="#l13.736"></a><span id="l13.736">   /**</span>
<a href="#l13.737"></a><span id="l13.737">    * We are entering the folder for display:</span>
<a href="#l13.738"></a><span id="l13.738">    * - set the header cache size.</span>
<a href="#l13.739"></a><span id="l13.739">    * - Setup the columns if we did not already depersist in |onLoadingFolder|.</span>
<a href="#l13.740"></a><span id="l13.740">    */</span>
<a href="#l13.741"></a><span id="l13.741" class="difflineminus">-  onDisplayingFolder: function FolderDisplayWidget_onDisplayingFolder() {</span>
<a href="#l13.742"></a><span id="l13.742" class="difflineplus">+  onDisplayingFolder() {</span>
<a href="#l13.743"></a><span id="l13.743">     let displayedFolder = this.view.displayedFolder;</span>
<a href="#l13.744"></a><span id="l13.744">     let msgDatabase = displayedFolder &amp;&amp; displayedFolder.msgDatabase;</span>
<a href="#l13.745"></a><span id="l13.745">     if (msgDatabase) {</span>
<a href="#l13.746"></a><span id="l13.746">       msgDatabase.resetHdrCacheSize(this.PERF_HEADER_CACHE_SIZE);</span>
<a href="#l13.747"></a><span id="l13.747">     }</span>
<a href="#l13.748"></a><span id="l13.748"> </span>
<a href="#l13.749"></a><span id="l13.749">     // makeActive will restore the folder state</span>
<a href="#l13.750"></a><span id="l13.750">     if (!this._savedColumnStates) {</span>
<a href="#l13.751"></a><span id="l13.751">       if (this.view.isSynthetic &amp;&amp;</span>
<a href="#l13.752"></a><span id="l13.752">           &quot;getPersistedSetting&quot; in this.view._syntheticView) {</span>
<a href="#l13.753"></a><span id="l13.753">         let columns = this.view._syntheticView.getPersistedSetting(&quot;columns&quot;);</span>
<a href="#l13.754"></a><span id="l13.754">         this._savedColumnStates = columns;</span>
<a href="#l13.755"></a><span id="l13.755" class="difflineminus">-      }</span>
<a href="#l13.756"></a><span id="l13.756" class="difflineminus">-      else {</span>
<a href="#l13.757"></a><span id="l13.757" class="difflineplus">+      } else {</span>
<a href="#l13.758"></a><span id="l13.758">         // get the default for this folder</span>
<a href="#l13.759"></a><span id="l13.759">         this._savedColumnStates = this._getDefaultColumnsForCurrentFolder();</span>
<a href="#l13.760"></a><span id="l13.760">         // and save it so it doesn't wiggle if the inbox/prototype changes</span>
<a href="#l13.761"></a><span id="l13.761">         this._persistColumnStates(this._savedColumnStates);</span>
<a href="#l13.762"></a><span id="l13.762">       }</span>
<a href="#l13.763"></a><span id="l13.763">     }</span>
<a href="#l13.764"></a><span id="l13.764"> </span>
<a href="#l13.765"></a><span id="l13.765">     FolderDisplayListenerManager._fireListeners(&quot;onDisplayingFolder&quot;,</span>
<a href="#l13.766"></a><span id="l13.766" class="difflineat">@@ -1062,17 +1048,17 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.767"></a><span id="l13.767">       this.makeActive();</span>
<a href="#l13.768"></a><span id="l13.768">   },</span>
<a href="#l13.769"></a><span id="l13.769"> </span>
<a href="#l13.770"></a><span id="l13.770">   /**</span>
<a href="#l13.771"></a><span id="l13.771">    * Notification from DBViewWrapper that it is closing the folder.  This can</span>
<a href="#l13.772"></a><span id="l13.772">    *  happen for reasons other than our own 'close' method closing the view.</span>
<a href="#l13.773"></a><span id="l13.773">    *  For example, user deletion of the folder or underlying folder closes it.</span>
<a href="#l13.774"></a><span id="l13.774">    */</span>
<a href="#l13.775"></a><span id="l13.775" class="difflineminus">-  onLeavingFolder: function FolderDisplayWidget_onLeavingFolder() {</span>
<a href="#l13.776"></a><span id="l13.776" class="difflineplus">+  onLeavingFolder() {</span>
<a href="#l13.777"></a><span id="l13.777">     FolderDisplayListenerManager._fireListeners(&quot;onLeavingFolder&quot;,</span>
<a href="#l13.778"></a><span id="l13.778">                                                 [this]);</span>
<a href="#l13.779"></a><span id="l13.779"> </span>
<a href="#l13.780"></a><span id="l13.780">     // Keep the msgWindow's openFolder up-to-date; it powers nsMessenger's</span>
<a href="#l13.781"></a><span id="l13.781">     //  concept of history so that it can bring you back to the actual folder</span>
<a href="#l13.782"></a><span id="l13.782">     //  you were looking at, rather than just the underlying folder.</span>
<a href="#l13.783"></a><span id="l13.783">     if (this._active)</span>
<a href="#l13.784"></a><span id="l13.784">       msgWindow.openFolder = null;</span>
<a href="#l13.785"></a><span id="l13.785" class="difflineat">@@ -1091,26 +1077,25 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.786"></a><span id="l13.786">   /**</span>
<a href="#l13.787"></a><span id="l13.787">    * Things to do once some or all the messages that should show up in a folder</span>
<a href="#l13.788"></a><span id="l13.788">    *  have shown up.  For a real folder, this happens when the folder is</span>
<a href="#l13.789"></a><span id="l13.789">    *  entered. For a virtual folder, this happens when the search completes.</span>
<a href="#l13.790"></a><span id="l13.790">    *</span>
<a href="#l13.791"></a><span id="l13.791">    * What we do:</span>
<a href="#l13.792"></a><span id="l13.792">    * - Any scrolling required!</span>
<a href="#l13.793"></a><span id="l13.793">    */</span>
<a href="#l13.794"></a><span id="l13.794" class="difflineminus">-  onMessagesLoaded: function FolderDisplayWidget_onMessagesLoaded(aAll) {</span>
<a href="#l13.795"></a><span id="l13.795" class="difflineplus">+  onMessagesLoaded(aAll) {</span>
<a href="#l13.796"></a><span id="l13.796">     this._allMessagesLoaded = aAll;</span>
<a href="#l13.797"></a><span id="l13.797"> </span>
<a href="#l13.798"></a><span id="l13.798">     FolderDisplayListenerManager._fireListeners(&quot;onMessagesLoaded&quot;,</span>
<a href="#l13.799"></a><span id="l13.799">                                                 [this, aAll]);</span>
<a href="#l13.800"></a><span id="l13.800"> </span>
<a href="#l13.801"></a><span id="l13.801">     this._notifyWhenActive(this._activeMessagesLoaded);</span>
<a href="#l13.802"></a><span id="l13.802">   },</span>
<a href="#l13.803"></a><span id="l13.803" class="difflineminus">-  _activeMessagesLoaded:</span>
<a href="#l13.804"></a><span id="l13.804" class="difflineminus">-      function FolderDisplayWidget__activeMessagesLoaded() {</span>
<a href="#l13.805"></a><span id="l13.805" class="difflineplus">+  _activeMessagesLoaded() {</span>
<a href="#l13.806"></a><span id="l13.806">     FolderDisplayListenerManager._fireListeners(&quot;onActiveMessagesLoaded&quot;,</span>
<a href="#l13.807"></a><span id="l13.807">                                                 [this]);</span>
<a href="#l13.808"></a><span id="l13.808"> </span>
<a href="#l13.809"></a><span id="l13.809">     // - if a selectMessage's coming up, get out of here</span>
<a href="#l13.810"></a><span id="l13.810">     if (this._aboutToSelectMessage)</span>
<a href="#l13.811"></a><span id="l13.811">       return;</span>
<a href="#l13.812"></a><span id="l13.812"> </span>
<a href="#l13.813"></a><span id="l13.813">     // - restore user's last expand/collapse choice.</span>
<a href="#l13.814"></a><span id="l13.814" class="difflineat">@@ -1180,46 +1165,46 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.815"></a><span id="l13.815">     // - to the top, the coliseum</span>
<a href="#l13.816"></a><span id="l13.816">     this.ensureRowIsVisible(0);</span>
<a href="#l13.817"></a><span id="l13.817">   },</span>
<a href="#l13.818"></a><span id="l13.818"> </span>
<a href="#l13.819"></a><span id="l13.819">   /**</span>
<a href="#l13.820"></a><span id="l13.820">    * The DBViewWrapper tells us when someone (possibly the wrapper itself)</span>
<a href="#l13.821"></a><span id="l13.821">    *  changes the active mail view so that we can kick the UI to update.</span>
<a href="#l13.822"></a><span id="l13.822">    */</span>
<a href="#l13.823"></a><span id="l13.823" class="difflineminus">-  onMailViewChanged: function FolderDisplayWidget_onMailViewChanged() {</span>
<a href="#l13.824"></a><span id="l13.824" class="difflineplus">+  onMailViewChanged() {</span>
<a href="#l13.825"></a><span id="l13.825">     // only do this if we're currently active.  no need to queue it because we</span>
<a href="#l13.826"></a><span id="l13.826">     //  always update the mail view whenever we are made active.</span>
<a href="#l13.827"></a><span id="l13.827">     if (this.active) {</span>
<a href="#l13.828"></a><span id="l13.828">       // you cannot cancel a view change!</span>
<a href="#l13.829"></a><span id="l13.829">       window.dispatchEvent(new Event(&quot;MailViewChanged&quot;,</span>
<a href="#l13.830"></a><span id="l13.830">         { bubbles: false, cancelable: false }));</span>
<a href="#l13.831"></a><span id="l13.831">     }</span>
<a href="#l13.832"></a><span id="l13.832">   },</span>
<a href="#l13.833"></a><span id="l13.833"> </span>
<a href="#l13.834"></a><span id="l13.834">   /**</span>
<a href="#l13.835"></a><span id="l13.835">    * Just the sort or threading was changed, without changing other things.  We</span>
<a href="#l13.836"></a><span id="l13.836">    *  will not get this notification if the view was re-created, for example.</span>
<a href="#l13.837"></a><span id="l13.837">    */</span>
<a href="#l13.838"></a><span id="l13.838" class="difflineminus">-  onSortChanged: function FolderDisplayWidget_onSortChanged() {</span>
<a href="#l13.839"></a><span id="l13.839" class="difflineplus">+  onSortChanged() {</span>
<a href="#l13.840"></a><span id="l13.840">     if (this.active)</span>
<a href="#l13.841"></a><span id="l13.841">       UpdateSortIndicators(this.view.primarySortType,</span>
<a href="#l13.842"></a><span id="l13.842">                            this.view.primarySortOrder);</span>
<a href="#l13.843"></a><span id="l13.843"> </span>
<a href="#l13.844"></a><span id="l13.844">     FolderDisplayListenerManager._fireListeners(&quot;onSortChanged&quot;,</span>
<a href="#l13.845"></a><span id="l13.845">                                                 [this]);</span>
<a href="#l13.846"></a><span id="l13.846">   },</span>
<a href="#l13.847"></a><span id="l13.847"> </span>
<a href="#l13.848"></a><span id="l13.848">   /**</span>
<a href="#l13.849"></a><span id="l13.849">    * Messages (that may have been displayed) have been removed; this may impact</span>
<a href="#l13.850"></a><span id="l13.850">    * our message selection. We might know it's coming; if we do then</span>
<a href="#l13.851"></a><span id="l13.851">    * this._nextViewIndexAfterDelete should know what view index to select next.</span>
<a href="#l13.852"></a><span id="l13.852">    * For the imap mark-as-deleted we won't know beforehand.</span>
<a href="#l13.853"></a><span id="l13.853">    */</span>
<a href="#l13.854"></a><span id="l13.854" class="difflineminus">-  onMessagesRemoved: function FolderDisplayWidget_onMessagesRemoved() {</span>
<a href="#l13.855"></a><span id="l13.855" class="difflineplus">+  onMessagesRemoved() {</span>
<a href="#l13.856"></a><span id="l13.856">     FolderDisplayListenerManager._fireListeners(&quot;onMessagesRemoved&quot;,</span>
<a href="#l13.857"></a><span id="l13.857">                                                 [this]);</span>
<a href="#l13.858"></a><span id="l13.858"> </span>
<a href="#l13.859"></a><span id="l13.859">     if (this.messageDisplay.onMessagesRemoved())</span>
<a href="#l13.860"></a><span id="l13.860">       return;</span>
<a href="#l13.861"></a><span id="l13.861"> </span>
<a href="#l13.862"></a><span id="l13.862">     // - we saw this coming</span>
<a href="#l13.863"></a><span id="l13.863">     let rowCount = this.view.dbView.rowCount;</span>
<a href="#l13.864"></a><span id="l13.864" class="difflineat">@@ -1274,51 +1259,50 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.865"></a><span id="l13.865">       this.view.dbView.selectionChanged();</span>
<a href="#l13.866"></a><span id="l13.866">   },</span>
<a href="#l13.867"></a><span id="l13.867"> </span>
<a href="#l13.868"></a><span id="l13.868">   /**</span>
<a href="#l13.869"></a><span id="l13.869">    * Messages were not actually removed, but we were expecting that they would</span>
<a href="#l13.870"></a><span id="l13.870">    *  be.  Clean-up what onMessagesRemoved would have cleaned up, namely the</span>
<a href="#l13.871"></a><span id="l13.871">    *  next view index to select.</span>
<a href="#l13.872"></a><span id="l13.872">    */</span>
<a href="#l13.873"></a><span id="l13.873" class="difflineminus">-  onMessageRemovalFailed:</span>
<a href="#l13.874"></a><span id="l13.874" class="difflineminus">-      function FolderDisplayWidget_onMessageRemovalFailed() {</span>
<a href="#l13.875"></a><span id="l13.875" class="difflineplus">+  onMessageRemovalFailed() {</span>
<a href="#l13.876"></a><span id="l13.876">     this._nextViewIndexAfterDelete = null;</span>
<a href="#l13.877"></a><span id="l13.877">     FolderDisplayListenerManager._fireListeners(&quot;onMessagesRemovalFailed&quot;,</span>
<a href="#l13.878"></a><span id="l13.878">                                                 [this]);</span>
<a href="#l13.879"></a><span id="l13.879">   },</span>
<a href="#l13.880"></a><span id="l13.880"> </span>
<a href="#l13.881"></a><span id="l13.881">   /**</span>
<a href="#l13.882"></a><span id="l13.882">    * Update the status bar to reflect our exciting message counts.</span>
<a href="#l13.883"></a><span id="l13.883">    */</span>
<a href="#l13.884"></a><span id="l13.884" class="difflineminus">-  onMessageCountsChanged: function FolderDisplayWidget_onMessageCountsChaned() {</span>
<a href="#l13.885"></a><span id="l13.885" class="difflineplus">+  onMessageCountsChanged() {</span>
<a href="#l13.886"></a><span id="l13.886">     if (this.active)</span>
<a href="#l13.887"></a><span id="l13.887">       UpdateStatusMessageCounts(this.displayedFolder);</span>
<a href="#l13.888"></a><span id="l13.888">     FolderDisplayListenerManager._fireListeners(&quot;onMessageCountsChanged&quot;,</span>
<a href="#l13.889"></a><span id="l13.889">                                                 [this]);</span>
<a href="#l13.890"></a><span id="l13.890">   },</span>
<a href="#l13.891"></a><span id="l13.891" class="difflineminus">-  //@}</span>
<a href="#l13.892"></a><span id="l13.892" class="difflineplus">+  // @}</span>
<a href="#l13.893"></a><span id="l13.893">   /* ===== End IDBViewWrapperListener ===== */</span>
<a href="#l13.894"></a><span id="l13.894"> </span>
<a href="#l13.895"></a><span id="l13.895">   /*   ==================================   */</span>
<a href="#l13.896"></a><span id="l13.896">   /* ===== nsIMsgDBViewCommandUpdater ===== */</span>
<a href="#l13.897"></a><span id="l13.897">   /*   ==================================   */</span>
<a href="#l13.898"></a><span id="l13.898"> </span>
<a href="#l13.899"></a><span id="l13.899">   /**</span>
<a href="#l13.900"></a><span id="l13.900">    * @name nsIMsgDBViewCommandUpdater Interface</span>
<a href="#l13.901"></a><span id="l13.901">    * @private</span>
<a href="#l13.902"></a><span id="l13.902">    */</span>
<a href="#l13.903"></a><span id="l13.903" class="difflineminus">-  //@{</span>
<a href="#l13.904"></a><span id="l13.904" class="difflineplus">+  // @{</span>
<a href="#l13.905"></a><span id="l13.905"> </span>
<a href="#l13.906"></a><span id="l13.906">   /**</span>
<a href="#l13.907"></a><span id="l13.907">    * This gets called when the selection changes AND !suppressCommandUpdating</span>
<a href="#l13.908"></a><span id="l13.908">    *  AND (we're not removing a row OR we are now out of rows).</span>
<a href="#l13.909"></a><span id="l13.909">    * In response, we update the toolbar.</span>
<a href="#l13.910"></a><span id="l13.910">    */</span>
<a href="#l13.911"></a><span id="l13.911" class="difflineminus">-  updateCommandStatus: function FolderDisplayWidget_updateCommandStatus() {</span>
<a href="#l13.912"></a><span id="l13.912" class="difflineplus">+  updateCommandStatus() {</span>
<a href="#l13.913"></a><span id="l13.913">     // Do this only if we're active. If we aren't, we're going to take care of</span>
<a href="#l13.914"></a><span id="l13.914">     // this when we switch back to the tab.</span>
<a href="#l13.915"></a><span id="l13.915">     if (this._active)</span>
<a href="#l13.916"></a><span id="l13.916">       UpdateMailToolbar(&quot;FolderDisplayWidget command updater notification&quot;);</span>
<a href="#l13.917"></a><span id="l13.917">   },</span>
<a href="#l13.918"></a><span id="l13.918"> </span>
<a href="#l13.919"></a><span id="l13.919">   /**</span>
<a href="#l13.920"></a><span id="l13.920">    * This gets called by nsMsgDBView::UpdateDisplayMessage following a call</span>
<a href="#l13.921"></a><span id="l13.921" class="difflineat">@@ -1335,18 +1319,17 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.922"></a><span id="l13.922">    * - Update some toolbar buttons, why not.</span>
<a href="#l13.923"></a><span id="l13.923">    *</span>
<a href="#l13.924"></a><span id="l13.924">    * @param aFolder The display/view folder, as opposed to the backing folder.</span>
<a href="#l13.925"></a><span id="l13.925">    * @param aSubject The subject with &quot;Re: &quot; if it's got one, which makes it</span>
<a href="#l13.926"></a><span id="l13.926">    *     notably different from just directly accessing the message header's</span>
<a href="#l13.927"></a><span id="l13.927">    *     subject.</span>
<a href="#l13.928"></a><span id="l13.928">    * @param aKeywords The keywords, which roughly translates to message tags.</span>
<a href="#l13.929"></a><span id="l13.929">    */</span>
<a href="#l13.930"></a><span id="l13.930" class="difflineminus">-  displayMessageChanged: function FolderDisplayWidget_displayMessageChanged(</span>
<a href="#l13.931"></a><span id="l13.931" class="difflineminus">-      aFolder, aSubject, aKeywords) {</span>
<a href="#l13.932"></a><span id="l13.932" class="difflineplus">+  displayMessageChanged(aFolder, aSubject, aKeywords) {</span>
<a href="#l13.933"></a><span id="l13.933">     // Hide previous stale message to prevent brief threadpane selection and</span>
<a href="#l13.934"></a><span id="l13.934">     // content displayed mismatch, on both folder and tab changes.</span>
<a href="#l13.935"></a><span id="l13.935">     let browser = getBrowser();</span>
<a href="#l13.936"></a><span id="l13.936">     if (browser &amp;&amp; browser.contentDocument &amp;&amp; browser.contentDocument.body)</span>
<a href="#l13.937"></a><span id="l13.937">       browser.contentDocument.body.hidden = true;</span>
<a href="#l13.938"></a><span id="l13.938"> </span>
<a href="#l13.939"></a><span id="l13.939">     UpdateMailToolbar(&quot;FolderDisplayWidget displayed message changed&quot;);</span>
<a href="#l13.940"></a><span id="l13.940">     let selected = this.view.dbView.getSelectedMsgHdrs();</span>
<a href="#l13.941"></a><span id="l13.941" class="difflineat">@@ -1371,18 +1354,17 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.942"></a><span id="l13.942">   /**</span>
<a href="#l13.943"></a><span id="l13.943">    * This gets called as a hint that the currently selected message is junk and</span>
<a href="#l13.944"></a><span id="l13.944">    *  said junked message is going to be moved out of the current folder, or</span>
<a href="#l13.945"></a><span id="l13.945">    *  right before a header is removed from the db view.  The legacy behaviour</span>
<a href="#l13.946"></a><span id="l13.946">    *  is to retrieve the msgToSelectAfterDelete attribute off the db view,</span>
<a href="#l13.947"></a><span id="l13.947">    *  stashing it for benefit of the code that gets called when a message</span>
<a href="#l13.948"></a><span id="l13.948">    *  move/deletion is completed so that we can trigger its display.</span>
<a href="#l13.949"></a><span id="l13.949">    */</span>
<a href="#l13.950"></a><span id="l13.950" class="difflineminus">-  updateNextMessageAfterDelete:</span>
<a href="#l13.951"></a><span id="l13.951" class="difflineminus">-      function FolderDisplayWidget_updateNextMessageAfterDelete() {</span>
<a href="#l13.952"></a><span id="l13.952" class="difflineplus">+  updateNextMessageAfterDelete() {</span>
<a href="#l13.953"></a><span id="l13.953">     this.hintAboutToDeleteMessages();</span>
<a href="#l13.954"></a><span id="l13.954">   },</span>
<a href="#l13.955"></a><span id="l13.955"> </span>
<a href="#l13.956"></a><span id="l13.956">   /**</span>
<a href="#l13.957"></a><span id="l13.957">    * The most recent currentIndexes on the selection (from the last time</span>
<a href="#l13.958"></a><span id="l13.958">    *  summarizeSelection got called).  We use this in onMessagesRemoved if</span>
<a href="#l13.959"></a><span id="l13.959">    *  we get an unexpected notification.</span>
<a href="#l13.960"></a><span id="l13.960">    * We keep a maximum of 2 entries in this list.</span>
<a href="#l13.961"></a><span id="l13.961" class="difflineat">@@ -1397,79 +1379,76 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.962"></a><span id="l13.962">   _mostRecentSelectionCounts: undefined, // initialized in constructor</span>
<a href="#l13.963"></a><span id="l13.963"> </span>
<a href="#l13.964"></a><span id="l13.964">   /**</span>
<a href="#l13.965"></a><span id="l13.965">    * Always called by the db view when the selection changes in</span>
<a href="#l13.966"></a><span id="l13.966">    *  SelectionChanged.  This event will come after the notification to</span>
<a href="#l13.967"></a><span id="l13.967">    *  displayMessageChanged (if one happens), and before the notification to</span>
<a href="#l13.968"></a><span id="l13.968">    *  updateCommandStatus (if one happens).</span>
<a href="#l13.969"></a><span id="l13.969">    */</span>
<a href="#l13.970"></a><span id="l13.970" class="difflineminus">-  summarizeSelection: function FolderDisplayWidget_summarizeSelection() {</span>
<a href="#l13.971"></a><span id="l13.971" class="difflineplus">+  summarizeSelection() {</span>
<a href="#l13.972"></a><span id="l13.972">     // save the current index off in case the selection gets deleted out from</span>
<a href="#l13.973"></a><span id="l13.973">     //  under us and we want to have persistence of actually-having-something</span>
<a href="#l13.974"></a><span id="l13.974">     //  selected.</span>
<a href="#l13.975"></a><span id="l13.975">     let treeSelection = this.treeSelection;</span>
<a href="#l13.976"></a><span id="l13.976">     if (treeSelection) {</span>
<a href="#l13.977"></a><span id="l13.977">       this._mostRecentCurrentIndices.unshift(treeSelection.currentIndex);</span>
<a href="#l13.978"></a><span id="l13.978">       this._mostRecentCurrentIndices.splice(2);</span>
<a href="#l13.979"></a><span id="l13.979">       this._mostRecentSelectionCounts.unshift(treeSelection.count);</span>
<a href="#l13.980"></a><span id="l13.980">       this._mostRecentSelectionCounts.splice(2);</span>
<a href="#l13.981"></a><span id="l13.981">     }</span>
<a href="#l13.982"></a><span id="l13.982">     return this.messageDisplay.onSelectedMessagesChanged();</span>
<a href="#l13.983"></a><span id="l13.983">   },</span>
<a href="#l13.984"></a><span id="l13.984" class="difflineminus">-  //@}</span>
<a href="#l13.985"></a><span id="l13.985" class="difflineplus">+  // @}</span>
<a href="#l13.986"></a><span id="l13.986">   /* ===== End nsIMsgDBViewCommandUpdater ===== */</span>
<a href="#l13.987"></a><span id="l13.987"> </span>
<a href="#l13.988"></a><span id="l13.988">   /* ===== Hints from the command infrastructure ===== */</span>
<a href="#l13.989"></a><span id="l13.989">   /**</span>
<a href="#l13.990"></a><span id="l13.990">    * @name Command Infrastructure Hints</span>
<a href="#l13.991"></a><span id="l13.991">    * @protected</span>
<a href="#l13.992"></a><span id="l13.992">    */</span>
<a href="#l13.993"></a><span id="l13.993" class="difflineminus">-  //@{</span>
<a href="#l13.994"></a><span id="l13.994" class="difflineplus">+  // @{</span>
<a href="#l13.995"></a><span id="l13.995"> </span>
<a href="#l13.996"></a><span id="l13.996">   /**</span>
<a href="#l13.997"></a><span id="l13.997">    * doCommand helps us out by telling us when it is telling the view to delete</span>
<a href="#l13.998"></a><span id="l13.998">    *  some messages.  Ideally it should go through us / the DB View Wrapper to</span>
<a href="#l13.999"></a><span id="l13.999">    *  kick off the delete in the first place, but that's a thread I don't want</span>
<a href="#l13.1000"></a><span id="l13.1000">    *  to pull on right now.</span>
<a href="#l13.1001"></a><span id="l13.1001">    * We use this hint to figure out the next message to display once the</span>
<a href="#l13.1002"></a><span id="l13.1002">    *  deletion completes.  We do this before the deletion happens because the</span>
<a href="#l13.1003"></a><span id="l13.1003">    *  selection is probably going away (except in the IMAP delete model), and it</span>
<a href="#l13.1004"></a><span id="l13.1004">    *  might be too late to figure this out after the deletion happens.</span>
<a href="#l13.1005"></a><span id="l13.1005">    * Our automated complement (that calls us) is updateNextMessageAfterDelete.</span>
<a href="#l13.1006"></a><span id="l13.1006">    */</span>
<a href="#l13.1007"></a><span id="l13.1007" class="difflineminus">-  hintAboutToDeleteMessages:</span>
<a href="#l13.1008"></a><span id="l13.1008" class="difflineminus">-      function FolderDisplayWidget_hintAboutToDeleteMessages() {</span>
<a href="#l13.1009"></a><span id="l13.1009" class="difflineplus">+  hintAboutToDeleteMessages() {</span>
<a href="#l13.1010"></a><span id="l13.1010">     // save the value, even if it is nsMsgViewIndex_None.</span>
<a href="#l13.1011"></a><span id="l13.1011">     this._nextViewIndexAfterDelete = this.view.dbView.msgToSelectAfterDelete;</span>
<a href="#l13.1012"></a><span id="l13.1012">   },</span>
<a href="#l13.1013"></a><span id="l13.1013"> </span>
<a href="#l13.1014"></a><span id="l13.1014">   /**</span>
<a href="#l13.1015"></a><span id="l13.1015">    * The archive code tells us when it is starting to archive messages.  This</span>
<a href="#l13.1016"></a><span id="l13.1016">    *  is different from hinting about deletion because it will also tell us</span>
<a href="#l13.1017"></a><span id="l13.1017">    *  when it has completed its mass move.</span>
<a href="#l13.1018"></a><span id="l13.1018">    * The UI goal is that we do not immediately jump beyond the selected messages</span>
<a href="#l13.1019"></a><span id="l13.1019">    *  to the next message until all of the selected messages have been</span>
<a href="#l13.1020"></a><span id="l13.1020">    *  processed (moved).  Ideally we would also do this when deleting messages</span>
<a href="#l13.1021"></a><span id="l13.1021">    *  from a multiple-folder backed message view, but we don't know when the</span>
<a href="#l13.1022"></a><span id="l13.1022">    *  last job completes in that case (whereas in this case we do because of the</span>
<a href="#l13.1023"></a><span id="l13.1023">    *  call to hintMassMoveCompleted.)</span>
<a href="#l13.1024"></a><span id="l13.1024">    */</span>
<a href="#l13.1025"></a><span id="l13.1025" class="difflineminus">-  hintMassMoveStarting:</span>
<a href="#l13.1026"></a><span id="l13.1026" class="difflineminus">-      function FolderDisplayWidget_hintMassMoveStarting() {</span>
<a href="#l13.1027"></a><span id="l13.1027" class="difflineplus">+  hintMassMoveStarting() {</span>
<a href="#l13.1028"></a><span id="l13.1028">     this.hintAboutToDeleteMessages();</span>
<a href="#l13.1029"></a><span id="l13.1029">     this._massMoveActive = true;</span>
<a href="#l13.1030"></a><span id="l13.1030">   },</span>
<a href="#l13.1031"></a><span id="l13.1031"> </span>
<a href="#l13.1032"></a><span id="l13.1032">   /**</span>
<a href="#l13.1033"></a><span id="l13.1033">    * The archival has completed, we can finally let onMessagseRemoved run to</span>
<a href="#l13.1034"></a><span id="l13.1034">    *  completion.</span>
<a href="#l13.1035"></a><span id="l13.1035">    */</span>
<a href="#l13.1036"></a><span id="l13.1036" class="difflineminus">-  hintMassMoveCompleted:</span>
<a href="#l13.1037"></a><span id="l13.1037" class="difflineminus">-      function FolderDisplayWidget_hintMassMoveCompleted() {</span>
<a href="#l13.1038"></a><span id="l13.1038" class="difflineplus">+  hintMassMoveCompleted() {</span>
<a href="#l13.1039"></a><span id="l13.1039">     this._massMoveActive = false;</span>
<a href="#l13.1040"></a><span id="l13.1040">     this.onMessagesRemoved();</span>
<a href="#l13.1041"></a><span id="l13.1041">   },</span>
<a href="#l13.1042"></a><span id="l13.1042"> </span>
<a href="#l13.1043"></a><span id="l13.1043">   /**</span>
<a href="#l13.1044"></a><span id="l13.1044">    * When a right-click on the thread pane is going to alter our selection, we</span>
<a href="#l13.1045"></a><span id="l13.1045">    *  get this notification (currently from |ChangeSelectionWithoutContentLoad|</span>
<a href="#l13.1046"></a><span id="l13.1046">    *  in msgMail3PaneWindow.js), which lets us save our state.</span>
<a href="#l13.1047"></a><span id="l13.1047" class="difflineat">@@ -1483,121 +1462,114 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.1048"></a><span id="l13.1048">    *  the right-click itself may mutate the view (although we could try and get</span>
<a href="#l13.1049"></a><span id="l13.1049">    *  it to restore the selection before it gets to the mutation part).  Our</span>
<a href="#l13.1050"></a><span id="l13.1050">    *  only way to resolve this would be to create a 'tee' like fake selection</span>
<a href="#l13.1051"></a><span id="l13.1051">    *  that would proxy view change notifications to both sets of selections.</span>
<a href="#l13.1052"></a><span id="l13.1052">    *  That is hard.</span>
<a href="#l13.1053"></a><span id="l13.1053">    * So we just use the existing _saveSelection/_restoreSelection mechanism</span>
<a href="#l13.1054"></a><span id="l13.1054">    *  which is potentially very costly.</span>
<a href="#l13.1055"></a><span id="l13.1055">    */</span>
<a href="#l13.1056"></a><span id="l13.1056" class="difflineminus">-  hintRightClickPerturbingSelection:</span>
<a href="#l13.1057"></a><span id="l13.1057" class="difflineminus">-      function FolderDisplayWidget_hintRightClickPerturbingSelect() {</span>
<a href="#l13.1058"></a><span id="l13.1058" class="difflineplus">+  hintRightClickPerturbingSelection() {</span>
<a href="#l13.1059"></a><span id="l13.1059">     this._saveSelection();</span>
<a href="#l13.1060"></a><span id="l13.1060">   },</span>
<a href="#l13.1061"></a><span id="l13.1061"> </span>
<a href="#l13.1062"></a><span id="l13.1062">   /**</span>
<a href="#l13.1063"></a><span id="l13.1063">    * When a right-click on the thread pane altered our selection (which we</span>
<a href="#l13.1064"></a><span id="l13.1064">    *  should have received a call to |hintRightClickPerturbingSelection| for),</span>
<a href="#l13.1065"></a><span id="l13.1065">    *  we should receive this notification from</span>
<a href="#l13.1066"></a><span id="l13.1066">    *  |RestoreSelectionWithoutContentLoad| when it wants to put things back.</span>
<a href="#l13.1067"></a><span id="l13.1067">    */</span>
<a href="#l13.1068"></a><span id="l13.1068" class="difflineminus">-  hintRightClickSelectionPerturbationDone:</span>
<a href="#l13.1069"></a><span id="l13.1069" class="difflineminus">-      function FolderDisplayWidget_hintRightClickSelectionPerturbationDone() {</span>
<a href="#l13.1070"></a><span id="l13.1070" class="difflineplus">+  hintRightClickSelectionPerturbationDone() {</span>
<a href="#l13.1071"></a><span id="l13.1071">     this._restoreSelection();</span>
<a href="#l13.1072"></a><span id="l13.1072">   },</span>
<a href="#l13.1073"></a><span id="l13.1073" class="difflineminus">-  //@}</span>
<a href="#l13.1074"></a><span id="l13.1074" class="difflineplus">+  // @}</span>
<a href="#l13.1075"></a><span id="l13.1075">   /* ===== End hints from the command infrastructure ==== */</span>
<a href="#l13.1076"></a><span id="l13.1076"> </span>
<a href="#l13.1077"></a><span id="l13.1077" class="difflineminus">-  _updateThreadDisplay: function FolderDisplayWidget__updateThreadDisplay() {</span>
<a href="#l13.1078"></a><span id="l13.1078" class="difflineplus">+  _updateThreadDisplay() {</span>
<a href="#l13.1079"></a><span id="l13.1079">     if (this.active) {</span>
<a href="#l13.1080"></a><span id="l13.1080">       if (this.view.dbView) {</span>
<a href="#l13.1081"></a><span id="l13.1081">         UpdateSortIndicators(this.view.dbView.sortType,</span>
<a href="#l13.1082"></a><span id="l13.1082">                              this.view.dbView.sortOrder);</span>
<a href="#l13.1083"></a><span id="l13.1083">         SetNewsFolderColumns();</span>
<a href="#l13.1084"></a><span id="l13.1084">       }</span>
<a href="#l13.1085"></a><span id="l13.1085">     }</span>
<a href="#l13.1086"></a><span id="l13.1086">   },</span>
<a href="#l13.1087"></a><span id="l13.1087"> </span>
<a href="#l13.1088"></a><span id="l13.1088">   /**</span>
<a href="#l13.1089"></a><span id="l13.1089">    * Update the UI display apart from the thread tree because the folder being</span>
<a href="#l13.1090"></a><span id="l13.1090">    *  displayed has changed.  This can be the result of changing the folder in</span>
<a href="#l13.1091"></a><span id="l13.1091">    *  this FolderDisplayWidget, or because this FolderDisplayWidget is being</span>
<a href="#l13.1092"></a><span id="l13.1092">    *  made active.  _updateThreadDisplay handles the parts of the thread tree</span>
<a href="#l13.1093"></a><span id="l13.1093">    *  that need updating.</span>
<a href="#l13.1094"></a><span id="l13.1094">    */</span>
<a href="#l13.1095"></a><span id="l13.1095" class="difflineminus">-  _updateContextDisplay: function FolderDisplayWidget__updateContextDisplay() {</span>
<a href="#l13.1096"></a><span id="l13.1096" class="difflineplus">+  _updateContextDisplay() {</span>
<a href="#l13.1097"></a><span id="l13.1097">     if (this.active) {</span>
<a href="#l13.1098"></a><span id="l13.1098">       UpdateMailToolbar(&quot;FolderDisplayWidget updating context&quot;);</span>
<a href="#l13.1099"></a><span id="l13.1099">       UpdateStatusQuota(this.displayedFolder);</span>
<a href="#l13.1100"></a><span id="l13.1100">       UpdateStatusMessageCounts(this.displayedFolder);</span>
<a href="#l13.1101"></a><span id="l13.1101"> </span>
<a href="#l13.1102"></a><span id="l13.1102">       // - mail view combo-box.</span>
<a href="#l13.1103"></a><span id="l13.1103">       this.onMailViewChanged();</span>
<a href="#l13.1104"></a><span id="l13.1104">     }</span>
<a href="#l13.1105"></a><span id="l13.1105">   },</span>
<a href="#l13.1106"></a><span id="l13.1106"> </span>
<a href="#l13.1107"></a><span id="l13.1107">   /**</span>
<a href="#l13.1108"></a><span id="l13.1108">    * @name Activation Control</span>
<a href="#l13.1109"></a><span id="l13.1109">    * @protected</span>
<a href="#l13.1110"></a><span id="l13.1110">    */</span>
<a href="#l13.1111"></a><span id="l13.1111" class="difflineminus">-  //@{</span>
<a href="#l13.1112"></a><span id="l13.1112" class="difflineplus">+  // @{</span>
<a href="#l13.1113"></a><span id="l13.1113"> </span>
<a href="#l13.1114"></a><span id="l13.1114">   /**</span>
<a href="#l13.1115"></a><span id="l13.1115">    * Run the provided notification function right now if we are 'active' (the</span>
<a href="#l13.1116"></a><span id="l13.1116">    *  currently displayed tab), otherwise queue it to be run when we become</span>
<a href="#l13.1117"></a><span id="l13.1117">    *  active.  We do this because our tabbing model uses multiplexed (reused)</span>
<a href="#l13.1118"></a><span id="l13.1118">    *  widgets, and extensions likewise depend on these global/singleton things.</span>
<a href="#l13.1119"></a><span id="l13.1119">    * If the requested notification function is already queued, it will not be</span>
<a href="#l13.1120"></a><span id="l13.1120">    *  added a second time, and the original call ordering will be maintained.</span>
<a href="#l13.1121"></a><span id="l13.1121">    *  If a new call ordering is required, the list of notifications should</span>
<a href="#l13.1122"></a><span id="l13.1122">    *  probably be reset by the 'big bang' event (new view creation?).</span>
<a href="#l13.1123"></a><span id="l13.1123">    */</span>
<a href="#l13.1124"></a><span id="l13.1124" class="difflineminus">-  _notifyWhenActive:</span>
<a href="#l13.1125"></a><span id="l13.1125" class="difflineminus">-      function FolderDisplayWidget__notifyWhenActive(aNotificationFunc) {</span>
<a href="#l13.1126"></a><span id="l13.1126" class="difflineplus">+  _notifyWhenActive(aNotificationFunc) {</span>
<a href="#l13.1127"></a><span id="l13.1127">     if (this._active) {</span>
<a href="#l13.1128"></a><span id="l13.1128">       aNotificationFunc.call(this);</span>
<a href="#l13.1129"></a><span id="l13.1129" class="difflineminus">-    }</span>
<a href="#l13.1130"></a><span id="l13.1130" class="difflineminus">-    else {</span>
<a href="#l13.1131"></a><span id="l13.1131" class="difflineminus">-      if (!this._notificationsPendingActivation.includes(aNotificationFunc))</span>
<a href="#l13.1132"></a><span id="l13.1132" class="difflineminus">-        this._notificationsPendingActivation.push(aNotificationFunc);</span>
<a href="#l13.1133"></a><span id="l13.1133" class="difflineplus">+    } else if (!this._notificationsPendingActivation.includes(aNotificationFunc)) {</span>
<a href="#l13.1134"></a><span id="l13.1134" class="difflineplus">+      this._notificationsPendingActivation.push(aNotificationFunc);</span>
<a href="#l13.1135"></a><span id="l13.1135">     }</span>
<a href="#l13.1136"></a><span id="l13.1136">   },</span>
<a href="#l13.1137"></a><span id="l13.1137"> </span>
<a href="#l13.1138"></a><span id="l13.1138">   /**</span>
<a href="#l13.1139"></a><span id="l13.1139">    * Some notifications cannot run while the FolderDisplayWidget is inactive</span>
<a href="#l13.1140"></a><span id="l13.1140">    *  (presumbly because it is in a background tab).  We accumulate those in</span>
<a href="#l13.1141"></a><span id="l13.1141">    *  _notificationsPendingActivation and then this method runs them when we</span>
<a href="#l13.1142"></a><span id="l13.1142">    *  become active again.</span>
<a href="#l13.1143"></a><span id="l13.1143">    */</span>
<a href="#l13.1144"></a><span id="l13.1144" class="difflineminus">-  _runNotificationsPendingActivation:</span>
<a href="#l13.1145"></a><span id="l13.1145" class="difflineminus">-      function FolderDisplayWidget__runNotificationsPendingActivation() {</span>
<a href="#l13.1146"></a><span id="l13.1146" class="difflineplus">+  _runNotificationsPendingActivation() {</span>
<a href="#l13.1147"></a><span id="l13.1147">     if (!this._notificationsPendingActivation.length)</span>
<a href="#l13.1148"></a><span id="l13.1148">       return;</span>
<a href="#l13.1149"></a><span id="l13.1149"> </span>
<a href="#l13.1150"></a><span id="l13.1150">     let pendingNotifications = this._notificationsPendingActivation;</span>
<a href="#l13.1151"></a><span id="l13.1151">     this._notificationsPendingActivation = [];</span>
<a href="#l13.1152"></a><span id="l13.1152">     for (let notif of pendingNotifications) {</span>
<a href="#l13.1153"></a><span id="l13.1153">       notif.call(this);</span>
<a href="#l13.1154"></a><span id="l13.1154">     }</span>
<a href="#l13.1155"></a><span id="l13.1155">   },</span>
<a href="#l13.1156"></a><span id="l13.1156"> </span>
<a href="#l13.1157"></a><span id="l13.1157" class="difflineminus">-  /// This is not guaranteed to be up to date if the folder display is active</span>
<a href="#l13.1158"></a><span id="l13.1158" class="difflineplus">+  // This is not guaranteed to be up to date if the folder display is active</span>
<a href="#l13.1159"></a><span id="l13.1159">   _folderPaneVisible: null,</span>
<a href="#l13.1160"></a><span id="l13.1160"> </span>
<a href="#l13.1161"></a><span id="l13.1161">   /**</span>
<a href="#l13.1162"></a><span id="l13.1162">    * Whether the folder pane is visible. When we're inactive, we stash the value</span>
<a href="#l13.1163"></a><span id="l13.1163">    * in |this._folderPaneVisible|.</span>
<a href="#l13.1164"></a><span id="l13.1164">    */</span>
<a href="#l13.1165"></a><span id="l13.1165">   get folderPaneVisible() {</span>
<a href="#l13.1166"></a><span id="l13.1166">     if (this._active) {</span>
<a href="#l13.1167"></a><span id="l13.1167">       let folderPaneBox = document.getElementById(&quot;folderPaneBox&quot;);</span>
<a href="#l13.1168"></a><span id="l13.1168">       if (folderPaneBox)</span>
<a href="#l13.1169"></a><span id="l13.1169">         return !folderPaneBox.collapsed;</span>
<a href="#l13.1170"></a><span id="l13.1170" class="difflineminus">-    }</span>
<a href="#l13.1171"></a><span id="l13.1171" class="difflineminus">-    else {</span>
<a href="#l13.1172"></a><span id="l13.1172" class="difflineplus">+    } else {</span>
<a href="#l13.1173"></a><span id="l13.1173">       return this._folderPaneVisible;</span>
<a href="#l13.1174"></a><span id="l13.1174">     }</span>
<a href="#l13.1175"></a><span id="l13.1175"> </span>
<a href="#l13.1176"></a><span id="l13.1176">     return null;</span>
<a href="#l13.1177"></a><span id="l13.1177">   },</span>
<a href="#l13.1178"></a><span id="l13.1178"> </span>
<a href="#l13.1179"></a><span id="l13.1179">   /**</span>
<a href="#l13.1180"></a><span id="l13.1180">    * Sets the visibility of the folder pane. This should reflect reality and</span>
<a href="#l13.1181"></a><span id="l13.1181" class="difflineat">@@ -1611,17 +1583,17 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.1182"></a><span id="l13.1182">     return this._active;</span>
<a href="#l13.1183"></a><span id="l13.1183">   },</span>
<a href="#l13.1184"></a><span id="l13.1184"> </span>
<a href="#l13.1185"></a><span id="l13.1185">   /**</span>
<a href="#l13.1186"></a><span id="l13.1186">    * Make this FolderDisplayWidget the 'active' widget by updating globals and</span>
<a href="#l13.1187"></a><span id="l13.1187">    *  linking us up to the UI widgets.  This is intended for use by the tabbing</span>
<a href="#l13.1188"></a><span id="l13.1188">    *  logic.</span>
<a href="#l13.1189"></a><span id="l13.1189">    */</span>
<a href="#l13.1190"></a><span id="l13.1190" class="difflineminus">-  makeActive: function FolderDisplayWidget_makeActive(aWasInactive) {</span>
<a href="#l13.1191"></a><span id="l13.1191" class="difflineplus">+  makeActive(aWasInactive) {</span>
<a href="#l13.1192"></a><span id="l13.1192">     let wasInactive = !this._active;</span>
<a href="#l13.1193"></a><span id="l13.1193"> </span>
<a href="#l13.1194"></a><span id="l13.1194">     // -- globals</span>
<a href="#l13.1195"></a><span id="l13.1195">     // update per-tab globals that we own</span>
<a href="#l13.1196"></a><span id="l13.1196">     gFolderDisplay = this;</span>
<a href="#l13.1197"></a><span id="l13.1197">     gMessageDisplay = this.messageDisplay;</span>
<a href="#l13.1198"></a><span id="l13.1198">     gDBView = this.view.dbView;</span>
<a href="#l13.1199"></a><span id="l13.1199">     messenger = this.messenger;</span>
<a href="#l13.1200"></a><span id="l13.1200" class="difflineat">@@ -1703,55 +1675,54 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.1201"></a><span id="l13.1201">         mailTabType._setPaneStates(this._tabInfo.mode.legalPanes,</span>
<a href="#l13.1202"></a><span id="l13.1202">           {folder: folderPaneVisible,</span>
<a href="#l13.1203"></a><span id="l13.1203">            message: this.messageDisplay.visible});</span>
<a href="#l13.1204"></a><span id="l13.1204"> </span>
<a href="#l13.1205"></a><span id="l13.1205">       // update the columns and such that live inside the thread pane</span>
<a href="#l13.1206"></a><span id="l13.1206">       this._updateThreadDisplay();</span>
<a href="#l13.1207"></a><span id="l13.1207"> </span>
<a href="#l13.1208"></a><span id="l13.1208">       this.messageDisplay.makeActive(dontReloadMessage);</span>
<a href="#l13.1209"></a><span id="l13.1209" class="difflineminus">-    }</span>
<a href="#l13.1210"></a><span id="l13.1210" class="difflineminus">-    // account central stuff when we don't have a dbview</span>
<a href="#l13.1211"></a><span id="l13.1211" class="difflineminus">-    else {</span>
<a href="#l13.1212"></a><span id="l13.1212" class="difflineplus">+    } else {</span>
<a href="#l13.1213"></a><span id="l13.1213" class="difflineplus">+      // account central stuff when we don't have a dbview</span>
<a href="#l13.1214"></a><span id="l13.1214">       this._showAccountCentral();</span>
<a href="#l13.1215"></a><span id="l13.1215">       if (this._tabInfo)</span>
<a href="#l13.1216"></a><span id="l13.1216">         mailTabType._setPaneStates(this._tabInfo.mode.accountCentralLegalPanes,</span>
<a href="#l13.1217"></a><span id="l13.1217">           {folder: folderPaneVisible});</span>
<a href="#l13.1218"></a><span id="l13.1218">     }</span>
<a href="#l13.1219"></a><span id="l13.1219"> </span>
<a href="#l13.1220"></a><span id="l13.1220">     this._updateContextDisplay();</span>
<a href="#l13.1221"></a><span id="l13.1221">   },</span>
<a href="#l13.1222"></a><span id="l13.1222"> </span>
<a href="#l13.1223"></a><span id="l13.1223">   /**</span>
<a href="#l13.1224"></a><span id="l13.1224">    * Cause the displayDeck to display the thread pane.</span>
<a href="#l13.1225"></a><span id="l13.1225">    */</span>
<a href="#l13.1226"></a><span id="l13.1226" class="difflineminus">-  _showThreadPane: function FolderDisplayWidget__showThreadPane() {</span>
<a href="#l13.1227"></a><span id="l13.1227" class="difflineplus">+  _showThreadPane() {</span>
<a href="#l13.1228"></a><span id="l13.1228">     document.getElementById(&quot;displayDeck&quot;).selectedPanel =</span>
<a href="#l13.1229"></a><span id="l13.1229">       document.getElementById(&quot;threadPaneBox&quot;);</span>
<a href="#l13.1230"></a><span id="l13.1230">   },</span>
<a href="#l13.1231"></a><span id="l13.1231"> </span>
<a href="#l13.1232"></a><span id="l13.1232">   /**</span>
<a href="#l13.1233"></a><span id="l13.1233">    * Cause the displayDeck to display the (preference configurable) account</span>
<a href="#l13.1234"></a><span id="l13.1234">    *  central page.</span>
<a href="#l13.1235"></a><span id="l13.1235">    */</span>
<a href="#l13.1236"></a><span id="l13.1236" class="difflineminus">-  _showAccountCentral: function FolderDisplayWidget__showAccountCentral() {</span>
<a href="#l13.1237"></a><span id="l13.1237" class="difflineplus">+  _showAccountCentral() {</span>
<a href="#l13.1238"></a><span id="l13.1238">     var accountBox = document.getElementById(&quot;accountCentralBox&quot;);</span>
<a href="#l13.1239"></a><span id="l13.1239">     document.getElementById(&quot;displayDeck&quot;).selectedPanel = accountBox;</span>
<a href="#l13.1240"></a><span id="l13.1240">     var prefName = &quot;mailnews.account_central_page.url&quot;;</span>
<a href="#l13.1241"></a><span id="l13.1241">     // oh yeah, 'pref' is a global all right.</span>
<a href="#l13.1242"></a><span id="l13.1242">     var acctCentralPage =</span>
<a href="#l13.1243"></a><span id="l13.1243">       Services.prefs.getComplexValue(prefName,</span>
<a href="#l13.1244"></a><span id="l13.1244">                                      Ci.nsIPrefLocalizedString).data;</span>
<a href="#l13.1245"></a><span id="l13.1245" class="difflineminus">-    window.frames[&quot;accountCentralPane&quot;].location.href = acctCentralPage;</span>
<a href="#l13.1246"></a><span id="l13.1246" class="difflineplus">+    window.frames.accountCentralPane.location.href = acctCentralPage;</span>
<a href="#l13.1247"></a><span id="l13.1247">   },</span>
<a href="#l13.1248"></a><span id="l13.1248"> </span>
<a href="#l13.1249"></a><span id="l13.1249">   /**</span>
<a href="#l13.1250"></a><span id="l13.1250">    * Call this when the tab using us is being hidden.</span>
<a href="#l13.1251"></a><span id="l13.1251">    */</span>
<a href="#l13.1252"></a><span id="l13.1252" class="difflineminus">-  makeInactive: function FolderDisplayWidget_makeInactive() {</span>
<a href="#l13.1253"></a><span id="l13.1253" class="difflineplus">+  makeInactive() {</span>
<a href="#l13.1254"></a><span id="l13.1254">     // - things to do before we mark ourselves inactive (because they depend on</span>
<a href="#l13.1255"></a><span id="l13.1255">     //   us being active)</span>
<a href="#l13.1256"></a><span id="l13.1256"> </span>
<a href="#l13.1257"></a><span id="l13.1257">     // getColumnStates returns _savedColumnStates when we are inactive (and is</span>
<a href="#l13.1258"></a><span id="l13.1258">     //  used by _saveColumnStates) so we must do this before marking inactive.</span>
<a href="#l13.1259"></a><span id="l13.1259">     this._saveColumnStates();</span>
<a href="#l13.1260"></a><span id="l13.1260"> </span>
<a href="#l13.1261"></a><span id="l13.1261">     // - mark us inactive</span>
<a href="#l13.1262"></a><span id="l13.1262" class="difflineat">@@ -1770,30 +1741,29 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.1263"></a><span id="l13.1263">       this.messagePaneCollapsed =</span>
<a href="#l13.1264"></a><span id="l13.1264">         document.getElementById(&quot;messagepaneboxwrapper&quot;).collapsed;</span>
<a href="#l13.1265"></a><span id="l13.1265"> </span>
<a href="#l13.1266"></a><span id="l13.1266">       this.hookUpFakeTreeBox(true);</span>
<a href="#l13.1267"></a><span id="l13.1267">     }</span>
<a href="#l13.1268"></a><span id="l13.1268"> </span>
<a href="#l13.1269"></a><span id="l13.1269">     this.messageDisplay.makeInactive();</span>
<a href="#l13.1270"></a><span id="l13.1270">   },</span>
<a href="#l13.1271"></a><span id="l13.1271" class="difflineminus">-  //@}</span>
<a href="#l13.1272"></a><span id="l13.1272" class="difflineplus">+  // @}</span>
<a href="#l13.1273"></a><span id="l13.1273"> </span>
<a href="#l13.1274"></a><span id="l13.1274">   /**</span>
<a href="#l13.1275"></a><span id="l13.1275">    * Called when we want to &quot;disable&quot; the real treeBox for a while and hook up</span>
<a href="#l13.1276"></a><span id="l13.1276">    * the fake tree box to the db view. This also takes care of our</span>
<a href="#l13.1277"></a><span id="l13.1277">    * treeSelection object.</span>
<a href="#l13.1278"></a><span id="l13.1278">    *</span>
<a href="#l13.1279"></a><span id="l13.1279">    * @param aNullRealTreeBoxView true if we want to null out the real tree box.</span>
<a href="#l13.1280"></a><span id="l13.1280">    *          We don't want to null out the view if we're opening a background</span>
<a href="#l13.1281"></a><span id="l13.1281">    *          tab, for example.</span>
<a href="#l13.1282"></a><span id="l13.1282">    * @private</span>
<a href="#l13.1283"></a><span id="l13.1283">    */</span>
<a href="#l13.1284"></a><span id="l13.1284" class="difflineminus">-  hookUpFakeTreeBox: function FolderDisplayWidget_hookUpFakeTreeBox(</span>
<a href="#l13.1285"></a><span id="l13.1285" class="difflineminus">-                         aNullRealTreeBoxView) {</span>
<a href="#l13.1286"></a><span id="l13.1286" class="difflineplus">+  hookUpFakeTreeBox(aNullRealTreeBoxView) {</span>
<a href="#l13.1287"></a><span id="l13.1287">     // save off the tree selection object.  the nsTreeBodyFrame will make the</span>
<a href="#l13.1288"></a><span id="l13.1288">     //  view forget about it when our view is removed, so it's up to us to</span>
<a href="#l13.1289"></a><span id="l13.1289">     //  save it.</span>
<a href="#l13.1290"></a><span id="l13.1290">     // We use this.treeSelection instead of this.view.dbView.selection here,</span>
<a href="#l13.1291"></a><span id="l13.1291">     //  so that we get the fake tree selection if we have it.</span>
<a href="#l13.1292"></a><span id="l13.1292">     let treeSelection = this.treeSelection;</span>
<a href="#l13.1293"></a><span id="l13.1293">     // if we want to, make the tree forget about the view right now so we can</span>
<a href="#l13.1294"></a><span id="l13.1294">     //  tell the db view about its selection object so it can try and keep it</span>
<a href="#l13.1295"></a><span id="l13.1295" class="difflineat">@@ -1807,86 +1777,84 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.1296"></a><span id="l13.1296">     this._fakeTreeBox.view = this.view.dbView;</span>
<a href="#l13.1297"></a><span id="l13.1297">     this.view.dbView.setTree(this._fakeTreeBox);</span>
<a href="#l13.1298"></a><span id="l13.1298">     treeSelection.tree = this._fakeTreeBox;</span>
<a href="#l13.1299"></a><span id="l13.1299">   },</span>
<a href="#l13.1300"></a><span id="l13.1300"> </span>
<a href="#l13.1301"></a><span id="l13.1301">   /**</span>
<a href="#l13.1302"></a><span id="l13.1302">    * @name Command Support</span>
<a href="#l13.1303"></a><span id="l13.1303">    */</span>
<a href="#l13.1304"></a><span id="l13.1304" class="difflineminus">-  //@{</span>
<a href="#l13.1305"></a><span id="l13.1305" class="difflineplus">+  // @{</span>
<a href="#l13.1306"></a><span id="l13.1306"> </span>
<a href="#l13.1307"></a><span id="l13.1307">   /**</span>
<a href="#l13.1308"></a><span id="l13.1308">    * @return true if there is a db view and the command is enabled on the view.</span>
<a href="#l13.1309"></a><span id="l13.1309">    *  This function hides some of the XPCOM-odditities of the getCommandStatus</span>
<a href="#l13.1310"></a><span id="l13.1310">    *  call.</span>
<a href="#l13.1311"></a><span id="l13.1311">    */</span>
<a href="#l13.1312"></a><span id="l13.1312" class="difflineminus">-  getCommandStatus: function FolderDisplayWidget_getCommandStatus(</span>
<a href="#l13.1313"></a><span id="l13.1313" class="difflineminus">-      aCommandType, aEnabledObj, aCheckStatusObj) {</span>
<a href="#l13.1314"></a><span id="l13.1314" class="difflineplus">+  getCommandStatus(aCommandType, aEnabledObj, aCheckStatusObj) {</span>
<a href="#l13.1315"></a><span id="l13.1315">     // no view means not enabled</span>
<a href="#l13.1316"></a><span id="l13.1316">     if (!this.view.dbView)</span>
<a href="#l13.1317"></a><span id="l13.1317">       return false;</span>
<a href="#l13.1318"></a><span id="l13.1318">     let enabledObj = {}, checkStatusObj = {};</span>
<a href="#l13.1319"></a><span id="l13.1319">     this.view.dbView.getCommandStatus(aCommandType, enabledObj, checkStatusObj);</span>
<a href="#l13.1320"></a><span id="l13.1320">     return enabledObj.value;</span>
<a href="#l13.1321"></a><span id="l13.1321">   },</span>
<a href="#l13.1322"></a><span id="l13.1322"> </span>
<a href="#l13.1323"></a><span id="l13.1323">   /**</span>
<a href="#l13.1324"></a><span id="l13.1324">    * Make code cleaner by allowing peoples to call doCommand on us rather than</span>
<a href="#l13.1325"></a><span id="l13.1325">    *  having to do folderDisplayWidget.view.dbView.doCommand.</span>
<a href="#l13.1326"></a><span id="l13.1326">    *</span>
<a href="#l13.1327"></a><span id="l13.1327">    * @param aCommandName The command name to invoke.</span>
<a href="#l13.1328"></a><span id="l13.1328">    */</span>
<a href="#l13.1329"></a><span id="l13.1329" class="difflineminus">-  doCommand: function FolderDisplayWidget_doCommand(aCommandName) {</span>
<a href="#l13.1330"></a><span id="l13.1330" class="difflineplus">+  doCommand(aCommandName) {</span>
<a href="#l13.1331"></a><span id="l13.1331">     return this.view.dbView &amp;&amp; this.view.dbView.doCommand(aCommandName);</span>
<a href="#l13.1332"></a><span id="l13.1332">   },</span>
<a href="#l13.1333"></a><span id="l13.1333"> </span>
<a href="#l13.1334"></a><span id="l13.1334">   /**</span>
<a href="#l13.1335"></a><span id="l13.1335">    * Make code cleaner by allowing peoples to call doCommandWithFolder on us</span>
<a href="#l13.1336"></a><span id="l13.1336">    *  rather than having to do:</span>
<a href="#l13.1337"></a><span id="l13.1337">    *  folderDisplayWidget.view.dbView.doCommandWithFolder.</span>
<a href="#l13.1338"></a><span id="l13.1338">    *</span>
<a href="#l13.1339"></a><span id="l13.1339">    * @param aCommandName The command name to invoke.</span>
<a href="#l13.1340"></a><span id="l13.1340">    * @param aFolder The folder context for the command.</span>
<a href="#l13.1341"></a><span id="l13.1341">    */</span>
<a href="#l13.1342"></a><span id="l13.1342" class="difflineminus">-  doCommandWithFolder: function FolderDisplayWidget_doCommandWithFolder(</span>
<a href="#l13.1343"></a><span id="l13.1343" class="difflineminus">-      aCommandName, aFolder) {</span>
<a href="#l13.1344"></a><span id="l13.1344" class="difflineplus">+  doCommandWithFolder(aCommandName, aFolder) {</span>
<a href="#l13.1345"></a><span id="l13.1345">     return this.view.dbView &amp;&amp;</span>
<a href="#l13.1346"></a><span id="l13.1346">            this.view.dbView.doCommandWithFolder(aCommandName, aFolder);</span>
<a href="#l13.1347"></a><span id="l13.1347">   },</span>
<a href="#l13.1348"></a><span id="l13.1348" class="difflineminus">-  //@}</span>
<a href="#l13.1349"></a><span id="l13.1349" class="difflineplus">+  // @}</span>
<a href="#l13.1350"></a><span id="l13.1350"> </span>
<a href="#l13.1351"></a><span id="l13.1351">   /**</span>
<a href="#l13.1352"></a><span id="l13.1352">    * @return true when account central is being displayed.</span>
<a href="#l13.1353"></a><span id="l13.1353">    * @groupName Displayed</span>
<a href="#l13.1354"></a><span id="l13.1354">    */</span>
<a href="#l13.1355"></a><span id="l13.1355">   get isAccountCentralDisplayed() {</span>
<a href="#l13.1356"></a><span id="l13.1356">     return (this.view.dbView == null);</span>
<a href="#l13.1357"></a><span id="l13.1357">   },</span>
<a href="#l13.1358"></a><span id="l13.1358"> </span>
<a href="#l13.1359"></a><span id="l13.1359">   /**</span>
<a href="#l13.1360"></a><span id="l13.1360">    * @name Navigation</span>
<a href="#l13.1361"></a><span id="l13.1361">    * @protected</span>
<a href="#l13.1362"></a><span id="l13.1362">    */</span>
<a href="#l13.1363"></a><span id="l13.1363" class="difflineminus">-  //@{</span>
<a href="#l13.1364"></a><span id="l13.1364" class="difflineplus">+  // @{</span>
<a href="#l13.1365"></a><span id="l13.1365"> </span>
<a href="#l13.1366"></a><span id="l13.1366">   /**</span>
<a href="#l13.1367"></a><span id="l13.1367">    * Navigate using nsMsgNavigationType rules and ensuring the resulting row is</span>
<a href="#l13.1368"></a><span id="l13.1368">    *  visible.  This is trickier than it used to be because we now support</span>
<a href="#l13.1369"></a><span id="l13.1369">    *  treating collapsed threads as the set of all the messages in the collapsed</span>
<a href="#l13.1370"></a><span id="l13.1370">    *  thread rather than just the root message in that thread.</span>
<a href="#l13.1371"></a><span id="l13.1371">    *</span>
<a href="#l13.1372"></a><span id="l13.1372">    * @param {nsMsgNavigationType} aNavType navigation command.</span>
<a href="#l13.1373"></a><span id="l13.1373">    * @param {Boolean} [aSelect=true] should we select the message if we find</span>
<a href="#l13.1374"></a><span id="l13.1374">    *     one?</span>
<a href="#l13.1375"></a><span id="l13.1375">    *</span>
<a href="#l13.1376"></a><span id="l13.1376">    * @return true if the navigation constraint matched anything, false if not.</span>
<a href="#l13.1377"></a><span id="l13.1377">    *     We will have navigated if true, we will have done nothing if false.</span>
<a href="#l13.1378"></a><span id="l13.1378">    */</span>
<a href="#l13.1379"></a><span id="l13.1379" class="difflineminus">-  navigate: function FolderDisplayWidget_navigate(aNavType, aSelect) {</span>
<a href="#l13.1380"></a><span id="l13.1380" class="difflineplus">+  navigate(aNavType, aSelect) {</span>
<a href="#l13.1381"></a><span id="l13.1381">     if (aSelect === undefined)</span>
<a href="#l13.1382"></a><span id="l13.1382">       aSelect = true;</span>
<a href="#l13.1383"></a><span id="l13.1383">     let resultKeyObj = {}, resultIndexObj = {}, threadIndexObj = {};</span>
<a href="#l13.1384"></a><span id="l13.1384"> </span>
<a href="#l13.1385"></a><span id="l13.1385">     let summarizeSelection = this.summarizeSelectionInFolder;</span>
<a href="#l13.1386"></a><span id="l13.1386"> </span>
<a href="#l13.1387"></a><span id="l13.1387">     let treeSelection = this.treeSelection; // potentially magic getter</span>
<a href="#l13.1388"></a><span id="l13.1388">     let currentIndex = treeSelection ? treeSelection.currentIndex : 0;</span>
<a href="#l13.1389"></a><span id="l13.1389" class="difflineat">@@ -1897,18 +1865,17 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.1390"></a><span id="l13.1390">     // the top level message, without using viewNavigate.</span>
<a href="#l13.1391"></a><span id="l13.1391">     if (summarizeSelection &amp;&amp;</span>
<a href="#l13.1392"></a><span id="l13.1392">         aNavType == nsMsgNavigationType.nextUnreadMessage &amp;&amp;</span>
<a href="#l13.1393"></a><span id="l13.1393">         currentIndex != -1 &amp;&amp;</span>
<a href="#l13.1394"></a><span id="l13.1394">         this.view.isCollapsedThreadAtIndex(currentIndex) &amp;&amp;</span>
<a href="#l13.1395"></a><span id="l13.1395">         !(this.view.dbView.getFlagsAt(currentIndex) &amp;</span>
<a href="#l13.1396"></a><span id="l13.1396">           Ci.nsMsgMessageFlags.Read)) {</span>
<a href="#l13.1397"></a><span id="l13.1397">       viewIndex = currentIndex;</span>
<a href="#l13.1398"></a><span id="l13.1398" class="difflineminus">-    }</span>
<a href="#l13.1399"></a><span id="l13.1399" class="difflineminus">-    else {</span>
<a href="#l13.1400"></a><span id="l13.1400" class="difflineplus">+    } else {</span>
<a href="#l13.1401"></a><span id="l13.1401">       // always 'wrap' because the start index is relative to the selection.</span>
<a href="#l13.1402"></a><span id="l13.1402">       // (keep in mind that many forms of navigation do not care about the</span>
<a href="#l13.1403"></a><span id="l13.1403">       //  starting position or 'wrap' at all; for example, firstNew just finds</span>
<a href="#l13.1404"></a><span id="l13.1404">       //  the first new message.)</span>
<a href="#l13.1405"></a><span id="l13.1405">       // allegedly this does tree-expansion for us.</span>
<a href="#l13.1406"></a><span id="l13.1406">       this.view.dbView.viewNavigate(aNavType, resultKeyObj, resultIndexObj,</span>
<a href="#l13.1407"></a><span id="l13.1407">                                     threadIndexObj, true);</span>
<a href="#l13.1408"></a><span id="l13.1408">       viewIndex = resultIndexObj.value;</span>
<a href="#l13.1409"></a><span id="l13.1409" class="difflineat">@@ -1932,35 +1899,35 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.1410"></a><span id="l13.1410">     return true;</span>
<a href="#l13.1411"></a><span id="l13.1411">   },</span>
<a href="#l13.1412"></a><span id="l13.1412"> </span>
<a href="#l13.1413"></a><span id="l13.1413">   /**</span>
<a href="#l13.1414"></a><span id="l13.1414">    * Push a call to |navigate| to be what we do once we successfully open the</span>
<a href="#l13.1415"></a><span id="l13.1415">    *  next folder.  This is intended to be used by cross-folder navigation</span>
<a href="#l13.1416"></a><span id="l13.1416">    *  code.  It should call this method before triggering the folder change.</span>
<a href="#l13.1417"></a><span id="l13.1417">    */</span>
<a href="#l13.1418"></a><span id="l13.1418" class="difflineminus">-  pushNavigation: function FolderDisplayWidget_navigate(aNavType, aSelect) {</span>
<a href="#l13.1419"></a><span id="l13.1419" class="difflineplus">+  pushNavigation(aNavType, aSelect) {</span>
<a href="#l13.1420"></a><span id="l13.1420">     this._pendingNavigation = [aNavType, aSelect];</span>
<a href="#l13.1421"></a><span id="l13.1421">   },</span>
<a href="#l13.1422"></a><span id="l13.1422"> </span>
<a href="#l13.1423"></a><span id="l13.1423">   /**</span>
<a href="#l13.1424"></a><span id="l13.1424">    * @return true if we are able to navigate using the given navigation type at</span>
<a href="#l13.1425"></a><span id="l13.1425">    *  this time.</span>
<a href="#l13.1426"></a><span id="l13.1426">    */</span>
<a href="#l13.1427"></a><span id="l13.1427" class="difflineminus">-  navigateStatus: function FolderDisplayWidget_navigateStatus(aNavType) {</span>
<a href="#l13.1428"></a><span id="l13.1428" class="difflineplus">+  navigateStatus(aNavType) {</span>
<a href="#l13.1429"></a><span id="l13.1429">     if (!this.view.dbView)</span>
<a href="#l13.1430"></a><span id="l13.1430">       return false;</span>
<a href="#l13.1431"></a><span id="l13.1431">     return this.view.dbView.navigateStatus(aNavType);</span>
<a href="#l13.1432"></a><span id="l13.1432">   },</span>
<a href="#l13.1433"></a><span id="l13.1433" class="difflineminus">-  //@}</span>
<a href="#l13.1434"></a><span id="l13.1434" class="difflineplus">+  // @}</span>
<a href="#l13.1435"></a><span id="l13.1435"> </span>
<a href="#l13.1436"></a><span id="l13.1436">   /**</span>
<a href="#l13.1437"></a><span id="l13.1437">    * @name Selection</span>
<a href="#l13.1438"></a><span id="l13.1438">    */</span>
<a href="#l13.1439"></a><span id="l13.1439" class="difflineminus">-  //@{</span>
<a href="#l13.1440"></a><span id="l13.1440" class="difflineplus">+  // @{</span>
<a href="#l13.1441"></a><span id="l13.1441"> </span>
<a href="#l13.1442"></a><span id="l13.1442">   /**</span>
<a href="#l13.1443"></a><span id="l13.1443">    * @returns the message header for the first selected message, or null if</span>
<a href="#l13.1444"></a><span id="l13.1444">    *  there is no selected message.</span>
<a href="#l13.1445"></a><span id="l13.1445">    *</span>
<a href="#l13.1446"></a><span id="l13.1446">    * If the user has right-clicked on a message, this method will return that</span>
<a href="#l13.1447"></a><span id="l13.1447">    *  message and not the 'current index' (the dude with the dotted selection</span>
<a href="#l13.1448"></a><span id="l13.1448">    *  rectangle around him.)  If you instead always want the currently</span>
<a href="#l13.1449"></a><span id="l13.1449" class="difflineat">@@ -2155,18 +2122,17 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.1450"></a><span id="l13.1450">           this.displayedFolder.server</span>
<a href="#l13.1451"></a><span id="l13.1451">         );</span>
<a href="#l13.1452"></a><span id="l13.1452"> </span>
<a href="#l13.1453"></a><span id="l13.1453">         const nsIMsgIdentity = Ci.nsIMsgIdentity;</span>
<a href="#l13.1454"></a><span id="l13.1454">         let allEnabled = undefined;</span>
<a href="#l13.1455"></a><span id="l13.1455">         for (let identity of fixIterator(serverIdentities, nsIMsgIdentity)) {</span>
<a href="#l13.1456"></a><span id="l13.1456">           if (allEnabled === undefined) {</span>
<a href="#l13.1457"></a><span id="l13.1457">             allEnabled = identity.archiveEnabled;</span>
<a href="#l13.1458"></a><span id="l13.1458" class="difflineminus">-          }</span>
<a href="#l13.1459"></a><span id="l13.1459" class="difflineminus">-          else if (identity.archiveEnabled != allEnabled) {</span>
<a href="#l13.1460"></a><span id="l13.1460" class="difflineplus">+          } else if (identity.archiveEnabled != allEnabled) {</span>
<a href="#l13.1461"></a><span id="l13.1461">             allEnabled = undefined;</span>
<a href="#l13.1462"></a><span id="l13.1462">             break;</span>
<a href="#l13.1463"></a><span id="l13.1463">           }</span>
<a href="#l13.1464"></a><span id="l13.1464">         }</span>
<a href="#l13.1465"></a><span id="l13.1465">         if (allEnabled !== undefined)</span>
<a href="#l13.1466"></a><span id="l13.1466">           return allEnabled;</span>
<a href="#l13.1467"></a><span id="l13.1467">       }</span>
<a href="#l13.1468"></a><span id="l13.1468">     }</span>
<a href="#l13.1469"></a><span id="l13.1469" class="difflineat">@@ -2196,58 +2162,56 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.1470"></a><span id="l13.1470">     }</span>
<a href="#l13.1471"></a><span id="l13.1471">     return true;</span>
<a href="#l13.1472"></a><span id="l13.1472">   },</span>
<a href="#l13.1473"></a><span id="l13.1473"> </span>
<a href="#l13.1474"></a><span id="l13.1474">   /**</span>
<a href="#l13.1475"></a><span id="l13.1475">    * Clear the tree selection, making sure the message pane is cleared and</span>
<a href="#l13.1476"></a><span id="l13.1476">    *  the context display (toolbars, etc.) are updated.</span>
<a href="#l13.1477"></a><span id="l13.1477">    */</span>
<a href="#l13.1478"></a><span id="l13.1478" class="difflineminus">-  clearSelection: function FolderDisplayWidget_clearSelection() {</span>
<a href="#l13.1479"></a><span id="l13.1479" class="difflineplus">+  clearSelection() {</span>
<a href="#l13.1480"></a><span id="l13.1480">     let treeSelection = this.treeSelection; // potentially magic getter</span>
<a href="#l13.1481"></a><span id="l13.1481">     if (!treeSelection)</span>
<a href="#l13.1482"></a><span id="l13.1482">       return;</span>
<a href="#l13.1483"></a><span id="l13.1483">     treeSelection.clearSelection();</span>
<a href="#l13.1484"></a><span id="l13.1484">     this.messageDisplay.clearDisplay();</span>
<a href="#l13.1485"></a><span id="l13.1485">     this._updateContextDisplay();</span>
<a href="#l13.1486"></a><span id="l13.1486">   },</span>
<a href="#l13.1487"></a><span id="l13.1487"> </span>
<a href="#l13.1488"></a><span id="l13.1488" class="difflineminus">-  /// Whether we're about to select a message</span>
<a href="#l13.1489"></a><span id="l13.1489" class="difflineplus">+  // Whether we're about to select a message</span>
<a href="#l13.1490"></a><span id="l13.1490">   _aboutToSelectMessage: false,</span>
<a href="#l13.1491"></a><span id="l13.1491"> </span>
<a href="#l13.1492"></a><span id="l13.1492">   /**</span>
<a href="#l13.1493"></a><span id="l13.1493">    * This needs to be called to let us know that a selectMessage or equivalent</span>
<a href="#l13.1494"></a><span id="l13.1494">    * is coming  up right after a show() call, so that we know that a double</span>
<a href="#l13.1495"></a><span id="l13.1495">    * message load won't be happening.</span>
<a href="#l13.1496"></a><span id="l13.1496">    *</span>
<a href="#l13.1497"></a><span id="l13.1497">    * This can be assumed to be idempotent.</span>
<a href="#l13.1498"></a><span id="l13.1498">    */</span>
<a href="#l13.1499"></a><span id="l13.1499" class="difflineminus">-  selectMessageComingUp: function FolderDisplayWidget_selectMessageComingUp() {</span>
<a href="#l13.1500"></a><span id="l13.1500" class="difflineplus">+  selectMessageComingUp() {</span>
<a href="#l13.1501"></a><span id="l13.1501">     this._aboutToSelectMessage = true;</span>
<a href="#l13.1502"></a><span id="l13.1502">   },</span>
<a href="#l13.1503"></a><span id="l13.1503"> </span>
<a href="#l13.1504"></a><span id="l13.1504">   /**</span>
<a href="#l13.1505"></a><span id="l13.1505">    * Select a message for display by header.  Attempt to select the message</span>
<a href="#l13.1506"></a><span id="l13.1506">    *  right now.  If we were unable to find it, update our saved selection</span>
<a href="#l13.1507"></a><span id="l13.1507">    *  to want to display the message.  Threads are expanded to find the header.</span>
<a href="#l13.1508"></a><span id="l13.1508">    *</span>
<a href="#l13.1509"></a><span id="l13.1509">    * @param aMsgHdr The message header to select for display.</span>
<a href="#l13.1510"></a><span id="l13.1510">    * @param [aForceSelect] If the message is not in the view and this is true,</span>
<a href="#l13.1511"></a><span id="l13.1511">    *                       we will drop any applied view filters to look for the</span>
<a href="#l13.1512"></a><span id="l13.1512">    *                       message. The dropping of view filters is persistent,</span>
<a href="#l13.1513"></a><span id="l13.1513">    *                       so use with care. Defaults to false.</span>
<a href="#l13.1514"></a><span id="l13.1514">    */</span>
<a href="#l13.1515"></a><span id="l13.1515" class="difflineminus">-  selectMessage: function FolderDisplayWidget_selectMessage(aMsgHdr,</span>
<a href="#l13.1516"></a><span id="l13.1516" class="difflineminus">-      aForceSelect) {</span>
<a href="#l13.1517"></a><span id="l13.1517" class="difflineplus">+  selectMessage(aMsgHdr, aForceSelect) {</span>
<a href="#l13.1518"></a><span id="l13.1518">     let viewIndex = this.view.getViewIndexForMsgHdr(aMsgHdr, aForceSelect);</span>
<a href="#l13.1519"></a><span id="l13.1519">     if (viewIndex != nsMsgViewIndex_None) {</span>
<a href="#l13.1520"></a><span id="l13.1520">       this._savedSelection = null;</span>
<a href="#l13.1521"></a><span id="l13.1521">       this.selectViewIndex(viewIndex);</span>
<a href="#l13.1522"></a><span id="l13.1522" class="difflineminus">-    }</span>
<a href="#l13.1523"></a><span id="l13.1523" class="difflineminus">-    else {</span>
<a href="#l13.1524"></a><span id="l13.1524" class="difflineplus">+    } else {</span>
<a href="#l13.1525"></a><span id="l13.1525">       this._savedSelection = {messages: [{messageId: aMsgHdr.messageId}],</span>
<a href="#l13.1526"></a><span id="l13.1526">                               forceSelect: aForceSelect};</span>
<a href="#l13.1527"></a><span id="l13.1527">       // queue the selection to be restored once we become active if we are not</span>
<a href="#l13.1528"></a><span id="l13.1528">       //  active.</span>
<a href="#l13.1529"></a><span id="l13.1529">       if (!this.active)</span>
<a href="#l13.1530"></a><span id="l13.1530">         this._notifyWhenActive(this._restoreSelection);</span>
<a href="#l13.1531"></a><span id="l13.1531">     }</span>
<a href="#l13.1532"></a><span id="l13.1532"> </span>
<a href="#l13.1533"></a><span id="l13.1533" class="difflineat">@@ -2269,39 +2233,37 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.1534"></a><span id="l13.1534">    *                       message. The dropping of view filters is persistent,</span>
<a href="#l13.1535"></a><span id="l13.1535">    *                       so use with care. Defaults to false.</span>
<a href="#l13.1536"></a><span id="l13.1536">    * @param aDoNotNeedToFindAll If true (can be omitted and left undefined), we</span>
<a href="#l13.1537"></a><span id="l13.1537">    *     do not attempt to save the selection for future use.  This is intended</span>
<a href="#l13.1538"></a><span id="l13.1538">    *     for use by the _restoreSelection call which is the end-of-the-line for</span>
<a href="#l13.1539"></a><span id="l13.1539">    *     restoring the selection.  (Once it gets called all of our messages</span>
<a href="#l13.1540"></a><span id="l13.1540">    *     should have already been loaded.)</span>
<a href="#l13.1541"></a><span id="l13.1541">    */</span>
<a href="#l13.1542"></a><span id="l13.1542" class="difflineminus">-  selectMessages: function FolderDisplayWidget_selectMessages(</span>
<a href="#l13.1543"></a><span id="l13.1543" class="difflineminus">-      aMessages, aForceSelect, aDoNotNeedToFindAll) {</span>
<a href="#l13.1544"></a><span id="l13.1544" class="difflineplus">+  selectMessages(aMessages, aForceSelect, aDoNotNeedToFindAll) {</span>
<a href="#l13.1545"></a><span id="l13.1545">     let treeSelection = this.treeSelection; // potentially magic getter</span>
<a href="#l13.1546"></a><span id="l13.1546">     let foundAll = true;</span>
<a href="#l13.1547"></a><span id="l13.1547">     if (treeSelection) {</span>
<a href="#l13.1548"></a><span id="l13.1548">       let minRow = null, maxRow = null;</span>
<a href="#l13.1549"></a><span id="l13.1549"> </span>
<a href="#l13.1550"></a><span id="l13.1550">       treeSelection.selectEventsSuppressed = true;</span>
<a href="#l13.1551"></a><span id="l13.1551">       treeSelection.clearSelection();</span>
<a href="#l13.1552"></a><span id="l13.1552"> </span>
<a href="#l13.1553"></a><span id="l13.1553">       for (let msgHdr of aMessages) {</span>
<a href="#l13.1554"></a><span id="l13.1554">         let viewIndex = this.view.getViewIndexForMsgHdr(msgHdr, aForceSelect);</span>
<a href="#l13.1555"></a><span id="l13.1555"> </span>
<a href="#l13.1556"></a><span id="l13.1556">         if (viewIndex != nsMsgViewIndex_None) {</span>
<a href="#l13.1557"></a><span id="l13.1557">           if (minRow == null || viewIndex &lt; minRow)</span>
<a href="#l13.1558"></a><span id="l13.1558">             minRow = viewIndex;</span>
<a href="#l13.1559"></a><span id="l13.1559" class="difflineminus">-          if (maxRow == null || viewIndex &gt; maxRow )</span>
<a href="#l13.1560"></a><span id="l13.1560" class="difflineplus">+          if (maxRow == null || viewIndex &gt; maxRow)</span>
<a href="#l13.1561"></a><span id="l13.1561">             maxRow = viewIndex;</span>
<a href="#l13.1562"></a><span id="l13.1562">           // nsTreeSelection is actually very clever about doing this</span>
<a href="#l13.1563"></a><span id="l13.1563">           //  efficiently.</span>
<a href="#l13.1564"></a><span id="l13.1564">           treeSelection.rangedSelect(viewIndex, viewIndex, true);</span>
<a href="#l13.1565"></a><span id="l13.1565" class="difflineminus">-        }</span>
<a href="#l13.1566"></a><span id="l13.1566" class="difflineminus">-        else {</span>
<a href="#l13.1567"></a><span id="l13.1567" class="difflineplus">+        } else {</span>
<a href="#l13.1568"></a><span id="l13.1568">           foundAll = false;</span>
<a href="#l13.1569"></a><span id="l13.1569">         }</span>
<a href="#l13.1570"></a><span id="l13.1570"> </span>
<a href="#l13.1571"></a><span id="l13.1571">         // make sure the selection is as visible as possible</span>
<a href="#l13.1572"></a><span id="l13.1572">         if (minRow != null)</span>
<a href="#l13.1573"></a><span id="l13.1573">           this.ensureRowRangeIsVisible(minRow, maxRow);</span>
<a href="#l13.1574"></a><span id="l13.1574">       }</span>
<a href="#l13.1575"></a><span id="l13.1575"> </span>
<a href="#l13.1576"></a><span id="l13.1576" class="difflineat">@@ -2317,31 +2279,31 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.1577"></a><span id="l13.1577"> </span>
<a href="#l13.1578"></a><span id="l13.1578">     // Two cases.</span>
<a href="#l13.1579"></a><span id="l13.1579">     // 1. The tree selection isn't there at all.</span>
<a href="#l13.1580"></a><span id="l13.1580">     // 2. The tree selection is there, and we needed to find all messages, but</span>
<a href="#l13.1581"></a><span id="l13.1581">     //    we didn't.</span>
<a href="#l13.1582"></a><span id="l13.1582">     if (!treeSelection || (!aDoNotNeedToFindAll &amp;&amp; !foundAll)) {</span>
<a href="#l13.1583"></a><span id="l13.1583">       this._savedSelection = {</span>
<a href="#l13.1584"></a><span id="l13.1584">         messages: aMessages.map(msgHdr =&gt; ({messageId: msgHdr.messageId})),</span>
<a href="#l13.1585"></a><span id="l13.1585" class="difflineminus">-        forceSelect: aForceSelect</span>
<a href="#l13.1586"></a><span id="l13.1586" class="difflineplus">+        forceSelect: aForceSelect,</span>
<a href="#l13.1587"></a><span id="l13.1587">       };</span>
<a href="#l13.1588"></a><span id="l13.1588">       if (!this.active)</span>
<a href="#l13.1589"></a><span id="l13.1589">         this._notifyWhenActive(this._restoreSelection);</span>
<a href="#l13.1590"></a><span id="l13.1590">     }</span>
<a href="#l13.1591"></a><span id="l13.1591">   },</span>
<a href="#l13.1592"></a><span id="l13.1592"> </span>
<a href="#l13.1593"></a><span id="l13.1593">   /**</span>
<a href="#l13.1594"></a><span id="l13.1594">    * Select the message at view index.</span>
<a href="#l13.1595"></a><span id="l13.1595">    *</span>
<a href="#l13.1596"></a><span id="l13.1596">    * @param aViewIndex The view index to select.  This will be bounds-checked</span>
<a href="#l13.1597"></a><span id="l13.1597">    *     and if it is outside the bounds, we will clear the selection and</span>
<a href="#l13.1598"></a><span id="l13.1598">    *     bail.</span>
<a href="#l13.1599"></a><span id="l13.1599">    */</span>
<a href="#l13.1600"></a><span id="l13.1600" class="difflineminus">-  selectViewIndex: function FolderDisplayWidget_selectViewIndex(aViewIndex) {</span>
<a href="#l13.1601"></a><span id="l13.1601" class="difflineplus">+  selectViewIndex(aViewIndex) {</span>
<a href="#l13.1602"></a><span id="l13.1602">     let treeSelection = this.treeSelection;</span>
<a href="#l13.1603"></a><span id="l13.1603">     // if we have no selection, we can't select something</span>
<a href="#l13.1604"></a><span id="l13.1604">     if (!treeSelection)</span>
<a href="#l13.1605"></a><span id="l13.1605">       return;</span>
<a href="#l13.1606"></a><span id="l13.1606">     let rowCount = this.view.dbView.rowCount;</span>
<a href="#l13.1607"></a><span id="l13.1607">     if ((aViewIndex == nsMsgViewIndex_None) ||</span>
<a href="#l13.1608"></a><span id="l13.1608">         (aViewIndex &lt; 0) || (aViewIndex &gt;= rowCount)) {</span>
<a href="#l13.1609"></a><span id="l13.1609">       this.clearSelection();</span>
<a href="#l13.1610"></a><span id="l13.1610" class="difflineat">@@ -2361,26 +2323,25 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.1611"></a><span id="l13.1611">         ((treeSelection.currentIndex == aViewIndex) ||</span>
<a href="#l13.1612"></a><span id="l13.1612">          treeSelection.isSelected(aViewIndex))) {</span>
<a href="#l13.1613"></a><span id="l13.1613">       // Make sure the index we just selected is also the current index.</span>
<a href="#l13.1614"></a><span id="l13.1614">       //  This can happen when the tree selection adjusts itself as a result of</span>
<a href="#l13.1615"></a><span id="l13.1615">       //  changes to the tree as a result of deletion.  This will not trigger</span>
<a href="#l13.1616"></a><span id="l13.1616">       //  a notification.</span>
<a href="#l13.1617"></a><span id="l13.1617">       treeSelection.select(aViewIndex);</span>
<a href="#l13.1618"></a><span id="l13.1618">       this.view.dbView.selectionChanged();</span>
<a href="#l13.1619"></a><span id="l13.1619" class="difflineminus">-    }</span>
<a href="#l13.1620"></a><span id="l13.1620" class="difflineminus">-    // Previous code was concerned about avoiding updating commands on the</span>
<a href="#l13.1621"></a><span id="l13.1621" class="difflineminus">-    //  assumption that only the selection count mattered.  We no longer</span>
<a href="#l13.1622"></a><span id="l13.1622" class="difflineminus">-    //  make this assumption.</span>
<a href="#l13.1623"></a><span id="l13.1623" class="difflineminus">-    // Things that may surprise you about the call to treeSelection.select:</span>
<a href="#l13.1624"></a><span id="l13.1624" class="difflineminus">-    // 1) This ends up calling the onselect method defined on the XUL 'tree'</span>
<a href="#l13.1625"></a><span id="l13.1625" class="difflineminus">-    //    tag.  For the 3pane this is the ThreadPaneSelectionChanged method in</span>
<a href="#l13.1626"></a><span id="l13.1626" class="difflineminus">-    //    threadPane.js.  That code checks a global to see if it is dealing</span>
<a href="#l13.1627"></a><span id="l13.1627" class="difflineminus">-    //    with a right-click, and ignores it if so.</span>
<a href="#l13.1628"></a><span id="l13.1628" class="difflineminus">-    else {</span>
<a href="#l13.1629"></a><span id="l13.1629" class="difflineplus">+    } else {</span>
<a href="#l13.1630"></a><span id="l13.1630" class="difflineplus">+      // Previous code was concerned about avoiding updating commands on the</span>
<a href="#l13.1631"></a><span id="l13.1631" class="difflineplus">+      //  assumption that only the selection count mattered.  We no longer</span>
<a href="#l13.1632"></a><span id="l13.1632" class="difflineplus">+      //  make this assumption.</span>
<a href="#l13.1633"></a><span id="l13.1633" class="difflineplus">+      // Things that may surprise you about the call to treeSelection.select:</span>
<a href="#l13.1634"></a><span id="l13.1634" class="difflineplus">+      // 1) This ends up calling the onselect method defined on the XUL 'tree'</span>
<a href="#l13.1635"></a><span id="l13.1635" class="difflineplus">+      //    tag.  For the 3pane this is the ThreadPaneSelectionChanged method in</span>
<a href="#l13.1636"></a><span id="l13.1636" class="difflineplus">+      //    threadPane.js.  That code checks a global to see if it is dealing</span>
<a href="#l13.1637"></a><span id="l13.1637" class="difflineplus">+      //    with a right-click, and ignores it if so.</span>
<a href="#l13.1638"></a><span id="l13.1638">       treeSelection.select(aViewIndex);</span>
<a href="#l13.1639"></a><span id="l13.1639">     }</span>
<a href="#l13.1640"></a><span id="l13.1640"> </span>
<a href="#l13.1641"></a><span id="l13.1641">     if (this._active)</span>
<a href="#l13.1642"></a><span id="l13.1642">       this.ensureRowIsVisible(aViewIndex);</span>
<a href="#l13.1643"></a><span id="l13.1643"> </span>
<a href="#l13.1644"></a><span id="l13.1644">     // The saved selection is invalidated, since we've got something newer</span>
<a href="#l13.1645"></a><span id="l13.1645">     this._savedSelection = null;</span>
<a href="#l13.1646"></a><span id="l13.1646" class="difflineat">@@ -2392,18 +2353,17 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.1647"></a><span id="l13.1647">   /**</span>
<a href="#l13.1648"></a><span id="l13.1648">    * For every selected message in the display that is part of a (displayed)</span>
<a href="#l13.1649"></a><span id="l13.1649">    *  thread and is not the root message, de-select it and ensure that the</span>
<a href="#l13.1650"></a><span id="l13.1650">    *  root message of the thread is selected.</span>
<a href="#l13.1651"></a><span id="l13.1651">    * This is primarily intended to be used when collapsing visible threads.</span>
<a href="#l13.1652"></a><span id="l13.1652">    *</span>
<a href="#l13.1653"></a><span id="l13.1653">    * We do nothing if we are not in a threaded display mode.</span>
<a href="#l13.1654"></a><span id="l13.1654">    */</span>
<a href="#l13.1655"></a><span id="l13.1655" class="difflineminus">-  selectSelectedThreadRoots:</span>
<a href="#l13.1656"></a><span id="l13.1656" class="difflineminus">-      function FolderDisplayWidget_selectSelectedThreadRoots() {</span>
<a href="#l13.1657"></a><span id="l13.1657" class="difflineplus">+  selectSelectedThreadRoots() {</span>
<a href="#l13.1658"></a><span id="l13.1658">     if (!this.view.showThreaded)</span>
<a href="#l13.1659"></a><span id="l13.1659">       return;</span>
<a href="#l13.1660"></a><span id="l13.1660"> </span>
<a href="#l13.1661"></a><span id="l13.1661">     // There are basically two implementation strategies available to us:</span>
<a href="#l13.1662"></a><span id="l13.1662">     // 1) For each selected view index with a level &gt; 0, keep walking 'up'</span>
<a href="#l13.1663"></a><span id="l13.1663">     //    (numerically smaller) until we find a message with level 0.</span>
<a href="#l13.1664"></a><span id="l13.1664">     //    The inefficiency here is the potentially large number of JS calls</span>
<a href="#l13.1665"></a><span id="l13.1665">     //    into XPCOM space that will be required.</span>
<a href="#l13.1666"></a><span id="l13.1666" class="difflineat">@@ -2420,22 +2380,22 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.1667"></a><span id="l13.1667">       let thread = dbView.getThreadContainingIndex(index);</span>
<a href="#l13.1668"></a><span id="l13.1668">       // We use getChildHdrAt instead of getRootHdr because getRootHdr has</span>
<a href="#l13.1669"></a><span id="l13.1669">       //  a useless out-param and just calls getChildHdrAt anyways.</span>
<a href="#l13.1670"></a><span id="l13.1670">       newSelectedMessages.push(thread.getChildHdrAt(0));</span>
<a href="#l13.1671"></a><span id="l13.1671">     }</span>
<a href="#l13.1672"></a><span id="l13.1672">     this.selectMessages(newSelectedMessages);</span>
<a href="#l13.1673"></a><span id="l13.1673">   },</span>
<a href="#l13.1674"></a><span id="l13.1674"> </span>
<a href="#l13.1675"></a><span id="l13.1675" class="difflineminus">-  //@}</span>
<a href="#l13.1676"></a><span id="l13.1676" class="difflineplus">+  // @}</span>
<a href="#l13.1677"></a><span id="l13.1677"> </span>
<a href="#l13.1678"></a><span id="l13.1678">   /**</span>
<a href="#l13.1679"></a><span id="l13.1679">    * @name Ensure Visibility</span>
<a href="#l13.1680"></a><span id="l13.1680">    */</span>
<a href="#l13.1681"></a><span id="l13.1681" class="difflineminus">-  //@{</span>
<a href="#l13.1682"></a><span id="l13.1682" class="difflineplus">+  // @{</span>
<a href="#l13.1683"></a><span id="l13.1683"> </span>
<a href="#l13.1684"></a><span id="l13.1684">   /**</span>
<a href="#l13.1685"></a><span id="l13.1685">    * Minimum number of lines to display between the 'focused' message and the</span>
<a href="#l13.1686"></a><span id="l13.1686">    *  top / bottom of the thread pane.</span>
<a href="#l13.1687"></a><span id="l13.1687">    */</span>
<a href="#l13.1688"></a><span id="l13.1688">   get visibleRowPadding() {</span>
<a href="#l13.1689"></a><span id="l13.1689">     let topPadding, bottomPadding;</span>
<a href="#l13.1690"></a><span id="l13.1690"> </span>
<a href="#l13.1691"></a><span id="l13.1691" class="difflineat">@@ -2447,18 +2407,18 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.1692"></a><span id="l13.1692">       let bottomPercentPadding = Services.prefs.getIntPref(</span>
<a href="#l13.1693"></a><span id="l13.1693">                                  &quot;mail.threadpane.padding.bottom_percent&quot;);</span>
<a href="#l13.1694"></a><span id="l13.1694"> </span>
<a href="#l13.1695"></a><span id="l13.1695">       // Assume the bottom row is half-visible and should generally be ignored.</span>
<a href="#l13.1696"></a><span id="l13.1696">       // (We could actually do the legwork to see if there is a partial one...)</span>
<a href="#l13.1697"></a><span id="l13.1697">       let paneHeight = this.treeBox.getPageLength() - 1;</span>
<a href="#l13.1698"></a><span id="l13.1698"> </span>
<a href="#l13.1699"></a><span id="l13.1699">       // Convert from percentages to absolute row counts.</span>
<a href="#l13.1700"></a><span id="l13.1700" class="difflineminus">-      topPadding = Math.ceil((topPercentPadding / 100)  * paneHeight);</span>
<a href="#l13.1701"></a><span id="l13.1701" class="difflineminus">-      bottomPadding = Math.ceil((bottomPercentPadding / 100)  * paneHeight);</span>
<a href="#l13.1702"></a><span id="l13.1702" class="difflineplus">+      topPadding = Math.ceil((topPercentPadding / 100) * paneHeight);</span>
<a href="#l13.1703"></a><span id="l13.1703" class="difflineplus">+      bottomPadding = Math.ceil((bottomPercentPadding / 100) * paneHeight);</span>
<a href="#l13.1704"></a><span id="l13.1704"> </span>
<a href="#l13.1705"></a><span id="l13.1705">       // We need one visible row not counted in either padding, for the actual</span>
<a href="#l13.1706"></a><span id="l13.1706">       //  target message. Also helps correct for rounding errors.</span>
<a href="#l13.1707"></a><span id="l13.1707">       if (topPadding + bottomPadding &gt; paneHeight) {</span>
<a href="#l13.1708"></a><span id="l13.1708">         if (topPadding &gt; bottomPadding)</span>
<a href="#l13.1709"></a><span id="l13.1709">           topPadding--;</span>
<a href="#l13.1710"></a><span id="l13.1710">         else</span>
<a href="#l13.1711"></a><span id="l13.1711">           bottomPadding--;</span>
<a href="#l13.1712"></a><span id="l13.1712" class="difflineat">@@ -2479,18 +2439,17 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.1713"></a><span id="l13.1713">    * By padding, we mean that the index will not be the first or last message</span>
<a href="#l13.1714"></a><span id="l13.1714">    *  displayed, but rather have messages on either side.</span>
<a href="#l13.1715"></a><span id="l13.1715">    * We have the concept of a 'lip' when we are at the end of the message</span>
<a href="#l13.1716"></a><span id="l13.1716">    *  display.  If we are near the end of the display, we want to show an</span>
<a href="#l13.1717"></a><span id="l13.1717">    *  empty row (at the bottom) so the user knows they are at the end.  Also,</span>
<a href="#l13.1718"></a><span id="l13.1718">    *  if a message shows up that is new and things are sorted ascending, this</span>
<a href="#l13.1719"></a><span id="l13.1719">    *  turns out to be useful.</span>
<a href="#l13.1720"></a><span id="l13.1720">    */</span>
<a href="#l13.1721"></a><span id="l13.1721" class="difflineminus">-  ensureRowIsVisible: function FolderDisplayWidget_ensureRowIsVisible(</span>
<a href="#l13.1722"></a><span id="l13.1722" class="difflineminus">-      aViewIndex, aBounced) {</span>
<a href="#l13.1723"></a><span id="l13.1723" class="difflineplus">+  ensureRowIsVisible(aViewIndex, aBounced) {</span>
<a href="#l13.1724"></a><span id="l13.1724">     // Dealing with the tree view layout is a nightmare, let's just always make</span>
<a href="#l13.1725"></a><span id="l13.1725">     //  sure we re-schedule ourselves.  The most particular rationale here is</span>
<a href="#l13.1726"></a><span id="l13.1726">     //  that the message pane may be toggling its state and it's much simpler</span>
<a href="#l13.1727"></a><span id="l13.1727">     //  and reliable if we ensure that all of FolderDisplayWidget's state</span>
<a href="#l13.1728"></a><span id="l13.1728">     //  change logic gets to run to completion before we run ourselves.</span>
<a href="#l13.1729"></a><span id="l13.1729">     if (!aBounced) {</span>
<a href="#l13.1730"></a><span id="l13.1730">       let dis = this;</span>
<a href="#l13.1731"></a><span id="l13.1731">       window.setTimeout(function() {</span>
<a href="#l13.1732"></a><span id="l13.1732" class="difflineat">@@ -2536,19 +2495,17 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.1733"></a><span id="l13.1733">    *  displayed in the thread pane, we bias towards showing the min row (with</span>
<a href="#l13.1734"></a><span id="l13.1734">    *  padding).</span>
<a href="#l13.1735"></a><span id="l13.1735">    *</span>
<a href="#l13.1736"></a><span id="l13.1736">    * @param aMinRow The numerically smallest row index defining the start of</span>
<a href="#l13.1737"></a><span id="l13.1737">    *     the inclusive range.</span>
<a href="#l13.1738"></a><span id="l13.1738">    * @param aMaxRow The numberically largest row index defining the end of the</span>
<a href="#l13.1739"></a><span id="l13.1739">    *     inclusive range.</span>
<a href="#l13.1740"></a><span id="l13.1740">    */</span>
<a href="#l13.1741"></a><span id="l13.1741" class="difflineminus">-  ensureRowRangeIsVisible:</span>
<a href="#l13.1742"></a><span id="l13.1742" class="difflineminus">-      function FolderDisplayWidget_ensureRowRangeIsVisible(aMinRow, aMaxRow,</span>
<a href="#l13.1743"></a><span id="l13.1743" class="difflineminus">-                                                           aBounced) {</span>
<a href="#l13.1744"></a><span id="l13.1744" class="difflineplus">+  ensureRowRangeIsVisible(aMinRow, aMaxRow, aBounced) {</span>
<a href="#l13.1745"></a><span id="l13.1745">     // Dealing with the tree view layout is a nightmare, let's just always make</span>
<a href="#l13.1746"></a><span id="l13.1746">     //  sure we re-schedule ourselves.  The most particular rationale here is</span>
<a href="#l13.1747"></a><span id="l13.1747">     //  that the message pane may be toggling its state and it's much simpler</span>
<a href="#l13.1748"></a><span id="l13.1748">     //  and reliable if we ensure that all of FolderDisplayWidget's state</span>
<a href="#l13.1749"></a><span id="l13.1749">     //  change logic gets to run to completion before we run ourselves.</span>
<a href="#l13.1750"></a><span id="l13.1750">     if (!aBounced) {</span>
<a href="#l13.1751"></a><span id="l13.1751">       let dis = this;</span>
<a href="#l13.1752"></a><span id="l13.1752">       window.setTimeout(function() {</span>
<a href="#l13.1753"></a><span id="l13.1753" class="difflineat">@@ -2583,38 +2540,37 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.1754"></a><span id="l13.1754">       target = aMinRow - halfSpare - topPadding;</span>
<a href="#l13.1755"></a><span id="l13.1755">     }</span>
<a href="#l13.1756"></a><span id="l13.1756">     treeBox.scrollToRow(target);</span>
<a href="#l13.1757"></a><span id="l13.1757">   },</span>
<a href="#l13.1758"></a><span id="l13.1758"> </span>
<a href="#l13.1759"></a><span id="l13.1759">   /**</span>
<a href="#l13.1760"></a><span id="l13.1760">    * Ensure that the selection is visible to the extent possible.</span>
<a href="#l13.1761"></a><span id="l13.1761">    */</span>
<a href="#l13.1762"></a><span id="l13.1762" class="difflineminus">-  ensureSelectionIsVisible:</span>
<a href="#l13.1763"></a><span id="l13.1763" class="difflineminus">-      function FolderDisplayWidget_ensureSelectionIsVisible() {</span>
<a href="#l13.1764"></a><span id="l13.1764" class="difflineplus">+  ensureSelectionIsVisible() {</span>
<a href="#l13.1765"></a><span id="l13.1765">     let treeSelection = this.treeSelection; // potentially magic getter</span>
<a href="#l13.1766"></a><span id="l13.1766">     if (!treeSelection || !treeSelection.count)</span>
<a href="#l13.1767"></a><span id="l13.1767">       return;</span>
<a href="#l13.1768"></a><span id="l13.1768"> </span>
<a href="#l13.1769"></a><span id="l13.1769">     let minRow = null, maxRow = null;</span>
<a href="#l13.1770"></a><span id="l13.1770"> </span>
<a href="#l13.1771"></a><span id="l13.1771">     let rangeCount = treeSelection.getRangeCount();</span>
<a href="#l13.1772"></a><span id="l13.1772">     for (let iRange = 0; iRange &lt; rangeCount; iRange++) {</span>
<a href="#l13.1773"></a><span id="l13.1773">       let rangeMinObj = {}, rangeMaxObj = {};</span>
<a href="#l13.1774"></a><span id="l13.1774">       treeSelection.getRangeAt(iRange, rangeMinObj, rangeMaxObj);</span>
<a href="#l13.1775"></a><span id="l13.1775">       let rangeMin = rangeMinObj.value, rangeMax = rangeMaxObj.value;</span>
<a href="#l13.1776"></a><span id="l13.1776">       if (minRow == null || rangeMin &lt; minRow)</span>
<a href="#l13.1777"></a><span id="l13.1777">         minRow = rangeMin;</span>
<a href="#l13.1778"></a><span id="l13.1778" class="difflineminus">-      if (maxRow == null || rangeMax &gt; maxRow )</span>
<a href="#l13.1779"></a><span id="l13.1779" class="difflineplus">+      if (maxRow == null || rangeMax &gt; maxRow)</span>
<a href="#l13.1780"></a><span id="l13.1780">         maxRow = rangeMax;</span>
<a href="#l13.1781"></a><span id="l13.1781">     }</span>
<a href="#l13.1782"></a><span id="l13.1782"> </span>
<a href="#l13.1783"></a><span id="l13.1783">     this.ensureRowRangeIsVisible(minRow, maxRow);</span>
<a href="#l13.1784"></a><span id="l13.1784" class="difflineminus">-  }</span>
<a href="#l13.1785"></a><span id="l13.1785" class="difflineminus">-  //@}</span>
<a href="#l13.1786"></a><span id="l13.1786" class="difflineplus">+  },</span>
<a href="#l13.1787"></a><span id="l13.1787" class="difflineplus">+  // @}</span>
<a href="#l13.1788"></a><span id="l13.1788"> };</span>
<a href="#l13.1789"></a><span id="l13.1789"> </span>
<a href="#l13.1790"></a><span id="l13.1790"> /**</span>
<a href="#l13.1791"></a><span id="l13.1791">  * Implement a fake nsITreeBoxObject so that we can keep the view</span>
<a href="#l13.1792"></a><span id="l13.1792">  *  nsITreeSelection selections 'live' when they are in the background.  We need</span>
<a href="#l13.1793"></a><span id="l13.1793">  *  to do this because nsTreeSelection changes its behaviour (and gets ornery)</span>
<a href="#l13.1794"></a><span id="l13.1794">  *  if it does not have a box object.</span>
<a href="#l13.1795"></a><span id="l13.1795">  * This does not need to exist once we abandon multiplexed tabbing.</span>
<a href="#l13.1796"></a><span id="l13.1796" class="difflineat">@@ -2626,82 +2582,82 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l13.1797"></a><span id="l13.1797">  *  whenever nsTreeSelection QIs us to nsIBoxObject.</span>
<a href="#l13.1798"></a><span id="l13.1798">  */</span>
<a href="#l13.1799"></a><span id="l13.1799"> function FakeTreeBoxObject(aDOMNode) {</span>
<a href="#l13.1800"></a><span id="l13.1800">   this.domNode = aDOMNode;</span>
<a href="#l13.1801"></a><span id="l13.1801">   this.view = null;</span>
<a href="#l13.1802"></a><span id="l13.1802"> }</span>
<a href="#l13.1803"></a><span id="l13.1803"> FakeTreeBoxObject.prototype = {</span>
<a href="#l13.1804"></a><span id="l13.1804">   view: null,</span>
<a href="#l13.1805"></a><span id="l13.1805" class="difflineminus">-  ensureRowIsVisible: function FakeTreeBoxObject_ensureRowIsVisible() {</span>
<a href="#l13.1806"></a><span id="l13.1806" class="difflineplus">+  ensureRowIsVisible() {</span>
<a href="#l13.1807"></a><span id="l13.1807">     // NOP</span>
<a href="#l13.1808"></a><span id="l13.1808">   },</span>
<a href="#l13.1809"></a><span id="l13.1809">   /**</span>
<a href="#l13.1810"></a><span id="l13.1810">    * No need to actually invalidate, as when we re-root the view this will</span>
<a href="#l13.1811"></a><span id="l13.1811">    *  happen.</span>
<a href="#l13.1812"></a><span id="l13.1812">    */</span>
<a href="#l13.1813"></a><span id="l13.1813" class="difflineminus">-  invalidate: function FakeTreeBoxObject_invalidate() {</span>
<a href="#l13.1814"></a><span id="l13.1814" class="difflineplus">+  invalidate() {</span>
<a href="#l13.1815"></a><span id="l13.1815">     // NOP</span>
<a href="#l13.1816"></a><span id="l13.1816">   },</span>
<a href="#l13.1817"></a><span id="l13.1817" class="difflineminus">-  invalidateRange: function FakeTreeBoxObject_invalidateRange() {</span>
<a href="#l13.1818"></a><span id="l13.1818" class="difflineplus">+  invalidateRange() {</span>
<a href="#l13.1819"></a><span id="l13.1819">     // NOP</span>
<a href="#l13.1820"></a><span id="l13.1820">   },</span>
<a href="#l13.1821"></a><span id="l13.1821" class="difflineminus">-  invalidateRow: function FakeTreeBoxObject_invalidateRow() {</span>
<a href="#l13.1822"></a><span id="l13.1822" class="difflineplus">+  invalidateRow() {</span>
<a href="#l13.1823"></a><span id="l13.1823">     // NOP</span>
<a href="#l13.1824"></a><span id="l13.1824">   },</span>
<a href="#l13.1825"></a><span id="l13.1825" class="difflineminus">-  beginUpdateBatch: function FakeTreeBoxObject_beginUpdateBatch() {</span>
<a href="#l13.1826"></a><span id="l13.1826" class="difflineplus">+  beginUpdateBatch() {</span>
<a href="#l13.1827"></a><span id="l13.1827"> </span>
<a href="#l13.1828"></a><span id="l13.1828">   },</span>
<a href="#l13.1829"></a><span id="l13.1829" class="difflineminus">-  endUpdateBatch: function FakeTreeBoxObject_endUpdateBatch() {</span>
<a href="#l13.1830"></a><span id="l13.1830" class="difflineplus">+  endUpdateBatch() {</span>
<a href="#l13.1831"></a><span id="l13.1831"> </span>
<a href="#l13.1832"></a><span id="l13.1832">   },</span>
<a href="#l13.1833"></a><span id="l13.1833">   /**</span>
<a href="#l13.1834"></a><span id="l13.1834">    * We're going to make an exception to our NOP rule here, as this is rather</span>
<a href="#l13.1835"></a><span id="l13.1835">    * important for us to pass on. The db view calls this if a row's been</span>
<a href="#l13.1836"></a><span id="l13.1836">    * inserted or deleted. Without this, the selection's going to be out of sync</span>
<a href="#l13.1837"></a><span id="l13.1837">    * with the view.</span>
<a href="#l13.1838"></a><span id="l13.1838">    *</span>
<a href="#l13.1839"></a><span id="l13.1839">    * @param aIndex the index where the rows have been inserted or deleted</span>
<a href="#l13.1840"></a><span id="l13.1840">    * @param aCount the number of rows inserted or deleted (negative for</span>
<a href="#l13.1841"></a><span id="l13.1841">    *               deleted)</span>
<a href="#l13.1842"></a><span id="l13.1842">    */</span>
<a href="#l13.1843"></a><span id="l13.1843" class="difflineminus">-  rowCountChanged: function FakeTreeBoxObject_rowCountChanged(aIndex, aCount) {</span>
<a href="#l13.1844"></a><span id="l13.1844" class="difflineplus">+  rowCountChanged(aIndex, aCount) {</span>
<a href="#l13.1845"></a><span id="l13.1845">     if (aCount == 0 || !this.view)</span>
<a href="#l13.1846"></a><span id="l13.1846">       // Nothing to do</span>
<a href="#l13.1847"></a><span id="l13.1847">       return;</span>
<a href="#l13.1848"></a><span id="l13.1848"> </span>
<a href="#l13.1849"></a><span id="l13.1849">     let selection = this.view.selection;</span>
<a href="#l13.1850"></a><span id="l13.1850">     if (selection)</span>
<a href="#l13.1851"></a><span id="l13.1851">       selection.adjustSelection(aIndex, aCount);</span>
<a href="#l13.1852"></a><span id="l13.1852">   },</span>
<a href="#l13.1853"></a><span id="l13.1853" class="difflineminus">-  get element() {return this.domNode;},</span>
<a href="#l13.1854"></a><span id="l13.1854" class="difflineminus">-  get x() {return this.domNode.boxObject.x},</span>
<a href="#l13.1855"></a><span id="l13.1855" class="difflineminus">-  get y() {return this.domNode.boxObject.y},</span>
<a href="#l13.1856"></a><span id="l13.1856" class="difflineminus">-  get screenX() {return this.domNode.boxObject.screenX},</span>
<a href="#l13.1857"></a><span id="l13.1857" class="difflineminus">-  get screenY() {return this.domNode.boxObject.screenY},</span>
<a href="#l13.1858"></a><span id="l13.1858" class="difflineminus">-  get width() {return this.domNode.boxObject.width},</span>
<a href="#l13.1859"></a><span id="l13.1859" class="difflineminus">-  get height()  {return this.domNode.boxObject.height},</span>
<a href="#l13.1860"></a><span id="l13.1860" class="difflineminus">-  get parentBox() {return this.domNode.boxObject.parentBox},</span>
<a href="#l13.1861"></a><span id="l13.1861" class="difflineminus">-  get firstChild() {return this.domNode.boxObject.firstChild},</span>
<a href="#l13.1862"></a><span id="l13.1862" class="difflineminus">-  get lastChild() {return this.domNode.boxObject.lastChild},</span>
<a href="#l13.1863"></a><span id="l13.1863" class="difflineminus">-  get nextSibling() {return this.domNode.boxObject.nextSibling},</span>
<a href="#l13.1864"></a><span id="l13.1864" class="difflineminus">-  get previousSibling() {return this.domNode.boxObject.previousSibling},</span>
<a href="#l13.1865"></a><span id="l13.1865" class="difflineminus">-  getPropertyAsSupports : function FakeTreeBoxObject_getPropertyAsSupports(propertyName) {</span>
<a href="#l13.1866"></a><span id="l13.1866" class="difflineplus">+  get element() { return this.domNode; },</span>
<a href="#l13.1867"></a><span id="l13.1867" class="difflineplus">+  get x() { return this.domNode.boxObject.x; },</span>
<a href="#l13.1868"></a><span id="l13.1868" class="difflineplus">+  get y() { return this.domNode.boxObject.y; },</span>
<a href="#l13.1869"></a><span id="l13.1869" class="difflineplus">+  get screenX() { return this.domNode.boxObject.screenX; },</span>
<a href="#l13.1870"></a><span id="l13.1870" class="difflineplus">+  get screenY() { return this.domNode.boxObject.screenY; },</span>
<a href="#l13.1871"></a><span id="l13.1871" class="difflineplus">+  get width() { return this.domNode.boxObject.width; },</span>
<a href="#l13.1872"></a><span id="l13.1872" class="difflineplus">+  get height() { return this.domNode.boxObject.height; },</span>
<a href="#l13.1873"></a><span id="l13.1873" class="difflineplus">+  get parentBox() { return this.domNode.boxObject.parentBox; },</span>
<a href="#l13.1874"></a><span id="l13.1874" class="difflineplus">+  get firstChild() { return this.domNode.boxObject.firstChild; },</span>
<a href="#l13.1875"></a><span id="l13.1875" class="difflineplus">+  get lastChild() { return this.domNode.boxObject.lastChild; },</span>
<a href="#l13.1876"></a><span id="l13.1876" class="difflineplus">+  get nextSibling() { return this.domNode.boxObject.nextSibling; },</span>
<a href="#l13.1877"></a><span id="l13.1877" class="difflineplus">+  get previousSibling() { return this.domNode.boxObject.previousSibling; },</span>
<a href="#l13.1878"></a><span id="l13.1878" class="difflineplus">+  getPropertyAsSupports(propertyName) {</span>
<a href="#l13.1879"></a><span id="l13.1879">     return this.domNode.boxObject.getPropertyAsSupports(propertyName);</span>
<a href="#l13.1880"></a><span id="l13.1880">   },</span>
<a href="#l13.1881"></a><span id="l13.1881" class="difflineminus">-  setPropertyAsSupports : function FakeTreeBoxObject_setPropertyAsSupports(propertyName, value) {</span>
<a href="#l13.1882"></a><span id="l13.1882" class="difflineplus">+  setPropertyAsSupports(propertyName, value) {</span>
<a href="#l13.1883"></a><span id="l13.1883">     this.domNode.boxObject.setPropertyAsSupports(propertyName, value);</span>
<a href="#l13.1884"></a><span id="l13.1884">   },</span>
<a href="#l13.1885"></a><span id="l13.1885" class="difflineminus">-  getProperty : function FakeTreeBoxObject_getProperty(propertyName) {</span>
<a href="#l13.1886"></a><span id="l13.1886" class="difflineplus">+  getProperty(propertyName) {</span>
<a href="#l13.1887"></a><span id="l13.1887">     return this.domNode.boxObject.getProperty(propertyName);</span>
<a href="#l13.1888"></a><span id="l13.1888">   },</span>
<a href="#l13.1889"></a><span id="l13.1889" class="difflineminus">-  setProperty : function FakeTreeBoxObject_setProperty(propertyName, value) {</span>
<a href="#l13.1890"></a><span id="l13.1890" class="difflineplus">+  setProperty(propertyName, value) {</span>
<a href="#l13.1891"></a><span id="l13.1891">     return this.domNode.boxObject.setProperty(propertyName, value);</span>
<a href="#l13.1892"></a><span id="l13.1892">   },</span>
<a href="#l13.1893"></a><span id="l13.1893" class="difflineminus">-  removeProperty : function FakeTreeBoxObject_removeProperty(propertyName) {</span>
<a href="#l13.1894"></a><span id="l13.1894" class="difflineplus">+  removeProperty(propertyName) {</span>
<a href="#l13.1895"></a><span id="l13.1895">     return this.domNode.boxObject.removeProperty(propertyName);</span>
<a href="#l13.1896"></a><span id="l13.1896">   },</span>
<a href="#l13.1897"></a><span id="l13.1897">   QueryInterface: ChromeUtils.generateQI([&quot;nsIBoxObject&quot;,</span>
<a href="#l13.1898"></a><span id="l13.1898">                                           &quot;nsITreeBoxObject&quot;]),</span>
<a href="#l13.1899"></a><span id="l13.1899"> };</span>
<a href="#l13.1900"></a><span id="l13.1900"> /*</span>
<a href="#l13.1901"></a><span id="l13.1901">  * Provide attribute and function implementations that complain very loudly if</span>
<a href="#l13.1902"></a><span id="l13.1902">  *  they are used.  Now, XPConnect will return an error to callers if we don't</span>
<a href="#l13.1903"></a><span id="l13.1903" class="difflineat">@@ -2712,35 +2668,32 @@ FakeTreeBoxObject.prototype = {</span>
<a href="#l13.1904"></a><span id="l13.1904">  */</span>
<a href="#l13.1905"></a><span id="l13.1905"> function FTBO_stubOutAttributes(aObj, aAttribNames) {</span>
<a href="#l13.1906"></a><span id="l13.1906">   for (let attrName of aAttribNames) {</span>
<a href="#l13.1907"></a><span id="l13.1907">     let myAttrName = attrName;</span>
<a href="#l13.1908"></a><span id="l13.1908">     aObj.__defineGetter__(attrName,</span>
<a href="#l13.1909"></a><span id="l13.1909">       function() {</span>
<a href="#l13.1910"></a><span id="l13.1910">         let msg = &quot;Read access to stubbed attribute &quot; + myAttrName;</span>
<a href="#l13.1911"></a><span id="l13.1911">         dump(msg + &quot;\n&quot;);</span>
<a href="#l13.1912"></a><span id="l13.1912" class="difflineminus">-        debugger;</span>
<a href="#l13.1913"></a><span id="l13.1913">         throw new Error(msg);</span>
<a href="#l13.1914"></a><span id="l13.1914">       });</span>
<a href="#l13.1915"></a><span id="l13.1915">     aObj.__defineSetter__(attrName,</span>
<a href="#l13.1916"></a><span id="l13.1916">       function() {</span>
<a href="#l13.1917"></a><span id="l13.1917">         let msg = &quot;Write access to stubbed attribute &quot; + myAttrName;</span>
<a href="#l13.1918"></a><span id="l13.1918">         dump(msg + &quot;\n&quot;);</span>
<a href="#l13.1919"></a><span id="l13.1919" class="difflineminus">-        debugger;</span>
<a href="#l13.1920"></a><span id="l13.1920">         throw new Error(msg);</span>
<a href="#l13.1921"></a><span id="l13.1921">       });</span>
<a href="#l13.1922"></a><span id="l13.1922">   }</span>
<a href="#l13.1923"></a><span id="l13.1923"> }</span>
<a href="#l13.1924"></a><span id="l13.1924"> function FTBO_stubOutMethods(aObj, aMethodNames) {</span>
<a href="#l13.1925"></a><span id="l13.1925">   for (let methodName of aMethodNames) {</span>
<a href="#l13.1926"></a><span id="l13.1926">     let myMethodName = methodName;</span>
<a href="#l13.1927"></a><span id="l13.1927">     aObj[myMethodName] = function() {</span>
<a href="#l13.1928"></a><span id="l13.1928">       let msg = &quot;Call to stubbed method &quot; + myMethodName;</span>
<a href="#l13.1929"></a><span id="l13.1929">       dump(msg + &quot;\n&quot;);</span>
<a href="#l13.1930"></a><span id="l13.1930" class="difflineminus">-      debugger;</span>
<a href="#l13.1931"></a><span id="l13.1931">       throw new Error(msg);</span>
<a href="#l13.1932"></a><span id="l13.1932">     };</span>
<a href="#l13.1933"></a><span id="l13.1933">   }</span>
<a href="#l13.1934"></a><span id="l13.1934"> }</span>
<a href="#l13.1935"></a><span id="l13.1935"> FTBO_stubOutAttributes(FakeTreeBoxObject.prototype, [</span>
<a href="#l13.1936"></a><span id="l13.1936">   &quot;columns&quot;,</span>
<a href="#l13.1937"></a><span id="l13.1937">   &quot;focused&quot;,</span>
<a href="#l13.1938"></a><span id="l13.1938">   &quot;treeBody&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/base/content/folderPane.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/base/content/folderPane.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -3,17 +3,20 @@</span>
<a href="#l14.4"></a><span id="l14.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.5"></a><span id="l14.5"> </span>
<a href="#l14.6"></a><span id="l14.6"> // Implements a tree of folders. It shows icons depending on folder type</span>
<a href="#l14.7"></a><span id="l14.7"> // and other fancy styling.</span>
<a href="#l14.8"></a><span id="l14.8"> // This is used in the main folder pane, but also some dialogs that need</span>
<a href="#l14.9"></a><span id="l14.9"> // to show a nice list of folders.</span>
<a href="#l14.10"></a><span id="l14.10"> </span>
<a href="#l14.11"></a><span id="l14.11"> ChromeUtils.import(&quot;resource:///modules/folderUtils.jsm&quot;);</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+var {</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+  fixIterator,</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+  toXPCOMArray,</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+} = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;, null);</span>
<a href="#l14.17"></a><span id="l14.17"> ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l14.18"></a><span id="l14.18"> ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l14.19"></a><span id="l14.19"> ChromeUtils.import(&quot;resource:///modules/IOUtils.js&quot;);</span>
<a href="#l14.20"></a><span id="l14.20"> ChromeUtils.import(&quot;resource:///modules/FeedUtils.jsm&quot;);</span>
<a href="#l14.21"></a><span id="l14.21"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l14.22"></a><span id="l14.22"> </span>
<a href="#l14.23"></a><span id="l14.23"> if (typeof FeedMessageHandler != &quot;object&quot;)</span>
<a href="#l14.24"></a><span id="l14.24">   Services.scriptloader.loadSubScript(&quot;chrome://messenger-newsblog/content/newsblogOverlay.js&quot;);</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineat">@@ -43,17 +46,17 @@ var IFolderTreeMode = {</span>
<a href="#l14.26"></a><span id="l14.26">    * Generates the folder map for this mode.</span>
<a href="#l14.27"></a><span id="l14.27">    *</span>
<a href="#l14.28"></a><span id="l14.28">    * @param aFolderTreeView The gFolderTreeView for which this mode is being</span>
<a href="#l14.29"></a><span id="l14.29">    *     activated.</span>
<a href="#l14.30"></a><span id="l14.30">    *</span>
<a href="#l14.31"></a><span id="l14.31">    * @returns An array containing ftvItem instances representing the top-level</span>
<a href="#l14.32"></a><span id="l14.32">    *     folders in this view.</span>
<a href="#l14.33"></a><span id="l14.33">    */</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineminus">-  generateMap: function IFolderTreeMode_generateMap(aFolderTreeView) {</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+  generateMap(aFolderTreeView) {</span>
<a href="#l14.36"></a><span id="l14.36">     return null;</span>
<a href="#l14.37"></a><span id="l14.37">   },</span>
<a href="#l14.38"></a><span id="l14.38"> </span>
<a href="#l14.39"></a><span id="l14.39">   /**</span>
<a href="#l14.40"></a><span id="l14.40">    * Given an nsIMsgFolder, returns its parent in the map. The default behaviour</span>
<a href="#l14.41"></a><span id="l14.41">    * is to return the folder's actual parent (aFolder.parent). Folder tree modes</span>
<a href="#l14.42"></a><span id="l14.42">    * may decide to override it.</span>
<a href="#l14.43"></a><span id="l14.43">    *</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineat">@@ -63,17 +66,17 @@ var IFolderTreeMode = {</span>
<a href="#l14.45"></a><span id="l14.45">    *</span>
<a href="#l14.46"></a><span id="l14.46">    * @returns an nsIMsgFolder representing the parent of the folder in the view,</span>
<a href="#l14.47"></a><span id="l14.47">    *     or null if the folder is a top-level folder in the map. It is expected</span>
<a href="#l14.48"></a><span id="l14.48">    *     that the returned parent will have the given folder as one of its</span>
<a href="#l14.49"></a><span id="l14.49">    *     children.</span>
<a href="#l14.50"></a><span id="l14.50">    * @note This function need not guarantee that either the folder or its parent</span>
<a href="#l14.51"></a><span id="l14.51">    *       is actually in the view.</span>
<a href="#l14.52"></a><span id="l14.52">    */</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineminus">-  getParentOfFolder: function IFolderTreeMode_getParentOfFolder(aFolder) {</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+  getParentOfFolder(aFolder) {</span>
<a href="#l14.55"></a><span id="l14.55">     return aFolder.parent;</span>
<a href="#l14.56"></a><span id="l14.56">   },</span>
<a href="#l14.57"></a><span id="l14.57"> </span>
<a href="#l14.58"></a><span id="l14.58">   /**</span>
<a href="#l14.59"></a><span id="l14.59">    * Given an nsIMsgDBHdr, returns the folder it is considered to be contained</span>
<a href="#l14.60"></a><span id="l14.60">    * in, in this mode. This is usually just the physical folder it is contained</span>
<a href="#l14.61"></a><span id="l14.61">    * in (aMsgHdr.folder), but some modes may decide to override this. For</span>
<a href="#l14.62"></a><span id="l14.62">    * example, combined views like Smart Folders return the smart inbox for any</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineat">@@ -82,78 +85,78 @@ var IFolderTreeMode = {</span>
<a href="#l14.64"></a><span id="l14.64">    * The folder returned doesn't need to be in the view.</span>
<a href="#l14.65"></a><span id="l14.65"> </span>
<a href="#l14.66"></a><span id="l14.66">    * @returns The folder the message header is considered to be contained in, in</span>
<a href="#l14.67"></a><span id="l14.67">    *     this mode. The returned folder may or may not actually be in the view</span>
<a href="#l14.68"></a><span id="l14.68">    *     -- however, given a valid nsIMsgDBHdr, it is expected that a) a</span>
<a href="#l14.69"></a><span id="l14.69">    *     non-null folder is returned, and that b) the folder that is returned</span>
<a href="#l14.70"></a><span id="l14.70">    *     actually does contain the message header.</span>
<a href="#l14.71"></a><span id="l14.71">    */</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineminus">-  getFolderForMsgHdr: function IFolderTreeMode_getFolderForMsgHdr(aMsgHdr) {</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+  getFolderForMsgHdr(aMsgHdr) {</span>
<a href="#l14.74"></a><span id="l14.74">     return aMsgHdr.folder;</span>
<a href="#l14.75"></a><span id="l14.75">   },</span>
<a href="#l14.76"></a><span id="l14.76"> </span>
<a href="#l14.77"></a><span id="l14.77">   /**</span>
<a href="#l14.78"></a><span id="l14.78">    * Notified when a folder is added. The default behavior is to add it as a</span>
<a href="#l14.79"></a><span id="l14.79">    * child of the parent item, but some views may decide to override this. For</span>
<a href="#l14.80"></a><span id="l14.80">    * example, combined views like Smart Folders add any new inbox as a child of</span>
<a href="#l14.81"></a><span id="l14.81">    * the smart inbox.</span>
<a href="#l14.82"></a><span id="l14.82">    *</span>
<a href="#l14.83"></a><span id="l14.83">    * @param aParent The parent of the folder that was added.</span>
<a href="#l14.84"></a><span id="l14.84">    * @param aFolder The folder that was added.</span>
<a href="#l14.85"></a><span id="l14.85">    */</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineminus">-  onFolderAdded: function IFolderTreeMode_onFolderAdded(aParent, aFolder) {</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineplus">+  onFolderAdded(aParent, aFolder) {</span>
<a href="#l14.88"></a><span id="l14.88">     gFolderTreeView.addFolder(aParent, aFolder);</span>
<a href="#l14.89"></a><span id="l14.89">   },</span>
<a href="#l14.90"></a><span id="l14.90"> </span>
<a href="#l14.91"></a><span id="l14.91">   /**</span>
<a href="#l14.92"></a><span id="l14.92">    * Notified when a folder int property is changed.</span>
<a href="#l14.93"></a><span id="l14.93">    *</span>
<a href="#l14.94"></a><span id="l14.94">    * Returns true if the event was processed inside the function and no further</span>
<a href="#l14.95"></a><span id="l14.95">    * default handling should be done in the caller. Otherwise false.</span>
<a href="#l14.96"></a><span id="l14.96">    *</span>
<a href="#l14.97"></a><span id="l14.97">    * @param aItem      The folder with a change.</span>
<a href="#l14.98"></a><span id="l14.98">    * @param aProperty  The changed property string.</span>
<a href="#l14.99"></a><span id="l14.99">    * @param aOld       The old value of the property.</span>
<a href="#l14.100"></a><span id="l14.100">    * @param aNew       The new value of the property.</span>
<a href="#l14.101"></a><span id="l14.101">    */</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineminus">-  handleChangedIntProperty: function(aItem, aProperty, aOld, aNew) {</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineplus">+  handleChangedIntProperty(aItem, aProperty, aOld, aNew) {</span>
<a href="#l14.104"></a><span id="l14.104">     return false;</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineminus">-  }</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineplus">+  },</span>
<a href="#l14.107"></a><span id="l14.107"> };</span>
<a href="#l14.108"></a><span id="l14.108"> </span>
<a href="#l14.109"></a><span id="l14.109"> /**</span>
<a href="#l14.110"></a><span id="l14.110">  * This is our controller for the folder-tree. It includes our nsITreeView</span>
<a href="#l14.111"></a><span id="l14.111">  * implementation, as well as other control functions.</span>
<a href="#l14.112"></a><span id="l14.112">  */</span>
<a href="#l14.113"></a><span id="l14.113"> var gFolderTreeView = {</span>
<a href="#l14.114"></a><span id="l14.114">   messengerBundle: null,</span>
<a href="#l14.115"></a><span id="l14.115"> </span>
<a href="#l14.116"></a><span id="l14.116">   /**</span>
<a href="#l14.117"></a><span id="l14.117">    * Called when the window is initially loaded.  This function initializes the</span>
<a href="#l14.118"></a><span id="l14.118">    * folder-pane to the view last shown before the application was closed.</span>
<a href="#l14.119"></a><span id="l14.119">    */</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineminus">-  load: function ftv_load(aTree, aJSONFile) {</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineplus">+  load(aTree, aJSONFile) {</span>
<a href="#l14.122"></a><span id="l14.122">     this._treeElement = aTree;</span>
<a href="#l14.123"></a><span id="l14.123">     this.messengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l14.124"></a><span id="l14.124"> </span>
<a href="#l14.125"></a><span id="l14.125">     // the folder pane can be used for other trees which may not have these elements.</span>
<a href="#l14.126"></a><span id="l14.126">     if (document.getElementById(&quot;folderpane_splitter&quot;))</span>
<a href="#l14.127"></a><span id="l14.127">       document.getElementById(&quot;folderpane_splitter&quot;).collapsed = false;</span>
<a href="#l14.128"></a><span id="l14.128">     if (document.getElementById(&quot;folderPaneBox&quot;))</span>
<a href="#l14.129"></a><span id="l14.129">       document.getElementById(&quot;folderPaneBox&quot;).collapsed = false;</span>
<a href="#l14.130"></a><span id="l14.130"> </span>
<a href="#l14.131"></a><span id="l14.131">     try {</span>
<a href="#l14.132"></a><span id="l14.132">       // Normally our tree takes care of keeping the last selected by itself.</span>
<a href="#l14.133"></a><span id="l14.133">       // However older versions of TB stored this in a preference, which we need</span>
<a href="#l14.134"></a><span id="l14.134">       // to migrate</span>
<a href="#l14.135"></a><span id="l14.135">       let modeIndex = Services.prefs.getIntPref(&quot;mail.ui.folderpane.view&quot;);</span>
<a href="#l14.136"></a><span id="l14.136">       this._mode = this._modeNames[modeIndex];</span>
<a href="#l14.137"></a><span id="l14.137">       Services.prefs.deleteBranch(&quot;mail.ui.folderpane&quot;);</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineminus">-    } catch(ex) {</span>
<a href="#l14.139"></a><span id="l14.139" class="difflineplus">+    } catch (ex) {</span>
<a href="#l14.140"></a><span id="l14.140">       // This is ok.  If we've already migrated we'll end up here</span>
<a href="#l14.141"></a><span id="l14.141">     }</span>
<a href="#l14.142"></a><span id="l14.142"> </span>
<a href="#l14.143"></a><span id="l14.143">     if (aJSONFile) {</span>
<a href="#l14.144"></a><span id="l14.144">       // Parse our persistent-open-state json file</span>
<a href="#l14.145"></a><span id="l14.145">       let data = IOUtils.loadFileToString(aJSONFile);</span>
<a href="#l14.146"></a><span id="l14.146">       if (data) {</span>
<a href="#l14.147"></a><span id="l14.147">         try {</span>
<a href="#l14.148"></a><span id="l14.148" class="difflineat">@@ -179,17 +182,17 @@ var gFolderTreeView = {</span>
<a href="#l14.149"></a><span id="l14.149">     // Add this listener so that we can update the tree when things change</span>
<a href="#l14.150"></a><span id="l14.150">     MailServices.mailSession.AddFolderListener(this, Ci.nsIFolderListener.all);</span>
<a href="#l14.151"></a><span id="l14.151">   },</span>
<a href="#l14.152"></a><span id="l14.152"> </span>
<a href="#l14.153"></a><span id="l14.153">   /**</span>
<a href="#l14.154"></a><span id="l14.154">    * Called when the window is being torn down.  Here we undo everything we did</span>
<a href="#l14.155"></a><span id="l14.155">    * onload.  That means removing our listener and serializing our JSON.</span>
<a href="#l14.156"></a><span id="l14.156">    */</span>
<a href="#l14.157"></a><span id="l14.157" class="difflineminus">-  unload: function ftv_unload(aJSONFile) {</span>
<a href="#l14.158"></a><span id="l14.158" class="difflineplus">+  unload(aJSONFile) {</span>
<a href="#l14.159"></a><span id="l14.159">     // Remove our listener</span>
<a href="#l14.160"></a><span id="l14.160">     MailServices.mailSession.RemoveFolderListener(this);</span>
<a href="#l14.161"></a><span id="l14.161"> </span>
<a href="#l14.162"></a><span id="l14.162">     if (aJSONFile) {</span>
<a href="#l14.163"></a><span id="l14.163">       // Write out our json file...</span>
<a href="#l14.164"></a><span id="l14.164">       let data = JSON.stringify(this._persistOpenMap);</span>
<a href="#l14.165"></a><span id="l14.165">       IOUtils.saveStringToFile(aJSONFile, data);</span>
<a href="#l14.166"></a><span id="l14.166">     }</span>
<a href="#l14.167"></a><span id="l14.167" class="difflineat">@@ -197,103 +200,100 @@ var gFolderTreeView = {</span>
<a href="#l14.168"></a><span id="l14.168"> </span>
<a href="#l14.169"></a><span id="l14.169">   /**</span>
<a href="#l14.170"></a><span id="l14.170">    * Extensions can use this function to add a new mode to the folder pane.</span>
<a href="#l14.171"></a><span id="l14.171">    *</span>
<a href="#l14.172"></a><span id="l14.172">    * @param aCommonName  an internal name to identify this mode. Must be unique</span>
<a href="#l14.173"></a><span id="l14.173">    * @param aMode An implementation of |IFolderTreeMode| for this mode.</span>
<a href="#l14.174"></a><span id="l14.174">    * @param aDisplayName  a localized name for this mode</span>
<a href="#l14.175"></a><span id="l14.175">    */</span>
<a href="#l14.176"></a><span id="l14.176" class="difflineminus">-  registerFolderTreeMode: function ftv_registerFolderTreeMode(aCommonName,</span>
<a href="#l14.177"></a><span id="l14.177" class="difflineminus">-                                                              aMode,</span>
<a href="#l14.178"></a><span id="l14.178" class="difflineminus">-                                                              aDisplayName) {</span>
<a href="#l14.179"></a><span id="l14.179" class="difflineplus">+  registerFolderTreeMode(aCommonName, aMode, aDisplayName) {</span>
<a href="#l14.180"></a><span id="l14.180">     this._modeNames.push(aCommonName);</span>
<a href="#l14.181"></a><span id="l14.181">     this._modes[aCommonName] = aMode;</span>
<a href="#l14.182"></a><span id="l14.182">     this._modeDisplayNames[aCommonName] = aDisplayName;</span>
<a href="#l14.183"></a><span id="l14.183">   },</span>
<a href="#l14.184"></a><span id="l14.184"> </span>
<a href="#l14.185"></a><span id="l14.185">   /**</span>
<a href="#l14.186"></a><span id="l14.186">    * Unregisters a previously registered mode. Since common-names must be unique</span>
<a href="#l14.187"></a><span id="l14.187">    * this is all that need be provided to unregister.</span>
<a href="#l14.188"></a><span id="l14.188">    * @param aCommonName  the common-name with which the mode was previously</span>
<a href="#l14.189"></a><span id="l14.189">    *                     registered</span>
<a href="#l14.190"></a><span id="l14.190">    */</span>
<a href="#l14.191"></a><span id="l14.191" class="difflineminus">-  unregisterFolderTreeMode: function ftv_unregisterFolderTreeMode(aCommonName) {</span>
<a href="#l14.192"></a><span id="l14.192" class="difflineplus">+  unregisterFolderTreeMode(aCommonName) {</span>
<a href="#l14.193"></a><span id="l14.193">     this._modeNames.splice(this._modeNames.indexOf(aCommonName), 1);</span>
<a href="#l14.194"></a><span id="l14.194">     delete this._modes[aCommonName];</span>
<a href="#l14.195"></a><span id="l14.195">     delete this._modeDisplayNames[aCommonName];</span>
<a href="#l14.196"></a><span id="l14.196">     if (this._mode == aCommonName)</span>
<a href="#l14.197"></a><span id="l14.197">       this.mode = kDefaultMode;</span>
<a href="#l14.198"></a><span id="l14.198">   },</span>
<a href="#l14.199"></a><span id="l14.199"> </span>
<a href="#l14.200"></a><span id="l14.200">   /**</span>
<a href="#l14.201"></a><span id="l14.201">    * Retrieves a specific mode object</span>
<a href="#l14.202"></a><span id="l14.202">    * @param aCommonName  the common-name with which the mode was previously</span>
<a href="#l14.203"></a><span id="l14.203">    *                     registered</span>
<a href="#l14.204"></a><span id="l14.204">    */</span>
<a href="#l14.205"></a><span id="l14.205" class="difflineminus">-  getFolderTreeMode: function ftv_getFolderTreeMode(aCommonName) {</span>
<a href="#l14.206"></a><span id="l14.206" class="difflineplus">+  getFolderTreeMode(aCommonName) {</span>
<a href="#l14.207"></a><span id="l14.207">     return this._modes[aCommonName];</span>
<a href="#l14.208"></a><span id="l14.208">   },</span>
<a href="#l14.209"></a><span id="l14.209"> </span>
<a href="#l14.210"></a><span id="l14.210">   /**</span>
<a href="#l14.211"></a><span id="l14.211">    * Called to move to the next/prev folder-mode in the list</span>
<a href="#l14.212"></a><span id="l14.212">    *</span>
<a href="#l14.213"></a><span id="l14.213">    * @param aForward  whether or not we should move forward in the list</span>
<a href="#l14.214"></a><span id="l14.214">    */</span>
<a href="#l14.215"></a><span id="l14.215" class="difflineminus">-  cycleMode: function ftv_cycleMode(aForward) {</span>
<a href="#l14.216"></a><span id="l14.216" class="difflineplus">+  cycleMode(aForward) {</span>
<a href="#l14.217"></a><span id="l14.217">     let index = this._modeNames.indexOf(this.mode);</span>
<a href="#l14.218"></a><span id="l14.218">     let offset = aForward ? 1 : this._modeNames.length - 1;</span>
<a href="#l14.219"></a><span id="l14.219">     index = (index + offset) % this._modeNames.length;</span>
<a href="#l14.220"></a><span id="l14.220"> </span>
<a href="#l14.221"></a><span id="l14.221">     this.mode = this._modeNames[index];</span>
<a href="#l14.222"></a><span id="l14.222">   },</span>
<a href="#l14.223"></a><span id="l14.223"> </span>
<a href="#l14.224"></a><span id="l14.224">   /**</span>
<a href="#l14.225"></a><span id="l14.225">    * If the hidden pref is set, then double-clicking on a folder should open it</span>
<a href="#l14.226"></a><span id="l14.226">    *</span>
<a href="#l14.227"></a><span id="l14.227">    * @param event  the double-click event</span>
<a href="#l14.228"></a><span id="l14.228">    */</span>
<a href="#l14.229"></a><span id="l14.229" class="difflineminus">-  onDoubleClick: function ftv_onDoubleClick(aEvent) {</span>
<a href="#l14.230"></a><span id="l14.230" class="difflineplus">+  onDoubleClick(aEvent) {</span>
<a href="#l14.231"></a><span id="l14.231">     if (aEvent.button != 0 || aEvent.originalTarget.localName == &quot;twisty&quot; ||</span>
<a href="#l14.232"></a><span id="l14.232">         aEvent.originalTarget.localName == &quot;slider&quot; ||</span>
<a href="#l14.233"></a><span id="l14.233">         aEvent.originalTarget.localName == &quot;scrollbarbutton&quot;)</span>
<a href="#l14.234"></a><span id="l14.234">       return;</span>
<a href="#l14.235"></a><span id="l14.235"> </span>
<a href="#l14.236"></a><span id="l14.236">     let row = gFolderTreeView._treeElement.treeBoxObject.getRowAt(aEvent.clientX,</span>
<a href="#l14.237"></a><span id="l14.237">                                                                   aEvent.clientY);</span>
<a href="#l14.238"></a><span id="l14.238">     let folderItem = gFolderTreeView._rowMap[row];</span>
<a href="#l14.239"></a><span id="l14.239">     if (folderItem)</span>
<a href="#l14.240"></a><span id="l14.240">       folderItem.command();</span>
<a href="#l14.241"></a><span id="l14.241"> </span>
<a href="#l14.242"></a><span id="l14.242">     // Don't let the double-click toggle the open state of the folder here</span>
<a href="#l14.243"></a><span id="l14.243">     aEvent.stopPropagation();</span>
<a href="#l14.244"></a><span id="l14.244">   },</span>
<a href="#l14.245"></a><span id="l14.245"> </span>
<a href="#l14.246"></a><span id="l14.246" class="difflineminus">-  getFolderAtCoords: function ftv_getFolderAtCoords(aX, aY) {</span>
<a href="#l14.247"></a><span id="l14.247" class="difflineplus">+  getFolderAtCoords(aX, aY) {</span>
<a href="#l14.248"></a><span id="l14.248">     let row = gFolderTreeView._treeElement.treeBoxObject.getRowAt(aX, aY);</span>
<a href="#l14.249"></a><span id="l14.249">     if (row in gFolderTreeView._rowMap)</span>
<a href="#l14.250"></a><span id="l14.250">       return gFolderTreeView._rowMap[row]._folder;</span>
<a href="#l14.251"></a><span id="l14.251">     return null;</span>
<a href="#l14.252"></a><span id="l14.252">   },</span>
<a href="#l14.253"></a><span id="l14.253"> </span>
<a href="#l14.254"></a><span id="l14.254">   /**</span>
<a href="#l14.255"></a><span id="l14.255">    * Toggle displaying the headers of columns in the folder pane.</span>
<a href="#l14.256"></a><span id="l14.256">    * @param aSetup  Set to true if the columns should be set up according</span>
<a href="#l14.257"></a><span id="l14.257">    *                to the pref, not toggle them.</span>
<a href="#l14.258"></a><span id="l14.258">    */</span>
<a href="#l14.259"></a><span id="l14.259" class="difflineminus">-  toggleCols: function(aSetup = false) {</span>
<a href="#l14.260"></a><span id="l14.260" class="difflineplus">+  toggleCols(aSetup = false) {</span>
<a href="#l14.261"></a><span id="l14.261">     if (this._treeElement.getAttribute(&quot;simplelist&quot;) == &quot;true&quot;)</span>
<a href="#l14.262"></a><span id="l14.262">       return;</span>
<a href="#l14.263"></a><span id="l14.263">     let hide = Services.prefs.getBoolPref(&quot;mail.folderpane.showColumns&quot;);</span>
<a href="#l14.264"></a><span id="l14.264">     if (aSetup)</span>
<a href="#l14.265"></a><span id="l14.265">       hide = !hide;</span>
<a href="#l14.266"></a><span id="l14.266">     this._treeElement.setAttribute(&quot;hidecolumnpicker&quot;, hide ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l14.267"></a><span id="l14.267">     for (let columnName of [&quot;folderNameCol&quot;, &quot;folderUnreadCol&quot;,</span>
<a href="#l14.268"></a><span id="l14.268" class="difflineminus">-                            &quot;folderTotalCol&quot;, &quot;folderSizeCol&quot;])</span>
<a href="#l14.269"></a><span id="l14.269" class="difflineminus">-    {</span>
<a href="#l14.270"></a><span id="l14.270" class="difflineplus">+                            &quot;folderTotalCol&quot;, &quot;folderSizeCol&quot;]) {</span>
<a href="#l14.271"></a><span id="l14.271">       let column = document.getElementById(columnName);</span>
<a href="#l14.272"></a><span id="l14.272">       if (!column)</span>
<a href="#l14.273"></a><span id="l14.273">         continue;</span>
<a href="#l14.274"></a><span id="l14.274">       if (hide) {</span>
<a href="#l14.275"></a><span id="l14.275">         column.setAttribute(&quot;hideheader&quot;, &quot;true&quot;);</span>
<a href="#l14.276"></a><span id="l14.276">         column.removeAttribute(&quot;label&quot;);</span>
<a href="#l14.277"></a><span id="l14.277">         if (columnName != &quot;folderNameCol&quot;) {</span>
<a href="#l14.278"></a><span id="l14.278">           if (!aSetup) {</span>
<a href="#l14.279"></a><span id="l14.279" class="difflineat">@@ -327,28 +327,28 @@ var gFolderTreeView = {</span>
<a href="#l14.280"></a><span id="l14.280">       Services.prefs.setBoolPref(&quot;mail.folderpane.showColumns&quot;, !hide);</span>
<a href="#l14.281"></a><span id="l14.281">   },</span>
<a href="#l14.282"></a><span id="l14.282"> </span>
<a href="#l14.283"></a><span id="l14.283">   /**</span>
<a href="#l14.284"></a><span id="l14.284">    * Toggles the compact view of the current mode.</span>
<a href="#l14.285"></a><span id="l14.285">    *</span>
<a href="#l14.286"></a><span id="l14.286">    * @param aCompact  Boolean telling whether compact view should be enabled.</span>
<a href="#l14.287"></a><span id="l14.287">    */</span>
<a href="#l14.288"></a><span id="l14.288" class="difflineminus">-  toggleCompact: function(aCompact) {</span>
<a href="#l14.289"></a><span id="l14.289" class="difflineplus">+  toggleCompact(aCompact) {</span>
<a href="#l14.290"></a><span id="l14.290">     let targetMode = this.fullMode(this.baseMode(), aCompact);</span>
<a href="#l14.291"></a><span id="l14.291">     this.mode = targetMode;</span>
<a href="#l14.292"></a><span id="l14.292">   },</span>
<a href="#l14.293"></a><span id="l14.293"> </span>
<a href="#l14.294"></a><span id="l14.294">   /**</span>
<a href="#l14.295"></a><span id="l14.295">    * Toggles the folder mode, but tries to keep the &quot;compact&quot; variant the same</span>
<a href="#l14.296"></a><span id="l14.296">    * as the previous mode.</span>
<a href="#l14.297"></a><span id="l14.297">    *</span>
<a href="#l14.298"></a><span id="l14.298">    * @param aMode  The base name of the new mode selected.</span>
<a href="#l14.299"></a><span id="l14.299">    */</span>
<a href="#l14.300"></a><span id="l14.300" class="difflineminus">-  toggleMode: function(aMode) {</span>
<a href="#l14.301"></a><span id="l14.301" class="difflineplus">+  toggleMode(aMode) {</span>
<a href="#l14.302"></a><span id="l14.302">     // Take the base name and add compact variant according to the state of the</span>
<a href="#l14.303"></a><span id="l14.303">     // &quot;Compact&quot; checkbox in the UI.</span>
<a href="#l14.304"></a><span id="l14.304">     let userMode = this.fullMode(aMode,</span>
<a href="#l14.305"></a><span id="l14.305">         document.getElementById(&quot;appmenu_compactFolderView&quot;).hasAttribute(&quot;checked&quot;));</span>
<a href="#l14.306"></a><span id="l14.306"> </span>
<a href="#l14.307"></a><span id="l14.307">     // Some combinations of user selection and &quot;Compact view&quot; checkbox are not supported.</span>
<a href="#l14.308"></a><span id="l14.308">     // In that case fall back to a version of this mode that exists.</span>
<a href="#l14.309"></a><span id="l14.309">     if (!(userMode in this._modes)) {</span>
<a href="#l14.310"></a><span id="l14.310" class="difflineat">@@ -364,17 +364,17 @@ var gFolderTreeView = {</span>
<a href="#l14.311"></a><span id="l14.311"> </span>
<a href="#l14.312"></a><span id="l14.312">   /**</span>
<a href="#l14.313"></a><span id="l14.313">    * Update state of checkboxes according to currently selected mode.</span>
<a href="#l14.314"></a><span id="l14.314">    * Synchronize the state of our 2 &quot;compact&quot; menuitems and decide if they</span>
<a href="#l14.315"></a><span id="l14.315">    * should be disabled.</span>
<a href="#l14.316"></a><span id="l14.316">    *</span>
<a href="#l14.317"></a><span id="l14.317">    * @param aMode  The current folder mode.</span>
<a href="#l14.318"></a><span id="l14.318">    */</span>
<a href="#l14.319"></a><span id="l14.319" class="difflineminus">-  _updateCompactState: function(aMode) {</span>
<a href="#l14.320"></a><span id="l14.320" class="difflineplus">+  _updateCompactState(aMode) {</span>
<a href="#l14.321"></a><span id="l14.321">     let checked = aMode.endsWith(&quot;_compact&quot;);</span>
<a href="#l14.322"></a><span id="l14.322">     let menuitem = document.getElementById(&quot;menu_compactFolderView&quot;);</span>
<a href="#l14.323"></a><span id="l14.323">     let appmenuitem = document.getElementById(&quot;appmenu_compactFolderView&quot;);</span>
<a href="#l14.324"></a><span id="l14.324">     if (checked) {</span>
<a href="#l14.325"></a><span id="l14.325">       if (menuitem)</span>
<a href="#l14.326"></a><span id="l14.326">        menuitem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l14.327"></a><span id="l14.327">       if (appmenuitem)</span>
<a href="#l14.328"></a><span id="l14.328">         appmenuitem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l14.329"></a><span id="l14.329" class="difflineat">@@ -427,40 +427,40 @@ var gFolderTreeView = {</span>
<a href="#l14.330"></a><span id="l14.330">   },</span>
<a href="#l14.331"></a><span id="l14.331"> </span>
<a href="#l14.332"></a><span id="l14.332">   /**</span>
<a href="#l14.333"></a><span id="l14.333">    * Name of the mode without the _compact suffix, used e.g. in the menulists.</span>
<a href="#l14.334"></a><span id="l14.334">    *</span>
<a href="#l14.335"></a><span id="l14.335">    * @param aMode  If set, construct the base name from this mode name instead</span>
<a href="#l14.336"></a><span id="l14.336">    *               of the currently active one.</span>
<a href="#l14.337"></a><span id="l14.337">    */</span>
<a href="#l14.338"></a><span id="l14.338" class="difflineminus">-  baseMode: function(aMode) {</span>
<a href="#l14.339"></a><span id="l14.339" class="difflineplus">+  baseMode(aMode) {</span>
<a href="#l14.340"></a><span id="l14.340">     if (!aMode)</span>
<a href="#l14.341"></a><span id="l14.341">       aMode = this.mode;</span>
<a href="#l14.342"></a><span id="l14.342"> </span>
<a href="#l14.343"></a><span id="l14.343">     return aMode.replace(/_compact$/, &quot;&quot;);</span>
<a href="#l14.344"></a><span id="l14.344">   },</span>
<a href="#l14.345"></a><span id="l14.345"> </span>
<a href="#l14.346"></a><span id="l14.346">   /**</span>
<a href="#l14.347"></a><span id="l14.347">    * Name of the mode including the _compact suffix if appropriate.</span>
<a href="#l14.348"></a><span id="l14.348">    *</span>
<a href="#l14.349"></a><span id="l14.349">    * @param aMode  If set, construct the base name from this mode name instead</span>
<a href="#l14.350"></a><span id="l14.350">    *               of the currently active one.</span>
<a href="#l14.351"></a><span id="l14.351">    * @param aCOmpact  Bool value whether to force adding the suffix or not.</span>
<a href="#l14.352"></a><span id="l14.352">    */</span>
<a href="#l14.353"></a><span id="l14.353" class="difflineminus">-  fullMode: function(aMode, aCompact) {</span>
<a href="#l14.354"></a><span id="l14.354" class="difflineplus">+  fullMode(aMode, aCompact) {</span>
<a href="#l14.355"></a><span id="l14.355">     if (!aMode)</span>
<a href="#l14.356"></a><span id="l14.356">       aMode = this.mode;</span>
<a href="#l14.357"></a><span id="l14.357">     if (aCompact == undefined)</span>
<a href="#l14.358"></a><span id="l14.358">       aCompact = aMode.endsWith(&quot;_compact&quot;);</span>
<a href="#l14.359"></a><span id="l14.359"> </span>
<a href="#l14.360"></a><span id="l14.360">     return this.baseMode(aMode) + (aCompact ? &quot;_compact&quot; : &quot;&quot;);</span>
<a href="#l14.361"></a><span id="l14.361">   },</span>
<a href="#l14.362"></a><span id="l14.362"> </span>
<a href="#l14.363"></a><span id="l14.363" class="difflineminus">-  _initFolderModeSelector: function() {</span>
<a href="#l14.364"></a><span id="l14.364" class="difflineplus">+  _initFolderModeSelector() {</span>
<a href="#l14.365"></a><span id="l14.365">     // Populate the mode selector menulist on the toolbar.</span>
<a href="#l14.366"></a><span id="l14.366">     let fullModes = [];</span>
<a href="#l14.367"></a><span id="l14.367">     let compactModes = [];</span>
<a href="#l14.368"></a><span id="l14.368">     for (let mode of this._modeNames) {</span>
<a href="#l14.369"></a><span id="l14.369">       let array = mode.endsWith(&quot;_compact&quot;) ? compactModes : fullModes;</span>
<a href="#l14.370"></a><span id="l14.370">       array.push(mode);</span>
<a href="#l14.371"></a><span id="l14.371">     }</span>
<a href="#l14.372"></a><span id="l14.372"> </span>
<a href="#l14.373"></a><span id="l14.373" class="difflineat">@@ -493,17 +493,17 @@ var gFolderTreeView = {</span>
<a href="#l14.374"></a><span id="l14.374"> </span>
<a href="#l14.375"></a><span id="l14.375">     if ((fullModes.length &gt; 0) &amp;&amp; (compactModes.length &gt; 0))</span>
<a href="#l14.376"></a><span id="l14.376">       modeSelector.menupopup.appendChild(document.createElement(&quot;menuseparator&quot;));</span>
<a href="#l14.377"></a><span id="l14.377"> </span>
<a href="#l14.378"></a><span id="l14.378">     for (let mode of compactModes)</span>
<a href="#l14.379"></a><span id="l14.379">       appendMode(mode);</span>
<a href="#l14.380"></a><span id="l14.380">   },</span>
<a href="#l14.381"></a><span id="l14.381"> </span>
<a href="#l14.382"></a><span id="l14.382" class="difflineminus">-  _selectModeInSelector: function(aMode) {</span>
<a href="#l14.383"></a><span id="l14.383" class="difflineplus">+  _selectModeInSelector(aMode) {</span>
<a href="#l14.384"></a><span id="l14.384">     // Show the mode in the mode selector, if it is on a toolbar.</span>
<a href="#l14.385"></a><span id="l14.385">     let modeSelector = document.getElementById(&quot;folderpane-mode-selector&quot;);</span>
<a href="#l14.386"></a><span id="l14.386">     if (modeSelector) {</span>
<a href="#l14.387"></a><span id="l14.387">       if (!modeSelector.querySelector('[value=&quot;' + aMode + '&quot;]'))</span>
<a href="#l14.388"></a><span id="l14.388">         this._initFolderModeSelector();</span>
<a href="#l14.389"></a><span id="l14.389">       modeSelector.firstChild.value = aMode;</span>
<a href="#l14.390"></a><span id="l14.390">     }</span>
<a href="#l14.391"></a><span id="l14.391">   },</span>
<a href="#l14.392"></a><span id="l14.392" class="difflineat">@@ -515,17 +515,17 @@ var gFolderTreeView = {</span>
<a href="#l14.393"></a><span id="l14.393">    *</span>
<a href="#l14.394"></a><span id="l14.394">    * @param aFolder  the nsIMsgFolder to select</span>
<a href="#l14.395"></a><span id="l14.395">    * @param [aForceSelect] Whether we should switch to the default mode to</span>
<a href="#l14.396"></a><span id="l14.396">    *      select the folder in case we didn't find the folder in the current</span>
<a href="#l14.397"></a><span id="l14.397">    *      view. Defaults to false.</span>
<a href="#l14.398"></a><span id="l14.398">    * @returns true if the folder selection was successful, false if it failed</span>
<a href="#l14.399"></a><span id="l14.399">    *     (probably because the folder isn't in the view at all)</span>
<a href="#l14.400"></a><span id="l14.400">    */</span>
<a href="#l14.401"></a><span id="l14.401" class="difflineminus">-  selectFolder: function ftv_selectFolder(aFolder, aForceSelect = false) {</span>
<a href="#l14.402"></a><span id="l14.402" class="difflineplus">+  selectFolder(aFolder, aForceSelect = false) {</span>
<a href="#l14.403"></a><span id="l14.403">     // &quot;this&quot; inside the nested function refers to the function...</span>
<a href="#l14.404"></a><span id="l14.404">     // Also note that openIfNot is recursive.</span>
<a href="#l14.405"></a><span id="l14.405">     let tree = this;</span>
<a href="#l14.406"></a><span id="l14.406">     let folderTreeMode = this._modes[this._mode];</span>
<a href="#l14.407"></a><span id="l14.407">     function openIfNot(aFolderToOpen) {</span>
<a href="#l14.408"></a><span id="l14.408">       let index = tree.getIndexOfFolder(aFolderToOpen);</span>
<a href="#l14.409"></a><span id="l14.409">       if (index != null) {</span>
<a href="#l14.410"></a><span id="l14.410">         if (!tree._rowMap[index].open)</span>
<a href="#l14.411"></a><span id="l14.411" class="difflineat">@@ -572,77 +572,77 @@ var gFolderTreeView = {</span>
<a href="#l14.412"></a><span id="l14.412">   /**</span>
<a href="#l14.413"></a><span id="l14.413">    * Returns the index of a folder in the current display.</span>
<a href="#l14.414"></a><span id="l14.414">    *</span>
<a href="#l14.415"></a><span id="l14.415">    * @param aFolder  the folder whose index should be returned.</span>
<a href="#l14.416"></a><span id="l14.416">    * @returns The index of the folder in the view (a number).</span>
<a href="#l14.417"></a><span id="l14.417">    * @note If the folder is not in the display (perhaps because one of its</span>
<a href="#l14.418"></a><span id="l14.418">    *       anscetors is collapsed), this function returns null.</span>
<a href="#l14.419"></a><span id="l14.419">    */</span>
<a href="#l14.420"></a><span id="l14.420" class="difflineminus">-  getIndexOfFolder: function ftv_getIndexOfFolder(aFolder) {</span>
<a href="#l14.421"></a><span id="l14.421" class="difflineplus">+  getIndexOfFolder(aFolder) {</span>
<a href="#l14.422"></a><span id="l14.422">     for (let [iRow, row] of this._rowMap.entries()) {</span>
<a href="#l14.423"></a><span id="l14.423">       if (row.id == aFolder.URI)</span>
<a href="#l14.424"></a><span id="l14.424">         return iRow;</span>
<a href="#l14.425"></a><span id="l14.425">     }</span>
<a href="#l14.426"></a><span id="l14.426">     return null;</span>
<a href="#l14.427"></a><span id="l14.427">   },</span>
<a href="#l14.428"></a><span id="l14.428"> </span>
<a href="#l14.429"></a><span id="l14.429">   /**</span>
<a href="#l14.430"></a><span id="l14.430">    * Returns the folder for an index in the current display.</span>
<a href="#l14.431"></a><span id="l14.431">    *</span>
<a href="#l14.432"></a><span id="l14.432">    * @param aIndex the index for which the folder should be returned.</span>
<a href="#l14.433"></a><span id="l14.433">    * @note If the index is out of bounds, this function returns null.</span>
<a href="#l14.434"></a><span id="l14.434">    */</span>
<a href="#l14.435"></a><span id="l14.435" class="difflineminus">-  getFolderForIndex: function ftv_getFolderForIndex(aIndex) {</span>
<a href="#l14.436"></a><span id="l14.436" class="difflineplus">+  getFolderForIndex(aIndex) {</span>
<a href="#l14.437"></a><span id="l14.437">     if (aIndex &lt; 0 || aIndex &gt;= this._rowMap.length)</span>
<a href="#l14.438"></a><span id="l14.438">       return null;</span>
<a href="#l14.439"></a><span id="l14.439">     return this._rowMap[aIndex]._folder;</span>
<a href="#l14.440"></a><span id="l14.440">   },</span>
<a href="#l14.441"></a><span id="l14.441"> </span>
<a href="#l14.442"></a><span id="l14.442">   /**</span>
<a href="#l14.443"></a><span id="l14.443">    * Returns the parent of a folder in the current view. This may be, but is not</span>
<a href="#l14.444"></a><span id="l14.444">    * necessarily, the actual parent of the folder (aFolder.parent). In</span>
<a href="#l14.445"></a><span id="l14.445">    * particular, in the smart view, special folders are usually children of the</span>
<a href="#l14.446"></a><span id="l14.446">    * smart folder of that kind.</span>
<a href="#l14.447"></a><span id="l14.447">    *</span>
<a href="#l14.448"></a><span id="l14.448">    * @param aFolder The folder to get the parent of.</span>
<a href="#l14.449"></a><span id="l14.449">    * @returns The parent of the folder, or null if the parent wasn't found.</span>
<a href="#l14.450"></a><span id="l14.450">    * @note This function does not guarantee that either the folder or its parent</span>
<a href="#l14.451"></a><span id="l14.451">    *       is actually in the view.</span>
<a href="#l14.452"></a><span id="l14.452">    */</span>
<a href="#l14.453"></a><span id="l14.453" class="difflineminus">-  getParentOfFolder: function ftv_getParentOfFolder(aFolder) {</span>
<a href="#l14.454"></a><span id="l14.454" class="difflineplus">+  getParentOfFolder(aFolder) {</span>
<a href="#l14.455"></a><span id="l14.455">     return this._modes[this._mode].getParentOfFolder(aFolder);</span>
<a href="#l14.456"></a><span id="l14.456">   },</span>
<a href="#l14.457"></a><span id="l14.457"> </span>
<a href="#l14.458"></a><span id="l14.458">   /**</span>
<a href="#l14.459"></a><span id="l14.459">    * Given an nsIMsgDBHdr, returns the folder it is considered to be contained</span>
<a href="#l14.460"></a><span id="l14.460">    * in, in the current mode. This is usually, but not necessarily, the actual</span>
<a href="#l14.461"></a><span id="l14.461">    * folder the message is in (aMsgHdr.folder). For more details, see</span>
<a href="#l14.462"></a><span id="l14.462">    * |IFolderTreeMode.getFolderForMsgHdr|.</span>
<a href="#l14.463"></a><span id="l14.463">    */</span>
<a href="#l14.464"></a><span id="l14.464" class="difflineminus">-  getFolderForMsgHdr: function ftv_getFolderForMsgHdr(aMsgHdr) {</span>
<a href="#l14.465"></a><span id="l14.465" class="difflineplus">+  getFolderForMsgHdr(aMsgHdr) {</span>
<a href="#l14.466"></a><span id="l14.466">     return this._modes[this._mode].getFolderForMsgHdr(aMsgHdr);</span>
<a href="#l14.467"></a><span id="l14.467">   },</span>
<a href="#l14.468"></a><span id="l14.468"> </span>
<a href="#l14.469"></a><span id="l14.469">   /**</span>
<a href="#l14.470"></a><span id="l14.470">    * Returns the |ftvItem| for an index in the current display. Intended for use</span>
<a href="#l14.471"></a><span id="l14.471">    * by folder tree mode implementers.</span>
<a href="#l14.472"></a><span id="l14.472">    *</span>
<a href="#l14.473"></a><span id="l14.473">    * @param aIndex The index for which the ftvItem should be returned.</span>
<a href="#l14.474"></a><span id="l14.474">    * @note If the index is out of bounds, this function returns null.</span>
<a href="#l14.475"></a><span id="l14.475">    */</span>
<a href="#l14.476"></a><span id="l14.476" class="difflineminus">-  getFTVItemForIndex: function ftv_getFTVItemForIndex(aIndex) {</span>
<a href="#l14.477"></a><span id="l14.477" class="difflineplus">+  getFTVItemForIndex(aIndex) {</span>
<a href="#l14.478"></a><span id="l14.478">     return this._rowMap[aIndex];</span>
<a href="#l14.479"></a><span id="l14.479">   },</span>
<a href="#l14.480"></a><span id="l14.480"> </span>
<a href="#l14.481"></a><span id="l14.481">   /**</span>
<a href="#l14.482"></a><span id="l14.482">    * Returns an array of nsIMsgFolders corresponding to the current selection</span>
<a href="#l14.483"></a><span id="l14.483">    * in the tree</span>
<a href="#l14.484"></a><span id="l14.484">    */</span>
<a href="#l14.485"></a><span id="l14.485" class="difflineminus">-  getSelectedFolders: function ftv_getSelectedFolders() {</span>
<a href="#l14.486"></a><span id="l14.486" class="difflineplus">+  getSelectedFolders() {</span>
<a href="#l14.487"></a><span id="l14.487">     let selection = this.selection;</span>
<a href="#l14.488"></a><span id="l14.488">     if (!selection)</span>
<a href="#l14.489"></a><span id="l14.489">       return [];</span>
<a href="#l14.490"></a><span id="l14.490"> </span>
<a href="#l14.491"></a><span id="l14.491">     let folderArray = [];</span>
<a href="#l14.492"></a><span id="l14.492">     let rangeCount = selection.getRangeCount();</span>
<a href="#l14.493"></a><span id="l14.493">     for (let i = 0; i &lt; rangeCount; i++) {</span>
<a href="#l14.494"></a><span id="l14.494">       let startIndex = {};</span>
<a href="#l14.495"></a><span id="l14.495" class="difflineat">@@ -660,30 +660,31 @@ var gFolderTreeView = {</span>
<a href="#l14.496"></a><span id="l14.496">    * Adds a new child |ftvItem| to the given parent |ftvItem|. Intended for use</span>
<a href="#l14.497"></a><span id="l14.497">    * by folder tree mode implementers.</span>
<a href="#l14.498"></a><span id="l14.498">    *</span>
<a href="#l14.499"></a><span id="l14.499">    * @param aParentItem The parent ftvItem. It is assumed that this is visible</span>
<a href="#l14.500"></a><span id="l14.500">    *     in the view.</span>
<a href="#l14.501"></a><span id="l14.501">    * @param aParentIndex The index of the parent ftvItem in the view.</span>
<a href="#l14.502"></a><span id="l14.502">    * @param aItem The item to add.</span>
<a href="#l14.503"></a><span id="l14.503">    */</span>
<a href="#l14.504"></a><span id="l14.504" class="difflineminus">-  addChildItem: function ftv_addChildItem(aParentItem, aParentIndex, aItem) {</span>
<a href="#l14.505"></a><span id="l14.505" class="difflineplus">+  addChildItem(aParentItem, aParentIndex, aItem) {</span>
<a href="#l14.506"></a><span id="l14.506">     this._addChildToView(aParentItem, aParentIndex, aItem);</span>
<a href="#l14.507"></a><span id="l14.507">   },</span>
<a href="#l14.508"></a><span id="l14.508"> </span>
<a href="#l14.509"></a><span id="l14.509">   // ****************** Start of nsITreeView implementation **************** //</span>
<a href="#l14.510"></a><span id="l14.510"> </span>
<a href="#l14.511"></a><span id="l14.511">   get rowCount() {</span>
<a href="#l14.512"></a><span id="l14.512">     return this._rowMap.length;</span>
<a href="#l14.513"></a><span id="l14.513">   },</span>
<a href="#l14.514"></a><span id="l14.514"> </span>
<a href="#l14.515"></a><span id="l14.515">   /**</span>
<a href="#l14.516"></a><span id="l14.516">    * drag drop interfaces</span>
<a href="#l14.517"></a><span id="l14.517">    */</span>
<a href="#l14.518"></a><span id="l14.518" class="difflineminus">-  canDrop: function ftv_canDrop(aRow, aOrientation) {</span>
<a href="#l14.519"></a><span id="l14.519" class="difflineplus">+  /* eslint-disable complexity */</span>
<a href="#l14.520"></a><span id="l14.520" class="difflineplus">+  canDrop(aRow, aOrientation) {</span>
<a href="#l14.521"></a><span id="l14.521">     let targetFolder = gFolderTreeView._rowMap[aRow]._folder;</span>
<a href="#l14.522"></a><span id="l14.522">     if (!targetFolder)</span>
<a href="#l14.523"></a><span id="l14.523">       return false;</span>
<a href="#l14.524"></a><span id="l14.524">     let dt = this._currentTransfer;</span>
<a href="#l14.525"></a><span id="l14.525">     let types = Array.from(dt.mozTypesAt(0));</span>
<a href="#l14.526"></a><span id="l14.526">     if (types.includes(&quot;text/x-moz-message&quot;)) {</span>
<a href="#l14.527"></a><span id="l14.527">       if (aOrientation != Ci.nsITreeView.DROP_ON)</span>
<a href="#l14.528"></a><span id="l14.528">         return false;</span>
<a href="#l14.529"></a><span id="l14.529" class="difflineat">@@ -696,32 +697,31 @@ var gFolderTreeView = {</span>
<a href="#l14.530"></a><span id="l14.530">       let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l14.531"></a><span id="l14.531">       for (let i = 0; i &lt; dt.mozItemCount; i++) {</span>
<a href="#l14.532"></a><span id="l14.532">         let msgHdr = messenger.msgHdrFromURI(dt.mozGetDataAt(&quot;text/x-moz-message&quot;, i));</span>
<a href="#l14.533"></a><span id="l14.533">         // Don't allow drop onto original folder.</span>
<a href="#l14.534"></a><span id="l14.534">         if (msgHdr.folder == targetFolder)</span>
<a href="#l14.535"></a><span id="l14.535">           return false;</span>
<a href="#l14.536"></a><span id="l14.536">       }</span>
<a href="#l14.537"></a><span id="l14.537">       return true;</span>
<a href="#l14.538"></a><span id="l14.538" class="difflineminus">-    }</span>
<a href="#l14.539"></a><span id="l14.539" class="difflineminus">-    else if (types.includes(&quot;text/x-moz-folder&quot;)) {</span>
<a href="#l14.540"></a><span id="l14.540" class="difflineplus">+    } else if (types.includes(&quot;text/x-moz-folder&quot;)) {</span>
<a href="#l14.541"></a><span id="l14.541">       if (aOrientation != Ci.nsITreeView.DROP_ON)</span>
<a href="#l14.542"></a><span id="l14.542">         return false;</span>
<a href="#l14.543"></a><span id="l14.543">       // If cannot create subfolders then don't allow drop here.</span>
<a href="#l14.544"></a><span id="l14.544">       if (!targetFolder.canCreateSubfolders)</span>
<a href="#l14.545"></a><span id="l14.545">         return false;</span>
<a href="#l14.546"></a><span id="l14.546">       for (let i = 0; i &lt; dt.mozItemCount; i++) {</span>
<a href="#l14.547"></a><span id="l14.547">         let folder = dt.mozGetDataAt(&quot;text/x-moz-folder&quot;, i)</span>
<a href="#l14.548"></a><span id="l14.548">                        .QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l14.549"></a><span id="l14.549">         // Don't allow to drop on itself.</span>
<a href="#l14.550"></a><span id="l14.550">         if (targetFolder == folder)</span>
<a href="#l14.551"></a><span id="l14.551">           return false;</span>
<a href="#l14.552"></a><span id="l14.552">         // Don't copy within same server.</span>
<a href="#l14.553"></a><span id="l14.553">         if ((folder.server == targetFolder.server) &amp;&amp;</span>
<a href="#l14.554"></a><span id="l14.554" class="difflineminus">-             (dt.dropEffect == 'copy'))</span>
<a href="#l14.555"></a><span id="l14.555" class="difflineplus">+             (dt.dropEffect == &quot;copy&quot;))</span>
<a href="#l14.556"></a><span id="l14.556">           return false;</span>
<a href="#l14.557"></a><span id="l14.557">         // Don't allow immediate child to be dropped onto its parent.</span>
<a href="#l14.558"></a><span id="l14.558">         if (targetFolder == folder.parent)</span>
<a href="#l14.559"></a><span id="l14.559">           return false;</span>
<a href="#l14.560"></a><span id="l14.560">         // Don't allow dragging of virtual folders across accounts.</span>
<a href="#l14.561"></a><span id="l14.561">         if ((folder.getFlag(Ci.nsMsgFolderFlags.Virtual)) &amp;&amp;</span>
<a href="#l14.562"></a><span id="l14.562">             folder.server != targetFolder.server)</span>
<a href="#l14.563"></a><span id="l14.563">           return false;</span>
<a href="#l14.564"></a><span id="l14.564" class="difflineat">@@ -730,18 +730,17 @@ var gFolderTreeView = {</span>
<a href="#l14.565"></a><span id="l14.565">           return false;</span>
<a href="#l14.566"></a><span id="l14.566">         // If there is a folder that can't be renamed, don't allow it to be</span>
<a href="#l14.567"></a><span id="l14.567">         // dropped if it is not to &quot;Local Folders&quot; or is to the same account.</span>
<a href="#l14.568"></a><span id="l14.568">         if (!folder.canRename &amp;&amp; (targetFolder.server.type != &quot;none&quot; ||</span>
<a href="#l14.569"></a><span id="l14.569">                                   folder.server == targetFolder.server))</span>
<a href="#l14.570"></a><span id="l14.570">           return false;</span>
<a href="#l14.571"></a><span id="l14.571">       }</span>
<a href="#l14.572"></a><span id="l14.572">       return true;</span>
<a href="#l14.573"></a><span id="l14.573" class="difflineminus">-    }</span>
<a href="#l14.574"></a><span id="l14.574" class="difflineminus">-    else if (types.includes(&quot;text/x-moz-newsfolder&quot;)) {</span>
<a href="#l14.575"></a><span id="l14.575" class="difflineplus">+    } else if (types.includes(&quot;text/x-moz-newsfolder&quot;)) {</span>
<a href="#l14.576"></a><span id="l14.576">       // Don't allow dragging onto element.</span>
<a href="#l14.577"></a><span id="l14.577">       if (aOrientation == Ci.nsITreeView.DROP_ON)</span>
<a href="#l14.578"></a><span id="l14.578">         return false;</span>
<a href="#l14.579"></a><span id="l14.579">       // Don't allow drop onto server itself.</span>
<a href="#l14.580"></a><span id="l14.580">       if (targetFolder.isServer)</span>
<a href="#l14.581"></a><span id="l14.581">         return false;</span>
<a href="#l14.582"></a><span id="l14.582">       for (let i = 0; i &lt; dt.mozItemCount; i++) {</span>
<a href="#l14.583"></a><span id="l14.583">         let folder = dt.mozGetDataAt(&quot;text/x-moz-newsfolder&quot;, i)</span>
<a href="#l14.584"></a><span id="l14.584" class="difflineat">@@ -755,65 +754,64 @@ var gFolderTreeView = {</span>
<a href="#l14.585"></a><span id="l14.585">         // Don't allow dragging newsgroup to before item after or</span>
<a href="#l14.586"></a><span id="l14.586">         // after item before.</span>
<a href="#l14.587"></a><span id="l14.587">         let row = aRow + aOrientation;</span>
<a href="#l14.588"></a><span id="l14.588">         if (row in gFolderTreeView._rowMap &amp;&amp;</span>
<a href="#l14.589"></a><span id="l14.589">             (gFolderTreeView._rowMap[row]._folder == folder))</span>
<a href="#l14.590"></a><span id="l14.590">           return false;</span>
<a href="#l14.591"></a><span id="l14.591">       }</span>
<a href="#l14.592"></a><span id="l14.592">       return true;</span>
<a href="#l14.593"></a><span id="l14.593" class="difflineminus">-    }</span>
<a href="#l14.594"></a><span id="l14.594" class="difflineminus">-    // Allow subscribing to feeds by dragging an url to a feed account.</span>
<a href="#l14.595"></a><span id="l14.595" class="difflineminus">-    else if (targetFolder.server.type == &quot;rss&quot; &amp;&amp; dt.mozItemCount == 1)</span>
<a href="#l14.596"></a><span id="l14.596" class="difflineminus">-      return FeedUtils.getFeedUriFromDataTransfer(dt) ? true : false;</span>
<a href="#l14.597"></a><span id="l14.597" class="difflineminus">-    else if (types.includes(&quot;application/x-moz-file&quot;)) {</span>
<a href="#l14.598"></a><span id="l14.598" class="difflineplus">+    } else if (targetFolder.server.type == &quot;rss&quot; &amp;&amp; dt.mozItemCount == 1) {</span>
<a href="#l14.599"></a><span id="l14.599" class="difflineplus">+      // Allow subscribing to feeds by dragging an url to a feed account.</span>
<a href="#l14.600"></a><span id="l14.600" class="difflineplus">+      return !!FeedUtils.getFeedUriFromDataTransfer(dt);</span>
<a href="#l14.601"></a><span id="l14.601" class="difflineplus">+    } else if (types.includes(&quot;application/x-moz-file&quot;)) {</span>
<a href="#l14.602"></a><span id="l14.602">       if (aOrientation != Ci.nsITreeView.DROP_ON)</span>
<a href="#l14.603"></a><span id="l14.603">         return false;</span>
<a href="#l14.604"></a><span id="l14.604">       // Don't allow drop onto server itself.</span>
<a href="#l14.605"></a><span id="l14.605">       if (targetFolder.isServer)</span>
<a href="#l14.606"></a><span id="l14.606">         return false;</span>
<a href="#l14.607"></a><span id="l14.607">       // Don't allow drop into a folder that cannot take messages.</span>
<a href="#l14.608"></a><span id="l14.608">       if (!targetFolder.canFileMessages)</span>
<a href="#l14.609"></a><span id="l14.609">         return false;</span>
<a href="#l14.610"></a><span id="l14.610">       for (let i = 0; i &lt; dt.mozItemCount; i++) {</span>
<a href="#l14.611"></a><span id="l14.611">         let extFile = dt.mozGetDataAt(&quot;application/x-moz-file&quot;, i)</span>
<a href="#l14.612"></a><span id="l14.612">                         .QueryInterface(Ci.nsIFile);</span>
<a href="#l14.613"></a><span id="l14.613">         return extFile.isFile();</span>
<a href="#l14.614"></a><span id="l14.614">       }</span>
<a href="#l14.615"></a><span id="l14.615">     }</span>
<a href="#l14.616"></a><span id="l14.616">     return false;</span>
<a href="#l14.617"></a><span id="l14.617">   },</span>
<a href="#l14.618"></a><span id="l14.618" class="difflineminus">-  drop: function ftv_drop(aRow, aOrientation) {</span>
<a href="#l14.619"></a><span id="l14.619" class="difflineplus">+  /* eslint-enable complexity */</span>
<a href="#l14.620"></a><span id="l14.620" class="difflineplus">+  drop(aRow, aOrientation) {</span>
<a href="#l14.621"></a><span id="l14.621">     let targetFolder = gFolderTreeView._rowMap[aRow]._folder;</span>
<a href="#l14.622"></a><span id="l14.622"> </span>
<a href="#l14.623"></a><span id="l14.623">     let dt = this._currentTransfer;</span>
<a href="#l14.624"></a><span id="l14.624">     let count = dt.mozItemCount;</span>
<a href="#l14.625"></a><span id="l14.625">     let cs = MailServices.copy;</span>
<a href="#l14.626"></a><span id="l14.626"> </span>
<a href="#l14.627"></a><span id="l14.627">     // This is a potential rss feed.  A link image as well as link text url</span>
<a href="#l14.628"></a><span id="l14.628">     // should be handled; try to extract a url from non moz apps as well.</span>
<a href="#l14.629"></a><span id="l14.629">     let feedUri = targetFolder.server.type == &quot;rss&quot; &amp;&amp; count == 1 ?</span>
<a href="#l14.630"></a><span id="l14.630">                     FeedUtils.getFeedUriFromDataTransfer(dt) : null;</span>
<a href="#l14.631"></a><span id="l14.631"> </span>
<a href="#l14.632"></a><span id="l14.632">     // we only support drag of a single flavor at a time.</span>
<a href="#l14.633"></a><span id="l14.633">     let types = Array.from(dt.mozTypesAt(0));</span>
<a href="#l14.634"></a><span id="l14.634">     if (types.includes(&quot;text/x-moz-folder&quot;)) {</span>
<a href="#l14.635"></a><span id="l14.635">       for (let i = 0; i &lt; count; i++) {</span>
<a href="#l14.636"></a><span id="l14.636" class="difflineminus">-        let folders = new Array;</span>
<a href="#l14.637"></a><span id="l14.637" class="difflineplus">+        let folders = [];</span>
<a href="#l14.638"></a><span id="l14.638">         folders.push(dt.mozGetDataAt(&quot;text/x-moz-folder&quot;, i)</span>
<a href="#l14.639"></a><span id="l14.639">                        .QueryInterface(Ci.nsIMsgFolder));</span>
<a href="#l14.640"></a><span id="l14.640">         let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l14.641"></a><span id="l14.641">         cs.CopyFolders(array, targetFolder,</span>
<a href="#l14.642"></a><span id="l14.642">                       (folders[0].server == targetFolder.server), null,</span>
<a href="#l14.643"></a><span id="l14.643">                        msgWindow);</span>
<a href="#l14.644"></a><span id="l14.644">       }</span>
<a href="#l14.645"></a><span id="l14.645" class="difflineminus">-    }</span>
<a href="#l14.646"></a><span id="l14.646" class="difflineminus">-    else if (types.includes(&quot;text/x-moz-newsfolder&quot;)) {</span>
<a href="#l14.647"></a><span id="l14.647" class="difflineplus">+    } else if (types.includes(&quot;text/x-moz-newsfolder&quot;)) {</span>
<a href="#l14.648"></a><span id="l14.648">       // Start by getting folders into order.</span>
<a href="#l14.649"></a><span id="l14.649" class="difflineminus">-      let folders = new Array;</span>
<a href="#l14.650"></a><span id="l14.650" class="difflineplus">+      let folders = [];</span>
<a href="#l14.651"></a><span id="l14.651">       for (let i = 0; i &lt; count; i++) {</span>
<a href="#l14.652"></a><span id="l14.652">         let folder = dt.mozGetDataAt(&quot;text/x-moz-newsfolder&quot;, i)</span>
<a href="#l14.653"></a><span id="l14.653">                        .QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l14.654"></a><span id="l14.654">         folders[this.getIndexOfFolder(folder)] = folder;</span>
<a href="#l14.655"></a><span id="l14.655">       }</span>
<a href="#l14.656"></a><span id="l14.656">       let newsFolder = targetFolder.rootFolder</span>
<a href="#l14.657"></a><span id="l14.657">                                    .QueryInterface(Ci.nsIMsgNewsFolder);</span>
<a href="#l14.658"></a><span id="l14.658">       // When moving down, want to insert first one last.</span>
<a href="#l14.659"></a><span id="l14.659" class="difflineat">@@ -822,18 +820,17 @@ var gFolderTreeView = {</span>
<a href="#l14.660"></a><span id="l14.660">       while (i &gt;= 0 &amp;&amp; i &lt; folders.length) {</span>
<a href="#l14.661"></a><span id="l14.661">         let folder = folders[i];</span>
<a href="#l14.662"></a><span id="l14.662">         if (folder) {</span>
<a href="#l14.663"></a><span id="l14.663">           newsFolder.moveFolder(folder, targetFolder, aOrientation);</span>
<a href="#l14.664"></a><span id="l14.664">           this.selection.toggleSelect(this.getIndexOfFolder(folder));</span>
<a href="#l14.665"></a><span id="l14.665">         }</span>
<a href="#l14.666"></a><span id="l14.666">         i -= aOrientation;</span>
<a href="#l14.667"></a><span id="l14.667">       }</span>
<a href="#l14.668"></a><span id="l14.668" class="difflineminus">-    }</span>
<a href="#l14.669"></a><span id="l14.669" class="difflineminus">-    else if (types.includes(&quot;text/x-moz-message&quot;)) {</span>
<a href="#l14.670"></a><span id="l14.670" class="difflineplus">+    } else if (types.includes(&quot;text/x-moz-message&quot;)) {</span>
<a href="#l14.671"></a><span id="l14.671">       let array = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l14.672"></a><span id="l14.672">                     .createInstance(Ci.nsIMutableArray);</span>
<a href="#l14.673"></a><span id="l14.673">       let sourceFolder;</span>
<a href="#l14.674"></a><span id="l14.674">       let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l14.675"></a><span id="l14.675">       for (let i = 0; i &lt; count; i++) {</span>
<a href="#l14.676"></a><span id="l14.676">         let msgHdr = messenger.msgHdrFromURI(dt.mozGetDataAt(&quot;text/x-moz-message&quot;, i));</span>
<a href="#l14.677"></a><span id="l14.677">         if (!i)</span>
<a href="#l14.678"></a><span id="l14.678">           sourceFolder = msgHdr.folder;</span>
<a href="#l14.679"></a><span id="l14.679" class="difflineat">@@ -847,87 +844,84 @@ var gFolderTreeView = {</span>
<a href="#l14.680"></a><span id="l14.680">         isMove = false;</span>
<a href="#l14.681"></a><span id="l14.681"> </span>
<a href="#l14.682"></a><span id="l14.682">       prefBranch.setCharPref(&quot;last_msg_movecopy_target_uri&quot;, targetFolder.URI);</span>
<a href="#l14.683"></a><span id="l14.683">       prefBranch.setBoolPref(&quot;last_msg_movecopy_was_move&quot;, isMove);</span>
<a href="#l14.684"></a><span id="l14.684">       // ### ugh, so this won't work with cross-folder views. We would</span>
<a href="#l14.685"></a><span id="l14.685">       // really need to partition the messages by folder.</span>
<a href="#l14.686"></a><span id="l14.686">       cs.CopyMessages(sourceFolder, array, targetFolder, isMove, null,</span>
<a href="#l14.687"></a><span id="l14.687">                         msgWindow, true);</span>
<a href="#l14.688"></a><span id="l14.688" class="difflineminus">-    }</span>
<a href="#l14.689"></a><span id="l14.689" class="difflineminus">-    else if (feedUri) {</span>
<a href="#l14.690"></a><span id="l14.690" class="difflineplus">+    } else if (feedUri) {</span>
<a href="#l14.691"></a><span id="l14.691">       Cc[&quot;@mozilla.org/newsblog-feed-downloader;1&quot;]</span>
<a href="#l14.692"></a><span id="l14.692">          .getService(Ci.nsINewsBlogFeedDownloader)</span>
<a href="#l14.693"></a><span id="l14.693">          .subscribeToFeed(feedUri.spec, targetFolder, msgWindow);</span>
<a href="#l14.694"></a><span id="l14.694" class="difflineminus">-    }</span>
<a href="#l14.695"></a><span id="l14.695" class="difflineminus">-    else if (types.includes(&quot;application/x-moz-file&quot;)) {</span>
<a href="#l14.696"></a><span id="l14.696" class="difflineplus">+    } else if (types.includes(&quot;application/x-moz-file&quot;)) {</span>
<a href="#l14.697"></a><span id="l14.697">       for (let i = 0; i &lt; count; i++) {</span>
<a href="#l14.698"></a><span id="l14.698">         let extFile = dt.mozGetDataAt(&quot;application/x-moz-file&quot;, i)</span>
<a href="#l14.699"></a><span id="l14.699">                         .QueryInterface(Ci.nsIFile);</span>
<a href="#l14.700"></a><span id="l14.700">         if (extFile.isFile()) {</span>
<a href="#l14.701"></a><span id="l14.701">           let len = extFile.leafName.length;</span>
<a href="#l14.702"></a><span id="l14.702">           if (len &gt; 4 &amp;&amp; extFile.leafName.toLowerCase().endsWith(&quot;.eml&quot;))</span>
<a href="#l14.703"></a><span id="l14.703">             cs.CopyFileMessage(extFile, targetFolder, null, false, 1, &quot;&quot;, null, msgWindow);</span>
<a href="#l14.704"></a><span id="l14.704">         }</span>
<a href="#l14.705"></a><span id="l14.705">       }</span>
<a href="#l14.706"></a><span id="l14.706">     }</span>
<a href="#l14.707"></a><span id="l14.707">   },</span>
<a href="#l14.708"></a><span id="l14.708"> </span>
<a href="#l14.709"></a><span id="l14.709" class="difflineminus">-  _onDragStart: function ftv_dragStart(aEvent) {</span>
<a href="#l14.710"></a><span id="l14.710" class="difflineplus">+  _onDragStart(aEvent) {</span>
<a href="#l14.711"></a><span id="l14.711">     // Ugh, this is ugly but necessary</span>
<a href="#l14.712"></a><span id="l14.712">     let view = gFolderTreeView;</span>
<a href="#l14.713"></a><span id="l14.713"> </span>
<a href="#l14.714"></a><span id="l14.714">     if (aEvent.originalTarget.localName != &quot;treechildren&quot;)</span>
<a href="#l14.715"></a><span id="l14.715">       return;</span>
<a href="#l14.716"></a><span id="l14.716"> </span>
<a href="#l14.717"></a><span id="l14.717">     let folders = view.getSelectedFolders();</span>
<a href="#l14.718"></a><span id="l14.718">     folders = folders.filter(function(f) { return !f.isServer; });</span>
<a href="#l14.719"></a><span id="l14.719">     for (let i in folders) {</span>
<a href="#l14.720"></a><span id="l14.720">       let flavor = folders[i].server.type == &quot;nntp&quot; ? &quot;text/x-moz-newsfolder&quot; :</span>
<a href="#l14.721"></a><span id="l14.721">                                                       &quot;text/x-moz-folder&quot;;</span>
<a href="#l14.722"></a><span id="l14.722">       aEvent.dataTransfer.mozSetDataAt(flavor, folders[i], i);</span>
<a href="#l14.723"></a><span id="l14.723">     }</span>
<a href="#l14.724"></a><span id="l14.724">     aEvent.dataTransfer.effectAllowed = &quot;copyMove&quot;;</span>
<a href="#l14.725"></a><span id="l14.725">     aEvent.dataTransfer.addElement(aEvent.originalTarget);</span>
<a href="#l14.726"></a><span id="l14.726" class="difflineminus">-    return;</span>
<a href="#l14.727"></a><span id="l14.727">   },</span>
<a href="#l14.728"></a><span id="l14.728"> </span>
<a href="#l14.729"></a><span id="l14.729" class="difflineminus">-  _onDragOver: function ftv_onDragOver(aEvent) {</span>
<a href="#l14.730"></a><span id="l14.730" class="difflineplus">+  _onDragOver(aEvent) {</span>
<a href="#l14.731"></a><span id="l14.731">     this._currentTransfer = aEvent.dataTransfer;</span>
<a href="#l14.732"></a><span id="l14.732">   },</span>
<a href="#l14.733"></a><span id="l14.733"> </span>
<a href="#l14.734"></a><span id="l14.734" class="difflineminus">-  _onDragDrop: function ftv_onDragDrop(aEvent) {</span>
<a href="#l14.735"></a><span id="l14.735" class="difflineplus">+  _onDragDrop(aEvent) {</span>
<a href="#l14.736"></a><span id="l14.736">     this._currentTransfer = aEvent.dataTransfer;</span>
<a href="#l14.737"></a><span id="l14.737">   },</span>
<a href="#l14.738"></a><span id="l14.738"> </span>
<a href="#l14.739"></a><span id="l14.739">   /**</span>
<a href="#l14.740"></a><span id="l14.740">    * CSS files will cue off of these.  Note that we reach into the rowMap's</span>
<a href="#l14.741"></a><span id="l14.741">    * items so that custom data-displays can define their own properties</span>
<a href="#l14.742"></a><span id="l14.742">    */</span>
<a href="#l14.743"></a><span id="l14.743" class="difflineminus">-  getCellProperties: function ftv_getCellProperties(aRow, aCol) {</span>
<a href="#l14.744"></a><span id="l14.744" class="difflineplus">+  getCellProperties(aRow, aCol) {</span>
<a href="#l14.745"></a><span id="l14.745">     return this._rowMap[aRow].getProperties(aCol);</span>
<a href="#l14.746"></a><span id="l14.746">   },</span>
<a href="#l14.747"></a><span id="l14.747"> </span>
<a href="#l14.748"></a><span id="l14.748">   /**</span>
<a href="#l14.749"></a><span id="l14.749">    * The actual text to display in the tree</span>
<a href="#l14.750"></a><span id="l14.750">    */</span>
<a href="#l14.751"></a><span id="l14.751" class="difflineminus">-  getCellText: function ftv_getCellText(aRow, aCol) {</span>
<a href="#l14.752"></a><span id="l14.752" class="difflineplus">+  getCellText(aRow, aCol) {</span>
<a href="#l14.753"></a><span id="l14.753">     if ((aCol.id == &quot;folderNameCol&quot;) ||</span>
<a href="#l14.754"></a><span id="l14.754">         (aCol.id == &quot;folderUnreadCol&quot;) ||</span>
<a href="#l14.755"></a><span id="l14.755">         (aCol.id == &quot;folderTotalCol&quot;) ||</span>
<a href="#l14.756"></a><span id="l14.756">         (aCol.id == &quot;folderSizeCol&quot;))</span>
<a href="#l14.757"></a><span id="l14.757">       return this._rowMap[aRow].getText(aCol.id);</span>
<a href="#l14.758"></a><span id="l14.758">     return &quot;&quot;;</span>
<a href="#l14.759"></a><span id="l14.759">   },</span>
<a href="#l14.760"></a><span id="l14.760"> </span>
<a href="#l14.761"></a><span id="l14.761">   /**</span>
<a href="#l14.762"></a><span id="l14.762">    * For feed folders get, cache, and return a favicon. Otherwise return &quot;&quot; to</span>
<a href="#l14.763"></a><span id="l14.763">    * let css set the image per nsITreeView requirements.</span>
<a href="#l14.764"></a><span id="l14.764">    */</span>
<a href="#l14.765"></a><span id="l14.765" class="difflineminus">-  getImageSrc: function(aRow, aCol) {</span>
<a href="#l14.766"></a><span id="l14.766" class="difflineplus">+  getImageSrc(aRow, aCol) {</span>
<a href="#l14.767"></a><span id="l14.767">     if (aCol.id != &quot;folderNameCol&quot;)</span>
<a href="#l14.768"></a><span id="l14.768">       return &quot;&quot;;</span>
<a href="#l14.769"></a><span id="l14.769"> </span>
<a href="#l14.770"></a><span id="l14.770">     let rowItem = gFolderTreeView._rowMap[aRow];</span>
<a href="#l14.771"></a><span id="l14.771">     let folder = rowItem._folder;</span>
<a href="#l14.772"></a><span id="l14.772">     if (folder.server.type != &quot;rss&quot; || folder.isServer)</span>
<a href="#l14.773"></a><span id="l14.773">       return &quot;&quot;;</span>
<a href="#l14.774"></a><span id="l14.774"> </span>
<a href="#l14.775"></a><span id="l14.775" class="difflineat">@@ -945,117 +939,119 @@ var gFolderTreeView = {</span>
<a href="#l14.776"></a><span id="l14.776">     });</span>
<a href="#l14.777"></a><span id="l14.777"> </span>
<a href="#l14.778"></a><span id="l14.778">     // Cache empty string initially to return default while getting favicon,</span>
<a href="#l14.779"></a><span id="l14.779">     // so as to never return here. Alternatively, a blank image could be cached.</span>
<a href="#l14.780"></a><span id="l14.780">     this.setFolderCacheProperty(folder, &quot;favicon&quot;, &quot;&quot;);</span>
<a href="#l14.781"></a><span id="l14.781"> </span>
<a href="#l14.782"></a><span id="l14.782"> </span>
<a href="#l14.783"></a><span id="l14.783">     if (this._treeElement.getAttribute(&quot;simplelist&quot;) == &quot;true&quot;)</span>
<a href="#l14.784"></a><span id="l14.784" class="difflineminus">-      return;</span>
<a href="#l14.785"></a><span id="l14.785" class="difflineplus">+      return &quot;&quot;;</span>
<a href="#l14.786"></a><span id="l14.786"> </span>
<a href="#l14.787"></a><span id="l14.787">     // On startup, allow the ui to paint first before spawning potentially</span>
<a href="#l14.788"></a><span id="l14.788">     // many requests for favicons, even though they are async.</span>
<a href="#l14.789"></a><span id="l14.789">     setTimeout(() =&gt; {</span>
<a href="#l14.790"></a><span id="l14.790">       FeedUtils.getFavicon(folder, null, favicon, window, callback);</span>
<a href="#l14.791"></a><span id="l14.791">     }, 0);</span>
<a href="#l14.792"></a><span id="l14.792" class="difflineplus">+</span>
<a href="#l14.793"></a><span id="l14.793" class="difflineplus">+    return &quot;&quot;;</span>
<a href="#l14.794"></a><span id="l14.794">   },</span>
<a href="#l14.795"></a><span id="l14.795"> </span>
<a href="#l14.796"></a><span id="l14.796">   /**</span>
<a href="#l14.797"></a><span id="l14.797">    * The ftvItems take care of assigning this when created.</span>
<a href="#l14.798"></a><span id="l14.798">    */</span>
<a href="#l14.799"></a><span id="l14.799" class="difflineminus">-  getLevel: function ftv_getLevel(aIndex) {</span>
<a href="#l14.800"></a><span id="l14.800" class="difflineplus">+  getLevel(aIndex) {</span>
<a href="#l14.801"></a><span id="l14.801">     return this._rowMap[aIndex].level;</span>
<a href="#l14.802"></a><span id="l14.802">   },</span>
<a href="#l14.803"></a><span id="l14.803"> </span>
<a href="#l14.804"></a><span id="l14.804">   /**</span>
<a href="#l14.805"></a><span id="l14.805">    * The ftvItems take care of assigning this when building children lists</span>
<a href="#l14.806"></a><span id="l14.806">    */</span>
<a href="#l14.807"></a><span id="l14.807" class="difflineminus">-  getServerNameAdded: function ftv_getServerNameAdded(aIndex) {</span>
<a href="#l14.808"></a><span id="l14.808" class="difflineplus">+  getServerNameAdded(aIndex) {</span>
<a href="#l14.809"></a><span id="l14.809">     return this._rowMap[aIndex].addServerName;</span>
<a href="#l14.810"></a><span id="l14.810">   },</span>
<a href="#l14.811"></a><span id="l14.811"> </span>
<a href="#l14.812"></a><span id="l14.812">   /**</span>
<a href="#l14.813"></a><span id="l14.813">    * This is easy since the ftv items assigned the _parent property when making</span>
<a href="#l14.814"></a><span id="l14.814">    * the child lists</span>
<a href="#l14.815"></a><span id="l14.815">    */</span>
<a href="#l14.816"></a><span id="l14.816" class="difflineminus">-  getParentIndex: function ftv_getParentIndex(aIndex) {</span>
<a href="#l14.817"></a><span id="l14.817" class="difflineplus">+  getParentIndex(aIndex) {</span>
<a href="#l14.818"></a><span id="l14.818">     return this._rowMap.indexOf(this._rowMap[aIndex]._parent);</span>
<a href="#l14.819"></a><span id="l14.819">   },</span>
<a href="#l14.820"></a><span id="l14.820"> </span>
<a href="#l14.821"></a><span id="l14.821">   /**</span>
<a href="#l14.822"></a><span id="l14.822">    * This is duplicative for our normal ftv views, but custom data-displays may</span>
<a href="#l14.823"></a><span id="l14.823">    * want to do something special here</span>
<a href="#l14.824"></a><span id="l14.824">    */</span>
<a href="#l14.825"></a><span id="l14.825" class="difflineminus">-  getRowProperties: function ftv_getRowProperties(aRow) {</span>
<a href="#l14.826"></a><span id="l14.826" class="difflineplus">+  getRowProperties(aRow) {</span>
<a href="#l14.827"></a><span id="l14.827">     return this._rowMap[aRow].getProperties();</span>
<a href="#l14.828"></a><span id="l14.828">   },</span>
<a href="#l14.829"></a><span id="l14.829"> </span>
<a href="#l14.830"></a><span id="l14.830">   /**</span>
<a href="#l14.831"></a><span id="l14.831">    * Check whether there are any more rows with our level before the next row</span>
<a href="#l14.832"></a><span id="l14.832">    * at our parent's level</span>
<a href="#l14.833"></a><span id="l14.833">    */</span>
<a href="#l14.834"></a><span id="l14.834" class="difflineminus">-  hasNextSibling: function ftv_hasNextSibling(aIndex, aNextIndex) {</span>
<a href="#l14.835"></a><span id="l14.835" class="difflineplus">+  hasNextSibling(aIndex, aNextIndex) {</span>
<a href="#l14.836"></a><span id="l14.836">     var currentLevel = this._rowMap[aIndex].level;</span>
<a href="#l14.837"></a><span id="l14.837">     for (var i = aNextIndex + 1; i &lt; this._rowMap.length; i++) {</span>
<a href="#l14.838"></a><span id="l14.838">       if (this._rowMap[i].level == currentLevel)</span>
<a href="#l14.839"></a><span id="l14.839">         return true;</span>
<a href="#l14.840"></a><span id="l14.840">       if (this._rowMap[i].level &lt; currentLevel)</span>
<a href="#l14.841"></a><span id="l14.841">         return false;</span>
<a href="#l14.842"></a><span id="l14.842">     }</span>
<a href="#l14.843"></a><span id="l14.843">     return false;</span>
<a href="#l14.844"></a><span id="l14.844">   },</span>
<a href="#l14.845"></a><span id="l14.845"> </span>
<a href="#l14.846"></a><span id="l14.846">   /**</span>
<a href="#l14.847"></a><span id="l14.847">    * All folders are containers, so we can drag drop messages to them.</span>
<a href="#l14.848"></a><span id="l14.848">    */</span>
<a href="#l14.849"></a><span id="l14.849" class="difflineminus">-  isContainer: function ftv_isContainer(aIndex) {</span>
<a href="#l14.850"></a><span id="l14.850" class="difflineplus">+  isContainer(aIndex) {</span>
<a href="#l14.851"></a><span id="l14.851">     return true;</span>
<a href="#l14.852"></a><span id="l14.852">   },</span>
<a href="#l14.853"></a><span id="l14.853"> </span>
<a href="#l14.854"></a><span id="l14.854" class="difflineminus">-  isContainerEmpty: function ftv_isContainerEmpty(aIndex) {</span>
<a href="#l14.855"></a><span id="l14.855" class="difflineplus">+  isContainerEmpty(aIndex) {</span>
<a href="#l14.856"></a><span id="l14.856">     // If the folder has no children, the container is empty.</span>
<a href="#l14.857"></a><span id="l14.857">     return !this._rowMap[aIndex].children.length;</span>
<a href="#l14.858"></a><span id="l14.858">   },</span>
<a href="#l14.859"></a><span id="l14.859"> </span>
<a href="#l14.860"></a><span id="l14.860">   /**</span>
<a href="#l14.861"></a><span id="l14.861">    * Just look at the ftvItem here</span>
<a href="#l14.862"></a><span id="l14.862">    */</span>
<a href="#l14.863"></a><span id="l14.863" class="difflineminus">-  isContainerOpen: function ftv_isContainerOpen(aIndex) {</span>
<a href="#l14.864"></a><span id="l14.864" class="difflineplus">+  isContainerOpen(aIndex) {</span>
<a href="#l14.865"></a><span id="l14.865">     return this._rowMap[aIndex].open;</span>
<a href="#l14.866"></a><span id="l14.866">   },</span>
<a href="#l14.867"></a><span id="l14.867" class="difflineminus">-  getSummarizedCounts: function(aIndex, aColName) {</span>
<a href="#l14.868"></a><span id="l14.868" class="difflineplus">+  getSummarizedCounts(aIndex, aColName) {</span>
<a href="#l14.869"></a><span id="l14.869">     return this._rowMap[aIndex]._summarizedCounts.get(aColName);</span>
<a href="#l14.870"></a><span id="l14.870">   },</span>
<a href="#l14.871"></a><span id="l14.871" class="difflineminus">-  isEditable: function ftv_isEditable(aRow, aCol) {</span>
<a href="#l14.872"></a><span id="l14.872" class="difflineplus">+  isEditable(aRow, aCol) {</span>
<a href="#l14.873"></a><span id="l14.873">     // We don't support editing rows in the tree yet.  We may want to later as</span>
<a href="#l14.874"></a><span id="l14.874">     // an easier way to rename folders.</span>
<a href="#l14.875"></a><span id="l14.875">     return false;</span>
<a href="#l14.876"></a><span id="l14.876">   },</span>
<a href="#l14.877"></a><span id="l14.877" class="difflineminus">-  isSeparator: function ftv_isSeparator(aIndex) {</span>
<a href="#l14.878"></a><span id="l14.878" class="difflineplus">+  isSeparator(aIndex) {</span>
<a href="#l14.879"></a><span id="l14.879">     // There are no separators in our trees</span>
<a href="#l14.880"></a><span id="l14.880">     return false;</span>
<a href="#l14.881"></a><span id="l14.881">   },</span>
<a href="#l14.882"></a><span id="l14.882" class="difflineminus">-  isSorted: function ftv_isSorted() {</span>
<a href="#l14.883"></a><span id="l14.883" class="difflineplus">+  isSorted() {</span>
<a href="#l14.884"></a><span id="l14.884">     // We do our own customized sorting</span>
<a href="#l14.885"></a><span id="l14.885">     return false;</span>
<a href="#l14.886"></a><span id="l14.886">   },</span>
<a href="#l14.887"></a><span id="l14.887" class="difflineminus">-  setTree: function ftv_setTree(aTree) {</span>
<a href="#l14.888"></a><span id="l14.888" class="difflineplus">+  setTree(aTree) {</span>
<a href="#l14.889"></a><span id="l14.889">     this._tree = aTree;</span>
<a href="#l14.890"></a><span id="l14.890">   },</span>
<a href="#l14.891"></a><span id="l14.891"> </span>
<a href="#l14.892"></a><span id="l14.892">   /**</span>
<a href="#l14.893"></a><span id="l14.893">    * Opens or closes a folder with children.  The logic here is a bit hairy, so</span>
<a href="#l14.894"></a><span id="l14.894">    * be very careful about changing anything.</span>
<a href="#l14.895"></a><span id="l14.895">    */</span>
<a href="#l14.896"></a><span id="l14.896" class="difflineminus">-  toggleOpenState: function ftv_toggleOpenState(aIndex) {</span>
<a href="#l14.897"></a><span id="l14.897" class="difflineplus">+  toggleOpenState(aIndex) {</span>
<a href="#l14.898"></a><span id="l14.898">     this._toggleRow(aIndex, true);</span>
<a href="#l14.899"></a><span id="l14.899">   },</span>
<a href="#l14.900"></a><span id="l14.900"> </span>
<a href="#l14.901"></a><span id="l14.901" class="difflineminus">-  recursivelyAddToMap: function ftv_recursivelyAddToMap(aChild, aNewIndex) {</span>
<a href="#l14.902"></a><span id="l14.902" class="difflineplus">+  recursivelyAddToMap(aChild, aNewIndex) {</span>
<a href="#l14.903"></a><span id="l14.903">     // When we add sub-children, we're going to need to increase our index</span>
<a href="#l14.904"></a><span id="l14.904">     // for the next add item at our own level.</span>
<a href="#l14.905"></a><span id="l14.905">     let count = 0;</span>
<a href="#l14.906"></a><span id="l14.906">     if (aChild.children.length &amp;&amp; aChild.open) {</span>
<a href="#l14.907"></a><span id="l14.907">       for (let [i, child] of Array.from(this._rowMap[aNewIndex].children).entries()) {</span>
<a href="#l14.908"></a><span id="l14.908">         count++;</span>
<a href="#l14.909"></a><span id="l14.909">         let index = Number(aNewIndex) + Number(i) + 1;</span>
<a href="#l14.910"></a><span id="l14.910">         this._rowMap.splice(index, 0, child);</span>
<a href="#l14.911"></a><span id="l14.911" class="difflineat">@@ -1064,18 +1060,17 @@ var gFolderTreeView = {</span>
<a href="#l14.912"></a><span id="l14.912">         count += kidsAdded;</span>
<a href="#l14.913"></a><span id="l14.913">         // Somehow the aNewIndex turns into a string without this.</span>
<a href="#l14.914"></a><span id="l14.914">         aNewIndex = Number(aNewIndex) + kidsAdded;</span>
<a href="#l14.915"></a><span id="l14.915">       }</span>
<a href="#l14.916"></a><span id="l14.916">     }</span>
<a href="#l14.917"></a><span id="l14.917">     return count;</span>
<a href="#l14.918"></a><span id="l14.918">   },</span>
<a href="#l14.919"></a><span id="l14.919"> </span>
<a href="#l14.920"></a><span id="l14.920" class="difflineminus">-  _toggleRow: function toggleRow(aIndex, aExpandServer)</span>
<a href="#l14.921"></a><span id="l14.921" class="difflineminus">-  {</span>
<a href="#l14.922"></a><span id="l14.922" class="difflineplus">+  _toggleRow(aIndex, aExpandServer) {</span>
<a href="#l14.923"></a><span id="l14.923">     // Ok, this is a bit tricky.</span>
<a href="#l14.924"></a><span id="l14.924">     this._rowMap[aIndex].open = !this._rowMap[aIndex].open;</span>
<a href="#l14.925"></a><span id="l14.925">     if (!this._rowMap[aIndex].open) {</span>
<a href="#l14.926"></a><span id="l14.926">       // We're closing the current container.  Remove the children</span>
<a href="#l14.927"></a><span id="l14.927"> </span>
<a href="#l14.928"></a><span id="l14.928">       // Note that we can't simply splice out children.length, because some of</span>
<a href="#l14.929"></a><span id="l14.929">       // them might have children too.  Find out how many items we're actually</span>
<a href="#l14.930"></a><span id="l14.930">       // going to splice</span>
<a href="#l14.931"></a><span id="l14.931" class="difflineat">@@ -1122,44 +1117,41 @@ var gFolderTreeView = {</span>
<a href="#l14.932"></a><span id="l14.932">         if (folder.isServer)</span>
<a href="#l14.933"></a><span id="l14.933">           folder.server.performExpand(msgWindow);</span>
<a href="#l14.934"></a><span id="l14.934">         else if (folder instanceof Ci.nsIMsgImapMailFolder)</span>
<a href="#l14.935"></a><span id="l14.935">           folder.performExpand(msgWindow);</span>
<a href="#l14.936"></a><span id="l14.936">       }</span>
<a href="#l14.937"></a><span id="l14.937">     }</span>
<a href="#l14.938"></a><span id="l14.938">   },</span>
<a href="#l14.939"></a><span id="l14.939"> </span>
<a href="#l14.940"></a><span id="l14.940" class="difflineminus">-  _subFoldersWithStringProperty: function ftv_subFoldersWithStringProperty(folder, folders, aFolderName, deep)</span>
<a href="#l14.941"></a><span id="l14.941" class="difflineminus">-  {</span>
<a href="#l14.942"></a><span id="l14.942" class="difflineplus">+  _subFoldersWithStringProperty(folder, folders, aFolderName, deep) {</span>
<a href="#l14.943"></a><span id="l14.943">     for (let child of fixIterator(folder.subFolders, Ci.nsIMsgFolder)) {</span>
<a href="#l14.944"></a><span id="l14.944">       // if the folder selection is based on a string property, use that</span>
<a href="#l14.945"></a><span id="l14.945">       if (aFolderName == getSmartFolderName(child)) {</span>
<a href="#l14.946"></a><span id="l14.946">         folders.push(child);</span>
<a href="#l14.947"></a><span id="l14.947">         // Add sub-folders if requested.</span>
<a href="#l14.948"></a><span id="l14.948">         if (deep)</span>
<a href="#l14.949"></a><span id="l14.949">           this.addSubFolders(child, folders);</span>
<a href="#l14.950"></a><span id="l14.950" class="difflineminus">-      }</span>
<a href="#l14.951"></a><span id="l14.951" class="difflineminus">-      else</span>
<a href="#l14.952"></a><span id="l14.952" class="difflineplus">+      } else {</span>
<a href="#l14.953"></a><span id="l14.953">         // if this folder doesn't have a property set, check Its children</span>
<a href="#l14.954"></a><span id="l14.954">         this._subFoldersWithStringProperty(child, folders, aFolderName, deep);</span>
<a href="#l14.955"></a><span id="l14.955" class="difflineplus">+      }</span>
<a href="#l14.956"></a><span id="l14.956">     }</span>
<a href="#l14.957"></a><span id="l14.957">   },</span>
<a href="#l14.958"></a><span id="l14.958"> </span>
<a href="#l14.959"></a><span id="l14.959" class="difflineminus">-  _allFoldersWithStringProperty: function ftv_getAllFoldersWithProperty(accounts, aFolderName, deep)</span>
<a href="#l14.960"></a><span id="l14.960" class="difflineminus">-  {</span>
<a href="#l14.961"></a><span id="l14.961" class="difflineplus">+  _allFoldersWithStringProperty(accounts, aFolderName, deep) {</span>
<a href="#l14.962"></a><span id="l14.962">     let folders = [];</span>
<a href="#l14.963"></a><span id="l14.963">     for (let acct of accounts) {</span>
<a href="#l14.964"></a><span id="l14.964">       let folder = acct.incomingServer.rootFolder;</span>
<a href="#l14.965"></a><span id="l14.965">       this._subFoldersWithStringProperty(folder, folders, aFolderName, deep);</span>
<a href="#l14.966"></a><span id="l14.966">     }</span>
<a href="#l14.967"></a><span id="l14.967">     return folders;</span>
<a href="#l14.968"></a><span id="l14.968">   },</span>
<a href="#l14.969"></a><span id="l14.969"> </span>
<a href="#l14.970"></a><span id="l14.970" class="difflineminus">-  _allFoldersWithFlag: function ftv_getAllFolders(accounts, aFolderFlag, deep)</span>
<a href="#l14.971"></a><span id="l14.971" class="difflineminus">-  {</span>
<a href="#l14.972"></a><span id="l14.972" class="difflineplus">+  _allFoldersWithFlag(accounts, aFolderFlag, deep) {</span>
<a href="#l14.973"></a><span id="l14.973">     let folders = [];</span>
<a href="#l14.974"></a><span id="l14.974">     for (let acct of accounts) {</span>
<a href="#l14.975"></a><span id="l14.975">       let foldersWithFlag = acct.incomingServer.rootFolder.getFoldersWithFlags(aFolderFlag);</span>
<a href="#l14.976"></a><span id="l14.976">       if (foldersWithFlag.length &gt; 0) {</span>
<a href="#l14.977"></a><span id="l14.977">         for (let folderWithFlag of fixIterator(foldersWithFlag,</span>
<a href="#l14.978"></a><span id="l14.978">                                                Ci.nsIMsgFolder)) {</span>
<a href="#l14.979"></a><span id="l14.979">           folders.push(folderWithFlag);</span>
<a href="#l14.980"></a><span id="l14.980">           // Add sub-folders of Sent and Archive to the result.</span>
<a href="#l14.981"></a><span id="l14.981" class="difflineat">@@ -1169,17 +1161,17 @@ var gFolderTreeView = {</span>
<a href="#l14.982"></a><span id="l14.982">       }</span>
<a href="#l14.983"></a><span id="l14.983">     }</span>
<a href="#l14.984"></a><span id="l14.984">     return folders;</span>
<a href="#l14.985"></a><span id="l14.985">   },</span>
<a href="#l14.986"></a><span id="l14.986"> </span>
<a href="#l14.987"></a><span id="l14.987">   /**</span>
<a href="#l14.988"></a><span id="l14.988">    * get folders by flag or property based on the value of flag</span>
<a href="#l14.989"></a><span id="l14.989">    */</span>
<a href="#l14.990"></a><span id="l14.990" class="difflineminus">-  _allSmartFolders: function ftv_allSmartFolders(accounts, flag, folderName, deep) {</span>
<a href="#l14.991"></a><span id="l14.991" class="difflineplus">+  _allSmartFolders(accounts, flag, folderName, deep) {</span>
<a href="#l14.992"></a><span id="l14.992">     return flag ?</span>
<a href="#l14.993"></a><span id="l14.993">       gFolderTreeView._allFoldersWithFlag(accounts, flag, deep) :</span>
<a href="#l14.994"></a><span id="l14.994">       gFolderTreeView._allFoldersWithStringProperty(accounts, folderName, deep);</span>
<a href="#l14.995"></a><span id="l14.995">   },</span>
<a href="#l14.996"></a><span id="l14.996"> </span>
<a href="#l14.997"></a><span id="l14.997">   /**</span>
<a href="#l14.998"></a><span id="l14.998">    * Add a smart folder for folders with the passed flag set. But if there's</span>
<a href="#l14.999"></a><span id="l14.999">    * only one folder with the flag set, just put it at the top level.</span>
<a href="#l14.1000"></a><span id="l14.1000" class="difflineat">@@ -1188,19 +1180,17 @@ var gFolderTreeView = {</span>
<a href="#l14.1001"></a><span id="l14.1001">    * @param accounts array of accounts.</span>
<a href="#l14.1002"></a><span id="l14.1002">    * @param smartRootFolder root folder of the smart folders server</span>
<a href="#l14.1003"></a><span id="l14.1003">    * @param flag folder flag to create smart folders for</span>
<a href="#l14.1004"></a><span id="l14.1004">    * @param folderName name to give smart folder</span>
<a href="#l14.1005"></a><span id="l14.1005">    * @param position optional place to put folder item in map. If not specified,</span>
<a href="#l14.1006"></a><span id="l14.1006">    *                 folder item will be appended at the end of map.</span>
<a href="#l14.1007"></a><span id="l14.1007">    * @returns The smart folder's ftvItem if one was added, null otherwise.</span>
<a href="#l14.1008"></a><span id="l14.1008">    */</span>
<a href="#l14.1009"></a><span id="l14.1009" class="difflineminus">-  _addSmartFoldersForFlag: function ftv_addSFForFlag(map, accounts, smartRootFolder,</span>
<a href="#l14.1010"></a><span id="l14.1010" class="difflineminus">-                                                     flag, folderName, position)</span>
<a href="#l14.1011"></a><span id="l14.1011" class="difflineminus">-  {</span>
<a href="#l14.1012"></a><span id="l14.1012" class="difflineplus">+  _addSmartFoldersForFlag(map, accounts, smartRootFolder, flag, folderName, position) {</span>
<a href="#l14.1013"></a><span id="l14.1013">     // If there's only one subFolder, just put it at the root.</span>
<a href="#l14.1014"></a><span id="l14.1014">     let subFolders = gFolderTreeView._allSmartFolders(accounts, flag, folderName, false);</span>
<a href="#l14.1015"></a><span id="l14.1015">     if (flag &amp;&amp; subFolders.length == 1) {</span>
<a href="#l14.1016"></a><span id="l14.1016">       let folderItem = new ftvItem(subFolders[0]);</span>
<a href="#l14.1017"></a><span id="l14.1017">       folderItem._level = 0;</span>
<a href="#l14.1018"></a><span id="l14.1018">       if (flag &amp; Ci.nsMsgFolderFlags.Inbox)</span>
<a href="#l14.1019"></a><span id="l14.1019">         folderItem.__defineGetter__(&quot;children&quot;, () =&gt; []);</span>
<a href="#l14.1020"></a><span id="l14.1020">       if (position == undefined)</span>
<a href="#l14.1021"></a><span id="l14.1021" class="difflineat">@@ -1212,23 +1202,23 @@ var gFolderTreeView = {</span>
<a href="#l14.1022"></a><span id="l14.1022">     }</span>
<a href="#l14.1023"></a><span id="l14.1023"> </span>
<a href="#l14.1024"></a><span id="l14.1024">     let smartFolder;</span>
<a href="#l14.1025"></a><span id="l14.1025">     try {</span>
<a href="#l14.1026"></a><span id="l14.1026">       let folderUri = smartRootFolder.URI + &quot;/&quot; + encodeURI(folderName);</span>
<a href="#l14.1027"></a><span id="l14.1027">       smartFolder = smartRootFolder.getChildWithURI(folderUri, false, true);</span>
<a href="#l14.1028"></a><span id="l14.1028">     } catch (ex) {</span>
<a href="#l14.1029"></a><span id="l14.1029">         smartFolder = null;</span>
<a href="#l14.1030"></a><span id="l14.1030" class="difflineminus">-    };</span>
<a href="#l14.1031"></a><span id="l14.1031" class="difflineplus">+    }</span>
<a href="#l14.1032"></a><span id="l14.1032">     if (!smartFolder) {</span>
<a href="#l14.1033"></a><span id="l14.1033">       let searchFolders = gFolderTreeView._allSmartFolders(accounts, flag, folderName, true);</span>
<a href="#l14.1034"></a><span id="l14.1034">       let searchFolderURIs = &quot;&quot;;</span>
<a href="#l14.1035"></a><span id="l14.1035">       for (let searchFolder of searchFolders) {</span>
<a href="#l14.1036"></a><span id="l14.1036">         if (searchFolderURIs.length)</span>
<a href="#l14.1037"></a><span id="l14.1037" class="difflineminus">-          searchFolderURIs += '|';</span>
<a href="#l14.1038"></a><span id="l14.1038" class="difflineplus">+          searchFolderURIs += &quot;|&quot;;</span>
<a href="#l14.1039"></a><span id="l14.1039">         searchFolderURIs +=  searchFolder.URI;</span>
<a href="#l14.1040"></a><span id="l14.1040">       }</span>
<a href="#l14.1041"></a><span id="l14.1041">       if (!searchFolderURIs.length)</span>
<a href="#l14.1042"></a><span id="l14.1042">         return null;</span>
<a href="#l14.1043"></a><span id="l14.1043">       smartFolder = gFolderTreeView._createVFFolder(folderName, smartRootFolder,</span>
<a href="#l14.1044"></a><span id="l14.1044">                                                     searchFolderURIs, flag);</span>
<a href="#l14.1045"></a><span id="l14.1045">     }</span>
<a href="#l14.1046"></a><span id="l14.1046"> </span>
<a href="#l14.1047"></a><span id="l14.1047" class="difflineat">@@ -1245,83 +1235,81 @@ var gFolderTreeView = {</span>
<a href="#l14.1048"></a><span id="l14.1048"> </span>
<a href="#l14.1049"></a><span id="l14.1049">     let prevChild = null;</span>
<a href="#l14.1050"></a><span id="l14.1050">     // Each child is a level one below the smartFolder</span>
<a href="#l14.1051"></a><span id="l14.1051">     for (let child of smartFolderItem._children) {</span>
<a href="#l14.1052"></a><span id="l14.1052">       child._level = smartFolderItem._level + 1;</span>
<a href="#l14.1053"></a><span id="l14.1053">       child._parent = smartFolderItem;</span>
<a href="#l14.1054"></a><span id="l14.1054">       // don't show sub-folders of the inbox, but I think Archives/Sent, etc</span>
<a href="#l14.1055"></a><span id="l14.1055">       // should have the sub-folders.</span>
<a href="#l14.1056"></a><span id="l14.1056" class="difflineminus">-      if (flag &amp; Ci.nsMsgFolderFlags.Inbox)</span>
<a href="#l14.1057"></a><span id="l14.1057" class="difflineplus">+      if (flag &amp; Ci.nsMsgFolderFlags.Inbox) {</span>
<a href="#l14.1058"></a><span id="l14.1058">         child.__defineGetter__(&quot;children&quot;, () =&gt; []);</span>
<a href="#l14.1059"></a><span id="l14.1059" class="difflineplus">+      }</span>
<a href="#l14.1060"></a><span id="l14.1060">       // If we have consecutive children with the same server, then both</span>
<a href="#l14.1061"></a><span id="l14.1061">       // should display as folder - server.</span>
<a href="#l14.1062"></a><span id="l14.1062">       if (prevChild &amp;&amp; (child._folder.server == prevChild._folder.server)) {</span>
<a href="#l14.1063"></a><span id="l14.1063">         child.addServerName = true;</span>
<a href="#l14.1064"></a><span id="l14.1064">         prevChild.addServerName = true;</span>
<a href="#l14.1065"></a><span id="l14.1065">         prevChild.useServerNameOnly = false;</span>
<a href="#l14.1066"></a><span id="l14.1066" class="difflineminus">-      }</span>
<a href="#l14.1067"></a><span id="l14.1067" class="difflineminus">-      else if (flag)</span>
<a href="#l14.1068"></a><span id="l14.1068" class="difflineplus">+      } else if (flag) {</span>
<a href="#l14.1069"></a><span id="l14.1069">         child.useServerNameOnly = true;</span>
<a href="#l14.1070"></a><span id="l14.1070" class="difflineminus">-      else</span>
<a href="#l14.1071"></a><span id="l14.1071" class="difflineplus">+      } else {</span>
<a href="#l14.1072"></a><span id="l14.1072">         child.addServerName = true;</span>
<a href="#l14.1073"></a><span id="l14.1073" class="difflineplus">+      }</span>
<a href="#l14.1074"></a><span id="l14.1074">       prevChild = child;</span>
<a href="#l14.1075"></a><span id="l14.1075">     }</span>
<a href="#l14.1076"></a><span id="l14.1076">     // new custom folders from addons may contain lots of children, sort them</span>
<a href="#l14.1077"></a><span id="l14.1077">     if (flag == 0)</span>
<a href="#l14.1078"></a><span id="l14.1078">       sortFolderItems(smartFolderItem._children);</span>
<a href="#l14.1079"></a><span id="l14.1079">     return smartFolderItem;</span>
<a href="#l14.1080"></a><span id="l14.1080">   },</span>
<a href="#l14.1081"></a><span id="l14.1081" class="difflineminus">-  _createVFFolder: function ftv_createVFFolder(newName, parentFolder,</span>
<a href="#l14.1082"></a><span id="l14.1082" class="difflineminus">-                                               searchFolderURIs, folderFlag)</span>
<a href="#l14.1083"></a><span id="l14.1083" class="difflineminus">-  {</span>
<a href="#l14.1084"></a><span id="l14.1084" class="difflineplus">+  _createVFFolder(newName, parentFolder, searchFolderURIs, folderFlag) {</span>
<a href="#l14.1085"></a><span id="l14.1085">     let newFolder;</span>
<a href="#l14.1086"></a><span id="l14.1086">     try {</span>
<a href="#l14.1087"></a><span id="l14.1087" class="difflineminus">-      if (parentFolder instanceof(Ci.nsIMsgLocalMailFolder))</span>
<a href="#l14.1088"></a><span id="l14.1088" class="difflineplus">+      if (parentFolder instanceof Ci.nsIMsgLocalMailFolder)</span>
<a href="#l14.1089"></a><span id="l14.1089">         newFolder = parentFolder.createLocalSubfolder(newName);</span>
<a href="#l14.1090"></a><span id="l14.1090">       else</span>
<a href="#l14.1091"></a><span id="l14.1091">         newFolder = parentFolder.addSubfolder(newName);</span>
<a href="#l14.1092"></a><span id="l14.1092">       newFolder.setFlag(Ci.nsMsgFolderFlags.Virtual);</span>
<a href="#l14.1093"></a><span id="l14.1093">       // provide a way to make the top level folder just a container, not</span>
<a href="#l14.1094"></a><span id="l14.1094">       // a search folder</span>
<a href="#l14.1095"></a><span id="l14.1095" class="difflineminus">-      let type = this._modes[&quot;smart&quot;].getSmartFolderTypeByName(newName);</span>
<a href="#l14.1096"></a><span id="l14.1096" class="difflineplus">+      let type = this._modes.smart.getSmartFolderTypeByName(newName);</span>
<a href="#l14.1097"></a><span id="l14.1097">       if (type[3]) { // isSearch</span>
<a href="#l14.1098"></a><span id="l14.1098">         let vfdb = newFolder.msgDatabase;</span>
<a href="#l14.1099"></a><span id="l14.1099">         let dbFolderInfo = vfdb.dBFolderInfo;</span>
<a href="#l14.1100"></a><span id="l14.1100">         // set the view string as a property of the db folder info</span>
<a href="#l14.1101"></a><span id="l14.1101">         // set the original folder name as well.</span>
<a href="#l14.1102"></a><span id="l14.1102">         dbFolderInfo.setCharProperty(&quot;searchStr&quot;, &quot;ALL&quot;);</span>
<a href="#l14.1103"></a><span id="l14.1103">         dbFolderInfo.setCharProperty(&quot;searchFolderUri&quot;, searchFolderURIs);</span>
<a href="#l14.1104"></a><span id="l14.1104">         dbFolderInfo.setUint32Property(&quot;searchFolderFlag&quot;, folderFlag);</span>
<a href="#l14.1105"></a><span id="l14.1105">         dbFolderInfo.setBooleanProperty(&quot;searchOnline&quot;, true);</span>
<a href="#l14.1106"></a><span id="l14.1106">         vfdb.summaryValid = true;</span>
<a href="#l14.1107"></a><span id="l14.1107">         vfdb.Close(true);</span>
<a href="#l14.1108"></a><span id="l14.1108">       }</span>
<a href="#l14.1109"></a><span id="l14.1109">       parentFolder.NotifyItemAdded(newFolder);</span>
<a href="#l14.1110"></a><span id="l14.1110">       MailServices.accounts.saveVirtualFolders();</span>
<a href="#l14.1111"></a><span id="l14.1111" class="difflineminus">-    }</span>
<a href="#l14.1112"></a><span id="l14.1112" class="difflineminus">-    catch(e) {</span>
<a href="#l14.1113"></a><span id="l14.1113" class="difflineminus">-       throw(e);</span>
<a href="#l14.1114"></a><span id="l14.1114" class="difflineminus">-       dump (&quot;Exception : creating virtual folder \n&quot;);</span>
<a href="#l14.1115"></a><span id="l14.1115" class="difflineplus">+    } catch (e) {</span>
<a href="#l14.1116"></a><span id="l14.1116" class="difflineplus">+      dump(&quot;Exception : creating virtual folder \n&quot;);</span>
<a href="#l14.1117"></a><span id="l14.1117" class="difflineplus">+      throw e;</span>
<a href="#l14.1118"></a><span id="l14.1118">     }</span>
<a href="#l14.1119"></a><span id="l14.1119">     return newFolder;</span>
<a href="#l14.1120"></a><span id="l14.1120">   },</span>
<a href="#l14.1121"></a><span id="l14.1121"> </span>
<a href="#l14.1122"></a><span id="l14.1122">   // We don't implement any of these at the moment</span>
<a href="#l14.1123"></a><span id="l14.1123" class="difflineminus">-  performAction: function ftv_performAction(aAction) {},</span>
<a href="#l14.1124"></a><span id="l14.1124" class="difflineminus">-  performActionOnCell: function ftv_performActionOnCell(aAction, aRow, aCol) {},</span>
<a href="#l14.1125"></a><span id="l14.1125" class="difflineminus">-  performActionOnRow: function ftv_performActionOnRow(aAction, aRow) {},</span>
<a href="#l14.1126"></a><span id="l14.1126" class="difflineminus">-  selectionChanged: function ftv_selectionChanged() {},</span>
<a href="#l14.1127"></a><span id="l14.1127" class="difflineminus">-  setCellText: function ftv_setCellText(aRow, aCol, aValue) {},</span>
<a href="#l14.1128"></a><span id="l14.1128" class="difflineminus">-  setCellValue: function ftv_setCellValue(aRow, aCol, aValue) {},</span>
<a href="#l14.1129"></a><span id="l14.1129" class="difflineminus">-  getCellValue: function ftv_getCellValue(aRow, aCol) {},</span>
<a href="#l14.1130"></a><span id="l14.1130" class="difflineminus">-  getColumnProperties: function ftv_getColumnProperties(aCol) { return &quot;&quot;; },</span>
<a href="#l14.1131"></a><span id="l14.1131" class="difflineminus">-  getProgressMode: function ftv_getProgressMode(aRow, aCol) {},</span>
<a href="#l14.1132"></a><span id="l14.1132" class="difflineminus">-  cycleCell: function ftv_cycleCell(aRow, aCol) {},</span>
<a href="#l14.1133"></a><span id="l14.1133" class="difflineminus">-  cycleHeader: function ftv_cycleHeader(aCol) {},</span>
<a href="#l14.1134"></a><span id="l14.1134" class="difflineplus">+  performAction(aAction) {},</span>
<a href="#l14.1135"></a><span id="l14.1135" class="difflineplus">+  performActionOnCell(aAction, aRow, aCol) {},</span>
<a href="#l14.1136"></a><span id="l14.1136" class="difflineplus">+  performActionOnRow(aAction, aRow) {},</span>
<a href="#l14.1137"></a><span id="l14.1137" class="difflineplus">+  selectionChanged() {},</span>
<a href="#l14.1138"></a><span id="l14.1138" class="difflineplus">+  setCellText(aRow, aCol, aValue) {},</span>
<a href="#l14.1139"></a><span id="l14.1139" class="difflineplus">+  setCellValue(aRow, aCol, aValue) {},</span>
<a href="#l14.1140"></a><span id="l14.1140" class="difflineplus">+  getCellValue(aRow, aCol) {},</span>
<a href="#l14.1141"></a><span id="l14.1141" class="difflineplus">+  getColumnProperties(aCol) { return &quot;&quot;; },</span>
<a href="#l14.1142"></a><span id="l14.1142" class="difflineplus">+  getProgressMode(aRow, aCol) {},</span>
<a href="#l14.1143"></a><span id="l14.1143" class="difflineplus">+  cycleCell(aRow, aCol) {},</span>
<a href="#l14.1144"></a><span id="l14.1144" class="difflineplus">+  cycleHeader(aCol) {},</span>
<a href="#l14.1145"></a><span id="l14.1145"> </span>
<a href="#l14.1146"></a><span id="l14.1146">   // ****************** End of nsITreeView implementation **************** //</span>
<a href="#l14.1147"></a><span id="l14.1147"> </span>
<a href="#l14.1148"></a><span id="l14.1148">   //</span>
<a href="#l14.1149"></a><span id="l14.1149">   // WARNING: Everything below this point is considered private.  Touch at your</span>
<a href="#l14.1150"></a><span id="l14.1150">   //          own risk.</span>
<a href="#l14.1151"></a><span id="l14.1151"> </span>
<a href="#l14.1152"></a><span id="l14.1152">   /**</span>
<a href="#l14.1153"></a><span id="l14.1153" class="difflineat">@@ -1342,17 +1330,17 @@ var gFolderTreeView = {</span>
<a href="#l14.1154"></a><span id="l14.1154">    * persist their state over-time.  It is designed to be used as a JSON object.</span>
<a href="#l14.1155"></a><span id="l14.1155">    */</span>
<a href="#l14.1156"></a><span id="l14.1156">   _persistOpenMap: {},</span>
<a href="#l14.1157"></a><span id="l14.1157">   _notPersistedModes: [&quot;unread&quot;, &quot;unread_compact&quot;, &quot;favorite&quot;, &quot;favorite_compact&quot;, &quot;recent_compact&quot;],</span>
<a href="#l14.1158"></a><span id="l14.1158"> </span>
<a href="#l14.1159"></a><span id="l14.1159">   /**</span>
<a href="#l14.1160"></a><span id="l14.1160">    * Iterate over the persistent list and open the items (folders) stored in it.</span>
<a href="#l14.1161"></a><span id="l14.1161">    */</span>
<a href="#l14.1162"></a><span id="l14.1162" class="difflineminus">-  _restoreOpenStates: function ftv__persistOpenStates() {</span>
<a href="#l14.1163"></a><span id="l14.1163" class="difflineplus">+  _restoreOpenStates() {</span>
<a href="#l14.1164"></a><span id="l14.1164">     let mode = this.mode;</span>
<a href="#l14.1165"></a><span id="l14.1165">     // Remove any saved state of modes where open state should not be persisted.</span>
<a href="#l14.1166"></a><span id="l14.1166">     // This is mostly for migration from older profiles that may have the info stored.</span>
<a href="#l14.1167"></a><span id="l14.1167">     if (this._notPersistedModes.includes(mode)) {</span>
<a href="#l14.1168"></a><span id="l14.1168">       delete this._persistOpenMap[mode];</span>
<a href="#l14.1169"></a><span id="l14.1169">     }</span>
<a href="#l14.1170"></a><span id="l14.1170"> </span>
<a href="#l14.1171"></a><span id="l14.1171">     let curLevel = 0;</span>
<a href="#l14.1172"></a><span id="l14.1172" class="difflineat">@@ -1384,17 +1372,17 @@ var gFolderTreeView = {</span>
<a href="#l14.1173"></a><span id="l14.1173">   },</span>
<a href="#l14.1174"></a><span id="l14.1174"> </span>
<a href="#l14.1175"></a><span id="l14.1175">   /**</span>
<a href="#l14.1176"></a><span id="l14.1176">    * Remove the item from the persistent list, meaning the item should</span>
<a href="#l14.1177"></a><span id="l14.1177">    * be persisted as closed in the tree.</span>
<a href="#l14.1178"></a><span id="l14.1178">    *</span>
<a href="#l14.1179"></a><span id="l14.1179">    * @param aItemId  The URI of the folder item.</span>
<a href="#l14.1180"></a><span id="l14.1180">    */</span>
<a href="#l14.1181"></a><span id="l14.1181" class="difflineminus">-  _persistItemClosed: function ftv_unpersistItem(aItemId) {</span>
<a href="#l14.1182"></a><span id="l14.1182" class="difflineplus">+  _persistItemClosed(aItemId) {</span>
<a href="#l14.1183"></a><span id="l14.1183">     let mode = this.mode;</span>
<a href="#l14.1184"></a><span id="l14.1184">     if (this._notPersistedModes.includes(mode))</span>
<a href="#l14.1185"></a><span id="l14.1185">       return;</span>
<a href="#l14.1186"></a><span id="l14.1186"> </span>
<a href="#l14.1187"></a><span id="l14.1187">     // If the whole mode is not in the map yet,</span>
<a href="#l14.1188"></a><span id="l14.1188">     // we can silently ignore the folder removal.</span>
<a href="#l14.1189"></a><span id="l14.1189">     if (!this._persistOpenMap[mode])</span>
<a href="#l14.1190"></a><span id="l14.1190">       return;</span>
<a href="#l14.1191"></a><span id="l14.1191" class="difflineat">@@ -1405,17 +1393,17 @@ var gFolderTreeView = {</span>
<a href="#l14.1192"></a><span id="l14.1192">   },</span>
<a href="#l14.1193"></a><span id="l14.1193"> </span>
<a href="#l14.1194"></a><span id="l14.1194">   /**</span>
<a href="#l14.1195"></a><span id="l14.1195">    * Add the item from the persistent list, meaning the item should</span>
<a href="#l14.1196"></a><span id="l14.1196">    * be persisted as open (expanded) in the tree.</span>
<a href="#l14.1197"></a><span id="l14.1197">    *</span>
<a href="#l14.1198"></a><span id="l14.1198">    * @param aItemId  The URI of the folder item.</span>
<a href="#l14.1199"></a><span id="l14.1199">    */</span>
<a href="#l14.1200"></a><span id="l14.1200" class="difflineminus">-  _persistItemOpen: function ftv_persistItem(aItemId) {</span>
<a href="#l14.1201"></a><span id="l14.1201" class="difflineplus">+  _persistItemOpen(aItemId) {</span>
<a href="#l14.1202"></a><span id="l14.1202">     let mode = this.mode;</span>
<a href="#l14.1203"></a><span id="l14.1203">     if (this._notPersistedModes.includes(mode))</span>
<a href="#l14.1204"></a><span id="l14.1204">       return;</span>
<a href="#l14.1205"></a><span id="l14.1205"> </span>
<a href="#l14.1206"></a><span id="l14.1206">     if (!this._persistOpenMap[mode])</span>
<a href="#l14.1207"></a><span id="l14.1207">       this._persistOpenMap[mode] = [];</span>
<a href="#l14.1208"></a><span id="l14.1208"> </span>
<a href="#l14.1209"></a><span id="l14.1209">     if (!this._persistOpenMap[mode].includes(aItemId))</span>
<a href="#l14.1210"></a><span id="l14.1210" class="difflineat">@@ -1428,58 +1416,57 @@ var gFolderTreeView = {</span>
<a href="#l14.1211"></a><span id="l14.1211">    * An array of ftvItems, where each item corresponds to a row in the tree</span>
<a href="#l14.1212"></a><span id="l14.1212">    */</span>
<a href="#l14.1213"></a><span id="l14.1213">   _rowMap: null,</span>
<a href="#l14.1214"></a><span id="l14.1214"> </span>
<a href="#l14.1215"></a><span id="l14.1215">   /**</span>
<a href="#l14.1216"></a><span id="l14.1216">    * Completely discards the current tree and rebuilds it based on current</span>
<a href="#l14.1217"></a><span id="l14.1217">    * settings</span>
<a href="#l14.1218"></a><span id="l14.1218">    */</span>
<a href="#l14.1219"></a><span id="l14.1219" class="difflineminus">-  _rebuild: function ftv__rebuild() {</span>
<a href="#l14.1220"></a><span id="l14.1220" class="difflineplus">+  _rebuild() {</span>
<a href="#l14.1221"></a><span id="l14.1221">     let newRowMap;</span>
<a href="#l14.1222"></a><span id="l14.1222">     try {</span>
<a href="#l14.1223"></a><span id="l14.1223">       newRowMap = this._modes[this.mode].generateMap(this);</span>
<a href="#l14.1224"></a><span id="l14.1224" class="difflineminus">-    } catch(ex) {</span>
<a href="#l14.1225"></a><span id="l14.1225" class="difflineplus">+    } catch (ex) {</span>
<a href="#l14.1226"></a><span id="l14.1226">       Services.console.logStringMessage(&quot;generator &quot; + this.mode + &quot; failed with exception: &quot; + ex);</span>
<a href="#l14.1227"></a><span id="l14.1227">       this.mode = kDefaultMode;</span>
<a href="#l14.1228"></a><span id="l14.1228">       newRowMap = this._modes[this.mode].generateMap(this);</span>
<a href="#l14.1229"></a><span id="l14.1229">     }</span>
<a href="#l14.1230"></a><span id="l14.1230">     let selectedFolders = this.getSelectedFolders();</span>
<a href="#l14.1231"></a><span id="l14.1231">     if (this.selection)</span>
<a href="#l14.1232"></a><span id="l14.1232">       this.selection.clearSelection();</span>
<a href="#l14.1233"></a><span id="l14.1233">     // There's a chance the call to the map generator altered this._rowMap, so</span>
<a href="#l14.1234"></a><span id="l14.1234">     // evaluate oldCount after calling it rather than before</span>
<a href="#l14.1235"></a><span id="l14.1235">     let oldCount = this._rowMap ? this._rowMap.length : null;</span>
<a href="#l14.1236"></a><span id="l14.1236">     this._rowMap = newRowMap;</span>
<a href="#l14.1237"></a><span id="l14.1237"> </span>
<a href="#l14.1238"></a><span id="l14.1238">     this._treeElement.dispatchEvent(new Event(&quot;mapRebuild&quot;,  // Introduced in bug 474822 for add-ons.</span>
<a href="#l14.1239"></a><span id="l14.1239">       { bubbles: true, cancelable: false }));</span>
<a href="#l14.1240"></a><span id="l14.1240"> </span>
<a href="#l14.1241"></a><span id="l14.1241" class="difflineminus">-    if (this._tree)</span>
<a href="#l14.1242"></a><span id="l14.1242" class="difflineminus">-    {</span>
<a href="#l14.1243"></a><span id="l14.1243" class="difflineplus">+    if (this._tree) {</span>
<a href="#l14.1244"></a><span id="l14.1244">       if (oldCount !== null)</span>
<a href="#l14.1245"></a><span id="l14.1245">           this._tree.rowCountChanged(0, this._rowMap.length - oldCount);</span>
<a href="#l14.1246"></a><span id="l14.1246">       this._tree.invalidate();</span>
<a href="#l14.1247"></a><span id="l14.1247">     }</span>
<a href="#l14.1248"></a><span id="l14.1248">     this._restoreOpenStates();</span>
<a href="#l14.1249"></a><span id="l14.1249">     // restore selection.</span>
<a href="#l14.1250"></a><span id="l14.1250">     for (let folder of selectedFolders) {</span>
<a href="#l14.1251"></a><span id="l14.1251">       if (folder) {</span>
<a href="#l14.1252"></a><span id="l14.1252">         let index = this.getIndexOfFolder(folder);</span>
<a href="#l14.1253"></a><span id="l14.1253">         if (index != null)</span>
<a href="#l14.1254"></a><span id="l14.1254">           this.selection.toggleSelect(index);</span>
<a href="#l14.1255"></a><span id="l14.1255">       }</span>
<a href="#l14.1256"></a><span id="l14.1256">     }</span>
<a href="#l14.1257"></a><span id="l14.1257">   },</span>
<a href="#l14.1258"></a><span id="l14.1258"> </span>
<a href="#l14.1259"></a><span id="l14.1259" class="difflineminus">-  _sortedAccounts: function ftv_getSortedAccounts() {</span>
<a href="#l14.1260"></a><span id="l14.1260" class="difflineplus">+  _sortedAccounts() {</span>
<a href="#l14.1261"></a><span id="l14.1261">     let accounts = allAccountsSorted(true);</span>
<a href="#l14.1262"></a><span id="l14.1262"> </span>
<a href="#l14.1263"></a><span id="l14.1263">     // Don't show deferred pop accounts.</span>
<a href="#l14.1264"></a><span id="l14.1264" class="difflineminus">-    accounts = accounts.filter(function isNotDeferred(a) {</span>
<a href="#l14.1265"></a><span id="l14.1265" class="difflineplus">+    accounts = accounts.filter(function(a) {</span>
<a href="#l14.1266"></a><span id="l14.1266">       let server = a.incomingServer;</span>
<a href="#l14.1267"></a><span id="l14.1267">       return !(server instanceof Ci.nsIPop3IncomingServer &amp;&amp;</span>
<a href="#l14.1268"></a><span id="l14.1268">                server.deferredToAccount);</span>
<a href="#l14.1269"></a><span id="l14.1269">     });</span>
<a href="#l14.1270"></a><span id="l14.1270"> </span>
<a href="#l14.1271"></a><span id="l14.1271">     return accounts;</span>
<a href="#l14.1272"></a><span id="l14.1272">   },</span>
<a href="#l14.1273"></a><span id="l14.1273"> </span>
<a href="#l14.1274"></a><span id="l14.1274" class="difflineat">@@ -1492,34 +1479,34 @@ var gFolderTreeView = {</span>
<a href="#l14.1275"></a><span id="l14.1275"> </span>
<a href="#l14.1276"></a><span id="l14.1276">   /**</span>
<a href="#l14.1277"></a><span id="l14.1277">    * Update a folder property in the session cache.</span>
<a href="#l14.1278"></a><span id="l14.1278">    *</span>
<a href="#l14.1279"></a><span id="l14.1279">    * @param  nsIMsgFolder aFolder   - folder.</span>
<a href="#l14.1280"></a><span id="l14.1280">    * @param  string aProperty       - property, currently in &quot;favicon&quot;.</span>
<a href="#l14.1281"></a><span id="l14.1281">    * @param  aValue                 - string or object value.</span>
<a href="#l14.1282"></a><span id="l14.1282">    */</span>
<a href="#l14.1283"></a><span id="l14.1283" class="difflineminus">-  setFolderCacheProperty: function(aFolder, aProperty, aValue) {</span>
<a href="#l14.1284"></a><span id="l14.1284" class="difflineplus">+  setFolderCacheProperty(aFolder, aProperty, aValue) {</span>
<a href="#l14.1285"></a><span id="l14.1285">     if (!aFolder || !aProperty)</span>
<a href="#l14.1286"></a><span id="l14.1286">       return;</span>
<a href="#l14.1287"></a><span id="l14.1287"> </span>
<a href="#l14.1288"></a><span id="l14.1288">     if (!this._cache[aFolder.URI])</span>
<a href="#l14.1289"></a><span id="l14.1289">       this._cache[aFolder.URI] = {};</span>
<a href="#l14.1290"></a><span id="l14.1290"> </span>
<a href="#l14.1291"></a><span id="l14.1291">     this._cache[aFolder.URI][aProperty] = aValue;</span>
<a href="#l14.1292"></a><span id="l14.1292">   },</span>
<a href="#l14.1293"></a><span id="l14.1293"> </span>
<a href="#l14.1294"></a><span id="l14.1294">   /**</span>
<a href="#l14.1295"></a><span id="l14.1295">    * Get a folder property from the session cache.</span>
<a href="#l14.1296"></a><span id="l14.1296">    *</span>
<a href="#l14.1297"></a><span id="l14.1297">    * @param  nsIMsgFolder aFolder   - folder.</span>
<a href="#l14.1298"></a><span id="l14.1298">    * @param  string aProperty       - property key.</span>
<a href="#l14.1299"></a><span id="l14.1299">    * @return value or null          - null indicates uninitialized.</span>
<a href="#l14.1300"></a><span id="l14.1300">    */</span>
<a href="#l14.1301"></a><span id="l14.1301" class="difflineminus">-  getFolderCacheProperty: function(aFolder, aProperty) {</span>
<a href="#l14.1302"></a><span id="l14.1302" class="difflineplus">+  getFolderCacheProperty(aFolder, aProperty) {</span>
<a href="#l14.1303"></a><span id="l14.1303">     if (!aFolder || !aProperty)</span>
<a href="#l14.1304"></a><span id="l14.1304">       return null;</span>
<a href="#l14.1305"></a><span id="l14.1305"> </span>
<a href="#l14.1306"></a><span id="l14.1306">     if (!(aFolder.URI in this._cache) ||</span>
<a href="#l14.1307"></a><span id="l14.1307">         !(aProperty in this._cache[aFolder.URI]))</span>
<a href="#l14.1308"></a><span id="l14.1308">       return null;</span>
<a href="#l14.1309"></a><span id="l14.1309"> </span>
<a href="#l14.1310"></a><span id="l14.1310">     return this._cache[aFolder.URI][aProperty];</span>
<a href="#l14.1311"></a><span id="l14.1311" class="difflineat">@@ -1532,77 +1519,77 @@ var gFolderTreeView = {</span>
<a href="#l14.1312"></a><span id="l14.1312">    */</span>
<a href="#l14.1313"></a><span id="l14.1313">   _modes: {</span>
<a href="#l14.1314"></a><span id="l14.1314">     /**</span>
<a href="#l14.1315"></a><span id="l14.1315">      * The all mode returns all folders, arranged in a hierarchy</span>
<a href="#l14.1316"></a><span id="l14.1316">      */</span>
<a href="#l14.1317"></a><span id="l14.1317">     all: {</span>
<a href="#l14.1318"></a><span id="l14.1318">       __proto__: IFolderTreeMode,</span>
<a href="#l14.1319"></a><span id="l14.1319"> </span>
<a href="#l14.1320"></a><span id="l14.1320" class="difflineminus">-      generateMap: function ftv_all_generateMap(ftv) {</span>
<a href="#l14.1321"></a><span id="l14.1321" class="difflineplus">+      generateMap(ftv) {</span>
<a href="#l14.1322"></a><span id="l14.1322">         let accounts = gFolderTreeView._sortedAccounts();</span>
<a href="#l14.1323"></a><span id="l14.1323">         // force each root folder to do its local subfolder discovery.</span>
<a href="#l14.1324"></a><span id="l14.1324">         MailUtils.discoverFolders();</span>
<a href="#l14.1325"></a><span id="l14.1325"> </span>
<a href="#l14.1326"></a><span id="l14.1326">         return accounts.map(acct =&gt; new ftvItem(acct.incomingServer.rootFolder));</span>
<a href="#l14.1327"></a><span id="l14.1327" class="difflineminus">-      }</span>
<a href="#l14.1328"></a><span id="l14.1328" class="difflineplus">+      },</span>
<a href="#l14.1329"></a><span id="l14.1329">     },</span>
<a href="#l14.1330"></a><span id="l14.1330"> </span>
<a href="#l14.1331"></a><span id="l14.1331">     /**</span>
<a href="#l14.1332"></a><span id="l14.1332">      * The unread mode returns all folders that are not root-folders and that</span>
<a href="#l14.1333"></a><span id="l14.1333">      * have unread items. Also always keep the currently selected folder</span>
<a href="#l14.1334"></a><span id="l14.1334">      * so it doesn't disappear under the user.</span>
<a href="#l14.1335"></a><span id="l14.1335">      * It also includes parent folders of the Unread folders so the hierarchy</span>
<a href="#l14.1336"></a><span id="l14.1336">      * shown.</span>
<a href="#l14.1337"></a><span id="l14.1337">      */</span>
<a href="#l14.1338"></a><span id="l14.1338">     unread: {</span>
<a href="#l14.1339"></a><span id="l14.1339">       __proto__: IFolderTreeMode,</span>
<a href="#l14.1340"></a><span id="l14.1340"> </span>
<a href="#l14.1341"></a><span id="l14.1341" class="difflineminus">-      generateMap: function ftv_unread_generateMap(ftv) {</span>
<a href="#l14.1342"></a><span id="l14.1342" class="difflineminus">-        let filterUnread = function filterUnread(aFolder) {</span>
<a href="#l14.1343"></a><span id="l14.1343" class="difflineplus">+      generateMap(ftv) {</span>
<a href="#l14.1344"></a><span id="l14.1344" class="difflineplus">+        let filterUnread = function(aFolder) {</span>
<a href="#l14.1345"></a><span id="l14.1345">           let currentFolder = gFolderTreeView.getSelectedFolders()[0];</span>
<a href="#l14.1346"></a><span id="l14.1346">           return ((aFolder.getNumUnread(true) &gt; 0) ||</span>
<a href="#l14.1347"></a><span id="l14.1347">                   (aFolder == currentFolder));</span>
<a href="#l14.1348"></a><span id="l14.1348" class="difflineminus">-        }</span>
<a href="#l14.1349"></a><span id="l14.1349" class="difflineplus">+        };</span>
<a href="#l14.1350"></a><span id="l14.1350"> </span>
<a href="#l14.1351"></a><span id="l14.1351">         let accounts = gFolderTreeView._sortedAccounts();</span>
<a href="#l14.1352"></a><span id="l14.1352">         // Force each root folder to do its local subfolder discovery.</span>
<a href="#l14.1353"></a><span id="l14.1353">         MailUtils.discoverFolders();</span>
<a href="#l14.1354"></a><span id="l14.1354"> </span>
<a href="#l14.1355"></a><span id="l14.1355">         let unreadRootFolders = [];</span>
<a href="#l14.1356"></a><span id="l14.1356">         for (let acct of accounts) {</span>
<a href="#l14.1357"></a><span id="l14.1357">           let rootFolder = acct.incomingServer.rootFolder;</span>
<a href="#l14.1358"></a><span id="l14.1358">           // Add rootFolders of accounts that contain at least one Favorite folder.</span>
<a href="#l14.1359"></a><span id="l14.1359">           if (rootFolder.getNumUnread(true) &gt; 0)</span>
<a href="#l14.1360"></a><span id="l14.1360">             unreadRootFolders.push(new ftvItem(rootFolder, filterUnread));</span>
<a href="#l14.1361"></a><span id="l14.1361">         }</span>
<a href="#l14.1362"></a><span id="l14.1362"> </span>
<a href="#l14.1363"></a><span id="l14.1363">         return unreadRootFolders;</span>
<a href="#l14.1364"></a><span id="l14.1364">       },</span>
<a href="#l14.1365"></a><span id="l14.1365"> </span>
<a href="#l14.1366"></a><span id="l14.1366" class="difflineminus">-      handleChangedIntProperty: function(aItem, aProperty, aOld, aNew) {</span>
<a href="#l14.1367"></a><span id="l14.1367" class="difflineplus">+      handleChangedIntProperty(aItem, aProperty, aOld, aNew) {</span>
<a href="#l14.1368"></a><span id="l14.1368">         // We want to rebuild only if we have a newly unread folder</span>
<a href="#l14.1369"></a><span id="l14.1369">         // and we didn't already have the folder.</span>
<a href="#l14.1370"></a><span id="l14.1370">         if (aProperty == &quot;TotalUnreadMessages&quot; &amp;&amp; aOld == 0 &amp;&amp; aNew &gt; 0 &amp;&amp;</span>
<a href="#l14.1371"></a><span id="l14.1371">             gFolderTreeView.getIndexOfFolder(aItem) == null) {</span>
<a href="#l14.1372"></a><span id="l14.1372">           gFolderTreeView._rebuild();</span>
<a href="#l14.1373"></a><span id="l14.1373">           return true;</span>
<a href="#l14.1374"></a><span id="l14.1374">         }</span>
<a href="#l14.1375"></a><span id="l14.1375">         return false;</span>
<a href="#l14.1376"></a><span id="l14.1376" class="difflineminus">-      }</span>
<a href="#l14.1377"></a><span id="l14.1377" class="difflineplus">+      },</span>
<a href="#l14.1378"></a><span id="l14.1378">     },</span>
<a href="#l14.1379"></a><span id="l14.1379"> </span>
<a href="#l14.1380"></a><span id="l14.1380">     /**</span>
<a href="#l14.1381"></a><span id="l14.1381">      * A variant of the 'unread' mode above. This does not include the parent folders</span>
<a href="#l14.1382"></a><span id="l14.1382">      * and the unread folders are shown in a flat list with no hierarchy.</span>
<a href="#l14.1383"></a><span id="l14.1383">      */</span>
<a href="#l14.1384"></a><span id="l14.1384">     unread_compact: {</span>
<a href="#l14.1385"></a><span id="l14.1385">       __proto__: IFolderTreeMode,</span>
<a href="#l14.1386"></a><span id="l14.1386"> </span>
<a href="#l14.1387"></a><span id="l14.1387" class="difflineminus">-      generateMap: function(ftv) {</span>
<a href="#l14.1388"></a><span id="l14.1388" class="difflineplus">+      generateMap(ftv) {</span>
<a href="#l14.1389"></a><span id="l14.1389">         let map = [];</span>
<a href="#l14.1390"></a><span id="l14.1390">         let currentFolder = gFolderTreeView.getSelectedFolders()[0];</span>
<a href="#l14.1391"></a><span id="l14.1391">         for (let folder of ftv._enumerateFolders) {</span>
<a href="#l14.1392"></a><span id="l14.1392">           if ((!folder.isServer &amp;&amp; folder.getNumUnread(false) &gt; 0) ||</span>
<a href="#l14.1393"></a><span id="l14.1393">               (folder == currentFolder))</span>
<a href="#l14.1394"></a><span id="l14.1394">             map.push(new ftvItem(folder));</span>
<a href="#l14.1395"></a><span id="l14.1395">         }</span>
<a href="#l14.1396"></a><span id="l14.1396"> </span>
<a href="#l14.1397"></a><span id="l14.1397" class="difflineat">@@ -1610,81 +1597,81 @@ var gFolderTreeView = {</span>
<a href="#l14.1398"></a><span id="l14.1398">         for (let folder of map) {</span>
<a href="#l14.1399"></a><span id="l14.1399">           folder.__defineGetter__(&quot;children&quot;, () =&gt; []);</span>
<a href="#l14.1400"></a><span id="l14.1400">           folder.addServerName = true;</span>
<a href="#l14.1401"></a><span id="l14.1401">         }</span>
<a href="#l14.1402"></a><span id="l14.1402">         sortFolderItems(map);</span>
<a href="#l14.1403"></a><span id="l14.1403">         return map;</span>
<a href="#l14.1404"></a><span id="l14.1404">       },</span>
<a href="#l14.1405"></a><span id="l14.1405"> </span>
<a href="#l14.1406"></a><span id="l14.1406" class="difflineminus">-      getParentOfFolder: function(aFolder) {</span>
<a href="#l14.1407"></a><span id="l14.1407" class="difflineplus">+      getParentOfFolder(aFolder) {</span>
<a href="#l14.1408"></a><span id="l14.1408">         // This is a flat view, so no folders have parents.</span>
<a href="#l14.1409"></a><span id="l14.1409">         return null;</span>
<a href="#l14.1410"></a><span id="l14.1410">       },</span>
<a href="#l14.1411"></a><span id="l14.1411"> </span>
<a href="#l14.1412"></a><span id="l14.1412" class="difflineminus">-      handleChangedIntProperty: function(aItem, aProperty, aOld, aNew) {</span>
<a href="#l14.1413"></a><span id="l14.1413" class="difflineplus">+      handleChangedIntProperty(aItem, aProperty, aOld, aNew) {</span>
<a href="#l14.1414"></a><span id="l14.1414">         // We want to rebuild only if we have a newly unread folder</span>
<a href="#l14.1415"></a><span id="l14.1415">         // and we didn't already have the folder.</span>
<a href="#l14.1416"></a><span id="l14.1416">         if (aProperty == &quot;TotalUnreadMessages&quot; &amp;&amp; aOld == 0 &amp;&amp; aNew &gt; 0 &amp;&amp;</span>
<a href="#l14.1417"></a><span id="l14.1417">             gFolderTreeView.getIndexOfFolder(aItem) == null) {</span>
<a href="#l14.1418"></a><span id="l14.1418">           gFolderTreeView._rebuild();</span>
<a href="#l14.1419"></a><span id="l14.1419">           return true;</span>
<a href="#l14.1420"></a><span id="l14.1420">         }</span>
<a href="#l14.1421"></a><span id="l14.1421">         return false;</span>
<a href="#l14.1422"></a><span id="l14.1422" class="difflineminus">-      }</span>
<a href="#l14.1423"></a><span id="l14.1423" class="difflineplus">+      },</span>
<a href="#l14.1424"></a><span id="l14.1424">     },</span>
<a href="#l14.1425"></a><span id="l14.1425"> </span>
<a href="#l14.1426"></a><span id="l14.1426">     /**</span>
<a href="#l14.1427"></a><span id="l14.1427">      * The favorites mode returns all folders whose flags are set to include</span>
<a href="#l14.1428"></a><span id="l14.1428">      * the favorite flag.</span>
<a href="#l14.1429"></a><span id="l14.1429">      * It also includes parent folders of the Unread folders so the hierarchy</span>
<a href="#l14.1430"></a><span id="l14.1430">      * shown.</span>
<a href="#l14.1431"></a><span id="l14.1431">      */</span>
<a href="#l14.1432"></a><span id="l14.1432">     favorite: {</span>
<a href="#l14.1433"></a><span id="l14.1433">       __proto__: IFolderTreeMode,</span>
<a href="#l14.1434"></a><span id="l14.1434"> </span>
<a href="#l14.1435"></a><span id="l14.1435" class="difflineminus">-      generateMap: function ftv_favorite_generateMap(ftv) {</span>
<a href="#l14.1436"></a><span id="l14.1436" class="difflineplus">+      generateMap(ftv) {</span>
<a href="#l14.1437"></a><span id="l14.1437">         let accounts = gFolderTreeView._sortedAccounts();</span>
<a href="#l14.1438"></a><span id="l14.1438">         // Force each root folder to do its local subfolder discovery.</span>
<a href="#l14.1439"></a><span id="l14.1439">         MailUtils.discoverFolders();</span>
<a href="#l14.1440"></a><span id="l14.1440"> </span>
<a href="#l14.1441"></a><span id="l14.1441">         let favRootFolders = [];</span>
<a href="#l14.1442"></a><span id="l14.1442" class="difflineminus">-        let filterFavorite = function filterFavorite(aFolder) {</span>
<a href="#l14.1443"></a><span id="l14.1443" class="difflineplus">+        let filterFavorite = function(aFolder) {</span>
<a href="#l14.1444"></a><span id="l14.1444">           return aFolder.getFolderWithFlags(Ci.nsMsgFolderFlags.Favorite) != null;</span>
<a href="#l14.1445"></a><span id="l14.1445" class="difflineminus">-        }</span>
<a href="#l14.1446"></a><span id="l14.1446" class="difflineplus">+        };</span>
<a href="#l14.1447"></a><span id="l14.1447">         for (let acct of accounts) {</span>
<a href="#l14.1448"></a><span id="l14.1448">           let rootFolder = acct.incomingServer.rootFolder;</span>
<a href="#l14.1449"></a><span id="l14.1449">           // Add rootFolders of accounts that contain at least one Favorite folder.</span>
<a href="#l14.1450"></a><span id="l14.1450">           if (filterFavorite(rootFolder))</span>
<a href="#l14.1451"></a><span id="l14.1451">             favRootFolders.push(new ftvItem(rootFolder, filterFavorite));</span>
<a href="#l14.1452"></a><span id="l14.1452">         }</span>
<a href="#l14.1453"></a><span id="l14.1453"> </span>
<a href="#l14.1454"></a><span id="l14.1454">         return favRootFolders;</span>
<a href="#l14.1455"></a><span id="l14.1455">       },</span>
<a href="#l14.1456"></a><span id="l14.1456"> </span>
<a href="#l14.1457"></a><span id="l14.1457" class="difflineminus">-      handleChangedIntProperty: function(aItem, aProperty, aOld, aNew) {</span>
<a href="#l14.1458"></a><span id="l14.1458" class="difflineplus">+      handleChangedIntProperty(aItem, aProperty, aOld, aNew) {</span>
<a href="#l14.1459"></a><span id="l14.1459">         // We want to rebuild if the favorite status of a folder changed.</span>
<a href="#l14.1460"></a><span id="l14.1460">         if (aProperty == &quot;FolderFlag&quot; &amp;&amp;</span>
<a href="#l14.1461"></a><span id="l14.1461">             ((aOld &amp; Ci.nsMsgFolderFlags.Favorite) !=</span>
<a href="#l14.1462"></a><span id="l14.1462">             (aNew &amp; Ci.nsMsgFolderFlags.Favorite))) {</span>
<a href="#l14.1463"></a><span id="l14.1463">           gFolderTreeView._rebuild();</span>
<a href="#l14.1464"></a><span id="l14.1464">           return true;</span>
<a href="#l14.1465"></a><span id="l14.1465">         }</span>
<a href="#l14.1466"></a><span id="l14.1466">         return false;</span>
<a href="#l14.1467"></a><span id="l14.1467" class="difflineminus">-      }</span>
<a href="#l14.1468"></a><span id="l14.1468" class="difflineplus">+      },</span>
<a href="#l14.1469"></a><span id="l14.1469">     },</span>
<a href="#l14.1470"></a><span id="l14.1470"> </span>
<a href="#l14.1471"></a><span id="l14.1471">     /**</span>
<a href="#l14.1472"></a><span id="l14.1472">      * A variant of the 'favorite' mode above. This does not include the parent folders</span>
<a href="#l14.1473"></a><span id="l14.1473">      * and the unread folders are shown in a compact list with no hierarchy.</span>
<a href="#l14.1474"></a><span id="l14.1474">      */</span>
<a href="#l14.1475"></a><span id="l14.1475">     favorite_compact: {</span>
<a href="#l14.1476"></a><span id="l14.1476">       __proto__: IFolderTreeMode,</span>
<a href="#l14.1477"></a><span id="l14.1477"> </span>
<a href="#l14.1478"></a><span id="l14.1478" class="difflineminus">-      generateMap: function(ftv) {</span>
<a href="#l14.1479"></a><span id="l14.1479" class="difflineplus">+      generateMap(ftv) {</span>
<a href="#l14.1480"></a><span id="l14.1480">         let faves = [];</span>
<a href="#l14.1481"></a><span id="l14.1481">         for (let folder of ftv._enumerateFolders) {</span>
<a href="#l14.1482"></a><span id="l14.1482">           if (folder.getFlag(Ci.nsMsgFolderFlags.Favorite))</span>
<a href="#l14.1483"></a><span id="l14.1483">             faves.push(new ftvItem(folder));</span>
<a href="#l14.1484"></a><span id="l14.1484">         }</span>
<a href="#l14.1485"></a><span id="l14.1485"> </span>
<a href="#l14.1486"></a><span id="l14.1486">         // We want to display the account name alongside folders that have</span>
<a href="#l14.1487"></a><span id="l14.1487">         // duplicated folder names.</span>
<a href="#l14.1488"></a><span id="l14.1488" class="difflineat">@@ -1705,47 +1692,47 @@ var gFolderTreeView = {</span>
<a href="#l14.1489"></a><span id="l14.1489">           let name = item._folder.abbreviatedName.toLocaleLowerCase();</span>
<a href="#l14.1490"></a><span id="l14.1490">           item.__defineGetter__(&quot;children&quot;, () =&gt; []);</span>
<a href="#l14.1491"></a><span id="l14.1491">           item.addServerName = dupeNames.has(name);</span>
<a href="#l14.1492"></a><span id="l14.1492">         }</span>
<a href="#l14.1493"></a><span id="l14.1493">         sortFolderItems(faves);</span>
<a href="#l14.1494"></a><span id="l14.1494">         return faves;</span>
<a href="#l14.1495"></a><span id="l14.1495">       },</span>
<a href="#l14.1496"></a><span id="l14.1496"> </span>
<a href="#l14.1497"></a><span id="l14.1497" class="difflineminus">-      getParentOfFolder: function(aFolder) {</span>
<a href="#l14.1498"></a><span id="l14.1498" class="difflineplus">+      getParentOfFolder(aFolder) {</span>
<a href="#l14.1499"></a><span id="l14.1499">         // This is a flat view, so no folders have parents.</span>
<a href="#l14.1500"></a><span id="l14.1500">         return null;</span>
<a href="#l14.1501"></a><span id="l14.1501">       },</span>
<a href="#l14.1502"></a><span id="l14.1502"> </span>
<a href="#l14.1503"></a><span id="l14.1503" class="difflineminus">-      handleChangedIntProperty: function(aItem, aProperty, aOld, aNew) {</span>
<a href="#l14.1504"></a><span id="l14.1504" class="difflineplus">+      handleChangedIntProperty(aItem, aProperty, aOld, aNew) {</span>
<a href="#l14.1505"></a><span id="l14.1505">         // We want to rebuild if the favorite status of a folder changed.</span>
<a href="#l14.1506"></a><span id="l14.1506">         if (aProperty == &quot;FolderFlag&quot; &amp;&amp;</span>
<a href="#l14.1507"></a><span id="l14.1507">             ((aOld &amp; Ci.nsMsgFolderFlags.Favorite) !=</span>
<a href="#l14.1508"></a><span id="l14.1508">             (aNew &amp; Ci.nsMsgFolderFlags.Favorite))) {</span>
<a href="#l14.1509"></a><span id="l14.1509">           gFolderTreeView._rebuild();</span>
<a href="#l14.1510"></a><span id="l14.1510">           return true;</span>
<a href="#l14.1511"></a><span id="l14.1511">         }</span>
<a href="#l14.1512"></a><span id="l14.1512">         return false;</span>
<a href="#l14.1513"></a><span id="l14.1513" class="difflineminus">-      }</span>
<a href="#l14.1514"></a><span id="l14.1514" class="difflineplus">+      },</span>
<a href="#l14.1515"></a><span id="l14.1515">     },</span>
<a href="#l14.1516"></a><span id="l14.1516"> </span>
<a href="#l14.1517"></a><span id="l14.1517">     recent_compact: {</span>
<a href="#l14.1518"></a><span id="l14.1518">       __proto__: IFolderTreeMode,</span>
<a href="#l14.1519"></a><span id="l14.1519"> </span>
<a href="#l14.1520"></a><span id="l14.1520" class="difflineminus">-      generateMap: function(ftv) {</span>
<a href="#l14.1521"></a><span id="l14.1521" class="difflineplus">+      generateMap(ftv) {</span>
<a href="#l14.1522"></a><span id="l14.1522">         const MAXRECENT = 15;</span>
<a href="#l14.1523"></a><span id="l14.1523"> </span>
<a href="#l14.1524"></a><span id="l14.1524">         // Get 15 (MAXRECENT) most recently accessed folders.</span>
<a href="#l14.1525"></a><span id="l14.1525">         let recentFolders = getMostRecentFolders(ftv._enumerateFolders,</span>
<a href="#l14.1526"></a><span id="l14.1526">                                                  MAXRECENT,</span>
<a href="#l14.1527"></a><span id="l14.1527">                                                  &quot;MRUTime&quot;,</span>
<a href="#l14.1528"></a><span id="l14.1528">                                                  null);</span>
<a href="#l14.1529"></a><span id="l14.1529"> </span>
<a href="#l14.1530"></a><span id="l14.1530">         // Sort the folder names alphabetically.</span>
<a href="#l14.1531"></a><span id="l14.1531" class="difflineminus">-        recentFolders.sort(function rf_sort(a, b){</span>
<a href="#l14.1532"></a><span id="l14.1532" class="difflineplus">+        recentFolders.sort(function(a, b) {</span>
<a href="#l14.1533"></a><span id="l14.1533">           let aLabel = a.prettyName;</span>
<a href="#l14.1534"></a><span id="l14.1534">           let bLabel = b.prettyName;</span>
<a href="#l14.1535"></a><span id="l14.1535">           if (aLabel == bLabel) {</span>
<a href="#l14.1536"></a><span id="l14.1536">             aLabel = a.server.prettyName;</span>
<a href="#l14.1537"></a><span id="l14.1537">             bLabel = b.server.prettyName;</span>
<a href="#l14.1538"></a><span id="l14.1538">           }</span>
<a href="#l14.1539"></a><span id="l14.1539">           return folderNameCompare(aLabel, bLabel);</span>
<a href="#l14.1540"></a><span id="l14.1540">         });</span>
<a href="#l14.1541"></a><span id="l14.1541" class="difflineat">@@ -1758,38 +1745,37 @@ var gFolderTreeView = {</span>
<a href="#l14.1542"></a><span id="l14.1542">         for (let folder of items) {</span>
<a href="#l14.1543"></a><span id="l14.1543">           folder.__defineGetter__(&quot;children&quot;, () =&gt; []);</span>
<a href="#l14.1544"></a><span id="l14.1544">           folder.addServerName = true;</span>
<a href="#l14.1545"></a><span id="l14.1545">         }</span>
<a href="#l14.1546"></a><span id="l14.1546"> </span>
<a href="#l14.1547"></a><span id="l14.1547">         return items;</span>
<a href="#l14.1548"></a><span id="l14.1548">       },</span>
<a href="#l14.1549"></a><span id="l14.1549"> </span>
<a href="#l14.1550"></a><span id="l14.1550" class="difflineminus">-      getParentOfFolder: function(aFolder) {</span>
<a href="#l14.1551"></a><span id="l14.1551" class="difflineplus">+      getParentOfFolder(aFolder) {</span>
<a href="#l14.1552"></a><span id="l14.1552">         // This is a flat view, so no folders have parents.</span>
<a href="#l14.1553"></a><span id="l14.1553">         return null;</span>
<a href="#l14.1554"></a><span id="l14.1554" class="difflineminus">-      }</span>
<a href="#l14.1555"></a><span id="l14.1555" class="difflineplus">+      },</span>
<a href="#l14.1556"></a><span id="l14.1556">     },</span>
<a href="#l14.1557"></a><span id="l14.1557"> </span>
<a href="#l14.1558"></a><span id="l14.1558">     /**</span>
<a href="#l14.1559"></a><span id="l14.1559">      * The smart folder mode combines special folders of a particular type</span>
<a href="#l14.1560"></a><span id="l14.1560">      * across accounts into a single cross-folder saved search.</span>
<a href="#l14.1561"></a><span id="l14.1561">      */</span>
<a href="#l14.1562"></a><span id="l14.1562">     smart: {</span>
<a href="#l14.1563"></a><span id="l14.1563">       __proto__: IFolderTreeMode,</span>
<a href="#l14.1564"></a><span id="l14.1564"> </span>
<a href="#l14.1565"></a><span id="l14.1565">       /**</span>
<a href="#l14.1566"></a><span id="l14.1566">        * The smart server. This will create the server if it doesn't exist.</span>
<a href="#l14.1567"></a><span id="l14.1567">        */</span>
<a href="#l14.1568"></a><span id="l14.1568">       get _smartServer() {</span>
<a href="#l14.1569"></a><span id="l14.1569">         let smartServer;</span>
<a href="#l14.1570"></a><span id="l14.1570">         try {</span>
<a href="#l14.1571"></a><span id="l14.1571">           smartServer = MailServices.accounts.FindServer(&quot;nobody&quot;, &quot;smart mailboxes&quot;, &quot;none&quot;);</span>
<a href="#l14.1572"></a><span id="l14.1572" class="difflineminus">-        }</span>
<a href="#l14.1573"></a><span id="l14.1573" class="difflineminus">-        catch (ex) {</span>
<a href="#l14.1574"></a><span id="l14.1574" class="difflineplus">+        } catch (ex) {</span>
<a href="#l14.1575"></a><span id="l14.1575">           smartServer = MailServices.accounts.createIncomingServer(&quot;nobody&quot;, &quot;smart mailboxes&quot;, &quot;none&quot;);</span>
<a href="#l14.1576"></a><span id="l14.1576">           // We don't want the &quot;smart&quot; server/account leaking out into the ui in</span>
<a href="#l14.1577"></a><span id="l14.1577">           // other places, so set it as hidden.</span>
<a href="#l14.1578"></a><span id="l14.1578">           smartServer.hidden = true;</span>
<a href="#l14.1579"></a><span id="l14.1579">           let account = MailServices.accounts.createAccount();</span>
<a href="#l14.1580"></a><span id="l14.1580">           account.incomingServer = smartServer;</span>
<a href="#l14.1581"></a><span id="l14.1581">         }</span>
<a href="#l14.1582"></a><span id="l14.1582">         delete this._smartServer;</span>
<a href="#l14.1583"></a><span id="l14.1583" class="difflineat">@@ -1805,112 +1791,112 @@ var gFolderTreeView = {</span>
<a href="#l14.1584"></a><span id="l14.1584">       _flagNameList: [</span>
<a href="#l14.1585"></a><span id="l14.1585">         [Ci.nsMsgFolderFlags.Inbox, &quot;Inbox&quot;, false, true],</span>
<a href="#l14.1586"></a><span id="l14.1586">         [Ci.nsMsgFolderFlags.Drafts, &quot;Drafts&quot;, false, true],</span>
<a href="#l14.1587"></a><span id="l14.1587">         [Ci.nsMsgFolderFlags.SentMail, &quot;Sent&quot;, true, true],</span>
<a href="#l14.1588"></a><span id="l14.1588">         [Ci.nsMsgFolderFlags.Trash, &quot;Trash&quot;, true, true],</span>
<a href="#l14.1589"></a><span id="l14.1589">         [Ci.nsMsgFolderFlags.Templates, &quot;Templates&quot;, false, true],</span>
<a href="#l14.1590"></a><span id="l14.1590">         [Ci.nsMsgFolderFlags.Archive, &quot;Archives&quot;, true, true],</span>
<a href="#l14.1591"></a><span id="l14.1591">         [Ci.nsMsgFolderFlags.Junk, &quot;Junk&quot;, false, true],</span>
<a href="#l14.1592"></a><span id="l14.1592" class="difflineminus">-        [Ci.nsMsgFolderFlags.Queue, &quot;Outbox&quot;, true, true]</span>
<a href="#l14.1593"></a><span id="l14.1593" class="difflineplus">+        [Ci.nsMsgFolderFlags.Queue, &quot;Outbox&quot;, true, true],</span>
<a href="#l14.1594"></a><span id="l14.1594">       ],</span>
<a href="#l14.1595"></a><span id="l14.1595"> </span>
<a href="#l14.1596"></a><span id="l14.1596">       /**</span>
<a href="#l14.1597"></a><span id="l14.1597">        * support for addons to add special folder types, this must be called</span>
<a href="#l14.1598"></a><span id="l14.1598">        * prior to onload.</span>
<a href="#l14.1599"></a><span id="l14.1599">        *</span>
<a href="#l14.1600"></a><span id="l14.1600">        * @param aFolderName  name of the folder</span>
<a href="#l14.1601"></a><span id="l14.1601">        * @param isDeep  include subfolders</span>
<a href="#l14.1602"></a><span id="l14.1602">        * @param folderOptions  object with searchStr and searchOnline options, or null</span>
<a href="#l14.1603"></a><span id="l14.1603">        */</span>
<a href="#l14.1604"></a><span id="l14.1604" class="difflineminus">-      addSmartFolderType: function ftv_addSmartFolderType(aFolderName, isDeep, isSearchFolder) {</span>
<a href="#l14.1605"></a><span id="l14.1605" class="difflineplus">+      addSmartFolderType(aFolderName, isDeep, isSearchFolder) {</span>
<a href="#l14.1606"></a><span id="l14.1606">         this._flagNameList.push([0, aFolderName, isDeep, isSearchFolder]);</span>
<a href="#l14.1607"></a><span id="l14.1607">       },</span>
<a href="#l14.1608"></a><span id="l14.1608"> </span>
<a href="#l14.1609"></a><span id="l14.1609">       /**</span>
<a href="#l14.1610"></a><span id="l14.1610">        * Returns an array of 4 elements describing the smart folder</span>
<a href="#l14.1611"></a><span id="l14.1611">        * if the given folder is a special folder, else returns null.</span>
<a href="#l14.1612"></a><span id="l14.1612">        */</span>
<a href="#l14.1613"></a><span id="l14.1613" class="difflineminus">-      getSmartFolderTypeByName: function ftv_smart__getSmartFolderType(aName) {</span>
<a href="#l14.1614"></a><span id="l14.1614" class="difflineplus">+      getSmartFolderTypeByName(aName) {</span>
<a href="#l14.1615"></a><span id="l14.1615">         for (let type of this._flagNameList) {</span>
<a href="#l14.1616"></a><span id="l14.1616">           if (type[1] == aName)</span>
<a href="#l14.1617"></a><span id="l14.1617">             return type;</span>
<a href="#l14.1618"></a><span id="l14.1618">         }</span>
<a href="#l14.1619"></a><span id="l14.1619">         return null;</span>
<a href="#l14.1620"></a><span id="l14.1620">       },</span>
<a href="#l14.1621"></a><span id="l14.1621">       /**</span>
<a href="#l14.1622"></a><span id="l14.1622">        * check to see if a folder is a smart folder</span>
<a href="#l14.1623"></a><span id="l14.1623">        */</span>
<a href="#l14.1624"></a><span id="l14.1624" class="difflineminus">-      isSmartFolder: function ftv_smart__isSmartFolder(aFolder) {</span>
<a href="#l14.1625"></a><span id="l14.1625" class="difflineplus">+      isSmartFolder(aFolder) {</span>
<a href="#l14.1626"></a><span id="l14.1626">         if (aFolder.flags &amp; this._allSmartFlags)</span>
<a href="#l14.1627"></a><span id="l14.1627">             return true;</span>
<a href="#l14.1628"></a><span id="l14.1628">         // Also check the folder name itself, as containers do not</span>
<a href="#l14.1629"></a><span id="l14.1629">         // have the smartFolderName property.  We check all folders here, since</span>
<a href="#l14.1630"></a><span id="l14.1630">         // a &quot;real&quot; folder might be marked as a child of a smart folder.</span>
<a href="#l14.1631"></a><span id="l14.1631">         let smartFolderName = getSmartFolderName(aFolder);</span>
<a href="#l14.1632"></a><span id="l14.1632">         return smartFolderName &amp;&amp; this.getSmartFolderTypeByName(smartFolderName) ||</span>
<a href="#l14.1633"></a><span id="l14.1633">             this.getSmartFolderTypeByName(aFolder.name);</span>
<a href="#l14.1634"></a><span id="l14.1634">       },</span>
<a href="#l14.1635"></a><span id="l14.1635"> </span>
<a href="#l14.1636"></a><span id="l14.1636">       /**</span>
<a href="#l14.1637"></a><span id="l14.1637">        * All the flags above, bitwise ORed.</span>
<a href="#l14.1638"></a><span id="l14.1638">        */</span>
<a href="#l14.1639"></a><span id="l14.1639">       get _allSmartFlags() {</span>
<a href="#l14.1640"></a><span id="l14.1640">         delete this._allSmartFlags;</span>
<a href="#l14.1641"></a><span id="l14.1641">         return this._allSmartFlags = this._flagNameList.reduce(</span>
<a href="#l14.1642"></a><span id="l14.1642" class="difflineminus">-          (res, [flag,, isDeep,]) =&gt; res | flag, 0);</span>
<a href="#l14.1643"></a><span id="l14.1643" class="difflineplus">+          (res, [flag,, isDeep]) =&gt; res | flag, 0);</span>
<a href="#l14.1644"></a><span id="l14.1644">       },</span>
<a href="#l14.1645"></a><span id="l14.1645"> </span>
<a href="#l14.1646"></a><span id="l14.1646">       /**</span>
<a href="#l14.1647"></a><span id="l14.1647">        * All the &quot;shallow&quot; flags above (isDeep set to false), bitwise ORed.</span>
<a href="#l14.1648"></a><span id="l14.1648">        */</span>
<a href="#l14.1649"></a><span id="l14.1649">       get _allShallowFlags() {</span>
<a href="#l14.1650"></a><span id="l14.1650">         delete this._allShallowFlags;</span>
<a href="#l14.1651"></a><span id="l14.1651">         return this._allShallowFlags = this._flagNameList.reduce(</span>
<a href="#l14.1652"></a><span id="l14.1652" class="difflineminus">-          (res, [flag,, isDeep,]) =&gt; isDeep ? res : (res | flag), 0);</span>
<a href="#l14.1653"></a><span id="l14.1653" class="difflineplus">+          (res, [flag,, isDeep]) =&gt; isDeep ? res : (res | flag), 0);</span>
<a href="#l14.1654"></a><span id="l14.1654">       },</span>
<a href="#l14.1655"></a><span id="l14.1655"> </span>
<a href="#l14.1656"></a><span id="l14.1656">       /**</span>
<a href="#l14.1657"></a><span id="l14.1657">        * Returns an array of 4 elements describing the smart folder</span>
<a href="#l14.1658"></a><span id="l14.1658">        * if the given folder is a special folder, else returns null.</span>
<a href="#l14.1659"></a><span id="l14.1659">        */</span>
<a href="#l14.1660"></a><span id="l14.1660" class="difflineminus">-      _getSmartFolderType: function ftv_smart__getSmartFolderType(aFolder) {</span>
<a href="#l14.1661"></a><span id="l14.1661" class="difflineplus">+      _getSmartFolderType(aFolder) {</span>
<a href="#l14.1662"></a><span id="l14.1662">         let smartFolderName = getSmartFolderName(aFolder);</span>
<a href="#l14.1663"></a><span id="l14.1663">         for (let type of this._flagNameList) {</span>
<a href="#l14.1664"></a><span id="l14.1664">           if (smartFolderName) {</span>
<a href="#l14.1665"></a><span id="l14.1665">             if (type[1] == smartFolderName)</span>
<a href="#l14.1666"></a><span id="l14.1666">               return type;</span>
<a href="#l14.1667"></a><span id="l14.1667">             continue;</span>
<a href="#l14.1668"></a><span id="l14.1668">           }</span>
<a href="#l14.1669"></a><span id="l14.1669">           if (aFolder.flags &amp; type[0])</span>
<a href="#l14.1670"></a><span id="l14.1670">             return type;</span>
<a href="#l14.1671"></a><span id="l14.1671">         }</span>
<a href="#l14.1672"></a><span id="l14.1672">         return null;</span>
<a href="#l14.1673"></a><span id="l14.1673">       },</span>
<a href="#l14.1674"></a><span id="l14.1674"> </span>
<a href="#l14.1675"></a><span id="l14.1675">       /**</span>
<a href="#l14.1676"></a><span id="l14.1676">        * Returns the smart folder with the given name.</span>
<a href="#l14.1677"></a><span id="l14.1677">        */</span>
<a href="#l14.1678"></a><span id="l14.1678" class="difflineminus">-      _getSmartFolderNamed: function ftv_smart__getSmartFolderNamed(aName) {</span>
<a href="#l14.1679"></a><span id="l14.1679" class="difflineplus">+      _getSmartFolderNamed(aName) {</span>
<a href="#l14.1680"></a><span id="l14.1680">         let smartRoot = this._smartServer.rootFolder;</span>
<a href="#l14.1681"></a><span id="l14.1681">         return smartRoot.getChildWithURI(smartRoot.URI + &quot;/&quot; + encodeURI(aName), false,</span>
<a href="#l14.1682"></a><span id="l14.1682">                                          true);</span>
<a href="#l14.1683"></a><span id="l14.1683">       },</span>
<a href="#l14.1684"></a><span id="l14.1684"> </span>
<a href="#l14.1685"></a><span id="l14.1685" class="difflineminus">-      generateMap: function ftv_smart_generateMap(ftv) {</span>
<a href="#l14.1686"></a><span id="l14.1686" class="difflineplus">+      generateMap(ftv) {</span>
<a href="#l14.1687"></a><span id="l14.1687">         let map = [];</span>
<a href="#l14.1688"></a><span id="l14.1688">         let accounts = gFolderTreeView._sortedAccounts();</span>
<a href="#l14.1689"></a><span id="l14.1689">         let smartServer = this._smartServer;</span>
<a href="#l14.1690"></a><span id="l14.1690">         smartServer.prettyName = gFolderTreeView.messengerBundle</span>
<a href="#l14.1691"></a><span id="l14.1691">                                                 .getString(&quot;unifiedAccountName&quot;);</span>
<a href="#l14.1692"></a><span id="l14.1692">         smartServer.canHaveFilters = false;</span>
<a href="#l14.1693"></a><span id="l14.1693"> </span>
<a href="#l14.1694"></a><span id="l14.1694">         let smartRoot = smartServer.rootFolder;</span>
<a href="#l14.1695"></a><span id="l14.1695">         let smartChildren = [];</span>
<a href="#l14.1696"></a><span id="l14.1696" class="difflineminus">-        for (let [flag, name,,] of this._flagNameList) {</span>
<a href="#l14.1697"></a><span id="l14.1697" class="difflineplus">+        for (let [flag, name] of this._flagNameList) {</span>
<a href="#l14.1698"></a><span id="l14.1698">           gFolderTreeView._addSmartFoldersForFlag(smartChildren, accounts,</span>
<a href="#l14.1699"></a><span id="l14.1699">                                                   smartRoot, flag, name);</span>
<a href="#l14.1700"></a><span id="l14.1700">         }</span>
<a href="#l14.1701"></a><span id="l14.1701"> </span>
<a href="#l14.1702"></a><span id="l14.1702">         sortFolderItems(smartChildren);</span>
<a href="#l14.1703"></a><span id="l14.1703">         for (let smartChild of smartChildren)</span>
<a href="#l14.1704"></a><span id="l14.1704">           map.push(smartChild);</span>
<a href="#l14.1705"></a><span id="l14.1705"> </span>
<a href="#l14.1706"></a><span id="l14.1706" class="difflineat">@@ -1929,17 +1915,17 @@ var gFolderTreeView = {</span>
<a href="#l14.1707"></a><span id="l14.1707">        * - For one of the special folders, it is the smart folder of that kind</span>
<a href="#l14.1708"></a><span id="l14.1708">        *   if we're showing it (this happens when there's more than one folder</span>
<a href="#l14.1709"></a><span id="l14.1709">        *   of the kind). Otherwise it's a top-level folder, so there isn't a</span>
<a href="#l14.1710"></a><span id="l14.1710">        *   parent.</span>
<a href="#l14.1711"></a><span id="l14.1711">        * - For a child of a &quot;shallow&quot; special folder (see |_flagNameList| for</span>
<a href="#l14.1712"></a><span id="l14.1712">        *   the definition), it is the account.</span>
<a href="#l14.1713"></a><span id="l14.1713">        * - Otherwise it is simply the folder's actual parent.</span>
<a href="#l14.1714"></a><span id="l14.1714">        */</span>
<a href="#l14.1715"></a><span id="l14.1715" class="difflineminus">-      getParentOfFolder: function ftv_smart_getParentOfFolder(aFolder) {</span>
<a href="#l14.1716"></a><span id="l14.1716" class="difflineplus">+      getParentOfFolder(aFolder) {</span>
<a href="#l14.1717"></a><span id="l14.1717">         let smartServer = this._smartServer;</span>
<a href="#l14.1718"></a><span id="l14.1718">         if (aFolder.server == smartServer)</span>
<a href="#l14.1719"></a><span id="l14.1719">           // This is a smart mailbox</span>
<a href="#l14.1720"></a><span id="l14.1720">           return null;</span>
<a href="#l14.1721"></a><span id="l14.1721"> </span>
<a href="#l14.1722"></a><span id="l14.1722">         let smartType = this._getSmartFolderType(aFolder);</span>
<a href="#l14.1723"></a><span id="l14.1723">         if (smartType) {</span>
<a href="#l14.1724"></a><span id="l14.1724">           // This is a special folder</span>
<a href="#l14.1725"></a><span id="l14.1725" class="difflineat">@@ -1960,17 +1946,17 @@ var gFolderTreeView = {</span>
<a href="#l14.1726"></a><span id="l14.1726">         return parent;</span>
<a href="#l14.1727"></a><span id="l14.1727">       },</span>
<a href="#l14.1728"></a><span id="l14.1728"> </span>
<a href="#l14.1729"></a><span id="l14.1729">       /**</span>
<a href="#l14.1730"></a><span id="l14.1730">        * For a folder of a particular type foo, this returns the smart folder of</span>
<a href="#l14.1731"></a><span id="l14.1731">        * that type (if it's displayed). Otherwise this returns the folder the</span>
<a href="#l14.1732"></a><span id="l14.1732">        * message is in.</span>
<a href="#l14.1733"></a><span id="l14.1733">        */</span>
<a href="#l14.1734"></a><span id="l14.1734" class="difflineminus">-      getFolderForMsgHdr: function ftv_smart_getFolderForMsgHdr(aMsgHdr) {</span>
<a href="#l14.1735"></a><span id="l14.1735" class="difflineplus">+      getFolderForMsgHdr(aMsgHdr) {</span>
<a href="#l14.1736"></a><span id="l14.1736">         let folder = aMsgHdr.folder;</span>
<a href="#l14.1737"></a><span id="l14.1737"> </span>
<a href="#l14.1738"></a><span id="l14.1738">         let smartType = this._getSmartFolderType(folder);</span>
<a href="#l14.1739"></a><span id="l14.1739">         if (smartType) {</span>
<a href="#l14.1740"></a><span id="l14.1740">           let smartFolder = this._getSmartFolderNamed(smartType[1]);</span>
<a href="#l14.1741"></a><span id="l14.1741">           if (smartFolder &amp;&amp;</span>
<a href="#l14.1742"></a><span id="l14.1742">               gFolderTreeView.getIndexOfFolder(smartFolder) != null)</span>
<a href="#l14.1743"></a><span id="l14.1743">             return smartFolder;</span>
<a href="#l14.1744"></a><span id="l14.1744" class="difflineat">@@ -1982,50 +1968,48 @@ var gFolderTreeView = {</span>
<a href="#l14.1745"></a><span id="l14.1745">        * Handles the case of a new folder being added.</span>
<a href="#l14.1746"></a><span id="l14.1746">        *</span>
<a href="#l14.1747"></a><span id="l14.1747">        * - If a new special folder is added, we need to add it as a child of the</span>
<a href="#l14.1748"></a><span id="l14.1748">        *   corresponding smart folder.</span>
<a href="#l14.1749"></a><span id="l14.1749">        * - If the parent is a shallow special folder, we need to add it as a</span>
<a href="#l14.1750"></a><span id="l14.1750">        *   top-level folder in its account.</span>
<a href="#l14.1751"></a><span id="l14.1751">        * - Otherwise, we need to add it as a child of its parent (as normal).</span>
<a href="#l14.1752"></a><span id="l14.1752">        */</span>
<a href="#l14.1753"></a><span id="l14.1753" class="difflineminus">-      onFolderAdded: function ftv_smart_onFolderAdded(aParent, aFolder) {</span>
<a href="#l14.1754"></a><span id="l14.1754" class="difflineplus">+      onFolderAdded(aParent, aFolder) {</span>
<a href="#l14.1755"></a><span id="l14.1755">         if (aFolder.flags &amp; this._allSmartFlags) {</span>
<a href="#l14.1756"></a><span id="l14.1756">           // add as child of corresponding smart folder</span>
<a href="#l14.1757"></a><span id="l14.1757">           let smartServer = this._smartServer;</span>
<a href="#l14.1758"></a><span id="l14.1758">           let smartRoot = smartServer.rootFolder;</span>
<a href="#l14.1759"></a><span id="l14.1759">           // In theory, a folder can have multiple flags set, so we need to</span>
<a href="#l14.1760"></a><span id="l14.1760">           // check each flag separately.</span>
<a href="#l14.1761"></a><span id="l14.1761" class="difflineminus">-          for (let [flag, name,,] of this._flagNameList) {</span>
<a href="#l14.1762"></a><span id="l14.1762" class="difflineplus">+          for (let [flag, name] of this._flagNameList) {</span>
<a href="#l14.1763"></a><span id="l14.1763">             if (aFolder.flags &amp; flag)</span>
<a href="#l14.1764"></a><span id="l14.1764">               gFolderTreeView._addSmartSubFolder(aFolder, smartRoot, name, flag);</span>
<a href="#l14.1765"></a><span id="l14.1765">           }</span>
<a href="#l14.1766"></a><span id="l14.1766" class="difflineminus">-        }</span>
<a href="#l14.1767"></a><span id="l14.1767" class="difflineminus">-        else if (aParent.isSpecialFolder(this._allShallowFlags, false)) {</span>
<a href="#l14.1768"></a><span id="l14.1768" class="difflineplus">+        } else if (aParent.isSpecialFolder(this._allShallowFlags, false)) {</span>
<a href="#l14.1769"></a><span id="l14.1769">           // add as a child of the account</span>
<a href="#l14.1770"></a><span id="l14.1770">           let rootIndex = gFolderTreeView.getIndexOfFolder(</span>
<a href="#l14.1771"></a><span id="l14.1771">             aFolder.server.rootFolder);</span>
<a href="#l14.1772"></a><span id="l14.1772">           let root = gFolderTreeView._rowMap[rootIndex];</span>
<a href="#l14.1773"></a><span id="l14.1773">           if (!root)</span>
<a href="#l14.1774"></a><span id="l14.1774">             return;</span>
<a href="#l14.1775"></a><span id="l14.1775"> </span>
<a href="#l14.1776"></a><span id="l14.1776">           let newChild = new ftv_SmartItem(aFolder);</span>
<a href="#l14.1777"></a><span id="l14.1777">           root.children.push(newChild);</span>
<a href="#l14.1778"></a><span id="l14.1778">           newChild._level = root._level + 1;</span>
<a href="#l14.1779"></a><span id="l14.1779">           newChild._parent = root;</span>
<a href="#l14.1780"></a><span id="l14.1780">           sortFolderItems(root._children);</span>
<a href="#l14.1781"></a><span id="l14.1781"> </span>
<a href="#l14.1782"></a><span id="l14.1782">           gFolderTreeView._addChildToView(root, rootIndex, newChild);</span>
<a href="#l14.1783"></a><span id="l14.1783" class="difflineminus">-        }</span>
<a href="#l14.1784"></a><span id="l14.1784" class="difflineminus">-        else {</span>
<a href="#l14.1785"></a><span id="l14.1785" class="difflineplus">+        } else {</span>
<a href="#l14.1786"></a><span id="l14.1786">           // add as normal</span>
<a href="#l14.1787"></a><span id="l14.1787">           gFolderTreeView.addFolder(aParent, aFolder);</span>
<a href="#l14.1788"></a><span id="l14.1788">         }</span>
<a href="#l14.1789"></a><span id="l14.1789" class="difflineminus">-      }</span>
<a href="#l14.1790"></a><span id="l14.1790" class="difflineminus">-    }</span>
<a href="#l14.1791"></a><span id="l14.1791" class="difflineplus">+      },</span>
<a href="#l14.1792"></a><span id="l14.1792" class="difflineplus">+    },</span>
<a href="#l14.1793"></a><span id="l14.1793">   },</span>
<a href="#l14.1794"></a><span id="l14.1794"> </span>
<a href="#l14.1795"></a><span id="l14.1795">   /**</span>
<a href="#l14.1796"></a><span id="l14.1796">    * This is a helper attribute that simply returns a flat list of all folders</span>
<a href="#l14.1797"></a><span id="l14.1797">    */</span>
<a href="#l14.1798"></a><span id="l14.1798">   get _enumerateFolders() {</span>
<a href="#l14.1799"></a><span id="l14.1799">     let folders = [];</span>
<a href="#l14.1800"></a><span id="l14.1800"> </span>
<a href="#l14.1801"></a><span id="l14.1801" class="difflineat">@@ -2044,54 +2028,52 @@ var gFolderTreeView = {</span>
<a href="#l14.1802"></a><span id="l14.1802"> </span>
<a href="#l14.1803"></a><span id="l14.1803">   /**</span>
<a href="#l14.1804"></a><span id="l14.1804">    * This is a recursive function to add all subfolders to the array. It</span>
<a href="#l14.1805"></a><span id="l14.1805">    * assumes that the passed in folder itself has already been added.</span>
<a href="#l14.1806"></a><span id="l14.1806">    *</span>
<a href="#l14.1807"></a><span id="l14.1807">    * @param aFolder  the folder whose subfolders should be added</span>
<a href="#l14.1808"></a><span id="l14.1808">    * @param folders  the array to add the folders to.</span>
<a href="#l14.1809"></a><span id="l14.1809">    */</span>
<a href="#l14.1810"></a><span id="l14.1810" class="difflineminus">-  addSubFolders : function ftv_addSubFolders (folder, folders) {</span>
<a href="#l14.1811"></a><span id="l14.1811" class="difflineplus">+  addSubFolders(folder, folders) {</span>
<a href="#l14.1812"></a><span id="l14.1812">     for (let f of fixIterator(folder.subFolders, Ci.nsIMsgFolder)) {</span>
<a href="#l14.1813"></a><span id="l14.1813">       folders.push(f);</span>
<a href="#l14.1814"></a><span id="l14.1814">       this.addSubFolders(f, folders);</span>
<a href="#l14.1815"></a><span id="l14.1815">     }</span>
<a href="#l14.1816"></a><span id="l14.1816">   },</span>
<a href="#l14.1817"></a><span id="l14.1817"> </span>
<a href="#l14.1818"></a><span id="l14.1818">   /**</span>
<a href="#l14.1819"></a><span id="l14.1819">    * This updates the rowmap and invalidates the right row(s) in the tree</span>
<a href="#l14.1820"></a><span id="l14.1820">    */</span>
<a href="#l14.1821"></a><span id="l14.1821" class="difflineminus">-  _addChildToView: function ftl_addChildToView(aParent, aParentIndex, aNewChild) {</span>
<a href="#l14.1822"></a><span id="l14.1822" class="difflineplus">+  _addChildToView(aParent, aParentIndex, aNewChild) {</span>
<a href="#l14.1823"></a><span id="l14.1823">     if (aParent.open) {</span>
<a href="#l14.1824"></a><span id="l14.1824">       let newChildIndex;</span>
<a href="#l14.1825"></a><span id="l14.1825">       let newChildNum = aParent._children.indexOf(aNewChild);</span>
<a href="#l14.1826"></a><span id="l14.1826">       // only child - go right after our parent</span>
<a href="#l14.1827"></a><span id="l14.1827">       if (newChildNum == 0) {</span>
<a href="#l14.1828"></a><span id="l14.1828" class="difflineminus">-        newChildIndex = Number(aParentIndex) + 1</span>
<a href="#l14.1829"></a><span id="l14.1829" class="difflineminus">-      }</span>
<a href="#l14.1830"></a><span id="l14.1830" class="difflineminus">-      // if we're not the last child, insert ourselves before the next child.</span>
<a href="#l14.1831"></a><span id="l14.1831" class="difflineminus">-      else if (newChildNum &lt; aParent._children.length - 1) {</span>
<a href="#l14.1832"></a><span id="l14.1832" class="difflineplus">+        newChildIndex = Number(aParentIndex) + 1;</span>
<a href="#l14.1833"></a><span id="l14.1833" class="difflineplus">+      } else if (newChildNum &lt; aParent._children.length - 1) {</span>
<a href="#l14.1834"></a><span id="l14.1834" class="difflineplus">+        // if we're not the last child, insert ourselves before the next child.</span>
<a href="#l14.1835"></a><span id="l14.1835">         newChildIndex = this.getIndexOfFolder(aParent._children[Number(newChildNum) + 1]._folder);</span>
<a href="#l14.1836"></a><span id="l14.1836" class="difflineminus">-      }</span>
<a href="#l14.1837"></a><span id="l14.1837" class="difflineminus">-      // otherwise, go after the last child</span>
<a href="#l14.1838"></a><span id="l14.1838" class="difflineminus">-      else {</span>
<a href="#l14.1839"></a><span id="l14.1839" class="difflineplus">+      } else {</span>
<a href="#l14.1840"></a><span id="l14.1840" class="difflineplus">+        // otherwise, go after the last child</span>
<a href="#l14.1841"></a><span id="l14.1841">         let lastChild = aParent._children[newChildNum - 1];</span>
<a href="#l14.1842"></a><span id="l14.1842">         let lastChildIndex = this.getIndexOfFolder(lastChild._folder);</span>
<a href="#l14.1843"></a><span id="l14.1843">         newChildIndex = Number(lastChildIndex) + 1;</span>
<a href="#l14.1844"></a><span id="l14.1844">         while (newChildIndex &lt; this.rowCount &amp;&amp;</span>
<a href="#l14.1845"></a><span id="l14.1845">                this._rowMap[newChildIndex].level &gt; this._rowMap[lastChildIndex].level)</span>
<a href="#l14.1846"></a><span id="l14.1846">           newChildIndex++;</span>
<a href="#l14.1847"></a><span id="l14.1847">       }</span>
<a href="#l14.1848"></a><span id="l14.1848">       this._rowMap.splice(newChildIndex, 0, aNewChild);</span>
<a href="#l14.1849"></a><span id="l14.1849">       this._tree.rowCountChanged(newChildIndex, 1);</span>
<a href="#l14.1850"></a><span id="l14.1850">     } else {</span>
<a href="#l14.1851"></a><span id="l14.1851">       this._tree.invalidateRow(aParentIndex);</span>
<a href="#l14.1852"></a><span id="l14.1852">     }</span>
<a href="#l14.1853"></a><span id="l14.1853">   },</span>
<a href="#l14.1854"></a><span id="l14.1854" class="difflineminus">-  _addSmartSubFolder: function ftl_addSmartSubFolder(aItem, aSmartRoot, aName, aFlag) {</span>
<a href="#l14.1855"></a><span id="l14.1855" class="difflineplus">+  _addSmartSubFolder(aItem, aSmartRoot, aName, aFlag) {</span>
<a href="#l14.1856"></a><span id="l14.1856">     let smartFolder = aSmartRoot.getChildWithURI(aSmartRoot.URI + &quot;/&quot; + encodeURI(aName),</span>
<a href="#l14.1857"></a><span id="l14.1857">                                                  false, true);</span>
<a href="#l14.1858"></a><span id="l14.1858">     let parent = null;</span>
<a href="#l14.1859"></a><span id="l14.1859">     let parentIndex = -1;</span>
<a href="#l14.1860"></a><span id="l14.1860">     let newChild;</span>
<a href="#l14.1861"></a><span id="l14.1861">     let newChildIndex = 0;</span>
<a href="#l14.1862"></a><span id="l14.1862">     if (!smartFolder || this.getIndexOfFolder(smartFolder) == null) {</span>
<a href="#l14.1863"></a><span id="l14.1863">       newChild = new ftv_SmartItem(aItem);</span>
<a href="#l14.1864"></a><span id="l14.1864" class="difflineat">@@ -2116,45 +2098,45 @@ var gFolderTreeView = {</span>
<a href="#l14.1865"></a><span id="l14.1865"> </span>
<a href="#l14.1866"></a><span id="l14.1866">       newChild = new ftv_SmartItem(aItem);</span>
<a href="#l14.1867"></a><span id="l14.1867">       parent.children.push(newChild);</span>
<a href="#l14.1868"></a><span id="l14.1868">       newChild._level = parent._level + 1;</span>
<a href="#l14.1869"></a><span id="l14.1869">       newChild._parent = parent;</span>
<a href="#l14.1870"></a><span id="l14.1870">       sortFolderItems(parent._children);</span>
<a href="#l14.1871"></a><span id="l14.1871">       newChild.useServerNameOnly = true;</span>
<a href="#l14.1872"></a><span id="l14.1872">     }</span>
<a href="#l14.1873"></a><span id="l14.1873" class="difflineminus">-    if (aItem.getFlag(Ci.nsMsgFolderFlags.Inbox))</span>
<a href="#l14.1874"></a><span id="l14.1874" class="difflineplus">+    if (aItem.getFlag(Ci.nsMsgFolderFlags.Inbox)) {</span>
<a href="#l14.1875"></a><span id="l14.1875">       newChild.__defineGetter__(&quot;children&quot;, () =&gt; []);</span>
<a href="#l14.1876"></a><span id="l14.1876" class="difflineminus">-    if (parent)</span>
<a href="#l14.1877"></a><span id="l14.1877" class="difflineplus">+    }</span>
<a href="#l14.1878"></a><span id="l14.1878" class="difflineplus">+    if (parent) {</span>
<a href="#l14.1879"></a><span id="l14.1879">       this._addChildToView(parent, parentIndex, newChild);</span>
<a href="#l14.1880"></a><span id="l14.1880" class="difflineminus">-    else {</span>
<a href="#l14.1881"></a><span id="l14.1881" class="difflineplus">+    } else {</span>
<a href="#l14.1882"></a><span id="l14.1882">       this._rowMap.splice(newChildIndex, 0, newChild);</span>
<a href="#l14.1883"></a><span id="l14.1883">       this._tree.rowCountChanged(newChildIndex, 1);</span>
<a href="#l14.1884"></a><span id="l14.1884">     }</span>
<a href="#l14.1885"></a><span id="l14.1885">   },</span>
<a href="#l14.1886"></a><span id="l14.1886">   /**</span>
<a href="#l14.1887"></a><span id="l14.1887">    * This is our implementation of nsIMsgFolderListener to watch for changes</span>
<a href="#l14.1888"></a><span id="l14.1888">    */</span>
<a href="#l14.1889"></a><span id="l14.1889" class="difflineminus">-  OnItemAdded: function ftl_add(aParentItem, aItem) {</span>
<a href="#l14.1890"></a><span id="l14.1890" class="difflineplus">+  OnItemAdded(aParentItem, aItem) {</span>
<a href="#l14.1891"></a><span id="l14.1891">     // Ignore this item if it's not a folder, or we knew about it.</span>
<a href="#l14.1892"></a><span id="l14.1892">     if (!(aItem instanceof Ci.nsIMsgFolder) ||</span>
<a href="#l14.1893"></a><span id="l14.1893">         this.getIndexOfFolder(aItem) != null)</span>
<a href="#l14.1894"></a><span id="l14.1894">       return;</span>
<a href="#l14.1895"></a><span id="l14.1895"> </span>
<a href="#l14.1896"></a><span id="l14.1896">     // if no parent, this is an account, so let's rebuild.</span>
<a href="#l14.1897"></a><span id="l14.1897">     if (!aParentItem) {</span>
<a href="#l14.1898"></a><span id="l14.1898">       if (!aItem.server.hidden) // ignore hidden server items</span>
<a href="#l14.1899"></a><span id="l14.1899">         this._rebuild();</span>
<a href="#l14.1900"></a><span id="l14.1900">       return;</span>
<a href="#l14.1901"></a><span id="l14.1901">     }</span>
<a href="#l14.1902"></a><span id="l14.1902">     this._modes[this._mode].onFolderAdded(</span>
<a href="#l14.1903"></a><span id="l14.1903">       aParentItem.QueryInterface(Ci.nsIMsgFolder), aItem);</span>
<a href="#l14.1904"></a><span id="l14.1904">   },</span>
<a href="#l14.1905"></a><span id="l14.1905" class="difflineminus">-  addFolder: function ftl_add_folder(aParentItem, aItem)</span>
<a href="#l14.1906"></a><span id="l14.1906" class="difflineminus">-  {</span>
<a href="#l14.1907"></a><span id="l14.1907" class="difflineplus">+  addFolder(aParentItem, aItem) {</span>
<a href="#l14.1908"></a><span id="l14.1908">     // This intentionally adds any new folder even if it would not pass the</span>
<a href="#l14.1909"></a><span id="l14.1909">     // _filterFunction. The idea is that the user can add new folders even</span>
<a href="#l14.1910"></a><span id="l14.1910">     // in modes like &quot;unread&quot; or &quot;favorite&quot; and could wonder why they</span>
<a href="#l14.1911"></a><span id="l14.1911">     // are not appearing (forgetting they do not meet the criteria of the view).</span>
<a href="#l14.1912"></a><span id="l14.1912">     // The folders will be hidden properly next time the view is rebuilt.</span>
<a href="#l14.1913"></a><span id="l14.1913">     let parentIndex = this.getIndexOfFolder(aParentItem);</span>
<a href="#l14.1914"></a><span id="l14.1914">     let parent = this._rowMap[parentIndex];</span>
<a href="#l14.1915"></a><span id="l14.1915">     if (!parent)</span>
<a href="#l14.1916"></a><span id="l14.1916" class="difflineat">@@ -2189,17 +2171,17 @@ var gFolderTreeView = {</span>
<a href="#l14.1917"></a><span id="l14.1917">       if (newChild._folder.getFlag(Ci.nsMsgFolderFlags.SpecialUse)) {</span>
<a href="#l14.1918"></a><span id="l14.1918">         this._toggleRow(parentIndex, false);</span>
<a href="#l14.1919"></a><span id="l14.1919">         return;</span>
<a href="#l14.1920"></a><span id="l14.1920">       }</span>
<a href="#l14.1921"></a><span id="l14.1921">     }</span>
<a href="#l14.1922"></a><span id="l14.1922">     this._addChildToView(parent, parentIndex, newChild);</span>
<a href="#l14.1923"></a><span id="l14.1923">   },</span>
<a href="#l14.1924"></a><span id="l14.1924"> </span>
<a href="#l14.1925"></a><span id="l14.1925" class="difflineminus">-  OnItemRemoved: function ftl_remove(aRDFParentItem, aItem) {</span>
<a href="#l14.1926"></a><span id="l14.1926" class="difflineplus">+  OnItemRemoved(aRDFParentItem, aItem) {</span>
<a href="#l14.1927"></a><span id="l14.1927">     if (!(aItem instanceof Ci.nsIMsgFolder))</span>
<a href="#l14.1928"></a><span id="l14.1928">       return;</span>
<a href="#l14.1929"></a><span id="l14.1929"> </span>
<a href="#l14.1930"></a><span id="l14.1930">     this._persistItemClosed(aItem.URI);</span>
<a href="#l14.1931"></a><span id="l14.1931"> </span>
<a href="#l14.1932"></a><span id="l14.1932">     let index = this.getIndexOfFolder(aItem);</span>
<a href="#l14.1933"></a><span id="l14.1933">     if (index == null)</span>
<a href="#l14.1934"></a><span id="l14.1934">       return;</span>
<a href="#l14.1935"></a><span id="l14.1935" class="difflineat">@@ -2213,18 +2195,18 @@ var gFolderTreeView = {</span>
<a href="#l14.1936"></a><span id="l14.1936">       walker++;</span>
<a href="#l14.1937"></a><span id="l14.1937">       kidCount++;</span>
<a href="#l14.1938"></a><span id="l14.1938">     }</span>
<a href="#l14.1939"></a><span id="l14.1939">     this._rowMap.splice(index, kidCount);</span>
<a href="#l14.1940"></a><span id="l14.1940">     this._tree.rowCountChanged(index, -1 * kidCount);</span>
<a href="#l14.1941"></a><span id="l14.1941">     this._tree.invalidateRow(index);</span>
<a href="#l14.1942"></a><span id="l14.1942">   },</span>
<a href="#l14.1943"></a><span id="l14.1943"> </span>
<a href="#l14.1944"></a><span id="l14.1944" class="difflineminus">-  OnItemPropertyChanged: function(aItem, aProperty, aOld, aNew) {},</span>
<a href="#l14.1945"></a><span id="l14.1945" class="difflineminus">-  OnItemIntPropertyChanged: function(aItem, aProperty, aOld, aNew) {</span>
<a href="#l14.1946"></a><span id="l14.1946" class="difflineplus">+  OnItemPropertyChanged(aItem, aProperty, aOld, aNew) {},</span>
<a href="#l14.1947"></a><span id="l14.1947" class="difflineplus">+  OnItemIntPropertyChanged(aItem, aProperty, aOld, aNew) {</span>
<a href="#l14.1948"></a><span id="l14.1948">     // First try mode specific handling of the changed property.</span>
<a href="#l14.1949"></a><span id="l14.1949">     if (this._modes[this.mode].handleChangedIntProperty(aItem, aProperty, aOld, aNew))</span>
<a href="#l14.1950"></a><span id="l14.1950">       return;</span>
<a href="#l14.1951"></a><span id="l14.1951"> </span>
<a href="#l14.1952"></a><span id="l14.1952">     if (aItem instanceof Ci.nsIMsgFolder) {</span>
<a href="#l14.1953"></a><span id="l14.1953">       let index = this.getIndexOfFolder(aItem);</span>
<a href="#l14.1954"></a><span id="l14.1954">       let folder = aItem;</span>
<a href="#l14.1955"></a><span id="l14.1955">       let folderTreeMode = this._modes[this._mode];</span>
<a href="#l14.1956"></a><span id="l14.1956" class="difflineat">@@ -2235,34 +2217,34 @@ var gFolderTreeView = {</span>
<a href="#l14.1957"></a><span id="l14.1957">           break;</span>
<a href="#l14.1958"></a><span id="l14.1958">         index = this.getIndexOfFolder(folder);</span>
<a href="#l14.1959"></a><span id="l14.1959">       }</span>
<a href="#l14.1960"></a><span id="l14.1960">       if (index != null)</span>
<a href="#l14.1961"></a><span id="l14.1961">         this._tree.invalidateRow(index);</span>
<a href="#l14.1962"></a><span id="l14.1962">     }</span>
<a href="#l14.1963"></a><span id="l14.1963">   },</span>
<a href="#l14.1964"></a><span id="l14.1964"> </span>
<a href="#l14.1965"></a><span id="l14.1965" class="difflineminus">-  OnItemBoolPropertyChanged: function(aItem, aProperty, aOld, aNew) {</span>
<a href="#l14.1966"></a><span id="l14.1966" class="difflineplus">+  OnItemBoolPropertyChanged(aItem, aProperty, aOld, aNew) {</span>
<a href="#l14.1967"></a><span id="l14.1967">     let index = this.getIndexOfFolder(aItem);</span>
<a href="#l14.1968"></a><span id="l14.1968">     if (index != null)</span>
<a href="#l14.1969"></a><span id="l14.1969">       this._tree.invalidateRow(index);</span>
<a href="#l14.1970"></a><span id="l14.1970">   },</span>
<a href="#l14.1971"></a><span id="l14.1971"> </span>
<a href="#l14.1972"></a><span id="l14.1972" class="difflineminus">-  OnItemUnicharPropertyChanged: function(aItem, aProperty, aOld, aNew) {</span>
<a href="#l14.1973"></a><span id="l14.1973" class="difflineplus">+  OnItemUnicharPropertyChanged(aItem, aProperty, aOld, aNew) {</span>
<a href="#l14.1974"></a><span id="l14.1974">     let index = this.getIndexOfFolder(aItem);</span>
<a href="#l14.1975"></a><span id="l14.1975">     if (index != null)</span>
<a href="#l14.1976"></a><span id="l14.1976">       this._tree.invalidateRow(index);</span>
<a href="#l14.1977"></a><span id="l14.1977">   },</span>
<a href="#l14.1978"></a><span id="l14.1978"> </span>
<a href="#l14.1979"></a><span id="l14.1979" class="difflineminus">-  OnItemPropertyFlagChanged: function(aItem, aProperty, aOld, aNew) {},</span>
<a href="#l14.1980"></a><span id="l14.1980" class="difflineminus">-  OnItemEvent: function(aFolder, aEvent) {</span>
<a href="#l14.1981"></a><span id="l14.1981" class="difflineplus">+  OnItemPropertyFlagChanged(aItem, aProperty, aOld, aNew) {},</span>
<a href="#l14.1982"></a><span id="l14.1982" class="difflineplus">+  OnItemEvent(aFolder, aEvent) {</span>
<a href="#l14.1983"></a><span id="l14.1983">     let index = this.getIndexOfFolder(aFolder);</span>
<a href="#l14.1984"></a><span id="l14.1984">     if (index != null)</span>
<a href="#l14.1985"></a><span id="l14.1985">       this._tree.invalidateRow(index);</span>
<a href="#l14.1986"></a><span id="l14.1986" class="difflineminus">-  }</span>
<a href="#l14.1987"></a><span id="l14.1987" class="difflineplus">+  },</span>
<a href="#l14.1988"></a><span id="l14.1988"> };</span>
<a href="#l14.1989"></a><span id="l14.1989"> </span>
<a href="#l14.1990"></a><span id="l14.1990"> /**</span>
<a href="#l14.1991"></a><span id="l14.1991">  * The ftvItem object represents a single row in the tree view. Because I'm lazy</span>
<a href="#l14.1992"></a><span id="l14.1992">  * I'm just going to define the expected interface here.  You are free to return</span>
<a href="#l14.1993"></a><span id="l14.1993">  * an alternative object, provided that it matches this interface:</span>
<a href="#l14.1994"></a><span id="l14.1994">  *</span>
<a href="#l14.1995"></a><span id="l14.1995">  * id (attribute) - a unique string for this object. Must persist over sessions</span>
<a href="#l14.1996"></a><span id="l14.1996" class="difflineat">@@ -2313,19 +2295,19 @@ ftvItem.prototype = {</span>
<a href="#l14.1997"></a><span id="l14.1997">     gFolderStatsHelpers.sumSubfolders = gFolderStatsHelpers.sumSubfoldersPref &amp;&amp;</span>
<a href="#l14.1998"></a><span id="l14.1998">                           (gFolderTreeView.mode == kDefaultMode) &amp;&amp;</span>
<a href="#l14.1999"></a><span id="l14.1999">                           this._folder.hasSubFolders &amp;&amp; !this.open;</span>
<a href="#l14.2000"></a><span id="l14.2000"> </span>
<a href="#l14.2001"></a><span id="l14.2001">     this._summarizedCounts.delete(aColName);</span>
<a href="#l14.2002"></a><span id="l14.2002">     switch (aColName) {</span>
<a href="#l14.2003"></a><span id="l14.2003">       case &quot;folderNameCol&quot;:</span>
<a href="#l14.2004"></a><span id="l14.2004">         let text;</span>
<a href="#l14.2005"></a><span id="l14.2005" class="difflineminus">-        if (this.useServerNameOnly)</span>
<a href="#l14.2006"></a><span id="l14.2006" class="difflineplus">+        if (this.useServerNameOnly) {</span>
<a href="#l14.2007"></a><span id="l14.2007">           text = this._folder.server.prettyName;</span>
<a href="#l14.2008"></a><span id="l14.2008" class="difflineminus">-        else {</span>
<a href="#l14.2009"></a><span id="l14.2009" class="difflineplus">+        } else {</span>
<a href="#l14.2010"></a><span id="l14.2010">           text = this._folder.abbreviatedName;</span>
<a href="#l14.2011"></a><span id="l14.2011">           if (this.addServerName) {</span>
<a href="#l14.2012"></a><span id="l14.2012">             text = gFolderTreeView.messengerBundle.getFormattedString(</span>
<a href="#l14.2013"></a><span id="l14.2013">               &quot;folderWithAccount&quot;, [text, this._folder.server.prettyName]);</span>
<a href="#l14.2014"></a><span id="l14.2014">           }</span>
<a href="#l14.2015"></a><span id="l14.2015">         }</span>
<a href="#l14.2016"></a><span id="l14.2016"> </span>
<a href="#l14.2017"></a><span id="l14.2017">         // In a simple list tree we don't care for attributes other than folder name.</span>
<a href="#l14.2018"></a><span id="l14.2018" class="difflineat">@@ -2393,17 +2375,17 @@ ftvItem.prototype = {</span>
<a href="#l14.2019"></a><span id="l14.2019">         return &quot;&quot;;</span>
<a href="#l14.2020"></a><span id="l14.2020">     }</span>
<a href="#l14.2021"></a><span id="l14.2021">   },</span>
<a href="#l14.2022"></a><span id="l14.2022"> </span>
<a href="#l14.2023"></a><span id="l14.2023">   get level() {</span>
<a href="#l14.2024"></a><span id="l14.2024">     return this._level;</span>
<a href="#l14.2025"></a><span id="l14.2025">   },</span>
<a href="#l14.2026"></a><span id="l14.2026"> </span>
<a href="#l14.2027"></a><span id="l14.2027" class="difflineminus">-  getProperties: function (aColumn) {</span>
<a href="#l14.2028"></a><span id="l14.2028" class="difflineplus">+  getProperties(aColumn) {</span>
<a href="#l14.2029"></a><span id="l14.2029">     if (aColumn &amp;&amp; aColumn.id != &quot;folderNameCol&quot;)</span>
<a href="#l14.2030"></a><span id="l14.2030">       return &quot;&quot;;</span>
<a href="#l14.2031"></a><span id="l14.2031"> </span>
<a href="#l14.2032"></a><span id="l14.2032">     // From folderUtils.jsm</span>
<a href="#l14.2033"></a><span id="l14.2033">     let properties = getFolderProperties(this._folder, this.open);</span>
<a href="#l14.2034"></a><span id="l14.2034">     if (this._folder.getFlag(Ci.nsMsgFolderFlags.Virtual)) {</span>
<a href="#l14.2035"></a><span id="l14.2035">       properties += &quot; specialFolder-Smart&quot;;</span>
<a href="#l14.2036"></a><span id="l14.2036">       // a second possibility for customized smart folders</span>
<a href="#l14.2037"></a><span id="l14.2037" class="difflineat">@@ -2418,31 +2400,31 @@ ftvItem.prototype = {</span>
<a href="#l14.2038"></a><span id="l14.2038">     if (FeedMessageHandler.isFeedFolder(this._folder)) {</span>
<a href="#l14.2039"></a><span id="l14.2039">       properties += FeedUtils.getFolderProperties(this._folder, null);</span>
<a href="#l14.2040"></a><span id="l14.2040">       gFolderTreeView.setFolderCacheProperty(this._folder, &quot;properties&quot;, properties);</span>
<a href="#l14.2041"></a><span id="l14.2041">     }</span>
<a href="#l14.2042"></a><span id="l14.2042"> </span>
<a href="#l14.2043"></a><span id="l14.2043">     return properties;</span>
<a href="#l14.2044"></a><span id="l14.2044">   },</span>
<a href="#l14.2045"></a><span id="l14.2045"> </span>
<a href="#l14.2046"></a><span id="l14.2046" class="difflineminus">-  command: function fti_command() {</span>
<a href="#l14.2047"></a><span id="l14.2047" class="difflineplus">+  command() {</span>
<a href="#l14.2048"></a><span id="l14.2048">     if (!Services.prefs.getBoolPref(&quot;mailnews.reuse_thread_window2&quot;))</span>
<a href="#l14.2049"></a><span id="l14.2049">       MsgOpenNewWindowForFolder(this._folder.URI, -1 /* key */);</span>
<a href="#l14.2050"></a><span id="l14.2050">   },</span>
<a href="#l14.2051"></a><span id="l14.2051"> </span>
<a href="#l14.2052"></a><span id="l14.2052">   _children: null,</span>
<a href="#l14.2053"></a><span id="l14.2053">   get children() {</span>
<a href="#l14.2054"></a><span id="l14.2054">     // We're caching our child list to save perf.</span>
<a href="#l14.2055"></a><span id="l14.2055">     if (!this._children) {</span>
<a href="#l14.2056"></a><span id="l14.2056">       let iter;</span>
<a href="#l14.2057"></a><span id="l14.2057">       try {</span>
<a href="#l14.2058"></a><span id="l14.2058">         iter = fixIterator(this._folder.subFolders, Ci.nsIMsgFolder);</span>
<a href="#l14.2059"></a><span id="l14.2059">       } catch (ex) {</span>
<a href="#l14.2060"></a><span id="l14.2060">         Services.console.logStringMessage(&quot;Discovering children for &quot; + this._folder.URI +</span>
<a href="#l14.2061"></a><span id="l14.2061" class="difflineminus">-                                          &quot; failed with &quot; + &quot;exception: &quot; + ex);</span>
<a href="#l14.2062"></a><span id="l14.2062" class="difflineplus">+                                          &quot; failed with exception: &quot; + ex);</span>
<a href="#l14.2063"></a><span id="l14.2063">         iter = [];</span>
<a href="#l14.2064"></a><span id="l14.2064">       }</span>
<a href="#l14.2065"></a><span id="l14.2065">       this._children = [];</span>
<a href="#l14.2066"></a><span id="l14.2066">       // Out of all children, only keep those that match the _folderFilter</span>
<a href="#l14.2067"></a><span id="l14.2067">       // and those that contain such children.</span>
<a href="#l14.2068"></a><span id="l14.2068">       for (let folder of iter) {</span>
<a href="#l14.2069"></a><span id="l14.2069">         if (!this._folderFilter || this._folderFilter(folder)) {</span>
<a href="#l14.2070"></a><span id="l14.2070">           this._children.push(new ftvItem(folder, this._folderFilter));</span>
<a href="#l14.2071"></a><span id="l14.2071" class="difflineat">@@ -2451,31 +2433,31 @@ ftvItem.prototype = {</span>
<a href="#l14.2072"></a><span id="l14.2072">       sortFolderItems(this._children);</span>
<a href="#l14.2073"></a><span id="l14.2073">       // Each child is a level one below us</span>
<a href="#l14.2074"></a><span id="l14.2074">       for (let child of this._children) {</span>
<a href="#l14.2075"></a><span id="l14.2075">         child._level = this._level + 1;</span>
<a href="#l14.2076"></a><span id="l14.2076">         child._parent = this;</span>
<a href="#l14.2077"></a><span id="l14.2077">       }</span>
<a href="#l14.2078"></a><span id="l14.2078">     }</span>
<a href="#l14.2079"></a><span id="l14.2079">     return this._children;</span>
<a href="#l14.2080"></a><span id="l14.2080" class="difflineminus">-  }</span>
<a href="#l14.2081"></a><span id="l14.2081" class="difflineplus">+  },</span>
<a href="#l14.2082"></a><span id="l14.2082"> };</span>
<a href="#l14.2083"></a><span id="l14.2083"> </span>
<a href="#l14.2084"></a><span id="l14.2084"> /**</span>
<a href="#l14.2085"></a><span id="l14.2085">  * This handles the invocation of most commands dealing with folders, based off</span>
<a href="#l14.2086"></a><span id="l14.2086">  * of the current selection, or a passed in folder.</span>
<a href="#l14.2087"></a><span id="l14.2087">  */</span>
<a href="#l14.2088"></a><span id="l14.2088"> var gFolderTreeController = {</span>
<a href="#l14.2089"></a><span id="l14.2089">   /**</span>
<a href="#l14.2090"></a><span id="l14.2090">    * Opens the dialog to create a new sub-folder, and creates it if the user</span>
<a href="#l14.2091"></a><span id="l14.2091">    * accepts</span>
<a href="#l14.2092"></a><span id="l14.2092">    *</span>
<a href="#l14.2093"></a><span id="l14.2093">    * @param aParent (optional)  the parent for the new subfolder</span>
<a href="#l14.2094"></a><span id="l14.2094">    */</span>
<a href="#l14.2095"></a><span id="l14.2095" class="difflineminus">-  newFolder: function ftc_newFolder(aParent) {</span>
<a href="#l14.2096"></a><span id="l14.2096" class="difflineplus">+  newFolder(aParent) {</span>
<a href="#l14.2097"></a><span id="l14.2097">     let folder = aParent || gFolderTreeView.getSelectedFolders()[0];</span>
<a href="#l14.2098"></a><span id="l14.2098"> </span>
<a href="#l14.2099"></a><span id="l14.2099">     // Make sure we actually can create subfolders</span>
<a href="#l14.2100"></a><span id="l14.2100">     if (!folder.canCreateSubfolders) {</span>
<a href="#l14.2101"></a><span id="l14.2101">       // Check if we can create them at the root</span>
<a href="#l14.2102"></a><span id="l14.2102">       let rootMsgFolder = folder.server.rootMsgFolder;</span>
<a href="#l14.2103"></a><span id="l14.2103">       if (rootMsgFolder.canCreateSubfolders)</span>
<a href="#l14.2104"></a><span id="l14.2104">         folder = rootMsgFolder;</span>
<a href="#l14.2105"></a><span id="l14.2105" class="difflineat">@@ -2494,49 +2476,49 @@ var gFolderTreeController = {</span>
<a href="#l14.2106"></a><span id="l14.2106">       // nsMsgLocalMailFolder::CreateSubfolderInternal to here (bug 831190#c16).</span>
<a href="#l14.2107"></a><span id="l14.2107">       if (aName)</span>
<a href="#l14.2108"></a><span id="l14.2108">         aFolder.createSubfolder(aName, msgWindow);</span>
<a href="#l14.2109"></a><span id="l14.2109">     }</span>
<a href="#l14.2110"></a><span id="l14.2110"> </span>
<a href="#l14.2111"></a><span id="l14.2111">     window.openDialog(&quot;chrome://messenger/content/newFolderDialog.xul&quot;,</span>
<a href="#l14.2112"></a><span id="l14.2112">                       &quot;&quot;,</span>
<a href="#l14.2113"></a><span id="l14.2113">                       &quot;chrome,modal,resizable=no,centerscreen&quot;,</span>
<a href="#l14.2114"></a><span id="l14.2114" class="difflineminus">-                      {folder: folder, dualUseFolders: dualUseFolders,</span>
<a href="#l14.2115"></a><span id="l14.2115" class="difflineplus">+                      {folder, dualUseFolders,</span>
<a href="#l14.2116"></a><span id="l14.2116">                        okCallback: newFolderCallback});</span>
<a href="#l14.2117"></a><span id="l14.2117">   },</span>
<a href="#l14.2118"></a><span id="l14.2118"> </span>
<a href="#l14.2119"></a><span id="l14.2119">   /**</span>
<a href="#l14.2120"></a><span id="l14.2120">    * Opens the dialog to edit the properties for a folder</span>
<a href="#l14.2121"></a><span id="l14.2121">    *</span>
<a href="#l14.2122"></a><span id="l14.2122">    * @param aTabID  (optional) the tab to show in the dialog</span>
<a href="#l14.2123"></a><span id="l14.2123">    * @param aFolder (optional) the folder to edit, if not the selected one</span>
<a href="#l14.2124"></a><span id="l14.2124">    */</span>
<a href="#l14.2125"></a><span id="l14.2125" class="difflineminus">-  editFolder: function ftc_editFolder(aTabID, aFolder) {</span>
<a href="#l14.2126"></a><span id="l14.2126" class="difflineplus">+  editFolder(aTabID, aFolder) {</span>
<a href="#l14.2127"></a><span id="l14.2127">     let folder = aFolder || gFolderTreeView.getSelectedFolders()[0];</span>
<a href="#l14.2128"></a><span id="l14.2128"> </span>
<a href="#l14.2129"></a><span id="l14.2129">     // If this is actually a server, send it off to that controller</span>
<a href="#l14.2130"></a><span id="l14.2130">     if (folder.isServer) {</span>
<a href="#l14.2131"></a><span id="l14.2131">       MsgAccountManager(null, folder.server);</span>
<a href="#l14.2132"></a><span id="l14.2132">       return;</span>
<a href="#l14.2133"></a><span id="l14.2133">     }</span>
<a href="#l14.2134"></a><span id="l14.2134"> </span>
<a href="#l14.2135"></a><span id="l14.2135">     if (folder.getFlag(Ci.nsMsgFolderFlags.Virtual)) {</span>
<a href="#l14.2136"></a><span id="l14.2136">       this.editVirtualFolder(folder);</span>
<a href="#l14.2137"></a><span id="l14.2137">       return;</span>
<a href="#l14.2138"></a><span id="l14.2138">     }</span>
<a href="#l14.2139"></a><span id="l14.2139">     let title = gFolderTreeView.messengerBundle</span>
<a href="#l14.2140"></a><span id="l14.2140">                                .getString(&quot;folderProperties&quot;);</span>
<a href="#l14.2141"></a><span id="l14.2141"> </span>
<a href="#l14.2142"></a><span id="l14.2142" class="difflineminus">-    //xxx useless param</span>
<a href="#l14.2143"></a><span id="l14.2143" class="difflineplus">+    // xxx useless param</span>
<a href="#l14.2144"></a><span id="l14.2144">     function editFolderCallback(aNewName, aOldName, aUri) {</span>
<a href="#l14.2145"></a><span id="l14.2145">       if (aNewName != aOldName)</span>
<a href="#l14.2146"></a><span id="l14.2146">         folder.rename(aNewName, msgWindow);</span>
<a href="#l14.2147"></a><span id="l14.2147">     }</span>
<a href="#l14.2148"></a><span id="l14.2148"> </span>
<a href="#l14.2149"></a><span id="l14.2149" class="difflineminus">-    //xxx useless param</span>
<a href="#l14.2150"></a><span id="l14.2150" class="difflineplus">+    // xxx useless param</span>
<a href="#l14.2151"></a><span id="l14.2151">     function rebuildSummary(aFolder) {</span>
<a href="#l14.2152"></a><span id="l14.2152">       // folder is already introduced in our containing function and is</span>
<a href="#l14.2153"></a><span id="l14.2153">       //  lexically captured and available to us.</span>
<a href="#l14.2154"></a><span id="l14.2154">       if (folder.locked) {</span>
<a href="#l14.2155"></a><span id="l14.2155">         folder.throwAlertMsg(&quot;operationFailedFolderBusy&quot;, msgWindow);</span>
<a href="#l14.2156"></a><span id="l14.2156">         return;</span>
<a href="#l14.2157"></a><span id="l14.2157">       }</span>
<a href="#l14.2158"></a><span id="l14.2158">       if (folder.supportsOffline) {</span>
<a href="#l14.2159"></a><span id="l14.2159" class="difflineat">@@ -2554,46 +2536,45 @@ var gFolderTreeController = {</span>
<a href="#l14.2160"></a><span id="l14.2160">                                        null);</span>
<a href="#l14.2161"></a><span id="l14.2161"> </span>
<a href="#l14.2162"></a><span id="l14.2162">       folder.msgDatabase.summaryValid = false;</span>
<a href="#l14.2163"></a><span id="l14.2163"> </span>
<a href="#l14.2164"></a><span id="l14.2164">       var msgDB = folder.msgDatabase;</span>
<a href="#l14.2165"></a><span id="l14.2165">       msgDB.summaryValid = false;</span>
<a href="#l14.2166"></a><span id="l14.2166">       try {</span>
<a href="#l14.2167"></a><span id="l14.2167">         folder.closeAndBackupFolderDB(&quot;&quot;);</span>
<a href="#l14.2168"></a><span id="l14.2168" class="difflineminus">-      }</span>
<a href="#l14.2169"></a><span id="l14.2169" class="difflineminus">-      catch(e) {</span>
<a href="#l14.2170"></a><span id="l14.2170" class="difflineplus">+      } catch (e) {</span>
<a href="#l14.2171"></a><span id="l14.2171">         // In a failure, proceed anyway since we're dealing with problems</span>
<a href="#l14.2172"></a><span id="l14.2172">         folder.ForceDBClosed();</span>
<a href="#l14.2173"></a><span id="l14.2173">       }</span>
<a href="#l14.2174"></a><span id="l14.2174">       folder.updateFolder(msgWindow);</span>
<a href="#l14.2175"></a><span id="l14.2175">       gFolderDisplay.show(folder);</span>
<a href="#l14.2176"></a><span id="l14.2176">     }</span>
<a href="#l14.2177"></a><span id="l14.2177"> </span>
<a href="#l14.2178"></a><span id="l14.2178">     window.openDialog(&quot;chrome://messenger/content/folderProps.xul&quot;,</span>
<a href="#l14.2179"></a><span id="l14.2179">                       &quot;&quot;,</span>
<a href="#l14.2180"></a><span id="l14.2180">                       &quot;chrome,modal,centerscreen&quot;,</span>
<a href="#l14.2181"></a><span id="l14.2181" class="difflineminus">-                      {folder: folder, serverType: folder.server.type,</span>
<a href="#l14.2182"></a><span id="l14.2182" class="difflineminus">-                       msgWindow: msgWindow, title: title,</span>
<a href="#l14.2183"></a><span id="l14.2183" class="difflineplus">+                      {folder, serverType: folder.server.type,</span>
<a href="#l14.2184"></a><span id="l14.2184" class="difflineplus">+                       msgWindow, title,</span>
<a href="#l14.2185"></a><span id="l14.2185">                        okCallback: editFolderCallback,</span>
<a href="#l14.2186"></a><span id="l14.2186">                        tabID: aTabID, name: folder.prettyName,</span>
<a href="#l14.2187"></a><span id="l14.2187">                        rebuildSummaryCallback: rebuildSummary});</span>
<a href="#l14.2188"></a><span id="l14.2188">   },</span>
<a href="#l14.2189"></a><span id="l14.2189"> </span>
<a href="#l14.2190"></a><span id="l14.2190">   /**</span>
<a href="#l14.2191"></a><span id="l14.2191">    * Opens the dialog to rename a particular folder, and does the renaming if</span>
<a href="#l14.2192"></a><span id="l14.2192">    * the user clicks OK in that dialog</span>
<a href="#l14.2193"></a><span id="l14.2193">    *</span>
<a href="#l14.2194"></a><span id="l14.2194">    * @param aFolder (optional)  the folder to rename, if different than the</span>
<a href="#l14.2195"></a><span id="l14.2195">    *                            currently selected one</span>
<a href="#l14.2196"></a><span id="l14.2196">    */</span>
<a href="#l14.2197"></a><span id="l14.2197" class="difflineminus">-  renameFolder: function ftc_rename(aFolder) {</span>
<a href="#l14.2198"></a><span id="l14.2198" class="difflineplus">+  renameFolder(aFolder) {</span>
<a href="#l14.2199"></a><span id="l14.2199">     let folder = aFolder || gFolderTreeView.getSelectedFolders()[0];</span>
<a href="#l14.2200"></a><span id="l14.2200"> </span>
<a href="#l14.2201"></a><span id="l14.2201" class="difflineminus">-    //xxx no need for uri now</span>
<a href="#l14.2202"></a><span id="l14.2202" class="difflineplus">+    // xxx no need for uri now</span>
<a href="#l14.2203"></a><span id="l14.2203">     let controller = this;</span>
<a href="#l14.2204"></a><span id="l14.2204">     function renameCallback(aName, aUri) {</span>
<a href="#l14.2205"></a><span id="l14.2205">       if (aUri != folder.URI)</span>
<a href="#l14.2206"></a><span id="l14.2206">         Cu.reportError(&quot;got back a different folder to rename!&quot;);</span>
<a href="#l14.2207"></a><span id="l14.2207"> </span>
<a href="#l14.2208"></a><span id="l14.2208">       controller._tree.view.selection.clearSelection();</span>
<a href="#l14.2209"></a><span id="l14.2209"> </span>
<a href="#l14.2210"></a><span id="l14.2210">       // Actually do the rename</span>
<a href="#l14.2211"></a><span id="l14.2211" class="difflineat">@@ -2607,17 +2588,17 @@ var gFolderTreeController = {</span>
<a href="#l14.2212"></a><span id="l14.2212">   },</span>
<a href="#l14.2213"></a><span id="l14.2213"> </span>
<a href="#l14.2214"></a><span id="l14.2214">   /**</span>
<a href="#l14.2215"></a><span id="l14.2215">    * Deletes a folder from its parent. Also handles unsubscribe from newsgroups</span>
<a href="#l14.2216"></a><span id="l14.2216">    * if the selected folder/s happen to be nntp.</span>
<a href="#l14.2217"></a><span id="l14.2217">    *</span>
<a href="#l14.2218"></a><span id="l14.2218">    * @param aFolder (optional) the folder to delete, if not the selected one</span>
<a href="#l14.2219"></a><span id="l14.2219">    */</span>
<a href="#l14.2220"></a><span id="l14.2220" class="difflineminus">-  deleteFolder: function ftc_delete(aFolder) {</span>
<a href="#l14.2221"></a><span id="l14.2221" class="difflineplus">+  deleteFolder(aFolder) {</span>
<a href="#l14.2222"></a><span id="l14.2222">     let folders = aFolder ? [aFolder] : gFolderTreeView.getSelectedFolders();</span>
<a href="#l14.2223"></a><span id="l14.2223">     let folder = folders[0];</span>
<a href="#l14.2224"></a><span id="l14.2224"> </span>
<a href="#l14.2225"></a><span id="l14.2225">     // For newsgroups, &quot;delete&quot; means &quot;unsubscribe&quot;.</span>
<a href="#l14.2226"></a><span id="l14.2226">     if (folder.server.type == &quot;nntp&quot; &amp;&amp; !folder.getFlag(Ci.nsMsgFolderFlags.Virtual)) {</span>
<a href="#l14.2227"></a><span id="l14.2227">       MsgUnsubscribe(folders);</span>
<a href="#l14.2228"></a><span id="l14.2228">       return;</span>
<a href="#l14.2229"></a><span id="l14.2229">     }</span>
<a href="#l14.2230"></a><span id="l14.2230" class="difflineat">@@ -2647,17 +2628,17 @@ var gFolderTreeController = {</span>
<a href="#l14.2231"></a><span id="l14.2231">   /**</span>
<a href="#l14.2232"></a><span id="l14.2232">    * Prompts the user to confirm and empties the trash for the selected folder.</span>
<a href="#l14.2233"></a><span id="l14.2233">    * The folder and its children are only emptied if it has the proper Trash flag.</span>
<a href="#l14.2234"></a><span id="l14.2234">    *</span>
<a href="#l14.2235"></a><span id="l14.2235">    * @param aFolder (optional)  the trash folder to empty</span>
<a href="#l14.2236"></a><span id="l14.2236">    * @note Calling this function on a non-trash folder will result in strange</span>
<a href="#l14.2237"></a><span id="l14.2237">    *       behavior!</span>
<a href="#l14.2238"></a><span id="l14.2238">    */</span>
<a href="#l14.2239"></a><span id="l14.2239" class="difflineminus">-  emptyTrash: function ftc_emptyTrash(aFolder) {</span>
<a href="#l14.2240"></a><span id="l14.2240" class="difflineplus">+  emptyTrash(aFolder) {</span>
<a href="#l14.2241"></a><span id="l14.2241">     let folder = aFolder || gFolderTreeView.getSelectedFolders()[0];</span>
<a href="#l14.2242"></a><span id="l14.2242"> </span>
<a href="#l14.2243"></a><span id="l14.2243">     if (!folder)</span>
<a href="#l14.2244"></a><span id="l14.2244">       return;</span>
<a href="#l14.2245"></a><span id="l14.2245"> </span>
<a href="#l14.2246"></a><span id="l14.2246">     if (!this._checkConfirmationPrompt(&quot;emptyTrash&quot;, folder))</span>
<a href="#l14.2247"></a><span id="l14.2247">       return;</span>
<a href="#l14.2248"></a><span id="l14.2248"> </span>
<a href="#l14.2249"></a><span id="l14.2249" class="difflineat">@@ -2665,29 +2646,28 @@ var gFolderTreeController = {</span>
<a href="#l14.2250"></a><span id="l14.2250">       // to empty all the trash folders.</span>
<a href="#l14.2251"></a><span id="l14.2251">       if (folder.server.hostName == &quot;smart mailboxes&quot; &amp;&amp;</span>
<a href="#l14.2252"></a><span id="l14.2252">           folder.parent.isServer) {</span>
<a href="#l14.2253"></a><span id="l14.2253">         let subFolders = gFolderTreeView</span>
<a href="#l14.2254"></a><span id="l14.2254">                            ._allFoldersWithFlag(gFolderTreeView._sortedAccounts(),</span>
<a href="#l14.2255"></a><span id="l14.2255">                             Ci.nsMsgFolderFlags.Trash, false);</span>
<a href="#l14.2256"></a><span id="l14.2256">         for (let trash of subFolders)</span>
<a href="#l14.2257"></a><span id="l14.2257">           trash.emptyTrash(msgWindow, null);</span>
<a href="#l14.2258"></a><span id="l14.2258" class="difflineminus">-      }</span>
<a href="#l14.2259"></a><span id="l14.2259" class="difflineminus">-      else {</span>
<a href="#l14.2260"></a><span id="l14.2260" class="difflineplus">+      } else {</span>
<a href="#l14.2261"></a><span id="l14.2261">         folder.emptyTrash(msgWindow, null);</span>
<a href="#l14.2262"></a><span id="l14.2262">       }</span>
<a href="#l14.2263"></a><span id="l14.2263">   },</span>
<a href="#l14.2264"></a><span id="l14.2264"> </span>
<a href="#l14.2265"></a><span id="l14.2265">   /**</span>
<a href="#l14.2266"></a><span id="l14.2266">    * Deletes everything (folders and messages) in the selected folder.</span>
<a href="#l14.2267"></a><span id="l14.2267">    * The folder is only emptied if it has the proper Junk flag.</span>
<a href="#l14.2268"></a><span id="l14.2268">    *</span>
<a href="#l14.2269"></a><span id="l14.2269">    * @param aFolder (optional)  the folder to empty</span>
<a href="#l14.2270"></a><span id="l14.2270">    */</span>
<a href="#l14.2271"></a><span id="l14.2271" class="difflineminus">-  emptyJunk: function ftc_emptyJunk(aFolder) {</span>
<a href="#l14.2272"></a><span id="l14.2272" class="difflineplus">+  emptyJunk(aFolder) {</span>
<a href="#l14.2273"></a><span id="l14.2273">     let folder = aFolder || gFolderTreeView.getSelectedFolders()[0];</span>
<a href="#l14.2274"></a><span id="l14.2274"> </span>
<a href="#l14.2275"></a><span id="l14.2275">     if (!folder || !folder.getFlag(Ci.nsMsgFolderFlags.Junk))</span>
<a href="#l14.2276"></a><span id="l14.2276">       return;</span>
<a href="#l14.2277"></a><span id="l14.2277"> </span>
<a href="#l14.2278"></a><span id="l14.2278">     if (!this._checkConfirmationPrompt(&quot;emptyJunk&quot;, folder))</span>
<a href="#l14.2279"></a><span id="l14.2279">       return;</span>
<a href="#l14.2280"></a><span id="l14.2280"> </span>
<a href="#l14.2281"></a><span id="l14.2281" class="difflineat">@@ -2703,17 +2683,17 @@ var gFolderTreeController = {</span>
<a href="#l14.2282"></a><span id="l14.2282">   },</span>
<a href="#l14.2283"></a><span id="l14.2283"> </span>
<a href="#l14.2284"></a><span id="l14.2284">   /**</span>
<a href="#l14.2285"></a><span id="l14.2285">    * Compacts either particular folder/s, or selected folders.</span>
<a href="#l14.2286"></a><span id="l14.2286">    *</span>
<a href="#l14.2287"></a><span id="l14.2287">    * @param aFolders (optional) the folders to compact, if different than the</span>
<a href="#l14.2288"></a><span id="l14.2288">    *                            currently selected ones</span>
<a href="#l14.2289"></a><span id="l14.2289">    */</span>
<a href="#l14.2290"></a><span id="l14.2290" class="difflineminus">-  compactFolders: function ftc_compactFolders(aFolders) {</span>
<a href="#l14.2291"></a><span id="l14.2291" class="difflineplus">+  compactFolders(aFolders) {</span>
<a href="#l14.2292"></a><span id="l14.2292">     let folders = aFolders || gFolderTreeView.getSelectedFolders();</span>
<a href="#l14.2293"></a><span id="l14.2293">     for (let i = 0; i &lt; folders.length; i++) {</span>
<a href="#l14.2294"></a><span id="l14.2294">       // Can't compact folders that have just been compacted.</span>
<a href="#l14.2295"></a><span id="l14.2295">       if (folders[i].server.type != &quot;imap&quot; &amp;&amp; !folders[i].expungedBytes)</span>
<a href="#l14.2296"></a><span id="l14.2296">         continue;</span>
<a href="#l14.2297"></a><span id="l14.2297"> </span>
<a href="#l14.2298"></a><span id="l14.2298">       folders[i].compact(null, msgWindow);</span>
<a href="#l14.2299"></a><span id="l14.2299">     }</span>
<a href="#l14.2300"></a><span id="l14.2300" class="difflineat">@@ -2722,95 +2702,95 @@ var gFolderTreeController = {</span>
<a href="#l14.2301"></a><span id="l14.2301">   /**</span>
<a href="#l14.2302"></a><span id="l14.2302">    * Compacts all folders for accounts that the given folders belong</span>
<a href="#l14.2303"></a><span id="l14.2303">    * to, or all folders for accounts of the currently selected folders.</span>
<a href="#l14.2304"></a><span id="l14.2304">    *</span>
<a href="#l14.2305"></a><span id="l14.2305">    * @param aFolders (optional) the folders for whose accounts we should compact</span>
<a href="#l14.2306"></a><span id="l14.2306">    *                            all folders, if different than the currently</span>
<a href="#l14.2307"></a><span id="l14.2307">    *                            selected ones</span>
<a href="#l14.2308"></a><span id="l14.2308">    */</span>
<a href="#l14.2309"></a><span id="l14.2309" class="difflineminus">-  compactAllFoldersForAccount: function ftc_compactAllFoldersOfAccount(aFolders) {</span>
<a href="#l14.2310"></a><span id="l14.2310" class="difflineplus">+  compactAllFoldersForAccount(aFolders) {</span>
<a href="#l14.2311"></a><span id="l14.2311">     let folders = aFolders || gFolderTreeView.getSelectedFolders();</span>
<a href="#l14.2312"></a><span id="l14.2312">     for (let i = 0; i &lt; folders.length; i++) {</span>
<a href="#l14.2313"></a><span id="l14.2313">       folders[i].compactAll(null, msgWindow, folders[i].server.type == &quot;imap&quot; ||</span>
<a href="#l14.2314"></a><span id="l14.2314">                                              folders[i].server.type == &quot;nntp&quot;);</span>
<a href="#l14.2315"></a><span id="l14.2315">     }</span>
<a href="#l14.2316"></a><span id="l14.2316">   },</span>
<a href="#l14.2317"></a><span id="l14.2317"> </span>
<a href="#l14.2318"></a><span id="l14.2318">   /**</span>
<a href="#l14.2319"></a><span id="l14.2319">    * Opens the dialog to create a new virtual folder</span>
<a href="#l14.2320"></a><span id="l14.2320">    *</span>
<a href="#l14.2321"></a><span id="l14.2321">    * @param aName - the default name for the new folder</span>
<a href="#l14.2322"></a><span id="l14.2322">    * @param aSearchTerms - the search terms associated with the folder</span>
<a href="#l14.2323"></a><span id="l14.2323">    * @param aParent - the folder to run the search terms on</span>
<a href="#l14.2324"></a><span id="l14.2324">    */</span>
<a href="#l14.2325"></a><span id="l14.2325" class="difflineminus">-  newVirtualFolder: function ftc_newVFolder(aName, aSearchTerms, aParent) {</span>
<a href="#l14.2326"></a><span id="l14.2326" class="difflineplus">+  newVirtualFolder(aName, aSearchTerms, aParent) {</span>
<a href="#l14.2327"></a><span id="l14.2327">     let folder = aParent || gFolderTreeView.getSelectedFolders()[0];</span>
<a href="#l14.2328"></a><span id="l14.2328">     if (!folder)</span>
<a href="#l14.2329"></a><span id="l14.2329">       folder = GetDefaultAccountRootFolder();</span>
<a href="#l14.2330"></a><span id="l14.2330"> </span>
<a href="#l14.2331"></a><span id="l14.2331">     let name = folder.prettyName;</span>
<a href="#l14.2332"></a><span id="l14.2332">     if (aName)</span>
<a href="#l14.2333"></a><span id="l14.2333">       name += &quot;-&quot; + aName;</span>
<a href="#l14.2334"></a><span id="l14.2334"> </span>
<a href="#l14.2335"></a><span id="l14.2335">     window.openDialog(&quot;chrome://messenger/content/virtualFolderProperties.xul&quot;,</span>
<a href="#l14.2336"></a><span id="l14.2336">                       &quot;&quot;,</span>
<a href="#l14.2337"></a><span id="l14.2337">                       &quot;chrome,modal,centerscreen&quot;,</span>
<a href="#l14.2338"></a><span id="l14.2338" class="difflineminus">-                      {folder: folder, searchTerms: aSearchTerms,</span>
<a href="#l14.2339"></a><span id="l14.2339" class="difflineplus">+                      {folder, searchTerms: aSearchTerms,</span>
<a href="#l14.2340"></a><span id="l14.2340">                        newFolderName: name});</span>
<a href="#l14.2341"></a><span id="l14.2341">   },</span>
<a href="#l14.2342"></a><span id="l14.2342"> </span>
<a href="#l14.2343"></a><span id="l14.2343" class="difflineminus">-  editVirtualFolder: function ftc_editVirtualFolder(aFolder) {</span>
<a href="#l14.2344"></a><span id="l14.2344" class="difflineplus">+  editVirtualFolder(aFolder) {</span>
<a href="#l14.2345"></a><span id="l14.2345">     let folder = aFolder || gFolderTreeView.getSelectedFolders()[0];</span>
<a href="#l14.2346"></a><span id="l14.2346"> </span>
<a href="#l14.2347"></a><span id="l14.2347" class="difflineminus">-    //xxx should pass the folder object</span>
<a href="#l14.2348"></a><span id="l14.2348" class="difflineplus">+    // xxx should pass the folder object</span>
<a href="#l14.2349"></a><span id="l14.2349">     function editVirtualCallback(aURI) {</span>
<a href="#l14.2350"></a><span id="l14.2350">       // we need to reload the folder if it is the currently loaded folder...</span>
<a href="#l14.2351"></a><span id="l14.2351">       if (gFolderDisplay.displayedFolder &amp;&amp;</span>
<a href="#l14.2352"></a><span id="l14.2352">           aURI == gFolderDisplay.displayedFolder.URI)</span>
<a href="#l14.2353"></a><span id="l14.2353">         FolderPaneSelectionChange();</span>
<a href="#l14.2354"></a><span id="l14.2354">     }</span>
<a href="#l14.2355"></a><span id="l14.2355">     window.openDialog(&quot;chrome://messenger/content/virtualFolderProperties.xul&quot;,</span>
<a href="#l14.2356"></a><span id="l14.2356">                       &quot;&quot;,</span>
<a href="#l14.2357"></a><span id="l14.2357">                       &quot;chrome,modal,centerscreen&quot;,</span>
<a href="#l14.2358"></a><span id="l14.2358" class="difflineminus">-                      {folder: folder, editExistingFolder: true,</span>
<a href="#l14.2359"></a><span id="l14.2359" class="difflineplus">+                      {folder, editExistingFolder: true,</span>
<a href="#l14.2360"></a><span id="l14.2360">                        onOKCallback: editVirtualCallback,</span>
<a href="#l14.2361"></a><span id="l14.2361" class="difflineminus">-                       msgWindow: msgWindow});</span>
<a href="#l14.2362"></a><span id="l14.2362" class="difflineplus">+                       msgWindow});</span>
<a href="#l14.2363"></a><span id="l14.2363">   },</span>
<a href="#l14.2364"></a><span id="l14.2364"> </span>
<a href="#l14.2365"></a><span id="l14.2365">   /**</span>
<a href="#l14.2366"></a><span id="l14.2366">    * Opens a search window with the given folder, or the selected one if none</span>
<a href="#l14.2367"></a><span id="l14.2367">    * is given.</span>
<a href="#l14.2368"></a><span id="l14.2368">    *</span>
<a href="#l14.2369"></a><span id="l14.2369">    * @param [aFolder] the folder to open the search window for, if different</span>
<a href="#l14.2370"></a><span id="l14.2370">    *                  from the selected one</span>
<a href="#l14.2371"></a><span id="l14.2371">    */</span>
<a href="#l14.2372"></a><span id="l14.2372" class="difflineminus">-  searchMessages: function ftc_searchMessages(aFolder) {</span>
<a href="#l14.2373"></a><span id="l14.2373" class="difflineplus">+  searchMessages(aFolder) {</span>
<a href="#l14.2374"></a><span id="l14.2374">     MsgSearchMessages(aFolder || gFolderTreeView.getSelectedFolders()[0]);</span>
<a href="#l14.2375"></a><span id="l14.2375">   },</span>
<a href="#l14.2376"></a><span id="l14.2376"> </span>
<a href="#l14.2377"></a><span id="l14.2377">   /**</span>
<a href="#l14.2378"></a><span id="l14.2378">    * Prompts for confirmation, if the user hasn't already chosen the &quot;don't ask</span>
<a href="#l14.2379"></a><span id="l14.2379">    * again&quot; option.</span>
<a href="#l14.2380"></a><span id="l14.2380">    *</span>
<a href="#l14.2381"></a><span id="l14.2381">    * @param aCommand  the command to prompt for</span>
<a href="#l14.2382"></a><span id="l14.2382">    * @param aFolder   The folder for which the confirmation is requested.</span>
<a href="#l14.2383"></a><span id="l14.2383">    */</span>
<a href="#l14.2384"></a><span id="l14.2384" class="difflineminus">-  _checkConfirmationPrompt: function ftc_confirm(aCommand, aFolder) {</span>
<a href="#l14.2385"></a><span id="l14.2385" class="difflineplus">+  _checkConfirmationPrompt(aCommand, aFolder) {</span>
<a href="#l14.2386"></a><span id="l14.2386">     // If no folder was specified, reject the operation.</span>
<a href="#l14.2387"></a><span id="l14.2387">     if (!aFolder)</span>
<a href="#l14.2388"></a><span id="l14.2388">       return false;</span>
<a href="#l14.2389"></a><span id="l14.2389"> </span>
<a href="#l14.2390"></a><span id="l14.2390">     let showPrompt = true;</span>
<a href="#l14.2391"></a><span id="l14.2391">     try {</span>
<a href="#l14.2392"></a><span id="l14.2392">       showPrompt = !Services.prefs.getBoolPref(&quot;mailnews.&quot; + aCommand + &quot;.dontAskAgain&quot;);</span>
<a href="#l14.2393"></a><span id="l14.2393">     } catch (ex) {}</span>
<a href="#l14.2394"></a><span id="l14.2394"> </span>
<a href="#l14.2395"></a><span id="l14.2395">     if (showPrompt) {</span>
<a href="#l14.2396"></a><span id="l14.2396" class="difflineminus">-      let checkbox = {value:false};</span>
<a href="#l14.2397"></a><span id="l14.2397" class="difflineplus">+      let checkbox = {value: false};</span>
<a href="#l14.2398"></a><span id="l14.2398">       let title = gFolderTreeView.messengerBundle</span>
<a href="#l14.2399"></a><span id="l14.2399">         .getFormattedString(aCommand + &quot;FolderTitle&quot;, [aFolder.prettyName]);</span>
<a href="#l14.2400"></a><span id="l14.2400">       let msg = gFolderTreeView.messengerBundle.getString(aCommand + &quot;FolderMessage&quot;);</span>
<a href="#l14.2401"></a><span id="l14.2401">       let ok = Services.prompt.confirmEx(window,</span>
<a href="#l14.2402"></a><span id="l14.2402">                                          title,</span>
<a href="#l14.2403"></a><span id="l14.2403">                                          msg,</span>
<a href="#l14.2404"></a><span id="l14.2404">                                          Services.prompt.STD_YES_NO_BUTTONS,</span>
<a href="#l14.2405"></a><span id="l14.2405">                                          null, null, null,</span>
<a href="#l14.2406"></a><span id="l14.2406" class="difflineat">@@ -2823,67 +2803,65 @@ var gFolderTreeController = {</span>
<a href="#l14.2407"></a><span id="l14.2407">     }</span>
<a href="#l14.2408"></a><span id="l14.2408">     return true;</span>
<a href="#l14.2409"></a><span id="l14.2409">   },</span>
<a href="#l14.2410"></a><span id="l14.2410"> </span>
<a href="#l14.2411"></a><span id="l14.2411">   get _tree() {</span>
<a href="#l14.2412"></a><span id="l14.2412">     let tree = document.getElementById(&quot;folderTree&quot;);</span>
<a href="#l14.2413"></a><span id="l14.2413">     delete this._tree;</span>
<a href="#l14.2414"></a><span id="l14.2414">     return this._tree = tree;</span>
<a href="#l14.2415"></a><span id="l14.2415" class="difflineminus">-  }</span>
<a href="#l14.2416"></a><span id="l14.2416" class="difflineplus">+  },</span>
<a href="#l14.2417"></a><span id="l14.2417"> };</span>
<a href="#l14.2418"></a><span id="l14.2418"> </span>
<a href="#l14.2419"></a><span id="l14.2419"> /**</span>
<a href="#l14.2420"></a><span id="l14.2420">  * Constructor for ftv_SmartItem. This is a top level item in the &quot;smart&quot;</span>
<a href="#l14.2421"></a><span id="l14.2421">  * (a.k.a. &quot;Unified&quot;) folder mode.</span>
<a href="#l14.2422"></a><span id="l14.2422">  */</span>
<a href="#l14.2423"></a><span id="l14.2423" class="difflineminus">-function ftv_SmartItem(aFolder)</span>
<a href="#l14.2424"></a><span id="l14.2424" class="difflineminus">-{</span>
<a href="#l14.2425"></a><span id="l14.2425" class="difflineplus">+function ftv_SmartItem(aFolder) {</span>
<a href="#l14.2426"></a><span id="l14.2426">   ftvItem.call(this, aFolder); // call super constructor</span>
<a href="#l14.2427"></a><span id="l14.2427">   this._level = 0;</span>
<a href="#l14.2428"></a><span id="l14.2428"> }</span>
<a href="#l14.2429"></a><span id="l14.2429"> </span>
<a href="#l14.2430"></a><span id="l14.2430"> ftv_SmartItem.prototype = {</span>
<a href="#l14.2431"></a><span id="l14.2431">   __proto__: ftvItem.prototype,</span>
<a href="#l14.2432"></a><span id="l14.2432">   get children() {</span>
<a href="#l14.2433"></a><span id="l14.2433">     let smartMode = gFolderTreeView.getFolderTreeMode(&quot;smart&quot;);</span>
<a href="#l14.2434"></a><span id="l14.2434"> </span>
<a href="#l14.2435"></a><span id="l14.2435">     // We're caching our child list to save perf.</span>
<a href="#l14.2436"></a><span id="l14.2436">     if (!this._children) {</span>
<a href="#l14.2437"></a><span id="l14.2437">       this._children = [];</span>
<a href="#l14.2438"></a><span id="l14.2438">       let iter = fixIterator(this._folder.subFolders, Ci.nsIMsgFolder);</span>
<a href="#l14.2439"></a><span id="l14.2439">       for (let folder of iter) {</span>
<a href="#l14.2440"></a><span id="l14.2440">         if (!smartMode.isSmartFolder(folder)) {</span>
<a href="#l14.2441"></a><span id="l14.2441">           this._children.push(new ftv_SmartItem(folder));</span>
<a href="#l14.2442"></a><span id="l14.2442" class="difflineminus">-        }</span>
<a href="#l14.2443"></a><span id="l14.2443" class="difflineminus">-        else if (folder.getFlag(Ci.nsMsgFolderFlags.Inbox)) {</span>
<a href="#l14.2444"></a><span id="l14.2444" class="difflineplus">+        } else if (folder.getFlag(Ci.nsMsgFolderFlags.Inbox)) {</span>
<a href="#l14.2445"></a><span id="l14.2445">           let subIter = fixIterator(folder.subFolders, Ci.nsIMsgFolder);</span>
<a href="#l14.2446"></a><span id="l14.2446">           for (let subfolder of subIter) {</span>
<a href="#l14.2447"></a><span id="l14.2447">             if (!smartMode.isSmartFolder(subfolder))</span>
<a href="#l14.2448"></a><span id="l14.2448">               this._children.push(new ftv_SmartItem(subfolder));</span>
<a href="#l14.2449"></a><span id="l14.2449">           }</span>
<a href="#l14.2450"></a><span id="l14.2450">         }</span>
<a href="#l14.2451"></a><span id="l14.2451">       }</span>
<a href="#l14.2452"></a><span id="l14.2452">       sortFolderItems(this._children);</span>
<a href="#l14.2453"></a><span id="l14.2453">       // Each child is a level one below us</span>
<a href="#l14.2454"></a><span id="l14.2454">       for (let child of this._children) {</span>
<a href="#l14.2455"></a><span id="l14.2455">         child._level = this._level + 1;</span>
<a href="#l14.2456"></a><span id="l14.2456">         child._parent = this;</span>
<a href="#l14.2457"></a><span id="l14.2457">       }</span>
<a href="#l14.2458"></a><span id="l14.2458">     }</span>
<a href="#l14.2459"></a><span id="l14.2459">     return this._children;</span>
<a href="#l14.2460"></a><span id="l14.2460" class="difflineminus">-  }</span>
<a href="#l14.2461"></a><span id="l14.2461" class="difflineminus">-}</span>
<a href="#l14.2462"></a><span id="l14.2462" class="difflineplus">+  },</span>
<a href="#l14.2463"></a><span id="l14.2463" class="difflineplus">+};</span>
<a href="#l14.2464"></a><span id="l14.2464"> </span>
<a href="#l14.2465"></a><span id="l14.2465"> /**</span>
<a href="#l14.2466"></a><span id="l14.2466">  * Sorts the passed in array of folder items using the folder sort key</span>
<a href="#l14.2467"></a><span id="l14.2467">  *</span>
<a href="#l14.2468"></a><span id="l14.2468">  * @param aFolders - the array of ftvItems to sort.</span>
<a href="#l14.2469"></a><span id="l14.2469">  */</span>
<a href="#l14.2470"></a><span id="l14.2470" class="difflineminus">-function sortFolderItems (aFtvItems) {</span>
<a href="#l14.2471"></a><span id="l14.2471" class="difflineplus">+function sortFolderItems(aFtvItems) {</span>
<a href="#l14.2472"></a><span id="l14.2472">   function sorter(a, b) {</span>
<a href="#l14.2473"></a><span id="l14.2473">     return a._folder.compareSortKeys(b._folder);</span>
<a href="#l14.2474"></a><span id="l14.2474">   }</span>
<a href="#l14.2475"></a><span id="l14.2475">   aFtvItems.sort(sorter);</span>
<a href="#l14.2476"></a><span id="l14.2476"> }</span>
<a href="#l14.2477"></a><span id="l14.2477"> </span>
<a href="#l14.2478"></a><span id="l14.2478"> /**</span>
<a href="#l14.2479"></a><span id="l14.2479">  * An extension wishing to set a folderpane tree property must use</span>
<a href="#l14.2480"></a><span id="l14.2480" class="difflineat">@@ -2912,17 +2890,17 @@ function setSmartFolderName(aFolder, aNa</span>
<a href="#l14.2481"></a><span id="l14.2481"> var gFolderStatsHelpers = {</span>
<a href="#l14.2482"></a><span id="l14.2482">     kUnknownSize: &quot;-&quot;,</span>
<a href="#l14.2483"></a><span id="l14.2483">     sumSubfoldersPref: false,</span>
<a href="#l14.2484"></a><span id="l14.2484">     sumSubfolders: false,</span>
<a href="#l14.2485"></a><span id="l14.2485">     sizeUnits: &quot;&quot;,</span>
<a href="#l14.2486"></a><span id="l14.2486">     kiloUnit: &quot;KB&quot;,</span>
<a href="#l14.2487"></a><span id="l14.2487">     megaUnit: &quot;MB&quot;,</span>
<a href="#l14.2488"></a><span id="l14.2488"> </span>
<a href="#l14.2489"></a><span id="l14.2489" class="difflineminus">-    init: function() {</span>
<a href="#l14.2490"></a><span id="l14.2490" class="difflineplus">+    init() {</span>
<a href="#l14.2491"></a><span id="l14.2491">       // We cache these values because the cells in the folder pane columns</span>
<a href="#l14.2492"></a><span id="l14.2492">       // using these helpers can be redrawn often.</span>
<a href="#l14.2493"></a><span id="l14.2493">       this.sumSubfoldersPref = Services.prefs.getBoolPref(&quot;mail.folderpane.sumSubfolders&quot;);</span>
<a href="#l14.2494"></a><span id="l14.2494">       this.sizeUnits = Services.prefs.getCharPref(&quot;mail.folderpane.sizeUnits&quot;);</span>
<a href="#l14.2495"></a><span id="l14.2495">       this.kiloUnit = gFolderTreeView.messengerBundle.getString(&quot;kiloByteAbbreviation2&quot;);</span>
<a href="#l14.2496"></a><span id="l14.2496">       this.megaUnit = gFolderTreeView.messengerBundle.getString(&quot;megaByteAbbreviation2&quot;);</span>
<a href="#l14.2497"></a><span id="l14.2497">     },</span>
<a href="#l14.2498"></a><span id="l14.2498"> </span>
<a href="#l14.2499"></a><span id="l14.2499" class="difflineat">@@ -2932,17 +2910,17 @@ var gFolderStatsHelpers = {</span>
<a href="#l14.2500"></a><span id="l14.2500">      * folders when they are shown expanded (due to rounding to a unit).</span>
<a href="#l14.2501"></a><span id="l14.2501">      * E.g. folder1 600bytes -&gt; 1KB, folder2 700bytes -&gt; 1KB</span>
<a href="#l14.2502"></a><span id="l14.2502">      * summarized at parent folder: 1300bytes -&gt; 1KB</span>
<a href="#l14.2503"></a><span id="l14.2503">      *</span>
<a href="#l14.2504"></a><span id="l14.2504">      * @param aValue                  The value to be displayed.</span>
<a href="#l14.2505"></a><span id="l14.2505">      * @param aSubfoldersContributed  Boolean indicating whether subfolders</span>
<a href="#l14.2506"></a><span id="l14.2506">      *                                contributed to the accumulated total value.</span>
<a href="#l14.2507"></a><span id="l14.2507">      */</span>
<a href="#l14.2508"></a><span id="l14.2508" class="difflineminus">-    addSummarizedPrefix: function(aValue, aSubfoldersContributed) {</span>
<a href="#l14.2509"></a><span id="l14.2509" class="difflineplus">+    addSummarizedPrefix(aValue, aSubfoldersContributed) {</span>
<a href="#l14.2510"></a><span id="l14.2510">       if (!this.sumSubfolders)</span>
<a href="#l14.2511"></a><span id="l14.2511">         return aValue;</span>
<a href="#l14.2512"></a><span id="l14.2512"> </span>
<a href="#l14.2513"></a><span id="l14.2513">       if (!aSubfoldersContributed)</span>
<a href="#l14.2514"></a><span id="l14.2514">         return aValue;</span>
<a href="#l14.2515"></a><span id="l14.2515"> </span>
<a href="#l14.2516"></a><span id="l14.2516">       return gFolderTreeView.messengerBundle</span>
<a href="#l14.2517"></a><span id="l14.2517">         .getFormattedString(&quot;folderSummarizedSymbolValue&quot;, [aValue]);</span>
<a href="#l14.2518"></a><span id="l14.2518" class="difflineat">@@ -2952,47 +2930,47 @@ var gFolderStatsHelpers = {</span>
<a href="#l14.2519"></a><span id="l14.2519">      * nsIMsgFolder uses -1 as a magic number to mean &quot;I don't know&quot;. In those</span>
<a href="#l14.2520"></a><span id="l14.2520">      * cases we indicate it to the user. The user has to open the folder</span>
<a href="#l14.2521"></a><span id="l14.2521">      * so that the property is initialized from the DB.</span>
<a href="#l14.2522"></a><span id="l14.2522">      *</span>
<a href="#l14.2523"></a><span id="l14.2523">      * @param aNumber                 The number to translate for the user.</span>
<a href="#l14.2524"></a><span id="l14.2524">      * @param aSubfoldersContributed  Boolean indicating whether subfolders</span>
<a href="#l14.2525"></a><span id="l14.2525">      *                                contributed to the accumulated total value.</span>
<a href="#l14.2526"></a><span id="l14.2526">      */</span>
<a href="#l14.2527"></a><span id="l14.2527" class="difflineminus">-    fixNum: function(aNumber, aSubfoldersContributed) {</span>
<a href="#l14.2528"></a><span id="l14.2528" class="difflineplus">+    fixNum(aNumber, aSubfoldersContributed) {</span>
<a href="#l14.2529"></a><span id="l14.2529">       if (aNumber &lt; 0)</span>
<a href="#l14.2530"></a><span id="l14.2530">         return this.kUnknownSize;</span>
<a href="#l14.2531"></a><span id="l14.2531"> </span>
<a href="#l14.2532"></a><span id="l14.2532">       return (aNumber == 0 ? &quot;&quot; : this.addSummarizedPrefix(aNumber,</span>
<a href="#l14.2533"></a><span id="l14.2533">                                                            aSubfoldersContributed));</span>
<a href="#l14.2534"></a><span id="l14.2534">     },</span>
<a href="#l14.2535"></a><span id="l14.2535"> </span>
<a href="#l14.2536"></a><span id="l14.2536">     /**</span>
<a href="#l14.2537"></a><span id="l14.2537">      * Get the size of the specified folder.</span>
<a href="#l14.2538"></a><span id="l14.2538">      *</span>
<a href="#l14.2539"></a><span id="l14.2539">      * @param aFolder  The nsIMsgFolder to analyze.</span>
<a href="#l14.2540"></a><span id="l14.2540">      */</span>
<a href="#l14.2541"></a><span id="l14.2541" class="difflineminus">-    getFolderSize: function(aFolder) {</span>
<a href="#l14.2542"></a><span id="l14.2542" class="difflineplus">+    getFolderSize(aFolder) {</span>
<a href="#l14.2543"></a><span id="l14.2543">       let folderSize = 0;</span>
<a href="#l14.2544"></a><span id="l14.2544">       try {</span>
<a href="#l14.2545"></a><span id="l14.2545">         folderSize = aFolder.sizeOnDisk;</span>
<a href="#l14.2546"></a><span id="l14.2546">         if (folderSize &lt; 0)</span>
<a href="#l14.2547"></a><span id="l14.2547">           return this.kUnknownSize;</span>
<a href="#l14.2548"></a><span id="l14.2548" class="difflineminus">-      } catch(ex) {</span>
<a href="#l14.2549"></a><span id="l14.2549" class="difflineplus">+      } catch (ex) {</span>
<a href="#l14.2550"></a><span id="l14.2550">         return this.kUnknownSize;</span>
<a href="#l14.2551"></a><span id="l14.2551">       }</span>
<a href="#l14.2552"></a><span id="l14.2552">       return folderSize;</span>
<a href="#l14.2553"></a><span id="l14.2553">     },</span>
<a href="#l14.2554"></a><span id="l14.2554"> </span>
<a href="#l14.2555"></a><span id="l14.2555">     /**</span>
<a href="#l14.2556"></a><span id="l14.2556">      * Get the total size of all subfolders of the specified folder.</span>
<a href="#l14.2557"></a><span id="l14.2557">      *</span>
<a href="#l14.2558"></a><span id="l14.2558">      * @param aFolder  The nsIMsgFolder to analyze.</span>
<a href="#l14.2559"></a><span id="l14.2559">      */</span>
<a href="#l14.2560"></a><span id="l14.2560" class="difflineminus">-    getSubfoldersSize: function(aFolder) {</span>
<a href="#l14.2561"></a><span id="l14.2561" class="difflineplus">+    getSubfoldersSize(aFolder) {</span>
<a href="#l14.2562"></a><span id="l14.2562">       let folderSize = 0;</span>
<a href="#l14.2563"></a><span id="l14.2563">       if (aFolder.hasSubFolders) {</span>
<a href="#l14.2564"></a><span id="l14.2564">         let subFolders = aFolder.subFolders;</span>
<a href="#l14.2565"></a><span id="l14.2565">         while (subFolders.hasMoreElements()) {</span>
<a href="#l14.2566"></a><span id="l14.2566">           let subFolder = subFolders.getNext()</span>
<a href="#l14.2567"></a><span id="l14.2567">             .QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l14.2568"></a><span id="l14.2568">           let subSize = this.getFolderSize(subFolder);</span>
<a href="#l14.2569"></a><span id="l14.2569">           let subSubSize = this.getSubfoldersSize(subFolder);</span>
<a href="#l14.2570"></a><span id="l14.2570" class="difflineat">@@ -3009,23 +2987,23 @@ var gFolderStatsHelpers = {</span>
<a href="#l14.2571"></a><span id="l14.2571">      * Format the given folder size into a string with an appropriate unit.</span>
<a href="#l14.2572"></a><span id="l14.2572">      *</span>
<a href="#l14.2573"></a><span id="l14.2573">      * @param aSize  The size in bytes to format.</span>
<a href="#l14.2574"></a><span id="l14.2574">      * @param aUnit  Optional unit to use for the format.</span>
<a href="#l14.2575"></a><span id="l14.2575">      *               Possible values are &quot;KB&quot; or &quot;MB&quot;.</span>
<a href="#l14.2576"></a><span id="l14.2576">      * @return       An array with 2 values. First is the resulting formatted strings.</span>
<a href="#l14.2577"></a><span id="l14.2577">      *               The second one is the final unit used to format the string.</span>
<a href="#l14.2578"></a><span id="l14.2578">      */</span>
<a href="#l14.2579"></a><span id="l14.2579" class="difflineminus">-    formatFolderSize: function(aSize, aUnit = gFolderStatsHelpers.sizeUnits) {</span>
<a href="#l14.2580"></a><span id="l14.2580" class="difflineplus">+    formatFolderSize(aSize, aUnit = gFolderStatsHelpers.sizeUnits) {</span>
<a href="#l14.2581"></a><span id="l14.2581">       let size = Math.round(aSize / 1024);</span>
<a href="#l14.2582"></a><span id="l14.2582">       let unit = gFolderStatsHelpers.kiloUnit;</span>
<a href="#l14.2583"></a><span id="l14.2583">       // If size is non-zero try to show it in a unit that fits in 3 digits,</span>
<a href="#l14.2584"></a><span id="l14.2584">       // but if user specified a fixed unit, use that.</span>
<a href="#l14.2585"></a><span id="l14.2585">       if (aUnit != &quot;KB&quot; &amp;&amp; (size &gt; 999 || aUnit == &quot;MB&quot;)) {</span>
<a href="#l14.2586"></a><span id="l14.2586">         size = Math.round(size / 1024);</span>
<a href="#l14.2587"></a><span id="l14.2587">         unit = gFolderStatsHelpers.megaUnit;</span>
<a href="#l14.2588"></a><span id="l14.2588">         aUnit = &quot;MB&quot;;</span>
<a href="#l14.2589"></a><span id="l14.2589">       }</span>
<a href="#l14.2590"></a><span id="l14.2590">       // This needs to be updated if the &quot;%.*f&quot; placeholder string</span>
<a href="#l14.2591"></a><span id="l14.2591">       // in &quot;*ByteAbbreviation2&quot; in messenger.properties changes.</span>
<a href="#l14.2592"></a><span id="l14.2592" class="difflineminus">-      return [unit.replace(&quot;%.*f&quot;, size).replace(&quot; &quot;,&quot;&quot;), aUnit];</span>
<a href="#l14.2593"></a><span id="l14.2593" class="difflineminus">-    }</span>
<a href="#l14.2594"></a><span id="l14.2594" class="difflineplus">+      return [unit.replace(&quot;%.*f&quot;, size).replace(&quot; &quot;, &quot;&quot;), aUnit];</span>
<a href="#l14.2595"></a><span id="l14.2595" class="difflineplus">+    },</span>
<a href="#l14.2596"></a><span id="l14.2596"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/base/content/foldersummary.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/base/content/foldersummary.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -36,17 +36,17 @@ class MozFolderSummary extends MozXULEle</span>
<a href="#l15.4"></a><span id="l15.4">         (folder.server instanceof Ci.nsINntpIncomingServer)) {</span>
<a href="#l15.5"></a><span id="l15.5">       return false;</span>
<a href="#l15.6"></a><span id="l15.6">     }</span>
<a href="#l15.7"></a><span id="l15.7"> </span>
<a href="#l15.8"></a><span id="l15.8">     let folderArray = [];</span>
<a href="#l15.9"></a><span id="l15.9">     let msgDatabase;</span>
<a href="#l15.10"></a><span id="l15.10">     try {</span>
<a href="#l15.11"></a><span id="l15.11">       msgDatabase = folder.msgDatabase;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-    } catch(e) {</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+    } catch (e) {</span>
<a href="#l15.14"></a><span id="l15.14">       // The database for this folder may be missing (e.g. outdated/missing .msf),</span>
<a href="#l15.15"></a><span id="l15.15">       // so just skip this folder.</span>
<a href="#l15.16"></a><span id="l15.16">       return false;</span>
<a href="#l15.17"></a><span id="l15.17">     }</span>
<a href="#l15.18"></a><span id="l15.18"> </span>
<a href="#l15.19"></a><span id="l15.19">     if (folder.flags &amp; Ci.nsMsgFolderFlags.Virtual) {</span>
<a href="#l15.20"></a><span id="l15.20">       let srchFolderUri = msgDatabase.dBFolderInfo.getCharProperty(&quot;searchFolderUri&quot;);</span>
<a href="#l15.21"></a><span id="l15.21">       let folderUris = srchFolderUri.split(&quot;|&quot;);</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineat">@@ -61,17 +61,17 @@ class MozFolderSummary extends MozXULEle</span>
<a href="#l15.23"></a><span id="l15.23">       folderArray.push(folder);</span>
<a href="#l15.24"></a><span id="l15.24">     }</span>
<a href="#l15.25"></a><span id="l15.25"> </span>
<a href="#l15.26"></a><span id="l15.26">     let foundNewMsg = false;</span>
<a href="#l15.27"></a><span id="l15.27">     for (let folder of folderArray) {</span>
<a href="#l15.28"></a><span id="l15.28">       // now get the database</span>
<a href="#l15.29"></a><span id="l15.29">       try {</span>
<a href="#l15.30"></a><span id="l15.30">         msgDatabase = folder.msgDatabase;</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-      } catch(e) {</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+      } catch (e) {</span>
<a href="#l15.33"></a><span id="l15.33">         // The database for this folder may be missing (e.g. outdated/missing .msf),</span>
<a href="#l15.34"></a><span id="l15.34">         // then just skip this folder.</span>
<a href="#l15.35"></a><span id="l15.35">         continue;</span>
<a href="#l15.36"></a><span id="l15.36">       }</span>
<a href="#l15.37"></a><span id="l15.37"> </span>
<a href="#l15.38"></a><span id="l15.38">       folder.msgDatabase = null;</span>
<a href="#l15.39"></a><span id="l15.39">       let msgKeys = {};</span>
<a href="#l15.40"></a><span id="l15.40">       let numMsgKeys = {};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mail/base/content/glodaFacetBindings.xml</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mail/base/content/glodaFacetBindings.xml</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -29,17 +29,17 @@</span>
<a href="#l16.4"></a><span id="l16.4"> </span>
<a href="#l16.5"></a><span id="l16.5">         let dis = this;</span>
<a href="#l16.6"></a><span id="l16.6">         let spanify = function(aText, aClass) {</span>
<a href="#l16.7"></a><span id="l16.7">           let span = document.createElement(&quot;span&quot;);</span>
<a href="#l16.8"></a><span id="l16.8">           span.setAttribute(&quot;class&quot;, aClass);</span>
<a href="#l16.9"></a><span id="l16.9">           span.textContent = aText;</span>
<a href="#l16.10"></a><span id="l16.10">           dis.appendChild(span);</span>
<a href="#l16.11"></a><span id="l16.11">           return span;</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-        }</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+        };</span>
<a href="#l16.14"></a><span id="l16.14"> </span>
<a href="#l16.15"></a><span id="l16.15">         let searchLabel = glodaFacetStrings.get(</span>
<a href="#l16.16"></a><span id="l16.16">           &quot;glodaFacetView.search.label&quot;);</span>
<a href="#l16.17"></a><span id="l16.17">         spanify(searchLabel, &quot;explanation-fulltext-label&quot;);</span>
<a href="#l16.18"></a><span id="l16.18"> </span>
<a href="#l16.19"></a><span id="l16.19">         let criteriaText = glodaFacetStrings.get(</span>
<a href="#l16.20"></a><span id="l16.20">           &quot;glodaFacetView.constraints.query.fulltext.&quot; +</span>
<a href="#l16.21"></a><span id="l16.21">           (aMsgSearcher.andTerms ? &quot;and&quot; : &quot;or&quot;) + &quot;JoinWord&quot;);</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineat">@@ -59,43 +59,43 @@</span>
<a href="#l16.23"></a><span id="l16.23"> </span>
<a href="#l16.24"></a><span id="l16.24">         let dis = this;</span>
<a href="#l16.25"></a><span id="l16.25">         let spanify = function(aText, aClass) {</span>
<a href="#l16.26"></a><span id="l16.26">           let span = document.createElement(&quot;span&quot;);</span>
<a href="#l16.27"></a><span id="l16.27">           span.setAttribute(&quot;class&quot;, aClass);</span>
<a href="#l16.28"></a><span id="l16.28">           span.textContent = aText;</span>
<a href="#l16.29"></a><span id="l16.29">           dis.appendChild(span);</span>
<a href="#l16.30"></a><span id="l16.30">           return span;</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-        }</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+        };</span>
<a href="#l16.33"></a><span id="l16.33"> </span>
<a href="#l16.34"></a><span id="l16.34">         let label = glodaFacetStrings.get(</span>
<a href="#l16.35"></a><span id="l16.35">           &quot;glodaFacetView.search.label&quot;);</span>
<a href="#l16.36"></a><span id="l16.36">         spanify(label, &quot;explanation-query-label&quot;);</span>
<a href="#l16.37"></a><span id="l16.37"> </span>
<a href="#l16.38"></a><span id="l16.38">         let constraintStrings = [];</span>
<a href="#l16.39"></a><span id="l16.39">         for (let constraint of aMsgQuery._constraints) {</span>
<a href="#l16.40"></a><span id="l16.40">           if (constraint[0] != 1) return; // no idea what this is about</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineminus">-          if (constraint[1].attributeName == 'involves') {</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+          if (constraint[1].attributeName == &quot;involves&quot;) {</span>
<a href="#l16.43"></a><span id="l16.43">             let involvesLabel = glodaFacetStrings.get(</span>
<a href="#l16.44"></a><span id="l16.44">               &quot;glodaFacetView.constraints.query.involves.label&quot;);</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineminus">-            involvesLabel = involvesLabel.replace(&quot;#1&quot;, constraint[2].value)</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineplus">+            involvesLabel = involvesLabel.replace(&quot;#1&quot;, constraint[2].value);</span>
<a href="#l16.47"></a><span id="l16.47">             spanify(involvesLabel, &quot;explanation-query-involves&quot;);</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineminus">-          } else if (constraint[1].attributeName == 'tag') {</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineplus">+          } else if (constraint[1].attributeName == &quot;tag&quot;) {</span>
<a href="#l16.50"></a><span id="l16.50">             let tagLabel = glodaFacetStrings.get(</span>
<a href="#l16.51"></a><span id="l16.51">               &quot;glodaFacetView.constraints.query.tagged.label&quot;);</span>
<a href="#l16.52"></a><span id="l16.52">             let tag = constraint[2];</span>
<a href="#l16.53"></a><span id="l16.53">             let tagNode = document.createElement(&quot;span&quot;);</span>
<a href="#l16.54"></a><span id="l16.54">             let colorClass = &quot;blc-&quot; + MailServices.tags.getColorForKey(tag.key).substr(1);</span>
<a href="#l16.55"></a><span id="l16.55">             tagNode.setAttribute(&quot;class&quot;, &quot;message-tag tag &quot; + colorClass);</span>
<a href="#l16.56"></a><span id="l16.56">             tagNode.textContent = tag.tag;</span>
<a href="#l16.57"></a><span id="l16.57">             spanify(tagLabel, &quot;explanation-query-tagged&quot;);</span>
<a href="#l16.58"></a><span id="l16.58">             this.appendChild(tagNode);</span>
<a href="#l16.59"></a><span id="l16.59">           }</span>
<a href="#l16.60"></a><span id="l16.60">         }</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineminus">-        label = label + constraintStrings.join(', '); // XXX l10n?</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineplus">+        label = label + constraintStrings.join(&quot;, &quot;); // XXX l10n?</span>
<a href="#l16.63"></a><span id="l16.63">       } catch (e) {</span>
<a href="#l16.64"></a><span id="l16.64">         logException(e);</span>
<a href="#l16.65"></a><span id="l16.65">       }</span>
<a href="#l16.66"></a><span id="l16.66">       ]]&gt;&lt;/body&gt;</span>
<a href="#l16.67"></a><span id="l16.67">     &lt;/method&gt;</span>
<a href="#l16.68"></a><span id="l16.68">   &lt;/implementation&gt;</span>
<a href="#l16.69"></a><span id="l16.69"> &lt;/binding&gt;</span>
<a href="#l16.70"></a><span id="l16.70"> </span>
<a href="#l16.71"></a><span id="l16.71" class="difflineat">@@ -174,17 +174,17 @@</span>
<a href="#l16.72"></a><span id="l16.72">       this.checkbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;,</span>
<a href="#l16.73"></a><span id="l16.73">                                                               &quot;checkbox&quot;);</span>
<a href="#l16.74"></a><span id="l16.74">       this.labelNode = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;,</span>
<a href="#l16.75"></a><span id="l16.75">                                                                &quot;label&quot;);</span>
<a href="#l16.76"></a><span id="l16.76">       this.countNode = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;,</span>
<a href="#l16.77"></a><span id="l16.77">                                                                &quot;count&quot;);</span>
<a href="#l16.78"></a><span id="l16.78"> </span>
<a href="#l16.79"></a><span id="l16.79">       let dis = this;</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineminus">-      this.bubble.addEventListener(&quot;click&quot;, function (event) {</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineplus">+      this.bubble.addEventListener(&quot;click&quot;, function(event) {</span>
<a href="#l16.82"></a><span id="l16.82">         return dis.bubbleClicked(event);</span>
<a href="#l16.83"></a><span id="l16.83">       }, true);</span>
<a href="#l16.84"></a><span id="l16.84"> </span>
<a href="#l16.85"></a><span id="l16.85">       this.extraSetup();</span>
<a href="#l16.86"></a><span id="l16.86"> </span>
<a href="#l16.87"></a><span id="l16.87">       if (&quot;faceter&quot; in this)</span>
<a href="#l16.88"></a><span id="l16.88">         this.build(true);</span>
<a href="#l16.89"></a><span id="l16.89">     ]]&gt;&lt;/constructor&gt;</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineat">@@ -192,18 +192,17 @@</span>
<a href="#l16.91"></a><span id="l16.91">     &lt;property name=&quot;disabled&quot;&gt;</span>
<a href="#l16.92"></a><span id="l16.92">       &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l16.93"></a><span id="l16.93">         return this.getAttribute(&quot;disabled&quot;) == &quot;true&quot;;</span>
<a href="#l16.94"></a><span id="l16.94">       ]]&gt;&lt;/getter&gt;</span>
<a href="#l16.95"></a><span id="l16.95">       &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l16.96"></a><span id="l16.96">         if (val) {</span>
<a href="#l16.97"></a><span id="l16.97">           this.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l16.98"></a><span id="l16.98">           this.checkbox.setAttribute(&quot;disabled&quot;, true);</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineminus">-        }</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineminus">-        else {</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineplus">+        } else {</span>
<a href="#l16.102"></a><span id="l16.102">           this.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l16.103"></a><span id="l16.103">           this.checkbox.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l16.104"></a><span id="l16.104">         }</span>
<a href="#l16.105"></a><span id="l16.105">       ]]&gt;&lt;/setter&gt;</span>
<a href="#l16.106"></a><span id="l16.106">     &lt;/property&gt;</span>
<a href="#l16.107"></a><span id="l16.107">     &lt;property name=&quot;checked&quot;&gt;</span>
<a href="#l16.108"></a><span id="l16.108">       &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l16.109"></a><span id="l16.109">         return this.getAttribute(&quot;checked&quot;) == &quot;true&quot;;</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineat">@@ -216,18 +215,17 @@</span>
<a href="#l16.111"></a><span id="l16.111">           // the XBL inherits magic appears to fail if we explicitly check the</span>
<a href="#l16.112"></a><span id="l16.112">           //  box itself rather than via our click handler, presumably because</span>
<a href="#l16.113"></a><span id="l16.113">           //  we unshadow something.  So manually apply changes ourselves.</span>
<a href="#l16.114"></a><span id="l16.114">           this.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l16.115"></a><span id="l16.115">           this.checkbox.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l16.116"></a><span id="l16.116">           if (!this.disabled)</span>
<a href="#l16.117"></a><span id="l16.117">             FacetContext.addFacetConstraint(this.faceter, true,</span>
<a href="#l16.118"></a><span id="l16.118">                                             this.trueGroups);</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineminus">-        }</span>
<a href="#l16.120"></a><span id="l16.120" class="difflineminus">-        else {</span>
<a href="#l16.121"></a><span id="l16.121" class="difflineplus">+        } else {</span>
<a href="#l16.122"></a><span id="l16.122">           this.removeAttribute(&quot;checked&quot;);</span>
<a href="#l16.123"></a><span id="l16.123">           this.checkbox.removeAttribute(&quot;checked&quot;);</span>
<a href="#l16.124"></a><span id="l16.124">           if (!this.disabled)</span>
<a href="#l16.125"></a><span id="l16.125">             FacetContext.removeFacetConstraint(this.faceter, true,</span>
<a href="#l16.126"></a><span id="l16.126">                                                this.trueGroups);</span>
<a href="#l16.127"></a><span id="l16.127">         }</span>
<a href="#l16.128"></a><span id="l16.128">         this.checkStateChanged();</span>
<a href="#l16.129"></a><span id="l16.129">       ]]&gt;&lt;/setter&gt;</span>
<a href="#l16.130"></a><span id="l16.130" class="difflineat">@@ -248,26 +246,25 @@</span>
<a href="#l16.131"></a><span id="l16.131">           this.checkbox.setAttribute(&quot;aria-label&quot;,</span>
<a href="#l16.132"></a><span id="l16.132">                                      this.facetDef.strings.facetNameLabel);</span>
<a href="#l16.133"></a><span id="l16.133">           this.trueValues = [];</span>
<a href="#l16.134"></a><span id="l16.134">         }</span>
<a href="#l16.135"></a><span id="l16.135"> </span>
<a href="#l16.136"></a><span id="l16.136">         // If we do not currently have a constraint applied and there is only</span>
<a href="#l16.137"></a><span id="l16.137">         //  one (or no) group, then: disable us, but reflect the underlying</span>
<a href="#l16.138"></a><span id="l16.138">         //  state of the data (checked or non-checked)</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineminus">-        if (!this.faceter.constraint &amp;&amp; (this.orderedGroups.length &lt;= 1)){</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineplus">+        if (!this.faceter.constraint &amp;&amp; (this.orderedGroups.length &lt;= 1)) {</span>
<a href="#l16.141"></a><span id="l16.141">           this.disabled = true;</span>
<a href="#l16.142"></a><span id="l16.142">           let count = 0;</span>
<a href="#l16.143"></a><span id="l16.143">           if (this.orderedGroups.length) {</span>
<a href="#l16.144"></a><span id="l16.144">             // true case?</span>
<a href="#l16.145"></a><span id="l16.145">             if (this.orderedGroups[0][0]) {</span>
<a href="#l16.146"></a><span id="l16.146">               count = this.orderedGroups[0][1].length;</span>
<a href="#l16.147"></a><span id="l16.147">               this.checked = true;</span>
<a href="#l16.148"></a><span id="l16.148" class="difflineminus">-            }</span>
<a href="#l16.149"></a><span id="l16.149" class="difflineminus">-            else {</span>
<a href="#l16.150"></a><span id="l16.150" class="difflineplus">+            } else {</span>
<a href="#l16.151"></a><span id="l16.151">               this.checked = false;</span>
<a href="#l16.152"></a><span id="l16.152">             }</span>
<a href="#l16.153"></a><span id="l16.153">           }</span>
<a href="#l16.154"></a><span id="l16.154">           this.countNode.textContent = count.toLocaleString();</span>
<a href="#l16.155"></a><span id="l16.155">           return;</span>
<a href="#l16.156"></a><span id="l16.156">         }</span>
<a href="#l16.157"></a><span id="l16.157">         // if we were disabled checked before, clear ourselves out</span>
<a href="#l16.158"></a><span id="l16.158">         if (this.disabled &amp;&amp; this.checked)</span>
<a href="#l16.159"></a><span id="l16.159" class="difflineat">@@ -275,17 +272,17 @@</span>
<a href="#l16.160"></a><span id="l16.160">         this.disabled = false;</span>
<a href="#l16.161"></a><span id="l16.161"> </span>
<a href="#l16.162"></a><span id="l16.162">         // if we are here, we have our 2 groups, find true...</span>
<a href="#l16.163"></a><span id="l16.163">         // (note: it is possible to get jerked around by null values</span>
<a href="#l16.164"></a><span id="l16.164">         //  currently, so leave a reasonable failure case)</span>
<a href="#l16.165"></a><span id="l16.165">         this.trueValues = [];</span>
<a href="#l16.166"></a><span id="l16.166">         this.trueGroups = [true];</span>
<a href="#l16.167"></a><span id="l16.167">         for (let groupPair of this.orderedGroups) {</span>
<a href="#l16.168"></a><span id="l16.168" class="difflineminus">-          if (groupPair[0] == true)</span>
<a href="#l16.169"></a><span id="l16.169" class="difflineplus">+          if (groupPair[0])</span>
<a href="#l16.170"></a><span id="l16.170">             this.trueValues = groupPair[1];</span>
<a href="#l16.171"></a><span id="l16.171">         }</span>
<a href="#l16.172"></a><span id="l16.172"> </span>
<a href="#l16.173"></a><span id="l16.173">         this.countNode.textContent = this.trueValues.length.toLocaleString();</span>
<a href="#l16.174"></a><span id="l16.174">       ]]&gt;&lt;/body&gt;</span>
<a href="#l16.175"></a><span id="l16.175">     &lt;/method&gt;</span>
<a href="#l16.176"></a><span id="l16.176">     &lt;method name=&quot;bubbleClicked&quot;&gt;</span>
<a href="#l16.177"></a><span id="l16.177">       &lt;parameter name=&quot;event&quot; /&gt;</span>
<a href="#l16.178"></a><span id="l16.178" class="difflineat">@@ -384,19 +381,19 @@</span>
<a href="#l16.179"></a><span id="l16.179">         this.trueGroups = [];</span>
<a href="#l16.180"></a><span id="l16.180">         // the real true groups is the actual true values for our explicit</span>
<a href="#l16.181"></a><span id="l16.181">         //  filtering</span>
<a href="#l16.182"></a><span id="l16.182">         this.realTrueGroups = [];</span>
<a href="#l16.183"></a><span id="l16.183">         this.trueValues = [];</span>
<a href="#l16.184"></a><span id="l16.184">         this.falseValues = [];</span>
<a href="#l16.185"></a><span id="l16.185">         let selectNodes = [];</span>
<a href="#l16.186"></a><span id="l16.186">         for (let groupPair of this.orderedGroups) {</span>
<a href="#l16.187"></a><span id="l16.187" class="difflineminus">-          if (groupPair[0] == null)</span>
<a href="#l16.188"></a><span id="l16.188" class="difflineplus">+          if (groupPair[0] === null) {</span>
<a href="#l16.189"></a><span id="l16.189">             this.falseValues.push.apply(this.falseValues, groupPair[1]);</span>
<a href="#l16.190"></a><span id="l16.190" class="difflineminus">-          else {</span>
<a href="#l16.191"></a><span id="l16.191" class="difflineplus">+          } else {</span>
<a href="#l16.192"></a><span id="l16.192">             this.trueValues.push.apply(this.trueValues, groupPair[1]);</span>
<a href="#l16.193"></a><span id="l16.193"> </span>
<a href="#l16.194"></a><span id="l16.194">             let groupValue = groupPair[0];</span>
<a href="#l16.195"></a><span id="l16.195">             let selNode = document.createElement(&quot;option&quot;);</span>
<a href="#l16.196"></a><span id="l16.196">             selNode.textContent = groupValue[this.groupDisplayProperty];</span>
<a href="#l16.197"></a><span id="l16.197">             selNode.setAttribute(&quot;value&quot;, this.realTrueGroups.length);</span>
<a href="#l16.198"></a><span id="l16.198">             if (this.selectedValue == groupValue.category)</span>
<a href="#l16.199"></a><span id="l16.199">               selNode.setAttribute(&quot;selected&quot;, &quot;selected&quot;);</span>
<a href="#l16.200"></a><span id="l16.200" class="difflineat">@@ -426,18 +423,17 @@</span>
<a href="#l16.201"></a><span id="l16.201">       &lt;parameter name=&quot;event&quot; /&gt;</span>
<a href="#l16.202"></a><span id="l16.202">       &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.203"></a><span id="l16.203">         if (!this.checked)</span>
<a href="#l16.204"></a><span id="l16.204">           return;</span>
<a href="#l16.205"></a><span id="l16.205">         if (this.filterNode.value == &quot;all&quot;) {</span>
<a href="#l16.206"></a><span id="l16.206">           this.selectedValue = &quot;all&quot;;</span>
<a href="#l16.207"></a><span id="l16.207">           FacetContext.addFacetConstraint(this.faceter, true,</span>
<a href="#l16.208"></a><span id="l16.208">                                           this.trueGroups, false, true);</span>
<a href="#l16.209"></a><span id="l16.209" class="difflineminus">-        }</span>
<a href="#l16.210"></a><span id="l16.210" class="difflineminus">-        else {</span>
<a href="#l16.211"></a><span id="l16.211" class="difflineplus">+        } else {</span>
<a href="#l16.212"></a><span id="l16.212">           let groupValue = this.realTrueGroups[parseInt(this.filterNode.value)];</span>
<a href="#l16.213"></a><span id="l16.213">           this.selectedValue = groupValue.category;</span>
<a href="#l16.214"></a><span id="l16.214">           FacetContext.addFacetConstraint(this.faceter, true,</span>
<a href="#l16.215"></a><span id="l16.215">                                           [groupValue], false, true);</span>
<a href="#l16.216"></a><span id="l16.216">         }</span>
<a href="#l16.217"></a><span id="l16.217">       ]]&gt;&lt;/body&gt;</span>
<a href="#l16.218"></a><span id="l16.218">     &lt;/method&gt;</span>
<a href="#l16.219"></a><span id="l16.219">   &lt;/implementation&gt;</span>
<a href="#l16.220"></a><span id="l16.220" class="difflineat">@@ -486,26 +482,25 @@</span>
<a href="#l16.221"></a><span id="l16.221">                                                      &quot;undo-item&quot;);</span>
<a href="#l16.222"></a><span id="l16.222">     ]]&gt;&lt;/constructor&gt;</span>
<a href="#l16.223"></a><span id="l16.223">     &lt;method name=&quot;_getLabel&quot;&gt;</span>
<a href="#l16.224"></a><span id="l16.224">       &lt;parameter name=&quot;facetDef&quot;/&gt;</span>
<a href="#l16.225"></a><span id="l16.225">       &lt;parameter name=&quot;facetValue&quot;/&gt;</span>
<a href="#l16.226"></a><span id="l16.226">       &lt;parameter name=&quot;groupValue&quot;/&gt;</span>
<a href="#l16.227"></a><span id="l16.227">       &lt;parameter name=&quot;stringName&quot;/&gt;</span>
<a href="#l16.228"></a><span id="l16.228">       &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.229"></a><span id="l16.229" class="difflineminus">-        let label, labelFormat;</span>
<a href="#l16.230"></a><span id="l16.230" class="difflineplus">+        let labelFormat;</span>
<a href="#l16.231"></a><span id="l16.231">         if (stringName in facetDef.strings)</span>
<a href="#l16.232"></a><span id="l16.232">           labelFormat = facetDef.strings[stringName];</span>
<a href="#l16.233"></a><span id="l16.233">         else</span>
<a href="#l16.234"></a><span id="l16.234">           labelFormat = glodaFacetStrings.get(</span>
<a href="#l16.235"></a><span id="l16.235" class="difflineminus">-              &quot;glodaFacetView.facets.&quot;+stringName+&quot;.fallbackLabel&quot;);</span>
<a href="#l16.236"></a><span id="l16.236" class="difflineplus">+              `glodaFacetView.facets.${stringName}.fallbackLabel`);</span>
<a href="#l16.237"></a><span id="l16.237">         if (!labelFormat.includes(&quot;#1&quot;))</span>
<a href="#l16.238"></a><span id="l16.238">           return labelFormat;</span>
<a href="#l16.239"></a><span id="l16.239" class="difflineminus">-        else</span>
<a href="#l16.240"></a><span id="l16.240" class="difflineminus">-          return labelFormat.replace(&quot;#1&quot;, facetValue);</span>
<a href="#l16.241"></a><span id="l16.241" class="difflineplus">+        return labelFormat.replace(&quot;#1&quot;, facetValue);</span>
<a href="#l16.242"></a><span id="l16.242">       ]]&gt;&lt;/body&gt;</span>
<a href="#l16.243"></a><span id="l16.243">     &lt;/method&gt;</span>
<a href="#l16.244"></a><span id="l16.244">     &lt;method name=&quot;build&quot;&gt;</span>
<a href="#l16.245"></a><span id="l16.245">       &lt;parameter name=&quot;facetDef&quot;/&gt;</span>
<a href="#l16.246"></a><span id="l16.246">       &lt;parameter name=&quot;facetValue&quot;/&gt;</span>
<a href="#l16.247"></a><span id="l16.247">       &lt;parameter name=&quot;groupValue&quot;/&gt;</span>
<a href="#l16.248"></a><span id="l16.248">       &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.249"></a><span id="l16.249">       try {</span>
<a href="#l16.250"></a><span id="l16.250" class="difflineat">@@ -533,18 +528,16 @@</span>
<a href="#l16.251"></a><span id="l16.251">       ]]&gt;</span>
<a href="#l16.252"></a><span id="l16.252">       &lt;/body&gt;</span>
<a href="#l16.253"></a><span id="l16.253">     &lt;/method&gt;</span>
<a href="#l16.254"></a><span id="l16.254">     &lt;method name=&quot;moveFocus&quot;&gt;</span>
<a href="#l16.255"></a><span id="l16.255">       &lt;parameter name=&quot;event&quot;/&gt;</span>
<a href="#l16.256"></a><span id="l16.256">       &lt;parameter name=&quot;delta&quot;/&gt;</span>
<a href="#l16.257"></a><span id="l16.257">       &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.258"></a><span id="l16.258">       try {</span>
<a href="#l16.259"></a><span id="l16.259" class="difflineminus">-        let parent = document.getAnonymousElementByAttribute(this,</span>
<a href="#l16.260"></a><span id="l16.260" class="difflineminus">-          &quot;anonid&quot;, &quot;parent&quot;);</span>
<a href="#l16.261"></a><span id="l16.261">         // We probably want something quite generic in the long term, but that</span>
<a href="#l16.262"></a><span id="l16.262">         // is way too much for now (needs to skip over invisible items, etc)</span>
<a href="#l16.263"></a><span id="l16.263">         let focused = document.activeElement;</span>
<a href="#l16.264"></a><span id="l16.264">         if (focused == this.includeNode)</span>
<a href="#l16.265"></a><span id="l16.265">           this.excludeNode.focus();</span>
<a href="#l16.266"></a><span id="l16.266">         else if (focused == this.excludeNode)</span>
<a href="#l16.267"></a><span id="l16.267">           this.includeNode.focus();</span>
<a href="#l16.268"></a><span id="l16.268">         event.preventDefault();</span>
<a href="#l16.269"></a><span id="l16.269" class="difflineat">@@ -581,17 +574,17 @@</span>
<a href="#l16.270"></a><span id="l16.270">           this.node = barNode;</span>
<a href="#l16.271"></a><span id="l16.271">           this.facetNode = facetNode;</span>
<a href="#l16.272"></a><span id="l16.272">           let facetDef = facetNode.facetDef;</span>
<a href="#l16.273"></a><span id="l16.273">           let groupValue = barNode.groupValue;</span>
<a href="#l16.274"></a><span id="l16.274">           let variety = barNode.getAttribute(&quot;variety&quot;);</span>
<a href="#l16.275"></a><span id="l16.275">           let label = barNode.querySelector(&quot;.bar-link&quot;).textContent;</span>
<a href="#l16.276"></a><span id="l16.276">           this.build(facetDef, label, groupValue);</span>
<a href="#l16.277"></a><span id="l16.277">           this.node.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l16.278"></a><span id="l16.278" class="difflineminus">-          var rtl = window.getComputedStyle(this, null).direction == &quot;rtl&quot;;</span>
<a href="#l16.279"></a><span id="l16.279" class="difflineplus">+          var rtl = window.getComputedStyle(this).direction == &quot;rtl&quot;;</span>
<a href="#l16.280"></a><span id="l16.280">           /* We show different menus if we're on an &quot;unselected&quot; facet value,</span>
<a href="#l16.281"></a><span id="l16.281">              or if we're on a preselected facet value, whether included or</span>
<a href="#l16.282"></a><span id="l16.282">              excluded. The variety attribute handles that through CSS */</span>
<a href="#l16.283"></a><span id="l16.283">           this.setAttribute(&quot;variety&quot;, variety);</span>
<a href="#l16.284"></a><span id="l16.284">           let rect = barNode.getBoundingClientRect();</span>
<a href="#l16.285"></a><span id="l16.285">           let X, Y;</span>
<a href="#l16.286"></a><span id="l16.286">           if (event.type == &quot;click&quot;) {</span>
<a href="#l16.287"></a><span id="l16.287">             // center the menu on the mouse click</span>
<a href="#l16.288"></a><span id="l16.288" class="difflineat">@@ -757,18 +750,17 @@</span>
<a href="#l16.289"></a><span id="l16.289">                             this, &quot;anonid&quot;, &quot;content-box&quot;);</span>
<a href="#l16.290"></a><span id="l16.290"> </span>
<a href="#l16.291"></a><span id="l16.291"> </span>
<a href="#l16.292"></a><span id="l16.292">         // -- House-cleaning</span>
<a href="#l16.293"></a><span id="l16.293">         // -- All/Top mode decision</span>
<a href="#l16.294"></a><span id="l16.294">         this.modes = [&quot;all&quot;];</span>
<a href="#l16.295"></a><span id="l16.295">         if (this.maxDisplayRows &gt;= this.orderedGroups.length) {</span>
<a href="#l16.296"></a><span id="l16.296">           this.mode = &quot;all&quot;;</span>
<a href="#l16.297"></a><span id="l16.297" class="difflineminus">-        }</span>
<a href="#l16.298"></a><span id="l16.298" class="difflineminus">-        else {</span>
<a href="#l16.299"></a><span id="l16.299" class="difflineplus">+        } else {</span>
<a href="#l16.300"></a><span id="l16.300">           // top mode must be used</span>
<a href="#l16.301"></a><span id="l16.301">           this.modes.push(&quot;top&quot;);</span>
<a href="#l16.302"></a><span id="l16.302">           this.mode = &quot;top&quot;;</span>
<a href="#l16.303"></a><span id="l16.303">           this.topGroups = FacetUtils.makeTopGroups(this.attrDef,</span>
<a href="#l16.304"></a><span id="l16.304">                                                     this.orderedGroups,</span>
<a href="#l16.305"></a><span id="l16.305">                                                     this.maxDisplayRows);</span>
<a href="#l16.306"></a><span id="l16.306">           // setup the more button string</span>
<a href="#l16.307"></a><span id="l16.307">           let groupCount = this.orderedGroups.length;</span>
<a href="#l16.308"></a><span id="l16.308" class="difflineat">@@ -831,17 +823,17 @@</span>
<a href="#l16.309"></a><span id="l16.309">         //  then re-call for the long name.  We could be smarter by building</span>
<a href="#l16.310"></a><span id="l16.310">         //  a list of the input values that resulted in the output string and</span>
<a href="#l16.311"></a><span id="l16.311">         //  then using that to back-update the id map, but it's more compelx and</span>
<a href="#l16.312"></a><span id="l16.312">         //  the performance difference is unlikely to be meaningful.</span>
<a href="#l16.313"></a><span id="l16.313">         let ambiguousKeyValues;</span>
<a href="#l16.314"></a><span id="l16.314">         if (&quot;userVisibleString&quot; in nounDef) {</span>
<a href="#l16.315"></a><span id="l16.315">           ambiguousKeyValues = {};</span>
<a href="#l16.316"></a><span id="l16.316">           for (let groupPair of useGroups) {</span>
<a href="#l16.317"></a><span id="l16.317" class="difflineminus">-            let [groupValue, groupItems] = groupPair;</span>
<a href="#l16.318"></a><span id="l16.318" class="difflineplus">+            let [groupValue] = groupPair;</span>
<a href="#l16.319"></a><span id="l16.319"> </span>
<a href="#l16.320"></a><span id="l16.320">             // skip null values, they are handled by the none special-case</span>
<a href="#l16.321"></a><span id="l16.321">             if (groupValue == null)</span>
<a href="#l16.322"></a><span id="l16.322">               continue;</span>
<a href="#l16.323"></a><span id="l16.323"> </span>
<a href="#l16.324"></a><span id="l16.324">             let groupStr = nounDef.userVisibleString(groupValue, false);</span>
<a href="#l16.325"></a><span id="l16.325">             // We use hasOwnProperty because it is possible that groupStr could</span>
<a href="#l16.326"></a><span id="l16.326">             //  be the same as the name of one of the attributes on</span>
<a href="#l16.327"></a><span id="l16.327" class="difflineat">@@ -887,51 +879,45 @@</span>
<a href="#l16.328"></a><span id="l16.328">           label.addEventListener(&quot;mouseleave&quot;, function() {</span>
<a href="#l16.329"></a><span id="l16.329">             rootBinding.setAttribute(&quot;title&quot;, &quot;&quot;);</span>
<a href="#l16.330"></a><span id="l16.330">           });</span>
<a href="#l16.331"></a><span id="l16.331"> </span>
<a href="#l16.332"></a><span id="l16.332">           // The null value is a special indicator for 'none'</span>
<a href="#l16.333"></a><span id="l16.333">           if (groupValue == null) {</span>
<a href="#l16.334"></a><span id="l16.334">             label.textContent =</span>
<a href="#l16.335"></a><span id="l16.335">               glodaFacetStrings.get(&quot;glodaFacetView.facets.noneLabel&quot;);</span>
<a href="#l16.336"></a><span id="l16.336" class="difflineminus">-          }</span>
<a href="#l16.337"></a><span id="l16.337" class="difflineminus">-          // Otherwise stringify the group object</span>
<a href="#l16.338"></a><span id="l16.338" class="difflineminus">-          else {</span>
<a href="#l16.339"></a><span id="l16.339" class="difflineplus">+          } else {</span>
<a href="#l16.340"></a><span id="l16.340" class="difflineplus">+            // Otherwise stringify the group object</span>
<a href="#l16.341"></a><span id="l16.341">             let labelStr;</span>
<a href="#l16.342"></a><span id="l16.342">             if (ambiguousKeyValues) {</span>
<a href="#l16.343"></a><span id="l16.343">               labelStr = nounDef.userVisibleString(groupValue, false);</span>
<a href="#l16.344"></a><span id="l16.344">               if (ambiguousKeyValues[labelStr])</span>
<a href="#l16.345"></a><span id="l16.345">                 labelStr = nounDef.userVisibleString(groupValue, true);</span>
<a href="#l16.346"></a><span id="l16.346" class="difflineminus">-            }</span>
<a href="#l16.347"></a><span id="l16.347" class="difflineminus">-            else if (&quot;labelFunc&quot; in this.facetDef) {</span>
<a href="#l16.348"></a><span id="l16.348" class="difflineplus">+            } else if (&quot;labelFunc&quot; in this.facetDef) {</span>
<a href="#l16.349"></a><span id="l16.349">               labelStr = this.facetDef.labelFunc(groupValue);</span>
<a href="#l16.350"></a><span id="l16.350" class="difflineminus">-            }</span>
<a href="#l16.351"></a><span id="l16.351" class="difflineminus">-            else {</span>
<a href="#l16.352"></a><span id="l16.352" class="difflineplus">+            } else {</span>
<a href="#l16.353"></a><span id="l16.353">               labelStr = groupValue.toLocaleString().substring(0, 80);</span>
<a href="#l16.354"></a><span id="l16.354">             }</span>
<a href="#l16.355"></a><span id="l16.355">             label.textContent = labelStr;</span>
<a href="#l16.356"></a><span id="l16.356">           }</span>
<a href="#l16.357"></a><span id="l16.357">           li.appendChild(label);</span>
<a href="#l16.358"></a><span id="l16.358"> </span>
<a href="#l16.359"></a><span id="l16.359">           // root it under the appropriate list</span>
<a href="#l16.360"></a><span id="l16.360">           if (constraint) {</span>
<a href="#l16.361"></a><span id="l16.361">             if (constraint.isIncludedGroup(groupValue)) {</span>
<a href="#l16.362"></a><span id="l16.362">               li.setAttribute(&quot;variety&quot;, &quot;include&quot;);</span>
<a href="#l16.363"></a><span id="l16.363">               includeList.appendChild(li);</span>
<a href="#l16.364"></a><span id="l16.364" class="difflineminus">-            }</span>
<a href="#l16.365"></a><span id="l16.365" class="difflineminus">-            else if (constraint.isExcludedGroup(groupValue)) {</span>
<a href="#l16.366"></a><span id="l16.366" class="difflineplus">+            } else if (constraint.isExcludedGroup(groupValue)) {</span>
<a href="#l16.367"></a><span id="l16.367">               li.setAttribute(&quot;variety&quot;, &quot;exclude&quot;);</span>
<a href="#l16.368"></a><span id="l16.368">               excludeList.appendChild(li);</span>
<a href="#l16.369"></a><span id="l16.369" class="difflineminus">-            }</span>
<a href="#l16.370"></a><span id="l16.370" class="difflineminus">-            else {</span>
<a href="#l16.371"></a><span id="l16.371" class="difflineplus">+            } else {</span>
<a href="#l16.372"></a><span id="l16.372">               li.setAttribute(&quot;variety&quot;, &quot;remainder&quot;);</span>
<a href="#l16.373"></a><span id="l16.373">               remainderList.appendChild(li);</span>
<a href="#l16.374"></a><span id="l16.374">             }</span>
<a href="#l16.375"></a><span id="l16.375" class="difflineminus">-          }</span>
<a href="#l16.376"></a><span id="l16.376" class="difflineminus">-          else {</span>
<a href="#l16.377"></a><span id="l16.377" class="difflineplus">+          } else {</span>
<a href="#l16.378"></a><span id="l16.378">             li.setAttribute(&quot;variety&quot;, &quot;remainder&quot;);</span>
<a href="#l16.379"></a><span id="l16.379">             remainderList.appendChild(li);</span>
<a href="#l16.380"></a><span id="l16.380">           }</span>
<a href="#l16.381"></a><span id="l16.381">         }</span>
<a href="#l16.382"></a><span id="l16.382"> </span>
<a href="#l16.383"></a><span id="l16.383">         this.updateHeaderStates();</span>
<a href="#l16.384"></a><span id="l16.384">       ]]&gt;&lt;/body&gt;</span>
<a href="#l16.385"></a><span id="l16.385">     &lt;/method&gt;</span>
<a href="#l16.386"></a><span id="l16.386" class="difflineat">@@ -1006,19 +992,19 @@</span>
<a href="#l16.387"></a><span id="l16.387">       &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.388"></a><span id="l16.388">         function getRect(aElement) {</span>
<a href="#l16.389"></a><span id="l16.389">           let box = aElement.getBoundingClientRect();</span>
<a href="#l16.390"></a><span id="l16.390">           let documentElement = aElement.ownerDocument.documentElement;</span>
<a href="#l16.391"></a><span id="l16.391">           return {</span>
<a href="#l16.392"></a><span id="l16.392">             top: box.top + window.pageYOffset - documentElement.clientTop,</span>
<a href="#l16.393"></a><span id="l16.393">             left: box.left + window.pageXOffset - documentElement.clientLeft,</span>
<a href="#l16.394"></a><span id="l16.394">             width: box.width,</span>
<a href="#l16.395"></a><span id="l16.395" class="difflineminus">-            height: box.height</span>
<a href="#l16.396"></a><span id="l16.396" class="difflineplus">+            height: box.height,</span>
<a href="#l16.397"></a><span id="l16.397">           };</span>
<a href="#l16.398"></a><span id="l16.398" class="difflineminus">-        };</span>
<a href="#l16.399"></a><span id="l16.399" class="difflineplus">+        }</span>
<a href="#l16.400"></a><span id="l16.400">         // figure out our origin location prior to adding the target or it</span>
<a href="#l16.401"></a><span id="l16.401">         //  will shift us down.</span>
<a href="#l16.402"></a><span id="l16.402">         let origin = getRect(aBarNode);</span>
<a href="#l16.403"></a><span id="l16.403"> </span>
<a href="#l16.404"></a><span id="l16.404">         // clone the node into its target location</span>
<a href="#l16.405"></a><span id="l16.405">         let targetNode = aBarNode.cloneNode(true);</span>
<a href="#l16.406"></a><span id="l16.406">         targetNode.groupValue = aBarNode.groupValue;</span>
<a href="#l16.407"></a><span id="l16.407">         targetNode.groupItems = aBarNode.groupItems;</span>
<a href="#l16.408"></a><span id="l16.408" class="difflineat">@@ -1048,19 +1034,19 @@</span>
<a href="#l16.409"></a><span id="l16.409">         flyingNode.style.top = origin.top + &quot;px&quot;;</span>
<a href="#l16.410"></a><span id="l16.410">         flyingNode.style.left = origin.left + &quot;px&quot;;</span>
<a href="#l16.411"></a><span id="l16.411">         flyingNode.style.zIndex = 1000;</span>
<a href="#l16.412"></a><span id="l16.412"> </span>
<a href="#l16.413"></a><span id="l16.413">         flyingNode.style.transitionDuration = (Math.abs(dest.top - origin.top) * 2) + &quot;ms&quot;;</span>
<a href="#l16.414"></a><span id="l16.414">         flyingNode.style.transitionProperty = &quot;top, left&quot;;</span>
<a href="#l16.415"></a><span id="l16.415"> </span>
<a href="#l16.416"></a><span id="l16.416">         flyingNode.addEventListener(&quot;transitionend&quot;, function() {</span>
<a href="#l16.417"></a><span id="l16.417" class="difflineminus">-          aBarNode.parentNode.removeChild(aBarNode);</span>
<a href="#l16.418"></a><span id="l16.418" class="difflineplus">+          aBarNode.remove();</span>
<a href="#l16.419"></a><span id="l16.419">           targetNode.style.display = &quot;block&quot;;</span>
<a href="#l16.420"></a><span id="l16.420" class="difflineminus">-          flyingNode.parentNode.removeChild(flyingNode);</span>
<a href="#l16.421"></a><span id="l16.421" class="difflineplus">+          flyingNode.remove();</span>
<a href="#l16.422"></a><span id="l16.422"> </span>
<a href="#l16.423"></a><span id="l16.423">           if (aCallback)</span>
<a href="#l16.424"></a><span id="l16.424">             setTimeout(aCallback, 50);</span>
<a href="#l16.425"></a><span id="l16.425">         });</span>
<a href="#l16.426"></a><span id="l16.426"> </span>
<a href="#l16.427"></a><span id="l16.427">         document.body.appendChild(flyingNode);</span>
<a href="#l16.428"></a><span id="l16.428"> </span>
<a href="#l16.429"></a><span id="l16.429">         // animate the flying clone... flying!</span>
<a href="#l16.430"></a><span id="l16.430" class="difflineat">@@ -1078,51 +1064,48 @@</span>
<a href="#l16.431"></a><span id="l16.431">         delete aBarNode.groupItems;</span>
<a href="#l16.432"></a><span id="l16.432">       ]]&gt;&lt;/body&gt;</span>
<a href="#l16.433"></a><span id="l16.433">     &lt;/method&gt;</span>
<a href="#l16.434"></a><span id="l16.434">     &lt;method name=&quot;barClicked&quot;&gt;</span>
<a href="#l16.435"></a><span id="l16.435">       &lt;parameter name=&quot;aBarNode&quot; /&gt;</span>
<a href="#l16.436"></a><span id="l16.436">       &lt;parameter name=&quot;aVariety&quot; /&gt;</span>
<a href="#l16.437"></a><span id="l16.437">       &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.438"></a><span id="l16.438">         let groupValue = aBarNode.groupValue;</span>
<a href="#l16.439"></a><span id="l16.439" class="difflineminus">-        let groupItems = aBarNode.groupItems;</span>
<a href="#l16.440"></a><span id="l16.440">         let dis = this;</span>
<a href="#l16.441"></a><span id="l16.441">         // These determine what goAnimate actually does.</span>
<a href="#l16.442"></a><span id="l16.442">         // flyAway allows us to cancel flying in the case the constraint is</span>
<a href="#l16.443"></a><span id="l16.443">         //  being fully dropped and so the facet is just going to get rebuilt</span>
<a href="#l16.444"></a><span id="l16.444">         let flyAway = true;</span>
<a href="#l16.445"></a><span id="l16.445"> </span>
<a href="#l16.446"></a><span id="l16.446">         function goAnimate() {</span>
<a href="#l16.447"></a><span id="l16.447" class="difflineminus">-          setTimeout(function () {</span>
<a href="#l16.448"></a><span id="l16.448" class="difflineplus">+          setTimeout(function() {</span>
<a href="#l16.449"></a><span id="l16.449">             if (flyAway) {</span>
<a href="#l16.450"></a><span id="l16.450">               dis.afterListVisible(aVariety, function() {</span>
<a href="#l16.451"></a><span id="l16.451">                 dis._flyBarAway(aBarNode, aVariety, function() {</span>
<a href="#l16.452"></a><span id="l16.452">                   dis.updateHeaderStates();</span>
<a href="#l16.453"></a><span id="l16.453">                 });</span>
<a href="#l16.454"></a><span id="l16.454">               });</span>
<a href="#l16.455"></a><span id="l16.455">             }</span>
<a href="#l16.456"></a><span id="l16.456">           }, 0);</span>
<a href="#l16.457"></a><span id="l16.457" class="difflineminus">-        };</span>
<a href="#l16.458"></a><span id="l16.458" class="difflineplus">+        }</span>
<a href="#l16.459"></a><span id="l16.459"> </span>
<a href="#l16.460"></a><span id="l16.460">         // Immediately apply the facet change, triggering the animation after</span>
<a href="#l16.461"></a><span id="l16.461">         //  the faceting completes.</span>
<a href="#l16.462"></a><span id="l16.462">         if (aVariety == &quot;remainder&quot;) {</span>
<a href="#l16.463"></a><span id="l16.463">           let currentVariety = aBarNode.getAttribute(&quot;variety&quot;);</span>
<a href="#l16.464"></a><span id="l16.464">           let constraintGone = FacetContext.removeFacetConstraint(</span>
<a href="#l16.465"></a><span id="l16.465">                                  this.faceter,</span>
<a href="#l16.466"></a><span id="l16.466">                                  currentVariety == &quot;include&quot;,</span>
<a href="#l16.467"></a><span id="l16.467">                                  [groupValue],</span>
<a href="#l16.468"></a><span id="l16.468">                                  goAnimate);</span>
<a href="#l16.469"></a><span id="l16.469">           // we will automatically rebuild if the constraint is gone, so</span>
<a href="#l16.470"></a><span id="l16.470">           //  just make the animation a no-op.</span>
<a href="#l16.471"></a><span id="l16.471">           if (constraintGone)</span>
<a href="#l16.472"></a><span id="l16.472">             flyAway = false;</span>
<a href="#l16.473"></a><span id="l16.473" class="difflineminus">-        }</span>
<a href="#l16.474"></a><span id="l16.474" class="difflineminus">-        // include/exclude</span>
<a href="#l16.475"></a><span id="l16.475" class="difflineminus">-        else {</span>
<a href="#l16.476"></a><span id="l16.476" class="difflineplus">+        } else { // include/exclude</span>
<a href="#l16.477"></a><span id="l16.477">           let revalidate = FacetContext.addFacetConstraint(</span>
<a href="#l16.478"></a><span id="l16.478">                              this.faceter,</span>
<a href="#l16.479"></a><span id="l16.479">                              aVariety == &quot;include&quot;,</span>
<a href="#l16.480"></a><span id="l16.480">                              [groupValue],</span>
<a href="#l16.481"></a><span id="l16.481">                              false, false, goAnimate);</span>
<a href="#l16.482"></a><span id="l16.482">           // revalidate means we need to blow away the other dudes, in which</span>
<a href="#l16.483"></a><span id="l16.483">           //  case it makes the most sense to just trigger a rebuild of ourself</span>
<a href="#l16.484"></a><span id="l16.484">           if (revalidate) {</span>
<a href="#l16.485"></a><span id="l16.485" class="difflineat">@@ -1191,23 +1174,23 @@</span>
<a href="#l16.486"></a><span id="l16.486">           // of it, or perhaps the facet-more button, or maybe something</span>
<a href="#l16.487"></a><span id="l16.487">           // else that we'll handle in the next version.  We walk up its</span>
<a href="#l16.488"></a><span id="l16.488">           // parent chain until we get to the right level of the DOM</span>
<a href="#l16.489"></a><span id="l16.489">           // hierarchy, or the facet-content which seems to be the root.</span>
<a href="#l16.490"></a><span id="l16.490">           if (this.currentNode)</span>
<a href="#l16.491"></a><span id="l16.491">             this.currentNode.removeAttribute(&quot;selected&quot;);</span>
<a href="#l16.492"></a><span id="l16.492"> </span>
<a href="#l16.493"></a><span id="l16.493">           let node = event.originalTarget;</span>
<a href="#l16.494"></a><span id="l16.494" class="difflineminus">-          while ((! (node &amp;&amp; node.hasAttribute &amp;&amp; node.hasAttribute(&quot;class&quot;))) ||</span>
<a href="#l16.495"></a><span id="l16.495" class="difflineplus">+          while ((!(node &amp;&amp; node.hasAttribute &amp;&amp; node.hasAttribute(&quot;class&quot;))) ||</span>
<a href="#l16.496"></a><span id="l16.496">                  (!node.classList.contains(&quot;bar&quot;) &amp;&amp;</span>
<a href="#l16.497"></a><span id="l16.497">                   !node.classList.contains(&quot;facet-more&quot;) &amp;&amp;</span>
<a href="#l16.498"></a><span id="l16.498">                   !node.classList.contains(&quot;facet-content&quot;)))</span>
<a href="#l16.499"></a><span id="l16.499">             node = node.parentNode;</span>
<a href="#l16.500"></a><span id="l16.500"> </span>
<a href="#l16.501"></a><span id="l16.501" class="difflineminus">-          if (! (node &amp;&amp; node.hasAttribute &amp;&amp; node.hasAttribute(&quot;class&quot;)))</span>
<a href="#l16.502"></a><span id="l16.502" class="difflineplus">+          if (!(node &amp;&amp; node.hasAttribute &amp;&amp; node.hasAttribute(&quot;class&quot;)))</span>
<a href="#l16.503"></a><span id="l16.503">             return false;</span>
<a href="#l16.504"></a><span id="l16.504"> </span>
<a href="#l16.505"></a><span id="l16.505">           this.currentNode = node;</span>
<a href="#l16.506"></a><span id="l16.506">           node.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l16.507"></a><span id="l16.507">           if (node.classList.contains(&quot;bar&quot;))</span>
<a href="#l16.508"></a><span id="l16.508">             document.getElementById(&quot;popup-menu&quot;).show(event, this, node);</span>
<a href="#l16.509"></a><span id="l16.509">           else if (node.classList.contains(&quot;facet-more&quot;))</span>
<a href="#l16.510"></a><span id="l16.510">             this.changeMode(&quot;all&quot;);</span>
<a href="#l16.511"></a><span id="l16.511" class="difflineat">@@ -1300,17 +1283,17 @@</span>
<a href="#l16.512"></a><span id="l16.512">           &quot;glodaFacetView.results.header.countLabel.ofN&quot;);</span>
<a href="#l16.513"></a><span id="l16.513">         let groupingFormat = glodaFacetStrings.get(</span>
<a href="#l16.514"></a><span id="l16.514">           &quot;glodaFacetView.results.header.countLabel.grouping&quot;);</span>
<a href="#l16.515"></a><span id="l16.515"> </span>
<a href="#l16.516"></a><span id="l16.516">         let displayCount = aMessages.length;</span>
<a href="#l16.517"></a><span id="l16.517">         let totalCount = FacetContext.activeSet.length;</span>
<a href="#l16.518"></a><span id="l16.518"> </span>
<a href="#l16.519"></a><span id="l16.519">         // set the count so CSS selectors can know what the results look like</span>
<a href="#l16.520"></a><span id="l16.520" class="difflineminus">-        this.setAttribute(&quot;state&quot;, (totalCount &lt;= 0)? &quot;empty&quot; : &quot;some&quot;);</span>
<a href="#l16.521"></a><span id="l16.521" class="difflineplus">+        this.setAttribute(&quot;state&quot;, (totalCount &lt;= 0) ? &quot;empty&quot; : &quot;some&quot;);</span>
<a href="#l16.522"></a><span id="l16.522"> </span>
<a href="#l16.523"></a><span id="l16.523">         let topMessagesStr = PluralForm.get(displayCount,</span>
<a href="#l16.524"></a><span id="l16.524">                                             topMessagesPluralFormat)</span>
<a href="#l16.525"></a><span id="l16.525">                                        .replace(&quot;#1&quot;,</span>
<a href="#l16.526"></a><span id="l16.526">                                                 displayCount.toLocaleString());</span>
<a href="#l16.527"></a><span id="l16.527">         let outOfStr = PluralForm.get(totalCount,</span>
<a href="#l16.528"></a><span id="l16.528">                                       outOfPluralFormat)</span>
<a href="#l16.529"></a><span id="l16.529">                                  .replace(&quot;#1&quot;, totalCount.toLocaleString());</span>
<a href="#l16.530"></a><span id="l16.530" class="difflineat">@@ -1324,59 +1307,59 @@</span>
<a href="#l16.531"></a><span id="l16.531">         let visible = aMessages.some(m =&gt; m instanceof GlodaMessage);</span>
<a href="#l16.532"></a><span id="l16.532">         showNode.style.display = visible ? &quot;inline&quot; : &quot;none&quot;;</span>
<a href="#l16.533"></a><span id="l16.533">         showNode.textContent = glodaFacetStrings.get(</span>
<a href="#l16.534"></a><span id="l16.534">           &quot;glodaFacetView.results.message.openEmailAsList.label&quot;);</span>
<a href="#l16.535"></a><span id="l16.535">         showNode.setAttribute(&quot;title&quot;, glodaFacetStrings.get(</span>
<a href="#l16.536"></a><span id="l16.536">           &quot;glodaFacetView.results.message.openEmailAsList.tooltip&quot;));</span>
<a href="#l16.537"></a><span id="l16.537">         showNode.onkeypress = function(event) {</span>
<a href="#l16.538"></a><span id="l16.538">           if (event.charCode == KeyEvent.DOM_VK_SPACE) {</span>
<a href="#l16.539"></a><span id="l16.539" class="difflineminus">-            FacetContext.showActiveSetInTab()</span>
<a href="#l16.540"></a><span id="l16.540" class="difflineplus">+            FacetContext.showActiveSetInTab();</span>
<a href="#l16.541"></a><span id="l16.541">             event.preventDefault();</span>
<a href="#l16.542"></a><span id="l16.542">           }</span>
<a href="#l16.543"></a><span id="l16.543" class="difflineminus">-        }</span>
<a href="#l16.544"></a><span id="l16.544" class="difflineplus">+        };</span>
<a href="#l16.545"></a><span id="l16.545"> </span>
<a href="#l16.546"></a><span id="l16.546">         let sortLabelNode = document.getAnonymousElementByAttribute(</span>
<a href="#l16.547"></a><span id="l16.547">                           this, &quot;anonid&quot;, &quot;sort-label&quot;);</span>
<a href="#l16.548"></a><span id="l16.548">         sortLabelNode.textContent = glodaFacetStrings.get(</span>
<a href="#l16.549"></a><span id="l16.549">           &quot;glodaFacetView.results.message.sort.label&quot;);</span>
<a href="#l16.550"></a><span id="l16.550"> </span>
<a href="#l16.551"></a><span id="l16.551">         let sortRelevanceNode = document.getAnonymousElementByAttribute(</span>
<a href="#l16.552"></a><span id="l16.552">                           this, &quot;anonid&quot;, &quot;sort-relevance&quot;);</span>
<a href="#l16.553"></a><span id="l16.553">         sortRelevanceNode.textContent = glodaFacetStrings.get(</span>
<a href="#l16.554"></a><span id="l16.554">           &quot;glodaFacetView.results.message.sort.relevance&quot;);</span>
<a href="#l16.555"></a><span id="l16.555"> </span>
<a href="#l16.556"></a><span id="l16.556">         let dis = this;</span>
<a href="#l16.557"></a><span id="l16.557">         sortRelevanceNode.onclick = function() {</span>
<a href="#l16.558"></a><span id="l16.558" class="difflineminus">-          FacetContext.sortBy = '-dascore';</span>
<a href="#l16.559"></a><span id="l16.559" class="difflineplus">+          FacetContext.sortBy = &quot;-dascore&quot;;</span>
<a href="#l16.560"></a><span id="l16.560">           dis.updateSortLabels();</span>
<a href="#l16.561"></a><span id="l16.561" class="difflineminus">-        }</span>
<a href="#l16.562"></a><span id="l16.562" class="difflineplus">+        };</span>
<a href="#l16.563"></a><span id="l16.563">         sortRelevanceNode.onkeypress = function(event) {</span>
<a href="#l16.564"></a><span id="l16.564">           if (event.charCode == KeyEvent.DOM_VK_SPACE) {</span>
<a href="#l16.565"></a><span id="l16.565" class="difflineminus">-            FacetContext.sortBy = '-dascore';</span>
<a href="#l16.566"></a><span id="l16.566" class="difflineplus">+            FacetContext.sortBy = &quot;-dascore&quot;;</span>
<a href="#l16.567"></a><span id="l16.567">             dis.updateSortLabels();</span>
<a href="#l16.568"></a><span id="l16.568">             event.preventDefault();</span>
<a href="#l16.569"></a><span id="l16.569">           }</span>
<a href="#l16.570"></a><span id="l16.570" class="difflineminus">-        }</span>
<a href="#l16.571"></a><span id="l16.571" class="difflineplus">+        };</span>
<a href="#l16.572"></a><span id="l16.572"> </span>
<a href="#l16.573"></a><span id="l16.573">         let sortDateNode = document.getAnonymousElementByAttribute(</span>
<a href="#l16.574"></a><span id="l16.574">                           this, &quot;anonid&quot;, &quot;sort-date&quot;);</span>
<a href="#l16.575"></a><span id="l16.575">         sortDateNode.textContent = glodaFacetStrings.get(</span>
<a href="#l16.576"></a><span id="l16.576">           &quot;glodaFacetView.results.message.sort.date&quot;);</span>
<a href="#l16.577"></a><span id="l16.577">         sortDateNode.onclick = function() {</span>
<a href="#l16.578"></a><span id="l16.578" class="difflineminus">-          FacetContext.sortBy = '-date';</span>
<a href="#l16.579"></a><span id="l16.579" class="difflineplus">+          FacetContext.sortBy = &quot;-date&quot;;</span>
<a href="#l16.580"></a><span id="l16.580">           dis.updateSortLabels();</span>
<a href="#l16.581"></a><span id="l16.581" class="difflineminus">-        }</span>
<a href="#l16.582"></a><span id="l16.582" class="difflineplus">+        };</span>
<a href="#l16.583"></a><span id="l16.583">         sortDateNode.onkeypress = function(event) {</span>
<a href="#l16.584"></a><span id="l16.584">           if (event.charCode == KeyEvent.DOM_VK_SPACE) {</span>
<a href="#l16.585"></a><span id="l16.585" class="difflineminus">-            FacetContext.sortBy = '-date';</span>
<a href="#l16.586"></a><span id="l16.586" class="difflineplus">+            FacetContext.sortBy = &quot;-date&quot;;</span>
<a href="#l16.587"></a><span id="l16.587">             dis.updateSortLabels();</span>
<a href="#l16.588"></a><span id="l16.588">             event.preventDefault();</span>
<a href="#l16.589"></a><span id="l16.589">           }</span>
<a href="#l16.590"></a><span id="l16.590" class="difflineminus">-        }</span>
<a href="#l16.591"></a><span id="l16.591" class="difflineplus">+        };</span>
<a href="#l16.592"></a><span id="l16.592"> </span>
<a href="#l16.593"></a><span id="l16.593">         this.updateSortLabels(FacetContext.sortBy);</span>
<a href="#l16.594"></a><span id="l16.594"> </span>
<a href="#l16.595"></a><span id="l16.595">         let messagesNode = document.getAnonymousElementByAttribute(</span>
<a href="#l16.596"></a><span id="l16.596">                              this, &quot;anonid&quot;, &quot;messages&quot;);</span>
<a href="#l16.597"></a><span id="l16.597">         while (messagesNode.hasChildNodes())</span>
<a href="#l16.598"></a><span id="l16.598">           messagesNode.lastChild.remove();</span>
<a href="#l16.599"></a><span id="l16.599">       try {</span>
<a href="#l16.600"></a><span id="l16.600" class="difflineat">@@ -1393,17 +1376,17 @@</span>
<a href="#l16.601"></a><span id="l16.601">       ]]&gt;&lt;/body&gt;</span>
<a href="#l16.602"></a><span id="l16.602">     &lt;/method&gt;</span>
<a href="#l16.603"></a><span id="l16.603">     &lt;method name=&quot;ensureNodeVisible&quot;&gt;</span>
<a href="#l16.604"></a><span id="l16.604">       &lt;parameter name=&quot;messageIndex&quot;/&gt;</span>
<a href="#l16.605"></a><span id="l16.605">       &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.606"></a><span id="l16.606">         let messagesNode = document.getAnonymousElementByAttribute(</span>
<a href="#l16.607"></a><span id="l16.607">                              this, &quot;anonid&quot;, &quot;messages&quot;);</span>
<a href="#l16.608"></a><span id="l16.608">         let message = messagesNode.childNodes[messageIndex];</span>
<a href="#l16.609"></a><span id="l16.609" class="difflineminus">-        window.scrollTo(0, $(message).position()['top'] + $(window).scrollTop());</span>
<a href="#l16.610"></a><span id="l16.610" class="difflineplus">+        window.scrollTo(0, $(message).position().top + $(window).scrollTop());</span>
<a href="#l16.611"></a><span id="l16.611">       ]]&gt;&lt;/body&gt;</span>
<a href="#l16.612"></a><span id="l16.612">     &lt;/method&gt;</span>
<a href="#l16.613"></a><span id="l16.613"> </span>
<a href="#l16.614"></a><span id="l16.614">     &lt;method name=&quot;updateSortLabels&quot;&gt;</span>
<a href="#l16.615"></a><span id="l16.615">       &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.616"></a><span id="l16.616">       try {</span>
<a href="#l16.617"></a><span id="l16.617">         let sortBy = FacetContext.sortBy;</span>
<a href="#l16.618"></a><span id="l16.618">         let sortRelevanceNode = document.getAnonymousElementByAttribute(</span>
<a href="#l16.619"></a><span id="l16.619" class="difflineat">@@ -1413,17 +1396,17 @@</span>
<a href="#l16.620"></a><span id="l16.620"> </span>
<a href="#l16.621"></a><span id="l16.621">         if (sortBy == &quot;-dascore&quot;) {</span>
<a href="#l16.622"></a><span id="l16.622">           sortRelevanceNode.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l16.623"></a><span id="l16.623">           sortDateNode.removeAttribute(&quot;selected&quot;);</span>
<a href="#l16.624"></a><span id="l16.624">         } else if (sortBy == &quot;-date&quot;) {</span>
<a href="#l16.625"></a><span id="l16.625">           sortRelevanceNode.removeAttribute(&quot;selected&quot;);</span>
<a href="#l16.626"></a><span id="l16.626">           sortDateNode.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l16.627"></a><span id="l16.627">         }</span>
<a href="#l16.628"></a><span id="l16.628" class="difflineminus">-      } catch (e ) {</span>
<a href="#l16.629"></a><span id="l16.629" class="difflineplus">+      } catch (e) {</span>
<a href="#l16.630"></a><span id="l16.630">         logException(e);</span>
<a href="#l16.631"></a><span id="l16.631">       }</span>
<a href="#l16.632"></a><span id="l16.632">       ]]&gt;&lt;/body&gt;</span>
<a href="#l16.633"></a><span id="l16.633">     &lt;/method&gt;</span>
<a href="#l16.634"></a><span id="l16.634">   &lt;/implementation&gt;</span>
<a href="#l16.635"></a><span id="l16.635"> &lt;/binding&gt;</span>
<a href="#l16.636"></a><span id="l16.636"> </span>
<a href="#l16.637"></a><span id="l16.637"> &lt;binding id=&quot;result-message&quot;&gt;</span>
<a href="#l16.638"></a><span id="l16.638" class="difflineat">@@ -1470,42 +1453,42 @@</span>
<a href="#l16.639"></a><span id="l16.639">         // -- eventify</span>
<a href="#l16.640"></a><span id="l16.640">         subject.onclick = function(aEvent) {</span>
<a href="#l16.641"></a><span id="l16.641">           FacetContext.showConversationInTab(this,</span>
<a href="#l16.642"></a><span id="l16.642">                                              aEvent.button == 1);</span>
<a href="#l16.643"></a><span id="l16.643">         }.bind(this);</span>
<a href="#l16.644"></a><span id="l16.644">         subject.onkeypress = function(aEvent) {</span>
<a href="#l16.645"></a><span id="l16.645">           if (aEvent.keyCode == aEvent.DOM_VK_RETURN)</span>
<a href="#l16.646"></a><span id="l16.646">             FacetContext.showConversationInTab(this,</span>
<a href="#l16.647"></a><span id="l16.647" class="difflineminus">-                                               aEvent.shiftKey == true);</span>
<a href="#l16.648"></a><span id="l16.648" class="difflineplus">+                                               aEvent.shiftKey);</span>
<a href="#l16.649"></a><span id="l16.649">         }.bind(this);</span>
<a href="#l16.650"></a><span id="l16.650"> </span>
<a href="#l16.651"></a><span id="l16.651">         // -- Content Poking</span>
<a href="#l16.652"></a><span id="l16.652">         if (message.subject.trim() == &quot;&quot;)</span>
<a href="#l16.653"></a><span id="l16.653">           subject.textContent = glodaFacetStrings.get(&quot;glodaFacetView.result.message.noSubject&quot;);</span>
<a href="#l16.654"></a><span id="l16.654">         else</span>
<a href="#l16.655"></a><span id="l16.655">           subject.textContent = message.subject;</span>
<a href="#l16.656"></a><span id="l16.656">         let authorNode = anonElem(&quot;author&quot;);</span>
<a href="#l16.657"></a><span id="l16.657">         authorNode.setAttribute(&quot;title&quot;, message.from.value);</span>
<a href="#l16.658"></a><span id="l16.658" class="difflineminus">-        authorNode.textContent = message.from.contact.name</span>
<a href="#l16.659"></a><span id="l16.659" class="difflineplus">+        authorNode.textContent = message.from.contact.name;</span>
<a href="#l16.660"></a><span id="l16.660">         let toNode = anonElem(&quot;to&quot;);</span>
<a href="#l16.661"></a><span id="l16.661">         toNode.textContent = glodaFacetStrings.get(&quot;glodaFacetView.result.message.toLabel&quot;);</span>
<a href="#l16.662"></a><span id="l16.662"> </span>
<a href="#l16.663"></a><span id="l16.663" class="difflineminus">-        //anonElem(&quot;author&quot;).textContent = ;</span>
<a href="#l16.664"></a><span id="l16.664" class="difflineplus">+        // anonElem(&quot;author&quot;).textContent = ;</span>
<a href="#l16.665"></a><span id="l16.665">         anonElem(&quot;date&quot;).textContent = makeFriendlyDateAgo(message.date);</span>
<a href="#l16.666"></a><span id="l16.666"> </span>
<a href="#l16.667"></a><span id="l16.667">         // - Recipients</span>
<a href="#l16.668"></a><span id="l16.668">       try {</span>
<a href="#l16.669"></a><span id="l16.669">         let recipientsNode = anonElem(&quot;recipients&quot;);</span>
<a href="#l16.670"></a><span id="l16.670">         if (message.recipients) {</span>
<a href="#l16.671"></a><span id="l16.671">           let recipientCount = 0;</span>
<a href="#l16.672"></a><span id="l16.672">           const MAX_RECIPIENTS = 3;</span>
<a href="#l16.673"></a><span id="l16.673">           let totalRecipientCount = message.recipients.length;</span>
<a href="#l16.674"></a><span id="l16.674">           let recipientSeparator = glodaFacetStrings.get(</span>
<a href="#l16.675"></a><span id="l16.675" class="difflineminus">-              &quot;glodaFacetView.results.message.recipientSeparator&quot;)</span>
<a href="#l16.676"></a><span id="l16.676" class="difflineplus">+            &quot;glodaFacetView.results.message.recipientSeparator&quot;);</span>
<a href="#l16.677"></a><span id="l16.677">           for (let index in message.recipients) {</span>
<a href="#l16.678"></a><span id="l16.678">             let recipNode = document.createElement(&quot;span&quot;);</span>
<a href="#l16.679"></a><span id="l16.679">             recipNode.setAttribute(&quot;class&quot;, &quot;message-recipient&quot;);</span>
<a href="#l16.680"></a><span id="l16.680">             recipNode.textContent = message.recipients[index].contact.name;</span>
<a href="#l16.681"></a><span id="l16.681">             recipientsNode.appendChild(recipNode);</span>
<a href="#l16.682"></a><span id="l16.682">             recipientCount++;</span>
<a href="#l16.683"></a><span id="l16.683">             if (recipientCount == MAX_RECIPIENTS)</span>
<a href="#l16.684"></a><span id="l16.684">               break;</span>
<a href="#l16.685"></a><span id="l16.685" class="difflineat">@@ -1517,32 +1500,32 @@</span>
<a href="#l16.686"></a><span id="l16.686">               recipientsNode.appendChild(sepNode);</span>
<a href="#l16.687"></a><span id="l16.687">             }</span>
<a href="#l16.688"></a><span id="l16.688">           }</span>
<a href="#l16.689"></a><span id="l16.689">           if (totalRecipientCount &gt; MAX_RECIPIENTS) {</span>
<a href="#l16.690"></a><span id="l16.690">             let nOthers = totalRecipientCount - recipientCount;</span>
<a href="#l16.691"></a><span id="l16.691">             let andNOthers = document.createElement(&quot;span&quot;);</span>
<a href="#l16.692"></a><span id="l16.692">             andNOthers.setAttribute(&quot;class&quot;, &quot;message-recipients-andothers&quot;);</span>
<a href="#l16.693"></a><span id="l16.693"> </span>
<a href="#l16.694"></a><span id="l16.694" class="difflineminus">-            let andOthersLabel= PluralForm.get(nOthers, glodaFacetStrings.get(</span>
<a href="#l16.695"></a><span id="l16.695" class="difflineminus">-                              &quot;glodaFacetView.results.message.andOthers&quot;))</span>
<a href="#l16.696"></a><span id="l16.696" class="difflineminus">-                             .replace(&quot;#1&quot;, nOthers);</span>
<a href="#l16.697"></a><span id="l16.697" class="difflineplus">+            let andOthersLabel = PluralForm.get(</span>
<a href="#l16.698"></a><span id="l16.698" class="difflineplus">+              nOthers, glodaFacetStrings.get(&quot;glodaFacetView.results.message.andOthers&quot;)</span>
<a href="#l16.699"></a><span id="l16.699" class="difflineplus">+            ).replace(&quot;#1&quot;, nOthers);</span>
<a href="#l16.700"></a><span id="l16.700"> </span>
<a href="#l16.701"></a><span id="l16.701">             andNOthers.textContent = andOthersLabel;</span>
<a href="#l16.702"></a><span id="l16.702">             recipientsNode.appendChild(andNOthers);</span>
<a href="#l16.703"></a><span id="l16.703">           }</span>
<a href="#l16.704"></a><span id="l16.704">         }</span>
<a href="#l16.705"></a><span id="l16.705">       } catch (e) {</span>
<a href="#l16.706"></a><span id="l16.706">         logException(e);</span>
<a href="#l16.707"></a><span id="l16.707">       }</span>
<a href="#l16.708"></a><span id="l16.708"> </span>
<a href="#l16.709"></a><span id="l16.709">         // - Starred</span>
<a href="#l16.710"></a><span id="l16.710">         let starNode = anonElem(&quot;star&quot;);</span>
<a href="#l16.711"></a><span id="l16.711">         if (message.starred) {</span>
<a href="#l16.712"></a><span id="l16.712" class="difflineminus">-          starNode.setAttribute(&quot;starred&quot;, &quot;true&quot;)</span>
<a href="#l16.713"></a><span id="l16.713" class="difflineplus">+          starNode.setAttribute(&quot;starred&quot;, &quot;true&quot;);</span>
<a href="#l16.714"></a><span id="l16.714">         }</span>
<a href="#l16.715"></a><span id="l16.715"> </span>
<a href="#l16.716"></a><span id="l16.716">         // - Attachments</span>
<a href="#l16.717"></a><span id="l16.717">         if (message.attachmentNames) {</span>
<a href="#l16.718"></a><span id="l16.718">           let attachmentsNode = anonElem(&quot;attachments&quot;);</span>
<a href="#l16.719"></a><span id="l16.719">           let imgNode = document.createElement(&quot;div&quot;);</span>
<a href="#l16.720"></a><span id="l16.720">           imgNode.setAttribute(&quot;class&quot;, &quot;message-attachment-icon&quot;);</span>
<a href="#l16.721"></a><span id="l16.721">           attachmentsNode.appendChild(imgNode);</span>
<a href="#l16.722"></a><span id="l16.722" class="difflineat">@@ -1605,18 +1588,24 @@</span>
<a href="#l16.723"></a><span id="l16.723">             let charCodeToByteCount = function(c) {</span>
<a href="#l16.724"></a><span id="l16.724">               // UTF-8 stores:</span>
<a href="#l16.725"></a><span id="l16.725">               // - code points below U+0080 on 1 byte,</span>
<a href="#l16.726"></a><span id="l16.726">               // - code points below U+0800 on 2 bytes,</span>
<a href="#l16.727"></a><span id="l16.727">               // - code points U+D800 through U+DFFF are UTF-16 surrogate halves</span>
<a href="#l16.728"></a><span id="l16.728">               // (they indicate that JS has split a 4 bytes UTF-8 character</span>
<a href="#l16.729"></a><span id="l16.729">               // in two halves of 2 bytes each),</span>
<a href="#l16.730"></a><span id="l16.730">               // - other code points on 3 bytes.</span>
<a href="#l16.731"></a><span id="l16.731" class="difflineminus">-              return c &lt; 0x80 ? 1 : (c &lt; 0x800 || (c &gt;= 0xD800 &amp;&amp; c &lt;= 0xDFFF)) ? 2 : 3;</span>
<a href="#l16.732"></a><span id="l16.732" class="difflineminus">-            }</span>
<a href="#l16.733"></a><span id="l16.733" class="difflineplus">+              if (c &lt; 0x80) {</span>
<a href="#l16.734"></a><span id="l16.734" class="difflineplus">+                return 1;</span>
<a href="#l16.735"></a><span id="l16.735" class="difflineplus">+              }</span>
<a href="#l16.736"></a><span id="l16.736" class="difflineplus">+              if (c &lt; 0x800 || (c &gt;= 0xD800 &amp;&amp; c &lt;= 0xDFFF)) {</span>
<a href="#l16.737"></a><span id="l16.737" class="difflineplus">+                return 2;</span>
<a href="#l16.738"></a><span id="l16.738" class="difflineplus">+              }</span>
<a href="#l16.739"></a><span id="l16.739" class="difflineplus">+              return 3;</span>
<a href="#l16.740"></a><span id="l16.740" class="difflineplus">+            };</span>
<a href="#l16.741"></a><span id="l16.741">             let byteOffset = 0;</span>
<a href="#l16.742"></a><span id="l16.742">             let offset = 0;</span>
<a href="#l16.743"></a><span id="l16.743">             for (let match of matches) {</span>
<a href="#l16.744"></a><span id="l16.744">               while (byteOffset &lt; match[0])</span>
<a href="#l16.745"></a><span id="l16.745">                 byteOffset += charCodeToByteCount(bodyText.charCodeAt(offset++));</span>
<a href="#l16.746"></a><span id="l16.746">               match[0] = offset;</span>
<a href="#l16.747"></a><span id="l16.747">               for (let i = offset; i &lt; offset + match[1]; ++i) {</span>
<a href="#l16.748"></a><span id="l16.748">                 let size = charCodeToByteCount(bodyText.charCodeAt(i));</span>
<a href="#l16.749"></a><span id="l16.749" class="difflineat">@@ -1654,19 +1643,19 @@</span>
<a href="#l16.750"></a><span id="l16.750">               ++startIndex;</span>
<a href="#l16.751"></a><span id="l16.751">             bodyText = ellipses + bodyText.substring(startIndex);</span>
<a href="#l16.752"></a><span id="l16.752">             // The first line will only contain the ellipsis as the character</span>
<a href="#l16.753"></a><span id="l16.753">             // at startIndex is always \n, so we show an additional line.</span>
<a href="#l16.754"></a><span id="l16.754">             ++maxLineCount;</span>
<a href="#l16.755"></a><span id="l16.755">           }</span>
<a href="#l16.756"></a><span id="l16.756"> </span>
<a href="#l16.757"></a><span id="l16.757">           for (let newlineCount = 0; newlineCount &lt; maxLineCount; newlineCount++) {</span>
<a href="#l16.758"></a><span id="l16.758" class="difflineminus">-            idxNewline = bodyText.indexOf(&quot;\n&quot;, idxNewline+1);</span>
<a href="#l16.759"></a><span id="l16.759" class="difflineplus">+            idxNewline = bodyText.indexOf(&quot;\n&quot;, idxNewline + 1);</span>
<a href="#l16.760"></a><span id="l16.760">             if (idxNewline == -1) {</span>
<a href="#l16.761"></a><span id="l16.761" class="difflineminus">-              ellipses = '';</span>
<a href="#l16.762"></a><span id="l16.762" class="difflineplus">+              ellipses = &quot;&quot;;</span>
<a href="#l16.763"></a><span id="l16.763">               break;</span>
<a href="#l16.764"></a><span id="l16.764">             }</span>
<a href="#l16.765"></a><span id="l16.765">           }</span>
<a href="#l16.766"></a><span id="l16.766">           let snippet = &quot;&quot;;</span>
<a href="#l16.767"></a><span id="l16.767">           if (idxNewline &gt; -1)</span>
<a href="#l16.768"></a><span id="l16.768">             snippet = bodyText.substring(0, idxNewline);</span>
<a href="#l16.769"></a><span id="l16.769">           else</span>
<a href="#l16.770"></a><span id="l16.770">             snippet = bodyText;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mail/base/content/glodaFacetTab.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mail/base/content/glodaFacetTab.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -12,20 +12,20 @@ var glodaFacetTabType = {</span>
<a href="#l17.4"></a><span id="l17.4">   name: &quot;glodaFacet&quot;,</span>
<a href="#l17.5"></a><span id="l17.5">   perTabPanel: &quot;vbox&quot;,</span>
<a href="#l17.6"></a><span id="l17.6">   lastTabId: 0,</span>
<a href="#l17.7"></a><span id="l17.7">   strings:</span>
<a href="#l17.8"></a><span id="l17.8">     new StringBundle(&quot;chrome://messenger/locale/glodaFacetView.properties&quot;),</span>
<a href="#l17.9"></a><span id="l17.9">   modes: {</span>
<a href="#l17.10"></a><span id="l17.10">     glodaFacet: {</span>
<a href="#l17.11"></a><span id="l17.11">       // this is what get exposed on the tab for icon purposes</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-      type: &quot;glodaSearch&quot;</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-    }</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+      type: &quot;glodaSearch&quot;,</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+    },</span>
<a href="#l17.16"></a><span id="l17.16">   },</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineminus">-  openTab: function glodaFacetTabType_openTab(aTab, aArgs) {</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+  openTab(aTab, aArgs) {</span>
<a href="#l17.19"></a><span id="l17.19">     // we have no browser until our XUL document loads</span>
<a href="#l17.20"></a><span id="l17.20">     aTab.browser = null;</span>
<a href="#l17.21"></a><span id="l17.21"> </span>
<a href="#l17.22"></a><span id="l17.22">     // First clone the page and set up the basics.</span>
<a href="#l17.23"></a><span id="l17.23">     let clone = document.getElementById(&quot;glodaTab&quot;)</span>
<a href="#l17.24"></a><span id="l17.24">                         .firstChild</span>
<a href="#l17.25"></a><span id="l17.25">                         .cloneNode(true);</span>
<a href="#l17.26"></a><span id="l17.26"> </span>
<a href="#l17.27"></a><span id="l17.27" class="difflineat">@@ -38,33 +38,31 @@ var glodaFacetTabType = {</span>
<a href="#l17.28"></a><span id="l17.28">     searchInput.focus();</span>
<a href="#l17.29"></a><span id="l17.29"> </span>
<a href="#l17.30"></a><span id="l17.30">     if (&quot;query&quot; in aArgs) {</span>
<a href="#l17.31"></a><span id="l17.31">       aTab.query = aArgs.query;</span>
<a href="#l17.32"></a><span id="l17.32">       aTab.collection = aTab.query.getCollection();</span>
<a href="#l17.33"></a><span id="l17.33"> </span>
<a href="#l17.34"></a><span id="l17.34">       aTab.title = this.strings.get(&quot;glodaFacetView.tab.query.label&quot;);</span>
<a href="#l17.35"></a><span id="l17.35">       aTab.searchString = null;</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineminus">-    }</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineminus">-    else if (&quot;searcher&quot; in aArgs) {</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+    } else if (&quot;searcher&quot; in aArgs) {</span>
<a href="#l17.39"></a><span id="l17.39">       aTab.searcher = aArgs.searcher;</span>
<a href="#l17.40"></a><span id="l17.40">       aTab.collection = aTab.searcher.getCollection();</span>
<a href="#l17.41"></a><span id="l17.41">       aTab.query = aTab.searcher.query;</span>
<a href="#l17.42"></a><span id="l17.42">       if (&quot;IMSearcher&quot; in aArgs) {</span>
<a href="#l17.43"></a><span id="l17.43">         aTab.IMSearcher = aArgs.IMSearcher;</span>
<a href="#l17.44"></a><span id="l17.44">         aTab.IMCollection = aArgs.IMSearcher.getCollection();</span>
<a href="#l17.45"></a><span id="l17.45">         aTab.IMQuery = aTab.IMSearcher.query;</span>
<a href="#l17.46"></a><span id="l17.46">       }</span>
<a href="#l17.47"></a><span id="l17.47"> </span>
<a href="#l17.48"></a><span id="l17.48">       let searchString = aTab.searcher.searchString;</span>
<a href="#l17.49"></a><span id="l17.49">       aTab.searchInputValue = aTab.searchString = searchString;</span>
<a href="#l17.50"></a><span id="l17.50">       aTab.title = searchString ? searchString</span>
<a href="#l17.51"></a><span id="l17.51">                    : this.strings.get(&quot;glodaFacetView.tab.search.label&quot;);</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineminus">-    }</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineminus">-    else if (&quot;collection&quot; in aArgs) {</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineplus">+    } else if (&quot;collection&quot; in aArgs) {</span>
<a href="#l17.55"></a><span id="l17.55">       aTab.collection = aArgs.collection;</span>
<a href="#l17.56"></a><span id="l17.56"> </span>
<a href="#l17.57"></a><span id="l17.57">       aTab.title = this.strings.get(&quot;glodaFacetView.tab.query.label&quot;);</span>
<a href="#l17.58"></a><span id="l17.58">       aTab.searchString = null;</span>
<a href="#l17.59"></a><span id="l17.59">     }</span>
<a href="#l17.60"></a><span id="l17.60"> </span>
<a href="#l17.61"></a><span id="l17.61">     function xulLoadHandler() {</span>
<a href="#l17.62"></a><span id="l17.62">       aTab.iframe.contentWindow.tab = aTab;</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineat">@@ -74,21 +72,21 @@ var glodaFacetTabType = {</span>
<a href="#l17.64"></a><span id="l17.64">     }</span>
<a href="#l17.65"></a><span id="l17.65"> </span>
<a href="#l17.66"></a><span id="l17.66">     aTab.iframe.contentWindow.addEventListener(&quot;load&quot;, xulLoadHandler, {capture: false, once: true});</span>
<a href="#l17.67"></a><span id="l17.67">     aTab.iframe.setAttribute(&quot;src&quot;,</span>
<a href="#l17.68"></a><span id="l17.68">       &quot;chrome://messenger/content/glodaFacetViewWrapper.xul&quot;);</span>
<a href="#l17.69"></a><span id="l17.69"> </span>
<a href="#l17.70"></a><span id="l17.70">     this.lastTabId++;</span>
<a href="#l17.71"></a><span id="l17.71">   },</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineminus">-  closeTab: function glodaFacetTabType_closeTab(aTab) {</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineplus">+  closeTab(aTab) {</span>
<a href="#l17.74"></a><span id="l17.74">   },</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineminus">-  saveTabState: function glodaFacetTabType_saveTabState(aTab) {</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineplus">+  saveTabState(aTab) {</span>
<a href="#l17.77"></a><span id="l17.77">     // nothing to do; we are not multiplexed</span>
<a href="#l17.78"></a><span id="l17.78">   },</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineminus">-  showTab: function glodaFacetTabType_showTab(aTab) {</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineplus">+  showTab(aTab) {</span>
<a href="#l17.81"></a><span id="l17.81">     // nothing to do; we are not multiplexed</span>
<a href="#l17.82"></a><span id="l17.82">   },</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineminus">-  getBrowser: function(aTab) {</span>
<a href="#l17.84"></a><span id="l17.84" class="difflineplus">+  getBrowser(aTab) {</span>
<a href="#l17.85"></a><span id="l17.85">     return aTab.browser;</span>
<a href="#l17.86"></a><span id="l17.86" class="difflineminus">-  }</span>
<a href="#l17.87"></a><span id="l17.87" class="difflineplus">+  },</span>
<a href="#l17.88"></a><span id="l17.88"> };</span>
<a href="#l17.89"></a><span id="l17.89"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mail/base/content/glodaFacetView.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mail/base/content/glodaFacetView.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -34,17 +34,17 @@ var glodaFacetStrings =</span>
<a href="#l18.4"></a><span id="l18.4"> function ActiveSingularConstraint(aFaceter, aRanged) {</span>
<a href="#l18.5"></a><span id="l18.5">   this.faceter = aFaceter;</span>
<a href="#l18.6"></a><span id="l18.6">   this.attrDef = aFaceter.attrDef;</span>
<a href="#l18.7"></a><span id="l18.7">   this.facetDef = aFaceter.facetDef;</span>
<a href="#l18.8"></a><span id="l18.8">   this.ranged = Boolean(aRanged);</span>
<a href="#l18.9"></a><span id="l18.9">   this.clear();</span>
<a href="#l18.10"></a><span id="l18.10"> }</span>
<a href="#l18.11"></a><span id="l18.11"> ActiveSingularConstraint.prototype = {</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-  _makeQuery: function() {</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+  _makeQuery() {</span>
<a href="#l18.14"></a><span id="l18.14">     // have the faceter make the query and the invert decision for us if it</span>
<a href="#l18.15"></a><span id="l18.15">     //  implements the makeQuery method.</span>
<a href="#l18.16"></a><span id="l18.16">     if (&quot;makeQuery&quot; in this.faceter) {</span>
<a href="#l18.17"></a><span id="l18.17">       [this.query, this.invertQuery] = this.faceter.makeQuery(this.groupValues,</span>
<a href="#l18.18"></a><span id="l18.18">                                                               this.inclusive);</span>
<a href="#l18.19"></a><span id="l18.19">       return;</span>
<a href="#l18.20"></a><span id="l18.20">     }</span>
<a href="#l18.21"></a><span id="l18.21"> </span>
<a href="#l18.22"></a><span id="l18.22" class="difflineat">@@ -67,17 +67,17 @@ ActiveSingularConstraint.prototype = {</span>
<a href="#l18.23"></a><span id="l18.23">    *  Mainly, if the inclusive flag is the same as what we already have, we</span>
<a href="#l18.24"></a><span id="l18.24">    *  just append the new values to the existing set of values.  If it is not</span>
<a href="#l18.25"></a><span id="l18.25">    *  the same, we replace them.</span>
<a href="#l18.26"></a><span id="l18.26">    *</span>
<a href="#l18.27"></a><span id="l18.27">    * @return true if the caller needs to revalidate their understanding of the</span>
<a href="#l18.28"></a><span id="l18.28">    *     constraint because we have flipped whether we are inclusive or</span>
<a href="#l18.29"></a><span id="l18.29">    *     exclusive and have thrown away some constraints as a result.</span>
<a href="#l18.30"></a><span id="l18.30">    */</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineminus">-  constrain: function(aInclusive, aGroupValues) {</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+  constrain(aInclusive, aGroupValues) {</span>
<a href="#l18.33"></a><span id="l18.33">     if (aInclusive == this.inclusive) {</span>
<a href="#l18.34"></a><span id="l18.34">       this.groupValues = this.groupValues.concat(aGroupValues);</span>
<a href="#l18.35"></a><span id="l18.35">       this._makeQuery();</span>
<a href="#l18.36"></a><span id="l18.36">       return false;</span>
<a href="#l18.37"></a><span id="l18.37">     }</span>
<a href="#l18.38"></a><span id="l18.38"> </span>
<a href="#l18.39"></a><span id="l18.39">     let needToRevalidate = (this.inclusive != null);</span>
<a href="#l18.40"></a><span id="l18.40">     this.inclusive = aInclusive;</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineat">@@ -87,17 +87,17 @@ ActiveSingularConstraint.prototype = {</span>
<a href="#l18.42"></a><span id="l18.42">     return needToRevalidate;</span>
<a href="#l18.43"></a><span id="l18.43">   },</span>
<a href="#l18.44"></a><span id="l18.44">   /**</span>
<a href="#l18.45"></a><span id="l18.45">    * Relax something we previously constrained.  Remove it, some might say.  It</span>
<a href="#l18.46"></a><span id="l18.46">    *  is possible after relaxing that we will no longer be an active constraint.</span>
<a href="#l18.47"></a><span id="l18.47">    *</span>
<a href="#l18.48"></a><span id="l18.48">    * @return true if we are no longer constrained at all.</span>
<a href="#l18.49"></a><span id="l18.49">    */</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineminus">-  relax: function(aInclusive, aGroupValues) {</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+  relax(aInclusive, aGroupValues) {</span>
<a href="#l18.52"></a><span id="l18.52">     if (aInclusive != this.inclusive)</span>
<a href="#l18.53"></a><span id="l18.53">       throw new Error(&quot;You can't relax a constraint that isn't possible.&quot;);</span>
<a href="#l18.54"></a><span id="l18.54"> </span>
<a href="#l18.55"></a><span id="l18.55">     for (let groupValue of aGroupValues) {</span>
<a href="#l18.56"></a><span id="l18.56">       let index = this.groupValues.indexOf(groupValue);</span>
<a href="#l18.57"></a><span id="l18.57">       if (index == -1)</span>
<a href="#l18.58"></a><span id="l18.58">         throw new Error(&quot;Tried to relax a constraint that was not in force.&quot;);</span>
<a href="#l18.59"></a><span id="l18.59">       this.groupValues.splice(index, 1);</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineat">@@ -114,52 +114,52 @@ ActiveSingularConstraint.prototype = {</span>
<a href="#l18.61"></a><span id="l18.61">    * Indicate whether this constraint is actually doing anything anymore.</span>
<a href="#l18.62"></a><span id="l18.62">    */</span>
<a href="#l18.63"></a><span id="l18.63">   get isConstrained() {</span>
<a href="#l18.64"></a><span id="l18.64">     return this.inclusive != null;</span>
<a href="#l18.65"></a><span id="l18.65">   },</span>
<a href="#l18.66"></a><span id="l18.66">   /**</span>
<a href="#l18.67"></a><span id="l18.67">    * Clear the constraint so that the next call to adjust initializes it.</span>
<a href="#l18.68"></a><span id="l18.68">    */</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineminus">-  clear: function() {</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineplus">+  clear() {</span>
<a href="#l18.71"></a><span id="l18.71">     this.inclusive = null;</span>
<a href="#l18.72"></a><span id="l18.72">     this.groupValues = null;</span>
<a href="#l18.73"></a><span id="l18.73">     this.query = null;</span>
<a href="#l18.74"></a><span id="l18.74">     this.invertQuery = null;</span>
<a href="#l18.75"></a><span id="l18.75">   },</span>
<a href="#l18.76"></a><span id="l18.76">   /**</span>
<a href="#l18.77"></a><span id="l18.77">    * Filter the items against our constraint.</span>
<a href="#l18.78"></a><span id="l18.78">    */</span>
<a href="#l18.79"></a><span id="l18.79" class="difflineminus">-  sieve: function(aItems) {</span>
<a href="#l18.80"></a><span id="l18.80" class="difflineplus">+  sieve(aItems) {</span>
<a href="#l18.81"></a><span id="l18.81">     let query = this.query;</span>
<a href="#l18.82"></a><span id="l18.82">     let expectedResult = !this.invertQuery;</span>
<a href="#l18.83"></a><span id="l18.83">     return aItems.filter(item =&gt; query.test(item) == expectedResult);</span>
<a href="#l18.84"></a><span id="l18.84">   },</span>
<a href="#l18.85"></a><span id="l18.85" class="difflineminus">-  isIncludedGroup: function(aGroupValue) {</span>
<a href="#l18.86"></a><span id="l18.86" class="difflineplus">+  isIncludedGroup(aGroupValue) {</span>
<a href="#l18.87"></a><span id="l18.87">     if (!this.inclusive)</span>
<a href="#l18.88"></a><span id="l18.88">       return false;</span>
<a href="#l18.89"></a><span id="l18.89">     return this.groupValues.includes(aGroupValue);</span>
<a href="#l18.90"></a><span id="l18.90">   },</span>
<a href="#l18.91"></a><span id="l18.91" class="difflineminus">-  isExcludedGroup: function(aGroupValue) {</span>
<a href="#l18.92"></a><span id="l18.92" class="difflineplus">+  isExcludedGroup(aGroupValue) {</span>
<a href="#l18.93"></a><span id="l18.93">     if (this.inclusive)</span>
<a href="#l18.94"></a><span id="l18.94">       return false;</span>
<a href="#l18.95"></a><span id="l18.95">     return this.groupValues.includes(aGroupValue);</span>
<a href="#l18.96"></a><span id="l18.96" class="difflineminus">-  }</span>
<a href="#l18.97"></a><span id="l18.97" class="difflineplus">+  },</span>
<a href="#l18.98"></a><span id="l18.98"> };</span>
<a href="#l18.99"></a><span id="l18.99"> </span>
<a href="#l18.100"></a><span id="l18.100"> function ActiveNonSingularConstraint(aFaceter, aRanged) {</span>
<a href="#l18.101"></a><span id="l18.101">   this.faceter = aFaceter;</span>
<a href="#l18.102"></a><span id="l18.102">   this.attrDef = aFaceter.attrDef;</span>
<a href="#l18.103"></a><span id="l18.103">   this.facetDef = aFaceter.facetDef;</span>
<a href="#l18.104"></a><span id="l18.104">   this.ranged = Boolean(aRanged);</span>
<a href="#l18.105"></a><span id="l18.105"> </span>
<a href="#l18.106"></a><span id="l18.106">   this.clear();</span>
<a href="#l18.107"></a><span id="l18.107"> }</span>
<a href="#l18.108"></a><span id="l18.108"> ActiveNonSingularConstraint.prototype = {</span>
<a href="#l18.109"></a><span id="l18.109" class="difflineminus">-  _makeQuery: function(aInclusive, aGroupValues) {</span>
<a href="#l18.110"></a><span id="l18.110" class="difflineplus">+  _makeQuery(aInclusive, aGroupValues) {</span>
<a href="#l18.111"></a><span id="l18.111">     // have the faceter make the query and the invert decision for us if it</span>
<a href="#l18.112"></a><span id="l18.112">     //  implements the makeQuery method.</span>
<a href="#l18.113"></a><span id="l18.113">     if (&quot;makeQuery&quot; in this.faceter) {</span>
<a href="#l18.114"></a><span id="l18.114">       // returns [query, invertQuery] directly</span>
<a href="#l18.115"></a><span id="l18.115">       return this.faceter.makeQuery(aGroupValues, aInclusive);</span>
<a href="#l18.116"></a><span id="l18.116">     }</span>
<a href="#l18.117"></a><span id="l18.117"> </span>
<a href="#l18.118"></a><span id="l18.118">     let query = Gloda.newQuery(Gloda.NOUN_MESSAGE);</span>
<a href="#l18.119"></a><span id="l18.119" class="difflineat">@@ -178,17 +178,17 @@ ActiveNonSingularConstraint.prototype = </span>
<a href="#l18.120"></a><span id="l18.120">   },</span>
<a href="#l18.121"></a><span id="l18.121"> </span>
<a href="#l18.122"></a><span id="l18.122">   /**</span>
<a href="#l18.123"></a><span id="l18.123">    * Adjust the constraint given the incoming faceting constraint desired.</span>
<a href="#l18.124"></a><span id="l18.124">    *  Mainly, if the inclusive flag is the same as what we already have, we</span>
<a href="#l18.125"></a><span id="l18.125">    *  just append the new values to the existing set of values.  If it is not</span>
<a href="#l18.126"></a><span id="l18.126">    *  the same, we replace them.</span>
<a href="#l18.127"></a><span id="l18.127">    */</span>
<a href="#l18.128"></a><span id="l18.128" class="difflineminus">-  constrain: function(aInclusive, aGroupValues) {</span>
<a href="#l18.129"></a><span id="l18.129" class="difflineplus">+  constrain(aInclusive, aGroupValues) {</span>
<a href="#l18.130"></a><span id="l18.130">     let groupIdAttr = this.attrDef.objectNounDef.isPrimitive ? null</span>
<a href="#l18.131"></a><span id="l18.131">                         : this.facetDef.groupIdAttr;</span>
<a href="#l18.132"></a><span id="l18.132">     let idMap = aInclusive ? this.includedGroupIds</span>
<a href="#l18.133"></a><span id="l18.133">                            : this.excludedGroupIds;</span>
<a href="#l18.134"></a><span id="l18.134">     let valList = aInclusive ? this.includedGroupValues</span>
<a href="#l18.135"></a><span id="l18.135">                              : this.excludedGroupValues;</span>
<a href="#l18.136"></a><span id="l18.136">     for (let groupValue of aGroupValues) {</span>
<a href="#l18.137"></a><span id="l18.137">       let valId = (groupIdAttr !== null &amp;&amp; groupValue != null) ?</span>
<a href="#l18.138"></a><span id="l18.138" class="difflineat">@@ -206,17 +206,17 @@ ActiveNonSingularConstraint.prototype = </span>
<a href="#l18.139"></a><span id="l18.139">     return false;</span>
<a href="#l18.140"></a><span id="l18.140">   },</span>
<a href="#l18.141"></a><span id="l18.141">   /**</span>
<a href="#l18.142"></a><span id="l18.142">    * Relax something we previously constrained.  Remove it, some might say.  It</span>
<a href="#l18.143"></a><span id="l18.143">    *  is possible after relaxing that we will no longer be an active constraint.</span>
<a href="#l18.144"></a><span id="l18.144">    *</span>
<a href="#l18.145"></a><span id="l18.145">    * @return true if we are no longer constrained at all.</span>
<a href="#l18.146"></a><span id="l18.146">    */</span>
<a href="#l18.147"></a><span id="l18.147" class="difflineminus">-  relax: function(aInclusive, aGroupValues) {</span>
<a href="#l18.148"></a><span id="l18.148" class="difflineplus">+  relax(aInclusive, aGroupValues) {</span>
<a href="#l18.149"></a><span id="l18.149">     let groupIdAttr = this.attrDef.objectNounDef.isPrimitive ? null</span>
<a href="#l18.150"></a><span id="l18.150">                         : this.facetDef.groupIdAttr;</span>
<a href="#l18.151"></a><span id="l18.151">     let idMap = aInclusive ? this.includedGroupIds</span>
<a href="#l18.152"></a><span id="l18.152">                            : this.excludedGroupIds;</span>
<a href="#l18.153"></a><span id="l18.153">     let valList = aInclusive ? this.includedGroupValues</span>
<a href="#l18.154"></a><span id="l18.154">                              : this.excludedGroupValues;</span>
<a href="#l18.155"></a><span id="l18.155">     for (let groupValue of aGroupValues) {</span>
<a href="#l18.156"></a><span id="l18.156">       let valId = (groupIdAttr !== null &amp;&amp; groupValue != null) ?</span>
<a href="#l18.157"></a><span id="l18.157" class="difflineat">@@ -229,18 +229,17 @@ ActiveNonSingularConstraint.prototype = </span>
<a href="#l18.158"></a><span id="l18.158">       valList.splice(index, 1);</span>
<a href="#l18.159"></a><span id="l18.159">     }</span>
<a href="#l18.160"></a><span id="l18.160"> </span>
<a href="#l18.161"></a><span id="l18.161">     if (valList.length == 0) {</span>
<a href="#l18.162"></a><span id="l18.162">       if (aInclusive)</span>
<a href="#l18.163"></a><span id="l18.163">         this.includeQuery = null;</span>
<a href="#l18.164"></a><span id="l18.164">       else</span>
<a href="#l18.165"></a><span id="l18.165">         this.excludeQuery = null;</span>
<a href="#l18.166"></a><span id="l18.166" class="difflineminus">-    }</span>
<a href="#l18.167"></a><span id="l18.167" class="difflineminus">-    else {</span>
<a href="#l18.168"></a><span id="l18.168" class="difflineplus">+    } else {</span>
<a href="#l18.169"></a><span id="l18.169">       let [query, invertQuery] = this._makeQuery(aInclusive, valList);</span>
<a href="#l18.170"></a><span id="l18.170">       if (aInclusive &amp;&amp; !invertQuery)</span>
<a href="#l18.171"></a><span id="l18.171">         this.includeQuery = query;</span>
<a href="#l18.172"></a><span id="l18.172">       else</span>
<a href="#l18.173"></a><span id="l18.173">         this.excludeQuery = query;</span>
<a href="#l18.174"></a><span id="l18.174">     }</span>
<a href="#l18.175"></a><span id="l18.175"> </span>
<a href="#l18.176"></a><span id="l18.176">     return this.includeQuery == null &amp;&amp; this.excludeQuery == null;</span>
<a href="#l18.177"></a><span id="l18.177" class="difflineat">@@ -249,42 +248,42 @@ ActiveNonSingularConstraint.prototype = </span>
<a href="#l18.178"></a><span id="l18.178">    * Indicate whether this constraint is actually doing anything anymore.</span>
<a href="#l18.179"></a><span id="l18.179">    */</span>
<a href="#l18.180"></a><span id="l18.180">   get isConstrained() {</span>
<a href="#l18.181"></a><span id="l18.181">     return this.includeQuery == null &amp;&amp; this.excludeQuery == null;</span>
<a href="#l18.182"></a><span id="l18.182">   },</span>
<a href="#l18.183"></a><span id="l18.183">   /**</span>
<a href="#l18.184"></a><span id="l18.184">    * Clear the constraint so that the next call to adjust initializes it.</span>
<a href="#l18.185"></a><span id="l18.185">    */</span>
<a href="#l18.186"></a><span id="l18.186" class="difflineminus">-  clear: function() {</span>
<a href="#l18.187"></a><span id="l18.187" class="difflineplus">+  clear() {</span>
<a href="#l18.188"></a><span id="l18.188">     this.includeQuery = null;</span>
<a href="#l18.189"></a><span id="l18.189">     this.includedGroupIds = {};</span>
<a href="#l18.190"></a><span id="l18.190">     this.includedGroupValues = [];</span>
<a href="#l18.191"></a><span id="l18.191"> </span>
<a href="#l18.192"></a><span id="l18.192">     this.excludeQuery = null;</span>
<a href="#l18.193"></a><span id="l18.193">     this.excludedGroupIds = {};</span>
<a href="#l18.194"></a><span id="l18.194">     this.excludedGroupValues = [];</span>
<a href="#l18.195"></a><span id="l18.195">   },</span>
<a href="#l18.196"></a><span id="l18.196">   /**</span>
<a href="#l18.197"></a><span id="l18.197">    * Filter the items against our constraint.</span>
<a href="#l18.198"></a><span id="l18.198">    */</span>
<a href="#l18.199"></a><span id="l18.199" class="difflineminus">-  sieve: function(aItems) {</span>
<a href="#l18.200"></a><span id="l18.200" class="difflineplus">+  sieve(aItems) {</span>
<a href="#l18.201"></a><span id="l18.201">     let includeQuery = this.includeQuery;</span>
<a href="#l18.202"></a><span id="l18.202">     let excludeQuery = this.excludeQuery;</span>
<a href="#l18.203"></a><span id="l18.203">     return aItems.filter(item =&gt; (!includeQuery || includeQuery.test(item)) &amp;&amp;</span>
<a href="#l18.204"></a><span id="l18.204">                                  (!excludeQuery || !excludeQuery.test(item)));</span>
<a href="#l18.205"></a><span id="l18.205">   },</span>
<a href="#l18.206"></a><span id="l18.206" class="difflineminus">-  isIncludedGroup: function(aGroupValue) {</span>
<a href="#l18.207"></a><span id="l18.207" class="difflineplus">+  isIncludedGroup(aGroupValue) {</span>
<a href="#l18.208"></a><span id="l18.208">     let valId = aGroupValue[this.facetDef.groupIdAttr];</span>
<a href="#l18.209"></a><span id="l18.209">     return (valId in this.includedGroupIds);</span>
<a href="#l18.210"></a><span id="l18.210">   },</span>
<a href="#l18.211"></a><span id="l18.211" class="difflineminus">-  isExcludedGroup: function(aGroupValue) {</span>
<a href="#l18.212"></a><span id="l18.212" class="difflineplus">+  isExcludedGroup(aGroupValue) {</span>
<a href="#l18.213"></a><span id="l18.213">     let valId = aGroupValue[this.facetDef.groupIdAttr];</span>
<a href="#l18.214"></a><span id="l18.214">     return (valId in this.excludedGroupIds);</span>
<a href="#l18.215"></a><span id="l18.215" class="difflineminus">-  }</span>
<a href="#l18.216"></a><span id="l18.216" class="difflineplus">+  },</span>
<a href="#l18.217"></a><span id="l18.217"> };</span>
<a href="#l18.218"></a><span id="l18.218"> </span>
<a href="#l18.219"></a><span id="l18.219"> var FacetContext = {</span>
<a href="#l18.220"></a><span id="l18.220">   facetDriver: new FacetDriver(Gloda.lookupNounDef(&quot;message&quot;), window),</span>
<a href="#l18.221"></a><span id="l18.221"> </span>
<a href="#l18.222"></a><span id="l18.222">   /**</span>
<a href="#l18.223"></a><span id="l18.223">    * The root collection which our active set is a subset of.  We hold onto this</span>
<a href="#l18.224"></a><span id="l18.224">    *  for garbage collection reasons, although the tab that owns us should also</span>
<a href="#l18.225"></a><span id="l18.225" class="difflineat">@@ -322,52 +321,52 @@ var FacetContext = {</span>
<a href="#l18.226"></a><span id="l18.226"> </span>
<a href="#l18.227"></a><span id="l18.227">   /**</span>
<a href="#l18.228"></a><span id="l18.228">    * fullSet is a special attribute which is passed a set of items that we're</span>
<a href="#l18.229"></a><span id="l18.229">    * displaying, but the order of which is determined by the sortBy property.</span>
<a href="#l18.230"></a><span id="l18.230">    * On setting the fullSet, we compute both sorted lists, and then on getting,</span>
<a href="#l18.231"></a><span id="l18.231">    * we return the appropriate one.</span>
<a href="#l18.232"></a><span id="l18.232">    */</span>
<a href="#l18.233"></a><span id="l18.233">   get fullSet() {</span>
<a href="#l18.234"></a><span id="l18.234" class="difflineminus">-    return (this._sortBy == '-dascore' ?</span>
<a href="#l18.235"></a><span id="l18.235" class="difflineplus">+    return (this._sortBy == &quot;-dascore&quot; ?</span>
<a href="#l18.236"></a><span id="l18.236">             this._relevantSortedItems :</span>
<a href="#l18.237"></a><span id="l18.237">             this._dateSortedItems);</span>
<a href="#l18.238"></a><span id="l18.238">   },</span>
<a href="#l18.239"></a><span id="l18.239"> </span>
<a href="#l18.240"></a><span id="l18.240">   set fullSet(items) {</span>
<a href="#l18.241"></a><span id="l18.241">     let scores;</span>
<a href="#l18.242"></a><span id="l18.242">     if (this.searcher &amp;&amp; this.searcher.scores)</span>
<a href="#l18.243"></a><span id="l18.243">       scores = this.searcher.scores;</span>
<a href="#l18.244"></a><span id="l18.244">     else</span>
<a href="#l18.245"></a><span id="l18.245">       scores = Gloda.scoreNounItems(items);</span>
<a href="#l18.246"></a><span id="l18.246">     let scoredItems = items.map(function(item, index) { return [scores[index], item]; });</span>
<a href="#l18.247"></a><span id="l18.247" class="difflineminus">-    scoredItems.sort((a, b) =&gt; b[0]-a[0]);</span>
<a href="#l18.248"></a><span id="l18.248" class="difflineplus">+    scoredItems.sort((a, b) =&gt; b[0] - a[0]);</span>
<a href="#l18.249"></a><span id="l18.249">     this._relevantSortedItems = scoredItems.map(scoredItem =&gt; scoredItem[1]);</span>
<a href="#l18.250"></a><span id="l18.250"> </span>
<a href="#l18.251"></a><span id="l18.251">     this._dateSortedItems =</span>
<a href="#l18.252"></a><span id="l18.252" class="difflineminus">-      this._relevantSortedItems.concat().sort((a, b) =&gt; b.date-a.date);</span>
<a href="#l18.253"></a><span id="l18.253" class="difflineplus">+      this._relevantSortedItems.concat().sort((a, b) =&gt; b.date - a.date);</span>
<a href="#l18.254"></a><span id="l18.254">   },</span>
<a href="#l18.255"></a><span id="l18.255"> </span>
<a href="#l18.256"></a><span id="l18.256" class="difflineminus">-  initialBuild: function() {</span>
<a href="#l18.257"></a><span id="l18.257" class="difflineplus">+  initialBuild() {</span>
<a href="#l18.258"></a><span id="l18.258">     let queryExplanation = document.getElementById(&quot;query-explanation&quot;);</span>
<a href="#l18.259"></a><span id="l18.259">     if (this.searcher)</span>
<a href="#l18.260"></a><span id="l18.260">       queryExplanation.setFulltext(this.searcher);</span>
<a href="#l18.261"></a><span id="l18.261">     else</span>
<a href="#l18.262"></a><span id="l18.262">       queryExplanation.setQuery(this.collection.query);</span>
<a href="#l18.263"></a><span id="l18.263">     // we like to sort them so should clone the list</span>
<a href="#l18.264"></a><span id="l18.264">     this.faceters = this.facetDriver.faceters.concat();</span>
<a href="#l18.265"></a><span id="l18.265"> </span>
<a href="#l18.266"></a><span id="l18.266">     this._timelineShown = !Services.prefs.getBoolPref(&quot;gloda.facetview.hidetimeline&quot;);</span>
<a href="#l18.267"></a><span id="l18.267"> </span>
<a href="#l18.268"></a><span id="l18.268">     this.everFaceted = false;</span>
<a href="#l18.269"></a><span id="l18.269">     this._activeConstraints = {};</span>
<a href="#l18.270"></a><span id="l18.270">     if (this.searcher)</span>
<a href="#l18.271"></a><span id="l18.271" class="difflineminus">-      this._sortBy = '-dascore';</span>
<a href="#l18.272"></a><span id="l18.272" class="difflineplus">+      this._sortBy = &quot;-dascore&quot;;</span>
<a href="#l18.273"></a><span id="l18.273">     else</span>
<a href="#l18.274"></a><span id="l18.274" class="difflineminus">-      this._sortBy = '-date';</span>
<a href="#l18.275"></a><span id="l18.275" class="difflineplus">+      this._sortBy = &quot;-date&quot;;</span>
<a href="#l18.276"></a><span id="l18.276">     this.fullSet = this._removeDupes(this._collection.items.concat());</span>
<a href="#l18.277"></a><span id="l18.277">     if (&quot;IMCollection&quot; in this)</span>
<a href="#l18.278"></a><span id="l18.278">       this.fullSet = this.fullSet.concat(this.IMCollection.items);</span>
<a href="#l18.279"></a><span id="l18.279">     this.build(this.fullSet);</span>
<a href="#l18.280"></a><span id="l18.280">   },</span>
<a href="#l18.281"></a><span id="l18.281"> </span>
<a href="#l18.282"></a><span id="l18.282">   /**</span>
<a href="#l18.283"></a><span id="l18.283">    * Remove duplicate messages from search results.</span>
<a href="#l18.284"></a><span id="l18.284" class="difflineat">@@ -377,17 +376,17 @@ var FacetContext = {</span>
<a href="#l18.285"></a><span id="l18.285">    *</span>
<a href="#l18.286"></a><span id="l18.286">    * Some IMAP servers (here's looking at you, Gmail) will create message</span>
<a href="#l18.287"></a><span id="l18.287">    * duplicates unbeknownst to the user.  We'd like to deal with them earlier</span>
<a href="#l18.288"></a><span id="l18.288">    * in the pipeline, but that's a bit hard right now.  So as a workaround</span>
<a href="#l18.289"></a><span id="l18.289">    * we'd rather not show them in the Search Results UI.  The simplest way</span>
<a href="#l18.290"></a><span id="l18.290">    * of doing that is just to cull (from the display) messages with have the</span>
<a href="#l18.291"></a><span id="l18.291">    * Message-ID of a message already displayed.</span>
<a href="#l18.292"></a><span id="l18.292">    */</span>
<a href="#l18.293"></a><span id="l18.293" class="difflineminus">-  _removeDupes: function(aItems) {</span>
<a href="#l18.294"></a><span id="l18.294" class="difflineplus">+  _removeDupes(aItems) {</span>
<a href="#l18.295"></a><span id="l18.295">     let deduped = [];</span>
<a href="#l18.296"></a><span id="l18.296">     let msgIdsSeen = {};</span>
<a href="#l18.297"></a><span id="l18.297">     for (let item of aItems) {</span>
<a href="#l18.298"></a><span id="l18.298">       if (item.headerMessageID in msgIdsSeen)</span>
<a href="#l18.299"></a><span id="l18.299">         continue;</span>
<a href="#l18.300"></a><span id="l18.300">       deduped.push(item);</span>
<a href="#l18.301"></a><span id="l18.301">       msgIdsSeen[item.headerMessageID] = true;</span>
<a href="#l18.302"></a><span id="l18.302">     }</span>
<a href="#l18.303"></a><span id="l18.303" class="difflineat">@@ -395,54 +394,54 @@ var FacetContext = {</span>
<a href="#l18.304"></a><span id="l18.304">   },</span>
<a href="#l18.305"></a><span id="l18.305"> </span>
<a href="#l18.306"></a><span id="l18.306">   /**</span>
<a href="#l18.307"></a><span id="l18.307">    * Kick-off a new faceting pass.</span>
<a href="#l18.308"></a><span id="l18.308">    *</span>
<a href="#l18.309"></a><span id="l18.309">    * @param aNewSet the set of items to facet.</span>
<a href="#l18.310"></a><span id="l18.310">    * @param aCallback the callback to invoke when faceting is completed.</span>
<a href="#l18.311"></a><span id="l18.311">    */</span>
<a href="#l18.312"></a><span id="l18.312" class="difflineminus">-  build: function(aNewSet, aCallback) {</span>
<a href="#l18.313"></a><span id="l18.313" class="difflineplus">+  build(aNewSet, aCallback) {</span>
<a href="#l18.314"></a><span id="l18.314">     this._activeSet = aNewSet;</span>
<a href="#l18.315"></a><span id="l18.315">     this._callbackOnFacetComplete = aCallback;</span>
<a href="#l18.316"></a><span id="l18.316">     this.facetDriver.go(this._activeSet, this.facetingCompleted, this);</span>
<a href="#l18.317"></a><span id="l18.317">   },</span>
<a href="#l18.318"></a><span id="l18.318"> </span>
<a href="#l18.319"></a><span id="l18.319">   /**</span>
<a href="#l18.320"></a><span id="l18.320">    * Attempt to figure out a reasonable number of rows to limit each facet to</span>
<a href="#l18.321"></a><span id="l18.321">    *  display.  While the number will ordinarily be dominated by the maximum</span>
<a href="#l18.322"></a><span id="l18.322">    *  number of rows we believe the user can easily scan, this may also be</span>
<a href="#l18.323"></a><span id="l18.323">    *  impacted by layout concerns (since we want to avoid scrolling).</span>
<a href="#l18.324"></a><span id="l18.324">    */</span>
<a href="#l18.325"></a><span id="l18.325" class="difflineminus">-  planLayout: function() {</span>
<a href="#l18.326"></a><span id="l18.326" class="difflineplus">+  planLayout() {</span>
<a href="#l18.327"></a><span id="l18.327">     // XXX arbitrary!</span>
<a href="#l18.328"></a><span id="l18.328">     this.maxDisplayRows = 8;</span>
<a href="#l18.329"></a><span id="l18.329">     this.maxMessagesToShow = 10;</span>
<a href="#l18.330"></a><span id="l18.330">   },</span>
<a href="#l18.331"></a><span id="l18.331"> </span>
<a href="#l18.332"></a><span id="l18.332">   /**</span>
<a href="#l18.333"></a><span id="l18.333">    * Clean up the UI in preparation for a new query to come in.</span>
<a href="#l18.334"></a><span id="l18.334">    */</span>
<a href="#l18.335"></a><span id="l18.335" class="difflineminus">-  _resetUI: function() {</span>
<a href="#l18.336"></a><span id="l18.336" class="difflineplus">+  _resetUI() {</span>
<a href="#l18.337"></a><span id="l18.337">     for (let faceter of this.faceters) {</span>
<a href="#l18.338"></a><span id="l18.338">       if (faceter.xblNode &amp;&amp; !faceter.xblNode.explicit)</span>
<a href="#l18.339"></a><span id="l18.339">         faceter.xblNode.remove();</span>
<a href="#l18.340"></a><span id="l18.340">       faceter.xblNode = null;</span>
<a href="#l18.341"></a><span id="l18.341">       faceter.constraint = null;</span>
<a href="#l18.342"></a><span id="l18.342">     }</span>
<a href="#l18.343"></a><span id="l18.343">   },</span>
<a href="#l18.344"></a><span id="l18.344"> </span>
<a href="#l18.345"></a><span id="l18.345" class="difflineminus">-  _groupCountComparator: function(a, b) {</span>
<a href="#l18.346"></a><span id="l18.346" class="difflineplus">+  _groupCountComparator(a, b) {</span>
<a href="#l18.347"></a><span id="l18.347">     return b.groupCount - a.groupCount;</span>
<a href="#l18.348"></a><span id="l18.348">   },</span>
<a href="#l18.349"></a><span id="l18.349">   /**</span>
<a href="#l18.350"></a><span id="l18.350">    * Tells the UI about all the facets when notified by the |facetDriver| when</span>
<a href="#l18.351"></a><span id="l18.351">    *  it is done faceting everything.</span>
<a href="#l18.352"></a><span id="l18.352">    */</span>
<a href="#l18.353"></a><span id="l18.353" class="difflineminus">-  facetingCompleted: function() {</span>
<a href="#l18.354"></a><span id="l18.354" class="difflineplus">+  facetingCompleted() {</span>
<a href="#l18.355"></a><span id="l18.355">     this.planLayout();</span>
<a href="#l18.356"></a><span id="l18.356"> </span>
<a href="#l18.357"></a><span id="l18.357">     let uiFacets = document.getElementById(&quot;facets&quot;);</span>
<a href="#l18.358"></a><span id="l18.358"> </span>
<a href="#l18.359"></a><span id="l18.359">     if (!this.everFaceted) {</span>
<a href="#l18.360"></a><span id="l18.360">       this.everFaceted = true;</span>
<a href="#l18.361"></a><span id="l18.361">       this.faceters.sort(this._groupCountComparator);</span>
<a href="#l18.362"></a><span id="l18.362">       for (let faceter of this.faceters) {</span>
<a href="#l18.363"></a><span id="l18.363" class="difflineat">@@ -473,114 +472,108 @@ var FacetContext = {</span>
<a href="#l18.364"></a><span id="l18.364"> </span>
<a href="#l18.365"></a><span id="l18.365">         // ignore facets that do not vary!</span>
<a href="#l18.366"></a><span id="l18.366">         if (faceter.groupCount &lt;= 1) {</span>
<a href="#l18.367"></a><span id="l18.367">           faceter.xblNode = null;</span>
<a href="#l18.368"></a><span id="l18.368">           continue;</span>
<a href="#l18.369"></a><span id="l18.369">         }</span>
<a href="#l18.370"></a><span id="l18.370"> </span>
<a href="#l18.371"></a><span id="l18.371">         faceter.xblNode = uiFacets.addFacet(faceter.type, faceter.attrDef, {</span>
<a href="#l18.372"></a><span id="l18.372" class="difflineminus">-          faceter: faceter,</span>
<a href="#l18.373"></a><span id="l18.373" class="difflineplus">+          faceter,</span>
<a href="#l18.374"></a><span id="l18.374">           facetDef: faceter.facetDef,</span>
<a href="#l18.375"></a><span id="l18.375">           orderedGroups: faceter.orderedGroups,</span>
<a href="#l18.376"></a><span id="l18.376">           maxDisplayRows: this.maxDisplayRows,</span>
<a href="#l18.377"></a><span id="l18.377" class="difflineminus">-          explicit: false</span>
<a href="#l18.378"></a><span id="l18.378" class="difflineplus">+          explicit: false,</span>
<a href="#l18.379"></a><span id="l18.379">         });</span>
<a href="#l18.380"></a><span id="l18.380">       }</span>
<a href="#l18.381"></a><span id="l18.381" class="difflineminus">-    }</span>
<a href="#l18.382"></a><span id="l18.382" class="difflineminus">-    else {</span>
<a href="#l18.383"></a><span id="l18.383" class="difflineplus">+    } else {</span>
<a href="#l18.384"></a><span id="l18.384">       for (let faceter of this.faceters) {</span>
<a href="#l18.385"></a><span id="l18.385">         // Do not bother with un-displayed facets, or that are locked by a</span>
<a href="#l18.386"></a><span id="l18.386">         //  constraint.  But do bother if the widget can be updated without</span>
<a href="#l18.387"></a><span id="l18.387">         //  losing important data.</span>
<a href="#l18.388"></a><span id="l18.388">         if (!faceter.xblNode ||</span>
<a href="#l18.389"></a><span id="l18.389">             (faceter.constraint &amp;&amp; !faceter.xblNode.canUpdate))</span>
<a href="#l18.390"></a><span id="l18.390">           continue;</span>
<a href="#l18.391"></a><span id="l18.391"> </span>
<a href="#l18.392"></a><span id="l18.392">         // hide things that have 0/1 groups now and are not constrained and not</span>
<a href="#l18.393"></a><span id="l18.393">         //  explicit</span>
<a href="#l18.394"></a><span id="l18.394">         if (faceter.groupCount &lt;= 1 &amp;&amp; !faceter.constraint &amp;&amp;</span>
<a href="#l18.395"></a><span id="l18.395" class="difflineminus">-            (!faceter.xblNode.explicit || faceter.type == &quot;date&quot;))</span>
<a href="#l18.396"></a><span id="l18.396" class="difflineplus">+            (!faceter.xblNode.explicit || faceter.type == &quot;date&quot;)) {</span>
<a href="#l18.397"></a><span id="l18.397">           faceter.xblNode.style.display = &quot;none&quot;;</span>
<a href="#l18.398"></a><span id="l18.398" class="difflineminus">-        // otherwise, update</span>
<a href="#l18.399"></a><span id="l18.399" class="difflineminus">-        else {</span>
<a href="#l18.400"></a><span id="l18.400" class="difflineplus">+        } else { // otherwise, update</span>
<a href="#l18.401"></a><span id="l18.401">           faceter.xblNode.orderedGroups = faceter.orderedGroups;</span>
<a href="#l18.402"></a><span id="l18.402">           faceter.xblNode.build(false);</span>
<a href="#l18.403"></a><span id="l18.403">           faceter.xblNode.style.display = &quot;block&quot;;</span>
<a href="#l18.404"></a><span id="l18.404">         }</span>
<a href="#l18.405"></a><span id="l18.405">       }</span>
<a href="#l18.406"></a><span id="l18.406">     }</span>
<a href="#l18.407"></a><span id="l18.407"> </span>
<a href="#l18.408"></a><span id="l18.408" class="difflineminus">-    if (! this._timelineShown)</span>
<a href="#l18.409"></a><span id="l18.409" class="difflineplus">+    if (!this._timelineShown)</span>
<a href="#l18.410"></a><span id="l18.410">       this._hideTimeline(true);</span>
<a href="#l18.411"></a><span id="l18.411"> </span>
<a href="#l18.412"></a><span id="l18.412">     this._showResults();</span>
<a href="#l18.413"></a><span id="l18.413"> </span>
<a href="#l18.414"></a><span id="l18.414">     if (this._callbackOnFacetComplete) {</span>
<a href="#l18.415"></a><span id="l18.415">       let callback = this._callbackOnFacetComplete;</span>
<a href="#l18.416"></a><span id="l18.416">       this._callbackOnFacetComplete = null;</span>
<a href="#l18.417"></a><span id="l18.417">       callback();</span>
<a href="#l18.418"></a><span id="l18.418">     }</span>
<a href="#l18.419"></a><span id="l18.419">   },</span>
<a href="#l18.420"></a><span id="l18.420"> </span>
<a href="#l18.421"></a><span id="l18.421" class="difflineminus">-  _showResults: function()</span>
<a href="#l18.422"></a><span id="l18.422" class="difflineminus">-  {</span>
<a href="#l18.423"></a><span id="l18.423" class="difflineplus">+  _showResults() {</span>
<a href="#l18.424"></a><span id="l18.424">     let results = document.getElementById(&quot;results&quot;);</span>
<a href="#l18.425"></a><span id="l18.425">     let numMessageToShow = Math.min(this.maxMessagesToShow * this._numPages,</span>
<a href="#l18.426"></a><span id="l18.426">                                     this._activeSet.length);</span>
<a href="#l18.427"></a><span id="l18.427">     results.setMessages(this._activeSet.slice(0, numMessageToShow));</span>
<a href="#l18.428"></a><span id="l18.428"> </span>
<a href="#l18.429"></a><span id="l18.429">     let showLoading = document.getElementById(&quot;showLoading&quot;);</span>
<a href="#l18.430"></a><span id="l18.430">     showLoading.style.display = &quot;none&quot;; /* hide spinner, we're done thinking */</span>
<a href="#l18.431"></a><span id="l18.431"> </span>
<a href="#l18.432"></a><span id="l18.432">     let showEmpty = document.getElementById(&quot;showEmpty&quot;);</span>
<a href="#l18.433"></a><span id="l18.433">     let dateToggle = document.getElementById(&quot;date-toggle&quot;);</span>
<a href="#l18.434"></a><span id="l18.434">     /* check for no messages at all */</span>
<a href="#l18.435"></a><span id="l18.435">     if (this._activeSet.length == 0) {</span>
<a href="#l18.436"></a><span id="l18.436">       showEmpty.style.display = &quot;block&quot;;</span>
<a href="#l18.437"></a><span id="l18.437">       dateToggle.style.display = &quot;none&quot;;</span>
<a href="#l18.438"></a><span id="l18.438" class="difflineminus">-    }</span>
<a href="#l18.439"></a><span id="l18.439" class="difflineminus">-    else {</span>
<a href="#l18.440"></a><span id="l18.440" class="difflineplus">+    } else {</span>
<a href="#l18.441"></a><span id="l18.441">       showEmpty.style.display = &quot;none&quot;;</span>
<a href="#l18.442"></a><span id="l18.442">       dateToggle.style.display = &quot;block&quot;;</span>
<a href="#l18.443"></a><span id="l18.443">     }</span>
<a href="#l18.444"></a><span id="l18.444"> </span>
<a href="#l18.445"></a><span id="l18.445">     let showMore = document.getElementById(&quot;showMore&quot;);</span>
<a href="#l18.446"></a><span id="l18.446">     if (this._activeSet.length &gt; numMessageToShow)</span>
<a href="#l18.447"></a><span id="l18.447">       showMore.style.display = &quot;block&quot;;</span>
<a href="#l18.448"></a><span id="l18.448">     else</span>
<a href="#l18.449"></a><span id="l18.449">       showMore.style.display = &quot;none&quot;;</span>
<a href="#l18.450"></a><span id="l18.450">   },</span>
<a href="#l18.451"></a><span id="l18.451"> </span>
<a href="#l18.452"></a><span id="l18.452" class="difflineminus">-  showMore: function() {</span>
<a href="#l18.453"></a><span id="l18.453" class="difflineplus">+  showMore() {</span>
<a href="#l18.454"></a><span id="l18.454">     this._numPages += 1;</span>
<a href="#l18.455"></a><span id="l18.455">     this._showResults();</span>
<a href="#l18.456"></a><span id="l18.456" class="difflineminus">-    let results = document.getElementById(&quot;results&quot;);</span>
<a href="#l18.457"></a><span id="l18.457">   },</span>
<a href="#l18.458"></a><span id="l18.458"> </span>
<a href="#l18.459"></a><span id="l18.459" class="difflineminus">-</span>
<a href="#l18.460"></a><span id="l18.460" class="difflineminus">-  zoomOut: function() {</span>
<a href="#l18.461"></a><span id="l18.461" class="difflineminus">-    let facetDate = document.getElementById('facet-date');</span>
<a href="#l18.462"></a><span id="l18.462" class="difflineminus">-    this.removeFacetConstraint(facetDate.faceter, true, facetDate.vis.constraints)</span>
<a href="#l18.463"></a><span id="l18.463" class="difflineplus">+  zoomOut() {</span>
<a href="#l18.464"></a><span id="l18.464" class="difflineplus">+    let facetDate = document.getElementById(&quot;facet-date&quot;);</span>
<a href="#l18.465"></a><span id="l18.465" class="difflineplus">+    this.removeFacetConstraint(facetDate.faceter, true, facetDate.vis.constraints);</span>
<a href="#l18.466"></a><span id="l18.466">     facetDate.setAttribute(&quot;zoomedout&quot;, &quot;true&quot;);</span>
<a href="#l18.467"></a><span id="l18.467">   },</span>
<a href="#l18.468"></a><span id="l18.468"> </span>
<a href="#l18.469"></a><span id="l18.469" class="difflineminus">-  toggleTimeline: function() {</span>
<a href="#l18.470"></a><span id="l18.470" class="difflineplus">+  toggleTimeline() {</span>
<a href="#l18.471"></a><span id="l18.471">     try {</span>
<a href="#l18.472"></a><span id="l18.472" class="difflineminus">-      this._timelineShown = ! this._timelineShown;</span>
<a href="#l18.473"></a><span id="l18.473" class="difflineplus">+      this._timelineShown = !this._timelineShown;</span>
<a href="#l18.474"></a><span id="l18.474">       if (this._timelineShown)</span>
<a href="#l18.475"></a><span id="l18.475">         this._showTimeline();</span>
<a href="#l18.476"></a><span id="l18.476">       else</span>
<a href="#l18.477"></a><span id="l18.477">         this._hideTimeline(false);</span>
<a href="#l18.478"></a><span id="l18.478">     } catch (e) {</span>
<a href="#l18.479"></a><span id="l18.479">       logException(e);</span>
<a href="#l18.480"></a><span id="l18.480">     }</span>
<a href="#l18.481"></a><span id="l18.481">   },</span>
<a href="#l18.482"></a><span id="l18.482"> </span>
<a href="#l18.483"></a><span id="l18.483" class="difflineminus">-  _showTimeline: function() {</span>
<a href="#l18.484"></a><span id="l18.484" class="difflineplus">+  _showTimeline() {</span>
<a href="#l18.485"></a><span id="l18.485">     let facetDate = document.getElementById(&quot;facet-date&quot;);</span>
<a href="#l18.486"></a><span id="l18.486">     if (facetDate.style.display == &quot;none&quot;) {</span>
<a href="#l18.487"></a><span id="l18.487">       facetDate.style.display = &quot;inherit&quot;;</span>
<a href="#l18.488"></a><span id="l18.488">       // Force binding attachment so the transition to the</span>
<a href="#l18.489"></a><span id="l18.489">       // visible state actually happens.</span>
<a href="#l18.490"></a><span id="l18.490">       facetDate.getBoundingClientRect();</span>
<a href="#l18.491"></a><span id="l18.491">     }</span>
<a href="#l18.492"></a><span id="l18.492">     let listener = () =&gt; {</span>
<a href="#l18.493"></a><span id="l18.493" class="difflineat">@@ -590,17 +583,17 @@ var FacetContext = {</span>
<a href="#l18.494"></a><span id="l18.494">       facetDate.removeAttribute(&quot;style&quot;);</span>
<a href="#l18.495"></a><span id="l18.495">     };</span>
<a href="#l18.496"></a><span id="l18.496">     facetDate.addEventListener(&quot;transitionend&quot;, listener, {once: true});</span>
<a href="#l18.497"></a><span id="l18.497">     facetDate.removeAttribute(&quot;hide&quot;);</span>
<a href="#l18.498"></a><span id="l18.498">     document.getElementById(&quot;date-toggle&quot;).removeAttribute(&quot;tucked&quot;);</span>
<a href="#l18.499"></a><span id="l18.499">     Services.prefs.setBoolPref(&quot;gloda.facetview.hidetimeline&quot;, false);</span>
<a href="#l18.500"></a><span id="l18.500">   },</span>
<a href="#l18.501"></a><span id="l18.501"> </span>
<a href="#l18.502"></a><span id="l18.502" class="difflineminus">-  _hideTimeline: function(immediate) {</span>
<a href="#l18.503"></a><span id="l18.503" class="difflineplus">+  _hideTimeline(immediate) {</span>
<a href="#l18.504"></a><span id="l18.504">     let facetDate = document.getElementById(&quot;facet-date&quot;);</span>
<a href="#l18.505"></a><span id="l18.505">     if (immediate)</span>
<a href="#l18.506"></a><span id="l18.506">       facetDate.style.display = &quot;none&quot;;</span>
<a href="#l18.507"></a><span id="l18.507">     facetDate.style.overflow = &quot;hidden&quot;;</span>
<a href="#l18.508"></a><span id="l18.508">     facetDate.setAttribute(&quot;hide&quot;, &quot;true&quot;);</span>
<a href="#l18.509"></a><span id="l18.509">     document.getElementById(&quot;date-toggle&quot;).setAttribute(&quot;tucked&quot;, &quot;true&quot;);</span>
<a href="#l18.510"></a><span id="l18.510">     Services.prefs.setBoolPref(&quot;gloda.facetview.hidetimeline&quot;, true);</span>
<a href="#l18.511"></a><span id="l18.511">   },</span>
<a href="#l18.512"></a><span id="l18.512" class="difflineat">@@ -613,47 +606,47 @@ var FacetContext = {</span>
<a href="#l18.513"></a><span id="l18.513">   fakeResultAttr: {},</span>
<a href="#l18.514"></a><span id="l18.514"> </span>
<a href="#l18.515"></a><span id="l18.515">   _numPages: 1,</span>
<a href="#l18.516"></a><span id="l18.516">   _HOVER_STABILITY_DURATION_MS: 100,</span>
<a href="#l18.517"></a><span id="l18.517">   _brushedFacet: null,</span>
<a href="#l18.518"></a><span id="l18.518">   _brushedGroup: null,</span>
<a href="#l18.519"></a><span id="l18.519">   _brushedItems: null,</span>
<a href="#l18.520"></a><span id="l18.520">   _brushTimeout: null,</span>
<a href="#l18.521"></a><span id="l18.521" class="difflineminus">-  hoverFacet: function(aFaceter, aAttrDef, aGroupValue, aGroupItems) {</span>
<a href="#l18.522"></a><span id="l18.522" class="difflineplus">+  hoverFacet(aFaceter, aAttrDef, aGroupValue, aGroupItems) {</span>
<a href="#l18.523"></a><span id="l18.523">     // bail if we are already brushing this item</span>
<a href="#l18.524"></a><span id="l18.524">     if (this._brushedFacet == aFaceter &amp;&amp; this._brushedGroup == aGroupValue)</span>
<a href="#l18.525"></a><span id="l18.525">       return;</span>
<a href="#l18.526"></a><span id="l18.526"> </span>
<a href="#l18.527"></a><span id="l18.527">     this._brushedFacet = aFaceter;</span>
<a href="#l18.528"></a><span id="l18.528">     this._brushedGroup = aGroupValue;</span>
<a href="#l18.529"></a><span id="l18.529">     this._brushedItems = aGroupItems;</span>
<a href="#l18.530"></a><span id="l18.530"> </span>
<a href="#l18.531"></a><span id="l18.531">     if (this._brushTimeout != null)</span>
<a href="#l18.532"></a><span id="l18.532">       clearTimeout(this._brushTimeout);</span>
<a href="#l18.533"></a><span id="l18.533">     this._brushTimeout = setTimeout(this._timeoutHoverWrapper,</span>
<a href="#l18.534"></a><span id="l18.534">                                     this._HOVER_STABILITY_DURATION_MS, this);</span>
<a href="#l18.535"></a><span id="l18.535"> </span>
<a href="#l18.536"></a><span id="l18.536">   },</span>
<a href="#l18.537"></a><span id="l18.537" class="difflineminus">-  _timeoutHover: function() {</span>
<a href="#l18.538"></a><span id="l18.538" class="difflineplus">+  _timeoutHover() {</span>
<a href="#l18.539"></a><span id="l18.539">     this._brushTimeout = null;</span>
<a href="#l18.540"></a><span id="l18.540">     for (let faceter of this.faceters) {</span>
<a href="#l18.541"></a><span id="l18.541">       if (faceter == this._brushedFacet || !faceter.xblNode)</span>
<a href="#l18.542"></a><span id="l18.542">         continue;</span>
<a href="#l18.543"></a><span id="l18.543"> </span>
<a href="#l18.544"></a><span id="l18.544">       if (this._brushedItems != null)</span>
<a href="#l18.545"></a><span id="l18.545">         faceter.xblNode.brushItems(this._brushedItems);</span>
<a href="#l18.546"></a><span id="l18.546">       else</span>
<a href="#l18.547"></a><span id="l18.547">         faceter.xblNode.clearBrushedItems();</span>
<a href="#l18.548"></a><span id="l18.548">     }</span>
<a href="#l18.549"></a><span id="l18.549">   },</span>
<a href="#l18.550"></a><span id="l18.550" class="difflineminus">-  _timeoutHoverWrapper: function(aThis) {</span>
<a href="#l18.551"></a><span id="l18.551" class="difflineplus">+  _timeoutHoverWrapper(aThis) {</span>
<a href="#l18.552"></a><span id="l18.552">     aThis._timeoutHover();</span>
<a href="#l18.553"></a><span id="l18.553">   },</span>
<a href="#l18.554"></a><span id="l18.554" class="difflineminus">-  unhoverFacet: function(aFaceter, aAttrDef, aGroupValue, aGroupItems) {</span>
<a href="#l18.555"></a><span id="l18.555" class="difflineplus">+  unhoverFacet(aFaceter, aAttrDef, aGroupValue, aGroupItems) {</span>
<a href="#l18.556"></a><span id="l18.556">     // have we already brushed from some other source already?  ignore then.</span>
<a href="#l18.557"></a><span id="l18.557">     if (this._brushedFacet != aFaceter || this._brushedGroup != aGroupValue)</span>
<a href="#l18.558"></a><span id="l18.558">       return;</span>
<a href="#l18.559"></a><span id="l18.559"> </span>
<a href="#l18.560"></a><span id="l18.560">     // reuse hover facet to null everyone out</span>
<a href="#l18.561"></a><span id="l18.561">     this.hoverFacet(null, null, null, null);</span>
<a href="#l18.562"></a><span id="l18.562">   },</span>
<a href="#l18.563"></a><span id="l18.563"> </span>
<a href="#l18.564"></a><span id="l18.564" class="difflineat">@@ -687,30 +680,28 @@ var FacetContext = {</span>
<a href="#l18.565"></a><span id="l18.565">    *     a date constraint applied.)</span>
<a href="#l18.566"></a><span id="l18.566">    * @param [aCallback] The callback to call once (re-)faceting has completed.</span>
<a href="#l18.567"></a><span id="l18.567">    *</span>
<a href="#l18.568"></a><span id="l18.568">    * @return true if the caller needs to revalidate because the constraint has</span>
<a href="#l18.569"></a><span id="l18.569">    *     changed in a way other than explicitly requested.  This can occur if</span>
<a href="#l18.570"></a><span id="l18.570">    *     a singular constraint flips its inclusive state and throws away</span>
<a href="#l18.571"></a><span id="l18.571">    *     constraints.</span>
<a href="#l18.572"></a><span id="l18.572">    */</span>
<a href="#l18.573"></a><span id="l18.573" class="difflineminus">-  addFacetConstraint: function(aFaceter, aInclusive, aGroupValues,</span>
<a href="#l18.574"></a><span id="l18.574" class="difflineminus">-                               aRanged, aNukeExisting, aCallback) {</span>
<a href="#l18.575"></a><span id="l18.575" class="difflineplus">+  addFacetConstraint(aFaceter, aInclusive, aGroupValues, aRanged, aNukeExisting, aCallback) {</span>
<a href="#l18.576"></a><span id="l18.576">     let attrName = aFaceter.attrDef.attributeName;</span>
<a href="#l18.577"></a><span id="l18.577"> </span>
<a href="#l18.578"></a><span id="l18.578">     let constraint;</span>
<a href="#l18.579"></a><span id="l18.579">     let needToSieveAll = false;</span>
<a href="#l18.580"></a><span id="l18.580">     if (attrName in this._activeConstraints) {</span>
<a href="#l18.581"></a><span id="l18.581">       constraint = this._activeConstraints[attrName];</span>
<a href="#l18.582"></a><span id="l18.582"> </span>
<a href="#l18.583"></a><span id="l18.583">       needToSieveAll = true;</span>
<a href="#l18.584"></a><span id="l18.584">       if (aNukeExisting)</span>
<a href="#l18.585"></a><span id="l18.585">         constraint.clear();</span>
<a href="#l18.586"></a><span id="l18.586" class="difflineminus">-    }</span>
<a href="#l18.587"></a><span id="l18.587" class="difflineminus">-    else {</span>
<a href="#l18.588"></a><span id="l18.588" class="difflineplus">+    } else {</span>
<a href="#l18.589"></a><span id="l18.589">       let constraintClass = aFaceter.attrDef.singular ? ActiveSingularConstraint</span>
<a href="#l18.590"></a><span id="l18.590">                               : ActiveNonSingularConstraint;</span>
<a href="#l18.591"></a><span id="l18.591">       constraint = this._activeConstraints[attrName] =</span>
<a href="#l18.592"></a><span id="l18.592">         new constraintClass(aFaceter, aRanged);</span>
<a href="#l18.593"></a><span id="l18.593">       aFaceter.constraint = constraint;</span>
<a href="#l18.594"></a><span id="l18.594">     }</span>
<a href="#l18.595"></a><span id="l18.595">     let needToRevalidate = constraint.constrain(aInclusive, aGroupValues);</span>
<a href="#l18.596"></a><span id="l18.596"> </span>
<a href="#l18.597"></a><span id="l18.597" class="difflineat">@@ -739,18 +730,17 @@ var FacetContext = {</span>
<a href="#l18.598"></a><span id="l18.598">    * @param aGroupValues The list of group values to remove.</span>
<a href="#l18.599"></a><span id="l18.599">    * @param aCallback The callback to call once all facets have been updated.</span>
<a href="#l18.600"></a><span id="l18.600">    *</span>
<a href="#l18.601"></a><span id="l18.601">    * @return true if the constraint has been completely removed.  Under the</span>
<a href="#l18.602"></a><span id="l18.602">    *     current regime, this will likely cause the binding that is calling us</span>
<a href="#l18.603"></a><span id="l18.603">    *     to be rebuilt, so be aware if you are trying to do any cool animation</span>
<a href="#l18.604"></a><span id="l18.604">    *     that might no longer make sense.</span>
<a href="#l18.605"></a><span id="l18.605">    */</span>
<a href="#l18.606"></a><span id="l18.606" class="difflineminus">-  removeFacetConstraint: function(aFaceter, aInclusive, aGroupValues,</span>
<a href="#l18.607"></a><span id="l18.607" class="difflineminus">-                                  aCallback) {</span>
<a href="#l18.608"></a><span id="l18.608" class="difflineplus">+  removeFacetConstraint(aFaceter, aInclusive, aGroupValues, aCallback) {</span>
<a href="#l18.609"></a><span id="l18.609">     let attrName = aFaceter.attrDef.attributeName;</span>
<a href="#l18.610"></a><span id="l18.610">     let constraint = this._activeConstraints[attrName];</span>
<a href="#l18.611"></a><span id="l18.611"> </span>
<a href="#l18.612"></a><span id="l18.612">     let constraintGone = false;</span>
<a href="#l18.613"></a><span id="l18.613"> </span>
<a href="#l18.614"></a><span id="l18.614">     if (constraint.relax(aInclusive, aGroupValues)) {</span>
<a href="#l18.615"></a><span id="l18.615">       delete this._activeConstraints[attrName];</span>
<a href="#l18.616"></a><span id="l18.616">       aFaceter.constraint = null;</span>
<a href="#l18.617"></a><span id="l18.617" class="difflineat">@@ -762,99 +752,99 @@ var FacetContext = {</span>
<a href="#l18.618"></a><span id="l18.618"> </span>
<a href="#l18.619"></a><span id="l18.619">     return constraintGone;</span>
<a href="#l18.620"></a><span id="l18.620">   },</span>
<a href="#l18.621"></a><span id="l18.621"> </span>
<a href="#l18.622"></a><span id="l18.622">   /**</span>
<a href="#l18.623"></a><span id="l18.623">    * Sieve the items from the underlying collection against all constraints,</span>
<a href="#l18.624"></a><span id="l18.624">    *  returning the value.</span>
<a href="#l18.625"></a><span id="l18.625">    */</span>
<a href="#l18.626"></a><span id="l18.626" class="difflineminus">-  _sieveAll: function() {</span>
<a href="#l18.627"></a><span id="l18.627" class="difflineplus">+  _sieveAll() {</span>
<a href="#l18.628"></a><span id="l18.628">     let items = this.fullSet;</span>
<a href="#l18.629"></a><span id="l18.629"> </span>
<a href="#l18.630"></a><span id="l18.630">     for (let elem in this._activeConstraints) {</span>
<a href="#l18.631"></a><span id="l18.631">       items = this._activeConstraints[elem].sieve(items);</span>
<a href="#l18.632"></a><span id="l18.632">     }</span>
<a href="#l18.633"></a><span id="l18.633"> </span>
<a href="#l18.634"></a><span id="l18.634">     return items;</span>
<a href="#l18.635"></a><span id="l18.635">   },</span>
<a href="#l18.636"></a><span id="l18.636"> </span>
<a href="#l18.637"></a><span id="l18.637" class="difflineminus">-  toggleFulltextCriteria: function() {</span>
<a href="#l18.638"></a><span id="l18.638" class="difflineplus">+  toggleFulltextCriteria() {</span>
<a href="#l18.639"></a><span id="l18.639">     this.tab.searcher.andTerms = !this.tab.searcher.andTerms;</span>
<a href="#l18.640"></a><span id="l18.640">     this._resetUI();</span>
<a href="#l18.641"></a><span id="l18.641">     this.collection = this.tab.searcher.getCollection(this);</span>
<a href="#l18.642"></a><span id="l18.642">   },</span>
<a href="#l18.643"></a><span id="l18.643"> </span>
<a href="#l18.644"></a><span id="l18.644">   /**</span>
<a href="#l18.645"></a><span id="l18.645">    * Show the active message set in a glodaList tab.</span>
<a href="#l18.646"></a><span id="l18.646">    */</span>
<a href="#l18.647"></a><span id="l18.647" class="difflineminus">-  showActiveSetInTab: function() {</span>
<a href="#l18.648"></a><span id="l18.648" class="difflineplus">+  showActiveSetInTab() {</span>
<a href="#l18.649"></a><span id="l18.649">     let tabmail = this.rootWin.document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l18.650"></a><span id="l18.650">     tabmail.openTab(&quot;glodaList&quot;, {</span>
<a href="#l18.651"></a><span id="l18.651">       collection: Gloda.explicitCollection(Gloda.NOUN_MESSAGE, this.activeSet),</span>
<a href="#l18.652"></a><span id="l18.652" class="difflineminus">-      title: this.tab.title</span>
<a href="#l18.653"></a><span id="l18.653" class="difflineplus">+      title: this.tab.title,</span>
<a href="#l18.654"></a><span id="l18.654">     });</span>
<a href="#l18.655"></a><span id="l18.655">   },</span>
<a href="#l18.656"></a><span id="l18.656"> </span>
<a href="#l18.657"></a><span id="l18.657">   /**</span>
<a href="#l18.658"></a><span id="l18.658">    * Show the conversation in a new glodaList tab.</span>
<a href="#l18.659"></a><span id="l18.659">    *</span>
<a href="#l18.660"></a><span id="l18.660">    * @param {glodaFacetBindings.xml#result-message} aResultMessage The</span>
<a href="#l18.661"></a><span id="l18.661">    *     result the user wants to see in more details.</span>
<a href="#l18.662"></a><span id="l18.662">    * @param {Boolean} [aBackground] Whether it should be in the background.</span>
<a href="#l18.663"></a><span id="l18.663">    */</span>
<a href="#l18.664"></a><span id="l18.664" class="difflineminus">-  showConversationInTab: function(aResultMessage, aBackground) {</span>
<a href="#l18.665"></a><span id="l18.665" class="difflineplus">+  showConversationInTab(aResultMessage, aBackground) {</span>
<a href="#l18.666"></a><span id="l18.666">     let tabmail = this.rootWin.document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l18.667"></a><span id="l18.667">     let message = aResultMessage.message;</span>
<a href="#l18.668"></a><span id="l18.668">     if (&quot;IMCollection&quot; in this &amp;&amp;</span>
<a href="#l18.669"></a><span id="l18.669">         message instanceof Gloda.lookupNounDef(&quot;im-conversation&quot;).clazz) {</span>
<a href="#l18.670"></a><span id="l18.670">       tabmail.openTab(&quot;chat&quot;, {</span>
<a href="#l18.671"></a><span id="l18.671">         convType: &quot;log&quot;,</span>
<a href="#l18.672"></a><span id="l18.672">         conv: message,</span>
<a href="#l18.673"></a><span id="l18.673">         searchTerm: aResultMessage.firstMatchText,</span>
<a href="#l18.674"></a><span id="l18.674" class="difflineminus">-        background: aBackground</span>
<a href="#l18.675"></a><span id="l18.675" class="difflineplus">+        background: aBackground,</span>
<a href="#l18.676"></a><span id="l18.676">       });</span>
<a href="#l18.677"></a><span id="l18.677">       return;</span>
<a href="#l18.678"></a><span id="l18.678">     }</span>
<a href="#l18.679"></a><span id="l18.679">     tabmail.openTab(&quot;glodaList&quot;, {</span>
<a href="#l18.680"></a><span id="l18.680">       conversation: message.conversation,</span>
<a href="#l18.681"></a><span id="l18.681" class="difflineminus">-      message: message,</span>
<a href="#l18.682"></a><span id="l18.682" class="difflineplus">+      message,</span>
<a href="#l18.683"></a><span id="l18.683">       title: message.conversation.subject,</span>
<a href="#l18.684"></a><span id="l18.684" class="difflineminus">-      background: aBackground</span>
<a href="#l18.685"></a><span id="l18.685" class="difflineplus">+      background: aBackground,</span>
<a href="#l18.686"></a><span id="l18.686">     });</span>
<a href="#l18.687"></a><span id="l18.687">   },</span>
<a href="#l18.688"></a><span id="l18.688"> </span>
<a href="#l18.689"></a><span id="l18.689">   /**</span>
<a href="#l18.690"></a><span id="l18.690">    * Show the message in a new tab.</span>
<a href="#l18.691"></a><span id="l18.691">    *</span>
<a href="#l18.692"></a><span id="l18.692">    * @param {GlodaMessage} aMessage The message to show.</span>
<a href="#l18.693"></a><span id="l18.693">    * @param {Boolean} [aBackground] Whether it should be in the background.</span>
<a href="#l18.694"></a><span id="l18.694">    */</span>
<a href="#l18.695"></a><span id="l18.695" class="difflineminus">-  showMessageInTab: function(aMessage, aBackground) {</span>
<a href="#l18.696"></a><span id="l18.696" class="difflineplus">+  showMessageInTab(aMessage, aBackground) {</span>
<a href="#l18.697"></a><span id="l18.697">     let tabmail = this.rootWin.document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l18.698"></a><span id="l18.698">     let msgHdr = aMessage.folderMessage;</span>
<a href="#l18.699"></a><span id="l18.699">     if (!msgHdr)</span>
<a href="#l18.700"></a><span id="l18.700">       throw new Error(&quot;Unable to translate gloda message to message header.&quot;);</span>
<a href="#l18.701"></a><span id="l18.701">     tabmail.openTab(&quot;message&quot;, {</span>
<a href="#l18.702"></a><span id="l18.702" class="difflineminus">-      msgHdr: msgHdr,</span>
<a href="#l18.703"></a><span id="l18.703" class="difflineminus">-      background: aBackground</span>
<a href="#l18.704"></a><span id="l18.704" class="difflineplus">+      msgHdr,</span>
<a href="#l18.705"></a><span id="l18.705" class="difflineplus">+      background: aBackground,</span>
<a href="#l18.706"></a><span id="l18.706">     });</span>
<a href="#l18.707"></a><span id="l18.707">   },</span>
<a href="#l18.708"></a><span id="l18.708"> </span>
<a href="#l18.709"></a><span id="l18.709" class="difflineminus">-  onItemsAdded: function(aItems, aCollection) {</span>
<a href="#l18.710"></a><span id="l18.710" class="difflineplus">+  onItemsAdded(aItems, aCollection) {</span>
<a href="#l18.711"></a><span id="l18.711">   },</span>
<a href="#l18.712"></a><span id="l18.712" class="difflineminus">-  onItemsModified: function(aItems, aCollection) {</span>
<a href="#l18.713"></a><span id="l18.713" class="difflineplus">+  onItemsModified(aItems, aCollection) {</span>
<a href="#l18.714"></a><span id="l18.714">   },</span>
<a href="#l18.715"></a><span id="l18.715" class="difflineminus">-  onItemsRemoved: function(aItems, aCollection) {</span>
<a href="#l18.716"></a><span id="l18.716" class="difflineplus">+  onItemsRemoved(aItems, aCollection) {</span>
<a href="#l18.717"></a><span id="l18.717">   },</span>
<a href="#l18.718"></a><span id="l18.718" class="difflineminus">-  onQueryCompleted: function(aCollection) {</span>
<a href="#l18.719"></a><span id="l18.719" class="difflineplus">+  onQueryCompleted(aCollection) {</span>
<a href="#l18.720"></a><span id="l18.720">     if (this.tab.query.completed &amp;&amp;</span>
<a href="#l18.721"></a><span id="l18.721">         (!(&quot;IMQuery&quot; in this.tab) || this.tab.IMQuery.completed))</span>
<a href="#l18.722"></a><span id="l18.722">       this.initialBuild();</span>
<a href="#l18.723"></a><span id="l18.723" class="difflineminus">-  }</span>
<a href="#l18.724"></a><span id="l18.724" class="difflineplus">+  },</span>
<a href="#l18.725"></a><span id="l18.725"> };</span>
<a href="#l18.726"></a><span id="l18.726"> </span>
<a href="#l18.727"></a><span id="l18.727"> /**</span>
<a href="#l18.728"></a><span id="l18.728">  * addEventListener betrayals compel us to establish our link with the</span>
<a href="#l18.729"></a><span id="l18.729">  *  outside world from inside.  NeilAway suggests the problem might have</span>
<a href="#l18.730"></a><span id="l18.730">  *  been the registration of the listener prior to initiating the load.  Which</span>
<a href="#l18.731"></a><span id="l18.731">  *  is odd considering it works for the XUL case, but I could see how that might</span>
<a href="#l18.732"></a><span id="l18.732">  *  differ.  Anywho, this works for now and is a delightful reference to boot.</span>
<a href="#l18.733"></a><span id="l18.733" class="difflineat">@@ -876,28 +866,27 @@ function reachOutAndTouchFrame() {</span>
<a href="#l18.734"></a><span id="l18.734">   //  removal notifications are required.</span>
<a href="#l18.735"></a><span id="l18.735">   if (&quot;searcher&quot; in aTab) {</span>
<a href="#l18.736"></a><span id="l18.736">     FacetContext.searcher = aTab.searcher;</span>
<a href="#l18.737"></a><span id="l18.737">     aTab.searcher.listener = FacetContext;</span>
<a href="#l18.738"></a><span id="l18.738">     if (&quot;IMSearcher&quot; in aTab) {</span>
<a href="#l18.739"></a><span id="l18.739">       FacetContext.IMSearcher = aTab.IMSearcher;</span>
<a href="#l18.740"></a><span id="l18.740">       aTab.IMSearcher.listener = FacetContext;</span>
<a href="#l18.741"></a><span id="l18.741">     }</span>
<a href="#l18.742"></a><span id="l18.742" class="difflineminus">-  }</span>
<a href="#l18.743"></a><span id="l18.743" class="difflineminus">-  else {</span>
<a href="#l18.744"></a><span id="l18.744" class="difflineplus">+  } else {</span>
<a href="#l18.745"></a><span id="l18.745">     FacetContext.searcher = null;</span>
<a href="#l18.746"></a><span id="l18.746">     aTab.collection.listener = FacetContext;</span>
<a href="#l18.747"></a><span id="l18.747">   }</span>
<a href="#l18.748"></a><span id="l18.748">   FacetContext.collection = aTab.collection;</span>
<a href="#l18.749"></a><span id="l18.749">   if (&quot;IMCollection&quot; in aTab)</span>
<a href="#l18.750"></a><span id="l18.750">     FacetContext.IMCollection = aTab.IMCollection;</span>
<a href="#l18.751"></a><span id="l18.751"> </span>
<a href="#l18.752"></a><span id="l18.752">   // if it has already completed, we need to prod things</span>
<a href="#l18.753"></a><span id="l18.753">   if (aTab.query.completed &amp;&amp; (!(&quot;IMQuery&quot; in aTab) || aTab.IMQuery.completed))</span>
<a href="#l18.754"></a><span id="l18.754">     FacetContext.initialBuild();</span>
<a href="#l18.755"></a><span id="l18.755"> }</span>
<a href="#l18.756"></a><span id="l18.756"> </span>
<a href="#l18.757"></a><span id="l18.757"> function clickOnBody(event) {</span>
<a href="#l18.758"></a><span id="l18.758">   if (event.bubbles) {</span>
<a href="#l18.759"></a><span id="l18.759" class="difflineminus">-    document.getElementById('popup-menu').hide();</span>
<a href="#l18.760"></a><span id="l18.760" class="difflineplus">+    document.getElementById(&quot;popup-menu&quot;).hide();</span>
<a href="#l18.761"></a><span id="l18.761">   }</span>
<a href="#l18.762"></a><span id="l18.762">   return 0;</span>
<a href="#l18.763"></a><span id="l18.763"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mail/base/content/glodaFacetVis.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mail/base/content/glodaFacetVis.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -14,22 +14,22 @@</span>
<a href="#l19.4"></a><span id="l19.4"> function DateFacetVis(aBinding, aCanvasNode) {</span>
<a href="#l19.5"></a><span id="l19.5">   this.binding = aBinding;</span>
<a href="#l19.6"></a><span id="l19.6">   this.canvasNode = aCanvasNode;</span>
<a href="#l19.7"></a><span id="l19.7"> </span>
<a href="#l19.8"></a><span id="l19.8">   this.faceter = aBinding.faceter;</span>
<a href="#l19.9"></a><span id="l19.9">   this.attrDef = this.faceter.attrDef;</span>
<a href="#l19.10"></a><span id="l19.10"> }</span>
<a href="#l19.11"></a><span id="l19.11"> DateFacetVis.prototype = {</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-  build: function() {</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+  build() {</span>
<a href="#l19.14"></a><span id="l19.14">     let resultsBarRect = document.getElementById(&quot;results&quot;).getBoundingClientRect();</span>
<a href="#l19.15"></a><span id="l19.15">     this.allowedSpace = resultsBarRect.right - resultsBarRect.left;</span>
<a href="#l19.16"></a><span id="l19.16">     this.render();</span>
<a href="#l19.17"></a><span id="l19.17">   },</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineminus">-  rebuild: function() {</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+  rebuild() {</span>
<a href="#l19.20"></a><span id="l19.20">     this.render();</span>
<a href="#l19.21"></a><span id="l19.21">   },</span>
<a href="#l19.22"></a><span id="l19.22"> </span>
<a href="#l19.23"></a><span id="l19.23">   _MIN_BAR_SIZE_PX: 9,</span>
<a href="#l19.24"></a><span id="l19.24">   _BAR_SPACING_PX: 1,</span>
<a href="#l19.25"></a><span id="l19.25"> </span>
<a href="#l19.26"></a><span id="l19.26">   _MAX_BAR_SIZE_PX: 44,</span>
<a href="#l19.27"></a><span id="l19.27"> </span>
<a href="#l19.28"></a><span id="l19.28" class="difflineat">@@ -51,24 +51,24 @@ DateFacetVis.prototype = {</span>
<a href="#l19.29"></a><span id="l19.29">    * Because of our love of sharpness, we will potentially under-use the space</span>
<a href="#l19.30"></a><span id="l19.30">    *  allocated to us.</span>
<a href="#l19.31"></a><span id="l19.31">    *</span>
<a href="#l19.32"></a><span id="l19.32">    * @param aPixels The number of linear content pixels we have to work with.</span>
<a href="#l19.33"></a><span id="l19.33">    *     You are in charge of the borders and such, so you subtract that off</span>
<a href="#l19.34"></a><span id="l19.34">    *     before you pass it in.</span>
<a href="#l19.35"></a><span id="l19.35">    * @return An object with attributes:</span>
<a href="#l19.36"></a><span id="l19.36">    */</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineminus">-  makeIdealScaleGivenSpace: function(aPixels) {</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineplus">+  makeIdealScaleGivenSpace(aPixels) {</span>
<a href="#l19.39"></a><span id="l19.39">     let facet = this.faceter;</span>
<a href="#l19.40"></a><span id="l19.40">     // build a scale and have it grow the edges based on the span</span>
<a href="#l19.41"></a><span id="l19.41">     let scale = pv.Scales.dateTime(facet.oldest, facet.newest);</span>
<a href="#l19.42"></a><span id="l19.42"> </span>
<a href="#l19.43"></a><span id="l19.43">     const Span = pv.Scales.DateTimeScale.Span;</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineminus">-    const MS_MIN = 60*1000, MS_HOUR = 60*MS_MIN, MS_DAY = 24*MS_HOUR,</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineminus">-          MS_WEEK = 7*MS_DAY, MS_MONTHISH = 31*MS_DAY, MS_YEARISH = 366*MS_DAY;</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineplus">+    const MS_MIN = 60 * 1000, MS_HOUR = 60 * MS_MIN, MS_DAY = 24 * MS_HOUR,</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineplus">+          MS_WEEK = 7 * MS_DAY, MS_MONTHISH = 31 * MS_DAY, MS_YEARISH = 366 * MS_DAY;</span>
<a href="#l19.48"></a><span id="l19.48">     const roughMap = {};</span>
<a href="#l19.49"></a><span id="l19.49">     roughMap[Span.DAYS] = MS_DAY;</span>
<a href="#l19.50"></a><span id="l19.50">     roughMap[Span.WEEKS] = MS_WEEK;</span>
<a href="#l19.51"></a><span id="l19.51">     // we overestimate since we want to slightly underestimate pixel usage</span>
<a href="#l19.52"></a><span id="l19.52">     //  in enoughPix's rough estimate</span>
<a href="#l19.53"></a><span id="l19.53">     roughMap[Span.MONTHS] = MS_MONTHISH;</span>
<a href="#l19.54"></a><span id="l19.54">     roughMap[Span.YEARS] = MS_YEARISH;</span>
<a href="#l19.55"></a><span id="l19.55"> </span>
<a href="#l19.56"></a><span id="l19.56" class="difflineat">@@ -112,78 +112,73 @@ DateFacetVis.prototype = {</span>
<a href="#l19.57"></a><span id="l19.57">     let labelTiers = [];</span>
<a href="#l19.58"></a><span id="l19.58">     // add year spans in all cases, although whether we draw bars depends on if</span>
<a href="#l19.59"></a><span id="l19.59">     //  we are in year mode or not</span>
<a href="#l19.60"></a><span id="l19.60">     labelTiers.push({</span>
<a href="#l19.61"></a><span id="l19.61">       rules: (span == Span.YEARS) ? rules : scale.ruleValues(Span.YEARS, true),</span>
<a href="#l19.62"></a><span id="l19.62">       // We should not hit the null member of the array...</span>
<a href="#l19.63"></a><span id="l19.63">       label: [{ year: &quot;numeric&quot; }, { year: &quot;2-digit&quot; }, null],</span>
<a href="#l19.64"></a><span id="l19.64">       boost: (span == Span.YEARS),</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineminus">-      noFringe: (span == Span.YEARS)</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineplus">+      noFringe: (span == Span.YEARS),</span>
<a href="#l19.67"></a><span id="l19.67">     });</span>
<a href="#l19.68"></a><span id="l19.68">     // add month spans if we are days or weeks...</span>
<a href="#l19.69"></a><span id="l19.69">     if (spandex &lt; 2) {</span>
<a href="#l19.70"></a><span id="l19.70">       labelTiers.push({</span>
<a href="#l19.71"></a><span id="l19.71">         rules: scale.ruleValues(Span.MONTHS, true),</span>
<a href="#l19.72"></a><span id="l19.72">         // try to use the full month, falling back to the short month</span>
<a href="#l19.73"></a><span id="l19.73">         label: [{ month: &quot;long&quot; }, { month: &quot;short&quot; }, null],</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineminus">-        boost: false</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineplus">+        boost: false,</span>
<a href="#l19.76"></a><span id="l19.76">       });</span>
<a href="#l19.77"></a><span id="l19.77">     }</span>
<a href="#l19.78"></a><span id="l19.78">     // add week spans if our granularity is days...</span>
<a href="#l19.79"></a><span id="l19.79">     if (span == Span.DAYS) {</span>
<a href="#l19.80"></a><span id="l19.80">       let numDays = delta / MS_DAY;</span>
<a href="#l19.81"></a><span id="l19.81"> </span>
<a href="#l19.82"></a><span id="l19.82">       // find out how many days we are talking about and add days if it's small</span>
<a href="#l19.83"></a><span id="l19.83">       //  enough, display both the date and the day of the week</span>
<a href="#l19.84"></a><span id="l19.84">       if (numDays &lt;= this._MAX_DAY_COUNT_LABEL_DISPLAY) {</span>
<a href="#l19.85"></a><span id="l19.85">         labelTiers.push({</span>
<a href="#l19.86"></a><span id="l19.86" class="difflineminus">-          rules: rules,</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineplus">+          rules,</span>
<a href="#l19.88"></a><span id="l19.88">           label: [{ day: &quot;numeric&quot; }, null],</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineminus">-          boost: true, noFringe: true</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineplus">+          boost: true, noFringe: true,</span>
<a href="#l19.91"></a><span id="l19.91">         });</span>
<a href="#l19.92"></a><span id="l19.92">         labelTiers.push({</span>
<a href="#l19.93"></a><span id="l19.93" class="difflineminus">-          rules: rules,</span>
<a href="#l19.94"></a><span id="l19.94" class="difflineplus">+          rules,</span>
<a href="#l19.95"></a><span id="l19.95">           label: [{ weekday: &quot;short&quot; }, null],</span>
<a href="#l19.96"></a><span id="l19.96" class="difflineminus">-          boost: true, noFringe: true</span>
<a href="#l19.97"></a><span id="l19.97" class="difflineplus">+          boost: true, noFringe: true,</span>
<a href="#l19.98"></a><span id="l19.98">         });</span>
<a href="#l19.99"></a><span id="l19.99" class="difflineminus">-      }</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineminus">-      // show the weeks since we're at greater than a day time-scale</span>
<a href="#l19.101"></a><span id="l19.101" class="difflineminus">-      else {</span>
<a href="#l19.102"></a><span id="l19.102" class="difflineplus">+      } else {</span>
<a href="#l19.103"></a><span id="l19.103" class="difflineplus">+        // show the weeks since we're at greater than a day time-scale</span>
<a href="#l19.104"></a><span id="l19.104">         labelTiers.push({</span>
<a href="#l19.105"></a><span id="l19.105">           rules: scale.ruleValues(Span.WEEKS, true),</span>
<a href="#l19.106"></a><span id="l19.106">           // labeling weeks is nonsensical; no one understands ISO weeks</span>
<a href="#l19.107"></a><span id="l19.107">           //  numbers.</span>
<a href="#l19.108"></a><span id="l19.108">           label: [null],</span>
<a href="#l19.109"></a><span id="l19.109" class="difflineminus">-          boost: false</span>
<a href="#l19.110"></a><span id="l19.110" class="difflineplus">+          boost: false,</span>
<a href="#l19.111"></a><span id="l19.111">         });</span>
<a href="#l19.112"></a><span id="l19.112">       }</span>
<a href="#l19.113"></a><span id="l19.113">     }</span>
<a href="#l19.114"></a><span id="l19.114"> </span>
<a href="#l19.115"></a><span id="l19.115" class="difflineminus">-    return {</span>
<a href="#l19.116"></a><span id="l19.116" class="difflineminus">-      scale: scale, span: span, rules: rules, barPixBudget: barPixBudget,</span>
<a href="#l19.117"></a><span id="l19.117" class="difflineminus">-      labelTiers: labelTiers</span>
<a href="#l19.118"></a><span id="l19.118" class="difflineminus">-    };</span>
<a href="#l19.119"></a><span id="l19.119" class="difflineplus">+    return { scale, span, rules, barPixBudget, labelTiers };</span>
<a href="#l19.120"></a><span id="l19.120">   },</span>
<a href="#l19.121"></a><span id="l19.121"> </span>
<a href="#l19.122"></a><span id="l19.122" class="difflineminus">-  render: function() {</span>
<a href="#l19.123"></a><span id="l19.123" class="difflineminus">-    let {scale: scale, span: span, rules: rules, barPixBudget: barPixBudget,</span>
<a href="#l19.124"></a><span id="l19.124" class="difflineminus">-         labelTiers: labelTiers} =</span>
<a href="#l19.125"></a><span id="l19.125" class="difflineplus">+  render() {</span>
<a href="#l19.126"></a><span id="l19.126" class="difflineplus">+    let { scale, span, rules, barPixBudget, labelTiers } =</span>
<a href="#l19.127"></a><span id="l19.127">       this.makeIdealScaleGivenSpace(this.allowedSpace);</span>
<a href="#l19.128"></a><span id="l19.128"> </span>
<a href="#l19.129"></a><span id="l19.129">     barPixBudget = Math.floor(barPixBudget);</span>
<a href="#l19.130"></a><span id="l19.130"> </span>
<a href="#l19.131"></a><span id="l19.131">     let minBarPix = this._MIN_BAR_SIZE_PX + this._BAR_SPACING_PX;</span>
<a href="#l19.132"></a><span id="l19.132">     let maxBarPix = this._MAX_BAR_SIZE_PX + this._BAR_SPACING_PX;</span>
<a href="#l19.133"></a><span id="l19.133"> </span>
<a href="#l19.134"></a><span id="l19.134">     let barPix = Math.max(minBarPix, Math.min(maxBarPix, barPixBudget));</span>
<a href="#l19.135"></a><span id="l19.135">     let width = barPix * (rules.length - 1);</span>
<a href="#l19.136"></a><span id="l19.136"> </span>
<a href="#l19.137"></a><span id="l19.137">     let totalAxisLabelHeight = 0;</span>
<a href="#l19.138"></a><span id="l19.138" class="difflineminus">-    let isRTL = window.getComputedStyle(this.binding, null).direction == &quot;rtl&quot;;</span>
<a href="#l19.139"></a><span id="l19.139" class="difflineplus">+    let isRTL = window.getComputedStyle(this.binding).direction == &quot;rtl&quot;;</span>
<a href="#l19.140"></a><span id="l19.140"> </span>
<a href="#l19.141"></a><span id="l19.141">     // we need to do some font-metric calculations, so create a canvas...</span>
<a href="#l19.142"></a><span id="l19.142">     let fontMetricCanvas = document.createElement(&quot;canvas&quot;);</span>
<a href="#l19.143"></a><span id="l19.143">     let ctx = fontMetricCanvas.getContext(&quot;2d&quot;);</span>
<a href="#l19.144"></a><span id="l19.144"> </span>
<a href="#l19.145"></a><span id="l19.145">     // do the labeling logic,</span>
<a href="#l19.146"></a><span id="l19.146">     for (let labelTier of labelTiers) {</span>
<a href="#l19.147"></a><span id="l19.147">       let labelRules = labelTier.rules;</span>
<a href="#l19.148"></a><span id="l19.148" class="difflineat">@@ -235,17 +230,16 @@ DateFacetVis.prototype = {</span>
<a href="#l19.149"></a><span id="l19.149">                                   this._AXIS_VERT_SPACING_PX;</span>
<a href="#l19.150"></a><span id="l19.150"> </span>
<a href="#l19.151"></a><span id="l19.151">           break;</span>
<a href="#l19.152"></a><span id="l19.152">         }</span>
<a href="#l19.153"></a><span id="l19.153">       }</span>
<a href="#l19.154"></a><span id="l19.154">     }</span>
<a href="#l19.155"></a><span id="l19.155"> </span>
<a href="#l19.156"></a><span id="l19.156">     let barWidth = barPix - this._BAR_SPACING_PX;</span>
<a href="#l19.157"></a><span id="l19.157" class="difflineminus">-    let barSpacing = this._BAR_SPACING_PX;</span>
<a href="#l19.158"></a><span id="l19.158"> </span>
<a href="#l19.159"></a><span id="l19.159">     width = barPix * (rules.length - 1);</span>
<a href="#l19.160"></a><span id="l19.160">     // we ideally want this to be the same size as the max rows translates to...</span>
<a href="#l19.161"></a><span id="l19.161">     let height = 100;</span>
<a href="#l19.162"></a><span id="l19.162">     let ch = height - totalAxisLabelHeight;</span>
<a href="#l19.163"></a><span id="l19.163"> </span>
<a href="#l19.164"></a><span id="l19.164">     let [bins, maxBinSize] = this.binBySpan(scale, span, rules);</span>
<a href="#l19.165"></a><span id="l19.165"> </span>
<a href="#l19.166"></a><span id="l19.166" class="difflineat">@@ -271,18 +265,17 @@ DateFacetVis.prototype = {</span>
<a href="#l19.167"></a><span id="l19.167">       .left(function() { return isRTL ? null : (this.index * barPix); })</span>
<a href="#l19.168"></a><span id="l19.168">       .right(function() { return isRTL ? (this.index * barPix) : null; })</span>
<a href="#l19.169"></a><span id="l19.169">       .fillStyle(&quot;var(--barColor)&quot;)</span>
<a href="#l19.170"></a><span id="l19.170">       .event(&quot;mouseover&quot;, function(d) { return this.fillStyle(&quot;var(--barHlColor)&quot;); })</span>
<a href="#l19.171"></a><span id="l19.171">       .event(&quot;mouseout&quot;, function(d) { return this.fillStyle(&quot;var(--barColor)&quot;); })</span>
<a href="#l19.172"></a><span id="l19.172">       .event(&quot;click&quot;, function(d) {</span>
<a href="#l19.173"></a><span id="l19.173">           dis.constraints = [[d.startDate, d.endDate]];</span>
<a href="#l19.174"></a><span id="l19.174">           dis.binding.setAttribute(&quot;zoomedout&quot;, &quot;false&quot;);</span>
<a href="#l19.175"></a><span id="l19.175" class="difflineminus">-          FacetContext.addFacetConstraint(faceter, true, dis.constraints,</span>
<a href="#l19.176"></a><span id="l19.176" class="difflineminus">-                                          true, true);</span>
<a href="#l19.177"></a><span id="l19.177" class="difflineplus">+          FacetContext.addFacetConstraint(faceter, true, dis.constraints, true, true);</span>
<a href="#l19.178"></a><span id="l19.178">         }</span>
<a href="#l19.179"></a><span id="l19.179">       );</span>
<a href="#l19.180"></a><span id="l19.180"> </span>
<a href="#l19.181"></a><span id="l19.181">     this.hotBars = vis.add(pv.Bar)</span>
<a href="#l19.182"></a><span id="l19.182">       .data(this.emptyBins)</span>
<a href="#l19.183"></a><span id="l19.183">       .bottom(0)</span>
<a href="#l19.184"></a><span id="l19.184">       .height(d =&gt; Math.floor(d * binScale))</span>
<a href="#l19.185"></a><span id="l19.185">       .width(() =&gt; barWidth)</span>
<a href="#l19.186"></a><span id="l19.186" class="difflineat">@@ -298,72 +291,71 @@ DateFacetVis.prototype = {</span>
<a href="#l19.187"></a><span id="l19.187">         .right(d =&gt; isRTL ? Math.floor(width * d[0]) : null)</span>
<a href="#l19.188"></a><span id="l19.188">         .width(d =&gt; Math.floor(width * d[1]) - Math.floor(width * d[0]) - 1)</span>
<a href="#l19.189"></a><span id="l19.189">         .fillStyle(&quot;var(--dateColor)&quot;)</span>
<a href="#l19.190"></a><span id="l19.190">         .event(&quot;mouseover&quot;, function(d) { return this.fillStyle(&quot;var(--dateHLColor)&quot;); })</span>
<a href="#l19.191"></a><span id="l19.191">         .event(&quot;mouseout&quot;, function(d) { return this.fillStyle(&quot;var(--dateColor)&quot;); })</span>
<a href="#l19.192"></a><span id="l19.192">         .event(&quot;click&quot;, function(d) {</span>
<a href="#l19.193"></a><span id="l19.193">           dis.constraints = [[d[3], d[4]]];</span>
<a href="#l19.194"></a><span id="l19.194">           dis.binding.setAttribute(&quot;zoomedout&quot;, &quot;false&quot;);</span>
<a href="#l19.195"></a><span id="l19.195" class="difflineminus">-          FacetContext.addFacetConstraint(faceter, true, dis.constraints,</span>
<a href="#l19.196"></a><span id="l19.196" class="difflineminus">-                                          true, true)</span>
<a href="#l19.197"></a><span id="l19.197" class="difflineplus">+          FacetContext.addFacetConstraint(faceter, true, dis.constraints, true, true);</span>
<a href="#l19.198"></a><span id="l19.198">         });</span>
<a href="#l19.199"></a><span id="l19.199"> </span>
<a href="#l19.200"></a><span id="l19.200">       if (labelTier.displayLabel) {</span>
<a href="#l19.201"></a><span id="l19.201">         labelBar.anchor(&quot;top&quot;).add(pv.Label)</span>
<a href="#l19.202"></a><span id="l19.202">           .font(this._AXIS_FONT)</span>
<a href="#l19.203"></a><span id="l19.203">           .textAlign(&quot;center&quot;)</span>
<a href="#l19.204"></a><span id="l19.204">           .textBaseline(&quot;top&quot;)</span>
<a href="#l19.205"></a><span id="l19.205">           .textStyle(&quot;black&quot;)</span>
<a href="#l19.206"></a><span id="l19.206">           .text(d =&gt; d[2]);</span>
<a href="#l19.207"></a><span id="l19.207">       }</span>
<a href="#l19.208"></a><span id="l19.208">     }</span>
<a href="#l19.209"></a><span id="l19.209"> </span>
<a href="#l19.210"></a><span id="l19.210"> </span>
<a href="#l19.211"></a><span id="l19.211">     vis.render();</span>
<a href="#l19.212"></a><span id="l19.212">   },</span>
<a href="#l19.213"></a><span id="l19.213"> </span>
<a href="#l19.214"></a><span id="l19.214" class="difflineminus">-  hoverItems: function(aItems) {</span>
<a href="#l19.215"></a><span id="l19.215" class="difflineplus">+  hoverItems(aItems) {</span>
<a href="#l19.216"></a><span id="l19.216">     let itemToBin = this.itemToBin;</span>
<a href="#l19.217"></a><span id="l19.217">     let bins = this.emptyBins.concat();</span>
<a href="#l19.218"></a><span id="l19.218">     for (let item of aItems) {</span>
<a href="#l19.219"></a><span id="l19.219">       if (item.id in itemToBin)</span>
<a href="#l19.220"></a><span id="l19.220">         bins[itemToBin[item.id]]++;</span>
<a href="#l19.221"></a><span id="l19.221">     }</span>
<a href="#l19.222"></a><span id="l19.222">     this.hotBars.data(bins);</span>
<a href="#l19.223"></a><span id="l19.223">     this.vis.render();</span>
<a href="#l19.224"></a><span id="l19.224">   },</span>
<a href="#l19.225"></a><span id="l19.225"> </span>
<a href="#l19.226"></a><span id="l19.226" class="difflineminus">-  clearHover: function() {</span>
<a href="#l19.227"></a><span id="l19.227" class="difflineplus">+  clearHover() {</span>
<a href="#l19.228"></a><span id="l19.228">     this.hotBars.data(this.emptyBins);</span>
<a href="#l19.229"></a><span id="l19.229">     this.vis.render();</span>
<a href="#l19.230"></a><span id="l19.230">   },</span>
<a href="#l19.231"></a><span id="l19.231"> </span>
<a href="#l19.232"></a><span id="l19.232">   /**</span>
<a href="#l19.233"></a><span id="l19.233">    * Bin items at the given span granularity with the set of rules generated</span>
<a href="#l19.234"></a><span id="l19.234">    *  for the given span.  This could equally as well be done as a pre-built</span>
<a href="#l19.235"></a><span id="l19.235">    *  array of buckets with a linear scan of items and a calculation of what</span>
<a href="#l19.236"></a><span id="l19.236">    *  bucket they should be placed in.</span>
<a href="#l19.237"></a><span id="l19.237">    */</span>
<a href="#l19.238"></a><span id="l19.238" class="difflineminus">-  binBySpan: function(aScale, aSpan, aRules, aItems) {</span>
<a href="#l19.239"></a><span id="l19.239" class="difflineplus">+  binBySpan(aScale, aSpan, aRules, aItems) {</span>
<a href="#l19.240"></a><span id="l19.240">     let bins = [];</span>
<a href="#l19.241"></a><span id="l19.241">     let maxBinSize = 0;</span>
<a href="#l19.242"></a><span id="l19.242">     let binCount = aRules.length - 1;</span>
<a href="#l19.243"></a><span id="l19.243">     let itemToBin = this.itemToBin = {};</span>
<a href="#l19.244"></a><span id="l19.244"> </span>
<a href="#l19.245"></a><span id="l19.245">     // We used to break this out by case, but that was a lot of code, and it was</span>
<a href="#l19.246"></a><span id="l19.246">     //  somewhat ridiculous.  So now we just do the simple, if somewhat more</span>
<a href="#l19.247"></a><span id="l19.247">     //  expensive thing.  Reviewer, feel free to thank me.</span>
<a href="#l19.248"></a><span id="l19.248">     // We do a pass through the rules, mapping each rounded rule to a bin.  We</span>
<a href="#l19.249"></a><span id="l19.249">     //  then do a pass through all of the items, rounding them down and using</span>
<a href="#l19.250"></a><span id="l19.250">     //  that to perform a lookup against the map.  We could special-case the</span>
<a href="#l19.251"></a><span id="l19.251">     //  rounding, but I doubt it's worth it.</span>
<a href="#l19.252"></a><span id="l19.252">     let binMap = {};</span>
<a href="#l19.253"></a><span id="l19.253">     for (let iRule = 0; iRule &lt; binCount; iRule++) {</span>
<a href="#l19.254"></a><span id="l19.254" class="difflineminus">-      let binStartDate = aRules[iRule], binEndDate = aRules[iRule+1];</span>
<a href="#l19.255"></a><span id="l19.255" class="difflineplus">+      let binStartDate = aRules[iRule], binEndDate = aRules[iRule + 1];</span>
<a href="#l19.256"></a><span id="l19.256">       binMap[binStartDate.valueOf().toString()] = iRule;</span>
<a href="#l19.257"></a><span id="l19.257">       bins.push({items: [],</span>
<a href="#l19.258"></a><span id="l19.258">                  startDate: binStartDate,</span>
<a href="#l19.259"></a><span id="l19.259">                  endDate: binEndDate});</span>
<a href="#l19.260"></a><span id="l19.260">     }</span>
<a href="#l19.261"></a><span id="l19.261">     let attrKey = this.attrDef.boundName;</span>
<a href="#l19.262"></a><span id="l19.262">     for (let item of this.faceter.validItems) {</span>
<a href="#l19.263"></a><span id="l19.263">       let val = item[attrKey];</span>
<a href="#l19.264"></a><span id="l19.264" class="difflineat">@@ -374,11 +366,11 @@ DateFacetVis.prototype = {</span>
<a href="#l19.265"></a><span id="l19.265">       itemToBin[item.id] = itemBin;</span>
<a href="#l19.266"></a><span id="l19.266">       bins[itemBin].items.push(item);</span>
<a href="#l19.267"></a><span id="l19.267">     }</span>
<a href="#l19.268"></a><span id="l19.268">     for (let bin of bins) {</span>
<a href="#l19.269"></a><span id="l19.269">       maxBinSize = Math.max(bin.items.length, maxBinSize);</span>
<a href="#l19.270"></a><span id="l19.270">     }</span>
<a href="#l19.271"></a><span id="l19.271"> </span>
<a href="#l19.272"></a><span id="l19.272">     return [bins, maxBinSize];</span>
<a href="#l19.273"></a><span id="l19.273" class="difflineminus">-  }</span>
<a href="#l19.274"></a><span id="l19.274" class="difflineplus">+  },</span>
<a href="#l19.275"></a><span id="l19.275"> </span>
<a href="#l19.276"></a><span id="l19.276"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mail/base/content/hiddenWindow.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mail/base/content/hiddenWindow.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -1,66 +1,65 @@</span>
<a href="#l20.4"></a><span id="l20.4"> /* -*- Mode: Javascript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l20.5"></a><span id="l20.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l20.6"></a><span id="l20.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l20.7"></a><span id="l20.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l20.8"></a><span id="l20.8"> </span>
<a href="#l20.9"></a><span id="l20.9" class="difflineminus">-function hiddenWindowStartup()</span>
<a href="#l20.10"></a><span id="l20.10" class="difflineminus">-{</span>
<a href="#l20.11"></a><span id="l20.11" class="difflineplus">+function hiddenWindowStartup() {</span>
<a href="#l20.12"></a><span id="l20.12">   // Disable menus which are not appropriate</span>
<a href="#l20.13"></a><span id="l20.13">   let disabledItems = [</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineminus">-      'menu_newFolder', 'newMailAccountMenuItem', 'newAccountMenuItem',</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineminus">-      'menu_close', 'menu_saveAs', 'menu_saveAsFile', 'menu_newVirtualFolder',</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineminus">-      'menu_find', 'menu_findCmd', 'menu_findAgainCmd', 'menu_sendunsentmsgs',</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineminus">-      'menu_subscribe', 'menu_deleteFolder', 'menu_renameFolder', 'menu_select',</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineminus">-      'menu_selectAll', 'menu_selectThread', 'menu_favoriteFolder',</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineminus">-      'menu_properties', 'menu_Toolbars', 'menu_MessagePaneLayout',</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineminus">-      'menu_showMessage', 'menu_showFolderPane', 'menu_FolderViews',</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineminus">-      'viewSortMenu', 'groupBySort', 'viewMessageViewMenu',</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineminus">-      'mailviewCharsetMenu', 'viewMessagesMenu', 'menu_expandAllThreads',</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineminus">-      'collapseAllThreads', 'viewheadersmenu', 'viewBodyMenu',</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineminus">-      'viewAttachmentsInlineMenuitem', 'viewFullZoomMenu', 'goNextMenu',</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineminus">-      'menu_nextMsg', 'menu_nextUnreadMsg', 'menu_nextUnreadThread',</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineminus">-      'goPreviousMenu', 'menu_prevMsg', 'menu_prevUnreadMsg', 'menu_goForward',</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineminus">-      'menu_goBack', 'goStartPage', 'newMsgCmd', 'replyMainMenu',</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineminus">-      'replySenderMainMenu', 'replyNewsgroupMainMenu', 'menu_replyToAll',</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineminus">-      'menu_replyToList', 'menu_forwardMsg', 'forwardAsMenu',</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineminus">-      'menu_editMsgAsNew', 'openMessageWindowMenuitem',</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-      'openConversationMenuitem', 'moveMenu', 'copyMenu', 'moveToFolderAgain',</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineminus">-      'tagMenu', 'markMenu', 'markReadMenuItem', 'menu_markThreadAsRead',</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineminus">-      'menu_markReadByDate', 'menu_markAllRead', 'markFlaggedMenuItem',</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineminus">-      'menu_markAsJunk', 'menu_markAsNotJunk', 'createFilter', 'killThread',</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineminus">-      'killSubthread', 'watchThread', 'applyFilters', 'runJunkControls',</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineminus">-      'deleteJunk', 'menu_import', 'searchMailCmd', 'searchAddressesCmd',</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineminus">-      'filtersCmd', 'cmd_close', 'minimizeWindow', 'appmenu_markMenu',</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineminus">-      'zoomWindow', 'appmenu_replyMainMenu', 'appmenu_replyNewsgroupMainMenu',</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineminus">-      'appmenu_newFolder', 'appmenu_newMailAccountMenuItem', 'appmenu_close',</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineminus">-      'appmenu_newAccountMenuItem', 'appmenu_saveAs', 'appmenu_saveAsFile',</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineminus">-      'appmenu_newVirtualFolder', 'appmenu_viewBodyMenu', 'appmenu_goNextMenu',</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineminus">-      'appmenu_findAgainCmd', 'appmenu_sendUnsentMsgs', 'appmenu_charsetMenu',</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineminus">-      'appmenu_deleteFolder', 'appmenu_renameFolder', 'appmenu_favoriteFolder',</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineminus">-      'appmenu_properties', 'appmenu_MessagePaneLayout', 'appmenu_showMessage',</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineminus">-      'appmenu_showFolderPane', 'appmenu_FolderViews', 'appmenu_viewSortMenu',</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineminus">-      'appmenu_groupBySort', 'appmenu_viewMessageViewMenu', 'appmenu_subscribe',</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineminus">-      'appmenu_viewMessagesMenu', 'appmenu_expandAllThreads', 'appmenu_findCmd',</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineminus">-      'appmenu_collapseAllThreads', 'appmenu_viewHeadersMenu', 'appmenu_find',</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineminus">-      'appmenu_viewAttachmentsInlineMenuitem', 'appmenu_replySenderMainMenu',</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineminus">-      'appmenu_nextMsg', 'appmenu_nextUnreadMsg', 'appmenu_nextUnreadThread',</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineminus">-      'appmenu_goPreviousMenu', 'appmenu_prevMsg', 'appmenu_prevUnreadMsg',</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineminus">-      'appmenu_goForward', 'appmenu_goBack', 'appmenu_goStartPage',</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineminus">-      'appmenu_newMsgCmd', 'appmenu_viewFullZoomMenu', 'appmenu_replyToAll',</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineminus">-      'appmenu_replyToList', 'appmenu_forwardMsg', 'appmenu_forwardAsMenu',</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineminus">-      'appmenu_editMsgAsNew', 'appmenu_tagMenu', 'appmenu_moveToFolderAgain',</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineminus">-      'appmenu_openMessageWindowMenuitem', 'appmenu_openConversationMenuitem',</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineminus">-      'appmenu_moveMenu', 'appmenu_copyMenu', 'appmenu_createFilter',</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineminus">-      'appmenu_killThread', 'appmenu_killSubthread'];</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineplus">+    &quot;menu_newFolder&quot;, &quot;newMailAccountMenuItem&quot;, &quot;newAccountMenuItem&quot;,</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineplus">+    &quot;menu_close&quot;, &quot;menu_saveAs&quot;, &quot;menu_saveAsFile&quot;, &quot;menu_newVirtualFolder&quot;,</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineplus">+    &quot;menu_find&quot;, &quot;menu_findCmd&quot;, &quot;menu_findAgainCmd&quot;, &quot;menu_sendunsentmsgs&quot;,</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineplus">+    &quot;menu_subscribe&quot;, &quot;menu_deleteFolder&quot;, &quot;menu_renameFolder&quot;, &quot;menu_select&quot;,</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineplus">+    &quot;menu_selectAll&quot;, &quot;menu_selectThread&quot;, &quot;menu_favoriteFolder&quot;,</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineplus">+    &quot;menu_properties&quot;, &quot;menu_Toolbars&quot;, &quot;menu_MessagePaneLayout&quot;,</span>
<a href="#l20.65"></a><span id="l20.65" class="difflineplus">+    &quot;menu_showMessage&quot;, &quot;menu_showFolderPane&quot;, &quot;menu_FolderViews&quot;,</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineplus">+    &quot;viewSortMenu&quot;, &quot;groupBySort&quot;, &quot;viewMessageViewMenu&quot;,</span>
<a href="#l20.67"></a><span id="l20.67" class="difflineplus">+    &quot;mailviewCharsetMenu&quot;, &quot;viewMessagesMenu&quot;, &quot;menu_expandAllThreads&quot;,</span>
<a href="#l20.68"></a><span id="l20.68" class="difflineplus">+    &quot;collapseAllThreads&quot;, &quot;viewheadersmenu&quot;, &quot;viewBodyMenu&quot;,</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineplus">+    &quot;viewAttachmentsInlineMenuitem&quot;, &quot;viewFullZoomMenu&quot;, &quot;goNextMenu&quot;,</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineplus">+    &quot;menu_nextMsg&quot;, &quot;menu_nextUnreadMsg&quot;, &quot;menu_nextUnreadThread&quot;,</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineplus">+    &quot;goPreviousMenu&quot;, &quot;menu_prevMsg&quot;, &quot;menu_prevUnreadMsg&quot;, &quot;menu_goForward&quot;,</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineplus">+    &quot;menu_goBack&quot;, &quot;goStartPage&quot;, &quot;newMsgCmd&quot;, &quot;replyMainMenu&quot;,</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineplus">+    &quot;replySenderMainMenu&quot;, &quot;replyNewsgroupMainMenu&quot;, &quot;menu_replyToAll&quot;,</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineplus">+    &quot;menu_replyToList&quot;, &quot;menu_forwardMsg&quot;, &quot;forwardAsMenu&quot;,</span>
<a href="#l20.75"></a><span id="l20.75" class="difflineplus">+    &quot;menu_editMsgAsNew&quot;, &quot;openMessageWindowMenuitem&quot;,</span>
<a href="#l20.76"></a><span id="l20.76" class="difflineplus">+    &quot;openConversationMenuitem&quot;, &quot;moveMenu&quot;, &quot;copyMenu&quot;, &quot;moveToFolderAgain&quot;,</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineplus">+    &quot;tagMenu&quot;, &quot;markMenu&quot;, &quot;markReadMenuItem&quot;, &quot;menu_markThreadAsRead&quot;,</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineplus">+    &quot;menu_markReadByDate&quot;, &quot;menu_markAllRead&quot;, &quot;markFlaggedMenuItem&quot;,</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineplus">+    &quot;menu_markAsJunk&quot;, &quot;menu_markAsNotJunk&quot;, &quot;createFilter&quot;, &quot;killThread&quot;,</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineplus">+    &quot;killSubthread&quot;, &quot;watchThread&quot;, &quot;applyFilters&quot;, &quot;runJunkControls&quot;,</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineplus">+    &quot;deleteJunk&quot;, &quot;menu_import&quot;, &quot;searchMailCmd&quot;, &quot;searchAddressesCmd&quot;,</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineplus">+    &quot;filtersCmd&quot;, &quot;cmd_close&quot;, &quot;minimizeWindow&quot;, &quot;appmenu_markMenu&quot;,</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineplus">+    &quot;zoomWindow&quot;, &quot;appmenu_replyMainMenu&quot;, &quot;appmenu_replyNewsgroupMainMenu&quot;,</span>
<a href="#l20.84"></a><span id="l20.84" class="difflineplus">+    &quot;appmenu_newFolder&quot;, &quot;appmenu_newMailAccountMenuItem&quot;, &quot;appmenu_close&quot;,</span>
<a href="#l20.85"></a><span id="l20.85" class="difflineplus">+    &quot;appmenu_newAccountMenuItem&quot;, &quot;appmenu_saveAs&quot;, &quot;appmenu_saveAsFile&quot;,</span>
<a href="#l20.86"></a><span id="l20.86" class="difflineplus">+    &quot;appmenu_newVirtualFolder&quot;, &quot;appmenu_viewBodyMenu&quot;, &quot;appmenu_goNextMenu&quot;,</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineplus">+    &quot;appmenu_findAgainCmd&quot;, &quot;appmenu_sendUnsentMsgs&quot;, &quot;appmenu_charsetMenu&quot;,</span>
<a href="#l20.88"></a><span id="l20.88" class="difflineplus">+    &quot;appmenu_deleteFolder&quot;, &quot;appmenu_renameFolder&quot;, &quot;appmenu_favoriteFolder&quot;,</span>
<a href="#l20.89"></a><span id="l20.89" class="difflineplus">+    &quot;appmenu_properties&quot;, &quot;appmenu_MessagePaneLayout&quot;, &quot;appmenu_showMessage&quot;,</span>
<a href="#l20.90"></a><span id="l20.90" class="difflineplus">+    &quot;appmenu_showFolderPane&quot;, &quot;appmenu_FolderViews&quot;, &quot;appmenu_viewSortMenu&quot;,</span>
<a href="#l20.91"></a><span id="l20.91" class="difflineplus">+    &quot;appmenu_groupBySort&quot;, &quot;appmenu_viewMessageViewMenu&quot;, &quot;appmenu_subscribe&quot;,</span>
<a href="#l20.92"></a><span id="l20.92" class="difflineplus">+    &quot;appmenu_viewMessagesMenu&quot;, &quot;appmenu_expandAllThreads&quot;, &quot;appmenu_findCmd&quot;,</span>
<a href="#l20.93"></a><span id="l20.93" class="difflineplus">+    &quot;appmenu_collapseAllThreads&quot;, &quot;appmenu_viewHeadersMenu&quot;, &quot;appmenu_find&quot;,</span>
<a href="#l20.94"></a><span id="l20.94" class="difflineplus">+    &quot;appmenu_viewAttachmentsInlineMenuitem&quot;, &quot;appmenu_replySenderMainMenu&quot;,</span>
<a href="#l20.95"></a><span id="l20.95" class="difflineplus">+    &quot;appmenu_nextMsg&quot;, &quot;appmenu_nextUnreadMsg&quot;, &quot;appmenu_nextUnreadThread&quot;,</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineplus">+    &quot;appmenu_goPreviousMenu&quot;, &quot;appmenu_prevMsg&quot;, &quot;appmenu_prevUnreadMsg&quot;,</span>
<a href="#l20.97"></a><span id="l20.97" class="difflineplus">+    &quot;appmenu_goForward&quot;, &quot;appmenu_goBack&quot;, &quot;appmenu_goStartPage&quot;,</span>
<a href="#l20.98"></a><span id="l20.98" class="difflineplus">+    &quot;appmenu_newMsgCmd&quot;, &quot;appmenu_viewFullZoomMenu&quot;, &quot;appmenu_replyToAll&quot;,</span>
<a href="#l20.99"></a><span id="l20.99" class="difflineplus">+    &quot;appmenu_replyToList&quot;, &quot;appmenu_forwardMsg&quot;, &quot;appmenu_forwardAsMenu&quot;,</span>
<a href="#l20.100"></a><span id="l20.100" class="difflineplus">+    &quot;appmenu_editMsgAsNew&quot;, &quot;appmenu_tagMenu&quot;, &quot;appmenu_moveToFolderAgain&quot;,</span>
<a href="#l20.101"></a><span id="l20.101" class="difflineplus">+    &quot;appmenu_openMessageWindowMenuitem&quot;, &quot;appmenu_openConversationMenuitem&quot;,</span>
<a href="#l20.102"></a><span id="l20.102" class="difflineplus">+    &quot;appmenu_moveMenu&quot;, &quot;appmenu_copyMenu&quot;, &quot;appmenu_createFilter&quot;,</span>
<a href="#l20.103"></a><span id="l20.103" class="difflineplus">+    &quot;appmenu_killThread&quot;, &quot;appmenu_killSubthread&quot;,</span>
<a href="#l20.104"></a><span id="l20.104" class="difflineplus">+  ];</span>
<a href="#l20.105"></a><span id="l20.105"> </span>
<a href="#l20.106"></a><span id="l20.106">   let element;</span>
<a href="#l20.107"></a><span id="l20.107" class="difflineminus">-  for (let id of disabledItems)</span>
<a href="#l20.108"></a><span id="l20.108" class="difflineminus">-  {</span>
<a href="#l20.109"></a><span id="l20.109" class="difflineplus">+  for (let id of disabledItems) {</span>
<a href="#l20.110"></a><span id="l20.110">     element = document.getElementById(id);</span>
<a href="#l20.111"></a><span id="l20.111">     if (element)</span>
<a href="#l20.112"></a><span id="l20.112">       element.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l20.113"></a><span id="l20.113">   }</span>
<a href="#l20.114"></a><span id="l20.114"> </span>
<a href="#l20.115"></a><span id="l20.115">   // Also hide the window-list separator if it exists.</span>
<a href="#l20.116"></a><span id="l20.116">   element = document.getElementById(&quot;sep-window-list&quot;);</span>
<a href="#l20.117"></a><span id="l20.117">   if (element)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mail/base/content/macMessengerMenu.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mail/base/content/macMessengerMenu.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -46,49 +46,44 @@ function PrefWindowObserver() {</span>
<a href="#l21.4"></a><span id="l21.4">   };</span>
<a href="#l21.5"></a><span id="l21.5"> }</span>
<a href="#l21.6"></a><span id="l21.6"> </span>
<a href="#l21.7"></a><span id="l21.7"> /**</span>
<a href="#l21.8"></a><span id="l21.8">  * Show the Dock Options sub-dialog hanging from the Preferences window.</span>
<a href="#l21.9"></a><span id="l21.9">  * If Preference window was already opened, this will select General pane before</span>
<a href="#l21.10"></a><span id="l21.10">  * opening Dock Options sub-dialog.</span>
<a href="#l21.11"></a><span id="l21.11">  */</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-function openDockOptions()</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-{</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+function openDockOptions() {</span>
<a href="#l21.15"></a><span id="l21.15">   let win = Services.wm.getMostRecentWindow(&quot;Mail:Preferences&quot;);</span>
<a href="#l21.16"></a><span id="l21.16"> </span>
<a href="#l21.17"></a><span id="l21.17">   if (win) {</span>
<a href="#l21.18"></a><span id="l21.18">     openOptionsDialog(&quot;paneGeneral&quot;);</span>
<a href="#l21.19"></a><span id="l21.19">     win.document.documentElement</span>
<a href="#l21.20"></a><span id="l21.20">        .openSubDialog(&quot;chrome://messenger/content/preferences/dockoptions.xul&quot;,</span>
<a href="#l21.21"></a><span id="l21.21">                       &quot;&quot;, null);</span>
<a href="#l21.22"></a><span id="l21.22">   } else {</span>
<a href="#l21.23"></a><span id="l21.23">       Services.ww.registerNotification(new PrefWindowObserver());</span>
<a href="#l21.24"></a><span id="l21.24">       openOptionsDialog(&quot;paneGeneral&quot;);</span>
<a href="#l21.25"></a><span id="l21.25">   }</span>
<a href="#l21.26"></a><span id="l21.26"> }</span>
<a href="#l21.27"></a><span id="l21.27"> </span>
<a href="#l21.28"></a><span id="l21.28"> /**</span>
<a href="#l21.29"></a><span id="l21.29">  * Open a new window for writing a new message</span>
<a href="#l21.30"></a><span id="l21.30">  */</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-function writeNewMessageDock()</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineminus">-{</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineplus">+function writeNewMessageDock() {</span>
<a href="#l21.34"></a><span id="l21.34">   // Default identity will be used as sender for the new message.</span>
<a href="#l21.35"></a><span id="l21.35">   MailServices.compose.OpenComposeWindow(null, null, null,</span>
<a href="#l21.36"></a><span id="l21.36">     Ci.nsIMsgCompType.New,</span>
<a href="#l21.37"></a><span id="l21.37">     Ci.nsIMsgCompFormat.Default, null, null);</span>
<a href="#l21.38"></a><span id="l21.38"> }</span>
<a href="#l21.39"></a><span id="l21.39"> </span>
<a href="#l21.40"></a><span id="l21.40"> /**</span>
<a href="#l21.41"></a><span id="l21.41">  * Open the address book window</span>
<a href="#l21.42"></a><span id="l21.42">  */</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineminus">-function openAddressBookDock()</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineminus">-{</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineplus">+function openAddressBookDock() {</span>
<a href="#l21.46"></a><span id="l21.46">   let win = Services.wm.getMostRecentWindow(&quot;mail:addressbook&quot;);</span>
<a href="#l21.47"></a><span id="l21.47">   if (win) {</span>
<a href="#l21.48"></a><span id="l21.48">     win.focus();</span>
<a href="#l21.49"></a><span id="l21.49">   } else {</span>
<a href="#l21.50"></a><span id="l21.50" class="difflineminus">-    let ww = Cc[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;].</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineminus">-                                getService(Ci.nsIWindowWatcher);</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineminus">-    ww.openWindow(null, &quot;chrome://messenger/content/addressbook/addressbook.xul&quot;, null,</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineminus">-                  &quot;chrome,extrachrome,menubar,resizable,scrollbars,status,toolbar&quot;, null);</span>
<a href="#l21.54"></a><span id="l21.54" class="difflineplus">+    Services.ww.openWindow(null, &quot;chrome://messenger/content/addressbook/addressbook.xul&quot;, null,</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineplus">+                           &quot;chrome,extrachrome,menubar,resizable,scrollbars,status,toolbar&quot;, null);</span>
<a href="#l21.56"></a><span id="l21.56">   }</span>
<a href="#l21.57"></a><span id="l21.57"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mail/base/content/mail-compacttheme.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mail/base/content/mail-compacttheme.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -63,10 +63,10 @@ var CompactTheme = {</span>
<a href="#l22.4"></a><span id="l22.4">   },</span>
<a href="#l22.5"></a><span id="l22.5"> </span>
<a href="#l22.6"></a><span id="l22.6">   uninit() {</span>
<a href="#l22.7"></a><span id="l22.7">     Services.obs.removeObserver(this, &quot;lightweight-theme-styling-update&quot;);</span>
<a href="#l22.8"></a><span id="l22.8">     // If the getter still exists, remove it.</span>
<a href="#l22.9"></a><span id="l22.9">     if (Object.getOwnPropertyDescriptor(this, &quot;styleSheet&quot;).get)</span>
<a href="#l22.10"></a><span id="l22.10">       delete this.styleSheet;</span>
<a href="#l22.11"></a><span id="l22.11">     this.styleSheet = null;</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-  }</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+  },</span>
<a href="#l22.14"></a><span id="l22.14"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mail/base/content/mail-offline.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mail/base/content/mail-offline.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -4,236 +4,213 @@</span>
<a href="#l23.4"></a><span id="l23.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l23.5"></a><span id="l23.5"> </span>
<a href="#l23.6"></a><span id="l23.6"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l23.7"></a><span id="l23.7"> </span>
<a href="#l23.8"></a><span id="l23.8"> var MailOfflineMgr = {</span>
<a href="#l23.9"></a><span id="l23.9">   offlineManager: null,</span>
<a href="#l23.10"></a><span id="l23.10">   offlineBundle: null,</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-  init: function()</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-  {</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineplus">+  init() {</span>
<a href="#l23.15"></a><span id="l23.15">     Services.obs.addObserver(this, &quot;network:offline-status-changed&quot;);</span>
<a href="#l23.16"></a><span id="l23.16"> </span>
<a href="#l23.17"></a><span id="l23.17">     this.offlineManager = Cc[&quot;@mozilla.org/messenger/offline-manager;1&quot;]</span>
<a href="#l23.18"></a><span id="l23.18">                         .getService(Ci.nsIMsgOfflineManager);</span>
<a href="#l23.19"></a><span id="l23.19">     this.offlineBundle = document.getElementById(&quot;bundle_offlinePrompts&quot;);</span>
<a href="#l23.20"></a><span id="l23.20"> </span>
<a href="#l23.21"></a><span id="l23.21">     // initialize our offline state UI</span>
<a href="#l23.22"></a><span id="l23.22">     this.updateOfflineUI(!this.isOnline());</span>
<a href="#l23.23"></a><span id="l23.23">   },</span>
<a href="#l23.24"></a><span id="l23.24"> </span>
<a href="#l23.25"></a><span id="l23.25" class="difflineminus">-  uninit: function()</span>
<a href="#l23.26"></a><span id="l23.26" class="difflineminus">-  {</span>
<a href="#l23.27"></a><span id="l23.27" class="difflineplus">+  uninit() {</span>
<a href="#l23.28"></a><span id="l23.28">     Services.obs.removeObserver(this, &quot;network:offline-status-changed&quot;);</span>
<a href="#l23.29"></a><span id="l23.29">   },</span>
<a href="#l23.30"></a><span id="l23.30"> </span>
<a href="#l23.31"></a><span id="l23.31">   /**</span>
<a href="#l23.32"></a><span id="l23.32">    * @return true if we are online</span>
<a href="#l23.33"></a><span id="l23.33">    */</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineminus">-   isOnline: function()</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineminus">-   {</span>
<a href="#l23.36"></a><span id="l23.36" class="difflineplus">+   isOnline() {</span>
<a href="#l23.37"></a><span id="l23.37">      return (!Services.io.offline);</span>
<a href="#l23.38"></a><span id="l23.38">    },</span>
<a href="#l23.39"></a><span id="l23.39"> </span>
<a href="#l23.40"></a><span id="l23.40">   /**</span>
<a href="#l23.41"></a><span id="l23.41">    * Toggles the online / offline state, initiated by the user. Depending on user settings</span>
<a href="#l23.42"></a><span id="l23.42">    * we may prompt the user to send unsent messages when going online or to download messages for</span>
<a href="#l23.43"></a><span id="l23.43">    * offline use when going offline.</span>
<a href="#l23.44"></a><span id="l23.44">    */</span>
<a href="#l23.45"></a><span id="l23.45" class="difflineminus">-  toggleOfflineStatus: function()</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineminus">-  {</span>
<a href="#l23.47"></a><span id="l23.47" class="difflineplus">+  toggleOfflineStatus() {</span>
<a href="#l23.48"></a><span id="l23.48">     // the offline manager(goOnline and synchronizeForOffline) actually does the dirty work of</span>
<a href="#l23.49"></a><span id="l23.49">     // changing the offline state with the networking service.</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineminus">-    if (!this.isOnline())</span>
<a href="#l23.51"></a><span id="l23.51" class="difflineminus">-    {</span>
<a href="#l23.52"></a><span id="l23.52" class="difflineplus">+    if (!this.isOnline()) {</span>
<a href="#l23.53"></a><span id="l23.53">       // We do the go online stuff in our listener for the online state change.</span>
<a href="#l23.54"></a><span id="l23.54">       Services.io.offline = false;</span>
<a href="#l23.55"></a><span id="l23.55">       // resume managing offline status now that we are going back online.</span>
<a href="#l23.56"></a><span id="l23.56">       Services.io.manageOfflineStatus = Services.prefs.getBoolPref(&quot;offline.autoDetect&quot;);</span>
<a href="#l23.57"></a><span id="l23.57" class="difflineminus">-    }</span>
<a href="#l23.58"></a><span id="l23.58" class="difflineminus">-    else // going offline</span>
<a href="#l23.59"></a><span id="l23.59" class="difflineminus">-    {</span>
<a href="#l23.60"></a><span id="l23.60" class="difflineplus">+    } else { // going offline</span>
<a href="#l23.61"></a><span id="l23.61">       // Stop automatic management of the offline status since the user has</span>
<a href="#l23.62"></a><span id="l23.62">       // decided to go offline.</span>
<a href="#l23.63"></a><span id="l23.63">       Services.io.manageOfflineStatus = false;</span>
<a href="#l23.64"></a><span id="l23.64">       var prefDownloadMessages = Services.prefs.getIntPref(&quot;offline.download.download_messages&quot;);</span>
<a href="#l23.65"></a><span id="l23.65">       // 0 == Ask, 1 == Always Download, 2 == Never Download</span>
<a href="#l23.66"></a><span id="l23.66">       var downloadForOfflineUse = (prefDownloadMessages == 0 &amp;&amp; this.confirmDownloadMessagesForOfflineUse())</span>
<a href="#l23.67"></a><span id="l23.67">                                   || prefDownloadMessages == 1;</span>
<a href="#l23.68"></a><span id="l23.68">       this.offlineManager.synchronizeForOffline(downloadForOfflineUse, downloadForOfflineUse, false, true, msgWindow);</span>
<a href="#l23.69"></a><span id="l23.69">     }</span>
<a href="#l23.70"></a><span id="l23.70">   },</span>
<a href="#l23.71"></a><span id="l23.71"> </span>
<a href="#l23.72"></a><span id="l23.72" class="difflineminus">-  observe: function (aSubject, aTopic, aState)</span>
<a href="#l23.73"></a><span id="l23.73" class="difflineminus">-  {</span>
<a href="#l23.74"></a><span id="l23.74" class="difflineplus">+  observe(aSubject, aTopic, aState) {</span>
<a href="#l23.75"></a><span id="l23.75">     if (aTopic == &quot;network:offline-status-changed&quot;)</span>
<a href="#l23.76"></a><span id="l23.76">       this.mailOfflineStateChanged(aState == &quot;offline&quot;);</span>
<a href="#l23.77"></a><span id="l23.77">   },</span>
<a href="#l23.78"></a><span id="l23.78"> </span>
<a href="#l23.79"></a><span id="l23.79">   /**</span>
<a href="#l23.80"></a><span id="l23.80">    * @return true if there are unsent messages</span>
<a href="#l23.81"></a><span id="l23.81">    */</span>
<a href="#l23.82"></a><span id="l23.82" class="difflineminus">-  haveUnsentMessages: function()</span>
<a href="#l23.83"></a><span id="l23.83" class="difflineminus">-  {</span>
<a href="#l23.84"></a><span id="l23.84" class="difflineplus">+  haveUnsentMessages() {</span>
<a href="#l23.85"></a><span id="l23.85">     return Cc[&quot;@mozilla.org/messengercompose/sendlater;1&quot;]</span>
<a href="#l23.86"></a><span id="l23.86">              .getService(Ci.nsIMsgSendLater)</span>
<a href="#l23.87"></a><span id="l23.87">              .hasUnsentMessages();</span>
<a href="#l23.88"></a><span id="l23.88">   },</span>
<a href="#l23.89"></a><span id="l23.89"> </span>
<a href="#l23.90"></a><span id="l23.90">   /**</span>
<a href="#l23.91"></a><span id="l23.91">    * open the offline panel in the account manager for the currently loaded</span>
<a href="#l23.92"></a><span id="l23.92">    * account.</span>
<a href="#l23.93"></a><span id="l23.93">    */</span>
<a href="#l23.94"></a><span id="l23.94" class="difflineminus">-  openOfflineAccountSettings: function()</span>
<a href="#l23.95"></a><span id="l23.95" class="difflineminus">-  {</span>
<a href="#l23.96"></a><span id="l23.96" class="difflineminus">-    window.parent.MsgAccountManager('am-offline.xul');</span>
<a href="#l23.97"></a><span id="l23.97" class="difflineplus">+  openOfflineAccountSettings() {</span>
<a href="#l23.98"></a><span id="l23.98" class="difflineplus">+    window.parent.MsgAccountManager(&quot;am-offline.xul&quot;);</span>
<a href="#l23.99"></a><span id="l23.99">   },</span>
<a href="#l23.100"></a><span id="l23.100"> </span>
<a href="#l23.101"></a><span id="l23.101">   /**</span>
<a href="#l23.102"></a><span id="l23.102">    * Prompt the user about going online to send unsent messages, and then send them</span>
<a href="#l23.103"></a><span id="l23.103">    * if appropriate. Puts the app back into online mode.</span>
<a href="#l23.104"></a><span id="l23.104">    *</span>
<a href="#l23.105"></a><span id="l23.105">    * @param aMsgWindow the msg window to be used when going online</span>
<a href="#l23.106"></a><span id="l23.106">    */</span>
<a href="#l23.107"></a><span id="l23.107" class="difflineminus">-  goOnlineToSendMessages: function(aMsgWindow)</span>
<a href="#l23.108"></a><span id="l23.108" class="difflineminus">-  {</span>
<a href="#l23.109"></a><span id="l23.109" class="difflineplus">+  goOnlineToSendMessages(aMsgWindow) {</span>
<a href="#l23.110"></a><span id="l23.110">     let goOnlineToSendMsgs = Services.prompt.confirm(window,</span>
<a href="#l23.111"></a><span id="l23.111" class="difflineminus">-      this.offlineBundle.getString('sendMessagesOfflineWindowTitle1'),</span>
<a href="#l23.112"></a><span id="l23.112" class="difflineminus">-      this.offlineBundle.getString('sendMessagesOfflineLabel1'));</span>
<a href="#l23.113"></a><span id="l23.113" class="difflineplus">+      this.offlineBundle.getString(&quot;sendMessagesOfflineWindowTitle1&quot;),</span>
<a href="#l23.114"></a><span id="l23.114" class="difflineplus">+      this.offlineBundle.getString(&quot;sendMessagesOfflineLabel1&quot;));</span>
<a href="#l23.115"></a><span id="l23.115"> </span>
<a href="#l23.116"></a><span id="l23.116">     if (goOnlineToSendMsgs)</span>
<a href="#l23.117"></a><span id="l23.117">       this.offlineManager.goOnline(true /* send unsent messages*/, false, aMsgWindow);</span>
<a href="#l23.118"></a><span id="l23.118">   },</span>
<a href="#l23.119"></a><span id="l23.119"> </span>
<a href="#l23.120"></a><span id="l23.120">   /**</span>
<a href="#l23.121"></a><span id="l23.121">    * Prompts the user to confirm sending of unsent messages. This is different from</span>
<a href="#l23.122"></a><span id="l23.122">    * goOnlineToSendMessages which involves going online to send unsent messages.</span>
<a href="#l23.123"></a><span id="l23.123">    *</span>
<a href="#l23.124"></a><span id="l23.124">    * @return true if the user wants to send unsent messages</span>
<a href="#l23.125"></a><span id="l23.125">    */</span>
<a href="#l23.126"></a><span id="l23.126" class="difflineminus">-  confirmSendUnsentMessages: function()</span>
<a href="#l23.127"></a><span id="l23.127" class="difflineminus">-  {</span>
<a href="#l23.128"></a><span id="l23.128" class="difflineplus">+  confirmSendUnsentMessages() {</span>
<a href="#l23.129"></a><span id="l23.129">     let alwaysAsk = {value: true};</span>
<a href="#l23.130"></a><span id="l23.130">     let sendUnsentMessages = Services.prompt.confirmEx(window,</span>
<a href="#l23.131"></a><span id="l23.131" class="difflineminus">-      this.offlineBundle.getString('sendMessagesWindowTitle1'),</span>
<a href="#l23.132"></a><span id="l23.132" class="difflineminus">-      this.offlineBundle.getString('sendMessagesLabel2'),</span>
<a href="#l23.133"></a><span id="l23.133" class="difflineplus">+      this.offlineBundle.getString(&quot;sendMessagesWindowTitle1&quot;),</span>
<a href="#l23.134"></a><span id="l23.134" class="difflineplus">+      this.offlineBundle.getString(&quot;sendMessagesLabel2&quot;),</span>
<a href="#l23.135"></a><span id="l23.135">       (Services.prompt.BUTTON_TITLE_IS_STRING * Services.prompt.BUTTON_POS_0) +</span>
<a href="#l23.136"></a><span id="l23.136">       (Services.prompt.BUTTON_TITLE_IS_STRING * Services.prompt.BUTTON_POS_1),</span>
<a href="#l23.137"></a><span id="l23.137" class="difflineminus">-      this.offlineBundle.getString('sendMessagesNow2'),</span>
<a href="#l23.138"></a><span id="l23.138" class="difflineminus">-      this.offlineBundle.getString('processMessagesLater2'),</span>
<a href="#l23.139"></a><span id="l23.139" class="difflineplus">+      this.offlineBundle.getString(&quot;sendMessagesNow2&quot;),</span>
<a href="#l23.140"></a><span id="l23.140" class="difflineplus">+      this.offlineBundle.getString(&quot;processMessagesLater2&quot;),</span>
<a href="#l23.141"></a><span id="l23.141">       null,</span>
<a href="#l23.142"></a><span id="l23.142" class="difflineminus">-      this.offlineBundle.getString('sendMessagesCheckboxLabel1'),</span>
<a href="#l23.143"></a><span id="l23.143" class="difflineplus">+      this.offlineBundle.getString(&quot;sendMessagesCheckboxLabel1&quot;),</span>
<a href="#l23.144"></a><span id="l23.144">       alwaysAsk) == 0;</span>
<a href="#l23.145"></a><span id="l23.145"> </span>
<a href="#l23.146"></a><span id="l23.146">     // if the user changed the ask me setting then update the global pref based on their yes / no answer</span>
<a href="#l23.147"></a><span id="l23.147">     if (!alwaysAsk.value)</span>
<a href="#l23.148"></a><span id="l23.148">       Services.prefs.setIntPref(&quot;offline.send.unsent_messages&quot;, sendUnsentMessages ? 1 : 2);</span>
<a href="#l23.149"></a><span id="l23.149"> </span>
<a href="#l23.150"></a><span id="l23.150">     return sendUnsentMessages;</span>
<a href="#l23.151"></a><span id="l23.151">   },</span>
<a href="#l23.152"></a><span id="l23.152"> </span>
<a href="#l23.153"></a><span id="l23.153">   /**</span>
<a href="#l23.154"></a><span id="l23.154">    * Should we send unsent messages? Based on the value of</span>
<a href="#l23.155"></a><span id="l23.155">    * offline.send.unsent_messages, this method may prompt the user.</span>
<a href="#l23.156"></a><span id="l23.156">    * @return true if we should send unsent messages</span>
<a href="#l23.157"></a><span id="l23.157">    */</span>
<a href="#l23.158"></a><span id="l23.158" class="difflineminus">-  shouldSendUnsentMessages: function()</span>
<a href="#l23.159"></a><span id="l23.159" class="difflineminus">-  {</span>
<a href="#l23.160"></a><span id="l23.160" class="difflineplus">+  shouldSendUnsentMessages() {</span>
<a href="#l23.161"></a><span id="l23.161">     var sendUnsentWhenGoingOnlinePref = Services.prefs.getIntPref(&quot;offline.send.unsent_messages&quot;);</span>
<a href="#l23.162"></a><span id="l23.162" class="difflineminus">-    if(sendUnsentWhenGoingOnlinePref == 2) // never send</span>
<a href="#l23.163"></a><span id="l23.163" class="difflineplus">+    if (sendUnsentWhenGoingOnlinePref == 2) { // never send</span>
<a href="#l23.164"></a><span id="l23.164">       return false;</span>
<a href="#l23.165"></a><span id="l23.165" class="difflineminus">-</span>
<a href="#l23.166"></a><span id="l23.166" class="difflineminus">-    // if we we have unsent messages, then honor the offline.send.unsent_messages pref.</span>
<a href="#l23.167"></a><span id="l23.167" class="difflineminus">-    else if (this.haveUnsentMessages())</span>
<a href="#l23.168"></a><span id="l23.168" class="difflineminus">-    {</span>
<a href="#l23.169"></a><span id="l23.169" class="difflineplus">+    } else if (this.haveUnsentMessages()) {</span>
<a href="#l23.170"></a><span id="l23.170" class="difflineplus">+      // if we we have unsent messages, then honor the offline.send.unsent_messages pref.</span>
<a href="#l23.171"></a><span id="l23.171">       if ((sendUnsentWhenGoingOnlinePref == 0 &amp;&amp; this.confirmSendUnsentMessages())</span>
<a href="#l23.172"></a><span id="l23.172">            || sendUnsentWhenGoingOnlinePref == 1)</span>
<a href="#l23.173"></a><span id="l23.173">         return true;</span>
<a href="#l23.174"></a><span id="l23.174">     }</span>
<a href="#l23.175"></a><span id="l23.175">     return false;</span>
<a href="#l23.176"></a><span id="l23.176">   },</span>
<a href="#l23.177"></a><span id="l23.177"> </span>
<a href="#l23.178"></a><span id="l23.178">   /**</span>
<a href="#l23.179"></a><span id="l23.179">    * Prompts the user to download messages for offline use before going offline.</span>
<a href="#l23.180"></a><span id="l23.180">    * May update the value of offline.download.download_messages</span>
<a href="#l23.181"></a><span id="l23.181">    *</span>
<a href="#l23.182"></a><span id="l23.182">    * @return true if the user wants to download messages for offline use.</span>
<a href="#l23.183"></a><span id="l23.183">    */</span>
<a href="#l23.184"></a><span id="l23.184" class="difflineminus">-  confirmDownloadMessagesForOfflineUse: function()</span>
<a href="#l23.185"></a><span id="l23.185" class="difflineminus">-  {</span>
<a href="#l23.186"></a><span id="l23.186" class="difflineplus">+  confirmDownloadMessagesForOfflineUse() {</span>
<a href="#l23.187"></a><span id="l23.187">     let alwaysAsk = {value: true};</span>
<a href="#l23.188"></a><span id="l23.188">     let downloadMessages = Services.prompt.confirmEx(window,</span>
<a href="#l23.189"></a><span id="l23.189" class="difflineminus">-      this.offlineBundle.getString('downloadMessagesWindowTitle1'),</span>
<a href="#l23.190"></a><span id="l23.190" class="difflineminus">-      this.offlineBundle.getString('downloadMessagesLabel1'),</span>
<a href="#l23.191"></a><span id="l23.191" class="difflineplus">+      this.offlineBundle.getString(&quot;downloadMessagesWindowTitle1&quot;),</span>
<a href="#l23.192"></a><span id="l23.192" class="difflineplus">+      this.offlineBundle.getString(&quot;downloadMessagesLabel1&quot;),</span>
<a href="#l23.193"></a><span id="l23.193">       (Services.prompt.BUTTON_TITLE_IS_STRING * Services.prompt.BUTTON_POS_0) +</span>
<a href="#l23.194"></a><span id="l23.194">       (Services.prompt.BUTTON_TITLE_IS_STRING * Services.prompt.BUTTON_POS_1),</span>
<a href="#l23.195"></a><span id="l23.195" class="difflineminus">-      this.offlineBundle.getString('downloadMessagesNow2'),</span>
<a href="#l23.196"></a><span id="l23.196" class="difflineminus">-      this.offlineBundle.getString('processMessagesLater2'),</span>
<a href="#l23.197"></a><span id="l23.197" class="difflineplus">+      this.offlineBundle.getString(&quot;downloadMessagesNow2&quot;),</span>
<a href="#l23.198"></a><span id="l23.198" class="difflineplus">+      this.offlineBundle.getString(&quot;processMessagesLater2&quot;),</span>
<a href="#l23.199"></a><span id="l23.199">       null,</span>
<a href="#l23.200"></a><span id="l23.200" class="difflineminus">-      this.offlineBundle.getString('downloadMessagesCheckboxLabel1'),</span>
<a href="#l23.201"></a><span id="l23.201" class="difflineplus">+      this.offlineBundle.getString(&quot;downloadMessagesCheckboxLabel1&quot;),</span>
<a href="#l23.202"></a><span id="l23.202">       alwaysAsk) == 0;</span>
<a href="#l23.203"></a><span id="l23.203"> </span>
<a href="#l23.204"></a><span id="l23.204">     // if the user changed the ask me setting then update the global pref based on their yes / no answer</span>
<a href="#l23.205"></a><span id="l23.205">     if (!alwaysAsk.value)</span>
<a href="#l23.206"></a><span id="l23.206">       Services.prefs.setIntPref(&quot;offline.download.download_messages&quot;, downloadMessages ? 1 : 2);</span>
<a href="#l23.207"></a><span id="l23.207">     return downloadMessages;</span>
<a href="#l23.208"></a><span id="l23.208">   },</span>
<a href="#l23.209"></a><span id="l23.209"> </span>
<a href="#l23.210"></a><span id="l23.210">   /**</span>
<a href="#l23.211"></a><span id="l23.211">    *  Get New Mail When Offline</span>
<a href="#l23.212"></a><span id="l23.212">    *  Prompts the user about going online in order to download new messages.</span>
<a href="#l23.213"></a><span id="l23.213">    *  Based on the response, will move us back to online mode.</span>
<a href="#l23.214"></a><span id="l23.214">    *</span>
<a href="#l23.215"></a><span id="l23.215">    * @return true if the user confirms going online.</span>
<a href="#l23.216"></a><span id="l23.216">    */</span>
<a href="#l23.217"></a><span id="l23.217" class="difflineminus">-  getNewMail: function()</span>
<a href="#l23.218"></a><span id="l23.218" class="difflineminus">-  {</span>
<a href="#l23.219"></a><span id="l23.219" class="difflineplus">+  getNewMail() {</span>
<a href="#l23.220"></a><span id="l23.220">     let goOnline = Services.prompt.confirm(window,</span>
<a href="#l23.221"></a><span id="l23.221" class="difflineminus">-      this.offlineBundle.getString('getMessagesOfflineWindowTitle1'),</span>
<a href="#l23.222"></a><span id="l23.222" class="difflineminus">-      this.offlineBundle.getString('getMessagesOfflineLabel1'));</span>
<a href="#l23.223"></a><span id="l23.223" class="difflineplus">+      this.offlineBundle.getString(&quot;getMessagesOfflineWindowTitle1&quot;),</span>
<a href="#l23.224"></a><span id="l23.224" class="difflineplus">+      this.offlineBundle.getString(&quot;getMessagesOfflineLabel1&quot;));</span>
<a href="#l23.225"></a><span id="l23.225"> </span>
<a href="#l23.226"></a><span id="l23.226">     if (goOnline)</span>
<a href="#l23.227"></a><span id="l23.227">       this.offlineManager.goOnline(this.shouldSendUnsentMessages(),</span>
<a href="#l23.228"></a><span id="l23.228">                                    false /* playbackOfflineImapOperations */, msgWindow);</span>
<a href="#l23.229"></a><span id="l23.229">     return goOnline;</span>
<a href="#l23.230"></a><span id="l23.230">   },</span>
<a href="#l23.231"></a><span id="l23.231"> </span>
<a href="#l23.232"></a><span id="l23.232">   /**</span>
<a href="#l23.233"></a><span id="l23.233">    * Private helper method to update the state of the Offline menu item</span>
<a href="#l23.234"></a><span id="l23.234">    * and the offline status bar indicator</span>
<a href="#l23.235"></a><span id="l23.235">    */</span>
<a href="#l23.236"></a><span id="l23.236" class="difflineminus">-  updateOfflineUI: function(aIsOffline)</span>
<a href="#l23.237"></a><span id="l23.237" class="difflineminus">-  {</span>
<a href="#l23.238"></a><span id="l23.238" class="difflineplus">+  updateOfflineUI(aIsOffline) {</span>
<a href="#l23.239"></a><span id="l23.239">     document.getElementById(&quot;goOfflineMenuItem&quot;).setAttribute(&quot;checked&quot;, aIsOffline);</span>
<a href="#l23.240"></a><span id="l23.240">     if (document.getElementById(&quot;appmenu_goOffline&quot;))</span>
<a href="#l23.241"></a><span id="l23.241">       document.getElementById(&quot;appmenu_goOffline&quot;).setAttribute(&quot;checked&quot;, aIsOffline);</span>
<a href="#l23.242"></a><span id="l23.242">     var statusBarPanel = document.getElementById(&quot;offline-status&quot;);</span>
<a href="#l23.243"></a><span id="l23.243" class="difflineminus">-    if (aIsOffline)</span>
<a href="#l23.244"></a><span id="l23.244" class="difflineminus">-    {</span>
<a href="#l23.245"></a><span id="l23.245" class="difflineplus">+    if (aIsOffline) {</span>
<a href="#l23.246"></a><span id="l23.246">       statusBarPanel.setAttribute(&quot;offline&quot;, &quot;true&quot;);</span>
<a href="#l23.247"></a><span id="l23.247">       statusBarPanel.setAttribute(&quot;tooltiptext&quot;, this.offlineBundle.getString(&quot;offlineTooltip&quot;));</span>
<a href="#l23.248"></a><span id="l23.248" class="difflineminus">-    }</span>
<a href="#l23.249"></a><span id="l23.249" class="difflineminus">-    else</span>
<a href="#l23.250"></a><span id="l23.250" class="difflineminus">-    {</span>
<a href="#l23.251"></a><span id="l23.251" class="difflineplus">+    } else {</span>
<a href="#l23.252"></a><span id="l23.252">       statusBarPanel.removeAttribute(&quot;offline&quot;);</span>
<a href="#l23.253"></a><span id="l23.253">       statusBarPanel.setAttribute(&quot;tooltiptext&quot;, this.offlineBundle.getString(&quot;onlineTooltip&quot;));</span>
<a href="#l23.254"></a><span id="l23.254">     }</span>
<a href="#l23.255"></a><span id="l23.255">   },</span>
<a href="#l23.256"></a><span id="l23.256"> </span>
<a href="#l23.257"></a><span id="l23.257">   /**</span>
<a href="#l23.258"></a><span id="l23.258">    * private helper method called whenever we detect a change to the offline state</span>
<a href="#l23.259"></a><span id="l23.259">    */</span>
<a href="#l23.260"></a><span id="l23.260" class="difflineminus">-  mailOfflineStateChanged: function (aGoingOffline)</span>
<a href="#l23.261"></a><span id="l23.261" class="difflineminus">-  {</span>
<a href="#l23.262"></a><span id="l23.262" class="difflineplus">+  mailOfflineStateChanged(aGoingOffline) {</span>
<a href="#l23.263"></a><span id="l23.263">     this.updateOfflineUI(aGoingOffline);</span>
<a href="#l23.264"></a><span id="l23.264" class="difflineminus">-    if (!aGoingOffline)</span>
<a href="#l23.265"></a><span id="l23.265" class="difflineminus">-    {</span>
<a href="#l23.266"></a><span id="l23.266" class="difflineplus">+    if (!aGoingOffline) {</span>
<a href="#l23.267"></a><span id="l23.267">       let prefSendUnsentMessages = Services.prefs.getIntPref(&quot;offline.send.unsent_messages&quot;);</span>
<a href="#l23.268"></a><span id="l23.268">       // 0 == Ask, 1 == Always Send, 2 == Never Send</span>
<a href="#l23.269"></a><span id="l23.269">       let sendUnsentMessages = (prefSendUnsentMessages == 0 &amp;&amp;</span>
<a href="#l23.270"></a><span id="l23.270">                                 this.haveUnsentMessages() &amp;&amp;</span>
<a href="#l23.271"></a><span id="l23.271">                                 this.confirmSendUnsentMessages()) ||</span>
<a href="#l23.272"></a><span id="l23.272">                                prefSendUnsentMessages == 1;</span>
<a href="#l23.273"></a><span id="l23.273">       this.offlineManager.goOnline(sendUnsentMessages, true, msgWindow);</span>
<a href="#l23.274"></a><span id="l23.274">     }</span>
<a href="#l23.275"></a><span id="l23.275" class="difflineminus">-  }</span>
<a href="#l23.276"></a><span id="l23.276" class="difflineplus">+  },</span>
<a href="#l23.277"></a><span id="l23.277"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mail/base/content/mail3PaneWindowCommands.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mail/base/content/mail3PaneWindowCommands.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -8,22 +8,19 @@</span>
<a href="#l24.4"></a><span id="l24.4">  */</span>
<a href="#l24.5"></a><span id="l24.5"> </span>
<a href="#l24.6"></a><span id="l24.6"> ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l24.7"></a><span id="l24.7"> ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l24.8"></a><span id="l24.8"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l24.9"></a><span id="l24.9"> ChromeUtils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l24.10"></a><span id="l24.10"> </span>
<a href="#l24.11"></a><span id="l24.11"> // Controller object for folder pane</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-var FolderPaneController =</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineminus">-{</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineminus">-  supportsCommand: function(command)</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineminus">-  {</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineminus">-    switch ( command )</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineminus">-    {</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineplus">+var FolderPaneController = {</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineplus">+  supportsCommand(command) {</span>
<a href="#l24.20"></a><span id="l24.20" class="difflineplus">+    switch (command) {</span>
<a href="#l24.21"></a><span id="l24.21">       case &quot;cmd_delete&quot;:</span>
<a href="#l24.22"></a><span id="l24.22">       case &quot;cmd_shiftDelete&quot;:</span>
<a href="#l24.23"></a><span id="l24.23">       case &quot;button_delete&quot;:</span>
<a href="#l24.24"></a><span id="l24.24">       case &quot;button_shiftDelete&quot;:</span>
<a href="#l24.25"></a><span id="l24.25">         // Even if the folder pane has focus, don't do a folder delete if</span>
<a href="#l24.26"></a><span id="l24.26">         // we have a selected message, but do a message delete instead.</span>
<a href="#l24.27"></a><span id="l24.27">         // Return false here supportsCommand and let the command fall back</span>
<a href="#l24.28"></a><span id="l24.28">         // to the DefaultController.</span>
<a href="#l24.29"></a><span id="l24.29" class="difflineat">@@ -35,20 +32,18 @@ var FolderPaneController =</span>
<a href="#l24.30"></a><span id="l24.30">       case &quot;cmd_paste&quot;:</span>
<a href="#l24.31"></a><span id="l24.31">         return true;</span>
<a href="#l24.32"></a><span id="l24.32"> </span>
<a href="#l24.33"></a><span id="l24.33">       default:</span>
<a href="#l24.34"></a><span id="l24.34">         return false;</span>
<a href="#l24.35"></a><span id="l24.35">     }</span>
<a href="#l24.36"></a><span id="l24.36">   },</span>
<a href="#l24.37"></a><span id="l24.37"> </span>
<a href="#l24.38"></a><span id="l24.38" class="difflineminus">-  isCommandEnabled: function(command)</span>
<a href="#l24.39"></a><span id="l24.39" class="difflineminus">-  {</span>
<a href="#l24.40"></a><span id="l24.40" class="difflineminus">-    switch ( command )</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineminus">-    {</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineplus">+  isCommandEnabled(command) {</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineplus">+    switch (command) {</span>
<a href="#l24.44"></a><span id="l24.44">       case &quot;cmd_cut&quot;:</span>
<a href="#l24.45"></a><span id="l24.45">       case &quot;cmd_copy&quot;:</span>
<a href="#l24.46"></a><span id="l24.46">       case &quot;cmd_paste&quot;:</span>
<a href="#l24.47"></a><span id="l24.47">         return false;</span>
<a href="#l24.48"></a><span id="l24.48">       case &quot;cmd_delete&quot;:</span>
<a href="#l24.49"></a><span id="l24.49">       case &quot;cmd_shiftDelete&quot;:</span>
<a href="#l24.50"></a><span id="l24.50">       case &quot;button_delete&quot;:</span>
<a href="#l24.51"></a><span id="l24.51">       case &quot;button_shiftDelete&quot;:</span>
<a href="#l24.52"></a><span id="l24.52" class="difflineat">@@ -56,71 +51,62 @@ var FolderPaneController =</span>
<a href="#l24.53"></a><span id="l24.53">         // Make sure the button doesn't show &quot;Undelete&quot; for folders.</span>
<a href="#l24.54"></a><span id="l24.54">         UpdateDeleteToolbarButton();</span>
<a href="#l24.55"></a><span id="l24.55">         let folders = gFolderTreeView.getSelectedFolders();</span>
<a href="#l24.56"></a><span id="l24.56">         if (folders.length) {</span>
<a href="#l24.57"></a><span id="l24.57">           // XXX Figure out some better way/place to update the folder labels.</span>
<a href="#l24.58"></a><span id="l24.58">           UpdateDeleteLabelsFromFolderCommand(folders[0], command);</span>
<a href="#l24.59"></a><span id="l24.59">           return CanDeleteFolder(folders[0]) &amp;&amp; folders[0].isCommandEnabled(command);</span>
<a href="#l24.60"></a><span id="l24.60">         }</span>
<a href="#l24.61"></a><span id="l24.61" class="difflineminus">-        else</span>
<a href="#l24.62"></a><span id="l24.62" class="difflineminus">-          return false;</span>
<a href="#l24.63"></a><span id="l24.63" class="difflineplus">+        return false;</span>
<a href="#l24.64"></a><span id="l24.64">       }</span>
<a href="#l24.65"></a><span id="l24.65">       default:</span>
<a href="#l24.66"></a><span id="l24.66">         return false;</span>
<a href="#l24.67"></a><span id="l24.67">     }</span>
<a href="#l24.68"></a><span id="l24.68">   },</span>
<a href="#l24.69"></a><span id="l24.69"> </span>
<a href="#l24.70"></a><span id="l24.70" class="difflineminus">-  doCommand: function(command)</span>
<a href="#l24.71"></a><span id="l24.71" class="difflineminus">-  {</span>
<a href="#l24.72"></a><span id="l24.72" class="difflineplus">+  doCommand(command) {</span>
<a href="#l24.73"></a><span id="l24.73">     // if the user invoked a key short cut then it is possible that we got here for a command which is</span>
<a href="#l24.74"></a><span id="l24.74">     // really disabled. kick out if the command should be disabled.</span>
<a href="#l24.75"></a><span id="l24.75">     if (!this.isCommandEnabled(command)) return;</span>
<a href="#l24.76"></a><span id="l24.76"> </span>
<a href="#l24.77"></a><span id="l24.77" class="difflineminus">-    switch ( command )</span>
<a href="#l24.78"></a><span id="l24.78" class="difflineminus">-    {</span>
<a href="#l24.79"></a><span id="l24.79" class="difflineplus">+    switch (command) {</span>
<a href="#l24.80"></a><span id="l24.80">       case &quot;cmd_delete&quot;:</span>
<a href="#l24.81"></a><span id="l24.81">       case &quot;cmd_shiftDelete&quot;:</span>
<a href="#l24.82"></a><span id="l24.82">       case &quot;button_delete&quot;:</span>
<a href="#l24.83"></a><span id="l24.83">       case &quot;button_shiftDelete&quot;:</span>
<a href="#l24.84"></a><span id="l24.84">       case &quot;cmd_deleteFolder&quot;:</span>
<a href="#l24.85"></a><span id="l24.85">         gFolderTreeController.deleteFolder();</span>
<a href="#l24.86"></a><span id="l24.86">         break;</span>
<a href="#l24.87"></a><span id="l24.87">     }</span>
<a href="#l24.88"></a><span id="l24.88">   },</span>
<a href="#l24.89"></a><span id="l24.89"> </span>
<a href="#l24.90"></a><span id="l24.90" class="difflineminus">-  onEvent: function(event)</span>
<a href="#l24.91"></a><span id="l24.91" class="difflineminus">-  {</span>
<a href="#l24.92"></a><span id="l24.92" class="difflineminus">-  }</span>
<a href="#l24.93"></a><span id="l24.93" class="difflineplus">+  onEvent(event) {</span>
<a href="#l24.94"></a><span id="l24.94" class="difflineplus">+  },</span>
<a href="#l24.95"></a><span id="l24.95"> };</span>
<a href="#l24.96"></a><span id="l24.96"> </span>
<a href="#l24.97"></a><span id="l24.97" class="difflineminus">-function UpdateDeleteLabelsFromFolderCommand(folder, command)</span>
<a href="#l24.98"></a><span id="l24.98" class="difflineminus">-{</span>
<a href="#l24.99"></a><span id="l24.99" class="difflineplus">+function UpdateDeleteLabelsFromFolderCommand(folder, command) {</span>
<a href="#l24.100"></a><span id="l24.100">   if (command != &quot;cmd_delete&quot;)</span>
<a href="#l24.101"></a><span id="l24.101">     return;</span>
<a href="#l24.102"></a><span id="l24.102"> </span>
<a href="#l24.103"></a><span id="l24.103">   if (folder.getFlag(Ci.nsMsgFolderFlags.Virtual)) {</span>
<a href="#l24.104"></a><span id="l24.104">     goSetMenuValue(command, &quot;valueFolder&quot;);</span>
<a href="#l24.105"></a><span id="l24.105" class="difflineminus">-  }</span>
<a href="#l24.106"></a><span id="l24.106" class="difflineminus">-  else if (folder.server.type == &quot;nntp&quot;) {</span>
<a href="#l24.107"></a><span id="l24.107" class="difflineplus">+  } else if (folder.server.type == &quot;nntp&quot;) {</span>
<a href="#l24.108"></a><span id="l24.108">     goSetMenuValue(command, &quot;valueNewsgroup&quot;);</span>
<a href="#l24.109"></a><span id="l24.109">     goSetAccessKey(command, &quot;valueNewsgroupAccessKey&quot;);</span>
<a href="#l24.110"></a><span id="l24.110" class="difflineminus">-  }</span>
<a href="#l24.111"></a><span id="l24.111" class="difflineminus">-  else {</span>
<a href="#l24.112"></a><span id="l24.112" class="difflineplus">+  } else {</span>
<a href="#l24.113"></a><span id="l24.113">     goSetMenuValue(command, &quot;valueFolder&quot;);</span>
<a href="#l24.114"></a><span id="l24.114">   }</span>
<a href="#l24.115"></a><span id="l24.115"> }</span>
<a href="#l24.116"></a><span id="l24.116"> </span>
<a href="#l24.117"></a><span id="l24.117"> // DefaultController object (handles commands when one of the trees does not have focus)</span>
<a href="#l24.118"></a><span id="l24.118" class="difflineminus">-var DefaultController =</span>
<a href="#l24.119"></a><span id="l24.119" class="difflineminus">-{</span>
<a href="#l24.120"></a><span id="l24.120" class="difflineminus">-  supportsCommand: function(command)</span>
<a href="#l24.121"></a><span id="l24.121" class="difflineminus">-  {</span>
<a href="#l24.122"></a><span id="l24.122" class="difflineminus">-    switch ( command )</span>
<a href="#l24.123"></a><span id="l24.123" class="difflineminus">-    {</span>
<a href="#l24.124"></a><span id="l24.124" class="difflineplus">+var DefaultController = {</span>
<a href="#l24.125"></a><span id="l24.125" class="difflineplus">+  /* eslint-disable complexity */</span>
<a href="#l24.126"></a><span id="l24.126" class="difflineplus">+  supportsCommand(command) {</span>
<a href="#l24.127"></a><span id="l24.127" class="difflineplus">+    switch (command) {</span>
<a href="#l24.128"></a><span id="l24.128">       case &quot;cmd_createFilterFromPopup&quot;:</span>
<a href="#l24.129"></a><span id="l24.129">       case &quot;cmd_archive&quot;:</span>
<a href="#l24.130"></a><span id="l24.130">       case &quot;button_archive&quot;:</span>
<a href="#l24.131"></a><span id="l24.131">       case &quot;cmd_newMessage&quot;:</span>
<a href="#l24.132"></a><span id="l24.132">       case &quot;cmd_reply&quot;:</span>
<a href="#l24.133"></a><span id="l24.133">       case &quot;button_reply&quot;:</span>
<a href="#l24.134"></a><span id="l24.134">       case &quot;cmd_replySender&quot;:</span>
<a href="#l24.135"></a><span id="l24.135">       case &quot;cmd_replyGroup&quot;:</span>
<a href="#l24.136"></a><span id="l24.136" class="difflineat">@@ -265,20 +251,18 @@ var DefaultController =</span>
<a href="#l24.137"></a><span id="l24.137">       case &quot;cmd_chatStatus&quot;:</span>
<a href="#l24.138"></a><span id="l24.138">         return !!chatHandler;</span>
<a href="#l24.139"></a><span id="l24.139"> </span>
<a href="#l24.140"></a><span id="l24.140">       default:</span>
<a href="#l24.141"></a><span id="l24.141">         return false;</span>
<a href="#l24.142"></a><span id="l24.142">     }</span>
<a href="#l24.143"></a><span id="l24.143">   },</span>
<a href="#l24.144"></a><span id="l24.144"> </span>
<a href="#l24.145"></a><span id="l24.145" class="difflineminus">-  isCommandEnabled: function(command)</span>
<a href="#l24.146"></a><span id="l24.146" class="difflineminus">-  {</span>
<a href="#l24.147"></a><span id="l24.147" class="difflineminus">-    switch (command)</span>
<a href="#l24.148"></a><span id="l24.148" class="difflineminus">-    {</span>
<a href="#l24.149"></a><span id="l24.149" class="difflineplus">+  isCommandEnabled(command) {</span>
<a href="#l24.150"></a><span id="l24.150" class="difflineplus">+    switch (command) {</span>
<a href="#l24.151"></a><span id="l24.151">       case &quot;cmd_delete&quot;:</span>
<a href="#l24.152"></a><span id="l24.152">         UpdateDeleteCommand();</span>
<a href="#l24.153"></a><span id="l24.153">         // fall through</span>
<a href="#l24.154"></a><span id="l24.154">       case &quot;button_delete&quot;:</span>
<a href="#l24.155"></a><span id="l24.155">         UpdateDeleteToolbarButton();</span>
<a href="#l24.156"></a><span id="l24.156">         return gFolderDisplay.getCommandStatus(nsMsgViewCommandType.deleteMsg);</span>
<a href="#l24.157"></a><span id="l24.157">       case &quot;cmd_shiftDelete&quot;:</span>
<a href="#l24.158"></a><span id="l24.158">       case &quot;button_shiftDelete&quot;:</span>
<a href="#l24.159"></a><span id="l24.159" class="difflineat">@@ -338,40 +322,38 @@ var DefaultController =</span>
<a href="#l24.160"></a><span id="l24.160">       case &quot;cmd_editTemplateMsg&quot;:</span>
<a href="#l24.161"></a><span id="l24.161">       case &quot;cmd_openMessage&quot;:</span>
<a href="#l24.162"></a><span id="l24.162">       case &quot;button_print&quot;:</span>
<a href="#l24.163"></a><span id="l24.163">       case &quot;cmd_print&quot;:</span>
<a href="#l24.164"></a><span id="l24.164">       case &quot;cmd_viewPageSource&quot;:</span>
<a href="#l24.165"></a><span id="l24.165">       case &quot;cmd_reload&quot;:</span>
<a href="#l24.166"></a><span id="l24.166">       case &quot;cmd_applyFiltersToSelection&quot;:</span>
<a href="#l24.167"></a><span id="l24.167">         let numSelected = gFolderDisplay.selectedCount;</span>
<a href="#l24.168"></a><span id="l24.168" class="difflineminus">-        if (command == &quot;cmd_applyFiltersToSelection&quot;)</span>
<a href="#l24.169"></a><span id="l24.169" class="difflineminus">-        {</span>
<a href="#l24.170"></a><span id="l24.170" class="difflineplus">+        if (command == &quot;cmd_applyFiltersToSelection&quot;) {</span>
<a href="#l24.171"></a><span id="l24.171">           var whichText = &quot;valueMessage&quot;;</span>
<a href="#l24.172"></a><span id="l24.172">           if (numSelected &gt; 1)</span>
<a href="#l24.173"></a><span id="l24.173">             whichText = &quot;valueSelection&quot;;</span>
<a href="#l24.174"></a><span id="l24.174">           goSetMenuValue(command, whichText);</span>
<a href="#l24.175"></a><span id="l24.175">           goSetAccessKey(command, whichText + &quot;AccessKey&quot;);</span>
<a href="#l24.176"></a><span id="l24.176">         }</span>
<a href="#l24.177"></a><span id="l24.177" class="difflineminus">-        if (numSelected &gt; 0)</span>
<a href="#l24.178"></a><span id="l24.178" class="difflineminus">-        {</span>
<a href="#l24.179"></a><span id="l24.179" class="difflineplus">+        if (numSelected &gt; 0) {</span>
<a href="#l24.180"></a><span id="l24.180">           if (!gFolderDisplay.getCommandStatus(nsMsgViewCommandType.cmdRequiringMsgBody))</span>
<a href="#l24.181"></a><span id="l24.181">             return false;</span>
<a href="#l24.182"></a><span id="l24.182"> </span>
<a href="#l24.183"></a><span id="l24.183">           // Check if we have a collapsed thread selected and are summarizing it.</span>
<a href="#l24.184"></a><span id="l24.184">           // If so, selectedIndices.length won't match numSelected. Also check</span>
<a href="#l24.185"></a><span id="l24.185">           // that we're not displaying a message, which handles the case</span>
<a href="#l24.186"></a><span id="l24.186">           // where we failed to summarize the selection and fell back to</span>
<a href="#l24.187"></a><span id="l24.187">           // displaying a message.</span>
<a href="#l24.188"></a><span id="l24.188">           if (gFolderDisplay.selectedIndices.length != numSelected &amp;&amp;</span>
<a href="#l24.189"></a><span id="l24.189">               command != &quot;cmd_applyFiltersToSelection&quot; &amp;&amp;</span>
<a href="#l24.190"></a><span id="l24.190">               gDBView &amp;&amp; gDBView.currentlyDisplayedMessage == nsMsgViewIndex_None)</span>
<a href="#l24.191"></a><span id="l24.191">             return false;</span>
<a href="#l24.192"></a><span id="l24.192">           if (command == &quot;cmd_reply&quot; || command == &quot;button_reply&quot; ||</span>
<a href="#l24.193"></a><span id="l24.193" class="difflineminus">-              command == &quot;cmd_replyall&quot; ||command == &quot;button_replyall&quot;)</span>
<a href="#l24.194"></a><span id="l24.194" class="difflineplus">+              command == &quot;cmd_replyall&quot; || command == &quot;button_replyall&quot;)</span>
<a href="#l24.195"></a><span id="l24.195">             return IsReplyEnabled();</span>
<a href="#l24.196"></a><span id="l24.196">           if (command == &quot;cmd_replylist&quot; || command == &quot;button_replylist&quot;)</span>
<a href="#l24.197"></a><span id="l24.197">             return IsReplyListEnabled();</span>
<a href="#l24.198"></a><span id="l24.198">           return true;</span>
<a href="#l24.199"></a><span id="l24.199">         }</span>
<a href="#l24.200"></a><span id="l24.200">         return false;</span>
<a href="#l24.201"></a><span id="l24.201">       case &quot;cmd_printpreview&quot;:</span>
<a href="#l24.202"></a><span id="l24.202">         if (gFolderDisplay.selectedCount == 1)</span>
<a href="#l24.203"></a><span id="l24.203" class="difflineat">@@ -524,49 +506,48 @@ var DefaultController =</span>
<a href="#l24.204"></a><span id="l24.204">       {</span>
<a href="#l24.205"></a><span id="l24.205">         let folder = GetSelectedMsgFolders()[0];</span>
<a href="#l24.206"></a><span id="l24.206">         return folder &amp;&amp; folder.server.canEmptyTrashOnExit ?</span>
<a href="#l24.207"></a><span id="l24.207">                          IsMailFolderSelected() : false;</span>
<a href="#l24.208"></a><span id="l24.208">       }</span>
<a href="#l24.209"></a><span id="l24.209">       case &quot;button_compact&quot;:</span>
<a href="#l24.210"></a><span id="l24.210">       {</span>
<a href="#l24.211"></a><span id="l24.211">         let folders = gFolderTreeView.getSelectedFolders();</span>
<a href="#l24.212"></a><span id="l24.212" class="difflineminus">-        let canCompact = function canCompact(folder) {</span>
<a href="#l24.213"></a><span id="l24.213" class="difflineplus">+        let canCompact = function(folder) {</span>
<a href="#l24.214"></a><span id="l24.214">           return !folder.isServer &amp;&amp;</span>
<a href="#l24.215"></a><span id="l24.215">             !(folder.getFlag(Ci.nsMsgFolderFlags.Virtual)) &amp;&amp;</span>
<a href="#l24.216"></a><span id="l24.216">             (folder.server.type != &quot;imap&quot; || folder.server.canCompactFoldersOnServer) &amp;&amp;</span>
<a href="#l24.217"></a><span id="l24.217">             folder.isCommandEnabled(&quot;button_compact&quot;);</span>
<a href="#l24.218"></a><span id="l24.218" class="difflineminus">-        }</span>
<a href="#l24.219"></a><span id="l24.219" class="difflineplus">+        };</span>
<a href="#l24.220"></a><span id="l24.220">         return folders &amp;&amp; folders.every(canCompact);</span>
<a href="#l24.221"></a><span id="l24.221">       }</span>
<a href="#l24.222"></a><span id="l24.222">       case &quot;cmd_compactFolder&quot;:</span>
<a href="#l24.223"></a><span id="l24.223">       {</span>
<a href="#l24.224"></a><span id="l24.224">         let folders = gFolderTreeView.getSelectedFolders();</span>
<a href="#l24.225"></a><span id="l24.225" class="difflineminus">-        let canCompactAll = function canCompactAll(folder) {</span>
<a href="#l24.226"></a><span id="l24.226" class="difflineplus">+        let canCompactAll = function(folder) {</span>
<a href="#l24.227"></a><span id="l24.227">           return (folder.server.type != &quot;imap&quot; ||</span>
<a href="#l24.228"></a><span id="l24.228">                   folder.server.canCompactFoldersOnServer) &amp;&amp;</span>
<a href="#l24.229"></a><span id="l24.229" class="difflineminus">-                  folder.isCommandEnabled(&quot;cmd_compactFolder&quot;) ;</span>
<a href="#l24.230"></a><span id="l24.230" class="difflineminus">-        }</span>
<a href="#l24.231"></a><span id="l24.231" class="difflineplus">+                  folder.isCommandEnabled(&quot;cmd_compactFolder&quot;);</span>
<a href="#l24.232"></a><span id="l24.232" class="difflineplus">+        };</span>
<a href="#l24.233"></a><span id="l24.233">         return folders &amp;&amp; folders.every(canCompactAll);</span>
<a href="#l24.234"></a><span id="l24.234">       }</span>
<a href="#l24.235"></a><span id="l24.235">       case &quot;cmd_setFolderCharset&quot;:</span>
<a href="#l24.236"></a><span id="l24.236">         return IsFolderCharsetEnabled();</span>
<a href="#l24.237"></a><span id="l24.237">       case &quot;cmd_downloadFlagged&quot;:</span>
<a href="#l24.238"></a><span id="l24.238" class="difflineminus">-        return(IsFolderSelected() &amp;&amp; MailOfflineMgr.isOnline());</span>
<a href="#l24.239"></a><span id="l24.239" class="difflineplus">+        return (IsFolderSelected() &amp;&amp; MailOfflineMgr.isOnline());</span>
<a href="#l24.240"></a><span id="l24.240">       case &quot;cmd_downloadSelected&quot;:</span>
<a href="#l24.241"></a><span id="l24.241">         return (IsFolderSelected() &amp;&amp; MailOfflineMgr.isOnline() &amp;&amp; gFolderDisplay.selectedCount &gt; 0);</span>
<a href="#l24.242"></a><span id="l24.242">       case &quot;cmd_synchronizeOffline&quot;:</span>
<a href="#l24.243"></a><span id="l24.243">         return MailOfflineMgr.isOnline();</span>
<a href="#l24.244"></a><span id="l24.244">       case &quot;cmd_settingsOffline&quot;:</span>
<a href="#l24.245"></a><span id="l24.245">         return IsAccountOfflineEnabled();</span>
<a href="#l24.246"></a><span id="l24.246">       case &quot;cmd_moveToFolderAgain&quot;:</span>
<a href="#l24.247"></a><span id="l24.247">         // Disable &quot;Move to &lt;folder&gt; Again&quot; for news and other read only</span>
<a href="#l24.248"></a><span id="l24.248">         // folders since we can't really move messages from there - only copy.</span>
<a href="#l24.249"></a><span id="l24.249" class="difflineminus">-        if (Services.prefs.getBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;))</span>
<a href="#l24.250"></a><span id="l24.250" class="difflineminus">-        {</span>
<a href="#l24.251"></a><span id="l24.251" class="difflineplus">+        if (Services.prefs.getBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;)) {</span>
<a href="#l24.252"></a><span id="l24.252">           let loadedFolder = gFolderTreeView.getSelectedFolders()[0];</span>
<a href="#l24.253"></a><span id="l24.253">           if (loadedFolder &amp;&amp; !loadedFolder.canDeleteMessages)</span>
<a href="#l24.254"></a><span id="l24.254">             return false;</span>
<a href="#l24.255"></a><span id="l24.255">         }</span>
<a href="#l24.256"></a><span id="l24.256">         let targetURI = Services.prefs.getCharPref(&quot;mail.last_msg_movecopy_target_uri&quot;);</span>
<a href="#l24.257"></a><span id="l24.257">         if (!targetURI)</span>
<a href="#l24.258"></a><span id="l24.258">           return false;</span>
<a href="#l24.259"></a><span id="l24.259">         let targetFolder = MailUtils.getFolderForURI(targetURI);</span>
<a href="#l24.260"></a><span id="l24.260" class="difflineat">@@ -588,32 +569,27 @@ var DefaultController =</span>
<a href="#l24.261"></a><span id="l24.261">       case &quot;cmd_newVirtualFolder&quot;:</span>
<a href="#l24.262"></a><span id="l24.262">         return !!gFolderTreeController;</span>
<a href="#l24.263"></a><span id="l24.263">       case &quot;cmd_goFolder&quot;:</span>
<a href="#l24.264"></a><span id="l24.264">         return !!gFolderTreeView;</span>
<a href="#l24.265"></a><span id="l24.265">       case &quot;cmd_joinChat&quot;:</span>
<a href="#l24.266"></a><span id="l24.266">       case &quot;cmd_addChatBuddy&quot;:</span>
<a href="#l24.267"></a><span id="l24.267">       case &quot;cmd_chatStatus&quot;:</span>
<a href="#l24.268"></a><span id="l24.268">         return !!chatHandler;</span>
<a href="#l24.269"></a><span id="l24.269" class="difflineminus">-</span>
<a href="#l24.270"></a><span id="l24.270" class="difflineminus">-      default:</span>
<a href="#l24.271"></a><span id="l24.271" class="difflineminus">-        return false;</span>
<a href="#l24.272"></a><span id="l24.272">     }</span>
<a href="#l24.273"></a><span id="l24.273">     return false;</span>
<a href="#l24.274"></a><span id="l24.274">   },</span>
<a href="#l24.275"></a><span id="l24.275"> </span>
<a href="#l24.276"></a><span id="l24.276" class="difflineminus">-  doCommand: function(command, aTab)</span>
<a href="#l24.277"></a><span id="l24.277" class="difflineminus">-  {</span>
<a href="#l24.278"></a><span id="l24.278" class="difflineplus">+  doCommand(command, aTab) {</span>
<a href="#l24.279"></a><span id="l24.279">     // If the user invoked a key short cut then it is possible that we got here</span>
<a href="#l24.280"></a><span id="l24.280">     // for a command which is really disabled. Kick out if the command should be disabled.</span>
<a href="#l24.281"></a><span id="l24.281">     if (!this.isCommandEnabled(command))</span>
<a href="#l24.282"></a><span id="l24.282">       return;</span>
<a href="#l24.283"></a><span id="l24.283"> </span>
<a href="#l24.284"></a><span id="l24.284" class="difflineminus">-    switch ( command )</span>
<a href="#l24.285"></a><span id="l24.285" class="difflineminus">-    {</span>
<a href="#l24.286"></a><span id="l24.286" class="difflineplus">+    switch (command) {</span>
<a href="#l24.287"></a><span id="l24.287">       case &quot;button_getNewMessages&quot;:</span>
<a href="#l24.288"></a><span id="l24.288">       case &quot;cmd_getNewMessages&quot;:</span>
<a href="#l24.289"></a><span id="l24.289">         MsgGetMessage();</span>
<a href="#l24.290"></a><span id="l24.290">         break;</span>
<a href="#l24.291"></a><span id="l24.291">       case &quot;cmd_getMsgsForAuthAccounts&quot;:</span>
<a href="#l24.292"></a><span id="l24.292">         MsgGetMessagesForAllAuthenticatedAccounts();</span>
<a href="#l24.293"></a><span id="l24.293">         break;</span>
<a href="#l24.294"></a><span id="l24.294">       case &quot;cmd_getNextNMessages&quot;:</span>
<a href="#l24.295"></a><span id="l24.295" class="difflineat">@@ -694,31 +670,29 @@ var DefaultController =</span>
<a href="#l24.296"></a><span id="l24.296">         break;</span>
<a href="#l24.297"></a><span id="l24.297">       case &quot;cmd_deleteFolder&quot;:</span>
<a href="#l24.298"></a><span id="l24.298">         gFolderTreeController.deleteFolder();</span>
<a href="#l24.299"></a><span id="l24.299">         break;</span>
<a href="#l24.300"></a><span id="l24.300">       case &quot;cmd_killThread&quot;:</span>
<a href="#l24.301"></a><span id="l24.301">         if (!gFolderDisplay.selectedMessageIsNews) {</span>
<a href="#l24.302"></a><span id="l24.302">           if (!gFolderDisplay.selectedMessageThreadIgnored) {</span>
<a href="#l24.303"></a><span id="l24.303">             ShowIgnoredMessageNotification(gFolderDisplay.selectedMessages, false);</span>
<a href="#l24.304"></a><span id="l24.304" class="difflineminus">-          }</span>
<a href="#l24.305"></a><span id="l24.305" class="difflineminus">-          else {</span>
<a href="#l24.306"></a><span id="l24.306" class="difflineplus">+          } else {</span>
<a href="#l24.307"></a><span id="l24.307">             document.getElementById(&quot;msg-footer-notification-box&quot;)</span>
<a href="#l24.308"></a><span id="l24.308">                     .removeTransientNotifications();</span>
<a href="#l24.309"></a><span id="l24.309">           }</span>
<a href="#l24.310"></a><span id="l24.310">         }</span>
<a href="#l24.311"></a><span id="l24.311">         // kill thread kills the thread and then does a next unread</span>
<a href="#l24.312"></a><span id="l24.312">         GoNextMessage(nsMsgNavigationType.toggleThreadKilled, true);</span>
<a href="#l24.313"></a><span id="l24.313">         break;</span>
<a href="#l24.314"></a><span id="l24.314">       case &quot;cmd_killSubthread&quot;:</span>
<a href="#l24.315"></a><span id="l24.315">         if (!gFolderDisplay.selectedMessageIsNews) {</span>
<a href="#l24.316"></a><span id="l24.316">           if (!gFolderDisplay.selectedMessageSubthreadIgnored) {</span>
<a href="#l24.317"></a><span id="l24.317">             ShowIgnoredMessageNotification(gFolderDisplay.selectedMessages, true);</span>
<a href="#l24.318"></a><span id="l24.318" class="difflineminus">-          }</span>
<a href="#l24.319"></a><span id="l24.319" class="difflineminus">-          else {</span>
<a href="#l24.320"></a><span id="l24.320" class="difflineplus">+          } else {</span>
<a href="#l24.321"></a><span id="l24.321">             document.getElementById(&quot;msg-footer-notification-box&quot;)</span>
<a href="#l24.322"></a><span id="l24.322">                     .removeTransientNotifications();</span>
<a href="#l24.323"></a><span id="l24.323">           }</span>
<a href="#l24.324"></a><span id="l24.324">         }</span>
<a href="#l24.325"></a><span id="l24.325">         GoNextMessage(nsMsgNavigationType.toggleSubthreadKilled, true);</span>
<a href="#l24.326"></a><span id="l24.326">         break;</span>
<a href="#l24.327"></a><span id="l24.327">       case &quot;cmd_watchThread&quot;:</span>
<a href="#l24.328"></a><span id="l24.328">         gFolderDisplay.doCommand(nsMsgViewCommandType.toggleThreadWatched);</span>
<a href="#l24.329"></a><span id="l24.329" class="difflineat">@@ -1019,26 +993,25 @@ var DefaultController =</span>
<a href="#l24.330"></a><span id="l24.330">       case &quot;cmd_joinChat&quot;:</span>
<a href="#l24.331"></a><span id="l24.331">         chatHandler.joinChat();</span>
<a href="#l24.332"></a><span id="l24.332">         break;</span>
<a href="#l24.333"></a><span id="l24.333">       case &quot;cmd_addChatBuddy&quot;:</span>
<a href="#l24.334"></a><span id="l24.334">         chatHandler.addBuddy();</span>
<a href="#l24.335"></a><span id="l24.335">         break;</span>
<a href="#l24.336"></a><span id="l24.336">     }</span>
<a href="#l24.337"></a><span id="l24.337">   },</span>
<a href="#l24.338"></a><span id="l24.338" class="difflineplus">+  /* eslint-enable complexity */</span>
<a href="#l24.339"></a><span id="l24.339"> </span>
<a href="#l24.340"></a><span id="l24.340" class="difflineminus">-  onEvent: function(event)</span>
<a href="#l24.341"></a><span id="l24.341" class="difflineminus">-  {</span>
<a href="#l24.342"></a><span id="l24.342" class="difflineplus">+  onEvent(event) {</span>
<a href="#l24.343"></a><span id="l24.343">     // on blur events set the menu item texts back to the normal values</span>
<a href="#l24.344"></a><span id="l24.344" class="difflineminus">-    if ( event == 'blur' )</span>
<a href="#l24.345"></a><span id="l24.345" class="difflineminus">-    {</span>
<a href="#l24.346"></a><span id="l24.346" class="difflineminus">-      goSetMenuValue('cmd_undo', 'valueDefault');</span>
<a href="#l24.347"></a><span id="l24.347" class="difflineminus">-      goSetMenuValue('cmd_redo', 'valueDefault');</span>
<a href="#l24.348"></a><span id="l24.348" class="difflineplus">+    if (event == &quot;blur&quot;) {</span>
<a href="#l24.349"></a><span id="l24.349" class="difflineplus">+      goSetMenuValue(&quot;cmd_undo&quot;, &quot;valueDefault&quot;);</span>
<a href="#l24.350"></a><span id="l24.350" class="difflineplus">+      goSetMenuValue(&quot;cmd_redo&quot;, &quot;valueDefault&quot;);</span>
<a href="#l24.351"></a><span id="l24.351">     }</span>
<a href="#l24.352"></a><span id="l24.352" class="difflineminus">-  }</span>
<a href="#l24.353"></a><span id="l24.353" class="difflineplus">+  },</span>
<a href="#l24.354"></a><span id="l24.354"> };</span>
<a href="#l24.355"></a><span id="l24.355"> </span>
<a href="#l24.356"></a><span id="l24.356"> /**</span>
<a href="#l24.357"></a><span id="l24.357">  * Show a notification in the message pane footer, allowing the user to learn</span>
<a href="#l24.358"></a><span id="l24.358">  * more about the ignore thread feature, and also allowing undo ignore thread.</span>
<a href="#l24.359"></a><span id="l24.359">  * @param aMsgs the messages that were ignore</span>
<a href="#l24.360"></a><span id="l24.360">  * @param aSubThread only boolean indicating if it was ignore subthread or</span>
<a href="#l24.361"></a><span id="l24.361">  *                   ignore thread</span>
<a href="#l24.362"></a><span id="l24.362" class="difflineat">@@ -1049,96 +1022,90 @@ function ShowIgnoredMessageNotification(</span>
<a href="#l24.363"></a><span id="l24.363"> </span>
<a href="#l24.364"></a><span id="l24.364">   let bundle = new StringBundle(&quot;chrome://messenger/locale/messenger.properties&quot;);</span>
<a href="#l24.365"></a><span id="l24.365"> </span>
<a href="#l24.366"></a><span id="l24.366">   let buttons = [</span>
<a href="#l24.367"></a><span id="l24.367">     {</span>
<a href="#l24.368"></a><span id="l24.368">       label:     bundle.get(&quot;learnMoreAboutIgnoreThread&quot;),</span>
<a href="#l24.369"></a><span id="l24.369">       accessKey: bundle.get(&quot;learnMoreAboutIgnoreThreadAccessKey&quot;),</span>
<a href="#l24.370"></a><span id="l24.370">       popup:     null,</span>
<a href="#l24.371"></a><span id="l24.371" class="difflineminus">-      callback:  function(aNotificationBar, aButton) {</span>
<a href="#l24.372"></a><span id="l24.372" class="difflineplus">+      callback(aNotificationBar, aButton) {</span>
<a href="#l24.373"></a><span id="l24.373">         let url = Services.prefs.getCharPref(&quot;mail.ignore_thread.learn_more_url&quot;);</span>
<a href="#l24.374"></a><span id="l24.374">         openContentTab(url);</span>
<a href="#l24.375"></a><span id="l24.375">         return true; // keep notification open</span>
<a href="#l24.376"></a><span id="l24.376" class="difflineminus">-      }</span>
<a href="#l24.377"></a><span id="l24.377" class="difflineplus">+      },</span>
<a href="#l24.378"></a><span id="l24.378">     },</span>
<a href="#l24.379"></a><span id="l24.379">     {</span>
<a href="#l24.380"></a><span id="l24.380" class="difflineminus">-      label:     bundle.get(!aSubthreadOnly ? &quot;undoIgnoreThread&quot;:</span>
<a href="#l24.381"></a><span id="l24.381" class="difflineplus">+      label:     bundle.get(!aSubthreadOnly ? &quot;undoIgnoreThread&quot; :</span>
<a href="#l24.382"></a><span id="l24.382">                                               &quot;undoIgnoreSubthread&quot;),</span>
<a href="#l24.383"></a><span id="l24.383" class="difflineminus">-      accessKey: bundle.get(!aSubthreadOnly ? &quot;undoIgnoreThreadAccessKey&quot;:</span>
<a href="#l24.384"></a><span id="l24.384" class="difflineplus">+      accessKey: bundle.get(!aSubthreadOnly ? &quot;undoIgnoreThreadAccessKey&quot; :</span>
<a href="#l24.385"></a><span id="l24.385">                                               &quot;undoIgnoreSubthreadAccessKey&quot;),</span>
<a href="#l24.386"></a><span id="l24.386">       isDefault: true,</span>
<a href="#l24.387"></a><span id="l24.387">       popup:     null,</span>
<a href="#l24.388"></a><span id="l24.388" class="difflineminus">-      callback:  function(aNotificationBar, aButton) {</span>
<a href="#l24.389"></a><span id="l24.389" class="difflineplus">+      callback(aNotificationBar, aButton) {</span>
<a href="#l24.390"></a><span id="l24.390">         aMsgs.forEach(function(msg) {</span>
<a href="#l24.391"></a><span id="l24.391">           let msgDb = msg.folder.msgDatabase;</span>
<a href="#l24.392"></a><span id="l24.392">           if (aSubthreadOnly) {</span>
<a href="#l24.393"></a><span id="l24.393">             msgDb.MarkHeaderKilled(msg, false, gDBView);</span>
<a href="#l24.394"></a><span id="l24.394" class="difflineminus">-          }</span>
<a href="#l24.395"></a><span id="l24.395" class="difflineminus">-          else {</span>
<a href="#l24.396"></a><span id="l24.396" class="difflineplus">+          } else {</span>
<a href="#l24.397"></a><span id="l24.397">             let thread = msgDb.GetThreadContainingMsgHdr(msg);</span>
<a href="#l24.398"></a><span id="l24.398">             msgDb.MarkThreadIgnored(thread, thread.threadKey, false, gDBView);</span>
<a href="#l24.399"></a><span id="l24.399">           }</span>
<a href="#l24.400"></a><span id="l24.400">         });</span>
<a href="#l24.401"></a><span id="l24.401">         return false; // close notification</span>
<a href="#l24.402"></a><span id="l24.402" class="difflineminus">-      }</span>
<a href="#l24.403"></a><span id="l24.403" class="difflineminus">-    }</span>
<a href="#l24.404"></a><span id="l24.404" class="difflineplus">+      },</span>
<a href="#l24.405"></a><span id="l24.405" class="difflineplus">+    },</span>
<a href="#l24.406"></a><span id="l24.406">   ];</span>
<a href="#l24.407"></a><span id="l24.407"> </span>
<a href="#l24.408"></a><span id="l24.408">   let threadIds = new Set();</span>
<a href="#l24.409"></a><span id="l24.409">   aMsgs.forEach(function(msg) {</span>
<a href="#l24.410"></a><span id="l24.410">     if (!threadIds.has(msg.threadId))</span>
<a href="#l24.411"></a><span id="l24.411">       threadIds.add(msg.threadId);</span>
<a href="#l24.412"></a><span id="l24.412">   });</span>
<a href="#l24.413"></a><span id="l24.413">   let nbrOfThreads = threadIds.size;</span>
<a href="#l24.414"></a><span id="l24.414"> </span>
<a href="#l24.415"></a><span id="l24.415">   if (nbrOfThreads == 1) {</span>
<a href="#l24.416"></a><span id="l24.416">     let ignoredThreadText = bundle.get(!aSubthreadOnly ?</span>
<a href="#l24.417"></a><span id="l24.417" class="difflineminus">-      &quot;ignoredThreadFeedback&quot;: &quot;ignoredSubthreadFeedback&quot;);</span>
<a href="#l24.418"></a><span id="l24.418" class="difflineplus">+      &quot;ignoredThreadFeedback&quot; : &quot;ignoredSubthreadFeedback&quot;);</span>
<a href="#l24.419"></a><span id="l24.419">     let subj = aMsgs[0].mime2DecodedSubject || &quot;&quot;;</span>
<a href="#l24.420"></a><span id="l24.420">     if (subj.length &gt; 45)</span>
<a href="#l24.421"></a><span id="l24.421">       subj = subj.substring(0, 45) + &quot;&quot;;</span>
<a href="#l24.422"></a><span id="l24.422">     let text = ignoredThreadText.replace(&quot;#1&quot;, subj);</span>
<a href="#l24.423"></a><span id="l24.423"> </span>
<a href="#l24.424"></a><span id="l24.424" class="difflineminus">-    let notification = notifyBox.appendNotification(</span>
<a href="#l24.425"></a><span id="l24.425" class="difflineplus">+    notifyBox.appendNotification(</span>
<a href="#l24.426"></a><span id="l24.426">       text, &quot;ignoreThreadInfo&quot;, null,</span>
<a href="#l24.427"></a><span id="l24.427">       notifyBox.PRIORITY_INFO_MEDIUM, buttons);</span>
<a href="#l24.428"></a><span id="l24.428" class="difflineminus">-  }</span>
<a href="#l24.429"></a><span id="l24.429" class="difflineminus">-  else {</span>
<a href="#l24.430"></a><span id="l24.430" class="difflineplus">+  } else {</span>
<a href="#l24.431"></a><span id="l24.431">     let ignoredThreadText = bundle.get(!aSubthreadOnly ?</span>
<a href="#l24.432"></a><span id="l24.432" class="difflineminus">-      &quot;ignoredThreadsFeedback&quot;: &quot;ignoredSubthreadsFeedback&quot;);</span>
<a href="#l24.433"></a><span id="l24.433" class="difflineplus">+      &quot;ignoredThreadsFeedback&quot; : &quot;ignoredSubthreadsFeedback&quot;);</span>
<a href="#l24.434"></a><span id="l24.434">     let text = PluralForm.get(nbrOfThreads, ignoredThreadText).replace(&quot;#1&quot;, nbrOfThreads);</span>
<a href="#l24.435"></a><span id="l24.435" class="difflineminus">-    let notification = notifyBox.appendNotification(</span>
<a href="#l24.436"></a><span id="l24.436" class="difflineplus">+    notifyBox.appendNotification(</span>
<a href="#l24.437"></a><span id="l24.437">       text, &quot;ignoreThreadsInfo&quot;, null,</span>
<a href="#l24.438"></a><span id="l24.438">       notifyBox.PRIORITY_INFO_MEDIUM, buttons);</span>
<a href="#l24.439"></a><span id="l24.439">   }</span>
<a href="#l24.440"></a><span id="l24.440"> }</span>
<a href="#l24.441"></a><span id="l24.441"> </span>
<a href="#l24.442"></a><span id="l24.442" class="difflineminus">-function CloseTabOrWindow()</span>
<a href="#l24.443"></a><span id="l24.443" class="difflineminus">-{</span>
<a href="#l24.444"></a><span id="l24.444" class="difflineminus">-  let tabmail = document.getElementById('tabmail');</span>
<a href="#l24.445"></a><span id="l24.445" class="difflineplus">+function CloseTabOrWindow() {</span>
<a href="#l24.446"></a><span id="l24.446" class="difflineplus">+  let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l24.447"></a><span id="l24.447">   if (tabmail.tabInfo.length == 1) {</span>
<a href="#l24.448"></a><span id="l24.448">     if (Services.prefs.getBoolPref(&quot;mail.tabs.closeWindowWithLastTab&quot;))</span>
<a href="#l24.449"></a><span id="l24.449">       window.close();</span>
<a href="#l24.450"></a><span id="l24.450" class="difflineminus">-  }</span>
<a href="#l24.451"></a><span id="l24.451" class="difflineminus">-  else {</span>
<a href="#l24.452"></a><span id="l24.452" class="difflineplus">+  } else {</span>
<a href="#l24.453"></a><span id="l24.453">     tabmail.removeCurrentTab();</span>
<a href="#l24.454"></a><span id="l24.454">   }</span>
<a href="#l24.455"></a><span id="l24.455"> }</span>
<a href="#l24.456"></a><span id="l24.456"> </span>
<a href="#l24.457"></a><span id="l24.457" class="difflineminus">-function GetNumSelectedMessages()</span>
<a href="#l24.458"></a><span id="l24.458" class="difflineminus">-{</span>
<a href="#l24.459"></a><span id="l24.459" class="difflineplus">+function GetNumSelectedMessages() {</span>
<a href="#l24.460"></a><span id="l24.460">   // This global function is only for mailnews/ compatibility.</span>
<a href="#l24.461"></a><span id="l24.461">   return gFolderDisplay.selectedCount;</span>
<a href="#l24.462"></a><span id="l24.462"> }</span>
<a href="#l24.463"></a><span id="l24.463"> </span>
<a href="#l24.464"></a><span id="l24.464" class="difflineminus">-var gLastFocusedElement=null;</span>
<a href="#l24.465"></a><span id="l24.465" class="difflineplus">+var gLastFocusedElement = null;</span>
<a href="#l24.466"></a><span id="l24.466"> </span>
<a href="#l24.467"></a><span id="l24.467" class="difflineminus">-function FocusRingUpdate_Mail()</span>
<a href="#l24.468"></a><span id="l24.468" class="difflineminus">-{</span>
<a href="#l24.469"></a><span id="l24.469" class="difflineplus">+function FocusRingUpdate_Mail() {</span>
<a href="#l24.470"></a><span id="l24.470">   if (!gFolderDisplay)</span>
<a href="#l24.471"></a><span id="l24.471">     return;</span>
<a href="#l24.472"></a><span id="l24.472"> </span>
<a href="#l24.473"></a><span id="l24.473">   // if the focusedElement is null, we're here on a blur.</span>
<a href="#l24.474"></a><span id="l24.474">   // nsFocusController::Blur() calls nsFocusController::SetFocusedElement(null),</span>
<a href="#l24.475"></a><span id="l24.475">   // which will update any commands listening for &quot;focus&quot;.</span>
<a href="#l24.476"></a><span id="l24.476">   // we really only care about nsFocusController::Focus() happens,</span>
<a href="#l24.477"></a><span id="l24.477">   // which calls nsFocusController::SetFocusedElement(element)</span>
<a href="#l24.478"></a><span id="l24.478" class="difflineat">@@ -1156,40 +1123,36 @@ function FocusRingUpdate_Mail()</span>
<a href="#l24.479"></a><span id="l24.479">     // since we just changed the pane with focus we need to update the toolbar to reflect this</span>
<a href="#l24.480"></a><span id="l24.480">     // XXX TODO</span>
<a href="#l24.481"></a><span id="l24.481">     // can we optimize</span>
<a href="#l24.482"></a><span id="l24.482">     // and just update cmd_delete and button_delete?</span>
<a href="#l24.483"></a><span id="l24.483">     UpdateMailToolbar(&quot;focus&quot;);</span>
<a href="#l24.484"></a><span id="l24.484">   }</span>
<a href="#l24.485"></a><span id="l24.485"> }</span>
<a href="#l24.486"></a><span id="l24.486"> </span>
<a href="#l24.487"></a><span id="l24.487" class="difflineminus">-function RestoreFocusAfterHdrButton()</span>
<a href="#l24.488"></a><span id="l24.488" class="difflineminus">-{</span>
<a href="#l24.489"></a><span id="l24.489" class="difflineplus">+function RestoreFocusAfterHdrButton() {</span>
<a href="#l24.490"></a><span id="l24.490">   // I would love to really restore the focus to the pane that had</span>
<a href="#l24.491"></a><span id="l24.491">   // focus before the user clicked on the hdr button, and gLastFocusedElement</span>
<a href="#l24.492"></a><span id="l24.492">   // would almost do that, except that clicking on the hdr button sets</span>
<a href="#l24.493"></a><span id="l24.493">   // gLastFocusedElement to the message pane. What I need is</span>
<a href="#l24.494"></a><span id="l24.494">   // gPenultimateFocusedElement.</span>
<a href="#l24.495"></a><span id="l24.495">   SetFocusThreadPane();</span>
<a href="#l24.496"></a><span id="l24.496"> }</span>
<a href="#l24.497"></a><span id="l24.497"> </span>
<a href="#l24.498"></a><span id="l24.498" class="difflineminus">-function SetupCommandUpdateHandlers()</span>
<a href="#l24.499"></a><span id="l24.499" class="difflineminus">-{</span>
<a href="#l24.500"></a><span id="l24.500" class="difflineplus">+function SetupCommandUpdateHandlers() {</span>
<a href="#l24.501"></a><span id="l24.501">   // folder pane</span>
<a href="#l24.502"></a><span id="l24.502">   var widget = document.getElementById(&quot;folderTree&quot;);</span>
<a href="#l24.503"></a><span id="l24.503" class="difflineminus">-  if ( widget )</span>
<a href="#l24.504"></a><span id="l24.504" class="difflineplus">+  if (widget)</span>
<a href="#l24.505"></a><span id="l24.505">     widget.controllers.appendController(FolderPaneController);</span>
<a href="#l24.506"></a><span id="l24.506"> }</span>
<a href="#l24.507"></a><span id="l24.507"> </span>
<a href="#l24.508"></a><span id="l24.508" class="difflineminus">-function UnloadCommandUpdateHandlers()</span>
<a href="#l24.509"></a><span id="l24.509" class="difflineminus">-{</span>
<a href="#l24.510"></a><span id="l24.510" class="difflineplus">+function UnloadCommandUpdateHandlers() {</span>
<a href="#l24.511"></a><span id="l24.511"> }</span>
<a href="#l24.512"></a><span id="l24.512"> </span>
<a href="#l24.513"></a><span id="l24.513" class="difflineminus">-function IsSendUnsentMsgsEnabled(unsentMsgsFolder)</span>
<a href="#l24.514"></a><span id="l24.514" class="difflineminus">-{</span>
<a href="#l24.515"></a><span id="l24.515" class="difflineplus">+function IsSendUnsentMsgsEnabled(unsentMsgsFolder) {</span>
<a href="#l24.516"></a><span id="l24.516">   // If no account has been configured, there are no messages for sending.</span>
<a href="#l24.517"></a><span id="l24.517">   if (MailServices.accounts.accounts.length == 0)</span>
<a href="#l24.518"></a><span id="l24.518">     return false;</span>
<a href="#l24.519"></a><span id="l24.519"> </span>
<a href="#l24.520"></a><span id="l24.520">   var msgSendlater =</span>
<a href="#l24.521"></a><span id="l24.521">     Cc[&quot;@mozilla.org/messengercompose/sendlater;1&quot;]</span>
<a href="#l24.522"></a><span id="l24.522">       .getService(Ci.nsIMsgSendLater);</span>
<a href="#l24.523"></a><span id="l24.523"> </span>
<a href="#l24.524"></a><span id="l24.524" class="difflineat">@@ -1216,18 +1179,17 @@ function IsSendUnsentMsgsEnabled(unsentM</span>
<a href="#l24.525"></a><span id="l24.525">     identity = MailServices.accounts.defaultAccount.defaultIdentity;</span>
<a href="#l24.526"></a><span id="l24.526"> </span>
<a href="#l24.527"></a><span id="l24.527">   return msgSendlater.hasUnsentMessages(identity);</span>
<a href="#l24.528"></a><span id="l24.528"> }</span>
<a href="#l24.529"></a><span id="l24.529"> </span>
<a href="#l24.530"></a><span id="l24.530"> /**</span>
<a href="#l24.531"></a><span id="l24.531">  * Determine whether there exists any server for which to show the Subscribe dialog.</span>
<a href="#l24.532"></a><span id="l24.532">  */</span>
<a href="#l24.533"></a><span id="l24.533" class="difflineminus">-function IsSubscribeEnabled()</span>
<a href="#l24.534"></a><span id="l24.534" class="difflineminus">-{</span>
<a href="#l24.535"></a><span id="l24.535" class="difflineplus">+function IsSubscribeEnabled() {</span>
<a href="#l24.536"></a><span id="l24.536">   // If there are any IMAP or News servers, we can show the dialog any time and</span>
<a href="#l24.537"></a><span id="l24.537">   // it will properly show those.</span>
<a href="#l24.538"></a><span id="l24.538">   let servers = MailServices.accounts.allServers;</span>
<a href="#l24.539"></a><span id="l24.539">   for (let server of fixIterator(servers,</span>
<a href="#l24.540"></a><span id="l24.540">                                  Ci.nsIMsgIncomingServer)) {</span>
<a href="#l24.541"></a><span id="l24.541">     if (server.type == &quot;imap&quot; || server.type == &quot;nntp&quot;)</span>
<a href="#l24.542"></a><span id="l24.542">       return true;</span>
<a href="#l24.543"></a><span id="l24.543">   }</span>
<a href="#l24.544"></a><span id="l24.544" class="difflineat">@@ -1236,69 +1198,62 @@ function IsSubscribeEnabled()</span>
<a href="#l24.545"></a><span id="l24.545">   // such an account is selected.</span>
<a href="#l24.546"></a><span id="l24.546">   let preselectedFolder = GetFirstSelectedMsgFolder();</span>
<a href="#l24.547"></a><span id="l24.547">   if (preselectedFolder &amp;&amp; preselectedFolder.server.type == &quot;rss&quot;)</span>
<a href="#l24.548"></a><span id="l24.548">     return true;</span>
<a href="#l24.549"></a><span id="l24.549"> </span>
<a href="#l24.550"></a><span id="l24.550">   return false;</span>
<a href="#l24.551"></a><span id="l24.551"> }</span>
<a href="#l24.552"></a><span id="l24.552"> </span>
<a href="#l24.553"></a><span id="l24.553" class="difflineminus">-function IsFolderCharsetEnabled()</span>
<a href="#l24.554"></a><span id="l24.554" class="difflineminus">-{</span>
<a href="#l24.555"></a><span id="l24.555" class="difflineplus">+function IsFolderCharsetEnabled() {</span>
<a href="#l24.556"></a><span id="l24.556">   return IsFolderSelected();</span>
<a href="#l24.557"></a><span id="l24.557"> }</span>
<a href="#l24.558"></a><span id="l24.558"> </span>
<a href="#l24.559"></a><span id="l24.559" class="difflineminus">-function IsPropertiesEnabled(command)</span>
<a href="#l24.560"></a><span id="l24.560" class="difflineminus">-{</span>
<a href="#l24.561"></a><span id="l24.561" class="difflineplus">+function IsPropertiesEnabled(command) {</span>
<a href="#l24.562"></a><span id="l24.562">   var folders = GetSelectedMsgFolders();</span>
<a href="#l24.563"></a><span id="l24.563">   if (!folders.length)</span>
<a href="#l24.564"></a><span id="l24.564">     return false;</span>
<a href="#l24.565"></a><span id="l24.565">   var folder = folders[0];</span>
<a href="#l24.566"></a><span id="l24.566"> </span>
<a href="#l24.567"></a><span id="l24.567">   // when servers are selected it should be &quot;Edit | Properties...&quot;</span>
<a href="#l24.568"></a><span id="l24.568">   if (folder.isServer)</span>
<a href="#l24.569"></a><span id="l24.569">     goSetMenuValue(command, &quot;valueGeneric&quot;);</span>
<a href="#l24.570"></a><span id="l24.570">   else if (folder.getFlag(Ci.nsMsgFolderFlags.Virtual))</span>
<a href="#l24.571"></a><span id="l24.571">     goSetMenuValue(command, &quot;valueFolder&quot;);</span>
<a href="#l24.572"></a><span id="l24.572">   else</span>
<a href="#l24.573"></a><span id="l24.573">     goSetMenuValue(command, isNewsURI(folder.URI) ? &quot;valueNewsgroup&quot; : &quot;valueFolder&quot;);</span>
<a href="#l24.574"></a><span id="l24.574"> </span>
<a href="#l24.575"></a><span id="l24.575">    return (folders.length == 1);</span>
<a href="#l24.576"></a><span id="l24.576"> }</span>
<a href="#l24.577"></a><span id="l24.577"> </span>
<a href="#l24.578"></a><span id="l24.578" class="difflineminus">-function IsViewNavigationItemEnabled()</span>
<a href="#l24.579"></a><span id="l24.579" class="difflineminus">-{</span>
<a href="#l24.580"></a><span id="l24.580" class="difflineplus">+function IsViewNavigationItemEnabled() {</span>
<a href="#l24.581"></a><span id="l24.581">   return IsFolderSelected();</span>
<a href="#l24.582"></a><span id="l24.582"> }</span>
<a href="#l24.583"></a><span id="l24.583"> </span>
<a href="#l24.584"></a><span id="l24.584" class="difflineminus">-function IsFolderSelected()</span>
<a href="#l24.585"></a><span id="l24.585" class="difflineminus">-{</span>
<a href="#l24.586"></a><span id="l24.586" class="difflineplus">+function IsFolderSelected() {</span>
<a href="#l24.587"></a><span id="l24.587">   var folders = GetSelectedMsgFolders();</span>
<a href="#l24.588"></a><span id="l24.588">   return folders.length == 1 &amp;&amp; !folders[0].isServer;</span>
<a href="#l24.589"></a><span id="l24.589"> }</span>
<a href="#l24.590"></a><span id="l24.590"> </span>
<a href="#l24.591"></a><span id="l24.591" class="difflineminus">-function SetFocusThreadPaneIfNotOnMessagePane()</span>
<a href="#l24.592"></a><span id="l24.592" class="difflineminus">-{</span>
<a href="#l24.593"></a><span id="l24.593" class="difflineplus">+function SetFocusThreadPaneIfNotOnMessagePane() {</span>
<a href="#l24.594"></a><span id="l24.594">   var focusedElement = gFolderDisplay.focusedPane;</span>
<a href="#l24.595"></a><span id="l24.595"> </span>
<a href="#l24.596"></a><span id="l24.596" class="difflineminus">-  if((focusedElement != GetThreadTree()) &amp;&amp;</span>
<a href="#l24.597"></a><span id="l24.597" class="difflineminus">-     (focusedElement != GetMessagePane()))</span>
<a href="#l24.598"></a><span id="l24.598" class="difflineminus">-     SetFocusThreadPane();</span>
<a href="#l24.599"></a><span id="l24.599" class="difflineplus">+  if ((focusedElement != GetThreadTree()) &amp;&amp; (focusedElement != GetMessagePane()))</span>
<a href="#l24.600"></a><span id="l24.600" class="difflineplus">+    SetFocusThreadPane();</span>
<a href="#l24.601"></a><span id="l24.601"> }</span>
<a href="#l24.602"></a><span id="l24.602"> </span>
<a href="#l24.603"></a><span id="l24.603"> // 3pane related commands.  Need to go in own file.  Putting here for the moment.</span>
<a href="#l24.604"></a><span id="l24.604"> </span>
<a href="#l24.605"></a><span id="l24.605"> /**</span>
<a href="#l24.606"></a><span id="l24.606">  * Cycle through the various panes in the 3pane window (in reverse if the shift</span>
<a href="#l24.607"></a><span id="l24.607">  * key is being held down).</span>
<a href="#l24.608"></a><span id="l24.608">  *</span>
<a href="#l24.609"></a><span id="l24.609">  * @param event the event that triggered us</span>
<a href="#l24.610"></a><span id="l24.610">  */</span>
<a href="#l24.611"></a><span id="l24.611" class="difflineminus">-function SwitchPaneFocus(event)</span>
<a href="#l24.612"></a><span id="l24.612" class="difflineminus">-{</span>
<a href="#l24.613"></a><span id="l24.613" class="difflineplus">+function SwitchPaneFocus(event) {</span>
<a href="#l24.614"></a><span id="l24.614">   let messagePane = GetMessagePane();</span>
<a href="#l24.615"></a><span id="l24.615"> </span>
<a href="#l24.616"></a><span id="l24.616">   // First, build an array of panes to cycle through based on our current state.</span>
<a href="#l24.617"></a><span id="l24.617">   // This will usually be something like [threadPane, messagePane, folderPane].</span>
<a href="#l24.618"></a><span id="l24.618">   let panes = [GetThreadTree()];</span>
<a href="#l24.619"></a><span id="l24.619"> </span>
<a href="#l24.620"></a><span id="l24.620">   if (!IsMessagePaneCollapsed())</span>
<a href="#l24.621"></a><span id="l24.621">     panes.push(messagePane);</span>
<a href="#l24.622"></a><span id="l24.622" class="difflineat">@@ -1309,97 +1264,86 @@ function SwitchPaneFocus(event)</span>
<a href="#l24.623"></a><span id="l24.623">   // Find our focused element in the array. If focus is not on one of the main</span>
<a href="#l24.624"></a><span id="l24.624">   // panes (it's probably on the toolbar), then act as if it's on the thread</span>
<a href="#l24.625"></a><span id="l24.625">   // tree.</span>
<a href="#l24.626"></a><span id="l24.626">   let focusedElement = gFolderDisplay.focusedPane;</span>
<a href="#l24.627"></a><span id="l24.627">   let focusedElementIndex = panes.indexOf(focusedElement);</span>
<a href="#l24.628"></a><span id="l24.628">   if (focusedElementIndex == -1)</span>
<a href="#l24.629"></a><span id="l24.629">     focusedElementIndex = 0;</span>
<a href="#l24.630"></a><span id="l24.630"> </span>
<a href="#l24.631"></a><span id="l24.631" class="difflineminus">-  if (event &amp;&amp; event.shiftKey)</span>
<a href="#l24.632"></a><span id="l24.632" class="difflineminus">-  {</span>
<a href="#l24.633"></a><span id="l24.633" class="difflineplus">+  if (event &amp;&amp; event.shiftKey) {</span>
<a href="#l24.634"></a><span id="l24.634">     focusedElementIndex--;</span>
<a href="#l24.635"></a><span id="l24.635">     if (focusedElementIndex == -1)</span>
<a href="#l24.636"></a><span id="l24.636" class="difflineminus">-      focusedElementIndex = panes.length-1;</span>
<a href="#l24.637"></a><span id="l24.637" class="difflineminus">-  }</span>
<a href="#l24.638"></a><span id="l24.638" class="difflineminus">-  else</span>
<a href="#l24.639"></a><span id="l24.639" class="difflineminus">-  {</span>
<a href="#l24.640"></a><span id="l24.640" class="difflineplus">+      focusedElementIndex = panes.length - 1;</span>
<a href="#l24.641"></a><span id="l24.641" class="difflineplus">+  } else {</span>
<a href="#l24.642"></a><span id="l24.642">     focusedElementIndex++;</span>
<a href="#l24.643"></a><span id="l24.643">     if (focusedElementIndex == panes.length)</span>
<a href="#l24.644"></a><span id="l24.644">       focusedElementIndex = 0;</span>
<a href="#l24.645"></a><span id="l24.645">   }</span>
<a href="#l24.646"></a><span id="l24.646"> </span>
<a href="#l24.647"></a><span id="l24.647">   let newElem = panes[focusedElementIndex];</span>
<a href="#l24.648"></a><span id="l24.648"> </span>
<a href="#l24.649"></a><span id="l24.649">   // We need to handle the message pane specially, since focusing it isn't as</span>
<a href="#l24.650"></a><span id="l24.650">   // simple as just calling focus(). See SetFocusMessagePane below for more</span>
<a href="#l24.651"></a><span id="l24.651">   // details.</span>
<a href="#l24.652"></a><span id="l24.652">   if (newElem == messagePane)</span>
<a href="#l24.653"></a><span id="l24.653">     SetFocusMessagePane();</span>
<a href="#l24.654"></a><span id="l24.654">   else</span>
<a href="#l24.655"></a><span id="l24.655">     newElem.focus();</span>
<a href="#l24.656"></a><span id="l24.656"> }</span>
<a href="#l24.657"></a><span id="l24.657"> </span>
<a href="#l24.658"></a><span id="l24.658" class="difflineminus">-function SetFocusThreadPane()</span>
<a href="#l24.659"></a><span id="l24.659" class="difflineminus">-{</span>
<a href="#l24.660"></a><span id="l24.660" class="difflineplus">+function SetFocusThreadPane() {</span>
<a href="#l24.661"></a><span id="l24.661">   var threadTree = GetThreadTree();</span>
<a href="#l24.662"></a><span id="l24.662">   threadTree.focus();</span>
<a href="#l24.663"></a><span id="l24.663"> }</span>
<a href="#l24.664"></a><span id="l24.664"> </span>
<a href="#l24.665"></a><span id="l24.665"> /**</span>
<a href="#l24.666"></a><span id="l24.666">  * Set the focus to the currently-active message pane (either the single- or</span>
<a href="#l24.667"></a><span id="l24.667">  * multi-message).</span>
<a href="#l24.668"></a><span id="l24.668">  */</span>
<a href="#l24.669"></a><span id="l24.669" class="difflineminus">-function SetFocusMessagePane()</span>
<a href="#l24.670"></a><span id="l24.670" class="difflineminus">-{</span>
<a href="#l24.671"></a><span id="l24.671" class="difflineplus">+function SetFocusMessagePane() {</span>
<a href="#l24.672"></a><span id="l24.672">   // Calling .focus() on content doesn't blur the previously focused chrome</span>
<a href="#l24.673"></a><span id="l24.673">   // element, so we shift focus to the XUL pane first, to not leave another</span>
<a href="#l24.674"></a><span id="l24.674">   // pane looking like it has focus.</span>
<a href="#l24.675"></a><span id="l24.675">   GetMessagePane().focus();</span>
<a href="#l24.676"></a><span id="l24.676">   if (gMessageDisplay.singleMessageDisplay)</span>
<a href="#l24.677"></a><span id="l24.677">     GetMessagePaneFrame().focus();</span>
<a href="#l24.678"></a><span id="l24.678">   else</span>
<a href="#l24.679"></a><span id="l24.679">     document.getElementById(&quot;multimessage&quot;).focus();</span>
<a href="#l24.680"></a><span id="l24.680"> }</span>
<a href="#l24.681"></a><span id="l24.681"> </span>
<a href="#l24.682"></a><span id="l24.682"> //</span>
<a href="#l24.683"></a><span id="l24.683"> // This function checks if the configured junk mail can be renamed or deleted.</span>
<a href="#l24.684"></a><span id="l24.684"> //</span>
<a href="#l24.685"></a><span id="l24.685" class="difflineminus">-function CanRenameDeleteJunkMail(aFolderUri)</span>
<a href="#l24.686"></a><span id="l24.686" class="difflineminus">-{</span>
<a href="#l24.687"></a><span id="l24.687" class="difflineplus">+function CanRenameDeleteJunkMail(aFolderUri) {</span>
<a href="#l24.688"></a><span id="l24.688">   if (!aFolderUri)</span>
<a href="#l24.689"></a><span id="l24.689">     return false;</span>
<a href="#l24.690"></a><span id="l24.690"> </span>
<a href="#l24.691"></a><span id="l24.691">   // Go through junk mail settings for all servers and see if the folder is set/used by anyone.</span>
<a href="#l24.692"></a><span id="l24.692" class="difflineminus">-  try</span>
<a href="#l24.693"></a><span id="l24.693" class="difflineminus">-  {</span>
<a href="#l24.694"></a><span id="l24.694" class="difflineplus">+  try {</span>
<a href="#l24.695"></a><span id="l24.695">     var allServers = accountManager.allServers;</span>
<a href="#l24.696"></a><span id="l24.696"> </span>
<a href="#l24.697"></a><span id="l24.697" class="difflineminus">-    for (var i = 0; i &lt; allServers.length; i++)</span>
<a href="#l24.698"></a><span id="l24.698" class="difflineminus">-    {</span>
<a href="#l24.699"></a><span id="l24.699" class="difflineplus">+    for (var i = 0; i &lt; allServers.length; i++) {</span>
<a href="#l24.700"></a><span id="l24.700">       var currentServer = allServers.queryElementAt(i, Ci.nsIMsgIncomingServer);</span>
<a href="#l24.701"></a><span id="l24.701">       var settings = currentServer.spamSettings;</span>
<a href="#l24.702"></a><span id="l24.702">       // If junk mail control or move junk mail to folder option is disabled then</span>
<a href="#l24.703"></a><span id="l24.703">       // allow the folder to be removed/renamed since the folder is not used in this case.</span>
<a href="#l24.704"></a><span id="l24.704">       if (!settings.level || !settings.moveOnSpam)</span>
<a href="#l24.705"></a><span id="l24.705">         continue;</span>
<a href="#l24.706"></a><span id="l24.706">       if (settings.spamFolderURI == aFolderUri)</span>
<a href="#l24.707"></a><span id="l24.707">         return false;</span>
<a href="#l24.708"></a><span id="l24.708">     }</span>
<a href="#l24.709"></a><span id="l24.709" class="difflineminus">-  }</span>
<a href="#l24.710"></a><span id="l24.710" class="difflineminus">-  catch(ex)</span>
<a href="#l24.711"></a><span id="l24.711" class="difflineminus">-  {</span>
<a href="#l24.712"></a><span id="l24.712" class="difflineminus">-      dump(&quot;Can't get all servers\n&quot;);</span>
<a href="#l24.713"></a><span id="l24.713" class="difflineplus">+  } catch (ex) {</span>
<a href="#l24.714"></a><span id="l24.714" class="difflineplus">+    dump(&quot;Can't get all servers\n&quot;);</span>
<a href="#l24.715"></a><span id="l24.715">   }</span>
<a href="#l24.716"></a><span id="l24.716">   return true;</span>
<a href="#l24.717"></a><span id="l24.717"> }</span>
<a href="#l24.718"></a><span id="l24.718"> </span>
<a href="#l24.719"></a><span id="l24.719"> /** Check if this is a folder the user is allowed to delete. */</span>
<a href="#l24.720"></a><span id="l24.720" class="difflineminus">-function CanDeleteFolder(folder)</span>
<a href="#l24.721"></a><span id="l24.721" class="difflineminus">-{</span>
<a href="#l24.722"></a><span id="l24.722" class="difflineplus">+function CanDeleteFolder(folder) {</span>
<a href="#l24.723"></a><span id="l24.723">   if (folder.isServer)</span>
<a href="#l24.724"></a><span id="l24.724">     return false;</span>
<a href="#l24.725"></a><span id="l24.725"> </span>
<a href="#l24.726"></a><span id="l24.726">   var specialFolder = getSpecialFolderString(folder);</span>
<a href="#l24.727"></a><span id="l24.727"> </span>
<a href="#l24.728"></a><span id="l24.728">   if (specialFolder == &quot;Inbox&quot; || specialFolder == &quot;Trash&quot; ||</span>
<a href="#l24.729"></a><span id="l24.729">       specialFolder == &quot;Drafts&quot; || specialFolder == &quot;Sent&quot; ||</span>
<a href="#l24.730"></a><span id="l24.730">       specialFolder == &quot;Templates&quot; || specialFolder == &quot;Outbox&quot; ||</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mail/base/content/mailCommands.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mail/base/content/mailCommands.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -10,30 +10,29 @@ ChromeUtils.import(&quot;resource:///modules/</span>
<a href="#l25.4"></a><span id="l25.4">  * Get the identity that most likely is the best one to use, given the hint.</span>
<a href="#l25.5"></a><span id="l25.5">  * @param identities    nsIArray&lt;nsIMsgIdentity&gt; of identities</span>
<a href="#l25.6"></a><span id="l25.6">  * @param optionalHint  string containing comma separated mailboxes</span>
<a href="#l25.7"></a><span id="l25.7">  * @param useDefault    If true, use the default identity of the default</span>
<a href="#l25.8"></a><span id="l25.8">  *                      account as last choice. This is useful when all</span>
<a href="#l25.9"></a><span id="l25.9">  *                      identities are passed in. Otherwise, use the first</span>
<a href="#l25.10"></a><span id="l25.10">  *                      entity in the list.</span>
<a href="#l25.11"></a><span id="l25.11">  */</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-function getBestIdentity(identities, optionalHint, useDefault = false)</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-{</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineplus">+function getBestIdentity(identities, optionalHint, useDefault = false) {</span>
<a href="#l25.15"></a><span id="l25.15">   let identityCount = identities.length;</span>
<a href="#l25.16"></a><span id="l25.16">   if (identityCount &lt; 1)</span>
<a href="#l25.17"></a><span id="l25.17">     return null;</span>
<a href="#l25.18"></a><span id="l25.18"> </span>
<a href="#l25.19"></a><span id="l25.19">   // If we have more than one identity and a hint to help us pick one.</span>
<a href="#l25.20"></a><span id="l25.20">   if (identityCount &gt; 1 &amp;&amp; optionalHint) {</span>
<a href="#l25.21"></a><span id="l25.21">     // Normalize case on the optional hint to improve our chances of</span>
<a href="#l25.22"></a><span id="l25.22">     // finding a match.</span>
<a href="#l25.23"></a><span id="l25.23">     optionalHint = optionalHint.toLowerCase();</span>
<a href="#l25.24"></a><span id="l25.24">     let hints = optionalHint.toLowerCase().split(&quot;,&quot;);</span>
<a href="#l25.25"></a><span id="l25.25"> </span>
<a href="#l25.26"></a><span id="l25.26" class="difflineminus">-    for (let i = 0 ; i &lt; hints.length; i++) {</span>
<a href="#l25.27"></a><span id="l25.27" class="difflineplus">+    for (let i = 0; i &lt; hints.length; i++) {</span>
<a href="#l25.28"></a><span id="l25.28">       for (let identity of fixIterator(identities,</span>
<a href="#l25.29"></a><span id="l25.29">                                        Ci.nsIMsgIdentity)) {</span>
<a href="#l25.30"></a><span id="l25.30">         if (!identity.email)</span>
<a href="#l25.31"></a><span id="l25.31">           continue;</span>
<a href="#l25.32"></a><span id="l25.32">         if (hints[i].trim() == identity.email.toLowerCase() ||</span>
<a href="#l25.33"></a><span id="l25.33">             hints[i].includes(&quot;&lt;&quot; + identity.email.toLowerCase() + &quot;&gt;&quot;))</span>
<a href="#l25.34"></a><span id="l25.34">           return identity;</span>
<a href="#l25.35"></a><span id="l25.35">       }</span>
<a href="#l25.36"></a><span id="l25.36" class="difflineat">@@ -48,39 +47,37 @@ function getBestIdentity(identities, opt</span>
<a href="#l25.37"></a><span id="l25.37">     } catch (ex) {}</span>
<a href="#l25.38"></a><span id="l25.38">     if (defaultAccount &amp;&amp; defaultAccount.defaultIdentity)</span>
<a href="#l25.39"></a><span id="l25.39">       return defaultAccount.defaultIdentity;</span>
<a href="#l25.40"></a><span id="l25.40">   }</span>
<a href="#l25.41"></a><span id="l25.41"> </span>
<a href="#l25.42"></a><span id="l25.42">   return identities.queryElementAt(0, Ci.nsIMsgIdentity);</span>
<a href="#l25.43"></a><span id="l25.43"> }</span>
<a href="#l25.44"></a><span id="l25.44"> </span>
<a href="#l25.45"></a><span id="l25.45" class="difflineminus">-function getIdentityForServer(server, optionalHint)</span>
<a href="#l25.46"></a><span id="l25.46" class="difflineminus">-{</span>
<a href="#l25.47"></a><span id="l25.47" class="difflineplus">+function getIdentityForServer(server, optionalHint) {</span>
<a href="#l25.48"></a><span id="l25.48">   var identities = accountManager.getIdentitiesForServer(server);</span>
<a href="#l25.49"></a><span id="l25.49">   return getBestIdentity(identities, optionalHint);</span>
<a href="#l25.50"></a><span id="l25.50"> }</span>
<a href="#l25.51"></a><span id="l25.51"> </span>
<a href="#l25.52"></a><span id="l25.52"> /**</span>
<a href="#l25.53"></a><span id="l25.53">  * Get the identity for the given header.</span>
<a href="#l25.54"></a><span id="l25.54">  * @param hdr nsIMsgHdr message header</span>
<a href="#l25.55"></a><span id="l25.55">  * @param type nsIMsgCompType compose type the identity ise used for.</span>
<a href="#l25.56"></a><span id="l25.56">  */</span>
<a href="#l25.57"></a><span id="l25.57" class="difflineminus">-function getIdentityForHeader(hdr, type)</span>
<a href="#l25.58"></a><span id="l25.58" class="difflineminus">-{</span>
<a href="#l25.59"></a><span id="l25.59" class="difflineplus">+function getIdentityForHeader(hdr, type) {</span>
<a href="#l25.60"></a><span id="l25.60">   function findDeliveredToIdentityEmail() {</span>
<a href="#l25.61"></a><span id="l25.61">     // This function reads from currentHeaderData, which is only useful if we're</span>
<a href="#l25.62"></a><span id="l25.62">     // looking at the currently-displayed message. Otherwise, just return</span>
<a href="#l25.63"></a><span id="l25.63">     // immediately so we don't waste time.</span>
<a href="#l25.64"></a><span id="l25.64">     if (hdr != gMessageDisplay.displayedMessage)</span>
<a href="#l25.65"></a><span id="l25.65">       return &quot;&quot;;</span>
<a href="#l25.66"></a><span id="l25.66"> </span>
<a href="#l25.67"></a><span id="l25.67">     // Get the delivered-to headers.</span>
<a href="#l25.68"></a><span id="l25.68">     let key = &quot;delivered-to&quot;;</span>
<a href="#l25.69"></a><span id="l25.69" class="difflineminus">-    let deliveredTos = new Array();</span>
<a href="#l25.70"></a><span id="l25.70" class="difflineplus">+    let deliveredTos = [];</span>
<a href="#l25.71"></a><span id="l25.71">     let index = 0;</span>
<a href="#l25.72"></a><span id="l25.72">     let header = &quot;&quot;;</span>
<a href="#l25.73"></a><span id="l25.73">     while ((header = currentHeaderData[key])) {</span>
<a href="#l25.74"></a><span id="l25.74">       deliveredTos.push(header.headerValue.toLowerCase().trim());</span>
<a href="#l25.75"></a><span id="l25.75">       key = &quot;delivered-to&quot; + index++;</span>
<a href="#l25.76"></a><span id="l25.76">     }</span>
<a href="#l25.77"></a><span id="l25.77"> </span>
<a href="#l25.78"></a><span id="l25.78">     // Reverse the array so that the last delivered-to header will show at front.</span>
<a href="#l25.79"></a><span id="l25.79" class="difflineat">@@ -135,18 +132,17 @@ function getIdentityForHeader(hdr, type)</span>
<a href="#l25.80"></a><span id="l25.80"> </span>
<a href="#l25.81"></a><span id="l25.81">   if (!identity)</span>
<a href="#l25.82"></a><span id="l25.82">     identity = getBestIdentity(accountManager.allIdentities,</span>
<a href="#l25.83"></a><span id="l25.83">                                hintForIdentity, true);</span>
<a href="#l25.84"></a><span id="l25.84"> </span>
<a href="#l25.85"></a><span id="l25.85">   return identity;</span>
<a href="#l25.86"></a><span id="l25.86"> }</span>
<a href="#l25.87"></a><span id="l25.87"> </span>
<a href="#l25.88"></a><span id="l25.88" class="difflineminus">-function GetNextNMessages(folder)</span>
<a href="#l25.89"></a><span id="l25.89" class="difflineminus">-{</span>
<a href="#l25.90"></a><span id="l25.90" class="difflineplus">+function GetNextNMessages(folder) {</span>
<a href="#l25.91"></a><span id="l25.91">   if (folder) {</span>
<a href="#l25.92"></a><span id="l25.92">     var newsFolder = folder.QueryInterface(</span>
<a href="#l25.93"></a><span id="l25.93">                      Ci.nsIMsgNewsFolder);</span>
<a href="#l25.94"></a><span id="l25.94">     if (newsFolder) {</span>
<a href="#l25.95"></a><span id="l25.95">       newsFolder.getNextNMessages(msgWindow);</span>
<a href="#l25.96"></a><span id="l25.96">     }</span>
<a href="#l25.97"></a><span id="l25.97">   }</span>
<a href="#l25.98"></a><span id="l25.98"> }</span>
<a href="#l25.99"></a><span id="l25.99" class="difflineat">@@ -169,18 +165,18 @@ function GetMsgKeyFromURI(uri) {</span>
<a href="#l25.100"></a><span id="l25.100"> /**</span>
<a href="#l25.101"></a><span id="l25.101">  * Compose a message.</span>
<a href="#l25.102"></a><span id="l25.102">  *</span>
<a href="#l25.103"></a><span id="l25.103">  * @param type   nsIMsgCompType    Type of composition (new message, reply, draft, etc.)</span>
<a href="#l25.104"></a><span id="l25.104">  * @param format nsIMsgCompFormat  Requested format (plain text, html, default)</span>
<a href="#l25.105"></a><span id="l25.105">  * @param folder nsIMsgFolder      Folder where the original message is stored</span>
<a href="#l25.106"></a><span id="l25.106">  * @param messageArray             Array of messages to process, often only holding one element.</span>
<a href="#l25.107"></a><span id="l25.107">  */</span>
<a href="#l25.108"></a><span id="l25.108" class="difflineminus">-function ComposeMessage(type, format, folder, messageArray)</span>
<a href="#l25.109"></a><span id="l25.109" class="difflineminus">-{</span>
<a href="#l25.110"></a><span id="l25.110" class="difflineplus">+/* eslint-disable complexity */</span>
<a href="#l25.111"></a><span id="l25.111" class="difflineplus">+function ComposeMessage(type, format, folder, messageArray) {</span>
<a href="#l25.112"></a><span id="l25.112">   let msgComposeType = Ci.nsIMsgCompType;</span>
<a href="#l25.113"></a><span id="l25.113">   let ignoreQuote = false;</span>
<a href="#l25.114"></a><span id="l25.114">   let msgKey;</span>
<a href="#l25.115"></a><span id="l25.115">   if (messageArray &amp;&amp; messageArray.length == 1) {</span>
<a href="#l25.116"></a><span id="l25.116">     msgKey = GetMsgKeyFromURI(messageArray[0]);</span>
<a href="#l25.117"></a><span id="l25.117">     if (msgKey != gMessageDisplay.keyForCharsetOverride) {</span>
<a href="#l25.118"></a><span id="l25.118">       msgWindow.charsetOverride = false;</span>
<a href="#l25.119"></a><span id="l25.119">     }</span>
<a href="#l25.120"></a><span id="l25.120" class="difflineat">@@ -219,47 +215,41 @@ function ComposeMessage(type, format, fo</span>
<a href="#l25.121"></a><span id="l25.121">       }</span>
<a href="#l25.122"></a><span id="l25.122">     }</span>
<a href="#l25.123"></a><span id="l25.123">   }</span>
<a href="#l25.124"></a><span id="l25.124">   var identity = null;</span>
<a href="#l25.125"></a><span id="l25.125">   var newsgroup = null;</span>
<a href="#l25.126"></a><span id="l25.126">   var hdr;</span>
<a href="#l25.127"></a><span id="l25.127"> </span>
<a href="#l25.128"></a><span id="l25.128">   // dump(&quot;ComposeMessage folder=&quot; + folder + &quot;\n&quot;);</span>
<a href="#l25.129"></a><span id="l25.129" class="difflineminus">-  try</span>
<a href="#l25.130"></a><span id="l25.130" class="difflineminus">-  {</span>
<a href="#l25.131"></a><span id="l25.131" class="difflineminus">-    if (folder)</span>
<a href="#l25.132"></a><span id="l25.132" class="difflineminus">-    {</span>
<a href="#l25.133"></a><span id="l25.133" class="difflineplus">+  try {</span>
<a href="#l25.134"></a><span id="l25.134" class="difflineplus">+    if (folder) {</span>
<a href="#l25.135"></a><span id="l25.135">       // Get the incoming server associated with this uri.</span>
<a href="#l25.136"></a><span id="l25.136">       var server = folder.server;</span>
<a href="#l25.137"></a><span id="l25.137"> </span>
<a href="#l25.138"></a><span id="l25.138">       // If they hit new or reply and they are reading a newsgroup,</span>
<a href="#l25.139"></a><span id="l25.139">       // turn this into a new post or a reply to group.</span>
<a href="#l25.140"></a><span id="l25.140" class="difflineminus">-      if (!folder.isServer &amp;&amp; server.type == &quot;nntp&quot; &amp;&amp; type == msgComposeType.New)</span>
<a href="#l25.141"></a><span id="l25.141" class="difflineminus">-      {</span>
<a href="#l25.142"></a><span id="l25.142" class="difflineplus">+      if (!folder.isServer &amp;&amp; server.type == &quot;nntp&quot; &amp;&amp; type == msgComposeType.New) {</span>
<a href="#l25.143"></a><span id="l25.143">         type = msgComposeType.NewsPost;</span>
<a href="#l25.144"></a><span id="l25.144">         newsgroup = folder.folderURL;</span>
<a href="#l25.145"></a><span id="l25.145">       }</span>
<a href="#l25.146"></a><span id="l25.146"> </span>
<a href="#l25.147"></a><span id="l25.147">       identity = folder.customIdentity;</span>
<a href="#l25.148"></a><span id="l25.148">       if (!identity)</span>
<a href="#l25.149"></a><span id="l25.149">         identity = getIdentityForServer(server);</span>
<a href="#l25.150"></a><span id="l25.150">       // dump(&quot;identity = &quot; + identity + &quot;\n&quot;);</span>
<a href="#l25.151"></a><span id="l25.151">     }</span>
<a href="#l25.152"></a><span id="l25.152" class="difflineminus">-  }</span>
<a href="#l25.153"></a><span id="l25.153" class="difflineminus">-  catch (ex)</span>
<a href="#l25.154"></a><span id="l25.154" class="difflineminus">-  {</span>
<a href="#l25.155"></a><span id="l25.155" class="difflineplus">+  } catch (ex) {</span>
<a href="#l25.156"></a><span id="l25.156">     dump(&quot;failed to get an identity to pre-select: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l25.157"></a><span id="l25.157">   }</span>
<a href="#l25.158"></a><span id="l25.158"> </span>
<a href="#l25.159"></a><span id="l25.159">   // dump(&quot;\nComposeMessage from XUL: &quot; + identity + &quot;\n&quot;);</span>
<a href="#l25.160"></a><span id="l25.160"> </span>
<a href="#l25.161"></a><span id="l25.161" class="difflineminus">-  switch (type)</span>
<a href="#l25.162"></a><span id="l25.162" class="difflineminus">-  {</span>
<a href="#l25.163"></a><span id="l25.163" class="difflineminus">-    case msgComposeType.New: //new message</span>
<a href="#l25.164"></a><span id="l25.164" class="difflineplus">+  switch (type) {</span>
<a href="#l25.165"></a><span id="l25.165" class="difflineplus">+    case msgComposeType.New: // new message</span>
<a href="#l25.166"></a><span id="l25.166">       // dump(&quot;OpenComposeWindow with &quot; + identity + &quot;\n&quot;);</span>
<a href="#l25.167"></a><span id="l25.167"> </span>
<a href="#l25.168"></a><span id="l25.168">       // If the addressbook sidebar panel is open and has focus, get</span>
<a href="#l25.169"></a><span id="l25.169">       // the selected addresses from it.</span>
<a href="#l25.170"></a><span id="l25.170">       if (document.commandDispatcher.focusedWindow &amp;&amp;</span>
<a href="#l25.171"></a><span id="l25.171">           document.commandDispatcher.focusedWindow</span>
<a href="#l25.172"></a><span id="l25.172">                   .document.documentElement.hasAttribute(&quot;selectedaddresses&quot;))</span>
<a href="#l25.173"></a><span id="l25.173">         NewMessageToSelectedAddresses(type, format, identity);</span>
<a href="#l25.174"></a><span id="l25.174" class="difflineat">@@ -268,58 +258,54 @@ function ComposeMessage(type, format, fo</span>
<a href="#l25.175"></a><span id="l25.175">                                                format, identity, msgWindow);</span>
<a href="#l25.176"></a><span id="l25.176">       return;</span>
<a href="#l25.177"></a><span id="l25.177">     case msgComposeType.NewsPost:</span>
<a href="#l25.178"></a><span id="l25.178">       // dump(&quot;OpenComposeWindow with &quot; + identity + &quot; and &quot; + newsgroup + &quot;\n&quot;);</span>
<a href="#l25.179"></a><span id="l25.179">       MailServices.compose.OpenComposeWindow(null, null, newsgroup, type,</span>
<a href="#l25.180"></a><span id="l25.180">                                              format, identity, msgWindow);</span>
<a href="#l25.181"></a><span id="l25.181">       return;</span>
<a href="#l25.182"></a><span id="l25.182">     case msgComposeType.ForwardAsAttachment:</span>
<a href="#l25.183"></a><span id="l25.183" class="difflineminus">-      if (messageArray &amp;&amp; messageArray.length)</span>
<a href="#l25.184"></a><span id="l25.184" class="difflineminus">-      {</span>
<a href="#l25.185"></a><span id="l25.185" class="difflineplus">+      if (messageArray &amp;&amp; messageArray.length) {</span>
<a href="#l25.186"></a><span id="l25.186">         // If we have more than one ForwardAsAttachment then pass null instead</span>
<a href="#l25.187"></a><span id="l25.187">         // of the header to tell the compose service to work out the attachment</span>
<a href="#l25.188"></a><span id="l25.188">         // subjects from the URIs.</span>
<a href="#l25.189"></a><span id="l25.189">         hdr = messageArray.length &gt; 1 ? null : messenger.msgHdrFromURI(messageArray[0]);</span>
<a href="#l25.190"></a><span id="l25.190" class="difflineminus">-        MailServices.compose.OpenComposeWindow(null, hdr, messageArray.join(','),</span>
<a href="#l25.191"></a><span id="l25.191" class="difflineplus">+        MailServices.compose.OpenComposeWindow(null, hdr, messageArray.join(&quot;,&quot;),</span>
<a href="#l25.192"></a><span id="l25.192">                                                type, format, identity, msgWindow);</span>
<a href="#l25.193"></a><span id="l25.193">         return;</span>
<a href="#l25.194"></a><span id="l25.194">       }</span>
<a href="#l25.195"></a><span id="l25.195">     default:</span>
<a href="#l25.196"></a><span id="l25.196">       if (!messageArray)</span>
<a href="#l25.197"></a><span id="l25.197">         return;</span>
<a href="#l25.198"></a><span id="l25.198"> </span>
<a href="#l25.199"></a><span id="l25.199">       // Limit the number of new compose windows to 8. Why 8 ?</span>
<a href="#l25.200"></a><span id="l25.200">       // I like that number :-)</span>
<a href="#l25.201"></a><span id="l25.201">       if (messageArray.length &gt; 8)</span>
<a href="#l25.202"></a><span id="l25.202">         messageArray.length = 8;</span>
<a href="#l25.203"></a><span id="l25.203"> </span>
<a href="#l25.204"></a><span id="l25.204" class="difflineminus">-      for (var i = 0; i &lt; messageArray.length; ++i)</span>
<a href="#l25.205"></a><span id="l25.205" class="difflineminus">-      {</span>
<a href="#l25.206"></a><span id="l25.206" class="difflineplus">+      for (var i = 0; i &lt; messageArray.length; ++i) {</span>
<a href="#l25.207"></a><span id="l25.207">         var messageUri = messageArray[i];</span>
<a href="#l25.208"></a><span id="l25.208">         hdr = messenger.msgHdrFromURI(messageUri);</span>
<a href="#l25.209"></a><span id="l25.209" class="difflineminus">-        if (FeedMessageHandler.isFeedMessage(hdr))</span>
<a href="#l25.210"></a><span id="l25.210" class="difflineminus">-        {</span>
<a href="#l25.211"></a><span id="l25.211" class="difflineplus">+        if (FeedMessageHandler.isFeedMessage(hdr)) {</span>
<a href="#l25.212"></a><span id="l25.212">           // Do not use the header derived identity for feeds, pass on only a</span>
<a href="#l25.213"></a><span id="l25.213">           // possible server identity from above.</span>
<a href="#l25.214"></a><span id="l25.214">           openComposeWindowForRSSArticle(null, hdr, messageUri, type,</span>
<a href="#l25.215"></a><span id="l25.215">                                          format, identity, msgWindow);</span>
<a href="#l25.216"></a><span id="l25.216" class="difflineminus">-        }</span>
<a href="#l25.217"></a><span id="l25.217" class="difflineminus">-        else</span>
<a href="#l25.218"></a><span id="l25.218" class="difflineminus">-        {</span>
<a href="#l25.219"></a><span id="l25.219" class="difflineplus">+        } else {</span>
<a href="#l25.220"></a><span id="l25.220">           // Replies come here.</span>
<a href="#l25.221"></a><span id="l25.221">           let hdrIdentity = getIdentityForHeader(hdr, type);</span>
<a href="#l25.222"></a><span id="l25.222">           if (ignoreQuote)</span>
<a href="#l25.223"></a><span id="l25.223">             type += msgComposeType.ReplyIgnoreQuote;</span>
<a href="#l25.224"></a><span id="l25.224">           MailServices.compose.OpenComposeWindow(null, hdr, messageUri, type,</span>
<a href="#l25.225"></a><span id="l25.225">                                                  format, hdrIdentity, msgWindow);</span>
<a href="#l25.226"></a><span id="l25.226">         }</span>
<a href="#l25.227"></a><span id="l25.227">       }</span>
<a href="#l25.228"></a><span id="l25.228">   }</span>
<a href="#l25.229"></a><span id="l25.229"> }</span>
<a href="#l25.230"></a><span id="l25.230" class="difflineplus">+/* eslint-enable complexity */</span>
<a href="#l25.231"></a><span id="l25.231"> </span>
<a href="#l25.232"></a><span id="l25.232"> function NewMessageToSelectedAddresses(type, format, identity) {</span>
<a href="#l25.233"></a><span id="l25.233">   var abSidebarPanel = document.commandDispatcher.focusedWindow;</span>
<a href="#l25.234"></a><span id="l25.234">   var abResultsTree = abSidebarPanel.document.getElementById(&quot;abResultsTree&quot;);</span>
<a href="#l25.235"></a><span id="l25.235">   var abResultsBoxObject = abResultsTree.treeBoxObject;</span>
<a href="#l25.236"></a><span id="l25.236">   var abView = abResultsBoxObject.view;</span>
<a href="#l25.237"></a><span id="l25.237">   abView = abView.QueryInterface(Ci.nsIAbView);</span>
<a href="#l25.238"></a><span id="l25.238">   var addresses = abView.selectedAddresses;</span>
<a href="#l25.239"></a><span id="l25.239" class="difflineat">@@ -337,77 +323,68 @@ function NewMessageToSelectedAddresses(t</span>
<a href="#l25.240"></a><span id="l25.240">       }</span>
<a href="#l25.241"></a><span id="l25.241">       composeFields.to = addressList.join(&quot;,&quot;);</span>
<a href="#l25.242"></a><span id="l25.242">       params.composeFields = composeFields;</span>
<a href="#l25.243"></a><span id="l25.243">       MailServices.compose.OpenComposeWindowWithParams(null, params);</span>
<a href="#l25.244"></a><span id="l25.244">     }</span>
<a href="#l25.245"></a><span id="l25.245">   }</span>
<a href="#l25.246"></a><span id="l25.246"> }</span>
<a href="#l25.247"></a><span id="l25.247"> </span>
<a href="#l25.248"></a><span id="l25.248" class="difflineminus">-function Subscribe(preselectedMsgFolder)</span>
<a href="#l25.249"></a><span id="l25.249" class="difflineminus">-{</span>
<a href="#l25.250"></a><span id="l25.250" class="difflineplus">+function Subscribe(preselectedMsgFolder) {</span>
<a href="#l25.251"></a><span id="l25.251">   window.openDialog(&quot;chrome://messenger/content/subscribe.xul&quot;,</span>
<a href="#l25.252"></a><span id="l25.252">                     &quot;subscribe&quot;, &quot;chrome,modal,titlebar,resizable=yes&quot;,</span>
<a href="#l25.253"></a><span id="l25.253" class="difflineminus">-                    {folder:preselectedMsgFolder,</span>
<a href="#l25.254"></a><span id="l25.254" class="difflineminus">-                      okCallback:SubscribeOKCallback});</span>
<a href="#l25.255"></a><span id="l25.255" class="difflineplus">+                    {</span>
<a href="#l25.256"></a><span id="l25.256" class="difflineplus">+                      folder: preselectedMsgFolder,</span>
<a href="#l25.257"></a><span id="l25.257" class="difflineplus">+                      okCallback: SubscribeOKCallback,</span>
<a href="#l25.258"></a><span id="l25.258" class="difflineplus">+                    });</span>
<a href="#l25.259"></a><span id="l25.259"> }</span>
<a href="#l25.260"></a><span id="l25.260"> </span>
<a href="#l25.261"></a><span id="l25.261" class="difflineminus">-function SubscribeOKCallback(changeTable)</span>
<a href="#l25.262"></a><span id="l25.262" class="difflineminus">-{</span>
<a href="#l25.263"></a><span id="l25.263" class="difflineplus">+function SubscribeOKCallback(changeTable) {</span>
<a href="#l25.264"></a><span id="l25.264">   for (var serverURI in changeTable) {</span>
<a href="#l25.265"></a><span id="l25.265">     var folder = MailUtils.getFolderForURI(serverURI, true);</span>
<a href="#l25.266"></a><span id="l25.266">     var server = folder.server;</span>
<a href="#l25.267"></a><span id="l25.267">     var subscribableServer =</span>
<a href="#l25.268"></a><span id="l25.268">           server.QueryInterface(Ci.nsISubscribableServer);</span>
<a href="#l25.269"></a><span id="l25.269"> </span>
<a href="#l25.270"></a><span id="l25.270">     for (var name in changeTable[serverURI]) {</span>
<a href="#l25.271"></a><span id="l25.271" class="difflineminus">-      if (changeTable[serverURI][name] == true) {</span>
<a href="#l25.272"></a><span id="l25.272" class="difflineplus">+      if (changeTable[serverURI][name]) {</span>
<a href="#l25.273"></a><span id="l25.273">         try {</span>
<a href="#l25.274"></a><span id="l25.274">           subscribableServer.subscribe(name);</span>
<a href="#l25.275"></a><span id="l25.275" class="difflineminus">-        }</span>
<a href="#l25.276"></a><span id="l25.276" class="difflineminus">-        catch (ex) {</span>
<a href="#l25.277"></a><span id="l25.277" class="difflineplus">+        } catch (ex) {</span>
<a href="#l25.278"></a><span id="l25.278">           dump(&quot;failed to subscribe to &quot; + name + &quot;: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l25.279"></a><span id="l25.279">         }</span>
<a href="#l25.280"></a><span id="l25.280" class="difflineminus">-      }</span>
<a href="#l25.281"></a><span id="l25.281" class="difflineminus">-      else if (changeTable[serverURI][name] == false) {</span>
<a href="#l25.282"></a><span id="l25.282" class="difflineplus">+      } else if (!changeTable[serverURI][name]) {</span>
<a href="#l25.283"></a><span id="l25.283">         try {</span>
<a href="#l25.284"></a><span id="l25.284">           subscribableServer.unsubscribe(name);</span>
<a href="#l25.285"></a><span id="l25.285" class="difflineminus">-        }</span>
<a href="#l25.286"></a><span id="l25.286" class="difflineminus">-        catch (ex) {</span>
<a href="#l25.287"></a><span id="l25.287" class="difflineplus">+        } catch (ex) {</span>
<a href="#l25.288"></a><span id="l25.288">           dump(&quot;failed to unsubscribe to &quot; + name + &quot;: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l25.289"></a><span id="l25.289">         }</span>
<a href="#l25.290"></a><span id="l25.290">       }</span>
<a href="#l25.291"></a><span id="l25.291" class="difflineminus">-      else {</span>
<a href="#l25.292"></a><span id="l25.292" class="difflineminus">-        // no change</span>
<a href="#l25.293"></a><span id="l25.293" class="difflineminus">-      }</span>
<a href="#l25.294"></a><span id="l25.294">     }</span>
<a href="#l25.295"></a><span id="l25.295"> </span>
<a href="#l25.296"></a><span id="l25.296">     try {</span>
<a href="#l25.297"></a><span id="l25.297">       subscribableServer.commitSubscribeChanges();</span>
<a href="#l25.298"></a><span id="l25.298" class="difflineminus">-    }</span>
<a href="#l25.299"></a><span id="l25.299" class="difflineminus">-    catch (ex) {</span>
<a href="#l25.300"></a><span id="l25.300" class="difflineplus">+    } catch (ex) {</span>
<a href="#l25.301"></a><span id="l25.301">       dump(&quot;failed to commit the changes: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l25.302"></a><span id="l25.302">     }</span>
<a href="#l25.303"></a><span id="l25.303">   }</span>
<a href="#l25.304"></a><span id="l25.304"> }</span>
<a href="#l25.305"></a><span id="l25.305"> </span>
<a href="#l25.306"></a><span id="l25.306" class="difflineminus">-function SaveAsFile(uris)</span>
<a href="#l25.307"></a><span id="l25.307" class="difflineminus">-{</span>
<a href="#l25.308"></a><span id="l25.308" class="difflineplus">+function SaveAsFile(uris) {</span>
<a href="#l25.309"></a><span id="l25.309">   if (uris.length == 1) {</span>
<a href="#l25.310"></a><span id="l25.310">     let uri = uris[0];</span>
<a href="#l25.311"></a><span id="l25.311">     let msgHdr = messenger.messageServiceFromURI(uri)</span>
<a href="#l25.312"></a><span id="l25.312">                           .messageURIToMsgHdr(uri);</span>
<a href="#l25.313"></a><span id="l25.313">     let name = msgHdr.mime2DecodedSubject;</span>
<a href="#l25.314"></a><span id="l25.314">     if (msgHdr.flags &amp; Ci.nsMsgMessageFlags.HasRe)</span>
<a href="#l25.315"></a><span id="l25.315">       name = (name) ? &quot;Re: &quot; + name : &quot;Re: &quot;;</span>
<a href="#l25.316"></a><span id="l25.316"> </span>
<a href="#l25.317"></a><span id="l25.317">     let filename = GenerateValidFilename(name, &quot;.eml&quot;);</span>
<a href="#l25.318"></a><span id="l25.318">     messenger.saveAs(uri, true, null, filename);</span>
<a href="#l25.319"></a><span id="l25.319" class="difflineminus">-  }</span>
<a href="#l25.320"></a><span id="l25.320" class="difflineminus">-  else {</span>
<a href="#l25.321"></a><span id="l25.321" class="difflineplus">+  } else {</span>
<a href="#l25.322"></a><span id="l25.322">     let filenames = [];</span>
<a href="#l25.323"></a><span id="l25.323">     for (let i = 0; i &lt; uris.length; i++) {</span>
<a href="#l25.324"></a><span id="l25.324">       let msgHdr = messenger.messageServiceFromURI(uris[i])</span>
<a href="#l25.325"></a><span id="l25.325">                             .messageURIToMsgHdr(uris[i]);</span>
<a href="#l25.326"></a><span id="l25.326"> </span>
<a href="#l25.327"></a><span id="l25.327">       let nameBase = GenerateFilenameFromMsgHdr(msgHdr);</span>
<a href="#l25.328"></a><span id="l25.328">       let name = GenerateValidFilename(nameBase, &quot;.eml&quot;);</span>
<a href="#l25.329"></a><span id="l25.329"> </span>
<a href="#l25.330"></a><span id="l25.330" class="difflineat">@@ -420,49 +397,49 @@ function SaveAsFile(uris)</span>
<a href="#l25.331"></a><span id="l25.331">     }</span>
<a href="#l25.332"></a><span id="l25.332">     messenger.saveMessages(uris.length, filenames, uris);</span>
<a href="#l25.333"></a><span id="l25.333">   }</span>
<a href="#l25.334"></a><span id="l25.334"> }</span>
<a href="#l25.335"></a><span id="l25.335"> </span>
<a href="#l25.336"></a><span id="l25.336"> function GenerateFilenameFromMsgHdr(msgHdr) {</span>
<a href="#l25.337"></a><span id="l25.337"> </span>
<a href="#l25.338"></a><span id="l25.338">   function MakeIS8601ODateString(date) {</span>
<a href="#l25.339"></a><span id="l25.339" class="difflineminus">-    function pad(n) {return n &lt; 10 ? &quot;0&quot; + n : n;}</span>
<a href="#l25.340"></a><span id="l25.340" class="difflineplus">+    function pad(n) { return n &lt; 10 ? &quot;0&quot; + n : n; }</span>
<a href="#l25.341"></a><span id="l25.341">     return date.getFullYear() + &quot;-&quot; +</span>
<a href="#l25.342"></a><span id="l25.342" class="difflineminus">-           pad(date.getMonth() + 1)  + &quot;-&quot; +</span>
<a href="#l25.343"></a><span id="l25.343" class="difflineminus">-           pad(date.getDate())  + &quot; &quot; +</span>
<a href="#l25.344"></a><span id="l25.344" class="difflineminus">-           pad(date.getHours())  + &quot;&quot; +</span>
<a href="#l25.345"></a><span id="l25.345" class="difflineplus">+           pad(date.getMonth() + 1) + &quot;-&quot; +</span>
<a href="#l25.346"></a><span id="l25.346" class="difflineplus">+           pad(date.getDate()) + &quot; &quot; +</span>
<a href="#l25.347"></a><span id="l25.347" class="difflineplus">+           pad(date.getHours()) + &quot;&quot; +</span>
<a href="#l25.348"></a><span id="l25.348">            pad(date.getMinutes()) + &quot;&quot;;</span>
<a href="#l25.349"></a><span id="l25.349">   }</span>
<a href="#l25.350"></a><span id="l25.350"> </span>
<a href="#l25.351"></a><span id="l25.351">   let filename;</span>
<a href="#l25.352"></a><span id="l25.352">   if (msgHdr.flags &amp; Ci.nsMsgMessageFlags.HasRe)</span>
<a href="#l25.353"></a><span id="l25.353">     filename = (msgHdr.mime2DecodedSubject) ? &quot;Re: &quot; + msgHdr.mime2DecodedSubject : &quot;Re: &quot;;</span>
<a href="#l25.354"></a><span id="l25.354">   else</span>
<a href="#l25.355"></a><span id="l25.355">     filename = msgHdr.mime2DecodedSubject;</span>
<a href="#l25.356"></a><span id="l25.356"> </span>
<a href="#l25.357"></a><span id="l25.357">   filename += &quot; - &quot;;</span>
<a href="#l25.358"></a><span id="l25.358" class="difflineminus">-  filename += msgHdr.mime2DecodedAuthor  + &quot; - &quot;;</span>
<a href="#l25.359"></a><span id="l25.359" class="difflineminus">-  filename += MakeIS8601ODateString(new Date(msgHdr.date/1000));</span>
<a href="#l25.360"></a><span id="l25.360" class="difflineplus">+  filename += msgHdr.mime2DecodedAuthor + &quot; - &quot;;</span>
<a href="#l25.361"></a><span id="l25.361" class="difflineplus">+  filename += MakeIS8601ODateString(new Date(msgHdr.date / 1000));</span>
<a href="#l25.362"></a><span id="l25.362"> </span>
<a href="#l25.363"></a><span id="l25.363">   return filename;</span>
<a href="#l25.364"></a><span id="l25.364"> </span>
<a href="#l25.365"></a><span id="l25.365"> }</span>
<a href="#l25.366"></a><span id="l25.366"> </span>
<a href="#l25.367"></a><span id="l25.367"> function saveAsUrlListener(aUri, aIdentity) {</span>
<a href="#l25.368"></a><span id="l25.368">   this.uri = aUri;</span>
<a href="#l25.369"></a><span id="l25.369">   this.identity = aIdentity;</span>
<a href="#l25.370"></a><span id="l25.370"> }</span>
<a href="#l25.371"></a><span id="l25.371"> </span>
<a href="#l25.372"></a><span id="l25.372"> saveAsUrlListener.prototype = {</span>
<a href="#l25.373"></a><span id="l25.373" class="difflineminus">-  OnStartRunningUrl: function(aUrl) {</span>
<a href="#l25.374"></a><span id="l25.374" class="difflineplus">+  OnStartRunningUrl(aUrl) {</span>
<a href="#l25.375"></a><span id="l25.375">   },</span>
<a href="#l25.376"></a><span id="l25.376" class="difflineminus">-  OnStopRunningUrl: function(aUrl, aExitCode) {</span>
<a href="#l25.377"></a><span id="l25.377" class="difflineplus">+  OnStopRunningUrl(aUrl, aExitCode) {</span>
<a href="#l25.378"></a><span id="l25.378">     messenger.saveAs(this.uri, false, this.identity, null);</span>
<a href="#l25.379"></a><span id="l25.379" class="difflineminus">-  }</span>
<a href="#l25.380"></a><span id="l25.380" class="difflineplus">+  },</span>
<a href="#l25.381"></a><span id="l25.381"> };</span>
<a href="#l25.382"></a><span id="l25.382"> </span>
<a href="#l25.383"></a><span id="l25.383"> function SaveAsTemplate(uri) {</span>
<a href="#l25.384"></a><span id="l25.384">   if (uri) {</span>
<a href="#l25.385"></a><span id="l25.385">     let hdr = messenger.msgHdrFromURI(uri);</span>
<a href="#l25.386"></a><span id="l25.386">     let identity = getIdentityForHeader(hdr, Ci.nsIMsgCompType.Template);</span>
<a href="#l25.387"></a><span id="l25.387">     let templates = MailUtils.getFolderForURI(identity.stationeryFolder, false);</span>
<a href="#l25.388"></a><span id="l25.388">     if (!templates.parent) {</span>
<a href="#l25.389"></a><span id="l25.389" class="difflineat">@@ -471,51 +448,46 @@ function SaveAsTemplate(uri) {</span>
<a href="#l25.390"></a><span id="l25.390">       templates.createStorageIfMissing(new saveAsUrlListener(uri, identity));</span>
<a href="#l25.391"></a><span id="l25.391">       if (isAsync)</span>
<a href="#l25.392"></a><span id="l25.392">         return;</span>
<a href="#l25.393"></a><span id="l25.393">     }</span>
<a href="#l25.394"></a><span id="l25.394">     messenger.saveAs(uri, false, identity, null);</span>
<a href="#l25.395"></a><span id="l25.395">   }</span>
<a href="#l25.396"></a><span id="l25.396"> }</span>
<a href="#l25.397"></a><span id="l25.397"> </span>
<a href="#l25.398"></a><span id="l25.398" class="difflineminus">-function MarkSelectedMessagesRead(markRead)</span>
<a href="#l25.399"></a><span id="l25.399" class="difflineminus">-{</span>
<a href="#l25.400"></a><span id="l25.400" class="difflineplus">+function MarkSelectedMessagesRead(markRead) {</span>
<a href="#l25.401"></a><span id="l25.401">   ClearPendingReadTimer();</span>
<a href="#l25.402"></a><span id="l25.402">   gDBView.doCommand(markRead ? nsMsgViewCommandType.markMessagesRead : nsMsgViewCommandType.markMessagesUnread);</span>
<a href="#l25.403"></a><span id="l25.403"> }</span>
<a href="#l25.404"></a><span id="l25.404"> </span>
<a href="#l25.405"></a><span id="l25.405" class="difflineminus">-function MarkSelectedMessagesFlagged(markFlagged)</span>
<a href="#l25.406"></a><span id="l25.406" class="difflineminus">-{</span>
<a href="#l25.407"></a><span id="l25.407" class="difflineplus">+function MarkSelectedMessagesFlagged(markFlagged) {</span>
<a href="#l25.408"></a><span id="l25.408">   gDBView.doCommand(markFlagged ? nsMsgViewCommandType.flagMessages : nsMsgViewCommandType.unflagMessages);</span>
<a href="#l25.409"></a><span id="l25.409"> }</span>
<a href="#l25.410"></a><span id="l25.410"> </span>
<a href="#l25.411"></a><span id="l25.411" class="difflineminus">-function ViewPageSource(messages)</span>
<a href="#l25.412"></a><span id="l25.412" class="difflineminus">-{</span>
<a href="#l25.413"></a><span id="l25.413" class="difflineplus">+function ViewPageSource(messages) {</span>
<a href="#l25.414"></a><span id="l25.414">   var numMessages = messages.length;</span>
<a href="#l25.415"></a><span id="l25.415"> </span>
<a href="#l25.416"></a><span id="l25.416" class="difflineminus">-  if (numMessages == 0)</span>
<a href="#l25.417"></a><span id="l25.417" class="difflineminus">-  {</span>
<a href="#l25.418"></a><span id="l25.418" class="difflineplus">+  if (numMessages == 0) {</span>
<a href="#l25.419"></a><span id="l25.419">     dump(&quot;MsgViewPageSource(): No messages selected.\n&quot;);</span>
<a href="#l25.420"></a><span id="l25.420">     return false;</span>
<a href="#l25.421"></a><span id="l25.421">   }</span>
<a href="#l25.422"></a><span id="l25.422"> </span>
<a href="#l25.423"></a><span id="l25.423">   var browser = getBrowser();</span>
<a href="#l25.424"></a><span id="l25.424"> </span>
<a href="#l25.425"></a><span id="l25.425">   try {</span>
<a href="#l25.426"></a><span id="l25.426" class="difflineminus">-    for (var i = 0; i &lt; numMessages; i++)</span>
<a href="#l25.427"></a><span id="l25.427" class="difflineminus">-    {</span>
<a href="#l25.428"></a><span id="l25.428" class="difflineplus">+    for (var i = 0; i &lt; numMessages; i++) {</span>
<a href="#l25.429"></a><span id="l25.429">       // Now, we need to get a URL from a URI</span>
<a href="#l25.430"></a><span id="l25.430">       var url = MailServices.mailSession.ConvertMsgURIToMsgURL(messages[i], msgWindow);</span>
<a href="#l25.431"></a><span id="l25.431"> </span>
<a href="#l25.432"></a><span id="l25.432">       // Strip out the message-display parameter to ensure that attached emails</span>
<a href="#l25.433"></a><span id="l25.433">       // display the message source, not the processed HTML.</span>
<a href="#l25.434"></a><span id="l25.434">       url = url.replace(/type=application\/x-message-display&amp;/, &quot;&quot;);</span>
<a href="#l25.435"></a><span id="l25.435">       window.openDialog(&quot;chrome://messenger/content/viewSource.xul&quot;,</span>
<a href="#l25.436"></a><span id="l25.436">                         &quot;_blank&quot;, &quot;all,dialog=no&quot;,</span>
<a href="#l25.437"></a><span id="l25.437" class="difflineminus">-                        {URL: url, browser: browser,</span>
<a href="#l25.438"></a><span id="l25.438" class="difflineplus">+                        {URL: url, browser,</span>
<a href="#l25.439"></a><span id="l25.439">                          outerWindowID: browser.outerWindowID});</span>
<a href="#l25.440"></a><span id="l25.440">     }</span>
<a href="#l25.441"></a><span id="l25.441">     return true;</span>
<a href="#l25.442"></a><span id="l25.442">   } catch (e) {</span>
<a href="#l25.443"></a><span id="l25.443">     // Couldn't get mail session</span>
<a href="#l25.444"></a><span id="l25.444">     return false;</span>
<a href="#l25.445"></a><span id="l25.445">   }</span>
<a href="#l25.446"></a><span id="l25.446"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mail/base/content/mailContextMenus.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mail/base/content/mailContextMenus.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -10,18 +10,17 @@ var mailtolength = 7;</span>
<a href="#l26.4"></a><span id="l26.4"> </span>
<a href="#l26.5"></a><span id="l26.5"> /**</span>
<a href="#l26.6"></a><span id="l26.6">  * Function to change the highlighted row back to the row that is currently</span>
<a href="#l26.7"></a><span id="l26.7">  * outline/dotted without loading the contents of either rows. This is</span>
<a href="#l26.8"></a><span id="l26.8">  * triggered when the context menu for a given row is hidden/closed</span>
<a href="#l26.9"></a><span id="l26.9">  * (onpopuphiding).</span>
<a href="#l26.10"></a><span id="l26.10">  * @param tree the tree element to restore selection for</span>
<a href="#l26.11"></a><span id="l26.11">  */</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-function RestoreSelectionWithoutContentLoad(tree)</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-{</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineplus">+function RestoreSelectionWithoutContentLoad(tree) {</span>
<a href="#l26.15"></a><span id="l26.15">   if (gRightMouseButtonSavedSelection) {</span>
<a href="#l26.16"></a><span id="l26.16">     let view = gRightMouseButtonSavedSelection.view;</span>
<a href="#l26.17"></a><span id="l26.17">     // restore the selection</span>
<a href="#l26.18"></a><span id="l26.18">     let transientSelection = gRightMouseButtonSavedSelection.transientSelection;</span>
<a href="#l26.19"></a><span id="l26.19">     let realSelection = gRightMouseButtonSavedSelection.realSelection;</span>
<a href="#l26.20"></a><span id="l26.20">     view.selection = realSelection;</span>
<a href="#l26.21"></a><span id="l26.21">     // replay any calls to adjustSelection, this handles suppression.</span>
<a href="#l26.22"></a><span id="l26.22">     transientSelection.replayAdjustSelectionLog(realSelection);</span>
<a href="#l26.23"></a><span id="l26.23" class="difflineat">@@ -37,51 +36,49 @@ function RestoreSelectionWithoutContentL</span>
<a href="#l26.24"></a><span id="l26.24"> }</span>
<a href="#l26.25"></a><span id="l26.25"> </span>
<a href="#l26.26"></a><span id="l26.26"> /**</span>
<a href="#l26.27"></a><span id="l26.27">  * Function to clear out the global nsContextMenu, and in the case when we</span>
<a href="#l26.28"></a><span id="l26.28">  * were a threadpane context menu, restore the selection so that a right-click</span>
<a href="#l26.29"></a><span id="l26.29">  * on a non-selected row doesn't move the selection.</span>
<a href="#l26.30"></a><span id="l26.30">  * @param event the onpopuphiding event</span>
<a href="#l26.31"></a><span id="l26.31">  */</span>
<a href="#l26.32"></a><span id="l26.32" class="difflineminus">-function mailContextOnPopupHiding(aEvent)</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineminus">-{</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineplus">+function mailContextOnPopupHiding(aEvent) {</span>
<a href="#l26.35"></a><span id="l26.35">   // Don't do anything if it's a submenu's onpopuphiding that's just bubbling</span>
<a href="#l26.36"></a><span id="l26.36">   // up to the top.</span>
<a href="#l26.37"></a><span id="l26.37">   if (aEvent.target != aEvent.currentTarget)</span>
<a href="#l26.38"></a><span id="l26.38">     return;</span>
<a href="#l26.39"></a><span id="l26.39"> </span>
<a href="#l26.40"></a><span id="l26.40">   let wasInThreadPane = gContextMenu.inThreadPane;</span>
<a href="#l26.41"></a><span id="l26.41">   gContextMenu = null;</span>
<a href="#l26.42"></a><span id="l26.42">   if (wasInThreadPane)</span>
<a href="#l26.43"></a><span id="l26.43">     RestoreSelectionWithoutContentLoad(GetThreadTree());</span>
<a href="#l26.44"></a><span id="l26.44"> }</span>
<a href="#l26.45"></a><span id="l26.45"> </span>
<a href="#l26.46"></a><span id="l26.46" class="difflineminus">-function fillMailContextMenu(event)</span>
<a href="#l26.47"></a><span id="l26.47" class="difflineminus">-{</span>
<a href="#l26.48"></a><span id="l26.48" class="difflineplus">+function fillMailContextMenu(event) {</span>
<a href="#l26.49"></a><span id="l26.49">   // If the popupshowing was for a submenu, we don't need to do anything.</span>
<a href="#l26.50"></a><span id="l26.50">   if (event.target != event.currentTarget)</span>
<a href="#l26.51"></a><span id="l26.51">     return true;</span>
<a href="#l26.52"></a><span id="l26.52"> </span>
<a href="#l26.53"></a><span id="l26.53">   // No menu on grouped header row currently, any command would be an implied</span>
<a href="#l26.54"></a><span id="l26.54">   // multiselect.</span>
<a href="#l26.55"></a><span id="l26.55">   if (gFolderDisplay.tree) {</span>
<a href="#l26.56"></a><span id="l26.56">     let row = gFolderDisplay.treeBox.getRowAt(event.clientX, event.clientY);</span>
<a href="#l26.57"></a><span id="l26.57">     if (gFolderDisplay.view.isGroupedByHeaderAtIndex(row)) {</span>
<a href="#l26.58"></a><span id="l26.58">       RestoreSelectionWithoutContentLoad(gFolderDisplay.tree);</span>
<a href="#l26.59"></a><span id="l26.59">       return false;</span>
<a href="#l26.60"></a><span id="l26.60">     }</span>
<a href="#l26.61"></a><span id="l26.61">   }</span>
<a href="#l26.62"></a><span id="l26.62"> </span>
<a href="#l26.63"></a><span id="l26.63" class="difflineminus">-  goUpdateCommand('cmd_killThread');</span>
<a href="#l26.64"></a><span id="l26.64" class="difflineminus">-  goUpdateCommand('cmd_killSubthread');</span>
<a href="#l26.65"></a><span id="l26.65" class="difflineminus">-  goUpdateCommand('cmd_watchThread');</span>
<a href="#l26.66"></a><span id="l26.66" class="difflineplus">+  goUpdateCommand(&quot;cmd_killThread&quot;);</span>
<a href="#l26.67"></a><span id="l26.67" class="difflineplus">+  goUpdateCommand(&quot;cmd_killSubthread&quot;);</span>
<a href="#l26.68"></a><span id="l26.68" class="difflineplus">+  goUpdateCommand(&quot;cmd_watchThread&quot;);</span>
<a href="#l26.69"></a><span id="l26.69"> </span>
<a href="#l26.70"></a><span id="l26.70" class="difflineminus">-  goUpdateCommand('cmd_printpreview');</span>
<a href="#l26.71"></a><span id="l26.71" class="difflineminus">-  goUpdateCommand('cmd_print');</span>
<a href="#l26.72"></a><span id="l26.72" class="difflineplus">+  goUpdateCommand(&quot;cmd_printpreview&quot;);</span>
<a href="#l26.73"></a><span id="l26.73" class="difflineplus">+  goUpdateCommand(&quot;cmd_print&quot;);</span>
<a href="#l26.74"></a><span id="l26.74"> </span>
<a href="#l26.75"></a><span id="l26.75">   updateCheckedStateForIgnoreAndWatchThreadCmds();</span>
<a href="#l26.76"></a><span id="l26.76"> </span>
<a href="#l26.77"></a><span id="l26.77">   // Show &quot;Edit Draft Message&quot; menus only in a drafts folder; otherwise hide them.</span>
<a href="#l26.78"></a><span id="l26.78">   showCommandInSpecialFolder(&quot;cmd_editDraftMsg&quot;,</span>
<a href="#l26.79"></a><span id="l26.79">                              Ci.nsMsgFolderFlags.Drafts);</span>
<a href="#l26.80"></a><span id="l26.80">   // Show &quot;New Message from Template&quot; and &quot;Edit Template&quot; menus only in a</span>
<a href="#l26.81"></a><span id="l26.81">   // templates folder; otherwise hide them.</span>
<a href="#l26.82"></a><span id="l26.82" class="difflineat">@@ -91,187 +88,162 @@ function fillMailContextMenu(event)</span>
<a href="#l26.83"></a><span id="l26.83">   gContextMenu = new nsContextMenu(event.target, event.shiftKey);</span>
<a href="#l26.84"></a><span id="l26.84">   return gContextMenu.shouldDisplay;</span>
<a href="#l26.85"></a><span id="l26.85"> }</span>
<a href="#l26.86"></a><span id="l26.86"> </span>
<a href="#l26.87"></a><span id="l26.87"> /**</span>
<a href="#l26.88"></a><span id="l26.88">  * Set the message id to show as label in the context menu item designated</span>
<a href="#l26.89"></a><span id="l26.89">  * for that purpose.</span>
<a href="#l26.90"></a><span id="l26.90">  */</span>
<a href="#l26.91"></a><span id="l26.91" class="difflineminus">-function FillMessageIdContextMenu(messageIdNode)</span>
<a href="#l26.92"></a><span id="l26.92" class="difflineminus">-{</span>
<a href="#l26.93"></a><span id="l26.93" class="difflineplus">+function FillMessageIdContextMenu(messageIdNode) {</span>
<a href="#l26.94"></a><span id="l26.94">   var msgId = messageIdNode.getAttribute(&quot;messageid&quot;);</span>
<a href="#l26.95"></a><span id="l26.95">   document.getElementById(&quot;messageIdContext-messageIdTarget&quot;)</span>
<a href="#l26.96"></a><span id="l26.96">           .setAttribute(&quot;label&quot;, msgId);</span>
<a href="#l26.97"></a><span id="l26.97"> </span>
<a href="#l26.98"></a><span id="l26.98">   // We don't want to show &quot;Open Message For ID&quot; for the same message</span>
<a href="#l26.99"></a><span id="l26.99">   // we're viewing.</span>
<a href="#l26.100"></a><span id="l26.100">   var currentMsgId = &quot;&lt;&quot; + gFolderDisplay.selectedMessage.messageId + &quot;&gt;&quot;;</span>
<a href="#l26.101"></a><span id="l26.101">   document.getElementById(&quot;messageIdContext-openMessageForMsgId&quot;)</span>
<a href="#l26.102"></a><span id="l26.102">           .hidden = (currentMsgId == msgId);</span>
<a href="#l26.103"></a><span id="l26.103"> </span>
<a href="#l26.104"></a><span id="l26.104">   // We don't want to show &quot;Open Browser With Message-ID&quot; for non-nntp messages.</span>
<a href="#l26.105"></a><span id="l26.105">   document.getElementById(&quot;messageIdContext-openBrowserWithMsgId&quot;)</span>
<a href="#l26.106"></a><span id="l26.106">           .hidden = !gFolderDisplay.selectedMessageIsNews;</span>
<a href="#l26.107"></a><span id="l26.107"> }</span>
<a href="#l26.108"></a><span id="l26.108"> </span>
<a href="#l26.109"></a><span id="l26.109" class="difflineminus">-function CopyMessageId(messageId)</span>
<a href="#l26.110"></a><span id="l26.110" class="difflineminus">-{</span>
<a href="#l26.111"></a><span id="l26.111" class="difflineplus">+function CopyMessageId(messageId) {</span>
<a href="#l26.112"></a><span id="l26.112">    var clipboard = Cc[&quot;@mozilla.org/widget/clipboardhelper;1&quot;]</span>
<a href="#l26.113"></a><span id="l26.113">                      .getService(Ci.nsIClipboardHelper);</span>
<a href="#l26.114"></a><span id="l26.114"> </span>
<a href="#l26.115"></a><span id="l26.115">    clipboard.copyString(messageId);</span>
<a href="#l26.116"></a><span id="l26.116"> }</span>
<a href="#l26.117"></a><span id="l26.117"> </span>
<a href="#l26.118"></a><span id="l26.118" class="difflineminus">-function GetMessageIdFromNode(messageIdNode, cleanMessageId)</span>
<a href="#l26.119"></a><span id="l26.119" class="difflineminus">-{</span>
<a href="#l26.120"></a><span id="l26.120" class="difflineplus">+function GetMessageIdFromNode(messageIdNode, cleanMessageId) {</span>
<a href="#l26.121"></a><span id="l26.121">   var messageId  = messageIdNode.getAttribute(&quot;messageid&quot;);</span>
<a href="#l26.122"></a><span id="l26.122"> </span>
<a href="#l26.123"></a><span id="l26.123">   // remove &lt; and &gt;</span>
<a href="#l26.124"></a><span id="l26.124">   if (cleanMessageId)</span>
<a href="#l26.125"></a><span id="l26.125">     messageId = messageId.substring(1, messageId.length - 1);</span>
<a href="#l26.126"></a><span id="l26.126"> </span>
<a href="#l26.127"></a><span id="l26.127">   return messageId;</span>
<a href="#l26.128"></a><span id="l26.128"> }</span>
<a href="#l26.129"></a><span id="l26.129"> </span>
<a href="#l26.130"></a><span id="l26.130"> /**</span>
<a href="#l26.131"></a><span id="l26.131">  * Take the message id from the messageIdNode and use the url defined in the</span>
<a href="#l26.132"></a><span id="l26.132">  * hidden pref &quot;mailnews.messageid_browser.url&quot; to open it in a browser window</span>
<a href="#l26.133"></a><span id="l26.133">  * (%mid is replaced by the message id).</span>
<a href="#l26.134"></a><span id="l26.134">  * @param messageId the message id to open</span>
<a href="#l26.135"></a><span id="l26.135">  */</span>
<a href="#l26.136"></a><span id="l26.136" class="difflineminus">-function OpenBrowserWithMessageId(messageId)</span>
<a href="#l26.137"></a><span id="l26.137" class="difflineminus">-{</span>
<a href="#l26.138"></a><span id="l26.138" class="difflineplus">+function OpenBrowserWithMessageId(messageId) {</span>
<a href="#l26.139"></a><span id="l26.139">   var browserURL = Services.prefs.getComplexValue(&quot;mailnews.messageid_browser.url&quot;,</span>
<a href="#l26.140"></a><span id="l26.140">                                                   Ci.nsIPrefLocalizedString).data;</span>
<a href="#l26.141"></a><span id="l26.141">   browserURL = browserURL.replace(/%mid/, messageId);</span>
<a href="#l26.142"></a><span id="l26.142" class="difflineminus">-  try</span>
<a href="#l26.143"></a><span id="l26.143" class="difflineminus">-  {</span>
<a href="#l26.144"></a><span id="l26.144" class="difflineplus">+  try {</span>
<a href="#l26.145"></a><span id="l26.145">     messenger.launchExternalURL(browserURL);</span>
<a href="#l26.146"></a><span id="l26.146" class="difflineminus">-  }</span>
<a href="#l26.147"></a><span id="l26.147" class="difflineminus">-  catch (ex)</span>
<a href="#l26.148"></a><span id="l26.148" class="difflineminus">-  {</span>
<a href="#l26.149"></a><span id="l26.149" class="difflineplus">+  } catch (ex) {</span>
<a href="#l26.150"></a><span id="l26.150">     Cu.reportError(&quot;Failed to open message-id in browser; &quot; +</span>
<a href="#l26.151"></a><span id="l26.151">                    &quot;browserURL=&quot; + browserURL);</span>
<a href="#l26.152"></a><span id="l26.152">   }</span>
<a href="#l26.153"></a><span id="l26.153"> }</span>
<a href="#l26.154"></a><span id="l26.154"> </span>
<a href="#l26.155"></a><span id="l26.155"> /**</span>
<a href="#l26.156"></a><span id="l26.156">  * Take the message id from the messageIdNode, search for the corresponding</span>
<a href="#l26.157"></a><span id="l26.157">  * message in all folders starting with the current selected folder, then the</span>
<a href="#l26.158"></a><span id="l26.158">  * current account followed by the other accounts and open corresponding</span>
<a href="#l26.159"></a><span id="l26.159">  * message if found.</span>
<a href="#l26.160"></a><span id="l26.160">  * @param messageId the message id to open</span>
<a href="#l26.161"></a><span id="l26.161">  */</span>
<a href="#l26.162"></a><span id="l26.162" class="difflineminus">-function OpenMessageForMessageId(messageId)</span>
<a href="#l26.163"></a><span id="l26.163" class="difflineminus">-{</span>
<a href="#l26.164"></a><span id="l26.164" class="difflineplus">+function OpenMessageForMessageId(messageId) {</span>
<a href="#l26.165"></a><span id="l26.165">   let startServer = msgWindow.openFolder.server;</span>
<a href="#l26.166"></a><span id="l26.166"> </span>
<a href="#l26.167"></a><span id="l26.167">   window.setCursor(&quot;wait&quot;);</span>
<a href="#l26.168"></a><span id="l26.168"> </span>
<a href="#l26.169"></a><span id="l26.169">   // first search in current folder for message id</span>
<a href="#l26.170"></a><span id="l26.170">   let messageHeader = CheckForMessageIdInFolder(msgWindow.openFolder, messageId);</span>
<a href="#l26.171"></a><span id="l26.171"> </span>
<a href="#l26.172"></a><span id="l26.172">   // if message id not found in current folder search in all folders</span>
<a href="#l26.173"></a><span id="l26.173" class="difflineminus">-  if (!messageHeader)</span>
<a href="#l26.174"></a><span id="l26.174" class="difflineminus">-  {</span>
<a href="#l26.175"></a><span id="l26.175" class="difflineplus">+  if (!messageHeader) {</span>
<a href="#l26.176"></a><span id="l26.176">     let allServers = MailServices.accounts.allServers;</span>
<a href="#l26.177"></a><span id="l26.177"> </span>
<a href="#l26.178"></a><span id="l26.178">     messageHeader = SearchForMessageIdInSubFolder(startServer.rootFolder, messageId);</span>
<a href="#l26.179"></a><span id="l26.179"> </span>
<a href="#l26.180"></a><span id="l26.180" class="difflineminus">-    for (let i = 0; i &lt; allServers.length &amp;&amp; !messageHeader; i++)</span>
<a href="#l26.181"></a><span id="l26.181" class="difflineminus">-    {</span>
<a href="#l26.182"></a><span id="l26.182" class="difflineplus">+    for (let i = 0; i &lt; allServers.length &amp;&amp; !messageHeader; i++) {</span>
<a href="#l26.183"></a><span id="l26.183">       let currentServer =</span>
<a href="#l26.184"></a><span id="l26.184">         allServers.queryElementAt(i, Ci.nsIMsgIncomingServer);</span>
<a href="#l26.185"></a><span id="l26.185">       if (currentServer &amp;&amp; startServer != currentServer &amp;&amp;</span>
<a href="#l26.186"></a><span id="l26.186" class="difflineminus">-          currentServer.canSearchMessages &amp;&amp; !currentServer.isDeferredTo)</span>
<a href="#l26.187"></a><span id="l26.187" class="difflineminus">-      {</span>
<a href="#l26.188"></a><span id="l26.188" class="difflineplus">+          currentServer.canSearchMessages &amp;&amp; !currentServer.isDeferredTo) {</span>
<a href="#l26.189"></a><span id="l26.189">         messageHeader = SearchForMessageIdInSubFolder(currentServer.rootFolder, messageId);</span>
<a href="#l26.190"></a><span id="l26.190">       }</span>
<a href="#l26.191"></a><span id="l26.191">     }</span>
<a href="#l26.192"></a><span id="l26.192">   }</span>
<a href="#l26.193"></a><span id="l26.193">   window.setCursor(&quot;auto&quot;);</span>
<a href="#l26.194"></a><span id="l26.194"> </span>
<a href="#l26.195"></a><span id="l26.195">   // if message id was found open corresponding message</span>
<a href="#l26.196"></a><span id="l26.196">   // else show error message</span>
<a href="#l26.197"></a><span id="l26.197" class="difflineminus">-  if (messageHeader)</span>
<a href="#l26.198"></a><span id="l26.198" class="difflineplus">+  if (messageHeader) {</span>
<a href="#l26.199"></a><span id="l26.199">     OpenMessageByHeader(messageHeader, Services.prefs.getBoolPref(&quot;mailnews.messageid.openInNewWindow&quot;));</span>
<a href="#l26.200"></a><span id="l26.200" class="difflineminus">-  else</span>
<a href="#l26.201"></a><span id="l26.201" class="difflineminus">-  {</span>
<a href="#l26.202"></a><span id="l26.202" class="difflineplus">+  } else {</span>
<a href="#l26.203"></a><span id="l26.203">     let messageIdStr = &quot;&lt;&quot; + messageId + &quot;&gt;&quot;;</span>
<a href="#l26.204"></a><span id="l26.204">     let bundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l26.205"></a><span id="l26.205">     let errorTitle = bundle.getString(&quot;errorOpenMessageForMessageIdTitle&quot;);</span>
<a href="#l26.206"></a><span id="l26.206">     let errorMessage = bundle.getFormattedString(&quot;errorOpenMessageForMessageIdMessage&quot;,</span>
<a href="#l26.207"></a><span id="l26.207">                                                  [messageIdStr]);</span>
<a href="#l26.208"></a><span id="l26.208"> </span>
<a href="#l26.209"></a><span id="l26.209">     Services.prompt.alert(window, errorTitle, errorMessage);</span>
<a href="#l26.210"></a><span id="l26.210">   }</span>
<a href="#l26.211"></a><span id="l26.211"> }</span>
<a href="#l26.212"></a><span id="l26.212"> </span>
<a href="#l26.213"></a><span id="l26.213" class="difflineminus">-function OpenMessageByHeader(messageHeader, openInNewWindow)</span>
<a href="#l26.214"></a><span id="l26.214" class="difflineminus">-{</span>
<a href="#l26.215"></a><span id="l26.215" class="difflineplus">+function OpenMessageByHeader(messageHeader, openInNewWindow) {</span>
<a href="#l26.216"></a><span id="l26.216">   var folder    = messageHeader.folder;</span>
<a href="#l26.217"></a><span id="l26.217">   var folderURI = folder.URI;</span>
<a href="#l26.218"></a><span id="l26.218"> </span>
<a href="#l26.219"></a><span id="l26.219" class="difflineminus">-  if (openInNewWindow)</span>
<a href="#l26.220"></a><span id="l26.220" class="difflineminus">-  {</span>
<a href="#l26.221"></a><span id="l26.221" class="difflineplus">+  if (openInNewWindow) {</span>
<a href="#l26.222"></a><span id="l26.222">     window.openDialog(&quot;chrome://messenger/content/messageWindow.xul&quot;,</span>
<a href="#l26.223"></a><span id="l26.223">                       &quot;_blank&quot;, &quot;all,chrome,dialog=no,status,toolbar&quot;,</span>
<a href="#l26.224"></a><span id="l26.224">                       messageHeader);</span>
<a href="#l26.225"></a><span id="l26.225" class="difflineminus">-  }</span>
<a href="#l26.226"></a><span id="l26.226" class="difflineminus">-  else</span>
<a href="#l26.227"></a><span id="l26.227" class="difflineminus">-  {</span>
<a href="#l26.228"></a><span id="l26.228" class="difflineplus">+  } else {</span>
<a href="#l26.229"></a><span id="l26.229">     if (msgWindow.openFolder != folderURI)</span>
<a href="#l26.230"></a><span id="l26.230">       gFolderTreeView.selectFolder(folder);</span>
<a href="#l26.231"></a><span id="l26.231"> </span>
<a href="#l26.232"></a><span id="l26.232">     var tree = null;</span>
<a href="#l26.233"></a><span id="l26.233" class="difflineminus">-    var wintype = document.documentElement.getAttribute('windowtype');</span>
<a href="#l26.234"></a><span id="l26.234" class="difflineminus">-    if (wintype != &quot;mail:messageWindow&quot;)</span>
<a href="#l26.235"></a><span id="l26.235" class="difflineminus">-    {</span>
<a href="#l26.236"></a><span id="l26.236" class="difflineplus">+    let wintype = document.documentElement.getAttribute(&quot;windowtype&quot;);</span>
<a href="#l26.237"></a><span id="l26.237" class="difflineplus">+    if (wintype != &quot;mail:messageWindow&quot;) {</span>
<a href="#l26.238"></a><span id="l26.238">       tree = GetThreadTree();</span>
<a href="#l26.239"></a><span id="l26.239">       tree.view.selection.clearSelection();</span>
<a href="#l26.240"></a><span id="l26.240">     }</span>
<a href="#l26.241"></a><span id="l26.241"> </span>
<a href="#l26.242"></a><span id="l26.242" class="difflineminus">-    try</span>
<a href="#l26.243"></a><span id="l26.243" class="difflineminus">-    {</span>
<a href="#l26.244"></a><span id="l26.244" class="difflineplus">+    try {</span>
<a href="#l26.245"></a><span id="l26.245">       gDBView.selectMsgByKey(messageHeader.messageKey);</span>
<a href="#l26.246"></a><span id="l26.246" class="difflineminus">-    }</span>
<a href="#l26.247"></a><span id="l26.247" class="difflineminus">-    catch(e)</span>
<a href="#l26.248"></a><span id="l26.248" class="difflineminus">-    { // message not in the thread pane</span>
<a href="#l26.249"></a><span id="l26.249" class="difflineminus">-      try</span>
<a href="#l26.250"></a><span id="l26.250" class="difflineminus">-      {</span>
<a href="#l26.251"></a><span id="l26.251" class="difflineplus">+    } catch (e) { // message not in the thread pane</span>
<a href="#l26.252"></a><span id="l26.252" class="difflineplus">+      try {</span>
<a href="#l26.253"></a><span id="l26.253">         goDoCommand(&quot;cmd_viewAllMsgs&quot;);</span>
<a href="#l26.254"></a><span id="l26.254">         gDBView.selectMsgByKey(messageHeader.messageKey);</span>
<a href="#l26.255"></a><span id="l26.255" class="difflineminus">-      }</span>
<a href="#l26.256"></a><span id="l26.256" class="difflineminus">-      catch(e)</span>
<a href="#l26.257"></a><span id="l26.257" class="difflineminus">-      {</span>
<a href="#l26.258"></a><span id="l26.258" class="difflineplus">+      } catch (e) {</span>
<a href="#l26.259"></a><span id="l26.259">          dump(&quot;select messagekey &quot; + messageHeader.messageKey +</span>
<a href="#l26.260"></a><span id="l26.260">               &quot; failed in folder &quot; + folder.URI);</span>
<a href="#l26.261"></a><span id="l26.261">       }</span>
<a href="#l26.262"></a><span id="l26.262">     }</span>
<a href="#l26.263"></a><span id="l26.263"> </span>
<a href="#l26.264"></a><span id="l26.264">     if (tree &amp;&amp; tree.currentIndex != -1)</span>
<a href="#l26.265"></a><span id="l26.265">       tree.treeBoxObject.ensureRowIsVisible(tree.currentIndex);</span>
<a href="#l26.266"></a><span id="l26.266">   }</span>
<a href="#l26.267"></a><span id="l26.267"> }</span>
<a href="#l26.268"></a><span id="l26.268"> </span>
<a href="#l26.269"></a><span id="l26.269"> // search for message by message id in given folder and its subfolders</span>
<a href="#l26.270"></a><span id="l26.270"> // return message header if message was found</span>
<a href="#l26.271"></a><span id="l26.271" class="difflineminus">-function SearchForMessageIdInSubFolder(folder, messageId)</span>
<a href="#l26.272"></a><span id="l26.272" class="difflineminus">-{</span>
<a href="#l26.273"></a><span id="l26.273" class="difflineplus">+function SearchForMessageIdInSubFolder(folder, messageId) {</span>
<a href="#l26.274"></a><span id="l26.274">   var messageHeader;</span>
<a href="#l26.275"></a><span id="l26.275">   var subFolders = folder.subFolders;</span>
<a href="#l26.276"></a><span id="l26.276"> </span>
<a href="#l26.277"></a><span id="l26.277">   // search in folder</span>
<a href="#l26.278"></a><span id="l26.278">   if (!folder.isServer)</span>
<a href="#l26.279"></a><span id="l26.279">     messageHeader = CheckForMessageIdInFolder(folder, messageId);</span>
<a href="#l26.280"></a><span id="l26.280"> </span>
<a href="#l26.281"></a><span id="l26.281">   // search subfolders recursively</span>
<a href="#l26.282"></a><span id="l26.282" class="difflineminus">-  while (subFolders.hasMoreElements() &amp;&amp; !messageHeader)</span>
<a href="#l26.283"></a><span id="l26.283" class="difflineminus">-  {</span>
<a href="#l26.284"></a><span id="l26.284" class="difflineplus">+  while (subFolders.hasMoreElements() &amp;&amp; !messageHeader) {</span>
<a href="#l26.285"></a><span id="l26.285">     // search in current folder</span>
<a href="#l26.286"></a><span id="l26.286">     var currentFolder =</span>
<a href="#l26.287"></a><span id="l26.287">       subFolders.getNext().QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l26.288"></a><span id="l26.288">     messageHeader = CheckForMessageIdInFolder(currentFolder, messageId);</span>
<a href="#l26.289"></a><span id="l26.289"> </span>
<a href="#l26.290"></a><span id="l26.290">     // search in its subfolder</span>
<a href="#l26.291"></a><span id="l26.291">     if (!messageHeader &amp;&amp; currentFolder.hasSubFolders)</span>
<a href="#l26.292"></a><span id="l26.292">       messageHeader = SearchForMessageIdInSubFolder(currentFolder, messageId);</span>
<a href="#l26.293"></a><span id="l26.293" class="difflineat">@@ -279,46 +251,40 @@ function SearchForMessageIdInSubFolder(f</span>
<a href="#l26.294"></a><span id="l26.294"> </span>
<a href="#l26.295"></a><span id="l26.295">   return messageHeader;</span>
<a href="#l26.296"></a><span id="l26.296"> }</span>
<a href="#l26.297"></a><span id="l26.297"> </span>
<a href="#l26.298"></a><span id="l26.298"> /**</span>
<a href="#l26.299"></a><span id="l26.299">  * Check folder for corresponding message to given message id.</span>
<a href="#l26.300"></a><span id="l26.300">  * @return the message header if message was found</span>
<a href="#l26.301"></a><span id="l26.301">  */</span>
<a href="#l26.302"></a><span id="l26.302" class="difflineminus">-function CheckForMessageIdInFolder(folder, messageId)</span>
<a href="#l26.303"></a><span id="l26.303" class="difflineminus">-{</span>
<a href="#l26.304"></a><span id="l26.304" class="difflineplus">+function CheckForMessageIdInFolder(folder, messageId) {</span>
<a href="#l26.305"></a><span id="l26.305">   var messageDatabase = folder.msgDatabase;</span>
<a href="#l26.306"></a><span id="l26.306">   var messageHeader;</span>
<a href="#l26.307"></a><span id="l26.307" class="difflineminus">-  try</span>
<a href="#l26.308"></a><span id="l26.308" class="difflineminus">-  {</span>
<a href="#l26.309"></a><span id="l26.309" class="difflineplus">+  try {</span>
<a href="#l26.310"></a><span id="l26.310">     messageHeader = messageDatabase.getMsgHdrForMessageID(messageId);</span>
<a href="#l26.311"></a><span id="l26.311" class="difflineminus">-  }</span>
<a href="#l26.312"></a><span id="l26.312" class="difflineminus">-  catch (ex)</span>
<a href="#l26.313"></a><span id="l26.313" class="difflineminus">-  {</span>
<a href="#l26.314"></a><span id="l26.314" class="difflineplus">+  } catch (ex) {</span>
<a href="#l26.315"></a><span id="l26.315">     Cu.reportError(&quot;Failed to find message-id in folder; &quot; +</span>
<a href="#l26.316"></a><span id="l26.316">                    &quot;messageId=&quot; + messageId);</span>
<a href="#l26.317"></a><span id="l26.317">   }</span>
<a href="#l26.318"></a><span id="l26.318"> </span>
<a href="#l26.319"></a><span id="l26.319">   if (!MailServices.mailSession.IsFolderOpenInWindow(folder) &amp;&amp;</span>
<a href="#l26.320"></a><span id="l26.320" class="difflineminus">-      !(folder.flags &amp; (Ci.nsMsgFolderFlags.Trash | Ci.nsMsgFolderFlags.Inbox)))</span>
<a href="#l26.321"></a><span id="l26.321" class="difflineminus">-  {</span>
<a href="#l26.322"></a><span id="l26.322" class="difflineplus">+      !(folder.flags &amp; (Ci.nsMsgFolderFlags.Trash | Ci.nsMsgFolderFlags.Inbox))) {</span>
<a href="#l26.323"></a><span id="l26.323">     folder.msgDatabase = null;</span>
<a href="#l26.324"></a><span id="l26.324">   }</span>
<a href="#l26.325"></a><span id="l26.325"> </span>
<a href="#l26.326"></a><span id="l26.326">   return messageHeader;</span>
<a href="#l26.327"></a><span id="l26.327"> }</span>
<a href="#l26.328"></a><span id="l26.328"> </span>
<a href="#l26.329"></a><span id="l26.329" class="difflineminus">-function folderPaneOnPopupHiding()</span>
<a href="#l26.330"></a><span id="l26.330" class="difflineminus">-{</span>
<a href="#l26.331"></a><span id="l26.331" class="difflineplus">+function folderPaneOnPopupHiding() {</span>
<a href="#l26.332"></a><span id="l26.332">   RestoreSelectionWithoutContentLoad(document.getElementById(&quot;folderTree&quot;));</span>
<a href="#l26.333"></a><span id="l26.333"> }</span>
<a href="#l26.334"></a><span id="l26.334"> </span>
<a href="#l26.335"></a><span id="l26.335" class="difflineminus">-function fillFolderPaneContextMenu(aEvent)</span>
<a href="#l26.336"></a><span id="l26.336" class="difflineminus">-{</span>
<a href="#l26.337"></a><span id="l26.337" class="difflineplus">+/* eslint-disable complexity */</span>
<a href="#l26.338"></a><span id="l26.338" class="difflineplus">+function fillFolderPaneContextMenu(aEvent) {</span>
<a href="#l26.339"></a><span id="l26.339">   let target = document.popupNode;</span>
<a href="#l26.340"></a><span id="l26.340">   // If a column header was clicked, show the column picker.</span>
<a href="#l26.341"></a><span id="l26.341">   if (target.localName == &quot;treecol&quot;) {</span>
<a href="#l26.342"></a><span id="l26.342">     let treecols = target.parentNode;</span>
<a href="#l26.343"></a><span id="l26.343">     let nodeList = document.getAnonymousNodes(treecols);</span>
<a href="#l26.344"></a><span id="l26.344">     let treeColPicker = null;</span>
<a href="#l26.345"></a><span id="l26.345">     for (let i = 0; i &lt; nodeList.length; i++) {</span>
<a href="#l26.346"></a><span id="l26.346">       if (nodeList.item(i).localName == &quot;treecolpicker&quot;) {</span>
<a href="#l26.347"></a><span id="l26.347" class="difflineat">@@ -394,24 +360,20 @@ function fillFolderPaneContextMenu(aEven</span>
<a href="#l26.348"></a><span id="l26.348">              !checkIsVirtualFolder(folder));</span>
<a href="#l26.349"></a><span id="l26.349">   }</span>
<a href="#l26.350"></a><span id="l26.350">   var selectedFoldersThatCanGetMessages = folders.filter(checkCanGetMessages);</span>
<a href="#l26.351"></a><span id="l26.351"> </span>
<a href="#l26.352"></a><span id="l26.352">   // --- Set up folder properties / account settings menu item.</span>
<a href="#l26.353"></a><span id="l26.353">   if (numSelected != 1) {</span>
<a href="#l26.354"></a><span id="l26.354">     ShowMenuItem(&quot;folderPaneContext-settings&quot;, false);</span>
<a href="#l26.355"></a><span id="l26.355">     ShowMenuItem(&quot;folderPaneContext-properties&quot;, false);</span>
<a href="#l26.356"></a><span id="l26.356" class="difflineminus">-  }</span>
<a href="#l26.357"></a><span id="l26.357" class="difflineminus">-  else if (selectedServers.length != 1)</span>
<a href="#l26.358"></a><span id="l26.358" class="difflineminus">-  {</span>
<a href="#l26.359"></a><span id="l26.359" class="difflineplus">+  } else if (selectedServers.length != 1) {</span>
<a href="#l26.360"></a><span id="l26.360">     ShowMenuItem(&quot;folderPaneContext-settings&quot;, false);</span>
<a href="#l26.361"></a><span id="l26.361">     ShowMenuItem(&quot;folderPaneContext-properties&quot;, true);</span>
<a href="#l26.362"></a><span id="l26.362" class="difflineminus">-  }</span>
<a href="#l26.363"></a><span id="l26.363" class="difflineminus">-  else</span>
<a href="#l26.364"></a><span id="l26.364" class="difflineminus">-  {</span>
<a href="#l26.365"></a><span id="l26.365" class="difflineplus">+  } else {</span>
<a href="#l26.366"></a><span id="l26.366">     ShowMenuItem(&quot;folderPaneContext-properties&quot;, false);</span>
<a href="#l26.367"></a><span id="l26.367">     ShowMenuItem(&quot;folderPaneContext-settings&quot;, true);</span>
<a href="#l26.368"></a><span id="l26.368">   }</span>
<a href="#l26.369"></a><span id="l26.369"> </span>
<a href="#l26.370"></a><span id="l26.370">   // --- Set up the get messages menu item.</span>
<a href="#l26.371"></a><span id="l26.371">   // Show if only servers, or it's only newsgroups/feeds. We could mix,</span>
<a href="#l26.372"></a><span id="l26.372">   // but it gets messy for situations where both server and a folder</span>
<a href="#l26.373"></a><span id="l26.373">   // on the server are selected.</span>
<a href="#l26.374"></a><span id="l26.374" class="difflineat">@@ -456,40 +418,37 @@ function fillFolderPaneContextMenu(aEven</span>
<a href="#l26.375"></a><span id="l26.375">   if (numSelected == 1) {</span>
<a href="#l26.376"></a><span id="l26.376">     let showNewFolderItem =</span>
<a href="#l26.377"></a><span id="l26.377">       ((folders[0].server.type != &quot;nntp&quot;) &amp;&amp; folders[0].canCreateSubfolders) ||</span>
<a href="#l26.378"></a><span id="l26.378">       (specialFolder == &quot;Inbox&quot;);</span>
<a href="#l26.379"></a><span id="l26.379">     ShowMenuItem(&quot;folderPaneContext-new&quot;, showNewFolderItem);</span>
<a href="#l26.380"></a><span id="l26.380">     // XXX: Can't offline imap create folders nowadays?</span>
<a href="#l26.381"></a><span id="l26.381">     EnableMenuItem(&quot;folderPaneContext-new&quot;, folders[0].server.type != &quot;imap&quot; ||</span>
<a href="#l26.382"></a><span id="l26.382">                                             MailOfflineMgr.isOnline());</span>
<a href="#l26.383"></a><span id="l26.383" class="difflineminus">-    if (showNewFolderItem)</span>
<a href="#l26.384"></a><span id="l26.384" class="difflineminus">-    {</span>
<a href="#l26.385"></a><span id="l26.385" class="difflineplus">+    if (showNewFolderItem) {</span>
<a href="#l26.386"></a><span id="l26.386">       if (folders[0].isServer || specialFolder == &quot;Inbox&quot;)</span>
<a href="#l26.387"></a><span id="l26.387">         SetMenuItemLabel(&quot;folderPaneContext-new&quot;,</span>
<a href="#l26.388"></a><span id="l26.388">                          bundle.getString(&quot;newFolder&quot;));</span>
<a href="#l26.389"></a><span id="l26.389">       else</span>
<a href="#l26.390"></a><span id="l26.390">         SetMenuItemLabel(&quot;folderPaneContext-new&quot;,</span>
<a href="#l26.391"></a><span id="l26.391">                          bundle.getString(&quot;newSubfolder&quot;));</span>
<a href="#l26.392"></a><span id="l26.392">     }</span>
<a href="#l26.393"></a><span id="l26.393" class="difflineminus">-  }</span>
<a href="#l26.394"></a><span id="l26.394" class="difflineminus">-  else {</span>
<a href="#l26.395"></a><span id="l26.395" class="difflineplus">+  } else {</span>
<a href="#l26.396"></a><span id="l26.396">     ShowMenuItem(&quot;folderPaneContext-new&quot;, false);</span>
<a href="#l26.397"></a><span id="l26.397">   }</span>
<a href="#l26.398"></a><span id="l26.398"> </span>
<a href="#l26.399"></a><span id="l26.399">   // --- Set up rename menu item.</span>
<a href="#l26.400"></a><span id="l26.400">   if (numSelected == 1) {</span>
<a href="#l26.401"></a><span id="l26.401">     ShowMenuItem(&quot;folderPaneContext-rename&quot;,</span>
<a href="#l26.402"></a><span id="l26.402">                  !folders[0].isServer &amp;&amp; folders[0].canRename &amp;&amp;</span>
<a href="#l26.403"></a><span id="l26.403">                  specialFolder == &quot;none&quot; || specialFolder == &quot;Virtual&quot; ||</span>
<a href="#l26.404"></a><span id="l26.404">                  (specialFolder == &quot;Junk&quot; &amp;&amp; CanRenameDeleteJunkMail(folders[0].URI)));</span>
<a href="#l26.405"></a><span id="l26.405">     EnableMenuItem(&quot;folderPaneContext-rename&quot;,</span>
<a href="#l26.406"></a><span id="l26.406">                    !folders[0].isServer &amp;&amp; folders[0].isCommandEnabled(&quot;cmd_renameFolder&quot;));</span>
<a href="#l26.407"></a><span id="l26.407" class="difflineminus">-  }</span>
<a href="#l26.408"></a><span id="l26.408" class="difflineminus">-  else {</span>
<a href="#l26.409"></a><span id="l26.409" class="difflineplus">+  } else {</span>
<a href="#l26.410"></a><span id="l26.410">     ShowMenuItem(&quot;folderPaneContext-rename&quot;, false);</span>
<a href="#l26.411"></a><span id="l26.411">   }</span>
<a href="#l26.412"></a><span id="l26.412"> </span>
<a href="#l26.413"></a><span id="l26.413">   // --- Set up the delete folder menu item.</span>
<a href="#l26.414"></a><span id="l26.414">   function checkCanDeleteFolder(folder) {</span>
<a href="#l26.415"></a><span id="l26.415">     if (folder.isSpecialFolder(Ci.nsMsgFolderFlags.Junk, false))</span>
<a href="#l26.416"></a><span id="l26.416">       return CanRenameDeleteJunkMail(folder.URI);</span>
<a href="#l26.417"></a><span id="l26.417">     return folder.deletable;</span>
<a href="#l26.418"></a><span id="l26.418" class="difflineat">@@ -515,18 +474,17 @@ function fillFolderPaneContextMenu(aEven</span>
<a href="#l26.419"></a><span id="l26.419">     return folder.isCommandEnabled(&quot;cmd_compactFolder&quot;);</span>
<a href="#l26.420"></a><span id="l26.420">   }</span>
<a href="#l26.421"></a><span id="l26.421">   var haveOnlyCompactEnabledFolders = folders.every(checkIsCompactEnabled);</span>
<a href="#l26.422"></a><span id="l26.422">   EnableMenuItem(&quot;folderPaneContext-compact&quot;, haveOnlyCompactEnabledFolders);</span>
<a href="#l26.423"></a><span id="l26.423"> </span>
<a href="#l26.424"></a><span id="l26.424">   // --- Set up favorite folder menu item.</span>
<a href="#l26.425"></a><span id="l26.425">   ShowMenuItem(&quot;folderPaneContext-favoriteFolder&quot;,</span>
<a href="#l26.426"></a><span id="l26.426">                numSelected == 1 &amp;&amp; !folders[0].isServer);</span>
<a href="#l26.427"></a><span id="l26.427" class="difflineminus">-  if (numSelected == 1 &amp;&amp; !folders[0].isServer)</span>
<a href="#l26.428"></a><span id="l26.428" class="difflineminus">-  {</span>
<a href="#l26.429"></a><span id="l26.429" class="difflineplus">+  if (numSelected == 1 &amp;&amp; !folders[0].isServer) {</span>
<a href="#l26.430"></a><span id="l26.430">      // Adjust the checked state on the menu item.</span>
<a href="#l26.431"></a><span id="l26.431">     document.getElementById(&quot;folderPaneContext-favoriteFolder&quot;)</span>
<a href="#l26.432"></a><span id="l26.432">             .setAttribute(&quot;checked&quot;, folders[0].getFlag(Ci.nsMsgFolderFlags.Favorite));</span>
<a href="#l26.433"></a><span id="l26.433">   }</span>
<a href="#l26.434"></a><span id="l26.434"> </span>
<a href="#l26.435"></a><span id="l26.435">   // --- Set up the empty trash menu item.</span>
<a href="#l26.436"></a><span id="l26.436">   ShowMenuItem(&quot;folderPaneContext-emptyTrash&quot;,</span>
<a href="#l26.437"></a><span id="l26.437">                numSelected == 1 &amp;&amp; specialFolder == &quot;Trash&quot;);</span>
<a href="#l26.438"></a><span id="l26.438" class="difflineat">@@ -559,17 +517,17 @@ function fillFolderPaneContextMenu(aEven</span>
<a href="#l26.439"></a><span id="l26.439">                haveOnlyMailFolders &amp;&amp; !haveAnyVirtualFolders);</span>
<a href="#l26.440"></a><span id="l26.440">   SetMenuItemLabel(&quot;folderPaneContext-markMailFolderAllRead&quot;,</span>
<a href="#l26.441"></a><span id="l26.441">                    PluralForm.get(numSelected,</span>
<a href="#l26.442"></a><span id="l26.442">                                   bundle.getString(&quot;markFolderRead&quot;)));</span>
<a href="#l26.443"></a><span id="l26.443"> </span>
<a href="#l26.444"></a><span id="l26.444">   // Set up the search menu item.</span>
<a href="#l26.445"></a><span id="l26.445">   ShowMenuItem(&quot;folderPaneContext-searchMessages&quot;,</span>
<a href="#l26.446"></a><span id="l26.446">                numSelected == 1 &amp;&amp; !haveAnyVirtualFolders);</span>
<a href="#l26.447"></a><span id="l26.447" class="difflineminus">-  goUpdateCommand('cmd_search');</span>
<a href="#l26.448"></a><span id="l26.448" class="difflineplus">+  goUpdateCommand(&quot;cmd_search&quot;);</span>
<a href="#l26.449"></a><span id="l26.449"> </span>
<a href="#l26.450"></a><span id="l26.450">   // handle our separators</span>
<a href="#l26.451"></a><span id="l26.451">   function hideIfAppropriate(aID) {</span>
<a href="#l26.452"></a><span id="l26.452">     var separator = document.getElementById(aID);</span>
<a href="#l26.453"></a><span id="l26.453">     var sibling = separator.previousSibling;</span>
<a href="#l26.454"></a><span id="l26.454">     while (sibling) {</span>
<a href="#l26.455"></a><span id="l26.455">       if (sibling.getAttribute(&quot;hidden&quot;) != &quot;true&quot;) {</span>
<a href="#l26.456"></a><span id="l26.456">         ShowMenuItem(aID, sibling.localName != &quot;menuseparator&quot; &amp;&amp;</span>
<a href="#l26.457"></a><span id="l26.457" class="difflineat">@@ -585,116 +543,103 @@ function fillFolderPaneContextMenu(aEven</span>
<a href="#l26.458"></a><span id="l26.458">   ShowMenuItem(&quot;folderPaneContext-sep1&quot;, selectedServers.length == 0);</span>
<a href="#l26.459"></a><span id="l26.459">   hideIfAppropriate(&quot;folderPaneContext-sep1&quot;);</span>
<a href="#l26.460"></a><span id="l26.460">   hideIfAppropriate(&quot;folderPaneContext-sep2&quot;);</span>
<a href="#l26.461"></a><span id="l26.461">   hideIfAppropriate(&quot;folderPaneContext-sep3&quot;);</span>
<a href="#l26.462"></a><span id="l26.462">   hideIfAppropriate(&quot;folderPaneContext-sep4&quot;);</span>
<a href="#l26.463"></a><span id="l26.463"> </span>
<a href="#l26.464"></a><span id="l26.464">   return true;</span>
<a href="#l26.465"></a><span id="l26.465"> }</span>
<a href="#l26.466"></a><span id="l26.466" class="difflineplus">+/* eslint-enable complexity */</span>
<a href="#l26.467"></a><span id="l26.467"> </span>
<a href="#l26.468"></a><span id="l26.468" class="difflineminus">-function ShowMenuItem(id, showItem)</span>
<a href="#l26.469"></a><span id="l26.469" class="difflineminus">-{</span>
<a href="#l26.470"></a><span id="l26.470" class="difflineplus">+function ShowMenuItem(id, showItem) {</span>
<a href="#l26.471"></a><span id="l26.471">   document.getElementById(id).hidden = !showItem;</span>
<a href="#l26.472"></a><span id="l26.472"> }</span>
<a href="#l26.473"></a><span id="l26.473"> </span>
<a href="#l26.474"></a><span id="l26.474" class="difflineminus">-function EnableMenuItem(id, enableItem)</span>
<a href="#l26.475"></a><span id="l26.475" class="difflineminus">-{</span>
<a href="#l26.476"></a><span id="l26.476" class="difflineplus">+function EnableMenuItem(id, enableItem) {</span>
<a href="#l26.477"></a><span id="l26.477">   document.getElementById(id).disabled = !enableItem;</span>
<a href="#l26.478"></a><span id="l26.478"> }</span>
<a href="#l26.479"></a><span id="l26.479"> </span>
<a href="#l26.480"></a><span id="l26.480" class="difflineminus">-function SetMenuItemLabel(id, label)</span>
<a href="#l26.481"></a><span id="l26.481" class="difflineminus">-{</span>
<a href="#l26.482"></a><span id="l26.482" class="difflineminus">-  document.getElementById(id).setAttribute('label', label);</span>
<a href="#l26.483"></a><span id="l26.483" class="difflineplus">+function SetMenuItemLabel(id, label) {</span>
<a href="#l26.484"></a><span id="l26.484" class="difflineplus">+  document.getElementById(id).setAttribute(&quot;label&quot;, label);</span>
<a href="#l26.485"></a><span id="l26.485"> }</span>
<a href="#l26.486"></a><span id="l26.486"> </span>
<a href="#l26.487"></a><span id="l26.487"> // helper function used by shouldShowSeparator</span>
<a href="#l26.488"></a><span id="l26.488" class="difflineminus">-function hasAVisibleNextSibling(aNode)</span>
<a href="#l26.489"></a><span id="l26.489" class="difflineminus">-{</span>
<a href="#l26.490"></a><span id="l26.490" class="difflineplus">+function hasAVisibleNextSibling(aNode) {</span>
<a href="#l26.491"></a><span id="l26.491">   var sibling = aNode.nextSibling;</span>
<a href="#l26.492"></a><span id="l26.492" class="difflineminus">-  while (sibling)</span>
<a href="#l26.493"></a><span id="l26.493" class="difflineminus">-  {</span>
<a href="#l26.494"></a><span id="l26.494" class="difflineplus">+  while (sibling) {</span>
<a href="#l26.495"></a><span id="l26.495">     if (sibling.getAttribute(&quot;hidden&quot;) != &quot;true&quot;</span>
<a href="#l26.496"></a><span id="l26.496">         &amp;&amp; sibling.localName != &quot;menuseparator&quot;)</span>
<a href="#l26.497"></a><span id="l26.497">       return true;</span>
<a href="#l26.498"></a><span id="l26.498">     sibling = sibling.nextSibling;</span>
<a href="#l26.499"></a><span id="l26.499">   }</span>
<a href="#l26.500"></a><span id="l26.500">   return false;</span>
<a href="#l26.501"></a><span id="l26.501"> }</span>
<a href="#l26.502"></a><span id="l26.502"> </span>
<a href="#l26.503"></a><span id="l26.503" class="difflineminus">-function IsMenuItemShowing(menuID)</span>
<a href="#l26.504"></a><span id="l26.504" class="difflineminus">-{</span>
<a href="#l26.505"></a><span id="l26.505" class="difflineplus">+function IsMenuItemShowing(menuID) {</span>
<a href="#l26.506"></a><span id="l26.506">   var item = document.getElementById(menuID);</span>
<a href="#l26.507"></a><span id="l26.507">   if (item)</span>
<a href="#l26.508"></a><span id="l26.508">     return item.hidden != &quot;true&quot;;</span>
<a href="#l26.509"></a><span id="l26.509">   return false;</span>
<a href="#l26.510"></a><span id="l26.510"> }</span>
<a href="#l26.511"></a><span id="l26.511"> </span>
<a href="#l26.512"></a><span id="l26.512"> // message pane context menu helper methods</span>
<a href="#l26.513"></a><span id="l26.513" class="difflineminus">-function addEmail()</span>
<a href="#l26.514"></a><span id="l26.514" class="difflineminus">-{</span>
<a href="#l26.515"></a><span id="l26.515" class="difflineplus">+function addEmail() {</span>
<a href="#l26.516"></a><span id="l26.516">   var url = gContextMenu.linkURL;</span>
<a href="#l26.517"></a><span id="l26.517">   var addresses = getEmail(url);</span>
<a href="#l26.518"></a><span id="l26.518">   window.openDialog(&quot;chrome://messenger/content/addressbook/abNewCardDialog.xul&quot;,</span>
<a href="#l26.519"></a><span id="l26.519">                     &quot;&quot;,</span>
<a href="#l26.520"></a><span id="l26.520">                      &quot;chrome,resizable=no,titlebar,modal,centerscreen&quot;,</span>
<a href="#l26.521"></a><span id="l26.521">                     {primaryEmail: addresses});</span>
<a href="#l26.522"></a><span id="l26.522"> }</span>
<a href="#l26.523"></a><span id="l26.523"> </span>
<a href="#l26.524"></a><span id="l26.524" class="difflineminus">-function composeEmailTo()</span>
<a href="#l26.525"></a><span id="l26.525" class="difflineminus">-{</span>
<a href="#l26.526"></a><span id="l26.526" class="difflineplus">+function composeEmailTo() {</span>
<a href="#l26.527"></a><span id="l26.527">   let fields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l26.528"></a><span id="l26.528">                  .createInstance(Ci.nsIMsgCompFields);</span>
<a href="#l26.529"></a><span id="l26.529">   let params = Cc[&quot;@mozilla.org/messengercompose/composeparams;1&quot;]</span>
<a href="#l26.530"></a><span id="l26.530">                  .createInstance(Ci.nsIMsgComposeParams);</span>
<a href="#l26.531"></a><span id="l26.531">   fields.to = getEmail(gContextMenu.linkURL);</span>
<a href="#l26.532"></a><span id="l26.532">   params.type = Ci.nsIMsgCompType.New;</span>
<a href="#l26.533"></a><span id="l26.533">   params.format = Ci.nsIMsgCompFormat.Default;</span>
<a href="#l26.534"></a><span id="l26.534">   if (gFolderDisplay.displayedFolder) {</span>
<a href="#l26.535"></a><span id="l26.535">     params.identity = accountManager.getFirstIdentityForServer(</span>
<a href="#l26.536"></a><span id="l26.536">                         gFolderDisplay.displayedFolder.server);</span>
<a href="#l26.537"></a><span id="l26.537">   }</span>
<a href="#l26.538"></a><span id="l26.538">   params.composeFields = fields;</span>
<a href="#l26.539"></a><span id="l26.539">   MailServices.compose.OpenComposeWindowWithParams(null, params);</span>
<a href="#l26.540"></a><span id="l26.540"> }</span>
<a href="#l26.541"></a><span id="l26.541"> </span>
<a href="#l26.542"></a><span id="l26.542"> // Extracts email address from url string</span>
<a href="#l26.543"></a><span id="l26.543" class="difflineminus">-function getEmail (url)</span>
<a href="#l26.544"></a><span id="l26.544" class="difflineminus">-{</span>
<a href="#l26.545"></a><span id="l26.545" class="difflineminus">-  var qmark = url.indexOf( &quot;?&quot; );</span>
<a href="#l26.546"></a><span id="l26.546" class="difflineplus">+function getEmail(url) {</span>
<a href="#l26.547"></a><span id="l26.547" class="difflineplus">+  var qmark = url.indexOf(&quot;?&quot;);</span>
<a href="#l26.548"></a><span id="l26.548">   var addresses;</span>
<a href="#l26.549"></a><span id="l26.549"> </span>
<a href="#l26.550"></a><span id="l26.550" class="difflineminus">-  if ( qmark &gt; mailtolength )</span>
<a href="#l26.551"></a><span id="l26.551" class="difflineminus">-      addresses = url.substring( mailtolength, qmark );</span>
<a href="#l26.552"></a><span id="l26.552" class="difflineplus">+  if (qmark &gt; mailtolength)</span>
<a href="#l26.553"></a><span id="l26.553" class="difflineplus">+    addresses = url.substring(mailtolength, qmark);</span>
<a href="#l26.554"></a><span id="l26.554">   else</span>
<a href="#l26.555"></a><span id="l26.555" class="difflineminus">-     addresses = url.substr( mailtolength );</span>
<a href="#l26.556"></a><span id="l26.556" class="difflineplus">+    addresses = url.substr(mailtolength);</span>
<a href="#l26.557"></a><span id="l26.557">   // Let's try to unescape it using a character set</span>
<a href="#l26.558"></a><span id="l26.558">   try {</span>
<a href="#l26.559"></a><span id="l26.559">     var characterSet = gContextMenu.target.ownerDocument.characterSet;</span>
<a href="#l26.560"></a><span id="l26.560" class="difflineminus">-    const textToSubURI = Cc[&quot;@mozilla.org/intl/texttosuburi;1&quot;]</span>
<a href="#l26.561"></a><span id="l26.561" class="difflineminus">-                                 .getService(Ci.nsITextToSubURI);</span>
<a href="#l26.562"></a><span id="l26.562" class="difflineminus">-    addresses = textToSubURI.unEscapeURIForUI(characterSet, addresses);</span>
<a href="#l26.563"></a><span id="l26.563" class="difflineminus">-  }</span>
<a href="#l26.564"></a><span id="l26.564" class="difflineminus">-  catch(ex) {</span>
<a href="#l26.565"></a><span id="l26.565" class="difflineplus">+    addresses = Services.textToSubURI.unEscapeURIForUI(characterSet, addresses);</span>
<a href="#l26.566"></a><span id="l26.566" class="difflineplus">+  } catch (ex) {</span>
<a href="#l26.567"></a><span id="l26.567">     // Do nothing.</span>
<a href="#l26.568"></a><span id="l26.568">   }</span>
<a href="#l26.569"></a><span id="l26.569">   return addresses;</span>
<a href="#l26.570"></a><span id="l26.570"> }</span>
<a href="#l26.571"></a><span id="l26.571"> </span>
<a href="#l26.572"></a><span id="l26.572" class="difflineminus">-function CopyMessageUrl()</span>
<a href="#l26.573"></a><span id="l26.573" class="difflineminus">-{</span>
<a href="#l26.574"></a><span id="l26.574" class="difflineplus">+function CopyMessageUrl() {</span>
<a href="#l26.575"></a><span id="l26.575">   try {</span>
<a href="#l26.576"></a><span id="l26.576">     var hdr = gDBView.hdrForFirstSelectedMessage;</span>
<a href="#l26.577"></a><span id="l26.577">     var server = hdr.folder.server;</span>
<a href="#l26.578"></a><span id="l26.578"> </span>
<a href="#l26.579"></a><span id="l26.579">     // TODO let backend construct URL and return as attribute</span>
<a href="#l26.580"></a><span id="l26.580">     var url = (server.socketType == Ci.nsMsgSocketType.SSL) ?</span>
<a href="#l26.581"></a><span id="l26.581">               &quot;snews://&quot; : &quot;news://&quot;;</span>
<a href="#l26.582"></a><span id="l26.582">     url += server.hostName + &quot;:&quot; + server.port + &quot;/&quot; + hdr.messageId;</span>
<a href="#l26.583"></a><span id="l26.583"> </span>
<a href="#l26.584"></a><span id="l26.584">     var clipboard = Cc[&quot;@mozilla.org/widget/clipboardhelper;1&quot;]</span>
<a href="#l26.585"></a><span id="l26.585">                       .getService(Ci.nsIClipboardHelper);</span>
<a href="#l26.586"></a><span id="l26.586">     clipboard.copyString(url);</span>
<a href="#l26.587"></a><span id="l26.587" class="difflineminus">-  }</span>
<a href="#l26.588"></a><span id="l26.588" class="difflineminus">-  catch (ex) {</span>
<a href="#l26.589"></a><span id="l26.589" class="difflineminus">-    dump(&quot;ex=&quot;+ex+&quot;\n&quot;);</span>
<a href="#l26.590"></a><span id="l26.590" class="difflineplus">+  } catch (ex) {</span>
<a href="#l26.591"></a><span id="l26.591" class="difflineplus">+    dump(&quot;ex=&quot; + ex + &quot;\n&quot;);</span>
<a href="#l26.592"></a><span id="l26.592">   }</span>
<a href="#l26.593"></a><span id="l26.593"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mail/base/content/mailCore.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mail/base/content/mailCore.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -17,17 +17,17 @@ ChromeUtils.import(&quot;resource://gre/modul</span>
<a href="#l27.4"></a><span id="l27.4"> ChromeUtils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;);</span>
<a href="#l27.5"></a><span id="l27.5"> ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l27.6"></a><span id="l27.6"> ChromeUtils.import(&quot;resource://gre/modules/CharsetMenu.jsm&quot;);</span>
<a href="#l27.7"></a><span id="l27.7"> ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l27.8"></a><span id="l27.8"> </span>
<a href="#l27.9"></a><span id="l27.9"> XPCOMUtils.defineLazyGetter(this, &quot;gViewSourceUtils&quot;, function() {</span>
<a href="#l27.10"></a><span id="l27.10">   let scope = {};</span>
<a href="#l27.11"></a><span id="l27.11">   Services.scriptloader.loadSubScript(&quot;chrome://global/content/viewSourceUtils.js&quot;, scope);</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-  scope.gViewSourceUtils.viewSource = async function (aArgs) {</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+  scope.gViewSourceUtils.viewSource = async function(aArgs) {</span>
<a href="#l27.14"></a><span id="l27.14">     // Check if external view source is enabled. If so, try it. If it fails,</span>
<a href="#l27.15"></a><span id="l27.15">     // fallback to internal view source.</span>
<a href="#l27.16"></a><span id="l27.16">     if (Services.prefs.getBoolPref(&quot;view_source.editor.external&quot;)) {</span>
<a href="#l27.17"></a><span id="l27.17">       try {</span>
<a href="#l27.18"></a><span id="l27.18">         await this.openInExternalEditor(aArgs);</span>
<a href="#l27.19"></a><span id="l27.19">         return;</span>
<a href="#l27.20"></a><span id="l27.20">       } catch (ex) {}</span>
<a href="#l27.21"></a><span id="l27.21">     }</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineat">@@ -40,17 +40,17 @@ XPCOMUtils.defineLazyGetter(this, &quot;gView</span>
<a href="#l27.23"></a><span id="l27.23"> Services.obs.addObserver({</span>
<a href="#l27.24"></a><span id="l27.24">   observe(win) {</span>
<a href="#l27.25"></a><span id="l27.25">     win.addEventListener(&quot;load&quot;, function() {</span>
<a href="#l27.26"></a><span id="l27.26">       if (this.location.href != &quot;chrome://devtools/content/webconsole/browserconsole.xul&quot;) {</span>
<a href="#l27.27"></a><span id="l27.27">         return;</span>
<a href="#l27.28"></a><span id="l27.28">       }</span>
<a href="#l27.29"></a><span id="l27.29"> </span>
<a href="#l27.30"></a><span id="l27.30">       this.setTimeout(() =&gt; {</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineminus">-        this.gViewSourceUtils.viewSource = async function (aArgs) {</span>
<a href="#l27.32"></a><span id="l27.32" class="difflineplus">+        this.gViewSourceUtils.viewSource = async function(aArgs) {</span>
<a href="#l27.33"></a><span id="l27.33">           // Check if external view source is enabled. If so, try it. If it fails,</span>
<a href="#l27.34"></a><span id="l27.34">           // fallback to internal view source.</span>
<a href="#l27.35"></a><span id="l27.35">           if (Services.prefs.getBoolPref(&quot;view_source.editor.external&quot;)) {</span>
<a href="#l27.36"></a><span id="l27.36">             try {</span>
<a href="#l27.37"></a><span id="l27.37">               await this.openInExternalEditor(aArgs);</span>
<a href="#l27.38"></a><span id="l27.38">               return;</span>
<a href="#l27.39"></a><span id="l27.39">             } catch (ex) {}</span>
<a href="#l27.40"></a><span id="l27.40">           }</span>
<a href="#l27.41"></a><span id="l27.41" class="difflineat">@@ -74,51 +74,48 @@ function overlayRestoreDefaultSet() {</span>
<a href="#l27.42"></a><span id="l27.42">   let mode = toolbox.getAttribute(&quot;defaultmode&quot;);</span>
<a href="#l27.43"></a><span id="l27.43">   let align = toolbox.getAttribute(&quot;defaultlabelalign&quot;);</span>
<a href="#l27.44"></a><span id="l27.44">   let menulist = document.getElementById(&quot;modelist&quot;);</span>
<a href="#l27.45"></a><span id="l27.45"> </span>
<a href="#l27.46"></a><span id="l27.46">   if (mode == &quot;full&quot; &amp;&amp; align == &quot;end&quot;) {</span>
<a href="#l27.47"></a><span id="l27.47">     toolbox.setAttribute(&quot;mode&quot;, &quot;textbesideicon&quot;);</span>
<a href="#l27.48"></a><span id="l27.48">     toolbox.setAttribute(&quot;labelalign&quot;, align);</span>
<a href="#l27.49"></a><span id="l27.49">     overlayUpdateToolbarMode(&quot;textbesideicon&quot;);</span>
<a href="#l27.50"></a><span id="l27.50" class="difflineminus">-  }</span>
<a href="#l27.51"></a><span id="l27.51" class="difflineminus">-  else if (mode == &quot;full&quot; &amp;&amp; align == &quot;&quot;){</span>
<a href="#l27.52"></a><span id="l27.52" class="difflineplus">+  } else if (mode == &quot;full&quot; &amp;&amp; align == &quot;&quot;) {</span>
<a href="#l27.53"></a><span id="l27.53">     toolbox.setAttribute(&quot;mode&quot;, &quot;full&quot;);</span>
<a href="#l27.54"></a><span id="l27.54">     toolbox.removeAttribute(&quot;labelalign&quot;);</span>
<a href="#l27.55"></a><span id="l27.55">     overlayUpdateToolbarMode(mode);</span>
<a href="#l27.56"></a><span id="l27.56">   }</span>
<a href="#l27.57"></a><span id="l27.57"> </span>
<a href="#l27.58"></a><span id="l27.58">   restoreDefaultSet();</span>
<a href="#l27.59"></a><span id="l27.59"> </span>
<a href="#l27.60"></a><span id="l27.60">   if (mode == &quot;full&quot; &amp;&amp; align == &quot;end&quot;) {</span>
<a href="#l27.61"></a><span id="l27.61">     menulist.value = &quot;textbesideicon&quot;;</span>
<a href="#l27.62"></a><span id="l27.62">   }</span>
<a href="#l27.63"></a><span id="l27.63"> }</span>
<a href="#l27.64"></a><span id="l27.64"> </span>
<a href="#l27.65"></a><span id="l27.65" class="difflineminus">-function overlayUpdateToolbarMode(aModeValue)</span>
<a href="#l27.66"></a><span id="l27.66" class="difflineminus">-{</span>
<a href="#l27.67"></a><span id="l27.67" class="difflineplus">+function overlayUpdateToolbarMode(aModeValue) {</span>
<a href="#l27.68"></a><span id="l27.68">   let toolbox = null;</span>
<a href="#l27.69"></a><span id="l27.69">   if (&quot;arguments&quot; in window &amp;&amp; window.arguments[0])</span>
<a href="#l27.70"></a><span id="l27.70">     toolbox = window.arguments[0];</span>
<a href="#l27.71"></a><span id="l27.71">   else if (window.frameElement &amp;&amp; &quot;toolbox&quot; in window.frameElement)</span>
<a href="#l27.72"></a><span id="l27.72">     toolbox = window.frameElement.toolbox;</span>
<a href="#l27.73"></a><span id="l27.73"> </span>
<a href="#l27.74"></a><span id="l27.74">   // If they chose a mode of textbesideicon or full,</span>
<a href="#l27.75"></a><span id="l27.75">   // then map that to a mode of full, and a labelalign of true or false.</span>
<a href="#l27.76"></a><span id="l27.76" class="difflineminus">-  if( aModeValue == &quot;textbesideicon&quot; || aModeValue == &quot;full&quot;) {</span>
<a href="#l27.77"></a><span id="l27.77" class="difflineplus">+  if (aModeValue == &quot;textbesideicon&quot; || aModeValue == &quot;full&quot;) {</span>
<a href="#l27.78"></a><span id="l27.78">     var align = aModeValue == &quot;textbesideicon&quot; ? &quot;end&quot; : &quot;bottom&quot;;</span>
<a href="#l27.79"></a><span id="l27.79">     toolbox.setAttribute(&quot;labelalign&quot;, align);</span>
<a href="#l27.80"></a><span id="l27.80">     Services.xulStore.persist(toolbox, &quot;labelalign&quot;);</span>
<a href="#l27.81"></a><span id="l27.81">     aModeValue = &quot;full&quot;;</span>
<a href="#l27.82"></a><span id="l27.82">   }</span>
<a href="#l27.83"></a><span id="l27.83">   updateToolbarMode(aModeValue);</span>
<a href="#l27.84"></a><span id="l27.84"> }</span>
<a href="#l27.85"></a><span id="l27.85"> </span>
<a href="#l27.86"></a><span id="l27.86" class="difflineminus">-function overlayOnLoad()</span>
<a href="#l27.87"></a><span id="l27.87" class="difflineminus">-{</span>
<a href="#l27.88"></a><span id="l27.88" class="difflineplus">+function overlayOnLoad() {</span>
<a href="#l27.89"></a><span id="l27.89">   let restoreButton = document.getElementById(&quot;main-box&quot;)</span>
<a href="#l27.90"></a><span id="l27.90">                               .querySelector(&quot;[oncommand*='restore']&quot;);</span>
<a href="#l27.91"></a><span id="l27.91">   restoreButton.setAttribute(&quot;oncommand&quot;, &quot;overlayRestoreDefaultSet();&quot;);</span>
<a href="#l27.92"></a><span id="l27.92"> </span>
<a href="#l27.93"></a><span id="l27.93">   // Add the textBesideIcon menu item if it's not already there.</span>
<a href="#l27.94"></a><span id="l27.94">   let menuitem = document.getElementById(&quot;textbesideiconItem&quot;);</span>
<a href="#l27.95"></a><span id="l27.95">   if (!menuitem) {</span>
<a href="#l27.96"></a><span id="l27.96">     let menulist = document.getElementById(&quot;modelist&quot;);</span>
<a href="#l27.97"></a><span id="l27.97" class="difflineat">@@ -152,18 +149,17 @@ function overlayOnLoad()</span>
<a href="#l27.98"></a><span id="l27.98"> </span>
<a href="#l27.99"></a><span id="l27.99">   // Re-set and re-persist the mode, if we changed it above.</span>
<a href="#l27.100"></a><span id="l27.100">   if (mode == &quot;full&quot; &amp;&amp; align == &quot;end&quot;) {</span>
<a href="#l27.101"></a><span id="l27.101">     toolbox.setAttribute(&quot;mode&quot;, mode);</span>
<a href="#l27.102"></a><span id="l27.102">     Services.xulStore.persist(toolbox, &quot;mode&quot;);</span>
<a href="#l27.103"></a><span id="l27.103">   }</span>
<a href="#l27.104"></a><span id="l27.104"> }</span>
<a href="#l27.105"></a><span id="l27.105"> </span>
<a href="#l27.106"></a><span id="l27.106" class="difflineminus">-function overlayRepositionDialog()</span>
<a href="#l27.107"></a><span id="l27.107" class="difflineminus">-{</span>
<a href="#l27.108"></a><span id="l27.108" class="difflineplus">+function overlayRepositionDialog() {</span>
<a href="#l27.109"></a><span id="l27.109">   // Position the dialog so it is fully visible on the screen</span>
<a href="#l27.110"></a><span id="l27.110">   // (if possible)</span>
<a href="#l27.111"></a><span id="l27.111"> </span>
<a href="#l27.112"></a><span id="l27.112">   // Seems to be necessary to get the correct dialog height/width</span>
<a href="#l27.113"></a><span id="l27.113">   window.sizeToContent();</span>
<a href="#l27.114"></a><span id="l27.114">   var wH  = window.outerHeight;</span>
<a href="#l27.115"></a><span id="l27.115">   var wW  = window.outerWidth;</span>
<a href="#l27.116"></a><span id="l27.116">   var sH  = window.screen.height;</span>
<a href="#l27.117"></a><span id="l27.117" class="difflineat">@@ -173,18 +169,17 @@ function overlayRepositionDialog()</span>
<a href="#l27.118"></a><span id="l27.118">   var sAL = window.screen.availLeft;</span>
<a href="#l27.119"></a><span id="l27.119">   var sAT = window.screen.availTop;</span>
<a href="#l27.120"></a><span id="l27.120"> </span>
<a href="#l27.121"></a><span id="l27.121">   var nX = Math.max(Math.min(sX, sW - wW), sAL);</span>
<a href="#l27.122"></a><span id="l27.122">   var nY = Math.max(Math.min(sY, sH - wH), sAT);</span>
<a href="#l27.123"></a><span id="l27.123">   window.moveTo(nX, nY);</span>
<a href="#l27.124"></a><span id="l27.124"> }</span>
<a href="#l27.125"></a><span id="l27.125"> </span>
<a href="#l27.126"></a><span id="l27.126" class="difflineminus">-function CustomizeMailToolbar(toolboxId, customizePopupId)</span>
<a href="#l27.127"></a><span id="l27.127" class="difflineminus">-{</span>
<a href="#l27.128"></a><span id="l27.128" class="difflineplus">+function CustomizeMailToolbar(toolboxId, customizePopupId) {</span>
<a href="#l27.129"></a><span id="l27.129">   // Disable the toolbar context menu items</span>
<a href="#l27.130"></a><span id="l27.130">   var menubar = document.getElementById(&quot;mail-menubar&quot;);</span>
<a href="#l27.131"></a><span id="l27.131">   for (var i = 0; i &lt; menubar.childNodes.length; ++i)</span>
<a href="#l27.132"></a><span id="l27.132">     menubar.childNodes[i].setAttribute(&quot;disabled&quot;, true);</span>
<a href="#l27.133"></a><span id="l27.133"> </span>
<a href="#l27.134"></a><span id="l27.134">   var customizePopup = document.getElementById(customizePopupId);</span>
<a href="#l27.135"></a><span id="l27.135">   customizePopup.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l27.136"></a><span id="l27.136"> </span>
<a href="#l27.137"></a><span id="l27.137" class="difflineat">@@ -199,40 +194,38 @@ function CustomizeMailToolbar(toolboxId,</span>
<a href="#l27.138"></a><span id="l27.138">     sheetFrame.hidden = false;</span>
<a href="#l27.139"></a><span id="l27.139">     sheetFrame.toolbox = toolbox;</span>
<a href="#l27.140"></a><span id="l27.140">     sheetFrame.panel = panel;</span>
<a href="#l27.141"></a><span id="l27.141"> </span>
<a href="#l27.142"></a><span id="l27.142">     // The document might not have been loaded yet, if this is the first time.</span>
<a href="#l27.143"></a><span id="l27.143">     // If it is already loaded, reload it so that the onload initialization code</span>
<a href="#l27.144"></a><span id="l27.144">     // re-runs.</span>
<a href="#l27.145"></a><span id="l27.145">     if (sheetFrame.getAttribute(&quot;src&quot;) == customizeURL)</span>
<a href="#l27.146"></a><span id="l27.146" class="difflineminus">-      sheetFrame.contentWindow.location.reload()</span>
<a href="#l27.147"></a><span id="l27.147" class="difflineplus">+      sheetFrame.contentWindow.location.reload();</span>
<a href="#l27.148"></a><span id="l27.148">     else</span>
<a href="#l27.149"></a><span id="l27.149">       sheetFrame.setAttribute(&quot;src&quot;, customizeURL);</span>
<a href="#l27.150"></a><span id="l27.150"> </span>
<a href="#l27.151"></a><span id="l27.151">     // Open the panel, but make it invisible until the iframe has loaded so</span>
<a href="#l27.152"></a><span id="l27.152">     // that the user doesn't see a white flash.</span>
<a href="#l27.153"></a><span id="l27.153">     panel.style.visibility = &quot;hidden&quot;;</span>
<a href="#l27.154"></a><span id="l27.154" class="difflineminus">-    toolbox.addEventListener(&quot;beforecustomization&quot;, function removeProp() {</span>
<a href="#l27.155"></a><span id="l27.155" class="difflineplus">+    toolbox.addEventListener(&quot;beforecustomization&quot;, function() {</span>
<a href="#l27.156"></a><span id="l27.156">       panel.style.removeProperty(&quot;visibility&quot;);</span>
<a href="#l27.157"></a><span id="l27.157">     }, {capture: false, once: true});</span>
<a href="#l27.158"></a><span id="l27.158">     panel.openPopup(toolbox, &quot;after_start&quot;, 0, 0);</span>
<a href="#l27.159"></a><span id="l27.159" class="difflineminus">-  }</span>
<a href="#l27.160"></a><span id="l27.160" class="difflineminus">-  else {</span>
<a href="#l27.161"></a><span id="l27.161" class="difflineplus">+  } else {</span>
<a href="#l27.162"></a><span id="l27.162">     var wintype = document.documentElement.getAttribute(&quot;windowtype&quot;);</span>
<a href="#l27.163"></a><span id="l27.163">     wintype = wintype.replace(/:/g, &quot;&quot;);</span>
<a href="#l27.164"></a><span id="l27.164"> </span>
<a href="#l27.165"></a><span id="l27.165">     window.openDialog(customizeURL,</span>
<a href="#l27.166"></a><span id="l27.166" class="difflineminus">-                      &quot;CustomizeToolbar&quot;+wintype,</span>
<a href="#l27.167"></a><span id="l27.167" class="difflineplus">+                      &quot;CustomizeToolbar&quot; + wintype,</span>
<a href="#l27.168"></a><span id="l27.168">                       &quot;chrome,all,dependent&quot;, toolbox);</span>
<a href="#l27.169"></a><span id="l27.169">   }</span>
<a href="#l27.170"></a><span id="l27.170"> }</span>
<a href="#l27.171"></a><span id="l27.171"> </span>
<a href="#l27.172"></a><span id="l27.172" class="difflineminus">-function MailToolboxCustomizeDone(aEvent, customizePopupId)</span>
<a href="#l27.173"></a><span id="l27.173" class="difflineminus">-{</span>
<a href="#l27.174"></a><span id="l27.174" class="difflineplus">+function MailToolboxCustomizeDone(aEvent, customizePopupId) {</span>
<a href="#l27.175"></a><span id="l27.175">   if (gCustomizeSheet) {</span>
<a href="#l27.176"></a><span id="l27.176">     document.getElementById(&quot;customizeToolbarSheetIFrame&quot;).hidden = true;</span>
<a href="#l27.177"></a><span id="l27.177">     document.getElementById(&quot;customizeToolbarSheetPopup&quot;).hidePopup();</span>
<a href="#l27.178"></a><span id="l27.178">   }</span>
<a href="#l27.179"></a><span id="l27.179"> </span>
<a href="#l27.180"></a><span id="l27.180">   // Update global UI elements that may have been added or removed</span>
<a href="#l27.181"></a><span id="l27.181"> </span>
<a href="#l27.182"></a><span id="l27.182">   // Re-enable parts of the UI we disabled during the dialog</span>
<a href="#l27.183"></a><span id="l27.183" class="difflineat">@@ -266,18 +259,17 @@ function MailToolboxCustomizeDone(aEvent</span>
<a href="#l27.184"></a><span id="l27.184">     // menus (old and new App menu). And also Go -&gt; Folder.</span>
<a href="#l27.185"></a><span id="l27.185">     // TODO bug 904223: try to fix folderWidgets.xml to not do this.</span>
<a href="#l27.186"></a><span id="l27.186">     // See Bug 520457 and Bug 534448 and Bug 709733.</span>
<a href="#l27.187"></a><span id="l27.187">     // Fix Bug 565045: Only treat &quot;Get Message Button&quot; if it is in our toolbox</span>
<a href="#l27.188"></a><span id="l27.188">     for (let popup of [ toolbox.querySelector(&quot;#button-getMsgPopup&quot;),</span>
<a href="#l27.189"></a><span id="l27.189">                         document.getElementById(&quot;menu_getAllNewMsgPopup&quot;),</span>
<a href="#l27.190"></a><span id="l27.190">                         document.getElementById(&quot;appmenu_getAllNewMsgPopup&quot;),</span>
<a href="#l27.191"></a><span id="l27.191">                         document.getElementById(&quot;menu_GoFolderPopup&quot;),</span>
<a href="#l27.192"></a><span id="l27.192" class="difflineminus">-                        document.getElementById(&quot;appmenu_GoFolderPopup&quot;) ])</span>
<a href="#l27.193"></a><span id="l27.193" class="difflineminus">-    {</span>
<a href="#l27.194"></a><span id="l27.194" class="difflineplus">+                        document.getElementById(&quot;appmenu_GoFolderPopup&quot;) ]) {</span>
<a href="#l27.195"></a><span id="l27.195">       if (!popup)</span>
<a href="#l27.196"></a><span id="l27.196">         continue;</span>
<a href="#l27.197"></a><span id="l27.197"> </span>
<a href="#l27.198"></a><span id="l27.198">       // .teardown() is only available here if the menu has its frame</span>
<a href="#l27.199"></a><span id="l27.199">       // otherwise the folderWidgets.xml::folder-menupopup binding is not</span>
<a href="#l27.200"></a><span id="l27.200">       // attached to the popup. So if it is not available, remove the items</span>
<a href="#l27.201"></a><span id="l27.201">       // explicitly. Only remove elements that were generated by the binding.</span>
<a href="#l27.202"></a><span id="l27.202">       if (&quot;_teardown&quot; in popup) {</span>
<a href="#l27.203"></a><span id="l27.203" class="difflineat">@@ -291,18 +283,17 @@ function MailToolboxCustomizeDone(aEvent</span>
<a href="#l27.204"></a><span id="l27.204">             child._teardown();</span>
<a href="#l27.205"></a><span id="l27.205">           child.remove();</span>
<a href="#l27.206"></a><span id="l27.206">         }</span>
<a href="#l27.207"></a><span id="l27.207">       }</span>
<a href="#l27.208"></a><span id="l27.208">     }</span>
<a href="#l27.209"></a><span id="l27.209">   }</span>
<a href="#l27.210"></a><span id="l27.210"> }</span>
<a href="#l27.211"></a><span id="l27.211"> </span>
<a href="#l27.212"></a><span id="l27.212" class="difflineminus">-function onViewToolbarsPopupShowing(aEvent, toolboxIds, aInsertPoint)</span>
<a href="#l27.213"></a><span id="l27.213" class="difflineminus">-{</span>
<a href="#l27.214"></a><span id="l27.214" class="difflineplus">+function onViewToolbarsPopupShowing(aEvent, toolboxIds, aInsertPoint) {</span>
<a href="#l27.215"></a><span id="l27.215">   if (!Array.isArray(toolboxIds))</span>
<a href="#l27.216"></a><span id="l27.216">     toolboxIds = [toolboxIds];</span>
<a href="#l27.217"></a><span id="l27.217"> </span>
<a href="#l27.218"></a><span id="l27.218">   let popup = aEvent.target;</span>
<a href="#l27.219"></a><span id="l27.219"> </span>
<a href="#l27.220"></a><span id="l27.220">   // Empty the menu</span>
<a href="#l27.221"></a><span id="l27.221">   for (let i = popup.childNodes.length - 1; i &gt;= 0; --i) {</span>
<a href="#l27.222"></a><span id="l27.222">     let deadItem = popup.childNodes[i];</span>
<a href="#l27.223"></a><span id="l27.223" class="difflineat">@@ -353,121 +344,109 @@ function onViewToolbarsPopupShowing(aEve</span>
<a href="#l27.224"></a><span id="l27.224">         menuItem.setAttribute(&quot;checked&quot;,</span>
<a href="#l27.225"></a><span id="l27.225">                               toolbar.getAttribute(hidingAttribute) != &quot;true&quot;);</span>
<a href="#l27.226"></a><span id="l27.226">         popup.insertBefore(menuItem, firstMenuItem);</span>
<a href="#l27.227"></a><span id="l27.227"> </span>
<a href="#l27.228"></a><span id="l27.228">         let onMenuItemCommand = function(aEvent) {</span>
<a href="#l27.229"></a><span id="l27.229">           let hidden = aEvent.originalTarget.getAttribute(&quot;checked&quot;) != &quot;true&quot;;</span>
<a href="#l27.230"></a><span id="l27.230">           toolbar.setAttribute(hidingAttribute, hidden);</span>
<a href="#l27.231"></a><span id="l27.231">           Services.xulStore.persist(toolbar, hidingAttribute);</span>
<a href="#l27.232"></a><span id="l27.232" class="difflineminus">-        }</span>
<a href="#l27.233"></a><span id="l27.233" class="difflineplus">+        };</span>
<a href="#l27.234"></a><span id="l27.234"> </span>
<a href="#l27.235"></a><span id="l27.235">         menuItem.addEventListener(&quot;command&quot;, onMenuItemCommand);</span>
<a href="#l27.236"></a><span id="l27.236">       }</span>
<a href="#l27.237"></a><span id="l27.237">     }</span>
<a href="#l27.238"></a><span id="l27.238">   }</span>
<a href="#l27.239"></a><span id="l27.239"> }</span>
<a href="#l27.240"></a><span id="l27.240"> </span>
<a href="#l27.241"></a><span id="l27.241" class="difflineminus">-function toJavaScriptConsole()</span>
<a href="#l27.242"></a><span id="l27.242" class="difflineminus">-{</span>
<a href="#l27.243"></a><span id="l27.243" class="difflineplus">+function toJavaScriptConsole() {</span>
<a href="#l27.244"></a><span id="l27.244">   HUDService.openBrowserConsoleOrFocus();</span>
<a href="#l27.245"></a><span id="l27.245"> }</span>
<a href="#l27.246"></a><span id="l27.246"> </span>
<a href="#l27.247"></a><span id="l27.247" class="difflineminus">-function openAboutDebugging(hash)</span>
<a href="#l27.248"></a><span id="l27.248" class="difflineminus">-{</span>
<a href="#l27.249"></a><span id="l27.249" class="difflineplus">+function openAboutDebugging(hash) {</span>
<a href="#l27.250"></a><span id="l27.250">   let url = &quot;about:debugging&quot; + (hash ? &quot;#&quot; + hash : &quot;&quot;);</span>
<a href="#l27.251"></a><span id="l27.251" class="difflineminus">-  document.getElementById('tabmail').openTab(&quot;contentTab&quot;, { contentPage: url });</span>
<a href="#l27.252"></a><span id="l27.252" class="difflineplus">+  document.getElementById(&quot;tabmail&quot;).openTab(&quot;contentTab&quot;, { contentPage: url });</span>
<a href="#l27.253"></a><span id="l27.253"> }</span>
<a href="#l27.254"></a><span id="l27.254"> </span>
<a href="#l27.255"></a><span id="l27.255" class="difflineminus">-function toOpenWindowByType(inType, uri)</span>
<a href="#l27.256"></a><span id="l27.256" class="difflineminus">-{</span>
<a href="#l27.257"></a><span id="l27.257" class="difflineplus">+function toOpenWindowByType(inType, uri) {</span>
<a href="#l27.258"></a><span id="l27.258">   var topWindow = Services.wm.getMostRecentWindow(inType);</span>
<a href="#l27.259"></a><span id="l27.259">   if (topWindow)</span>
<a href="#l27.260"></a><span id="l27.260">     topWindow.focus();</span>
<a href="#l27.261"></a><span id="l27.261">   else</span>
<a href="#l27.262"></a><span id="l27.262">     window.open(uri, &quot;_blank&quot;, &quot;chrome,extrachrome,menubar,resizable,scrollbars,status,toolbar&quot;);</span>
<a href="#l27.263"></a><span id="l27.263"> }</span>
<a href="#l27.264"></a><span id="l27.264"> </span>
<a href="#l27.265"></a><span id="l27.265" class="difflineminus">-function toMessengerWindow()</span>
<a href="#l27.266"></a><span id="l27.266" class="difflineminus">-{</span>
<a href="#l27.267"></a><span id="l27.267" class="difflineplus">+function toMessengerWindow() {</span>
<a href="#l27.268"></a><span id="l27.268">   toOpenWindowByType(&quot;mail:3pane&quot;, &quot;chrome://messenger/content/messenger.xul&quot;);</span>
<a href="#l27.269"></a><span id="l27.269"> }</span>
<a href="#l27.270"></a><span id="l27.270"> </span>
<a href="#l27.271"></a><span id="l27.271"> </span>
<a href="#l27.272"></a><span id="l27.272" class="difflineminus">-function focusOnMail(tabNo, event)</span>
<a href="#l27.273"></a><span id="l27.273" class="difflineminus">-{</span>
<a href="#l27.274"></a><span id="l27.274" class="difflineplus">+function focusOnMail(tabNo, event) {</span>
<a href="#l27.275"></a><span id="l27.275">   // this is invoked by accel-&lt;number&gt;</span>
<a href="#l27.276"></a><span id="l27.276">   // if the window isn't visible or focused, make it so</span>
<a href="#l27.277"></a><span id="l27.277">   var topWindow = Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l27.278"></a><span id="l27.278">   if (topWindow) {</span>
<a href="#l27.279"></a><span id="l27.279">     if (topWindow != window)</span>
<a href="#l27.280"></a><span id="l27.280">       topWindow.focus();</span>
<a href="#l27.281"></a><span id="l27.281">     else</span>
<a href="#l27.282"></a><span id="l27.282" class="difflineminus">-      document.getElementById('tabmail').selectTabByIndex(event, tabNo);</span>
<a href="#l27.283"></a><span id="l27.283" class="difflineminus">-  }</span>
<a href="#l27.284"></a><span id="l27.284" class="difflineminus">-  else {</span>
<a href="#l27.285"></a><span id="l27.285" class="difflineplus">+      document.getElementById(&quot;tabmail&quot;).selectTabByIndex(event, tabNo);</span>
<a href="#l27.286"></a><span id="l27.286" class="difflineplus">+  } else {</span>
<a href="#l27.287"></a><span id="l27.287">     window.open(&quot;chrome://messenger/content/messenger.xul&quot;,</span>
<a href="#l27.288"></a><span id="l27.288">                 &quot;_blank&quot;,</span>
<a href="#l27.289"></a><span id="l27.289">                 &quot;chrome,extrachrome,menubar,resizable,scrollbars,status,toolbar&quot;);</span>
<a href="#l27.290"></a><span id="l27.290">   }</span>
<a href="#l27.291"></a><span id="l27.291"> }</span>
<a href="#l27.292"></a><span id="l27.292"> </span>
<a href="#l27.293"></a><span id="l27.293" class="difflineminus">-function toAddressBook()</span>
<a href="#l27.294"></a><span id="l27.294" class="difflineminus">-{</span>
<a href="#l27.295"></a><span id="l27.295" class="difflineplus">+function toAddressBook() {</span>
<a href="#l27.296"></a><span id="l27.296">   toOpenWindowByType(&quot;mail:addressbook&quot;,</span>
<a href="#l27.297"></a><span id="l27.297">                      &quot;chrome://messenger/content/addressbook/addressbook.xul&quot;);</span>
<a href="#l27.298"></a><span id="l27.298"> }</span>
<a href="#l27.299"></a><span id="l27.299"> </span>
<a href="#l27.300"></a><span id="l27.300" class="difflineminus">-function showChatTab()</span>
<a href="#l27.301"></a><span id="l27.301" class="difflineminus">-{</span>
<a href="#l27.302"></a><span id="l27.302" class="difflineplus">+function showChatTab() {</span>
<a href="#l27.303"></a><span id="l27.303">   let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l27.304"></a><span id="l27.304">   if (gChatTab)</span>
<a href="#l27.305"></a><span id="l27.305">     tabmail.switchToTab(gChatTab);</span>
<a href="#l27.306"></a><span id="l27.306">   else</span>
<a href="#l27.307"></a><span id="l27.307">     tabmail.openTab(&quot;chat&quot;, {});</span>
<a href="#l27.308"></a><span id="l27.308"> }</span>
<a href="#l27.309"></a><span id="l27.309"> </span>
<a href="#l27.310"></a><span id="l27.310" class="difflineminus">-function toImport()</span>
<a href="#l27.311"></a><span id="l27.311" class="difflineminus">-{</span>
<a href="#l27.312"></a><span id="l27.312" class="difflineplus">+function toImport() {</span>
<a href="#l27.313"></a><span id="l27.313">   window.openDialog(&quot;chrome://messenger/content/importDialog.xul&quot;, &quot;importDialog&quot;,</span>
<a href="#l27.314"></a><span id="l27.314">                     &quot;chrome, modal, titlebar, centerscreen&quot;);</span>
<a href="#l27.315"></a><span id="l27.315"> }</span>
<a href="#l27.316"></a><span id="l27.316"> </span>
<a href="#l27.317"></a><span id="l27.317" class="difflineminus">-function toSanitize()</span>
<a href="#l27.318"></a><span id="l27.318" class="difflineminus">-{</span>
<a href="#l27.319"></a><span id="l27.319" class="difflineplus">+function toSanitize() {</span>
<a href="#l27.320"></a><span id="l27.320">    Cc[&quot;@mozilla.org/mail/mailglue;1&quot;]</span>
<a href="#l27.321"></a><span id="l27.321">      .getService(Ci.nsIMailGlue)</span>
<a href="#l27.322"></a><span id="l27.322">      .sanitize(window);</span>
<a href="#l27.323"></a><span id="l27.323"> }</span>
<a href="#l27.324"></a><span id="l27.324"> </span>
<a href="#l27.325"></a><span id="l27.325"> /**</span>
<a href="#l27.326"></a><span id="l27.326">  * Opens the Preferences (Options) dialog.</span>
<a href="#l27.327"></a><span id="l27.327">  *</span>
<a href="#l27.328"></a><span id="l27.328">  * @param aPaneID     ID of prefpane to select automatically.</span>
<a href="#l27.329"></a><span id="l27.329">  * @param aTabID      ID of tab to select on the prefpane.</span>
<a href="#l27.330"></a><span id="l27.330">  * @param aOtherArgs  other prefpane specific arguments</span>
<a href="#l27.331"></a><span id="l27.331">  */</span>
<a href="#l27.332"></a><span id="l27.332" class="difflineminus">-function openOptionsDialog(aPaneID, aTabID, aOtherArgs)</span>
<a href="#l27.333"></a><span id="l27.333" class="difflineminus">-{</span>
<a href="#l27.334"></a><span id="l27.334" class="difflineplus">+function openOptionsDialog(aPaneID, aTabID, aOtherArgs) {</span>
<a href="#l27.335"></a><span id="l27.335">   openPreferencesTab(aPaneID, aTabID, aOtherArgs);</span>
<a href="#l27.336"></a><span id="l27.336"> }</span>
<a href="#l27.337"></a><span id="l27.337"> </span>
<a href="#l27.338"></a><span id="l27.338" class="difflineminus">-function openAddonsMgr(aView)</span>
<a href="#l27.339"></a><span id="l27.339" class="difflineminus">-{</span>
<a href="#l27.340"></a><span id="l27.340" class="difflineplus">+function openAddonsMgr(aView) {</span>
<a href="#l27.341"></a><span id="l27.341">   if (aView) {</span>
<a href="#l27.342"></a><span id="l27.342">     let emWindow;</span>
<a href="#l27.343"></a><span id="l27.343">     let browserWindow;</span>
<a href="#l27.344"></a><span id="l27.344"> </span>
<a href="#l27.345"></a><span id="l27.345" class="difflineminus">-    let receivePong = function receivePong(aSubject, aTopic, aData) {</span>
<a href="#l27.346"></a><span id="l27.346" class="difflineplus">+    let receivePong = function(aSubject, aTopic, aData) {</span>
<a href="#l27.347"></a><span id="l27.347">       let browserWin = aSubject.docShell.rootTreeItem.domWindow;</span>
<a href="#l27.348"></a><span id="l27.348">       if (!emWindow || browserWin == window /* favor the current window */) {</span>
<a href="#l27.349"></a><span id="l27.349">         emWindow = aSubject;</span>
<a href="#l27.350"></a><span id="l27.350">         browserWindow = browserWin;</span>
<a href="#l27.351"></a><span id="l27.351">       }</span>
<a href="#l27.352"></a><span id="l27.352" class="difflineminus">-    }</span>
<a href="#l27.353"></a><span id="l27.353" class="difflineplus">+    };</span>
<a href="#l27.354"></a><span id="l27.354">     Services.obs.addObserver(receivePong, &quot;EM-pong&quot;);</span>
<a href="#l27.355"></a><span id="l27.355">     Services.obs.notifyObservers(null, &quot;EM-ping&quot;);</span>
<a href="#l27.356"></a><span id="l27.356">     Services.obs.removeObserver(receivePong, &quot;EM-pong&quot;);</span>
<a href="#l27.357"></a><span id="l27.357"> </span>
<a href="#l27.358"></a><span id="l27.358">     if (emWindow) {</span>
<a href="#l27.359"></a><span id="l27.359">       emWindow.loadView(aView);</span>
<a href="#l27.360"></a><span id="l27.360">       let tabmail = browserWindow.document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l27.361"></a><span id="l27.361">       tabmail.switchToTab(tabmail.getBrowserForDocument(emWindow));</span>
<a href="#l27.362"></a><span id="l27.362" class="difflineat">@@ -503,38 +482,35 @@ function openAddonPrefs(aURL, aOptionsTy</span>
<a href="#l27.363"></a><span id="l27.363">                                .getBoolPref(&quot;browser.preferences.instantApply&quot;);</span>
<a href="#l27.364"></a><span id="l27.364">     let features = &quot;chrome,titlebar,toolbar,centerscreen&quot; +</span>
<a href="#l27.365"></a><span id="l27.365">                    (instantApply ? &quot;,dialog=no&quot; : &quot;,modal&quot;);</span>
<a href="#l27.366"></a><span id="l27.366"> </span>
<a href="#l27.367"></a><span id="l27.367">     window.openDialog(aURL, &quot;addonPrefs&quot;, features);</span>
<a href="#l27.368"></a><span id="l27.368">   }</span>
<a href="#l27.369"></a><span id="l27.369"> }</span>
<a href="#l27.370"></a><span id="l27.370"> </span>
<a href="#l27.371"></a><span id="l27.371" class="difflineminus">-function openActivityMgr()</span>
<a href="#l27.372"></a><span id="l27.372" class="difflineminus">-{</span>
<a href="#l27.373"></a><span id="l27.373" class="difflineminus">-  Cc['@mozilla.org/activity-manager-ui;1'].</span>
<a href="#l27.374"></a><span id="l27.374" class="difflineplus">+function openActivityMgr() {</span>
<a href="#l27.375"></a><span id="l27.375" class="difflineplus">+  Cc[&quot;@mozilla.org/activity-manager-ui;1&quot;].</span>
<a href="#l27.376"></a><span id="l27.376">     getService(Ci.nsIActivityManagerUI).show(window);</span>
<a href="#l27.377"></a><span id="l27.377"> }</span>
<a href="#l27.378"></a><span id="l27.378"> </span>
<a href="#l27.379"></a><span id="l27.379" class="difflineminus">-function openIMAccountMgr()</span>
<a href="#l27.380"></a><span id="l27.380" class="difflineminus">-{</span>
<a href="#l27.381"></a><span id="l27.381" class="difflineplus">+function openIMAccountMgr() {</span>
<a href="#l27.382"></a><span id="l27.382">   var win = Services.wm.getMostRecentWindow(&quot;Messenger:Accounts&quot;);</span>
<a href="#l27.383"></a><span id="l27.383">   if (win)</span>
<a href="#l27.384"></a><span id="l27.384">     win.focus();</span>
<a href="#l27.385"></a><span id="l27.385">   else {</span>
<a href="#l27.386"></a><span id="l27.386">     win = Services.ww.openWindow(null,</span>
<a href="#l27.387"></a><span id="l27.387">                                  &quot;chrome://messenger/content/chat/imAccounts.xul&quot;,</span>
<a href="#l27.388"></a><span id="l27.388">                                  &quot;Accounts&quot;, &quot;chrome,resizable,centerscreen&quot;,</span>
<a href="#l27.389"></a><span id="l27.389">                                  null);</span>
<a href="#l27.390"></a><span id="l27.390">   }</span>
<a href="#l27.391"></a><span id="l27.391">   return win;</span>
<a href="#l27.392"></a><span id="l27.392"> }</span>
<a href="#l27.393"></a><span id="l27.393"> </span>
<a href="#l27.394"></a><span id="l27.394" class="difflineminus">-function openIMAccountWizard()</span>
<a href="#l27.395"></a><span id="l27.395" class="difflineminus">-{</span>
<a href="#l27.396"></a><span id="l27.396" class="difflineplus">+function openIMAccountWizard() {</span>
<a href="#l27.397"></a><span id="l27.397">   const kFeatures = &quot;chrome,centerscreen,modal,titlebar&quot;;</span>
<a href="#l27.398"></a><span id="l27.398">   const kUrl = &quot;chrome://messenger/content/chat/imAccountWizard.xul&quot;;</span>
<a href="#l27.399"></a><span id="l27.399">   const kName = &quot;IMAccountWizard&quot;;</span>
<a href="#l27.400"></a><span id="l27.400"> </span>
<a href="#l27.401"></a><span id="l27.401">   if (AppConstants.platform == &quot;macosx&quot;) {</span>
<a href="#l27.402"></a><span id="l27.402">     // On Mac, avoid using the hidden window as a parent as that would</span>
<a href="#l27.403"></a><span id="l27.403">     // make it visible.</span>
<a href="#l27.404"></a><span id="l27.404">     let hiddenWindowUrl =</span>
<a href="#l27.405"></a><span id="l27.405" class="difflineat">@@ -543,49 +519,46 @@ function openIMAccountWizard()</span>
<a href="#l27.406"></a><span id="l27.406">       Services.ww.openWindow(null, kUrl, kName, kFeatures, null);</span>
<a href="#l27.407"></a><span id="l27.407">       return;</span>
<a href="#l27.408"></a><span id="l27.408">     }</span>
<a href="#l27.409"></a><span id="l27.409">   }</span>
<a href="#l27.410"></a><span id="l27.410"> </span>
<a href="#l27.411"></a><span id="l27.411">   window.openDialog(kUrl, kName, kFeatures);</span>
<a href="#l27.412"></a><span id="l27.412"> }</span>
<a href="#l27.413"></a><span id="l27.413"> </span>
<a href="#l27.414"></a><span id="l27.414" class="difflineminus">-function openSavedFilesWnd()</span>
<a href="#l27.415"></a><span id="l27.415" class="difflineminus">-{</span>
<a href="#l27.416"></a><span id="l27.416" class="difflineplus">+function openSavedFilesWnd() {</span>
<a href="#l27.417"></a><span id="l27.417">   let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l27.418"></a><span id="l27.418">   let downloadsBrowser = tabmail.getBrowserForDocumentId(&quot;aboutDownloads&quot;);</span>
<a href="#l27.419"></a><span id="l27.419">   if (downloadsBrowser)</span>
<a href="#l27.420"></a><span id="l27.420">     tabmail.switchToTab(downloadsBrowser);</span>
<a href="#l27.421"></a><span id="l27.421">   else {</span>
<a href="#l27.422"></a><span id="l27.422">     tabmail.openTab(&quot;chromeTab&quot;,</span>
<a href="#l27.423"></a><span id="l27.423">                     { chromePage: &quot;about:downloads&quot;,</span>
<a href="#l27.424"></a><span id="l27.424">                       clickHandler: &quot;specialTabs.aboutClickHandler(event);&quot; });</span>
<a href="#l27.425"></a><span id="l27.425">   }</span>
<a href="#l27.426"></a><span id="l27.426"> }</span>
<a href="#l27.427"></a><span id="l27.427"> </span>
<a href="#l27.428"></a><span id="l27.428" class="difflineminus">-function SetBusyCursor(window, enable)</span>
<a href="#l27.429"></a><span id="l27.429" class="difflineminus">-{</span>
<a href="#l27.430"></a><span id="l27.430" class="difflineplus">+function SetBusyCursor(window, enable) {</span>
<a href="#l27.431"></a><span id="l27.431">     // setCursor() is only available for chrome windows.</span>
<a href="#l27.432"></a><span id="l27.432">     // However one of our frames is the start page which</span>
<a href="#l27.433"></a><span id="l27.433">     // is a non-chrome window, so check if this window has a</span>
<a href="#l27.434"></a><span id="l27.434">     // setCursor method</span>
<a href="#l27.435"></a><span id="l27.435">     if (&quot;setCursor&quot; in window) {</span>
<a href="#l27.436"></a><span id="l27.436">         if (enable)</span>
<a href="#l27.437"></a><span id="l27.437">             window.setCursor(&quot;progress&quot;);</span>
<a href="#l27.438"></a><span id="l27.438">         else</span>
<a href="#l27.439"></a><span id="l27.439">             window.setCursor(&quot;auto&quot;);</span>
<a href="#l27.440"></a><span id="l27.440">     }</span>
<a href="#l27.441"></a><span id="l27.441"> </span>
<a href="#l27.442"></a><span id="l27.442">   var numFrames = window.frames.length;</span>
<a href="#l27.443"></a><span id="l27.443" class="difflineminus">-  for(var i = 0; i &lt; numFrames; i++)</span>
<a href="#l27.444"></a><span id="l27.444" class="difflineplus">+  for (var i = 0; i &lt; numFrames; i++)</span>
<a href="#l27.445"></a><span id="l27.445">     SetBusyCursor(window.frames[i], enable);</span>
<a href="#l27.446"></a><span id="l27.446"> }</span>
<a href="#l27.447"></a><span id="l27.447"> </span>
<a href="#l27.448"></a><span id="l27.448" class="difflineminus">-function openAboutDialog()</span>
<a href="#l27.449"></a><span id="l27.449" class="difflineminus">-{</span>
<a href="#l27.450"></a><span id="l27.450" class="difflineplus">+function openAboutDialog() {</span>
<a href="#l27.451"></a><span id="l27.451">   let enumerator = Services.wm.getEnumerator(&quot;Mail:About&quot;);</span>
<a href="#l27.452"></a><span id="l27.452">   while (enumerator.hasMoreElements()) {</span>
<a href="#l27.453"></a><span id="l27.453">     // Only open one about window</span>
<a href="#l27.454"></a><span id="l27.454">     let win = enumerator.getNext();</span>
<a href="#l27.455"></a><span id="l27.455">     win.focus();</span>
<a href="#l27.456"></a><span id="l27.456">     return;</span>
<a href="#l27.457"></a><span id="l27.457">   }</span>
<a href="#l27.458"></a><span id="l27.458"> </span>
<a href="#l27.459"></a><span id="l27.459" class="difflineat">@@ -598,29 +571,27 @@ function openAboutDialog()</span>
<a href="#l27.460"></a><span id="l27.460">     features = &quot;chrome,centerscreen,dependent,dialog=no&quot;;</span>
<a href="#l27.461"></a><span id="l27.461"> </span>
<a href="#l27.462"></a><span id="l27.462">   window.openDialog(&quot;chrome://messenger/content/aboutDialog.xul&quot;, &quot;About&quot;, features);</span>
<a href="#l27.463"></a><span id="l27.463"> }</span>
<a href="#l27.464"></a><span id="l27.464"> </span>
<a href="#l27.465"></a><span id="l27.465"> /**</span>
<a href="#l27.466"></a><span id="l27.466">  * Opens the support page based on the app.support.baseURL pref.</span>
<a href="#l27.467"></a><span id="l27.467">  */</span>
<a href="#l27.468"></a><span id="l27.468" class="difflineminus">-function openSupportURL()</span>
<a href="#l27.469"></a><span id="l27.469" class="difflineminus">-{</span>
<a href="#l27.470"></a><span id="l27.470" class="difflineplus">+function openSupportURL() {</span>
<a href="#l27.471"></a><span id="l27.471">   openFormattedURL(&quot;app.support.baseURL&quot;);</span>
<a href="#l27.472"></a><span id="l27.472"> }</span>
<a href="#l27.473"></a><span id="l27.473"> </span>
<a href="#l27.474"></a><span id="l27.474"> /**</span>
<a href="#l27.475"></a><span id="l27.475">  *  Fetches the url for the passed in pref name, formats it and then loads it in the default</span>
<a href="#l27.476"></a><span id="l27.476">  *  browser.</span>
<a href="#l27.477"></a><span id="l27.477">  *</span>
<a href="#l27.478"></a><span id="l27.478">  *  @param aPrefName - name of the pref that holds the url we want to format and open</span>
<a href="#l27.479"></a><span id="l27.479">  */</span>
<a href="#l27.480"></a><span id="l27.480" class="difflineminus">-function openFormattedURL(aPrefName)</span>
<a href="#l27.481"></a><span id="l27.481" class="difflineminus">-{</span>
<a href="#l27.482"></a><span id="l27.482" class="difflineplus">+function openFormattedURL(aPrefName) {</span>
<a href="#l27.483"></a><span id="l27.483">   var urlToOpen = Services.urlFormatter.formatURLPref(aPrefName);</span>
<a href="#l27.484"></a><span id="l27.484"> </span>
<a href="#l27.485"></a><span id="l27.485">   var uri = Services.io.newURI(urlToOpen);</span>
<a href="#l27.486"></a><span id="l27.486"> </span>
<a href="#l27.487"></a><span id="l27.487">   var protocolSvc = Cc[&quot;@mozilla.org/uriloader/external-protocol-service;1&quot;]</span>
<a href="#l27.488"></a><span id="l27.488">                       .getService(Ci.nsIExternalProtocolService);</span>
<a href="#l27.489"></a><span id="l27.489">   protocolSvc.loadURI(uri);</span>
<a href="#l27.490"></a><span id="l27.490"> }</span>
<a href="#l27.491"></a><span id="l27.491" class="difflineat">@@ -632,18 +603,17 @@ function openAboutSupport() {</span>
<a href="#l27.492"></a><span id="l27.492">   let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l27.493"></a><span id="l27.493">   tabmail.openTab(&quot;contentTab&quot;, {contentPage: &quot;about:support&quot;,</span>
<a href="#l27.494"></a><span id="l27.494">                   clickHandler: &quot;specialTabs.aboutClickHandler(event);&quot; });</span>
<a href="#l27.495"></a><span id="l27.495"> }</span>
<a href="#l27.496"></a><span id="l27.496"> </span>
<a href="#l27.497"></a><span id="l27.497"> /**</span>
<a href="#l27.498"></a><span id="l27.498">  * Prompt the user to restart the browser in safe mode.</span>
<a href="#l27.499"></a><span id="l27.499">  */</span>
<a href="#l27.500"></a><span id="l27.500" class="difflineminus">-function safeModeRestart()</span>
<a href="#l27.501"></a><span id="l27.501" class="difflineminus">-{</span>
<a href="#l27.502"></a><span id="l27.502" class="difflineplus">+function safeModeRestart() {</span>
<a href="#l27.503"></a><span id="l27.503">   // prompt the user to confirm</span>
<a href="#l27.504"></a><span id="l27.504">   let bundle = Services.strings.createBundle(</span>
<a href="#l27.505"></a><span id="l27.505">     &quot;chrome://messenger/locale/messenger.properties&quot;);</span>
<a href="#l27.506"></a><span id="l27.506">   let promptTitle = bundle.GetStringFromName(&quot;safeModeRestartPromptTitle&quot;);</span>
<a href="#l27.507"></a><span id="l27.507">   let promptMessage = bundle.GetStringFromName(&quot;safeModeRestartPromptMessage&quot;);</span>
<a href="#l27.508"></a><span id="l27.508">   let restartText = bundle.GetStringFromName(&quot;safeModeRestartButton&quot;);</span>
<a href="#l27.509"></a><span id="l27.509">   let buttonFlags = (Services.prompt.BUTTON_POS_0 *</span>
<a href="#l27.510"></a><span id="l27.510">                      Services.prompt.BUTTON_TITLE_IS_STRING) +</span>
<a href="#l27.511"></a><span id="l27.511" class="difflineat">@@ -701,80 +671,74 @@ function getMostRecentMailWindow() {</span>
<a href="#l27.512"></a><span id="l27.512">  * people from hiding malicious extensions behind a run of spaces, etc. To do</span>
<a href="#l27.513"></a><span id="l27.513">  * this, we strip leading/trailing whitespace and collapse long runs of either</span>
<a href="#l27.514"></a><span id="l27.514">  * whitespace or identical characters. Windows especially will drop trailing</span>
<a href="#l27.515"></a><span id="l27.515">  * dots and whitespace from filename extensions.</span>
<a href="#l27.516"></a><span id="l27.516">  *</span>
<a href="#l27.517"></a><span id="l27.517">  * @param aAttachment the AttachmentInfo object</span>
<a href="#l27.518"></a><span id="l27.518">  * @return a sanitized display name for the attachment</span>
<a href="#l27.519"></a><span id="l27.519">  */</span>
<a href="#l27.520"></a><span id="l27.520" class="difflineminus">-function SanitizeAttachmentDisplayName(aAttachment)</span>
<a href="#l27.521"></a><span id="l27.521" class="difflineminus">-{</span>
<a href="#l27.522"></a><span id="l27.522" class="difflineplus">+function SanitizeAttachmentDisplayName(aAttachment) {</span>
<a href="#l27.523"></a><span id="l27.523">   let displayName = aAttachment.name.trim().replace(/\s+/g, &quot; &quot;);</span>
<a href="#l27.524"></a><span id="l27.524">   if (AppConstants.platform == &quot;win&quot;)</span>
<a href="#l27.525"></a><span id="l27.525">     displayName = displayName.replace(/[ \.]+$/, &quot;&quot;);</span>
<a href="#l27.526"></a><span id="l27.526">   return displayName.replace(/(.)\1{9,}/g, &quot;$1$1&quot;);</span>
<a href="#l27.527"></a><span id="l27.527"> }</span>
<a href="#l27.528"></a><span id="l27.528"> </span>
<a href="#l27.529"></a><span id="l27.529"> /**</span>
<a href="#l27.530"></a><span id="l27.530">  * Create a TransferData object for a message attachment, either from the</span>
<a href="#l27.531"></a><span id="l27.531">  * message reader or the composer.</span>
<a href="#l27.532"></a><span id="l27.532">  *</span>
<a href="#l27.533"></a><span id="l27.533">  * @param aAttachment the attachment object</span>
<a href="#l27.534"></a><span id="l27.534">  * @return the TransferData</span>
<a href="#l27.535"></a><span id="l27.535">  */</span>
<a href="#l27.536"></a><span id="l27.536" class="difflineminus">-function CreateAttachmentTransferData(aAttachment)</span>
<a href="#l27.537"></a><span id="l27.537" class="difflineminus">-{</span>
<a href="#l27.538"></a><span id="l27.538" class="difflineplus">+function CreateAttachmentTransferData(aAttachment) {</span>
<a href="#l27.539"></a><span id="l27.539">   // For now, disallow drag-and-drop on cloud attachments. In the future, we</span>
<a href="#l27.540"></a><span id="l27.540">   // should allow this.</span>
<a href="#l27.541"></a><span id="l27.541">   if (aAttachment.contentType == &quot;text/x-moz-deleted&quot; ||</span>
<a href="#l27.542"></a><span id="l27.542">       aAttachment.sendViaCloud)</span>
<a href="#l27.543"></a><span id="l27.543">     return null;</span>
<a href="#l27.544"></a><span id="l27.544"> </span>
<a href="#l27.545"></a><span id="l27.545">   var name = aAttachment.name || aAttachment.displayName;</span>
<a href="#l27.546"></a><span id="l27.546"> </span>
<a href="#l27.547"></a><span id="l27.547">   var data = new TransferData();</span>
<a href="#l27.548"></a><span id="l27.548" class="difflineminus">-  if (aAttachment.url &amp;&amp; name)</span>
<a href="#l27.549"></a><span id="l27.549" class="difflineminus">-  {</span>
<a href="#l27.550"></a><span id="l27.550" class="difflineplus">+  if (aAttachment.url &amp;&amp; name) {</span>
<a href="#l27.551"></a><span id="l27.551">     // Only add type/filename info for non-file URLs that don't already</span>
<a href="#l27.552"></a><span id="l27.552">     // have it.</span>
<a href="#l27.553"></a><span id="l27.553" class="difflineplus">+    var info;</span>
<a href="#l27.554"></a><span id="l27.554">     if (/(^file:|&amp;filename=)/.test(aAttachment.url))</span>
<a href="#l27.555"></a><span id="l27.555" class="difflineminus">-      var info = aAttachment.url;</span>
<a href="#l27.556"></a><span id="l27.556" class="difflineplus">+      info = aAttachment.url;</span>
<a href="#l27.557"></a><span id="l27.557">     else</span>
<a href="#l27.558"></a><span id="l27.558" class="difflineminus">-      var info = aAttachment.url + &quot;&amp;type=&quot; + aAttachment.contentType +</span>
<a href="#l27.559"></a><span id="l27.559" class="difflineminus">-                 &quot;&amp;filename=&quot; + encodeURIComponent(name);</span>
<a href="#l27.560"></a><span id="l27.560" class="difflineplus">+      info = aAttachment.url + &quot;&amp;type=&quot; + aAttachment.contentType +</span>
<a href="#l27.561"></a><span id="l27.561" class="difflineplus">+                               &quot;&amp;filename=&quot; + encodeURIComponent(name);</span>
<a href="#l27.562"></a><span id="l27.562"> </span>
<a href="#l27.563"></a><span id="l27.563">     data.addDataForFlavour(&quot;text/x-moz-url&quot;,</span>
<a href="#l27.564"></a><span id="l27.564">                            info + &quot;\n&quot; + name + &quot;\n&quot; + aAttachment.size);</span>
<a href="#l27.565"></a><span id="l27.565">     data.addDataForFlavour(&quot;text/x-moz-url-data&quot;, aAttachment.url);</span>
<a href="#l27.566"></a><span id="l27.566">     data.addDataForFlavour(&quot;text/x-moz-url-desc&quot;, name);</span>
<a href="#l27.567"></a><span id="l27.567">     data.addDataForFlavour(&quot;application/x-moz-file-promise-url&quot;,</span>
<a href="#l27.568"></a><span id="l27.568">                            aAttachment.url);</span>
<a href="#l27.569"></a><span id="l27.569">     data.addDataForFlavour(&quot;application/x-moz-file-promise&quot;,</span>
<a href="#l27.570"></a><span id="l27.570">                            new nsFlavorDataProvider(), 0,</span>
<a href="#l27.571"></a><span id="l27.571">                            Ci.nsISupports);</span>
<a href="#l27.572"></a><span id="l27.572">   }</span>
<a href="#l27.573"></a><span id="l27.573">   return data;</span>
<a href="#l27.574"></a><span id="l27.574"> }</span>
<a href="#l27.575"></a><span id="l27.575"> </span>
<a href="#l27.576"></a><span id="l27.576" class="difflineminus">-function nsFlavorDataProvider()</span>
<a href="#l27.577"></a><span id="l27.577" class="difflineminus">-{</span>
<a href="#l27.578"></a><span id="l27.578" class="difflineplus">+function nsFlavorDataProvider() {</span>
<a href="#l27.579"></a><span id="l27.579"> }</span>
<a href="#l27.580"></a><span id="l27.580"> </span>
<a href="#l27.581"></a><span id="l27.581" class="difflineminus">-nsFlavorDataProvider.prototype =</span>
<a href="#l27.582"></a><span id="l27.582" class="difflineminus">-{</span>
<a href="#l27.583"></a><span id="l27.583" class="difflineplus">+nsFlavorDataProvider.prototype = {</span>
<a href="#l27.584"></a><span id="l27.584">   QueryInterface: ChromeUtils.generateQI([&quot;nsIFlavorDataProvider&quot;]),</span>
<a href="#l27.585"></a><span id="l27.585"> </span>
<a href="#l27.586"></a><span id="l27.586" class="difflineminus">-  getFlavorData : function(aTransferable, aFlavor, aData, aDataLen)</span>
<a href="#l27.587"></a><span id="l27.587" class="difflineminus">-  {</span>
<a href="#l27.588"></a><span id="l27.588" class="difflineplus">+  getFlavorData(aTransferable, aFlavor, aData, aDataLen) {</span>
<a href="#l27.589"></a><span id="l27.589">     // get the url for the attachment</span>
<a href="#l27.590"></a><span id="l27.590" class="difflineminus">-    if (aFlavor == &quot;application/x-moz-file-promise&quot;)</span>
<a href="#l27.591"></a><span id="l27.591" class="difflineminus">-    {</span>
<a href="#l27.592"></a><span id="l27.592" class="difflineminus">-      var urlPrimitive = { };</span>
<a href="#l27.593"></a><span id="l27.593" class="difflineminus">-      var dataSize = { };</span>
<a href="#l27.594"></a><span id="l27.594" class="difflineplus">+    if (aFlavor == &quot;application/x-moz-file-promise&quot;) {</span>
<a href="#l27.595"></a><span id="l27.595" class="difflineplus">+      var urlPrimitive = {};</span>
<a href="#l27.596"></a><span id="l27.596" class="difflineplus">+      var dataSize = {};</span>
<a href="#l27.597"></a><span id="l27.597">       aTransferable.getTransferData(&quot;application/x-moz-file-promise-url&quot;,</span>
<a href="#l27.598"></a><span id="l27.598">                                     urlPrimitive, dataSize);</span>
<a href="#l27.599"></a><span id="l27.599"> </span>
<a href="#l27.600"></a><span id="l27.600">       var srcUrlPrimitive = urlPrimitive.value.QueryInterface(Ci.nsISupportsString);</span>
<a href="#l27.601"></a><span id="l27.601"> </span>
<a href="#l27.602"></a><span id="l27.602">       // now get the destination file location from kFilePromiseDirectoryMime</span>
<a href="#l27.603"></a><span id="l27.603">       var dirPrimitive = {};</span>
<a href="#l27.604"></a><span id="l27.604">       aTransferable.getTransferData(&quot;application/x-moz-file-promise-dir&quot;,</span>
<a href="#l27.605"></a><span id="l27.605" class="difflineat">@@ -782,36 +746,33 @@ nsFlavorDataProvider.prototype =</span>
<a href="#l27.606"></a><span id="l27.606">       var destDirectory = dirPrimitive.value.QueryInterface(Ci.nsIFile);</span>
<a href="#l27.607"></a><span id="l27.607"> </span>
<a href="#l27.608"></a><span id="l27.608">       // now save the attachment to the specified location</span>
<a href="#l27.609"></a><span id="l27.609">       // XXX: we need more information than just the attachment url to save it,</span>
<a href="#l27.610"></a><span id="l27.610">       // fortunately, we have an array of all the current attachments so we can</span>
<a href="#l27.611"></a><span id="l27.611">       // cheat and scan through them</span>
<a href="#l27.612"></a><span id="l27.612"> </span>
<a href="#l27.613"></a><span id="l27.613">       var attachment = null;</span>
<a href="#l27.614"></a><span id="l27.614" class="difflineminus">-      for (let index of currentAttachments.keys())</span>
<a href="#l27.615"></a><span id="l27.615" class="difflineminus">-      {</span>
<a href="#l27.616"></a><span id="l27.616" class="difflineplus">+      for (let index of currentAttachments.keys()) {</span>
<a href="#l27.617"></a><span id="l27.617">         attachment = currentAttachments[index];</span>
<a href="#l27.618"></a><span id="l27.618">         if (attachment.url == srcUrlPrimitive)</span>
<a href="#l27.619"></a><span id="l27.619">           break;</span>
<a href="#l27.620"></a><span id="l27.620">       }</span>
<a href="#l27.621"></a><span id="l27.621"> </span>
<a href="#l27.622"></a><span id="l27.622">       // call our code for saving attachments</span>
<a href="#l27.623"></a><span id="l27.623" class="difflineminus">-      if (attachment)</span>
<a href="#l27.624"></a><span id="l27.624" class="difflineminus">-      {</span>
<a href="#l27.625"></a><span id="l27.625" class="difflineplus">+      if (attachment) {</span>
<a href="#l27.626"></a><span id="l27.626">         var name = attachment.name || attachment.displayName;</span>
<a href="#l27.627"></a><span id="l27.627">         var destFilePath = messenger.saveAttachmentToFolder(attachment.contentType,</span>
<a href="#l27.628"></a><span id="l27.628">                                                             attachment.url,</span>
<a href="#l27.629"></a><span id="l27.629">                                                             encodeURIComponent(name),</span>
<a href="#l27.630"></a><span id="l27.630">                                                             attachment.uri,</span>
<a href="#l27.631"></a><span id="l27.631">                                                             destDirectory);</span>
<a href="#l27.632"></a><span id="l27.632">         aData.value = destFilePath.QueryInterface(Ci.nsISupports);</span>
<a href="#l27.633"></a><span id="l27.633">         aDataLen.value = 4;</span>
<a href="#l27.634"></a><span id="l27.634">       }</span>
<a href="#l27.635"></a><span id="l27.635">     }</span>
<a href="#l27.636"></a><span id="l27.636" class="difflineminus">-  }</span>
<a href="#l27.637"></a><span id="l27.637" class="difflineminus">-}</span>
<a href="#l27.638"></a><span id="l27.638" class="difflineplus">+  },</span>
<a href="#l27.639"></a><span id="l27.639" class="difflineplus">+};</span>
<a href="#l27.640"></a><span id="l27.640"> </span>
<a href="#l27.641"></a><span id="l27.641" class="difflineminus">-function UpdateCharsetMenu(aCharset, aNode)</span>
<a href="#l27.642"></a><span id="l27.642" class="difflineminus">-{</span>
<a href="#l27.643"></a><span id="l27.643" class="difflineplus">+function UpdateCharsetMenu(aCharset, aNode) {</span>
<a href="#l27.644"></a><span id="l27.644">   var bundle = document.getElementById(&quot;charsetBundle&quot;);</span>
<a href="#l27.645"></a><span id="l27.645">   CharsetMenu.update(aNode, bundle.getString(aCharset.toLowerCase()));</span>
<a href="#l27.646"></a><span id="l27.646"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mail/base/content/mailTabs.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mail/base/content/mailTabs.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -46,34 +46,33 @@ var mailTabType = {</span>
<a href="#l28.4"></a><span id="l28.4">      *  - A single folder.</span>
<a href="#l28.5"></a><span id="l28.5">      *    - A quicksearch on a single folder.</span>
<a href="#l28.6"></a><span id="l28.6">      *  - A virtual folder potentially containing messages from multiple</span>
<a href="#l28.7"></a><span id="l28.7">      *    folders. (eShowVirtualFolderResults)</span>
<a href="#l28.8"></a><span id="l28.8">      */</span>
<a href="#l28.9"></a><span id="l28.9">     folder: {</span>
<a href="#l28.10"></a><span id="l28.10">       isDefault: true,</span>
<a href="#l28.11"></a><span id="l28.11">       type: &quot;folder&quot;,</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-      /// The set of panes that are legal to be displayed in this mode</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+      // The set of panes that are legal to be displayed in this mode</span>
<a href="#l28.14"></a><span id="l28.14">       legalPanes: {</span>
<a href="#l28.15"></a><span id="l28.15">         folder: true,</span>
<a href="#l28.16"></a><span id="l28.16">         thread: true,</span>
<a href="#l28.17"></a><span id="l28.17" class="difflineminus">-        message: true</span>
<a href="#l28.18"></a><span id="l28.18" class="difflineplus">+        message: true,</span>
<a href="#l28.19"></a><span id="l28.19">       },</span>
<a href="#l28.20"></a><span id="l28.20" class="difflineminus">-      /// The set of panes that are legal when we are showing account central</span>
<a href="#l28.21"></a><span id="l28.21" class="difflineplus">+      // The set of panes that are legal when we are showing account central</span>
<a href="#l28.22"></a><span id="l28.22">       accountCentralLegalPanes: {</span>
<a href="#l28.23"></a><span id="l28.23">         folder: true,</span>
<a href="#l28.24"></a><span id="l28.24">         accountCentral: true,</span>
<a href="#l28.25"></a><span id="l28.25" class="difflineminus">-        message: false</span>
<a href="#l28.26"></a><span id="l28.26" class="difflineplus">+        message: false,</span>
<a href="#l28.27"></a><span id="l28.27">       },</span>
<a href="#l28.28"></a><span id="l28.28" class="difflineminus">-      openFirstTab: function(aTab) {</span>
<a href="#l28.29"></a><span id="l28.29" class="difflineplus">+      openFirstTab(aTab) {</span>
<a href="#l28.30"></a><span id="l28.30">         this.openTab(aTab, true, new MessagePaneDisplayWidget(), true);</span>
<a href="#l28.31"></a><span id="l28.31">         // persistence and restoreTab wants to know if we are the magic first tab</span>
<a href="#l28.32"></a><span id="l28.32">         aTab.firstTab = true;</span>
<a href="#l28.33"></a><span id="l28.33">         // Inherit the search mode from a window</span>
<a href="#l28.34"></a><span id="l28.34" class="difflineminus">-        let windowToInheritFrom = null;</span>
<a href="#l28.35"></a><span id="l28.35">         if (window.opener &amp;&amp;</span>
<a href="#l28.36"></a><span id="l28.36">             (window.opener.document.documentElement.getAttribute(&quot;windowtype&quot;) ==</span>
<a href="#l28.37"></a><span id="l28.37">              &quot;mail:3pane&quot;))</span>
<a href="#l28.38"></a><span id="l28.38">           windowToInheritFrom = window.opener;</span>
<a href="#l28.39"></a><span id="l28.39">         else</span>
<a href="#l28.40"></a><span id="l28.40">           windowToInheritFrom = FindOther3PaneWindow();</span>
<a href="#l28.41"></a><span id="l28.41"> </span>
<a href="#l28.42"></a><span id="l28.42">         aTab.folderDisplay.makeActive();</span>
<a href="#l28.43"></a><span id="l28.43" class="difflineat">@@ -86,17 +85,17 @@ var mailTabType = {</span>
<a href="#l28.44"></a><span id="l28.44">        *            current state is used.</span>
<a href="#l28.45"></a><span id="l28.45">        * @param [aArgs.messagePaneVisible] Whether the message pane should be</span>
<a href="#l28.46"></a><span id="l28.46">        *            visible. If this isn't specified, the current or first tab's</span>
<a href="#l28.47"></a><span id="l28.47">        *            current state is used.</span>
<a href="#l28.48"></a><span id="l28.48">        * @param [aArgs.forceSelectMessage] Whether we should consider dropping</span>
<a href="#l28.49"></a><span id="l28.49">        *            filters to select the message. This has no effect if</span>
<a href="#l28.50"></a><span id="l28.50">        *            aArgs.msgHdr isn't specified. Defaults to false.</span>
<a href="#l28.51"></a><span id="l28.51">        */</span>
<a href="#l28.52"></a><span id="l28.52" class="difflineminus">-      openTab: function(aTab, aArgs) {</span>
<a href="#l28.53"></a><span id="l28.53" class="difflineplus">+      openTab(aTab, aArgs) {</span>
<a href="#l28.54"></a><span id="l28.54">         // persistence and restoreTab wants to know if we are the magic first tab</span>
<a href="#l28.55"></a><span id="l28.55">         aTab.firstTab = false;</span>
<a href="#l28.56"></a><span id="l28.56"> </span>
<a href="#l28.57"></a><span id="l28.57">         // Get a tab that we can initialize our user preferences from.</span>
<a href="#l28.58"></a><span id="l28.58">         // (We don't want to assume that our immediate predecessor was a</span>
<a href="#l28.59"></a><span id="l28.59">         //  &quot;folder&quot; tab.)</span>
<a href="#l28.60"></a><span id="l28.60">         let modelTab = document.getElementById(&quot;tabmail&quot;)</span>
<a href="#l28.61"></a><span id="l28.61">                          .getTabInfoForCurrentOrFirstModeInstance(aTab.mode);</span>
<a href="#l28.62"></a><span id="l28.62" class="difflineat">@@ -158,37 +157,37 @@ var mailTabType = {</span>
<a href="#l28.63"></a><span id="l28.63">           // the actual displaying is handled by the show() call above. This</span>
<a href="#l28.64"></a><span id="l28.64">           // also means that we don't have to bother about making</span>
<a href="#l28.65"></a><span id="l28.65">           // gFolderTreeView believe that a selection change has happened.</span>
<a href="#l28.66"></a><span id="l28.66">           gFolderTreeView.selectFolder(aArgs.folder);</span>
<a href="#l28.67"></a><span id="l28.67">         }</span>
<a href="#l28.68"></a><span id="l28.68"> </span>
<a href="#l28.69"></a><span id="l28.69">         aTab.mode.onTitleChanged.call(this, aTab, aTab.tabNode);</span>
<a href="#l28.70"></a><span id="l28.70">       },</span>
<a href="#l28.71"></a><span id="l28.71" class="difflineminus">-      persistTab: function(aTab) {</span>
<a href="#l28.72"></a><span id="l28.72" class="difflineplus">+      persistTab(aTab) {</span>
<a href="#l28.73"></a><span id="l28.73">         try {</span>
<a href="#l28.74"></a><span id="l28.74">           if (!aTab.folderDisplay.displayedFolder)</span>
<a href="#l28.75"></a><span id="l28.75">             return null;</span>
<a href="#l28.76"></a><span id="l28.76">           let retval = {</span>
<a href="#l28.77"></a><span id="l28.77">             folderURI: aTab.folderDisplay.displayedFolder.URI,</span>
<a href="#l28.78"></a><span id="l28.78">             // if the folder pane is active, then we need to look at</span>
<a href="#l28.79"></a><span id="l28.79">             // whether the box is collapsed</span>
<a href="#l28.80"></a><span id="l28.80">             folderPaneVisible: aTab.folderDisplay.folderPaneVisible,</span>
<a href="#l28.81"></a><span id="l28.81">             messagePaneVisible: aTab.messageDisplay.visible,</span>
<a href="#l28.82"></a><span id="l28.82" class="difflineminus">-            firstTab: aTab.firstTab</span>
<a href="#l28.83"></a><span id="l28.83" class="difflineplus">+            firstTab: aTab.firstTab,</span>
<a href="#l28.84"></a><span id="l28.84">           };</span>
<a href="#l28.85"></a><span id="l28.85">           return retval;</span>
<a href="#l28.86"></a><span id="l28.86">         } catch (e) {</span>
<a href="#l28.87"></a><span id="l28.87">           logException(e);</span>
<a href="#l28.88"></a><span id="l28.88">           return null;</span>
<a href="#l28.89"></a><span id="l28.89">         }</span>
<a href="#l28.90"></a><span id="l28.90">       },</span>
<a href="#l28.91"></a><span id="l28.91" class="difflineminus">-      restoreTab: function(aTabmail, aPersistedState) {</span>
<a href="#l28.92"></a><span id="l28.92" class="difflineplus">+      restoreTab(aTabmail, aPersistedState) {</span>
<a href="#l28.93"></a><span id="l28.93">       try {</span>
<a href="#l28.94"></a><span id="l28.94" class="difflineminus">-        let rdfService = Cc['@mozilla.org/rdf/rdf-service;1']</span>
<a href="#l28.95"></a><span id="l28.95" class="difflineplus">+        let rdfService = Cc[&quot;@mozilla.org/rdf/rdf-service;1&quot;]</span>
<a href="#l28.96"></a><span id="l28.96">                            .getService(Ci.nsIRDFService);</span>
<a href="#l28.97"></a><span id="l28.97">         let folder = rdfService.GetResource(aPersistedState.folderURI)</span>
<a href="#l28.98"></a><span id="l28.98">                        .QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l28.99"></a><span id="l28.99">         // if the folder no longer exists, we can't restore the tab</span>
<a href="#l28.100"></a><span id="l28.100">         if (folder) {</span>
<a href="#l28.101"></a><span id="l28.101">           let folderPaneVisible = (&quot;folderPaneVisible&quot; in aPersistedState) ?</span>
<a href="#l28.102"></a><span id="l28.102">                                     aPersistedState.folderPaneVisible :</span>
<a href="#l28.103"></a><span id="l28.103">                                     true;</span>
<a href="#l28.104"></a><span id="l28.104" class="difflineat">@@ -228,52 +227,51 @@ var mailTabType = {</span>
<a href="#l28.105"></a><span id="l28.105">             for (let tabMonitor of tabmail.tabMonitors) {</span>
<a href="#l28.106"></a><span id="l28.106">               if ((&quot;onTabRestored&quot; in tabMonitor) &amp;&amp;</span>
<a href="#l28.107"></a><span id="l28.107">                   (tabMonitor.monitorName in restoreState.ext)) {</span>
<a href="#l28.108"></a><span id="l28.108">                 tabMonitor.onTabRestored(tab,</span>
<a href="#l28.109"></a><span id="l28.109">                                          restoreState.ext[tabMonitor.monitorName],</span>
<a href="#l28.110"></a><span id="l28.110">                                          true);</span>
<a href="#l28.111"></a><span id="l28.111">               }</span>
<a href="#l28.112"></a><span id="l28.112">             }</span>
<a href="#l28.113"></a><span id="l28.113" class="difflineminus">-          }</span>
<a href="#l28.114"></a><span id="l28.114" class="difflineminus">-          else {</span>
<a href="#l28.115"></a><span id="l28.115" class="difflineplus">+          } else {</span>
<a href="#l28.116"></a><span id="l28.116">             let tabArgs = {</span>
<a href="#l28.117"></a><span id="l28.117" class="difflineminus">-              folder: folder,</span>
<a href="#l28.118"></a><span id="l28.118" class="difflineminus">-              folderPaneVisible: folderPaneVisible,</span>
<a href="#l28.119"></a><span id="l28.119" class="difflineplus">+              folder,</span>
<a href="#l28.120"></a><span id="l28.120" class="difflineplus">+              folderPaneVisible,</span>
<a href="#l28.121"></a><span id="l28.121">               messagePaneVisible: aPersistedState.messagePaneVisible,</span>
<a href="#l28.122"></a><span id="l28.122" class="difflineminus">-              background: true</span>
<a href="#l28.123"></a><span id="l28.123" class="difflineplus">+              background: true,</span>
<a href="#l28.124"></a><span id="l28.124">             };</span>
<a href="#l28.125"></a><span id="l28.125">             aTabmail.openTab(&quot;folder&quot;, tabArgs);</span>
<a href="#l28.126"></a><span id="l28.126">           }</span>
<a href="#l28.127"></a><span id="l28.127">         }</span>
<a href="#l28.128"></a><span id="l28.128">       } catch (e) {</span>
<a href="#l28.129"></a><span id="l28.129">         logException(e);</span>
<a href="#l28.130"></a><span id="l28.130">       }</span>
<a href="#l28.131"></a><span id="l28.131">       },</span>
<a href="#l28.132"></a><span id="l28.132" class="difflineminus">-      onTitleChanged: function(aTab, aTabNode) {</span>
<a href="#l28.133"></a><span id="l28.133" class="difflineplus">+      onTitleChanged(aTab, aTabNode) {</span>
<a href="#l28.134"></a><span id="l28.134">         if (!aTab.folderDisplay || !aTab.folderDisplay.displayedFolder) {</span>
<a href="#l28.135"></a><span id="l28.135">           // Don't show &quot;undefined&quot; as title when there is no account.</span>
<a href="#l28.136"></a><span id="l28.136">           aTab.title = &quot; &quot;;</span>
<a href="#l28.137"></a><span id="l28.137">           return;</span>
<a href="#l28.138"></a><span id="l28.138">         }</span>
<a href="#l28.139"></a><span id="l28.139">         // The user may have changed folders, triggering our onTitleChanged</span>
<a href="#l28.140"></a><span id="l28.140">         // callback.</span>
<a href="#l28.141"></a><span id="l28.141">         let folder = aTab.folderDisplay.displayedFolder;</span>
<a href="#l28.142"></a><span id="l28.142">         aTab.title = folder.prettyName;</span>
<a href="#l28.143"></a><span id="l28.143">         if (!folder.isServer &amp;&amp; this._getNumberOfRealAccounts() &gt; 1)</span>
<a href="#l28.144"></a><span id="l28.144">           aTab.title += &quot; - &quot; + folder.server.prettyName;</span>
<a href="#l28.145"></a><span id="l28.145"> </span>
<a href="#l28.146"></a><span id="l28.146">         // Update the appropriate attributes on the tab.</span>
<a href="#l28.147"></a><span id="l28.147">         let specialFolderStr = getSpecialFolderString(folder);</span>
<a href="#l28.148"></a><span id="l28.148" class="difflineminus">-        aTabNode.setAttribute('SpecialFolder', specialFolderStr);</span>
<a href="#l28.149"></a><span id="l28.149" class="difflineminus">-        aTabNode.setAttribute('ServerType', folder.server.type);</span>
<a href="#l28.150"></a><span id="l28.150" class="difflineminus">-        aTabNode.setAttribute('IsServer', folder.isServer);</span>
<a href="#l28.151"></a><span id="l28.151" class="difflineminus">-        aTabNode.setAttribute('IsSecure', folder.server.isSecure);</span>
<a href="#l28.152"></a><span id="l28.152" class="difflineplus">+        aTabNode.setAttribute(&quot;SpecialFolder&quot;, specialFolderStr);</span>
<a href="#l28.153"></a><span id="l28.153" class="difflineplus">+        aTabNode.setAttribute(&quot;ServerType&quot;, folder.server.type);</span>
<a href="#l28.154"></a><span id="l28.154" class="difflineplus">+        aTabNode.setAttribute(&quot;IsServer&quot;, folder.isServer);</span>
<a href="#l28.155"></a><span id="l28.155" class="difflineplus">+        aTabNode.setAttribute(&quot;IsSecure&quot;, folder.server.isSecure);</span>
<a href="#l28.156"></a><span id="l28.156">         let feedUrls = FeedUtils.getFeedUrlsInFolder(folder);</span>
<a href="#l28.157"></a><span id="l28.157" class="difflineminus">-        aTabNode.setAttribute(&quot;IsFeedFolder&quot;, feedUrls ? true : false);</span>
<a href="#l28.158"></a><span id="l28.158" class="difflineplus">+        aTabNode.setAttribute(&quot;IsFeedFolder&quot;, !!feedUrls);</span>
<a href="#l28.159"></a><span id="l28.159"> </span>
<a href="#l28.160"></a><span id="l28.160">         // Set the favicon for feed folders.</span>
<a href="#l28.161"></a><span id="l28.161">         aTabNode.removeAttribute(&quot;image&quot;);</span>
<a href="#l28.162"></a><span id="l28.162">         if (folder.server.type != &quot;rss&quot; || folder.isServer || !feedUrls ||</span>
<a href="#l28.163"></a><span id="l28.163">             specialFolderStr != &quot;none&quot;)</span>
<a href="#l28.164"></a><span id="l28.164">           return;</span>
<a href="#l28.165"></a><span id="l28.165"> </span>
<a href="#l28.166"></a><span id="l28.166">         let favicon = gFolderTreeView.getFolderCacheProperty(folder, &quot;favicon&quot;);</span>
<a href="#l28.167"></a><span id="l28.167" class="difflineat">@@ -295,54 +293,53 @@ var mailTabType = {</span>
<a href="#l28.168"></a><span id="l28.168">             gFolderTreeView.setFolderCacheProperty(folder, &quot;favicon&quot;, iconUrl);</span>
<a href="#l28.169"></a><span id="l28.169">             let row = gFolderTreeView.getIndexOfFolder(folder);</span>
<a href="#l28.170"></a><span id="l28.170">             gFolderTreeView._tree.invalidateRow(row);</span>
<a href="#l28.171"></a><span id="l28.171">            });</span>
<a href="#l28.172"></a><span id="l28.172"> </span>
<a href="#l28.173"></a><span id="l28.173">           FeedUtils.getFavicon(folder, null, favicon, window, callback);</span>
<a href="#l28.174"></a><span id="l28.174">         }</span>
<a href="#l28.175"></a><span id="l28.175">       },</span>
<a href="#l28.176"></a><span id="l28.176" class="difflineminus">-      getBrowser: function(aTab) {</span>
<a href="#l28.177"></a><span id="l28.177" class="difflineplus">+      getBrowser(aTab) {</span>
<a href="#l28.178"></a><span id="l28.178">         // If we are currently a thread summary, we want to select the multi</span>
<a href="#l28.179"></a><span id="l28.179">         // message browser rather than the message pane.</span>
<a href="#l28.180"></a><span id="l28.180">         return gMessageDisplay.singleMessageDisplay ?</span>
<a href="#l28.181"></a><span id="l28.181">                document.getElementById(&quot;messagepane&quot;) :</span>
<a href="#l28.182"></a><span id="l28.182">                document.getElementById(&quot;multimessage&quot;);</span>
<a href="#l28.183"></a><span id="l28.183" class="difflineminus">-      }</span>
<a href="#l28.184"></a><span id="l28.184" class="difflineplus">+      },</span>
<a href="#l28.185"></a><span id="l28.185">     },</span>
<a href="#l28.186"></a><span id="l28.186">     /**</span>
<a href="#l28.187"></a><span id="l28.187">      * The message view displays a single message.  In this view, the folder</span>
<a href="#l28.188"></a><span id="l28.188">      *  pane and thread pane are forced hidden and only the message pane is</span>
<a href="#l28.189"></a><span id="l28.189">      *  displayed.</span>
<a href="#l28.190"></a><span id="l28.190">      */</span>
<a href="#l28.191"></a><span id="l28.191">     message: {</span>
<a href="#l28.192"></a><span id="l28.192">       type: &quot;message&quot;,</span>
<a href="#l28.193"></a><span id="l28.193" class="difflineminus">-      /// The set of panes that are legal to be displayed in this mode</span>
<a href="#l28.194"></a><span id="l28.194" class="difflineplus">+      // The set of panes that are legal to be displayed in this mode</span>
<a href="#l28.195"></a><span id="l28.195">       legalPanes: {</span>
<a href="#l28.196"></a><span id="l28.196">         folder: false,</span>
<a href="#l28.197"></a><span id="l28.197">         thread: false,</span>
<a href="#l28.198"></a><span id="l28.198" class="difflineminus">-        message: true</span>
<a href="#l28.199"></a><span id="l28.199" class="difflineplus">+        message: true,</span>
<a href="#l28.200"></a><span id="l28.200">       },</span>
<a href="#l28.201"></a><span id="l28.201" class="difflineminus">-      openTab: function(aTab, aArgs) {</span>
<a href="#l28.202"></a><span id="l28.202" class="difflineplus">+      openTab(aTab, aArgs) {</span>
<a href="#l28.203"></a><span id="l28.203">         this.openTab(aTab, false, new MessageTabDisplayWidget(), false);</span>
<a href="#l28.204"></a><span id="l28.204"> </span>
<a href="#l28.205"></a><span id="l28.205">         let viewWrapperToClone = (&quot;viewWrapperToClone&quot; in aArgs) &amp;&amp;</span>
<a href="#l28.206"></a><span id="l28.206">                                  aArgs.viewWrapperToClone;</span>
<a href="#l28.207"></a><span id="l28.207">         let background = (&quot;background&quot; in aArgs) &amp;&amp; aArgs.background;</span>
<a href="#l28.208"></a><span id="l28.208"> </span>
<a href="#l28.209"></a><span id="l28.209">         if (viewWrapperToClone) {</span>
<a href="#l28.210"></a><span id="l28.210">           // The original view must have a collapsed group header thread's</span>
<a href="#l28.211"></a><span id="l28.211">           // message(s) found in expand mode before it's cloned, for any to</span>
<a href="#l28.212"></a><span id="l28.212">           // be selected.</span>
<a href="#l28.213"></a><span id="l28.213">           if (viewWrapperToClone.showGroupedBySort)</span>
<a href="#l28.214"></a><span id="l28.214">             viewWrapperToClone.dbView.findIndexOfMsgHdr(aArgs.msgHdr, true);</span>
<a href="#l28.215"></a><span id="l28.215"> </span>
<a href="#l28.216"></a><span id="l28.216">           aTab.folderDisplay.cloneView(viewWrapperToClone);</span>
<a href="#l28.217"></a><span id="l28.217" class="difflineminus">-        }</span>
<a href="#l28.218"></a><span id="l28.218" class="difflineminus">-        else {</span>
<a href="#l28.219"></a><span id="l28.219" class="difflineplus">+        } else {</span>
<a href="#l28.220"></a><span id="l28.220">           // Create a synthetic message view for the header</span>
<a href="#l28.221"></a><span id="l28.221">           let synView = new MsgHdrSyntheticView(aArgs.msgHdr);</span>
<a href="#l28.222"></a><span id="l28.222">           aTab.folderDisplay.show(synView);</span>
<a href="#l28.223"></a><span id="l28.223">         }</span>
<a href="#l28.224"></a><span id="l28.224"> </span>
<a href="#l28.225"></a><span id="l28.225">         // folderDisplay.show is going to try to set the title itself, but we</span>
<a href="#l28.226"></a><span id="l28.226">         // wouldn't have selected a message at that point, so set the title</span>
<a href="#l28.227"></a><span id="l28.227">         // here</span>
<a href="#l28.228"></a><span id="l28.228" class="difflineat">@@ -354,36 +351,35 @@ var mailTabType = {</span>
<a href="#l28.229"></a><span id="l28.229">         // get focus</span>
<a href="#l28.230"></a><span id="l28.230">         aTab._focusedElement = document.getElementById(&quot;messagepane&quot;);</span>
<a href="#l28.231"></a><span id="l28.231"> </span>
<a href="#l28.232"></a><span id="l28.232">         // we only want to make it active after setting up the view and the message</span>
<a href="#l28.233"></a><span id="l28.233">         //  to avoid generating bogus summarization events.</span>
<a href="#l28.234"></a><span id="l28.234">         if (!background) {</span>
<a href="#l28.235"></a><span id="l28.235">           aTab.folderDisplay.makeActive();</span>
<a href="#l28.236"></a><span id="l28.236">           this.restoreFocus(aTab);</span>
<a href="#l28.237"></a><span id="l28.237" class="difflineminus">-        }</span>
<a href="#l28.238"></a><span id="l28.238" class="difflineminus">-        else {</span>
<a href="#l28.239"></a><span id="l28.239" class="difflineplus">+        } else {</span>
<a href="#l28.240"></a><span id="l28.240">           // We don't want to null out the real tree box view, as that</span>
<a href="#l28.241"></a><span id="l28.241">           // corresponds to the _current_ tab, not the new one</span>
<a href="#l28.242"></a><span id="l28.242">           aTab.folderDisplay.hookUpFakeTreeBox(false);</span>
<a href="#l28.243"></a><span id="l28.243">         }</span>
<a href="#l28.244"></a><span id="l28.244">       },</span>
<a href="#l28.245"></a><span id="l28.245" class="difflineminus">-      persistTab: function(aTab) {</span>
<a href="#l28.246"></a><span id="l28.246" class="difflineplus">+      persistTab(aTab) {</span>
<a href="#l28.247"></a><span id="l28.247">         let msgHdr = aTab.folderDisplay.selectedMessage;</span>
<a href="#l28.248"></a><span id="l28.248">         return {</span>
<a href="#l28.249"></a><span id="l28.249" class="difflineminus">-          messageURI: msgHdr.folder.getUriForMsg(msgHdr)</span>
<a href="#l28.250"></a><span id="l28.250" class="difflineplus">+          messageURI: msgHdr.folder.getUriForMsg(msgHdr),</span>
<a href="#l28.251"></a><span id="l28.251">         };</span>
<a href="#l28.252"></a><span id="l28.252">       },</span>
<a href="#l28.253"></a><span id="l28.253" class="difflineminus">-      restoreTab: function(aTabmail, aPersistedState) {</span>
<a href="#l28.254"></a><span id="l28.254" class="difflineplus">+      restoreTab(aTabmail, aPersistedState) {</span>
<a href="#l28.255"></a><span id="l28.255">         let msgHdr = messenger.msgHdrFromURI(aPersistedState.messageURI);</span>
<a href="#l28.256"></a><span id="l28.256">         // if the message no longer exists, we can't restore the tab</span>
<a href="#l28.257"></a><span id="l28.257">         if (msgHdr)</span>
<a href="#l28.258"></a><span id="l28.258" class="difflineminus">-          aTabmail.openTab(&quot;message&quot;, {msgHdr: msgHdr, background: true});</span>
<a href="#l28.259"></a><span id="l28.259" class="difflineplus">+          aTabmail.openTab(&quot;message&quot;, {msgHdr, background: true});</span>
<a href="#l28.260"></a><span id="l28.260">       },</span>
<a href="#l28.261"></a><span id="l28.261" class="difflineminus">-      onTitleChanged: function(aTab, aTabNode, aMsgHdr) {</span>
<a href="#l28.262"></a><span id="l28.262" class="difflineplus">+      onTitleChanged(aTab, aTabNode, aMsgHdr) {</span>
<a href="#l28.263"></a><span id="l28.263">         // Try and figure out the selected message if one was not provided.</span>
<a href="#l28.264"></a><span id="l28.264">         // It is possible that the folder has yet to load, so it may still be</span>
<a href="#l28.265"></a><span id="l28.265">         //  null.</span>
<a href="#l28.266"></a><span id="l28.266">         if (aMsgHdr == null)</span>
<a href="#l28.267"></a><span id="l28.267">           aMsgHdr = aTab.folderDisplay.selectedMessage;</span>
<a href="#l28.268"></a><span id="l28.268">         aTab.title = &quot;&quot;;</span>
<a href="#l28.269"></a><span id="l28.269">         if (aMsgHdr == null)</span>
<a href="#l28.270"></a><span id="l28.270">           return;</span>
<a href="#l28.271"></a><span id="l28.271" class="difflineat">@@ -415,29 +411,29 @@ var mailTabType = {</span>
<a href="#l28.272"></a><span id="l28.272">               });</span>
<a href="#l28.273"></a><span id="l28.273"> </span>
<a href="#l28.274"></a><span id="l28.274">               let url = aMimeMsg.headers[&quot;content-base&quot;][0];</span>
<a href="#l28.275"></a><span id="l28.275">               FeedUtils.getFavicon(null, url, null, window, callback);</span>
<a href="#l28.276"></a><span id="l28.276">             }</span>
<a href="#l28.277"></a><span id="l28.277">           }, false, {saneBodySize: true});</span>
<a href="#l28.278"></a><span id="l28.278">         }</span>
<a href="#l28.279"></a><span id="l28.279">       },</span>
<a href="#l28.280"></a><span id="l28.280" class="difflineminus">-      getBrowser: function(aTab) {</span>
<a href="#l28.281"></a><span id="l28.281" class="difflineplus">+      getBrowser(aTab) {</span>
<a href="#l28.282"></a><span id="l28.282">         // Message tabs always use the messagepane browser.</span>
<a href="#l28.283"></a><span id="l28.283">         return document.getElementById(&quot;messagepane&quot;);</span>
<a href="#l28.284"></a><span id="l28.284" class="difflineminus">-      }</span>
<a href="#l28.285"></a><span id="l28.285" class="difflineplus">+      },</span>
<a href="#l28.286"></a><span id="l28.286">     },</span>
<a href="#l28.287"></a><span id="l28.287">     /**</span>
<a href="#l28.288"></a><span id="l28.288">      * The glodaList view displays a gloda-backed nsMsgDBView with only the</span>
<a href="#l28.289"></a><span id="l28.289">      *  thread pane and (potentially) the message pane displayed; the folder</span>
<a href="#l28.290"></a><span id="l28.290">      *  pane is forced hidden.</span>
<a href="#l28.291"></a><span id="l28.291">      */</span>
<a href="#l28.292"></a><span id="l28.292">     glodaList: {</span>
<a href="#l28.293"></a><span id="l28.293">       type: &quot;glodaSearch&quot;,</span>
<a href="#l28.294"></a><span id="l28.294" class="difflineminus">-      /// The set of panes that are legal to be displayed in this mode</span>
<a href="#l28.295"></a><span id="l28.295" class="difflineplus">+      // The set of panes that are legal to be displayed in this mode</span>
<a href="#l28.296"></a><span id="l28.296">       legalPanes: {</span>
<a href="#l28.297"></a><span id="l28.297">         folder: false,</span>
<a href="#l28.298"></a><span id="l28.298">         thread: true,</span>
<a href="#l28.299"></a><span id="l28.299">         message: true,</span>
<a href="#l28.300"></a><span id="l28.300">       },</span>
<a href="#l28.301"></a><span id="l28.301">       /**</span>
<a href="#l28.302"></a><span id="l28.302">        * Open a new folder-display-style tab showing the contents of a gloda</span>
<a href="#l28.303"></a><span id="l28.303">        *  query/collection.  You must pass one of 'query'/'collection'/</span>
<a href="#l28.304"></a><span id="l28.304" class="difflineat">@@ -453,17 +449,17 @@ var mailTabType = {</span>
<a href="#l28.305"></a><span id="l28.305">        * @param {GlodaMessage} [aArgs.message] The message to select in the</span>
<a href="#l28.306"></a><span id="l28.306">        *     conversation, if provided.</span>
<a href="#l28.307"></a><span id="l28.307">        * @param aArgs.title The title to give to the tab.  If this is not user</span>
<a href="#l28.308"></a><span id="l28.308">        *     content (a search string, a message subject, etc.), make sure you</span>
<a href="#l28.309"></a><span id="l28.309">        *     are using a localized string.</span>
<a href="#l28.310"></a><span id="l28.310">        *</span>
<a href="#l28.311"></a><span id="l28.311">        * XXX This needs to handle opening in the background</span>
<a href="#l28.312"></a><span id="l28.312">        */</span>
<a href="#l28.313"></a><span id="l28.313" class="difflineminus">-      openTab: function(aTab, aArgs) {</span>
<a href="#l28.314"></a><span id="l28.314" class="difflineplus">+      openTab(aTab, aArgs) {</span>
<a href="#l28.315"></a><span id="l28.315">         aTab.glodaSynView = new GlodaSyntheticView(aArgs);</span>
<a href="#l28.316"></a><span id="l28.316">         aTab.title = aArgs.title;</span>
<a href="#l28.317"></a><span id="l28.317"> </span>
<a href="#l28.318"></a><span id="l28.318">         this.openTab(aTab, false, new MessagePaneDisplayWidget(), false);</span>
<a href="#l28.319"></a><span id="l28.319">         aTab.folderDisplay.show(aTab.glodaSynView);</span>
<a href="#l28.320"></a><span id="l28.320">         // XXX persist threaded state?</span>
<a href="#l28.321"></a><span id="l28.321">         aTab.folderDisplay.view.showThreaded = true;</span>
<a href="#l28.322"></a><span id="l28.322"> </span>
<a href="#l28.323"></a><span id="l28.323" class="difflineat">@@ -471,84 +467,83 @@ var mailTabType = {</span>
<a href="#l28.324"></a><span id="l28.324">         if (!background)</span>
<a href="#l28.325"></a><span id="l28.325">           aTab.folderDisplay.makeActive();</span>
<a href="#l28.326"></a><span id="l28.326">         if (&quot;message&quot; in aArgs) {</span>
<a href="#l28.327"></a><span id="l28.327">           let hdr = aArgs.message.folderMessage;</span>
<a href="#l28.328"></a><span id="l28.328">           if (hdr)</span>
<a href="#l28.329"></a><span id="l28.329">             aTab.folderDisplay.selectMessage(hdr);</span>
<a href="#l28.330"></a><span id="l28.330">         }</span>
<a href="#l28.331"></a><span id="l28.331">       },</span>
<a href="#l28.332"></a><span id="l28.332" class="difflineminus">-      getBrowser: function(aTab) {</span>
<a href="#l28.333"></a><span id="l28.333" class="difflineplus">+      getBrowser(aTab) {</span>
<a href="#l28.334"></a><span id="l28.334">         // If we are currently a thread summary, we want to select the multi</span>
<a href="#l28.335"></a><span id="l28.335">         // message browser rather than the message pane.</span>
<a href="#l28.336"></a><span id="l28.336">         return gMessageDisplay.singleMessageDisplay ?</span>
<a href="#l28.337"></a><span id="l28.337">                document.getElementById(&quot;messagepane&quot;) :</span>
<a href="#l28.338"></a><span id="l28.338">                document.getElementById(&quot;multimessage&quot;);</span>
<a href="#l28.339"></a><span id="l28.339" class="difflineminus">-      }</span>
<a href="#l28.340"></a><span id="l28.340" class="difflineplus">+      },</span>
<a href="#l28.341"></a><span id="l28.341">     },</span>
<a href="#l28.342"></a><span id="l28.342">   },</span>
<a href="#l28.343"></a><span id="l28.343"> </span>
<a href="#l28.344"></a><span id="l28.344" class="difflineminus">-  _getNumberOfRealAccounts : function() {</span>
<a href="#l28.345"></a><span id="l28.345" class="difflineplus">+  _getNumberOfRealAccounts() {</span>
<a href="#l28.346"></a><span id="l28.346">     let accountCount = MailServices.accounts.accounts.length;</span>
<a href="#l28.347"></a><span id="l28.347">     // If we have an account, we also always have a &quot;Local Folders&quot; account.</span>
<a href="#l28.348"></a><span id="l28.348">     return accountCount &gt; 0 ? (accountCount - 1) : 0;</span>
<a href="#l28.349"></a><span id="l28.349">   },</span>
<a href="#l28.350"></a><span id="l28.350"> </span>
<a href="#l28.351"></a><span id="l28.351">   /**</span>
<a href="#l28.352"></a><span id="l28.352">    * Common tab opening code shared by the various tab modes.</span>
<a href="#l28.353"></a><span id="l28.353">    */</span>
<a href="#l28.354"></a><span id="l28.354" class="difflineminus">-  openTab: function(aTab, aIsFirstTab, aMessageDisplay, aFolderPaneVisible) {</span>
<a href="#l28.355"></a><span id="l28.355" class="difflineplus">+  openTab(aTab, aIsFirstTab, aMessageDisplay, aFolderPaneVisible) {</span>
<a href="#l28.356"></a><span id="l28.356">     // Set the messagepane as the primary browser for content.</span>
<a href="#l28.357"></a><span id="l28.357">     document.getElementById(&quot;messagepane&quot;).setAttribute(&quot;type&quot;, &quot;content&quot;);</span>
<a href="#l28.358"></a><span id="l28.358">     document.getElementById(&quot;messagepane&quot;).setAttribute(&quot;primary&quot;, &quot;true&quot;);</span>
<a href="#l28.359"></a><span id="l28.359"> </span>
<a href="#l28.360"></a><span id="l28.360">     aTab.messageDisplay = aMessageDisplay;</span>
<a href="#l28.361"></a><span id="l28.361">     aTab.folderDisplay = new FolderDisplayWidget(aTab, aTab.messageDisplay);</span>
<a href="#l28.362"></a><span id="l28.362">     aTab.folderDisplay.msgWindow = msgWindow;</span>
<a href="#l28.363"></a><span id="l28.363">     aTab.folderDisplay.tree = document.getElementById(&quot;threadTree&quot;);</span>
<a href="#l28.364"></a><span id="l28.364">     aTab.folderDisplay.treeBox = aTab.folderDisplay.tree.boxObject;</span>
<a href="#l28.365"></a><span id="l28.365">     aTab.folderDisplay.folderPaneVisible = aFolderPaneVisible;</span>
<a href="#l28.366"></a><span id="l28.366"> </span>
<a href="#l28.367"></a><span id="l28.367">     if (aIsFirstTab) {</span>
<a href="#l28.368"></a><span id="l28.368">       aTab.folderDisplay.messenger = messenger;</span>
<a href="#l28.369"></a><span id="l28.369" class="difflineminus">-    }</span>
<a href="#l28.370"></a><span id="l28.370" class="difflineminus">-    else {</span>
<a href="#l28.371"></a><span id="l28.371" class="difflineplus">+    } else {</span>
<a href="#l28.372"></a><span id="l28.372">       // Each tab gets its own messenger instance; this provides each tab with</span>
<a href="#l28.373"></a><span id="l28.373">       // its own undo/redo stack and back/forward navigation history.</span>
<a href="#l28.374"></a><span id="l28.374">       // If this is a foreground tab, folderDisplay.makeActive() is going to</span>
<a href="#l28.375"></a><span id="l28.375">       // set it as the global messenger, so there's no need to do it here</span>
<a href="#l28.376"></a><span id="l28.376">       let tabMessenger = Cc[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l28.377"></a><span id="l28.377">                            .createInstance(Ci.nsIMessenger);</span>
<a href="#l28.378"></a><span id="l28.378">       tabMessenger.setWindow(window, msgWindow);</span>
<a href="#l28.379"></a><span id="l28.379">       aTab.folderDisplay.messenger = tabMessenger;</span>
<a href="#l28.380"></a><span id="l28.380">     }</span>
<a href="#l28.381"></a><span id="l28.381">   },</span>
<a href="#l28.382"></a><span id="l28.382"> </span>
<a href="#l28.383"></a><span id="l28.383" class="difflineminus">-  closeTab: function(aTab) {</span>
<a href="#l28.384"></a><span id="l28.384" class="difflineplus">+  closeTab(aTab) {</span>
<a href="#l28.385"></a><span id="l28.385">     aTab.folderDisplay.close();</span>
<a href="#l28.386"></a><span id="l28.386">   },</span>
<a href="#l28.387"></a><span id="l28.387"> </span>
<a href="#l28.388"></a><span id="l28.388">   /**</span>
<a href="#l28.389"></a><span id="l28.389">    * Save off the tab's currently focused element or window.</span>
<a href="#l28.390"></a><span id="l28.390">    * - If the message pane or summary is currently focused, save the</span>
<a href="#l28.391"></a><span id="l28.391">    *   corresponding browser element as the focused element.</span>
<a href="#l28.392"></a><span id="l28.392">    * - If the thread tree or folder tree is focused, save that as the focused</span>
<a href="#l28.393"></a><span id="l28.393">    *   element.</span>
<a href="#l28.394"></a><span id="l28.394">    */</span>
<a href="#l28.395"></a><span id="l28.395" class="difflineminus">-  saveFocus: function mailTabType_saveFocus(aTab) {</span>
<a href="#l28.396"></a><span id="l28.396" class="difflineplus">+  saveFocus(aTab) {</span>
<a href="#l28.397"></a><span id="l28.397">     aTab._focusedElement = aTab.folderDisplay.focusedPane;</span>
<a href="#l28.398"></a><span id="l28.398">   },</span>
<a href="#l28.399"></a><span id="l28.399"> </span>
<a href="#l28.400"></a><span id="l28.400">   /**</span>
<a href="#l28.401"></a><span id="l28.401">    * Restore the tab's focused element or window.</span>
<a href="#l28.402"></a><span id="l28.402">    */</span>
<a href="#l28.403"></a><span id="l28.403" class="difflineminus">-  restoreFocus: function mailTabType_restoreFocus(aTab) {</span>
<a href="#l28.404"></a><span id="l28.404" class="difflineplus">+  restoreFocus(aTab) {</span>
<a href="#l28.405"></a><span id="l28.405">     // There seem to be issues with opening multiple messages at once, so allow</span>
<a href="#l28.406"></a><span id="l28.406">     // things to stabilize a bit before proceeding</span>
<a href="#l28.407"></a><span id="l28.407" class="difflineminus">-    let reallyRestoreFocus = function mailTabType_reallyRestoreFocus(aTab) {</span>
<a href="#l28.408"></a><span id="l28.408" class="difflineplus">+    let reallyRestoreFocus = function(aTab) {</span>
<a href="#l28.409"></a><span id="l28.409">       if (&quot;_focusedElement&quot; in aTab &amp;&amp; aTab._focusedElement) {</span>
<a href="#l28.410"></a><span id="l28.410">         aTab._focusedElement.focus();</span>
<a href="#l28.411"></a><span id="l28.411"> </span>
<a href="#l28.412"></a><span id="l28.412">         // If we were focused on the message pane, we need to focus on the</span>
<a href="#l28.413"></a><span id="l28.413">         // appropriate subnode (the single- or multi-message content window).</span>
<a href="#l28.414"></a><span id="l28.414">         if (aTab._focusedElement == document.getElementById(&quot;messagepanebox&quot;)) {</span>
<a href="#l28.415"></a><span id="l28.415">           if (aTab.messageDisplay.singleMessageDisplay)</span>
<a href="#l28.416"></a><span id="l28.416">             document.getElementById(&quot;messagepane&quot;).focus();</span>
<a href="#l28.417"></a><span id="l28.417" class="difflineat">@@ -557,17 +552,17 @@ var mailTabType = {</span>
<a href="#l28.418"></a><span id="l28.418">         }</span>
<a href="#l28.419"></a><span id="l28.419">       }</span>
<a href="#l28.420"></a><span id="l28.420">       aTab._focusedElement = null;</span>
<a href="#l28.421"></a><span id="l28.421">     };</span>
<a href="#l28.422"></a><span id="l28.422"> </span>
<a href="#l28.423"></a><span id="l28.423">     window.setTimeout(reallyRestoreFocus, 0, aTab);</span>
<a href="#l28.424"></a><span id="l28.424">   },</span>
<a href="#l28.425"></a><span id="l28.425"> </span>
<a href="#l28.426"></a><span id="l28.426" class="difflineminus">-  saveTabState: function(aTab) {</span>
<a href="#l28.427"></a><span id="l28.427" class="difflineplus">+  saveTabState(aTab) {</span>
<a href="#l28.428"></a><span id="l28.428">     // Now let other tabs have a primary browser if they want.</span>
<a href="#l28.429"></a><span id="l28.429">     let messagepane = document.getElementById(&quot;messagepane&quot;);</span>
<a href="#l28.430"></a><span id="l28.430">     messagepane.setAttribute(&quot;type&quot;, &quot;content&quot;);</span>
<a href="#l28.431"></a><span id="l28.431">     messagepane.removeAttribute(&quot;primary&quot;);</span>
<a href="#l28.432"></a><span id="l28.432"> </span>
<a href="#l28.433"></a><span id="l28.433">     this.saveFocus(aTab);</span>
<a href="#l28.434"></a><span id="l28.434">     aTab.folderDisplay.makeInactive();</span>
<a href="#l28.435"></a><span id="l28.435">   },</span>
<a href="#l28.436"></a><span id="l28.436" class="difflineat">@@ -601,25 +596,23 @@ var mailTabType = {</span>
<a href="#l28.437"></a><span id="l28.437">    *        on whether it's actually the thread pane we are showing.</span>
<a href="#l28.438"></a><span id="l28.438">    *     - message: The message pane.  Required/assumed to be true for now.</span>
<a href="#l28.439"></a><span id="l28.439">    * @param aVisibleStates A dictionary where each value indicates whether the</span>
<a href="#l28.440"></a><span id="l28.440">    *     pane should be 'visible' (not collapsed).  Only panes that are governed</span>
<a href="#l28.441"></a><span id="l28.441">    *     by splitters are options here.  Keys are:</span>
<a href="#l28.442"></a><span id="l28.442">    *     - folder: The folder (tree) pane.</span>
<a href="#l28.443"></a><span id="l28.443">    *     - message: The message pane.</span>
<a href="#l28.444"></a><span id="l28.444">    */</span>
<a href="#l28.445"></a><span id="l28.445" class="difflineminus">-  _setPaneStates: function mailTabType_setPaneStates(aLegalStates,</span>
<a href="#l28.446"></a><span id="l28.446" class="difflineminus">-                                                     aVisibleStates) {</span>
<a href="#l28.447"></a><span id="l28.447" class="difflineplus">+  _setPaneStates(aLegalStates, aVisibleStates) {</span>
<a href="#l28.448"></a><span id="l28.448">     // The display deck hosts both the thread pane and account central.</span>
<a href="#l28.449"></a><span id="l28.449">     let displayDeckLegal = aLegalStates.thread ||</span>
<a href="#l28.450"></a><span id="l28.450">                            aLegalStates.accountCentral;</span>
<a href="#l28.451"></a><span id="l28.451"> </span>
<a href="#l28.452"></a><span id="l28.452">     let layout = Services.prefs.getIntPref(&quot;mail.pane_config.dynamic&quot;);</span>
<a href="#l28.453"></a><span id="l28.453" class="difflineminus">-    if (layout == kWidePaneConfig)</span>
<a href="#l28.454"></a><span id="l28.454" class="difflineminus">-    {</span>
<a href="#l28.455"></a><span id="l28.455" class="difflineplus">+    if (layout == kWidePaneConfig) {</span>
<a href="#l28.456"></a><span id="l28.456">       // in the &quot;wide&quot; configuration, the #messengerBox is left holding the</span>
<a href="#l28.457"></a><span id="l28.457">       //  folder pane and thread pane, and the message pane has migrated to be</span>
<a href="#l28.458"></a><span id="l28.458">       //  its sibling (under #mailContent).</span>
<a href="#l28.459"></a><span id="l28.459">       // Accordingly, if both the folder and thread panes are illegal, we</span>
<a href="#l28.460"></a><span id="l28.460">       //  want to collapse the #messengerBox and make sure the #messagepanebox</span>
<a href="#l28.461"></a><span id="l28.461">       //  fills up the screen.  (For example, when in &quot;message&quot; mode.)</span>
<a href="#l28.462"></a><span id="l28.462">       let collapseMessengerBox = !aLegalStates.folder &amp;&amp; !displayDeckLegal;</span>
<a href="#l28.463"></a><span id="l28.463">       document.getElementById(&quot;messengerBox&quot;).collapsed = collapseMessengerBox;</span>
<a href="#l28.464"></a><span id="l28.464" class="difflineat">@@ -692,59 +685,58 @@ var mailTabType = {</span>
<a href="#l28.465"></a><span id="l28.465">     //  updating the menu item (on demand)</span>
<a href="#l28.466"></a><span id="l28.466">     let messagePaneToggleKey = document.getElementById(&quot;key_toggleMessagePane&quot;);</span>
<a href="#l28.467"></a><span id="l28.467">     if (aLegalStates.thread)</span>
<a href="#l28.468"></a><span id="l28.468">       messagePaneToggleKey.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l28.469"></a><span id="l28.469">     else</span>
<a href="#l28.470"></a><span id="l28.470">       messagePaneToggleKey.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l28.471"></a><span id="l28.471">   },</span>
<a href="#l28.472"></a><span id="l28.472"> </span>
<a href="#l28.473"></a><span id="l28.473" class="difflineminus">-  showTab: function(aTab) {</span>
<a href="#l28.474"></a><span id="l28.474" class="difflineplus">+  showTab(aTab) {</span>
<a href="#l28.475"></a><span id="l28.475">     // Set the messagepane as the primary browser for content.</span>
<a href="#l28.476"></a><span id="l28.476">     document.getElementById(&quot;messagepane&quot;).setAttribute(&quot;type&quot;, &quot;content&quot;);</span>
<a href="#l28.477"></a><span id="l28.477">     document.getElementById(&quot;messagepane&quot;).setAttribute(&quot;primary&quot;, &quot;true&quot;);</span>
<a href="#l28.478"></a><span id="l28.478"> </span>
<a href="#l28.479"></a><span id="l28.479">     aTab.folderDisplay.makeActive();</span>
<a href="#l28.480"></a><span id="l28.480"> </span>
<a href="#l28.481"></a><span id="l28.481">     // - restore folder pane/tree selection</span>
<a href="#l28.482"></a><span id="l28.482">     if (aTab.folderDisplay.displayedFolder) {</span>
<a href="#l28.483"></a><span id="l28.483">       // but don't generate any events while doing so!</span>
<a href="#l28.484"></a><span id="l28.484">       gFolderTreeView.selection.selectEventsSuppressed = true;</span>
<a href="#l28.485"></a><span id="l28.485">       try {</span>
<a href="#l28.486"></a><span id="l28.486">         gFolderTreeView.selectFolder(aTab.folderDisplay.displayedFolder);</span>
<a href="#l28.487"></a><span id="l28.487" class="difflineminus">-      }</span>
<a href="#l28.488"></a><span id="l28.488" class="difflineminus">-      finally {</span>
<a href="#l28.489"></a><span id="l28.489" class="difflineplus">+      } finally {</span>
<a href="#l28.490"></a><span id="l28.490">         gIgnoreSyntheticFolderPaneSelectionChange = true;</span>
<a href="#l28.491"></a><span id="l28.491">         gFolderTreeView.selection.selectEventsSuppressed = false;</span>
<a href="#l28.492"></a><span id="l28.492">       }</span>
<a href="#l28.493"></a><span id="l28.493">     }</span>
<a href="#l28.494"></a><span id="l28.494"> </span>
<a href="#l28.495"></a><span id="l28.495">     // restore focus</span>
<a href="#l28.496"></a><span id="l28.496">     this.restoreFocus(aTab);</span>
<a href="#l28.497"></a><span id="l28.497">   },</span>
<a href="#l28.498"></a><span id="l28.498"> </span>
<a href="#l28.499"></a><span id="l28.499">   // nsIController implementation</span>
<a href="#l28.500"></a><span id="l28.500"> </span>
<a href="#l28.501"></a><span id="l28.501" class="difflineminus">-  supportsCommand: function mailTabType_supportsCommand(aCommand, aTab) {</span>
<a href="#l28.502"></a><span id="l28.502" class="difflineplus">+  supportsCommand(aCommand, aTab) {</span>
<a href="#l28.503"></a><span id="l28.503">     switch (aCommand) {</span>
<a href="#l28.504"></a><span id="l28.504">       case &quot;cmd_viewClassicMailLayout&quot;:</span>
<a href="#l28.505"></a><span id="l28.505">       case &quot;cmd_viewWideMailLayout&quot;:</span>
<a href="#l28.506"></a><span id="l28.506">       case &quot;cmd_viewVerticalMailLayout&quot;:</span>
<a href="#l28.507"></a><span id="l28.507">       case &quot;cmd_toggleFolderPane&quot;:</span>
<a href="#l28.508"></a><span id="l28.508">       case &quot;cmd_toggleFolderPaneCols&quot;:</span>
<a href="#l28.509"></a><span id="l28.509">       case &quot;cmd_toggleMessagePane&quot;:</span>
<a href="#l28.510"></a><span id="l28.510">         return true;</span>
<a href="#l28.511"></a><span id="l28.511"> </span>
<a href="#l28.512"></a><span id="l28.512">       default:</span>
<a href="#l28.513"></a><span id="l28.513">         return DefaultController.supportsCommand(aCommand);</span>
<a href="#l28.514"></a><span id="l28.514">     }</span>
<a href="#l28.515"></a><span id="l28.515">   },</span>
<a href="#l28.516"></a><span id="l28.516"> </span>
<a href="#l28.517"></a><span id="l28.517">   // We only depend on what's illegal</span>
<a href="#l28.518"></a><span id="l28.518" class="difflineminus">-  isCommandEnabled: function mailTabType_isCommandEnabled(aCommand, aTab) {</span>
<a href="#l28.519"></a><span id="l28.519" class="difflineplus">+  isCommandEnabled(aCommand, aTab) {</span>
<a href="#l28.520"></a><span id="l28.520">     switch (aCommand) {</span>
<a href="#l28.521"></a><span id="l28.521">       case &quot;cmd_viewClassicMailLayout&quot;:</span>
<a href="#l28.522"></a><span id="l28.522">       case &quot;cmd_viewWideMailLayout&quot;:</span>
<a href="#l28.523"></a><span id="l28.523">       case &quot;cmd_viewVerticalMailLayout&quot;:</span>
<a href="#l28.524"></a><span id="l28.524">       case &quot;cmd_toggleFolderPane&quot;:</span>
<a href="#l28.525"></a><span id="l28.525">       case &quot;cmd_toggleFolderPaneCols&quot;:</span>
<a href="#l28.526"></a><span id="l28.526">       case &quot;cmd_toggleMessagePane&quot;:</span>
<a href="#l28.527"></a><span id="l28.527">         // If the thread pane is illegal, these are all disabled</span>
<a href="#l28.528"></a><span id="l28.528" class="difflineat">@@ -752,16 +744,16 @@ var mailTabType = {</span>
<a href="#l28.529"></a><span id="l28.529">           return false;</span>
<a href="#l28.530"></a><span id="l28.530">         // else fall through</span>
<a href="#l28.531"></a><span id="l28.531"> </span>
<a href="#l28.532"></a><span id="l28.532">       default:</span>
<a href="#l28.533"></a><span id="l28.533">         return DefaultController.isCommandEnabled(aCommand);</span>
<a href="#l28.534"></a><span id="l28.534">     }</span>
<a href="#l28.535"></a><span id="l28.535">   },</span>
<a href="#l28.536"></a><span id="l28.536"> </span>
<a href="#l28.537"></a><span id="l28.537" class="difflineminus">-  doCommand: function mailTabType_doCommand(aCommand, aTab) {</span>
<a href="#l28.538"></a><span id="l28.538" class="difflineplus">+  doCommand(aCommand, aTab) {</span>
<a href="#l28.539"></a><span id="l28.539">     if (!this.isCommandEnabled(aCommand, aTab))</span>
<a href="#l28.540"></a><span id="l28.540">       return;</span>
<a href="#l28.541"></a><span id="l28.541"> </span>
<a href="#l28.542"></a><span id="l28.542">     // DefaultController knows how to handle this</span>
<a href="#l28.543"></a><span id="l28.543">     DefaultController.doCommand(aCommand, aTab);</span>
<a href="#l28.544"></a><span id="l28.544" class="difflineminus">-  }</span>
<a href="#l28.545"></a><span id="l28.545" class="difflineplus">+  },</span>
<a href="#l28.546"></a><span id="l28.546"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mail/base/content/mailWidgets.xml</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mail/base/content/mailWidgets.xml</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -108,38 +108,36 @@</span>
<a href="#l29.4"></a><span id="l29.4"> </span>
<a href="#l29.5"></a><span id="l29.5">           if (offset &gt; 0) {</span>
<a href="#l29.6"></a><span id="l29.6">             // We went too far! Go back until we find an item totally off-</span>
<a href="#l29.7"></a><span id="l29.7">             // screen, then return the one after that.</span>
<a href="#l29.8"></a><span id="l29.8">             for (let i = estimatedIndex - 1; i &gt;= 0; i--) {</span>
<a href="#l29.9"></a><span id="l29.9">               let childBoxObj = this._childNodes[i].boxObject;</span>
<a href="#l29.10"></a><span id="l29.10">               if (childBoxObj.screenY + childBoxObj.height &lt;=</span>
<a href="#l29.11"></a><span id="l29.11">                   box.boxObject.screenY)</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-                return i+1;</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+                return i + 1;</span>
<a href="#l29.14"></a><span id="l29.14">             }</span>
<a href="#l29.15"></a><span id="l29.15"> </span>
<a href="#l29.16"></a><span id="l29.16">             // If we get here, we must have gone back to the beginning of the</span>
<a href="#l29.17"></a><span id="l29.17">             // list, so just return 0.</span>
<a href="#l29.18"></a><span id="l29.18">             return 0;</span>
<a href="#l29.19"></a><span id="l29.19">           }</span>
<a href="#l29.20"></a><span id="l29.20" class="difflineminus">-          else {</span>
<a href="#l29.21"></a><span id="l29.21" class="difflineminus">-            // We didn't go far enough! Keep going until we find an item at</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineminus">-            // least partially on-screen.</span>
<a href="#l29.23"></a><span id="l29.23" class="difflineminus">-            for (let i = estimatedIndex; i &lt; this._childNodes.length; i++) {</span>
<a href="#l29.24"></a><span id="l29.24" class="difflineminus">-              let childBoxObj = this._childNodes[i].boxObject;</span>
<a href="#l29.25"></a><span id="l29.25" class="difflineminus">-              if (childBoxObj.screenY + childBoxObj.height &gt;</span>
<a href="#l29.26"></a><span id="l29.26" class="difflineminus">-                  box.boxObject.screenY &gt; 0)</span>
<a href="#l29.27"></a><span id="l29.27" class="difflineminus">-                return i;</span>
<a href="#l29.28"></a><span id="l29.28" class="difflineminus">-            }</span>
<a href="#l29.29"></a><span id="l29.29" class="difflineplus">+          // We didn't go far enough! Keep going until we find an item at</span>
<a href="#l29.30"></a><span id="l29.30" class="difflineplus">+          // least partially on-screen.</span>
<a href="#l29.31"></a><span id="l29.31" class="difflineplus">+          for (let i = estimatedIndex; i &lt; this._childNodes.length; i++) {</span>
<a href="#l29.32"></a><span id="l29.32" class="difflineplus">+            let childBoxObj = this._childNodes[i].boxObject;</span>
<a href="#l29.33"></a><span id="l29.33" class="difflineplus">+            if (childBoxObj.screenY + childBoxObj.height &gt;</span>
<a href="#l29.34"></a><span id="l29.34" class="difflineplus">+                box.boxObject.screenY &gt; 0)</span>
<a href="#l29.35"></a><span id="l29.35" class="difflineplus">+              return i;</span>
<a href="#l29.36"></a><span id="l29.36" class="difflineplus">+          }</span>
<a href="#l29.37"></a><span id="l29.37"> </span>
<a href="#l29.38"></a><span id="l29.38" class="difflineminus">-            // If we get here, something is very wrong.</span>
<a href="#l29.39"></a><span id="l29.39" class="difflineminus">-            Cu.reportError(</span>
<a href="#l29.40"></a><span id="l29.40" class="difflineminus">-              &quot;Couldn't get index of first visible row for attachmentlist!\n&quot;);</span>
<a href="#l29.41"></a><span id="l29.41" class="difflineminus">-            return -1;</span>
<a href="#l29.42"></a><span id="l29.42" class="difflineminus">-          }</span>
<a href="#l29.43"></a><span id="l29.43" class="difflineplus">+          // If we get here, something is very wrong.</span>
<a href="#l29.44"></a><span id="l29.44" class="difflineplus">+          Cu.reportError(</span>
<a href="#l29.45"></a><span id="l29.45" class="difflineplus">+            &quot;Couldn't get index of first visible row for attachmentlist!\n&quot;);</span>
<a href="#l29.46"></a><span id="l29.46" class="difflineplus">+          return -1;</span>
<a href="#l29.47"></a><span id="l29.47">         ]]&gt;&lt;/body&gt;</span>
<a href="#l29.48"></a><span id="l29.48">       &lt;/method&gt;</span>
<a href="#l29.49"></a><span id="l29.49">       &lt;method name=&quot;ensureIndexIsVisible&quot;&gt;</span>
<a href="#l29.50"></a><span id="l29.50">         &lt;parameter name=&quot;index&quot;/&gt;</span>
<a href="#l29.51"></a><span id="l29.51">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l29.52"></a><span id="l29.52">           this.ensureElementIsVisible(this.getItemAtIndex(index));</span>
<a href="#l29.53"></a><span id="l29.53">         ]]&gt;&lt;/body&gt;</span>
<a href="#l29.54"></a><span id="l29.54">       &lt;/method&gt;</span>
<a href="#l29.55"></a><span id="l29.55" class="difflineat">@@ -191,20 +189,19 @@</span>
<a href="#l29.56"></a><span id="l29.56">             size = this.messenger.formatFileSize(attachment.size);</span>
<a href="#l29.57"></a><span id="l29.57">           else // Use a zero-width space so the size label has the right height.</span>
<a href="#l29.58"></a><span id="l29.58">             size = &quot;\u200b&quot;;</span>
<a href="#l29.59"></a><span id="l29.59">           item.setAttribute(&quot;size&quot;, size);</span>
<a href="#l29.60"></a><span id="l29.60"> </span>
<a href="#l29.61"></a><span id="l29.61">           // Pick out some nice icons (small and large) for the attachment</span>
<a href="#l29.62"></a><span id="l29.62">           if (attachment.contentType == &quot;text/x-moz-deleted&quot;) {</span>
<a href="#l29.63"></a><span id="l29.63">             let base = &quot;chrome://messenger/skin/icons/&quot;;</span>
<a href="#l29.64"></a><span id="l29.64" class="difflineminus">-            item.setAttribute(&quot;image16&quot;, base+&quot;attachment-deleted.png&quot;);</span>
<a href="#l29.65"></a><span id="l29.65" class="difflineminus">-            item.setAttribute(&quot;image32&quot;, base+&quot;attachment-deleted-large.png&quot;);</span>
<a href="#l29.66"></a><span id="l29.66" class="difflineminus">-          }</span>
<a href="#l29.67"></a><span id="l29.67" class="difflineminus">-          else {</span>
<a href="#l29.68"></a><span id="l29.68" class="difflineplus">+            item.setAttribute(&quot;image16&quot;, base + &quot;attachment-deleted.png&quot;);</span>
<a href="#l29.69"></a><span id="l29.69" class="difflineplus">+            item.setAttribute(&quot;image32&quot;, base + &quot;attachment-deleted-large.png&quot;);</span>
<a href="#l29.70"></a><span id="l29.70" class="difflineplus">+          } else {</span>
<a href="#l29.71"></a><span id="l29.71">             item.setAttribute(&quot;image16&quot;, &quot;moz-icon://&quot; + attachment.name +</span>
<a href="#l29.72"></a><span id="l29.72">                               &quot;?size=16&amp;amp;contentType=&quot; +</span>
<a href="#l29.73"></a><span id="l29.73">                               attachment.contentType);</span>
<a href="#l29.74"></a><span id="l29.74">             item.setAttribute(&quot;image32&quot;, &quot;moz-icon://&quot; + attachment.name +</span>
<a href="#l29.75"></a><span id="l29.75">                               &quot;?size=32&amp;amp;contentType=&quot; +</span>
<a href="#l29.76"></a><span id="l29.76">                               attachment.contentType);</span>
<a href="#l29.77"></a><span id="l29.77">           }</span>
<a href="#l29.78"></a><span id="l29.78"> </span>
<a href="#l29.79"></a><span id="l29.79" class="difflineat">@@ -233,18 +230,21 @@</span>
<a href="#l29.80"></a><span id="l29.80">           }</span>
<a href="#l29.81"></a><span id="l29.81">           return null;</span>
<a href="#l29.82"></a><span id="l29.82">         ]]&gt;&lt;/body&gt;</span>
<a href="#l29.83"></a><span id="l29.83">       &lt;/method&gt;</span>
<a href="#l29.84"></a><span id="l29.84"> </span>
<a href="#l29.85"></a><span id="l29.85">       &lt;!-- ///////////////// private members ///////////////// --&gt;</span>
<a href="#l29.86"></a><span id="l29.86"> </span>
<a href="#l29.87"></a><span id="l29.87">       &lt;field name=&quot;_childNodes&quot; readonly=&quot;true&quot;&gt;this.getElementsByTagName(&quot;attachmentitem&quot;)&lt;/field&gt;</span>
<a href="#l29.88"></a><span id="l29.88" class="difflineminus">-      &lt;property name=&quot;scrollbox&quot; readonly=&quot;true&quot;</span>
<a href="#l29.89"></a><span id="l29.89" class="difflineminus">-                onget=&quot;return document.getAnonymousElementByAttribute(this, 'anonid', 'scrollbox');&quot;/&gt;</span>
<a href="#l29.90"></a><span id="l29.90" class="difflineplus">+      &lt;property name=&quot;scrollbox&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l29.91"></a><span id="l29.91" class="difflineplus">+        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l29.92"></a><span id="l29.92" class="difflineplus">+          return document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;scrollbox&quot;);</span>
<a href="#l29.93"></a><span id="l29.93" class="difflineplus">+        ]]&gt;&lt;/getter&gt;</span>
<a href="#l29.94"></a><span id="l29.94" class="difflineplus">+      &lt;/property&gt;</span>
<a href="#l29.95"></a><span id="l29.95"> </span>
<a href="#l29.96"></a><span id="l29.96">       &lt;method name=&quot;_fireOnSelect&quot;&gt;</span>
<a href="#l29.97"></a><span id="l29.97">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l29.98"></a><span id="l29.98">           if (!this._suppressOnSelect &amp;&amp; !this.suppressOnSelect) {</span>
<a href="#l29.99"></a><span id="l29.99">             this.dispatchEvent(new Event(&quot;select&quot;,</span>
<a href="#l29.100"></a><span id="l29.100">                                          { bubbles: false, cancelable: true }));</span>
<a href="#l29.101"></a><span id="l29.101">           }</span>
<a href="#l29.102"></a><span id="l29.102">         ]]&gt;&lt;/body&gt;</span>
<a href="#l29.103"></a><span id="l29.103" class="difflineat">@@ -256,18 +256,17 @@</span>
<a href="#l29.104"></a><span id="l29.104">           if (this._childNodes.length &lt; 2)</span>
<a href="#l29.105"></a><span id="l29.105">             return this._childNodes.length;</span>
<a href="#l29.106"></a><span id="l29.106"> </span>
<a href="#l29.107"></a><span id="l29.107">           let itemWidth = this._childNodes[1].boxObject.x -</span>
<a href="#l29.108"></a><span id="l29.108">                           this._childNodes[0].boxObject.x;</span>
<a href="#l29.109"></a><span id="l29.109"> </span>
<a href="#l29.110"></a><span id="l29.110">           if (itemWidth == 0) // Each item takes up a full row</span>
<a href="#l29.111"></a><span id="l29.111">             return 1;</span>
<a href="#l29.112"></a><span id="l29.112" class="difflineminus">-          else</span>
<a href="#l29.113"></a><span id="l29.113" class="difflineminus">-            return Math.floor(this.scrollbox.clientWidth / itemWidth);</span>
<a href="#l29.114"></a><span id="l29.114" class="difflineplus">+          return Math.floor(this.scrollbox.clientWidth / itemWidth);</span>
<a href="#l29.115"></a><span id="l29.115">         ]]&gt;&lt;/body&gt;</span>
<a href="#l29.116"></a><span id="l29.116">       &lt;/method&gt;</span>
<a href="#l29.117"></a><span id="l29.117"> </span>
<a href="#l29.118"></a><span id="l29.118">       &lt;method name=&quot;_itemsPerCol&quot;&gt;</span>
<a href="#l29.119"></a><span id="l29.119">         &lt;parameter name=&quot;aItemsPerRow&quot;/&gt;</span>
<a href="#l29.120"></a><span id="l29.120">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l29.121"></a><span id="l29.121">           let itemsPerRow = aItemsPerRow || this._itemsPerRow();</span>
<a href="#l29.122"></a><span id="l29.122"> </span>
<a href="#l29.123"></a><span id="l29.123" class="difflineat">@@ -408,17 +407,17 @@</span>
<a href="#l29.124"></a><span id="l29.124">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l29.125"></a><span id="l29.125">       &lt;/property&gt;</span>
<a href="#l29.126"></a><span id="l29.126"> </span>
<a href="#l29.127"></a><span id="l29.127">       &lt;method name=&quot;_updateImage&quot;&gt;</span>
<a href="#l29.128"></a><span id="l29.128">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l29.129"></a><span id="l29.129">           if (!this.hasAttribute(&quot;image&quot;)) {</span>
<a href="#l29.130"></a><span id="l29.130">             let icon = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;,</span>
<a href="#l29.131"></a><span id="l29.131">                                                                &quot;icon&quot;);</span>
<a href="#l29.132"></a><span id="l29.132" class="difflineminus">-            let attr = &quot;image&quot;+this.imageSize;</span>
<a href="#l29.133"></a><span id="l29.133" class="difflineplus">+            let attr = &quot;image&quot; + this.imageSize;</span>
<a href="#l29.134"></a><span id="l29.134">             if (this.hasAttribute(attr))</span>
<a href="#l29.135"></a><span id="l29.135">               icon.setAttribute(&quot;src&quot;, this.getAttribute(attr));</span>
<a href="#l29.136"></a><span id="l29.136">           }</span>
<a href="#l29.137"></a><span id="l29.137">         ]]&gt;&lt;/body&gt;</span>
<a href="#l29.138"></a><span id="l29.138">       &lt;/method&gt;</span>
<a href="#l29.139"></a><span id="l29.139">     &lt;/implementation&gt;</span>
<a href="#l29.140"></a><span id="l29.140">     &lt;!-- Below, we want the name label to flex but not be any bigger than</span>
<a href="#l29.141"></a><span id="l29.141">          necessary, so add a spacer with a huge flex value. --&gt;</span>
<a href="#l29.142"></a><span id="l29.142" class="difflineat">@@ -460,17 +459,17 @@</span>
<a href="#l29.143"></a><span id="l29.143">       &lt;/xul:hbox&gt;</span>
<a href="#l29.144"></a><span id="l29.144">       &lt;xul:label class=&quot;moreIndicator&quot; onclick=&quot;this.parentNode.toggleWrap()&quot;</span>
<a href="#l29.145"></a><span id="l29.145">                  collapsed=&quot;true&quot; anonid=&quot;more&quot;/&gt;</span>
<a href="#l29.146"></a><span id="l29.146">     &lt;/content&gt;</span>
<a href="#l29.147"></a><span id="l29.147"> </span>
<a href="#l29.148"></a><span id="l29.148">     &lt;implementation&gt;</span>
<a href="#l29.149"></a><span id="l29.149">       &lt;constructor&gt;</span>
<a href="#l29.150"></a><span id="l29.150">         &lt;![CDATA[</span>
<a href="#l29.151"></a><span id="l29.151" class="difflineminus">-          this.mAddresses = new Array;</span>
<a href="#l29.152"></a><span id="l29.152" class="difflineplus">+          this.mAddresses = [];</span>
<a href="#l29.153"></a><span id="l29.153">           ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l29.154"></a><span id="l29.154">         ]]&gt;</span>
<a href="#l29.155"></a><span id="l29.155">       &lt;/constructor&gt;</span>
<a href="#l29.156"></a><span id="l29.156"> </span>
<a href="#l29.157"></a><span id="l29.157">       &lt;field name=&quot;mAddresses&quot;/&gt;</span>
<a href="#l29.158"></a><span id="l29.158"> </span>
<a href="#l29.159"></a><span id="l29.159">       &lt;!-- addAddressView: a public method used to add an address to this widget.</span>
<a href="#l29.160"></a><span id="l29.160">            aAddresses is an object with 3 properties: displayName, emailAddress and fullAddress</span>
<a href="#l29.161"></a><span id="l29.161" class="difflineat">@@ -515,23 +514,20 @@</span>
<a href="#l29.162"></a><span id="l29.162">             // property at all, so we skip in that case.  We get away with it</span>
<a href="#l29.163"></a><span id="l29.163">             // because there's no screen reader support on the Mac.</span>
<a href="#l29.164"></a><span id="l29.164">             if (&quot;labelElement&quot; in this) {</span>
<a href="#l29.165"></a><span id="l29.165">                 let ariaLabel = this.labelElement.value + &quot;: &quot; +</span>
<a href="#l29.166"></a><span id="l29.166">                                 (aAddress.fullAddress || aAddress.displayName || &quot;&quot;);</span>
<a href="#l29.167"></a><span id="l29.167">                 aEmailNode.setAttribute(&quot;aria-label&quot;, ariaLabel);</span>
<a href="#l29.168"></a><span id="l29.168">             }</span>
<a href="#l29.169"></a><span id="l29.169"> </span>
<a href="#l29.170"></a><span id="l29.170" class="difflineminus">-            try</span>
<a href="#l29.171"></a><span id="l29.171" class="difflineminus">-            {</span>
<a href="#l29.172"></a><span id="l29.172" class="difflineplus">+            try {</span>
<a href="#l29.173"></a><span id="l29.173">               if ((&quot;UpdateEmailNodeDetails&quot; in top) &amp;&amp; aAddress.emailAddress)</span>
<a href="#l29.174"></a><span id="l29.174">                 UpdateEmailNodeDetails(aAddress.emailAddress, aEmailNode);</span>
<a href="#l29.175"></a><span id="l29.175" class="difflineminus">-            }</span>
<a href="#l29.176"></a><span id="l29.176" class="difflineminus">-            catch(ex)</span>
<a href="#l29.177"></a><span id="l29.177" class="difflineminus">-            {</span>
<a href="#l29.178"></a><span id="l29.178" class="difflineplus">+            } catch (ex) {</span>
<a href="#l29.179"></a><span id="l29.179">               dump(&quot;UpdateEmailNodeDetails failed: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l29.180"></a><span id="l29.180">             }</span>
<a href="#l29.181"></a><span id="l29.181">           ]]&gt;</span>
<a href="#l29.182"></a><span id="l29.182">         &lt;/body&gt;</span>
<a href="#l29.183"></a><span id="l29.183">       &lt;/method&gt;</span>
<a href="#l29.184"></a><span id="l29.184"> </span>
<a href="#l29.185"></a><span id="l29.185">       &lt;!-- This field is used to buffer the width of the comma node so that</span>
<a href="#l29.186"></a><span id="l29.186">            it only has to be determined once during the lifetime of this</span>
<a href="#l29.187"></a><span id="l29.187" class="difflineat">@@ -567,34 +563,33 @@</span>
<a href="#l29.188"></a><span id="l29.188">             this.addNMore(this.mAddresses.length);</span>
<a href="#l29.189"></a><span id="l29.189">             var availableWidth = aAddressesNode.clientWidth;</span>
<a href="#l29.190"></a><span id="l29.190">             this.more.collapsed = true;</span>
<a href="#l29.191"></a><span id="l29.191"> </span>
<a href="#l29.192"></a><span id="l29.192">             // add addresses until we're done, or we overflow the allowed lines</span>
<a href="#l29.193"></a><span id="l29.193">             var i = 0;</span>
<a href="#l29.194"></a><span id="l29.194">             for (let curLine = 0, curLineWidth = 0;</span>
<a href="#l29.195"></a><span id="l29.195">                  i &lt; this.mAddresses.length &amp;&amp; (all || curLine &lt; this.maxLinesBeforeMore);</span>
<a href="#l29.196"></a><span id="l29.196" class="difflineminus">-                 i++)</span>
<a href="#l29.197"></a><span id="l29.197" class="difflineminus">-            {</span>
<a href="#l29.198"></a><span id="l29.198" class="difflineplus">+                 i++) {</span>
<a href="#l29.199"></a><span id="l29.199">               let newAddressNode;</span>
<a href="#l29.200"></a><span id="l29.200"> </span>
<a href="#l29.201"></a><span id="l29.201">               // First, add a comma as long as this isn't the first address.</span>
<a href="#l29.202"></a><span id="l29.202">               if (i &gt; 0) {</span>
<a href="#l29.203"></a><span id="l29.203" class="difflineminus">-                if (cached-- &gt; 0)</span>
<a href="#l29.204"></a><span id="l29.204" class="difflineminus">-                  aAddressesNode.childNodes[i*2 - 1].hidden = false;</span>
<a href="#l29.205"></a><span id="l29.205" class="difflineminus">-                else {</span>
<a href="#l29.206"></a><span id="l29.206" class="difflineplus">+                if (cached-- &gt; 0) {</span>
<a href="#l29.207"></a><span id="l29.207" class="difflineplus">+                  aAddressesNode.childNodes[i * 2 - 1].hidden = false;</span>
<a href="#l29.208"></a><span id="l29.208" class="difflineplus">+                } else {</span>
<a href="#l29.209"></a><span id="l29.209">                   this.appendComma();</span>
<a href="#l29.210"></a><span id="l29.210">                   if (this.commaNodeWidth == 0)</span>
<a href="#l29.211"></a><span id="l29.211">                     this.commaNodeWidth = this.emailAddresses.lastChild.clientWidth;</span>
<a href="#l29.212"></a><span id="l29.212">                 }</span>
<a href="#l29.213"></a><span id="l29.213">               }</span>
<a href="#l29.214"></a><span id="l29.214"> </span>
<a href="#l29.215"></a><span id="l29.215">               // Now add an email address.</span>
<a href="#l29.216"></a><span id="l29.216">               if (cached-- &gt; 0) {</span>
<a href="#l29.217"></a><span id="l29.217" class="difflineminus">-                newAddressNode = aAddressesNode.childNodes[i*2];</span>
<a href="#l29.218"></a><span id="l29.218" class="difflineplus">+                newAddressNode = aAddressesNode.childNodes[i * 2];</span>
<a href="#l29.219"></a><span id="l29.219">                 newAddressNode.hidden = false;</span>
<a href="#l29.220"></a><span id="l29.220">               } else {</span>
<a href="#l29.221"></a><span id="l29.221">                 newAddressNode = document.createElement(&quot;mail-emailaddress&quot;);</span>
<a href="#l29.222"></a><span id="l29.222"> </span>
<a href="#l29.223"></a><span id="l29.223">                 // Stash the headerName somewhere that UpdateEmailNodeDetails</span>
<a href="#l29.224"></a><span id="l29.224">                 // will be able to find it.</span>
<a href="#l29.225"></a><span id="l29.225">                 newAddressNode.setAttribute(&quot;headerName&quot;, this.headerName);</span>
<a href="#l29.226"></a><span id="l29.226"> </span>
<a href="#l29.227"></a><span id="l29.227" class="difflineat">@@ -605,48 +600,48 @@</span>
<a href="#l29.228"></a><span id="l29.228">               // Reading .clientWidth triggers an expensive reflow, so only</span>
<a href="#l29.229"></a><span id="l29.229">               // do it when necessary for possible early loop exit to display</span>
<a href="#l29.230"></a><span id="l29.230">               // (X more).</span>
<a href="#l29.231"></a><span id="l29.231">               if (!all) {</span>
<a href="#l29.232"></a><span id="l29.232"> </span>
<a href="#l29.233"></a><span id="l29.233">                 // Calculate width and lines, consider the i+1 comma node if we have to</span>
<a href="#l29.234"></a><span id="l29.234">                 // &lt;http://www.w3.org/TR/cssom-view/#client-attributes&gt;</span>
<a href="#l29.235"></a><span id="l29.235">                 // &lt;https://developer.mozilla.org/en/Determining_the_dimensions_of_elements&gt;</span>
<a href="#l29.236"></a><span id="l29.236" class="difflineminus">-                let newLineWidth = i+1 &lt; this.mAddresses.length ?</span>
<a href="#l29.237"></a><span id="l29.237" class="difflineminus">-                                   newAddressNode.clientWidth + this.commaNodeWidth:</span>
<a href="#l29.238"></a><span id="l29.238" class="difflineplus">+                let newLineWidth = i + 1 &lt; this.mAddresses.length ?</span>
<a href="#l29.239"></a><span id="l29.239" class="difflineplus">+                                   newAddressNode.clientWidth + this.commaNodeWidth :</span>
<a href="#l29.240"></a><span id="l29.240">                                    newAddressNode.clientWidth;</span>
<a href="#l29.241"></a><span id="l29.241">                 curLineWidth += newLineWidth;</span>
<a href="#l29.242"></a><span id="l29.242"> </span>
<a href="#l29.243"></a><span id="l29.243">                 let overLineWidth = curLineWidth - availableWidth;</span>
<a href="#l29.244"></a><span id="l29.244">                 if (overLineWidth &gt; 0 &amp;&amp; i &gt; 0) {</span>
<a href="#l29.245"></a><span id="l29.245">                   curLine++;</span>
<a href="#l29.246"></a><span id="l29.246">                   curLineWidth = newLineWidth;</span>
<a href="#l29.247"></a><span id="l29.247">                 }</span>
<a href="#l29.248"></a><span id="l29.248"> </span>
<a href="#l29.249"></a><span id="l29.249">                 // hide the last node spanning into the additional line (n&gt;1)</span>
<a href="#l29.250"></a><span id="l29.250">                 // also hide it if &lt;30px left after sliding the address (n=1)</span>
<a href="#l29.251"></a><span id="l29.251">                 // or if the last address would be truncated without &quot;more&quot;</span>
<a href="#l29.252"></a><span id="l29.252">                 if (curLine &gt;= this.maxLinesBeforeMore &amp;&amp;</span>
<a href="#l29.253"></a><span id="l29.253">                     (this.maxLinesBeforeMore &gt; 1 ||</span>
<a href="#l29.254"></a><span id="l29.254" class="difflineminus">-                     (i+1 == this.mAddresses.length &amp;&amp; overLineWidth &gt; 30) ||</span>
<a href="#l29.255"></a><span id="l29.255" class="difflineplus">+                     (i + 1 == this.mAddresses.length &amp;&amp; overLineWidth &gt; 30) ||</span>
<a href="#l29.256"></a><span id="l29.256">                      newLineWidth - overLineWidth &lt; 30)) {</span>
<a href="#l29.257"></a><span id="l29.257">                   aAddressesNode.lastChild.hidden = true;</span>
<a href="#l29.258"></a><span id="l29.258">                   i--;</span>
<a href="#l29.259"></a><span id="l29.259">                 }</span>
<a href="#l29.260"></a><span id="l29.260">               }</span>
<a href="#l29.261"></a><span id="l29.261">             }</span>
<a href="#l29.262"></a><span id="l29.262"> </span>
<a href="#l29.263"></a><span id="l29.263">             // Update maxAddressesBeforeMore if we exceed the current cache</span>
<a href="#l29.264"></a><span id="l29.264">             // estimate, but only if we aren't supposed to show all addresses.</span>
<a href="#l29.265"></a><span id="l29.265">             if (!all &amp;&amp; this.maxAddressesBeforeMore &lt; i)</span>
<a href="#l29.266"></a><span id="l29.266">               this.maxAddressesBeforeMore = i;</span>
<a href="#l29.267"></a><span id="l29.267"> </span>
<a href="#l29.268"></a><span id="l29.268">             // Hide any extra nodes but keep them around for later.</span>
<a href="#l29.269"></a><span id="l29.269">             cached = aAddressesNode.childNodes.length;</span>
<a href="#l29.270"></a><span id="l29.270" class="difflineminus">-            for (let j = Math.max(i*2 - 1, 0); j &lt; cached; j++) {</span>
<a href="#l29.271"></a><span id="l29.271" class="difflineplus">+            for (let j = Math.max(i * 2 - 1, 0); j &lt; cached; j++) {</span>
<a href="#l29.272"></a><span id="l29.272">               aAddressesNode.childNodes[j].hidden = true;</span>
<a href="#l29.273"></a><span id="l29.273">             }</span>
<a href="#l29.274"></a><span id="l29.274"> </span>
<a href="#l29.275"></a><span id="l29.275">             // If we're not required to show all addresses, and there are still</span>
<a href="#l29.276"></a><span id="l29.276">             // addresses remaining, add an (N more) widget.</span>
<a href="#l29.277"></a><span id="l29.277">             if (!all) {</span>
<a href="#l29.278"></a><span id="l29.278">               let remainingAddresses = this.mAddresses.length - i;</span>
<a href="#l29.279"></a><span id="l29.279">               if (remainingAddresses &gt; 0) {</span>
<a href="#l29.280"></a><span id="l29.280" class="difflineat">@@ -660,22 +655,31 @@</span>
<a href="#l29.281"></a><span id="l29.281">               }</span>
<a href="#l29.282"></a><span id="l29.282">             }</span>
<a href="#l29.283"></a><span id="l29.283"> </span>
<a href="#l29.284"></a><span id="l29.284">             return i; // number of addresses shown</span>
<a href="#l29.285"></a><span id="l29.285">           ]]&gt;</span>
<a href="#l29.286"></a><span id="l29.286">         &lt;/body&gt;</span>
<a href="#l29.287"></a><span id="l29.287">       &lt;/method&gt;</span>
<a href="#l29.288"></a><span id="l29.288"> </span>
<a href="#l29.289"></a><span id="l29.289" class="difflineminus">-      &lt;property name=&quot;emailAddresses&quot; onget=&quot;return document.getAnonymousElementByAttribute(this, 'anonid', 'emailAddresses');&quot;</span>
<a href="#l29.290"></a><span id="l29.290" class="difflineminus">-        readonly=&quot;true&quot;/&gt;</span>
<a href="#l29.291"></a><span id="l29.291" class="difflineminus">-      &lt;property name=&quot;longEmailAddresses&quot; onget=&quot;return document.getAnonymousElementByAttribute(this, 'anonid', 'longEmailAddresses');&quot;</span>
<a href="#l29.292"></a><span id="l29.292" class="difflineminus">-        readonly=&quot;true&quot;/&gt;</span>
<a href="#l29.293"></a><span id="l29.293" class="difflineminus">-      &lt;property name=&quot;more&quot; onget=&quot;return document.getAnonymousElementByAttribute(this, 'anonid', 'more')&quot;</span>
<a href="#l29.294"></a><span id="l29.294" class="difflineminus">-        readonly=&quot;true&quot;/&gt;</span>
<a href="#l29.295"></a><span id="l29.295" class="difflineplus">+      &lt;property name=&quot;emailAddresses&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l29.296"></a><span id="l29.296" class="difflineplus">+        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l29.297"></a><span id="l29.297" class="difflineplus">+          return document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;emailAddresses&quot;);</span>
<a href="#l29.298"></a><span id="l29.298" class="difflineplus">+        ]]&gt;&lt;/getter&gt;</span>
<a href="#l29.299"></a><span id="l29.299" class="difflineplus">+      &lt;/property&gt;</span>
<a href="#l29.300"></a><span id="l29.300" class="difflineplus">+      &lt;property name=&quot;longEmailAddresses&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l29.301"></a><span id="l29.301" class="difflineplus">+        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l29.302"></a><span id="l29.302" class="difflineplus">+          return document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;longEmailAddresses&quot;);</span>
<a href="#l29.303"></a><span id="l29.303" class="difflineplus">+        ]]&gt;&lt;/getter&gt;</span>
<a href="#l29.304"></a><span id="l29.304" class="difflineplus">+      &lt;/property&gt;</span>
<a href="#l29.305"></a><span id="l29.305" class="difflineplus">+      &lt;property name=&quot;more&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l29.306"></a><span id="l29.306" class="difflineplus">+        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l29.307"></a><span id="l29.307" class="difflineplus">+          return document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;more&quot;);</span>
<a href="#l29.308"></a><span id="l29.308" class="difflineplus">+        ]]&gt;&lt;/getter&gt;</span>
<a href="#l29.309"></a><span id="l29.309" class="difflineplus">+      &lt;/property&gt;</span>
<a href="#l29.310"></a><span id="l29.310"> </span>
<a href="#l29.311"></a><span id="l29.311">       &lt;!-- The number of lines of addresses we will display before adding a</span>
<a href="#l29.312"></a><span id="l29.312">            (more) indicator to the widget. This can be increased using the</span>
<a href="#l29.313"></a><span id="l29.313">            preference mailnews.headers.show_n_lines_before_more . --&gt;</span>
<a href="#l29.314"></a><span id="l29.314">       &lt;field name=&quot;maxLinesBeforeMore&quot;&gt;1&lt;/field&gt;</span>
<a href="#l29.315"></a><span id="l29.315"> </span>
<a href="#l29.316"></a><span id="l29.316">       &lt;!-- The number addresses which did fit up to now before the (more)</span>
<a href="#l29.317"></a><span id="l29.317">            indicator became necessary to be added. This determines how many</span>
<a href="#l29.318"></a><span id="l29.318" class="difflineat">@@ -693,18 +697,17 @@</span>
<a href="#l29.319"></a><span id="l29.319">             this.maxLinesBeforeMore = Services.prefs.getIntPref(</span>
<a href="#l29.320"></a><span id="l29.320">               &quot;mailnews.headers.show_n_lines_before_more&quot;);</span>
<a href="#l29.321"></a><span id="l29.321">             const dt = Ci.nsMimeHeaderDisplayTypes;</span>
<a href="#l29.322"></a><span id="l29.322">             let headerchoice = Services.prefs.getIntPref(&quot;mail.show_headers&quot;);</span>
<a href="#l29.323"></a><span id="l29.323">             if (this.maxLinesBeforeMore &lt; 1 ||</span>
<a href="#l29.324"></a><span id="l29.324">                 headerchoice == dt.AllHeaders) {</span>
<a href="#l29.325"></a><span id="l29.325">               this.fillAddressesNode(this.emailAddresses, true);</span>
<a href="#l29.326"></a><span id="l29.326">               this.longEmailAddresses.removeAttribute(&quot;singleline&quot;);</span>
<a href="#l29.327"></a><span id="l29.327" class="difflineminus">-            }</span>
<a href="#l29.328"></a><span id="l29.328" class="difflineminus">-            else {</span>
<a href="#l29.329"></a><span id="l29.329" class="difflineplus">+            } else {</span>
<a href="#l29.330"></a><span id="l29.330">               this.fillAddressesNode(this.emailAddresses, false);</span>
<a href="#l29.331"></a><span id="l29.331">               // force a single line only in the default n=1 case</span>
<a href="#l29.332"></a><span id="l29.332">               if (this.maxLinesBeforeMore &gt; 1)</span>
<a href="#l29.333"></a><span id="l29.333">                 this.longEmailAddresses.removeAttribute(&quot;singleline&quot;);</span>
<a href="#l29.334"></a><span id="l29.334">             }</span>
<a href="#l29.335"></a><span id="l29.335">           ]]&gt;</span>
<a href="#l29.336"></a><span id="l29.336">         &lt;/body&gt;</span>
<a href="#l29.337"></a><span id="l29.337">       &lt;/method&gt;</span>
<a href="#l29.338"></a><span id="l29.338" class="difflineat">@@ -811,17 +814,17 @@</span>
<a href="#l29.339"></a><span id="l29.339">           &lt;![CDATA[</span>
<a href="#l29.340"></a><span id="l29.340">             // Workaround the fact that XUL line-wrapping and &quot;overflow: auto&quot;</span>
<a href="#l29.341"></a><span id="l29.341">             // don't interact properly (bug 492645), without which we</span>
<a href="#l29.342"></a><span id="l29.342">             // would be inadvertently occluding too much of the message header</span>
<a href="#l29.343"></a><span id="l29.343">             // text and forcing the user to scroll unnecessarily (bug 525225).</span>
<a href="#l29.344"></a><span id="l29.344">             //</span>
<a href="#l29.345"></a><span id="l29.345">             // Fake the &quot;All Headers&quot; mode, so that we get a scroll bar</span>
<a href="#l29.346"></a><span id="l29.346">             // Will be reset when a new message loads</span>
<a href="#l29.347"></a><span id="l29.347" class="difflineminus">-            document.getElementById(&quot;expandedHeaderView&quot;).setAttribute(&quot;show_header_mode&quot;,&quot;all&quot;);</span>
<a href="#l29.348"></a><span id="l29.348" class="difflineplus">+            document.getElementById(&quot;expandedHeaderView&quot;).setAttribute(&quot;show_header_mode&quot;, &quot;all&quot;);</span>
<a href="#l29.349"></a><span id="l29.349"> </span>
<a href="#l29.350"></a><span id="l29.350">             // Causes different CSS selectors to be used, which allows all</span>
<a href="#l29.351"></a><span id="l29.351">             // of the addresses to be properly displayed and wrapped.</span>
<a href="#l29.352"></a><span id="l29.352">             this.longEmailAddresses.removeAttribute(&quot;singleline&quot;);</span>
<a href="#l29.353"></a><span id="l29.353"> </span>
<a href="#l29.354"></a><span id="l29.354">             this.clearChildNodes(this.emailAddresses);</span>
<a href="#l29.355"></a><span id="l29.355"> </span>
<a href="#l29.356"></a><span id="l29.356">             // Re-render the node, this time with all the addresses.</span>
<a href="#l29.357"></a><span id="l29.357" class="difflineat">@@ -841,30 +844,29 @@</span>
<a href="#l29.358"></a><span id="l29.358">           &lt;![CDATA[</span>
<a href="#l29.359"></a><span id="l29.359">             this.more.collapsed = true;</span>
<a href="#l29.360"></a><span id="l29.360"> </span>
<a href="#l29.361"></a><span id="l29.361">             // We want to keep around the first maxAddressesBeforeMore email</span>
<a href="#l29.362"></a><span id="l29.362">             // address nodes as well as any intervening comma nodes.</span>
<a href="#l29.363"></a><span id="l29.363">             var numItemsToPreserve = this.maxAddressesBeforeMore * 2 - 1;</span>
<a href="#l29.364"></a><span id="l29.364">             var numItemsInNode = aParentNode.childNodes.length;</span>
<a href="#l29.365"></a><span id="l29.365"> </span>
<a href="#l29.366"></a><span id="l29.366" class="difflineminus">-            while (numItemsInNode &amp;&amp; (numItemsInNode &gt; numItemsToPreserve))</span>
<a href="#l29.367"></a><span id="l29.367" class="difflineminus">-            {</span>
<a href="#l29.368"></a><span id="l29.368" class="difflineplus">+            while (numItemsInNode &amp;&amp; (numItemsInNode &gt; numItemsToPreserve)) {</span>
<a href="#l29.369"></a><span id="l29.369">               aParentNode.lastChild.remove();</span>
<a href="#l29.370"></a><span id="l29.370">               numItemsInNode--;</span>
<a href="#l29.371"></a><span id="l29.371">             }</span>
<a href="#l29.372"></a><span id="l29.372">           ]]&gt;</span>
<a href="#l29.373"></a><span id="l29.373">         &lt;/body&gt;</span>
<a href="#l29.374"></a><span id="l29.374">       &lt;/method&gt;</span>
<a href="#l29.375"></a><span id="l29.375"> </span>
<a href="#l29.376"></a><span id="l29.376">       &lt;method name=&quot;clearHeaderValues&quot;&gt;</span>
<a href="#l29.377"></a><span id="l29.377">         &lt;body&gt;</span>
<a href="#l29.378"></a><span id="l29.378">           &lt;![CDATA[</span>
<a href="#l29.379"></a><span id="l29.379">             // clear out our local state</span>
<a href="#l29.380"></a><span id="l29.380" class="difflineminus">-            this.mAddresses = new Array;</span>
<a href="#l29.381"></a><span id="l29.381" class="difflineplus">+            this.mAddresses = [];</span>
<a href="#l29.382"></a><span id="l29.382">             this.longEmailAddresses.setAttribute(&quot;singleline&quot;, &quot;true&quot;);</span>
<a href="#l29.383"></a><span id="l29.383">             // remove anything inside of each of our labels....</span>
<a href="#l29.384"></a><span id="l29.384">             this.clearChildNodes(this.emailAddresses);</span>
<a href="#l29.385"></a><span id="l29.385">           ]]&gt;</span>
<a href="#l29.386"></a><span id="l29.386">         &lt;/body&gt;</span>
<a href="#l29.387"></a><span id="l29.387">       &lt;/method&gt;</span>
<a href="#l29.388"></a><span id="l29.388">     &lt;/implementation&gt;</span>
<a href="#l29.389"></a><span id="l29.389">   &lt;/binding&gt;</span>
<a href="#l29.390"></a><span id="l29.390" class="difflineat">@@ -883,20 +885,26 @@</span>
<a href="#l29.391"></a><span id="l29.391">     &lt;implementation&gt;</span>
<a href="#l29.392"></a><span id="l29.392">       &lt;constructor&gt;</span>
<a href="#l29.393"></a><span id="l29.393">         &lt;![CDATA[</span>
<a href="#l29.394"></a><span id="l29.394">           this.mMessageIds = [];</span>
<a href="#l29.395"></a><span id="l29.395">           this.showFullMessageIds = false;</span>
<a href="#l29.396"></a><span id="l29.396">         ]]&gt;</span>
<a href="#l29.397"></a><span id="l29.397">       &lt;/constructor&gt;</span>
<a href="#l29.398"></a><span id="l29.398"> </span>
<a href="#l29.399"></a><span id="l29.399" class="difflineminus">-      &lt;property name=&quot;headerValue&quot; readonly=&quot;true&quot;</span>
<a href="#l29.400"></a><span id="l29.400" class="difflineminus">-                onget=&quot;return document.getAnonymousElementByAttribute(this, 'anonid', 'headerValue');&quot;/&gt;</span>
<a href="#l29.401"></a><span id="l29.401" class="difflineminus">-      &lt;property name=&quot;toggleIcon&quot; readonly=&quot;true&quot;</span>
<a href="#l29.402"></a><span id="l29.402" class="difflineminus">-                onget=&quot;return document.getAnonymousElementByAttribute(this, 'anonid', 'toggleIcon');&quot;/&gt;</span>
<a href="#l29.403"></a><span id="l29.403" class="difflineplus">+      &lt;property name=&quot;headerValue&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l29.404"></a><span id="l29.404" class="difflineplus">+        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l29.405"></a><span id="l29.405" class="difflineplus">+          return document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;headerValue&quot;);</span>
<a href="#l29.406"></a><span id="l29.406" class="difflineplus">+        ]]&gt;&lt;/getter&gt;</span>
<a href="#l29.407"></a><span id="l29.407" class="difflineplus">+      &lt;/property&gt;</span>
<a href="#l29.408"></a><span id="l29.408" class="difflineplus">+      &lt;property name=&quot;toggleIcon&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l29.409"></a><span id="l29.409" class="difflineplus">+        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l29.410"></a><span id="l29.410" class="difflineplus">+          return document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;toggleIcon&quot;);</span>
<a href="#l29.411"></a><span id="l29.411" class="difflineplus">+        ]]&gt;&lt;/getter&gt;</span>
<a href="#l29.412"></a><span id="l29.412" class="difflineplus">+      &lt;/property&gt;</span>
<a href="#l29.413"></a><span id="l29.413"> </span>
<a href="#l29.414"></a><span id="l29.414">       &lt;field name=&quot;mMessageIds&quot;/&gt;</span>
<a href="#l29.415"></a><span id="l29.415"> </span>
<a href="#l29.416"></a><span id="l29.416">       &lt;!-- addMessageIdView: a public method used to add a message-id to this widget. --&gt;</span>
<a href="#l29.417"></a><span id="l29.417">       &lt;method name=&quot;addMessageIdView&quot;&gt;</span>
<a href="#l29.418"></a><span id="l29.418">         &lt;parameter name=&quot;aMessageId&quot;/&gt;</span>
<a href="#l29.419"></a><span id="l29.419">         &lt;body&gt;</span>
<a href="#l29.420"></a><span id="l29.420">           &lt;![CDATA[</span>
<a href="#l29.421"></a><span id="l29.421" class="difflineat">@@ -910,59 +918,50 @@</span>
<a href="#l29.422"></a><span id="l29.422">         &lt;parameter name=&quot;aMessageIdNode&quot;/&gt;</span>
<a href="#l29.423"></a><span id="l29.423">         &lt;parameter name=&quot;aIndex&quot;/&gt;</span>
<a href="#l29.424"></a><span id="l29.424">         &lt;parameter name=&quot;aMessageId&quot;/&gt;</span>
<a href="#l29.425"></a><span id="l29.425">         &lt;parameter name=&quot;aLastId&quot;/&gt;</span>
<a href="#l29.426"></a><span id="l29.426">         &lt;body&gt;</span>
<a href="#l29.427"></a><span id="l29.427">           &lt;![CDATA[</span>
<a href="#l29.428"></a><span id="l29.428">             var showFullMessageIds = this.showFullMessageIds;</span>
<a href="#l29.429"></a><span id="l29.429"> </span>
<a href="#l29.430"></a><span id="l29.430" class="difflineminus">-            if (showFullMessageIds || aIndex == aLastId)</span>
<a href="#l29.431"></a><span id="l29.431" class="difflineminus">-            {</span>
<a href="#l29.432"></a><span id="l29.432" class="difflineplus">+            if (showFullMessageIds || aIndex == aLastId) {</span>
<a href="#l29.433"></a><span id="l29.433">               aMessageIdNode.setAttribute(&quot;label&quot;, aMessageId);</span>
<a href="#l29.434"></a><span id="l29.434">               aMessageIdNode.removeAttribute(&quot;tooltiptext&quot;);</span>
<a href="#l29.435"></a><span id="l29.435" class="difflineminus">-            }</span>
<a href="#l29.436"></a><span id="l29.436" class="difflineminus">-            else</span>
<a href="#l29.437"></a><span id="l29.437" class="difflineminus">-            {</span>
<a href="#l29.438"></a><span id="l29.438" class="difflineplus">+            } else {</span>
<a href="#l29.439"></a><span id="l29.439">               aMessageIdNode.setAttribute(&quot;label&quot;, aIndex);</span>
<a href="#l29.440"></a><span id="l29.440">               aMessageIdNode.setAttribute(&quot;tooltiptext&quot;, aMessageId);</span>
<a href="#l29.441"></a><span id="l29.441">             }</span>
<a href="#l29.442"></a><span id="l29.442"> </span>
<a href="#l29.443"></a><span id="l29.443">             aMessageIdNode.setAttribute(&quot;index&quot;, aIndex);</span>
<a href="#l29.444"></a><span id="l29.444">             aMessageIdNode.setAttribute(&quot;messageid&quot;, aMessageId);</span>
<a href="#l29.445"></a><span id="l29.445">           ]]&gt;</span>
<a href="#l29.446"></a><span id="l29.446">         &lt;/body&gt;</span>
<a href="#l29.447"></a><span id="l29.447">       &lt;/method&gt;</span>
<a href="#l29.448"></a><span id="l29.448"> </span>
<a href="#l29.449"></a><span id="l29.449">       &lt;method name=&quot;fillMessageIdNodes&quot;&gt;</span>
<a href="#l29.450"></a><span id="l29.450">         &lt;body&gt;</span>
<a href="#l29.451"></a><span id="l29.451">           &lt;![CDATA[</span>
<a href="#l29.452"></a><span id="l29.452">             var headerValue    = this.headerValue;</span>
<a href="#l29.453"></a><span id="l29.453">             var messageIdNodes = headerValue.childNodes;</span>
<a href="#l29.454"></a><span id="l29.454">             var numMessageIds  = this.mMessageIds.length;</span>
<a href="#l29.455"></a><span id="l29.455" class="difflineminus">-            var index = 0;</span>
<a href="#l29.456"></a><span id="l29.456"> </span>
<a href="#l29.457"></a><span id="l29.457">             while (messageIdNodes.length &gt; numMessageIds * 2 - 1)</span>
<a href="#l29.458"></a><span id="l29.458">               headerValue.lastChild.remove();</span>
<a href="#l29.459"></a><span id="l29.459"> </span>
<a href="#l29.460"></a><span id="l29.460">             this.toggleIcon.hidden = numMessageIds &lt;= 1;</span>
<a href="#l29.461"></a><span id="l29.461"> </span>
<a href="#l29.462"></a><span id="l29.462" class="difflineminus">-            for (var index = 0; index &lt; numMessageIds; index++)</span>
<a href="#l29.463"></a><span id="l29.463" class="difflineminus">-            {</span>
<a href="#l29.464"></a><span id="l29.464" class="difflineminus">-              if (index * 2 &lt;= messageIdNodes.length - 1)</span>
<a href="#l29.465"></a><span id="l29.465" class="difflineminus">-              {</span>
<a href="#l29.466"></a><span id="l29.466" class="difflineplus">+            for (var index = 0; index &lt; numMessageIds; index++) {</span>
<a href="#l29.467"></a><span id="l29.467" class="difflineplus">+              if (index * 2 &lt;= messageIdNodes.length - 1) {</span>
<a href="#l29.468"></a><span id="l29.468">                 this.updateMessageIdNode(messageIdNodes[index * 2], index + 1,</span>
<a href="#l29.469"></a><span id="l29.469">                                          this.mMessageIds[index], numMessageIds);</span>
<a href="#l29.470"></a><span id="l29.470" class="difflineminus">-              }</span>
<a href="#l29.471"></a><span id="l29.471" class="difflineminus">-              else</span>
<a href="#l29.472"></a><span id="l29.472" class="difflineminus">-              {</span>
<a href="#l29.473"></a><span id="l29.473" class="difflineplus">+              } else {</span>
<a href="#l29.474"></a><span id="l29.474">                 var newMessageIdNode = document.createElement(&quot;mail-messageid&quot;);</span>
<a href="#l29.475"></a><span id="l29.475"> </span>
<a href="#l29.476"></a><span id="l29.476" class="difflineminus">-                if (index)</span>
<a href="#l29.477"></a><span id="l29.477" class="difflineminus">-                {</span>
<a href="#l29.478"></a><span id="l29.478" class="difflineplus">+                if (index &gt; 0) {</span>
<a href="#l29.479"></a><span id="l29.479">                   var textNode = document.createElement(&quot;text&quot;);</span>
<a href="#l29.480"></a><span id="l29.480">                   textNode.setAttribute(&quot;value&quot;, &quot;, &quot;);</span>
<a href="#l29.481"></a><span id="l29.481">                   textNode.setAttribute(&quot;class&quot;, &quot;messageIdSeparator&quot;);</span>
<a href="#l29.482"></a><span id="l29.482">                   headerValue.appendChild(textNode);</span>
<a href="#l29.483"></a><span id="l29.483">                 }</span>
<a href="#l29.484"></a><span id="l29.484">                 var itemInDocument = headerValue.appendChild(newMessageIdNode);</span>
<a href="#l29.485"></a><span id="l29.485">                 this.updateMessageIdNode(itemInDocument, index + 1,</span>
<a href="#l29.486"></a><span id="l29.486">                                          this.mMessageIds[index], numMessageIds);</span>
<a href="#l29.487"></a><span id="l29.487" class="difflineat">@@ -973,46 +972,42 @@</span>
<a href="#l29.488"></a><span id="l29.488">       &lt;/method&gt;</span>
<a href="#l29.489"></a><span id="l29.489"> </span>
<a href="#l29.490"></a><span id="l29.490">       &lt;method name=&quot;toggleWrap&quot;&gt;</span>
<a href="#l29.491"></a><span id="l29.491">         &lt;body&gt;</span>
<a href="#l29.492"></a><span id="l29.492">           &lt;![CDATA[</span>
<a href="#l29.493"></a><span id="l29.493">             var headerValue        = this.headerValue;</span>
<a href="#l29.494"></a><span id="l29.494">             var messageIdNodes     = headerValue.childNodes;</span>
<a href="#l29.495"></a><span id="l29.495">             var showFullMessageIds = !this.showFullMessageIds;</span>
<a href="#l29.496"></a><span id="l29.496" class="difflineminus">-            var messageIds         = this.mMessageIds</span>
<a href="#l29.497"></a><span id="l29.497" class="difflineplus">+            var messageIds         = this.mMessageIds;</span>
<a href="#l29.498"></a><span id="l29.498"> </span>
<a href="#l29.499"></a><span id="l29.499" class="difflineminus">-            for (var i = 0; i &lt; messageIdNodes.length; i += 2)</span>
<a href="#l29.500"></a><span id="l29.500" class="difflineminus">-            {</span>
<a href="#l29.501"></a><span id="l29.501" class="difflineminus">-              if (showFullMessageIds)</span>
<a href="#l29.502"></a><span id="l29.502" class="difflineminus">-              {</span>
<a href="#l29.503"></a><span id="l29.503" class="difflineplus">+            for (var i = 0; i &lt; messageIdNodes.length; i += 2) {</span>
<a href="#l29.504"></a><span id="l29.504" class="difflineplus">+              if (showFullMessageIds) {</span>
<a href="#l29.505"></a><span id="l29.505">                 this.toggleIcon.setAttribute(&quot;open&quot;, &quot;true&quot;);</span>
<a href="#l29.506"></a><span id="l29.506">                 messageIdNodes[i].setAttribute(&quot;label&quot;, messageIds[i / 2]);</span>
<a href="#l29.507"></a><span id="l29.507">                 messageIdNodes[i].removeAttribute(&quot;tooltiptext&quot;);</span>
<a href="#l29.508"></a><span id="l29.508">                 headerValue.removeAttribute(&quot;singleline&quot;);</span>
<a href="#l29.509"></a><span id="l29.509" class="difflineminus">-              } else</span>
<a href="#l29.510"></a><span id="l29.510" class="difflineminus">-              {</span>
<a href="#l29.511"></a><span id="l29.511" class="difflineplus">+              } else {</span>
<a href="#l29.512"></a><span id="l29.512">                 this.toggleIcon.removeAttribute(&quot;open&quot;);</span>
<a href="#l29.513"></a><span id="l29.513">                 messageIdNodes[i].setAttribute(&quot;label&quot;, i / 2 + 1);</span>
<a href="#l29.514"></a><span id="l29.514">                 messageIdNodes[i].setAttribute(&quot;tooltiptext&quot;, messageIds[i / 2]);</span>
<a href="#l29.515"></a><span id="l29.515">               }</span>
<a href="#l29.516"></a><span id="l29.516">             }</span>
<a href="#l29.517"></a><span id="l29.517"> </span>
<a href="#l29.518"></a><span id="l29.518">             this.showFullMessageIds = showFullMessageIds;</span>
<a href="#l29.519"></a><span id="l29.519">           ]]&gt;</span>
<a href="#l29.520"></a><span id="l29.520">         &lt;/body&gt;</span>
<a href="#l29.521"></a><span id="l29.521">       &lt;/method&gt;</span>
<a href="#l29.522"></a><span id="l29.522"> </span>
<a href="#l29.523"></a><span id="l29.523">       &lt;method name=&quot;clearHeaderValues&quot;&gt;</span>
<a href="#l29.524"></a><span id="l29.524">         &lt;body&gt;</span>
<a href="#l29.525"></a><span id="l29.525">           &lt;![CDATA[</span>
<a href="#l29.526"></a><span id="l29.526">             // clear out our local state</span>
<a href="#l29.527"></a><span id="l29.527" class="difflineminus">-            this.mMessageIds = new Array;</span>
<a href="#l29.528"></a><span id="l29.528" class="difflineminus">-            if (this.showFullMessageIds)</span>
<a href="#l29.529"></a><span id="l29.529" class="difflineminus">-            {</span>
<a href="#l29.530"></a><span id="l29.530" class="difflineplus">+            this.mMessageIds = [];</span>
<a href="#l29.531"></a><span id="l29.531" class="difflineplus">+            if (this.showFullMessageIds) {</span>
<a href="#l29.532"></a><span id="l29.532">               this.showFullMessageIds = false;</span>
<a href="#l29.533"></a><span id="l29.533">               this.toggleIcon.removeAttribute(&quot;open&quot;);</span>
<a href="#l29.534"></a><span id="l29.534">             }</span>
<a href="#l29.535"></a><span id="l29.535">           ]]&gt;</span>
<a href="#l29.536"></a><span id="l29.536">         &lt;/body&gt;</span>
<a href="#l29.537"></a><span id="l29.537">       &lt;/method&gt;</span>
<a href="#l29.538"></a><span id="l29.538">     &lt;/implementation&gt;</span>
<a href="#l29.539"></a><span id="l29.539">   &lt;/binding&gt;</span>
<a href="#l29.540"></a><span id="l29.540" class="difflineat">@@ -1024,31 +1019,31 @@</span>
<a href="#l29.541"></a><span id="l29.541">       &lt;/xul:menulist&gt;</span>
<a href="#l29.542"></a><span id="l29.542">     &lt;/content&gt;</span>
<a href="#l29.543"></a><span id="l29.543"> </span>
<a href="#l29.544"></a><span id="l29.544">     &lt;implementation&gt;</span>
<a href="#l29.545"></a><span id="l29.545">       &lt;field name=&quot;internalScope&quot;&gt;null&lt;/field&gt;</span>
<a href="#l29.546"></a><span id="l29.546">       &lt;field name=&quot;internalValue&quot;&gt;-1&lt;/field&gt;</span>
<a href="#l29.547"></a><span id="l29.547">       &lt;field readonly=&quot;true&quot; name=&quot;validityManager&quot;&gt;</span>
<a href="#l29.548"></a><span id="l29.548">         &lt;![CDATA[</span>
<a href="#l29.549"></a><span id="l29.549" class="difflineminus">-           Cc['@mozilla.org/mail/search/validityManager;1'].getService(Ci.nsIMsgSearchValidityManager);</span>
<a href="#l29.550"></a><span id="l29.550" class="difflineplus">+           Cc[&quot;@mozilla.org/mail/search/validityManager;1&quot;].getService(Ci.nsIMsgSearchValidityManager);</span>
<a href="#l29.551"></a><span id="l29.551">         ]]&gt;</span>
<a href="#l29.552"></a><span id="l29.552">       &lt;/field&gt;</span>
<a href="#l29.553"></a><span id="l29.553">       &lt;property name=&quot;searchScope&quot; onget=&quot;return this.internalScope;&quot;&gt;</span>
<a href="#l29.554"></a><span id="l29.554">         &lt;!-- scope ID - retrieve the table --&gt;</span>
<a href="#l29.555"></a><span id="l29.555">         &lt;setter&gt;</span>
<a href="#l29.556"></a><span id="l29.556">           &lt;![CDATA[</span>
<a href="#l29.557"></a><span id="l29.557">             // if scope isn't changing this is a noop</span>
<a href="#l29.558"></a><span id="l29.558">             if (this.internalScope == val) return val;</span>
<a href="#l29.559"></a><span id="l29.559"> </span>
<a href="#l29.560"></a><span id="l29.560">             this.internalScope = val;</span>
<a href="#l29.561"></a><span id="l29.561">             this.refreshList();</span>
<a href="#l29.562"></a><span id="l29.562">             var targets = this.targets;</span>
<a href="#l29.563"></a><span id="l29.563">             if (targets) {</span>
<a href="#l29.564"></a><span id="l29.564" class="difflineminus">-              for (var i=0; i&lt; targets.length; i++) {</span>
<a href="#l29.565"></a><span id="l29.565" class="difflineplus">+              for (var i = 0; i &lt; targets.length; i++) {</span>
<a href="#l29.566"></a><span id="l29.566">                 targets[i].searchScope = val;</span>
<a href="#l29.567"></a><span id="l29.567">               }</span>
<a href="#l29.568"></a><span id="l29.568">             }</span>
<a href="#l29.569"></a><span id="l29.569">             return val;</span>
<a href="#l29.570"></a><span id="l29.570">           ]]&gt;</span>
<a href="#l29.571"></a><span id="l29.571">         &lt;/setter&gt;</span>
<a href="#l29.572"></a><span id="l29.572">       &lt;/property&gt;</span>
<a href="#l29.573"></a><span id="l29.573"> </span>
<a href="#l29.574"></a><span id="l29.574" class="difflineat">@@ -1057,17 +1052,17 @@</span>
<a href="#l29.575"></a><span id="l29.575">       &lt;property name=&quot;targets&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l29.576"></a><span id="l29.576">         &lt;getter&gt;</span>
<a href="#l29.577"></a><span id="l29.577">           &lt;![CDATA[</span>
<a href="#l29.578"></a><span id="l29.578">             var forAttrs =  this.getAttribute(&quot;for&quot;);</span>
<a href="#l29.579"></a><span id="l29.579">             if (!forAttrs) return null;</span>
<a href="#l29.580"></a><span id="l29.580">             var targetIds = forAttrs.split(&quot;,&quot;);</span>
<a href="#l29.581"></a><span id="l29.581">             if (targetIds.length == 0) return null;</span>
<a href="#l29.582"></a><span id="l29.582"> </span>
<a href="#l29.583"></a><span id="l29.583" class="difflineminus">-            var targets = new Array;</span>
<a href="#l29.584"></a><span id="l29.584" class="difflineplus">+            var targets = [];</span>
<a href="#l29.585"></a><span id="l29.585">             for (let j = 0, i = 0; i &lt; targetIds.length; i++) {</span>
<a href="#l29.586"></a><span id="l29.586">               var target = document.getElementById(targetIds[i]);</span>
<a href="#l29.587"></a><span id="l29.587">               if (target) targets[j++] = target;</span>
<a href="#l29.588"></a><span id="l29.588">             }</span>
<a href="#l29.589"></a><span id="l29.589">             return targets;</span>
<a href="#l29.590"></a><span id="l29.590">           ]]&gt;</span>
<a href="#l29.591"></a><span id="l29.591">         &lt;/getter&gt;</span>
<a href="#l29.592"></a><span id="l29.592">       &lt;/property&gt;</span>
<a href="#l29.593"></a><span id="l29.593" class="difflineat">@@ -1075,19 +1070,19 @@</span>
<a href="#l29.594"></a><span id="l29.594">       &lt;property name=&quot;optargets&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l29.595"></a><span id="l29.595">         &lt;getter&gt;</span>
<a href="#l29.596"></a><span id="l29.596">           &lt;![CDATA[</span>
<a href="#l29.597"></a><span id="l29.597">             var forAttrs =  this.getAttribute(&quot;opfor&quot;);</span>
<a href="#l29.598"></a><span id="l29.598">             if (!forAttrs) return null;</span>
<a href="#l29.599"></a><span id="l29.599">             var optargetIds = forAttrs.split(&quot;,&quot;);</span>
<a href="#l29.600"></a><span id="l29.600">             if (optargetIds.length == 0) return null;</span>
<a href="#l29.601"></a><span id="l29.601"> </span>
<a href="#l29.602"></a><span id="l29.602" class="difflineminus">-            var optargets = new Array;</span>
<a href="#l29.603"></a><span id="l29.603" class="difflineminus">-            var j=0;</span>
<a href="#l29.604"></a><span id="l29.604" class="difflineminus">-            for (var i=0; i&lt;optargetIds.length;i++) {</span>
<a href="#l29.605"></a><span id="l29.605" class="difflineplus">+            var optargets = [];</span>
<a href="#l29.606"></a><span id="l29.606" class="difflineplus">+            var j = 0;</span>
<a href="#l29.607"></a><span id="l29.607" class="difflineplus">+            for (var i = 0; i &lt; optargetIds.length; i++) {</span>
<a href="#l29.608"></a><span id="l29.608">               var optarget = document.getElementById(optargetIds[i]);</span>
<a href="#l29.609"></a><span id="l29.609">               if (optarget) optargets[j++] = optarget;</span>
<a href="#l29.610"></a><span id="l29.610">             }</span>
<a href="#l29.611"></a><span id="l29.611">             return optargets;</span>
<a href="#l29.612"></a><span id="l29.612">           ]]&gt;</span>
<a href="#l29.613"></a><span id="l29.613">         &lt;/getter&gt;</span>
<a href="#l29.614"></a><span id="l29.614">       &lt;/property&gt;</span>
<a href="#l29.615"></a><span id="l29.615"> </span>
<a href="#l29.616"></a><span id="l29.616" class="difflineat">@@ -1098,35 +1093,38 @@</span>
<a href="#l29.617"></a><span id="l29.617">               return val;</span>
<a href="#l29.618"></a><span id="l29.618">             this.internalValue = val;</span>
<a href="#l29.619"></a><span id="l29.619">             var menulist = document.getAnonymousNodes(this)[0];</span>
<a href="#l29.620"></a><span id="l29.620">             menulist.selectedItem = this.validMenuitem;</span>
<a href="#l29.621"></a><span id="l29.621"> </span>
<a href="#l29.622"></a><span id="l29.622">             // now notify targets of new parent's value</span>
<a href="#l29.623"></a><span id="l29.623">             var targets = this.targets;</span>
<a href="#l29.624"></a><span id="l29.624">             if (targets) {</span>
<a href="#l29.625"></a><span id="l29.625" class="difflineminus">-              for (var i=0; i &lt; targets.length; i++) {</span>
<a href="#l29.626"></a><span id="l29.626" class="difflineplus">+              for (var i = 0; i &lt; targets.length; i++) {</span>
<a href="#l29.627"></a><span id="l29.627">                 targets[i].parentValue = val;</span>
<a href="#l29.628"></a><span id="l29.628">               }</span>
<a href="#l29.629"></a><span id="l29.629">             }</span>
<a href="#l29.630"></a><span id="l29.630"> </span>
<a href="#l29.631"></a><span id="l29.631">             // now notify optargets of new op parent's value</span>
<a href="#l29.632"></a><span id="l29.632">             var optargets = this.optargets;</span>
<a href="#l29.633"></a><span id="l29.633">             if (optargets) {</span>
<a href="#l29.634"></a><span id="l29.634" class="difflineminus">-              for (i=0; i &lt; optargets.length; i++) {</span>
<a href="#l29.635"></a><span id="l29.635" class="difflineplus">+              for (i = 0; i &lt; optargets.length; i++) {</span>
<a href="#l29.636"></a><span id="l29.636">                 optargets[i].opParentValue = val;</span>
<a href="#l29.637"></a><span id="l29.637">               }</span>
<a href="#l29.638"></a><span id="l29.638">             }</span>
<a href="#l29.639"></a><span id="l29.639"> </span>
<a href="#l29.640"></a><span id="l29.640">             return val;</span>
<a href="#l29.641"></a><span id="l29.641">           ]]&gt;</span>
<a href="#l29.642"></a><span id="l29.642">         &lt;/setter&gt;</span>
<a href="#l29.643"></a><span id="l29.643">       &lt;/property&gt;</span>
<a href="#l29.644"></a><span id="l29.644">       &lt;!-- label forwards to the internal menulist's &quot;label&quot; attribute --&gt;</span>
<a href="#l29.645"></a><span id="l29.645" class="difflineminus">-      &lt;property name=&quot;label&quot; onget=&quot;return document.getAnonymousNodes(this)[0].selectedItem.getAttribute('label');&quot;&gt;</span>
<a href="#l29.646"></a><span id="l29.646" class="difflineplus">+      &lt;property name=&quot;label&quot;&gt;</span>
<a href="#l29.647"></a><span id="l29.647" class="difflineplus">+        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l29.648"></a><span id="l29.648" class="difflineplus">+          return document.getAnonymousNodes(this)[0].selectedItem.getAttribute(&quot;label&quot;);</span>
<a href="#l29.649"></a><span id="l29.649" class="difflineplus">+        ]]&gt;&lt;/getter&gt;</span>
<a href="#l29.650"></a><span id="l29.650">       &lt;/property&gt;</span>
<a href="#l29.651"></a><span id="l29.651">       &lt;property name=&quot;validMenuitem&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l29.652"></a><span id="l29.652">       &lt;!-- Prepare menulist selection, adding a missing hidden menuitem if needed, and</span>
<a href="#l29.653"></a><span id="l29.653">         updating the disabled state of the menulist label. --&gt;</span>
<a href="#l29.654"></a><span id="l29.654">         &lt;getter&gt;</span>
<a href="#l29.655"></a><span id="l29.655">           &lt;![CDATA[</span>
<a href="#l29.656"></a><span id="l29.656">             if (this.value == -1) // -1 means not initialized</span>
<a href="#l29.657"></a><span id="l29.657">               return null;</span>
<a href="#l29.658"></a><span id="l29.658" class="difflineat">@@ -1135,19 +1133,18 @@</span>
<a href="#l29.659"></a><span id="l29.659">             let isCustom = isNaN(this.value);</span>
<a href="#l29.660"></a><span id="l29.660">             let typedValue = isCustom ? this.value : parseInt(this.value);</span>
<a href="#l29.661"></a><span id="l29.661"> </span>
<a href="#l29.662"></a><span id="l29.662">             // custom attribute to style the unavailable menulist item</span>
<a href="#l29.663"></a><span id="l29.663">             menulist.setAttribute(&quot;unavailable&quot;,</span>
<a href="#l29.664"></a><span id="l29.664">               (!this.valueIds.includes(typedValue)) ? &quot;true&quot; : null);</span>
<a href="#l29.665"></a><span id="l29.665"> </span>
<a href="#l29.666"></a><span id="l29.666">             // add a hidden menulist item if value is missing</span>
<a href="#l29.667"></a><span id="l29.667" class="difflineminus">-            let menuitem = menulist.querySelector('[value=&quot;' + this.value + '&quot;]');</span>
<a href="#l29.668"></a><span id="l29.668" class="difflineminus">-            if (!menuitem)</span>
<a href="#l29.669"></a><span id="l29.669" class="difflineminus">-            { // need to add a hidden menuitem</span>
<a href="#l29.670"></a><span id="l29.670" class="difflineplus">+            let menuitem = menulist.querySelector(`[value=&quot;${this.value}&quot;]`);</span>
<a href="#l29.671"></a><span id="l29.671" class="difflineplus">+            if (!menuitem) { // need to add a hidden menuitem</span>
<a href="#l29.672"></a><span id="l29.672">               menuitem = menulist.appendItem(this.valueLabel, this.value);</span>
<a href="#l29.673"></a><span id="l29.673">               menuitem.hidden = true;</span>
<a href="#l29.674"></a><span id="l29.674">             }</span>
<a href="#l29.675"></a><span id="l29.675">             return menuitem;</span>
<a href="#l29.676"></a><span id="l29.676">           ]]&gt;</span>
<a href="#l29.677"></a><span id="l29.677">         &lt;/getter&gt;</span>
<a href="#l29.678"></a><span id="l29.678">       &lt;/property&gt;</span>
<a href="#l29.679"></a><span id="l29.679">       &lt;method name=&quot;refreshList&quot;&gt;</span>
<a href="#l29.680"></a><span id="l29.680" class="difflineat">@@ -1165,35 +1162,32 @@</span>
<a href="#l29.681"></a><span id="l29.681">             if (!dontRestore)</span>
<a href="#l29.682"></a><span id="l29.682">               oldData = menulist.value;</span>
<a href="#l29.683"></a><span id="l29.683"> </span>
<a href="#l29.684"></a><span id="l29.684">             // remove the old popup children</span>
<a href="#l29.685"></a><span id="l29.685">             while (popup.hasChildNodes())</span>
<a href="#l29.686"></a><span id="l29.686">               popup.lastChild.remove();</span>
<a href="#l29.687"></a><span id="l29.687"> </span>
<a href="#l29.688"></a><span id="l29.688">             var newSelection;</span>
<a href="#l29.689"></a><span id="l29.689" class="difflineminus">-            var customizePos=-1;</span>
<a href="#l29.690"></a><span id="l29.690" class="difflineminus">-            for (var i = 0; i &lt; menuItemIds.length; ++i)</span>
<a href="#l29.691"></a><span id="l29.691" class="difflineminus">-            {</span>
<a href="#l29.692"></a><span id="l29.692" class="difflineplus">+            var customizePos = -1;</span>
<a href="#l29.693"></a><span id="l29.693" class="difflineplus">+            for (var i = 0; i &lt; menuItemIds.length; ++i) {</span>
<a href="#l29.694"></a><span id="l29.694">               // create the menuitem</span>
<a href="#l29.695"></a><span id="l29.695" class="difflineminus">-              if (Ci.nsMsgSearchAttrib.OtherHeader == menuItemIds[i].toString())</span>
<a href="#l29.696"></a><span id="l29.696" class="difflineplus">+              if (Ci.nsMsgSearchAttrib.OtherHeader == menuItemIds[i].toString()) {</span>
<a href="#l29.697"></a><span id="l29.697">                 customizePos = i;</span>
<a href="#l29.698"></a><span id="l29.698" class="difflineminus">-              else</span>
<a href="#l29.699"></a><span id="l29.699" class="difflineminus">-              {</span>
<a href="#l29.700"></a><span id="l29.700" class="difflineplus">+              } else {</span>
<a href="#l29.701"></a><span id="l29.701">                 var menuitem = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l29.702"></a><span id="l29.702">                 menuitem.setAttribute(&quot;label&quot;, menuItemStrings[i]);</span>
<a href="#l29.703"></a><span id="l29.703">                 menuitem.setAttribute(&quot;value&quot;, menuItemIds[i]);</span>
<a href="#l29.704"></a><span id="l29.704">                 popup.appendChild(menuitem);</span>
<a href="#l29.705"></a><span id="l29.705">                 // try to restore the selection</span>
<a href="#l29.706"></a><span id="l29.706">                 if (!newSelection || oldData == menuItemIds[i].toString())</span>
<a href="#l29.707"></a><span id="l29.707">                   newSelection = menuitem;</span>
<a href="#l29.708"></a><span id="l29.708">               }</span>
<a href="#l29.709"></a><span id="l29.709">             }</span>
<a href="#l29.710"></a><span id="l29.710" class="difflineminus">-            if (customizePos != -1)</span>
<a href="#l29.711"></a><span id="l29.711" class="difflineminus">-            {</span>
<a href="#l29.712"></a><span id="l29.712" class="difflineplus">+            if (customizePos != -1) {</span>
<a href="#l29.713"></a><span id="l29.713">               var separator = document.createElement(&quot;menuseparator&quot;);</span>
<a href="#l29.714"></a><span id="l29.714">               popup.appendChild(separator);</span>
<a href="#l29.715"></a><span id="l29.715">               menuitem = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l29.716"></a><span id="l29.716">               menuitem.setAttribute(&quot;label&quot;, menuItemStrings[customizePos]);</span>
<a href="#l29.717"></a><span id="l29.717">               menuitem.setAttribute(&quot;value&quot;, menuItemIds[customizePos]);</span>
<a href="#l29.718"></a><span id="l29.718">               popup.appendChild(menuitem);</span>
<a href="#l29.719"></a><span id="l29.719">             }</span>
<a href="#l29.720"></a><span id="l29.720">             //</span>
<a href="#l29.721"></a><span id="l29.721" class="difflineat">@@ -1207,40 +1201,37 @@</span>
<a href="#l29.722"></a><span id="l29.722">           ]]&gt;</span>
<a href="#l29.723"></a><span id="l29.723">         &lt;/body&gt;</span>
<a href="#l29.724"></a><span id="l29.724">       &lt;/method&gt;</span>
<a href="#l29.725"></a><span id="l29.725">       &lt;method name=&quot;onSelect&quot;&gt;</span>
<a href="#l29.726"></a><span id="l29.726">         &lt;parameter name=&quot;event&quot;/&gt;</span>
<a href="#l29.727"></a><span id="l29.727">         &lt;body&gt;</span>
<a href="#l29.728"></a><span id="l29.728">           &lt;![CDATA[</span>
<a href="#l29.729"></a><span id="l29.729">             var menulist = document.getAnonymousNodes(this)[0];</span>
<a href="#l29.730"></a><span id="l29.730" class="difflineminus">-            if (menulist.value == Ci.nsMsgSearchAttrib.OtherHeader)</span>
<a href="#l29.731"></a><span id="l29.731" class="difflineminus">-            {</span>
<a href="#l29.732"></a><span id="l29.732" class="difflineplus">+            if (menulist.value == Ci.nsMsgSearchAttrib.OtherHeader) {</span>
<a href="#l29.733"></a><span id="l29.733">               // Customize menuitem selected.</span>
<a href="#l29.734"></a><span id="l29.734">               let args = {};</span>
<a href="#l29.735"></a><span id="l29.735">               window.openDialog(&quot;chrome://messenger/content/CustomHeaders.xul&quot;,</span>
<a href="#l29.736"></a><span id="l29.736">                                 &quot;&quot;, &quot;modal,centerscreen,resizable,titlebar,chrome&quot;,</span>
<a href="#l29.737"></a><span id="l29.737">                                 args);</span>
<a href="#l29.738"></a><span id="l29.738">               // User may have removed the custom header currently selected</span>
<a href="#l29.739"></a><span id="l29.739">               // in the menulist so temporarily set the selection to a safe value.</span>
<a href="#l29.740"></a><span id="l29.740">               this.value = Ci.nsMsgSearchAttrib.OtherHeader;</span>
<a href="#l29.741"></a><span id="l29.741">               // rebuild the menulist</span>
<a href="#l29.742"></a><span id="l29.742">               UpdateAfterCustomHeaderChange();</span>
<a href="#l29.743"></a><span id="l29.743">               // Find the created or chosen custom header and select it.</span>
<a href="#l29.744"></a><span id="l29.744">               if (args.selectedVal) {</span>
<a href="#l29.745"></a><span id="l29.745" class="difflineminus">-                let menuitem = menulist.querySelector('[label=&quot;' + args.selectedVal + '&quot;]');</span>
<a href="#l29.746"></a><span id="l29.746" class="difflineplus">+                let menuitem = menulist.querySelector(`[label=&quot;${args.selectedVal}&quot;]`);</span>
<a href="#l29.747"></a><span id="l29.747">                 this.value = menuitem.value;</span>
<a href="#l29.748"></a><span id="l29.748">               } else {</span>
<a href="#l29.749"></a><span id="l29.749">                 // Nothing was picked in the custom headers editor so just pick something</span>
<a href="#l29.750"></a><span id="l29.750">                 // instead of the current &quot;Customize&quot; menuitem.</span>
<a href="#l29.751"></a><span id="l29.751">                 this.value = menulist.getItemAtIndex(0).value;</span>
<a href="#l29.752"></a><span id="l29.752">               }</span>
<a href="#l29.753"></a><span id="l29.753" class="difflineminus">-            }</span>
<a href="#l29.754"></a><span id="l29.754" class="difflineminus">-            else</span>
<a href="#l29.755"></a><span id="l29.755" class="difflineminus">-            {</span>
<a href="#l29.756"></a><span id="l29.756" class="difflineplus">+            } else {</span>
<a href="#l29.757"></a><span id="l29.757">               this.value = menulist.value;</span>
<a href="#l29.758"></a><span id="l29.758">             }</span>
<a href="#l29.759"></a><span id="l29.759">           ]]&gt;</span>
<a href="#l29.760"></a><span id="l29.760">         &lt;/body&gt;</span>
<a href="#l29.761"></a><span id="l29.761">       &lt;/method&gt;</span>
<a href="#l29.762"></a><span id="l29.762">     &lt;/implementation&gt;</span>
<a href="#l29.763"></a><span id="l29.763">   &lt;/binding&gt;</span>
<a href="#l29.764"></a><span id="l29.764"> </span>
<a href="#l29.765"></a><span id="l29.765" class="difflineat">@@ -1251,92 +1242,83 @@</span>
<a href="#l29.766"></a><span id="l29.766">       &lt;field name=&quot;stringBundle&quot;&gt;</span>
<a href="#l29.767"></a><span id="l29.767">         &lt;![CDATA[</span>
<a href="#l29.768"></a><span id="l29.768">           this.Services.strings.createBundle(&quot;chrome://messenger/locale/search-attributes.properties&quot;)</span>
<a href="#l29.769"></a><span id="l29.769">         ]]&gt;</span>
<a href="#l29.770"></a><span id="l29.770">       &lt;/field&gt;</span>
<a href="#l29.771"></a><span id="l29.771">       &lt;property name=&quot;valueLabel&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l29.772"></a><span id="l29.772">         &lt;getter&gt;</span>
<a href="#l29.773"></a><span id="l29.773">           &lt;![CDATA[</span>
<a href="#l29.774"></a><span id="l29.774" class="difflineminus">-            if (isNaN(this.value)) // is this a custom term?</span>
<a href="#l29.775"></a><span id="l29.775" class="difflineminus">-            {</span>
<a href="#l29.776"></a><span id="l29.776" class="difflineplus">+            if (isNaN(this.value)) { // is this a custom term?</span>
<a href="#l29.777"></a><span id="l29.777">               let customTerm = MailServices.filters.getCustomTerm(this.value);</span>
<a href="#l29.778"></a><span id="l29.778">               if (customTerm)</span>
<a href="#l29.779"></a><span id="l29.779">                 return customTerm.name;</span>
<a href="#l29.780"></a><span id="l29.780" class="difflineminus">-              else</span>
<a href="#l29.781"></a><span id="l29.781" class="difflineminus">-              { // The custom term may be missing after the extension that added it</span>
<a href="#l29.782"></a><span id="l29.782" class="difflineminus">-                // was disabled or removed. We need to notify the user.</span>
<a href="#l29.783"></a><span id="l29.783" class="difflineminus">-                let scriptError = Cc[&quot;@mozilla.org/scripterror;1&quot;]</span>
<a href="#l29.784"></a><span id="l29.784" class="difflineminus">-                    .createInstance(Ci.nsIScriptError);</span>
<a href="#l29.785"></a><span id="l29.785" class="difflineminus">-                scriptError.init(&quot;Missing custom search term &quot; + this.value,</span>
<a href="#l29.786"></a><span id="l29.786" class="difflineminus">-                    null, null, 0, 0,</span>
<a href="#l29.787"></a><span id="l29.787" class="difflineminus">-                    Ci.nsIScriptError.errorFlag,</span>
<a href="#l29.788"></a><span id="l29.788" class="difflineminus">-                    &quot;component javascript&quot;);</span>
<a href="#l29.789"></a><span id="l29.789" class="difflineminus">-                this.Services.console.logMessage(scriptError);</span>
<a href="#l29.790"></a><span id="l29.790" class="difflineminus">-                return this.stringBundle.GetStringFromName(&quot;MissingCustomTerm&quot;);</span>
<a href="#l29.791"></a><span id="l29.791" class="difflineminus">-              }</span>
<a href="#l29.792"></a><span id="l29.792" class="difflineplus">+              // The custom term may be missing after the extension that added it</span>
<a href="#l29.793"></a><span id="l29.793" class="difflineplus">+              // was disabled or removed. We need to notify the user.</span>
<a href="#l29.794"></a><span id="l29.794" class="difflineplus">+              let scriptError = Cc[&quot;@mozilla.org/scripterror;1&quot;]</span>
<a href="#l29.795"></a><span id="l29.795" class="difflineplus">+                  .createInstance(Ci.nsIScriptError);</span>
<a href="#l29.796"></a><span id="l29.796" class="difflineplus">+              scriptError.init(&quot;Missing custom search term &quot; + this.value,</span>
<a href="#l29.797"></a><span id="l29.797" class="difflineplus">+                  null, null, 0, 0,</span>
<a href="#l29.798"></a><span id="l29.798" class="difflineplus">+                  Ci.nsIScriptError.errorFlag,</span>
<a href="#l29.799"></a><span id="l29.799" class="difflineplus">+                  &quot;component javascript&quot;);</span>
<a href="#l29.800"></a><span id="l29.800" class="difflineplus">+              this.Services.console.logMessage(scriptError);</span>
<a href="#l29.801"></a><span id="l29.801" class="difflineplus">+              return this.stringBundle.GetStringFromName(&quot;MissingCustomTerm&quot;);</span>
<a href="#l29.802"></a><span id="l29.802">             }</span>
<a href="#l29.803"></a><span id="l29.803">             return this.stringBundle.GetStringFromName(</span>
<a href="#l29.804"></a><span id="l29.804">               this.validityManager.getAttributeProperty(parseInt(this.value)));</span>
<a href="#l29.805"></a><span id="l29.805">           ]]&gt;</span>
<a href="#l29.806"></a><span id="l29.806">         &lt;/getter&gt;</span>
<a href="#l29.807"></a><span id="l29.807">       &lt;/property&gt;</span>
<a href="#l29.808"></a><span id="l29.808">       &lt;property name=&quot;valueIds&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l29.809"></a><span id="l29.809">         &lt;getter&gt;</span>
<a href="#l29.810"></a><span id="l29.810">           &lt;![CDATA[</span>
<a href="#l29.811"></a><span id="l29.811" class="difflineminus">-            var length = new Object;</span>
<a href="#l29.812"></a><span id="l29.812" class="difflineplus">+            var length = {};</span>
<a href="#l29.813"></a><span id="l29.813">             let result = this.validityTable.getAvailableAttributes(length);</span>
<a href="#l29.814"></a><span id="l29.814">             // add any available custom search terms</span>
<a href="#l29.815"></a><span id="l29.815">             let customEnum = MailServices.filters.getCustomTerms();</span>
<a href="#l29.816"></a><span id="l29.816" class="difflineminus">-            while (customEnum &amp;&amp; customEnum.hasMoreElements())</span>
<a href="#l29.817"></a><span id="l29.817" class="difflineminus">-            {</span>
<a href="#l29.818"></a><span id="l29.818" class="difflineplus">+            while (customEnum &amp;&amp; customEnum.hasMoreElements()) {</span>
<a href="#l29.819"></a><span id="l29.819">               let customTerm =</span>
<a href="#l29.820"></a><span id="l29.820">                  customEnum.getNext()</span>
<a href="#l29.821"></a><span id="l29.821">                            .QueryInterface(Ci.nsIMsgSearchCustomTerm);</span>
<a href="#l29.822"></a><span id="l29.822">               // for custom terms, the array element is a string with the custom id</span>
<a href="#l29.823"></a><span id="l29.823">               // instead of the integer attribute</span>
<a href="#l29.824"></a><span id="l29.824">               if (customTerm.getAvailable(this.searchScope, null))</span>
<a href="#l29.825"></a><span id="l29.825">                 result.push(customTerm.id);</span>
<a href="#l29.826"></a><span id="l29.826">             }</span>
<a href="#l29.827"></a><span id="l29.827">             return result;</span>
<a href="#l29.828"></a><span id="l29.828">           ]]&gt;</span>
<a href="#l29.829"></a><span id="l29.829">         &lt;/getter&gt;</span>
<a href="#l29.830"></a><span id="l29.830">       &lt;/property&gt;</span>
<a href="#l29.831"></a><span id="l29.831">       &lt;property name=&quot;valueStrings&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l29.832"></a><span id="l29.832">         &lt;getter&gt;</span>
<a href="#l29.833"></a><span id="l29.833">           &lt;![CDATA[</span>
<a href="#l29.834"></a><span id="l29.834" class="difflineminus">-            let strings = new Array;</span>
<a href="#l29.835"></a><span id="l29.835" class="difflineplus">+            let strings = [];</span>
<a href="#l29.836"></a><span id="l29.836">             let ids = this.valueIds;</span>
<a href="#l29.837"></a><span id="l29.837">             let hdrsArray = null;</span>
<a href="#l29.838"></a><span id="l29.838" class="difflineminus">-            try</span>
<a href="#l29.839"></a><span id="l29.839" class="difflineminus">-            {</span>
<a href="#l29.840"></a><span id="l29.840" class="difflineplus">+            try {</span>
<a href="#l29.841"></a><span id="l29.841">               let hdrs = this.Services.prefs.getCharPref(&quot;mailnews.customHeaders&quot;);</span>
<a href="#l29.842"></a><span id="l29.842" class="difflineminus">-              hdrs = hdrs.replace(/\s+/g, &quot;&quot;);  //remove white spaces before splitting</span>
<a href="#l29.843"></a><span id="l29.843" class="difflineplus">+              hdrs = hdrs.replace(/\s+/g, &quot;&quot;); // remove white spaces before splitting</span>
<a href="#l29.844"></a><span id="l29.844">               hdrsArray = hdrs.match(/[^:]+/g);</span>
<a href="#l29.845"></a><span id="l29.845" class="difflineminus">-            }</span>
<a href="#l29.846"></a><span id="l29.846" class="difflineminus">-            catch(ex)</span>
<a href="#l29.847"></a><span id="l29.847" class="difflineminus">-            {</span>
<a href="#l29.848"></a><span id="l29.848" class="difflineplus">+            } catch (ex) {</span>
<a href="#l29.849"></a><span id="l29.849">             }</span>
<a href="#l29.850"></a><span id="l29.850"> </span>
<a href="#l29.851"></a><span id="l29.851">             let j = 0;</span>
<a href="#l29.852"></a><span id="l29.852" class="difflineminus">-            for (let i = 0; i &lt; ids.length; i++)</span>
<a href="#l29.853"></a><span id="l29.853" class="difflineminus">-            {</span>
<a href="#l29.854"></a><span id="l29.854" class="difflineminus">-              if (isNaN(ids[i])) // Is this a custom search term?</span>
<a href="#l29.855"></a><span id="l29.855" class="difflineminus">-              {</span>
<a href="#l29.856"></a><span id="l29.856" class="difflineplus">+            for (let i = 0; i &lt; ids.length; i++) {</span>
<a href="#l29.857"></a><span id="l29.857" class="difflineplus">+              if (isNaN(ids[i])) { // Is this a custom search term?</span>
<a href="#l29.858"></a><span id="l29.858">                 let customTerm = MailServices.filters.getCustomTerm(ids[i]);</span>
<a href="#l29.859"></a><span id="l29.859">                 if (customTerm)</span>
<a href="#l29.860"></a><span id="l29.860">                   strings[i] = customTerm.name;</span>
<a href="#l29.861"></a><span id="l29.861">                 else</span>
<a href="#l29.862"></a><span id="l29.862">                   strings[i] = &quot;&quot;;</span>
<a href="#l29.863"></a><span id="l29.863" class="difflineminus">-              }</span>
<a href="#l29.864"></a><span id="l29.864" class="difflineminus">-              else if(ids[i] &gt; Ci.nsMsgSearchAttrib.OtherHeader &amp;&amp; hdrsArray)</span>
<a href="#l29.865"></a><span id="l29.865" class="difflineplus">+              } else if (ids[i] &gt; Ci.nsMsgSearchAttrib.OtherHeader &amp;&amp; hdrsArray) {</span>
<a href="#l29.866"></a><span id="l29.866">                 strings[i] = hdrsArray[j++];</span>
<a href="#l29.867"></a><span id="l29.867" class="difflineminus">-              else</span>
<a href="#l29.868"></a><span id="l29.868" class="difflineplus">+              } else {</span>
<a href="#l29.869"></a><span id="l29.869">                 strings[i] = this.stringBundle.GetStringFromName(</span>
<a href="#l29.870"></a><span id="l29.870">                                this.validityManager.getAttributeProperty(ids[i]));</span>
<a href="#l29.871"></a><span id="l29.871" class="difflineplus">+              }</span>
<a href="#l29.872"></a><span id="l29.872">             }</span>
<a href="#l29.873"></a><span id="l29.873">             return strings;</span>
<a href="#l29.874"></a><span id="l29.874">           ]]&gt;</span>
<a href="#l29.875"></a><span id="l29.875">         &lt;/getter&gt;</span>
<a href="#l29.876"></a><span id="l29.876">       &lt;/property&gt;</span>
<a href="#l29.877"></a><span id="l29.877">       &lt;constructor&gt;</span>
<a href="#l29.878"></a><span id="l29.878">       &lt;![CDATA[</span>
<a href="#l29.879"></a><span id="l29.879">         ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l29.880"></a><span id="l29.880" class="difflineat">@@ -1362,48 +1344,46 @@</span>
<a href="#l29.881"></a><span id="l29.881">           &lt;![CDATA[</span>
<a href="#l29.882"></a><span id="l29.882">             return this.stringBundle.GetStringFromName(this.value);</span>
<a href="#l29.883"></a><span id="l29.883">           ]]&gt;</span>
<a href="#l29.884"></a><span id="l29.884">         &lt;/getter&gt;</span>
<a href="#l29.885"></a><span id="l29.885">       &lt;/property&gt;</span>
<a href="#l29.886"></a><span id="l29.886">       &lt;property name=&quot;valueIds&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l29.887"></a><span id="l29.887">         &lt;getter&gt;</span>
<a href="#l29.888"></a><span id="l29.888">           &lt;![CDATA[</span>
<a href="#l29.889"></a><span id="l29.889" class="difflineminus">-            var length = new Object;</span>
<a href="#l29.890"></a><span id="l29.890" class="difflineplus">+            var length = {};</span>
<a href="#l29.891"></a><span id="l29.891">             let isCustom = isNaN(this.searchAttribute);</span>
<a href="#l29.892"></a><span id="l29.892" class="difflineminus">-            if (isCustom)</span>
<a href="#l29.893"></a><span id="l29.893" class="difflineminus">-            {</span>
<a href="#l29.894"></a><span id="l29.894" class="difflineplus">+            if (isCustom) {</span>
<a href="#l29.895"></a><span id="l29.895">               let customTerm = MailServices.filters.getCustomTerm(this.searchAttribute);</span>
<a href="#l29.896"></a><span id="l29.896">               if (customTerm)</span>
<a href="#l29.897"></a><span id="l29.897">                 return customTerm.getAvailableOperators(this.searchScope, length);</span>
<a href="#l29.898"></a><span id="l29.898">               return [Ci.nsMsgSearchOp.Contains];</span>
<a href="#l29.899"></a><span id="l29.899">             }</span>
<a href="#l29.900"></a><span id="l29.900" class="difflineminus">-            return this.validityTable.getAvailableOperators(this.searchAttribute,length);</span>
<a href="#l29.901"></a><span id="l29.901" class="difflineplus">+            return this.validityTable.getAvailableOperators(this.searchAttribute, length);</span>
<a href="#l29.902"></a><span id="l29.902">           ]]&gt;</span>
<a href="#l29.903"></a><span id="l29.903">         &lt;/getter&gt;</span>
<a href="#l29.904"></a><span id="l29.904">       &lt;/property&gt;</span>
<a href="#l29.905"></a><span id="l29.905">       &lt;property name=&quot;valueStrings&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l29.906"></a><span id="l29.906">         &lt;getter&gt;</span>
<a href="#l29.907"></a><span id="l29.907">           &lt;![CDATA[</span>
<a href="#l29.908"></a><span id="l29.908" class="difflineminus">-            let strings = new Array;</span>
<a href="#l29.909"></a><span id="l29.909" class="difflineplus">+            let strings = [];</span>
<a href="#l29.910"></a><span id="l29.910">             let ids = this.valueIds;</span>
<a href="#l29.911"></a><span id="l29.911">             for (let i = 0; i &lt; ids.length; i++)</span>
<a href="#l29.912"></a><span id="l29.912">               strings[i] = this.stringBundle.GetStringFromID(ids[i]);</span>
<a href="#l29.913"></a><span id="l29.913">             return strings;</span>
<a href="#l29.914"></a><span id="l29.914">           ]]&gt;</span>
<a href="#l29.915"></a><span id="l29.915">         &lt;/getter&gt;</span>
<a href="#l29.916"></a><span id="l29.916">       &lt;/property&gt;</span>
<a href="#l29.917"></a><span id="l29.917">       &lt;property name=&quot;parentValue&quot;&gt;</span>
<a href="#l29.918"></a><span id="l29.918">         &lt;setter&gt;</span>
<a href="#l29.919"></a><span id="l29.919">           &lt;![CDATA[</span>
<a href="#l29.920"></a><span id="l29.920">             if (this.searchAttribute == val &amp;&amp; val != Ci.nsMsgSearchAttrib.OtherHeader) return val;</span>
<a href="#l29.921"></a><span id="l29.921">             this.searchAttribute = val;</span>
<a href="#l29.922"></a><span id="l29.922">             this.refreshList(true); // don't restore the selection, since searchvalue nulls it</span>
<a href="#l29.923"></a><span id="l29.923" class="difflineminus">-            if (val == Ci.nsMsgSearchAttrib.AgeInDays)</span>
<a href="#l29.924"></a><span id="l29.924" class="difflineminus">-            {</span>
<a href="#l29.925"></a><span id="l29.925" class="difflineplus">+            if (val == Ci.nsMsgSearchAttrib.AgeInDays) {</span>
<a href="#l29.926"></a><span id="l29.926">               // We want &quot;Age in Days&quot; to default to &quot;is less than&quot;.</span>
<a href="#l29.927"></a><span id="l29.927">               this.value = Ci.nsMsgSearchOp.IsLessThan;</span>
<a href="#l29.928"></a><span id="l29.928">             }</span>
<a href="#l29.929"></a><span id="l29.929">             return val;</span>
<a href="#l29.930"></a><span id="l29.930">           ]]&gt;</span>
<a href="#l29.931"></a><span id="l29.931">         &lt;/setter&gt;</span>
<a href="#l29.932"></a><span id="l29.932">         &lt;getter&gt;</span>
<a href="#l29.933"></a><span id="l29.933">           &lt;![CDATA[</span>
<a href="#l29.934"></a><span id="l29.934" class="difflineat">@@ -1512,48 +1492,45 @@</span>
<a href="#l29.935"></a><span id="l29.935">                 this.setAttribute(&quot;selectedIndex&quot;, &quot;6&quot;);</span>
<a href="#l29.936"></a><span id="l29.936">             }</span>
<a href="#l29.937"></a><span id="l29.937"> </span>
<a href="#l29.938"></a><span id="l29.938">               // if it's not sender, to, cc, alladdresses, or toorcc, we don't care</span>
<a href="#l29.939"></a><span id="l29.939">               if (this.searchAttribute != Ci.nsMsgSearchAttrib.Sender &amp;&amp;</span>
<a href="#l29.940"></a><span id="l29.940">                 this.searchAttribute != Ci.nsMsgSearchAttrib.To &amp;&amp;</span>
<a href="#l29.941"></a><span id="l29.941">                 this.searchAttribute != Ci.nsMsgSearchAttrib.ToOrCC &amp;&amp;</span>
<a href="#l29.942"></a><span id="l29.942">                 this.searchAttribute != Ci.nsMsgSearchAttrib.AllAddresses &amp;&amp;</span>
<a href="#l29.943"></a><span id="l29.943" class="difflineminus">-                this.searchAttribute != Ci.nsMsgSearchAttrib.CC ) {</span>
<a href="#l29.944"></a><span id="l29.944" class="difflineplus">+                this.searchAttribute != Ci.nsMsgSearchAttrib.CC) {</span>
<a href="#l29.945"></a><span id="l29.945">               this.internalOperator = val;</span>
<a href="#l29.946"></a><span id="l29.946">               return val;</span>
<a href="#l29.947"></a><span id="l29.947">             }</span>
<a href="#l29.948"></a><span id="l29.948"> </span>
<a href="#l29.949"></a><span id="l29.949">             var children = document.getAnonymousNodes(this);</span>
<a href="#l29.950"></a><span id="l29.950">             if (val == Ci.nsMsgSearchOp.IsntInAB ||</span>
<a href="#l29.951"></a><span id="l29.951">                 val == Ci.nsMsgSearchOp.IsInAB) {</span>
<a href="#l29.952"></a><span id="l29.952">               // if the old internalOperator was</span>
<a href="#l29.953"></a><span id="l29.953">               // IsntInAB or IsInAB, and the new internalOperator is</span>
<a href="#l29.954"></a><span id="l29.954">               // IsntInAB or IsInAB, noop because the search value</span>
<a href="#l29.955"></a><span id="l29.955">               // was an ab type, and it still is.</span>
<a href="#l29.956"></a><span id="l29.956">               // otherwise, switch to the ab picker and select the PAB</span>
<a href="#l29.957"></a><span id="l29.957">               if (this.internalOperator != Ci.nsMsgSearchOp.IsntInAB &amp;&amp;</span>
<a href="#l29.958"></a><span id="l29.958">                   this.internalOperator != Ci.nsMsgSearchOp.IsInAB) {</span>
<a href="#l29.959"></a><span id="l29.959" class="difflineminus">-                var abs = children[4].querySelector('[value=&quot;moz-abmdbdirectory://abook.mab&quot;]');</span>
<a href="#l29.960"></a><span id="l29.960" class="difflineplus">+                var abs = children[4].querySelector(`[value=&quot;moz-abmdbdirectory://abook.mab&quot;]`);</span>
<a href="#l29.961"></a><span id="l29.961">                 if (abs)</span>
<a href="#l29.962"></a><span id="l29.962">                   children[4].selectedItem = abs;</span>
<a href="#l29.963"></a><span id="l29.963">                 this.setAttribute(&quot;selectedIndex&quot;, &quot;4&quot;);</span>
<a href="#l29.964"></a><span id="l29.964">               }</span>
<a href="#l29.965"></a><span id="l29.965" class="difflineminus">-            }</span>
<a href="#l29.966"></a><span id="l29.966" class="difflineminus">-            else {</span>
<a href="#l29.967"></a><span id="l29.967" class="difflineplus">+            } else if (this.internalOperator == Ci.nsMsgSearchOp.IsntInAB ||</span>
<a href="#l29.968"></a><span id="l29.968" class="difflineplus">+                       this.internalOperator == Ci.nsMsgSearchOp.IsInAB) {</span>
<a href="#l29.969"></a><span id="l29.969">               // if the old internalOperator wasn't</span>
<a href="#l29.970"></a><span id="l29.970">               // IsntInAB or IsInAB, and the new internalOperator isn't</span>
<a href="#l29.971"></a><span id="l29.971">               // IsntInAB or IsInAB, noop because the search value</span>
<a href="#l29.972"></a><span id="l29.972">               // wasn't an ab type, and it still isn't.</span>
<a href="#l29.973"></a><span id="l29.973">               // otherwise, switch to the textbox and clear it</span>
<a href="#l29.974"></a><span id="l29.974" class="difflineminus">-              if (this.internalOperator == Ci.nsMsgSearchOp.IsntInAB ||</span>
<a href="#l29.975"></a><span id="l29.975" class="difflineminus">-                  this.internalOperator == Ci.nsMsgSearchOp.IsInAB) {</span>
<a href="#l29.976"></a><span id="l29.976" class="difflineminus">-                children[0].value = &quot;&quot;;</span>
<a href="#l29.977"></a><span id="l29.977" class="difflineminus">-                this.setAttribute(&quot;selectedIndex&quot;, &quot;0&quot;);</span>
<a href="#l29.978"></a><span id="l29.978" class="difflineminus">-              }</span>
<a href="#l29.979"></a><span id="l29.979" class="difflineplus">+              children[0].value = &quot;&quot;;</span>
<a href="#l29.980"></a><span id="l29.980" class="difflineplus">+              this.setAttribute(&quot;selectedIndex&quot;, &quot;0&quot;);</span>
<a href="#l29.981"></a><span id="l29.981">             }</span>
<a href="#l29.982"></a><span id="l29.982"> </span>
<a href="#l29.983"></a><span id="l29.983">             this.internalOperator = val;</span>
<a href="#l29.984"></a><span id="l29.984">             return val;</span>
<a href="#l29.985"></a><span id="l29.985">           ]]&gt;</span>
<a href="#l29.986"></a><span id="l29.986">         &lt;/setter&gt;</span>
<a href="#l29.987"></a><span id="l29.987">       &lt;/property&gt;</span>
<a href="#l29.988"></a><span id="l29.988">       &lt;!-- parentValue forwards to the attribute --&gt;</span>
<a href="#l29.989"></a><span id="l29.989" class="difflineat">@@ -1566,213 +1543,186 @@</span>
<a href="#l29.990"></a><span id="l29.990">             if (this.internalAttribute == val) return val;</span>
<a href="#l29.991"></a><span id="l29.991">             this.internalAttribute = val;</span>
<a href="#l29.992"></a><span id="l29.992"> </span>
<a href="#l29.993"></a><span id="l29.993">             // if the searchAttribute changing, null out the internalOperator</span>
<a href="#l29.994"></a><span id="l29.994">             this.internalOperator = null;</span>
<a href="#l29.995"></a><span id="l29.995"> </span>
<a href="#l29.996"></a><span id="l29.996">             // we inherit from a deck, so just use it's index attribute</span>
<a href="#l29.997"></a><span id="l29.997">             // to hide/show widgets</span>
<a href="#l29.998"></a><span id="l29.998" class="difflineminus">-            if (isNaN(val)) // Is this a custom attribute?</span>
<a href="#l29.999"></a><span id="l29.999" class="difflineminus">-            {</span>
<a href="#l29.1000"></a><span id="l29.1000" class="difflineplus">+            if (isNaN(val)) { // Is this a custom attribute?</span>
<a href="#l29.1001"></a><span id="l29.1001">               this.setAttribute(&quot;selectedIndex&quot;, &quot;10&quot;);</span>
<a href="#l29.1002"></a><span id="l29.1002">               let customHbox = document.getAnonymousNodes(this)[10];</span>
<a href="#l29.1003"></a><span id="l29.1003">               if (this.internalValue)</span>
<a href="#l29.1004"></a><span id="l29.1004">                 customHbox.setAttribute(&quot;value&quot;, this.internalValue.str);</span>
<a href="#l29.1005"></a><span id="l29.1005">               // the searchAttribute attribute is intended as a selector in</span>
<a href="#l29.1006"></a><span id="l29.1006">               // CSS for custom search terms to bind a custom value</span>
<a href="#l29.1007"></a><span id="l29.1007">               customHbox.setAttribute(&quot;searchAttribute&quot;, val);</span>
<a href="#l29.1008"></a><span id="l29.1008" class="difflineminus">-            }</span>
<a href="#l29.1009"></a><span id="l29.1009" class="difflineminus">-            else if (val == Ci.nsMsgSearchAttrib.Priority)</span>
<a href="#l29.1010"></a><span id="l29.1010" class="difflineplus">+            } else if (val == Ci.nsMsgSearchAttrib.Priority) {</span>
<a href="#l29.1011"></a><span id="l29.1011">               this.setAttribute(&quot;selectedIndex&quot;, &quot;1&quot;);</span>
<a href="#l29.1012"></a><span id="l29.1012" class="difflineminus">-            else if (val == Ci.nsMsgSearchAttrib.MsgStatus)</span>
<a href="#l29.1013"></a><span id="l29.1013" class="difflineplus">+            } else if (val == Ci.nsMsgSearchAttrib.MsgStatus) {</span>
<a href="#l29.1014"></a><span id="l29.1014">               this.setAttribute(&quot;selectedIndex&quot;, &quot;2&quot;);</span>
<a href="#l29.1015"></a><span id="l29.1015" class="difflineminus">-            else if (val == Ci.nsMsgSearchAttrib.Date)</span>
<a href="#l29.1016"></a><span id="l29.1016" class="difflineplus">+            } else if (val == Ci.nsMsgSearchAttrib.Date) {</span>
<a href="#l29.1017"></a><span id="l29.1017">               this.setAttribute(&quot;selectedIndex&quot;, &quot;3&quot;);</span>
<a href="#l29.1018"></a><span id="l29.1018" class="difflineminus">-            else if (val == Ci.nsMsgSearchAttrib.Sender) {</span>
<a href="#l29.1019"></a><span id="l29.1019" class="difflineplus">+            } else if (val == Ci.nsMsgSearchAttrib.Sender) {</span>
<a href="#l29.1020"></a><span id="l29.1020">               // since the internalOperator is null</span>
<a href="#l29.1021"></a><span id="l29.1021">               // this is the same as the initial state</span>
<a href="#l29.1022"></a><span id="l29.1022">               // the initial state for Sender isn't an ab type search</span>
<a href="#l29.1023"></a><span id="l29.1023">               // it's a text search, so show the textbox</span>
<a href="#l29.1024"></a><span id="l29.1024">               this.setAttribute(&quot;selectedIndex&quot;, &quot;0&quot;);</span>
<a href="#l29.1025"></a><span id="l29.1025" class="difflineminus">-            }</span>
<a href="#l29.1026"></a><span id="l29.1026" class="difflineminus">-            else if (val == Ci.nsMsgSearchAttrib.Keywords) {</span>
<a href="#l29.1027"></a><span id="l29.1027" class="difflineplus">+            } else if (val == Ci.nsMsgSearchAttrib.Keywords) {</span>
<a href="#l29.1028"></a><span id="l29.1028">               this.setAttribute(&quot;selectedIndex&quot;, &quot;5&quot;);</span>
<a href="#l29.1029"></a><span id="l29.1029" class="difflineminus">-            }</span>
<a href="#l29.1030"></a><span id="l29.1030" class="difflineminus">-            else if (val == Ci.nsMsgSearchAttrib.JunkStatus) {</span>
<a href="#l29.1031"></a><span id="l29.1031" class="difflineplus">+            } else if (val == Ci.nsMsgSearchAttrib.JunkStatus) {</span>
<a href="#l29.1032"></a><span id="l29.1032">               this.setAttribute(&quot;selectedIndex&quot;, &quot;6&quot;);</span>
<a href="#l29.1033"></a><span id="l29.1033" class="difflineminus">-            }</span>
<a href="#l29.1034"></a><span id="l29.1034" class="difflineminus">-            else if (val == Ci.nsMsgSearchAttrib.HasAttachmentStatus) {</span>
<a href="#l29.1035"></a><span id="l29.1035" class="difflineplus">+            } else if (val == Ci.nsMsgSearchAttrib.HasAttachmentStatus) {</span>
<a href="#l29.1036"></a><span id="l29.1036">               this.setAttribute(&quot;selectedIndex&quot;, &quot;7&quot;);</span>
<a href="#l29.1037"></a><span id="l29.1037" class="difflineminus">-            }</span>
<a href="#l29.1038"></a><span id="l29.1038" class="difflineminus">-            else if (val == Ci.nsMsgSearchAttrib.JunkScoreOrigin) {</span>
<a href="#l29.1039"></a><span id="l29.1039" class="difflineplus">+            } else if (val == Ci.nsMsgSearchAttrib.JunkScoreOrigin) {</span>
<a href="#l29.1040"></a><span id="l29.1040">               this.setAttribute(&quot;selectedIndex&quot;, &quot;8&quot;);</span>
<a href="#l29.1041"></a><span id="l29.1041" class="difflineminus">-            }</span>
<a href="#l29.1042"></a><span id="l29.1042" class="difflineminus">-            else if (val == Ci.nsMsgSearchAttrib.AgeInDays) {</span>
<a href="#l29.1043"></a><span id="l29.1043" class="difflineplus">+            } else if (val == Ci.nsMsgSearchAttrib.AgeInDays) {</span>
<a href="#l29.1044"></a><span id="l29.1044">               let valueBox = document.getAnonymousNodes(this)[9];</span>
<a href="#l29.1045"></a><span id="l29.1045">               valueBox.min = -40000; // ~-100 years</span>
<a href="#l29.1046"></a><span id="l29.1046">               valueBox.max = 40000; // ~100 years</span>
<a href="#l29.1047"></a><span id="l29.1047">               this.setAttribute(&quot;selectedIndex&quot;, &quot;9&quot;);</span>
<a href="#l29.1048"></a><span id="l29.1048" class="difflineminus">-            }</span>
<a href="#l29.1049"></a><span id="l29.1049" class="difflineminus">-            else if (val == Ci.nsMsgSearchAttrib.Size) {</span>
<a href="#l29.1050"></a><span id="l29.1050" class="difflineplus">+            } else if (val == Ci.nsMsgSearchAttrib.Size) {</span>
<a href="#l29.1051"></a><span id="l29.1051">               let valueBox = document.getAnonymousNodes(this)[9];</span>
<a href="#l29.1052"></a><span id="l29.1052">               valueBox.min = 0;</span>
<a href="#l29.1053"></a><span id="l29.1053">               valueBox.max = 1000000000;</span>
<a href="#l29.1054"></a><span id="l29.1054">               this.setAttribute(&quot;selectedIndex&quot;, &quot;9&quot;);</span>
<a href="#l29.1055"></a><span id="l29.1055" class="difflineminus">-            }</span>
<a href="#l29.1056"></a><span id="l29.1056" class="difflineminus">-            else if (val == Ci.nsMsgSearchAttrib.JunkPercent) {</span>
<a href="#l29.1057"></a><span id="l29.1057" class="difflineplus">+            } else if (val == Ci.nsMsgSearchAttrib.JunkPercent) {</span>
<a href="#l29.1058"></a><span id="l29.1058">               let valueBox = document.getAnonymousNodes(this)[9];</span>
<a href="#l29.1059"></a><span id="l29.1059">               valueBox.min = 0;</span>
<a href="#l29.1060"></a><span id="l29.1060">               valueBox.max = 100;</span>
<a href="#l29.1061"></a><span id="l29.1061">               this.setAttribute(&quot;selectedIndex&quot;, &quot;9&quot;);</span>
<a href="#l29.1062"></a><span id="l29.1062" class="difflineminus">-            }</span>
<a href="#l29.1063"></a><span id="l29.1063" class="difflineminus">-            else {</span>
<a href="#l29.1064"></a><span id="l29.1064" class="difflineplus">+            } else {</span>
<a href="#l29.1065"></a><span id="l29.1065">               // a normal text field</span>
<a href="#l29.1066"></a><span id="l29.1066">               this.setAttribute(&quot;selectedIndex&quot;, &quot;0&quot;);</span>
<a href="#l29.1067"></a><span id="l29.1067">             }</span>
<a href="#l29.1068"></a><span id="l29.1068">             return val;</span>
<a href="#l29.1069"></a><span id="l29.1069">           ]]&gt;</span>
<a href="#l29.1070"></a><span id="l29.1070">         &lt;/setter&gt;</span>
<a href="#l29.1071"></a><span id="l29.1071">       &lt;/property&gt;</span>
<a href="#l29.1072"></a><span id="l29.1072">       &lt;property name=&quot;value&quot; onget=&quot;return this.internalValue;&quot;&gt;</span>
<a href="#l29.1073"></a><span id="l29.1073">         &lt;setter&gt;</span>
<a href="#l29.1074"></a><span id="l29.1074">           &lt;![CDATA[</span>
<a href="#l29.1075"></a><span id="l29.1075">           // val is a nsIMsgSearchValue object</span>
<a href="#l29.1076"></a><span id="l29.1076">           this.internalValue = val;</span>
<a href="#l29.1077"></a><span id="l29.1077">           var attrib = this.internalAttribute;</span>
<a href="#l29.1078"></a><span id="l29.1078">           var nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l29.1079"></a><span id="l29.1079">           var children = document.getAnonymousNodes(this);</span>
<a href="#l29.1080"></a><span id="l29.1080">           this.searchAttribute = attrib;</span>
<a href="#l29.1081"></a><span id="l29.1081" class="difflineminus">-          if (isNaN(attrib)) // a custom term</span>
<a href="#l29.1082"></a><span id="l29.1082" class="difflineminus">-          {</span>
<a href="#l29.1083"></a><span id="l29.1083" class="difflineplus">+          if (isNaN(attrib)) { // a custom term</span>
<a href="#l29.1084"></a><span id="l29.1084">             let customHbox = document.getAnonymousNodes(this)[10];</span>
<a href="#l29.1085"></a><span id="l29.1085">             customHbox.setAttribute(&quot;value&quot;, val.str);</span>
<a href="#l29.1086"></a><span id="l29.1086">             return val;</span>
<a href="#l29.1087"></a><span id="l29.1087">           }</span>
<a href="#l29.1088"></a><span id="l29.1088">           if (attrib == nsMsgSearchAttrib.Priority) {</span>
<a href="#l29.1089"></a><span id="l29.1089">             var matchingPriority =</span>
<a href="#l29.1090"></a><span id="l29.1090" class="difflineminus">-              children[1].querySelector('[value=&quot;' + val.priority + '&quot;]');</span>
<a href="#l29.1091"></a><span id="l29.1091" class="difflineplus">+              children[1].querySelector(`[value=&quot;${val.priority}&quot;]`);</span>
<a href="#l29.1092"></a><span id="l29.1092">             if (matchingPriority)</span>
<a href="#l29.1093"></a><span id="l29.1093">               children[1].selectedItem = matchingPriority;</span>
<a href="#l29.1094"></a><span id="l29.1094" class="difflineminus">-          }</span>
<a href="#l29.1095"></a><span id="l29.1095" class="difflineminus">-          else if (attrib == nsMsgSearchAttrib.MsgStatus) {</span>
<a href="#l29.1096"></a><span id="l29.1096" class="difflineplus">+          } else if (attrib == nsMsgSearchAttrib.MsgStatus) {</span>
<a href="#l29.1097"></a><span id="l29.1097">             var matchingStatus =</span>
<a href="#l29.1098"></a><span id="l29.1098" class="difflineminus">-              children[2].querySelector('[value=&quot;' + val.status + '&quot;]');</span>
<a href="#l29.1099"></a><span id="l29.1099" class="difflineplus">+              children[2].querySelector(`[value=&quot;${val.status}&quot;]`);</span>
<a href="#l29.1100"></a><span id="l29.1100">             if (matchingStatus)</span>
<a href="#l29.1101"></a><span id="l29.1101">               children[2].selectedItem = matchingStatus;</span>
<a href="#l29.1102"></a><span id="l29.1102" class="difflineminus">-          }</span>
<a href="#l29.1103"></a><span id="l29.1103" class="difflineminus">-          else if (attrib == nsMsgSearchAttrib.AgeInDays)</span>
<a href="#l29.1104"></a><span id="l29.1104" class="difflineplus">+          } else if (attrib == nsMsgSearchAttrib.AgeInDays) {</span>
<a href="#l29.1105"></a><span id="l29.1105">             children[9].value = val.age;</span>
<a href="#l29.1106"></a><span id="l29.1106" class="difflineminus">-          else if (attrib == nsMsgSearchAttrib.Date)</span>
<a href="#l29.1107"></a><span id="l29.1107" class="difflineplus">+          } else if (attrib == nsMsgSearchAttrib.Date) {</span>
<a href="#l29.1108"></a><span id="l29.1108">             children[3].value = convertPRTimeToString(val.date);</span>
<a href="#l29.1109"></a><span id="l29.1109" class="difflineminus">-          else if (attrib == nsMsgSearchAttrib.Sender ||</span>
<a href="#l29.1110"></a><span id="l29.1110" class="difflineminus">-                   attrib == nsMsgSearchAttrib.To ||</span>
<a href="#l29.1111"></a><span id="l29.1111" class="difflineminus">-                   attrib == nsMsgSearchAttrib.CC ||</span>
<a href="#l29.1112"></a><span id="l29.1112" class="difflineminus">-                   attrib == nsMsgSearchAttrib.AllAddresses ||</span>
<a href="#l29.1113"></a><span id="l29.1113" class="difflineminus">-                   attrib == nsMsgSearchAttrib.ToOrCC)</span>
<a href="#l29.1114"></a><span id="l29.1114" class="difflineminus">-          {</span>
<a href="#l29.1115"></a><span id="l29.1115" class="difflineplus">+          } else if (attrib == nsMsgSearchAttrib.Sender ||</span>
<a href="#l29.1116"></a><span id="l29.1116" class="difflineplus">+                     attrib == nsMsgSearchAttrib.To ||</span>
<a href="#l29.1117"></a><span id="l29.1117" class="difflineplus">+                     attrib == nsMsgSearchAttrib.CC ||</span>
<a href="#l29.1118"></a><span id="l29.1118" class="difflineplus">+                     attrib == nsMsgSearchAttrib.AllAddresses ||</span>
<a href="#l29.1119"></a><span id="l29.1119" class="difflineplus">+                     attrib == nsMsgSearchAttrib.ToOrCC) {</span>
<a href="#l29.1120"></a><span id="l29.1120">             if (this.internalOperator == Ci.nsMsgSearchOp.IsntInAB ||</span>
<a href="#l29.1121"></a><span id="l29.1121">                 this.internalOperator == Ci.nsMsgSearchOp.IsInAB) {</span>
<a href="#l29.1122"></a><span id="l29.1122" class="difflineminus">-              var abs = children[4].querySelector('[value=&quot;' + val.str + '&quot;]');</span>
<a href="#l29.1123"></a><span id="l29.1123" class="difflineplus">+              var abs = children[4].querySelector(`[value=&quot;${val.str}&quot;]`);</span>
<a href="#l29.1124"></a><span id="l29.1124">               if (abs)</span>
<a href="#l29.1125"></a><span id="l29.1125">                 children[4].selectedItem = abs;</span>
<a href="#l29.1126"></a><span id="l29.1126" class="difflineminus">-            }</span>
<a href="#l29.1127"></a><span id="l29.1127" class="difflineminus">-            else</span>
<a href="#l29.1128"></a><span id="l29.1128" class="difflineplus">+            } else {</span>
<a href="#l29.1129"></a><span id="l29.1129">               children[0].value = val.str;</span>
<a href="#l29.1130"></a><span id="l29.1130" class="difflineminus">-          }</span>
<a href="#l29.1131"></a><span id="l29.1131" class="difflineminus">-          else if (attrib == nsMsgSearchAttrib.Keywords)</span>
<a href="#l29.1132"></a><span id="l29.1132" class="difflineminus">-          {</span>
<a href="#l29.1133"></a><span id="l29.1133" class="difflineminus">-            var keywordVal = children[5].querySelector('[value=&quot;' + val.str + '&quot;]');</span>
<a href="#l29.1134"></a><span id="l29.1134" class="difflineminus">-            if (keywordVal)</span>
<a href="#l29.1135"></a><span id="l29.1135" class="difflineminus">-            {</span>
<a href="#l29.1136"></a><span id="l29.1136" class="difflineplus">+            }</span>
<a href="#l29.1137"></a><span id="l29.1137" class="difflineplus">+          } else if (attrib == nsMsgSearchAttrib.Keywords) {</span>
<a href="#l29.1138"></a><span id="l29.1138" class="difflineplus">+            var keywordVal = children[5].querySelector(`[value=&quot;${val.str}&quot;]`);</span>
<a href="#l29.1139"></a><span id="l29.1139" class="difflineplus">+            if (keywordVal) {</span>
<a href="#l29.1140"></a><span id="l29.1140">               children[5].value = val.str;</span>
<a href="#l29.1141"></a><span id="l29.1141">               children[5].selectedItem = keywordVal;</span>
<a href="#l29.1142"></a><span id="l29.1142">             }</span>
<a href="#l29.1143"></a><span id="l29.1143" class="difflineminus">-          }</span>
<a href="#l29.1144"></a><span id="l29.1144" class="difflineminus">-          else if (attrib == nsMsgSearchAttrib.JunkStatus) {</span>
<a href="#l29.1145"></a><span id="l29.1145" class="difflineplus">+          } else if (attrib == nsMsgSearchAttrib.JunkStatus) {</span>
<a href="#l29.1146"></a><span id="l29.1146">             var junkStatus =</span>
<a href="#l29.1147"></a><span id="l29.1147" class="difflineminus">-              children[6].querySelector('[value=&quot;' + val.junkStatus + '&quot;]');</span>
<a href="#l29.1148"></a><span id="l29.1148" class="difflineplus">+              children[6].querySelector(`[value=&quot;${val.junkStatus}&quot;]`);</span>
<a href="#l29.1149"></a><span id="l29.1149">             if (junkStatus)</span>
<a href="#l29.1150"></a><span id="l29.1150">               children[6].selectedItem = junkStatus;</span>
<a href="#l29.1151"></a><span id="l29.1151" class="difflineminus">-          }</span>
<a href="#l29.1152"></a><span id="l29.1152" class="difflineminus">-          else if (attrib == nsMsgSearchAttrib.HasAttachmentStatus) {</span>
<a href="#l29.1153"></a><span id="l29.1153" class="difflineplus">+          } else if (attrib == nsMsgSearchAttrib.HasAttachmentStatus) {</span>
<a href="#l29.1154"></a><span id="l29.1154">             var hasAttachmentStatus =</span>
<a href="#l29.1155"></a><span id="l29.1155" class="difflineminus">-              children[7].querySelector('[value=&quot;' + val.hasAttachmentStatus + '&quot;]');</span>
<a href="#l29.1156"></a><span id="l29.1156" class="difflineplus">+              children[7].querySelector(`[value=&quot;${val.hasAttachmentStatus}&quot;]`);</span>
<a href="#l29.1157"></a><span id="l29.1157">             if (hasAttachmentStatus)</span>
<a href="#l29.1158"></a><span id="l29.1158">               children[7].selectedItem = hasAttachmentStatus;</span>
<a href="#l29.1159"></a><span id="l29.1159" class="difflineminus">-          }</span>
<a href="#l29.1160"></a><span id="l29.1160" class="difflineminus">-          else if (attrib == nsMsgSearchAttrib.JunkScoreOrigin) {</span>
<a href="#l29.1161"></a><span id="l29.1161" class="difflineplus">+          } else if (attrib == nsMsgSearchAttrib.JunkScoreOrigin) {</span>
<a href="#l29.1162"></a><span id="l29.1162">             var junkScoreOrigin =</span>
<a href="#l29.1163"></a><span id="l29.1163" class="difflineminus">-              children[8].querySelector('[value=&quot;' + val.str + '&quot;]');</span>
<a href="#l29.1164"></a><span id="l29.1164" class="difflineplus">+              children[8].querySelector(`[value=&quot;${val.str}&quot;]`);</span>
<a href="#l29.1165"></a><span id="l29.1165">             if (junkScoreOrigin)</span>
<a href="#l29.1166"></a><span id="l29.1166">               children[8].selectedItem = junkScoreOrigin;</span>
<a href="#l29.1167"></a><span id="l29.1167" class="difflineminus">-          }</span>
<a href="#l29.1168"></a><span id="l29.1168" class="difflineminus">-          else if (attrib == nsMsgSearchAttrib.JunkPercent) {</span>
<a href="#l29.1169"></a><span id="l29.1169" class="difflineplus">+          } else if (attrib == nsMsgSearchAttrib.JunkPercent) {</span>
<a href="#l29.1170"></a><span id="l29.1170">             children[9].value = val.junkPercent;</span>
<a href="#l29.1171"></a><span id="l29.1171" class="difflineplus">+          } else if (attrib == nsMsgSearchAttrib.Size) {</span>
<a href="#l29.1172"></a><span id="l29.1172" class="difflineplus">+            children[9].value = val.size;</span>
<a href="#l29.1173"></a><span id="l29.1173" class="difflineplus">+          } else {</span>
<a href="#l29.1174"></a><span id="l29.1174" class="difflineplus">+            children[0].value = val.str;</span>
<a href="#l29.1175"></a><span id="l29.1175">           }</span>
<a href="#l29.1176"></a><span id="l29.1176" class="difflineminus">-          else if (attrib == nsMsgSearchAttrib.Size) {</span>
<a href="#l29.1177"></a><span id="l29.1177" class="difflineminus">-            children[9].value = val.size;</span>
<a href="#l29.1178"></a><span id="l29.1178" class="difflineminus">-          }</span>
<a href="#l29.1179"></a><span id="l29.1179" class="difflineminus">-          else</span>
<a href="#l29.1180"></a><span id="l29.1180" class="difflineminus">-            children[0].value = val.str;</span>
<a href="#l29.1181"></a><span id="l29.1181">           return val;</span>
<a href="#l29.1182"></a><span id="l29.1182">           ]]&gt;</span>
<a href="#l29.1183"></a><span id="l29.1183">         &lt;/setter&gt;</span>
<a href="#l29.1184"></a><span id="l29.1184">       &lt;/property&gt;</span>
<a href="#l29.1185"></a><span id="l29.1185">       &lt;method name=&quot;save&quot;&gt;</span>
<a href="#l29.1186"></a><span id="l29.1186">         &lt;body&gt;</span>
<a href="#l29.1187"></a><span id="l29.1187">           &lt;![CDATA[</span>
<a href="#l29.1188"></a><span id="l29.1188">             var searchValue = this.value;</span>
<a href="#l29.1189"></a><span id="l29.1189">             var searchAttribute = this.searchAttribute;</span>
<a href="#l29.1190"></a><span id="l29.1190">             var nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l29.1191"></a><span id="l29.1191">             var children = document.getAnonymousNodes(this);</span>
<a href="#l29.1192"></a><span id="l29.1192"> </span>
<a href="#l29.1193"></a><span id="l29.1193">             searchValue.attrib = searchAttribute;</span>
<a href="#l29.1194"></a><span id="l29.1194">             if (searchAttribute == nsMsgSearchAttrib.Priority) {</span>
<a href="#l29.1195"></a><span id="l29.1195" class="difflineminus">-               searchValue.priority = children[1].selectedItem.value;</span>
<a href="#l29.1196"></a><span id="l29.1196" class="difflineminus">-            }</span>
<a href="#l29.1197"></a><span id="l29.1197" class="difflineminus">-            else if (searchAttribute == nsMsgSearchAttrib.MsgStatus)</span>
<a href="#l29.1198"></a><span id="l29.1198" class="difflineminus">-               searchValue.status = children[2].value;</span>
<a href="#l29.1199"></a><span id="l29.1199" class="difflineminus">-            else if (searchAttribute == nsMsgSearchAttrib.AgeInDays)</span>
<a href="#l29.1200"></a><span id="l29.1200" class="difflineminus">-               searchValue.age = children[9].value;</span>
<a href="#l29.1201"></a><span id="l29.1201" class="difflineminus">-            else if (searchAttribute == nsMsgSearchAttrib.Date)</span>
<a href="#l29.1202"></a><span id="l29.1202" class="difflineminus">-               searchValue.date = convertStringToPRTime(children[3].value);</span>
<a href="#l29.1203"></a><span id="l29.1203" class="difflineminus">-            else if (searchAttribute == nsMsgSearchAttrib.Sender ||</span>
<a href="#l29.1204"></a><span id="l29.1204" class="difflineminus">-                   searchAttribute == nsMsgSearchAttrib.To ||</span>
<a href="#l29.1205"></a><span id="l29.1205" class="difflineminus">-                   searchAttribute == nsMsgSearchAttrib.CC ||</span>
<a href="#l29.1206"></a><span id="l29.1206" class="difflineminus">-                   searchAttribute == nsMsgSearchAttrib.AllAddresses ||</span>
<a href="#l29.1207"></a><span id="l29.1207" class="difflineminus">-                   searchAttribute == nsMsgSearchAttrib.ToOrCC)</span>
<a href="#l29.1208"></a><span id="l29.1208" class="difflineminus">-            {</span>
<a href="#l29.1209"></a><span id="l29.1209" class="difflineplus">+              searchValue.priority = children[1].selectedItem.value;</span>
<a href="#l29.1210"></a><span id="l29.1210" class="difflineplus">+            } else if (searchAttribute == nsMsgSearchAttrib.MsgStatus) {</span>
<a href="#l29.1211"></a><span id="l29.1211" class="difflineplus">+              searchValue.status = children[2].value;</span>
<a href="#l29.1212"></a><span id="l29.1212" class="difflineplus">+            } else if (searchAttribute == nsMsgSearchAttrib.AgeInDays) {</span>
<a href="#l29.1213"></a><span id="l29.1213" class="difflineplus">+              searchValue.age = children[9].value;</span>
<a href="#l29.1214"></a><span id="l29.1214" class="difflineplus">+            } else if (searchAttribute == nsMsgSearchAttrib.Date) {</span>
<a href="#l29.1215"></a><span id="l29.1215" class="difflineplus">+              searchValue.date = convertStringToPRTime(children[3].value);</span>
<a href="#l29.1216"></a><span id="l29.1216" class="difflineplus">+            } else if (searchAttribute == nsMsgSearchAttrib.Sender ||</span>
<a href="#l29.1217"></a><span id="l29.1217" class="difflineplus">+                       searchAttribute == nsMsgSearchAttrib.To ||</span>
<a href="#l29.1218"></a><span id="l29.1218" class="difflineplus">+                       searchAttribute == nsMsgSearchAttrib.CC ||</span>
<a href="#l29.1219"></a><span id="l29.1219" class="difflineplus">+                       searchAttribute == nsMsgSearchAttrib.AllAddresses ||</span>
<a href="#l29.1220"></a><span id="l29.1220" class="difflineplus">+                       searchAttribute == nsMsgSearchAttrib.ToOrCC) {</span>
<a href="#l29.1221"></a><span id="l29.1221">               if (this.internalOperator == Ci.nsMsgSearchOp.IsntInAB ||</span>
<a href="#l29.1222"></a><span id="l29.1222" class="difflineminus">-                  this.internalOperator == Ci.nsMsgSearchOp.IsInAB)</span>
<a href="#l29.1223"></a><span id="l29.1223" class="difflineplus">+                  this.internalOperator == Ci.nsMsgSearchOp.IsInAB) {</span>
<a href="#l29.1224"></a><span id="l29.1224">                 searchValue.str = children[4].selectedItem.value;</span>
<a href="#l29.1225"></a><span id="l29.1225" class="difflineminus">-              else</span>
<a href="#l29.1226"></a><span id="l29.1226" class="difflineplus">+              } else {</span>
<a href="#l29.1227"></a><span id="l29.1227">                 searchValue.str = children[0].value;</span>
<a href="#l29.1228"></a><span id="l29.1228" class="difflineminus">-            }</span>
<a href="#l29.1229"></a><span id="l29.1229" class="difflineminus">-            else if (searchAttribute == nsMsgSearchAttrib.Keywords)</span>
<a href="#l29.1230"></a><span id="l29.1230" class="difflineminus">-            {</span>
<a href="#l29.1231"></a><span id="l29.1231" class="difflineplus">+              }</span>
<a href="#l29.1232"></a><span id="l29.1232" class="difflineplus">+            } else if (searchAttribute == nsMsgSearchAttrib.Keywords) {</span>
<a href="#l29.1233"></a><span id="l29.1233">               searchValue.str = children[5].value;</span>
<a href="#l29.1234"></a><span id="l29.1234" class="difflineminus">-            }</span>
<a href="#l29.1235"></a><span id="l29.1235" class="difflineminus">-            else if (searchAttribute == nsMsgSearchAttrib.JunkStatus)</span>
<a href="#l29.1236"></a><span id="l29.1236" class="difflineminus">-               searchValue.junkStatus = children[6].value;</span>
<a href="#l29.1237"></a><span id="l29.1237" class="difflineminus">-            else if (searchAttribute == nsMsgSearchAttrib.JunkPercent)</span>
<a href="#l29.1238"></a><span id="l29.1238" class="difflineminus">-               searchValue.junkPercent = children[9].value;</span>
<a href="#l29.1239"></a><span id="l29.1239" class="difflineminus">-            else if (searchAttribute == nsMsgSearchAttrib.Size)</span>
<a href="#l29.1240"></a><span id="l29.1240" class="difflineminus">-               searchValue.size = children[9].value;</span>
<a href="#l29.1241"></a><span id="l29.1241" class="difflineminus">-            else if (searchAttribute == nsMsgSearchAttrib.HasAttachmentStatus)</span>
<a href="#l29.1242"></a><span id="l29.1242" class="difflineminus">-               searchValue.status = 0x10000000;  // 0x10000000 is MSG_FLAG_ATTACHMENT;</span>
<a href="#l29.1243"></a><span id="l29.1243" class="difflineminus">-            else if (searchAttribute == nsMsgSearchAttrib.JunkScoreOrigin)</span>
<a href="#l29.1244"></a><span id="l29.1244" class="difflineminus">-               searchValue.str = children[8].value;</span>
<a href="#l29.1245"></a><span id="l29.1245" class="difflineminus">-            else if (isNaN(searchAttribute)) //  a custom term</span>
<a href="#l29.1246"></a><span id="l29.1246" class="difflineminus">-            {</span>
<a href="#l29.1247"></a><span id="l29.1247" class="difflineplus">+            } else if (searchAttribute == nsMsgSearchAttrib.JunkStatus) {</span>
<a href="#l29.1248"></a><span id="l29.1248" class="difflineplus">+              searchValue.junkStatus = children[6].value;</span>
<a href="#l29.1249"></a><span id="l29.1249" class="difflineplus">+            } else if (searchAttribute == nsMsgSearchAttrib.JunkPercent) {</span>
<a href="#l29.1250"></a><span id="l29.1250" class="difflineplus">+              searchValue.junkPercent = children[9].value;</span>
<a href="#l29.1251"></a><span id="l29.1251" class="difflineplus">+            } else if (searchAttribute == nsMsgSearchAttrib.Size) {</span>
<a href="#l29.1252"></a><span id="l29.1252" class="difflineplus">+              searchValue.size = children[9].value;</span>
<a href="#l29.1253"></a><span id="l29.1253" class="difflineplus">+            } else if (searchAttribute == nsMsgSearchAttrib.HasAttachmentStatus) {</span>
<a href="#l29.1254"></a><span id="l29.1254" class="difflineplus">+              searchValue.status = 0x10000000;  // 0x10000000 is MSG_FLAG_ATTACHMENT;</span>
<a href="#l29.1255"></a><span id="l29.1255" class="difflineplus">+            } else if (searchAttribute == nsMsgSearchAttrib.JunkScoreOrigin) {</span>
<a href="#l29.1256"></a><span id="l29.1256" class="difflineplus">+              searchValue.str = children[8].value;</span>
<a href="#l29.1257"></a><span id="l29.1257" class="difflineplus">+            } else if (isNaN(searchAttribute)) { // a custom term</span>
<a href="#l29.1258"></a><span id="l29.1258">               searchValue.attrib = nsMsgSearchAttrib.Custom;</span>
<a href="#l29.1259"></a><span id="l29.1259">               searchValue.str = children[10].getAttribute(&quot;value&quot;);</span>
<a href="#l29.1260"></a><span id="l29.1260" class="difflineplus">+            } else {</span>
<a href="#l29.1261"></a><span id="l29.1261" class="difflineplus">+              searchValue.str = children[0].value;</span>
<a href="#l29.1262"></a><span id="l29.1262">             }</span>
<a href="#l29.1263"></a><span id="l29.1263" class="difflineminus">-            else</span>
<a href="#l29.1264"></a><span id="l29.1264" class="difflineminus">-              searchValue.str = children[0].value;</span>
<a href="#l29.1265"></a><span id="l29.1265">           ]]&gt;</span>
<a href="#l29.1266"></a><span id="l29.1266">         &lt;/body&gt;</span>
<a href="#l29.1267"></a><span id="l29.1267">       &lt;/method&gt;</span>
<a href="#l29.1268"></a><span id="l29.1268">       &lt;method name=&quot;saveTo&quot;&gt;</span>
<a href="#l29.1269"></a><span id="l29.1269">         &lt;parameter name=&quot;searchValue&quot;/&gt;</span>
<a href="#l29.1270"></a><span id="l29.1270">         &lt;body&gt;</span>
<a href="#l29.1271"></a><span id="l29.1271">           &lt;![CDATA[</span>
<a href="#l29.1272"></a><span id="l29.1272">             this.internalValue = searchValue;</span>
<a href="#l29.1273"></a><span id="l29.1273" class="difflineat">@@ -1781,37 +1731,36 @@</span>
<a href="#l29.1274"></a><span id="l29.1274">         &lt;/body&gt;</span>
<a href="#l29.1275"></a><span id="l29.1275">       &lt;/method&gt;</span>
<a href="#l29.1276"></a><span id="l29.1276">       &lt;method name=&quot;fillInTags&quot;&gt;</span>
<a href="#l29.1277"></a><span id="l29.1277">         &lt;body&gt;</span>
<a href="#l29.1278"></a><span id="l29.1278">           &lt;![CDATA[</span>
<a href="#l29.1279"></a><span id="l29.1279">             var children = document.getAnonymousNodes(this);</span>
<a href="#l29.1280"></a><span id="l29.1280">             var popupMenu = children[5].firstChild;</span>
<a href="#l29.1281"></a><span id="l29.1281">             let tagArray = MailServices.tags.getAllTags({});</span>
<a href="#l29.1282"></a><span id="l29.1282" class="difflineminus">-            for (var i = 0; i &lt; tagArray.length; ++i)</span>
<a href="#l29.1283"></a><span id="l29.1283" class="difflineminus">-            {</span>
<a href="#l29.1284"></a><span id="l29.1284" class="difflineplus">+            for (var i = 0; i &lt; tagArray.length; ++i) {</span>
<a href="#l29.1285"></a><span id="l29.1285">               var taginfo = tagArray[i];</span>
<a href="#l29.1286"></a><span id="l29.1286" class="difflineminus">-              var newMenuItem = document.createElement('menuitem');</span>
<a href="#l29.1287"></a><span id="l29.1287" class="difflineminus">-              newMenuItem.setAttribute('label', taginfo.tag);</span>
<a href="#l29.1288"></a><span id="l29.1288" class="difflineminus">-              newMenuItem.setAttribute('value', taginfo.key);</span>
<a href="#l29.1289"></a><span id="l29.1289" class="difflineplus">+              var newMenuItem = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l29.1290"></a><span id="l29.1290" class="difflineplus">+              newMenuItem.setAttribute(&quot;label&quot;, taginfo.tag);</span>
<a href="#l29.1291"></a><span id="l29.1291" class="difflineplus">+              newMenuItem.setAttribute(&quot;value&quot;, taginfo.key);</span>
<a href="#l29.1292"></a><span id="l29.1292">               popupMenu.appendChild(newMenuItem);</span>
<a href="#l29.1293"></a><span id="l29.1293">               if (!i)</span>
<a href="#l29.1294"></a><span id="l29.1294">                 children[5].selectedItem = newMenuItem;</span>
<a href="#l29.1295"></a><span id="l29.1295">             }</span>
<a href="#l29.1296"></a><span id="l29.1296">           ]]&gt;</span>
<a href="#l29.1297"></a><span id="l29.1297">         &lt;/body&gt;</span>
<a href="#l29.1298"></a><span id="l29.1298">       &lt;/method&gt;</span>
<a href="#l29.1299"></a><span id="l29.1299">       &lt;method name=&quot;fillStringsForChildren&quot;&gt;</span>
<a href="#l29.1300"></a><span id="l29.1300">         &lt;parameter name=&quot;parentNode&quot;/&gt;</span>
<a href="#l29.1301"></a><span id="l29.1301">         &lt;parameter name=&quot;bundle&quot;/&gt;</span>
<a href="#l29.1302"></a><span id="l29.1302">         &lt;body&gt;</span>
<a href="#l29.1303"></a><span id="l29.1303">           &lt;![CDATA[</span>
<a href="#l29.1304"></a><span id="l29.1304">             var children = parentNode.childNodes;</span>
<a href="#l29.1305"></a><span id="l29.1305" class="difflineminus">-            var len=children.length;</span>
<a href="#l29.1306"></a><span id="l29.1306" class="difflineminus">-            for (var i=0; i&lt;len; i++) {</span>
<a href="#l29.1307"></a><span id="l29.1307" class="difflineplus">+            var len = children.length;</span>
<a href="#l29.1308"></a><span id="l29.1308" class="difflineplus">+            for (var i = 0; i &lt; len; i++) {</span>
<a href="#l29.1309"></a><span id="l29.1309">               var node = children[i];</span>
<a href="#l29.1310"></a><span id="l29.1310">               var stringTag = node.getAttribute(&quot;stringTag&quot;);</span>
<a href="#l29.1311"></a><span id="l29.1311">               if (stringTag) {</span>
<a href="#l29.1312"></a><span id="l29.1312">                 var attr = (node.tagName == &quot;label&quot;) ? &quot;value&quot; : &quot;label&quot;;</span>
<a href="#l29.1313"></a><span id="l29.1313">                 node.setAttribute(attr, bundle.GetStringFromName(stringTag));</span>
<a href="#l29.1314"></a><span id="l29.1314">               }</span>
<a href="#l29.1315"></a><span id="l29.1315">             }</span>
<a href="#l29.1316"></a><span id="l29.1316">           ]]&gt;</span>
<a href="#l29.1317"></a><span id="l29.1317" class="difflineat">@@ -1920,23 +1869,23 @@</span>
<a href="#l29.1318"></a><span id="l29.1318">         &lt;/body&gt;</span>
<a href="#l29.1319"></a><span id="l29.1319">       &lt;/method&gt;</span>
<a href="#l29.1320"></a><span id="l29.1320">       &lt;field name=&quot;onKeyPressMenuList&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l29.1321"></a><span id="l29.1321">         &lt;![CDATA[</span>
<a href="#l29.1322"></a><span id="l29.1322">           ({</span>
<a href="#l29.1323"></a><span id="l29.1323">             self: this,</span>
<a href="#l29.1324"></a><span id="l29.1324">             tree: this.tree,</span>
<a href="#l29.1325"></a><span id="l29.1325">             parentNode: this.parentNode,</span>
<a href="#l29.1326"></a><span id="l29.1326" class="difflineminus">-            getLastVisibleRow: function getLastVisibleRow(box) {</span>
<a href="#l29.1327"></a><span id="l29.1327" class="difflineplus">+            getLastVisibleRow(box) {</span>
<a href="#l29.1328"></a><span id="l29.1328">               var f = box.getFirstVisibleRow();</span>
<a href="#l29.1329"></a><span id="l29.1329">               var p = box.getPageLength();</span>
<a href="#l29.1330"></a><span id="l29.1330">               var l = box.view.rowCount;</span>
<a href="#l29.1331"></a><span id="l29.1331">               return (l &lt; f + p ? l : f + p) - 1;</span>
<a href="#l29.1332"></a><span id="l29.1332">             },</span>
<a href="#l29.1333"></a><span id="l29.1333" class="difflineminus">-            handleEvent: function handleEvent(event) {</span>
<a href="#l29.1334"></a><span id="l29.1334" class="difflineplus">+            handleEvent(event) {</span>
<a href="#l29.1335"></a><span id="l29.1335">               if (event.altKey)</span>
<a href="#l29.1336"></a><span id="l29.1336">                 return;</span>
<a href="#l29.1337"></a><span id="l29.1337">               var index;</span>
<a href="#l29.1338"></a><span id="l29.1338">               var box = this.tree.treeBoxObject;</span>
<a href="#l29.1339"></a><span id="l29.1339">               if (this.parentNode.hasAttribute(&quot;open&quot;)) {</span>
<a href="#l29.1340"></a><span id="l29.1340">                 event.stopPropagation();</span>
<a href="#l29.1341"></a><span id="l29.1341">                 event.preventDefault();</span>
<a href="#l29.1342"></a><span id="l29.1342">                 switch (event.keyCode) {</span>
<a href="#l29.1343"></a><span id="l29.1343" class="difflineat">@@ -1992,17 +1941,17 @@</span>
<a href="#l29.1344"></a><span id="l29.1344">                   }</span>
<a href="#l29.1345"></a><span id="l29.1345">                   return;</span>
<a href="#l29.1346"></a><span id="l29.1346">               }</span>
<a href="#l29.1347"></a><span id="l29.1347">               box.view.selection.select(index);</span>
<a href="#l29.1348"></a><span id="l29.1348">               if (this.parentNode.hasAttribute(&quot;open&quot;))</span>
<a href="#l29.1349"></a><span id="l29.1349">                 box.ensureRowIsVisible(index);</span>
<a href="#l29.1350"></a><span id="l29.1350">               else</span>
<a href="#l29.1351"></a><span id="l29.1351">                 this.self.fire();</span>
<a href="#l29.1352"></a><span id="l29.1352" class="difflineminus">-            }</span>
<a href="#l29.1353"></a><span id="l29.1353" class="difflineplus">+            },</span>
<a href="#l29.1354"></a><span id="l29.1354">           })</span>
<a href="#l29.1355"></a><span id="l29.1355">         ]]&gt;</span>
<a href="#l29.1356"></a><span id="l29.1356">       &lt;/field&gt;</span>
<a href="#l29.1357"></a><span id="l29.1357">       &lt;method name=&quot;setInitialSelection&quot;&gt;</span>
<a href="#l29.1358"></a><span id="l29.1358">         &lt;body&gt;</span>
<a href="#l29.1359"></a><span id="l29.1359">           &lt;![CDATA[</span>
<a href="#l29.1360"></a><span id="l29.1360">             var view = this.tree.view;</span>
<a href="#l29.1361"></a><span id="l29.1361"> </span>
<a href="#l29.1362"></a><span id="l29.1362" class="difflineat">@@ -2142,17 +2091,17 @@</span>
<a href="#l29.1363"></a><span id="l29.1363">         if (this.getAttribute(&quot;active&quot;) != &quot;true&quot;) {</span>
<a href="#l29.1364"></a><span id="l29.1364">           this.setAttribute(&quot;active&quot;, &quot;true&quot;);</span>
<a href="#l29.1365"></a><span id="l29.1365"> </span>
<a href="#l29.1366"></a><span id="l29.1366">           this.dispatchEvent(new Event(&quot;DOMMenuItemActive&quot;,</span>
<a href="#l29.1367"></a><span id="l29.1367">                                        { bubbles: true, cancelable: false }));</span>
<a href="#l29.1368"></a><span id="l29.1368"> </span>
<a href="#l29.1369"></a><span id="l29.1369">           if (this.getAttribute(&quot;disabled&quot;) != &quot;true&quot;) {</span>
<a href="#l29.1370"></a><span id="l29.1370">             let self = this;</span>
<a href="#l29.1371"></a><span id="l29.1371" class="difflineminus">-            setTimeout(function () {</span>
<a href="#l29.1372"></a><span id="l29.1372" class="difflineplus">+            setTimeout(function() {</span>
<a href="#l29.1373"></a><span id="l29.1373">               if (self.getAttribute(&quot;active&quot;) == &quot;true&quot;)</span>
<a href="#l29.1374"></a><span id="l29.1374">                 self.menu.open = true;</span>
<a href="#l29.1375"></a><span id="l29.1375">             }, this._menuDelay);</span>
<a href="#l29.1376"></a><span id="l29.1376">           }</span>
<a href="#l29.1377"></a><span id="l29.1377">         }</span>
<a href="#l29.1378"></a><span id="l29.1378">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l29.1379"></a><span id="l29.1379"> </span>
<a href="#l29.1380"></a><span id="l29.1380">       &lt;handler event=&quot;popupshowing&quot;&gt;&lt;![CDATA[</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mail/base/content/mailWindow.js</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mail/base/content/mailWindow.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -6,34 +6,33 @@</span>
<a href="#l30.4"></a><span id="l30.4"> ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l30.5"></a><span id="l30.5"> ChromeUtils.import(&quot;resource:///modules/appIdleManager.js&quot;);</span>
<a href="#l30.6"></a><span id="l30.6"> ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l30.7"></a><span id="l30.7"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l30.8"></a><span id="l30.8"> ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l30.9"></a><span id="l30.9"> ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l30.10"></a><span id="l30.10"> ChromeUtils.import(&quot;resource:///modules/gloda/public.js&quot;);</span>
<a href="#l30.11"></a><span id="l30.11"> </span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-//This file stores variables common to mail windows</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+// This file stores variables common to mail windows</span>
<a href="#l30.14"></a><span id="l30.14"> var messenger;</span>
<a href="#l30.15"></a><span id="l30.15"> var statusFeedback;</span>
<a href="#l30.16"></a><span id="l30.16"> var msgWindow;</span>
<a href="#l30.17"></a><span id="l30.17"> </span>
<a href="#l30.18"></a><span id="l30.18"> var accountManager;</span>
<a href="#l30.19"></a><span id="l30.19"> </span>
<a href="#l30.20"></a><span id="l30.20"> var gContextMenu;</span>
<a href="#l30.21"></a><span id="l30.21"> var gMailWindowLog = Log4Moz.getConfiguredLogger(&quot;mailWindow&quot;, Log4Moz.Level.Debug, Log4Moz.Level.Debug, Log4Moz.Level.Debug);</span>
<a href="#l30.22"></a><span id="l30.22"> </span>
<a href="#l30.23"></a><span id="l30.23"> /**</span>
<a href="#l30.24"></a><span id="l30.24">  * Called by messageWindow.xul:onunload,  the 'single message display window'.</span>
<a href="#l30.25"></a><span id="l30.25">  *</span>
<a href="#l30.26"></a><span id="l30.26">  * Also called by messenger.xul:onunload's (the 3-pane window inside of tabs</span>
<a href="#l30.27"></a><span id="l30.27">  *  window) unload function, OnUnloadMessenger.</span>
<a href="#l30.28"></a><span id="l30.28">  */</span>
<a href="#l30.29"></a><span id="l30.29" class="difflineminus">-function OnMailWindowUnload()</span>
<a href="#l30.30"></a><span id="l30.30" class="difflineminus">-{</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineplus">+function OnMailWindowUnload() {</span>
<a href="#l30.32"></a><span id="l30.32">   MailOfflineMgr.uninit();</span>
<a href="#l30.33"></a><span id="l30.33">   ClearPendingReadTimer();</span>
<a href="#l30.34"></a><span id="l30.34"> </span>
<a href="#l30.35"></a><span id="l30.35">   // all dbview closing is handled by OnUnloadMessenger for the 3-pane (it closes</span>
<a href="#l30.36"></a><span id="l30.36">   //  the tabs which close their views) and OnUnloadMessageWindow for the</span>
<a href="#l30.37"></a><span id="l30.37">   //  standalone message window.</span>
<a href="#l30.38"></a><span id="l30.38"> </span>
<a href="#l30.39"></a><span id="l30.39">   MailServices.mailSession.RemoveMsgWindow(msgWindow);</span>
<a href="#l30.40"></a><span id="l30.40" class="difflineat">@@ -133,33 +132,31 @@ function onCopyOrDragStart(e) {</span>
<a href="#l30.41"></a><span id="l30.41">   let parserUtils = Cc[&quot;@mozilla.org/parserutils;1&quot;]</span>
<a href="#l30.42"></a><span id="l30.42">                       .getService(Ci.nsIParserUtils);</span>
<a href="#l30.43"></a><span id="l30.43">   let plain = parserUtils.convertToPlainText(html,</span>
<a href="#l30.44"></a><span id="l30.44">     Ci.nsIDocumentEncoder.OutputForPlainTextClipboardCopy, 0);</span>
<a href="#l30.45"></a><span id="l30.45">   if (&quot;clipboardData&quot; in e) { // copy</span>
<a href="#l30.46"></a><span id="l30.46">     e.clipboardData.setData(&quot;text/html&quot;, html);</span>
<a href="#l30.47"></a><span id="l30.47">     e.clipboardData.setData(&quot;text/plain&quot;, plain);</span>
<a href="#l30.48"></a><span id="l30.48">     e.preventDefault();</span>
<a href="#l30.49"></a><span id="l30.49" class="difflineminus">-  }</span>
<a href="#l30.50"></a><span id="l30.50" class="difflineminus">-  else if (&quot;dataTransfer&quot; in e) { // drag</span>
<a href="#l30.51"></a><span id="l30.51" class="difflineplus">+  } else if (&quot;dataTransfer&quot; in e) { // drag</span>
<a href="#l30.52"></a><span id="l30.52">     e.dataTransfer.setData(&quot;text/html&quot;, html);</span>
<a href="#l30.53"></a><span id="l30.53">     e.dataTransfer.setData(&quot;text/plain&quot;, plain);</span>
<a href="#l30.54"></a><span id="l30.54">   }</span>
<a href="#l30.55"></a><span id="l30.55"> }</span>
<a href="#l30.56"></a><span id="l30.56"> </span>
<a href="#l30.57"></a><span id="l30.57" class="difflineminus">-function CreateMailWindowGlobals()</span>
<a href="#l30.58"></a><span id="l30.58" class="difflineminus">-{</span>
<a href="#l30.59"></a><span id="l30.59" class="difflineplus">+function CreateMailWindowGlobals() {</span>
<a href="#l30.60"></a><span id="l30.60">   // get the messenger instance</span>
<a href="#l30.61"></a><span id="l30.61">   messenger = Cc[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l30.62"></a><span id="l30.62">                 .createInstance(Ci.nsIMessenger);</span>
<a href="#l30.63"></a><span id="l30.63"> </span>
<a href="#l30.64"></a><span id="l30.64">   window.addEventListener(&quot;blur&quot;, appIdleManager.onBlur);</span>
<a href="#l30.65"></a><span id="l30.65">   window.addEventListener(&quot;focus&quot;, appIdleManager.onFocus);</span>
<a href="#l30.66"></a><span id="l30.66"> </span>
<a href="#l30.67"></a><span id="l30.67" class="difflineminus">-  //Create windows status feedback</span>
<a href="#l30.68"></a><span id="l30.68" class="difflineplus">+  // Create windows status feedback</span>
<a href="#l30.69"></a><span id="l30.69">   // set the JS implementation of status feedback before creating the c++ one..</span>
<a href="#l30.70"></a><span id="l30.70">   window.MsgStatusFeedback = new nsMsgStatusFeedback();</span>
<a href="#l30.71"></a><span id="l30.71">   // double register the status feedback object as the xul browser window implementation</span>
<a href="#l30.72"></a><span id="l30.72">   window.QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l30.73"></a><span id="l30.73">         .getInterface(Ci.nsIWebNavigation)</span>
<a href="#l30.74"></a><span id="l30.74">         .QueryInterface(Ci.nsIDocShellTreeItem).treeOwner</span>
<a href="#l30.75"></a><span id="l30.75">         .QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l30.76"></a><span id="l30.76">         .getInterface(Ci.nsIXULWindow)</span>
<a href="#l30.77"></a><span id="l30.77" class="difflineat">@@ -171,27 +168,26 @@ function CreateMailWindowGlobals()</span>
<a href="#l30.78"></a><span id="l30.78">   statusFeedback = Cc[&quot;@mozilla.org/messenger/statusfeedback;1&quot;]</span>
<a href="#l30.79"></a><span id="l30.79">                      .createInstance(Ci.nsIMsgStatusFeedback);</span>
<a href="#l30.80"></a><span id="l30.80">   statusFeedback.setWrappedStatusFeedback(window.MsgStatusFeedback);</span>
<a href="#l30.81"></a><span id="l30.81"> </span>
<a href="#l30.82"></a><span id="l30.82">   Cc[&quot;@mozilla.org/activity-manager;1&quot;]</span>
<a href="#l30.83"></a><span id="l30.83">     .getService(Ci.nsIActivityManager)</span>
<a href="#l30.84"></a><span id="l30.84">     .addListener(window.MsgStatusFeedback);</span>
<a href="#l30.85"></a><span id="l30.85"> </span>
<a href="#l30.86"></a><span id="l30.86" class="difflineminus">-  //Create message window object</span>
<a href="#l30.87"></a><span id="l30.87" class="difflineplus">+  // Create message window object</span>
<a href="#l30.88"></a><span id="l30.88">   msgWindow = Cc[&quot;@mozilla.org/messenger/msgwindow;1&quot;]</span>
<a href="#l30.89"></a><span id="l30.89">                 .createInstance(Ci.nsIMsgWindow);</span>
<a href="#l30.90"></a><span id="l30.90"> </span>
<a href="#l30.91"></a><span id="l30.91">   accountManager = MailServices.accounts;</span>
<a href="#l30.92"></a><span id="l30.92"> </span>
<a href="#l30.93"></a><span id="l30.93">   msgWindow.notificationCallbacks = new BadCertHandler();</span>
<a href="#l30.94"></a><span id="l30.94"> }</span>
<a href="#l30.95"></a><span id="l30.95"> </span>
<a href="#l30.96"></a><span id="l30.96" class="difflineminus">-function InitMsgWindow()</span>
<a href="#l30.97"></a><span id="l30.97" class="difflineminus">-{</span>
<a href="#l30.98"></a><span id="l30.98" class="difflineplus">+function InitMsgWindow() {</span>
<a href="#l30.99"></a><span id="l30.99">   msgWindow.windowCommands = new nsMsgWindowCommands();</span>
<a href="#l30.100"></a><span id="l30.100">   // set the domWindow before setting the status feedback and header sink objects</span>
<a href="#l30.101"></a><span id="l30.101">   msgWindow.domWindow = window;</span>
<a href="#l30.102"></a><span id="l30.102">   msgWindow.statusFeedback = statusFeedback;</span>
<a href="#l30.103"></a><span id="l30.103">   msgWindow.msgHeaderSink = messageHeaderSink;</span>
<a href="#l30.104"></a><span id="l30.104">   MailServices.mailSession.AddMsgWindow(msgWindow);</span>
<a href="#l30.105"></a><span id="l30.105">   let messagepane = document.getElementById(&quot;messagepane&quot;);</span>
<a href="#l30.106"></a><span id="l30.106">   messagepane.docShell.allowAuth = false;</span>
<a href="#l30.107"></a><span id="l30.107" class="difflineat">@@ -203,31 +199,29 @@ function InitMsgWindow()</span>
<a href="#l30.108"></a><span id="l30.108"> </span>
<a href="#l30.109"></a><span id="l30.109">   document.addEventListener(&quot;copy&quot;, onCopyOrDragStart, true);</span>
<a href="#l30.110"></a><span id="l30.110">   document.addEventListener(&quot;dragstart&quot;, onCopyOrDragStart, true);</span>
<a href="#l30.111"></a><span id="l30.111"> }</span>
<a href="#l30.112"></a><span id="l30.112"> </span>
<a href="#l30.113"></a><span id="l30.113"> // We're going to implement our status feedback for the mail window in JS now.</span>
<a href="#l30.114"></a><span id="l30.114"> // the following contains the implementation of our status feedback object</span>
<a href="#l30.115"></a><span id="l30.115"> </span>
<a href="#l30.116"></a><span id="l30.116" class="difflineminus">-function nsMsgStatusFeedback()</span>
<a href="#l30.117"></a><span id="l30.117" class="difflineminus">-{</span>
<a href="#l30.118"></a><span id="l30.118" class="difflineplus">+function nsMsgStatusFeedback() {</span>
<a href="#l30.119"></a><span id="l30.119">   this._statusText = document.getElementById(&quot;statusText&quot;);</span>
<a href="#l30.120"></a><span id="l30.120">   this._statusPanel = document.getElementById(&quot;statusbar-display&quot;);</span>
<a href="#l30.121"></a><span id="l30.121">   this._progressBar = document.getElementById(&quot;statusbar-icon&quot;);</span>
<a href="#l30.122"></a><span id="l30.122">   this._progressBarContainer = document.getElementById(&quot;statusbar-progresspanel&quot;);</span>
<a href="#l30.123"></a><span id="l30.123">   this._throbber = document.getElementById(&quot;throbber-box&quot;);</span>
<a href="#l30.124"></a><span id="l30.124" class="difflineminus">-  this._activeProcesses = new Array();</span>
<a href="#l30.125"></a><span id="l30.125" class="difflineplus">+  this._activeProcesses = [];</span>
<a href="#l30.126"></a><span id="l30.126"> </span>
<a href="#l30.127"></a><span id="l30.127">   // make sure the stop button is accurate from the get-go</span>
<a href="#l30.128"></a><span id="l30.128">   goUpdateCommand(&quot;cmd_stop&quot;);</span>
<a href="#l30.129"></a><span id="l30.129"> }</span>
<a href="#l30.130"></a><span id="l30.130"> </span>
<a href="#l30.131"></a><span id="l30.131" class="difflineminus">-nsMsgStatusFeedback.prototype =</span>
<a href="#l30.132"></a><span id="l30.132" class="difflineminus">-{</span>
<a href="#l30.133"></a><span id="l30.133" class="difflineplus">+nsMsgStatusFeedback.prototype = {</span>
<a href="#l30.134"></a><span id="l30.134">   // Document elements.</span>
<a href="#l30.135"></a><span id="l30.135">   _statusText: null,</span>
<a href="#l30.136"></a><span id="l30.136">   _statusPanel: null,</span>
<a href="#l30.137"></a><span id="l30.137">   _progressBar: null,</span>
<a href="#l30.138"></a><span id="l30.138">   _progressBarContainer: null,</span>
<a href="#l30.139"></a><span id="l30.139">   _throbber: null,</span>
<a href="#l30.140"></a><span id="l30.140"> </span>
<a href="#l30.141"></a><span id="l30.141">   // Member variables.</span>
<a href="#l30.142"></a><span id="l30.142" class="difflineat">@@ -237,98 +231,98 @@ nsMsgStatusFeedback.prototype =</span>
<a href="#l30.143"></a><span id="l30.143">   _startRequests: 0,</span>
<a href="#l30.144"></a><span id="l30.144">   _meteorsSpinning: false,</span>
<a href="#l30.145"></a><span id="l30.145">   _defaultStatusText: null,</span>
<a href="#l30.146"></a><span id="l30.146">   _progressBarVisible: false,</span>
<a href="#l30.147"></a><span id="l30.147">   _activeProcesses: null,</span>
<a href="#l30.148"></a><span id="l30.148">   _statusFeedbackProgress: -1,</span>
<a href="#l30.149"></a><span id="l30.149"> </span>
<a href="#l30.150"></a><span id="l30.150">   // unload - call to remove links to listeners etc.</span>
<a href="#l30.151"></a><span id="l30.151" class="difflineminus">-  unload: function () {</span>
<a href="#l30.152"></a><span id="l30.152" class="difflineplus">+  unload() {</span>
<a href="#l30.153"></a><span id="l30.153">     // Remove listeners for any active processes we have hooked ourselves into.</span>
<a href="#l30.154"></a><span id="l30.154" class="difflineminus">-    this._activeProcesses.forEach(function (element) {</span>
<a href="#l30.155"></a><span id="l30.155" class="difflineplus">+    this._activeProcesses.forEach(function(element) {</span>
<a href="#l30.156"></a><span id="l30.156">         element.removeListener(this);</span>
<a href="#l30.157"></a><span id="l30.157">       }, this);</span>
<a href="#l30.158"></a><span id="l30.158">   },</span>
<a href="#l30.159"></a><span id="l30.159"> </span>
<a href="#l30.160"></a><span id="l30.160">   // nsIXULBrowserWindow implementation.</span>
<a href="#l30.161"></a><span id="l30.161" class="difflineminus">-  setJSStatus: function(status) {</span>
<a href="#l30.162"></a><span id="l30.162" class="difflineplus">+  setJSStatus(status) {</span>
<a href="#l30.163"></a><span id="l30.163">     if (status.length &gt; 0)</span>
<a href="#l30.164"></a><span id="l30.164">       this.showStatusString(status);</span>
<a href="#l30.165"></a><span id="l30.165">   },</span>
<a href="#l30.166"></a><span id="l30.166"> </span>
<a href="#l30.167"></a><span id="l30.167" class="difflineminus">-  setOverLink: function(link, context) {</span>
<a href="#l30.168"></a><span id="l30.168" class="difflineplus">+  setOverLink(link, context) {</span>
<a href="#l30.169"></a><span id="l30.169">     if (!document.getElementById(&quot;status-bar&quot;).hidden) {</span>
<a href="#l30.170"></a><span id="l30.170">       this._statusText.label = link;</span>
<a href="#l30.171"></a><span id="l30.171">     } else {</span>
<a href="#l30.172"></a><span id="l30.172">       // Statusbar invisible: Show link in statuspanel instead.</span>
<a href="#l30.173"></a><span id="l30.173">       this._statusPanel.label = link;</span>
<a href="#l30.174"></a><span id="l30.174">     }</span>
<a href="#l30.175"></a><span id="l30.175">   },</span>
<a href="#l30.176"></a><span id="l30.176"> </span>
<a href="#l30.177"></a><span id="l30.177">   // Called before links are navigated to to allow us to retarget them if needed.</span>
<a href="#l30.178"></a><span id="l30.178" class="difflineminus">-  onBeforeLinkTraversal: function(originalTarget, linkURI, linkNode, isAppTab) {</span>
<a href="#l30.179"></a><span id="l30.179" class="difflineplus">+  onBeforeLinkTraversal(originalTarget, linkURI, linkNode, isAppTab) {</span>
<a href="#l30.180"></a><span id="l30.180">     return originalTarget;</span>
<a href="#l30.181"></a><span id="l30.181">   },</span>
<a href="#l30.182"></a><span id="l30.182"> </span>
<a href="#l30.183"></a><span id="l30.183">   QueryInterface: ChromeUtils.generateQI([&quot;nsIMsgStatusFeedback&quot;,</span>
<a href="#l30.184"></a><span id="l30.184">                                           &quot;nsIXULBrowserWindow&quot;,</span>
<a href="#l30.185"></a><span id="l30.185">                                           &quot;nsIActivityMgrListener&quot;,</span>
<a href="#l30.186"></a><span id="l30.186">                                           &quot;nsIActivityListener&quot;,</span>
<a href="#l30.187"></a><span id="l30.187">                                           &quot;nsISupportsWeakReference&quot;]),</span>
<a href="#l30.188"></a><span id="l30.188"> </span>
<a href="#l30.189"></a><span id="l30.189">   // nsIMsgStatusFeedback implementation.</span>
<a href="#l30.190"></a><span id="l30.190" class="difflineminus">-  showStatusString: function(statusText) {</span>
<a href="#l30.191"></a><span id="l30.191" class="difflineplus">+  showStatusString(statusText) {</span>
<a href="#l30.192"></a><span id="l30.192">     if (!statusText)</span>
<a href="#l30.193"></a><span id="l30.193">       statusText = this._defaultStatusText;</span>
<a href="#l30.194"></a><span id="l30.194">     else</span>
<a href="#l30.195"></a><span id="l30.195">       this._defaultStatusText = &quot;&quot;;</span>
<a href="#l30.196"></a><span id="l30.196">     this._statusText.label = statusText;</span>
<a href="#l30.197"></a><span id="l30.197">   },</span>
<a href="#l30.198"></a><span id="l30.198"> </span>
<a href="#l30.199"></a><span id="l30.199" class="difflineminus">-  setStatusString: function(status) {</span>
<a href="#l30.200"></a><span id="l30.200" class="difflineplus">+  setStatusString(status) {</span>
<a href="#l30.201"></a><span id="l30.201">     if (status.length &gt; 0) {</span>
<a href="#l30.202"></a><span id="l30.202">       this._defaultStatusText = status;</span>
<a href="#l30.203"></a><span id="l30.203">       this._statusText.label = status;</span>
<a href="#l30.204"></a><span id="l30.204">     }</span>
<a href="#l30.205"></a><span id="l30.205">   },</span>
<a href="#l30.206"></a><span id="l30.206"> </span>
<a href="#l30.207"></a><span id="l30.207" class="difflineminus">-  _startMeteors: function() {</span>
<a href="#l30.208"></a><span id="l30.208" class="difflineplus">+  _startMeteors() {</span>
<a href="#l30.209"></a><span id="l30.209">     this._meteorsSpinning = true;</span>
<a href="#l30.210"></a><span id="l30.210">     this._startTimeoutID = null;</span>
<a href="#l30.211"></a><span id="l30.211"> </span>
<a href="#l30.212"></a><span id="l30.212">     // Turn progress meter on.</span>
<a href="#l30.213"></a><span id="l30.213">     this.updateProgress();</span>
<a href="#l30.214"></a><span id="l30.214"> </span>
<a href="#l30.215"></a><span id="l30.215">     // Start the throbber.</span>
<a href="#l30.216"></a><span id="l30.216">     if (this._throbber)</span>
<a href="#l30.217"></a><span id="l30.217">       this._throbber.setAttribute(&quot;busy&quot;, true);</span>
<a href="#l30.218"></a><span id="l30.218"> </span>
<a href="#l30.219"></a><span id="l30.219">     // Update the stop button</span>
<a href="#l30.220"></a><span id="l30.220">     goUpdateCommand(&quot;cmd_stop&quot;);</span>
<a href="#l30.221"></a><span id="l30.221">   },</span>
<a href="#l30.222"></a><span id="l30.222"> </span>
<a href="#l30.223"></a><span id="l30.223" class="difflineminus">-  startMeteors: function() {</span>
<a href="#l30.224"></a><span id="l30.224" class="difflineplus">+  startMeteors() {</span>
<a href="#l30.225"></a><span id="l30.225">     this._startRequests++;</span>
<a href="#l30.226"></a><span id="l30.226">     // If we don't already have a start meteor timeout pending</span>
<a href="#l30.227"></a><span id="l30.227">     // and the meteors aren't spinning, then kick off a start.</span>
<a href="#l30.228"></a><span id="l30.228">     if (!this._startTimeoutID &amp;&amp; !this._meteorsSpinning &amp;&amp;</span>
<a href="#l30.229"></a><span id="l30.229">         &quot;MsgStatusFeedback&quot; in window)</span>
<a href="#l30.230"></a><span id="l30.230">       this._startTimeoutID =</span>
<a href="#l30.231"></a><span id="l30.231" class="difflineminus">-        setTimeout('window.MsgStatusFeedback._startMeteors();', 500);</span>
<a href="#l30.232"></a><span id="l30.232" class="difflineplus">+        setTimeout(() =&gt; window.MsgStatusFeedback._startMeteors(), 500);</span>
<a href="#l30.233"></a><span id="l30.233"> </span>
<a href="#l30.234"></a><span id="l30.234">     // Since we are going to start up the throbber no sense in processing</span>
<a href="#l30.235"></a><span id="l30.235">     // a stop timeout...</span>
<a href="#l30.236"></a><span id="l30.236">     if (this._stopTimeoutID) {</span>
<a href="#l30.237"></a><span id="l30.237">       clearTimeout(this._stopTimeoutID);</span>
<a href="#l30.238"></a><span id="l30.238">       this._stopTimeoutID = null;</span>
<a href="#l30.239"></a><span id="l30.239">     }</span>
<a href="#l30.240"></a><span id="l30.240">   },</span>
<a href="#l30.241"></a><span id="l30.241"> </span>
<a href="#l30.242"></a><span id="l30.242" class="difflineminus">-  _stopMeteors: function() {</span>
<a href="#l30.243"></a><span id="l30.243" class="difflineplus">+  _stopMeteors() {</span>
<a href="#l30.244"></a><span id="l30.244">     this.showStatusString(this._defaultStatusText);</span>
<a href="#l30.245"></a><span id="l30.245"> </span>
<a href="#l30.246"></a><span id="l30.246">     // stop the throbber</span>
<a href="#l30.247"></a><span id="l30.247">     if (this._throbber)</span>
<a href="#l30.248"></a><span id="l30.248">       this._throbber.setAttribute(&quot;busy&quot;, false);</span>
<a href="#l30.249"></a><span id="l30.249"> </span>
<a href="#l30.250"></a><span id="l30.250">     this._meteorsSpinning = false;</span>
<a href="#l30.251"></a><span id="l30.251">     this._stopTimeoutID = null;</span>
<a href="#l30.252"></a><span id="l30.252" class="difflineat">@@ -336,52 +330,52 @@ nsMsgStatusFeedback.prototype =</span>
<a href="#l30.253"></a><span id="l30.253">     // Turn progress meter off.</span>
<a href="#l30.254"></a><span id="l30.254">     this._statusFeedbackProgress = -1;</span>
<a href="#l30.255"></a><span id="l30.255">     this.updateProgress();</span>
<a href="#l30.256"></a><span id="l30.256"> </span>
<a href="#l30.257"></a><span id="l30.257">     // Update the stop button</span>
<a href="#l30.258"></a><span id="l30.258">     goUpdateCommand(&quot;cmd_stop&quot;);</span>
<a href="#l30.259"></a><span id="l30.259">   },</span>
<a href="#l30.260"></a><span id="l30.260"> </span>
<a href="#l30.261"></a><span id="l30.261" class="difflineminus">-  stopMeteors: function() {</span>
<a href="#l30.262"></a><span id="l30.262" class="difflineplus">+  stopMeteors() {</span>
<a href="#l30.263"></a><span id="l30.263">     if (this._startRequests &gt; 0)</span>
<a href="#l30.264"></a><span id="l30.264">       this._startRequests--;</span>
<a href="#l30.265"></a><span id="l30.265"> </span>
<a href="#l30.266"></a><span id="l30.266">     // If we are going to be starting the meteors, cancel the start.</span>
<a href="#l30.267"></a><span id="l30.267">     if (this._startRequests == 0 &amp;&amp; this._startTimeoutID) {</span>
<a href="#l30.268"></a><span id="l30.268">       clearTimeout(this._startTimeoutID);</span>
<a href="#l30.269"></a><span id="l30.269">       this._startTimeoutID = null;</span>
<a href="#l30.270"></a><span id="l30.270">     }</span>
<a href="#l30.271"></a><span id="l30.271"> </span>
<a href="#l30.272"></a><span id="l30.272">     // If we have no more pending starts and we don't have a stop timeout</span>
<a href="#l30.273"></a><span id="l30.273">     // already in progress AND the meteors are currently running then fire a</span>
<a href="#l30.274"></a><span id="l30.274">     // stop timeout to shut them down.</span>
<a href="#l30.275"></a><span id="l30.275">     if (this._startRequests == 0 &amp;&amp; !this._stopTimeoutID &amp;&amp;</span>
<a href="#l30.276"></a><span id="l30.276">         this._meteorsSpinning &amp;&amp; &quot;MsgStatusFeedback&quot; in window) {</span>
<a href="#l30.277"></a><span id="l30.277">       this._stopTimeoutID =</span>
<a href="#l30.278"></a><span id="l30.278" class="difflineminus">-        setTimeout('window.MsgStatusFeedback._stopMeteors();', 500);</span>
<a href="#l30.279"></a><span id="l30.279" class="difflineplus">+        setTimeout(() =&gt; window.MsgStatusFeedback._stopMeteors(), 500);</span>
<a href="#l30.280"></a><span id="l30.280">     }</span>
<a href="#l30.281"></a><span id="l30.281">   },</span>
<a href="#l30.282"></a><span id="l30.282"> </span>
<a href="#l30.283"></a><span id="l30.283" class="difflineminus">-  showProgress: function(percentage) {</span>
<a href="#l30.284"></a><span id="l30.284" class="difflineplus">+  showProgress(percentage) {</span>
<a href="#l30.285"></a><span id="l30.285">     this._statusFeedbackProgress = percentage;</span>
<a href="#l30.286"></a><span id="l30.286">     this.updateProgress();</span>
<a href="#l30.287"></a><span id="l30.287">   },</span>
<a href="#l30.288"></a><span id="l30.288"> </span>
<a href="#l30.289"></a><span id="l30.289" class="difflineminus">-  updateProgress: function() {</span>
<a href="#l30.290"></a><span id="l30.290" class="difflineplus">+  updateProgress() {</span>
<a href="#l30.291"></a><span id="l30.291">     if (this._meteorsSpinning) {</span>
<a href="#l30.292"></a><span id="l30.292">       // In this function, we expect that the maximum for each progress is 100,</span>
<a href="#l30.293"></a><span id="l30.293">       // i.e. we are dealing with percentages. Hence we can combine several</span>
<a href="#l30.294"></a><span id="l30.294">       // processes running at the same time.</span>
<a href="#l30.295"></a><span id="l30.295">       let currentProgress = 0;</span>
<a href="#l30.296"></a><span id="l30.296">       let progressCount = 0;</span>
<a href="#l30.297"></a><span id="l30.297"> </span>
<a href="#l30.298"></a><span id="l30.298">       // For each activity that is in progress, get its status.</span>
<a href="#l30.299"></a><span id="l30.299"> </span>
<a href="#l30.300"></a><span id="l30.300" class="difflineminus">-      this._activeProcesses.forEach(function (element) {</span>
<a href="#l30.301"></a><span id="l30.301" class="difflineplus">+      this._activeProcesses.forEach(function(element) {</span>
<a href="#l30.302"></a><span id="l30.302">           if (element.state ==</span>
<a href="#l30.303"></a><span id="l30.303">               Ci.nsIActivityProcess.STATE_INPROGRESS &amp;&amp;</span>
<a href="#l30.304"></a><span id="l30.304">               element.percentComplete != -1) {</span>
<a href="#l30.305"></a><span id="l30.305">             currentProgress += element.percentComplete;</span>
<a href="#l30.306"></a><span id="l30.306">             ++progressCount;</span>
<a href="#l30.307"></a><span id="l30.307">           }</span>
<a href="#l30.308"></a><span id="l30.308">         });</span>
<a href="#l30.309"></a><span id="l30.309"> </span>
<a href="#l30.310"></a><span id="l30.310" class="difflineat">@@ -399,65 +393,62 @@ nsMsgStatusFeedback.prototype =</span>
<a href="#l30.311"></a><span id="l30.311"> </span>
<a href="#l30.312"></a><span id="l30.312">       if (!percentage) {</span>
<a href="#l30.313"></a><span id="l30.313">         this._progressBar.removeAttribute(&quot;value&quot;);</span>
<a href="#l30.314"></a><span id="l30.314">       } else {</span>
<a href="#l30.315"></a><span id="l30.315">         this._progressBar.value = percentage;</span>
<a href="#l30.316"></a><span id="l30.316">         this._progressBar.label = Math.round(percentage) + &quot;%&quot;;</span>
<a href="#l30.317"></a><span id="l30.317">       }</span>
<a href="#l30.318"></a><span id="l30.318">       if (!this._progressBarVisible) {</span>
<a href="#l30.319"></a><span id="l30.319" class="difflineminus">-        this._progressBarContainer.removeAttribute('collapsed');</span>
<a href="#l30.320"></a><span id="l30.320" class="difflineplus">+        this._progressBarContainer.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l30.321"></a><span id="l30.321">         this._progressBarVisible = true;</span>
<a href="#l30.322"></a><span id="l30.322">       }</span>
<a href="#l30.323"></a><span id="l30.323" class="difflineminus">-    }</span>
<a href="#l30.324"></a><span id="l30.324" class="difflineminus">-    else {</span>
<a href="#l30.325"></a><span id="l30.325" class="difflineplus">+    } else {</span>
<a href="#l30.326"></a><span id="l30.326">       // Stop the bar spinning as we're not doing anything now.</span>
<a href="#l30.327"></a><span id="l30.327">       this._progressBar.value = 0;</span>
<a href="#l30.328"></a><span id="l30.328">       this._progressBar.label = &quot;&quot;;</span>
<a href="#l30.329"></a><span id="l30.329"> </span>
<a href="#l30.330"></a><span id="l30.330">       if (this._progressBarVisible) {</span>
<a href="#l30.331"></a><span id="l30.331">         this._progressBarContainer.collapsed = true;</span>
<a href="#l30.332"></a><span id="l30.332">         this._progressBarVisible = false;</span>
<a href="#l30.333"></a><span id="l30.333">       }</span>
<a href="#l30.334"></a><span id="l30.334">     }</span>
<a href="#l30.335"></a><span id="l30.335">   },</span>
<a href="#l30.336"></a><span id="l30.336"> </span>
<a href="#l30.337"></a><span id="l30.337">   // nsIActivityMgrListener</span>
<a href="#l30.338"></a><span id="l30.338" class="difflineminus">-  onAddedActivity: function(aID, aActivity) {</span>
<a href="#l30.339"></a><span id="l30.339" class="difflineplus">+  onAddedActivity(aID, aActivity) {</span>
<a href="#l30.340"></a><span id="l30.340">     // ignore Gloda activity for status bar purposes</span>
<a href="#l30.341"></a><span id="l30.341">     if (aActivity.initiator == Gloda)</span>
<a href="#l30.342"></a><span id="l30.342">       return;</span>
<a href="#l30.343"></a><span id="l30.343">     if (aActivity instanceof Ci.nsIActivityEvent) {</span>
<a href="#l30.344"></a><span id="l30.344">       this.showStatusString(aActivity.displayText);</span>
<a href="#l30.345"></a><span id="l30.345" class="difflineminus">-    }</span>
<a href="#l30.346"></a><span id="l30.346" class="difflineminus">-    else if (aActivity instanceof Ci.nsIActivityProcess) {</span>
<a href="#l30.347"></a><span id="l30.347" class="difflineplus">+    } else if (aActivity instanceof Ci.nsIActivityProcess) {</span>
<a href="#l30.348"></a><span id="l30.348">       this._activeProcesses.push(aActivity);</span>
<a href="#l30.349"></a><span id="l30.349">       aActivity.addListener(this);</span>
<a href="#l30.350"></a><span id="l30.350">       this.startMeteors();</span>
<a href="#l30.351"></a><span id="l30.351">     }</span>
<a href="#l30.352"></a><span id="l30.352">   },</span>
<a href="#l30.353"></a><span id="l30.353"> </span>
<a href="#l30.354"></a><span id="l30.354" class="difflineminus">-  onRemovedActivity: function(aID) {</span>
<a href="#l30.355"></a><span id="l30.355" class="difflineplus">+  onRemovedActivity(aID) {</span>
<a href="#l30.356"></a><span id="l30.356">     this._activeProcesses =</span>
<a href="#l30.357"></a><span id="l30.357" class="difflineminus">-      this._activeProcesses.filter(function (element) {</span>
<a href="#l30.358"></a><span id="l30.358" class="difflineplus">+      this._activeProcesses.filter(function(element) {</span>
<a href="#l30.359"></a><span id="l30.359">         if (element.id == aID) {</span>
<a href="#l30.360"></a><span id="l30.360">           element.removeListener(this);</span>
<a href="#l30.361"></a><span id="l30.361">           this.stopMeteors();</span>
<a href="#l30.362"></a><span id="l30.362">           return false;</span>
<a href="#l30.363"></a><span id="l30.363">         }</span>
<a href="#l30.364"></a><span id="l30.364">         return true;</span>
<a href="#l30.365"></a><span id="l30.365">       }, this);</span>
<a href="#l30.366"></a><span id="l30.366">   },</span>
<a href="#l30.367"></a><span id="l30.367"> </span>
<a href="#l30.368"></a><span id="l30.368">   // nsIActivityListener</span>
<a href="#l30.369"></a><span id="l30.369" class="difflineminus">-  onStateChanged: function(aActivity, aOldState) {</span>
<a href="#l30.370"></a><span id="l30.370" class="difflineplus">+  onStateChanged(aActivity, aOldState) {</span>
<a href="#l30.371"></a><span id="l30.371">   },</span>
<a href="#l30.372"></a><span id="l30.372"> </span>
<a href="#l30.373"></a><span id="l30.373" class="difflineminus">-  onProgressChanged: function(aActivity, aStatusText, aWorkUnitsCompleted,</span>
<a href="#l30.374"></a><span id="l30.374" class="difflineminus">-                              aTotalWorkUnits) {</span>
<a href="#l30.375"></a><span id="l30.375" class="difflineplus">+  onProgressChanged(aActivity, aStatusText, aWorkUnitsCompleted, aTotalWorkUnits) {</span>
<a href="#l30.376"></a><span id="l30.376">     let index = this._activeProcesses.indexOf(aActivity);</span>
<a href="#l30.377"></a><span id="l30.377"> </span>
<a href="#l30.378"></a><span id="l30.378">     // Iterate through the list trying to find the first active process, but</span>
<a href="#l30.379"></a><span id="l30.379">     // only go as far as our process.</span>
<a href="#l30.380"></a><span id="l30.380">     for (var i = 0; i &lt; index; ++i) {</span>
<a href="#l30.381"></a><span id="l30.381">       if (this._activeProcesses[i].status ==</span>
<a href="#l30.382"></a><span id="l30.382">           Ci.nsIActivityProcess.STATE_INPROGRESS)</span>
<a href="#l30.383"></a><span id="l30.383">         break;</span>
<a href="#l30.384"></a><span id="l30.384" class="difflineat">@@ -469,85 +460,73 @@ nsMsgStatusFeedback.prototype =</span>
<a href="#l30.385"></a><span id="l30.385">       // Use the display text if we haven't got any status text. I'm assuming</span>
<a href="#l30.386"></a><span id="l30.386">       // that the status text will be generally what we want to see on the</span>
<a href="#l30.387"></a><span id="l30.387">       // status bar.</span>
<a href="#l30.388"></a><span id="l30.388">       this.showStatusString(aStatusText ? aStatusText : aActivity.displayText);</span>
<a href="#l30.389"></a><span id="l30.389"> </span>
<a href="#l30.390"></a><span id="l30.390">     this.updateProgress();</span>
<a href="#l30.391"></a><span id="l30.391">   },</span>
<a href="#l30.392"></a><span id="l30.392"> </span>
<a href="#l30.393"></a><span id="l30.393" class="difflineminus">-  onHandlerChanged: function(aActivity) {</span>
<a href="#l30.394"></a><span id="l30.394" class="difflineminus">-  }</span>
<a href="#l30.395"></a><span id="l30.395" class="difflineplus">+  onHandlerChanged(aActivity) {</span>
<a href="#l30.396"></a><span id="l30.396" class="difflineplus">+  },</span>
<a href="#l30.397"></a><span id="l30.397" class="difflineplus">+};</span>
<a href="#l30.398"></a><span id="l30.398" class="difflineplus">+</span>
<a href="#l30.399"></a><span id="l30.399" class="difflineplus">+function nsMsgWindowCommands() {</span>
<a href="#l30.400"></a><span id="l30.400"> }</span>
<a href="#l30.401"></a><span id="l30.401"> </span>
<a href="#l30.402"></a><span id="l30.402" class="difflineminus">-</span>
<a href="#l30.403"></a><span id="l30.403" class="difflineminus">-function nsMsgWindowCommands()</span>
<a href="#l30.404"></a><span id="l30.404" class="difflineminus">-{</span>
<a href="#l30.405"></a><span id="l30.405" class="difflineminus">-}</span>
<a href="#l30.406"></a><span id="l30.406" class="difflineminus">-</span>
<a href="#l30.407"></a><span id="l30.407" class="difflineminus">-nsMsgWindowCommands.prototype =</span>
<a href="#l30.408"></a><span id="l30.408" class="difflineminus">-{</span>
<a href="#l30.409"></a><span id="l30.409" class="difflineplus">+nsMsgWindowCommands.prototype = {</span>
<a href="#l30.410"></a><span id="l30.410">   QueryInterface: ChromeUtils.generateQI([&quot;nsIMsgWindowCommands&quot;]),</span>
<a href="#l30.411"></a><span id="l30.411"> </span>
<a href="#l30.412"></a><span id="l30.412" class="difflineminus">-  selectFolder: function(folderUri)</span>
<a href="#l30.413"></a><span id="l30.413" class="difflineminus">-  {</span>
<a href="#l30.414"></a><span id="l30.414" class="difflineplus">+  selectFolder(folderUri) {</span>
<a href="#l30.415"></a><span id="l30.415">     gFolderTreeView.selectFolder(MailUtils.getFolderForURI(folderUri));</span>
<a href="#l30.416"></a><span id="l30.416">   },</span>
<a href="#l30.417"></a><span id="l30.417"> </span>
<a href="#l30.418"></a><span id="l30.418" class="difflineminus">-  selectMessage: function(messageUri)</span>
<a href="#l30.419"></a><span id="l30.419" class="difflineminus">-  {</span>
<a href="#l30.420"></a><span id="l30.420" class="difflineplus">+  selectMessage(messageUri) {</span>
<a href="#l30.421"></a><span id="l30.421">     let msgHdr = messenger.msgHdrFromURI(messageUri);</span>
<a href="#l30.422"></a><span id="l30.422">     gFolderDisplay.selectMessage(msgHdr);</span>
<a href="#l30.423"></a><span id="l30.423">   },</span>
<a href="#l30.424"></a><span id="l30.424"> </span>
<a href="#l30.425"></a><span id="l30.425" class="difflineminus">-  clearMsgPane: function()</span>
<a href="#l30.426"></a><span id="l30.426" class="difflineminus">-  {</span>
<a href="#l30.427"></a><span id="l30.427" class="difflineplus">+  clearMsgPane() {</span>
<a href="#l30.428"></a><span id="l30.428">     // This call happens as part of a display decision made by the nsMsgDBView</span>
<a href="#l30.429"></a><span id="l30.429">     //  instance.  Strictly speaking, we don't want this.  I think davida's</span>
<a href="#l30.430"></a><span id="l30.430">     //  patch will change this, so we can figure it out after that lands if</span>
<a href="#l30.431"></a><span id="l30.431">     //  there are issues.</span>
<a href="#l30.432"></a><span id="l30.432">     ClearMessagePane();</span>
<a href="#l30.433"></a><span id="l30.433" class="difflineminus">-  }</span>
<a href="#l30.434"></a><span id="l30.434" class="difflineminus">-}</span>
<a href="#l30.435"></a><span id="l30.435" class="difflineplus">+  },</span>
<a href="#l30.436"></a><span id="l30.436" class="difflineplus">+};</span>
<a href="#l30.437"></a><span id="l30.437"> </span>
<a href="#l30.438"></a><span id="l30.438"> /**</span>
<a href="#l30.439"></a><span id="l30.439">  * Loads the mail start page.</span>
<a href="#l30.440"></a><span id="l30.440">  */</span>
<a href="#l30.441"></a><span id="l30.441" class="difflineminus">-function loadStartPage(aForce)</span>
<a href="#l30.442"></a><span id="l30.442" class="difflineminus">-{</span>
<a href="#l30.443"></a><span id="l30.443" class="difflineplus">+function loadStartPage(aForce) {</span>
<a href="#l30.444"></a><span id="l30.444">   // If the preference isn't enabled, then don't load anything.</span>
<a href="#l30.445"></a><span id="l30.445">   if (!aForce &amp;&amp; !Services.prefs.getBoolPref(&quot;mailnews.start_page.enabled&quot;))</span>
<a href="#l30.446"></a><span id="l30.446">     return;</span>
<a href="#l30.447"></a><span id="l30.447"> </span>
<a href="#l30.448"></a><span id="l30.448">   gMessageNotificationBar.clearMsgNotifications();</span>
<a href="#l30.449"></a><span id="l30.449">   let startpage = Services.urlFormatter.formatURLPref(&quot;mailnews.start_page.url&quot;);</span>
<a href="#l30.450"></a><span id="l30.450" class="difflineminus">-  if (startpage)</span>
<a href="#l30.451"></a><span id="l30.451" class="difflineminus">-  {</span>
<a href="#l30.452"></a><span id="l30.452" class="difflineplus">+  if (startpage) {</span>
<a href="#l30.453"></a><span id="l30.453">     try {</span>
<a href="#l30.454"></a><span id="l30.454">       let uri = Services.uriFixup.createFixupURI(startpage, 0);</span>
<a href="#l30.455"></a><span id="l30.455">       GetMessagePaneFrame().location.href = uri.spec;</span>
<a href="#l30.456"></a><span id="l30.456" class="difflineminus">-    }</span>
<a href="#l30.457"></a><span id="l30.457" class="difflineminus">-    catch (e) {</span>
<a href="#l30.458"></a><span id="l30.458" class="difflineplus">+    } catch (e) {</span>
<a href="#l30.459"></a><span id="l30.459">       Cu.reportError(e);</span>
<a href="#l30.460"></a><span id="l30.460">     }</span>
<a href="#l30.461"></a><span id="l30.461" class="difflineminus">-  }</span>
<a href="#l30.462"></a><span id="l30.462" class="difflineminus">-  else</span>
<a href="#l30.463"></a><span id="l30.463" class="difflineminus">-  {</span>
<a href="#l30.464"></a><span id="l30.464" class="difflineplus">+  } else {</span>
<a href="#l30.465"></a><span id="l30.465">     GetMessagePaneFrame().location.href = &quot;about:blank&quot;;</span>
<a href="#l30.466"></a><span id="l30.466">   }</span>
<a href="#l30.467"></a><span id="l30.467"> }</span>
<a href="#l30.468"></a><span id="l30.468"> </span>
<a href="#l30.469"></a><span id="l30.469"> /**</span>
<a href="#l30.470"></a><span id="l30.470">  * Returns the browser element of the current tab.</span>
<a href="#l30.471"></a><span id="l30.471">  * The zoom manager, view source and possibly some other functions still rely</span>
<a href="#l30.472"></a><span id="l30.472">  * on the getBrowser function.</span>
<a href="#l30.473"></a><span id="l30.473">  */</span>
<a href="#l30.474"></a><span id="l30.474" class="difflineminus">-function getBrowser()</span>
<a href="#l30.475"></a><span id="l30.475" class="difflineminus">-{</span>
<a href="#l30.476"></a><span id="l30.476" class="difflineminus">-  let tabmail = document.getElementById('tabmail');</span>
<a href="#l30.477"></a><span id="l30.477" class="difflineplus">+function getBrowser() {</span>
<a href="#l30.478"></a><span id="l30.478" class="difflineplus">+  let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l30.479"></a><span id="l30.479">   return tabmail ? tabmail.getBrowserForSelectedTab() : getMessagePaneBrowser();</span>
<a href="#l30.480"></a><span id="l30.480"> }</span>
<a href="#l30.481"></a><span id="l30.481"> </span>
<a href="#l30.482"></a><span id="l30.482"> /**</span>
<a href="#l30.483"></a><span id="l30.483">  * Returns the browser element of the message pane.</span>
<a href="#l30.484"></a><span id="l30.484">  */</span>
<a href="#l30.485"></a><span id="l30.485"> function getMessagePaneBrowser() {</span>
<a href="#l30.486"></a><span id="l30.486">   return document.getElementById(&quot;messagepane&quot;);</span>
<a href="#l30.487"></a><span id="l30.487" class="difflineat">@@ -571,18 +550,17 @@ function getNotificationBox(aWindow) {</span>
<a href="#l30.488"></a><span id="l30.488">     }</span>
<a href="#l30.489"></a><span id="l30.489">   }</span>
<a href="#l30.490"></a><span id="l30.490">   return null;</span>
<a href="#l30.491"></a><span id="l30.491"> }</span>
<a href="#l30.492"></a><span id="l30.492"> </span>
<a href="#l30.493"></a><span id="l30.493"> // Given the server, open the twisty and the set the selection</span>
<a href="#l30.494"></a><span id="l30.494"> // on inbox of that server.</span>
<a href="#l30.495"></a><span id="l30.495"> // prompt if offline.</span>
<a href="#l30.496"></a><span id="l30.496" class="difflineminus">-function OpenInboxForServer(server)</span>
<a href="#l30.497"></a><span id="l30.497" class="difflineminus">-{</span>
<a href="#l30.498"></a><span id="l30.498" class="difflineplus">+function OpenInboxForServer(server) {</span>
<a href="#l30.499"></a><span id="l30.499">   gFolderTreeView.selectFolder(GetInboxFolder(server));</span>
<a href="#l30.500"></a><span id="l30.500"> </span>
<a href="#l30.501"></a><span id="l30.501">   if (MailOfflineMgr.isOnline() || MailOfflineMgr.getNewMail()) {</span>
<a href="#l30.502"></a><span id="l30.502">     if (server.type != &quot;imap&quot;)</span>
<a href="#l30.503"></a><span id="l30.503">       GetMessagesForInboxOnServer(server);</span>
<a href="#l30.504"></a><span id="l30.504">   }</span>
<a href="#l30.505"></a><span id="l30.505"> }</span>
<a href="#l30.506"></a><span id="l30.506"> </span>
<a href="#l30.507"></a><span id="l30.507" class="difflineat">@@ -598,56 +576,55 @@ function UpdateFullZoomMenu() {</span>
<a href="#l30.508"></a><span id="l30.508">  * cert override dialog, though we'd like to give the user more detailed</span>
<a href="#l30.509"></a><span id="l30.509">  * information in the future.</span>
<a href="#l30.510"></a><span id="l30.510">  */</span>
<a href="#l30.511"></a><span id="l30.511"> function BadCertHandler() {</span>
<a href="#l30.512"></a><span id="l30.512"> }</span>
<a href="#l30.513"></a><span id="l30.513"> </span>
<a href="#l30.514"></a><span id="l30.514"> BadCertHandler.prototype = {</span>
<a href="#l30.515"></a><span id="l30.515">   // Suppress any certificate errors</span>
<a href="#l30.516"></a><span id="l30.516" class="difflineminus">-  notifyCertProblem: function(socketInfo, status, targetSite) {</span>
<a href="#l30.517"></a><span id="l30.517" class="difflineplus">+  notifyCertProblem(socketInfo, status, targetSite) {</span>
<a href="#l30.518"></a><span id="l30.518">     setTimeout(InformUserOfCertError, 0, socketInfo, status, targetSite);</span>
<a href="#l30.519"></a><span id="l30.519">     return true;</span>
<a href="#l30.520"></a><span id="l30.520">   },</span>
<a href="#l30.521"></a><span id="l30.521"> </span>
<a href="#l30.522"></a><span id="l30.522">   // nsIInterfaceRequestor</span>
<a href="#l30.523"></a><span id="l30.523" class="difflineminus">-  getInterface: function(iid) {</span>
<a href="#l30.524"></a><span id="l30.524" class="difflineplus">+  getInterface(iid) {</span>
<a href="#l30.525"></a><span id="l30.525">     return this.QueryInterface(iid);</span>
<a href="#l30.526"></a><span id="l30.526">   },</span>
<a href="#l30.527"></a><span id="l30.527"> </span>
<a href="#l30.528"></a><span id="l30.528">   // nsISupports</span>
<a href="#l30.529"></a><span id="l30.529">   QueryInterface: ChromeUtils.generateQI([&quot;nsIBadCertListener2&quot;,</span>
<a href="#l30.530"></a><span id="l30.530">                                           &quot;nsIInterfaceRequestor&quot;]),</span>
<a href="#l30.531"></a><span id="l30.531"> };</span>
<a href="#l30.532"></a><span id="l30.532"> </span>
<a href="#l30.533"></a><span id="l30.533" class="difflineminus">-function InformUserOfCertError(socketInfo, secInfo, targetSite)</span>
<a href="#l30.534"></a><span id="l30.534" class="difflineminus">-{</span>
<a href="#l30.535"></a><span id="l30.535" class="difflineplus">+function InformUserOfCertError(socketInfo, secInfo, targetSite) {</span>
<a href="#l30.536"></a><span id="l30.536">   let params = {</span>
<a href="#l30.537"></a><span id="l30.537" class="difflineminus">-    exceptionAdded : false,</span>
<a href="#l30.538"></a><span id="l30.538" class="difflineminus">-    securityInfo : secInfo,</span>
<a href="#l30.539"></a><span id="l30.539" class="difflineplus">+    exceptionAdded: false,</span>
<a href="#l30.540"></a><span id="l30.540" class="difflineplus">+    securityInfo: secInfo,</span>
<a href="#l30.541"></a><span id="l30.541">     prefetchCert: true,</span>
<a href="#l30.542"></a><span id="l30.542" class="difflineminus">-    location : targetSite</span>
<a href="#l30.543"></a><span id="l30.543" class="difflineplus">+    location: targetSite,</span>
<a href="#l30.544"></a><span id="l30.544">   };</span>
<a href="#l30.545"></a><span id="l30.545" class="difflineminus">-  window.openDialog('chrome://pippki/content/exceptionDialog.xul',</span>
<a href="#l30.546"></a><span id="l30.546" class="difflineminus">-                  '','chrome,centerscreen,modal', params);</span>
<a href="#l30.547"></a><span id="l30.547" class="difflineplus">+  window.openDialog(&quot;chrome://pippki/content/exceptionDialog.xul&quot;,</span>
<a href="#l30.548"></a><span id="l30.548" class="difflineplus">+                    &quot;&quot;, &quot;chrome,centerscreen,modal&quot;, params);</span>
<a href="#l30.549"></a><span id="l30.549"> }</span>
<a href="#l30.550"></a><span id="l30.550"> </span>
<a href="#l30.551"></a><span id="l30.551" class="difflineminus">-function nsBrowserAccess() { }</span>
<a href="#l30.552"></a><span id="l30.552" class="difflineplus">+function nsBrowserAccess() {}</span>
<a href="#l30.553"></a><span id="l30.553"> </span>
<a href="#l30.554"></a><span id="l30.554"> nsBrowserAccess.prototype = {</span>
<a href="#l30.555"></a><span id="l30.555">   QueryInterface: ChromeUtils.generateQI([&quot;nsIBrowserDOMWindow&quot;]),</span>
<a href="#l30.556"></a><span id="l30.556"> </span>
<a href="#l30.557"></a><span id="l30.557">   // The following function may be called during account creation, it is called by</span>
<a href="#l30.558"></a><span id="l30.558">   // the Mozmill test test-newmailaccount.js::test_window_open_link_opening_behaviour.</span>
<a href="#l30.559"></a><span id="l30.559">   createContentWindow(aURI, aOpener, aWhere, aFlags, aTriggeringPrincipal = null) {</span>
<a href="#l30.560"></a><span id="l30.560">     return this.getContentWindowOrOpenURI(null, aOpener, aWhere, aFlags,</span>
<a href="#l30.561"></a><span id="l30.561">                                           aTriggeringPrincipal);</span>
<a href="#l30.562"></a><span id="l30.562">   },</span>
<a href="#l30.563"></a><span id="l30.563"> </span>
<a href="#l30.564"></a><span id="l30.564" class="difflineminus">-  openURI: function (aURI, aOpener, aWhere, aFlags, aTriggeringPrincipal = null) {</span>
<a href="#l30.565"></a><span id="l30.565" class="difflineplus">+  openURI(aURI, aOpener, aWhere, aFlags, aTriggeringPrincipal = null) {</span>
<a href="#l30.566"></a><span id="l30.566">     if (!aURI) {</span>
<a href="#l30.567"></a><span id="l30.567">       Cu.reportError(&quot;openURI should only be called with a valid URI&quot;);</span>
<a href="#l30.568"></a><span id="l30.568">       throw Cr.NS_ERROR_FAILURE;</span>
<a href="#l30.569"></a><span id="l30.569">     }</span>
<a href="#l30.570"></a><span id="l30.570">     return this.getContentWindowOrOpenURI(aURI, aOpener, aWhere, aFlags,</span>
<a href="#l30.571"></a><span id="l30.571">                                           aTriggeringPrincipal);</span>
<a href="#l30.572"></a><span id="l30.572">   },</span>
<a href="#l30.573"></a><span id="l30.573"> </span>
<a href="#l30.574"></a><span id="l30.574" class="difflineat">@@ -666,61 +643,61 @@ nsBrowserAccess.prototype = {</span>
<a href="#l30.575"></a><span id="l30.575"> </span>
<a href="#l30.576"></a><span id="l30.576">     if (aWhere != nsIBrowserDOMWindow.OPEN_NEWTAB)</span>
<a href="#l30.577"></a><span id="l30.577">       Services.console.logStringMessage(&quot;Opening a URI in something other than a new tab is not supported, opening in new tab instead&quot;);</span>
<a href="#l30.578"></a><span id="l30.578"> </span>
<a href="#l30.579"></a><span id="l30.579">     let win, needToFocusWin;</span>
<a href="#l30.580"></a><span id="l30.580"> </span>
<a href="#l30.581"></a><span id="l30.581">     // Try the current window. If we're in a popup, fall back on the most</span>
<a href="#l30.582"></a><span id="l30.582">     // recent browser window.</span>
<a href="#l30.583"></a><span id="l30.583" class="difflineminus">-    if (!window.document.documentElement.getAttribute(&quot;chromehidden&quot;))</span>
<a href="#l30.584"></a><span id="l30.584" class="difflineplus">+    if (!window.document.documentElement.getAttribute(&quot;chromehidden&quot;)) {</span>
<a href="#l30.585"></a><span id="l30.585">       win = window;</span>
<a href="#l30.586"></a><span id="l30.586" class="difflineminus">-    else {</span>
<a href="#l30.587"></a><span id="l30.587" class="difflineplus">+    } else {</span>
<a href="#l30.588"></a><span id="l30.588">       win = getMostRecentMailWindow();</span>
<a href="#l30.589"></a><span id="l30.589">       needToFocusWin = true;</span>
<a href="#l30.590"></a><span id="l30.590">     }</span>
<a href="#l30.591"></a><span id="l30.591"> </span>
<a href="#l30.592"></a><span id="l30.592">     if (!win)</span>
<a href="#l30.593"></a><span id="l30.593" class="difflineminus">-      throw(&quot;Couldn't get a suitable window for openURI&quot;);</span>
<a href="#l30.594"></a><span id="l30.594" class="difflineplus">+      throw new Error(&quot;Couldn't get a suitable window for openURI&quot;);</span>
<a href="#l30.595"></a><span id="l30.595"> </span>
<a href="#l30.596"></a><span id="l30.596">     let loadInBackground =</span>
<a href="#l30.597"></a><span id="l30.597">       Services.prefs.getBoolPref(&quot;browser.tabs.loadDivertedInBackground&quot;);</span>
<a href="#l30.598"></a><span id="l30.598"> </span>
<a href="#l30.599"></a><span id="l30.599">     let tabmail = win.document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l30.600"></a><span id="l30.600">     let clickHandler = null;</span>
<a href="#l30.601"></a><span id="l30.601">     let browser = tabmail.getBrowserForDocument(content);</span>
<a href="#l30.602"></a><span id="l30.602">     if (browser)</span>
<a href="#l30.603"></a><span id="l30.603">       clickHandler = browser.clickHandler;</span>
<a href="#l30.604"></a><span id="l30.604"> </span>
<a href="#l30.605"></a><span id="l30.605">     let newTab = tabmail.openTab(&quot;contentTab&quot;, {contentPage: &quot;about:blank&quot;,</span>
<a href="#l30.606"></a><span id="l30.606">                                                 background: loadInBackground,</span>
<a href="#l30.607"></a><span id="l30.607" class="difflineminus">-                                                clickHandler: clickHandler});</span>
<a href="#l30.608"></a><span id="l30.608" class="difflineplus">+                                                clickHandler});</span>
<a href="#l30.609"></a><span id="l30.609"> </span>
<a href="#l30.610"></a><span id="l30.610">     newWindow = newTab.browser.docShell.domWindow;</span>
<a href="#l30.611"></a><span id="l30.611">     try {</span>
<a href="#l30.612"></a><span id="l30.612">       if (aURI) {</span>
<a href="#l30.613"></a><span id="l30.613">         let referrer = null;</span>
<a href="#l30.614"></a><span id="l30.614">         if (aOpener) {</span>
<a href="#l30.615"></a><span id="l30.615">           let location = aOpener.location;</span>
<a href="#l30.616"></a><span id="l30.616">           referrer = Services.io.newURI(location);</span>
<a href="#l30.617"></a><span id="l30.617">         }</span>
<a href="#l30.618"></a><span id="l30.618">         newWindow.QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l30.619"></a><span id="l30.619">                  .getInterface(Ci.nsIWebNavigation)</span>
<a href="#l30.620"></a><span id="l30.620">                  .loadURI(aURI.spec, loadflags, referrer, null, null, aTriggeringPrincipal);</span>
<a href="#l30.621"></a><span id="l30.621">       }</span>
<a href="#l30.622"></a><span id="l30.622">       if (needToFocusWin || (!loadInBackground &amp;&amp; isExternal))</span>
<a href="#l30.623"></a><span id="l30.623">         newWindow.focus();</span>
<a href="#l30.624"></a><span id="l30.624" class="difflineminus">-    } catch(e) {</span>
<a href="#l30.625"></a><span id="l30.625" class="difflineplus">+    } catch (e) {</span>
<a href="#l30.626"></a><span id="l30.626">     }</span>
<a href="#l30.627"></a><span id="l30.627">     return newWindow;</span>
<a href="#l30.628"></a><span id="l30.628">   },</span>
<a href="#l30.629"></a><span id="l30.629"> </span>
<a href="#l30.630"></a><span id="l30.630" class="difflineminus">-  isTabContentWindow: function (aWindow) {</span>
<a href="#l30.631"></a><span id="l30.631" class="difflineplus">+  isTabContentWindow(aWindow) {</span>
<a href="#l30.632"></a><span id="l30.632">     return false;</span>
<a href="#l30.633"></a><span id="l30.633" class="difflineminus">-  }</span>
<a href="#l30.634"></a><span id="l30.634" class="difflineplus">+  },</span>
<a href="#l30.635"></a><span id="l30.635"> };</span>
<a href="#l30.636"></a><span id="l30.636"> </span>
<a href="#l30.637"></a><span id="l30.637"> function MailSetCharacterSet(aEvent) {</span>
<a href="#l30.638"></a><span id="l30.638">   if (aEvent.target.hasAttribute(&quot;charset&quot;)) {</span>
<a href="#l30.639"></a><span id="l30.639">     msgWindow.mailCharacterSet = aEvent.target.getAttribute(&quot;charset&quot;);</span>
<a href="#l30.640"></a><span id="l30.640">     msgWindow.charsetOverride = true;</span>
<a href="#l30.641"></a><span id="l30.641">     gMessageDisplay.keyForCharsetOverride =</span>
<a href="#l30.642"></a><span id="l30.642">       (&quot;messageKey&quot; in gMessageDisplay.displayedMessage ?</span>
<a href="#l30.643"></a><span id="l30.643" class="difflineat">@@ -735,17 +712,17 @@ function MailSetCharacterSet(aEvent) {</span>
<a href="#l30.644"></a><span id="l30.644">  */</span>
<a href="#l30.645"></a><span id="l30.645"> function switchToTabHavingURI(aURI, aOpenNew, aOpenParams) {</span>
<a href="#l30.646"></a><span id="l30.646">   let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l30.647"></a><span id="l30.647">   let matchingIndex = -1;</span>
<a href="#l30.648"></a><span id="l30.648">   if (tabmail) {</span>
<a href="#l30.649"></a><span id="l30.649">     // about:preferences should be opened through openPreferencesTab().</span>
<a href="#l30.650"></a><span id="l30.650">     if (aURI == &quot;about:preferences&quot;) {</span>
<a href="#l30.651"></a><span id="l30.651">       openPreferencesTab();</span>
<a href="#l30.652"></a><span id="l30.652" class="difflineminus">-      return;</span>
<a href="#l30.653"></a><span id="l30.653" class="difflineplus">+      return true;</span>
<a href="#l30.654"></a><span id="l30.654">     }</span>
<a href="#l30.655"></a><span id="l30.655"> </span>
<a href="#l30.656"></a><span id="l30.656">     let openURI = makeURI(aURI);</span>
<a href="#l30.657"></a><span id="l30.657">     let tabInfo = tabmail.tabInfo;</span>
<a href="#l30.658"></a><span id="l30.658"> </span>
<a href="#l30.659"></a><span id="l30.659">     // Check if we already have the same URL open in a content tab.</span>
<a href="#l30.660"></a><span id="l30.660">     for (let tabIndex = 0; tabIndex &lt; tabInfo.length; tabIndex++) {</span>
<a href="#l30.661"></a><span id="l30.661">       if (tabInfo[tabIndex].mode.name == &quot;contentTab&quot;) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.js</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.js</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -12,34 +12,33 @@ ChromeUtils.import(&quot;resource://gre/modul</span>
<a href="#l31.4"></a><span id="l31.4"> ChromeUtils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l31.5"></a><span id="l31.5"> ChromeUtils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;);</span>
<a href="#l31.6"></a><span id="l31.6"> </span>
<a href="#l31.7"></a><span id="l31.7"> ChromeUtils.defineModuleGetter(this, &quot;BrowserToolboxProcess&quot;, &quot;resource://devtools/client/framework/ToolboxProcess.jsm&quot;);</span>
<a href="#l31.8"></a><span id="l31.8"> ChromeUtils.defineModuleGetter(this, &quot;ScratchpadManager&quot;, &quot;resource://devtools/client/scratchpad/scratchpad-manager.jsm&quot;);</span>
<a href="#l31.9"></a><span id="l31.9"> ChromeUtils.defineModuleGetter(this, &quot;ExtensionParent&quot;, &quot;resource://gre/modules/ExtensionParent.jsm&quot;);</span>
<a href="#l31.10"></a><span id="l31.10"> ChromeUtils.defineModuleGetter(this, &quot;ExtensionSupport&quot;, &quot;resource:///modules/extensionSupport.jsm&quot;);</span>
<a href="#l31.11"></a><span id="l31.11"> Object.defineProperty(this, &quot;HUDService&quot;, {</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-  get: function HUDService_getter() {</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+  get() {</span>
<a href="#l31.14"></a><span id="l31.14">     let { devtools } = ChromeUtils.import(&quot;resource://devtools/shared/Loader.jsm&quot;, null);</span>
<a href="#l31.15"></a><span id="l31.15">     return devtools.require(&quot;devtools/client/webconsole/hudservice&quot;).HUDService;</span>
<a href="#l31.16"></a><span id="l31.16">   },</span>
<a href="#l31.17"></a><span id="l31.17">   configurable: true,</span>
<a href="#l31.18"></a><span id="l31.18" class="difflineminus">-  enumerable: true</span>
<a href="#l31.19"></a><span id="l31.19" class="difflineplus">+  enumerable: true,</span>
<a href="#l31.20"></a><span id="l31.20"> });</span>
<a href="#l31.21"></a><span id="l31.21"> </span>
<a href="#l31.22"></a><span id="l31.22" class="difflineminus">-var ADDR_DB_LARGE_COMMIT       = 1;</span>
<a href="#l31.23"></a><span id="l31.23" class="difflineplus">+var ADDR_DB_LARGE_COMMIT = 1;</span>
<a href="#l31.24"></a><span id="l31.24"> </span>
<a href="#l31.25"></a><span id="l31.25"> var kClassicMailLayout = 0;</span>
<a href="#l31.26"></a><span id="l31.26"> var kWideMailLayout = 1;</span>
<a href="#l31.27"></a><span id="l31.27"> var kVerticalMailLayout = 2;</span>
<a href="#l31.28"></a><span id="l31.28" class="difflineminus">-var kMailLayoutCommandMap =</span>
<a href="#l31.29"></a><span id="l31.29" class="difflineminus">-{</span>
<a href="#l31.30"></a><span id="l31.30" class="difflineplus">+var kMailLayoutCommandMap = {</span>
<a href="#l31.31"></a><span id="l31.31">   &quot;cmd_viewClassicMailLayout&quot;: kClassicMailLayout,</span>
<a href="#l31.32"></a><span id="l31.32">   &quot;cmd_viewWideMailLayout&quot;: kWideMailLayout,</span>
<a href="#l31.33"></a><span id="l31.33" class="difflineminus">-  &quot;cmd_viewVerticalMailLayout&quot;: kVerticalMailLayout</span>
<a href="#l31.34"></a><span id="l31.34" class="difflineplus">+  &quot;cmd_viewVerticalMailLayout&quot;: kVerticalMailLayout,</span>
<a href="#l31.35"></a><span id="l31.35"> };</span>
<a href="#l31.36"></a><span id="l31.36"> </span>
<a href="#l31.37"></a><span id="l31.37"> // Per message header flags to keep track of whether the user is allowing remote</span>
<a href="#l31.38"></a><span id="l31.38"> // content for a particular message.</span>
<a href="#l31.39"></a><span id="l31.39"> // if you change or add more values to these constants, be sure to modify</span>
<a href="#l31.40"></a><span id="l31.40"> // the corresponding definitions in nsMsgContentPolicy.cpp</span>
<a href="#l31.41"></a><span id="l31.41"> var kNoRemoteContentPolicy = 0;</span>
<a href="#l31.42"></a><span id="l31.42"> var kBlockRemoteContent = 1;</span>
<a href="#l31.43"></a><span id="l31.43" class="difflineat">@@ -53,18 +52,17 @@ var gMarkViewedMessageAsReadTimer = null</span>
<a href="#l31.44"></a><span id="l31.44"> // if HTML is not allowed. I assume, that the user could have set this to a</span>
<a href="#l31.45"></a><span id="l31.45"> // value &gt; 1 in his prefs.js or user.js, but that the value will not</span>
<a href="#l31.46"></a><span id="l31.46"> // change during runtime other than through the MsgBody*() functions below.</span>
<a href="#l31.47"></a><span id="l31.47"> var gDisallow_classes_no_html = 1;</span>
<a href="#l31.48"></a><span id="l31.48"> </span>
<a href="#l31.49"></a><span id="l31.49"> // Disable the new account menu item if the account preference is locked.</span>
<a href="#l31.50"></a><span id="l31.50"> // The other affected areas are the account central, the account manager</span>
<a href="#l31.51"></a><span id="l31.51"> // dialog, and the account provisioner window.</span>
<a href="#l31.52"></a><span id="l31.52" class="difflineminus">-function menu_new_init()</span>
<a href="#l31.53"></a><span id="l31.53" class="difflineminus">-{</span>
<a href="#l31.54"></a><span id="l31.54" class="difflineplus">+function menu_new_init() {</span>
<a href="#l31.55"></a><span id="l31.55">   // If the account provisioner is pref'd off, we shouldn't display the menu</span>
<a href="#l31.56"></a><span id="l31.56">   // item.</span>
<a href="#l31.57"></a><span id="l31.57">   ShowMenuItem(&quot;newCreateEmailAccountMenuItem&quot;,</span>
<a href="#l31.58"></a><span id="l31.58">                Services.prefs.getBoolPref(&quot;mail.provider.enabled&quot;));</span>
<a href="#l31.59"></a><span id="l31.59"> </span>
<a href="#l31.60"></a><span id="l31.60">   // If we don't have a gFolderDisplay, just get out of here and leave the menu</span>
<a href="#l31.61"></a><span id="l31.61">   // as it is.</span>
<a href="#l31.62"></a><span id="l31.62">   if (!gFolderDisplay)</span>
<a href="#l31.63"></a><span id="l31.63" class="difflineat">@@ -80,31 +78,28 @@ function menu_new_init()</span>
<a href="#l31.64"></a><span id="l31.64">   var isInbox = folder.isSpecialFolder(Ci.nsMsgFolderFlags.Inbox);</span>
<a href="#l31.65"></a><span id="l31.65">   var showNew = (folder.canCreateSubfolders ||</span>
<a href="#l31.66"></a><span id="l31.66">                  (isInbox &amp;&amp; !(folder.getFlag(Ci.nsMsgFolderFlags.Virtual)))) &amp;&amp;</span>
<a href="#l31.67"></a><span id="l31.67">                 (document.getElementById(&quot;cmd_newFolder&quot;).getAttribute(&quot;disabled&quot;) != &quot;true&quot;);</span>
<a href="#l31.68"></a><span id="l31.68">   ShowMenuItem(&quot;menu_newFolder&quot;, showNew);</span>
<a href="#l31.69"></a><span id="l31.69">   ShowMenuItem(&quot;menu_newVirtualFolder&quot;, showNew);</span>
<a href="#l31.70"></a><span id="l31.70"> </span>
<a href="#l31.71"></a><span id="l31.71">   EnableMenuItem(&quot;menu_newFolder&quot;, folder.server.type != &quot;imap&quot; || MailOfflineMgr.isOnline());</span>
<a href="#l31.72"></a><span id="l31.72" class="difflineminus">-  if (showNew)</span>
<a href="#l31.73"></a><span id="l31.73" class="difflineminus">-  {</span>
<a href="#l31.74"></a><span id="l31.74" class="difflineplus">+  if (showNew) {</span>
<a href="#l31.75"></a><span id="l31.75">     var bundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l31.76"></a><span id="l31.76">     // Change &quot;New Folder...&quot; menu according to the context.</span>
<a href="#l31.77"></a><span id="l31.77">     SetMenuItemLabel(&quot;menu_newFolder&quot;, bundle.getString(</span>
<a href="#l31.78"></a><span id="l31.78">       (folder.isServer || isInbox) ? &quot;newFolderMenuItem&quot; : &quot;newSubfolderMenuItem&quot;));</span>
<a href="#l31.79"></a><span id="l31.79">   }</span>
<a href="#l31.80"></a><span id="l31.80"> </span>
<a href="#l31.81"></a><span id="l31.81">   goUpdateCommand(&quot;cmd_newMessage&quot;);</span>
<a href="#l31.82"></a><span id="l31.82"> }</span>
<a href="#l31.83"></a><span id="l31.83"> </span>
<a href="#l31.84"></a><span id="l31.84" class="difflineminus">-function goUpdateMailMenuItems(commandset)</span>
<a href="#l31.85"></a><span id="l31.85" class="difflineminus">-{</span>
<a href="#l31.86"></a><span id="l31.86" class="difflineminus">-  for (var i = 0; i &lt; commandset.childNodes.length; i++)</span>
<a href="#l31.87"></a><span id="l31.87" class="difflineminus">-  {</span>
<a href="#l31.88"></a><span id="l31.88" class="difflineplus">+function goUpdateMailMenuItems(commandset) {</span>
<a href="#l31.89"></a><span id="l31.89" class="difflineplus">+  for (var i = 0; i &lt; commandset.childNodes.length; i++) {</span>
<a href="#l31.90"></a><span id="l31.90">     var commandID = commandset.childNodes[i].getAttribute(&quot;id&quot;);</span>
<a href="#l31.91"></a><span id="l31.91">     if (commandID)</span>
<a href="#l31.92"></a><span id="l31.92">       goUpdateCommand(commandID);</span>
<a href="#l31.93"></a><span id="l31.93">   }</span>
<a href="#l31.94"></a><span id="l31.94"> </span>
<a href="#l31.95"></a><span id="l31.95">   updateCheckedStateForIgnoreAndWatchThreadCmds();</span>
<a href="#l31.96"></a><span id="l31.96"> }</span>
<a href="#l31.97"></a><span id="l31.97"> </span>
<a href="#l31.98"></a><span id="l31.98" class="difflineat">@@ -116,74 +111,69 @@ function updateCheckedStateForIgnoreAndW</span>
<a href="#l31.99"></a><span id="l31.99">   document.getElementById(&quot;cmd_killThread&quot;)</span>
<a href="#l31.100"></a><span id="l31.100">           .setAttribute(&quot;checked&quot;, gFolderDisplay.selectedMessageThreadIgnored);</span>
<a href="#l31.101"></a><span id="l31.101">   document.getElementById(&quot;cmd_killSubthread&quot;)</span>
<a href="#l31.102"></a><span id="l31.102">           .setAttribute(&quot;checked&quot;, gFolderDisplay.selectedMessageSubthreadIgnored);</span>
<a href="#l31.103"></a><span id="l31.103">   document.getElementById(&quot;cmd_watchThread&quot;)</span>
<a href="#l31.104"></a><span id="l31.104">           .setAttribute(&quot;checked&quot;, gFolderDisplay.selectedMessageThreadWatched);</span>
<a href="#l31.105"></a><span id="l31.105"> }</span>
<a href="#l31.106"></a><span id="l31.106"> </span>
<a href="#l31.107"></a><span id="l31.107" class="difflineminus">-function file_init()</span>
<a href="#l31.108"></a><span id="l31.108" class="difflineminus">-{</span>
<a href="#l31.109"></a><span id="l31.109" class="difflineminus">-  document.commandDispatcher.updateCommands('create-menu-file');</span>
<a href="#l31.110"></a><span id="l31.110" class="difflineplus">+function file_init() {</span>
<a href="#l31.111"></a><span id="l31.111" class="difflineplus">+  document.commandDispatcher.updateCommands(&quot;create-menu-file&quot;);</span>
<a href="#l31.112"></a><span id="l31.112"> }</span>
<a href="#l31.113"></a><span id="l31.113"> </span>
<a href="#l31.114"></a><span id="l31.114" class="difflineminus">-function InitEditMessagesMenu()</span>
<a href="#l31.115"></a><span id="l31.115" class="difflineminus">-{</span>
<a href="#l31.116"></a><span id="l31.116" class="difflineminus">-  goSetMenuValue('cmd_delete', 'valueDefault');</span>
<a href="#l31.117"></a><span id="l31.117" class="difflineminus">-  goSetAccessKey('cmd_delete', 'valueDefaultAccessKey');</span>
<a href="#l31.118"></a><span id="l31.118" class="difflineminus">-  document.commandDispatcher.updateCommands('create-menu-edit');</span>
<a href="#l31.119"></a><span id="l31.119" class="difflineplus">+function InitEditMessagesMenu() {</span>
<a href="#l31.120"></a><span id="l31.120" class="difflineplus">+  goSetMenuValue(&quot;cmd_delete&quot;, &quot;valueDefault&quot;);</span>
<a href="#l31.121"></a><span id="l31.121" class="difflineplus">+  goSetAccessKey(&quot;cmd_delete&quot;, &quot;valueDefaultAccessKey&quot;);</span>
<a href="#l31.122"></a><span id="l31.122" class="difflineplus">+  document.commandDispatcher.updateCommands(&quot;create-menu-edit&quot;);</span>
<a href="#l31.123"></a><span id="l31.123"> </span>
<a href="#l31.124"></a><span id="l31.124">   // initialize the favorite Folder checkbox in the edit menu</span>
<a href="#l31.125"></a><span id="l31.125" class="difflineminus">-  let favoriteFolderMenu = document.getElementById('menu_favoriteFolder');</span>
<a href="#l31.126"></a><span id="l31.126" class="difflineplus">+  let favoriteFolderMenu = document.getElementById(&quot;menu_favoriteFolder&quot;);</span>
<a href="#l31.127"></a><span id="l31.127">   if (!favoriteFolderMenu.hasAttribute(&quot;disabled&quot;)) {</span>
<a href="#l31.128"></a><span id="l31.128">     let folders = gFolderTreeView.getSelectedFolders();</span>
<a href="#l31.129"></a><span id="l31.129">     if (folders.length == 1 &amp;&amp; !folders[0].isServer) {</span>
<a href="#l31.130"></a><span id="l31.130">       // Adjust the checked state on the menu item.</span>
<a href="#l31.131"></a><span id="l31.131">       favoriteFolderMenu.setAttribute(&quot;checked&quot;,</span>
<a href="#l31.132"></a><span id="l31.132">         folders[0].getFlag(Ci.nsMsgFolderFlags.Favorite));</span>
<a href="#l31.133"></a><span id="l31.133">       favoriteFolderMenu.hidden = false;</span>
<a href="#l31.134"></a><span id="l31.134">     } else {</span>
<a href="#l31.135"></a><span id="l31.135">       favoriteFolderMenu.hidden = true;</span>
<a href="#l31.136"></a><span id="l31.136">     }</span>
<a href="#l31.137"></a><span id="l31.137">   }</span>
<a href="#l31.138"></a><span id="l31.138"> }</span>
<a href="#l31.139"></a><span id="l31.139"> </span>
<a href="#l31.140"></a><span id="l31.140" class="difflineminus">-function InitAppFolderViewsMenu()</span>
<a href="#l31.141"></a><span id="l31.141" class="difflineminus">-{</span>
<a href="#l31.142"></a><span id="l31.142" class="difflineminus">-  goSetMenuValue('cmd_delete', 'valueDefault');</span>
<a href="#l31.143"></a><span id="l31.143" class="difflineminus">-  goSetAccessKey('cmd_delete', 'valueDefaultAccessKey');</span>
<a href="#l31.144"></a><span id="l31.144" class="difflineminus">-  document.commandDispatcher.updateCommands('create-menu-edit');</span>
<a href="#l31.145"></a><span id="l31.145" class="difflineplus">+function InitAppFolderViewsMenu() {</span>
<a href="#l31.146"></a><span id="l31.146" class="difflineplus">+  goSetMenuValue(&quot;cmd_delete&quot;, &quot;valueDefault&quot;);</span>
<a href="#l31.147"></a><span id="l31.147" class="difflineplus">+  goSetAccessKey(&quot;cmd_delete&quot;, &quot;valueDefaultAccessKey&quot;);</span>
<a href="#l31.148"></a><span id="l31.148" class="difflineplus">+  document.commandDispatcher.updateCommands(&quot;create-menu-edit&quot;);</span>
<a href="#l31.149"></a><span id="l31.149"> </span>
<a href="#l31.150"></a><span id="l31.150">   // initialize the favorite Folder checkbox in the appmenu menu</span>
<a href="#l31.151"></a><span id="l31.151" class="difflineminus">-  let favoriteAppFolderMenu = document.getElementById('appmenu_favoriteFolder');</span>
<a href="#l31.152"></a><span id="l31.152" class="difflineplus">+  let favoriteAppFolderMenu = document.getElementById(&quot;appmenu_favoriteFolder&quot;);</span>
<a href="#l31.153"></a><span id="l31.153">   if (!favoriteAppFolderMenu.hasAttribute(&quot;disabled&quot;)) {</span>
<a href="#l31.154"></a><span id="l31.154">     let folders = gFolderTreeView.getSelectedFolders();</span>
<a href="#l31.155"></a><span id="l31.155">     if (folders.length == 1 &amp;&amp; !folders[0].isServer) {</span>
<a href="#l31.156"></a><span id="l31.156">       // Adjust the checked state on the menu item.</span>
<a href="#l31.157"></a><span id="l31.157">       favoriteAppFolderMenu.setAttribute(&quot;checked&quot;,</span>
<a href="#l31.158"></a><span id="l31.158">         folders[0].getFlag(Ci.nsMsgFolderFlags.Favorite));</span>
<a href="#l31.159"></a><span id="l31.159">       favoriteAppFolderMenu.hidden = false;</span>
<a href="#l31.160"></a><span id="l31.160">     } else {</span>
<a href="#l31.161"></a><span id="l31.161">       favoriteAppFolderMenu.hidden = true;</span>
<a href="#l31.162"></a><span id="l31.162">     }</span>
<a href="#l31.163"></a><span id="l31.163">   }</span>
<a href="#l31.164"></a><span id="l31.164"> }</span>
<a href="#l31.165"></a><span id="l31.165"> </span>
<a href="#l31.166"></a><span id="l31.166" class="difflineminus">-function InitGoMessagesMenu()</span>
<a href="#l31.167"></a><span id="l31.167" class="difflineminus">-{</span>
<a href="#l31.168"></a><span id="l31.168" class="difflineminus">-  document.commandDispatcher.updateCommands('create-menu-go');</span>
<a href="#l31.169"></a><span id="l31.169" class="difflineplus">+function InitGoMessagesMenu() {</span>
<a href="#l31.170"></a><span id="l31.170" class="difflineplus">+  document.commandDispatcher.updateCommands(&quot;create-menu-go&quot;);</span>
<a href="#l31.171"></a><span id="l31.171"> }</span>
<a href="#l31.172"></a><span id="l31.172"> </span>
<a href="#l31.173"></a><span id="l31.173"> /**</span>
<a href="#l31.174"></a><span id="l31.174">  * This is called every time the view menu popup is displayed.  It is</span>
<a href="#l31.175"></a><span id="l31.175">  *  responsible for updating the menu items' state to reflect reality.</span>
<a href="#l31.176"></a><span id="l31.176">  */</span>
<a href="#l31.177"></a><span id="l31.177" class="difflineminus">-function view_init()</span>
<a href="#l31.178"></a><span id="l31.178" class="difflineminus">-{</span>
<a href="#l31.179"></a><span id="l31.179" class="difflineplus">+function view_init() {</span>
<a href="#l31.180"></a><span id="l31.180">   let isFeed = gFolderDisplay &amp;&amp;</span>
<a href="#l31.181"></a><span id="l31.181">                (FeedMessageHandler.isFeedFolder(gFolderDisplay.displayedFolder) ||</span>
<a href="#l31.182"></a><span id="l31.182">                 gFolderDisplay.selectedMessageIsFeed);</span>
<a href="#l31.183"></a><span id="l31.183"> </span>
<a href="#l31.184"></a><span id="l31.184">   let accountCentralDisplayed = gFolderDisplay.isAccountCentralDisplayed;</span>
<a href="#l31.185"></a><span id="l31.185">   let messagePaneMenuItem = document.getElementById(&quot;menu_showMessage&quot;);</span>
<a href="#l31.186"></a><span id="l31.186">   if (!messagePaneMenuItem.hidden) { // Hidden in the standalone msg window.</span>
<a href="#l31.187"></a><span id="l31.187">     messagePaneMenuItem.setAttribute(&quot;checked&quot;,</span>
<a href="#l31.188"></a><span id="l31.188" class="difflineat">@@ -236,29 +226,29 @@ function view_init()</span>
<a href="#l31.189"></a><span id="l31.189"> </span>
<a href="#l31.190"></a><span id="l31.190">   let appmenuViewMessagesMenu = document.getElementById(&quot;appmenu_viewMessagesMenu&quot;);</span>
<a href="#l31.191"></a><span id="l31.191">   if (appmenuViewMessagesMenu)</span>
<a href="#l31.192"></a><span id="l31.192">     appmenuViewMessagesMenu.disabled = accountCentralDisplayed;</span>
<a href="#l31.193"></a><span id="l31.193"> </span>
<a href="#l31.194"></a><span id="l31.194">   // Hide the views menu item if the user doesn't have the views toolbar button</span>
<a href="#l31.195"></a><span id="l31.195">   // visible.</span>
<a href="#l31.196"></a><span id="l31.196">   var viewsToolbarButton = document.getElementById(&quot;mailviews-container&quot;);</span>
<a href="#l31.197"></a><span id="l31.197" class="difflineminus">-  document.getElementById('viewMessageViewMenu').hidden = !viewsToolbarButton;</span>
<a href="#l31.198"></a><span id="l31.198" class="difflineplus">+  document.getElementById(&quot;viewMessageViewMenu&quot;).hidden = !viewsToolbarButton;</span>
<a href="#l31.199"></a><span id="l31.199"> </span>
<a href="#l31.200"></a><span id="l31.200">   // Initialize the Message Body menuitem</span>
<a href="#l31.201"></a><span id="l31.201" class="difflineminus">-  document.getElementById('viewBodyMenu').hidden = isFeed;</span>
<a href="#l31.202"></a><span id="l31.202" class="difflineminus">-</span>
<a href="#l31.203"></a><span id="l31.203" class="difflineminus">-  let appmenuViewBodyMenu = document.getElementById('appmenu_viewBodyMenu');</span>
<a href="#l31.204"></a><span id="l31.204" class="difflineplus">+  document.getElementById(&quot;viewBodyMenu&quot;).hidden = isFeed;</span>
<a href="#l31.205"></a><span id="l31.205" class="difflineplus">+</span>
<a href="#l31.206"></a><span id="l31.206" class="difflineplus">+  let appmenuViewBodyMenu = document.getElementById(&quot;appmenu_viewBodyMenu&quot;);</span>
<a href="#l31.207"></a><span id="l31.207">   if (appmenuViewBodyMenu)</span>
<a href="#l31.208"></a><span id="l31.208">     appmenuViewBodyMenu.hidden = isFeed;</span>
<a href="#l31.209"></a><span id="l31.209"> </span>
<a href="#l31.210"></a><span id="l31.210">   // Initialize the Show Feed Summary menu</span>
<a href="#l31.211"></a><span id="l31.211" class="difflineminus">-  let viewFeedSummary = document.getElementById('viewFeedSummary');</span>
<a href="#l31.212"></a><span id="l31.212" class="difflineplus">+  let viewFeedSummary = document.getElementById(&quot;viewFeedSummary&quot;);</span>
<a href="#l31.213"></a><span id="l31.213">   viewFeedSummary.hidden = !isFeed;</span>
<a href="#l31.214"></a><span id="l31.214" class="difflineminus">-  let appmenuViewFeedSummary = document.getElementById('appmenu_viewFeedSummary');</span>
<a href="#l31.215"></a><span id="l31.215" class="difflineplus">+  let appmenuViewFeedSummary = document.getElementById(&quot;appmenu_viewFeedSummary&quot;);</span>
<a href="#l31.216"></a><span id="l31.216">   if (appmenuViewFeedSummary)</span>
<a href="#l31.217"></a><span id="l31.217">     appmenuViewFeedSummary.hidden = !isFeed;</span>
<a href="#l31.218"></a><span id="l31.218"> </span>
<a href="#l31.219"></a><span id="l31.219">   let viewRssMenuItemIds = [&quot;bodyFeedGlobalWebPage&quot;,</span>
<a href="#l31.220"></a><span id="l31.220">                             &quot;bodyFeedGlobalSummary&quot;,</span>
<a href="#l31.221"></a><span id="l31.221">                             &quot;bodyFeedPerFolderPref&quot;];</span>
<a href="#l31.222"></a><span id="l31.222">   let checked = FeedMessageHandler.onSelectPref;</span>
<a href="#l31.223"></a><span id="l31.223">   for (let [index, id] of viewRssMenuItemIds.entries()) {</span>
<a href="#l31.224"></a><span id="l31.224" class="difflineat">@@ -271,61 +261,57 @@ function view_init()</span>
<a href="#l31.225"></a><span id="l31.225">   document.getElementById(&quot;viewAttachmentsInlineMenuitem&quot;)</span>
<a href="#l31.226"></a><span id="l31.226">           .setAttribute(&quot;checked&quot;, viewAttachmentInline);</span>
<a href="#l31.227"></a><span id="l31.227"> </span>
<a href="#l31.228"></a><span id="l31.228">   let viewAttachmentInlineMenu =</span>
<a href="#l31.229"></a><span id="l31.229">     document.getElementById(&quot;appmenu_viewAttachmentsInlineMenuitem&quot;);</span>
<a href="#l31.230"></a><span id="l31.230">   if (viewAttachmentInlineMenu)</span>
<a href="#l31.231"></a><span id="l31.231">     viewAttachmentInlineMenu.setAttribute(&quot;checked&quot;, viewAttachmentInline);</span>
<a href="#l31.232"></a><span id="l31.232"> </span>
<a href="#l31.233"></a><span id="l31.233" class="difflineminus">-  document.commandDispatcher.updateCommands('create-menu-view');</span>
<a href="#l31.234"></a><span id="l31.234" class="difflineplus">+  document.commandDispatcher.updateCommands(&quot;create-menu-view&quot;);</span>
<a href="#l31.235"></a><span id="l31.235"> </span>
<a href="#l31.236"></a><span id="l31.236">   // Disable the charset item if there's nothing to enable</span>
<a href="#l31.237"></a><span id="l31.237">   document.getElementById(&quot;charsetMenu&quot;)</span>
<a href="#l31.238"></a><span id="l31.238">           .setAttribute(&quot;disabled&quot;, !gMessageDisplay.displayedMessage);</span>
<a href="#l31.239"></a><span id="l31.239">   let appmenuCharset = document.getElementById(&quot;appmenu_charsetMenu&quot;);</span>
<a href="#l31.240"></a><span id="l31.240">   if (appmenuCharset)</span>
<a href="#l31.241"></a><span id="l31.241">     appmenuCharset.setAttribute(&quot;disabled&quot;, !gMessageDisplay.displayedMessage);</span>
<a href="#l31.242"></a><span id="l31.242"> }</span>
<a href="#l31.243"></a><span id="l31.243"> </span>
<a href="#l31.244"></a><span id="l31.244" class="difflineminus">-function InitViewLayoutStyleMenu(event)</span>
<a href="#l31.245"></a><span id="l31.245" class="difflineminus">-{</span>
<a href="#l31.246"></a><span id="l31.246" class="difflineplus">+function InitViewLayoutStyleMenu(event) {</span>
<a href="#l31.247"></a><span id="l31.247">   // Prevent submenus from unnecessarily triggering onViewToolbarsPopupShowing</span>
<a href="#l31.248"></a><span id="l31.248">   // via bubbling of events.</span>
<a href="#l31.249"></a><span id="l31.249">   event.stopImmediatePropagation();</span>
<a href="#l31.250"></a><span id="l31.250">   var paneConfig = Services.prefs.getIntPref(&quot;mail.pane_config.dynamic&quot;);</span>
<a href="#l31.251"></a><span id="l31.251">   var layoutStyleMenuitem = event.target.childNodes[paneConfig];</span>
<a href="#l31.252"></a><span id="l31.252">   if (layoutStyleMenuitem)</span>
<a href="#l31.253"></a><span id="l31.253">     layoutStyleMenuitem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l31.254"></a><span id="l31.254"> }</span>
<a href="#l31.255"></a><span id="l31.255"> </span>
<a href="#l31.256"></a><span id="l31.256"> /**</span>
<a href="#l31.257"></a><span id="l31.257" class="difflineminus">- * Initialize (check) appropriate folder mode under the View |Folder menu.</span>
<a href="#l31.258"></a><span id="l31.258" class="difflineplus">+ * Initialize (check) appropriate folder mode under the View | Folder menu.</span>
<a href="#l31.259"></a><span id="l31.259">  */</span>
<a href="#l31.260"></a><span id="l31.260" class="difflineminus">-function InitViewFolderViewsMenu(event)</span>
<a href="#l31.261"></a><span id="l31.261" class="difflineminus">-{</span>
<a href="#l31.262"></a><span id="l31.262" class="difflineplus">+function InitViewFolderViewsMenu(event) {</span>
<a href="#l31.263"></a><span id="l31.263">   let selected = event.target.querySelector(&quot;[value=&quot; + gFolderTreeView.baseMode() + &quot;]&quot;);</span>
<a href="#l31.264"></a><span id="l31.264">   if (selected) {</span>
<a href="#l31.265"></a><span id="l31.265">     selected.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l31.266"></a><span id="l31.266">   }</span>
<a href="#l31.267"></a><span id="l31.267"> }</span>
<a href="#l31.268"></a><span id="l31.268"> </span>
<a href="#l31.269"></a><span id="l31.269" class="difflineminus">-function setSortByMenuItemCheckState(id, value)</span>
<a href="#l31.270"></a><span id="l31.270" class="difflineminus">-{</span>
<a href="#l31.271"></a><span id="l31.271" class="difflineplus">+function setSortByMenuItemCheckState(id, value) {</span>
<a href="#l31.272"></a><span id="l31.272">   var menuitem = document.getElementById(id);</span>
<a href="#l31.273"></a><span id="l31.273">   if (menuitem)</span>
<a href="#l31.274"></a><span id="l31.274">     menuitem.setAttribute(&quot;checked&quot;, value);</span>
<a href="#l31.275"></a><span id="l31.275"> }</span>
<a href="#l31.276"></a><span id="l31.276"> </span>
<a href="#l31.277"></a><span id="l31.277"> /**</span>
<a href="#l31.278"></a><span id="l31.278">  * Called when showing the menu_viewSortPopup menupopup, so it should always</span>
<a href="#l31.279"></a><span id="l31.279">  * be up-to-date.</span>
<a href="#l31.280"></a><span id="l31.280">  */</span>
<a href="#l31.281"></a><span id="l31.281" class="difflineminus">-function InitViewSortByMenu()</span>
<a href="#l31.282"></a><span id="l31.282" class="difflineminus">-{</span>
<a href="#l31.283"></a><span id="l31.283" class="difflineplus">+function InitViewSortByMenu() {</span>
<a href="#l31.284"></a><span id="l31.284">   var sortType = gFolderDisplay.view.primarySortType;</span>
<a href="#l31.285"></a><span id="l31.285"> </span>
<a href="#l31.286"></a><span id="l31.286">   setSortByMenuItemCheckState(&quot;sortByDateMenuitem&quot;, (sortType == nsMsgViewSortType.byDate));</span>
<a href="#l31.287"></a><span id="l31.287">   setSortByMenuItemCheckState(&quot;sortByReceivedMenuitem&quot;, (sortType == nsMsgViewSortType.byReceived));</span>
<a href="#l31.288"></a><span id="l31.288">   setSortByMenuItemCheckState(&quot;sortByFlagMenuitem&quot;, (sortType == nsMsgViewSortType.byFlagged));</span>
<a href="#l31.289"></a><span id="l31.289">   setSortByMenuItemCheckState(&quot;sortByOrderReceivedMenuitem&quot;, (sortType == nsMsgViewSortType.byId));</span>
<a href="#l31.290"></a><span id="l31.290">   setSortByMenuItemCheckState(&quot;sortByPriorityMenuitem&quot;, (sortType == nsMsgViewSortType.byPriority));</span>
<a href="#l31.291"></a><span id="l31.291">   setSortByMenuItemCheckState(&quot;sortBySizeMenuitem&quot;, (sortType == nsMsgViewSortType.bySize));</span>
<a href="#l31.292"></a><span id="l31.292" class="difflineat">@@ -354,18 +340,17 @@ function InitViewSortByMenu()</span>
<a href="#l31.293"></a><span id="l31.293">   sortUnthreadedMenuItem.setAttribute(&quot;checked&quot;, !threaded &amp;&amp; !grouped);</span>
<a href="#l31.294"></a><span id="l31.294"> </span>
<a href="#l31.295"></a><span id="l31.295">   var groupBySortOrderMenuItem = document.getElementById(&quot;groupBySort&quot;);</span>
<a href="#l31.296"></a><span id="l31.296"> </span>
<a href="#l31.297"></a><span id="l31.297">   groupBySortOrderMenuItem.setAttribute(&quot;disabled&quot;, !sortTypeSupportsGrouping);</span>
<a href="#l31.298"></a><span id="l31.298">   groupBySortOrderMenuItem.setAttribute(&quot;checked&quot;, grouped);</span>
<a href="#l31.299"></a><span id="l31.299"> }</span>
<a href="#l31.300"></a><span id="l31.300"> </span>
<a href="#l31.301"></a><span id="l31.301" class="difflineminus">-function InitAppViewSortByMenu()</span>
<a href="#l31.302"></a><span id="l31.302" class="difflineminus">-{</span>
<a href="#l31.303"></a><span id="l31.303" class="difflineplus">+function InitAppViewSortByMenu() {</span>
<a href="#l31.304"></a><span id="l31.304">   let sortType = gFolderDisplay.view.primarySortType;</span>
<a href="#l31.305"></a><span id="l31.305"> </span>
<a href="#l31.306"></a><span id="l31.306">   setSortByMenuItemCheckState(&quot;appmenu_sortByDateMenuitem&quot;, (sortType == nsMsgViewSortType.byDate));</span>
<a href="#l31.307"></a><span id="l31.307">   setSortByMenuItemCheckState(&quot;appmenu_sortByReceivedMenuitem&quot;, (sortType == nsMsgViewSortType.byReceived));</span>
<a href="#l31.308"></a><span id="l31.308">   setSortByMenuItemCheckState(&quot;appmenu_sortByFlagMenuitem&quot;, (sortType == nsMsgViewSortType.byFlagged));</span>
<a href="#l31.309"></a><span id="l31.309">   setSortByMenuItemCheckState(&quot;appmenu_sortByOrderReceivedMenuitem&quot;, (sortType == nsMsgViewSortType.byId));</span>
<a href="#l31.310"></a><span id="l31.310">   setSortByMenuItemCheckState(&quot;appmenu_sortByPriorityMenuitem&quot;, (sortType == nsMsgViewSortType.byPriority));</span>
<a href="#l31.311"></a><span id="l31.311">   setSortByMenuItemCheckState(&quot;appmenu_sortBySizeMenuitem&quot;, (sortType == nsMsgViewSortType.bySize));</span>
<a href="#l31.312"></a><span id="l31.312" class="difflineat">@@ -393,36 +378,34 @@ function InitAppViewSortByMenu()</span>
<a href="#l31.313"></a><span id="l31.313">   sortUnthreadedMenuItem.setAttribute(&quot;checked&quot;, !threaded &amp;&amp; !grouped);</span>
<a href="#l31.314"></a><span id="l31.314"> </span>
<a href="#l31.315"></a><span id="l31.315">   let groupBySortOrderMenuItem = document.getElementById(&quot;appmenu_groupBySort&quot;);</span>
<a href="#l31.316"></a><span id="l31.316"> </span>
<a href="#l31.317"></a><span id="l31.317">   groupBySortOrderMenuItem.setAttribute(&quot;disabled&quot;, !sortTypeSupportsGrouping);</span>
<a href="#l31.318"></a><span id="l31.318">   groupBySortOrderMenuItem.setAttribute(&quot;checked&quot;, grouped);</span>
<a href="#l31.319"></a><span id="l31.319"> }</span>
<a href="#l31.320"></a><span id="l31.320"> </span>
<a href="#l31.321"></a><span id="l31.321" class="difflineminus">-function isSortTypeValidForGrouping(sortType)</span>
<a href="#l31.322"></a><span id="l31.322" class="difflineminus">-{</span>
<a href="#l31.323"></a><span id="l31.323" class="difflineplus">+function isSortTypeValidForGrouping(sortType) {</span>
<a href="#l31.324"></a><span id="l31.324">   return Boolean(sortType == nsMsgViewSortType.byAccount ||</span>
<a href="#l31.325"></a><span id="l31.325">                  sortType == nsMsgViewSortType.byAttachments ||</span>
<a href="#l31.326"></a><span id="l31.326">                  sortType == nsMsgViewSortType.byAuthor ||</span>
<a href="#l31.327"></a><span id="l31.327">                  sortType == nsMsgViewSortType.byCorrespondent ||</span>
<a href="#l31.328"></a><span id="l31.328">                  sortType == nsMsgViewSortType.byDate ||</span>
<a href="#l31.329"></a><span id="l31.329">                  sortType == nsMsgViewSortType.byFlagged ||</span>
<a href="#l31.330"></a><span id="l31.330">                  sortType == nsMsgViewSortType.byLocation ||</span>
<a href="#l31.331"></a><span id="l31.331">                  sortType == nsMsgViewSortType.byPriority ||</span>
<a href="#l31.332"></a><span id="l31.332">                  sortType == nsMsgViewSortType.byReceived ||</span>
<a href="#l31.333"></a><span id="l31.333">                  sortType == nsMsgViewSortType.byRecipient ||</span>
<a href="#l31.334"></a><span id="l31.334">                  sortType == nsMsgViewSortType.byStatus ||</span>
<a href="#l31.335"></a><span id="l31.335">                  sortType == nsMsgViewSortType.bySubject ||</span>
<a href="#l31.336"></a><span id="l31.336">                  sortType == nsMsgViewSortType.byTags ||</span>
<a href="#l31.337"></a><span id="l31.337">                  sortType == nsMsgViewSortType.byCustom);</span>
<a href="#l31.338"></a><span id="l31.338"> }</span>
<a href="#l31.339"></a><span id="l31.339"> </span>
<a href="#l31.340"></a><span id="l31.340" class="difflineminus">-function InitViewMessagesMenu()</span>
<a href="#l31.341"></a><span id="l31.341" class="difflineminus">-{</span>
<a href="#l31.342"></a><span id="l31.342" class="difflineplus">+function InitViewMessagesMenu() {</span>
<a href="#l31.343"></a><span id="l31.343">   document.getElementById(&quot;viewAllMessagesMenuItem&quot;).setAttribute(&quot;checked&quot;,</span>
<a href="#l31.344"></a><span id="l31.344">     !gFolderDisplay.view.showUnreadOnly &amp;&amp;</span>
<a href="#l31.345"></a><span id="l31.345">     !gFolderDisplay.view.specialView);</span>
<a href="#l31.346"></a><span id="l31.346"> </span>
<a href="#l31.347"></a><span id="l31.347">   document.getElementById(&quot;viewUnreadMessagesMenuItem&quot;).setAttribute(&quot;checked&quot;,</span>
<a href="#l31.348"></a><span id="l31.348">     gFolderDisplay.view.showUnreadOnly);</span>
<a href="#l31.349"></a><span id="l31.349"> </span>
<a href="#l31.350"></a><span id="l31.350">   document.getElementById(&quot;viewThreadsWithUnreadMenuItem&quot;).setAttribute(&quot;checked&quot;,</span>
<a href="#l31.351"></a><span id="l31.351" class="difflineat">@@ -430,18 +413,17 @@ function InitViewMessagesMenu()</span>
<a href="#l31.352"></a><span id="l31.352"> </span>
<a href="#l31.353"></a><span id="l31.353">   document.getElementById(&quot;viewWatchedThreadsWithUnreadMenuItem&quot;).setAttribute(&quot;checked&quot;,</span>
<a href="#l31.354"></a><span id="l31.354">     gFolderDisplay.view.specialViewWatchedThreadsWithUnread);</span>
<a href="#l31.355"></a><span id="l31.355"> </span>
<a href="#l31.356"></a><span id="l31.356">   document.getElementById(&quot;viewIgnoredThreadsMenuItem&quot;).setAttribute(&quot;checked&quot;,</span>
<a href="#l31.357"></a><span id="l31.357">     gFolderDisplay.view.showIgnored);</span>
<a href="#l31.358"></a><span id="l31.358"> }</span>
<a href="#l31.359"></a><span id="l31.359"> </span>
<a href="#l31.360"></a><span id="l31.360" class="difflineminus">-function InitAppmenuViewMessagesMenu()</span>
<a href="#l31.361"></a><span id="l31.361" class="difflineminus">-{</span>
<a href="#l31.362"></a><span id="l31.362" class="difflineplus">+function InitAppmenuViewMessagesMenu() {</span>
<a href="#l31.363"></a><span id="l31.363">   document.getElementById(&quot;appmenu_viewAllMessagesMenuItem&quot;).setAttribute(&quot;checked&quot;,</span>
<a href="#l31.364"></a><span id="l31.364">     !gFolderDisplay.view.showUnreadOnly &amp;&amp;</span>
<a href="#l31.365"></a><span id="l31.365">     !gFolderDisplay.view.specialView);</span>
<a href="#l31.366"></a><span id="l31.366"> </span>
<a href="#l31.367"></a><span id="l31.367">   document.getElementById(&quot;appmenu_viewUnreadMessagesMenuItem&quot;).setAttribute(&quot;checked&quot;,</span>
<a href="#l31.368"></a><span id="l31.368">     gFolderDisplay.view.showUnreadOnly);</span>
<a href="#l31.369"></a><span id="l31.369"> </span>
<a href="#l31.370"></a><span id="l31.370">   document.getElementById(&quot;appmenu_viewThreadsWithUnreadMenuItem&quot;).setAttribute(&quot;checked&quot;,</span>
<a href="#l31.371"></a><span id="l31.371" class="difflineat">@@ -449,18 +431,17 @@ function InitAppmenuViewMessagesMenu()</span>
<a href="#l31.372"></a><span id="l31.372"> </span>
<a href="#l31.373"></a><span id="l31.373">   document.getElementById(&quot;appmenu_viewWatchedThreadsWithUnreadMenuItem&quot;).setAttribute(&quot;checked&quot;,</span>
<a href="#l31.374"></a><span id="l31.374">     gFolderDisplay.view.specialViewWatchedThreadsWithUnread);</span>
<a href="#l31.375"></a><span id="l31.375"> </span>
<a href="#l31.376"></a><span id="l31.376">   document.getElementById(&quot;appmenu_viewIgnoredThreadsMenuItem&quot;).setAttribute(&quot;checked&quot;,</span>
<a href="#l31.377"></a><span id="l31.377">     gFolderDisplay.view.showIgnored);</span>
<a href="#l31.378"></a><span id="l31.378"> }</span>
<a href="#l31.379"></a><span id="l31.379"> </span>
<a href="#l31.380"></a><span id="l31.380" class="difflineminus">-function InitMessageMenu()</span>
<a href="#l31.381"></a><span id="l31.381" class="difflineminus">-{</span>
<a href="#l31.382"></a><span id="l31.382" class="difflineplus">+function InitMessageMenu() {</span>
<a href="#l31.383"></a><span id="l31.383">   var selectedMsg = gFolderDisplay.selectedMessage;</span>
<a href="#l31.384"></a><span id="l31.384">   var isNews = gFolderDisplay.selectedMessageIsNews;</span>
<a href="#l31.385"></a><span id="l31.385">   var isFeed = gFolderDisplay.selectedMessageIsFeed;</span>
<a href="#l31.386"></a><span id="l31.386"> </span>
<a href="#l31.387"></a><span id="l31.387">   // We show reply to Newsgroups only for news messages.</span>
<a href="#l31.388"></a><span id="l31.388">   document.getElementById(&quot;replyNewsgroupMainMenu&quot;).hidden = !isNews;</span>
<a href="#l31.389"></a><span id="l31.389"> </span>
<a href="#l31.390"></a><span id="l31.390">   // For mail messages we say reply. For news we say ReplyToSender.</span>
<a href="#l31.391"></a><span id="l31.391" class="difflineat">@@ -495,38 +476,37 @@ function InitMessageMenu()</span>
<a href="#l31.392"></a><span id="l31.392">   showCommandInSpecialFolder(&quot;cmd_editDraftMsg&quot;,</span>
<a href="#l31.393"></a><span id="l31.393">                              Ci.nsMsgFolderFlags.Drafts);</span>
<a href="#l31.394"></a><span id="l31.394">   // Show &quot;New Message from Template&quot; and &quot;Edit Template&quot; menus only in a</span>
<a href="#l31.395"></a><span id="l31.395">   // templates folder; otherwise hide them.</span>
<a href="#l31.396"></a><span id="l31.396">   showCommandInSpecialFolder([&quot;cmd_newMsgFromTemplate&quot;, &quot;cmd_editTemplateMsg&quot;],</span>
<a href="#l31.397"></a><span id="l31.397">                              Ci.nsMsgFolderFlags.Templates);</span>
<a href="#l31.398"></a><span id="l31.398"> </span>
<a href="#l31.399"></a><span id="l31.399">   // Initialize the Open Message menuitem</span>
<a href="#l31.400"></a><span id="l31.400" class="difflineminus">-  var winType = document.documentElement.getAttribute('windowtype');</span>
<a href="#l31.401"></a><span id="l31.401" class="difflineplus">+  var winType = document.documentElement.getAttribute(&quot;windowtype&quot;);</span>
<a href="#l31.402"></a><span id="l31.402">   if (winType == &quot;mail:3pane&quot;)</span>
<a href="#l31.403"></a><span id="l31.403" class="difflineminus">-    document.getElementById('openMessageWindowMenuitem').hidden = isFeed;</span>
<a href="#l31.404"></a><span id="l31.404" class="difflineplus">+    document.getElementById(&quot;openMessageWindowMenuitem&quot;).hidden = isFeed;</span>
<a href="#l31.405"></a><span id="l31.405"> </span>
<a href="#l31.406"></a><span id="l31.406">   // Initialize the Open Feed Message handler menu</span>
<a href="#l31.407"></a><span id="l31.407">   let index = FeedMessageHandler.onOpenPref;</span>
<a href="#l31.408"></a><span id="l31.408">   document.getElementById(&quot;menu_openFeedMessage&quot;)</span>
<a href="#l31.409"></a><span id="l31.409">           .childNodes[index].setAttribute(&quot;checked&quot;, true);</span>
<a href="#l31.410"></a><span id="l31.410"> </span>
<a href="#l31.411"></a><span id="l31.411">   let openRssMenu = document.getElementById(&quot;openFeedMessage&quot;);</span>
<a href="#l31.412"></a><span id="l31.412">   openRssMenu.hidden = !isFeed;</span>
<a href="#l31.413"></a><span id="l31.413">   if (winType != &quot;mail:3pane&quot;)</span>
<a href="#l31.414"></a><span id="l31.414">     openRssMenu.hidden = true;</span>
<a href="#l31.415"></a><span id="l31.415"> </span>
<a href="#l31.416"></a><span id="l31.416">   // Disable mark menu when we're not in a folder.</span>
<a href="#l31.417"></a><span id="l31.417">   document.getElementById(&quot;markMenu&quot;).disabled = gMessageDisplay.isDummy;</span>
<a href="#l31.418"></a><span id="l31.418"> </span>
<a href="#l31.419"></a><span id="l31.419" class="difflineminus">-  document.commandDispatcher.updateCommands('create-menu-message');</span>
<a href="#l31.420"></a><span id="l31.420" class="difflineplus">+  document.commandDispatcher.updateCommands(&quot;create-menu-message&quot;);</span>
<a href="#l31.421"></a><span id="l31.421"> }</span>
<a href="#l31.422"></a><span id="l31.422"> </span>
<a href="#l31.423"></a><span id="l31.423" class="difflineminus">-function InitAppMessageMenu()</span>
<a href="#l31.424"></a><span id="l31.424" class="difflineminus">-{</span>
<a href="#l31.425"></a><span id="l31.425" class="difflineplus">+function InitAppMessageMenu() {</span>
<a href="#l31.426"></a><span id="l31.426">   let selectedMsg = gFolderDisplay.selectedMessage;</span>
<a href="#l31.427"></a><span id="l31.427">   let isNews = gFolderDisplay.selectedMessageIsNews;</span>
<a href="#l31.428"></a><span id="l31.428">   let isFeed = gFolderDisplay.selectedMessageIsFeed;</span>
<a href="#l31.429"></a><span id="l31.429"> </span>
<a href="#l31.430"></a><span id="l31.430">   // We show reply to Newsgroups only for news messages.</span>
<a href="#l31.431"></a><span id="l31.431">   document.getElementById(&quot;appmenu_replyNewsgroupMainMenu&quot;).hidden = !isNews;</span>
<a href="#l31.432"></a><span id="l31.432"> </span>
<a href="#l31.433"></a><span id="l31.433">   // For mail messages we say reply. For news we say ReplyToSender.</span>
<a href="#l31.434"></a><span id="l31.434" class="difflineat">@@ -561,47 +541,46 @@ function InitAppMessageMenu()</span>
<a href="#l31.435"></a><span id="l31.435">   showCommandInSpecialFolder(&quot;cmd_editDraftMsg&quot;,</span>
<a href="#l31.436"></a><span id="l31.436">                              Ci.nsMsgFolderFlags.Drafts);</span>
<a href="#l31.437"></a><span id="l31.437">   // Show &quot;New Message from Template&quot; and &quot;Edit Template&quot; menus only in a</span>
<a href="#l31.438"></a><span id="l31.438">   // templates folder; otherwise hide them.</span>
<a href="#l31.439"></a><span id="l31.439">   showCommandInSpecialFolder([&quot;cmd_newMsgFromTemplate&quot;, &quot;cmd_editTemplateMsg&quot;],</span>
<a href="#l31.440"></a><span id="l31.440">                              Ci.nsMsgFolderFlags.Templates);</span>
<a href="#l31.441"></a><span id="l31.441"> </span>
<a href="#l31.442"></a><span id="l31.442">   // Initialize the Open Message menuitem</span>
<a href="#l31.443"></a><span id="l31.443" class="difflineminus">-  let winType = document.documentElement.getAttribute('windowtype');</span>
<a href="#l31.444"></a><span id="l31.444" class="difflineplus">+  let winType = document.documentElement.getAttribute(&quot;windowtype&quot;);</span>
<a href="#l31.445"></a><span id="l31.445">   if (winType == &quot;mail:3pane&quot;)</span>
<a href="#l31.446"></a><span id="l31.446" class="difflineminus">-    document.getElementById('appmenu_openMessageWindowMenuitem').hidden = isFeed;</span>
<a href="#l31.447"></a><span id="l31.447" class="difflineplus">+    document.getElementById(&quot;appmenu_openMessageWindowMenuitem&quot;).hidden = isFeed;</span>
<a href="#l31.448"></a><span id="l31.448"> </span>
<a href="#l31.449"></a><span id="l31.449">   // Initialize the Open Feed Message handler menu</span>
<a href="#l31.450"></a><span id="l31.450">   let index = FeedMessageHandler.onOpenPref;</span>
<a href="#l31.451"></a><span id="l31.451">   document.getElementById(&quot;appmenu_openFeedMessagePopup&quot;)</span>
<a href="#l31.452"></a><span id="l31.452">           .childNodes[index]</span>
<a href="#l31.453"></a><span id="l31.453">           .setAttribute(&quot;checked&quot;, true);</span>
<a href="#l31.454"></a><span id="l31.454"> </span>
<a href="#l31.455"></a><span id="l31.455">   let openRssMenu = document.getElementById(&quot;appmenu_openFeedMessage&quot;);</span>
<a href="#l31.456"></a><span id="l31.456">   openRssMenu.hidden = !isFeed;</span>
<a href="#l31.457"></a><span id="l31.457">   if (winType != &quot;mail:3pane&quot;)</span>
<a href="#l31.458"></a><span id="l31.458">     openRssMenu.hidden = true;</span>
<a href="#l31.459"></a><span id="l31.459"> </span>
<a href="#l31.460"></a><span id="l31.460">   // Disable mark menu when we're not in a folder.</span>
<a href="#l31.461"></a><span id="l31.461">   document.getElementById(&quot;appmenu_markMenu&quot;).disabled = gMessageDisplay.isDummy;</span>
<a href="#l31.462"></a><span id="l31.462" class="difflineminus">-  document.commandDispatcher.updateCommands('create-menu-message');</span>
<a href="#l31.463"></a><span id="l31.463" class="difflineplus">+  document.commandDispatcher.updateCommands(&quot;create-menu-message&quot;);</span>
<a href="#l31.464"></a><span id="l31.464"> }</span>
<a href="#l31.465"></a><span id="l31.465"> </span>
<a href="#l31.466"></a><span id="l31.466"> /**</span>
<a href="#l31.467"></a><span id="l31.467">  * Show folder-specific menu items only for messages in special folders, e.g.</span>
<a href="#l31.468"></a><span id="l31.468">  * show 'cmd_editDraftMsg' in Drafts folder, or</span>
<a href="#l31.469"></a><span id="l31.469">  * show 'cmd_newMsgFromTemplate' in Templates folder.</span>
<a href="#l31.470"></a><span id="l31.470">  *</span>
<a href="#l31.471"></a><span id="l31.471">  * aCommandIds  single ID string of command or array of IDs of commands</span>
<a href="#l31.472"></a><span id="l31.472">  *              to be shown in folders having aFolderFlag</span>
<a href="#l31.473"></a><span id="l31.473">  * aFolderFlag  the nsMsgFolderFlag that the folder must have to show the command</span>
<a href="#l31.474"></a><span id="l31.474">  */</span>
<a href="#l31.475"></a><span id="l31.475" class="difflineminus">-function showCommandInSpecialFolder(aCommandIds, aFolderFlag)</span>
<a href="#l31.476"></a><span id="l31.476" class="difflineminus">-{</span>
<a href="#l31.477"></a><span id="l31.477" class="difflineplus">+function showCommandInSpecialFolder(aCommandIds, aFolderFlag) {</span>
<a href="#l31.478"></a><span id="l31.478">   let msg = gFolderDisplay.selectedMessage;</span>
<a href="#l31.479"></a><span id="l31.479">   let folder = gFolderDisplay.displayedFolder;</span>
<a href="#l31.480"></a><span id="l31.480">   let inSpecialFolder = (msg &amp;&amp;</span>
<a href="#l31.481"></a><span id="l31.481">                          msg.folder &amp;&amp;  // Check folder as messages opened from file have none.</span>
<a href="#l31.482"></a><span id="l31.482">                          msg.folder.isSpecialFolder(aFolderFlag, true)) ||</span>
<a href="#l31.483"></a><span id="l31.483">                         (folder &amp;&amp; folder.getFlag(aFolderFlag));</span>
<a href="#l31.484"></a><span id="l31.484">   if (typeof aCommandIds === &quot;string&quot;)</span>
<a href="#l31.485"></a><span id="l31.485">     aCommandIds = [aCommandIds];</span>
<a href="#l31.486"></a><span id="l31.486" class="difflineat">@@ -613,56 +592,51 @@ function showCommandInSpecialFolder(aCom</span>
<a href="#l31.487"></a><span id="l31.487"> </span>
<a href="#l31.488"></a><span id="l31.488"> /**</span>
<a href="#l31.489"></a><span id="l31.489">  * Initializes the menu item aMenuItem to show either &quot;Move&quot; or &quot;Copy&quot; to</span>
<a href="#l31.490"></a><span id="l31.490">  * folder again, based on the value of mail.last_msg_movecopy_target_uri.</span>
<a href="#l31.491"></a><span id="l31.491">  * The menu item label and accesskey are adjusted to include the folder name.</span>
<a href="#l31.492"></a><span id="l31.492">  *</span>
<a href="#l31.493"></a><span id="l31.493">  * @param aMenuItem the menu item to adjust</span>
<a href="#l31.494"></a><span id="l31.494">  */</span>
<a href="#l31.495"></a><span id="l31.495" class="difflineminus">-function initMoveToFolderAgainMenu(aMenuItem)</span>
<a href="#l31.496"></a><span id="l31.496" class="difflineminus">-{</span>
<a href="#l31.497"></a><span id="l31.497" class="difflineplus">+function initMoveToFolderAgainMenu(aMenuItem) {</span>
<a href="#l31.498"></a><span id="l31.498">   var lastFolderURI = Services.prefs.getCharPref(&quot;mail.last_msg_movecopy_target_uri&quot;);</span>
<a href="#l31.499"></a><span id="l31.499">   var isMove = Services.prefs.getBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;);</span>
<a href="#l31.500"></a><span id="l31.500" class="difflineminus">-  if (lastFolderURI)</span>
<a href="#l31.501"></a><span id="l31.501" class="difflineminus">-  {</span>
<a href="#l31.502"></a><span id="l31.502" class="difflineplus">+  if (lastFolderURI) {</span>
<a href="#l31.503"></a><span id="l31.503">     var destMsgFolder = MailUtils.getFolderForURI(lastFolderURI);</span>
<a href="#l31.504"></a><span id="l31.504">     var bundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l31.505"></a><span id="l31.505">     var stringName = isMove ? &quot;moveToFolderAgain&quot; : &quot;copyToFolderAgain&quot;;</span>
<a href="#l31.506"></a><span id="l31.506">     aMenuItem.label = bundle.getFormattedString(stringName,</span>
<a href="#l31.507"></a><span id="l31.507">                                                 [destMsgFolder.prettyName], 1);</span>
<a href="#l31.508"></a><span id="l31.508">     // This gives us moveToFolderAgainAccessKey and copyToFolderAgainAccessKey.</span>
<a href="#l31.509"></a><span id="l31.509">     aMenuItem.accesskey = bundle.getString(stringName + &quot;AccessKey&quot;);</span>
<a href="#l31.510"></a><span id="l31.510">   }</span>
<a href="#l31.511"></a><span id="l31.511"> }</span>
<a href="#l31.512"></a><span id="l31.512"> </span>
<a href="#l31.513"></a><span id="l31.513" class="difflineminus">-function InitViewHeadersMenu()</span>
<a href="#l31.514"></a><span id="l31.514" class="difflineminus">-{</span>
<a href="#l31.515"></a><span id="l31.515" class="difflineplus">+function InitViewHeadersMenu() {</span>
<a href="#l31.516"></a><span id="l31.516">   const dt = Ci.nsMimeHeaderDisplayTypes;</span>
<a href="#l31.517"></a><span id="l31.517">   var headerchoice = Services.prefs.getIntPref(&quot;mail.show_headers&quot;);</span>
<a href="#l31.518"></a><span id="l31.518">   document.getElementById(&quot;cmd_viewAllHeader&quot;)</span>
<a href="#l31.519"></a><span id="l31.519">           .setAttribute(&quot;checked&quot;, headerchoice == dt.AllHeaders);</span>
<a href="#l31.520"></a><span id="l31.520">   document.getElementById(&quot;cmd_viewNormalHeader&quot;)</span>
<a href="#l31.521"></a><span id="l31.521">           .setAttribute(&quot;checked&quot;, headerchoice == dt.NormalHeaders);</span>
<a href="#l31.522"></a><span id="l31.522">   document.commandDispatcher.updateCommands(&quot;create-menu-mark&quot;);</span>
<a href="#l31.523"></a><span id="l31.523"> }</span>
<a href="#l31.524"></a><span id="l31.524"> </span>
<a href="#l31.525"></a><span id="l31.525"> /**</span>
<a href="#l31.526"></a><span id="l31.526">  * @param headermode {Ci.nsMimeHeaderDisplayTypes}</span>
<a href="#l31.527"></a><span id="l31.527">  */</span>
<a href="#l31.528"></a><span id="l31.528" class="difflineminus">-function AdjustHeaderView(headermode)</span>
<a href="#l31.529"></a><span id="l31.529" class="difflineminus">-{</span>
<a href="#l31.530"></a><span id="l31.530" class="difflineplus">+function AdjustHeaderView(headermode) {</span>
<a href="#l31.531"></a><span id="l31.531">   const all = Ci.nsMimeHeaderDisplayTypes.AllHeaders;</span>
<a href="#l31.532"></a><span id="l31.532">   document.getElementById(&quot;expandedHeaderView&quot;)</span>
<a href="#l31.533"></a><span id="l31.533">       .setAttribute(&quot;show_header_mode&quot;, headermode == all ? &quot;all&quot; : &quot;normal&quot;);</span>
<a href="#l31.534"></a><span id="l31.534"> }</span>
<a href="#l31.535"></a><span id="l31.535"> </span>
<a href="#l31.536"></a><span id="l31.536"> </span>
<a href="#l31.537"></a><span id="l31.537" class="difflineminus">-function InitViewBodyMenu()</span>
<a href="#l31.538"></a><span id="l31.538" class="difflineminus">-{</span>
<a href="#l31.539"></a><span id="l31.539" class="difflineplus">+function InitViewBodyMenu() {</span>
<a href="#l31.540"></a><span id="l31.540">   // Separate render prefs not implemented for feeds, bug 458606.  Show the</span>
<a href="#l31.541"></a><span id="l31.541">   // checked item for feeds as for the regular pref.</span>
<a href="#l31.542"></a><span id="l31.542">   //  let html_as = Services.prefs.getIntPref(&quot;rss.display.html_as&quot;);</span>
<a href="#l31.543"></a><span id="l31.543">   //  let prefer_plaintext = Services.prefs.getBoolPref(&quot;rss.display.prefer_plaintext&quot;);</span>
<a href="#l31.544"></a><span id="l31.544">   //  let disallow_classes = Services.prefs.getIntPref(&quot;rss.display.disallow_mime_handlers&quot;);</span>
<a href="#l31.545"></a><span id="l31.545"> </span>
<a href="#l31.546"></a><span id="l31.546">   let html_as = Services.prefs.getIntPref(&quot;mailnews.display.html_as&quot;);</span>
<a href="#l31.547"></a><span id="l31.547">   let prefer_plaintext = Services.prefs.getBoolPref(&quot;mailnews.display.prefer_plaintext&quot;);</span>
<a href="#l31.548"></a><span id="l31.548" class="difflineat">@@ -683,17 +657,17 @@ function InitViewBodyMenu()</span>
<a href="#l31.549"></a><span id="l31.549"> </span>
<a href="#l31.550"></a><span id="l31.550">   let AllowHTML_menuitem = document.getElementById(menuIDs[0]);</span>
<a href="#l31.551"></a><span id="l31.551">   let Sanitized_menuitem = document.getElementById(menuIDs[1]);</span>
<a href="#l31.552"></a><span id="l31.552">   let AsPlaintext_menuitem = document.getElementById(menuIDs[2]);</span>
<a href="#l31.553"></a><span id="l31.553">   let AllBodyParts_menuitem = menuIDs[3] ? document.getElementById(menuIDs[3])</span>
<a href="#l31.554"></a><span id="l31.554">         : null;</span>
<a href="#l31.555"></a><span id="l31.555"> </span>
<a href="#l31.556"></a><span id="l31.556">   document.getElementById(&quot;bodyAllParts&quot;).hidden =</span>
<a href="#l31.557"></a><span id="l31.557" class="difflineminus">-    ! Services.prefs.getBoolPref(&quot;mailnews.display.show_all_body_parts_menu&quot;);</span>
<a href="#l31.558"></a><span id="l31.558" class="difflineplus">+    !Services.prefs.getBoolPref(&quot;mailnews.display.show_all_body_parts_menu&quot;);</span>
<a href="#l31.559"></a><span id="l31.559"> </span>
<a href="#l31.560"></a><span id="l31.560">   if (!prefer_plaintext &amp;&amp; !html_as &amp;&amp; !disallow_classes &amp;&amp;</span>
<a href="#l31.561"></a><span id="l31.561">       AllowHTML_menuitem)</span>
<a href="#l31.562"></a><span id="l31.562">     AllowHTML_menuitem.setAttribute(&quot;checked&quot;, true);</span>
<a href="#l31.563"></a><span id="l31.563">   else if (!prefer_plaintext &amp;&amp; html_as == 3 &amp;&amp; disallow_classes &gt; 0 &amp;&amp;</span>
<a href="#l31.564"></a><span id="l31.564">       Sanitized_menuitem)</span>
<a href="#l31.565"></a><span id="l31.565">     Sanitized_menuitem.setAttribute(&quot;checked&quot;, true);</span>
<a href="#l31.566"></a><span id="l31.566">   else if (prefer_plaintext &amp;&amp; html_as == 1 &amp;&amp; disallow_classes &gt; 0 &amp;&amp;</span>
<a href="#l31.567"></a><span id="l31.567" class="difflineat">@@ -707,18 +681,17 @@ function InitViewBodyMenu()</span>
<a href="#l31.568"></a><span id="l31.568">   if (isFeed) {</span>
<a href="#l31.569"></a><span id="l31.569">     AllowHTML_menuitem.hidden = !FeedMessageHandler.gShowSummary;</span>
<a href="#l31.570"></a><span id="l31.570">     Sanitized_menuitem.hidden = !FeedMessageHandler.gShowSummary;</span>
<a href="#l31.571"></a><span id="l31.571">     AsPlaintext_menuitem.hidden = !FeedMessageHandler.gShowSummary;</span>
<a href="#l31.572"></a><span id="l31.572">     document.getElementById(&quot;viewFeedSummarySeparator&quot;).hidden = !FeedMessageHandler.gShowSummary;</span>
<a href="#l31.573"></a><span id="l31.573">   }</span>
<a href="#l31.574"></a><span id="l31.574"> }</span>
<a href="#l31.575"></a><span id="l31.575"> </span>
<a href="#l31.576"></a><span id="l31.576" class="difflineminus">-function InitAppmenuViewBodyMenu()</span>
<a href="#l31.577"></a><span id="l31.577" class="difflineminus">-{</span>
<a href="#l31.578"></a><span id="l31.578" class="difflineplus">+function InitAppmenuViewBodyMenu() {</span>
<a href="#l31.579"></a><span id="l31.579">   let html_as = Services.prefs.getIntPref(&quot;mailnews.display.html_as&quot;);</span>
<a href="#l31.580"></a><span id="l31.580">   let prefer_plaintext = Services.prefs.getBoolPref(&quot;mailnews.display.prefer_plaintext&quot;);</span>
<a href="#l31.581"></a><span id="l31.581">   let disallow_classes = Services.prefs.getIntPref(&quot;mailnews.display.disallow_mime_handlers&quot;);</span>
<a href="#l31.582"></a><span id="l31.582">   let isFeed = gFolderDisplay.selectedMessageIsFeed;</span>
<a href="#l31.583"></a><span id="l31.583">   const kDefaultIDs = [&quot;appmenu_bodyAllowHTML&quot;,</span>
<a href="#l31.584"></a><span id="l31.584">                        &quot;appmenu_bodySanitized&quot;,</span>
<a href="#l31.585"></a><span id="l31.585">                        &quot;appmenu_bodyAsPlaintext&quot;,</span>
<a href="#l31.586"></a><span id="l31.586">                        &quot;appmenu_bodyAllParts&quot;];</span>
<a href="#l31.587"></a><span id="l31.587" class="difflineat">@@ -760,55 +733,51 @@ function InitAppmenuViewBodyMenu()</span>
<a href="#l31.588"></a><span id="l31.588">     AsPlaintext_menuitem.hidden = !gShowFeedSummary;</span>
<a href="#l31.589"></a><span id="l31.589">     document.getElementById(&quot;appmenu_viewFeedSummarySeparator&quot;).hidden = !gShowFeedSummary;</span>
<a href="#l31.590"></a><span id="l31.590">   }</span>
<a href="#l31.591"></a><span id="l31.591"> }</span>
<a href="#l31.592"></a><span id="l31.592"> </span>
<a href="#l31.593"></a><span id="l31.593"> /**</span>
<a href="#l31.594"></a><span id="l31.594">  * Expand or collapse the folder pane.</span>
<a href="#l31.595"></a><span id="l31.595">  */</span>
<a href="#l31.596"></a><span id="l31.596" class="difflineminus">-function MsgToggleFolderPane()</span>
<a href="#l31.597"></a><span id="l31.597" class="difflineminus">-{</span>
<a href="#l31.598"></a><span id="l31.598" class="difflineplus">+function MsgToggleFolderPane() {</span>
<a href="#l31.599"></a><span id="l31.599">   // Bail without doing anything if we are not a folder tab.</span>
<a href="#l31.600"></a><span id="l31.600">   let currentTabInfo = document.getElementById(&quot;tabmail&quot;).currentTabInfo;</span>
<a href="#l31.601"></a><span id="l31.601">   if (currentTabInfo.mode.name != &quot;folder&quot;)</span>
<a href="#l31.602"></a><span id="l31.602">     return;</span>
<a href="#l31.603"></a><span id="l31.603"> </span>
<a href="#l31.604"></a><span id="l31.604">   togglePaneSplitter(&quot;folderpane_splitter&quot;);</span>
<a href="#l31.605"></a><span id="l31.605"> }</span>
<a href="#l31.606"></a><span id="l31.606"> </span>
<a href="#l31.607"></a><span id="l31.607"> /**</span>
<a href="#l31.608"></a><span id="l31.608">  * Expand or collapse the message preview pane.</span>
<a href="#l31.609"></a><span id="l31.609">  */</span>
<a href="#l31.610"></a><span id="l31.610" class="difflineminus">-function MsgToggleMessagePane()</span>
<a href="#l31.611"></a><span id="l31.611" class="difflineminus">-{</span>
<a href="#l31.612"></a><span id="l31.612" class="difflineplus">+function MsgToggleMessagePane() {</span>
<a href="#l31.613"></a><span id="l31.613">   // Bail without doing anything if we are not a folder tab.</span>
<a href="#l31.614"></a><span id="l31.614">   let currentTabInfo = document.getElementById(&quot;tabmail&quot;).currentTabInfo;</span>
<a href="#l31.615"></a><span id="l31.615">   if (currentTabInfo.mode.name != &quot;folder&quot;)</span>
<a href="#l31.616"></a><span id="l31.616">     return;</span>
<a href="#l31.617"></a><span id="l31.617"> </span>
<a href="#l31.618"></a><span id="l31.618">   togglePaneSplitter(&quot;threadpane-splitter&quot;);</span>
<a href="#l31.619"></a><span id="l31.619">   ChangeMessagePaneVisibility(IsMessagePaneCollapsed());</span>
<a href="#l31.620"></a><span id="l31.620">   SetFocusThreadPaneIfNotOnMessagePane();</span>
<a href="#l31.621"></a><span id="l31.621"> }</span>
<a href="#l31.622"></a><span id="l31.622"> </span>
<a href="#l31.623"></a><span id="l31.623" class="difflineminus">-function SetMenuItemLabel(menuItemId, customLabel)</span>
<a href="#l31.624"></a><span id="l31.624" class="difflineminus">-{</span>
<a href="#l31.625"></a><span id="l31.625" class="difflineplus">+function SetMenuItemLabel(menuItemId, customLabel) {</span>
<a href="#l31.626"></a><span id="l31.626">   var menuItem = document.getElementById(menuItemId);</span>
<a href="#l31.627"></a><span id="l31.627">   if (menuItem)</span>
<a href="#l31.628"></a><span id="l31.628" class="difflineminus">-    menuItem.setAttribute('label', customLabel);</span>
<a href="#l31.629"></a><span id="l31.629" class="difflineplus">+    menuItem.setAttribute(&quot;label&quot;, customLabel);</span>
<a href="#l31.630"></a><span id="l31.630"> }</span>
<a href="#l31.631"></a><span id="l31.631"> </span>
<a href="#l31.632"></a><span id="l31.632"> /**</span>
<a href="#l31.633"></a><span id="l31.633">  * Update the tooltip of the &quot;Get messages&quot; button to indicate which accounts</span>
<a href="#l31.634"></a><span id="l31.634">  * (usernames) will be fetched if clicked.</span>
<a href="#l31.635"></a><span id="l31.635">  */</span>
<a href="#l31.636"></a><span id="l31.636"> </span>
<a href="#l31.637"></a><span id="l31.637" class="difflineminus">-function SetGetMsgButtonTooltip()</span>
<a href="#l31.638"></a><span id="l31.638" class="difflineminus">-{</span>
<a href="#l31.639"></a><span id="l31.639" class="difflineplus">+function SetGetMsgButtonTooltip() {</span>
<a href="#l31.640"></a><span id="l31.640">   var msgButton = document.getElementById(&quot;button-getmsg&quot;);</span>
<a href="#l31.641"></a><span id="l31.641">   // The button is not found in the document if isn't on the toolbar but available</span>
<a href="#l31.642"></a><span id="l31.642">   // in the Customize palette. In that case we do not need to update its tooltip.</span>
<a href="#l31.643"></a><span id="l31.643">   if (!msgButton)</span>
<a href="#l31.644"></a><span id="l31.644">     return;</span>
<a href="#l31.645"></a><span id="l31.645"> </span>
<a href="#l31.646"></a><span id="l31.646">   var selectedFolders = GetSelectedMsgFolders();</span>
<a href="#l31.647"></a><span id="l31.647">   var folders;</span>
<a href="#l31.648"></a><span id="l31.648" class="difflineat">@@ -822,48 +791,44 @@ function SetGetMsgButtonTooltip()</span>
<a href="#l31.649"></a><span id="l31.649"> </span>
<a href="#l31.650"></a><span id="l31.650">   // Push the usernames through a Set() to remove duplicates.</span>
<a href="#l31.651"></a><span id="l31.651">   var names = new Set(folders.map(v =&gt; v.server.prettyName));</span>
<a href="#l31.652"></a><span id="l31.652">   var tooltipNames = Array.from(names).join(listSeparator);</span>
<a href="#l31.653"></a><span id="l31.653">   msgButton.tooltipText = bundle.getFormattedString(&quot;getMsgButtonTooltip&quot;,</span>
<a href="#l31.654"></a><span id="l31.654">                                                     [ tooltipNames ]);</span>
<a href="#l31.655"></a><span id="l31.655"> }</span>
<a href="#l31.656"></a><span id="l31.656"> </span>
<a href="#l31.657"></a><span id="l31.657" class="difflineminus">-function RemoveAllMessageTags()</span>
<a href="#l31.658"></a><span id="l31.658" class="difflineminus">-{</span>
<a href="#l31.659"></a><span id="l31.659" class="difflineplus">+function RemoveAllMessageTags() {</span>
<a href="#l31.660"></a><span id="l31.660">   var selectedMessages = gFolderDisplay.selectedMessages;</span>
<a href="#l31.661"></a><span id="l31.661">   if (!selectedMessages.length)</span>
<a href="#l31.662"></a><span id="l31.662">     return;</span>
<a href="#l31.663"></a><span id="l31.663"> </span>
<a href="#l31.664"></a><span id="l31.664">   var messages = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l31.665"></a><span id="l31.665">                    .createInstance(Ci.nsIMutableArray);</span>
<a href="#l31.666"></a><span id="l31.666">   let tagArray = MailServices.tags.getAllTags({});</span>
<a href="#l31.667"></a><span id="l31.667"> </span>
<a href="#l31.668"></a><span id="l31.668">   var allKeys = &quot;&quot;;</span>
<a href="#l31.669"></a><span id="l31.669" class="difflineminus">-  for (var j = 0; j &lt; tagArray.length; ++j)</span>
<a href="#l31.670"></a><span id="l31.670" class="difflineminus">-  {</span>
<a href="#l31.671"></a><span id="l31.671" class="difflineplus">+  for (var j = 0; j &lt; tagArray.length; ++j) {</span>
<a href="#l31.672"></a><span id="l31.672">     if (j)</span>
<a href="#l31.673"></a><span id="l31.673">       allKeys += &quot; &quot;;</span>
<a href="#l31.674"></a><span id="l31.674">     allKeys += tagArray[j].key;</span>
<a href="#l31.675"></a><span id="l31.675">   }</span>
<a href="#l31.676"></a><span id="l31.676"> </span>
<a href="#l31.677"></a><span id="l31.677">   var prevHdrFolder = null;</span>
<a href="#l31.678"></a><span id="l31.678">   // this crudely handles cross-folder virtual folders with selected messages</span>
<a href="#l31.679"></a><span id="l31.679">   // that spans folders, by coalescing consecutive messages in the selection</span>
<a href="#l31.680"></a><span id="l31.680">   // that happen to be in the same folder. nsMsgSearchDBView does this better,</span>
<a href="#l31.681"></a><span id="l31.681">   // but nsIMsgDBView doesn't handle commands with arguments, and untag takes a</span>
<a href="#l31.682"></a><span id="l31.682">   // key argument. Furthermore, we only delete legacy labels and known tags,</span>
<a href="#l31.683"></a><span id="l31.683">   // keeping other keywords like (non)junk intact.</span>
<a href="#l31.684"></a><span id="l31.684"> </span>
<a href="#l31.685"></a><span id="l31.685" class="difflineminus">-  for (var i = 0; i &lt; selectedMessages.length; ++i)</span>
<a href="#l31.686"></a><span id="l31.686" class="difflineminus">-  {</span>
<a href="#l31.687"></a><span id="l31.687" class="difflineplus">+  for (var i = 0; i &lt; selectedMessages.length; ++i) {</span>
<a href="#l31.688"></a><span id="l31.688">     var msgHdr = selectedMessages[i];</span>
<a href="#l31.689"></a><span id="l31.689">     msgHdr.label = 0; // remove legacy label</span>
<a href="#l31.690"></a><span id="l31.690" class="difflineminus">-    if (prevHdrFolder != msgHdr.folder)</span>
<a href="#l31.691"></a><span id="l31.691" class="difflineminus">-    {</span>
<a href="#l31.692"></a><span id="l31.692" class="difflineplus">+    if (prevHdrFolder != msgHdr.folder) {</span>
<a href="#l31.693"></a><span id="l31.693">       if (prevHdrFolder)</span>
<a href="#l31.694"></a><span id="l31.694">         prevHdrFolder.removeKeywordsFromMessages(messages, allKeys);</span>
<a href="#l31.695"></a><span id="l31.695">       messages.clear();</span>
<a href="#l31.696"></a><span id="l31.696">       prevHdrFolder = msgHdr.folder;</span>
<a href="#l31.697"></a><span id="l31.697">     }</span>
<a href="#l31.698"></a><span id="l31.698">     messages.appendElement(msgHdr);</span>
<a href="#l31.699"></a><span id="l31.699">   }</span>
<a href="#l31.700"></a><span id="l31.700">   if (prevHdrFolder)</span>
<a href="#l31.701"></a><span id="l31.701" class="difflineat">@@ -872,18 +837,17 @@ function RemoveAllMessageTags()</span>
<a href="#l31.702"></a><span id="l31.702"> }</span>
<a href="#l31.703"></a><span id="l31.703"> </span>
<a href="#l31.704"></a><span id="l31.704"> /**</span>
<a href="#l31.705"></a><span id="l31.705">  * Toggle the state of a message tag on the selected messages (based on the</span>
<a href="#l31.706"></a><span id="l31.706">  * state of the first selected message, like for starring).</span>
<a href="#l31.707"></a><span id="l31.707">  *</span>
<a href="#l31.708"></a><span id="l31.708">  * @param keyNumber the number (1 through 9) associated with the tag</span>
<a href="#l31.709"></a><span id="l31.709">  */</span>
<a href="#l31.710"></a><span id="l31.710" class="difflineminus">-function ToggleMessageTagKey(keyNumber)</span>
<a href="#l31.711"></a><span id="l31.711" class="difflineminus">-{</span>
<a href="#l31.712"></a><span id="l31.712" class="difflineplus">+function ToggleMessageTagKey(keyNumber) {</span>
<a href="#l31.713"></a><span id="l31.713">   let msgHdr = gFolderDisplay.selectedMessage;</span>
<a href="#l31.714"></a><span id="l31.714">   if (!msgHdr)</span>
<a href="#l31.715"></a><span id="l31.715">     return;</span>
<a href="#l31.716"></a><span id="l31.716"> </span>
<a href="#l31.717"></a><span id="l31.717">   let tagArray = MailServices.tags.getAllTags({});</span>
<a href="#l31.718"></a><span id="l31.718">   if (keyNumber &gt; tagArray.length)</span>
<a href="#l31.719"></a><span id="l31.719">     return;</span>
<a href="#l31.720"></a><span id="l31.720"> </span>
<a href="#l31.721"></a><span id="l31.721" class="difflineat">@@ -891,110 +855,97 @@ function ToggleMessageTagKey(keyNumber)</span>
<a href="#l31.722"></a><span id="l31.722">   let curKeys = msgHdr.getStringProperty(&quot;keywords&quot;).split(&quot; &quot;);</span>
<a href="#l31.723"></a><span id="l31.723">   if (msgHdr.label)</span>
<a href="#l31.724"></a><span id="l31.724">     curKeys.push(&quot;$label&quot; + msgHdr.label);</span>
<a href="#l31.725"></a><span id="l31.725">   let addKey = !curKeys.includes(key);</span>
<a href="#l31.726"></a><span id="l31.726"> </span>
<a href="#l31.727"></a><span id="l31.727">   ToggleMessageTag(key, addKey);</span>
<a href="#l31.728"></a><span id="l31.728"> }</span>
<a href="#l31.729"></a><span id="l31.729"> </span>
<a href="#l31.730"></a><span id="l31.730" class="difflineminus">-function ToggleMessageTagMenu(target)</span>
<a href="#l31.731"></a><span id="l31.731" class="difflineminus">-{</span>
<a href="#l31.732"></a><span id="l31.732" class="difflineplus">+function ToggleMessageTagMenu(target) {</span>
<a href="#l31.733"></a><span id="l31.733">   var key    = target.getAttribute(&quot;value&quot;);</span>
<a href="#l31.734"></a><span id="l31.734">   var addKey = target.getAttribute(&quot;checked&quot;) == &quot;true&quot;;</span>
<a href="#l31.735"></a><span id="l31.735">   ToggleMessageTag(key, addKey);</span>
<a href="#l31.736"></a><span id="l31.736"> }</span>
<a href="#l31.737"></a><span id="l31.737"> </span>
<a href="#l31.738"></a><span id="l31.738" class="difflineminus">-function ToggleMessageTag(key, addKey)</span>
<a href="#l31.739"></a><span id="l31.739" class="difflineminus">-{</span>
<a href="#l31.740"></a><span id="l31.740" class="difflineplus">+function ToggleMessageTag(key, addKey) {</span>
<a href="#l31.741"></a><span id="l31.741">   var messages = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l31.742"></a><span id="l31.742">                    .createInstance(Ci.nsIMutableArray);</span>
<a href="#l31.743"></a><span id="l31.743">   var msg = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l31.744"></a><span id="l31.744">               .createInstance(Ci.nsIMutableArray);</span>
<a href="#l31.745"></a><span id="l31.745">   var selectedMessages = gFolderDisplay.selectedMessages;</span>
<a href="#l31.746"></a><span id="l31.746">   var toggler = addKey ? &quot;addKeywordsToMessages&quot; : &quot;removeKeywordsFromMessages&quot;;</span>
<a href="#l31.747"></a><span id="l31.747">   var prevHdrFolder = null;</span>
<a href="#l31.748"></a><span id="l31.748">   // this crudely handles cross-folder virtual folders with selected messages</span>
<a href="#l31.749"></a><span id="l31.749">   // that spans folders, by coalescing consecutive msgs in the selection</span>
<a href="#l31.750"></a><span id="l31.750">   // that happen to be in the same folder. nsMsgSearchDBView does this</span>
<a href="#l31.751"></a><span id="l31.751">   // better, but nsIMsgDBView doesn't handle commands with arguments,</span>
<a href="#l31.752"></a><span id="l31.752">   // and (un)tag takes a key argument.</span>
<a href="#l31.753"></a><span id="l31.753" class="difflineminus">-  for (var i = 0; i &lt; selectedMessages.length; ++i)</span>
<a href="#l31.754"></a><span id="l31.754" class="difflineminus">-  {</span>
<a href="#l31.755"></a><span id="l31.755" class="difflineplus">+  for (var i = 0; i &lt; selectedMessages.length; ++i) {</span>
<a href="#l31.756"></a><span id="l31.756">     var msgHdr = selectedMessages[i];</span>
<a href="#l31.757"></a><span id="l31.757" class="difflineminus">-    if (msgHdr.label)</span>
<a href="#l31.758"></a><span id="l31.758" class="difflineminus">-    {</span>
<a href="#l31.759"></a><span id="l31.759" class="difflineplus">+    if (msgHdr.label) {</span>
<a href="#l31.760"></a><span id="l31.760">       // Since we touch all these messages anyway, migrate the label now.</span>
<a href="#l31.761"></a><span id="l31.761">       // If we don't, the thread tree won't always show the correct tag state,</span>
<a href="#l31.762"></a><span id="l31.762">       // because resetting a label doesn't update the tree anymore...</span>
<a href="#l31.763"></a><span id="l31.763">       msg.clear();</span>
<a href="#l31.764"></a><span id="l31.764">       msg.appendElement(msgHdr);</span>
<a href="#l31.765"></a><span id="l31.765">       msgHdr.folder.addKeywordsToMessages(msg, &quot;$label&quot; + msgHdr.label);</span>
<a href="#l31.766"></a><span id="l31.766">       msgHdr.label = 0; // remove legacy label</span>
<a href="#l31.767"></a><span id="l31.767">     }</span>
<a href="#l31.768"></a><span id="l31.768" class="difflineminus">-    if (prevHdrFolder != msgHdr.folder)</span>
<a href="#l31.769"></a><span id="l31.769" class="difflineminus">-    {</span>
<a href="#l31.770"></a><span id="l31.770" class="difflineplus">+    if (prevHdrFolder != msgHdr.folder) {</span>
<a href="#l31.771"></a><span id="l31.771">       if (prevHdrFolder)</span>
<a href="#l31.772"></a><span id="l31.772">         prevHdrFolder[toggler](messages, key);</span>
<a href="#l31.773"></a><span id="l31.773">       messages.clear();</span>
<a href="#l31.774"></a><span id="l31.774">       prevHdrFolder = msgHdr.folder;</span>
<a href="#l31.775"></a><span id="l31.775">     }</span>
<a href="#l31.776"></a><span id="l31.776">     messages.appendElement(msgHdr);</span>
<a href="#l31.777"></a><span id="l31.777">   }</span>
<a href="#l31.778"></a><span id="l31.778">   if (prevHdrFolder)</span>
<a href="#l31.779"></a><span id="l31.779">     prevHdrFolder[toggler](messages, key);</span>
<a href="#l31.780"></a><span id="l31.780">   OnTagsChange();</span>
<a href="#l31.781"></a><span id="l31.781"> }</span>
<a href="#l31.782"></a><span id="l31.782"> </span>
<a href="#l31.783"></a><span id="l31.783" class="difflineminus">-function AddTag()</span>
<a href="#l31.784"></a><span id="l31.784" class="difflineminus">-{</span>
<a href="#l31.785"></a><span id="l31.785" class="difflineplus">+function AddTag() {</span>
<a href="#l31.786"></a><span id="l31.786">   var args = {result: &quot;&quot;, okCallback: AddTagCallback};</span>
<a href="#l31.787"></a><span id="l31.787" class="difflineminus">-  var dialog = window.openDialog(&quot;chrome://messenger/content/newTagDialog.xul&quot;,</span>
<a href="#l31.788"></a><span id="l31.788" class="difflineminus">-                                 &quot;&quot;,</span>
<a href="#l31.789"></a><span id="l31.789" class="difflineminus">-                                 &quot;chrome,titlebar,modal&quot;,</span>
<a href="#l31.790"></a><span id="l31.790" class="difflineminus">-                                 args);</span>
<a href="#l31.791"></a><span id="l31.791" class="difflineplus">+  window.openDialog(&quot;chrome://messenger/content/newTagDialog.xul&quot;,</span>
<a href="#l31.792"></a><span id="l31.792" class="difflineplus">+                    &quot;&quot;,</span>
<a href="#l31.793"></a><span id="l31.793" class="difflineplus">+                    &quot;chrome,titlebar,modal&quot;,</span>
<a href="#l31.794"></a><span id="l31.794" class="difflineplus">+                    args);</span>
<a href="#l31.795"></a><span id="l31.795"> }</span>
<a href="#l31.796"></a><span id="l31.796"> </span>
<a href="#l31.797"></a><span id="l31.797" class="difflineminus">-function ManageTags()</span>
<a href="#l31.798"></a><span id="l31.798" class="difflineminus">-{</span>
<a href="#l31.799"></a><span id="l31.799" class="difflineplus">+function ManageTags() {</span>
<a href="#l31.800"></a><span id="l31.800">   openOptionsDialog(&quot;paneDisplay&quot;, &quot;tagTab&quot;);</span>
<a href="#l31.801"></a><span id="l31.801"> }</span>
<a href="#l31.802"></a><span id="l31.802"> </span>
<a href="#l31.803"></a><span id="l31.803" class="difflineminus">-function AddTagCallback(name, color)</span>
<a href="#l31.804"></a><span id="l31.804" class="difflineminus">-{</span>
<a href="#l31.805"></a><span id="l31.805" class="difflineminus">-  MailServices.tags.addTag(name, color, '');</span>
<a href="#l31.806"></a><span id="l31.806" class="difflineminus">-  try</span>
<a href="#l31.807"></a><span id="l31.807" class="difflineminus">-  {</span>
<a href="#l31.808"></a><span id="l31.808" class="difflineplus">+function AddTagCallback(name, color) {</span>
<a href="#l31.809"></a><span id="l31.809" class="difflineplus">+  MailServices.tags.addTag(name, color, &quot;&quot;);</span>
<a href="#l31.810"></a><span id="l31.810" class="difflineplus">+  try {</span>
<a href="#l31.811"></a><span id="l31.811">     ToggleMessageTag(MailServices.tags.getKeyForTag(name), true);</span>
<a href="#l31.812"></a><span id="l31.812" class="difflineminus">-  }</span>
<a href="#l31.813"></a><span id="l31.813" class="difflineminus">-  catch(ex)</span>
<a href="#l31.814"></a><span id="l31.814" class="difflineminus">-  {</span>
<a href="#l31.815"></a><span id="l31.815" class="difflineplus">+  } catch (ex) {</span>
<a href="#l31.816"></a><span id="l31.816">     return false;</span>
<a href="#l31.817"></a><span id="l31.817">   }</span>
<a href="#l31.818"></a><span id="l31.818">   return true;</span>
<a href="#l31.819"></a><span id="l31.819"> }</span>
<a href="#l31.820"></a><span id="l31.820"> </span>
<a href="#l31.821"></a><span id="l31.821" class="difflineminus">-function SetMessageTagLabel(menuitem, index, name)</span>
<a href="#l31.822"></a><span id="l31.822" class="difflineminus">-{</span>
<a href="#l31.823"></a><span id="l31.823" class="difflineplus">+function SetMessageTagLabel(menuitem, index, name) {</span>
<a href="#l31.824"></a><span id="l31.824">   // if a &lt;key&gt; is defined for this tag, use its key as the accesskey</span>
<a href="#l31.825"></a><span id="l31.825">   // (the key for the tag at index n needs to have the id key_tag&lt;n&gt;)</span>
<a href="#l31.826"></a><span id="l31.826">   let shortcutkey = document.getElementById(&quot;key_tag&quot; + index);</span>
<a href="#l31.827"></a><span id="l31.827">   let accesskey = shortcutkey ? shortcutkey.getAttribute(&quot;key&quot;) : &quot;  &quot;;</span>
<a href="#l31.828"></a><span id="l31.828">   if (accesskey != &quot;  &quot;) {</span>
<a href="#l31.829"></a><span id="l31.829">     menuitem.setAttribute(&quot;accesskey&quot;, accesskey);</span>
<a href="#l31.830"></a><span id="l31.830">     menuitem.setAttribute(&quot;acceltext&quot;, accesskey);</span>
<a href="#l31.831"></a><span id="l31.831">   }</span>
<a href="#l31.832"></a><span id="l31.832">   let label = document.getElementById(&quot;bundle_messenger&quot;)</span>
<a href="#l31.833"></a><span id="l31.833">                       .getFormattedString(&quot;mailnews.tags.format&quot;,</span>
<a href="#l31.834"></a><span id="l31.834">                                           [accesskey, name]);</span>
<a href="#l31.835"></a><span id="l31.835">   menuitem.setAttribute(&quot;label&quot;, label);</span>
<a href="#l31.836"></a><span id="l31.836"> }</span>
<a href="#l31.837"></a><span id="l31.837"> </span>
<a href="#l31.838"></a><span id="l31.838" class="difflineminus">-function InitMessageTags(menuPopup)</span>
<a href="#l31.839"></a><span id="l31.839" class="difflineminus">-{</span>
<a href="#l31.840"></a><span id="l31.840" class="difflineplus">+function InitMessageTags(menuPopup) {</span>
<a href="#l31.841"></a><span id="l31.841">   let tagArray = MailServices.tags.getAllTags({});</span>
<a href="#l31.842"></a><span id="l31.842">   var tagCount = tagArray.length;</span>
<a href="#l31.843"></a><span id="l31.843"> </span>
<a href="#l31.844"></a><span id="l31.844">   // Remove any existing non-static entries... (clear tags list before rebuilding it)</span>
<a href="#l31.845"></a><span id="l31.845">   // &quot;5&quot; is the number of menu items (including separators) on the top of the menu</span>
<a href="#l31.846"></a><span id="l31.846">   // that should not be cleared.</span>
<a href="#l31.847"></a><span id="l31.847">   for (let i = menuPopup.childNodes.length; i &gt; 5; --i)</span>
<a href="#l31.848"></a><span id="l31.848">     menuPopup.lastChild.remove();</span>
<a href="#l31.849"></a><span id="l31.849" class="difflineat">@@ -1005,131 +956,121 @@ function InitMessageTags(menuPopup)</span>
<a href="#l31.850"></a><span id="l31.850">   SetMessageTagLabel(menuPopup.lastChild.previousSibling, 0, tagRemoveLabel);</span>
<a href="#l31.851"></a><span id="l31.851"> </span>
<a href="#l31.852"></a><span id="l31.852">   // now rebuild the list</span>
<a href="#l31.853"></a><span id="l31.853">   var msgHdr = gFolderDisplay.selectedMessage;</span>
<a href="#l31.854"></a><span id="l31.854">   var curKeys = msgHdr.getStringProperty(&quot;keywords&quot;);</span>
<a href="#l31.855"></a><span id="l31.855">   if (msgHdr.label)</span>
<a href="#l31.856"></a><span id="l31.856">     curKeys += &quot; $label&quot; + msgHdr.label;</span>
<a href="#l31.857"></a><span id="l31.857"> </span>
<a href="#l31.858"></a><span id="l31.858" class="difflineminus">-  for (var i = 0; i &lt; tagCount; ++i)</span>
<a href="#l31.859"></a><span id="l31.859" class="difflineminus">-  {</span>
<a href="#l31.860"></a><span id="l31.860" class="difflineplus">+  for (var i = 0; i &lt; tagCount; ++i) {</span>
<a href="#l31.861"></a><span id="l31.861">     var taginfo = tagArray[i];</span>
<a href="#l31.862"></a><span id="l31.862">     let removeKey = (&quot; &quot; + curKeys + &quot; &quot;).includes(&quot; &quot; + taginfo.key + &quot; &quot;);</span>
<a href="#l31.863"></a><span id="l31.863">     if (taginfo.ordinal.includes(&quot;~AUTOTAG&quot;) &amp;&amp; !removeKey)</span>
<a href="#l31.864"></a><span id="l31.864">       continue;</span>
<a href="#l31.865"></a><span id="l31.865"> </span>
<a href="#l31.866"></a><span id="l31.866">     // TODO we want to either remove or &quot;check&quot; the tags that already exist</span>
<a href="#l31.867"></a><span id="l31.867">     var newMenuItem = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l31.868"></a><span id="l31.868">     SetMessageTagLabel(newMenuItem, i + 1, taginfo.tag);</span>
<a href="#l31.869"></a><span id="l31.869">     newMenuItem.setAttribute(&quot;value&quot;, taginfo.key);</span>
<a href="#l31.870"></a><span id="l31.870">     newMenuItem.setAttribute(&quot;type&quot;, &quot;checkbox&quot;);</span>
<a href="#l31.871"></a><span id="l31.871" class="difflineminus">-    newMenuItem.setAttribute('checked', removeKey);</span>
<a href="#l31.872"></a><span id="l31.872" class="difflineminus">-    newMenuItem.setAttribute('oncommand', 'ToggleMessageTagMenu(event.target);');</span>
<a href="#l31.873"></a><span id="l31.873" class="difflineplus">+    newMenuItem.setAttribute(&quot;checked&quot;, removeKey);</span>
<a href="#l31.874"></a><span id="l31.874" class="difflineplus">+    newMenuItem.setAttribute(&quot;oncommand&quot;, &quot;ToggleMessageTagMenu(event.target);&quot;);</span>
<a href="#l31.875"></a><span id="l31.875">     var color = taginfo.color;</span>
<a href="#l31.876"></a><span id="l31.876">     if (color)</span>
<a href="#l31.877"></a><span id="l31.877">       newMenuItem.setAttribute(&quot;class&quot;, &quot;lc-&quot; + color.substr(1));</span>
<a href="#l31.878"></a><span id="l31.878">     menuPopup.appendChild(newMenuItem);</span>
<a href="#l31.879"></a><span id="l31.879">   }</span>
<a href="#l31.880"></a><span id="l31.880"> }</span>
<a href="#l31.881"></a><span id="l31.881"> </span>
<a href="#l31.882"></a><span id="l31.882" class="difflineminus">-function InitRecentlyClosedTabsPopup(menuPopup)</span>
<a href="#l31.883"></a><span id="l31.883" class="difflineminus">-{</span>
<a href="#l31.884"></a><span id="l31.884" class="difflineplus">+function InitRecentlyClosedTabsPopup(menuPopup) {</span>
<a href="#l31.885"></a><span id="l31.885">   let tabs = document.getElementById(&quot;tabmail&quot;).recentlyClosedTabs;</span>
<a href="#l31.886"></a><span id="l31.886"> </span>
<a href="#l31.887"></a><span id="l31.887">   // show Popup only when there are restorable tabs.</span>
<a href="#l31.888"></a><span id="l31.888" class="difflineminus">-  if( !tabs.length )</span>
<a href="#l31.889"></a><span id="l31.889" class="difflineplus">+  if (!tabs.length)</span>
<a href="#l31.890"></a><span id="l31.890">     return false;</span>
<a href="#l31.891"></a><span id="l31.891"> </span>
<a href="#l31.892"></a><span id="l31.892">   // Clear the list before rebulding it.</span>
<a href="#l31.893"></a><span id="l31.893">   while (menuPopup.hasChildNodes())</span>
<a href="#l31.894"></a><span id="l31.894">     menuPopup.lastChild.remove();</span>
<a href="#l31.895"></a><span id="l31.895"> </span>
<a href="#l31.896"></a><span id="l31.896">   // Rebuild the recently closed tab list</span>
<a href="#l31.897"></a><span id="l31.897" class="difflineminus">-  for (let i = 0; i &lt; tabs.length; i++ ) {</span>
<a href="#l31.898"></a><span id="l31.898" class="difflineplus">+  for (let i = 0; i &lt; tabs.length; i++) {</span>
<a href="#l31.899"></a><span id="l31.899"> </span>
<a href="#l31.900"></a><span id="l31.900">     let menuItem = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l31.901"></a><span id="l31.901" class="difflineminus">-    menuItem.setAttribute(&quot;label&quot;,tabs[i].title);</span>
<a href="#l31.902"></a><span id="l31.902" class="difflineminus">-    menuItem.setAttribute('oncommand',</span>
<a href="#l31.903"></a><span id="l31.903" class="difflineminus">-        'document.getElementById(&quot;tabmail&quot;).undoCloseTab('+i+');');</span>
<a href="#l31.904"></a><span id="l31.904" class="difflineminus">-</span>
<a href="#l31.905"></a><span id="l31.905" class="difflineminus">-    if (i==0)</span>
<a href="#l31.906"></a><span id="l31.906" class="difflineminus">-      menuItem.setAttribute('key',&quot;key_undoCloseTab&quot;);</span>
<a href="#l31.907"></a><span id="l31.907" class="difflineplus">+    menuItem.setAttribute(&quot;label&quot;, tabs[i].title);</span>
<a href="#l31.908"></a><span id="l31.908" class="difflineplus">+    menuItem.setAttribute(&quot;oncommand&quot;, `document.getElementById(&quot;tabmail&quot;).undoCloseTab(${i});`);</span>
<a href="#l31.909"></a><span id="l31.909" class="difflineplus">+</span>
<a href="#l31.910"></a><span id="l31.910" class="difflineplus">+    if (i == 0)</span>
<a href="#l31.911"></a><span id="l31.911" class="difflineplus">+      menuItem.setAttribute(&quot;key&quot;, &quot;key_undoCloseTab&quot;);</span>
<a href="#l31.912"></a><span id="l31.912"> </span>
<a href="#l31.913"></a><span id="l31.913">     menuPopup.appendChild(menuItem);</span>
<a href="#l31.914"></a><span id="l31.914">   }</span>
<a href="#l31.915"></a><span id="l31.915"> </span>
<a href="#l31.916"></a><span id="l31.916">   // &quot;Restore All Tabs&quot; with only one entry does not make sense</span>
<a href="#l31.917"></a><span id="l31.917">   if (tabs.length &gt; 1) {</span>
<a href="#l31.918"></a><span id="l31.918">     menuPopup.appendChild(document.createElement(&quot;menuseparator&quot;));</span>
<a href="#l31.919"></a><span id="l31.919"> </span>
<a href="#l31.920"></a><span id="l31.920">     let menuItem = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l31.921"></a><span id="l31.921">     menuItem.setAttribute(&quot;label&quot;, document.getElementById(&quot;bundle_messenger&quot;)</span>
<a href="#l31.922"></a><span id="l31.922">                                            .getString(&quot;restoreAllTabs&quot;));</span>
<a href="#l31.923"></a><span id="l31.923" class="difflineminus">-    menuItem.setAttribute(&quot;oncommand&quot;,&quot;goRestoreAllTabs();&quot;);</span>
<a href="#l31.924"></a><span id="l31.924" class="difflineplus">+    menuItem.setAttribute(&quot;oncommand&quot;, &quot;goRestoreAllTabs();&quot;);</span>
<a href="#l31.925"></a><span id="l31.925">     menuPopup.appendChild(menuItem);</span>
<a href="#l31.926"></a><span id="l31.926">   }</span>
<a href="#l31.927"></a><span id="l31.927"> </span>
<a href="#l31.928"></a><span id="l31.928">   return true;</span>
<a href="#l31.929"></a><span id="l31.929"> }</span>
<a href="#l31.930"></a><span id="l31.930"> </span>
<a href="#l31.931"></a><span id="l31.931" class="difflineminus">-function goRestoreAllTabs()</span>
<a href="#l31.932"></a><span id="l31.932" class="difflineminus">-{</span>
<a href="#l31.933"></a><span id="l31.933" class="difflineplus">+function goRestoreAllTabs() {</span>
<a href="#l31.934"></a><span id="l31.934">   let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l31.935"></a><span id="l31.935"> </span>
<a href="#l31.936"></a><span id="l31.936">   let len = tabmail.recentlyClosedTabs.length;</span>
<a href="#l31.937"></a><span id="l31.937"> </span>
<a href="#l31.938"></a><span id="l31.938" class="difflineminus">-  while(len--)</span>
<a href="#l31.939"></a><span id="l31.939" class="difflineplus">+  while (len--)</span>
<a href="#l31.940"></a><span id="l31.940">     document.getElementById(&quot;tabmail&quot;).undoCloseTab();</span>
<a href="#l31.941"></a><span id="l31.941"> }</span>
<a href="#l31.942"></a><span id="l31.942"> </span>
<a href="#l31.943"></a><span id="l31.943" class="difflineminus">-function backToolbarMenu_init(menuPopup)</span>
<a href="#l31.944"></a><span id="l31.944" class="difflineminus">-{</span>
<a href="#l31.945"></a><span id="l31.945" class="difflineplus">+function backToolbarMenu_init(menuPopup) {</span>
<a href="#l31.946"></a><span id="l31.946">   populateHistoryMenu(menuPopup, true);</span>
<a href="#l31.947"></a><span id="l31.947"> }</span>
<a href="#l31.948"></a><span id="l31.948"> </span>
<a href="#l31.949"></a><span id="l31.949" class="difflineminus">-function getMsgToolbarMenu_init()</span>
<a href="#l31.950"></a><span id="l31.950" class="difflineminus">-{</span>
<a href="#l31.951"></a><span id="l31.951" class="difflineminus">-  document.commandDispatcher.updateCommands('create-menu-getMsgToolbar');</span>
<a href="#l31.952"></a><span id="l31.952" class="difflineplus">+function getMsgToolbarMenu_init() {</span>
<a href="#l31.953"></a><span id="l31.953" class="difflineplus">+  document.commandDispatcher.updateCommands(&quot;create-menu-getMsgToolbar&quot;);</span>
<a href="#l31.954"></a><span id="l31.954"> }</span>
<a href="#l31.955"></a><span id="l31.955"> </span>
<a href="#l31.956"></a><span id="l31.956"> var gNavDebug = false;</span>
<a href="#l31.957"></a><span id="l31.957" class="difflineminus">-function navDebug(str)</span>
<a href="#l31.958"></a><span id="l31.958" class="difflineminus">-{</span>
<a href="#l31.959"></a><span id="l31.959" class="difflineplus">+function navDebug(str) {</span>
<a href="#l31.960"></a><span id="l31.960">   if (gNavDebug)</span>
<a href="#l31.961"></a><span id="l31.961">     dump(str);</span>
<a href="#l31.962"></a><span id="l31.962"> }</span>
<a href="#l31.963"></a><span id="l31.963"> </span>
<a href="#l31.964"></a><span id="l31.964" class="difflineminus">-function populateHistoryMenu(menuPopup, isBackMenu)</span>
<a href="#l31.965"></a><span id="l31.965" class="difflineminus">-{</span>
<a href="#l31.966"></a><span id="l31.966" class="difflineplus">+function populateHistoryMenu(menuPopup, isBackMenu) {</span>
<a href="#l31.967"></a><span id="l31.967">   // remove existing entries</span>
<a href="#l31.968"></a><span id="l31.968">   while (menuPopup.hasChildNodes())</span>
<a href="#l31.969"></a><span id="l31.969">     menuPopup.lastChild.remove();</span>
<a href="#l31.970"></a><span id="l31.970" class="difflineminus">-  var curPos = new Object;</span>
<a href="#l31.971"></a><span id="l31.971" class="difflineminus">-  var numEntries = new Object;</span>
<a href="#l31.972"></a><span id="l31.972" class="difflineminus">-  var historyEntries = new Object;</span>
<a href="#l31.973"></a><span id="l31.973" class="difflineplus">+  var curPos = {};</span>
<a href="#l31.974"></a><span id="l31.974" class="difflineplus">+  var numEntries = {};</span>
<a href="#l31.975"></a><span id="l31.975" class="difflineplus">+  var historyEntries = {};</span>
<a href="#l31.976"></a><span id="l31.976">   messenger.getNavigateHistory(curPos, numEntries, historyEntries);</span>
<a href="#l31.977"></a><span id="l31.977">   curPos.value = curPos.value * 2;</span>
<a href="#l31.978"></a><span id="l31.978">   navDebug(&quot;curPos = &quot; + curPos.value + &quot; numEntries = &quot; + numEntries.value + &quot;\n&quot;);</span>
<a href="#l31.979"></a><span id="l31.979">   var historyArray = historyEntries.value;</span>
<a href="#l31.980"></a><span id="l31.980">   var folder;</span>
<a href="#l31.981"></a><span id="l31.981">   var newMenuItem;</span>
<a href="#l31.982"></a><span id="l31.982" class="difflineminus">-  if (gFolderDisplay.selectedMessage)</span>
<a href="#l31.983"></a><span id="l31.983" class="difflineminus">-  {</span>
<a href="#l31.984"></a><span id="l31.984" class="difflineplus">+  if (gFolderDisplay.selectedMessage) {</span>
<a href="#l31.985"></a><span id="l31.985">     if (!isBackMenu)</span>
<a href="#l31.986"></a><span id="l31.986">       curPos.value += 2;</span>
<a href="#l31.987"></a><span id="l31.987">     else</span>
<a href="#l31.988"></a><span id="l31.988">       curPos.value -= 2;</span>
<a href="#l31.989"></a><span id="l31.989">   }</span>
<a href="#l31.990"></a><span id="l31.990">   // For populating the back menu, we want the most recently visited</span>
<a href="#l31.991"></a><span id="l31.991">   // messages first in the menu. So we go backward from curPos to 0.</span>
<a href="#l31.992"></a><span id="l31.992">   // For the forward menu, we want to go forward from curPos to the end.</span>
<a href="#l31.993"></a><span id="l31.993">   var relPos = 0;</span>
<a href="#l31.994"></a><span id="l31.994" class="difflineminus">-  for (var i = curPos.value; (isBackMenu) ? i &gt;= 0 : i &lt; historyArray.length; i += ((isBackMenu) ? -2 : 2))</span>
<a href="#l31.995"></a><span id="l31.995" class="difflineminus">-  {</span>
<a href="#l31.996"></a><span id="l31.996" class="difflineplus">+  for (var i = curPos.value; (isBackMenu) ? i &gt;= 0 : i &lt; historyArray.length; i += ((isBackMenu) ? -2 : 2)) {</span>
<a href="#l31.997"></a><span id="l31.997">     navDebug(&quot;history[&quot; + i + &quot;] = &quot; + historyArray[i] + &quot;\n&quot;);</span>
<a href="#l31.998"></a><span id="l31.998">     navDebug(&quot;history[&quot; + i + &quot;] = &quot; + historyArray[i + 1] + &quot;\n&quot;);</span>
<a href="#l31.999"></a><span id="l31.999">     folder = MailUtils.getFolderForURI(historyArray[i + 1]);</span>
<a href="#l31.1000"></a><span id="l31.1000">     navDebug(&quot;folder URI = &quot; + folder.URI + &quot;pretty name &quot; + folder.prettyName + &quot;\n&quot;);</span>
<a href="#l31.1001"></a><span id="l31.1001">     var menuText = &quot;&quot;;</span>
<a href="#l31.1002"></a><span id="l31.1002"> </span>
<a href="#l31.1003"></a><span id="l31.1003">     // If the message was not being displayed via the current folder, prepend</span>
<a href="#l31.1004"></a><span id="l31.1004">     //  the folder name.  We do not need to check underlying folders for</span>
<a href="#l31.1005"></a><span id="l31.1005" class="difflineat">@@ -1144,35 +1085,34 @@ function populateHistoryMenu(menuPopup, </span>
<a href="#l31.1006"></a><span id="l31.1006">     if (msgHdr.flags &amp; Ci.nsMsgMessageFlags.HasRe)</span>
<a href="#l31.1007"></a><span id="l31.1007">       subject = &quot;Re: &quot;;</span>
<a href="#l31.1008"></a><span id="l31.1008">     if (msgHdr.mime2DecodedSubject)</span>
<a href="#l31.1009"></a><span id="l31.1009">       subject += msgHdr.mime2DecodedSubject;</span>
<a href="#l31.1010"></a><span id="l31.1010">     if (subject)</span>
<a href="#l31.1011"></a><span id="l31.1011">       menuText += subject + &quot; - &quot;;</span>
<a href="#l31.1012"></a><span id="l31.1012"> </span>
<a href="#l31.1013"></a><span id="l31.1013">     menuText += msgHdr.mime2DecodedAuthor;</span>
<a href="#l31.1014"></a><span id="l31.1014" class="difflineminus">-    newMenuItem = document.createElement('menuitem');</span>
<a href="#l31.1015"></a><span id="l31.1015" class="difflineminus">-    newMenuItem.setAttribute('label', menuText);</span>
<a href="#l31.1016"></a><span id="l31.1016" class="difflineplus">+    newMenuItem = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l31.1017"></a><span id="l31.1017" class="difflineplus">+    newMenuItem.setAttribute(&quot;label&quot;, menuText);</span>
<a href="#l31.1018"></a><span id="l31.1018">     relPos += isBackMenu ? -1 : 1;</span>
<a href="#l31.1019"></a><span id="l31.1019" class="difflineminus">-    newMenuItem.setAttribute('value',  relPos);</span>
<a href="#l31.1020"></a><span id="l31.1020" class="difflineplus">+    newMenuItem.setAttribute(&quot;value&quot;, relPos);</span>
<a href="#l31.1021"></a><span id="l31.1021">     newMenuItem.folder = folder;</span>
<a href="#l31.1022"></a><span id="l31.1022" class="difflineminus">-    newMenuItem.setAttribute('oncommand', 'NavigateToUri(event.target); event.stopPropagation();');</span>
<a href="#l31.1023"></a><span id="l31.1023" class="difflineplus">+    newMenuItem.setAttribute(&quot;oncommand&quot;, &quot;NavigateToUri(event.target); event.stopPropagation();&quot;);</span>
<a href="#l31.1024"></a><span id="l31.1024">     menuPopup.appendChild(newMenuItem);</span>
<a href="#l31.1025"></a><span id="l31.1025" class="difflineminus">-    if (! (relPos % 20))</span>
<a href="#l31.1026"></a><span id="l31.1026" class="difflineplus">+    if (!(relPos % 20))</span>
<a href="#l31.1027"></a><span id="l31.1027">       break;</span>
<a href="#l31.1028"></a><span id="l31.1028">   }</span>
<a href="#l31.1029"></a><span id="l31.1029"> }</span>
<a href="#l31.1030"></a><span id="l31.1030"> </span>
<a href="#l31.1031"></a><span id="l31.1031"> /**</span>
<a href="#l31.1032"></a><span id="l31.1032">  * This is triggered by the history navigation menu options, as created by</span>
<a href="#l31.1033"></a><span id="l31.1033">  *  populateHistoryMenu above.</span>
<a href="#l31.1034"></a><span id="l31.1034">  */</span>
<a href="#l31.1035"></a><span id="l31.1035" class="difflineminus">-function NavigateToUri(target)</span>
<a href="#l31.1036"></a><span id="l31.1036" class="difflineminus">-{</span>
<a href="#l31.1037"></a><span id="l31.1037" class="difflineminus">-  var historyIndex = target.getAttribute('value');</span>
<a href="#l31.1038"></a><span id="l31.1038" class="difflineplus">+function NavigateToUri(target) {</span>
<a href="#l31.1039"></a><span id="l31.1039" class="difflineplus">+  var historyIndex = target.getAttribute(&quot;value&quot;);</span>
<a href="#l31.1040"></a><span id="l31.1040">   var msgUri = messenger.getMsgUriAtNavigatePos(historyIndex);</span>
<a href="#l31.1041"></a><span id="l31.1041">   var folder = target.folder;</span>
<a href="#l31.1042"></a><span id="l31.1042">   var msgHdr = messenger.msgHdrFromURI(msgUri);</span>
<a href="#l31.1043"></a><span id="l31.1043">   navDebug(&quot;navigating from &quot; + messenger.navigatePos + &quot; by &quot; + historyIndex + &quot; to &quot; + msgUri + &quot;\n&quot;);</span>
<a href="#l31.1044"></a><span id="l31.1044"> </span>
<a href="#l31.1045"></a><span id="l31.1045">   // this &quot;- 0&quot; seems to ensure that historyIndex is treated as an int, not a string.</span>
<a href="#l31.1046"></a><span id="l31.1046">   messenger.navigatePos += (historyIndex - 0);</span>
<a href="#l31.1047"></a><span id="l31.1047"> </span>
<a href="#l31.1048"></a><span id="l31.1048" class="difflineat">@@ -1180,55 +1120,50 @@ function NavigateToUri(target)</span>
<a href="#l31.1049"></a><span id="l31.1049">     if (gFolderTreeView)</span>
<a href="#l31.1050"></a><span id="l31.1050">       gFolderTreeView.selectFolder(folder);</span>
<a href="#l31.1051"></a><span id="l31.1051">     else</span>
<a href="#l31.1052"></a><span id="l31.1052">       gFolderDisplay.show(folder);</span>
<a href="#l31.1053"></a><span id="l31.1053">   }</span>
<a href="#l31.1054"></a><span id="l31.1054">   gFolderDisplay.selectMessage(msgHdr);</span>
<a href="#l31.1055"></a><span id="l31.1055"> }</span>
<a href="#l31.1056"></a><span id="l31.1056"> </span>
<a href="#l31.1057"></a><span id="l31.1057" class="difflineminus">-function forwardToolbarMenu_init(menuPopup)</span>
<a href="#l31.1058"></a><span id="l31.1058" class="difflineminus">-{</span>
<a href="#l31.1059"></a><span id="l31.1059" class="difflineplus">+function forwardToolbarMenu_init(menuPopup) {</span>
<a href="#l31.1060"></a><span id="l31.1060">   populateHistoryMenu(menuPopup, false);</span>
<a href="#l31.1061"></a><span id="l31.1061"> }</span>
<a href="#l31.1062"></a><span id="l31.1062"> </span>
<a href="#l31.1063"></a><span id="l31.1063" class="difflineminus">-function InitMessageMark()</span>
<a href="#l31.1064"></a><span id="l31.1064" class="difflineminus">-{</span>
<a href="#l31.1065"></a><span id="l31.1065" class="difflineplus">+function InitMessageMark() {</span>
<a href="#l31.1066"></a><span id="l31.1066">   document.getElementById(&quot;cmd_markAsFlagged&quot;)</span>
<a href="#l31.1067"></a><span id="l31.1067">           .setAttribute(&quot;checked&quot;, SelectedMessagesAreFlagged());</span>
<a href="#l31.1068"></a><span id="l31.1068"> </span>
<a href="#l31.1069"></a><span id="l31.1069" class="difflineminus">-  document.commandDispatcher.updateCommands('create-menu-mark');</span>
<a href="#l31.1070"></a><span id="l31.1070" class="difflineplus">+  document.commandDispatcher.updateCommands(&quot;create-menu-mark&quot;);</span>
<a href="#l31.1071"></a><span id="l31.1071"> }</span>
<a href="#l31.1072"></a><span id="l31.1072"> </span>
<a href="#l31.1073"></a><span id="l31.1073" class="difflineminus">-function UpdateJunkToolbarButton()</span>
<a href="#l31.1074"></a><span id="l31.1074" class="difflineminus">-{</span>
<a href="#l31.1075"></a><span id="l31.1075" class="difflineplus">+function UpdateJunkToolbarButton() {</span>
<a href="#l31.1076"></a><span id="l31.1076">   var junkButtonDeck = document.getElementById(&quot;junk-deck&quot;);</span>
<a href="#l31.1077"></a><span id="l31.1077">   if (junkButtonDeck)</span>
<a href="#l31.1078"></a><span id="l31.1078">     junkButtonDeck.selectedIndex = SelectedMessagesAreJunk() ? 1 : 0;</span>
<a href="#l31.1079"></a><span id="l31.1079"> }</span>
<a href="#l31.1080"></a><span id="l31.1080"> </span>
<a href="#l31.1081"></a><span id="l31.1081"> /**</span>
<a href="#l31.1082"></a><span id="l31.1082">  * Should the reply command/button be enabled?</span>
<a href="#l31.1083"></a><span id="l31.1083">  *</span>
<a href="#l31.1084"></a><span id="l31.1084">  * @return whether the reply command/button should be enabled.</span>
<a href="#l31.1085"></a><span id="l31.1085">  */</span>
<a href="#l31.1086"></a><span id="l31.1086" class="difflineminus">-function IsReplyEnabled()</span>
<a href="#l31.1087"></a><span id="l31.1087" class="difflineminus">-{</span>
<a href="#l31.1088"></a><span id="l31.1088" class="difflineplus">+function IsReplyEnabled() {</span>
<a href="#l31.1089"></a><span id="l31.1089">   // If we're in an rss item, we never want to Reply, because there's</span>
<a href="#l31.1090"></a><span id="l31.1090">   // usually no-one useful to reply to.</span>
<a href="#l31.1091"></a><span id="l31.1091">   return !gFolderDisplay.selectedMessageIsFeed;</span>
<a href="#l31.1092"></a><span id="l31.1092"> }</span>
<a href="#l31.1093"></a><span id="l31.1093"> </span>
<a href="#l31.1094"></a><span id="l31.1094"> /**</span>
<a href="#l31.1095"></a><span id="l31.1095">  * Should the reply-all command/button be enabled?</span>
<a href="#l31.1096"></a><span id="l31.1096">  *</span>
<a href="#l31.1097"></a><span id="l31.1097">  * @return whether the reply-all command/button should be enabled.</span>
<a href="#l31.1098"></a><span id="l31.1098">  */</span>
<a href="#l31.1099"></a><span id="l31.1099" class="difflineminus">-function IsReplyAllEnabled()</span>
<a href="#l31.1100"></a><span id="l31.1100" class="difflineminus">-{</span>
<a href="#l31.1101"></a><span id="l31.1101" class="difflineplus">+function IsReplyAllEnabled() {</span>
<a href="#l31.1102"></a><span id="l31.1102">   if (gFolderDisplay.selectedMessageIsNews)</span>
<a href="#l31.1103"></a><span id="l31.1103">     // If we're in a news item, we always want ReplyAll, because we can</span>
<a href="#l31.1104"></a><span id="l31.1104">     // reply to the sender and the newsgroup.</span>
<a href="#l31.1105"></a><span id="l31.1105">     return true;</span>
<a href="#l31.1106"></a><span id="l31.1106">   if (gFolderDisplay.selectedMessageIsFeed)</span>
<a href="#l31.1107"></a><span id="l31.1107">     // If we're in an rss item, we never want to ReplyAll, because there's</span>
<a href="#l31.1108"></a><span id="l31.1108">     // usually no-one useful to reply to.</span>
<a href="#l31.1109"></a><span id="l31.1109">     return false;</span>
<a href="#l31.1110"></a><span id="l31.1110" class="difflineat">@@ -1264,350 +1199,309 @@ function IsReplyAllEnabled()</span>
<a href="#l31.1111"></a><span id="l31.1111">   return numAddresses &gt; 1;</span>
<a href="#l31.1112"></a><span id="l31.1112"> }</span>
<a href="#l31.1113"></a><span id="l31.1113"> </span>
<a href="#l31.1114"></a><span id="l31.1114"> /**</span>
<a href="#l31.1115"></a><span id="l31.1115">  * Should the reply-list command/button be enabled?</span>
<a href="#l31.1116"></a><span id="l31.1116">  *</span>
<a href="#l31.1117"></a><span id="l31.1117">  * @return whether the reply-list command/button should be enabled.</span>
<a href="#l31.1118"></a><span id="l31.1118">  */</span>
<a href="#l31.1119"></a><span id="l31.1119" class="difflineminus">-function IsReplyListEnabled()</span>
<a href="#l31.1120"></a><span id="l31.1120" class="difflineminus">-{</span>
<a href="#l31.1121"></a><span id="l31.1121" class="difflineplus">+function IsReplyListEnabled() {</span>
<a href="#l31.1122"></a><span id="l31.1122">   // ReplyToList is enabled if there is a List-Post header</span>
<a href="#l31.1123"></a><span id="l31.1123">   // with the correct format.</span>
<a href="#l31.1124"></a><span id="l31.1124">   let listPost = currentHeaderData[&quot;list-post&quot;];</span>
<a href="#l31.1125"></a><span id="l31.1125">   if (!listPost)</span>
<a href="#l31.1126"></a><span id="l31.1126">     return false;</span>
<a href="#l31.1127"></a><span id="l31.1127"> </span>
<a href="#l31.1128"></a><span id="l31.1128">   // XXX: Once Bug 496914 provides a parser, we should use that instead.</span>
<a href="#l31.1129"></a><span id="l31.1129">   // Until then, we need to keep the following regex in sync with the</span>
<a href="#l31.1130"></a><span id="l31.1130">   // listPost parsing in nsMsgCompose.cpp's</span>
<a href="#l31.1131"></a><span id="l31.1131">   // QuotingOutputStreamListener::OnStopRequest.</span>
<a href="#l31.1132"></a><span id="l31.1132" class="difflineminus">-  return /&lt;mailto:.+&gt;/.test(listPost[&quot;headerValue&quot;]);</span>
<a href="#l31.1133"></a><span id="l31.1133" class="difflineplus">+  return /&lt;mailto:.+&gt;/.test(listPost.headerValue);</span>
<a href="#l31.1134"></a><span id="l31.1134"> }</span>
<a href="#l31.1135"></a><span id="l31.1135"> </span>
<a href="#l31.1136"></a><span id="l31.1136"> /**</span>
<a href="#l31.1137"></a><span id="l31.1137">  * Update the enabled/disabled states of the Reply, Reply-All, and</span>
<a href="#l31.1138"></a><span id="l31.1138">  * Reply-List buttons.  (After this function runs, one of the buttons</span>
<a href="#l31.1139"></a><span id="l31.1139">  * should be shown, and the others should be hidden.)</span>
<a href="#l31.1140"></a><span id="l31.1140">  */</span>
<a href="#l31.1141"></a><span id="l31.1141" class="difflineminus">-function UpdateReplyButtons()</span>
<a href="#l31.1142"></a><span id="l31.1142" class="difflineminus">-{</span>
<a href="#l31.1143"></a><span id="l31.1143" class="difflineplus">+function UpdateReplyButtons() {</span>
<a href="#l31.1144"></a><span id="l31.1144">   // If we have no message, because we're being called from</span>
<a href="#l31.1145"></a><span id="l31.1145">   // MailToolboxCustomizeDone before someone selected a message, then just</span>
<a href="#l31.1146"></a><span id="l31.1146">   // return.</span>
<a href="#l31.1147"></a><span id="l31.1147">   if (!gFolderDisplay.selectedMessage)</span>
<a href="#l31.1148"></a><span id="l31.1148">     return;</span>
<a href="#l31.1149"></a><span id="l31.1149"> </span>
<a href="#l31.1150"></a><span id="l31.1150">   let buttonToShow;</span>
<a href="#l31.1151"></a><span id="l31.1151" class="difflineminus">-  if (gFolderDisplay.selectedMessageIsNews)</span>
<a href="#l31.1152"></a><span id="l31.1152" class="difflineminus">-  {</span>
<a href="#l31.1153"></a><span id="l31.1153" class="difflineplus">+  if (gFolderDisplay.selectedMessageIsNews) {</span>
<a href="#l31.1154"></a><span id="l31.1154">     // News messages always default to the &quot;followup&quot; dual-button.</span>
<a href="#l31.1155"></a><span id="l31.1155">     buttonToShow = &quot;followup&quot;;</span>
<a href="#l31.1156"></a><span id="l31.1156" class="difflineminus">-  }</span>
<a href="#l31.1157"></a><span id="l31.1157" class="difflineminus">-  else if (gFolderDisplay.selectedMessageIsFeed)</span>
<a href="#l31.1158"></a><span id="l31.1158" class="difflineminus">-  {</span>
<a href="#l31.1159"></a><span id="l31.1159" class="difflineplus">+  } else if (gFolderDisplay.selectedMessageIsFeed) {</span>
<a href="#l31.1160"></a><span id="l31.1160">     // RSS items hide all the reply buttons.</span>
<a href="#l31.1161"></a><span id="l31.1161">     buttonToShow = null;</span>
<a href="#l31.1162"></a><span id="l31.1162" class="difflineminus">-  }</span>
<a href="#l31.1163"></a><span id="l31.1163" class="difflineminus">-  else</span>
<a href="#l31.1164"></a><span id="l31.1164" class="difflineminus">-  {</span>
<a href="#l31.1165"></a><span id="l31.1165" class="difflineplus">+  } else if (IsReplyListEnabled()) {</span>
<a href="#l31.1166"></a><span id="l31.1166">     // Mail messages show the &quot;reply&quot; button (not the dual-button) and</span>
<a href="#l31.1167"></a><span id="l31.1167">     // possibly the &quot;reply all&quot; and &quot;reply list&quot; buttons.</span>
<a href="#l31.1168"></a><span id="l31.1168" class="difflineminus">-    if (IsReplyListEnabled())</span>
<a href="#l31.1169"></a><span id="l31.1169" class="difflineminus">-      buttonToShow = &quot;replyList&quot;;</span>
<a href="#l31.1170"></a><span id="l31.1170" class="difflineminus">-    else if (IsReplyAllEnabled())</span>
<a href="#l31.1171"></a><span id="l31.1171" class="difflineminus">-      buttonToShow = &quot;replyAll&quot;;</span>
<a href="#l31.1172"></a><span id="l31.1172" class="difflineminus">-    else</span>
<a href="#l31.1173"></a><span id="l31.1173" class="difflineminus">-      buttonToShow = &quot;reply&quot;;</span>
<a href="#l31.1174"></a><span id="l31.1174" class="difflineplus">+    buttonToShow = &quot;replyList&quot;;</span>
<a href="#l31.1175"></a><span id="l31.1175" class="difflineplus">+  } else if (IsReplyAllEnabled()) {</span>
<a href="#l31.1176"></a><span id="l31.1176" class="difflineplus">+    buttonToShow = &quot;replyAll&quot;;</span>
<a href="#l31.1177"></a><span id="l31.1177" class="difflineplus">+  } else {</span>
<a href="#l31.1178"></a><span id="l31.1178" class="difflineplus">+    buttonToShow = &quot;reply&quot;;</span>
<a href="#l31.1179"></a><span id="l31.1179">   }</span>
<a href="#l31.1180"></a><span id="l31.1180"> </span>
<a href="#l31.1181"></a><span id="l31.1181">   let smartReplyButton = document.getElementById(&quot;hdrSmartReplyButton&quot;);</span>
<a href="#l31.1182"></a><span id="l31.1182" class="difflineminus">-  if (smartReplyButton)</span>
<a href="#l31.1183"></a><span id="l31.1183" class="difflineminus">-  {</span>
<a href="#l31.1184"></a><span id="l31.1184" class="difflineplus">+  if (smartReplyButton) {</span>
<a href="#l31.1185"></a><span id="l31.1185">     let replyButton = document.getElementById(&quot;hdrReplyButton&quot;);</span>
<a href="#l31.1186"></a><span id="l31.1186">     let replyAllButton = document.getElementById(&quot;hdrReplyAllButton&quot;);</span>
<a href="#l31.1187"></a><span id="l31.1187">     let replyListButton = document.getElementById(&quot;hdrReplyListButton&quot;);</span>
<a href="#l31.1188"></a><span id="l31.1188">     let followupButton = document.getElementById(&quot;hdrFollowupButton&quot;);</span>
<a href="#l31.1189"></a><span id="l31.1189"> </span>
<a href="#l31.1190"></a><span id="l31.1190">     replyButton.hidden = (buttonToShow != &quot;reply&quot;);</span>
<a href="#l31.1191"></a><span id="l31.1191">     replyAllButton.hidden = (buttonToShow != &quot;replyAll&quot;);</span>
<a href="#l31.1192"></a><span id="l31.1192">     replyListButton.hidden = (buttonToShow != &quot;replyList&quot;);</span>
<a href="#l31.1193"></a><span id="l31.1193">     followupButton.hidden = (buttonToShow != &quot;followup&quot;);</span>
<a href="#l31.1194"></a><span id="l31.1194">   }</span>
<a href="#l31.1195"></a><span id="l31.1195"> </span>
<a href="#l31.1196"></a><span id="l31.1196">   let replyToSenderButton = document.getElementById(&quot;hdrReplyToSenderButton&quot;);</span>
<a href="#l31.1197"></a><span id="l31.1197" class="difflineminus">-  if (replyToSenderButton)</span>
<a href="#l31.1198"></a><span id="l31.1198" class="difflineminus">-  {</span>
<a href="#l31.1199"></a><span id="l31.1199" class="difflineplus">+  if (replyToSenderButton) {</span>
<a href="#l31.1200"></a><span id="l31.1200">     if (gFolderDisplay.selectedMessageIsFeed)</span>
<a href="#l31.1201"></a><span id="l31.1201">       replyToSenderButton.hidden = true;</span>
<a href="#l31.1202"></a><span id="l31.1202">     else if (smartReplyButton)</span>
<a href="#l31.1203"></a><span id="l31.1203">       replyToSenderButton.hidden = (buttonToShow == &quot;reply&quot;);</span>
<a href="#l31.1204"></a><span id="l31.1204">     else</span>
<a href="#l31.1205"></a><span id="l31.1205">       replyToSenderButton.hidden = false;</span>
<a href="#l31.1206"></a><span id="l31.1206">   }</span>
<a href="#l31.1207"></a><span id="l31.1207"> </span>
<a href="#l31.1208"></a><span id="l31.1208">   goUpdateCommand(&quot;button_reply&quot;);</span>
<a href="#l31.1209"></a><span id="l31.1209">   goUpdateCommand(&quot;button_replyall&quot;);</span>
<a href="#l31.1210"></a><span id="l31.1210">   goUpdateCommand(&quot;button_replylist&quot;);</span>
<a href="#l31.1211"></a><span id="l31.1211">   goUpdateCommand(&quot;button_followup&quot;);</span>
<a href="#l31.1212"></a><span id="l31.1212"> }</span>
<a href="#l31.1213"></a><span id="l31.1213"> </span>
<a href="#l31.1214"></a><span id="l31.1214" class="difflineminus">-function UpdateDeleteToolbarButton()</span>
<a href="#l31.1215"></a><span id="l31.1215" class="difflineminus">-{</span>
<a href="#l31.1216"></a><span id="l31.1216" class="difflineplus">+function UpdateDeleteToolbarButton() {</span>
<a href="#l31.1217"></a><span id="l31.1217">   var deleteButtonDeck = document.getElementById(&quot;delete-deck&quot;);</span>
<a href="#l31.1218"></a><span id="l31.1218">   if (!deleteButtonDeck)</span>
<a href="#l31.1219"></a><span id="l31.1219">     return;</span>
<a href="#l31.1220"></a><span id="l31.1220"> </span>
<a href="#l31.1221"></a><span id="l31.1221">   // Never show &quot;Undelete&quot; in the 3-pane for folders, when delete would</span>
<a href="#l31.1222"></a><span id="l31.1222">   // apply to the selected folder.</span>
<a href="#l31.1223"></a><span id="l31.1223">   if (gFolderDisplay.focusedPane == document.getElementById(&quot;folderTree&quot;) &amp;&amp;</span>
<a href="#l31.1224"></a><span id="l31.1224">       gFolderDisplay.selectedCount == 0)</span>
<a href="#l31.1225"></a><span id="l31.1225">     deleteButtonDeck.selectedIndex = 0;</span>
<a href="#l31.1226"></a><span id="l31.1226">   else</span>
<a href="#l31.1227"></a><span id="l31.1227">     deleteButtonDeck.selectedIndex = SelectedMessagesAreDeleted() ? 1 : 0;</span>
<a href="#l31.1228"></a><span id="l31.1228"> }</span>
<a href="#l31.1229"></a><span id="l31.1229" class="difflineminus">-function UpdateDeleteCommand()</span>
<a href="#l31.1230"></a><span id="l31.1230" class="difflineminus">-{</span>
<a href="#l31.1231"></a><span id="l31.1231" class="difflineplus">+function UpdateDeleteCommand() {</span>
<a href="#l31.1232"></a><span id="l31.1232">   var value = &quot;value&quot;;</span>
<a href="#l31.1233"></a><span id="l31.1233">   if (SelectedMessagesAreDeleted())</span>
<a href="#l31.1234"></a><span id="l31.1234">     value += &quot;IMAPDeleted&quot;;</span>
<a href="#l31.1235"></a><span id="l31.1235">   if (gFolderDisplay.selectedCount &lt; 2)</span>
<a href="#l31.1236"></a><span id="l31.1236">     value += &quot;Message&quot;;</span>
<a href="#l31.1237"></a><span id="l31.1237">   else</span>
<a href="#l31.1238"></a><span id="l31.1238">     value += &quot;Messages&quot;;</span>
<a href="#l31.1239"></a><span id="l31.1239">   goSetMenuValue(&quot;cmd_delete&quot;, value);</span>
<a href="#l31.1240"></a><span id="l31.1240">   goSetAccessKey(&quot;cmd_delete&quot;, value + &quot;AccessKey&quot;);</span>
<a href="#l31.1241"></a><span id="l31.1241"> }</span>
<a href="#l31.1242"></a><span id="l31.1242"> </span>
<a href="#l31.1243"></a><span id="l31.1243" class="difflineminus">-function SelectedMessagesAreDeleted()</span>
<a href="#l31.1244"></a><span id="l31.1244" class="difflineminus">-{</span>
<a href="#l31.1245"></a><span id="l31.1245" class="difflineplus">+function SelectedMessagesAreDeleted() {</span>
<a href="#l31.1246"></a><span id="l31.1246">   let firstSelectedMessage = gFolderDisplay.selectedMessage;</span>
<a href="#l31.1247"></a><span id="l31.1247">   return firstSelectedMessage &amp;&amp;</span>
<a href="#l31.1248"></a><span id="l31.1248">          (firstSelectedMessage.flags &amp;</span>
<a href="#l31.1249"></a><span id="l31.1249">           Ci.nsMsgMessageFlags.IMAPDeleted);</span>
<a href="#l31.1250"></a><span id="l31.1250"> }</span>
<a href="#l31.1251"></a><span id="l31.1251"> </span>
<a href="#l31.1252"></a><span id="l31.1252" class="difflineminus">-function SelectedMessagesAreJunk()</span>
<a href="#l31.1253"></a><span id="l31.1253" class="difflineminus">-{</span>
<a href="#l31.1254"></a><span id="l31.1254" class="difflineplus">+function SelectedMessagesAreJunk() {</span>
<a href="#l31.1255"></a><span id="l31.1255">   try {</span>
<a href="#l31.1256"></a><span id="l31.1256">     var junkScore = gFolderDisplay.selectedMessage.getStringProperty(&quot;junkscore&quot;);</span>
<a href="#l31.1257"></a><span id="l31.1257">     return (junkScore != &quot;&quot;) &amp;&amp; (junkScore != &quot;0&quot;);</span>
<a href="#l31.1258"></a><span id="l31.1258" class="difflineminus">-  }</span>
<a href="#l31.1259"></a><span id="l31.1259" class="difflineminus">-  catch (ex) {</span>
<a href="#l31.1260"></a><span id="l31.1260" class="difflineplus">+  } catch (ex) {</span>
<a href="#l31.1261"></a><span id="l31.1261">     return false;</span>
<a href="#l31.1262"></a><span id="l31.1262">   }</span>
<a href="#l31.1263"></a><span id="l31.1263"> }</span>
<a href="#l31.1264"></a><span id="l31.1264"> </span>
<a href="#l31.1265"></a><span id="l31.1265" class="difflineminus">-function SelectedMessagesAreRead()</span>
<a href="#l31.1266"></a><span id="l31.1266" class="difflineminus">-{</span>
<a href="#l31.1267"></a><span id="l31.1267" class="difflineplus">+function SelectedMessagesAreRead() {</span>
<a href="#l31.1268"></a><span id="l31.1268">   let messages = gFolderDisplay.selectedMessages;</span>
<a href="#l31.1269"></a><span id="l31.1269">   if (messages.length == 0)</span>
<a href="#l31.1270"></a><span id="l31.1270">     return undefined;</span>
<a href="#l31.1271"></a><span id="l31.1271">   if (messages.every(function(msg) { return msg.isRead; }))</span>
<a href="#l31.1272"></a><span id="l31.1272">     return true;</span>
<a href="#l31.1273"></a><span id="l31.1273">   if (messages.every(function(msg) { return !msg.isRead; }))</span>
<a href="#l31.1274"></a><span id="l31.1274">     return false;</span>
<a href="#l31.1275"></a><span id="l31.1275">   return undefined;</span>
<a href="#l31.1276"></a><span id="l31.1276"> }</span>
<a href="#l31.1277"></a><span id="l31.1277"> </span>
<a href="#l31.1278"></a><span id="l31.1278" class="difflineminus">-function SelectedMessagesAreFlagged()</span>
<a href="#l31.1279"></a><span id="l31.1279" class="difflineminus">-{</span>
<a href="#l31.1280"></a><span id="l31.1280" class="difflineplus">+function SelectedMessagesAreFlagged() {</span>
<a href="#l31.1281"></a><span id="l31.1281">   let firstSelectedMessage = gFolderDisplay.selectedMessage;</span>
<a href="#l31.1282"></a><span id="l31.1282">   return firstSelectedMessage &amp;&amp; firstSelectedMessage.isFlagged;</span>
<a href="#l31.1283"></a><span id="l31.1283"> }</span>
<a href="#l31.1284"></a><span id="l31.1284"> </span>
<a href="#l31.1285"></a><span id="l31.1285" class="difflineminus">-function GetFirstSelectedMsgFolder()</span>
<a href="#l31.1286"></a><span id="l31.1286" class="difflineminus">-{</span>
<a href="#l31.1287"></a><span id="l31.1287" class="difflineplus">+function GetFirstSelectedMsgFolder() {</span>
<a href="#l31.1288"></a><span id="l31.1288">   try {</span>
<a href="#l31.1289"></a><span id="l31.1289">     var selectedFolders = GetSelectedMsgFolders();</span>
<a href="#l31.1290"></a><span id="l31.1290">   } catch (e) {</span>
<a href="#l31.1291"></a><span id="l31.1291">     logException(e);</span>
<a href="#l31.1292"></a><span id="l31.1292">   }</span>
<a href="#l31.1293"></a><span id="l31.1293">   return (selectedFolders.length &gt; 0) ? selectedFolders[0] : null;</span>
<a href="#l31.1294"></a><span id="l31.1294"> }</span>
<a href="#l31.1295"></a><span id="l31.1295"> </span>
<a href="#l31.1296"></a><span id="l31.1296" class="difflineminus">-function GetInboxFolder(server)</span>
<a href="#l31.1297"></a><span id="l31.1297" class="difflineminus">-{</span>
<a href="#l31.1298"></a><span id="l31.1298" class="difflineplus">+function GetInboxFolder(server) {</span>
<a href="#l31.1299"></a><span id="l31.1299">   try {</span>
<a href="#l31.1300"></a><span id="l31.1300">     var rootMsgFolder = server.rootMsgFolder;</span>
<a href="#l31.1301"></a><span id="l31.1301"> </span>
<a href="#l31.1302"></a><span id="l31.1302">     // Now find the Inbox.</span>
<a href="#l31.1303"></a><span id="l31.1303">     return rootMsgFolder.getFolderWithFlags(Ci.nsMsgFolderFlags.Inbox);</span>
<a href="#l31.1304"></a><span id="l31.1304" class="difflineminus">-  }</span>
<a href="#l31.1305"></a><span id="l31.1305" class="difflineminus">-  catch (ex) {</span>
<a href="#l31.1306"></a><span id="l31.1306" class="difflineplus">+  } catch (ex) {</span>
<a href="#l31.1307"></a><span id="l31.1307">     dump(ex + &quot;\n&quot;);</span>
<a href="#l31.1308"></a><span id="l31.1308">   }</span>
<a href="#l31.1309"></a><span id="l31.1309">   return null;</span>
<a href="#l31.1310"></a><span id="l31.1310"> }</span>
<a href="#l31.1311"></a><span id="l31.1311"> </span>
<a href="#l31.1312"></a><span id="l31.1312" class="difflineminus">-function GetMessagesForInboxOnServer(server)</span>
<a href="#l31.1313"></a><span id="l31.1313" class="difflineminus">-{</span>
<a href="#l31.1314"></a><span id="l31.1314" class="difflineplus">+function GetMessagesForInboxOnServer(server) {</span>
<a href="#l31.1315"></a><span id="l31.1315">   var inboxFolder = GetInboxFolder(server);</span>
<a href="#l31.1316"></a><span id="l31.1316"> </span>
<a href="#l31.1317"></a><span id="l31.1317">   // If the server doesn't support an inbox it could be an RSS server or some</span>
<a href="#l31.1318"></a><span id="l31.1318">   // other server type. Just use the root folder and the server implementation</span>
<a href="#l31.1319"></a><span id="l31.1319">   // can figure out what to do.</span>
<a href="#l31.1320"></a><span id="l31.1320">   if (!inboxFolder)</span>
<a href="#l31.1321"></a><span id="l31.1321">     inboxFolder = server.rootFolder;</span>
<a href="#l31.1322"></a><span id="l31.1322"> </span>
<a href="#l31.1323"></a><span id="l31.1323">   GetNewMsgs(server, inboxFolder);</span>
<a href="#l31.1324"></a><span id="l31.1324"> }</span>
<a href="#l31.1325"></a><span id="l31.1325"> </span>
<a href="#l31.1326"></a><span id="l31.1326" class="difflineminus">-function MsgGetMessage()</span>
<a href="#l31.1327"></a><span id="l31.1327" class="difflineminus">-{</span>
<a href="#l31.1328"></a><span id="l31.1328" class="difflineplus">+function MsgGetMessage() {</span>
<a href="#l31.1329"></a><span id="l31.1329">   // if offline, prompt for getting messages</span>
<a href="#l31.1330"></a><span id="l31.1330">   if (MailOfflineMgr.isOnline() || MailOfflineMgr.getNewMail())</span>
<a href="#l31.1331"></a><span id="l31.1331">     GetFolderMessages();</span>
<a href="#l31.1332"></a><span id="l31.1332"> }</span>
<a href="#l31.1333"></a><span id="l31.1333"> </span>
<a href="#l31.1334"></a><span id="l31.1334" class="difflineminus">-function MsgPauseUpdates(aMenuitem)</span>
<a href="#l31.1335"></a><span id="l31.1335" class="difflineminus">-{</span>
<a href="#l31.1336"></a><span id="l31.1336" class="difflineplus">+function MsgPauseUpdates(aMenuitem) {</span>
<a href="#l31.1337"></a><span id="l31.1337">   // Pause single feed folder subscription updates, or all account updates if</span>
<a href="#l31.1338"></a><span id="l31.1338">   // folder is the account folder.</span>
<a href="#l31.1339"></a><span id="l31.1339">   let selectedFolders = GetSelectedMsgFolders();</span>
<a href="#l31.1340"></a><span id="l31.1340">   let folder = selectedFolders.length ? selectedFolders[0] : null;</span>
<a href="#l31.1341"></a><span id="l31.1341">   if (!FeedMessageHandler.isFeedFolder(folder))</span>
<a href="#l31.1342"></a><span id="l31.1342">     return;</span>
<a href="#l31.1343"></a><span id="l31.1343"> </span>
<a href="#l31.1344"></a><span id="l31.1344">   let pause = aMenuitem.getAttribute(&quot;checked&quot;) == &quot;true&quot;;</span>
<a href="#l31.1345"></a><span id="l31.1345">   FeedUtils.pauseFeedFolderUpdates(folder, pause, true);</span>
<a href="#l31.1346"></a><span id="l31.1346"> }</span>
<a href="#l31.1347"></a><span id="l31.1347"> </span>
<a href="#l31.1348"></a><span id="l31.1348" class="difflineminus">-function MsgGetMessagesForAllServers(defaultServer)</span>
<a href="#l31.1349"></a><span id="l31.1349" class="difflineminus">-{</span>
<a href="#l31.1350"></a><span id="l31.1350" class="difflineplus">+function MsgGetMessagesForAllServers(defaultServer) {</span>
<a href="#l31.1351"></a><span id="l31.1351">   // now log into any server</span>
<a href="#l31.1352"></a><span id="l31.1352" class="difflineminus">-  try</span>
<a href="#l31.1353"></a><span id="l31.1353" class="difflineminus">-  {</span>
<a href="#l31.1354"></a><span id="l31.1354" class="difflineplus">+  try {</span>
<a href="#l31.1355"></a><span id="l31.1355">     var allServers = accountManager.allServers;</span>
<a href="#l31.1356"></a><span id="l31.1356">     // Array of arrays of servers for a particular folder.</span>
<a href="#l31.1357"></a><span id="l31.1357">     var pop3DownloadServersArray = [];</span>
<a href="#l31.1358"></a><span id="l31.1358">     // Parallel array of folders to download to...</span>
<a href="#l31.1359"></a><span id="l31.1359">     var localFoldersToDownloadTo = [];</span>
<a href="#l31.1360"></a><span id="l31.1360">     var pop3Server;</span>
<a href="#l31.1361"></a><span id="l31.1361" class="difflineminus">-    for (var i = 0; i &lt; allServers.length; ++i)</span>
<a href="#l31.1362"></a><span id="l31.1362" class="difflineminus">-    {</span>
<a href="#l31.1363"></a><span id="l31.1363" class="difflineplus">+    for (let i = 0; i &lt; allServers.length; ++i) {</span>
<a href="#l31.1364"></a><span id="l31.1364">       var currentServer = allServers.queryElementAt(i, Ci.nsIMsgIncomingServer);</span>
<a href="#l31.1365"></a><span id="l31.1365">       if (currentServer.protocolInfo.canLoginAtStartUp &amp;&amp;</span>
<a href="#l31.1366"></a><span id="l31.1366" class="difflineminus">-          currentServer.loginAtStartUp)</span>
<a href="#l31.1367"></a><span id="l31.1367" class="difflineminus">-      {</span>
<a href="#l31.1368"></a><span id="l31.1368" class="difflineplus">+          currentServer.loginAtStartUp) {</span>
<a href="#l31.1369"></a><span id="l31.1369">         if (defaultServer &amp;&amp; defaultServer.equals(currentServer) &amp;&amp;</span>
<a href="#l31.1370"></a><span id="l31.1370">             !defaultServer.isDeferredTo &amp;&amp;</span>
<a href="#l31.1371"></a><span id="l31.1371" class="difflineminus">-            defaultServer.rootFolder == defaultServer.rootMsgFolder)</span>
<a href="#l31.1372"></a><span id="l31.1372" class="difflineminus">-        {</span>
<a href="#l31.1373"></a><span id="l31.1373" class="difflineplus">+            defaultServer.rootFolder == defaultServer.rootMsgFolder) {</span>
<a href="#l31.1374"></a><span id="l31.1374">           // skip, already opened</span>
<a href="#l31.1375"></a><span id="l31.1375" class="difflineminus">-        }</span>
<a href="#l31.1376"></a><span id="l31.1376" class="difflineminus">-        else if (currentServer.type == &quot;pop3&quot; &amp;&amp; currentServer.downloadOnBiff)</span>
<a href="#l31.1377"></a><span id="l31.1377" class="difflineminus">-        {</span>
<a href="#l31.1378"></a><span id="l31.1378" class="difflineplus">+        } else if (currentServer.type == &quot;pop3&quot; &amp;&amp; currentServer.downloadOnBiff) {</span>
<a href="#l31.1379"></a><span id="l31.1379">           CoalesceGetMsgsForPop3ServersByDestFolder(currentServer,</span>
<a href="#l31.1380"></a><span id="l31.1380">             pop3DownloadServersArray, localFoldersToDownloadTo);</span>
<a href="#l31.1381"></a><span id="l31.1381">           pop3Server = currentServer.QueryInterface(Ci.nsIPop3IncomingServer);</span>
<a href="#l31.1382"></a><span id="l31.1382" class="difflineminus">-        }</span>
<a href="#l31.1383"></a><span id="l31.1383" class="difflineminus">-        else</span>
<a href="#l31.1384"></a><span id="l31.1384" class="difflineminus">-        {</span>
<a href="#l31.1385"></a><span id="l31.1385" class="difflineplus">+        } else {</span>
<a href="#l31.1386"></a><span id="l31.1386">           // Check to see if there are new messages on the server</span>
<a href="#l31.1387"></a><span id="l31.1387">           currentServer.performBiff(msgWindow);</span>
<a href="#l31.1388"></a><span id="l31.1388">         }</span>
<a href="#l31.1389"></a><span id="l31.1389">       }</span>
<a href="#l31.1390"></a><span id="l31.1390">     }</span>
<a href="#l31.1391"></a><span id="l31.1391" class="difflineminus">-    for (var i = 0; i &lt; pop3DownloadServersArray.length; ++i)</span>
<a href="#l31.1392"></a><span id="l31.1392" class="difflineminus">-    {</span>
<a href="#l31.1393"></a><span id="l31.1393" class="difflineplus">+    for (let i = 0; i &lt; pop3DownloadServersArray.length; ++i) {</span>
<a href="#l31.1394"></a><span id="l31.1394">       // Any ol' pop3Server will do - the serversArray specifies which servers</span>
<a href="#l31.1395"></a><span id="l31.1395">       // to download from.</span>
<a href="#l31.1396"></a><span id="l31.1396">       pop3Server.downloadMailFromServers(pop3DownloadServersArray[i],</span>
<a href="#l31.1397"></a><span id="l31.1397">                                          pop3DownloadServersArray[i].length,</span>
<a href="#l31.1398"></a><span id="l31.1398">                                          msgWindow,</span>
<a href="#l31.1399"></a><span id="l31.1399">                                          localFoldersToDownloadTo[i],</span>
<a href="#l31.1400"></a><span id="l31.1400">                                          null);</span>
<a href="#l31.1401"></a><span id="l31.1401">     }</span>
<a href="#l31.1402"></a><span id="l31.1402" class="difflineminus">-  }</span>
<a href="#l31.1403"></a><span id="l31.1403" class="difflineminus">-  catch(ex)</span>
<a href="#l31.1404"></a><span id="l31.1404" class="difflineminus">-  {</span>
<a href="#l31.1405"></a><span id="l31.1405" class="difflineplus">+  } catch (ex) {</span>
<a href="#l31.1406"></a><span id="l31.1406">     dump(ex + &quot;\n&quot;);</span>
<a href="#l31.1407"></a><span id="l31.1407">   }</span>
<a href="#l31.1408"></a><span id="l31.1408"> }</span>
<a href="#l31.1409"></a><span id="l31.1409"> </span>
<a href="#l31.1410"></a><span id="l31.1410"> /**</span>
<a href="#l31.1411"></a><span id="l31.1411">   * Get messages for all those accounts which have the capability</span>
<a href="#l31.1412"></a><span id="l31.1412">   * of getting messages and have session password available i.e.,</span>
<a href="#l31.1413"></a><span id="l31.1413">   * curretnly logged in accounts.</span>
<a href="#l31.1414"></a><span id="l31.1414">   * if offline, prompt for getting messages.</span>
<a href="#l31.1415"></a><span id="l31.1415">   */</span>
<a href="#l31.1416"></a><span id="l31.1416" class="difflineminus">-function MsgGetMessagesForAllAuthenticatedAccounts()</span>
<a href="#l31.1417"></a><span id="l31.1417" class="difflineminus">-{</span>
<a href="#l31.1418"></a><span id="l31.1418" class="difflineplus">+function MsgGetMessagesForAllAuthenticatedAccounts() {</span>
<a href="#l31.1419"></a><span id="l31.1419">   if (MailOfflineMgr.isOnline() || MailOfflineMgr.getNewMail())</span>
<a href="#l31.1420"></a><span id="l31.1420">     GetMessagesForAllAuthenticatedAccounts();</span>
<a href="#l31.1421"></a><span id="l31.1421"> }</span>
<a href="#l31.1422"></a><span id="l31.1422"> </span>
<a href="#l31.1423"></a><span id="l31.1423"> /**</span>
<a href="#l31.1424"></a><span id="l31.1424">   * Get messages for the account selected from Menu dropdowns.</span>
<a href="#l31.1425"></a><span id="l31.1425">   * if offline, prompt for getting messages.</span>
<a href="#l31.1426"></a><span id="l31.1426">   *</span>
<a href="#l31.1427"></a><span id="l31.1427">   * @param aFolder (optional) a folder in the account for which messages should</span>
<a href="#l31.1428"></a><span id="l31.1428">   *                           be retrieved.  If null, all accounts will be used.</span>
<a href="#l31.1429"></a><span id="l31.1429">   */</span>
<a href="#l31.1430"></a><span id="l31.1430" class="difflineminus">-function MsgGetMessagesForAccount(aFolder)</span>
<a href="#l31.1431"></a><span id="l31.1431" class="difflineminus">-{</span>
<a href="#l31.1432"></a><span id="l31.1432" class="difflineplus">+function MsgGetMessagesForAccount(aFolder) {</span>
<a href="#l31.1433"></a><span id="l31.1433">   if (!aFolder) {</span>
<a href="#l31.1434"></a><span id="l31.1434" class="difflineminus">-    goDoCommand('cmd_getNewMessages');</span>
<a href="#l31.1435"></a><span id="l31.1435" class="difflineplus">+    goDoCommand(&quot;cmd_getNewMessages&quot;);</span>
<a href="#l31.1436"></a><span id="l31.1436">     return;</span>
<a href="#l31.1437"></a><span id="l31.1437">   }</span>
<a href="#l31.1438"></a><span id="l31.1438"> </span>
<a href="#l31.1439"></a><span id="l31.1439">   if (MailOfflineMgr.isOnline() || MailOfflineMgr.getNewMail()) {</span>
<a href="#l31.1440"></a><span id="l31.1440">     var server = aFolder.server;</span>
<a href="#l31.1441"></a><span id="l31.1441">     GetMessagesForInboxOnServer(server);</span>
<a href="#l31.1442"></a><span id="l31.1442">   }</span>
<a href="#l31.1443"></a><span id="l31.1443"> }</span>
<a href="#l31.1444"></a><span id="l31.1444"> </span>
<a href="#l31.1445"></a><span id="l31.1445"> // if offline, prompt for getNextNMessages</span>
<a href="#l31.1446"></a><span id="l31.1446" class="difflineminus">-function MsgGetNextNMessages()</span>
<a href="#l31.1447"></a><span id="l31.1447" class="difflineminus">-{</span>
<a href="#l31.1448"></a><span id="l31.1448" class="difflineplus">+function MsgGetNextNMessages() {</span>
<a href="#l31.1449"></a><span id="l31.1449">   if (MailOfflineMgr.isOnline() || MailOfflineMgr.getNewMail())</span>
<a href="#l31.1450"></a><span id="l31.1450">     GetNextNMessages(GetFirstSelectedMsgFolder());</span>
<a href="#l31.1451"></a><span id="l31.1451"> }</span>
<a href="#l31.1452"></a><span id="l31.1452"> </span>
<a href="#l31.1453"></a><span id="l31.1453" class="difflineminus">-function MsgDeleteMessage(reallyDelete, fromToolbar)</span>
<a href="#l31.1454"></a><span id="l31.1454" class="difflineminus">-{</span>
<a href="#l31.1455"></a><span id="l31.1455" class="difflineplus">+function MsgDeleteMessage(reallyDelete, fromToolbar) {</span>
<a href="#l31.1456"></a><span id="l31.1456">   // If from the toolbar, return right away if this is a news message</span>
<a href="#l31.1457"></a><span id="l31.1457">   // only allow cancel from the menu:  &quot;Edit | Cancel / Delete Message&quot;.</span>
<a href="#l31.1458"></a><span id="l31.1458">   if (fromToolbar &amp;&amp; gFolderDisplay.view.isNewsFolder)</span>
<a href="#l31.1459"></a><span id="l31.1459">     return;</span>
<a href="#l31.1460"></a><span id="l31.1460"> </span>
<a href="#l31.1461"></a><span id="l31.1461">   gFolderDisplay.hintAboutToDeleteMessages();</span>
<a href="#l31.1462"></a><span id="l31.1462">   if (reallyDelete)</span>
<a href="#l31.1463"></a><span id="l31.1463">     gDBView.doCommand(nsMsgViewCommandType.deleteNoTrash);</span>
<a href="#l31.1464"></a><span id="l31.1464">   else</span>
<a href="#l31.1465"></a><span id="l31.1465">     gDBView.doCommand(nsMsgViewCommandType.deleteMsg);</span>
<a href="#l31.1466"></a><span id="l31.1466"> }</span>
<a href="#l31.1467"></a><span id="l31.1467"> </span>
<a href="#l31.1468"></a><span id="l31.1468"> /**</span>
<a href="#l31.1469"></a><span id="l31.1469">  * Copies the selected messages to the destination folder</span>
<a href="#l31.1470"></a><span id="l31.1470">  * @param aDestFolder  the destination folder</span>
<a href="#l31.1471"></a><span id="l31.1471">  */</span>
<a href="#l31.1472"></a><span id="l31.1472" class="difflineminus">-function MsgCopyMessage(aDestFolder)</span>
<a href="#l31.1473"></a><span id="l31.1473" class="difflineminus">-{</span>
<a href="#l31.1474"></a><span id="l31.1474" class="difflineplus">+function MsgCopyMessage(aDestFolder) {</span>
<a href="#l31.1475"></a><span id="l31.1475">   if (gMessageDisplay.isDummy) {</span>
<a href="#l31.1476"></a><span id="l31.1476">     let file = window.arguments[0].QueryInterface(Ci.nsIFileURL).file;</span>
<a href="#l31.1477"></a><span id="l31.1477">     MailServices.copy.CopyFileMessage(file, aDestFolder, null, false,</span>
<a href="#l31.1478"></a><span id="l31.1478">                                       Ci.nsMsgMessageFlags.Read,</span>
<a href="#l31.1479"></a><span id="l31.1479">                                       &quot;&quot;, null, msgWindow);</span>
<a href="#l31.1480"></a><span id="l31.1480" class="difflineplus">+  } else {</span>
<a href="#l31.1481"></a><span id="l31.1481" class="difflineplus">+    gDBView.doCommandWithFolder(nsMsgViewCommandType.copyMessages, aDestFolder);</span>
<a href="#l31.1482"></a><span id="l31.1482">   }</span>
<a href="#l31.1483"></a><span id="l31.1483" class="difflineminus">-  else</span>
<a href="#l31.1484"></a><span id="l31.1484" class="difflineminus">-    gDBView.doCommandWithFolder(nsMsgViewCommandType.copyMessages, aDestFolder);</span>
<a href="#l31.1485"></a><span id="l31.1485"> </span>
<a href="#l31.1486"></a><span id="l31.1486">   Services.prefs.setCharPref(&quot;mail.last_msg_movecopy_target_uri&quot;, aDestFolder.URI);</span>
<a href="#l31.1487"></a><span id="l31.1487">   Services.prefs.setBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;, false);</span>
<a href="#l31.1488"></a><span id="l31.1488"> }</span>
<a href="#l31.1489"></a><span id="l31.1489"> </span>
<a href="#l31.1490"></a><span id="l31.1490"> /**</span>
<a href="#l31.1491"></a><span id="l31.1491">  * Moves the selected messages to the destination folder</span>
<a href="#l31.1492"></a><span id="l31.1492">  * @param aDestFolder  the destination folder</span>
<a href="#l31.1493"></a><span id="l31.1493">  */</span>
<a href="#l31.1494"></a><span id="l31.1494" class="difflineminus">-function MsgMoveMessage(aDestFolder)</span>
<a href="#l31.1495"></a><span id="l31.1495" class="difflineminus">-{</span>
<a href="#l31.1496"></a><span id="l31.1496" class="difflineplus">+function MsgMoveMessage(aDestFolder) {</span>
<a href="#l31.1497"></a><span id="l31.1497">   gFolderDisplay.hintAboutToDeleteMessages();</span>
<a href="#l31.1498"></a><span id="l31.1498">   gDBView.doCommandWithFolder(nsMsgViewCommandType.moveMessages, aDestFolder);</span>
<a href="#l31.1499"></a><span id="l31.1499">   Services.prefs.setCharPref(&quot;mail.last_msg_movecopy_target_uri&quot;, aDestFolder.URI);</span>
<a href="#l31.1500"></a><span id="l31.1500">   Services.prefs.setBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;, true);</span>
<a href="#l31.1501"></a><span id="l31.1501"> }</span>
<a href="#l31.1502"></a><span id="l31.1502"> </span>
<a href="#l31.1503"></a><span id="l31.1503"> /**</span>
<a href="#l31.1504"></a><span id="l31.1504">  * Calls the ComposeMessage function with the desired type, and proper default</span>
<a href="#l31.1505"></a><span id="l31.1505" class="difflineat">@@ -1621,83 +1515,74 @@ function composeMsgByType(aCompType, aEv</span>
<a href="#l31.1506"></a><span id="l31.1506">   // to work out existing folders, so just use null.</span>
<a href="#l31.1507"></a><span id="l31.1507">   let msgFolder = gFolderDisplay ? GetFirstSelectedMsgFolder() : null;</span>
<a href="#l31.1508"></a><span id="l31.1508">   let msgUris = gFolderDisplay ? gFolderDisplay.selectedMessageUris : null;</span>
<a href="#l31.1509"></a><span id="l31.1509"> </span>
<a href="#l31.1510"></a><span id="l31.1510">   if (aEvent &amp;&amp; aEvent.shiftKey) {</span>
<a href="#l31.1511"></a><span id="l31.1511">     ComposeMessage(aCompType,</span>
<a href="#l31.1512"></a><span id="l31.1512">                    Ci.nsIMsgCompFormat.OppositeOfDefault,</span>
<a href="#l31.1513"></a><span id="l31.1513">                    msgFolder, msgUris);</span>
<a href="#l31.1514"></a><span id="l31.1514" class="difflineminus">-  }</span>
<a href="#l31.1515"></a><span id="l31.1515" class="difflineminus">-  else {</span>
<a href="#l31.1516"></a><span id="l31.1516" class="difflineplus">+  } else {</span>
<a href="#l31.1517"></a><span id="l31.1517">     ComposeMessage(aCompType, Ci.nsIMsgCompFormat.Default,</span>
<a href="#l31.1518"></a><span id="l31.1518">                    msgFolder, msgUris);</span>
<a href="#l31.1519"></a><span id="l31.1519">   }</span>
<a href="#l31.1520"></a><span id="l31.1520"> }</span>
<a href="#l31.1521"></a><span id="l31.1521"> </span>
<a href="#l31.1522"></a><span id="l31.1522" class="difflineminus">-function MsgNewMessage(event)</span>
<a href="#l31.1523"></a><span id="l31.1523" class="difflineminus">-{</span>
<a href="#l31.1524"></a><span id="l31.1524" class="difflineplus">+function MsgNewMessage(event) {</span>
<a href="#l31.1525"></a><span id="l31.1525">   composeMsgByType(Ci.nsIMsgCompType.New, event);</span>
<a href="#l31.1526"></a><span id="l31.1526"> }</span>
<a href="#l31.1527"></a><span id="l31.1527"> </span>
<a href="#l31.1528"></a><span id="l31.1528" class="difflineminus">-function CanComposeMessages()</span>
<a href="#l31.1529"></a><span id="l31.1529" class="difflineminus">-{</span>
<a href="#l31.1530"></a><span id="l31.1530" class="difflineplus">+function CanComposeMessages() {</span>
<a href="#l31.1531"></a><span id="l31.1531">   return MailServices.accounts.allIdentities.length &gt; 0;</span>
<a href="#l31.1532"></a><span id="l31.1532"> }</span>
<a href="#l31.1533"></a><span id="l31.1533"> </span>
<a href="#l31.1534"></a><span id="l31.1534" class="difflineminus">-function MsgReplyMessage(event)</span>
<a href="#l31.1535"></a><span id="l31.1535" class="difflineminus">-{</span>
<a href="#l31.1536"></a><span id="l31.1536" class="difflineplus">+function MsgReplyMessage(event) {</span>
<a href="#l31.1537"></a><span id="l31.1537">   if (gFolderDisplay.selectedMessageIsNews)</span>
<a href="#l31.1538"></a><span id="l31.1538">     MsgReplyGroup(event);</span>
<a href="#l31.1539"></a><span id="l31.1539">   else</span>
<a href="#l31.1540"></a><span id="l31.1540">     MsgReplySender(event);</span>
<a href="#l31.1541"></a><span id="l31.1541"> }</span>
<a href="#l31.1542"></a><span id="l31.1542"> </span>
<a href="#l31.1543"></a><span id="l31.1543" class="difflineminus">-function MsgReplySender(event)</span>
<a href="#l31.1544"></a><span id="l31.1544" class="difflineminus">-{</span>
<a href="#l31.1545"></a><span id="l31.1545" class="difflineplus">+function MsgReplySender(event) {</span>
<a href="#l31.1546"></a><span id="l31.1546">   composeMsgByType(Ci.nsIMsgCompType.ReplyToSender, event);</span>
<a href="#l31.1547"></a><span id="l31.1547"> }</span>
<a href="#l31.1548"></a><span id="l31.1548"> </span>
<a href="#l31.1549"></a><span id="l31.1549" class="difflineminus">-function MsgReplyGroup(event)</span>
<a href="#l31.1550"></a><span id="l31.1550" class="difflineminus">-{</span>
<a href="#l31.1551"></a><span id="l31.1551" class="difflineplus">+function MsgReplyGroup(event) {</span>
<a href="#l31.1552"></a><span id="l31.1552">   composeMsgByType(Ci.nsIMsgCompType.ReplyToGroup, event);</span>
<a href="#l31.1553"></a><span id="l31.1553"> }</span>
<a href="#l31.1554"></a><span id="l31.1554"> </span>
<a href="#l31.1555"></a><span id="l31.1555" class="difflineminus">-function MsgReplyToAllMessage(event)</span>
<a href="#l31.1556"></a><span id="l31.1556" class="difflineminus">-{</span>
<a href="#l31.1557"></a><span id="l31.1557" class="difflineplus">+function MsgReplyToAllMessage(event) {</span>
<a href="#l31.1558"></a><span id="l31.1558">   composeMsgByType(Ci.nsIMsgCompType.ReplyAll, event);</span>
<a href="#l31.1559"></a><span id="l31.1559"> }</span>
<a href="#l31.1560"></a><span id="l31.1560"> </span>
<a href="#l31.1561"></a><span id="l31.1561" class="difflineminus">-function MsgReplyToListMessage(event)</span>
<a href="#l31.1562"></a><span id="l31.1562" class="difflineminus">-{</span>
<a href="#l31.1563"></a><span id="l31.1563" class="difflineplus">+function MsgReplyToListMessage(event) {</span>
<a href="#l31.1564"></a><span id="l31.1564">   composeMsgByType(Ci.nsIMsgCompType.ReplyToList, event);</span>
<a href="#l31.1565"></a><span id="l31.1565"> }</span>
<a href="#l31.1566"></a><span id="l31.1566"> </span>
<a href="#l31.1567"></a><span id="l31.1567"> // Message Archive function</span>
<a href="#l31.1568"></a><span id="l31.1568"> </span>
<a href="#l31.1569"></a><span id="l31.1569"> function BatchMessageMover() {</span>
<a href="#l31.1570"></a><span id="l31.1570">   this._batches = {};</span>
<a href="#l31.1571"></a><span id="l31.1571">   this._currentKey = null;</span>
<a href="#l31.1572"></a><span id="l31.1572">   this._dstFolderParent = null;</span>
<a href="#l31.1573"></a><span id="l31.1573">   this._dstFolderName = null;</span>
<a href="#l31.1574"></a><span id="l31.1574"> }</span>
<a href="#l31.1575"></a><span id="l31.1575"> </span>
<a href="#l31.1576"></a><span id="l31.1576"> BatchMessageMover.prototype = {</span>
<a href="#l31.1577"></a><span id="l31.1577"> </span>
<a href="#l31.1578"></a><span id="l31.1578" class="difflineminus">-  archiveMessages: function (aMsgHdrs) {</span>
<a href="#l31.1579"></a><span id="l31.1579" class="difflineplus">+  archiveMessages(aMsgHdrs) {</span>
<a href="#l31.1580"></a><span id="l31.1580"> </span>
<a href="#l31.1581"></a><span id="l31.1581">     if (!aMsgHdrs.length)</span>
<a href="#l31.1582"></a><span id="l31.1582">       return;</span>
<a href="#l31.1583"></a><span id="l31.1583"> </span>
<a href="#l31.1584"></a><span id="l31.1584">     gFolderDisplay.hintMassMoveStarting();</span>
<a href="#l31.1585"></a><span id="l31.1585">     for (let i = 0; i &lt; aMsgHdrs.length; i++) {</span>
<a href="#l31.1586"></a><span id="l31.1586">       let msgHdr = aMsgHdrs[i];</span>
<a href="#l31.1587"></a><span id="l31.1587"> </span>
<a href="#l31.1588"></a><span id="l31.1588">       let server = msgHdr.folder.server;</span>
<a href="#l31.1589"></a><span id="l31.1589" class="difflineminus">-      let rootFolder = server.rootFolder;</span>
<a href="#l31.1590"></a><span id="l31.1590"> </span>
<a href="#l31.1591"></a><span id="l31.1591">       // Convert date to JS date object.</span>
<a href="#l31.1592"></a><span id="l31.1592">       let msgDate = new Date(msgHdr.date / 1000);</span>
<a href="#l31.1593"></a><span id="l31.1593">       let msgYear = msgDate.getFullYear().toString();</span>
<a href="#l31.1594"></a><span id="l31.1594">       let monthFolderName = msgYear + &quot;-&quot; + (msgDate.getMonth() + 1).toString().padStart(2, &quot;0&quot;);</span>
<a href="#l31.1595"></a><span id="l31.1595"> </span>
<a href="#l31.1596"></a><span id="l31.1596">       let archiveFolderURI;</span>
<a href="#l31.1597"></a><span id="l31.1597">       let archiveGranularity;</span>
<a href="#l31.1598"></a><span id="l31.1598" class="difflineat">@@ -1716,101 +1601,99 @@ BatchMessageMover.prototype = {</span>
<a href="#l31.1599"></a><span id="l31.1599"> </span>
<a href="#l31.1600"></a><span id="l31.1600">         archiveFolderURI = server.serverURI + &quot;/Archives&quot;;</span>
<a href="#l31.1601"></a><span id="l31.1601">         archiveGranularity = Services.prefs.getIntPref(</span>
<a href="#l31.1602"></a><span id="l31.1602">           &quot;mail.identity.default.archive_granularity&quot;</span>
<a href="#l31.1603"></a><span id="l31.1603">         );</span>
<a href="#l31.1604"></a><span id="l31.1604">         archiveKeepFolderStructure = Services.prefs.getBoolPref(</span>
<a href="#l31.1605"></a><span id="l31.1605">           &quot;mail.identity.default.archive_keep_folder_structure&quot;</span>
<a href="#l31.1606"></a><span id="l31.1606">         );</span>
<a href="#l31.1607"></a><span id="l31.1607" class="difflineminus">-      }</span>
<a href="#l31.1608"></a><span id="l31.1608" class="difflineminus">-      else {</span>
<a href="#l31.1609"></a><span id="l31.1609" class="difflineplus">+      } else {</span>
<a href="#l31.1610"></a><span id="l31.1610">         if (!identity.archiveEnabled)</span>
<a href="#l31.1611"></a><span id="l31.1611">           continue;</span>
<a href="#l31.1612"></a><span id="l31.1612"> </span>
<a href="#l31.1613"></a><span id="l31.1613">         archiveFolderURI = identity.archiveFolder;</span>
<a href="#l31.1614"></a><span id="l31.1614">         archiveGranularity = identity.archiveGranularity;</span>
<a href="#l31.1615"></a><span id="l31.1615">         archiveKeepFolderStructure = identity.archiveKeepFolderStructure;</span>
<a href="#l31.1616"></a><span id="l31.1616">       }</span>
<a href="#l31.1617"></a><span id="l31.1617"> </span>
<a href="#l31.1618"></a><span id="l31.1618">       let copyBatchKey = msgHdr.folder.URI;</span>
<a href="#l31.1619"></a><span id="l31.1619">       if (archiveGranularity &gt;= Ci.nsIMsgIdentity</span>
<a href="#l31.1620"></a><span id="l31.1620">                                   .perYearArchiveFolders)</span>
<a href="#l31.1621"></a><span id="l31.1621" class="difflineminus">-        copyBatchKey += '\0' + msgYear;</span>
<a href="#l31.1622"></a><span id="l31.1622" class="difflineplus">+        copyBatchKey += &quot;\0&quot; + msgYear;</span>
<a href="#l31.1623"></a><span id="l31.1623"> </span>
<a href="#l31.1624"></a><span id="l31.1624">       if (archiveGranularity &gt;= Ci.nsIMsgIdentity</span>
<a href="#l31.1625"></a><span id="l31.1625">                                   .perMonthArchiveFolders)</span>
<a href="#l31.1626"></a><span id="l31.1626" class="difflineminus">-        copyBatchKey += '\0' + monthFolderName;</span>
<a href="#l31.1627"></a><span id="l31.1627" class="difflineplus">+        copyBatchKey += &quot;\0&quot; + monthFolderName;</span>
<a href="#l31.1628"></a><span id="l31.1628"> </span>
<a href="#l31.1629"></a><span id="l31.1629">       if (archiveKeepFolderStructure)</span>
<a href="#l31.1630"></a><span id="l31.1630">         copyBatchKey += msgHdr.folder.URI;</span>
<a href="#l31.1631"></a><span id="l31.1631"> </span>
<a href="#l31.1632"></a><span id="l31.1632">       // Add a key to copyBatchKey</span>
<a href="#l31.1633"></a><span id="l31.1633">       if (!(copyBatchKey in this._batches)) {</span>
<a href="#l31.1634"></a><span id="l31.1634">         this._batches[copyBatchKey] = {</span>
<a href="#l31.1635"></a><span id="l31.1635">           srcFolder: msgHdr.folder,</span>
<a href="#l31.1636"></a><span id="l31.1636" class="difflineminus">-          archiveFolderURI: archiveFolderURI,</span>
<a href="#l31.1637"></a><span id="l31.1637" class="difflineplus">+          archiveFolderURI,</span>
<a href="#l31.1638"></a><span id="l31.1638">           granularity: archiveGranularity,</span>
<a href="#l31.1639"></a><span id="l31.1639">           keepFolderStructure: archiveKeepFolderStructure,</span>
<a href="#l31.1640"></a><span id="l31.1640">           yearFolderName: msgYear,</span>
<a href="#l31.1641"></a><span id="l31.1641" class="difflineminus">-          monthFolderName: monthFolderName,</span>
<a href="#l31.1642"></a><span id="l31.1642" class="difflineplus">+          monthFolderName,</span>
<a href="#l31.1643"></a><span id="l31.1643">           messages: [],</span>
<a href="#l31.1644"></a><span id="l31.1644">         };</span>
<a href="#l31.1645"></a><span id="l31.1645">       }</span>
<a href="#l31.1646"></a><span id="l31.1646">       this._batches[copyBatchKey].messages.push(msgHdr);</span>
<a href="#l31.1647"></a><span id="l31.1647">     }</span>
<a href="#l31.1648"></a><span id="l31.1648">     MailServices.mfn.addListener(this, MailServices.mfn.folderAdded);</span>
<a href="#l31.1649"></a><span id="l31.1649"> </span>
<a href="#l31.1650"></a><span id="l31.1650">     // Now we launch the code iterating over all message copies, one in turn.</span>
<a href="#l31.1651"></a><span id="l31.1651">     this.processNextBatch();</span>
<a href="#l31.1652"></a><span id="l31.1652">   },</span>
<a href="#l31.1653"></a><span id="l31.1653"> </span>
<a href="#l31.1654"></a><span id="l31.1654" class="difflineminus">-  processNextBatch: function () {</span>
<a href="#l31.1655"></a><span id="l31.1655" class="difflineplus">+  processNextBatch() {</span>
<a href="#l31.1656"></a><span id="l31.1656">     // get the first defined key and value</span>
<a href="#l31.1657"></a><span id="l31.1657">     for (let key in this._batches) {</span>
<a href="#l31.1658"></a><span id="l31.1658">       this._currentBatch = this._batches[key];</span>
<a href="#l31.1659"></a><span id="l31.1659">       delete this._batches[key];</span>
<a href="#l31.1660"></a><span id="l31.1660" class="difflineminus">-      return this.filterBatch();</span>
<a href="#l31.1661"></a><span id="l31.1661" class="difflineplus">+      this.filterBatch();</span>
<a href="#l31.1662"></a><span id="l31.1662" class="difflineplus">+      return;</span>
<a href="#l31.1663"></a><span id="l31.1663">     }</span>
<a href="#l31.1664"></a><span id="l31.1664">     this._batches = null;</span>
<a href="#l31.1665"></a><span id="l31.1665">     gFolderDisplay.hintMassMoveCompleted();</span>
<a href="#l31.1666"></a><span id="l31.1666">     MailServices.mfn.removeListener(this);</span>
<a href="#l31.1667"></a><span id="l31.1667">     // all done</span>
<a href="#l31.1668"></a><span id="l31.1668" class="difflineminus">-    return;</span>
<a href="#l31.1669"></a><span id="l31.1669">   },</span>
<a href="#l31.1670"></a><span id="l31.1670"> </span>
<a href="#l31.1671"></a><span id="l31.1671" class="difflineminus">-  filterBatch: function () {</span>
<a href="#l31.1672"></a><span id="l31.1672" class="difflineplus">+  filterBatch() {</span>
<a href="#l31.1673"></a><span id="l31.1673">     let batch = this._currentBatch;</span>
<a href="#l31.1674"></a><span id="l31.1674"> </span>
<a href="#l31.1675"></a><span id="l31.1675">     let filterArray = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l31.1676"></a><span id="l31.1676">                         .createInstance(Ci.nsIMutableArray);</span>
<a href="#l31.1677"></a><span id="l31.1677">     for (let message of batch.messages) {</span>
<a href="#l31.1678"></a><span id="l31.1678">       filterArray.appendElement(message);</span>
<a href="#l31.1679"></a><span id="l31.1679">     }</span>
<a href="#l31.1680"></a><span id="l31.1680"> </span>
<a href="#l31.1681"></a><span id="l31.1681">     // Apply filters to this batch.</span>
<a href="#l31.1682"></a><span id="l31.1682">     MailServices.filters.applyFilters(</span>
<a href="#l31.1683"></a><span id="l31.1683">       Ci.nsMsgFilterType.Archive,</span>
<a href="#l31.1684"></a><span id="l31.1684">       filterArray, batch.srcFolder, msgWindow, this);</span>
<a href="#l31.1685"></a><span id="l31.1685" class="difflineminus">-    return; // continues with onStopOperation</span>
<a href="#l31.1686"></a><span id="l31.1686" class="difflineplus">+    // continues with onStopOperation</span>
<a href="#l31.1687"></a><span id="l31.1687">   },</span>
<a href="#l31.1688"></a><span id="l31.1688"> </span>
<a href="#l31.1689"></a><span id="l31.1689" class="difflineminus">-  onStopOperation: function (aResult) {</span>
<a href="#l31.1690"></a><span id="l31.1690" class="difflineminus">-    if (!Components.isSuccessCode(aResult))</span>
<a href="#l31.1691"></a><span id="l31.1691" class="difflineminus">-    {</span>
<a href="#l31.1692"></a><span id="l31.1692" class="difflineplus">+  onStopOperation(aResult) {</span>
<a href="#l31.1693"></a><span id="l31.1693" class="difflineplus">+    if (!Components.isSuccessCode(aResult)) {</span>
<a href="#l31.1694"></a><span id="l31.1694">       Cu.reportError(&quot;Archive filter failed: &quot; + aResult);</span>
<a href="#l31.1695"></a><span id="l31.1695">       // We don't want to effectively disable archiving because a filter</span>
<a href="#l31.1696"></a><span id="l31.1696">       // failed, so we'll continue after reporting the error.</span>
<a href="#l31.1697"></a><span id="l31.1697">     }</span>
<a href="#l31.1698"></a><span id="l31.1698">     // Now do the default archive processing</span>
<a href="#l31.1699"></a><span id="l31.1699">     this.continueBatch();</span>
<a href="#l31.1700"></a><span id="l31.1700">   },</span>
<a href="#l31.1701"></a><span id="l31.1701"> </span>
<a href="#l31.1702"></a><span id="l31.1702">   // continue processing of default archive operations</span>
<a href="#l31.1703"></a><span id="l31.1703" class="difflineminus">-  continueBatch: function () {</span>
<a href="#l31.1704"></a><span id="l31.1704" class="difflineplus">+  continueBatch() {</span>
<a href="#l31.1705"></a><span id="l31.1705">       let batch = this._currentBatch;</span>
<a href="#l31.1706"></a><span id="l31.1706">       let srcFolder = batch.srcFolder;</span>
<a href="#l31.1707"></a><span id="l31.1707">       let archiveFolderURI = batch.archiveFolderURI;</span>
<a href="#l31.1708"></a><span id="l31.1708">       let archiveFolder = MailUtils.getFolderForURI(archiveFolderURI, false);</span>
<a href="#l31.1709"></a><span id="l31.1709">       let dstFolder = archiveFolder;</span>
<a href="#l31.1710"></a><span id="l31.1710"> </span>
<a href="#l31.1711"></a><span id="l31.1711">       let moveArray = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l31.1712"></a><span id="l31.1712">                         .createInstance(Ci.nsIMutableArray);</span>
<a href="#l31.1713"></a><span id="l31.1713" class="difflineat">@@ -1819,17 +1702,17 @@ BatchMessageMover.prototype = {</span>
<a href="#l31.1714"></a><span id="l31.1714">         if (srcFolder.msgDatabase.ContainsKey(item.messageKey) &amp;&amp;</span>
<a href="#l31.1715"></a><span id="l31.1715">             !(srcFolder.getProcessingFlags(item.messageKey) &amp;</span>
<a href="#l31.1716"></a><span id="l31.1716">               Ci.nsMsgProcessingFlags.FilterToMove)) {</span>
<a href="#l31.1717"></a><span id="l31.1717">           moveArray.appendElement(item);</span>
<a href="#l31.1718"></a><span id="l31.1718">         }</span>
<a href="#l31.1719"></a><span id="l31.1719">       }</span>
<a href="#l31.1720"></a><span id="l31.1720"> </span>
<a href="#l31.1721"></a><span id="l31.1721">       if (moveArray.length == 0)</span>
<a href="#l31.1722"></a><span id="l31.1722" class="difflineminus">-        return this.processNextBatch(); // continue processing</span>
<a href="#l31.1723"></a><span id="l31.1723" class="difflineplus">+        this.processNextBatch(); // continue processing</span>
<a href="#l31.1724"></a><span id="l31.1724"> </span>
<a href="#l31.1725"></a><span id="l31.1725">       // For folders on some servers (e.g. IMAP), we need to create the</span>
<a href="#l31.1726"></a><span id="l31.1726">       // sub-folders asynchronously, so we chain the urls using the listener</span>
<a href="#l31.1727"></a><span id="l31.1727">       // called back from createStorageIfMissing. For local,</span>
<a href="#l31.1728"></a><span id="l31.1728">       // createStorageIfMissing is synchronous.</span>
<a href="#l31.1729"></a><span id="l31.1729">       let isAsync = archiveFolder.server.protocolInfo.foldersCreatedAsync;</span>
<a href="#l31.1730"></a><span id="l31.1730">       if (!archiveFolder.parent) {</span>
<a href="#l31.1731"></a><span id="l31.1731">         archiveFolder.setFlag(Ci.nsMsgFolderFlags.Archive);</span>
<a href="#l31.1732"></a><span id="l31.1732" class="difflineat">@@ -1901,289 +1784,259 @@ BatchMessageMover.prototype = {</span>
<a href="#l31.1733"></a><span id="l31.1733">         // If the source folder doesn't support deleting messages, we</span>
<a href="#l31.1734"></a><span id="l31.1734">         // make archive a copy, not a move.</span>
<a href="#l31.1735"></a><span id="l31.1735">         MailServices.copy.CopyMessages(</span>
<a href="#l31.1736"></a><span id="l31.1736">           srcFolder, moveArray, dstFolder,</span>
<a href="#l31.1737"></a><span id="l31.1737">           srcFolder.canDeleteMessages, this, msgWindow, true</span>
<a href="#l31.1738"></a><span id="l31.1738">         );</span>
<a href="#l31.1739"></a><span id="l31.1739">         return; // continues with OnStopCopy</span>
<a href="#l31.1740"></a><span id="l31.1740">       }</span>
<a href="#l31.1741"></a><span id="l31.1741" class="difflineminus">-      return this.processNextBatch(); // next batch</span>
<a href="#l31.1742"></a><span id="l31.1742" class="difflineplus">+      this.processNextBatch(); // next batch</span>
<a href="#l31.1743"></a><span id="l31.1743">     },</span>
<a href="#l31.1744"></a><span id="l31.1744"> </span>
<a href="#l31.1745"></a><span id="l31.1745" class="difflineminus">-  OnStartRunningUrl: function(url) {},</span>
<a href="#l31.1746"></a><span id="l31.1746" class="difflineminus">-  OnStopRunningUrl: function(url, exitCode) {</span>
<a href="#l31.1747"></a><span id="l31.1747" class="difflineplus">+  OnStartRunningUrl(url) {},</span>
<a href="#l31.1748"></a><span id="l31.1748" class="difflineplus">+  OnStopRunningUrl(url, exitCode) {</span>
<a href="#l31.1749"></a><span id="l31.1749">     // this will always be a create folder url, afaik.</span>
<a href="#l31.1750"></a><span id="l31.1750" class="difflineminus">-    if (Components.isSuccessCode(exitCode))</span>
<a href="#l31.1751"></a><span id="l31.1751" class="difflineplus">+    if (Components.isSuccessCode(exitCode)) {</span>
<a href="#l31.1752"></a><span id="l31.1752">       this.continueBatch();</span>
<a href="#l31.1753"></a><span id="l31.1753" class="difflineminus">-    else {</span>
<a href="#l31.1754"></a><span id="l31.1754" class="difflineplus">+    } else {</span>
<a href="#l31.1755"></a><span id="l31.1755">       Cu.reportError(&quot;Archive failed to create folder: &quot; + exitCode);</span>
<a href="#l31.1756"></a><span id="l31.1756">       this._batches = null;</span>
<a href="#l31.1757"></a><span id="l31.1757">       this.processNextBatch(); // for cleanup and exit</span>
<a href="#l31.1758"></a><span id="l31.1758">     }</span>
<a href="#l31.1759"></a><span id="l31.1759">   },</span>
<a href="#l31.1760"></a><span id="l31.1760"> </span>
<a href="#l31.1761"></a><span id="l31.1761">   // also implements nsIMsgCopyServiceListener, but we only care</span>
<a href="#l31.1762"></a><span id="l31.1762">   // about the OnStopCopy</span>
<a href="#l31.1763"></a><span id="l31.1763" class="difflineminus">-  OnStartCopy: function() {},</span>
<a href="#l31.1764"></a><span id="l31.1764" class="difflineminus">-  OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l31.1765"></a><span id="l31.1765" class="difflineminus">-  SetMessageKey: function(aKey) {},</span>
<a href="#l31.1766"></a><span id="l31.1766" class="difflineminus">-  GetMessageId: function() {},</span>
<a href="#l31.1767"></a><span id="l31.1767" class="difflineminus">-  OnStopCopy: function(aStatus) {</span>
<a href="#l31.1768"></a><span id="l31.1768" class="difflineplus">+  OnStartCopy() {},</span>
<a href="#l31.1769"></a><span id="l31.1769" class="difflineplus">+  OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l31.1770"></a><span id="l31.1770" class="difflineplus">+  SetMessageKey(aKey) {},</span>
<a href="#l31.1771"></a><span id="l31.1771" class="difflineplus">+  GetMessageId() {},</span>
<a href="#l31.1772"></a><span id="l31.1772" class="difflineplus">+  OnStopCopy(aStatus) {</span>
<a href="#l31.1773"></a><span id="l31.1773">     if (Components.isSuccessCode(aStatus))</span>
<a href="#l31.1774"></a><span id="l31.1774" class="difflineminus">-      return this.processNextBatch();</span>
<a href="#l31.1775"></a><span id="l31.1775" class="difflineplus">+      this.processNextBatch();</span>
<a href="#l31.1776"></a><span id="l31.1776"> </span>
<a href="#l31.1777"></a><span id="l31.1777">     // stop on error</span>
<a href="#l31.1778"></a><span id="l31.1778">     Cu.reportError(&quot;Archive failed to copy: &quot; + aStatus);</span>
<a href="#l31.1779"></a><span id="l31.1779">     this._batches = null;</span>
<a href="#l31.1780"></a><span id="l31.1780">     this.processNextBatch(); // for cleanup and exit</span>
<a href="#l31.1781"></a><span id="l31.1781">   },</span>
<a href="#l31.1782"></a><span id="l31.1782"> </span>
<a href="#l31.1783"></a><span id="l31.1783">   // This also implements nsIMsgFolderListener, but we only care about the</span>
<a href="#l31.1784"></a><span id="l31.1784">   // folderAdded (createSubfolder callback).</span>
<a href="#l31.1785"></a><span id="l31.1785" class="difflineminus">-  folderAdded: function(aFolder) {</span>
<a href="#l31.1786"></a><span id="l31.1786" class="difflineplus">+  folderAdded(aFolder) {</span>
<a href="#l31.1787"></a><span id="l31.1787">     // Check that this is the folder we're interested in.</span>
<a href="#l31.1788"></a><span id="l31.1788">     if (aFolder.parent == this._dstFolderParent &amp;&amp;</span>
<a href="#l31.1789"></a><span id="l31.1789">         aFolder.name == this._dstFolderName) {</span>
<a href="#l31.1790"></a><span id="l31.1790">       this._dstFolderParent = null;</span>
<a href="#l31.1791"></a><span id="l31.1791">       this._dstFolderName = null;</span>
<a href="#l31.1792"></a><span id="l31.1792">       this.continueBatch();</span>
<a href="#l31.1793"></a><span id="l31.1793">     }</span>
<a href="#l31.1794"></a><span id="l31.1794">   },</span>
<a href="#l31.1795"></a><span id="l31.1795"> </span>
<a href="#l31.1796"></a><span id="l31.1796">   QueryInterface: ChromeUtils.generateQI([&quot;nsIUrlListener&quot;,</span>
<a href="#l31.1797"></a><span id="l31.1797">                                           &quot;nsIMsgCopyServiceListener&quot;,</span>
<a href="#l31.1798"></a><span id="l31.1798">                                           &quot;nsIMsgOperationListener&quot;]),</span>
<a href="#l31.1799"></a><span id="l31.1799" class="difflineminus">-}</span>
<a href="#l31.1800"></a><span id="l31.1800" class="difflineplus">+};</span>
<a href="#l31.1801"></a><span id="l31.1801"> </span>
<a href="#l31.1802"></a><span id="l31.1802"> /**</span>
<a href="#l31.1803"></a><span id="l31.1803">  * Archives the selected messages</span>
<a href="#l31.1804"></a><span id="l31.1804">  *</span>
<a href="#l31.1805"></a><span id="l31.1805">  * @param event the event that caused us to call this function</span>
<a href="#l31.1806"></a><span id="l31.1806">  */</span>
<a href="#l31.1807"></a><span id="l31.1807" class="difflineminus">-function MsgArchiveSelectedMessages(event)</span>
<a href="#l31.1808"></a><span id="l31.1808" class="difflineminus">-{</span>
<a href="#l31.1809"></a><span id="l31.1809" class="difflineplus">+function MsgArchiveSelectedMessages(event) {</span>
<a href="#l31.1810"></a><span id="l31.1810">   let batchMover = new BatchMessageMover();</span>
<a href="#l31.1811"></a><span id="l31.1811">   batchMover.archiveMessages(gFolderDisplay.selectedMessages);</span>
<a href="#l31.1812"></a><span id="l31.1812"> }</span>
<a href="#l31.1813"></a><span id="l31.1813"> </span>
<a href="#l31.1814"></a><span id="l31.1814" class="difflineminus">-function MsgForwardMessage(event)</span>
<a href="#l31.1815"></a><span id="l31.1815" class="difflineminus">-{</span>
<a href="#l31.1816"></a><span id="l31.1816" class="difflineminus">-  var forwardType = 0;</span>
<a href="#l31.1817"></a><span id="l31.1817" class="difflineminus">-  try {</span>
<a href="#l31.1818"></a><span id="l31.1818" class="difflineminus">-    forwardType = Services.prefs.getIntPref(&quot;mail.forward_message_mode&quot;);</span>
<a href="#l31.1819"></a><span id="l31.1819" class="difflineminus">-  }</span>
<a href="#l31.1820"></a><span id="l31.1820" class="difflineminus">-  catch (ex) {</span>
<a href="#l31.1821"></a><span id="l31.1821" class="difflineminus">-    dump(&quot;failed to retrieve pref mail.forward_message_mode&quot;);</span>
<a href="#l31.1822"></a><span id="l31.1822" class="difflineminus">-  }</span>
<a href="#l31.1823"></a><span id="l31.1823" class="difflineplus">+function MsgForwardMessage(event) {</span>
<a href="#l31.1824"></a><span id="l31.1824" class="difflineplus">+  var forwardType = Services.prefs.getIntPref(&quot;mail.forward_message_mode&quot;, 0);</span>
<a href="#l31.1825"></a><span id="l31.1825"> </span>
<a href="#l31.1826"></a><span id="l31.1826">   // mail.forward_message_mode could be 1, if the user migrated from 4.x</span>
<a href="#l31.1827"></a><span id="l31.1827">   // 1 (forward as quoted) is obsolete, so we treat is as forward inline</span>
<a href="#l31.1828"></a><span id="l31.1828">   // since that is more like forward as quoted then forward as attachment</span>
<a href="#l31.1829"></a><span id="l31.1829">   if (forwardType == 0)</span>
<a href="#l31.1830"></a><span id="l31.1830">     MsgForwardAsAttachment(event);</span>
<a href="#l31.1831"></a><span id="l31.1831">   else</span>
<a href="#l31.1832"></a><span id="l31.1832">     MsgForwardAsInline(event);</span>
<a href="#l31.1833"></a><span id="l31.1833"> }</span>
<a href="#l31.1834"></a><span id="l31.1834"> </span>
<a href="#l31.1835"></a><span id="l31.1835" class="difflineminus">-function MsgForwardAsAttachment(event)</span>
<a href="#l31.1836"></a><span id="l31.1836" class="difflineminus">-{</span>
<a href="#l31.1837"></a><span id="l31.1837" class="difflineplus">+function MsgForwardAsAttachment(event) {</span>
<a href="#l31.1838"></a><span id="l31.1838">   composeMsgByType(Ci.nsIMsgCompType.ForwardAsAttachment, event);</span>
<a href="#l31.1839"></a><span id="l31.1839"> }</span>
<a href="#l31.1840"></a><span id="l31.1840"> </span>
<a href="#l31.1841"></a><span id="l31.1841" class="difflineminus">-function MsgForwardAsInline(event)</span>
<a href="#l31.1842"></a><span id="l31.1842" class="difflineminus">-{</span>
<a href="#l31.1843"></a><span id="l31.1843" class="difflineplus">+function MsgForwardAsInline(event) {</span>
<a href="#l31.1844"></a><span id="l31.1844">   composeMsgByType(Ci.nsIMsgCompType.ForwardInline, event);</span>
<a href="#l31.1845"></a><span id="l31.1845"> }</span>
<a href="#l31.1846"></a><span id="l31.1846"> </span>
<a href="#l31.1847"></a><span id="l31.1847" class="difflineminus">-function MsgEditMessageAsNew(aEvent)</span>
<a href="#l31.1848"></a><span id="l31.1848" class="difflineminus">-{</span>
<a href="#l31.1849"></a><span id="l31.1849" class="difflineplus">+function MsgEditMessageAsNew(aEvent) {</span>
<a href="#l31.1850"></a><span id="l31.1850">   composeMsgByType(Ci.nsIMsgCompType.EditAsNew, aEvent);</span>
<a href="#l31.1851"></a><span id="l31.1851"> }</span>
<a href="#l31.1852"></a><span id="l31.1852"> </span>
<a href="#l31.1853"></a><span id="l31.1853" class="difflineminus">-function MsgEditDraftMessage(aEvent)</span>
<a href="#l31.1854"></a><span id="l31.1854" class="difflineminus">-{</span>
<a href="#l31.1855"></a><span id="l31.1855" class="difflineplus">+function MsgEditDraftMessage(aEvent) {</span>
<a href="#l31.1856"></a><span id="l31.1856">   composeMsgByType(Ci.nsIMsgCompType.Draft, aEvent);</span>
<a href="#l31.1857"></a><span id="l31.1857"> }</span>
<a href="#l31.1858"></a><span id="l31.1858"> </span>
<a href="#l31.1859"></a><span id="l31.1859" class="difflineminus">-function MsgNewMessageFromTemplate(aEvent)</span>
<a href="#l31.1860"></a><span id="l31.1860" class="difflineminus">-{</span>
<a href="#l31.1861"></a><span id="l31.1861" class="difflineplus">+function MsgNewMessageFromTemplate(aEvent) {</span>
<a href="#l31.1862"></a><span id="l31.1862">   composeMsgByType(Ci.nsIMsgCompType.Template, aEvent);</span>
<a href="#l31.1863"></a><span id="l31.1863"> }</span>
<a href="#l31.1864"></a><span id="l31.1864"> </span>
<a href="#l31.1865"></a><span id="l31.1865" class="difflineminus">-function MsgEditTemplateMessage(aEvent)</span>
<a href="#l31.1866"></a><span id="l31.1866" class="difflineminus">-{</span>
<a href="#l31.1867"></a><span id="l31.1867" class="difflineplus">+function MsgEditTemplateMessage(aEvent) {</span>
<a href="#l31.1868"></a><span id="l31.1868">   composeMsgByType(Ci.nsIMsgCompType.EditTemplate, aEvent);</span>
<a href="#l31.1869"></a><span id="l31.1869"> }</span>
<a href="#l31.1870"></a><span id="l31.1870"> </span>
<a href="#l31.1871"></a><span id="l31.1871" class="difflineminus">-function MsgComposeDraftMessage()</span>
<a href="#l31.1872"></a><span id="l31.1872" class="difflineminus">-{</span>
<a href="#l31.1873"></a><span id="l31.1873" class="difflineplus">+function MsgComposeDraftMessage() {</span>
<a href="#l31.1874"></a><span id="l31.1874">   ComposeMessage(Ci.nsIMsgCompType.Draft,</span>
<a href="#l31.1875"></a><span id="l31.1875">                  Ci.nsIMsgCompFormat.Default,</span>
<a href="#l31.1876"></a><span id="l31.1876">                  gFolderDisplay.displayedFolder,</span>
<a href="#l31.1877"></a><span id="l31.1877">                  gFolderDisplay.selectedMessageUris);</span>
<a href="#l31.1878"></a><span id="l31.1878"> }</span>
<a href="#l31.1879"></a><span id="l31.1879"> </span>
<a href="#l31.1880"></a><span id="l31.1880" class="difflineminus">-function MsgCreateFilter()</span>
<a href="#l31.1881"></a><span id="l31.1881" class="difflineminus">-{</span>
<a href="#l31.1882"></a><span id="l31.1882" class="difflineplus">+function MsgCreateFilter() {</span>
<a href="#l31.1883"></a><span id="l31.1883">   // retrieve Sender direct from selected message's headers</span>
<a href="#l31.1884"></a><span id="l31.1884">   var msgHdr = gFolderDisplay.selectedMessage;</span>
<a href="#l31.1885"></a><span id="l31.1885">   let emailAddress = MailServices.headerParser.extractHeaderAddressMailboxes(msgHdr.author);</span>
<a href="#l31.1886"></a><span id="l31.1886">   if (emailAddress)</span>
<a href="#l31.1887"></a><span id="l31.1887">     top.MsgFilters(emailAddress, msgHdr.folder);</span>
<a href="#l31.1888"></a><span id="l31.1888"> }</span>
<a href="#l31.1889"></a><span id="l31.1889"> </span>
<a href="#l31.1890"></a><span id="l31.1890" class="difflineminus">-function MsgNewFolder(callBackFunctionName)</span>
<a href="#l31.1891"></a><span id="l31.1891" class="difflineminus">-{</span>
<a href="#l31.1892"></a><span id="l31.1892" class="difflineplus">+function MsgNewFolder(callBackFunctionName) {</span>
<a href="#l31.1893"></a><span id="l31.1893">   var preselectedFolder = GetFirstSelectedMsgFolder();</span>
<a href="#l31.1894"></a><span id="l31.1894">   var dualUseFolders = true;</span>
<a href="#l31.1895"></a><span id="l31.1895">   var server = null;</span>
<a href="#l31.1896"></a><span id="l31.1896">   var destinationFolder = null;</span>
<a href="#l31.1897"></a><span id="l31.1897"> </span>
<a href="#l31.1898"></a><span id="l31.1898" class="difflineminus">-  if (preselectedFolder)</span>
<a href="#l31.1899"></a><span id="l31.1899" class="difflineminus">-  {</span>
<a href="#l31.1900"></a><span id="l31.1900" class="difflineplus">+  if (preselectedFolder) {</span>
<a href="#l31.1901"></a><span id="l31.1901">     try {</span>
<a href="#l31.1902"></a><span id="l31.1902">       server = preselectedFolder.server;</span>
<a href="#l31.1903"></a><span id="l31.1903" class="difflineminus">-      if (server)</span>
<a href="#l31.1904"></a><span id="l31.1904" class="difflineminus">-      {</span>
<a href="#l31.1905"></a><span id="l31.1905" class="difflineplus">+      if (server) {</span>
<a href="#l31.1906"></a><span id="l31.1906">         destinationFolder = getDestinationFolder(preselectedFolder, server);</span>
<a href="#l31.1907"></a><span id="l31.1907"> </span>
<a href="#l31.1908"></a><span id="l31.1908">         var imapServer =</span>
<a href="#l31.1909"></a><span id="l31.1909">             server.QueryInterface(Ci.nsIImapIncomingServer);</span>
<a href="#l31.1910"></a><span id="l31.1910">         if (imapServer)</span>
<a href="#l31.1911"></a><span id="l31.1911">           dualUseFolders = imapServer.dualUseFolders;</span>
<a href="#l31.1912"></a><span id="l31.1912">       }</span>
<a href="#l31.1913"></a><span id="l31.1913">     } catch (e) {</span>
<a href="#l31.1914"></a><span id="l31.1914" class="difflineminus">-        dump (&quot;Exception: dualUseFolders = true\n&quot;);</span>
<a href="#l31.1915"></a><span id="l31.1915" class="difflineplus">+        dump(&quot;Exception: dualUseFolders = true\n&quot;);</span>
<a href="#l31.1916"></a><span id="l31.1916">     }</span>
<a href="#l31.1917"></a><span id="l31.1917">   }</span>
<a href="#l31.1918"></a><span id="l31.1918">   window.openDialog(&quot;chrome://messenger/content/newFolderDialog.xul&quot;, &quot;&quot;,</span>
<a href="#l31.1919"></a><span id="l31.1919">                     &quot;chrome,titlebar,modal&quot;,</span>
<a href="#l31.1920"></a><span id="l31.1920" class="difflineminus">-                    {folder: destinationFolder, dualUseFolders: dualUseFolders,</span>
<a href="#l31.1921"></a><span id="l31.1921" class="difflineminus">-                     okCallback:callBackFunctionName});</span>
<a href="#l31.1922"></a><span id="l31.1922" class="difflineplus">+                    {folder: destinationFolder, dualUseFolders,</span>
<a href="#l31.1923"></a><span id="l31.1923" class="difflineplus">+                     okCallback: callBackFunctionName});</span>
<a href="#l31.1924"></a><span id="l31.1924"> }</span>
<a href="#l31.1925"></a><span id="l31.1925"> </span>
<a href="#l31.1926"></a><span id="l31.1926" class="difflineminus">-function getDestinationFolder(preselectedFolder, server)</span>
<a href="#l31.1927"></a><span id="l31.1927" class="difflineminus">-{</span>
<a href="#l31.1928"></a><span id="l31.1928" class="difflineplus">+function getDestinationFolder(preselectedFolder, server) {</span>
<a href="#l31.1929"></a><span id="l31.1929">   var destinationFolder = null;</span>
<a href="#l31.1930"></a><span id="l31.1930"> </span>
<a href="#l31.1931"></a><span id="l31.1931" class="difflineminus">-  if (!preselectedFolder.canCreateSubfolders)</span>
<a href="#l31.1932"></a><span id="l31.1932" class="difflineminus">-  {</span>
<a href="#l31.1933"></a><span id="l31.1933" class="difflineplus">+  if (!preselectedFolder.canCreateSubfolders) {</span>
<a href="#l31.1934"></a><span id="l31.1934">     destinationFolder = server.rootMsgFolder;</span>
<a href="#l31.1935"></a><span id="l31.1935"> </span>
<a href="#l31.1936"></a><span id="l31.1936">     var verifyCreateSubfolders = null;</span>
<a href="#l31.1937"></a><span id="l31.1937">     if (destinationFolder)</span>
<a href="#l31.1938"></a><span id="l31.1938">       verifyCreateSubfolders = destinationFolder.canCreateSubfolders;</span>
<a href="#l31.1939"></a><span id="l31.1939"> </span>
<a href="#l31.1940"></a><span id="l31.1940">     // In case the server cannot have subfolders, get default account and set</span>
<a href="#l31.1941"></a><span id="l31.1941">     // its incoming server as parent folder.</span>
<a href="#l31.1942"></a><span id="l31.1942" class="difflineminus">-    if (!verifyCreateSubfolders)</span>
<a href="#l31.1943"></a><span id="l31.1943" class="difflineminus">-    {</span>
<a href="#l31.1944"></a><span id="l31.1944" class="difflineplus">+    if (!verifyCreateSubfolders) {</span>
<a href="#l31.1945"></a><span id="l31.1945">       try {</span>
<a href="#l31.1946"></a><span id="l31.1946">         var defaultFolder = GetDefaultAccountRootFolder();</span>
<a href="#l31.1947"></a><span id="l31.1947">         var checkCreateSubfolders = null;</span>
<a href="#l31.1948"></a><span id="l31.1948">         if (defaultFolder)</span>
<a href="#l31.1949"></a><span id="l31.1949">           checkCreateSubfolders = defaultFolder.canCreateSubfolders;</span>
<a href="#l31.1950"></a><span id="l31.1950"> </span>
<a href="#l31.1951"></a><span id="l31.1951">         if (checkCreateSubfolders)</span>
<a href="#l31.1952"></a><span id="l31.1952">           destinationFolder = defaultFolder;</span>
<a href="#l31.1953"></a><span id="l31.1953"> </span>
<a href="#l31.1954"></a><span id="l31.1954">       } catch (e) {</span>
<a href="#l31.1955"></a><span id="l31.1955" class="difflineminus">-          dump (&quot;Exception: defaultAccount Not Available\n&quot;);</span>
<a href="#l31.1956"></a><span id="l31.1956" class="difflineplus">+        dump(&quot;Exception: defaultAccount Not Available\n&quot;);</span>
<a href="#l31.1957"></a><span id="l31.1957">       }</span>
<a href="#l31.1958"></a><span id="l31.1958">     }</span>
<a href="#l31.1959"></a><span id="l31.1959" class="difflineplus">+  } else {</span>
<a href="#l31.1960"></a><span id="l31.1960" class="difflineplus">+    destinationFolder = preselectedFolder;</span>
<a href="#l31.1961"></a><span id="l31.1961">   }</span>
<a href="#l31.1962"></a><span id="l31.1962" class="difflineminus">-  else</span>
<a href="#l31.1963"></a><span id="l31.1963" class="difflineminus">-    destinationFolder = preselectedFolder;</span>
<a href="#l31.1964"></a><span id="l31.1964"> </span>
<a href="#l31.1965"></a><span id="l31.1965">   return destinationFolder;</span>
<a href="#l31.1966"></a><span id="l31.1966"> }</span>
<a href="#l31.1967"></a><span id="l31.1967"> </span>
<a href="#l31.1968"></a><span id="l31.1968"> /** Open subscribe window. */</span>
<a href="#l31.1969"></a><span id="l31.1969" class="difflineminus">-function MsgSubscribe()</span>
<a href="#l31.1970"></a><span id="l31.1970" class="difflineminus">-{</span>
<a href="#l31.1971"></a><span id="l31.1971" class="difflineplus">+function MsgSubscribe() {</span>
<a href="#l31.1972"></a><span id="l31.1972">   var preselectedFolder = GetFirstSelectedMsgFolder();</span>
<a href="#l31.1973"></a><span id="l31.1973"> </span>
<a href="#l31.1974"></a><span id="l31.1974">   if (FeedMessageHandler.isFeedFolder(preselectedFolder))</span>
<a href="#l31.1975"></a><span id="l31.1975">     openSubscriptionsDialog(preselectedFolder); // open feed subscription dialog</span>
<a href="#l31.1976"></a><span id="l31.1976">   else</span>
<a href="#l31.1977"></a><span id="l31.1977">     Subscribe(preselectedFolder); // open imap/nntp subscription dialog</span>
<a href="#l31.1978"></a><span id="l31.1978"> }</span>
<a href="#l31.1979"></a><span id="l31.1979"> </span>
<a href="#l31.1980"></a><span id="l31.1980"> /**</span>
<a href="#l31.1981"></a><span id="l31.1981">  * Show a confirmation dialog - check if the user really want to unsubscribe</span>
<a href="#l31.1982"></a><span id="l31.1982">  * from the given newsgroup/s.</span>
<a href="#l31.1983"></a><span id="l31.1983">  * @folders an array of newsgroup folders to unsubscribe from</span>
<a href="#l31.1984"></a><span id="l31.1984">  * @return true if the user said it's ok to unsubscribe</span>
<a href="#l31.1985"></a><span id="l31.1985">  */</span>
<a href="#l31.1986"></a><span id="l31.1986" class="difflineminus">-function ConfirmUnsubscribe(folders)</span>
<a href="#l31.1987"></a><span id="l31.1987" class="difflineminus">-{</span>
<a href="#l31.1988"></a><span id="l31.1988" class="difflineplus">+function ConfirmUnsubscribe(folders) {</span>
<a href="#l31.1989"></a><span id="l31.1989">   var bundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l31.1990"></a><span id="l31.1990">   var titleMsg = bundle.getString(&quot;confirmUnsubscribeTitle&quot;);</span>
<a href="#l31.1991"></a><span id="l31.1991">   var dialogMsg = (folders.length == 1) ?</span>
<a href="#l31.1992"></a><span id="l31.1992">     bundle.getFormattedString(&quot;confirmUnsubscribeText&quot;, [folders[0].name], 1) :</span>
<a href="#l31.1993"></a><span id="l31.1993">     bundle.getString(&quot;confirmUnsubscribeManyText&quot;);</span>
<a href="#l31.1994"></a><span id="l31.1994"> </span>
<a href="#l31.1995"></a><span id="l31.1995">   return Services.prompt.confirm(window, titleMsg, dialogMsg);</span>
<a href="#l31.1996"></a><span id="l31.1996"> }</span>
<a href="#l31.1997"></a><span id="l31.1997"> </span>
<a href="#l31.1998"></a><span id="l31.1998"> /**</span>
<a href="#l31.1999"></a><span id="l31.1999">  * Unsubscribe from selected or passed in newsgroup/s.</span>
<a href="#l31.2000"></a><span id="l31.2000">  * @param newsgroups (optional param) the newsgroup folders to unsubscribe from</span>
<a href="#l31.2001"></a><span id="l31.2001">  */</span>
<a href="#l31.2002"></a><span id="l31.2002" class="difflineminus">-function MsgUnsubscribe(newsgroups)</span>
<a href="#l31.2003"></a><span id="l31.2003" class="difflineminus">-{</span>
<a href="#l31.2004"></a><span id="l31.2004" class="difflineplus">+function MsgUnsubscribe(newsgroups) {</span>
<a href="#l31.2005"></a><span id="l31.2005">   var folders = newsgroups || gFolderTreeView.getSelectedFolders();</span>
<a href="#l31.2006"></a><span id="l31.2006">   if (!ConfirmUnsubscribe(folders))</span>
<a href="#l31.2007"></a><span id="l31.2007">     return;</span>
<a href="#l31.2008"></a><span id="l31.2008"> </span>
<a href="#l31.2009"></a><span id="l31.2009">   for (let i = 0; i &lt; folders.length; i++) {</span>
<a href="#l31.2010"></a><span id="l31.2010">     let subscribableServer = folders[i].server.QueryInterface(</span>
<a href="#l31.2011"></a><span id="l31.2011">       Ci.nsISubscribableServer);</span>
<a href="#l31.2012"></a><span id="l31.2012">     subscribableServer.unsubscribe(folders[i].name);</span>
<a href="#l31.2013"></a><span id="l31.2013">     subscribableServer.commitSubscribeChanges();</span>
<a href="#l31.2014"></a><span id="l31.2014">   }</span>
<a href="#l31.2015"></a><span id="l31.2015"> }</span>
<a href="#l31.2016"></a><span id="l31.2016"> </span>
<a href="#l31.2017"></a><span id="l31.2017" class="difflineminus">-function ToggleFavoriteFolderFlag()</span>
<a href="#l31.2018"></a><span id="l31.2018" class="difflineminus">-{</span>
<a href="#l31.2019"></a><span id="l31.2019" class="difflineplus">+function ToggleFavoriteFolderFlag() {</span>
<a href="#l31.2020"></a><span id="l31.2020">   var folder = GetFirstSelectedMsgFolder();</span>
<a href="#l31.2021"></a><span id="l31.2021">   folder.toggleFlag(Ci.nsMsgFolderFlags.Favorite);</span>
<a href="#l31.2022"></a><span id="l31.2022"> }</span>
<a href="#l31.2023"></a><span id="l31.2023"> </span>
<a href="#l31.2024"></a><span id="l31.2024" class="difflineminus">-function MsgSaveAsFile()</span>
<a href="#l31.2025"></a><span id="l31.2025" class="difflineminus">-{</span>
<a href="#l31.2026"></a><span id="l31.2026" class="difflineplus">+function MsgSaveAsFile() {</span>
<a href="#l31.2027"></a><span id="l31.2027">   SaveAsFile(gFolderDisplay.selectedMessageUris);</span>
<a href="#l31.2028"></a><span id="l31.2028"> }</span>
<a href="#l31.2029"></a><span id="l31.2029"> </span>
<a href="#l31.2030"></a><span id="l31.2030" class="difflineminus">-function MsgSaveAsTemplate()</span>
<a href="#l31.2031"></a><span id="l31.2031" class="difflineminus">-{</span>
<a href="#l31.2032"></a><span id="l31.2032" class="difflineplus">+function MsgSaveAsTemplate() {</span>
<a href="#l31.2033"></a><span id="l31.2033">   if (gFolderDisplay.selectedCount == 1)</span>
<a href="#l31.2034"></a><span id="l31.2034">     SaveAsTemplate(gFolderDisplay.selectedMessageUris[0]);</span>
<a href="#l31.2035"></a><span id="l31.2035"> }</span>
<a href="#l31.2036"></a><span id="l31.2036"> </span>
<a href="#l31.2037"></a><span id="l31.2037" class="difflineminus">-function CreateToolbarTooltip(document, event)</span>
<a href="#l31.2038"></a><span id="l31.2038" class="difflineminus">-{</span>
<a href="#l31.2039"></a><span id="l31.2039" class="difflineplus">+function CreateToolbarTooltip(document, event) {</span>
<a href="#l31.2040"></a><span id="l31.2040">   event.stopPropagation();</span>
<a href="#l31.2041"></a><span id="l31.2041">   var tn = document.tooltipNode;</span>
<a href="#l31.2042"></a><span id="l31.2042">   if (tn.localName != &quot;tab&quot;)</span>
<a href="#l31.2043"></a><span id="l31.2043">     return false; // Not a tab, so cancel the tooltip.</span>
<a href="#l31.2044"></a><span id="l31.2044">   if (&quot;mOverCloseButton&quot; in tn &amp;&amp; tn.mOverCloseButton) {</span>
<a href="#l31.2045"></a><span id="l31.2045">      event.target.setAttribute(&quot;label&quot;, tn.getAttribute(&quot;closetabtext&quot;));</span>
<a href="#l31.2046"></a><span id="l31.2046">      return true;</span>
<a href="#l31.2047"></a><span id="l31.2047">   }</span>
<a href="#l31.2048"></a><span id="l31.2048">   if (tn.hasAttribute(&quot;label&quot;)) {</span>
<a href="#l31.2049"></a><span id="l31.2049">     event.target.setAttribute(&quot;label&quot;, tn.getAttribute(&quot;label&quot;));</span>
<a href="#l31.2050"></a><span id="l31.2050">     return true;</span>
<a href="#l31.2051"></a><span id="l31.2051">   }</span>
<a href="#l31.2052"></a><span id="l31.2052">   return false;</span>
<a href="#l31.2053"></a><span id="l31.2053"> }</span>
<a href="#l31.2054"></a><span id="l31.2054"> </span>
<a href="#l31.2055"></a><span id="l31.2055" class="difflineminus">-function MsgOpenNewWindowForFolder(folderURI, msgKeyToSelect)</span>
<a href="#l31.2056"></a><span id="l31.2056" class="difflineminus">-{</span>
<a href="#l31.2057"></a><span id="l31.2057" class="difflineplus">+function MsgOpenNewWindowForFolder(folderURI, msgKeyToSelect) {</span>
<a href="#l31.2058"></a><span id="l31.2058">   if (folderURI) {</span>
<a href="#l31.2059"></a><span id="l31.2059">     window.openDialog(&quot;chrome://messenger/content/&quot;, &quot;_blank&quot;,</span>
<a href="#l31.2060"></a><span id="l31.2060">                       &quot;chrome,all,dialog=no&quot;, folderURI, msgKeyToSelect);</span>
<a href="#l31.2061"></a><span id="l31.2061">     return;</span>
<a href="#l31.2062"></a><span id="l31.2062">   }</span>
<a href="#l31.2063"></a><span id="l31.2063"> </span>
<a href="#l31.2064"></a><span id="l31.2064">   // If there is a right-click happening, gFolderTreeView.getSelectedFolders()</span>
<a href="#l31.2065"></a><span id="l31.2065">   // will tell us about it (while the selection's currentIndex would reflect</span>
<a href="#l31.2066"></a><span id="l31.2066" class="difflineat">@@ -2197,59 +2050,56 @@ function MsgOpenNewWindowForFolder(folde</span>
<a href="#l31.2067"></a><span id="l31.2067"> }</span>
<a href="#l31.2068"></a><span id="l31.2068"> </span>
<a href="#l31.2069"></a><span id="l31.2069"> /**</span>
<a href="#l31.2070"></a><span id="l31.2070">  * UI-triggered command to open the currently selected folder(s) in new tabs.</span>
<a href="#l31.2071"></a><span id="l31.2071">  * @param aBackground [optional] if true, then the folder tab is opened in the</span>
<a href="#l31.2072"></a><span id="l31.2072">  *                    background. If false or not given, then the folder tab is</span>
<a href="#l31.2073"></a><span id="l31.2073">  *                    opened in the foreground.</span>
<a href="#l31.2074"></a><span id="l31.2074">  */</span>
<a href="#l31.2075"></a><span id="l31.2075" class="difflineminus">-function MsgOpenNewTabForFolder(aBackground)</span>
<a href="#l31.2076"></a><span id="l31.2076" class="difflineminus">-{</span>
<a href="#l31.2077"></a><span id="l31.2077" class="difflineplus">+function MsgOpenNewTabForFolder(aBackground) {</span>
<a href="#l31.2078"></a><span id="l31.2078">   // If there is a right-click happening, gFolderTreeView.getSelectedFolders()</span>
<a href="#l31.2079"></a><span id="l31.2079">   // will tell us about it (while the selection's currentIndex would reflect</span>
<a href="#l31.2080"></a><span id="l31.2080">   // the node that was selected/displayed before the right-click.)</span>
<a href="#l31.2081"></a><span id="l31.2081">   let selectedFolders = gFolderTreeView.getSelectedFolders();</span>
<a href="#l31.2082"></a><span id="l31.2082">   for (let i = 0; i &lt; selectedFolders.length; i++) {</span>
<a href="#l31.2083"></a><span id="l31.2083">     document.getElementById(&quot;tabmail&quot;).openTab(&quot;folder&quot;,</span>
<a href="#l31.2084"></a><span id="l31.2084">       {folder: selectedFolders[i], background: aBackground});</span>
<a href="#l31.2085"></a><span id="l31.2085">   }</span>
<a href="#l31.2086"></a><span id="l31.2086"> }</span>
<a href="#l31.2087"></a><span id="l31.2087"> </span>
<a href="#l31.2088"></a><span id="l31.2088" class="difflineminus">-function MsgOpenSelectedMessages()</span>
<a href="#l31.2089"></a><span id="l31.2089" class="difflineminus">-{</span>
<a href="#l31.2090"></a><span id="l31.2090" class="difflineplus">+function MsgOpenSelectedMessages() {</span>
<a href="#l31.2091"></a><span id="l31.2091">   // Toggle message body (feed summary) and content-base url in message pane or</span>
<a href="#l31.2092"></a><span id="l31.2092">   // load in browser, per pref, otherwise open summary or web page in new window</span>
<a href="#l31.2093"></a><span id="l31.2093">   // or tab, per that pref.</span>
<a href="#l31.2094"></a><span id="l31.2094">   if (gFolderDisplay.treeSelection &amp;&amp; gFolderDisplay.treeSelection.count == 1 &amp;&amp;</span>
<a href="#l31.2095"></a><span id="l31.2095">       gFolderDisplay.selectedMessageIsFeed) {</span>
<a href="#l31.2096"></a><span id="l31.2096">     let msgHdr = gFolderDisplay.selectedMessage;</span>
<a href="#l31.2097"></a><span id="l31.2097">     if (document.documentElement.getAttribute(&quot;windowtype&quot;) == &quot;mail:3pane&quot; &amp;&amp;</span>
<a href="#l31.2098"></a><span id="l31.2098">         FeedMessageHandler.onOpenPref == FeedMessageHandler.kOpenToggleInMessagePane) {</span>
<a href="#l31.2099"></a><span id="l31.2099">       let showSummary = FeedMessageHandler.shouldShowSummary(msgHdr, true);</span>
<a href="#l31.2100"></a><span id="l31.2100">       FeedMessageHandler.setContent(msgHdr, showSummary);</span>
<a href="#l31.2101"></a><span id="l31.2101">       return;</span>
<a href="#l31.2102"></a><span id="l31.2102">     }</span>
<a href="#l31.2103"></a><span id="l31.2103">     if (FeedMessageHandler.onOpenPref == FeedMessageHandler.kOpenLoadInBrowser) {</span>
<a href="#l31.2104"></a><span id="l31.2104" class="difflineminus">-      setTimeout(FeedMessageHandler.loadWebPage, 20, msgHdr, {browser:true});</span>
<a href="#l31.2105"></a><span id="l31.2105" class="difflineplus">+      setTimeout(FeedMessageHandler.loadWebPage, 20, msgHdr, {browser: true});</span>
<a href="#l31.2106"></a><span id="l31.2106">       return;</span>
<a href="#l31.2107"></a><span id="l31.2107">     }</span>
<a href="#l31.2108"></a><span id="l31.2108">   }</span>
<a href="#l31.2109"></a><span id="l31.2109"> </span>
<a href="#l31.2110"></a><span id="l31.2110">   // This is somewhat evil. If we're in a 3pane window, we'd have a tabmail</span>
<a href="#l31.2111"></a><span id="l31.2111">   // element and would pass it in here, ensuring that if we open tabs, we use</span>
<a href="#l31.2112"></a><span id="l31.2112">   // this tabmail to open them. If we aren't, then we wouldn't, so</span>
<a href="#l31.2113"></a><span id="l31.2113">   // displayMessages would look for a 3pane window and open tabs there.</span>
<a href="#l31.2114"></a><span id="l31.2114">   MailUtils.displayMessages(gFolderDisplay.selectedMessages,</span>
<a href="#l31.2115"></a><span id="l31.2115">                             gFolderDisplay.view,</span>
<a href="#l31.2116"></a><span id="l31.2116">                             document.getElementById(&quot;tabmail&quot;));</span>
<a href="#l31.2117"></a><span id="l31.2117"> }</span>
<a href="#l31.2118"></a><span id="l31.2118"> </span>
<a href="#l31.2119"></a><span id="l31.2119" class="difflineminus">-function MsgOpenFromFile()</span>
<a href="#l31.2120"></a><span id="l31.2120" class="difflineminus">-{</span>
<a href="#l31.2121"></a><span id="l31.2121" class="difflineplus">+function MsgOpenFromFile() {</span>
<a href="#l31.2122"></a><span id="l31.2122">   const nsIFilePicker = Ci.nsIFilePicker;</span>
<a href="#l31.2123"></a><span id="l31.2123">   var fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l31.2124"></a><span id="l31.2124">              .createInstance(nsIFilePicker);</span>
<a href="#l31.2125"></a><span id="l31.2125"> </span>
<a href="#l31.2126"></a><span id="l31.2126">   var bundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l31.2127"></a><span id="l31.2127">   var filterLabel = bundle.getString(&quot;EMLFiles&quot;);</span>
<a href="#l31.2128"></a><span id="l31.2128">   var windowTitle = bundle.getString(&quot;OpenEMLFiles&quot;);</span>
<a href="#l31.2129"></a><span id="l31.2129"> </span>
<a href="#l31.2130"></a><span id="l31.2130" class="difflineat">@@ -2266,18 +2116,17 @@ function MsgOpenFromFile()</span>
<a href="#l31.2131"></a><span id="l31.2131">     let uri = fp.fileURL.QueryInterface(Ci.nsIURL);</span>
<a href="#l31.2132"></a><span id="l31.2132">     uri = uri.mutate().setQuery(&quot;type=application/x-message-display&quot;).finalize();</span>
<a href="#l31.2133"></a><span id="l31.2133"> </span>
<a href="#l31.2134"></a><span id="l31.2134">     window.openDialog(&quot;chrome://messenger/content/messageWindow.xul&quot;, &quot;_blank&quot;,</span>
<a href="#l31.2135"></a><span id="l31.2135">                     &quot;all,chrome,dialog=no,status,toolbar&quot;, uri);</span>
<a href="#l31.2136"></a><span id="l31.2136">   });</span>
<a href="#l31.2137"></a><span id="l31.2137"> }</span>
<a href="#l31.2138"></a><span id="l31.2138"> </span>
<a href="#l31.2139"></a><span id="l31.2139" class="difflineminus">-function MsgOpenNewWindowForMessage(aMsgHdr)</span>
<a href="#l31.2140"></a><span id="l31.2140" class="difflineminus">-{</span>
<a href="#l31.2141"></a><span id="l31.2141" class="difflineplus">+function MsgOpenNewWindowForMessage(aMsgHdr) {</span>
<a href="#l31.2142"></a><span id="l31.2142">   // no message header provided?  get the selected message (this will give us</span>
<a href="#l31.2143"></a><span id="l31.2143">   //  the right-click selected message if that's what is going down.)</span>
<a href="#l31.2144"></a><span id="l31.2144">   if (!aMsgHdr)</span>
<a href="#l31.2145"></a><span id="l31.2145">     aMsgHdr = gFolderDisplay.selectedMessage;</span>
<a href="#l31.2146"></a><span id="l31.2146"> </span>
<a href="#l31.2147"></a><span id="l31.2147">   // (there might not have been a selected message, so check...)</span>
<a href="#l31.2148"></a><span id="l31.2148">   if (aMsgHdr)</span>
<a href="#l31.2149"></a><span id="l31.2149">     // we also need to tell the window about our current view so that it can</span>
<a href="#l31.2150"></a><span id="l31.2150" class="difflineat">@@ -2287,126 +2136,115 @@ function MsgOpenNewWindowForMessage(aMsg</span>
<a href="#l31.2151"></a><span id="l31.2151">                       aMsgHdr, gFolderDisplay.view);</span>
<a href="#l31.2152"></a><span id="l31.2152"> }</span>
<a href="#l31.2153"></a><span id="l31.2153"> </span>
<a href="#l31.2154"></a><span id="l31.2154"> /**</span>
<a href="#l31.2155"></a><span id="l31.2155">  * Display the given message in an existing folder tab.</span>
<a href="#l31.2156"></a><span id="l31.2156">  *</span>
<a href="#l31.2157"></a><span id="l31.2157">  * @param aMsgHdr The message header to display.</span>
<a href="#l31.2158"></a><span id="l31.2158">  */</span>
<a href="#l31.2159"></a><span id="l31.2159" class="difflineminus">-function MsgDisplayMessageInFolderTab(aMsgHdr)</span>
<a href="#l31.2160"></a><span id="l31.2160" class="difflineminus">-{</span>
<a href="#l31.2161"></a><span id="l31.2161" class="difflineplus">+function MsgDisplayMessageInFolderTab(aMsgHdr) {</span>
<a href="#l31.2162"></a><span id="l31.2162">   // Look for a folder tab</span>
<a href="#l31.2163"></a><span id="l31.2163">   let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l31.2164"></a><span id="l31.2164" class="difflineminus">-  let folderTab = tabmail.getTabInfoForCurrentOrFirstModeInstance(</span>
<a href="#l31.2165"></a><span id="l31.2165" class="difflineminus">-                      tabmail.tabModes[&quot;folder&quot;]);</span>
<a href="#l31.2166"></a><span id="l31.2166" class="difflineplus">+  let folderTab = tabmail.getTabInfoForCurrentOrFirstModeInstance(tabmail.tabModes.folder);</span>
<a href="#l31.2167"></a><span id="l31.2167">   let folderDisplay = folderTab.folderDisplay;</span>
<a href="#l31.2168"></a><span id="l31.2168">   let folder = gFolderTreeView.getFolderForMsgHdr(aMsgHdr);</span>
<a href="#l31.2169"></a><span id="l31.2169"> </span>
<a href="#l31.2170"></a><span id="l31.2170">   // XXX Yuck. We really need to have the tabmail be able to handle an extra</span>
<a href="#l31.2171"></a><span id="l31.2171">   // param with data to send to showTab, and to have the folder display have</span>
<a href="#l31.2172"></a><span id="l31.2172">   // a |selectFolderAndMessage| method that handles most of the messiness.</span>
<a href="#l31.2173"></a><span id="l31.2173">   folderDisplay.selectMessageComingUp();</span>
<a href="#l31.2174"></a><span id="l31.2174"> </span>
<a href="#l31.2175"></a><span id="l31.2175">   // Switch to the tab</span>
<a href="#l31.2176"></a><span id="l31.2176">   tabmail.switchToTab(folderTab);</span>
<a href="#l31.2177"></a><span id="l31.2177"> </span>
<a href="#l31.2178"></a><span id="l31.2178">   // We don't want to drop view filters at first</span>
<a href="#l31.2179"></a><span id="l31.2179">   if (folderDisplay.view.getViewIndexForMsgHdr(aMsgHdr, false) !=</span>
<a href="#l31.2180"></a><span id="l31.2180">       nsMsgViewIndex_None) {</span>
<a href="#l31.2181"></a><span id="l31.2181">     folderDisplay.selectMessage(aMsgHdr);</span>
<a href="#l31.2182"></a><span id="l31.2182" class="difflineminus">-  }</span>
<a href="#l31.2183"></a><span id="l31.2183" class="difflineminus">-  else {</span>
<a href="#l31.2184"></a><span id="l31.2184" class="difflineplus">+  } else {</span>
<a href="#l31.2185"></a><span id="l31.2185">     if (folderDisplay.displayedFolder != folder ||</span>
<a href="#l31.2186"></a><span id="l31.2186">         folderDisplay.view.isVirtual) {</span>
<a href="#l31.2187"></a><span id="l31.2187">       // Force select the folder</span>
<a href="#l31.2188"></a><span id="l31.2188">       folderDisplay.show(folder);</span>
<a href="#l31.2189"></a><span id="l31.2189">       gFolderTreeView.selectFolder(folder, true);</span>
<a href="#l31.2190"></a><span id="l31.2190">     }</span>
<a href="#l31.2191"></a><span id="l31.2191"> </span>
<a href="#l31.2192"></a><span id="l31.2192">     // Force select the message</span>
<a href="#l31.2193"></a><span id="l31.2193">     folderDisplay.selectMessage(aMsgHdr, true);</span>
<a href="#l31.2194"></a><span id="l31.2194">   }</span>
<a href="#l31.2195"></a><span id="l31.2195"> }</span>
<a href="#l31.2196"></a><span id="l31.2196"> </span>
<a href="#l31.2197"></a><span id="l31.2197" class="difflineminus">-function MsgJunk()</span>
<a href="#l31.2198"></a><span id="l31.2198" class="difflineminus">-{</span>
<a href="#l31.2199"></a><span id="l31.2199" class="difflineplus">+function MsgJunk() {</span>
<a href="#l31.2200"></a><span id="l31.2200">   MsgJunkMailInfo(true);</span>
<a href="#l31.2201"></a><span id="l31.2201">   JunkSelectedMessages(!SelectedMessagesAreJunk());</span>
<a href="#l31.2202"></a><span id="l31.2202"> }</span>
<a href="#l31.2203"></a><span id="l31.2203"> </span>
<a href="#l31.2204"></a><span id="l31.2204"> /**</span>
<a href="#l31.2205"></a><span id="l31.2205">  * Update the &quot;mark as junk&quot; button in the message header area.</span>
<a href="#l31.2206"></a><span id="l31.2206">  */</span>
<a href="#l31.2207"></a><span id="l31.2207" class="difflineminus">-function UpdateJunkButton()</span>
<a href="#l31.2208"></a><span id="l31.2208" class="difflineminus">-{</span>
<a href="#l31.2209"></a><span id="l31.2209" class="difflineplus">+function UpdateJunkButton() {</span>
<a href="#l31.2210"></a><span id="l31.2210">   // The junk message should slave off the selected message, as the preview pane</span>
<a href="#l31.2211"></a><span id="l31.2211">   //  may not be visible</span>
<a href="#l31.2212"></a><span id="l31.2212">   let hdr = gFolderDisplay.selectedMessage;</span>
<a href="#l31.2213"></a><span id="l31.2213">   // But only the message display knows if we are dealing with a dummy.</span>
<a href="#l31.2214"></a><span id="l31.2214">   if (!hdr || gMessageDisplay.isDummy) // .eml file</span>
<a href="#l31.2215"></a><span id="l31.2215">     return;</span>
<a href="#l31.2216"></a><span id="l31.2216">   let junkScore = hdr.getStringProperty(&quot;junkscore&quot;);</span>
<a href="#l31.2217"></a><span id="l31.2217">   let hideJunk = (junkScore == Ci.nsIJunkMailPlugin.IS_SPAM_SCORE);</span>
<a href="#l31.2218"></a><span id="l31.2218">   if (!gFolderDisplay.getCommandStatus(nsMsgViewCommandType.junk))</span>
<a href="#l31.2219"></a><span id="l31.2219">     hideJunk = true;</span>
<a href="#l31.2220"></a><span id="l31.2220" class="difflineminus">-  if (document.getElementById('hdrJunkButton')) {</span>
<a href="#l31.2221"></a><span id="l31.2221" class="difflineminus">-    document.getElementById('hdrJunkButton').disabled = hideJunk;</span>
<a href="#l31.2222"></a><span id="l31.2222" class="difflineplus">+  if (document.getElementById(&quot;hdrJunkButton&quot;)) {</span>
<a href="#l31.2223"></a><span id="l31.2223" class="difflineplus">+    document.getElementById(&quot;hdrJunkButton&quot;).disabled = hideJunk;</span>
<a href="#l31.2224"></a><span id="l31.2224">   }</span>
<a href="#l31.2225"></a><span id="l31.2225"> }</span>
<a href="#l31.2226"></a><span id="l31.2226"> </span>
<a href="#l31.2227"></a><span id="l31.2227"> /**</span>
<a href="#l31.2228"></a><span id="l31.2228">  * Checks if the selected messages can be marked as read or unread</span>
<a href="#l31.2229"></a><span id="l31.2229">  *</span>
<a href="#l31.2230"></a><span id="l31.2230">  * @param markingRead true if trying to mark messages as read, false otherwise</span>
<a href="#l31.2231"></a><span id="l31.2231">  * @return true if the chosen operation can be performed</span>
<a href="#l31.2232"></a><span id="l31.2232">  */</span>
<a href="#l31.2233"></a><span id="l31.2233" class="difflineminus">-function CanMarkMsgAsRead(markingRead)</span>
<a href="#l31.2234"></a><span id="l31.2234" class="difflineminus">-{</span>
<a href="#l31.2235"></a><span id="l31.2235" class="difflineplus">+function CanMarkMsgAsRead(markingRead) {</span>
<a href="#l31.2236"></a><span id="l31.2236">   return gFolderDisplay.selectedCount &gt; 0 &amp;&amp;</span>
<a href="#l31.2237"></a><span id="l31.2237">          SelectedMessagesAreRead() != markingRead;</span>
<a href="#l31.2238"></a><span id="l31.2238"> }</span>
<a href="#l31.2239"></a><span id="l31.2239"> </span>
<a href="#l31.2240"></a><span id="l31.2240"> /**</span>
<a href="#l31.2241"></a><span id="l31.2241">  * Marks the selected messages as read or unread</span>
<a href="#l31.2242"></a><span id="l31.2242">  *</span>
<a href="#l31.2243"></a><span id="l31.2243">  * @param read true if trying to mark messages as read, false if marking unread,</span>
<a href="#l31.2244"></a><span id="l31.2244">  *        undefined if toggling the read status</span>
<a href="#l31.2245"></a><span id="l31.2245">  */</span>
<a href="#l31.2246"></a><span id="l31.2246" class="difflineminus">-function MsgMarkMsgAsRead(read)</span>
<a href="#l31.2247"></a><span id="l31.2247" class="difflineminus">-{</span>
<a href="#l31.2248"></a><span id="l31.2248" class="difflineplus">+function MsgMarkMsgAsRead(read) {</span>
<a href="#l31.2249"></a><span id="l31.2249">   if (read == undefined)</span>
<a href="#l31.2250"></a><span id="l31.2250">     read = !gFolderDisplay.selectedMessage.isRead;</span>
<a href="#l31.2251"></a><span id="l31.2251">   MarkSelectedMessagesRead(read);</span>
<a href="#l31.2252"></a><span id="l31.2252"> }</span>
<a href="#l31.2253"></a><span id="l31.2253"> </span>
<a href="#l31.2254"></a><span id="l31.2254" class="difflineminus">-function MsgMarkAsFlagged()</span>
<a href="#l31.2255"></a><span id="l31.2255" class="difflineminus">-{</span>
<a href="#l31.2256"></a><span id="l31.2256" class="difflineplus">+function MsgMarkAsFlagged() {</span>
<a href="#l31.2257"></a><span id="l31.2257">   MarkSelectedMessagesFlagged(!SelectedMessagesAreFlagged());</span>
<a href="#l31.2258"></a><span id="l31.2258"> }</span>
<a href="#l31.2259"></a><span id="l31.2259"> </span>
<a href="#l31.2260"></a><span id="l31.2260" class="difflineminus">-function MsgMarkReadByDate()</span>
<a href="#l31.2261"></a><span id="l31.2261" class="difflineminus">-{</span>
<a href="#l31.2262"></a><span id="l31.2262" class="difflineminus">-  window.openDialog(&quot;chrome://messenger/content/markByDate.xul&quot;,&quot;&quot;,</span>
<a href="#l31.2263"></a><span id="l31.2263" class="difflineplus">+function MsgMarkReadByDate() {</span>
<a href="#l31.2264"></a><span id="l31.2264" class="difflineplus">+  window.openDialog(&quot;chrome://messenger/content/markByDate.xul&quot;, &quot;&quot;,</span>
<a href="#l31.2265"></a><span id="l31.2265">                     &quot;chrome,modal,titlebar,centerscreen&quot;,</span>
<a href="#l31.2266"></a><span id="l31.2266">                     gFolderDisplay.displayedFolder);</span>
<a href="#l31.2267"></a><span id="l31.2267"> }</span>
<a href="#l31.2268"></a><span id="l31.2268"> </span>
<a href="#l31.2269"></a><span id="l31.2269" class="difflineminus">-function MsgMarkAllRead()</span>
<a href="#l31.2270"></a><span id="l31.2270" class="difflineminus">-{</span>
<a href="#l31.2271"></a><span id="l31.2271" class="difflineplus">+function MsgMarkAllRead() {</span>
<a href="#l31.2272"></a><span id="l31.2272">   let folders = gFolderTreeView.getSelectedFolders();</span>
<a href="#l31.2273"></a><span id="l31.2273">   for (let i = 0; i &lt; folders.length; i++)</span>
<a href="#l31.2274"></a><span id="l31.2274">     folders[i].markAllMessagesRead(msgWindow);</span>
<a href="#l31.2275"></a><span id="l31.2275"> }</span>
<a href="#l31.2276"></a><span id="l31.2276"> </span>
<a href="#l31.2277"></a><span id="l31.2277"> /**</span>
<a href="#l31.2278"></a><span id="l31.2278">  * Go through each selected server and mark all its folders read.</span>
<a href="#l31.2279"></a><span id="l31.2279">  */</span>
<a href="#l31.2280"></a><span id="l31.2280" class="difflineminus">-function MsgMarkAllFoldersRead()</span>
<a href="#l31.2281"></a><span id="l31.2281" class="difflineminus">-{</span>
<a href="#l31.2282"></a><span id="l31.2282" class="difflineplus">+function MsgMarkAllFoldersRead() {</span>
<a href="#l31.2283"></a><span id="l31.2283">   const selectedFolders = gFolderTreeView.getSelectedFolders();</span>
<a href="#l31.2284"></a><span id="l31.2284">   const selectedServers = selectedFolders.filter(folder =&gt; folder.isServer);</span>
<a href="#l31.2285"></a><span id="l31.2285"> </span>
<a href="#l31.2286"></a><span id="l31.2286">   selectedServers.forEach(function(server) {</span>
<a href="#l31.2287"></a><span id="l31.2287">     const folders = server.rootFolder.descendants;</span>
<a href="#l31.2288"></a><span id="l31.2288">     for (let folder of fixIterator(folders, Ci.nsIMsgFolder)) {</span>
<a href="#l31.2289"></a><span id="l31.2289">       folder.markAllMessagesRead(msgWindow);</span>
<a href="#l31.2290"></a><span id="l31.2290">     }</span>
<a href="#l31.2291"></a><span id="l31.2291" class="difflineat">@@ -2417,74 +2255,64 @@ function MsgMarkAllFoldersRead()</span>
<a href="#l31.2292"></a><span id="l31.2292">  * Opens the filter list.</span>
<a href="#l31.2293"></a><span id="l31.2293">  * If an email address was passed, first a new filter is offered for creation</span>
<a href="#l31.2294"></a><span id="l31.2294">  * with the data prefilled.</span>
<a href="#l31.2295"></a><span id="l31.2295">  *</span>
<a href="#l31.2296"></a><span id="l31.2296">  * @param emailAddress  An email address to use as value in the first search term.</span>
<a href="#l31.2297"></a><span id="l31.2297">  * @param folder        The filter will be created in this folder's filter list.</span>
<a href="#l31.2298"></a><span id="l31.2298">  * @param fieldName     Search field string, from nsMsgSearchTerm.cpp::SearchAttribEntryTable.</span>
<a href="#l31.2299"></a><span id="l31.2299">  */</span>
<a href="#l31.2300"></a><span id="l31.2300" class="difflineminus">-function MsgFilters(emailAddress, folder, fieldName)</span>
<a href="#l31.2301"></a><span id="l31.2301" class="difflineminus">-{</span>
<a href="#l31.2302"></a><span id="l31.2302" class="difflineminus">-  if (!folder)</span>
<a href="#l31.2303"></a><span id="l31.2303" class="difflineminus">-  {</span>
<a href="#l31.2304"></a><span id="l31.2304" class="difflineplus">+function MsgFilters(emailAddress, folder, fieldName) {</span>
<a href="#l31.2305"></a><span id="l31.2305" class="difflineplus">+  if (!folder) {</span>
<a href="#l31.2306"></a><span id="l31.2306">     // Try to determine the folder from the selected message.</span>
<a href="#l31.2307"></a><span id="l31.2307" class="difflineminus">-    if (gDBView)</span>
<a href="#l31.2308"></a><span id="l31.2308" class="difflineminus">-    {</span>
<a href="#l31.2309"></a><span id="l31.2309" class="difflineplus">+    if (gDBView) {</span>
<a href="#l31.2310"></a><span id="l31.2310">       /*</span>
<a href="#l31.2311"></a><span id="l31.2311">        * Here we face a decision. If the message has been moved to a</span>
<a href="#l31.2312"></a><span id="l31.2312">        *  different account, then a single filter cannot work for both</span>
<a href="#l31.2313"></a><span id="l31.2313">        *  manual and incoming scope. So we will create the filter based</span>
<a href="#l31.2314"></a><span id="l31.2314">        *  on its existing location, which will make it work properly in</span>
<a href="#l31.2315"></a><span id="l31.2315">        *  manual scope. This is the best solution for POP3 with global</span>
<a href="#l31.2316"></a><span id="l31.2316">        *  inbox (as then both manual and incoming filters work correctly),</span>
<a href="#l31.2317"></a><span id="l31.2317">        *  but may not be what IMAP users who filter to a local folder</span>
<a href="#l31.2318"></a><span id="l31.2318">        *  really want.</span>
<a href="#l31.2319"></a><span id="l31.2319">        */</span>
<a href="#l31.2320"></a><span id="l31.2320" class="difflineminus">-      try</span>
<a href="#l31.2321"></a><span id="l31.2321" class="difflineminus">-      {</span>
<a href="#l31.2322"></a><span id="l31.2322" class="difflineplus">+      try {</span>
<a href="#l31.2323"></a><span id="l31.2323">         folder = gFolderDisplay.selectedMessage.folder;</span>
<a href="#l31.2324"></a><span id="l31.2324" class="difflineminus">-      }</span>
<a href="#l31.2325"></a><span id="l31.2325" class="difflineminus">-      catch (ex) {}</span>
<a href="#l31.2326"></a><span id="l31.2326" class="difflineplus">+      } catch (ex) {}</span>
<a href="#l31.2327"></a><span id="l31.2327">     }</span>
<a href="#l31.2328"></a><span id="l31.2328">     if (!folder)</span>
<a href="#l31.2329"></a><span id="l31.2329">       folder = GetFirstSelectedMsgFolder();</span>
<a href="#l31.2330"></a><span id="l31.2330">   }</span>
<a href="#l31.2331"></a><span id="l31.2331">   var args;</span>
<a href="#l31.2332"></a><span id="l31.2332" class="difflineminus">-  if (emailAddress)</span>
<a href="#l31.2333"></a><span id="l31.2333" class="difflineminus">-  {</span>
<a href="#l31.2334"></a><span id="l31.2334" class="difflineplus">+  if (emailAddress) {</span>
<a href="#l31.2335"></a><span id="l31.2335">     // We have to do prefill filter so we are going to launch the</span>
<a href="#l31.2336"></a><span id="l31.2336">     // filterEditor dialog and prefill that with the emailAddress.</span>
<a href="#l31.2337"></a><span id="l31.2337">     args = { filterList: folder.getEditableFilterList(msgWindow),</span>
<a href="#l31.2338"></a><span id="l31.2338">              filterName: emailAddress };</span>
<a href="#l31.2339"></a><span id="l31.2339">     // Set the field name to prefill in the filter, if one was specified.</span>
<a href="#l31.2340"></a><span id="l31.2340">     if (fieldName)</span>
<a href="#l31.2341"></a><span id="l31.2341">       args.fieldName = fieldName;</span>
<a href="#l31.2342"></a><span id="l31.2342"> </span>
<a href="#l31.2343"></a><span id="l31.2343">     window.openDialog(&quot;chrome://messenger/content/FilterEditor.xul&quot;, &quot;&quot;,</span>
<a href="#l31.2344"></a><span id="l31.2344">                       &quot;chrome, modal, resizable,centerscreen,dialog=yes&quot;, args);</span>
<a href="#l31.2345"></a><span id="l31.2345"> </span>
<a href="#l31.2346"></a><span id="l31.2346">     // If the user hits OK in the filterEditor dialog we set args.refresh=true</span>
<a href="#l31.2347"></a><span id="l31.2347">     // there and we check this here in args to show filterList dialog.</span>
<a href="#l31.2348"></a><span id="l31.2348">     // We also received the filter created via args.newFilter.</span>
<a href="#l31.2349"></a><span id="l31.2349" class="difflineminus">-    if (&quot;refresh&quot; in args &amp;&amp; args.refresh)</span>
<a href="#l31.2350"></a><span id="l31.2350" class="difflineminus">-    {</span>
<a href="#l31.2351"></a><span id="l31.2351" class="difflineminus">-      args = { refresh: true, folder: folder, filter: args.newFilter };</span>
<a href="#l31.2352"></a><span id="l31.2352" class="difflineplus">+    if (&quot;refresh&quot; in args &amp;&amp; args.refresh) {</span>
<a href="#l31.2353"></a><span id="l31.2353" class="difflineplus">+      args = { refresh: true, folder, filter: args.newFilter };</span>
<a href="#l31.2354"></a><span id="l31.2354">       MsgFilterList(args);</span>
<a href="#l31.2355"></a><span id="l31.2355">     }</span>
<a href="#l31.2356"></a><span id="l31.2356" class="difflineminus">-  }</span>
<a href="#l31.2357"></a><span id="l31.2357" class="difflineminus">-  else  // just launch filterList dialog</span>
<a href="#l31.2358"></a><span id="l31.2358" class="difflineminus">-  {</span>
<a href="#l31.2359"></a><span id="l31.2359" class="difflineminus">-    args = { refresh: false, folder: folder };</span>
<a href="#l31.2360"></a><span id="l31.2360" class="difflineplus">+  } else { // just launch filterList dialog</span>
<a href="#l31.2361"></a><span id="l31.2361" class="difflineplus">+    args = { refresh: false, folder };</span>
<a href="#l31.2362"></a><span id="l31.2362">     MsgFilterList(args);</span>
<a href="#l31.2363"></a><span id="l31.2363">   }</span>
<a href="#l31.2364"></a><span id="l31.2364"> }</span>
<a href="#l31.2365"></a><span id="l31.2365"> </span>
<a href="#l31.2366"></a><span id="l31.2366" class="difflineminus">-function MsgApplyFilters()</span>
<a href="#l31.2367"></a><span id="l31.2367" class="difflineminus">-{</span>
<a href="#l31.2368"></a><span id="l31.2368" class="difflineplus">+function MsgApplyFilters() {</span>
<a href="#l31.2369"></a><span id="l31.2369">   let preselectedFolder = GetFirstSelectedMsgFolder();</span>
<a href="#l31.2370"></a><span id="l31.2370">   let selectedFolders = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l31.2371"></a><span id="l31.2371">                           .createInstance(Ci.nsIMutableArray);</span>
<a href="#l31.2372"></a><span id="l31.2372">   selectedFolders.appendElement(preselectedFolder);</span>
<a href="#l31.2373"></a><span id="l31.2373"> </span>
<a href="#l31.2374"></a><span id="l31.2374">   let curFilterList = preselectedFolder.getFilterList(msgWindow);</span>
<a href="#l31.2375"></a><span id="l31.2375">   // create a new filter list and copy over the enabled filters to it.</span>
<a href="#l31.2376"></a><span id="l31.2376">   // We do this instead of having the filter after the fact code ignore</span>
<a href="#l31.2377"></a><span id="l31.2377" class="difflineat">@@ -2492,175 +2320,156 @@ function MsgApplyFilters()</span>
<a href="#l31.2378"></a><span id="l31.2378">   // code would have to clone filters to allow disabled filters to run,</span>
<a href="#l31.2379"></a><span id="l31.2379">   // and we don't support cloning filters currently.</span>
<a href="#l31.2380"></a><span id="l31.2380">   let tempFilterList = MailServices.filters.getTempFilterList(preselectedFolder);</span>
<a href="#l31.2381"></a><span id="l31.2381">   let numFilters = curFilterList.filterCount;</span>
<a href="#l31.2382"></a><span id="l31.2382">   // make sure the temp filter list uses the same log stream</span>
<a href="#l31.2383"></a><span id="l31.2383">   tempFilterList.logStream = curFilterList.logStream;</span>
<a href="#l31.2384"></a><span id="l31.2384">   tempFilterList.loggingEnabled = curFilterList.loggingEnabled;</span>
<a href="#l31.2385"></a><span id="l31.2385">   let newFilterIndex = 0;</span>
<a href="#l31.2386"></a><span id="l31.2386" class="difflineminus">-  for (let i = 0; i &lt; numFilters; i++)</span>
<a href="#l31.2387"></a><span id="l31.2387" class="difflineminus">-  {</span>
<a href="#l31.2388"></a><span id="l31.2388" class="difflineplus">+  for (let i = 0; i &lt; numFilters; i++) {</span>
<a href="#l31.2389"></a><span id="l31.2389">     let curFilter = curFilterList.getFilterAt(i);</span>
<a href="#l31.2390"></a><span id="l31.2390">     // only add enabled, UI visible filters that are in the manual context</span>
<a href="#l31.2391"></a><span id="l31.2391">     if (curFilter.enabled &amp;&amp; !curFilter.temporary &amp;&amp;</span>
<a href="#l31.2392"></a><span id="l31.2392" class="difflineminus">-        (curFilter.filterType &amp; Ci.nsMsgFilterType.Manual))</span>
<a href="#l31.2393"></a><span id="l31.2393" class="difflineminus">-    {</span>
<a href="#l31.2394"></a><span id="l31.2394" class="difflineplus">+        (curFilter.filterType &amp; Ci.nsMsgFilterType.Manual)) {</span>
<a href="#l31.2395"></a><span id="l31.2395">       tempFilterList.insertFilterAt(newFilterIndex, curFilter);</span>
<a href="#l31.2396"></a><span id="l31.2396">       newFilterIndex++;</span>
<a href="#l31.2397"></a><span id="l31.2397">     }</span>
<a href="#l31.2398"></a><span id="l31.2398">   }</span>
<a href="#l31.2399"></a><span id="l31.2399">   MailServices.filters.applyFiltersToFolders(tempFilterList, selectedFolders, msgWindow);</span>
<a href="#l31.2400"></a><span id="l31.2400"> }</span>
<a href="#l31.2401"></a><span id="l31.2401"> </span>
<a href="#l31.2402"></a><span id="l31.2402" class="difflineminus">-function MsgApplyFiltersToSelection()</span>
<a href="#l31.2403"></a><span id="l31.2403" class="difflineminus">-{</span>
<a href="#l31.2404"></a><span id="l31.2404" class="difflineplus">+function MsgApplyFiltersToSelection() {</span>
<a href="#l31.2405"></a><span id="l31.2405">   // bail if we're dealing with a dummy header</span>
<a href="#l31.2406"></a><span id="l31.2406">   if (gMessageDisplay.isDummy)</span>
<a href="#l31.2407"></a><span id="l31.2407">     return;</span>
<a href="#l31.2408"></a><span id="l31.2408"> </span>
<a href="#l31.2409"></a><span id="l31.2409">   var selectedMessages = gFolderDisplay.selectedMessages;</span>
<a href="#l31.2410"></a><span id="l31.2410">   if (selectedMessages.length) {</span>
<a href="#l31.2411"></a><span id="l31.2411">     MailServices.filters.applyFilters(Ci.nsMsgFilterType.Manual,</span>
<a href="#l31.2412"></a><span id="l31.2412">                                       toXPCOMArray(selectedMessages,</span>
<a href="#l31.2413"></a><span id="l31.2413">                                                    Ci.nsIMutableArray),</span>
<a href="#l31.2414"></a><span id="l31.2414">                                       gFolderDisplay.displayedFolder,</span>
<a href="#l31.2415"></a><span id="l31.2415">                                       msgWindow);</span>
<a href="#l31.2416"></a><span id="l31.2416">   }</span>
<a href="#l31.2417"></a><span id="l31.2417"> }</span>
<a href="#l31.2418"></a><span id="l31.2418"> </span>
<a href="#l31.2419"></a><span id="l31.2419" class="difflineminus">-function ChangeMailLayout(newLayout)</span>
<a href="#l31.2420"></a><span id="l31.2420" class="difflineminus">-{</span>
<a href="#l31.2421"></a><span id="l31.2421" class="difflineplus">+function ChangeMailLayout(newLayout) {</span>
<a href="#l31.2422"></a><span id="l31.2422">   Services.prefs.setIntPref(&quot;mail.pane_config.dynamic&quot;, newLayout);</span>
<a href="#l31.2423"></a><span id="l31.2423"> }</span>
<a href="#l31.2424"></a><span id="l31.2424"> </span>
<a href="#l31.2425"></a><span id="l31.2425" class="difflineminus">-function ChangeMailLayoutForCommand(aCommand)</span>
<a href="#l31.2426"></a><span id="l31.2426" class="difflineminus">-{</span>
<a href="#l31.2427"></a><span id="l31.2427" class="difflineplus">+function ChangeMailLayoutForCommand(aCommand) {</span>
<a href="#l31.2428"></a><span id="l31.2428">   ChangeMailLayout(kMailLayoutCommandMap[aCommand]);</span>
<a href="#l31.2429"></a><span id="l31.2429"> }</span>
<a href="#l31.2430"></a><span id="l31.2430"> </span>
<a href="#l31.2431"></a><span id="l31.2431" class="difflineminus">-function MsgViewAllHeaders()</span>
<a href="#l31.2432"></a><span id="l31.2432" class="difflineminus">-{</span>
<a href="#l31.2433"></a><span id="l31.2433" class="difflineplus">+function MsgViewAllHeaders() {</span>
<a href="#l31.2434"></a><span id="l31.2434">   const mode = Ci.nsMimeHeaderDisplayTypes.AllHeaders;</span>
<a href="#l31.2435"></a><span id="l31.2435">   Services.prefs.setIntPref(&quot;mail.show_headers&quot;, mode); // 2</span>
<a href="#l31.2436"></a><span id="l31.2436">   AdjustHeaderView(mode);</span>
<a href="#l31.2437"></a><span id="l31.2437">   ReloadMessage();</span>
<a href="#l31.2438"></a><span id="l31.2438"> }</span>
<a href="#l31.2439"></a><span id="l31.2439"> </span>
<a href="#l31.2440"></a><span id="l31.2440" class="difflineminus">-function MsgViewNormalHeaders()</span>
<a href="#l31.2441"></a><span id="l31.2441" class="difflineminus">-{</span>
<a href="#l31.2442"></a><span id="l31.2442" class="difflineplus">+function MsgViewNormalHeaders() {</span>
<a href="#l31.2443"></a><span id="l31.2443">   const mode = Ci.nsMimeHeaderDisplayTypes.NormalHeaders;</span>
<a href="#l31.2444"></a><span id="l31.2444">   Services.prefs.setIntPref(&quot;mail.show_headers&quot;, mode); // 1</span>
<a href="#l31.2445"></a><span id="l31.2445">   AdjustHeaderView(mode);</span>
<a href="#l31.2446"></a><span id="l31.2446">   ReloadMessage();</span>
<a href="#l31.2447"></a><span id="l31.2447"> }</span>
<a href="#l31.2448"></a><span id="l31.2448"> </span>
<a href="#l31.2449"></a><span id="l31.2449" class="difflineminus">-function MsgBodyAllowHTML()</span>
<a href="#l31.2450"></a><span id="l31.2450" class="difflineminus">-{</span>
<a href="#l31.2451"></a><span id="l31.2451" class="difflineplus">+function MsgBodyAllowHTML() {</span>
<a href="#l31.2452"></a><span id="l31.2452">   Services.prefs.setBoolPref(&quot;mailnews.display.prefer_plaintext&quot;, false);</span>
<a href="#l31.2453"></a><span id="l31.2453">   Services.prefs.setIntPref(&quot;mailnews.display.html_as&quot;, 0);</span>
<a href="#l31.2454"></a><span id="l31.2454">   Services.prefs.setIntPref(&quot;mailnews.display.disallow_mime_handlers&quot;, 0);</span>
<a href="#l31.2455"></a><span id="l31.2455">   ReloadMessage();</span>
<a href="#l31.2456"></a><span id="l31.2456"> }</span>
<a href="#l31.2457"></a><span id="l31.2457"> </span>
<a href="#l31.2458"></a><span id="l31.2458" class="difflineminus">-function MsgBodySanitized()</span>
<a href="#l31.2459"></a><span id="l31.2459" class="difflineminus">-{</span>
<a href="#l31.2460"></a><span id="l31.2460" class="difflineplus">+function MsgBodySanitized() {</span>
<a href="#l31.2461"></a><span id="l31.2461">   Services.prefs.setBoolPref(&quot;mailnews.display.prefer_plaintext&quot;, false);</span>
<a href="#l31.2462"></a><span id="l31.2462">   Services.prefs.setIntPref(&quot;mailnews.display.html_as&quot;, 3);</span>
<a href="#l31.2463"></a><span id="l31.2463">   Services.prefs.setIntPref(&quot;mailnews.display.disallow_mime_handlers&quot;,</span>
<a href="#l31.2464"></a><span id="l31.2464">                          gDisallow_classes_no_html);</span>
<a href="#l31.2465"></a><span id="l31.2465">   ReloadMessage();</span>
<a href="#l31.2466"></a><span id="l31.2466"> }</span>
<a href="#l31.2467"></a><span id="l31.2467"> </span>
<a href="#l31.2468"></a><span id="l31.2468" class="difflineminus">-function MsgBodyAsPlaintext()</span>
<a href="#l31.2469"></a><span id="l31.2469" class="difflineminus">-{</span>
<a href="#l31.2470"></a><span id="l31.2470" class="difflineplus">+function MsgBodyAsPlaintext() {</span>
<a href="#l31.2471"></a><span id="l31.2471">   Services.prefs.setBoolPref(&quot;mailnews.display.prefer_plaintext&quot;, true);</span>
<a href="#l31.2472"></a><span id="l31.2472">   Services.prefs.setIntPref(&quot;mailnews.display.html_as&quot;, 1);</span>
<a href="#l31.2473"></a><span id="l31.2473">   Services.prefs.setIntPref(&quot;mailnews.display.disallow_mime_handlers&quot;,</span>
<a href="#l31.2474"></a><span id="l31.2474">                          gDisallow_classes_no_html);</span>
<a href="#l31.2475"></a><span id="l31.2475">   ReloadMessage();</span>
<a href="#l31.2476"></a><span id="l31.2476"> }</span>
<a href="#l31.2477"></a><span id="l31.2477"> </span>
<a href="#l31.2478"></a><span id="l31.2478" class="difflineminus">-function MsgBodyAllParts()</span>
<a href="#l31.2479"></a><span id="l31.2479" class="difflineminus">-{</span>
<a href="#l31.2480"></a><span id="l31.2480" class="difflineplus">+function MsgBodyAllParts() {</span>
<a href="#l31.2481"></a><span id="l31.2481">   Services.prefs.setBoolPref(&quot;mailnews.display.prefer_plaintext&quot;, false);</span>
<a href="#l31.2482"></a><span id="l31.2482">   Services.prefs.setIntPref(&quot;mailnews.display.html_as&quot;, 4);</span>
<a href="#l31.2483"></a><span id="l31.2483">   Services.prefs.setIntPref(&quot;mailnews.display.disallow_mime_handlers&quot;, 0);</span>
<a href="#l31.2484"></a><span id="l31.2484">   ReloadMessage();</span>
<a href="#l31.2485"></a><span id="l31.2485"> }</span>
<a href="#l31.2486"></a><span id="l31.2486"> </span>
<a href="#l31.2487"></a><span id="l31.2487" class="difflineminus">-function MsgFeedBodyRenderPrefs(plaintext, html, mime)</span>
<a href="#l31.2488"></a><span id="l31.2488" class="difflineminus">-{</span>
<a href="#l31.2489"></a><span id="l31.2489" class="difflineplus">+function MsgFeedBodyRenderPrefs(plaintext, html, mime) {</span>
<a href="#l31.2490"></a><span id="l31.2490">   // Separate render prefs not implemented for feeds, bug 458606.</span>
<a href="#l31.2491"></a><span id="l31.2491">   //  Services.prefs.setBoolPref(&quot;rss.display.prefer_plaintext&quot;, plaintext);</span>
<a href="#l31.2492"></a><span id="l31.2492">   //  Services.prefs.setIntPref(&quot;rss.display.html_as&quot;, html);</span>
<a href="#l31.2493"></a><span id="l31.2493">   //  Services.prefs.setIntPref(&quot;rss.display.disallow_mime_handlers&quot;, mime);</span>
<a href="#l31.2494"></a><span id="l31.2494"> </span>
<a href="#l31.2495"></a><span id="l31.2495">   Services.prefs.setBoolPref(&quot;mailnews.display.prefer_plaintext&quot;, plaintext);</span>
<a href="#l31.2496"></a><span id="l31.2496">   Services.prefs.setIntPref(&quot;mailnews.display.html_as&quot;, html);</span>
<a href="#l31.2497"></a><span id="l31.2497">   Services.prefs.setIntPref(&quot;mailnews.display.disallow_mime_handlers&quot;, mime);</span>
<a href="#l31.2498"></a><span id="l31.2498">   // Reload only if showing rss summary; menuitem hidden if web page..</span>
<a href="#l31.2499"></a><span id="l31.2499">   ReloadMessage();</span>
<a href="#l31.2500"></a><span id="l31.2500"> }</span>
<a href="#l31.2501"></a><span id="l31.2501"> </span>
<a href="#l31.2502"></a><span id="l31.2502" class="difflineminus">-function ToggleInlineAttachment(target)</span>
<a href="#l31.2503"></a><span id="l31.2503" class="difflineminus">-{</span>
<a href="#l31.2504"></a><span id="l31.2504" class="difflineplus">+function ToggleInlineAttachment(target) {</span>
<a href="#l31.2505"></a><span id="l31.2505">   var viewAttachmentInline = !Services.prefs.getBoolPref(&quot;mail.inline_attachments&quot;);</span>
<a href="#l31.2506"></a><span id="l31.2506" class="difflineminus">-  Services.prefs.setBoolPref(&quot;mail.inline_attachments&quot;, viewAttachmentInline)</span>
<a href="#l31.2507"></a><span id="l31.2507" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.inline_attachments&quot;, viewAttachmentInline);</span>
<a href="#l31.2508"></a><span id="l31.2508">   target.setAttribute(&quot;checked&quot;, viewAttachmentInline ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l31.2509"></a><span id="l31.2509">   ReloadMessage();</span>
<a href="#l31.2510"></a><span id="l31.2510"> }</span>
<a href="#l31.2511"></a><span id="l31.2511"> </span>
<a href="#l31.2512"></a><span id="l31.2512" class="difflineminus">-function PrintEnginePrintInternal(doPrintPreview, msgType)</span>
<a href="#l31.2513"></a><span id="l31.2513" class="difflineminus">-{</span>
<a href="#l31.2514"></a><span id="l31.2514" class="difflineplus">+function PrintEnginePrintInternal(doPrintPreview, msgType) {</span>
<a href="#l31.2515"></a><span id="l31.2515">   var messageList = gFolderDisplay.selectedMessageUris;</span>
<a href="#l31.2516"></a><span id="l31.2516">   if (!messageList) {</span>
<a href="#l31.2517"></a><span id="l31.2517">     dump(&quot;PrintEnginePrintInternal(): No messages selected.\n&quot;);</span>
<a href="#l31.2518"></a><span id="l31.2518">     return;</span>
<a href="#l31.2519"></a><span id="l31.2519">   }</span>
<a href="#l31.2520"></a><span id="l31.2520"> </span>
<a href="#l31.2521"></a><span id="l31.2521">   window.openDialog(&quot;chrome://messenger/content/msgPrintEngine.xul&quot;, &quot;&quot;,</span>
<a href="#l31.2522"></a><span id="l31.2522">                     &quot;chrome,dialog=no,all,centerscreen&quot;,</span>
<a href="#l31.2523"></a><span id="l31.2523">                     messageList.length, messageList, statusFeedback,</span>
<a href="#l31.2524"></a><span id="l31.2524">                     doPrintPreview, msgType);</span>
<a href="#l31.2525"></a><span id="l31.2525"> }</span>
<a href="#l31.2526"></a><span id="l31.2526"> </span>
<a href="#l31.2527"></a><span id="l31.2527" class="difflineminus">-function PrintEnginePrint()</span>
<a href="#l31.2528"></a><span id="l31.2528" class="difflineminus">-{</span>
<a href="#l31.2529"></a><span id="l31.2529" class="difflineplus">+function PrintEnginePrint() {</span>
<a href="#l31.2530"></a><span id="l31.2530">   return PrintEnginePrintInternal(false,</span>
<a href="#l31.2531"></a><span id="l31.2531">     Ci.nsIMsgPrintEngine.MNAB_PRINT_MSG);</span>
<a href="#l31.2532"></a><span id="l31.2532"> }</span>
<a href="#l31.2533"></a><span id="l31.2533"> </span>
<a href="#l31.2534"></a><span id="l31.2534" class="difflineminus">-function PrintEnginePrintPreview()</span>
<a href="#l31.2535"></a><span id="l31.2535" class="difflineminus">-{</span>
<a href="#l31.2536"></a><span id="l31.2536" class="difflineplus">+function PrintEnginePrintPreview() {</span>
<a href="#l31.2537"></a><span id="l31.2537">   return PrintEnginePrintInternal(true,</span>
<a href="#l31.2538"></a><span id="l31.2538">     Ci.nsIMsgPrintEngine.MNAB_PRINTPREVIEW_MSG);</span>
<a href="#l31.2539"></a><span id="l31.2539"> }</span>
<a href="#l31.2540"></a><span id="l31.2540"> </span>
<a href="#l31.2541"></a><span id="l31.2541" class="difflineminus">-function IsMailFolderSelected()</span>
<a href="#l31.2542"></a><span id="l31.2542" class="difflineminus">-{</span>
<a href="#l31.2543"></a><span id="l31.2543" class="difflineplus">+function IsMailFolderSelected() {</span>
<a href="#l31.2544"></a><span id="l31.2544">   var selectedFolders = GetSelectedMsgFolders();</span>
<a href="#l31.2545"></a><span id="l31.2545">   var folder = selectedFolders.length ? selectedFolders[0] : null;</span>
<a href="#l31.2546"></a><span id="l31.2546">   return folder &amp;&amp; folder.server.type != &quot;nntp&quot;;</span>
<a href="#l31.2547"></a><span id="l31.2547"> }</span>
<a href="#l31.2548"></a><span id="l31.2548"> </span>
<a href="#l31.2549"></a><span id="l31.2549" class="difflineminus">-function IsGetNewMessagesEnabled()</span>
<a href="#l31.2550"></a><span id="l31.2550" class="difflineminus">-{</span>
<a href="#l31.2551"></a><span id="l31.2551" class="difflineplus">+function IsGetNewMessagesEnabled() {</span>
<a href="#l31.2552"></a><span id="l31.2552">   let allServers = accountManager.allServers;</span>
<a href="#l31.2553"></a><span id="l31.2553">   for (let i = 0; i &lt; allServers.length; ++i) {</span>
<a href="#l31.2554"></a><span id="l31.2554">     let server = allServers.queryElementAt(i, Ci.nsIMsgIncomingServer);</span>
<a href="#l31.2555"></a><span id="l31.2555">     if (server.type == &quot;none&quot;)</span>
<a href="#l31.2556"></a><span id="l31.2556">       continue;</span>
<a href="#l31.2557"></a><span id="l31.2557">     return true;</span>
<a href="#l31.2558"></a><span id="l31.2558">   }</span>
<a href="#l31.2559"></a><span id="l31.2559">   return false;</span>
<a href="#l31.2560"></a><span id="l31.2560"> }</span>
<a href="#l31.2561"></a><span id="l31.2561"> </span>
<a href="#l31.2562"></a><span id="l31.2562" class="difflineminus">-function IsGetNextNMessagesEnabled()</span>
<a href="#l31.2563"></a><span id="l31.2563" class="difflineminus">-{</span>
<a href="#l31.2564"></a><span id="l31.2564" class="difflineplus">+function IsGetNextNMessagesEnabled() {</span>
<a href="#l31.2565"></a><span id="l31.2565">   var selectedFolders = GetSelectedMsgFolders();</span>
<a href="#l31.2566"></a><span id="l31.2566">   var folder = selectedFolders.length ? selectedFolders[0] : null;</span>
<a href="#l31.2567"></a><span id="l31.2567"> </span>
<a href="#l31.2568"></a><span id="l31.2568">   var menuItem = document.getElementById(&quot;menu_getnextnmsg&quot;);</span>
<a href="#l31.2569"></a><span id="l31.2569">   var appMenuItem = document.getElementById(&quot;appmenu_getNextNMsgs&quot;);</span>
<a href="#l31.2570"></a><span id="l31.2570">   if (folder &amp;&amp; !folder.isServer &amp;&amp;</span>
<a href="#l31.2571"></a><span id="l31.2571">       folder.server instanceof Ci.nsINntpIncomingServer) {</span>
<a href="#l31.2572"></a><span id="l31.2572">     menuItem.label = PluralForm.get(folder.server.maxArticles,</span>
<a href="#l31.2573"></a><span id="l31.2573" class="difflineat">@@ -2670,159 +2479,147 @@ function IsGetNextNMessagesEnabled()</span>
<a href="#l31.2574"></a><span id="l31.2574">     menuItem.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l31.2575"></a><span id="l31.2575">     if (appMenuItem) {</span>
<a href="#l31.2576"></a><span id="l31.2576">       appMenuItem.label = menuItem.label;</span>
<a href="#l31.2577"></a><span id="l31.2577">       appMenuItem.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l31.2578"></a><span id="l31.2578">     }</span>
<a href="#l31.2579"></a><span id="l31.2579">     return true;</span>
<a href="#l31.2580"></a><span id="l31.2580">   }</span>
<a href="#l31.2581"></a><span id="l31.2581"> </span>
<a href="#l31.2582"></a><span id="l31.2582" class="difflineminus">-  menuItem.setAttribute(&quot;hidden&quot;,&quot;true&quot;);</span>
<a href="#l31.2583"></a><span id="l31.2583" class="difflineplus">+  menuItem.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l31.2584"></a><span id="l31.2584">   if (appMenuItem) {</span>
<a href="#l31.2585"></a><span id="l31.2585" class="difflineminus">-    appMenuItem.setAttribute(&quot;hidden&quot;,&quot;true&quot;);</span>
<a href="#l31.2586"></a><span id="l31.2586" class="difflineplus">+    appMenuItem.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l31.2587"></a><span id="l31.2587">   }</span>
<a href="#l31.2588"></a><span id="l31.2588">   return false;</span>
<a href="#l31.2589"></a><span id="l31.2589"> }</span>
<a href="#l31.2590"></a><span id="l31.2590"> </span>
<a href="#l31.2591"></a><span id="l31.2591" class="difflineminus">-function MsgSynchronizeOffline()</span>
<a href="#l31.2592"></a><span id="l31.2592" class="difflineminus">-{</span>
<a href="#l31.2593"></a><span id="l31.2593" class="difflineplus">+function MsgSynchronizeOffline() {</span>
<a href="#l31.2594"></a><span id="l31.2594">   window.openDialog(&quot;chrome://messenger/content/msgSynchronize.xul&quot;, &quot;&quot;,</span>
<a href="#l31.2595"></a><span id="l31.2595">                     &quot;centerscreen,chrome,modal,titlebar,resizable=yes&quot;,</span>
<a href="#l31.2596"></a><span id="l31.2596" class="difflineminus">-                    {msgWindow:msgWindow});</span>
<a href="#l31.2597"></a><span id="l31.2597" class="difflineplus">+                    {msgWindow});</span>
<a href="#l31.2598"></a><span id="l31.2598"> }</span>
<a href="#l31.2599"></a><span id="l31.2599"> </span>
<a href="#l31.2600"></a><span id="l31.2600" class="difflineminus">-function SpaceHit(event)</span>
<a href="#l31.2601"></a><span id="l31.2601" class="difflineminus">-{</span>
<a href="#l31.2602"></a><span id="l31.2602" class="difflineplus">+function SpaceHit(event) {</span>
<a href="#l31.2603"></a><span id="l31.2603">   // If focus is in chrome, we want to scroll the content window, unless</span>
<a href="#l31.2604"></a><span id="l31.2604">   // the focus is on an important chrome button like the otherActionsButton</span>
<a href="#l31.2605"></a><span id="l31.2605">   // popup; if focus is on a non-link content element like a button, bail so we</span>
<a href="#l31.2606"></a><span id="l31.2606">   // don't scroll when the element is going to do something else.</span>
<a href="#l31.2607"></a><span id="l31.2607"> </span>
<a href="#l31.2608"></a><span id="l31.2608">   var contentWindow = document.commandDispatcher.focusedWindow;</span>
<a href="#l31.2609"></a><span id="l31.2609">   let focusedElement = document.commandDispatcher.focusedElement;</span>
<a href="#l31.2610"></a><span id="l31.2610"> </span>
<a href="#l31.2611"></a><span id="l31.2611">   if (!gMessageDisplay.singleMessageDisplay) {</span>
<a href="#l31.2612"></a><span id="l31.2612">     contentWindow = document.getElementById(&quot;multimessage&quot;).contentWindow;</span>
<a href="#l31.2613"></a><span id="l31.2613">   } else if (contentWindow.top == window) {</span>
<a href="#l31.2614"></a><span id="l31.2614">     // These elements should always take priority over scrolling.</span>
<a href="#l31.2615"></a><span id="l31.2615">     const importantElements = [&quot;otherActionsButton&quot;, &quot;attachmentToggle&quot;];</span>
<a href="#l31.2616"></a><span id="l31.2616">     contentWindow = window.content;</span>
<a href="#l31.2617"></a><span id="l31.2617">     if (focusedElement &amp;&amp; importantElements.includes(focusedElement.id))</span>
<a href="#l31.2618"></a><span id="l31.2618">       return;</span>
<a href="#l31.2619"></a><span id="l31.2619" class="difflineplus">+  } else if (focusedElement &amp;&amp; !hRefForClickEvent(event)) {</span>
<a href="#l31.2620"></a><span id="l31.2620" class="difflineplus">+    return;</span>
<a href="#l31.2621"></a><span id="l31.2621">   }</span>
<a href="#l31.2622"></a><span id="l31.2622" class="difflineminus">-  else if (focusedElement &amp;&amp; !hRefForClickEvent(event))</span>
<a href="#l31.2623"></a><span id="l31.2623" class="difflineminus">-    return;</span>
<a href="#l31.2624"></a><span id="l31.2624"> </span>
<a href="#l31.2625"></a><span id="l31.2625">   if (!contentWindow)</span>
<a href="#l31.2626"></a><span id="l31.2626">     return;</span>
<a href="#l31.2627"></a><span id="l31.2627"> </span>
<a href="#l31.2628"></a><span id="l31.2628" class="difflineminus">-  var rssiframe = contentWindow.document.getElementById('_mailrssiframe');</span>
<a href="#l31.2629"></a><span id="l31.2629" class="difflineplus">+  var rssiframe = contentWindow.document.getElementById(&quot;_mailrssiframe&quot;);</span>
<a href="#l31.2630"></a><span id="l31.2630">   // If we are displaying an RSS article, we really want to scroll</span>
<a href="#l31.2631"></a><span id="l31.2631">   // the nested iframe.</span>
<a href="#l31.2632"></a><span id="l31.2632">   if (contentWindow == window.content &amp;&amp; rssiframe)</span>
<a href="#l31.2633"></a><span id="l31.2633">     contentWindow = rssiframe.contentWindow;</span>
<a href="#l31.2634"></a><span id="l31.2634"> </span>
<a href="#l31.2635"></a><span id="l31.2635">   if (event &amp;&amp; event.shiftKey) {</span>
<a href="#l31.2636"></a><span id="l31.2636">     // if at the start of the message, go to the previous one</span>
<a href="#l31.2637"></a><span id="l31.2637">     if (contentWindow.scrollY &gt; 0)</span>
<a href="#l31.2638"></a><span id="l31.2638">       contentWindow.scrollByPages(-1);</span>
<a href="#l31.2639"></a><span id="l31.2639">     else if (Services.prefs.getBoolPref(&quot;mail.advance_on_spacebar&quot;))</span>
<a href="#l31.2640"></a><span id="l31.2640">       goDoCommand(&quot;cmd_previousUnreadMsg&quot;);</span>
<a href="#l31.2641"></a><span id="l31.2641" class="difflineminus">-  }</span>
<a href="#l31.2642"></a><span id="l31.2642" class="difflineminus">-  else {</span>
<a href="#l31.2643"></a><span id="l31.2643" class="difflineplus">+  } else if (contentWindow.scrollY &lt; contentWindow.scrollMaxY) {</span>
<a href="#l31.2644"></a><span id="l31.2644">     // if at the end of the message, go to the next one</span>
<a href="#l31.2645"></a><span id="l31.2645" class="difflineminus">-    if (contentWindow.scrollY &lt; contentWindow.scrollMaxY)</span>
<a href="#l31.2646"></a><span id="l31.2646" class="difflineminus">-      contentWindow.scrollByPages(1);</span>
<a href="#l31.2647"></a><span id="l31.2647" class="difflineminus">-    else if (Services.prefs.getBoolPref(&quot;mail.advance_on_spacebar&quot;))</span>
<a href="#l31.2648"></a><span id="l31.2648" class="difflineminus">-      goDoCommand(&quot;cmd_nextUnreadMsg&quot;);</span>
<a href="#l31.2649"></a><span id="l31.2649" class="difflineplus">+    contentWindow.scrollByPages(1);</span>
<a href="#l31.2650"></a><span id="l31.2650" class="difflineplus">+  } else if (Services.prefs.getBoolPref(&quot;mail.advance_on_spacebar&quot;)) {</span>
<a href="#l31.2651"></a><span id="l31.2651" class="difflineplus">+    goDoCommand(&quot;cmd_nextUnreadMsg&quot;);</span>
<a href="#l31.2652"></a><span id="l31.2652">   }</span>
<a href="#l31.2653"></a><span id="l31.2653"> }</span>
<a href="#l31.2654"></a><span id="l31.2654"> </span>
<a href="#l31.2655"></a><span id="l31.2655" class="difflineminus">-function IsAccountOfflineEnabled()</span>
<a href="#l31.2656"></a><span id="l31.2656" class="difflineminus">-{</span>
<a href="#l31.2657"></a><span id="l31.2657" class="difflineplus">+function IsAccountOfflineEnabled() {</span>
<a href="#l31.2658"></a><span id="l31.2658">   var selectedFolders = GetSelectedMsgFolders();</span>
<a href="#l31.2659"></a><span id="l31.2659"> </span>
<a href="#l31.2660"></a><span id="l31.2660">   if (selectedFolders &amp;&amp; (selectedFolders.length == 1))</span>
<a href="#l31.2661"></a><span id="l31.2661">       return selectedFolders[0].supportsOffline;</span>
<a href="#l31.2662"></a><span id="l31.2662">   return false;</span>
<a href="#l31.2663"></a><span id="l31.2663"> }</span>
<a href="#l31.2664"></a><span id="l31.2664"> </span>
<a href="#l31.2665"></a><span id="l31.2665" class="difflineminus">-function GetDefaultAccountRootFolder()</span>
<a href="#l31.2666"></a><span id="l31.2666" class="difflineminus">-{</span>
<a href="#l31.2667"></a><span id="l31.2667" class="difflineplus">+function GetDefaultAccountRootFolder() {</span>
<a href="#l31.2668"></a><span id="l31.2668">   try {</span>
<a href="#l31.2669"></a><span id="l31.2669">     var account = accountManager.defaultAccount;</span>
<a href="#l31.2670"></a><span id="l31.2670">     var defaultServer = account.incomingServer;</span>
<a href="#l31.2671"></a><span id="l31.2671">     var defaultFolder = defaultServer.rootMsgFolder;</span>
<a href="#l31.2672"></a><span id="l31.2672">     return defaultFolder;</span>
<a href="#l31.2673"></a><span id="l31.2673" class="difflineminus">-  }</span>
<a href="#l31.2674"></a><span id="l31.2674" class="difflineminus">-  catch (ex) {</span>
<a href="#l31.2675"></a><span id="l31.2675" class="difflineplus">+  } catch (ex) {</span>
<a href="#l31.2676"></a><span id="l31.2676">   }</span>
<a href="#l31.2677"></a><span id="l31.2677">   return null;</span>
<a href="#l31.2678"></a><span id="l31.2678"> }</span>
<a href="#l31.2679"></a><span id="l31.2679"> </span>
<a href="#l31.2680"></a><span id="l31.2680"> /**</span>
<a href="#l31.2681"></a><span id="l31.2681">  * Check for new messages for all selected folders, or for the default account</span>
<a href="#l31.2682"></a><span id="l31.2682">  * in case no folders are selected.</span>
<a href="#l31.2683"></a><span id="l31.2683">  */</span>
<a href="#l31.2684"></a><span id="l31.2684" class="difflineminus">-function GetFolderMessages()</span>
<a href="#l31.2685"></a><span id="l31.2685" class="difflineminus">-{</span>
<a href="#l31.2686"></a><span id="l31.2686" class="difflineplus">+function GetFolderMessages() {</span>
<a href="#l31.2687"></a><span id="l31.2687">   var selectedFolders = GetSelectedMsgFolders();</span>
<a href="#l31.2688"></a><span id="l31.2688">   var defaultAccountRootFolder = GetDefaultAccountRootFolder();</span>
<a href="#l31.2689"></a><span id="l31.2689"> </span>
<a href="#l31.2690"></a><span id="l31.2690">   // if no default account, get msg isn't going do anything anyways</span>
<a href="#l31.2691"></a><span id="l31.2691">   // so bail out</span>
<a href="#l31.2692"></a><span id="l31.2692">   if (!defaultAccountRootFolder)</span>
<a href="#l31.2693"></a><span id="l31.2693">     return;</span>
<a href="#l31.2694"></a><span id="l31.2694"> </span>
<a href="#l31.2695"></a><span id="l31.2695">   // if nothing selected, use the default</span>
<a href="#l31.2696"></a><span id="l31.2696">   var folders = (selectedFolders.length) ? selectedFolders : [defaultAccountRootFolder];</span>
<a href="#l31.2697"></a><span id="l31.2697">   for (var i = 0; i &lt; folders.length; i++) {</span>
<a href="#l31.2698"></a><span id="l31.2698">     var serverType = folders[i].server.type;</span>
<a href="#l31.2699"></a><span id="l31.2699">     if (folders[i].isServer &amp;&amp; (serverType == &quot;nntp&quot;)) {</span>
<a href="#l31.2700"></a><span id="l31.2700">       // If we're doing &quot;get msgs&quot; on a news server,</span>
<a href="#l31.2701"></a><span id="l31.2701">       // update unread counts on this server.</span>
<a href="#l31.2702"></a><span id="l31.2702">       folders[i].server.performExpand(msgWindow);</span>
<a href="#l31.2703"></a><span id="l31.2703" class="difflineminus">-    }</span>
<a href="#l31.2704"></a><span id="l31.2704" class="difflineminus">-    else if (serverType == &quot;none&quot;) {</span>
<a href="#l31.2705"></a><span id="l31.2705" class="difflineplus">+    } else if (serverType == &quot;none&quot;) {</span>
<a href="#l31.2706"></a><span id="l31.2706">       // If &quot;Local Folders&quot; is selected and the user does &quot;Get Msgs&quot; and</span>
<a href="#l31.2707"></a><span id="l31.2707">       // LocalFolders is not deferred to, get new mail for the default account</span>
<a href="#l31.2708"></a><span id="l31.2708">       //</span>
<a href="#l31.2709"></a><span id="l31.2709">       // XXX TODO</span>
<a href="#l31.2710"></a><span id="l31.2710">       // Should shift click get mail for all (authenticated) accounts?</span>
<a href="#l31.2711"></a><span id="l31.2711">       // see bug #125885.</span>
<a href="#l31.2712"></a><span id="l31.2712">       if (!folders[i].server.isDeferredTo)</span>
<a href="#l31.2713"></a><span id="l31.2713">         GetNewMsgs(defaultAccountRootFolder.server, defaultAccountRootFolder);</span>
<a href="#l31.2714"></a><span id="l31.2714">       else</span>
<a href="#l31.2715"></a><span id="l31.2715">         GetNewMsgs(folders[i].server, folders[i]);</span>
<a href="#l31.2716"></a><span id="l31.2716" class="difflineminus">-    }</span>
<a href="#l31.2717"></a><span id="l31.2717" class="difflineminus">-    else {</span>
<a href="#l31.2718"></a><span id="l31.2718" class="difflineplus">+    } else {</span>
<a href="#l31.2719"></a><span id="l31.2719">       GetNewMsgs(folders[i].server, folders[i]);</span>
<a href="#l31.2720"></a><span id="l31.2720">     }</span>
<a href="#l31.2721"></a><span id="l31.2721">   }</span>
<a href="#l31.2722"></a><span id="l31.2722"> }</span>
<a href="#l31.2723"></a><span id="l31.2723"> </span>
<a href="#l31.2724"></a><span id="l31.2724"> /**</span>
<a href="#l31.2725"></a><span id="l31.2725">  * Gets new messages for the given server, for the given folder.</span>
<a href="#l31.2726"></a><span id="l31.2726">  * @param server which nsIMsgIncomingServer to check for new messages</span>
<a href="#l31.2727"></a><span id="l31.2727">  * @param folder which nsIMsgFolder folder to check for new messages</span>
<a href="#l31.2728"></a><span id="l31.2728">  */</span>
<a href="#l31.2729"></a><span id="l31.2729" class="difflineminus">-function GetNewMsgs(server, folder)</span>
<a href="#l31.2730"></a><span id="l31.2730" class="difflineminus">-{</span>
<a href="#l31.2731"></a><span id="l31.2731" class="difflineplus">+function GetNewMsgs(server, folder) {</span>
<a href="#l31.2732"></a><span id="l31.2732">   // Note that for Global Inbox folder.server != server when we want to get</span>
<a href="#l31.2733"></a><span id="l31.2733">   // messages for a specific account.</span>
<a href="#l31.2734"></a><span id="l31.2734"> </span>
<a href="#l31.2735"></a><span id="l31.2735">   const nsIMsgFolder = Ci.nsIMsgFolder;</span>
<a href="#l31.2736"></a><span id="l31.2736">   // Whenever we do get new messages, clear the old new messages.</span>
<a href="#l31.2737"></a><span id="l31.2737">   folder.biffState = nsIMsgFolder.nsMsgBiffState_NoMail;</span>
<a href="#l31.2738"></a><span id="l31.2738">   folder.clearNewMessages();</span>
<a href="#l31.2739"></a><span id="l31.2739">   server.getNewMessages(folder, msgWindow, null);</span>
<a href="#l31.2740"></a><span id="l31.2740"> }</span>
<a href="#l31.2741"></a><span id="l31.2741"> </span>
<a href="#l31.2742"></a><span id="l31.2742" class="difflineminus">-function SendUnsentMessages()</span>
<a href="#l31.2743"></a><span id="l31.2743" class="difflineminus">-{</span>
<a href="#l31.2744"></a><span id="l31.2744" class="difflineplus">+function SendUnsentMessages() {</span>
<a href="#l31.2745"></a><span id="l31.2745">   let msgSendlater = Cc[&quot;@mozilla.org/messengercompose/sendlater;1&quot;]</span>
<a href="#l31.2746"></a><span id="l31.2746">                        .getService(Ci.nsIMsgSendLater);</span>
<a href="#l31.2747"></a><span id="l31.2747"> </span>
<a href="#l31.2748"></a><span id="l31.2748">   let allIdentities = MailServices.accounts.allIdentities;</span>
<a href="#l31.2749"></a><span id="l31.2749">   let identitiesCount = allIdentities.length;</span>
<a href="#l31.2750"></a><span id="l31.2750">   for (let i = 0; i &lt; identitiesCount; i++) {</span>
<a href="#l31.2751"></a><span id="l31.2751">     let currentIdentity = allIdentities.queryElementAt(i, Ci.nsIMsgIdentity);</span>
<a href="#l31.2752"></a><span id="l31.2752">     let msgFolder = msgSendlater.getUnsentMessagesFolder(currentIdentity);</span>
<a href="#l31.2753"></a><span id="l31.2753" class="difflineat">@@ -2837,134 +2634,113 @@ function SendUnsentMessages()</span>
<a href="#l31.2754"></a><span id="l31.2754">         break;</span>
<a href="#l31.2755"></a><span id="l31.2755">       }</span>
<a href="#l31.2756"></a><span id="l31.2756">     }</span>
<a href="#l31.2757"></a><span id="l31.2757">   }</span>
<a href="#l31.2758"></a><span id="l31.2758"> }</span>
<a href="#l31.2759"></a><span id="l31.2759"> </span>
<a href="#l31.2760"></a><span id="l31.2760"> function CoalesceGetMsgsForPop3ServersByDestFolder(currentServer,</span>
<a href="#l31.2761"></a><span id="l31.2761">                                                    pop3DownloadServersArray,</span>
<a href="#l31.2762"></a><span id="l31.2762" class="difflineminus">-                                                   localFoldersToDownloadTo)</span>
<a href="#l31.2763"></a><span id="l31.2763" class="difflineminus">-{</span>
<a href="#l31.2764"></a><span id="l31.2764" class="difflineminus">-  var outNumFolders = new Object();</span>
<a href="#l31.2765"></a><span id="l31.2765" class="difflineplus">+                                                   localFoldersToDownloadTo) {</span>
<a href="#l31.2766"></a><span id="l31.2766">   var inboxFolder = currentServer.rootMsgFolder.getFolderWithFlags(Ci.nsMsgFolderFlags.Inbox);</span>
<a href="#l31.2767"></a><span id="l31.2767">   // coalesce the servers that download into the same folder...</span>
<a href="#l31.2768"></a><span id="l31.2768">   var index = localFoldersToDownloadTo.indexOf(inboxFolder);</span>
<a href="#l31.2769"></a><span id="l31.2769" class="difflineminus">-  if (index == -1)</span>
<a href="#l31.2770"></a><span id="l31.2770" class="difflineminus">-  {</span>
<a href="#l31.2771"></a><span id="l31.2771" class="difflineminus">-    if (inboxFolder)</span>
<a href="#l31.2772"></a><span id="l31.2772" class="difflineminus">-    {</span>
<a href="#l31.2773"></a><span id="l31.2773" class="difflineplus">+  if (index == -1) {</span>
<a href="#l31.2774"></a><span id="l31.2774" class="difflineplus">+    if (inboxFolder) {</span>
<a href="#l31.2775"></a><span id="l31.2775">       inboxFolder.biffState =  Ci.nsIMsgFolder.nsMsgBiffState_NoMail;</span>
<a href="#l31.2776"></a><span id="l31.2776">       inboxFolder.clearNewMessages();</span>
<a href="#l31.2777"></a><span id="l31.2777">     }</span>
<a href="#l31.2778"></a><span id="l31.2778">     localFoldersToDownloadTo.push(inboxFolder);</span>
<a href="#l31.2779"></a><span id="l31.2779">     index = pop3DownloadServersArray.length;</span>
<a href="#l31.2780"></a><span id="l31.2780">     pop3DownloadServersArray.push([]);</span>
<a href="#l31.2781"></a><span id="l31.2781">   }</span>
<a href="#l31.2782"></a><span id="l31.2782">   pop3DownloadServersArray[index].push(currentServer);</span>
<a href="#l31.2783"></a><span id="l31.2783"> }</span>
<a href="#l31.2784"></a><span id="l31.2784"> </span>
<a href="#l31.2785"></a><span id="l31.2785" class="difflineminus">-function GetMessagesForAllAuthenticatedAccounts()</span>
<a href="#l31.2786"></a><span id="l31.2786" class="difflineminus">-{</span>
<a href="#l31.2787"></a><span id="l31.2787" class="difflineplus">+function GetMessagesForAllAuthenticatedAccounts() {</span>
<a href="#l31.2788"></a><span id="l31.2788">   // now log into any server</span>
<a href="#l31.2789"></a><span id="l31.2789" class="difflineminus">-  try</span>
<a href="#l31.2790"></a><span id="l31.2790" class="difflineminus">-  {</span>
<a href="#l31.2791"></a><span id="l31.2791" class="difflineplus">+  try {</span>
<a href="#l31.2792"></a><span id="l31.2792">     var allServers = accountManager.allServers;</span>
<a href="#l31.2793"></a><span id="l31.2793">     // Array of arrays of servers for a particular folder.</span>
<a href="#l31.2794"></a><span id="l31.2794">     var pop3DownloadServersArray = [];</span>
<a href="#l31.2795"></a><span id="l31.2795">     // parallel array of folders to download to...</span>
<a href="#l31.2796"></a><span id="l31.2796">     var localFoldersToDownloadTo = [];</span>
<a href="#l31.2797"></a><span id="l31.2797">     var pop3Server;</span>
<a href="#l31.2798"></a><span id="l31.2798"> </span>
<a href="#l31.2799"></a><span id="l31.2799" class="difflineminus">-    for (var i = 0; i &lt; allServers.length; ++i)</span>
<a href="#l31.2800"></a><span id="l31.2800" class="difflineminus">-    {</span>
<a href="#l31.2801"></a><span id="l31.2801" class="difflineplus">+    for (let i = 0; i &lt; allServers.length; ++i) {</span>
<a href="#l31.2802"></a><span id="l31.2802">       var currentServer = allServers.queryElementAt(i, Ci.nsIMsgIncomingServer);</span>
<a href="#l31.2803"></a><span id="l31.2803">       if (currentServer.protocolInfo.canGetMessages &amp;&amp;</span>
<a href="#l31.2804"></a><span id="l31.2804" class="difflineminus">-          !currentServer.passwordPromptRequired)</span>
<a href="#l31.2805"></a><span id="l31.2805" class="difflineminus">-      {</span>
<a href="#l31.2806"></a><span id="l31.2806" class="difflineminus">-        if (currentServer.type == &quot;pop3&quot;)</span>
<a href="#l31.2807"></a><span id="l31.2807" class="difflineminus">-        {</span>
<a href="#l31.2808"></a><span id="l31.2808" class="difflineplus">+          !currentServer.passwordPromptRequired) {</span>
<a href="#l31.2809"></a><span id="l31.2809" class="difflineplus">+        if (currentServer.type == &quot;pop3&quot;) {</span>
<a href="#l31.2810"></a><span id="l31.2810">           CoalesceGetMsgsForPop3ServersByDestFolder(currentServer,</span>
<a href="#l31.2811"></a><span id="l31.2811">             pop3DownloadServersArray, localFoldersToDownloadTo);</span>
<a href="#l31.2812"></a><span id="l31.2812">           pop3Server = currentServer.QueryInterface(Ci.nsIPop3IncomingServer);</span>
<a href="#l31.2813"></a><span id="l31.2813" class="difflineplus">+        } else {</span>
<a href="#l31.2814"></a><span id="l31.2814" class="difflineplus">+          // get new messages on the server for imap or rss</span>
<a href="#l31.2815"></a><span id="l31.2815" class="difflineplus">+          GetMessagesForInboxOnServer(currentServer);</span>
<a href="#l31.2816"></a><span id="l31.2816">         }</span>
<a href="#l31.2817"></a><span id="l31.2817" class="difflineminus">-        else</span>
<a href="#l31.2818"></a><span id="l31.2818" class="difflineminus">-        // get new messages on the server for imap or rss</span>
<a href="#l31.2819"></a><span id="l31.2819" class="difflineminus">-          GetMessagesForInboxOnServer(currentServer);</span>
<a href="#l31.2820"></a><span id="l31.2820">       }</span>
<a href="#l31.2821"></a><span id="l31.2821">     }</span>
<a href="#l31.2822"></a><span id="l31.2822" class="difflineminus">-    for (var i = 0; i &lt; pop3DownloadServersArray.length; ++i)</span>
<a href="#l31.2823"></a><span id="l31.2823" class="difflineminus">-    {</span>
<a href="#l31.2824"></a><span id="l31.2824" class="difflineplus">+    for (let i = 0; i &lt; pop3DownloadServersArray.length; ++i) {</span>
<a href="#l31.2825"></a><span id="l31.2825">       // any ol' pop3Server will do - the serversArray specifies which servers to download from</span>
<a href="#l31.2826"></a><span id="l31.2826">       pop3Server.downloadMailFromServers(pop3DownloadServersArray[i],</span>
<a href="#l31.2827"></a><span id="l31.2827">                                          pop3DownloadServersArray[i].length,</span>
<a href="#l31.2828"></a><span id="l31.2828">                                          msgWindow,</span>
<a href="#l31.2829"></a><span id="l31.2829">                                          localFoldersToDownloadTo[i],</span>
<a href="#l31.2830"></a><span id="l31.2830">                                          null);</span>
<a href="#l31.2831"></a><span id="l31.2831">     }</span>
<a href="#l31.2832"></a><span id="l31.2832" class="difflineminus">-  }</span>
<a href="#l31.2833"></a><span id="l31.2833" class="difflineminus">-  catch(ex)</span>
<a href="#l31.2834"></a><span id="l31.2834" class="difflineminus">-  {</span>
<a href="#l31.2835"></a><span id="l31.2835" class="difflineplus">+  } catch (ex) {</span>
<a href="#l31.2836"></a><span id="l31.2836">       dump(ex + &quot;\n&quot;);</span>
<a href="#l31.2837"></a><span id="l31.2837">   }</span>
<a href="#l31.2838"></a><span id="l31.2838"> }</span>
<a href="#l31.2839"></a><span id="l31.2839"> </span>
<a href="#l31.2840"></a><span id="l31.2840" class="difflineminus">-function CommandUpdate_UndoRedo()</span>
<a href="#l31.2841"></a><span id="l31.2841" class="difflineminus">-{</span>
<a href="#l31.2842"></a><span id="l31.2842" class="difflineplus">+function CommandUpdate_UndoRedo() {</span>
<a href="#l31.2843"></a><span id="l31.2843">   EnableMenuItem(&quot;menu_undo&quot;, SetupUndoRedoCommand(&quot;cmd_undo&quot;));</span>
<a href="#l31.2844"></a><span id="l31.2844">   EnableMenuItem(&quot;menu_redo&quot;, SetupUndoRedoCommand(&quot;cmd_redo&quot;));</span>
<a href="#l31.2845"></a><span id="l31.2845"> }</span>
<a href="#l31.2846"></a><span id="l31.2846"> </span>
<a href="#l31.2847"></a><span id="l31.2847" class="difflineminus">-function SetupUndoRedoCommand(command)</span>
<a href="#l31.2848"></a><span id="l31.2848" class="difflineminus">-{</span>
<a href="#l31.2849"></a><span id="l31.2849" class="difflineplus">+function SetupUndoRedoCommand(command) {</span>
<a href="#l31.2850"></a><span id="l31.2850">   // If we have selected a server, and are viewing account central</span>
<a href="#l31.2851"></a><span id="l31.2851">   // there is no loaded folder.</span>
<a href="#l31.2852"></a><span id="l31.2852">   var loadedFolder = gFolderDisplay.displayedFolder;</span>
<a href="#l31.2853"></a><span id="l31.2853">   if (!loadedFolder || !loadedFolder.server.canUndoDeleteOnServer)</span>
<a href="#l31.2854"></a><span id="l31.2854">     return false;</span>
<a href="#l31.2855"></a><span id="l31.2855"> </span>
<a href="#l31.2856"></a><span id="l31.2856">   var canUndoOrRedo;</span>
<a href="#l31.2857"></a><span id="l31.2857">   var txnType;</span>
<a href="#l31.2858"></a><span id="l31.2858" class="difflineminus">-  if (command == &quot;cmd_undo&quot;)</span>
<a href="#l31.2859"></a><span id="l31.2859" class="difflineminus">-  {</span>
<a href="#l31.2860"></a><span id="l31.2860" class="difflineplus">+  if (command == &quot;cmd_undo&quot;) {</span>
<a href="#l31.2861"></a><span id="l31.2861">     canUndoOrRedo = messenger.canUndo();</span>
<a href="#l31.2862"></a><span id="l31.2862">     txnType = messenger.getUndoTransactionType();</span>
<a href="#l31.2863"></a><span id="l31.2863" class="difflineminus">-  }</span>
<a href="#l31.2864"></a><span id="l31.2864" class="difflineminus">-  else</span>
<a href="#l31.2865"></a><span id="l31.2865" class="difflineminus">-  {</span>
<a href="#l31.2866"></a><span id="l31.2866" class="difflineplus">+  } else {</span>
<a href="#l31.2867"></a><span id="l31.2867">     canUndoOrRedo = messenger.canRedo();</span>
<a href="#l31.2868"></a><span id="l31.2868">     txnType = messenger.getRedoTransactionType();</span>
<a href="#l31.2869"></a><span id="l31.2869">   }</span>
<a href="#l31.2870"></a><span id="l31.2870"> </span>
<a href="#l31.2871"></a><span id="l31.2871" class="difflineminus">-  if (canUndoOrRedo)</span>
<a href="#l31.2872"></a><span id="l31.2872" class="difflineminus">-  {</span>
<a href="#l31.2873"></a><span id="l31.2873" class="difflineplus">+  if (canUndoOrRedo) {</span>
<a href="#l31.2874"></a><span id="l31.2874">     var commands =</span>
<a href="#l31.2875"></a><span id="l31.2875" class="difflineminus">-      ['valueDefault', 'valueDeleteMsg', 'valueMoveMsg', 'valueCopyMsg', 'valueUnmarkAllMsgs'];</span>
<a href="#l31.2876"></a><span id="l31.2876" class="difflineplus">+      [&quot;valueDefault&quot;, &quot;valueDeleteMsg&quot;, &quot;valueMoveMsg&quot;, &quot;valueCopyMsg&quot;, &quot;valueUnmarkAllMsgs&quot;];</span>
<a href="#l31.2877"></a><span id="l31.2877">     goSetMenuValue(command, commands[txnType]);</span>
<a href="#l31.2878"></a><span id="l31.2878" class="difflineminus">-  }</span>
<a href="#l31.2879"></a><span id="l31.2879" class="difflineminus">-  else</span>
<a href="#l31.2880"></a><span id="l31.2880" class="difflineminus">-  {</span>
<a href="#l31.2881"></a><span id="l31.2881" class="difflineminus">-    goSetMenuValue(command, 'valueDefault');</span>
<a href="#l31.2882"></a><span id="l31.2882" class="difflineplus">+  } else {</span>
<a href="#l31.2883"></a><span id="l31.2883" class="difflineplus">+    goSetMenuValue(command, &quot;valueDefault&quot;);</span>
<a href="#l31.2884"></a><span id="l31.2884">   }</span>
<a href="#l31.2885"></a><span id="l31.2885">   return canUndoOrRedo;</span>
<a href="#l31.2886"></a><span id="l31.2886"> }</span>
<a href="#l31.2887"></a><span id="l31.2887"> </span>
<a href="#l31.2888"></a><span id="l31.2888"> /**</span>
<a href="#l31.2889"></a><span id="l31.2889">  * Triggered by the global JunkStatusChanged notification, we handle updating</span>
<a href="#l31.2890"></a><span id="l31.2890">  *  the message display if our displayed message might have had its junk status</span>
<a href="#l31.2891"></a><span id="l31.2891">  *  change.  This primarily entails updating the notification bar (that thing</span>
<a href="#l31.2892"></a><span id="l31.2892">  *  that appears above the message and says &quot;this message might be junk&quot;) and</span>
<a href="#l31.2893"></a><span id="l31.2893">  *  (potentially) reloading the message because junk status affects the form of</span>
<a href="#l31.2894"></a><span id="l31.2894">  *  HTML display used (sanitized vs not).</span>
<a href="#l31.2895"></a><span id="l31.2895">  * When our tab implementation is no longer multiplexed (reusing the same</span>
<a href="#l31.2896"></a><span id="l31.2896">  *  display widget), this must be moved into the MessageDisplayWidget or</span>
<a href="#l31.2897"></a><span id="l31.2897">  *  otherwise be scoped to the tab.</span>
<a href="#l31.2898"></a><span id="l31.2898">  */</span>
<a href="#l31.2899"></a><span id="l31.2899" class="difflineminus">-function HandleJunkStatusChanged(folder)</span>
<a href="#l31.2900"></a><span id="l31.2900" class="difflineminus">-{</span>
<a href="#l31.2901"></a><span id="l31.2901" class="difflineplus">+function HandleJunkStatusChanged(folder) {</span>
<a href="#l31.2902"></a><span id="l31.2902">   // We have nothing to do (and should bail) if:</span>
<a href="#l31.2903"></a><span id="l31.2903">   // - There is no currently displayed message.</span>
<a href="#l31.2904"></a><span id="l31.2904">   // - The displayed message is an .eml file from disk or an attachment.</span>
<a href="#l31.2905"></a><span id="l31.2905">   // - The folder that has had a junk change is not backing the display folder.</span>
<a href="#l31.2906"></a><span id="l31.2906"> </span>
<a href="#l31.2907"></a><span id="l31.2907">   // This might be the stand alone window, open to a message that was</span>
<a href="#l31.2908"></a><span id="l31.2908">   // and attachment (or on disk), in which case, we want to ignore it.</span>
<a href="#l31.2909"></a><span id="l31.2909">   if (!gMessageDisplay.displayedMessage ||</span>
<a href="#l31.2910"></a><span id="l31.2910" class="difflineat">@@ -2975,26 +2751,24 @@ function HandleJunkStatusChanged(folder)</span>
<a href="#l31.2911"></a><span id="l31.2911">   // If multiple message are selected and we change the junk status</span>
<a href="#l31.2912"></a><span id="l31.2912">   // we don't want to show the junk bar (since the message pane is blank).</span>
<a href="#l31.2913"></a><span id="l31.2913">   let msgHdr = gFolderDisplay.selectedCount == 1 ?</span>
<a href="#l31.2914"></a><span id="l31.2914">                  gMessageDisplay.displayedMessage : null;</span>
<a href="#l31.2915"></a><span id="l31.2915">   let junkBarWasDisplayed = gMessageNotificationBar.isShowingJunkNotification();</span>
<a href="#l31.2916"></a><span id="l31.2916">   gMessageNotificationBar.setJunkMsg(msgHdr);</span>
<a href="#l31.2917"></a><span id="l31.2917"> </span>
<a href="#l31.2918"></a><span id="l31.2918">   // Only reload message if junk bar display state has changed.</span>
<a href="#l31.2919"></a><span id="l31.2919" class="difflineminus">-  if (msgHdr &amp;&amp; junkBarWasDisplayed != gMessageNotificationBar.isShowingJunkNotification())</span>
<a href="#l31.2920"></a><span id="l31.2920" class="difflineminus">-  {</span>
<a href="#l31.2921"></a><span id="l31.2921" class="difflineplus">+  if (msgHdr &amp;&amp; junkBarWasDisplayed != gMessageNotificationBar.isShowingJunkNotification()) {</span>
<a href="#l31.2922"></a><span id="l31.2922">     // We may be forcing junk mail to be rendered with sanitized html.</span>
<a href="#l31.2923"></a><span id="l31.2923">     // In that scenario, we want to reload the message if the status has just</span>
<a href="#l31.2924"></a><span id="l31.2924">     // changed to not junk.</span>
<a href="#l31.2925"></a><span id="l31.2925">     var sanitizeJunkMail = Services.prefs.getBoolPref(&quot;mail.spam.display.sanitize&quot;);</span>
<a href="#l31.2926"></a><span id="l31.2926"> </span>
<a href="#l31.2927"></a><span id="l31.2927">     // Only bother doing this if we are modifying the html for junk mail....</span>
<a href="#l31.2928"></a><span id="l31.2928" class="difflineminus">-    if (sanitizeJunkMail)</span>
<a href="#l31.2929"></a><span id="l31.2929" class="difflineminus">-    {</span>
<a href="#l31.2930"></a><span id="l31.2930" class="difflineplus">+    if (sanitizeJunkMail) {</span>
<a href="#l31.2931"></a><span id="l31.2931">       let junkScore = msgHdr.getStringProperty(&quot;junkscore&quot;);</span>
<a href="#l31.2932"></a><span id="l31.2932">       let isJunk = (junkScore == Ci.nsIJunkMailPlugin.IS_SPAM_SCORE);</span>
<a href="#l31.2933"></a><span id="l31.2933"> </span>
<a href="#l31.2934"></a><span id="l31.2934">       // If the current row isn't going to change, reload to show sanitized or</span>
<a href="#l31.2935"></a><span id="l31.2935">       // unsanitized. Otherwise we wouldn't see the reloaded version anyway.</span>
<a href="#l31.2936"></a><span id="l31.2936">       // 1) When marking as non-junk from the Junk folder, the msg would move</span>
<a href="#l31.2937"></a><span id="l31.2937">       //    back to the Inbox -&gt; no reload needed</span>
<a href="#l31.2938"></a><span id="l31.2938">       //    When marking as non-junk from a folder other than the Junk folder,</span>
<a href="#l31.2939"></a><span id="l31.2939" class="difflineat">@@ -3009,35 +2783,33 @@ function HandleJunkStatusChanged(folder)</span>
<a href="#l31.2940"></a><span id="l31.2940">     }</span>
<a href="#l31.2941"></a><span id="l31.2941">   }</span>
<a href="#l31.2942"></a><span id="l31.2942"> }</span>
<a href="#l31.2943"></a><span id="l31.2943"> </span>
<a href="#l31.2944"></a><span id="l31.2944"> /**</span>
<a href="#l31.2945"></a><span id="l31.2945">  * Object to handle message related notifications that are showing in a</span>
<a href="#l31.2946"></a><span id="l31.2946">  * notificationbox above the message content.</span>
<a href="#l31.2947"></a><span id="l31.2947">  */</span>
<a href="#l31.2948"></a><span id="l31.2948" class="difflineminus">-var gMessageNotificationBar =</span>
<a href="#l31.2949"></a><span id="l31.2949" class="difflineminus">-{</span>
<a href="#l31.2950"></a><span id="l31.2950" class="difflineplus">+var gMessageNotificationBar = {</span>
<a href="#l31.2951"></a><span id="l31.2951">   get stringBundle() {</span>
<a href="#l31.2952"></a><span id="l31.2952">     delete this.stringBundle;</span>
<a href="#l31.2953"></a><span id="l31.2953">     return this.stringBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l31.2954"></a><span id="l31.2954">   },</span>
<a href="#l31.2955"></a><span id="l31.2955"> </span>
<a href="#l31.2956"></a><span id="l31.2956">   get brandBundle() {</span>
<a href="#l31.2957"></a><span id="l31.2957">     delete this.brandBundle;</span>
<a href="#l31.2958"></a><span id="l31.2958">     return this.brandBundle = document.getElementById(&quot;bundle_brand&quot;);</span>
<a href="#l31.2959"></a><span id="l31.2959">   },</span>
<a href="#l31.2960"></a><span id="l31.2960"> </span>
<a href="#l31.2961"></a><span id="l31.2961">   get msgNotificationBar() {</span>
<a href="#l31.2962"></a><span id="l31.2962">     delete this.msgNotificationBar;</span>
<a href="#l31.2963"></a><span id="l31.2963">     return this.msgNotificationBar = document.getElementById(&quot;msgNotificationBar&quot;);</span>
<a href="#l31.2964"></a><span id="l31.2964">   },</span>
<a href="#l31.2965"></a><span id="l31.2965"> </span>
<a href="#l31.2966"></a><span id="l31.2966" class="difflineminus">-  setJunkMsg: function(aMsgHdr)</span>
<a href="#l31.2967"></a><span id="l31.2967" class="difflineminus">-  {</span>
<a href="#l31.2968"></a><span id="l31.2968" class="difflineplus">+  setJunkMsg(aMsgHdr) {</span>
<a href="#l31.2969"></a><span id="l31.2969">     goUpdateCommand(&quot;button_junk&quot;);</span>
<a href="#l31.2970"></a><span id="l31.2970"> </span>
<a href="#l31.2971"></a><span id="l31.2971">     let brandName = this.brandBundle.getString(&quot;brandShortName&quot;);</span>
<a href="#l31.2972"></a><span id="l31.2972">     let junkBarMsg = this.stringBundle.getFormattedString(&quot;junkBarMessage&quot;,</span>
<a href="#l31.2973"></a><span id="l31.2973">                                                           [brandName]);</span>
<a href="#l31.2974"></a><span id="l31.2974"> </span>
<a href="#l31.2975"></a><span id="l31.2975">     let junkScore = aMsgHdr ? aMsgHdr.getStringProperty(&quot;junkscore&quot;) : &quot;&quot;;</span>
<a href="#l31.2976"></a><span id="l31.2976">     if ((junkScore == &quot;&quot;) ||</span>
<a href="#l31.2977"></a><span id="l31.2977" class="difflineat">@@ -3048,69 +2820,63 @@ var gMessageNotificationBar =</span>
<a href="#l31.2978"></a><span id="l31.2978">         this.msgNotificationBar.removeNotification(item, true);</span>
<a href="#l31.2979"></a><span id="l31.2979">       return;</span>
<a href="#l31.2980"></a><span id="l31.2980">     }</span>
<a href="#l31.2981"></a><span id="l31.2981"> </span>
<a href="#l31.2982"></a><span id="l31.2982">     let buttons = [{</span>
<a href="#l31.2983"></a><span id="l31.2983">       label: this.stringBundle.getString(&quot;junkBarInfoButton&quot;),</span>
<a href="#l31.2984"></a><span id="l31.2984">       accessKey: this.stringBundle.getString(&quot;junkBarInfoButtonKey&quot;),</span>
<a href="#l31.2985"></a><span id="l31.2985">       popup: null,</span>
<a href="#l31.2986"></a><span id="l31.2986" class="difflineminus">-      callback: function(aNotification, aButton) {</span>
<a href="#l31.2987"></a><span id="l31.2987" class="difflineplus">+      callback(aNotification, aButton) {</span>
<a href="#l31.2988"></a><span id="l31.2988">         MsgJunkMailInfo(false);</span>
<a href="#l31.2989"></a><span id="l31.2989">         return true; // keep notification open</span>
<a href="#l31.2990"></a><span id="l31.2990" class="difflineminus">-      }</span>
<a href="#l31.2991"></a><span id="l31.2991" class="difflineplus">+      },</span>
<a href="#l31.2992"></a><span id="l31.2992">     },</span>
<a href="#l31.2993"></a><span id="l31.2993">     {</span>
<a href="#l31.2994"></a><span id="l31.2994">       label: this.stringBundle.getString(&quot;junkBarButton&quot;),</span>
<a href="#l31.2995"></a><span id="l31.2995">       accessKey: this.stringBundle.getString(&quot;junkBarButtonKey&quot;),</span>
<a href="#l31.2996"></a><span id="l31.2996">       popup: null,</span>
<a href="#l31.2997"></a><span id="l31.2997" class="difflineminus">-      callback: function(aNotification, aButton) {</span>
<a href="#l31.2998"></a><span id="l31.2998" class="difflineplus">+      callback(aNotification, aButton) {</span>
<a href="#l31.2999"></a><span id="l31.2999">         JunkSelectedMessages(false);</span>
<a href="#l31.3000"></a><span id="l31.3000">         // Return true (=don't close) since changing junk status will fire a</span>
<a href="#l31.3001"></a><span id="l31.3001">         // JunkStatusChanged notification which will make the junk bar go away</span>
<a href="#l31.3002"></a><span id="l31.3002">         // for this message -&gt; no notification to close anymore -&gt; trying to</span>
<a href="#l31.3003"></a><span id="l31.3003">         // close would just fail.</span>
<a href="#l31.3004"></a><span id="l31.3004">         return true;</span>
<a href="#l31.3005"></a><span id="l31.3005" class="difflineminus">-      }</span>
<a href="#l31.3006"></a><span id="l31.3006" class="difflineplus">+      },</span>
<a href="#l31.3007"></a><span id="l31.3007">     }];</span>
<a href="#l31.3008"></a><span id="l31.3008"> </span>
<a href="#l31.3009"></a><span id="l31.3009">     if (!this.isShowingJunkNotification()) {</span>
<a href="#l31.3010"></a><span id="l31.3010">       this.msgNotificationBar.appendNotification(junkBarMsg, &quot;junkContent&quot;,</span>
<a href="#l31.3011"></a><span id="l31.3011">         &quot;chrome://messenger/skin/icons/junk.png&quot;,</span>
<a href="#l31.3012"></a><span id="l31.3012">         this.msgNotificationBar.PRIORITY_WARNING_HIGH,</span>
<a href="#l31.3013"></a><span id="l31.3013">         buttons);</span>
<a href="#l31.3014"></a><span id="l31.3014">     }</span>
<a href="#l31.3015"></a><span id="l31.3015">   },</span>
<a href="#l31.3016"></a><span id="l31.3016"> </span>
<a href="#l31.3017"></a><span id="l31.3017" class="difflineminus">-  isShowingJunkNotification: function() {</span>
<a href="#l31.3018"></a><span id="l31.3018" class="difflineplus">+  isShowingJunkNotification() {</span>
<a href="#l31.3019"></a><span id="l31.3019">     return !!this.msgNotificationBar.getNotificationWithValue(&quot;junkContent&quot;);</span>
<a href="#l31.3020"></a><span id="l31.3020">   },</span>
<a href="#l31.3021"></a><span id="l31.3021"> </span>
<a href="#l31.3022"></a><span id="l31.3022" class="difflineminus">-  setRemoteContentMsg: function(aMsgHdr, aContentURI, aCanOverride)</span>
<a href="#l31.3023"></a><span id="l31.3023" class="difflineminus">-  {</span>
<a href="#l31.3024"></a><span id="l31.3024" class="difflineplus">+  setRemoteContentMsg(aMsgHdr, aContentURI, aCanOverride) {</span>
<a href="#l31.3025"></a><span id="l31.3025">     // update the allow remote content for sender string</span>
<a href="#l31.3026"></a><span id="l31.3026" class="difflineminus">-    let emailAddress = MailServices.headerParser.extractHeaderAddressMailboxes(aMsgHdr.author);</span>
<a href="#l31.3027"></a><span id="l31.3027" class="difflineminus">-    var desc = document.getElementById(&quot;bundle_messenger&quot;)</span>
<a href="#l31.3028"></a><span id="l31.3028" class="difflineminus">-                       .getFormattedString(&quot;alwaysLoadRemoteContentForSender2&quot;,</span>
<a href="#l31.3029"></a><span id="l31.3029" class="difflineminus">-                                           [emailAddress ? emailAddress : aMsgHdr.author]);</span>
<a href="#l31.3030"></a><span id="l31.3030" class="difflineminus">-    let displayName = MailServices.headerParser.extractHeaderAddressName(aMsgHdr.author);</span>
<a href="#l31.3031"></a><span id="l31.3031">     let brandName = this.brandBundle.getString(&quot;brandShortName&quot;);</span>
<a href="#l31.3032"></a><span id="l31.3032">     let remoteContentMsg = this.stringBundle.getFormattedString(&quot;remoteContentBarMessage&quot;,</span>
<a href="#l31.3033"></a><span id="l31.3033">                                                                 [brandName]);</span>
<a href="#l31.3034"></a><span id="l31.3034"> </span>
<a href="#l31.3035"></a><span id="l31.3035">     let buttonLabel = this.stringBundle.getString((AppConstants.platform == &quot;win&quot;) ?</span>
<a href="#l31.3036"></a><span id="l31.3036">       &quot;remoteContentPrefLabel&quot; : &quot;remoteContentPrefLabelUnix&quot;);</span>
<a href="#l31.3037"></a><span id="l31.3037">     let buttonAccesskey = this.stringBundle.getString((AppConstants.platform == &quot;win&quot;) ?</span>
<a href="#l31.3038"></a><span id="l31.3038">       &quot;remoteContentPrefAccesskey&quot; : &quot;remoteContentPrefAccesskeyUnix&quot;);</span>
<a href="#l31.3039"></a><span id="l31.3039"> </span>
<a href="#l31.3040"></a><span id="l31.3040">     let buttons = [{</span>
<a href="#l31.3041"></a><span id="l31.3041">       label: buttonLabel,</span>
<a href="#l31.3042"></a><span id="l31.3042">       accessKey: buttonAccesskey,</span>
<a href="#l31.3043"></a><span id="l31.3043">       popup: &quot;remoteContentOptions&quot;,</span>
<a href="#l31.3044"></a><span id="l31.3044" class="difflineminus">-      callback: function() { }</span>
<a href="#l31.3045"></a><span id="l31.3045" class="difflineplus">+      callback() {},</span>
<a href="#l31.3046"></a><span id="l31.3046">     }];</span>
<a href="#l31.3047"></a><span id="l31.3047"> </span>
<a href="#l31.3048"></a><span id="l31.3048">     if (!this.isShowingRemoteContentNotification()) {</span>
<a href="#l31.3049"></a><span id="l31.3049">       this.msgNotificationBar.appendNotification(remoteContentMsg, &quot;remoteContent&quot;,</span>
<a href="#l31.3050"></a><span id="l31.3050">         &quot;chrome://messenger/skin/icons/remote-blocked.svg&quot;,</span>
<a href="#l31.3051"></a><span id="l31.3051">         this.msgNotificationBar.PRIORITY_WARNING_MEDIUM,</span>
<a href="#l31.3052"></a><span id="l31.3052">         (aCanOverride ? buttons : []));</span>
<a href="#l31.3053"></a><span id="l31.3053">     }</span>
<a href="#l31.3054"></a><span id="l31.3054" class="difflineat">@@ -3120,51 +2886,49 @@ var gMessageNotificationBar =</span>
<a href="#l31.3055"></a><span id="l31.3055">     let principal = Services.scriptSecurityManager</span>
<a href="#l31.3056"></a><span id="l31.3056">       .createCodebasePrincipal(aContentURI, {});</span>
<a href="#l31.3057"></a><span id="l31.3057">     let origins = popup.value ? popup.value.split(&quot; &quot;) : [];</span>
<a href="#l31.3058"></a><span id="l31.3058">     if (!origins.includes(principal.origin))</span>
<a href="#l31.3059"></a><span id="l31.3059">       origins.push(principal.origin);</span>
<a href="#l31.3060"></a><span id="l31.3060">     popup.value = origins.join(&quot; &quot;);</span>
<a href="#l31.3061"></a><span id="l31.3061">   },</span>
<a href="#l31.3062"></a><span id="l31.3062"> </span>
<a href="#l31.3063"></a><span id="l31.3063" class="difflineminus">-  isShowingRemoteContentNotification: function() {</span>
<a href="#l31.3064"></a><span id="l31.3064" class="difflineplus">+  isShowingRemoteContentNotification() {</span>
<a href="#l31.3065"></a><span id="l31.3065">     return !!this.msgNotificationBar.getNotificationWithValue(&quot;remoteContent&quot;);</span>
<a href="#l31.3066"></a><span id="l31.3066">   },</span>
<a href="#l31.3067"></a><span id="l31.3067"> </span>
<a href="#l31.3068"></a><span id="l31.3068" class="difflineminus">-  setPhishingMsg: function()</span>
<a href="#l31.3069"></a><span id="l31.3069" class="difflineminus">-  {</span>
<a href="#l31.3070"></a><span id="l31.3070" class="difflineplus">+  setPhishingMsg() {</span>
<a href="#l31.3071"></a><span id="l31.3071">     let phishingMsgNote = this.stringBundle.getString(&quot;phishingBarMessage&quot;);</span>
<a href="#l31.3072"></a><span id="l31.3072"> </span>
<a href="#l31.3073"></a><span id="l31.3073">     let buttonLabel = this.stringBundle.getString((AppConstants.platform == &quot;win&quot;) ?</span>
<a href="#l31.3074"></a><span id="l31.3074">       &quot;phishingBarPrefLabel&quot; : &quot;phishingBarPrefLabelUnix&quot;);</span>
<a href="#l31.3075"></a><span id="l31.3075">     let buttonAccesskey = this.stringBundle.getString((AppConstants.platform == &quot;win&quot;) ?</span>
<a href="#l31.3076"></a><span id="l31.3076">       &quot;phishingBarPrefAccesskey&quot; : &quot;phishingBarPrefAccesskeyUnix&quot;);</span>
<a href="#l31.3077"></a><span id="l31.3077"> </span>
<a href="#l31.3078"></a><span id="l31.3078">     let buttons = [</span>
<a href="#l31.3079"></a><span id="l31.3079">     {</span>
<a href="#l31.3080"></a><span id="l31.3080">       label: buttonLabel,</span>
<a href="#l31.3081"></a><span id="l31.3081">       accessKey: buttonAccesskey,</span>
<a href="#l31.3082"></a><span id="l31.3082">       popup: &quot;phishingOptions&quot;,</span>
<a href="#l31.3083"></a><span id="l31.3083" class="difflineminus">-      callback: function(aNotification, aButton) { }</span>
<a href="#l31.3084"></a><span id="l31.3084" class="difflineplus">+      callback(aNotification, aButton) {},</span>
<a href="#l31.3085"></a><span id="l31.3085">     }];</span>
<a href="#l31.3086"></a><span id="l31.3086"> </span>
<a href="#l31.3087"></a><span id="l31.3087">     if (!this.isShowingPhishingNotification()) {</span>
<a href="#l31.3088"></a><span id="l31.3088">        this.msgNotificationBar.appendNotification(phishingMsgNote, &quot;maybeScam&quot;,</span>
<a href="#l31.3089"></a><span id="l31.3089">          &quot;chrome://messenger/skin/icons/phishing.png&quot;,</span>
<a href="#l31.3090"></a><span id="l31.3090">          this.msgNotificationBar.PRIORITY_CRITICAL_MEDIUM,</span>
<a href="#l31.3091"></a><span id="l31.3091">          buttons);</span>
<a href="#l31.3092"></a><span id="l31.3092">     }</span>
<a href="#l31.3093"></a><span id="l31.3093">   },</span>
<a href="#l31.3094"></a><span id="l31.3094"> </span>
<a href="#l31.3095"></a><span id="l31.3095" class="difflineminus">-  isShowingPhishingNotification: function() {</span>
<a href="#l31.3096"></a><span id="l31.3096" class="difflineplus">+  isShowingPhishingNotification() {</span>
<a href="#l31.3097"></a><span id="l31.3097">     return !!this.msgNotificationBar.getNotificationWithValue(&quot;maybeScam&quot;);</span>
<a href="#l31.3098"></a><span id="l31.3098">   },</span>
<a href="#l31.3099"></a><span id="l31.3099"> </span>
<a href="#l31.3100"></a><span id="l31.3100" class="difflineminus">-  setMDNMsg: function(aMdnGenerator, aMsgHeader, aMimeHdr)</span>
<a href="#l31.3101"></a><span id="l31.3101" class="difflineminus">-  {</span>
<a href="#l31.3102"></a><span id="l31.3102" class="difflineplus">+  setMDNMsg(aMdnGenerator, aMsgHeader, aMimeHdr) {</span>
<a href="#l31.3103"></a><span id="l31.3103">     this.mdnGenerator = aMdnGenerator;</span>
<a href="#l31.3104"></a><span id="l31.3104">     // Return receipts can be RFC 3798 or not.</span>
<a href="#l31.3105"></a><span id="l31.3105">     let mdnHdr = aMimeHdr.extractHeader(&quot;Disposition-Notification-To&quot;, false) ||</span>
<a href="#l31.3106"></a><span id="l31.3106">                  aMimeHdr.extractHeader(&quot;Return-Receipt-To&quot;, false); // not</span>
<a href="#l31.3107"></a><span id="l31.3107">     let fromHdr = aMimeHdr.extractHeader(&quot;From&quot;, false);</span>
<a href="#l31.3108"></a><span id="l31.3108"> </span>
<a href="#l31.3109"></a><span id="l31.3109">     let mdnAddr = MailServices.headerParser.extractHeaderAddressMailboxes(mdnHdr);</span>
<a href="#l31.3110"></a><span id="l31.3110">     let fromAddr = MailServices.headerParser.extractHeaderAddressMailboxes(fromHdr);</span>
<a href="#l31.3111"></a><span id="l31.3111" class="difflineat">@@ -3178,71 +2942,68 @@ var gMessageNotificationBar =</span>
<a href="#l31.3112"></a><span id="l31.3112">       this.stringBundle.getFormattedString(&quot;mdnBarMessageAddressDiffers&quot;,</span>
<a href="#l31.3113"></a><span id="l31.3113">                                             [authorName, mdnAddr]) :</span>
<a href="#l31.3114"></a><span id="l31.3114">       this.stringBundle.getFormattedString(&quot;mdnBarMessageNormal&quot;, [authorName]);</span>
<a href="#l31.3115"></a><span id="l31.3115"> </span>
<a href="#l31.3116"></a><span id="l31.3116">     let buttons = [{</span>
<a href="#l31.3117"></a><span id="l31.3117">       label: this.stringBundle.getString(&quot;mdnBarSendReqButton&quot;),</span>
<a href="#l31.3118"></a><span id="l31.3118">       accessKey: this.stringBundle.getString(&quot;mdnBarSendReqButtonKey&quot;),</span>
<a href="#l31.3119"></a><span id="l31.3119">       popup: null,</span>
<a href="#l31.3120"></a><span id="l31.3120" class="difflineminus">-      callback: function(aNotification, aButton) {</span>
<a href="#l31.3121"></a><span id="l31.3121" class="difflineplus">+      callback(aNotification, aButton) {</span>
<a href="#l31.3122"></a><span id="l31.3122">         SendMDNResponse();</span>
<a href="#l31.3123"></a><span id="l31.3123">         return false; // close notification</span>
<a href="#l31.3124"></a><span id="l31.3124" class="difflineminus">-      }</span>
<a href="#l31.3125"></a><span id="l31.3125" class="difflineplus">+      },</span>
<a href="#l31.3126"></a><span id="l31.3126">     },</span>
<a href="#l31.3127"></a><span id="l31.3127">     {</span>
<a href="#l31.3128"></a><span id="l31.3128">       label: this.stringBundle.getString(&quot;mdnBarIgnoreButton&quot;),</span>
<a href="#l31.3129"></a><span id="l31.3129">       accessKey: this.stringBundle.getString(&quot;mdnBarIgnoreButtonKey&quot;),</span>
<a href="#l31.3130"></a><span id="l31.3130">       popup: null,</span>
<a href="#l31.3131"></a><span id="l31.3131" class="difflineminus">-      callback: function(aNotification, aButton) {</span>
<a href="#l31.3132"></a><span id="l31.3132" class="difflineplus">+      callback(aNotification, aButton) {</span>
<a href="#l31.3133"></a><span id="l31.3133">         IgnoreMDNResponse();</span>
<a href="#l31.3134"></a><span id="l31.3134">         return false; // close notification</span>
<a href="#l31.3135"></a><span id="l31.3135" class="difflineminus">-      }</span>
<a href="#l31.3136"></a><span id="l31.3136" class="difflineplus">+      },</span>
<a href="#l31.3137"></a><span id="l31.3137">     }];</span>
<a href="#l31.3138"></a><span id="l31.3138"> </span>
<a href="#l31.3139"></a><span id="l31.3139">     this.msgNotificationBar.appendNotification(mdnBarMsg, &quot;mdnRequested&quot;,</span>
<a href="#l31.3140"></a><span id="l31.3140">       null, this.msgNotificationBar.PRIORITY_INFO_MEDIUM, buttons);</span>
<a href="#l31.3141"></a><span id="l31.3141">   },</span>
<a href="#l31.3142"></a><span id="l31.3142"> </span>
<a href="#l31.3143"></a><span id="l31.3143" class="difflineminus">-  setDraftEditMessage: function() {</span>
<a href="#l31.3144"></a><span id="l31.3144" class="difflineplus">+  setDraftEditMessage() {</span>
<a href="#l31.3145"></a><span id="l31.3145">    let msgHdr = gFolderDisplay.selectedMessage;</span>
<a href="#l31.3146"></a><span id="l31.3146">    if (!msgHdr || !msgHdr.folder)</span>
<a href="#l31.3147"></a><span id="l31.3147">      return;</span>
<a href="#l31.3148"></a><span id="l31.3148"> </span>
<a href="#l31.3149"></a><span id="l31.3149" class="difflineminus">-   if (msgHdr.folder.isSpecialFolder(Ci.nsMsgFolderFlags.Drafts, true))</span>
<a href="#l31.3150"></a><span id="l31.3150" class="difflineminus">-   {</span>
<a href="#l31.3151"></a><span id="l31.3151" class="difflineplus">+   if (msgHdr.folder.isSpecialFolder(Ci.nsMsgFolderFlags.Drafts, true)) {</span>
<a href="#l31.3152"></a><span id="l31.3152">     let draftMsgNote = this.stringBundle.getString(&quot;draftMessageMsg&quot;);</span>
<a href="#l31.3153"></a><span id="l31.3153"> </span>
<a href="#l31.3154"></a><span id="l31.3154">     let buttons = [{</span>
<a href="#l31.3155"></a><span id="l31.3155">       label: this.stringBundle.getString(&quot;draftMessageButton&quot;),</span>
<a href="#l31.3156"></a><span id="l31.3156">       accessKey: this.stringBundle.getString(&quot;draftMessageButtonKey&quot;),</span>
<a href="#l31.3157"></a><span id="l31.3157">       popup: null,</span>
<a href="#l31.3158"></a><span id="l31.3158" class="difflineminus">-      callback: function(aNotification, aButton) {</span>
<a href="#l31.3159"></a><span id="l31.3159" class="difflineplus">+      callback(aNotification, aButton) {</span>
<a href="#l31.3160"></a><span id="l31.3160">         MsgComposeDraftMessage();</span>
<a href="#l31.3161"></a><span id="l31.3161">         return true; // keep notification open</span>
<a href="#l31.3162"></a><span id="l31.3162" class="difflineminus">-      }</span>
<a href="#l31.3163"></a><span id="l31.3163" class="difflineplus">+      },</span>
<a href="#l31.3164"></a><span id="l31.3164">     }];</span>
<a href="#l31.3165"></a><span id="l31.3165"> </span>
<a href="#l31.3166"></a><span id="l31.3166">     this.msgNotificationBar.appendNotification(draftMsgNote, &quot;draftMsgContent&quot;,</span>
<a href="#l31.3167"></a><span id="l31.3167">       null, this.msgNotificationBar.PRIORITY_INFO_HIGH, buttons);</span>
<a href="#l31.3168"></a><span id="l31.3168">    }</span>
<a href="#l31.3169"></a><span id="l31.3169">   },</span>
<a href="#l31.3170"></a><span id="l31.3170"> </span>
<a href="#l31.3171"></a><span id="l31.3171" class="difflineminus">-  clearMsgNotifications: function()</span>
<a href="#l31.3172"></a><span id="l31.3172" class="difflineminus">-  {</span>
<a href="#l31.3173"></a><span id="l31.3173" class="difflineplus">+  clearMsgNotifications() {</span>
<a href="#l31.3174"></a><span id="l31.3174">     this.msgNotificationBar.removeAllNotifications(true);</span>
<a href="#l31.3175"></a><span id="l31.3175" class="difflineminus">-  }</span>
<a href="#l31.3176"></a><span id="l31.3176" class="difflineplus">+  },</span>
<a href="#l31.3177"></a><span id="l31.3177"> };</span>
<a href="#l31.3178"></a><span id="l31.3178"> </span>
<a href="#l31.3179"></a><span id="l31.3179"> /**</span>
<a href="#l31.3180"></a><span id="l31.3180">  * LoadMsgWithRemoteContent</span>
<a href="#l31.3181"></a><span id="l31.3181">  *   Reload the current message, allowing remote content</span>
<a href="#l31.3182"></a><span id="l31.3182">  */</span>
<a href="#l31.3183"></a><span id="l31.3183" class="difflineminus">-function LoadMsgWithRemoteContent()</span>
<a href="#l31.3184"></a><span id="l31.3184" class="difflineminus">-{</span>
<a href="#l31.3185"></a><span id="l31.3185" class="difflineplus">+function LoadMsgWithRemoteContent() {</span>
<a href="#l31.3186"></a><span id="l31.3186">   // we want to get the msg hdr for the currently selected message</span>
<a href="#l31.3187"></a><span id="l31.3187">   // change the &quot;remoteContentBar&quot; property on it</span>
<a href="#l31.3188"></a><span id="l31.3188">   // then reload the message</span>
<a href="#l31.3189"></a><span id="l31.3189"> </span>
<a href="#l31.3190"></a><span id="l31.3190">   setMsgHdrPropertyAndReload(&quot;remoteContentPolicy&quot;, kAllowRemoteContent);</span>
<a href="#l31.3191"></a><span id="l31.3191">   window.content.focus();</span>
<a href="#l31.3192"></a><span id="l31.3192"> }</span>
<a href="#l31.3193"></a><span id="l31.3193"> </span>
<a href="#l31.3194"></a><span id="l31.3194" class="difflineat">@@ -3330,81 +3091,73 @@ function allowRemoteContentForAll(aListN</span>
<a href="#l31.3195"></a><span id="l31.3195">   ReloadMessage();</span>
<a href="#l31.3196"></a><span id="l31.3196"> }</span>
<a href="#l31.3197"></a><span id="l31.3197"> </span>
<a href="#l31.3198"></a><span id="l31.3198"> /**</span>
<a href="#l31.3199"></a><span id="l31.3199">  * Displays fine-grained, per-site preferences for remote content.</span>
<a href="#l31.3200"></a><span id="l31.3200">  */</span>
<a href="#l31.3201"></a><span id="l31.3201"> function editRemoteContentSettings() {</span>
<a href="#l31.3202"></a><span id="l31.3202">   openOptionsDialog(&quot;panePrivacy&quot;);</span>
<a href="#l31.3203"></a><span id="l31.3203" class="difflineminus">-  if(!Services.prefs.getBoolPref(&quot;browser.preferences.instantApply&quot;))</span>
<a href="#l31.3204"></a><span id="l31.3204" class="difflineplus">+  if (!Services.prefs.getBoolPref(&quot;browser.preferences.instantApply&quot;))</span>
<a href="#l31.3205"></a><span id="l31.3205">     ReloadMessage();</span>
<a href="#l31.3206"></a><span id="l31.3206"> }</span>
<a href="#l31.3207"></a><span id="l31.3207"> </span>
<a href="#l31.3208"></a><span id="l31.3208"> /**</span>
<a href="#l31.3209"></a><span id="l31.3209">  *  Set the msg hdr flag to ignore the phishing warning and reload the message.</span>
<a href="#l31.3210"></a><span id="l31.3210">  */</span>
<a href="#l31.3211"></a><span id="l31.3211" class="difflineminus">-function IgnorePhishingWarning()</span>
<a href="#l31.3212"></a><span id="l31.3212" class="difflineminus">-{</span>
<a href="#l31.3213"></a><span id="l31.3213" class="difflineplus">+function IgnorePhishingWarning() {</span>
<a href="#l31.3214"></a><span id="l31.3214">   // This property should really be called skipPhishingWarning or something</span>
<a href="#l31.3215"></a><span id="l31.3215">   // like that, but it's too late to change that now.</span>
<a href="#l31.3216"></a><span id="l31.3216">   // This property is used to suppress the phishing bar for the message.</span>
<a href="#l31.3217"></a><span id="l31.3217">   setMsgHdrPropertyAndReload(&quot;notAPhishMessage&quot;, 1);</span>
<a href="#l31.3218"></a><span id="l31.3218"> }</span>
<a href="#l31.3219"></a><span id="l31.3219"> </span>
<a href="#l31.3220"></a><span id="l31.3220"> /**</span>
<a href="#l31.3221"></a><span id="l31.3221">  *  Open the preferences dialog to allow disabling the scam feature.</span>
<a href="#l31.3222"></a><span id="l31.3222">  *  The dialog window will take care of reloading the message when</span>
<a href="#l31.3223"></a><span id="l31.3223">  *  invoked in instantApply mode.</span>
<a href="#l31.3224"></a><span id="l31.3224">  */</span>
<a href="#l31.3225"></a><span id="l31.3225" class="difflineminus">-function OpenPhishingSettings()</span>
<a href="#l31.3226"></a><span id="l31.3226" class="difflineminus">-{</span>
<a href="#l31.3227"></a><span id="l31.3227" class="difflineplus">+function OpenPhishingSettings() {</span>
<a href="#l31.3228"></a><span id="l31.3228">   openOptionsDialog(&quot;paneSecurity&quot;, &quot;phishingTab&quot;);</span>
<a href="#l31.3229"></a><span id="l31.3229" class="difflineminus">-  if(!Services.prefs.getBoolPref(&quot;browser.preferences.instantApply&quot;))</span>
<a href="#l31.3230"></a><span id="l31.3230" class="difflineplus">+  if (!Services.prefs.getBoolPref(&quot;browser.preferences.instantApply&quot;))</span>
<a href="#l31.3231"></a><span id="l31.3231">     ReloadMessage();</span>
<a href="#l31.3232"></a><span id="l31.3232"> }</span>
<a href="#l31.3233"></a><span id="l31.3233"> </span>
<a href="#l31.3234"></a><span id="l31.3234" class="difflineminus">-function setMsgHdrPropertyAndReload(aProperty, aValue)</span>
<a href="#l31.3235"></a><span id="l31.3235" class="difflineminus">-{</span>
<a href="#l31.3236"></a><span id="l31.3236" class="difflineplus">+function setMsgHdrPropertyAndReload(aProperty, aValue) {</span>
<a href="#l31.3237"></a><span id="l31.3237">   // we want to get the msg hdr for the currently selected message</span>
<a href="#l31.3238"></a><span id="l31.3238">   // change the appropriate property on it then reload the message</span>
<a href="#l31.3239"></a><span id="l31.3239">   var msgHdr = gMessageDisplay.displayedMessage;</span>
<a href="#l31.3240"></a><span id="l31.3240" class="difflineminus">-  if (msgHdr)</span>
<a href="#l31.3241"></a><span id="l31.3241" class="difflineminus">-  {</span>
<a href="#l31.3242"></a><span id="l31.3242" class="difflineplus">+  if (msgHdr) {</span>
<a href="#l31.3243"></a><span id="l31.3243">     msgHdr.setUint32Property(aProperty, aValue);</span>
<a href="#l31.3244"></a><span id="l31.3244">     ReloadMessage();</span>
<a href="#l31.3245"></a><span id="l31.3245">   }</span>
<a href="#l31.3246"></a><span id="l31.3246"> }</span>
<a href="#l31.3247"></a><span id="l31.3247"> </span>
<a href="#l31.3248"></a><span id="l31.3248"> /**</span>
<a href="#l31.3249"></a><span id="l31.3249">  * Mark a specified message as read.</span>
<a href="#l31.3250"></a><span id="l31.3250">  * @param msgHdr header (nsIMsgDBHdr) of the message to mark as read</span>
<a href="#l31.3251"></a><span id="l31.3251">  */</span>
<a href="#l31.3252"></a><span id="l31.3252" class="difflineminus">-function MarkMessageAsRead(msgHdr)</span>
<a href="#l31.3253"></a><span id="l31.3253" class="difflineminus">-{</span>
<a href="#l31.3254"></a><span id="l31.3254" class="difflineplus">+function MarkMessageAsRead(msgHdr) {</span>
<a href="#l31.3255"></a><span id="l31.3255">   ClearPendingReadTimer();</span>
<a href="#l31.3256"></a><span id="l31.3256">   var headers = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l31.3257"></a><span id="l31.3257">                   .createInstance(Ci.nsIMutableArray);</span>
<a href="#l31.3258"></a><span id="l31.3258">   headers.appendElement(msgHdr);</span>
<a href="#l31.3259"></a><span id="l31.3259">   msgHdr.folder.markMessagesRead(headers, true);</span>
<a href="#l31.3260"></a><span id="l31.3260"> }</span>
<a href="#l31.3261"></a><span id="l31.3261"> </span>
<a href="#l31.3262"></a><span id="l31.3262" class="difflineminus">-function ClearPendingReadTimer()</span>
<a href="#l31.3263"></a><span id="l31.3263" class="difflineminus">-{</span>
<a href="#l31.3264"></a><span id="l31.3264" class="difflineminus">-  if (gMarkViewedMessageAsReadTimer)</span>
<a href="#l31.3265"></a><span id="l31.3265" class="difflineminus">-  {</span>
<a href="#l31.3266"></a><span id="l31.3266" class="difflineplus">+function ClearPendingReadTimer() {</span>
<a href="#l31.3267"></a><span id="l31.3267" class="difflineplus">+  if (gMarkViewedMessageAsReadTimer) {</span>
<a href="#l31.3268"></a><span id="l31.3268">     clearTimeout(gMarkViewedMessageAsReadTimer);</span>
<a href="#l31.3269"></a><span id="l31.3269">     gMarkViewedMessageAsReadTimer = null;</span>
<a href="#l31.3270"></a><span id="l31.3270">   }</span>
<a href="#l31.3271"></a><span id="l31.3271"> }</span>
<a href="#l31.3272"></a><span id="l31.3272"> </span>
<a href="#l31.3273"></a><span id="l31.3273"> // this is called when layout is actually finished rendering a</span>
<a href="#l31.3274"></a><span id="l31.3274"> // mail message. OnMsgLoaded is called when libmime is done parsing the message</span>
<a href="#l31.3275"></a><span id="l31.3275" class="difflineminus">-function OnMsgParsed(aUrl)</span>
<a href="#l31.3276"></a><span id="l31.3276" class="difflineminus">-{</span>
<a href="#l31.3277"></a><span id="l31.3277" class="difflineplus">+function OnMsgParsed(aUrl) {</span>
<a href="#l31.3278"></a><span id="l31.3278">   // browser doesn't do this, but I thought it could be a useful thing to test out...</span>
<a href="#l31.3279"></a><span id="l31.3279">   // If the find bar is visible and we just loaded a new message, re-run</span>
<a href="#l31.3280"></a><span id="l31.3280">   // the find command. This means the new message will get highlighted and</span>
<a href="#l31.3281"></a><span id="l31.3281">   // we'll scroll to the first word in the message that matches the find text.</span>
<a href="#l31.3282"></a><span id="l31.3282">   var findBar = document.getElementById(&quot;FindToolbar&quot;);</span>
<a href="#l31.3283"></a><span id="l31.3283">   if (!findBar.hidden)</span>
<a href="#l31.3284"></a><span id="l31.3284">     findBar.onFindAgainCommand(false);</span>
<a href="#l31.3285"></a><span id="l31.3285"> </span>
<a href="#l31.3286"></a><span id="l31.3286" class="difflineat">@@ -3421,18 +3174,17 @@ function OnMsgParsed(aUrl)</span>
<a href="#l31.3287"></a><span id="l31.3287"> </span>
<a href="#l31.3288"></a><span id="l31.3288">   let browser = getMessagePaneBrowser();</span>
<a href="#l31.3289"></a><span id="l31.3289">   let doc = browser &amp;&amp; browser.contentDocument ? browser.contentDocument : null;</span>
<a href="#l31.3290"></a><span id="l31.3290"> </span>
<a href="#l31.3291"></a><span id="l31.3291">   // Rewrite any anchor elements' href attribute to reflect that the loaded</span>
<a href="#l31.3292"></a><span id="l31.3292">   // document is a mailnews url. This will cause docShell to scroll to the</span>
<a href="#l31.3293"></a><span id="l31.3293">   // element in the document rather than opening the link externally.</span>
<a href="#l31.3294"></a><span id="l31.3294">   let links = doc &amp;&amp; doc.links ? doc.links : [];</span>
<a href="#l31.3295"></a><span id="l31.3295" class="difflineminus">-  for (let linkNode of links)</span>
<a href="#l31.3296"></a><span id="l31.3296" class="difflineminus">-  {</span>
<a href="#l31.3297"></a><span id="l31.3297" class="difflineplus">+  for (let linkNode of links) {</span>
<a href="#l31.3298"></a><span id="l31.3298">     if (!linkNode.hash)</span>
<a href="#l31.3299"></a><span id="l31.3299">       continue;</span>
<a href="#l31.3300"></a><span id="l31.3300"> </span>
<a href="#l31.3301"></a><span id="l31.3301">     // We have a ref fragment which may reference a node in this document.</span>
<a href="#l31.3302"></a><span id="l31.3302">     // Ensure html in mail anchors work as expected.</span>
<a href="#l31.3303"></a><span id="l31.3303">     let anchorId = linkNode.hash.replace(&quot;#&quot;, &quot;&quot;);</span>
<a href="#l31.3304"></a><span id="l31.3304">     // Continue if an id (html5) or name attribute value for the ref is not</span>
<a href="#l31.3305"></a><span id="l31.3305">     // found in this document.</span>
<a href="#l31.3306"></a><span id="l31.3306" class="difflineat">@@ -3453,64 +3205,58 @@ function OnMsgParsed(aUrl)</span>
<a href="#l31.3307"></a><span id="l31.3307">     let messageURI = makeURI(linkNode.ownerDocument.URL);</span>
<a href="#l31.3308"></a><span id="l31.3308">     if (messageURI instanceof Ci.nsIMsgMailNewsUrl &amp;&amp;</span>
<a href="#l31.3309"></a><span id="l31.3309">         linkNode.href.startsWith(&quot;http&quot;))</span>
<a href="#l31.3310"></a><span id="l31.3310">       linkNode.href = messageURI.specIgnoringRef + linkNode.hash;</span>
<a href="#l31.3311"></a><span id="l31.3311">   }</span>
<a href="#l31.3312"></a><span id="l31.3312"> </span>
<a href="#l31.3313"></a><span id="l31.3313">   // Scale any overflowing images, exclude http content.</span>
<a href="#l31.3314"></a><span id="l31.3314">   let imgs = doc &amp;&amp; !doc.URL.startsWith(&quot;http&quot;) ? doc.images : [];</span>
<a href="#l31.3315"></a><span id="l31.3315" class="difflineminus">-  for (let img of imgs)</span>
<a href="#l31.3316"></a><span id="l31.3316" class="difflineminus">-  {</span>
<a href="#l31.3317"></a><span id="l31.3317" class="difflineplus">+  for (let img of imgs) {</span>
<a href="#l31.3318"></a><span id="l31.3318">     if (img.clientWidth - doc.body.offsetWidth &gt;= 0 &amp;&amp;</span>
<a href="#l31.3319"></a><span id="l31.3319">         (img.clientWidth &lt;= img.naturalWidth || !img.naturalWidth))</span>
<a href="#l31.3320"></a><span id="l31.3320">       img.setAttribute(&quot;overflowing&quot;, &quot;true&quot;);</span>
<a href="#l31.3321"></a><span id="l31.3321"> </span>
<a href="#l31.3322"></a><span id="l31.3322">     // This is the default case for images when a message is loaded.</span>
<a href="#l31.3323"></a><span id="l31.3323">     img.setAttribute(&quot;shrinktofit&quot;, &quot;true&quot;);</span>
<a href="#l31.3324"></a><span id="l31.3324">   }</span>
<a href="#l31.3325"></a><span id="l31.3325"> }</span>
<a href="#l31.3326"></a><span id="l31.3326"> </span>
<a href="#l31.3327"></a><span id="l31.3327" class="difflineminus">-function OnMsgLoaded(aUrl)</span>
<a href="#l31.3328"></a><span id="l31.3328" class="difflineminus">-{</span>
<a href="#l31.3329"></a><span id="l31.3329" class="difflineplus">+function OnMsgLoaded(aUrl) {</span>
<a href="#l31.3330"></a><span id="l31.3330">   if (!aUrl || gMessageDisplay.isDummy)</span>
<a href="#l31.3331"></a><span id="l31.3331">     return;</span>
<a href="#l31.3332"></a><span id="l31.3332"> </span>
<a href="#l31.3333"></a><span id="l31.3333">   var msgHdr = gMessageDisplay.displayedMessage;</span>
<a href="#l31.3334"></a><span id="l31.3334"> </span>
<a href="#l31.3335"></a><span id="l31.3335" class="difflineminus">-  var wintype = document.documentElement.getAttribute('windowtype');</span>
<a href="#l31.3336"></a><span id="l31.3336" class="difflineplus">+  var wintype = document.documentElement.getAttribute(&quot;windowtype&quot;);</span>
<a href="#l31.3337"></a><span id="l31.3337"> </span>
<a href="#l31.3338"></a><span id="l31.3338">   gMessageNotificationBar.setJunkMsg(msgHdr);</span>
<a href="#l31.3339"></a><span id="l31.3339"> </span>
<a href="#l31.3340"></a><span id="l31.3340" class="difflineminus">-  goUpdateCommand('button_delete');</span>
<a href="#l31.3341"></a><span id="l31.3341" class="difflineplus">+  goUpdateCommand(&quot;button_delete&quot;);</span>
<a href="#l31.3342"></a><span id="l31.3342"> </span>
<a href="#l31.3343"></a><span id="l31.3343">   var markReadAutoMode = Services.prefs.getBoolPref(&quot;mailnews.mark_message_read.auto&quot;);</span>
<a href="#l31.3344"></a><span id="l31.3344"> </span>
<a href="#l31.3345"></a><span id="l31.3345">   // We just finished loading a message. If messages are to be marked as read</span>
<a href="#l31.3346"></a><span id="l31.3346">   // automatically, set a timer to mark the message is read after n seconds</span>
<a href="#l31.3347"></a><span id="l31.3347">   // where n can be configured by the user.</span>
<a href="#l31.3348"></a><span id="l31.3348" class="difflineminus">-  if (msgHdr &amp;&amp; !msgHdr.isRead &amp;&amp; markReadAutoMode)</span>
<a href="#l31.3349"></a><span id="l31.3349" class="difflineminus">-  {</span>
<a href="#l31.3350"></a><span id="l31.3350" class="difflineplus">+  if (msgHdr &amp;&amp; !msgHdr.isRead &amp;&amp; markReadAutoMode) {</span>
<a href="#l31.3351"></a><span id="l31.3351">     let markReadOnADelay = Services.prefs.getBoolPref(&quot;mailnews.mark_message_read.delay&quot;);</span>
<a href="#l31.3352"></a><span id="l31.3352"> </span>
<a href="#l31.3353"></a><span id="l31.3353">     // Only use the timer if viewing using the 3-pane preview pane and the</span>
<a href="#l31.3354"></a><span id="l31.3354">     // user has set the pref.</span>
<a href="#l31.3355"></a><span id="l31.3355" class="difflineminus">-    if (markReadOnADelay &amp;&amp; wintype == &quot;mail:3pane&quot;) // 3-pane window</span>
<a href="#l31.3356"></a><span id="l31.3356" class="difflineminus">-    {</span>
<a href="#l31.3357"></a><span id="l31.3357" class="difflineplus">+    if (markReadOnADelay &amp;&amp; wintype == &quot;mail:3pane&quot;) { // 3-pane window</span>
<a href="#l31.3358"></a><span id="l31.3358">       ClearPendingReadTimer();</span>
<a href="#l31.3359"></a><span id="l31.3359">       let markReadDelayTime = Services.prefs.getIntPref(&quot;mailnews.mark_message_read.delay.interval&quot;);</span>
<a href="#l31.3360"></a><span id="l31.3360">       if (markReadDelayTime == 0)</span>
<a href="#l31.3361"></a><span id="l31.3361">         MarkMessageAsRead(msgHdr);</span>
<a href="#l31.3362"></a><span id="l31.3362">       else</span>
<a href="#l31.3363"></a><span id="l31.3363">         gMarkViewedMessageAsReadTimer = setTimeout(MarkMessageAsRead,</span>
<a href="#l31.3364"></a><span id="l31.3364">                                                    markReadDelayTime * 1000,</span>
<a href="#l31.3365"></a><span id="l31.3365">                                                    msgHdr);</span>
<a href="#l31.3366"></a><span id="l31.3366" class="difflineminus">-    }</span>
<a href="#l31.3367"></a><span id="l31.3367" class="difflineminus">-    else // standalone msg window</span>
<a href="#l31.3368"></a><span id="l31.3368" class="difflineminus">-    {</span>
<a href="#l31.3369"></a><span id="l31.3369" class="difflineplus">+    } else { // standalone msg window</span>
<a href="#l31.3370"></a><span id="l31.3370">       MarkMessageAsRead(msgHdr);</span>
<a href="#l31.3371"></a><span id="l31.3371">     }</span>
<a href="#l31.3372"></a><span id="l31.3372">   }</span>
<a href="#l31.3373"></a><span id="l31.3373"> </span>
<a href="#l31.3374"></a><span id="l31.3374">   // See if MDN was requested but has not been sent.</span>
<a href="#l31.3375"></a><span id="l31.3375">   HandleMDNResponse(aUrl);</span>
<a href="#l31.3376"></a><span id="l31.3376"> </span>
<a href="#l31.3377"></a><span id="l31.3377">   // Reset the blocked hosts so we can populate it again for this message.</span>
<a href="#l31.3378"></a><span id="l31.3378" class="difflineat">@@ -3518,18 +3264,17 @@ function OnMsgLoaded(aUrl)</span>
<a href="#l31.3379"></a><span id="l31.3379"> }</span>
<a href="#l31.3380"></a><span id="l31.3380"> </span>
<a href="#l31.3381"></a><span id="l31.3381"> /**</span>
<a href="#l31.3382"></a><span id="l31.3382">  * This function handles all mdn response generation (ie, imap and pop).</span>
<a href="#l31.3383"></a><span id="l31.3383">  * For pop the msg uid can be 0 (ie, 1st msg in a local folder) so no</span>
<a href="#l31.3384"></a><span id="l31.3384">  * need to check uid here. No one seems to set mimeHeaders to null so</span>
<a href="#l31.3385"></a><span id="l31.3385">  * no need to check it either.</span>
<a href="#l31.3386"></a><span id="l31.3386">  */</span>
<a href="#l31.3387"></a><span id="l31.3387" class="difflineminus">-function HandleMDNResponse(aUrl)</span>
<a href="#l31.3388"></a><span id="l31.3388" class="difflineminus">-{</span>
<a href="#l31.3389"></a><span id="l31.3389" class="difflineplus">+function HandleMDNResponse(aUrl) {</span>
<a href="#l31.3390"></a><span id="l31.3390">   if (!aUrl)</span>
<a href="#l31.3391"></a><span id="l31.3391">     return;</span>
<a href="#l31.3392"></a><span id="l31.3392"> </span>
<a href="#l31.3393"></a><span id="l31.3393">   var msgFolder = aUrl.folder;</span>
<a href="#l31.3394"></a><span id="l31.3394">   var msgHdr = gFolderDisplay.selectedMessage;</span>
<a href="#l31.3395"></a><span id="l31.3395">   if (!msgFolder || !msgHdr || gFolderDisplay.selectedMessageIsNews)</span>
<a href="#l31.3396"></a><span id="l31.3396">     return;</span>
<a href="#l31.3397"></a><span id="l31.3397"> </span>
<a href="#l31.3398"></a><span id="l31.3398" class="difflineat">@@ -3545,18 +3290,17 @@ function HandleMDNResponse(aUrl)</span>
<a href="#l31.3399"></a><span id="l31.3399">   } catch (ex) {</span>
<a href="#l31.3400"></a><span id="l31.3400">     return;</span>
<a href="#l31.3401"></a><span id="l31.3401">   }</span>
<a href="#l31.3402"></a><span id="l31.3402"> </span>
<a href="#l31.3403"></a><span id="l31.3403">   // If we didn't get the message id when we downloaded the message header,</span>
<a href="#l31.3404"></a><span id="l31.3404">   // we cons up an md5: message id. If we've done that, we'll try to extract</span>
<a href="#l31.3405"></a><span id="l31.3405">   // the message id out of the mime headers for the whole message.</span>
<a href="#l31.3406"></a><span id="l31.3406">   var msgId = msgHdr.messageId;</span>
<a href="#l31.3407"></a><span id="l31.3407" class="difflineminus">-  if (msgId.startsWith(&quot;md5:&quot;))</span>
<a href="#l31.3408"></a><span id="l31.3408" class="difflineminus">-  {</span>
<a href="#l31.3409"></a><span id="l31.3409" class="difflineplus">+  if (msgId.startsWith(&quot;md5:&quot;)) {</span>
<a href="#l31.3410"></a><span id="l31.3410">     var mimeMsgId = mimeHdr.extractHeader(&quot;Message-Id&quot;, false);</span>
<a href="#l31.3411"></a><span id="l31.3411">     if (mimeMsgId)</span>
<a href="#l31.3412"></a><span id="l31.3412">       msgHdr.messageId = mimeMsgId;</span>
<a href="#l31.3413"></a><span id="l31.3413">   }</span>
<a href="#l31.3414"></a><span id="l31.3414"> </span>
<a href="#l31.3415"></a><span id="l31.3415">   // After a msg is downloaded it's already marked READ at this point so we must check if</span>
<a href="#l31.3416"></a><span id="l31.3416">   // the msg has a &quot;Disposition-Notification-To&quot; header and no MDN report has been sent yet.</span>
<a href="#l31.3417"></a><span id="l31.3417">   if (msgHdr.flags &amp; Ci.nsMsgMessageFlags.MDNReportSent)</span>
<a href="#l31.3418"></a><span id="l31.3418" class="difflineat">@@ -3572,44 +3316,41 @@ function HandleMDNResponse(aUrl)</span>
<a href="#l31.3419"></a><span id="l31.3419">                        .createInstance(Ci.nsIMsgMdnGenerator);</span>
<a href="#l31.3420"></a><span id="l31.3420">   const MDN_DISPOSE_TYPE_DISPLAYED = 0;</span>
<a href="#l31.3421"></a><span id="l31.3421">   let askUser = mdnGenerator.process(MDN_DISPOSE_TYPE_DISPLAYED, msgWindow, msgFolder,</span>
<a href="#l31.3422"></a><span id="l31.3422">                                      msgHdr.messageKey, mimeHdr, false);</span>
<a href="#l31.3423"></a><span id="l31.3423">   if (askUser)</span>
<a href="#l31.3424"></a><span id="l31.3424">     gMessageNotificationBar.setMDNMsg(mdnGenerator, msgHdr, mimeHdr);</span>
<a href="#l31.3425"></a><span id="l31.3425"> }</span>
<a href="#l31.3426"></a><span id="l31.3426"> </span>
<a href="#l31.3427"></a><span id="l31.3427" class="difflineminus">-function SendMDNResponse()</span>
<a href="#l31.3428"></a><span id="l31.3428" class="difflineminus">-{</span>
<a href="#l31.3429"></a><span id="l31.3429" class="difflineplus">+function SendMDNResponse() {</span>
<a href="#l31.3430"></a><span id="l31.3430">   gMessageNotificationBar.mdnGenerator.userAgreed();</span>
<a href="#l31.3431"></a><span id="l31.3431"> }</span>
<a href="#l31.3432"></a><span id="l31.3432"> </span>
<a href="#l31.3433"></a><span id="l31.3433" class="difflineminus">-function IgnoreMDNResponse()</span>
<a href="#l31.3434"></a><span id="l31.3434" class="difflineminus">-{</span>
<a href="#l31.3435"></a><span id="l31.3435" class="difflineplus">+function IgnoreMDNResponse() {</span>
<a href="#l31.3436"></a><span id="l31.3436">   gMessageNotificationBar.mdnGenerator.userDeclined();</span>
<a href="#l31.3437"></a><span id="l31.3437"> }</span>
<a href="#l31.3438"></a><span id="l31.3438"> </span>
<a href="#l31.3439"></a><span id="l31.3439" class="difflineminus">-/***</span>
<a href="#l31.3440"></a><span id="l31.3440" class="difflineplus">+/**</span>
<a href="#l31.3441"></a><span id="l31.3441">  * Focus the gloda global search input box on current tab, or,</span>
<a href="#l31.3442"></a><span id="l31.3442">  * if the search box is not available, open a new gloda search tab</span>
<a href="#l31.3443"></a><span id="l31.3443">  * (with its search box focused).</span>
<a href="#l31.3444"></a><span id="l31.3444">  */</span>
<a href="#l31.3445"></a><span id="l31.3445" class="difflineminus">-function QuickSearchFocus()</span>
<a href="#l31.3446"></a><span id="l31.3446" class="difflineminus">-{</span>
<a href="#l31.3447"></a><span id="l31.3447" class="difflineplus">+function QuickSearchFocus() {</span>
<a href="#l31.3448"></a><span id="l31.3448">   // Default to focusing the search box on the current tab</span>
<a href="#l31.3449"></a><span id="l31.3449">   let newTab = false;</span>
<a href="#l31.3450"></a><span id="l31.3450">   let searchInput;</span>
<a href="#l31.3451"></a><span id="l31.3451" class="difflineminus">-  let tabmail = document.getElementById('tabmail');</span>
<a href="#l31.3452"></a><span id="l31.3452" class="difflineplus">+  let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l31.3453"></a><span id="l31.3453">   if (!tabmail) {</span>
<a href="#l31.3454"></a><span id="l31.3454">     // This should never happen.</span>
<a href="#l31.3455"></a><span id="l31.3455">     return;</span>
<a href="#l31.3456"></a><span id="l31.3456">   }</span>
<a href="#l31.3457"></a><span id="l31.3457"> </span>
<a href="#l31.3458"></a><span id="l31.3458">   switch (tabmail.currentTabInfo.mode.name) {</span>
<a href="#l31.3459"></a><span id="l31.3459" class="difflineminus">-    case  &quot;glodaFacet&quot;:</span>
<a href="#l31.3460"></a><span id="l31.3460" class="difflineplus">+    case &quot;glodaFacet&quot;:</span>
<a href="#l31.3461"></a><span id="l31.3461">       // If we're currently viewing a Gloda tab, drill down to find the</span>
<a href="#l31.3462"></a><span id="l31.3462">       // built-in search input, and select that.</span>
<a href="#l31.3463"></a><span id="l31.3463">       searchInput = tabmail.currentTabInfo</span>
<a href="#l31.3464"></a><span id="l31.3464">                            .panel</span>
<a href="#l31.3465"></a><span id="l31.3465">                            .querySelector(&quot;.remote-gloda-search&quot;);</span>
<a href="#l31.3466"></a><span id="l31.3466">       break;</span>
<a href="#l31.3467"></a><span id="l31.3467">     case &quot;chat&quot;:</span>
<a href="#l31.3468"></a><span id="l31.3468">       searchInput = document.getElementById(&quot;IMSearchInput&quot;);</span>
<a href="#l31.3469"></a><span id="l31.3469" class="difflineat">@@ -3617,18 +3358,17 @@ function QuickSearchFocus()</span>
<a href="#l31.3470"></a><span id="l31.3470">     default:</span>
<a href="#l31.3471"></a><span id="l31.3471">       searchInput = document.getElementById(&quot;searchInput&quot;);</span>
<a href="#l31.3472"></a><span id="l31.3472">   }</span>
<a href="#l31.3473"></a><span id="l31.3473"> </span>
<a href="#l31.3474"></a><span id="l31.3474">   if (!searchInput) {</span>
<a href="#l31.3475"></a><span id="l31.3475">     // If searchInput is not found on current tab (e.g. removed by user),</span>
<a href="#l31.3476"></a><span id="l31.3476">     // use a new tab.</span>
<a href="#l31.3477"></a><span id="l31.3477">     newTab = true;</span>
<a href="#l31.3478"></a><span id="l31.3478" class="difflineminus">-  }</span>
<a href="#l31.3479"></a><span id="l31.3479" class="difflineminus">-  else {</span>
<a href="#l31.3480"></a><span id="l31.3480" class="difflineplus">+  } else {</span>
<a href="#l31.3481"></a><span id="l31.3481">     // The searchInput element exists on current tab.</span>
<a href="#l31.3482"></a><span id="l31.3482">     // However, via toolbar customization, it can be in different places:</span>
<a href="#l31.3483"></a><span id="l31.3483">     // Toolbars, tab bar, menu bar, etc. If the containing elements are hidden,</span>
<a href="#l31.3484"></a><span id="l31.3484">     // searchInput will also be hidden, so clientHeight and clientWidth of the</span>
<a href="#l31.3485"></a><span id="l31.3485">     // searchbox or one of its parents will typically be zero and we can test</span>
<a href="#l31.3486"></a><span id="l31.3486">     // for that. If searchInput is hidden, use a new tab.</span>
<a href="#l31.3487"></a><span id="l31.3487">     let element = searchInput;</span>
<a href="#l31.3488"></a><span id="l31.3488">     while (element) {</span>
<a href="#l31.3489"></a><span id="l31.3489" class="difflineat">@@ -3649,26 +3389,24 @@ function QuickSearchFocus()</span>
<a href="#l31.3490"></a><span id="l31.3490"> </span>
<a href="#l31.3491"></a><span id="l31.3491"> /**</span>
<a href="#l31.3492"></a><span id="l31.3492">  * Opens a search window with the given folder, or the displayed one if none is</span>
<a href="#l31.3493"></a><span id="l31.3493">  * chosen.</span>
<a href="#l31.3494"></a><span id="l31.3494">  *</span>
<a href="#l31.3495"></a><span id="l31.3495">  * @param [aFolder] the folder to open the search window for, if different from</span>
<a href="#l31.3496"></a><span id="l31.3496">  *                  the displayed one</span>
<a href="#l31.3497"></a><span id="l31.3497">  */</span>
<a href="#l31.3498"></a><span id="l31.3498" class="difflineminus">-function MsgSearchMessages(aFolder)</span>
<a href="#l31.3499"></a><span id="l31.3499" class="difflineminus">-{</span>
<a href="#l31.3500"></a><span id="l31.3500" class="difflineplus">+function MsgSearchMessages(aFolder) {</span>
<a href="#l31.3501"></a><span id="l31.3501">   // We always open a new search dialog for each search command</span>
<a href="#l31.3502"></a><span id="l31.3502">   window.openDialog(&quot;chrome://messenger/content/SearchDialog.xul&quot;, &quot;_blank&quot;,</span>
<a href="#l31.3503"></a><span id="l31.3503">                     &quot;chrome,resizable,status,centerscreen,dialog=no&quot;,</span>
<a href="#l31.3504"></a><span id="l31.3504">                     { folder: aFolder || gFolderDisplay.displayedFolder });</span>
<a href="#l31.3505"></a><span id="l31.3505"> }</span>
<a href="#l31.3506"></a><span id="l31.3506"> </span>
<a href="#l31.3507"></a><span id="l31.3507" class="difflineminus">-function MsgJunkMailInfo(aCheckFirstUse)</span>
<a href="#l31.3508"></a><span id="l31.3508" class="difflineminus">-{</span>
<a href="#l31.3509"></a><span id="l31.3509" class="difflineplus">+function MsgJunkMailInfo(aCheckFirstUse) {</span>
<a href="#l31.3510"></a><span id="l31.3510">   if (aCheckFirstUse) {</span>
<a href="#l31.3511"></a><span id="l31.3511">     if (!Services.prefs.getBoolPref(&quot;mailnews.ui.junk.firstuse&quot;))</span>
<a href="#l31.3512"></a><span id="l31.3512">       return;</span>
<a href="#l31.3513"></a><span id="l31.3513">     Services.prefs.setBoolPref(&quot;mailnews.ui.junk.firstuse&quot;, false);</span>
<a href="#l31.3514"></a><span id="l31.3514"> </span>
<a href="#l31.3515"></a><span id="l31.3515">     // check to see if this is an existing profile where the user has started using</span>
<a href="#l31.3516"></a><span id="l31.3516">     // the junk mail feature already</span>
<a href="#l31.3517"></a><span id="l31.3517">     if (MailServices.junk.userHasClassified)</span>
<a href="#l31.3518"></a><span id="l31.3518" class="difflineat">@@ -3680,49 +3418,45 @@ function MsgJunkMailInfo(aCheckFirstUse)</span>
<a href="#l31.3519"></a><span id="l31.3519">   if (desiredWindow)</span>
<a href="#l31.3520"></a><span id="l31.3520">     desiredWindow.focus();</span>
<a href="#l31.3521"></a><span id="l31.3521">   else</span>
<a href="#l31.3522"></a><span id="l31.3522">     window.openDialog(&quot;chrome://messenger/content/junkMailInfo.xul&quot;,</span>
<a href="#l31.3523"></a><span id="l31.3523">                       &quot;mailnews:junkmailinfo&quot;,</span>
<a href="#l31.3524"></a><span id="l31.3524">                       &quot;centerscreen,resizable=no,titlebar,chrome,modal&quot;, null);</span>
<a href="#l31.3525"></a><span id="l31.3525"> }</span>
<a href="#l31.3526"></a><span id="l31.3526"> </span>
<a href="#l31.3527"></a><span id="l31.3527" class="difflineminus">-function MsgSearchAddresses()</span>
<a href="#l31.3528"></a><span id="l31.3528" class="difflineminus">-{</span>
<a href="#l31.3529"></a><span id="l31.3529" class="difflineplus">+function MsgSearchAddresses() {</span>
<a href="#l31.3530"></a><span id="l31.3530">   var args = { directory: null };</span>
<a href="#l31.3531"></a><span id="l31.3531">   OpenOrFocusWindow(args, &quot;mailnews:absearch&quot;, &quot;chrome://messenger/content/ABSearchDialog.xul&quot;);</span>
<a href="#l31.3532"></a><span id="l31.3532"> }</span>
<a href="#l31.3533"></a><span id="l31.3533"> </span>
<a href="#l31.3534"></a><span id="l31.3534" class="difflineminus">-function MsgFilterList(args)</span>
<a href="#l31.3535"></a><span id="l31.3535" class="difflineminus">-{</span>
<a href="#l31.3536"></a><span id="l31.3536" class="difflineplus">+function MsgFilterList(args) {</span>
<a href="#l31.3537"></a><span id="l31.3537">   OpenOrFocusWindow(args, &quot;mailnews:filterlist&quot;, &quot;chrome://messenger/content/FilterListDialog.xul&quot;);</span>
<a href="#l31.3538"></a><span id="l31.3538"> }</span>
<a href="#l31.3539"></a><span id="l31.3539"> </span>
<a href="#l31.3540"></a><span id="l31.3540" class="difflineminus">-function OpenOrFocusWindow(args, windowType, chromeURL)</span>
<a href="#l31.3541"></a><span id="l31.3541" class="difflineminus">-{</span>
<a href="#l31.3542"></a><span id="l31.3542" class="difflineplus">+function OpenOrFocusWindow(args, windowType, chromeURL) {</span>
<a href="#l31.3543"></a><span id="l31.3543">   var desiredWindow = Services.wm.getMostRecentWindow(windowType);</span>
<a href="#l31.3544"></a><span id="l31.3544"> </span>
<a href="#l31.3545"></a><span id="l31.3545">   if (desiredWindow) {</span>
<a href="#l31.3546"></a><span id="l31.3546">     desiredWindow.focus();</span>
<a href="#l31.3547"></a><span id="l31.3547">     if (&quot;refresh&quot; in args &amp;&amp; args.refresh)</span>
<a href="#l31.3548"></a><span id="l31.3548">       desiredWindow.refresh(args);</span>
<a href="#l31.3549"></a><span id="l31.3549" class="difflineplus">+  } else {</span>
<a href="#l31.3550"></a><span id="l31.3550" class="difflineplus">+    window.openDialog(chromeURL, &quot;&quot;, &quot;chrome,resizable,status,centerscreen,dialog=no&quot;, args);</span>
<a href="#l31.3551"></a><span id="l31.3551">   }</span>
<a href="#l31.3552"></a><span id="l31.3552" class="difflineminus">-  else</span>
<a href="#l31.3553"></a><span id="l31.3553" class="difflineminus">-    window.openDialog(chromeURL, &quot;&quot;, &quot;chrome,resizable,status,centerscreen,dialog=no&quot;, args);</span>
<a href="#l31.3554"></a><span id="l31.3554"> }</span>
<a href="#l31.3555"></a><span id="l31.3555"> </span>
<a href="#l31.3556"></a><span id="l31.3556" class="difflineminus">-function initAppMenuPopup(aMenuPopup, aEvent)</span>
<a href="#l31.3557"></a><span id="l31.3557" class="difflineminus">-{</span>
<a href="#l31.3558"></a><span id="l31.3558" class="difflineplus">+function initAppMenuPopup(aMenuPopup, aEvent) {</span>
<a href="#l31.3559"></a><span id="l31.3559">   file_init();</span>
<a href="#l31.3560"></a><span id="l31.3560">   view_init();</span>
<a href="#l31.3561"></a><span id="l31.3561">   InitGoMessagesMenu();</span>
<a href="#l31.3562"></a><span id="l31.3562">   menu_new_init();</span>
<a href="#l31.3563"></a><span id="l31.3563">   CommandUpdate_UndoRedo();</span>
<a href="#l31.3564"></a><span id="l31.3564">   InitAppFolderViewsMenu();</span>
<a href="#l31.3565"></a><span id="l31.3565" class="difflineminus">-  document.commandDispatcher.updateCommands('create-menu-tasks');</span>
<a href="#l31.3566"></a><span id="l31.3566" class="difflineplus">+  document.commandDispatcher.updateCommands(&quot;create-menu-tasks&quot;);</span>
<a href="#l31.3567"></a><span id="l31.3567"> </span>
<a href="#l31.3568"></a><span id="l31.3568">   // If the onpopupshowing event's target is on one of the splitmenu</span>
<a href="#l31.3569"></a><span id="l31.3569">   // menuitem popups, stash that popup in aMenuPopup (the menupopup one</span>
<a href="#l31.3570"></a><span id="l31.3570">   // level up) so that splitmenu knows which popup to close when it opens</span>
<a href="#l31.3571"></a><span id="l31.3571">   // up it's popupmenu.</span>
<a href="#l31.3572"></a><span id="l31.3572">   if (aEvent.target.parentNode.parentNode.parentNode.parentNode == aMenuPopup)</span>
<a href="#l31.3573"></a><span id="l31.3573">     aMenuPopup._currentPopup = aEvent.target;</span>
<a href="#l31.3574"></a><span id="l31.3574"> }</span>
<a href="#l31.3575"></a><span id="l31.3575" class="difflineat">@@ -3789,13 +3523,12 @@ async function initAddonPrefsMenu(aMenup</span>
<a href="#l31.3576"></a><span id="l31.3576">     }</span>
<a href="#l31.3577"></a><span id="l31.3577">     noPrefsElem.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l31.3578"></a><span id="l31.3578">   } else {</span>
<a href="#l31.3579"></a><span id="l31.3579">     // Only show message that there are no addons with prefs.</span>
<a href="#l31.3580"></a><span id="l31.3580">     noPrefsElem.setAttribute(&quot;collapsed&quot;, &quot;false&quot;);</span>
<a href="#l31.3581"></a><span id="l31.3581">   }</span>
<a href="#l31.3582"></a><span id="l31.3582"> }</span>
<a href="#l31.3583"></a><span id="l31.3583"> </span>
<a href="#l31.3584"></a><span id="l31.3584" class="difflineminus">-function openNewCardDialog()</span>
<a href="#l31.3585"></a><span id="l31.3585" class="difflineminus">-{</span>
<a href="#l31.3586"></a><span id="l31.3586" class="difflineplus">+function openNewCardDialog() {</span>
<a href="#l31.3587"></a><span id="l31.3587">   window.openDialog(&quot;chrome://messenger/content/addressbook/abNewCardDialog.xul&quot;,</span>
<a href="#l31.3588"></a><span id="l31.3588">                     &quot;&quot;, &quot;chrome,modal,resizable=no,centerscreen&quot;);</span>
<a href="#l31.3589"></a><span id="l31.3589"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mail/base/content/messageDisplay.js</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mail/base/content/messageDisplay.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -25,31 +25,33 @@ MessageDisplayWidget.prototype = {</span>
<a href="#l32.4"></a><span id="l32.4"> </span>
<a href="#l32.5"></a><span id="l32.5">   /**</span>
<a href="#l32.6"></a><span id="l32.6">    * Track whether the single message display pane is desired to be displayed</span>
<a href="#l32.7"></a><span id="l32.7">    *  (it is actually displayed when active, doesn't matter when not), or</span>
<a href="#l32.8"></a><span id="l32.8">    *  otherwise the multiple message display pane is desired to be displayed.</span>
<a href="#l32.9"></a><span id="l32.9">    */</span>
<a href="#l32.10"></a><span id="l32.10">   _singleMessageDisplay: null,</span>
<a href="#l32.11"></a><span id="l32.11">   get singleMessageDisplay() {</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-    // when null, assume single message display</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineminus">-    return this._singleMessageDisplay != false;</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineplus">+    if (this._singleMessageDisplay === null) {</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineplus">+      return true;</span>
<a href="#l32.16"></a><span id="l32.16" class="difflineplus">+    }</span>
<a href="#l32.17"></a><span id="l32.17" class="difflineplus">+    return !!this._singleMessageDisplay;</span>
<a href="#l32.18"></a><span id="l32.18">   },</span>
<a href="#l32.19"></a><span id="l32.19">   set singleMessageDisplay(aSingleDisplay) {</span>
<a href="#l32.20"></a><span id="l32.20">     if (this._singleMessageDisplay != aSingleDisplay) {</span>
<a href="#l32.21"></a><span id="l32.21">       this._singleMessageDisplay = aSingleDisplay;</span>
<a href="#l32.22"></a><span id="l32.22">       if (this._active)</span>
<a href="#l32.23"></a><span id="l32.23">         this._updateActiveMessagePane();</span>
<a href="#l32.24"></a><span id="l32.24">     }</span>
<a href="#l32.25"></a><span id="l32.25">   },</span>
<a href="#l32.26"></a><span id="l32.26"> </span>
<a href="#l32.27"></a><span id="l32.27">   /**</span>
<a href="#l32.28"></a><span id="l32.28">    * Set pane visibility based on this.singleMessageDisplay.</span>
<a href="#l32.29"></a><span id="l32.29">    */</span>
<a href="#l32.30"></a><span id="l32.30" class="difflineminus">-  _updateActiveMessagePane: function MessageDisplayWidget_updateMessagePane() {</span>
<a href="#l32.31"></a><span id="l32.31" class="difflineplus">+  _updateActiveMessagePane() {</span>
<a href="#l32.32"></a><span id="l32.32">     // If we're summarizing, might as well clear the message display so that</span>
<a href="#l32.33"></a><span id="l32.33">     // when we return to it, we don't display prev selected message.  If we're</span>
<a href="#l32.34"></a><span id="l32.34">     // *not* summarizing, clear the summary display so that the summary can</span>
<a href="#l32.35"></a><span id="l32.35">     // clean itself up.</span>
<a href="#l32.36"></a><span id="l32.36">     if (!this.singleMessageDisplay)</span>
<a href="#l32.37"></a><span id="l32.37">       this.clearDisplay();</span>
<a href="#l32.38"></a><span id="l32.38">     else</span>
<a href="#l32.39"></a><span id="l32.39">       gSummaryFrameManager.clear();</span>
<a href="#l32.40"></a><span id="l32.40" class="difflineat">@@ -70,25 +72,25 @@ MessageDisplayWidget.prototype = {</span>
<a href="#l32.41"></a><span id="l32.41">         document.getElementById(&quot;multimessage&quot;).focus();</span>
<a href="#l32.42"></a><span id="l32.42">     }</span>
<a href="#l32.43"></a><span id="l32.43">   },</span>
<a href="#l32.44"></a><span id="l32.44"> </span>
<a href="#l32.45"></a><span id="l32.45">   /**</span>
<a href="#l32.46"></a><span id="l32.46">    * Cleanup the MessageDisplayWidget in preparation for going away.  Called by</span>
<a href="#l32.47"></a><span id="l32.47">    *  FolderDisplayWidget's close method.</span>
<a href="#l32.48"></a><span id="l32.48">    */</span>
<a href="#l32.49"></a><span id="l32.49" class="difflineminus">-  _close: function MessageDisplayWidget_close() {</span>
<a href="#l32.50"></a><span id="l32.50" class="difflineplus">+  _close() {</span>
<a href="#l32.51"></a><span id="l32.51">     // mark ourselves inactive without doing any work.</span>
<a href="#l32.52"></a><span id="l32.52">     this._active = false;</span>
<a href="#l32.53"></a><span id="l32.53">   },</span>
<a href="#l32.54"></a><span id="l32.54"> </span>
<a href="#l32.55"></a><span id="l32.55">   /**</span>
<a href="#l32.56"></a><span id="l32.56">    * @name Displayed</span>
<a href="#l32.57"></a><span id="l32.57">    */</span>
<a href="#l32.58"></a><span id="l32.58" class="difflineminus">-  //@{</span>
<a href="#l32.59"></a><span id="l32.59" class="difflineplus">+  // @{</span>
<a href="#l32.60"></a><span id="l32.60"> </span>
<a href="#l32.61"></a><span id="l32.61">   /**</span>
<a href="#l32.62"></a><span id="l32.62">    * The FolderDisplayWidget that owns us.</span>
<a href="#l32.63"></a><span id="l32.63">    */</span>
<a href="#l32.64"></a><span id="l32.64">   folderDisplay: null,</span>
<a href="#l32.65"></a><span id="l32.65">   /**</span>
<a href="#l32.66"></a><span id="l32.66">    * The currently displayed message's nsIMsgDBHdr.  null if there's no message.</span>
<a href="#l32.67"></a><span id="l32.67">    */</span>
<a href="#l32.68"></a><span id="l32.68" class="difflineat">@@ -100,23 +102,23 @@ MessageDisplayWidget.prototype = {</span>
<a href="#l32.69"></a><span id="l32.69">   keyForCharsetOverride: null,</span>
<a href="#l32.70"></a><span id="l32.70"> </span>
<a href="#l32.71"></a><span id="l32.71">   /**</span>
<a href="#l32.72"></a><span id="l32.72">    * Indicate whether the message being displayed is a 'dummy' because it is</span>
<a href="#l32.73"></a><span id="l32.73">    *  backed not by an nsIMsgDBHdr but instead by a file on disk or an</span>
<a href="#l32.74"></a><span id="l32.74">    *  attachment on some mail message.</span>
<a href="#l32.75"></a><span id="l32.75">    */</span>
<a href="#l32.76"></a><span id="l32.76">   isDummy: false,</span>
<a href="#l32.77"></a><span id="l32.77" class="difflineminus">-  //@}</span>
<a href="#l32.78"></a><span id="l32.78" class="difflineplus">+  // @}</span>
<a href="#l32.79"></a><span id="l32.79"> </span>
<a href="#l32.80"></a><span id="l32.80">   /**</span>
<a href="#l32.81"></a><span id="l32.81">    * @name FolderDisplayWidget Notifications</span>
<a href="#l32.82"></a><span id="l32.82">    * @private</span>
<a href="#l32.83"></a><span id="l32.83">    */</span>
<a href="#l32.84"></a><span id="l32.84" class="difflineminus">-  //@{</span>
<a href="#l32.85"></a><span id="l32.85" class="difflineplus">+  // @{</span>
<a href="#l32.86"></a><span id="l32.86"> </span>
<a href="#l32.87"></a><span id="l32.87">   /**</span>
<a href="#l32.88"></a><span id="l32.88">    * Unit testing support variable that tracks whether a message load is in</span>
<a href="#l32.89"></a><span id="l32.89">    *  process.  This is set to true when |onDisplayingMessage| is invoked and</span>
<a href="#l32.90"></a><span id="l32.90">    *  cleared by invoking |clearDisplay| or when the message finishes streaming</span>
<a href="#l32.91"></a><span id="l32.91">    *  and |messageLoaded| is set to true.</span>
<a href="#l32.92"></a><span id="l32.92">    */</span>
<a href="#l32.93"></a><span id="l32.93">   messageLoading: false,</span>
<a href="#l32.94"></a><span id="l32.94" class="difflineat">@@ -126,74 +128,72 @@ MessageDisplayWidget.prototype = {</span>
<a href="#l32.95"></a><span id="l32.95">    *  or we hear that a new message begins streaming via |onDisplayingMessage|.</span>
<a href="#l32.96"></a><span id="l32.96">    */</span>
<a href="#l32.97"></a><span id="l32.97">   messageLoaded: false,</span>
<a href="#l32.98"></a><span id="l32.98"> </span>
<a href="#l32.99"></a><span id="l32.99">   /**</span>
<a href="#l32.100"></a><span id="l32.100">    * This is meant to be called immediately after a message or summary load is</span>
<a href="#l32.101"></a><span id="l32.101">    * started.</span>
<a href="#l32.102"></a><span id="l32.102">    */</span>
<a href="#l32.103"></a><span id="l32.103" class="difflineminus">-  onLoadStarted: function MessageDisplayWidget_onLoadStarted() {</span>
<a href="#l32.104"></a><span id="l32.104" class="difflineplus">+  onLoadStarted() {</span>
<a href="#l32.105"></a><span id="l32.105">     this.messageLoading = true;</span>
<a href="#l32.106"></a><span id="l32.106">     this.messageLoaded = false;</span>
<a href="#l32.107"></a><span id="l32.107">   },</span>
<a href="#l32.108"></a><span id="l32.108"> </span>
<a href="#l32.109"></a><span id="l32.109">   /**</span>
<a href="#l32.110"></a><span id="l32.110">    * This is meant to be called immediately after a message or summary load is</span>
<a href="#l32.111"></a><span id="l32.111">    * completed.</span>
<a href="#l32.112"></a><span id="l32.112">    */</span>
<a href="#l32.113"></a><span id="l32.113" class="difflineminus">-  onLoadCompleted: function MessageDisplayWidget_onLoadCompleted() {</span>
<a href="#l32.114"></a><span id="l32.114" class="difflineplus">+  onLoadCompleted() {</span>
<a href="#l32.115"></a><span id="l32.115">     this.messageLoading = false;</span>
<a href="#l32.116"></a><span id="l32.116">     this.messageLoaded = true;</span>
<a href="#l32.117"></a><span id="l32.117">   },</span>
<a href="#l32.118"></a><span id="l32.118"> </span>
<a href="#l32.119"></a><span id="l32.119" class="difflineminus">-  clearDisplay: function MessageDisplayWidget_clearDisplay() {</span>
<a href="#l32.120"></a><span id="l32.120" class="difflineplus">+  clearDisplay() {</span>
<a href="#l32.121"></a><span id="l32.121">     this.displayedMessage = null;</span>
<a href="#l32.122"></a><span id="l32.122">     this.messageLoading = false;</span>
<a href="#l32.123"></a><span id="l32.123">     this.messageLoaded = false;</span>
<a href="#l32.124"></a><span id="l32.124">     ClearPendingReadTimer();</span>
<a href="#l32.125"></a><span id="l32.125">     ClearMessagePane();</span>
<a href="#l32.126"></a><span id="l32.126">   },</span>
<a href="#l32.127"></a><span id="l32.127"> </span>
<a href="#l32.128"></a><span id="l32.128" class="difflineminus">-  onCreatedView: function MessageDisplayWidget_onCreatedView() {</span>
<a href="#l32.129"></a><span id="l32.129" class="difflineplus">+  onCreatedView() {</span>
<a href="#l32.130"></a><span id="l32.130">     // we need to compel setting this because nsMsgSearchDBView defaults it on</span>
<a href="#l32.131"></a><span id="l32.131">     this.folderDisplay.view.dbView.suppressMsgDisplay = !this.visible;</span>
<a href="#l32.132"></a><span id="l32.132">   },</span>
<a href="#l32.133"></a><span id="l32.133"> </span>
<a href="#l32.134"></a><span id="l32.134">   /**</span>
<a href="#l32.135"></a><span id="l32.135">    * FolderDisplayWidget tells us when it is killing the view, which means our</span>
<a href="#l32.136"></a><span id="l32.136">    *  displayed message is no longer valid.</span>
<a href="#l32.137"></a><span id="l32.137">    */</span>
<a href="#l32.138"></a><span id="l32.138" class="difflineminus">-  onDestroyingView: function MessageDisplayWidget_onDestroyingView(</span>
<a href="#l32.139"></a><span id="l32.139" class="difflineminus">-      aFolderIsComingBack) {</span>
<a href="#l32.140"></a><span id="l32.140" class="difflineplus">+  onDestroyingView(aFolderIsComingBack) {</span>
<a href="#l32.141"></a><span id="l32.141">     this.displayedMessage = null;</span>
<a href="#l32.142"></a><span id="l32.142">     // The only time we want to do anything is when the folder is not coming</span>
<a href="#l32.143"></a><span id="l32.143">     //  back.  If it is coming back, we can handle things when it shows up.</span>
<a href="#l32.144"></a><span id="l32.144">     if (!aFolderIsComingBack &amp;&amp; this._active) {</span>
<a href="#l32.145"></a><span id="l32.145">       // and in this case, we just want to clear things.</span>
<a href="#l32.146"></a><span id="l32.146">       this.clearDisplay();</span>
<a href="#l32.147"></a><span id="l32.147">       this.singleMessageDisplay = true;</span>
<a href="#l32.148"></a><span id="l32.148">     }</span>
<a href="#l32.149"></a><span id="l32.149">   },</span>
<a href="#l32.150"></a><span id="l32.150"> </span>
<a href="#l32.151"></a><span id="l32.151">   /**</span>
<a href="#l32.152"></a><span id="l32.152">    * FolderDisplayWidget tells us when a message is being displayed.</span>
<a href="#l32.153"></a><span id="l32.153">    */</span>
<a href="#l32.154"></a><span id="l32.154" class="difflineminus">-  onDisplayingMessage: function MessageDisplayWidget_onDisplayingMessage(</span>
<a href="#l32.155"></a><span id="l32.155" class="difflineminus">-      aMsgHdr) {</span>
<a href="#l32.156"></a><span id="l32.156" class="difflineplus">+  onDisplayingMessage(aMsgHdr) {</span>
<a href="#l32.157"></a><span id="l32.157">     this.displayedMessage = aMsgHdr;</span>
<a href="#l32.158"></a><span id="l32.158">     this.onLoadStarted();</span>
<a href="#l32.159"></a><span id="l32.159">   },</span>
<a href="#l32.160"></a><span id="l32.160" class="difflineminus">-  //@}</span>
<a href="#l32.161"></a><span id="l32.161" class="difflineplus">+  // @}</span>
<a href="#l32.162"></a><span id="l32.162"> </span>
<a href="#l32.163"></a><span id="l32.163">   /**</span>
<a href="#l32.164"></a><span id="l32.164">    * @name Summarization</span>
<a href="#l32.165"></a><span id="l32.165">    * @protected</span>
<a href="#l32.166"></a><span id="l32.166">    */</span>
<a href="#l32.167"></a><span id="l32.167" class="difflineminus">-  //@{</span>
<a href="#l32.168"></a><span id="l32.168" class="difflineplus">+  // @{</span>
<a href="#l32.169"></a><span id="l32.169"> </span>
<a href="#l32.170"></a><span id="l32.170">   /**</span>
<a href="#l32.171"></a><span id="l32.171">    * FolderDisplayWidget tells us when the set of selected messages has changed.</span>
<a href="#l32.172"></a><span id="l32.172">    *  FDW is doing this because an nsMsgDBView/subclass called</span>
<a href="#l32.173"></a><span id="l32.173">    *  summarizeSelection.  Although the call is purely an outgrowth of the</span>
<a href="#l32.174"></a><span id="l32.174">    *  introduction of folder summaries, it also provides a means for us to</span>
<a href="#l32.175"></a><span id="l32.175">    *  completely replace the nsMsgDBView logic.  Namely, we get first bat at</span>
<a href="#l32.176"></a><span id="l32.176">    *  taking an action as a result of the selection change, and we can cause the</span>
<a href="#l32.177"></a><span id="l32.177" class="difflineat">@@ -217,18 +217,17 @@ MessageDisplayWidget.prototype = {</span>
<a href="#l32.178"></a><span id="l32.178">    * In the event that the controlling preference for message summarization is</span>
<a href="#l32.179"></a><span id="l32.179">    *  not enabled (mail.operate_on_msgs_in_collapsed_threads), and there is a</span>
<a href="#l32.180"></a><span id="l32.180">    *  multi-selection, we just clear the display.</span>
<a href="#l32.181"></a><span id="l32.181">    *</span>
<a href="#l32.182"></a><span id="l32.182">    * @return true if we handled the selection notification and the nsMsgDBView</span>
<a href="#l32.183"></a><span id="l32.183">    *  should do nothing, false if we did not and the nsMsgDBView should use its</span>
<a href="#l32.184"></a><span id="l32.184">    *  logic to display a message.</span>
<a href="#l32.185"></a><span id="l32.185">    */</span>
<a href="#l32.186"></a><span id="l32.186" class="difflineminus">-  onSelectedMessagesChanged:</span>
<a href="#l32.187"></a><span id="l32.187" class="difflineminus">-      function MessageDisplayWidget_onSelectedMessagesChanged() {</span>
<a href="#l32.188"></a><span id="l32.188" class="difflineplus">+  onSelectedMessagesChanged() {</span>
<a href="#l32.189"></a><span id="l32.189">     // If we are not active, we should not be touching things.  pretend we are</span>
<a href="#l32.190"></a><span id="l32.190">     //  handling whatever is happening so the nsMsgDBView doesn't try and do</span>
<a href="#l32.191"></a><span id="l32.191">     //  anything.  makeActive will trigger a fake SelectionChanged notification</span>
<a href="#l32.192"></a><span id="l32.192">     //  when we switch, which should put everything in its right place.</span>
<a href="#l32.193"></a><span id="l32.193">     if (!this.active)</span>
<a href="#l32.194"></a><span id="l32.194">       return true;</span>
<a href="#l32.195"></a><span id="l32.195"> </span>
<a href="#l32.196"></a><span id="l32.196">     ClearPendingReadTimer();</span>
<a href="#l32.197"></a><span id="l32.197" class="difflineat">@@ -248,17 +247,17 @@ MessageDisplayWidget.prototype = {</span>
<a href="#l32.198"></a><span id="l32.198">   /**</span>
<a href="#l32.199"></a><span id="l32.199">    * FolderDisplayWidget will alert us when a message has been removed so that</span>
<a href="#l32.200"></a><span id="l32.200">    * we can decide whether we want to handle it here, e.g. by closing the</span>
<a href="#l32.201"></a><span id="l32.201">    * window/tab.</span>
<a href="#l32.202"></a><span id="l32.202">    *</span>
<a href="#l32.203"></a><span id="l32.203">    * @return true if the MessageDisplayWidget handled this event and the</span>
<a href="#l32.204"></a><span id="l32.204">    *         FolderDisplayWidget should stop processing</span>
<a href="#l32.205"></a><span id="l32.205">    */</span>
<a href="#l32.206"></a><span id="l32.206" class="difflineminus">-  onMessagesRemoved: function MessageDisplayWidget_onMessagesRemoved() {</span>
<a href="#l32.207"></a><span id="l32.207" class="difflineplus">+  onMessagesRemoved() {</span>
<a href="#l32.208"></a><span id="l32.208">   },</span>
<a href="#l32.209"></a><span id="l32.209"> </span>
<a href="#l32.210"></a><span id="l32.210">   /**</span>
<a href="#l32.211"></a><span id="l32.211">    * If we are already summarized and we get a new request to summarize, require</span>
<a href="#l32.212"></a><span id="l32.212">    *  that the selection has been stable for at least this many milliseconds</span>
<a href="#l32.213"></a><span id="l32.213">    *  before resummarizing.</span>
<a href="#l32.214"></a><span id="l32.214">    * Unit tests know about this variable and poke at it, so don't change the name</span>
<a href="#l32.215"></a><span id="l32.215">    *  without making sure you update the unit tests.  (Not that you would commit</span>
<a href="#l32.216"></a><span id="l32.216" class="difflineat">@@ -295,17 +294,17 @@ MessageDisplayWidget.prototype = {</span>
<a href="#l32.217"></a><span id="l32.217">    *    the next selection change will immediately summarize.</span>
<a href="#l32.218"></a><span id="l32.218">    *</span>
<a href="#l32.219"></a><span id="l32.219">    * @param aIsCallback Is this a callback to ourselves?  Callers should not set</span>
<a href="#l32.220"></a><span id="l32.220">    *     this, leaving it undefined.</span>
<a href="#l32.221"></a><span id="l32.221">    * @return true if we handled the selection notification and the nsMsgDBView</span>
<a href="#l32.222"></a><span id="l32.222">    *  should do nothing, false if we did not and the nsMsgDBView should use its</span>
<a href="#l32.223"></a><span id="l32.223">    *  logic to display a message.</span>
<a href="#l32.224"></a><span id="l32.224">    */</span>
<a href="#l32.225"></a><span id="l32.225" class="difflineminus">-  _showSummary: function MessageDisplayWidget_showSummary(aIsCallback) {</span>
<a href="#l32.226"></a><span id="l32.226" class="difflineplus">+  _showSummary(aIsCallback) {</span>
<a href="#l32.227"></a><span id="l32.227">     // Note: if we are in this function, we already know that summaries are</span>
<a href="#l32.228"></a><span id="l32.228">     // enabled.</span>
<a href="#l32.229"></a><span id="l32.229"> </span>
<a href="#l32.230"></a><span id="l32.230">     // Don't summarize if a mass move is currently active. We'll get notified</span>
<a href="#l32.231"></a><span id="l32.231">     // to summarize later. This occurs when we archive a single message and are</span>
<a href="#l32.232"></a><span id="l32.232">     // about to select a thread next, but haven't actually selected anything</span>
<a href="#l32.233"></a><span id="l32.233">     // yet.</span>
<a href="#l32.234"></a><span id="l32.234">     if (this.folderDisplay._massMoveActive)</span>
<a href="#l32.235"></a><span id="l32.235" class="difflineat">@@ -337,59 +336,58 @@ MessageDisplayWidget.prototype = {</span>
<a href="#l32.236"></a><span id="l32.236">                  this.SUMMARIZATION_SELECTION_STABILITY_INTERVAL_MS,</span>
<a href="#l32.237"></a><span id="l32.237">                  this);</span>
<a href="#l32.238"></a><span id="l32.238"> </span>
<a href="#l32.239"></a><span id="l32.239">     if (this.folderDisplay.selectedCount == 0) {</span>
<a href="#l32.240"></a><span id="l32.240">       // If there are no messages selected, show the folder summary. Gloda will</span>
<a href="#l32.241"></a><span id="l32.241">       // break if passed empty selectedMessages, so do not use any tree row</span>
<a href="#l32.242"></a><span id="l32.242">       // count value to indicate messages (dummy rows are not messages).</span>
<a href="#l32.243"></a><span id="l32.243">       summarizeFolder(this);</span>
<a href="#l32.244"></a><span id="l32.244" class="difflineminus">-    }</span>
<a href="#l32.245"></a><span id="l32.245" class="difflineminus">-    else {</span>
<a href="#l32.246"></a><span id="l32.246" class="difflineplus">+    } else {</span>
<a href="#l32.247"></a><span id="l32.247">       // If there are some messages selected, show the multi-message summary</span>
<a href="#l32.248"></a><span id="l32.248">       // (unless this folder doesn't support summarizing selections).</span>
<a href="#l32.249"></a><span id="l32.249">       if (!this.folderDisplay.summarizeSelectionInFolder) {</span>
<a href="#l32.250"></a><span id="l32.250">         this.singleMessageDisplay = true;</span>
<a href="#l32.251"></a><span id="l32.251">         return false;</span>
<a href="#l32.252"></a><span id="l32.252">       }</span>
<a href="#l32.253"></a><span id="l32.253"> </span>
<a href="#l32.254"></a><span id="l32.254">       summarizeSelection(this);</span>
<a href="#l32.255"></a><span id="l32.255">     }</span>
<a href="#l32.256"></a><span id="l32.256">     return true;</span>
<a href="#l32.257"></a><span id="l32.257">   },</span>
<a href="#l32.258"></a><span id="l32.258" class="difflineminus">-  _wrapShowSummary: function MessageDisplayWidget__wrapShowSummary(aThis) {</span>
<a href="#l32.259"></a><span id="l32.259" class="difflineplus">+  _wrapShowSummary(aThis) {</span>
<a href="#l32.260"></a><span id="l32.260">     aThis._showSummary(true);</span>
<a href="#l32.261"></a><span id="l32.261">   },</span>
<a href="#l32.262"></a><span id="l32.262">   /**</span>
<a href="#l32.263"></a><span id="l32.263">    * Just clears the _summaryStabilityTimeout attribute so we can use it as a</span>
<a href="#l32.264"></a><span id="l32.264">    *  means of checking if we are allowed to display the summary immediately.</span>
<a href="#l32.265"></a><span id="l32.265">    */</span>
<a href="#l32.266"></a><span id="l32.266" class="difflineminus">-  _clearSummaryTimer: function MessageDisplayWidget__clearSummaryTimer(aThis) {</span>
<a href="#l32.267"></a><span id="l32.267" class="difflineplus">+  _clearSummaryTimer(aThis) {</span>
<a href="#l32.268"></a><span id="l32.268">     aThis._summaryStabilityTimeout = null;</span>
<a href="#l32.269"></a><span id="l32.269">   },</span>
<a href="#l32.270"></a><span id="l32.270" class="difflineminus">-  //@}</span>
<a href="#l32.271"></a><span id="l32.271" class="difflineplus">+  // @}</span>
<a href="#l32.272"></a><span id="l32.272"> </span>
<a href="#l32.273"></a><span id="l32.273">   /**</span>
<a href="#l32.274"></a><span id="l32.274">    * @name Activity Control</span>
<a href="#l32.275"></a><span id="l32.275">    * @protected FolderDisplayWidget</span>
<a href="#l32.276"></a><span id="l32.276">    */</span>
<a href="#l32.277"></a><span id="l32.277" class="difflineminus">-  //@{</span>
<a href="#l32.278"></a><span id="l32.278" class="difflineplus">+  // @{</span>
<a href="#l32.279"></a><span id="l32.279"> </span>
<a href="#l32.280"></a><span id="l32.280">   /**</span>
<a href="#l32.281"></a><span id="l32.281">    * Called by the FolderDisplayWidget when it is being made active again and</span>
<a href="#l32.282"></a><span id="l32.282">    *  it's time for us to step up and re-display or clear the message as</span>
<a href="#l32.283"></a><span id="l32.283">    *  demanded by our multiplexed tab implementation.</span>
<a href="#l32.284"></a><span id="l32.284">    *</span>
<a href="#l32.285"></a><span id="l32.285">    *  @param aDontReloadMessage [optional] true if you don't want to make us</span>
<a href="#l32.286"></a><span id="l32.286">    *                            call reloadMessage even if the conditions are</span>
<a href="#l32.287"></a><span id="l32.287">    *                            right for doing so. Use only when you're sure</span>
<a href="#l32.288"></a><span id="l32.288">    *                            that you've already triggered a message load,</span>
<a href="#l32.289"></a><span id="l32.289">    *                            and that a message reload would be harmful.</span>
<a href="#l32.290"></a><span id="l32.290">    */</span>
<a href="#l32.291"></a><span id="l32.291" class="difflineminus">-  makeActive: function MessageDisplayWidget_makeActive(aDontReloadMessage) {</span>
<a href="#l32.292"></a><span id="l32.292" class="difflineplus">+  makeActive(aDontReloadMessage) {</span>
<a href="#l32.293"></a><span id="l32.293">     let wasInactive = !this._active;</span>
<a href="#l32.294"></a><span id="l32.294">     this._active = true;</span>
<a href="#l32.295"></a><span id="l32.295"> </span>
<a href="#l32.296"></a><span id="l32.296">     if (wasInactive) {</span>
<a href="#l32.297"></a><span id="l32.297">       let dbView = this.folderDisplay.view.dbView;</span>
<a href="#l32.298"></a><span id="l32.298">       // (see our usage below)</span>
<a href="#l32.299"></a><span id="l32.299">       let preDisplayedViewIndex =</span>
<a href="#l32.300"></a><span id="l32.300">           dbView.currentlyDisplayedMessage;</span>
<a href="#l32.301"></a><span id="l32.301" class="difflineat">@@ -419,20 +417,20 @@ MessageDisplayWidget.prototype = {</span>
<a href="#l32.302"></a><span id="l32.302"> </span>
<a href="#l32.303"></a><span id="l32.303">     this._updateActiveMessagePane();</span>
<a href="#l32.304"></a><span id="l32.304">   },</span>
<a href="#l32.305"></a><span id="l32.305"> </span>
<a href="#l32.306"></a><span id="l32.306">   /**</span>
<a href="#l32.307"></a><span id="l32.307">    * Called by the FolderDisplayWidget when it is being made inactive or no</span>
<a href="#l32.308"></a><span id="l32.308">    *  longer requires messages to be displayed.</span>
<a href="#l32.309"></a><span id="l32.309">    */</span>
<a href="#l32.310"></a><span id="l32.310" class="difflineminus">-  makeInactive: function MessageDisplayWidget_makeInactive() {</span>
<a href="#l32.311"></a><span id="l32.311" class="difflineplus">+  makeInactive() {</span>
<a href="#l32.312"></a><span id="l32.312">     this._active = false;</span>
<a href="#l32.313"></a><span id="l32.313" class="difflineminus">-  }</span>
<a href="#l32.314"></a><span id="l32.314" class="difflineminus">-  //@}</span>
<a href="#l32.315"></a><span id="l32.315" class="difflineplus">+  },</span>
<a href="#l32.316"></a><span id="l32.316" class="difflineplus">+  // @}</span>
<a href="#l32.317"></a><span id="l32.317"> };</span>
<a href="#l32.318"></a><span id="l32.318"> </span>
<a href="#l32.319"></a><span id="l32.319"> /**</span>
<a href="#l32.320"></a><span id="l32.320">  * Display widget abstraction for the 3-pane message view's preview pane/message</span>
<a href="#l32.321"></a><span id="l32.321">  *  pane. Like the DisplayWidget, it is multiplexed.</span>
<a href="#l32.322"></a><span id="l32.322">  */</span>
<a href="#l32.323"></a><span id="l32.323"> function MessagePaneDisplayWidget(aBeVisible) {</span>
<a href="#l32.324"></a><span id="l32.324">   MessageDisplayWidget.call(this);</span>
<a href="#l32.325"></a><span id="l32.325" class="difflineat">@@ -493,80 +491,77 @@ MessageTabDisplayWidget.prototype = {</span>
<a href="#l32.326"></a><span id="l32.326">    * The message tab always has a visible message pane.</span>
<a href="#l32.327"></a><span id="l32.327">    */</span>
<a href="#l32.328"></a><span id="l32.328">   get visible() {</span>
<a href="#l32.329"></a><span id="l32.329">     return true;</span>
<a href="#l32.330"></a><span id="l32.330">   },</span>
<a href="#l32.331"></a><span id="l32.331">   set visible(aIgnored) {</span>
<a href="#l32.332"></a><span id="l32.332">   },</span>
<a href="#l32.333"></a><span id="l32.333"> </span>
<a href="#l32.334"></a><span id="l32.334" class="difflineminus">-  onSelectedMessagesChanged:</span>
<a href="#l32.335"></a><span id="l32.335" class="difflineminus">-      function MessageTabDisplayWidget_onSelectedMessagesChanged() {</span>
<a href="#l32.336"></a><span id="l32.336" class="difflineplus">+  onSelectedMessagesChanged() {</span>
<a href="#l32.337"></a><span id="l32.337">     // Look at the number of messages left in the db view. If there aren't any,</span>
<a href="#l32.338"></a><span id="l32.338">     // close the tab.</span>
<a href="#l32.339"></a><span id="l32.339">     if (this.folderDisplay.view.dbView.rowCount == 0) {</span>
<a href="#l32.340"></a><span id="l32.340">       if (!this.closing) {</span>
<a href="#l32.341"></a><span id="l32.341">         this.closing = true;</span>
<a href="#l32.342"></a><span id="l32.342" class="difflineminus">-        document.getElementById('tabmail').closeTab(</span>
<a href="#l32.343"></a><span id="l32.343" class="difflineplus">+        document.getElementById(&quot;tabmail&quot;).closeTab(</span>
<a href="#l32.344"></a><span id="l32.344">             this.folderDisplay._tabInfo, true);</span>
<a href="#l32.345"></a><span id="l32.345">       }</span>
<a href="#l32.346"></a><span id="l32.346">       return true;</span>
<a href="#l32.347"></a><span id="l32.347">     }</span>
<a href="#l32.348"></a><span id="l32.348" class="difflineminus">-    else {</span>
<a href="#l32.349"></a><span id="l32.349" class="difflineminus">-      if (!this.closing)</span>
<a href="#l32.350"></a><span id="l32.350" class="difflineminus">-        document.getElementById('tabmail').setTabTitle(</span>
<a href="#l32.351"></a><span id="l32.351" class="difflineminus">-            this.folderDisplay._tabInfo);</span>
<a href="#l32.352"></a><span id="l32.352" class="difflineplus">+</span>
<a href="#l32.353"></a><span id="l32.353" class="difflineplus">+    if (!this.closing)</span>
<a href="#l32.354"></a><span id="l32.354" class="difflineplus">+      document.getElementById(&quot;tabmail&quot;).setTabTitle(this.folderDisplay._tabInfo);</span>
<a href="#l32.355"></a><span id="l32.355"> </span>
<a href="#l32.356"></a><span id="l32.356" class="difflineminus">-      // The db view shouldn't do anything if we're inactive or about to close</span>
<a href="#l32.357"></a><span id="l32.357" class="difflineminus">-      if (!this.active || this.closing)</span>
<a href="#l32.358"></a><span id="l32.358" class="difflineminus">-        return true;</span>
<a href="#l32.359"></a><span id="l32.359" class="difflineplus">+    // The db view shouldn't do anything if we're inactive or about to close</span>
<a href="#l32.360"></a><span id="l32.360" class="difflineplus">+    if (!this.active || this.closing)</span>
<a href="#l32.361"></a><span id="l32.361" class="difflineplus">+      return true;</span>
<a href="#l32.362"></a><span id="l32.362"> </span>
<a href="#l32.363"></a><span id="l32.363" class="difflineminus">-      // No summaries in a message tab</span>
<a href="#l32.364"></a><span id="l32.364" class="difflineminus">-      this.singleMessageDisplay = true;</span>
<a href="#l32.365"></a><span id="l32.365" class="difflineminus">-      return false;</span>
<a href="#l32.366"></a><span id="l32.366" class="difflineminus">-    }</span>
<a href="#l32.367"></a><span id="l32.367" class="difflineplus">+    // No summaries in a message tab</span>
<a href="#l32.368"></a><span id="l32.368" class="difflineplus">+    this.singleMessageDisplay = true;</span>
<a href="#l32.369"></a><span id="l32.369" class="difflineplus">+    return false;</span>
<a href="#l32.370"></a><span id="l32.370">   },</span>
<a href="#l32.371"></a><span id="l32.371"> </span>
<a href="#l32.372"></a><span id="l32.372" class="difflineminus">-  onMessagesRemoved: function MessageTabDisplayWidget_onMessagesRemoved() {</span>
<a href="#l32.373"></a><span id="l32.373" class="difflineplus">+  onMessagesRemoved() {</span>
<a href="#l32.374"></a><span id="l32.374">     if (!this.folderDisplay.treeSelection)</span>
<a href="#l32.375"></a><span id="l32.375">       return true;</span>
<a href="#l32.376"></a><span id="l32.376"> </span>
<a href="#l32.377"></a><span id="l32.377">     if (this.folderDisplay.treeSelection.count == 0 &amp;&amp;</span>
<a href="#l32.378"></a><span id="l32.378">         Services.prefs.getBoolPref(&quot;mail.close_message_window.on_delete&quot;)) {</span>
<a href="#l32.379"></a><span id="l32.379">       document.getElementById(&quot;tabmail&quot;).closeTab(this.folderDisplay._tabInfo,</span>
<a href="#l32.380"></a><span id="l32.380">                                                   true);</span>
<a href="#l32.381"></a><span id="l32.381">       return true;</span>
<a href="#l32.382"></a><span id="l32.382">     }</span>
<a href="#l32.383"></a><span id="l32.383">     return false;</span>
<a href="#l32.384"></a><span id="l32.384">   },</span>
<a href="#l32.385"></a><span id="l32.385"> </span>
<a href="#l32.386"></a><span id="l32.386">   /**</span>
<a href="#l32.387"></a><span id="l32.387">    * A message tab should never ever be blank.  Close the tab if we become</span>
<a href="#l32.388"></a><span id="l32.388">    *  blank.</span>
<a href="#l32.389"></a><span id="l32.389">    */</span>
<a href="#l32.390"></a><span id="l32.390" class="difflineminus">-  clearDisplay: function MessageTabDisplayWidget_clearDisplay() {</span>
<a href="#l32.391"></a><span id="l32.391" class="difflineplus">+  clearDisplay() {</span>
<a href="#l32.392"></a><span id="l32.392">     if (!this.closing) {</span>
<a href="#l32.393"></a><span id="l32.393">       this.closing = true;</span>
<a href="#l32.394"></a><span id="l32.394" class="difflineminus">-      document.getElementById('tabmail').closeTab(this.folderDisplay._tabInfo,</span>
<a href="#l32.395"></a><span id="l32.395" class="difflineplus">+      document.getElementById(&quot;tabmail&quot;).closeTab(this.folderDisplay._tabInfo,</span>
<a href="#l32.396"></a><span id="l32.396">                                                   true);</span>
<a href="#l32.397"></a><span id="l32.397">     }</span>
<a href="#l32.398"></a><span id="l32.398" class="difflineminus">-  }</span>
<a href="#l32.399"></a><span id="l32.399" class="difflineplus">+  },</span>
<a href="#l32.400"></a><span id="l32.400"> };</span>
<a href="#l32.401"></a><span id="l32.401"> </span>
<a href="#l32.402"></a><span id="l32.402"> /**</span>
<a href="#l32.403"></a><span id="l32.403">  * The search dialog has no message preview pane, and so wants a message</span>
<a href="#l32.404"></a><span id="l32.404">  *  display widget that is never visible.  No one other than the search</span>
<a href="#l32.405"></a><span id="l32.405">  *  dialog should use this because the search dialog is bad UI.</span>
<a href="#l32.406"></a><span id="l32.406">  */</span>
<a href="#l32.407"></a><span id="l32.407"> function NeverVisisbleMessageDisplayWidget() {</span>
<a href="#l32.408"></a><span id="l32.408">   MessageDisplayWidget.call(this);</span>
<a href="#l32.409"></a><span id="l32.409"> }</span>
<a href="#l32.410"></a><span id="l32.410"> NeverVisisbleMessageDisplayWidget.prototype = {</span>
<a href="#l32.411"></a><span id="l32.411">   __proto__: MessageDisplayWidget.prototype,</span>
<a href="#l32.412"></a><span id="l32.412">   get visible() {</span>
<a href="#l32.413"></a><span id="l32.413">     return false;</span>
<a href="#l32.414"></a><span id="l32.414">   },</span>
<a href="#l32.415"></a><span id="l32.415" class="difflineminus">-  onSelectedMessagesChanged: function() {</span>
<a href="#l32.416"></a><span id="l32.416" class="difflineplus">+  onSelectedMessagesChanged() {</span>
<a href="#l32.417"></a><span id="l32.417">     return false;</span>
<a href="#l32.418"></a><span id="l32.418">   },</span>
<a href="#l32.419"></a><span id="l32.419" class="difflineminus">-  _updateActiveMessagePane: function() {</span>
<a href="#l32.420"></a><span id="l32.420" class="difflineplus">+  _updateActiveMessagePane() {</span>
<a href="#l32.421"></a><span id="l32.421">   },</span>
<a href="#l32.422"></a><span id="l32.422"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mail/base/content/messageWindow.js</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mail/base/content/messageWindow.js</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -13,17 +13,17 @@ ChromeUtils.import(&quot;resource://gre/modul</span>
<a href="#l33.4"></a><span id="l33.4"> ChromeUtils.import(&quot;resource:///modules/MsgHdrSyntheticView.jsm&quot;);</span>
<a href="#l33.5"></a><span id="l33.5"> </span>
<a href="#l33.6"></a><span id="l33.6"> // from MailNewsTypes.h</span>
<a href="#l33.7"></a><span id="l33.7"> var nsMsgKey_None = 0xFFFFFFFF;</span>
<a href="#l33.8"></a><span id="l33.8"> var nsMsgViewIndex_None = 0xFFFFFFFF;</span>
<a href="#l33.9"></a><span id="l33.9"> </span>
<a href="#l33.10"></a><span id="l33.10"> /* globals for a particular window */</span>
<a href="#l33.11"></a><span id="l33.11"> </span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-/// we have no tree view; let people know that.</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+// we have no tree view; let people know that.</span>
<a href="#l33.14"></a><span id="l33.14"> var gFolderTreeView = null;</span>
<a href="#l33.15"></a><span id="l33.15"> </span>
<a href="#l33.16"></a><span id="l33.16"> var gFolderDisplay;</span>
<a href="#l33.17"></a><span id="l33.17"> var gMessageDisplay;</span>
<a href="#l33.18"></a><span id="l33.18"> </span>
<a href="#l33.19"></a><span id="l33.19"> /**</span>
<a href="#l33.20"></a><span id="l33.20">  * We subclass FolderDisplayWidget:</span>
<a href="#l33.21"></a><span id="l33.21">  * - Because it assumes some thread-pane things that do not apply to us and we</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineat">@@ -68,18 +68,17 @@ StandaloneFolderDisplayWidget.prototype </span>
<a href="#l33.23"></a><span id="l33.23">     return this.messageDisplay.displayedMessage ?</span>
<a href="#l33.24"></a><span id="l33.24">              [this.messageDisplay.displayedMessage] : [];</span>
<a href="#l33.25"></a><span id="l33.25">   },</span>
<a href="#l33.26"></a><span id="l33.26"> </span>
<a href="#l33.27"></a><span id="l33.27">   /**</span>
<a href="#l33.28"></a><span id="l33.28">    * We never have a real treeview, so we always want to tell the view about</span>
<a href="#l33.29"></a><span id="l33.29">    *  the fake tree box so it will actually do something in NoteChange.</span>
<a href="#l33.30"></a><span id="l33.30">    */</span>
<a href="#l33.31"></a><span id="l33.31" class="difflineminus">-  onCreatedView:</span>
<a href="#l33.32"></a><span id="l33.32" class="difflineminus">-      function StandaloneMessageDisplayWidget_onCreatedView() {</span>
<a href="#l33.33"></a><span id="l33.33" class="difflineplus">+  onCreatedView() {</span>
<a href="#l33.34"></a><span id="l33.34">     this._fakeTreeBox.view = this.view.dbView;</span>
<a href="#l33.35"></a><span id="l33.35">     // Need to clear out this reference later.</span>
<a href="#l33.36"></a><span id="l33.36">     this._magicTreeSelection.view = this.view.dbView;</span>
<a href="#l33.37"></a><span id="l33.37"> </span>
<a href="#l33.38"></a><span id="l33.38">     // only if we're not dealing with a dummy message (from .eml file /</span>
<a href="#l33.39"></a><span id="l33.39">     //  attachment should we try and hook up the selection object.)  Otherwise</span>
<a href="#l33.40"></a><span id="l33.40">     //  the view will not operate in stand alone message mode.</span>
<a href="#l33.41"></a><span id="l33.41">     // XXX the sequencing here may break re-using a message window that is</span>
<a href="#l33.42"></a><span id="l33.42" class="difflineat">@@ -97,60 +96,58 @@ StandaloneFolderDisplayWidget.prototype </span>
<a href="#l33.43"></a><span id="l33.43"> </span>
<a href="#l33.44"></a><span id="l33.44">   /**</span>
<a href="#l33.45"></a><span id="l33.45">    * Override this to make sure that we don't try to do stuff with</span>
<a href="#l33.46"></a><span id="l33.46">    * quick-search.</span>
<a href="#l33.47"></a><span id="l33.47">    *</span>
<a href="#l33.48"></a><span id="l33.48">    * XXX This should ideally be the default behavior, with a 3pane subclass</span>
<a href="#l33.49"></a><span id="l33.49">    * implementing the quick-search stuff.</span>
<a href="#l33.50"></a><span id="l33.50">    */</span>
<a href="#l33.51"></a><span id="l33.51" class="difflineminus">-  onDisplayingFolder:</span>
<a href="#l33.52"></a><span id="l33.52" class="difflineminus">-      function StandaloneFolderDisplayWidget_onDisplayingFolder() {</span>
<a href="#l33.53"></a><span id="l33.53" class="difflineplus">+  onDisplayingFolder() {</span>
<a href="#l33.54"></a><span id="l33.54">     let msgDatabase = this.view.displayedFolder &amp;&amp;</span>
<a href="#l33.55"></a><span id="l33.55">                       this.view.displayedFolder.msgDatabase;</span>
<a href="#l33.56"></a><span id="l33.56">     if (msgDatabase) {</span>
<a href="#l33.57"></a><span id="l33.57">       msgDatabase.resetHdrCacheSize(this.PERF_HEADER_CACHE_SIZE);</span>
<a href="#l33.58"></a><span id="l33.58">     }</span>
<a href="#l33.59"></a><span id="l33.59"> </span>
<a href="#l33.60"></a><span id="l33.60">     if (this.active)</span>
<a href="#l33.61"></a><span id="l33.61">       this.makeActive();</span>
<a href="#l33.62"></a><span id="l33.62">   },</span>
<a href="#l33.63"></a><span id="l33.63"> </span>
<a href="#l33.64"></a><span id="l33.64">   _superSelectedMessageUrisGetter:</span>
<a href="#l33.65"></a><span id="l33.65" class="difflineminus">-    FolderDisplayWidget.prototype.__lookupGetter__('selectedMessageUris'),</span>
<a href="#l33.66"></a><span id="l33.66" class="difflineplus">+    FolderDisplayWidget.prototype.__lookupGetter__(&quot;selectedMessageUris&quot;),</span>
<a href="#l33.67"></a><span id="l33.67">   /**</span>
<a href="#l33.68"></a><span id="l33.68">    * Check with the message display widget to see if it has a dummy; if so, just</span>
<a href="#l33.69"></a><span id="l33.69">    *  return the dummy's URI, as the nsMsgDBView logic that our superclass uses</span>
<a href="#l33.70"></a><span id="l33.70">    *  falls down in that case.</span>
<a href="#l33.71"></a><span id="l33.71">    */</span>
<a href="#l33.72"></a><span id="l33.72">   get selectedMessageUris() {</span>
<a href="#l33.73"></a><span id="l33.73">     if (this.messageDisplay.displayedUri)</span>
<a href="#l33.74"></a><span id="l33.74">       return [this.messageDisplay.displayedUri];</span>
<a href="#l33.75"></a><span id="l33.75" class="difflineminus">-    return this._superSelectedMessageUrisGetter.call(this);</span>
<a href="#l33.76"></a><span id="l33.76" class="difflineplus">+    return this._superSelectedMessageUrisGetter();</span>
<a href="#l33.77"></a><span id="l33.77">   },</span>
<a href="#l33.78"></a><span id="l33.78"> </span>
<a href="#l33.79"></a><span id="l33.79" class="difflineminus">-  /// folder display will want to show the thread pane; we need do nothing</span>
<a href="#l33.80"></a><span id="l33.80" class="difflineminus">-  _showThreadPane: function () {},</span>
<a href="#l33.81"></a><span id="l33.81" class="difflineminus">-  _showAccountCentral: function () {},</span>
<a href="#l33.82"></a><span id="l33.82" class="difflineplus">+  // folder display will want to show the thread pane; we need do nothing</span>
<a href="#l33.83"></a><span id="l33.83" class="difflineplus">+  _showThreadPane() {},</span>
<a href="#l33.84"></a><span id="l33.84" class="difflineplus">+  _showAccountCentral() {},</span>
<a href="#l33.85"></a><span id="l33.85"> </span>
<a href="#l33.86"></a><span id="l33.86" class="difflineminus">-  _updateThreadDisplay: function () {},</span>
<a href="#l33.87"></a><span id="l33.87" class="difflineplus">+  _updateThreadDisplay() {},</span>
<a href="#l33.88"></a><span id="l33.88"> </span>
<a href="#l33.89"></a><span id="l33.89">   // we don't care about columns.</span>
<a href="#l33.90"></a><span id="l33.90" class="difflineminus">-  setColumnStates: function () {},</span>
<a href="#l33.91"></a><span id="l33.91" class="difflineminus">-  getColumnStates: function () { return {}; },</span>
<a href="#l33.92"></a><span id="l33.92" class="difflineminus">-  _depersistColumnStateFromDbFolderInfo: function () { return {}; },</span>
<a href="#l33.93"></a><span id="l33.93" class="difflineminus">-  _getDefaultColumnsForCurrentFolder: function () { return {}; },</span>
<a href="#l33.94"></a><span id="l33.94" class="difflineminus">-  _persistColumnStates: function () {},</span>
<a href="#l33.95"></a><span id="l33.95" class="difflineminus">-  _saveColumnStates: function () {},</span>
<a href="#l33.96"></a><span id="l33.96" class="difflineminus">-  _restoreColumnStates: function() {},</span>
<a href="#l33.97"></a><span id="l33.97" class="difflineplus">+  setColumnStates() {},</span>
<a href="#l33.98"></a><span id="l33.98" class="difflineplus">+  getColumnStates() { return {}; },</span>
<a href="#l33.99"></a><span id="l33.99" class="difflineplus">+  _depersistColumnStateFromDbFolderInfo() { return {}; },</span>
<a href="#l33.100"></a><span id="l33.100" class="difflineplus">+  _getDefaultColumnsForCurrentFolder() { return {}; },</span>
<a href="#l33.101"></a><span id="l33.101" class="difflineplus">+  _persistColumnStates() {},</span>
<a href="#l33.102"></a><span id="l33.102" class="difflineplus">+  _saveColumnStates() {},</span>
<a href="#l33.103"></a><span id="l33.103" class="difflineplus">+  _restoreColumnStates() {},</span>
<a href="#l33.104"></a><span id="l33.104"> </span>
<a href="#l33.105"></a><span id="l33.105" class="difflineminus">-  onMessageCountsChanged:</span>
<a href="#l33.106"></a><span id="l33.106" class="difflineminus">-      function StandaloneFolderDisplayWidget_onMessageCountsChaned() {</span>
<a href="#l33.107"></a><span id="l33.107" class="difflineplus">+  onMessageCountsChanged() {</span>
<a href="#l33.108"></a><span id="l33.108">     UpdateStatusMessageCounts();</span>
<a href="#l33.109"></a><span id="l33.109" class="difflineminus">-  }</span>
<a href="#l33.110"></a><span id="l33.110" class="difflineplus">+  },</span>
<a href="#l33.111"></a><span id="l33.111"> };</span>
<a href="#l33.112"></a><span id="l33.112"> </span>
<a href="#l33.113"></a><span id="l33.113"> /**</span>
<a href="#l33.114"></a><span id="l33.114">  * Display widget abstraction for a standalone message display.  Right now</span>
<a href="#l33.115"></a><span id="l33.115">  *  I think this means the standalone message window, and not the 'message in a</span>
<a href="#l33.116"></a><span id="l33.116">  *  tab' thing, which is really just a perverted configuration of the 3-pane</span>
<a href="#l33.117"></a><span id="l33.117">  *  format.</span>
<a href="#l33.118"></a><span id="l33.118">  */</span>
<a href="#l33.119"></a><span id="l33.119" class="difflineat">@@ -178,53 +175,51 @@ StandaloneMessageDisplayWidget.prototype</span>
<a href="#l33.120"></a><span id="l33.120">   /**</span>
<a href="#l33.121"></a><span id="l33.121">    * The message pane is a standalone display widget is always visible.</span>
<a href="#l33.122"></a><span id="l33.122">    */</span>
<a href="#l33.123"></a><span id="l33.123">   get visible() {</span>
<a href="#l33.124"></a><span id="l33.124">     return true;</span>
<a href="#l33.125"></a><span id="l33.125">   },</span>
<a href="#l33.126"></a><span id="l33.126">   set visible(aIgnored) {</span>
<a href="#l33.127"></a><span id="l33.127">   },</span>
<a href="#l33.128"></a><span id="l33.128" class="difflineminus">-  /// We're always active</span>
<a href="#l33.129"></a><span id="l33.129" class="difflineplus">+  // We're always active</span>
<a href="#l33.130"></a><span id="l33.130">   _active: true,</span>
<a href="#l33.131"></a><span id="l33.131">   active: true,</span>
<a href="#l33.132"></a><span id="l33.132">   /**</span>
<a href="#l33.133"></a><span id="l33.133">    * Since we're always active, there's no reason for us to do anything with</span>
<a href="#l33.134"></a><span id="l33.134">    * makeActive or makeInactive.</span>
<a href="#l33.135"></a><span id="l33.135">    */</span>
<a href="#l33.136"></a><span id="l33.136" class="difflineminus">-  makeActive: function StandaloneMessageDisplayWidget_makeActive() {</span>
<a href="#l33.137"></a><span id="l33.137" class="difflineplus">+  makeActive() {</span>
<a href="#l33.138"></a><span id="l33.138">   },</span>
<a href="#l33.139"></a><span id="l33.139"> </span>
<a href="#l33.140"></a><span id="l33.140" class="difflineminus">-  makeInactive: function StandaloneMessageDisplayWidget_makeInactive() {</span>
<a href="#l33.141"></a><span id="l33.141" class="difflineplus">+  makeInactive() {</span>
<a href="#l33.142"></a><span id="l33.142">   },</span>
<a href="#l33.143"></a><span id="l33.143"> </span>
<a href="#l33.144"></a><span id="l33.144">   /**</span>
<a href="#l33.145"></a><span id="l33.145">    * Display the external message (from disk or attachment) named by the URI.</span>
<a href="#l33.146"></a><span id="l33.146">    */</span>
<a href="#l33.147"></a><span id="l33.147" class="difflineminus">-  displayExternalMessage:</span>
<a href="#l33.148"></a><span id="l33.148" class="difflineminus">-      function StandaloneMessageDisplayWidget_displayExternalMessage(aUri) {</span>
<a href="#l33.149"></a><span id="l33.149" class="difflineplus">+  displayExternalMessage(aUri) {</span>
<a href="#l33.150"></a><span id="l33.150">     this.isDummy = true;</span>
<a href="#l33.151"></a><span id="l33.151">     this.displayedUri = aUri;</span>
<a href="#l33.152"></a><span id="l33.152">     this.onDisplayingMessage(messageHeaderSink.dummyMsgHeader);</span>
<a href="#l33.153"></a><span id="l33.153">     UpdateMailToolbar(&quot;external message display&quot;);</span>
<a href="#l33.154"></a><span id="l33.154">     // null out the selection on the view so it operates in stand alone mode</span>
<a href="#l33.155"></a><span id="l33.155">     this.folderDisplay.view.dbView.selection = null;</span>
<a href="#l33.156"></a><span id="l33.156">     this.folderDisplay.view.dbView.loadMessageByUrl(aUri);</span>
<a href="#l33.157"></a><span id="l33.157">   },</span>
<a href="#l33.158"></a><span id="l33.158"> </span>
<a href="#l33.159"></a><span id="l33.159" class="difflineminus">-  clearDisplay: function () {</span>
<a href="#l33.160"></a><span id="l33.160" class="difflineplus">+  clearDisplay() {</span>
<a href="#l33.161"></a><span id="l33.161">     this.messageLoading = false;</span>
<a href="#l33.162"></a><span id="l33.162">     this.messageLoaded = false;</span>
<a href="#l33.163"></a><span id="l33.163">   },</span>
<a href="#l33.164"></a><span id="l33.164" class="difflineminus">-  _updateActiveMessagePane: function() {</span>
<a href="#l33.165"></a><span id="l33.165" class="difflineplus">+  _updateActiveMessagePane() {</span>
<a href="#l33.166"></a><span id="l33.166">     // no-op.  the message pane is always visible.</span>
<a href="#l33.167"></a><span id="l33.167">   },</span>
<a href="#l33.168"></a><span id="l33.168"> </span>
<a href="#l33.169"></a><span id="l33.169" class="difflineminus">-  onDisplayingMessage:</span>
<a href="#l33.170"></a><span id="l33.170" class="difflineminus">-      function StandaloneMessageDisplayWidget_onDisplayingMessage(aMsgHdr) {</span>
<a href="#l33.171"></a><span id="l33.171" class="difflineplus">+  onDisplayingMessage(aMsgHdr) {</span>
<a href="#l33.172"></a><span id="l33.172">     this.__proto__.__proto__.onDisplayingMessage.call(this, aMsgHdr);</span>
<a href="#l33.173"></a><span id="l33.173"> </span>
<a href="#l33.174"></a><span id="l33.174">     // - set the window title to the message subject (and maybe the app name)</span>
<a href="#l33.175"></a><span id="l33.175">     let docTitle = aMsgHdr.mime2DecodedSubject;</span>
<a href="#l33.176"></a><span id="l33.176"> </span>
<a href="#l33.177"></a><span id="l33.177">     // If the tab hasn't got a title, or we're on Mac, don't display</span>
<a href="#l33.178"></a><span id="l33.178">     // the separator.</span>
<a href="#l33.179"></a><span id="l33.179">     if (docTitle &amp;&amp; (AppConstants.platform != &quot;macosx&quot;))</span>
<a href="#l33.180"></a><span id="l33.180" class="difflineat">@@ -242,104 +237,94 @@ StandaloneMessageDisplayWidget.prototype</span>
<a href="#l33.181"></a><span id="l33.181">     this.isDummy = aMsgHdr.folder == null;</span>
<a href="#l33.182"></a><span id="l33.182">     if (!this.isDummy)</span>
<a href="#l33.183"></a><span id="l33.183">       this.displayedUri = null;</span>
<a href="#l33.184"></a><span id="l33.184"> </span>
<a href="#l33.185"></a><span id="l33.185">     // We've loaded a message, so this should be set to false</span>
<a href="#l33.186"></a><span id="l33.186">     this.aboutToLoadMessage = false;</span>
<a href="#l33.187"></a><span id="l33.187">   },</span>
<a href="#l33.188"></a><span id="l33.188"> </span>
<a href="#l33.189"></a><span id="l33.189" class="difflineminus">-  onSelectedMessagesChanged: function () {</span>
<a href="#l33.190"></a><span id="l33.190" class="difflineplus">+  onSelectedMessagesChanged() {</span>
<a href="#l33.191"></a><span id="l33.191">     // When switching folders, we won't have any selection for a while.</span>
<a href="#l33.192"></a><span id="l33.192">     if (!this.folderDisplay.view.dbView)</span>
<a href="#l33.193"></a><span id="l33.193">       return true;</span>
<a href="#l33.194"></a><span id="l33.194"> </span>
<a href="#l33.195"></a><span id="l33.195">     // If the message we're displaying is deleted, we won't have any selection</span>
<a href="#l33.196"></a><span id="l33.196">     // for a while, but we'll soon select a new message. So don't test the</span>
<a href="#l33.197"></a><span id="l33.197">     // selection count -- instead see if there are any messages in the db view</span>
<a href="#l33.198"></a><span id="l33.198">     // at all.</span>
<a href="#l33.199"></a><span id="l33.199">     if (!this.aboutToLoadMessage &amp;&amp;</span>
<a href="#l33.200"></a><span id="l33.200">         this.folderDisplay.view.dbView.rowCount == 0) {</span>
<a href="#l33.201"></a><span id="l33.201">       window.close();</span>
<a href="#l33.202"></a><span id="l33.202">       return true;</span>
<a href="#l33.203"></a><span id="l33.203">     }</span>
<a href="#l33.204"></a><span id="l33.204">     return false;</span>
<a href="#l33.205"></a><span id="l33.205">   },</span>
<a href="#l33.206"></a><span id="l33.206"> </span>
<a href="#l33.207"></a><span id="l33.207" class="difflineminus">-  onMessagesRemoved:</span>
<a href="#l33.208"></a><span id="l33.208" class="difflineminus">-      function StandaloneMessageDisplayWidget_onMessagesRemoved() {</span>
<a href="#l33.209"></a><span id="l33.209" class="difflineplus">+  onMessagesRemoved() {</span>
<a href="#l33.210"></a><span id="l33.210">     if (!this.folderDisplay.treeSelection)</span>
<a href="#l33.211"></a><span id="l33.211">       return true;</span>
<a href="#l33.212"></a><span id="l33.212">     if (this.folderDisplay.treeSelection.count == 0 &amp;&amp;</span>
<a href="#l33.213"></a><span id="l33.213">         Services.prefs.getBoolPref(&quot;mail.close_message_window.on_delete&quot;)) {</span>
<a href="#l33.214"></a><span id="l33.214">       window.close();</span>
<a href="#l33.215"></a><span id="l33.215">       return true;</span>
<a href="#l33.216"></a><span id="l33.216">     }</span>
<a href="#l33.217"></a><span id="l33.217">     return false;</span>
<a href="#l33.218"></a><span id="l33.218">   },</span>
<a href="#l33.219"></a><span id="l33.219"> };</span>
<a href="#l33.220"></a><span id="l33.220"> </span>
<a href="#l33.221"></a><span id="l33.221"> var messagepaneObserver = {</span>
<a href="#l33.222"></a><span id="l33.222"> </span>
<a href="#l33.223"></a><span id="l33.223">   canHandleMultipleItems: false,</span>
<a href="#l33.224"></a><span id="l33.224"> </span>
<a href="#l33.225"></a><span id="l33.225" class="difflineminus">-  onDrop: function (aEvent, aData, aDragSession)</span>
<a href="#l33.226"></a><span id="l33.226" class="difflineminus">-  {</span>
<a href="#l33.227"></a><span id="l33.227" class="difflineplus">+  onDrop(aEvent, aData, aDragSession) {</span>
<a href="#l33.228"></a><span id="l33.228">     var sourceUri = aData.data;</span>
<a href="#l33.229"></a><span id="l33.229">     if (!gFolderDisplay.selectedMessage ||</span>
<a href="#l33.230"></a><span id="l33.230" class="difflineminus">-        sourceUri != gFolderDisplay.selectedMessageUris[0])</span>
<a href="#l33.231"></a><span id="l33.231" class="difflineminus">-    {</span>
<a href="#l33.232"></a><span id="l33.232" class="difflineplus">+        sourceUri != gFolderDisplay.selectedMessageUris[0]) {</span>
<a href="#l33.233"></a><span id="l33.233">       var msgHdr = messenger.msgHdrFromURI(sourceUri);</span>
<a href="#l33.234"></a><span id="l33.234">       let originGlobal = aDragSession.sourceNode.ownerDocument.defaultValue;</span>
<a href="#l33.235"></a><span id="l33.235">       gFolderDisplay.cloneView(originGlobal.gFolderDisplay.view);</span>
<a href="#l33.236"></a><span id="l33.236">       gFolderDisplay.selectMessage(msgHdr);</span>
<a href="#l33.237"></a><span id="l33.237">     }</span>
<a href="#l33.238"></a><span id="l33.238">   },</span>
<a href="#l33.239"></a><span id="l33.239"> </span>
<a href="#l33.240"></a><span id="l33.240" class="difflineminus">-  onDragOver: function (aEvent, aFlavour, aDragSession)</span>
<a href="#l33.241"></a><span id="l33.241" class="difflineminus">-  {</span>
<a href="#l33.242"></a><span id="l33.242" class="difflineplus">+  onDragOver(aEvent, aFlavour, aDragSession) {</span>
<a href="#l33.243"></a><span id="l33.243">     var messagepanebox = document.getElementById(&quot;messagepanebox&quot;);</span>
<a href="#l33.244"></a><span id="l33.244">     messagepanebox.setAttribute(&quot;dragover&quot;, &quot;true&quot;);</span>
<a href="#l33.245"></a><span id="l33.245">   },</span>
<a href="#l33.246"></a><span id="l33.246"> </span>
<a href="#l33.247"></a><span id="l33.247" class="difflineminus">-  onDragExit: function (aEvent, aDragSession)</span>
<a href="#l33.248"></a><span id="l33.248" class="difflineminus">-  {</span>
<a href="#l33.249"></a><span id="l33.249" class="difflineplus">+  onDragExit(aEvent, aDragSession) {</span>
<a href="#l33.250"></a><span id="l33.250">     var messagepanebox = document.getElementById(&quot;messagepanebox&quot;);</span>
<a href="#l33.251"></a><span id="l33.251">     messagepanebox.removeAttribute(&quot;dragover&quot;);</span>
<a href="#l33.252"></a><span id="l33.252">   },</span>
<a href="#l33.253"></a><span id="l33.253"> </span>
<a href="#l33.254"></a><span id="l33.254" class="difflineminus">-  canDrop: function(aEvent, aDragSession)  //allow drop from mail:3pane window only - 4xp</span>
<a href="#l33.255"></a><span id="l33.255" class="difflineminus">-  {</span>
<a href="#l33.256"></a><span id="l33.256" class="difflineplus">+  canDrop(aEvent, aDragSession) { // allow drop from mail:3pane window only - 4xp</span>
<a href="#l33.257"></a><span id="l33.257">     var doc = aDragSession.sourceNode.ownerDocument;</span>
<a href="#l33.258"></a><span id="l33.258">     var elem = doc.getElementById(&quot;messengerWindow&quot;);</span>
<a href="#l33.259"></a><span id="l33.259">     return (elem &amp;&amp; (elem.getAttribute(&quot;windowtype&quot;) == &quot;mail:3pane&quot;));</span>
<a href="#l33.260"></a><span id="l33.260">   },</span>
<a href="#l33.261"></a><span id="l33.261"> </span>
<a href="#l33.262"></a><span id="l33.262" class="difflineminus">-  getSupportedFlavours: function ()</span>
<a href="#l33.263"></a><span id="l33.263" class="difflineminus">-  {</span>
<a href="#l33.264"></a><span id="l33.264" class="difflineplus">+  getSupportedFlavours() {</span>
<a href="#l33.265"></a><span id="l33.265">     var flavourSet = new FlavourSet();</span>
<a href="#l33.266"></a><span id="l33.266">     flavourSet.appendFlavour(&quot;text/x-moz-message&quot;);</span>
<a href="#l33.267"></a><span id="l33.267">     return flavourSet;</span>
<a href="#l33.268"></a><span id="l33.268" class="difflineminus">-  }</span>
<a href="#l33.269"></a><span id="l33.269" class="difflineplus">+  },</span>
<a href="#l33.270"></a><span id="l33.270"> };</span>
<a href="#l33.271"></a><span id="l33.271"> </span>
<a href="#l33.272"></a><span id="l33.272" class="difflineminus">-function UpdateStatusMessageCounts()</span>
<a href="#l33.273"></a><span id="l33.273" class="difflineminus">-{</span>
<a href="#l33.274"></a><span id="l33.274" class="difflineplus">+function UpdateStatusMessageCounts() {</span>
<a href="#l33.275"></a><span id="l33.275">   // hook for extra toolbar items</span>
<a href="#l33.276"></a><span id="l33.276">   Services.obs.notifyObservers(window, &quot;mail:updateStandAloneMessageCounts&quot;);</span>
<a href="#l33.277"></a><span id="l33.277"> }</span>
<a href="#l33.278"></a><span id="l33.278"> </span>
<a href="#l33.279"></a><span id="l33.279"> // we won't show the window until the onload() handler is finished</span>
<a href="#l33.280"></a><span id="l33.280"> // so we do this trick (suggested by hyatt / blaker)</span>
<a href="#l33.281"></a><span id="l33.281" class="difflineminus">-function OnLoadMessageWindow()</span>
<a href="#l33.282"></a><span id="l33.282" class="difflineminus">-{</span>
<a href="#l33.283"></a><span id="l33.283" class="difflineplus">+function OnLoadMessageWindow() {</span>
<a href="#l33.284"></a><span id="l33.284">   // Set a sane starting width/height for all resolutions on new profiles.</span>
<a href="#l33.285"></a><span id="l33.285">   // Do this before the window loads.</span>
<a href="#l33.286"></a><span id="l33.286" class="difflineminus">-  if (!document.documentElement.hasAttribute(&quot;width&quot;))</span>
<a href="#l33.287"></a><span id="l33.287" class="difflineminus">-  {</span>
<a href="#l33.288"></a><span id="l33.288" class="difflineplus">+  if (!document.documentElement.hasAttribute(&quot;width&quot;)) {</span>
<a href="#l33.289"></a><span id="l33.289">     // Prefer 860xfull height.</span>
<a href="#l33.290"></a><span id="l33.290">     let defaultHeight = screen.availHeight;</span>
<a href="#l33.291"></a><span id="l33.291">     let defaultWidth = (screen.availWidth &gt;= 860) ? 860 : screen.availWidth;</span>
<a href="#l33.292"></a><span id="l33.292"> </span>
<a href="#l33.293"></a><span id="l33.293">     // On small screens, default to maximized state.</span>
<a href="#l33.294"></a><span id="l33.294">     if (defaultHeight &lt;= 600)</span>
<a href="#l33.295"></a><span id="l33.295">       document.documentElement.setAttribute(&quot;sizemode&quot;, &quot;maximized&quot;);</span>
<a href="#l33.296"></a><span id="l33.296"> </span>
<a href="#l33.297"></a><span id="l33.297" class="difflineat">@@ -349,51 +334,50 @@ function OnLoadMessageWindow()</span>
<a href="#l33.298"></a><span id="l33.298">     document.documentElement.setAttribute(&quot;screenX&quot;, screen.availLeft);</span>
<a href="#l33.299"></a><span id="l33.299">     document.documentElement.setAttribute(&quot;screenY&quot;, screen.availTop);</span>
<a href="#l33.300"></a><span id="l33.300">   }</span>
<a href="#l33.301"></a><span id="l33.301"> </span>
<a href="#l33.302"></a><span id="l33.302">   ToolbarIconColor.init();</span>
<a href="#l33.303"></a><span id="l33.303">   setTimeout(delayedOnLoadMessageWindow, 0); // when debugging, set this to 5000, so you can see what happens after the window comes up.</span>
<a href="#l33.304"></a><span id="l33.304"> }</span>
<a href="#l33.305"></a><span id="l33.305"> </span>
<a href="#l33.306"></a><span id="l33.306" class="difflineminus">-function delayedOnLoadMessageWindow()</span>
<a href="#l33.307"></a><span id="l33.307" class="difflineminus">-{</span>
<a href="#l33.308"></a><span id="l33.308" class="difflineplus">+function delayedOnLoadMessageWindow() {</span>
<a href="#l33.309"></a><span id="l33.309">   HideMenus();</span>
<a href="#l33.310"></a><span id="l33.310">   ShowMenus();</span>
<a href="#l33.311"></a><span id="l33.311">   MailOfflineMgr.init();</span>
<a href="#l33.312"></a><span id="l33.312">   CreateMailWindowGlobals();</span>
<a href="#l33.313"></a><span id="l33.313">   verifyAccounts(null);</span>
<a href="#l33.314"></a><span id="l33.314"> </span>
<a href="#l33.315"></a><span id="l33.315">   /**</span>
<a href="#l33.316"></a><span id="l33.316">    * Create a message listener so that we can update the title once the message</span>
<a href="#l33.317"></a><span id="l33.317">    *  finishes streaming when it's a dummy.</span>
<a href="#l33.318"></a><span id="l33.318">    */</span>
<a href="#l33.319"></a><span id="l33.319">   gMessageListeners.push({</span>
<a href="#l33.320"></a><span id="l33.320" class="difflineminus">-    onStartHeaders: function () {},</span>
<a href="#l33.321"></a><span id="l33.321" class="difflineminus">-    onEndHeaders: function() {</span>
<a href="#l33.322"></a><span id="l33.322" class="difflineplus">+    onStartHeaders() {},</span>
<a href="#l33.323"></a><span id="l33.323" class="difflineplus">+    onEndHeaders() {</span>
<a href="#l33.324"></a><span id="l33.324">       if (gMessageDisplay.isDummy)</span>
<a href="#l33.325"></a><span id="l33.325">         gMessageDisplay.onDisplayingMessage(messageHeaderSink.dummyMsgHeader);</span>
<a href="#l33.326"></a><span id="l33.326">       UpdateMailToolbar(&quot;.eml/message from attachment finished loading&quot;);</span>
<a href="#l33.327"></a><span id="l33.327">     },</span>
<a href="#l33.328"></a><span id="l33.328" class="difflineminus">-    onEndAttachments: function () {},</span>
<a href="#l33.329"></a><span id="l33.329" class="difflineplus">+    onEndAttachments() {},</span>
<a href="#l33.330"></a><span id="l33.330">   });</span>
<a href="#l33.331"></a><span id="l33.331"> </span>
<a href="#l33.332"></a><span id="l33.332">   InitMsgWindow();</span>
<a href="#l33.333"></a><span id="l33.333"> </span>
<a href="#l33.334"></a><span id="l33.334">   messenger.setWindow(window, msgWindow);</span>
<a href="#l33.335"></a><span id="l33.335">   // FIX ME - later we will be able to use onload from the overlay</span>
<a href="#l33.336"></a><span id="l33.336">   OnLoadMsgHeaderPane();</span>
<a href="#l33.337"></a><span id="l33.337"> </span>
<a href="#l33.338"></a><span id="l33.338">   gPhishingDetector.init();</span>
<a href="#l33.339"></a><span id="l33.339"> </span>
<a href="#l33.340"></a><span id="l33.340">   // initialize the customizeDone method on the customizeable toolbar</span>
<a href="#l33.341"></a><span id="l33.341">   var toolbox = document.getElementById(&quot;mail-toolbox&quot;);</span>
<a href="#l33.342"></a><span id="l33.342">   toolbox.customizeDone = function(aEvent) { MailToolboxCustomizeDone(aEvent, &quot;CustomizeMailToolbar&quot;); };</span>
<a href="#l33.343"></a><span id="l33.343"> </span>
<a href="#l33.344"></a><span id="l33.344" class="difflineminus">-  var toolbarset = document.getElementById('customToolbars');</span>
<a href="#l33.345"></a><span id="l33.345" class="difflineplus">+  var toolbarset = document.getElementById(&quot;customToolbars&quot;);</span>
<a href="#l33.346"></a><span id="l33.346">   toolbox.toolbarset = toolbarset;</span>
<a href="#l33.347"></a><span id="l33.347"> </span>
<a href="#l33.348"></a><span id="l33.348">   SetupCommandUpdateHandlers();</span>
<a href="#l33.349"></a><span id="l33.349"> </span>
<a href="#l33.350"></a><span id="l33.350">   gMessageDisplay = new StandaloneMessageDisplayWidget();</span>
<a href="#l33.351"></a><span id="l33.351">   gFolderDisplay = new StandaloneFolderDisplayWidget(gMessageDisplay);</span>
<a href="#l33.352"></a><span id="l33.352">   gFolderDisplay.msgWindow = msgWindow;</span>
<a href="#l33.353"></a><span id="l33.353">   gFolderDisplay.messenger = messenger;</span>
<a href="#l33.354"></a><span id="l33.354" class="difflineat">@@ -426,53 +410,48 @@ function actuallyLoadMessage() {</span>
<a href="#l33.355"></a><span id="l33.355">    *     on disk or that is an attachment part on another message.</span>
<a href="#l33.356"></a><span id="l33.356">    *</span>
<a href="#l33.357"></a><span id="l33.357">    * Our original set of arguments, in case these get passed in and you're</span>
<a href="#l33.358"></a><span id="l33.358">    *  wondering why we explode, was:</span>
<a href="#l33.359"></a><span id="l33.359">    *   0: A message URI, string or nsIURI.</span>
<a href="#l33.360"></a><span id="l33.360">    *   1: A folder URI.  If arg 0 was an nsIURI, it may have had a folder attribute.</span>
<a href="#l33.361"></a><span id="l33.361">    *   2: The nsIMsgDBView used to open us.</span>
<a href="#l33.362"></a><span id="l33.362">    */</span>
<a href="#l33.363"></a><span id="l33.363" class="difflineminus">-  if (window.arguments &amp;&amp; window.arguments.length)</span>
<a href="#l33.364"></a><span id="l33.364" class="difflineminus">-  {</span>
<a href="#l33.365"></a><span id="l33.365" class="difflineplus">+  if (window.arguments &amp;&amp; window.arguments.length) {</span>
<a href="#l33.366"></a><span id="l33.366">     let msgHdr = null, originViewWrapper = null;</span>
<a href="#l33.367"></a><span id="l33.367">     // message header as an object?</span>
<a href="#l33.368"></a><span id="l33.368">     if (&quot;wrappedJSObject&quot; in window.arguments[0]) {</span>
<a href="#l33.369"></a><span id="l33.369">       let hdrObject = window.arguments[0].wrappedJSObject;</span>
<a href="#l33.370"></a><span id="l33.370">       msgHdr = hdrObject.msgHdr;</span>
<a href="#l33.371"></a><span id="l33.371">       if (&quot;viewWrapperToClone&quot; in hdrObject)</span>
<a href="#l33.372"></a><span id="l33.372">         originViewWrapper = hdrObject.viewWrapperToClone;</span>
<a href="#l33.373"></a><span id="l33.373" class="difflineminus">-    }</span>
<a href="#l33.374"></a><span id="l33.374" class="difflineminus">-    // message header as a separate param?</span>
<a href="#l33.375"></a><span id="l33.375" class="difflineminus">-    else if (window.arguments[0] instanceof Ci.nsIMsgDBHdr) {</span>
<a href="#l33.376"></a><span id="l33.376" class="difflineplus">+    } else if (window.arguments[0] instanceof Ci.nsIMsgDBHdr) {</span>
<a href="#l33.377"></a><span id="l33.377" class="difflineplus">+      // message header as a separate param?</span>
<a href="#l33.378"></a><span id="l33.378">       msgHdr = window.arguments[0];</span>
<a href="#l33.379"></a><span id="l33.379">       originViewWrapper = window.arguments.length &gt; 1 ?</span>
<a href="#l33.380"></a><span id="l33.380">         window.arguments[1] : null;</span>
<a href="#l33.381"></a><span id="l33.381">     }</span>
<a href="#l33.382"></a><span id="l33.382"> </span>
<a href="#l33.383"></a><span id="l33.383">     // this is a message header, so show it</span>
<a href="#l33.384"></a><span id="l33.384">     if (msgHdr) {</span>
<a href="#l33.385"></a><span id="l33.385">       if (originViewWrapper) {</span>
<a href="#l33.386"></a><span id="l33.386">         // The original view must have a collapsed group header thread's</span>
<a href="#l33.387"></a><span id="l33.387">         // message(s) found in expand mode before it's cloned, for any to</span>
<a href="#l33.388"></a><span id="l33.388">         // be selected.</span>
<a href="#l33.389"></a><span id="l33.389">         if (originViewWrapper.showGroupedBySort)</span>
<a href="#l33.390"></a><span id="l33.390">           originViewWrapper.dbView.findIndexOfMsgHdr(msgHdr, true);</span>
<a href="#l33.391"></a><span id="l33.391"> </span>
<a href="#l33.392"></a><span id="l33.392">         gFolderDisplay.cloneView(originViewWrapper);</span>
<a href="#l33.393"></a><span id="l33.393" class="difflineminus">-      }</span>
<a href="#l33.394"></a><span id="l33.394" class="difflineminus">-      else {</span>
<a href="#l33.395"></a><span id="l33.395" class="difflineplus">+      } else {</span>
<a href="#l33.396"></a><span id="l33.396">         // Create a synthetic message view for the header</span>
<a href="#l33.397"></a><span id="l33.397">         let synView = new MsgHdrSyntheticView(msgHdr);</span>
<a href="#l33.398"></a><span id="l33.398">         gFolderDisplay.show(synView);</span>
<a href="#l33.399"></a><span id="l33.399">       }</span>
<a href="#l33.400"></a><span id="l33.400">       gFolderDisplay.selectMessage(msgHdr);</span>
<a href="#l33.401"></a><span id="l33.401" class="difflineminus">-    }</span>
<a href="#l33.402"></a><span id="l33.402" class="difflineminus">-    // it must be a URI for a message lacking a backing header</span>
<a href="#l33.403"></a><span id="l33.403" class="difflineminus">-    else {</span>
<a href="#l33.404"></a><span id="l33.404" class="difflineplus">+    } else { // it must be a URI for a message lacking a backing header</span>
<a href="#l33.405"></a><span id="l33.405">       // Here's how this goes.  nsMessenger::LoadURL checks out the URL we</span>
<a href="#l33.406"></a><span id="l33.406">       //  pass it, and if it sees that the URI starts with &quot;file:&quot; or contains</span>
<a href="#l33.407"></a><span id="l33.407">       //  &quot;type=application/x-message-display&quot; then it knows it needs to</span>
<a href="#l33.408"></a><span id="l33.408">       //  create a dummy header.  It gets the 'dummyMsgHeader' property from</span>
<a href="#l33.409"></a><span id="l33.409">       //  the js message header sink.</span>
<a href="#l33.410"></a><span id="l33.410">       // Additionally, nsMessenger::MsgHdrFromURI checks the URI we pass it</span>
<a href="#l33.411"></a><span id="l33.411">       //  and if it meets either of those same constraints (assuming it has a</span>
<a href="#l33.412"></a><span id="l33.412">       //  msgWindow), it will retrieve the header sink off the msgWindow, get</span>
<a href="#l33.413"></a><span id="l33.413" class="difflineat">@@ -498,105 +477,102 @@ function actuallyLoadMessage() {</span>
<a href="#l33.414"></a><span id="l33.414">  * Load the given message into this window, and bring it to the front. This is</span>
<a href="#l33.415"></a><span id="l33.415">  * supposed to be called whenever a message is supposed to be displayed in this</span>
<a href="#l33.416"></a><span id="l33.416">  * window.</span>
<a href="#l33.417"></a><span id="l33.417">  *</span>
<a href="#l33.418"></a><span id="l33.418">  * @param aMsgHdr the message to display</span>
<a href="#l33.419"></a><span id="l33.419">  * @param aViewWrapperToClone [optional] a DB view wrapper to clone for the</span>
<a href="#l33.420"></a><span id="l33.420">  *                            message window</span>
<a href="#l33.421"></a><span id="l33.421">  */</span>
<a href="#l33.422"></a><span id="l33.422" class="difflineminus">-function displayMessage(aMsgHdr, aViewWrapperToClone)</span>
<a href="#l33.423"></a><span id="l33.423" class="difflineminus">-{</span>
<a href="#l33.424"></a><span id="l33.424" class="difflineplus">+function displayMessage(aMsgHdr, aViewWrapperToClone) {</span>
<a href="#l33.425"></a><span id="l33.425">   // We're about to load another message, so make sure we don't close this</span>
<a href="#l33.426"></a><span id="l33.426">   // window</span>
<a href="#l33.427"></a><span id="l33.427">   gMessageDisplay.aboutToLoadMessage = true;</span>
<a href="#l33.428"></a><span id="l33.428"> </span>
<a href="#l33.429"></a><span id="l33.429">   // Clear our old selection, so that we don't load the old URL onCreatedView.</span>
<a href="#l33.430"></a><span id="l33.430">   // Setting aboutToLoadMessage = true above means that we won't close the</span>
<a href="#l33.431"></a><span id="l33.431">   // window because of this.</span>
<a href="#l33.432"></a><span id="l33.432">   gFolderDisplay.clearSelection();</span>
<a href="#l33.433"></a><span id="l33.433"> </span>
<a href="#l33.434"></a><span id="l33.434">   if (aViewWrapperToClone) {</span>
<a href="#l33.435"></a><span id="l33.435">     if (aViewWrapperToClone.showGroupedBySort)</span>
<a href="#l33.436"></a><span id="l33.436">       aViewWrapperToClone.dbView.findIndexOfMsgHdr(aMsgHdr, true);</span>
<a href="#l33.437"></a><span id="l33.437"> </span>
<a href="#l33.438"></a><span id="l33.438">     gFolderDisplay.cloneView(aViewWrapperToClone);</span>
<a href="#l33.439"></a><span id="l33.439" class="difflineminus">-  }</span>
<a href="#l33.440"></a><span id="l33.440" class="difflineminus">-  else {</span>
<a href="#l33.441"></a><span id="l33.441" class="difflineplus">+  } else {</span>
<a href="#l33.442"></a><span id="l33.442">     // Create a synthetic message view for the header</span>
<a href="#l33.443"></a><span id="l33.443">     let synView = new MsgHdrSyntheticView(aMsgHdr);</span>
<a href="#l33.444"></a><span id="l33.444">     gFolderDisplay.show(synView);</span>
<a href="#l33.445"></a><span id="l33.445">   }</span>
<a href="#l33.446"></a><span id="l33.446"> </span>
<a href="#l33.447"></a><span id="l33.447">   // show the message</span>
<a href="#l33.448"></a><span id="l33.448">   gFolderDisplay.selectMessage(aMsgHdr);</span>
<a href="#l33.449"></a><span id="l33.449"> </span>
<a href="#l33.450"></a><span id="l33.450">   // bring this window to the front</span>
<a href="#l33.451"></a><span id="l33.451">   window.focus();</span>
<a href="#l33.452"></a><span id="l33.452"> }</span>
<a href="#l33.453"></a><span id="l33.453"> </span>
<a href="#l33.454"></a><span id="l33.454" class="difflineminus">-function ShowMenus()</span>
<a href="#l33.455"></a><span id="l33.455" class="difflineminus">-{</span>
<a href="#l33.456"></a><span id="l33.456" class="difflineminus">-  var openMail3Pane_menuitem = document.getElementById('tasksMenuMail');</span>
<a href="#l33.457"></a><span id="l33.457" class="difflineplus">+function ShowMenus() {</span>
<a href="#l33.458"></a><span id="l33.458" class="difflineplus">+  var openMail3Pane_menuitem = document.getElementById(&quot;tasksMenuMail&quot;);</span>
<a href="#l33.459"></a><span id="l33.459">   if (openMail3Pane_menuitem)</span>
<a href="#l33.460"></a><span id="l33.460">     openMail3Pane_menuitem.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l33.461"></a><span id="l33.461" class="difflineminus">-  openMail3Pane_menuitem = document.getElementById('appmenu_tasksMenuMail');</span>
<a href="#l33.462"></a><span id="l33.462" class="difflineplus">+  openMail3Pane_menuitem = document.getElementById(&quot;appmenu_tasksMenuMail&quot;);</span>
<a href="#l33.463"></a><span id="l33.463">   if (openMail3Pane_menuitem)</span>
<a href="#l33.464"></a><span id="l33.464">     openMail3Pane_menuitem.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l33.465"></a><span id="l33.465"> }</span>
<a href="#l33.466"></a><span id="l33.466"> </span>
<a href="#l33.467"></a><span id="l33.467" class="difflineminus">-function HideMenus()</span>
<a href="#l33.468"></a><span id="l33.468" class="difflineminus">-{</span>
<a href="#l33.469"></a><span id="l33.469" class="difflineplus">+/* eslint-disable complexity */</span>
<a href="#l33.470"></a><span id="l33.470" class="difflineplus">+function HideMenus() {</span>
<a href="#l33.471"></a><span id="l33.471">   // TODO: Seems to be a lot of repetitive code.</span>
<a href="#l33.472"></a><span id="l33.472">   // Can we just fold this into an array of element IDs and loop over them?</span>
<a href="#l33.473"></a><span id="l33.473" class="difflineminus">-  var message_menuitem=document.getElementById('menu_showMessage');</span>
<a href="#l33.474"></a><span id="l33.474" class="difflineplus">+  var message_menuitem = document.getElementById(&quot;menu_showMessage&quot;);</span>
<a href="#l33.475"></a><span id="l33.475">   if (message_menuitem)</span>
<a href="#l33.476"></a><span id="l33.476">     message_menuitem.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.477"></a><span id="l33.477"> </span>
<a href="#l33.478"></a><span id="l33.478" class="difflineminus">-  message_menuitem = document.getElementById('appmenu_showMessage');</span>
<a href="#l33.479"></a><span id="l33.479" class="difflineplus">+  message_menuitem = document.getElementById(&quot;appmenu_showMessage&quot;);</span>
<a href="#l33.480"></a><span id="l33.480">   if (message_menuitem)</span>
<a href="#l33.481"></a><span id="l33.481">     message_menuitem.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.482"></a><span id="l33.482"> </span>
<a href="#l33.483"></a><span id="l33.483" class="difflineminus">-  var folderPane_menuitem=document.getElementById('menu_showFolderPane');</span>
<a href="#l33.484"></a><span id="l33.484" class="difflineplus">+  var folderPane_menuitem = document.getElementById(&quot;menu_showFolderPane&quot;);</span>
<a href="#l33.485"></a><span id="l33.485">   if (folderPane_menuitem)</span>
<a href="#l33.486"></a><span id="l33.486">     folderPane_menuitem.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.487"></a><span id="l33.487"> </span>
<a href="#l33.488"></a><span id="l33.488" class="difflineminus">-  folderPane_menuitem = document.getElementById('appmenu_showFolderPane');</span>
<a href="#l33.489"></a><span id="l33.489" class="difflineplus">+  folderPane_menuitem = document.getElementById(&quot;appmenu_showFolderPane&quot;);</span>
<a href="#l33.490"></a><span id="l33.490">   if (folderPane_menuitem)</span>
<a href="#l33.491"></a><span id="l33.491">     folderPane_menuitem.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.492"></a><span id="l33.492"> </span>
<a href="#l33.493"></a><span id="l33.493">   let folderPaneCols_menuitem = document.getElementById(&quot;menu_showFolderPaneCols&quot;);</span>
<a href="#l33.494"></a><span id="l33.494">   if (folderPaneCols_menuitem)</span>
<a href="#l33.495"></a><span id="l33.495">     folderPaneCols_menuitem.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.496"></a><span id="l33.496"> </span>
<a href="#l33.497"></a><span id="l33.497">   folderPaneCols_menuitem = document.getElementById(&quot;appmenu_showFolderPaneCols&quot;);</span>
<a href="#l33.498"></a><span id="l33.498">   if (folderPaneCols_menuitem)</span>
<a href="#l33.499"></a><span id="l33.499">     folderPaneCols_menuitem.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.500"></a><span id="l33.500"> </span>
<a href="#l33.501"></a><span id="l33.501" class="difflineminus">-  var showSearch_showMessage_Separator = document.getElementById('menu_showSearch_showMessage_Separator');</span>
<a href="#l33.502"></a><span id="l33.502" class="difflineplus">+  var showSearch_showMessage_Separator = document.getElementById(&quot;menu_showSearch_showMessage_Separator&quot;);</span>
<a href="#l33.503"></a><span id="l33.503">   if (showSearch_showMessage_Separator)</span>
<a href="#l33.504"></a><span id="l33.504">     showSearch_showMessage_Separator.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.505"></a><span id="l33.505"> </span>
<a href="#l33.506"></a><span id="l33.506" class="difflineminus">-  var expandOrCollapseMenu = document.getElementById('menu_expandOrCollapse');</span>
<a href="#l33.507"></a><span id="l33.507" class="difflineplus">+  var expandOrCollapseMenu = document.getElementById(&quot;menu_expandOrCollapse&quot;);</span>
<a href="#l33.508"></a><span id="l33.508">   if (expandOrCollapseMenu)</span>
<a href="#l33.509"></a><span id="l33.509">     expandOrCollapseMenu.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.510"></a><span id="l33.510"> </span>
<a href="#l33.511"></a><span id="l33.511" class="difflineminus">-  var menuDeleteFolder = document.getElementById('menu_deleteFolder');</span>
<a href="#l33.512"></a><span id="l33.512" class="difflineplus">+  var menuDeleteFolder = document.getElementById(&quot;menu_deleteFolder&quot;);</span>
<a href="#l33.513"></a><span id="l33.513">   if (menuDeleteFolder)</span>
<a href="#l33.514"></a><span id="l33.514">     menuDeleteFolder.hidden = true;</span>
<a href="#l33.515"></a><span id="l33.515"> </span>
<a href="#l33.516"></a><span id="l33.516" class="difflineminus">-  menuDeleteFolder = document.getElementById('appmenu_deleteFolder');</span>
<a href="#l33.517"></a><span id="l33.517" class="difflineplus">+  menuDeleteFolder = document.getElementById(&quot;appmenu_deleteFolder&quot;);</span>
<a href="#l33.518"></a><span id="l33.518">   if (menuDeleteFolder)</span>
<a href="#l33.519"></a><span id="l33.519">     menuDeleteFolder.hidden = true;</span>
<a href="#l33.520"></a><span id="l33.520"> </span>
<a href="#l33.521"></a><span id="l33.521" class="difflineminus">-  var renameFolderMenu = document.getElementById('menu_renameFolder');</span>
<a href="#l33.522"></a><span id="l33.522" class="difflineplus">+  var renameFolderMenu = document.getElementById(&quot;menu_renameFolder&quot;);</span>
<a href="#l33.523"></a><span id="l33.523">   if (renameFolderMenu)</span>
<a href="#l33.524"></a><span id="l33.524">     renameFolderMenu.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.525"></a><span id="l33.525"> </span>
<a href="#l33.526"></a><span id="l33.526" class="difflineminus">-  renameFolderMenu = document.getElementById('appmenu_renameFolder');</span>
<a href="#l33.527"></a><span id="l33.527" class="difflineplus">+  renameFolderMenu = document.getElementById(&quot;appmenu_renameFolder&quot;);</span>
<a href="#l33.528"></a><span id="l33.528">   if (renameFolderMenu)</span>
<a href="#l33.529"></a><span id="l33.529">     renameFolderMenu.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.530"></a><span id="l33.530"> </span>
<a href="#l33.531"></a><span id="l33.531">   var viewLayoutMenu = document.getElementById(&quot;menu_MessagePaneLayout&quot;);</span>
<a href="#l33.532"></a><span id="l33.532">   if (viewLayoutMenu)</span>
<a href="#l33.533"></a><span id="l33.533">     viewLayoutMenu.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.534"></a><span id="l33.534"> </span>
<a href="#l33.535"></a><span id="l33.535">   viewLayoutMenu = document.getElementById(&quot;appmenu_MessagePaneLayout&quot;);</span>
<a href="#l33.536"></a><span id="l33.536" class="difflineat">@@ -610,217 +586,211 @@ function HideMenus()</span>
<a href="#l33.537"></a><span id="l33.537">   var viewFolderMenu = document.getElementById(&quot;menu_FolderViews&quot;);</span>
<a href="#l33.538"></a><span id="l33.538">   if (viewFolderMenu)</span>
<a href="#l33.539"></a><span id="l33.539">     viewFolderMenu.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.540"></a><span id="l33.540"> </span>
<a href="#l33.541"></a><span id="l33.541">   viewFolderMenu = document.getElementById(&quot;appmenu_FolderViews&quot;);</span>
<a href="#l33.542"></a><span id="l33.542">   if (viewFolderMenu)</span>
<a href="#l33.543"></a><span id="l33.543">     viewFolderMenu.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.544"></a><span id="l33.544"> </span>
<a href="#l33.545"></a><span id="l33.545" class="difflineminus">-  var viewMessagesMenu = document.getElementById('viewMessagesMenu');</span>
<a href="#l33.546"></a><span id="l33.546" class="difflineplus">+  var viewMessagesMenu = document.getElementById(&quot;viewMessagesMenu&quot;);</span>
<a href="#l33.547"></a><span id="l33.547">   if (viewMessagesMenu)</span>
<a href="#l33.548"></a><span id="l33.548">     viewMessagesMenu.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.549"></a><span id="l33.549"> </span>
<a href="#l33.550"></a><span id="l33.550" class="difflineminus">-  viewMessagesMenu = document.getElementById('appmenu_viewMessagesMenu');</span>
<a href="#l33.551"></a><span id="l33.551" class="difflineplus">+  viewMessagesMenu = document.getElementById(&quot;appmenu_viewMessagesMenu&quot;);</span>
<a href="#l33.552"></a><span id="l33.552">   if (viewMessagesMenu)</span>
<a href="#l33.553"></a><span id="l33.553">     viewMessagesMenu.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.554"></a><span id="l33.554"> </span>
<a href="#l33.555"></a><span id="l33.555" class="difflineminus">-  var viewMessageViewMenu = document.getElementById('viewMessageViewMenu');</span>
<a href="#l33.556"></a><span id="l33.556" class="difflineplus">+  var viewMessageViewMenu = document.getElementById(&quot;viewMessageViewMenu&quot;);</span>
<a href="#l33.557"></a><span id="l33.557">   if (viewMessageViewMenu)</span>
<a href="#l33.558"></a><span id="l33.558">     viewMessageViewMenu.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.559"></a><span id="l33.559"> </span>
<a href="#l33.560"></a><span id="l33.560" class="difflineminus">-  viewMessageViewMenu = document.getElementById('appmenu_viewMessageViewMenu');</span>
<a href="#l33.561"></a><span id="l33.561" class="difflineplus">+  viewMessageViewMenu = document.getElementById(&quot;appmenu_viewMessageViewMenu&quot;);</span>
<a href="#l33.562"></a><span id="l33.562">   if (viewMessageViewMenu)</span>
<a href="#l33.563"></a><span id="l33.563">     viewMessageViewMenu.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.564"></a><span id="l33.564"> </span>
<a href="#l33.565"></a><span id="l33.565" class="difflineminus">-  var viewMessagesMenuSeparator = document.getElementById('viewMessagesMenuSeparator');</span>
<a href="#l33.566"></a><span id="l33.566" class="difflineplus">+  var viewMessagesMenuSeparator = document.getElementById(&quot;viewMessagesMenuSeparator&quot;);</span>
<a href="#l33.567"></a><span id="l33.567">   if (viewMessagesMenuSeparator)</span>
<a href="#l33.568"></a><span id="l33.568">     viewMessagesMenuSeparator.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.569"></a><span id="l33.569"> </span>
<a href="#l33.570"></a><span id="l33.570" class="difflineminus">-  viewMessagesMenuSeparator = document.getElementById('appmenu_viewMessagesMenuSeparator');</span>
<a href="#l33.571"></a><span id="l33.571" class="difflineplus">+  viewMessagesMenuSeparator = document.getElementById(&quot;appmenu_viewMessagesMenuSeparator&quot;);</span>
<a href="#l33.572"></a><span id="l33.572">   if (viewMessagesMenuSeparator)</span>
<a href="#l33.573"></a><span id="l33.573">     viewMessagesMenuSeparator.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.574"></a><span id="l33.574"> </span>
<a href="#l33.575"></a><span id="l33.575" class="difflineminus">-  var openMessageMenu = document.getElementById('openMessageWindowMenuitem');</span>
<a href="#l33.576"></a><span id="l33.576" class="difflineplus">+  var openMessageMenu = document.getElementById(&quot;openMessageWindowMenuitem&quot;);</span>
<a href="#l33.577"></a><span id="l33.577">   if (openMessageMenu)</span>
<a href="#l33.578"></a><span id="l33.578">     openMessageMenu.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.579"></a><span id="l33.579"> </span>
<a href="#l33.580"></a><span id="l33.580" class="difflineminus">-  openMessageMenu = document.getElementById('appmenu_openMessageWindowMenuitem');</span>
<a href="#l33.581"></a><span id="l33.581" class="difflineplus">+  openMessageMenu = document.getElementById(&quot;appmenu_openMessageWindowMenuitem&quot;);</span>
<a href="#l33.582"></a><span id="l33.582">   if (openMessageMenu)</span>
<a href="#l33.583"></a><span id="l33.583">     openMessageMenu.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.584"></a><span id="l33.584"> </span>
<a href="#l33.585"></a><span id="l33.585" class="difflineminus">-  var viewSortMenuSeparator = document.getElementById('viewSortMenuSeparator');</span>
<a href="#l33.586"></a><span id="l33.586" class="difflineplus">+  var viewSortMenuSeparator = document.getElementById(&quot;viewSortMenuSeparator&quot;);</span>
<a href="#l33.587"></a><span id="l33.587">   if (viewSortMenuSeparator)</span>
<a href="#l33.588"></a><span id="l33.588">     viewSortMenuSeparator.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.589"></a><span id="l33.589"> </span>
<a href="#l33.590"></a><span id="l33.590" class="difflineminus">-  viewSortMenuSeparator = document.getElementById('appmenu_viewAfterThreadsSeparator');</span>
<a href="#l33.591"></a><span id="l33.591" class="difflineplus">+  viewSortMenuSeparator = document.getElementById(&quot;appmenu_viewAfterThreadsSeparator&quot;);</span>
<a href="#l33.592"></a><span id="l33.592">   if (viewSortMenuSeparator)</span>
<a href="#l33.593"></a><span id="l33.593">     viewSortMenuSeparator.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.594"></a><span id="l33.594"> </span>
<a href="#l33.595"></a><span id="l33.595" class="difflineminus">-  var viewSortMenu = document.getElementById('viewSortMenu');</span>
<a href="#l33.596"></a><span id="l33.596" class="difflineplus">+  var viewSortMenu = document.getElementById(&quot;viewSortMenu&quot;);</span>
<a href="#l33.597"></a><span id="l33.597">   if (viewSortMenu)</span>
<a href="#l33.598"></a><span id="l33.598">     viewSortMenu.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.599"></a><span id="l33.599"> </span>
<a href="#l33.600"></a><span id="l33.600" class="difflineminus">-  viewSortMenu = document.getElementById('appmenu_viewSortMenu');</span>
<a href="#l33.601"></a><span id="l33.601" class="difflineplus">+  viewSortMenu = document.getElementById(&quot;appmenu_viewSortMenu&quot;);</span>
<a href="#l33.602"></a><span id="l33.602">   if (viewSortMenu)</span>
<a href="#l33.603"></a><span id="l33.603">     viewSortMenu.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.604"></a><span id="l33.604"> </span>
<a href="#l33.605"></a><span id="l33.605" class="difflineminus">-  var emptryTrashMenu = document.getElementById('menu_emptyTrash');</span>
<a href="#l33.606"></a><span id="l33.606" class="difflineplus">+  var emptryTrashMenu = document.getElementById(&quot;menu_emptyTrash&quot;);</span>
<a href="#l33.607"></a><span id="l33.607">   if (emptryTrashMenu)</span>
<a href="#l33.608"></a><span id="l33.608">     emptryTrashMenu.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.609"></a><span id="l33.609"> </span>
<a href="#l33.610"></a><span id="l33.610" class="difflineminus">-  emptryTrashMenu = document.getElementById('appmenu_emptyTrash');</span>
<a href="#l33.611"></a><span id="l33.611" class="difflineplus">+  emptryTrashMenu = document.getElementById(&quot;appmenu_emptyTrash&quot;);</span>
<a href="#l33.612"></a><span id="l33.612">   if (emptryTrashMenu)</span>
<a href="#l33.613"></a><span id="l33.613">     emptryTrashMenu.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.614"></a><span id="l33.614"> </span>
<a href="#l33.615"></a><span id="l33.615">   var menuPropertiesSeparator = document.getElementById(&quot;editPropertiesSeparator&quot;);</span>
<a href="#l33.616"></a><span id="l33.616">   if (menuPropertiesSeparator)</span>
<a href="#l33.617"></a><span id="l33.617">     menuPropertiesSeparator.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.618"></a><span id="l33.618"> </span>
<a href="#l33.619"></a><span id="l33.619">   menuPropertiesSeparator = document.getElementById(&quot;appmenu_editPropertiesSeparator&quot;);</span>
<a href="#l33.620"></a><span id="l33.620">   if (menuPropertiesSeparator)</span>
<a href="#l33.621"></a><span id="l33.621">     menuPropertiesSeparator.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.622"></a><span id="l33.622"> </span>
<a href="#l33.623"></a><span id="l33.623" class="difflineminus">-  var menuProperties = document.getElementById('menu_properties');</span>
<a href="#l33.624"></a><span id="l33.624" class="difflineplus">+  var menuProperties = document.getElementById(&quot;menu_properties&quot;);</span>
<a href="#l33.625"></a><span id="l33.625">   if (menuProperties)</span>
<a href="#l33.626"></a><span id="l33.626">     menuProperties.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.627"></a><span id="l33.627"> </span>
<a href="#l33.628"></a><span id="l33.628" class="difflineminus">-  menuProperties = document.getElementById('appmenu_properties');</span>
<a href="#l33.629"></a><span id="l33.629" class="difflineplus">+  menuProperties = document.getElementById(&quot;appmenu_properties&quot;);</span>
<a href="#l33.630"></a><span id="l33.630">   if (menuProperties)</span>
<a href="#l33.631"></a><span id="l33.631">     menuProperties.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.632"></a><span id="l33.632"> </span>
<a href="#l33.633"></a><span id="l33.633" class="difflineminus">-  var favoriteFolder = document.getElementById('menu_favoriteFolder');</span>
<a href="#l33.634"></a><span id="l33.634" class="difflineminus">-  if (favoriteFolder)</span>
<a href="#l33.635"></a><span id="l33.635" class="difflineminus">-  {</span>
<a href="#l33.636"></a><span id="l33.636" class="difflineplus">+  var favoriteFolder = document.getElementById(&quot;menu_favoriteFolder&quot;);</span>
<a href="#l33.637"></a><span id="l33.637" class="difflineplus">+  if (favoriteFolder) {</span>
<a href="#l33.638"></a><span id="l33.638">     favoriteFolder.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l33.639"></a><span id="l33.639">     favoriteFolder.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.640"></a><span id="l33.640">   }</span>
<a href="#l33.641"></a><span id="l33.641"> </span>
<a href="#l33.642"></a><span id="l33.642" class="difflineminus">-  favoriteFolder = document.getElementById('appmenu_favoriteFolder');</span>
<a href="#l33.643"></a><span id="l33.643" class="difflineplus">+  favoriteFolder = document.getElementById(&quot;appmenu_favoriteFolder&quot;);</span>
<a href="#l33.644"></a><span id="l33.644">   if (favoriteFolder) {</span>
<a href="#l33.645"></a><span id="l33.645">     favoriteFolder.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l33.646"></a><span id="l33.646">     favoriteFolder.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.647"></a><span id="l33.647">   }</span>
<a href="#l33.648"></a><span id="l33.648"> </span>
<a href="#l33.649"></a><span id="l33.649" class="difflineminus">-  var compactFolderMenu = document.getElementById('menu_compactFolder');</span>
<a href="#l33.650"></a><span id="l33.650" class="difflineplus">+  var compactFolderMenu = document.getElementById(&quot;menu_compactFolder&quot;);</span>
<a href="#l33.651"></a><span id="l33.651">   if (compactFolderMenu)</span>
<a href="#l33.652"></a><span id="l33.652">     compactFolderMenu.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.653"></a><span id="l33.653"> </span>
<a href="#l33.654"></a><span id="l33.654" class="difflineminus">-  compactFolderMenu = document.getElementById('appmenu_compactFolder');</span>
<a href="#l33.655"></a><span id="l33.655" class="difflineplus">+  compactFolderMenu = document.getElementById(&quot;appmenu_compactFolder&quot;);</span>
<a href="#l33.656"></a><span id="l33.656">   if (compactFolderMenu)</span>
<a href="#l33.657"></a><span id="l33.657">     compactFolderMenu.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.658"></a><span id="l33.658"> </span>
<a href="#l33.659"></a><span id="l33.659" class="difflineminus">-  var trashSeparator = document.getElementById('trashMenuSeparator');</span>
<a href="#l33.660"></a><span id="l33.660" class="difflineplus">+  var trashSeparator = document.getElementById(&quot;trashMenuSeparator&quot;);</span>
<a href="#l33.661"></a><span id="l33.661">   if (trashSeparator)</span>
<a href="#l33.662"></a><span id="l33.662">     trashSeparator.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.663"></a><span id="l33.663"> </span>
<a href="#l33.664"></a><span id="l33.664" class="difflineminus">-  let fileMenuAfterRenameSeparator = document.getElementById('appmenu_fileMenuAfterRenameSeparator');</span>
<a href="#l33.665"></a><span id="l33.665" class="difflineplus">+  let fileMenuAfterRenameSeparator = document.getElementById(&quot;appmenu_fileMenuAfterRenameSeparator&quot;);</span>
<a href="#l33.666"></a><span id="l33.666">   if (fileMenuAfterRenameSeparator)</span>
<a href="#l33.667"></a><span id="l33.667">     fileMenuAfterRenameSeparator.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.668"></a><span id="l33.668"> </span>
<a href="#l33.669"></a><span id="l33.669" class="difflineminus">-  let fileMenuAfterCompactSeparator = document.getElementById('appmenu_fileMenuAfterCompactSeparator');</span>
<a href="#l33.670"></a><span id="l33.670" class="difflineplus">+  let fileMenuAfterCompactSeparator = document.getElementById(&quot;appmenu_fileMenuAfterCompactSeparator&quot;);</span>
<a href="#l33.671"></a><span id="l33.671">   if (fileMenuAfterCompactSeparator)</span>
<a href="#l33.672"></a><span id="l33.672">     fileMenuAfterCompactSeparator.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.673"></a><span id="l33.673"> </span>
<a href="#l33.674"></a><span id="l33.674" class="difflineminus">-  var goStartPageSeparator = document.getElementById('goNextSeparator');</span>
<a href="#l33.675"></a><span id="l33.675" class="difflineplus">+  var goStartPageSeparator = document.getElementById(&quot;goNextSeparator&quot;);</span>
<a href="#l33.676"></a><span id="l33.676">   if (goStartPageSeparator)</span>
<a href="#l33.677"></a><span id="l33.677">     goStartPageSeparator.hidden = true;</span>
<a href="#l33.678"></a><span id="l33.678"> </span>
<a href="#l33.679"></a><span id="l33.679" class="difflineminus">-  goStartPageSeparator = document.getElementById('appmenu_goNextSeparator');</span>
<a href="#l33.680"></a><span id="l33.680" class="difflineplus">+  goStartPageSeparator = document.getElementById(&quot;appmenu_goNextSeparator&quot;);</span>
<a href="#l33.681"></a><span id="l33.681">   if (goStartPageSeparator)</span>
<a href="#l33.682"></a><span id="l33.682">     goStartPageSeparator.hidden = true;</span>
<a href="#l33.683"></a><span id="l33.683"> </span>
<a href="#l33.684"></a><span id="l33.684" class="difflineminus">-  let goRecentlyClosedTabsSeparator = document.getElementById('goRecentlyClosedTabsSeparator');</span>
<a href="#l33.685"></a><span id="l33.685" class="difflineplus">+  let goRecentlyClosedTabsSeparator = document.getElementById(&quot;goRecentlyClosedTabsSeparator&quot;);</span>
<a href="#l33.686"></a><span id="l33.686">   if (goRecentlyClosedTabsSeparator)</span>
<a href="#l33.687"></a><span id="l33.687">     goRecentlyClosedTabsSeparator.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.688"></a><span id="l33.688"> </span>
<a href="#l33.689"></a><span id="l33.689" class="difflineminus">-  goRecentlyClosedTabsSeparator = document.getElementById('appmenu_goRecentlyClosedTabsSeparator');</span>
<a href="#l33.690"></a><span id="l33.690" class="difflineplus">+  goRecentlyClosedTabsSeparator = document.getElementById(&quot;appmenu_goRecentlyClosedTabsSeparator&quot;);</span>
<a href="#l33.691"></a><span id="l33.691">   if (goRecentlyClosedTabsSeparator)</span>
<a href="#l33.692"></a><span id="l33.692">     goRecentlyClosedTabsSeparator.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l33.693"></a><span id="l33.693"> </span>
<a href="#l33.694"></a><span id="l33.694" class="difflineminus">-  let goFolder = document.getElementById('goFolderMenu');</span>
<a href="#l33.695"></a><span id="l33.695" class="difflineplus">+  let goFolder = document.getElementById(&quot;goFolderMenu&quot;);</span>
<a href="#l33.696"></a><span id="l33.696">   if (goFolder)</span>
<a href="#l33.697"></a><span id="l33.697">     goFolder.hidden = true;</span>
<a href="#l33.698"></a><span id="l33.698"> </span>
<a href="#l33.699"></a><span id="l33.699" class="difflineminus">-  goFolder = document.getElementById('appmenu_goFolderMenu');</span>
<a href="#l33.700"></a><span id="l33.700" class="difflineplus">+  goFolder = document.getElementById(&quot;appmenu_goFolderMenu&quot;);</span>
<a href="#l33.701"></a><span id="l33.701">   if (goFolder)</span>
<a href="#l33.702"></a><span id="l33.702">     goFolder.hidden = true;</span>
<a href="#l33.703"></a><span id="l33.703"> </span>
<a href="#l33.704"></a><span id="l33.704">   goFolder = document.getElementById(&quot;goFolderSeparator&quot;);</span>
<a href="#l33.705"></a><span id="l33.705">   if (goFolder)</span>
<a href="#l33.706"></a><span id="l33.706">     goFolder.hidden = true;</span>
<a href="#l33.707"></a><span id="l33.707"> </span>
<a href="#l33.708"></a><span id="l33.708">   goFolder = document.getElementById(&quot;appmenu_goFolderSeparator&quot;);</span>
<a href="#l33.709"></a><span id="l33.709">   if (goFolder)</span>
<a href="#l33.710"></a><span id="l33.710">     goFolder.hidden = true;</span>
<a href="#l33.711"></a><span id="l33.711"> </span>
<a href="#l33.712"></a><span id="l33.712" class="difflineminus">-  var goStartPage = document.getElementById('goStartPage');</span>
<a href="#l33.713"></a><span id="l33.713" class="difflineplus">+  var goStartPage = document.getElementById(&quot;goStartPage&quot;);</span>
<a href="#l33.714"></a><span id="l33.714">   if (goStartPage)</span>
<a href="#l33.715"></a><span id="l33.715">    goStartPage.hidden = true;</span>
<a href="#l33.716"></a><span id="l33.716"> </span>
<a href="#l33.717"></a><span id="l33.717" class="difflineminus">-  goStartPage = document.getElementById('appmenu_goStartPage');</span>
<a href="#l33.718"></a><span id="l33.718" class="difflineplus">+  goStartPage = document.getElementById(&quot;appmenu_goStartPage&quot;);</span>
<a href="#l33.719"></a><span id="l33.719">   if (goStartPage)</span>
<a href="#l33.720"></a><span id="l33.720">    goStartPage.hidden = true;</span>
<a href="#l33.721"></a><span id="l33.721"> </span>
<a href="#l33.722"></a><span id="l33.722" class="difflineminus">-  let quickFilterBar = document.getElementById('appmenu_quickFilterBar');</span>
<a href="#l33.723"></a><span id="l33.723" class="difflineplus">+  let quickFilterBar = document.getElementById(&quot;appmenu_quickFilterBar&quot;);</span>
<a href="#l33.724"></a><span id="l33.724">   if (quickFilterBar)</span>
<a href="#l33.725"></a><span id="l33.725">    quickFilterBar.hidden = true;</span>
<a href="#l33.726"></a><span id="l33.726"> </span>
<a href="#l33.727"></a><span id="l33.727" class="difflineminus">-  var menuFileClose = document.getElementById('menu_close');</span>
<a href="#l33.728"></a><span id="l33.728" class="difflineminus">-  var menuFileQuit = document.getElementById('menu_FileQuitItem');</span>
<a href="#l33.729"></a><span id="l33.729" class="difflineplus">+  var menuFileClose = document.getElementById(&quot;menu_close&quot;);</span>
<a href="#l33.730"></a><span id="l33.730" class="difflineplus">+  var menuFileQuit = document.getElementById(&quot;menu_FileQuitItem&quot;);</span>
<a href="#l33.731"></a><span id="l33.731">   if (menuFileClose &amp;&amp; menuFileQuit)</span>
<a href="#l33.732"></a><span id="l33.732">     menuFileQuit.parentNode.replaceChild(menuFileClose, menuFileQuit);</span>
<a href="#l33.733"></a><span id="l33.733"> }</span>
<a href="#l33.734"></a><span id="l33.734" class="difflineplus">+/* eslint-enable complexity */</span>
<a href="#l33.735"></a><span id="l33.735"> </span>
<a href="#l33.736"></a><span id="l33.736" class="difflineminus">-function OnUnloadMessageWindow()</span>
<a href="#l33.737"></a><span id="l33.737" class="difflineminus">-{</span>
<a href="#l33.738"></a><span id="l33.738" class="difflineplus">+function OnUnloadMessageWindow() {</span>
<a href="#l33.739"></a><span id="l33.739">   if (gFolderDisplay._magicTreeSelection) {</span>
<a href="#l33.740"></a><span id="l33.740">     // Avoid cycle leaks.</span>
<a href="#l33.741"></a><span id="l33.741">     gFolderDisplay._magicTreeSelection.tree = null;</span>
<a href="#l33.742"></a><span id="l33.742">     gFolderDisplay._magicTreeSelection.view = null;</span>
<a href="#l33.743"></a><span id="l33.743">     gFolderDisplay._magicTreeSelection = null;</span>
<a href="#l33.744"></a><span id="l33.744">   }</span>
<a href="#l33.745"></a><span id="l33.745">   gFolderDisplay.close();</span>
<a href="#l33.746"></a><span id="l33.746">   UnloadCommandUpdateHandlers();</span>
<a href="#l33.747"></a><span id="l33.747">   // FIX ME - later we will be able to use onunload from the overlay</span>
<a href="#l33.748"></a><span id="l33.748">   OnUnloadMsgHeaderPane();</span>
<a href="#l33.749"></a><span id="l33.749">   gPhishingDetector.shutdown();</span>
<a href="#l33.750"></a><span id="l33.750">   ToolbarIconColor.uninit();</span>
<a href="#l33.751"></a><span id="l33.751">   OnMailWindowUnload();</span>
<a href="#l33.752"></a><span id="l33.752"> }</span>
<a href="#l33.753"></a><span id="l33.753"> </span>
<a href="#l33.754"></a><span id="l33.754" class="difflineminus">-function GetSelectedMsgFolders()</span>
<a href="#l33.755"></a><span id="l33.755" class="difflineminus">-{</span>
<a href="#l33.756"></a><span id="l33.756" class="difflineplus">+function GetSelectedMsgFolders() {</span>
<a href="#l33.757"></a><span id="l33.757">   if (gFolderDisplay.displayedFolder)</span>
<a href="#l33.758"></a><span id="l33.758">     return [gFolderDisplay.displayedFolder];</span>
<a href="#l33.759"></a><span id="l33.759">   return [];</span>
<a href="#l33.760"></a><span id="l33.760"> }</span>
<a href="#l33.761"></a><span id="l33.761"> </span>
<a href="#l33.762"></a><span id="l33.762" class="difflineminus">-function GetNumSelectedMessages()</span>
<a href="#l33.763"></a><span id="l33.763" class="difflineminus">-{</span>
<a href="#l33.764"></a><span id="l33.764" class="difflineplus">+function GetNumSelectedMessages() {</span>
<a href="#l33.765"></a><span id="l33.765">   return gFolderDisplay.selectedCount;</span>
<a href="#l33.766"></a><span id="l33.766"> }</span>
<a href="#l33.767"></a><span id="l33.767"> </span>
<a href="#l33.768"></a><span id="l33.768" class="difflineminus">-function ReloadMessage()</span>
<a href="#l33.769"></a><span id="l33.769" class="difflineminus">-{</span>
<a href="#l33.770"></a><span id="l33.770" class="difflineplus">+function ReloadMessage() {</span>
<a href="#l33.771"></a><span id="l33.771">   // If the current message was loaded from a file or attachment, so the dbView</span>
<a href="#l33.772"></a><span id="l33.772">   // can't handle reloading it. Let's do it ourselves, instead.</span>
<a href="#l33.773"></a><span id="l33.773">   if (window.arguments[0] instanceof Ci.nsIURI)</span>
<a href="#l33.774"></a><span id="l33.774">     gMessageDisplay.displayExternalMessage(window.arguments[0].spec);</span>
<a href="#l33.775"></a><span id="l33.775">   else</span>
<a href="#l33.776"></a><span id="l33.776">     gFolderDisplay.view.dbView.reloadMessage();</span>
<a href="#l33.777"></a><span id="l33.777"> }</span>
<a href="#l33.778"></a><span id="l33.778"> </span>
<a href="#l33.779"></a><span id="l33.779"> // MessageWindowController object (handles commands when one of the trees does not have focus)</span>
<a href="#l33.780"></a><span id="l33.780" class="difflineminus">-var MessageWindowController =</span>
<a href="#l33.781"></a><span id="l33.781" class="difflineminus">-{</span>
<a href="#l33.782"></a><span id="l33.782" class="difflineminus">-  supportsCommand: function(command)</span>
<a href="#l33.783"></a><span id="l33.783" class="difflineminus">-  {</span>
<a href="#l33.784"></a><span id="l33.784" class="difflineminus">-    switch ( command )</span>
<a href="#l33.785"></a><span id="l33.785" class="difflineminus">-    {</span>
<a href="#l33.786"></a><span id="l33.786" class="difflineplus">+var MessageWindowController = {</span>
<a href="#l33.787"></a><span id="l33.787" class="difflineplus">+  /* eslint-disable complexity */</span>
<a href="#l33.788"></a><span id="l33.788" class="difflineplus">+  supportsCommand(command) {</span>
<a href="#l33.789"></a><span id="l33.789" class="difflineplus">+    switch (command) {</span>
<a href="#l33.790"></a><span id="l33.790">       // external messages cannot be deleted, mutated, or subjected to filtering</span>
<a href="#l33.791"></a><span id="l33.791">       case &quot;cmd_delete&quot;:</span>
<a href="#l33.792"></a><span id="l33.792">       case &quot;cmd_killThread&quot;:</span>
<a href="#l33.793"></a><span id="l33.793">       case &quot;cmd_killSubthread&quot;:</span>
<a href="#l33.794"></a><span id="l33.794">       case &quot;cmd_watchThread&quot;:</span>
<a href="#l33.795"></a><span id="l33.795">       case &quot;button_delete&quot;:</span>
<a href="#l33.796"></a><span id="l33.796">       case &quot;button_junk&quot;:</span>
<a href="#l33.797"></a><span id="l33.797">       case &quot;cmd_shiftDelete&quot;:</span>
<a href="#l33.798"></a><span id="l33.798" class="difflineat">@@ -926,21 +896,19 @@ var MessageWindowController =</span>
<a href="#l33.799"></a><span id="l33.799">       case &quot;cmd_downloadFlagged&quot;:</span>
<a href="#l33.800"></a><span id="l33.800">       case &quot;cmd_downloadSelected&quot;:</span>
<a href="#l33.801"></a><span id="l33.801">         return MailOfflineMgr.isOnline();</span>
<a href="#l33.802"></a><span id="l33.802">       default:</span>
<a href="#l33.803"></a><span id="l33.803">         return false;</span>
<a href="#l33.804"></a><span id="l33.804">     }</span>
<a href="#l33.805"></a><span id="l33.805">   },</span>
<a href="#l33.806"></a><span id="l33.806"> </span>
<a href="#l33.807"></a><span id="l33.807" class="difflineminus">-  isCommandEnabled: function(command)</span>
<a href="#l33.808"></a><span id="l33.808" class="difflineminus">-  {</span>
<a href="#l33.809"></a><span id="l33.809" class="difflineplus">+  isCommandEnabled(command) {</span>
<a href="#l33.810"></a><span id="l33.810">     let loadedFolder;</span>
<a href="#l33.811"></a><span id="l33.811" class="difflineminus">-    switch ( command )</span>
<a href="#l33.812"></a><span id="l33.812" class="difflineminus">-    {</span>
<a href="#l33.813"></a><span id="l33.813" class="difflineplus">+    switch (command) {</span>
<a href="#l33.814"></a><span id="l33.814">       case &quot;cmd_createFilterFromPopup&quot;:</span>
<a href="#l33.815"></a><span id="l33.815">       case &quot;cmd_createFilterFromMenu&quot;:</span>
<a href="#l33.816"></a><span id="l33.816">         loadedFolder = gFolderDisplay.displayedFolder;</span>
<a href="#l33.817"></a><span id="l33.817">         if (!(loadedFolder &amp;&amp; loadedFolder.server.canHaveFilters))</span>
<a href="#l33.818"></a><span id="l33.818">           return false;</span>
<a href="#l33.819"></a><span id="l33.819">       case &quot;cmd_delete&quot;:</span>
<a href="#l33.820"></a><span id="l33.820">         UpdateDeleteCommand();</span>
<a href="#l33.821"></a><span id="l33.821">         // fall through</span>
<a href="#l33.822"></a><span id="l33.822" class="difflineat">@@ -1086,40 +1054,36 @@ var MessageWindowController =</span>
<a href="#l33.823"></a><span id="l33.823">         return false;</span>
<a href="#l33.824"></a><span id="l33.824">       case &quot;cmd_chat&quot;:</span>
<a href="#l33.825"></a><span id="l33.825">         return true;</span>
<a href="#l33.826"></a><span id="l33.826">       default:</span>
<a href="#l33.827"></a><span id="l33.827">         return false;</span>
<a href="#l33.828"></a><span id="l33.828">     }</span>
<a href="#l33.829"></a><span id="l33.829">   },</span>
<a href="#l33.830"></a><span id="l33.830"> </span>
<a href="#l33.831"></a><span id="l33.831" class="difflineminus">-  doCommand: function(command)</span>
<a href="#l33.832"></a><span id="l33.832" class="difflineminus">-  {</span>
<a href="#l33.833"></a><span id="l33.833" class="difflineplus">+  doCommand(command) {</span>
<a href="#l33.834"></a><span id="l33.834">     // If the user invoked a key short cut then it is possible that we got here</span>
<a href="#l33.835"></a><span id="l33.835">     // for a command which is really disabled. Kick out if the command should be disabled.</span>
<a href="#l33.836"></a><span id="l33.836">     if (!this.isCommandEnabled(command))</span>
<a href="#l33.837"></a><span id="l33.837">       return;</span>
<a href="#l33.838"></a><span id="l33.838"> </span>
<a href="#l33.839"></a><span id="l33.839" class="difflineminus">-    var navigationType = nsMsgNavigationType.nextUnreadMessage;</span>
<a href="#l33.840"></a><span id="l33.840" class="difflineminus">-</span>
<a href="#l33.841"></a><span id="l33.841" class="difflineminus">-    switch (command)</span>
<a href="#l33.842"></a><span id="l33.842" class="difflineminus">-    {</span>
<a href="#l33.843"></a><span id="l33.843" class="difflineminus">-    case &quot;cmd_getNewMessages&quot;:</span>
<a href="#l33.844"></a><span id="l33.844" class="difflineminus">-      MsgGetMessage();</span>
<a href="#l33.845"></a><span id="l33.845" class="difflineminus">-      break;</span>
<a href="#l33.846"></a><span id="l33.846" class="difflineminus">-        case &quot;cmd_undo&quot;:</span>
<a href="#l33.847"></a><span id="l33.847" class="difflineminus">-            messenger.undo(msgWindow);</span>
<a href="#l33.848"></a><span id="l33.848" class="difflineminus">-            break;</span>
<a href="#l33.849"></a><span id="l33.849" class="difflineminus">-        case &quot;cmd_redo&quot;:</span>
<a href="#l33.850"></a><span id="l33.850" class="difflineminus">-            messenger.redo(msgWindow);</span>
<a href="#l33.851"></a><span id="l33.851" class="difflineminus">-            break;</span>
<a href="#l33.852"></a><span id="l33.852" class="difflineminus">-        case &quot;cmd_getMsgsForAuthAccounts&quot;:</span>
<a href="#l33.853"></a><span id="l33.853" class="difflineminus">-          MsgGetMessagesForAllAuthenticatedAccounts();</span>
<a href="#l33.854"></a><span id="l33.854" class="difflineminus">-          break;</span>
<a href="#l33.855"></a><span id="l33.855" class="difflineminus">-        case &quot;cmd_getNextNMessages&quot;:</span>
<a href="#l33.856"></a><span id="l33.856" class="difflineplus">+    switch (command) {</span>
<a href="#l33.857"></a><span id="l33.857" class="difflineplus">+      case &quot;cmd_getNewMessages&quot;:</span>
<a href="#l33.858"></a><span id="l33.858" class="difflineplus">+        MsgGetMessage();</span>
<a href="#l33.859"></a><span id="l33.859" class="difflineplus">+        break;</span>
<a href="#l33.860"></a><span id="l33.860" class="difflineplus">+      case &quot;cmd_undo&quot;:</span>
<a href="#l33.861"></a><span id="l33.861" class="difflineplus">+        messenger.undo(msgWindow);</span>
<a href="#l33.862"></a><span id="l33.862" class="difflineplus">+        break;</span>
<a href="#l33.863"></a><span id="l33.863" class="difflineplus">+      case &quot;cmd_redo&quot;:</span>
<a href="#l33.864"></a><span id="l33.864" class="difflineplus">+        messenger.redo(msgWindow);</span>
<a href="#l33.865"></a><span id="l33.865" class="difflineplus">+        break;</span>
<a href="#l33.866"></a><span id="l33.866" class="difflineplus">+      case &quot;cmd_getMsgsForAuthAccounts&quot;:</span>
<a href="#l33.867"></a><span id="l33.867" class="difflineplus">+        MsgGetMessagesForAllAuthenticatedAccounts();</span>
<a href="#l33.868"></a><span id="l33.868" class="difflineplus">+        break;</span>
<a href="#l33.869"></a><span id="l33.869" class="difflineplus">+      case &quot;cmd_getNextNMessages&quot;:</span>
<a href="#l33.870"></a><span id="l33.870">         MsgGetNextNMessages();</span>
<a href="#l33.871"></a><span id="l33.871">         break;</span>
<a href="#l33.872"></a><span id="l33.872">       case &quot;cmd_archive&quot;:</span>
<a href="#l33.873"></a><span id="l33.873">         MsgArchiveSelectedMessages(null);</span>
<a href="#l33.874"></a><span id="l33.874">         break;</span>
<a href="#l33.875"></a><span id="l33.875">       case &quot;cmd_newMessage&quot;:</span>
<a href="#l33.876"></a><span id="l33.876">         MsgNewMessage(null);</span>
<a href="#l33.877"></a><span id="l33.877">         break;</span>
<a href="#l33.878"></a><span id="l33.878" class="difflineat">@@ -1205,20 +1169,20 @@ var MessageWindowController =</span>
<a href="#l33.879"></a><span id="l33.879">         break;</span>
<a href="#l33.880"></a><span id="l33.880">       case &quot;cmd_reload&quot;:</span>
<a href="#l33.881"></a><span id="l33.881">         ReloadMessage();</span>
<a href="#l33.882"></a><span id="l33.882">         break;</span>
<a href="#l33.883"></a><span id="l33.883">       case &quot;cmd_find&quot;:</span>
<a href="#l33.884"></a><span id="l33.884">         document.getElementById(&quot;FindToolbar&quot;).onFindCommand();</span>
<a href="#l33.885"></a><span id="l33.885">         break;</span>
<a href="#l33.886"></a><span id="l33.886">       case &quot;cmd_findAgain&quot;:</span>
<a href="#l33.887"></a><span id="l33.887" class="difflineminus">-        document.getElementById(&quot;FindToolbar&quot;).onFindAgainCommand(false)</span>
<a href="#l33.888"></a><span id="l33.888" class="difflineplus">+        document.getElementById(&quot;FindToolbar&quot;).onFindAgainCommand(false);</span>
<a href="#l33.889"></a><span id="l33.889">         break;</span>
<a href="#l33.890"></a><span id="l33.890">       case &quot;cmd_findPrevious&quot;:</span>
<a href="#l33.891"></a><span id="l33.891" class="difflineminus">-        document.getElementById(&quot;FindToolbar&quot;).onFindAgainCommand(true)</span>
<a href="#l33.892"></a><span id="l33.892" class="difflineplus">+        document.getElementById(&quot;FindToolbar&quot;).onFindAgainCommand(true);</span>
<a href="#l33.893"></a><span id="l33.893">         break;</span>
<a href="#l33.894"></a><span id="l33.894">       case &quot;cmd_search&quot;:</span>
<a href="#l33.895"></a><span id="l33.895">         MsgSearchMessages();</span>
<a href="#l33.896"></a><span id="l33.896">         break;</span>
<a href="#l33.897"></a><span id="l33.897">       case &quot;cmd_addTag&quot;:</span>
<a href="#l33.898"></a><span id="l33.898">         AddTag();</span>
<a href="#l33.899"></a><span id="l33.899">         return;</span>
<a href="#l33.900"></a><span id="l33.900">       case &quot;cmd_manageTags&quot;:</span>
<a href="#l33.901"></a><span id="l33.901" class="difflineat">@@ -1342,59 +1306,53 @@ var MessageWindowController =</span>
<a href="#l33.902"></a><span id="l33.902">       case &quot;cmd_stop&quot;:</span>
<a href="#l33.903"></a><span id="l33.903">         msgWindow.StopUrls();</span>
<a href="#l33.904"></a><span id="l33.904">         break;</span>
<a href="#l33.905"></a><span id="l33.905">       case &quot;cmd_chat&quot;:</span>
<a href="#l33.906"></a><span id="l33.906">         let win = Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l33.907"></a><span id="l33.907">         if (win) {</span>
<a href="#l33.908"></a><span id="l33.908">           win.focus();</span>
<a href="#l33.909"></a><span id="l33.909">           win.showChatTab();</span>
<a href="#l33.910"></a><span id="l33.910" class="difflineminus">-        }</span>
<a href="#l33.911"></a><span id="l33.911" class="difflineminus">-        else {</span>
<a href="#l33.912"></a><span id="l33.912" class="difflineplus">+        } else {</span>
<a href="#l33.913"></a><span id="l33.913">           window.openDialog(&quot;chrome://messenger/content/&quot;, &quot;_blank&quot;,</span>
<a href="#l33.914"></a><span id="l33.914">                             &quot;chrome,extrachrome,menubar,resizable,scrollbars,status,toolbar&quot;,</span>
<a href="#l33.915"></a><span id="l33.915">                             null, {tabType: &quot;chat&quot;, tabParams: {}});</span>
<a href="#l33.916"></a><span id="l33.916">         }</span>
<a href="#l33.917"></a><span id="l33.917">         break;</span>
<a href="#l33.918"></a><span id="l33.918">       }</span>
<a href="#l33.919"></a><span id="l33.919">   },</span>
<a href="#l33.920"></a><span id="l33.920" class="difflineplus">+  /* eslint-enable complexity */</span>
<a href="#l33.921"></a><span id="l33.921"> </span>
<a href="#l33.922"></a><span id="l33.922" class="difflineminus">-  onEvent: function(event)</span>
<a href="#l33.923"></a><span id="l33.923" class="difflineminus">-  {</span>
<a href="#l33.924"></a><span id="l33.924" class="difflineminus">-  }</span>
<a href="#l33.925"></a><span id="l33.925" class="difflineplus">+  onEvent(event) {</span>
<a href="#l33.926"></a><span id="l33.926" class="difflineplus">+  },</span>
<a href="#l33.927"></a><span id="l33.927"> };</span>
<a href="#l33.928"></a><span id="l33.928"> </span>
<a href="#l33.929"></a><span id="l33.929" class="difflineminus">-function performNavigation(type)</span>
<a href="#l33.930"></a><span id="l33.930" class="difflineminus">-{</span>
<a href="#l33.931"></a><span id="l33.931" class="difflineplus">+function performNavigation(type) {</span>
<a href="#l33.932"></a><span id="l33.932">   // Try to load a message by navigation type if we can find</span>
<a href="#l33.933"></a><span id="l33.933">   // the message in the same folder.</span>
<a href="#l33.934"></a><span id="l33.934">   if (gFolderDisplay.navigate(type))</span>
<a href="#l33.935"></a><span id="l33.935">     return;</span>
<a href="#l33.936"></a><span id="l33.936"> </span>
<a href="#l33.937"></a><span id="l33.937">   CrossFolderNavigation(type);</span>
<a href="#l33.938"></a><span id="l33.938"> }</span>
<a href="#l33.939"></a><span id="l33.939"> </span>
<a href="#l33.940"></a><span id="l33.940" class="difflineminus">-function SetupCommandUpdateHandlers()</span>
<a href="#l33.941"></a><span id="l33.941" class="difflineminus">-{</span>
<a href="#l33.942"></a><span id="l33.942" class="difflineplus">+function SetupCommandUpdateHandlers() {</span>
<a href="#l33.943"></a><span id="l33.943">   top.controllers.insertControllerAt(0, MessageWindowController);</span>
<a href="#l33.944"></a><span id="l33.944"> }</span>
<a href="#l33.945"></a><span id="l33.945"> </span>
<a href="#l33.946"></a><span id="l33.946" class="difflineminus">-function UnloadCommandUpdateHandlers()</span>
<a href="#l33.947"></a><span id="l33.947" class="difflineminus">-{</span>
<a href="#l33.948"></a><span id="l33.948" class="difflineplus">+function UnloadCommandUpdateHandlers() {</span>
<a href="#l33.949"></a><span id="l33.949">   top.controllers.removeController(MessageWindowController);</span>
<a href="#l33.950"></a><span id="l33.950"> }</span>
<a href="#l33.951"></a><span id="l33.951"> </span>
<a href="#l33.952"></a><span id="l33.952" class="difflineminus">-function getMailToolbox ()</span>
<a href="#l33.953"></a><span id="l33.953" class="difflineminus">-{</span>
<a href="#l33.954"></a><span id="l33.954" class="difflineplus">+function getMailToolbox() {</span>
<a href="#l33.955"></a><span id="l33.955">   return document.getElementById(&quot;mail-toolbox&quot;);</span>
<a href="#l33.956"></a><span id="l33.956"> }</span>
<a href="#l33.957"></a><span id="l33.957"> </span>
<a href="#l33.958"></a><span id="l33.958" class="difflineminus">-function RestoreFocusAfterHdrButton()</span>
<a href="#l33.959"></a><span id="l33.959" class="difflineminus">-{</span>
<a href="#l33.960"></a><span id="l33.960" class="difflineplus">+function RestoreFocusAfterHdrButton() {</span>
<a href="#l33.961"></a><span id="l33.961">   // set focus to the message pane</span>
<a href="#l33.962"></a><span id="l33.962">   window.content.focus();</span>
<a href="#l33.963"></a><span id="l33.963"> }</span>
<a href="#l33.964"></a><span id="l33.964"> </span>
<a href="#l33.965"></a><span id="l33.965" class="difflineminus">-function SelectFolder (aFolderUri) {</span>
<a href="#l33.966"></a><span id="l33.966" class="difflineplus">+function SelectFolder(aFolderUri) {</span>
<a href="#l33.967"></a><span id="l33.967">   gFolderDisplay.clearSelection();</span>
<a href="#l33.968"></a><span id="l33.968">   gFolderDisplay.treeSelection.currentIndex = -1;</span>
<a href="#l33.969"></a><span id="l33.969">   gFolderDisplay.show(MailUtils.getFolderForURI(aFolderUri));</span>
<a href="#l33.970"></a><span id="l33.970"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mail/base/content/messageWindow.xul</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mail/base/content/messageWindow.xul</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -92,17 +92,16 @@</span>
<a href="#l34.4"></a><span id="l34.4">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/mailContextMenus.js&quot;/&gt;</span>
<a href="#l34.5"></a><span id="l34.5">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/phishingDetector.js&quot;/&gt;</span>
<a href="#l34.6"></a><span id="l34.6">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://communicator/content/contentAreaClick.js&quot;/&gt;</span>
<a href="#l34.7"></a><span id="l34.7">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://global/content/nsDragAndDrop.js&quot;/&gt;</span>
<a href="#l34.8"></a><span id="l34.8">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/msgViewNavigation.js&quot;/&gt;</span>
<a href="#l34.9"></a><span id="l34.9">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/editContactPanel.js&quot;/&gt;</span>
<a href="#l34.10"></a><span id="l34.10">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/toolbarIconColor.js&quot;/&gt;</span>
<a href="#l34.11"></a><span id="l34.11">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/msgHdrView.js&quot;/&gt;</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://global/content/nsDragAndDrop.js&quot;/&gt;</span>
<a href="#l34.13"></a><span id="l34.13">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger-smime/content/msgHdrViewSMIMEOverlay.js&quot;/&gt;</span>
<a href="#l34.14"></a><span id="l34.14">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger-smime/content/msgReadSMIMEOverlay.js&quot;/&gt;</span>
<a href="#l34.15"></a><span id="l34.15">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/mailCommands.js&quot;/&gt;</span>
<a href="#l34.16"></a><span id="l34.16">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/junkCommands.js&quot;/&gt;</span>
<a href="#l34.17"></a><span id="l34.17">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/mailWindowOverlay.js&quot;/&gt;</span>
<a href="#l34.18"></a><span id="l34.18">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/mailTabs.js&quot;/&gt;</span>
<a href="#l34.19"></a><span id="l34.19">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger-newsblog/content/newsblogOverlay.js&quot;/&gt;</span>
<a href="#l34.20"></a><span id="l34.20">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/mail-offline.js&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mail/base/content/msgHdrView.js</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mail/base/content/msgHdrView.js</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -7,28 +7,27 @@</span>
<a href="#l35.4"></a><span id="l35.4">  * message pane.</span>
<a href="#l35.5"></a><span id="l35.5">  */</span>
<a href="#l35.6"></a><span id="l35.6"> </span>
<a href="#l35.7"></a><span id="l35.7"> ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l35.8"></a><span id="l35.8"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l35.9"></a><span id="l35.9"> ChromeUtils.import(&quot;resource:///modules/DisplayNameUtils.jsm&quot;);</span>
<a href="#l35.10"></a><span id="l35.10"> ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l35.11"></a><span id="l35.11"> ChromeUtils.import(&quot;resource:///modules/gloda/utils.js&quot;);</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-var {Status: statusUtils} =</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineminus">-  ChromeUtils.import(&quot;resource:///modules/imStatusUtils.jsm&quot;);</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineplus">+var {</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineplus">+  Status: statusUtils,</span>
<a href="#l35.16"></a><span id="l35.16" class="difflineplus">+} = ChromeUtils.import(&quot;resource:///modules/imStatusUtils.jsm&quot;, null);</span>
<a href="#l35.17"></a><span id="l35.17"> </span>
<a href="#l35.18"></a><span id="l35.18" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l35.19"></a><span id="l35.19"> // Warning: It's critical that the code in here for displaying the message</span>
<a href="#l35.20"></a><span id="l35.20"> // headers for a selected message remain as fast as possible. In particular,</span>
<a href="#l35.21"></a><span id="l35.21"> // right now, we only introduce one reflow per message. i.e. if you click on</span>
<a href="#l35.22"></a><span id="l35.22"> // a message in the thread pane, we batch up all the changes for displaying</span>
<a href="#l35.23"></a><span id="l35.23"> // the header pane (to, cc, attachements button, etc.) and we make a single</span>
<a href="#l35.24"></a><span id="l35.24"> // pass to display them. It's critical that we maintain this one reflow per</span>
<a href="#l35.25"></a><span id="l35.25"> // message view in the message header pane.</span>
<a href="#l35.26"></a><span id="l35.26" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l35.27"></a><span id="l35.27"> </span>
<a href="#l35.28"></a><span id="l35.28"> var gViewAllHeaders = false;</span>
<a href="#l35.29"></a><span id="l35.29"> var gMinNumberOfHeaders = 0;</span>
<a href="#l35.30"></a><span id="l35.30"> var gDummyHeaderIdIndex = 0;</span>
<a href="#l35.31"></a><span id="l35.31"> var gBuildAttachmentsForCurrentMsg = false;</span>
<a href="#l35.32"></a><span id="l35.32"> var gBuiltExpandedView = false;</span>
<a href="#l35.33"></a><span id="l35.33"> var gHeadersShowReferences = false;</span>
<a href="#l35.34"></a><span id="l35.34"> </span>
<a href="#l35.35"></a><span id="l35.35" class="difflineat">@@ -44,17 +43,17 @@ var gShowCondensedEmailAddresses;</span>
<a href="#l35.36"></a><span id="l35.36">  * gMessageListeners array with an object that supports the three properties:</span>
<a href="#l35.37"></a><span id="l35.37">  * onStartHeaders, onEndHeaders and onEndAttachments.</span>
<a href="#l35.38"></a><span id="l35.38">  *</span>
<a href="#l35.39"></a><span id="l35.39">  * Additionally, if your object has an onBeforeShowHeaderPane() method, it will</span>
<a href="#l35.40"></a><span id="l35.40">  * be called at the appropriate time.  This is designed to give add-ons a</span>
<a href="#l35.41"></a><span id="l35.41">  * chance to examine and modify the currentHeaderData array before it gets</span>
<a href="#l35.42"></a><span id="l35.42">  * displayed.</span>
<a href="#l35.43"></a><span id="l35.43">  */</span>
<a href="#l35.44"></a><span id="l35.44" class="difflineminus">-var gMessageListeners = new Array();</span>
<a href="#l35.45"></a><span id="l35.45" class="difflineplus">+var gMessageListeners = [];</span>
<a href="#l35.46"></a><span id="l35.46"> </span>
<a href="#l35.47"></a><span id="l35.47"> /**</span>
<a href="#l35.48"></a><span id="l35.48">  * This expanded header view shows many of the more common (and useful) headers.</span>
<a href="#l35.49"></a><span id="l35.49">  *</span>
<a href="#l35.50"></a><span id="l35.50">  * For every possible &quot;view&quot; in the message pane, you need to define the header</span>
<a href="#l35.51"></a><span id="l35.51">  * names you want to see in that view. In addition, include information</span>
<a href="#l35.52"></a><span id="l35.52">  * describing how you want that header field to be presented. i.e. if it's an</span>
<a href="#l35.53"></a><span id="l35.53">  * email address field, if you want a toggle inserted on the node in case</span>
<a href="#l35.54"></a><span id="l35.54" class="difflineat">@@ -71,21 +70,21 @@ var gMessageListeners = new Array();</span>
<a href="#l35.55"></a><span id="l35.55">  * outputFunction: this is a method which takes a headerEntry (see the definition</span>
<a href="#l35.56"></a><span id="l35.56">  *                 below) and a header value. This allows you to provide your own</span>
<a href="#l35.57"></a><span id="l35.57">  *                 methods for actually determining how the header value</span>
<a href="#l35.58"></a><span id="l35.58">  *                 is displayed. (DEFAULT: updateHeaderValue which just sets the</span>
<a href="#l35.59"></a><span id="l35.59">  *                 header value on the text node)</span>
<a href="#l35.60"></a><span id="l35.60">  */</span>
<a href="#l35.61"></a><span id="l35.61"> var gExpandedHeaderList = [</span>
<a href="#l35.62"></a><span id="l35.62">   { name: &quot;subject&quot; },</span>
<a href="#l35.63"></a><span id="l35.63" class="difflineminus">-  { name: &quot;from&quot;, useToggle:true, outputFunction: OutputEmailAddresses },</span>
<a href="#l35.64"></a><span id="l35.64" class="difflineminus">-  { name: &quot;reply-to&quot;, useToggle:true, outputFunction: OutputEmailAddresses },</span>
<a href="#l35.65"></a><span id="l35.65" class="difflineminus">-  { name: &quot;to&quot;, useToggle:true, outputFunction: OutputEmailAddresses },</span>
<a href="#l35.66"></a><span id="l35.66" class="difflineminus">-  { name: &quot;cc&quot;, useToggle:true, outputFunction: OutputEmailAddresses },</span>
<a href="#l35.67"></a><span id="l35.67" class="difflineminus">-  { name: &quot;bcc&quot;, useToggle:true, outputFunction: OutputEmailAddresses },</span>
<a href="#l35.68"></a><span id="l35.68" class="difflineplus">+  { name: &quot;from&quot;, useToggle: true, outputFunction: OutputEmailAddresses },</span>
<a href="#l35.69"></a><span id="l35.69" class="difflineplus">+  { name: &quot;reply-to&quot;, useToggle: true, outputFunction: OutputEmailAddresses },</span>
<a href="#l35.70"></a><span id="l35.70" class="difflineplus">+  { name: &quot;to&quot;, useToggle: true, outputFunction: OutputEmailAddresses },</span>
<a href="#l35.71"></a><span id="l35.71" class="difflineplus">+  { name: &quot;cc&quot;, useToggle: true, outputFunction: OutputEmailAddresses },</span>
<a href="#l35.72"></a><span id="l35.72" class="difflineplus">+  { name: &quot;bcc&quot;, useToggle: true, outputFunction: OutputEmailAddresses },</span>
<a href="#l35.73"></a><span id="l35.73">   { name: &quot;newsgroups&quot;, outputFunction: OutputNewsgroups },</span>
<a href="#l35.74"></a><span id="l35.74">   { name: &quot;references&quot;, outputFunction: OutputMessageIds },</span>
<a href="#l35.75"></a><span id="l35.75">   { name: &quot;followup-to&quot;, outputFunction: OutputNewsgroups },</span>
<a href="#l35.76"></a><span id="l35.76">   { name: &quot;content-base&quot; },</span>
<a href="#l35.77"></a><span id="l35.77">   { name: &quot;tags&quot; } ];</span>
<a href="#l35.78"></a><span id="l35.78"> </span>
<a href="#l35.79"></a><span id="l35.79"> /**</span>
<a href="#l35.80"></a><span id="l35.80">  * These are all the items that use a mail-multi-emailHeaderField widget and</span>
<a href="#l35.81"></a><span id="l35.81" class="difflineat">@@ -110,67 +109,65 @@ var gExpandedHeaderView  = {};</span>
<a href="#l35.82"></a><span id="l35.82">  * .headerName   name of the header (i.e. 'to'). Always stored in lower case</span>
<a href="#l35.83"></a><span id="l35.83">  * .headerValue  value of the header &quot;johndoe@example.com&quot;</span>
<a href="#l35.84"></a><span id="l35.84">  */</span>
<a href="#l35.85"></a><span id="l35.85"> var currentHeaderData = {};</span>
<a href="#l35.86"></a><span id="l35.86"> </span>
<a href="#l35.87"></a><span id="l35.87"> /**</span>
<a href="#l35.88"></a><span id="l35.88">  * CurrentAttachments is an array of AttachmentInfo objects.</span>
<a href="#l35.89"></a><span id="l35.89">  */</span>
<a href="#l35.90"></a><span id="l35.90" class="difflineminus">-var currentAttachments = new Array();</span>
<a href="#l35.91"></a><span id="l35.91" class="difflineplus">+var currentAttachments = [];</span>
<a href="#l35.92"></a><span id="l35.92"> </span>
<a href="#l35.93"></a><span id="l35.93"> var nsIAbDirectory = Ci.nsIAbDirectory;</span>
<a href="#l35.94"></a><span id="l35.94"> var nsIAbListener = Ci.nsIAbListener;</span>
<a href="#l35.95"></a><span id="l35.95"> var nsIAbCard = Ci.nsIAbCard;</span>
<a href="#l35.96"></a><span id="l35.96"> </span>
<a href="#l35.97"></a><span id="l35.97"> /**</span>
<a href="#l35.98"></a><span id="l35.98">  * Our constructor method which creates a header Entry based on an entry</span>
<a href="#l35.99"></a><span id="l35.99">  * in one of the header lists. A header entry is different from a header list.</span>
<a href="#l35.100"></a><span id="l35.100">  * A header list just describes how you want a particular header to be</span>
<a href="#l35.101"></a><span id="l35.101">  * presented. The header entry actually has knowledge about the DOM</span>
<a href="#l35.102"></a><span id="l35.102">  * and the actual DOM elements associated with the header.</span>
<a href="#l35.103"></a><span id="l35.103">  *</span>
<a href="#l35.104"></a><span id="l35.104">  * @param prefix  the name of the view (e.g. &quot;expanded&quot;)</span>
<a href="#l35.105"></a><span id="l35.105">  * @param headerListInfo  entry from a header list.</span>
<a href="#l35.106"></a><span id="l35.106">  */</span>
<a href="#l35.107"></a><span id="l35.107" class="difflineminus">-function createHeaderEntry(prefix, headerListInfo)</span>
<a href="#l35.108"></a><span id="l35.108" class="difflineminus">-{</span>
<a href="#l35.109"></a><span id="l35.109" class="difflineplus">+function createHeaderEntry(prefix, headerListInfo) {</span>
<a href="#l35.110"></a><span id="l35.110">   var partialIDName = prefix + headerListInfo.name;</span>
<a href="#l35.111"></a><span id="l35.111">   this.enclosingBox = document.getElementById(partialIDName + &quot;Box&quot;);</span>
<a href="#l35.112"></a><span id="l35.112">   this.enclosingRow = document.getElementById(partialIDName + &quot;Row&quot;);</span>
<a href="#l35.113"></a><span id="l35.113">   this.textNode = document.getElementById(partialIDName + &quot;Value&quot;);</span>
<a href="#l35.114"></a><span id="l35.114">   this.isNewHeader = false;</span>
<a href="#l35.115"></a><span id="l35.115">   this.valid = false;</span>
<a href="#l35.116"></a><span id="l35.116"> </span>
<a href="#l35.117"></a><span id="l35.117">   if (&quot;useToggle&quot; in headerListInfo) {</span>
<a href="#l35.118"></a><span id="l35.118">     this.useToggle = headerListInfo.useToggle;</span>
<a href="#l35.119"></a><span id="l35.119">     if (this.useToggle) {</span>
<a href="#l35.120"></a><span id="l35.120">       // find the toggle icon in the document</span>
<a href="#l35.121"></a><span id="l35.121">       this.toggleIcon = this.enclosingBox.toggleIcon;</span>
<a href="#l35.122"></a><span id="l35.122">       this.longTextNode = this.enclosingBox.longEmailAddresses;</span>
<a href="#l35.123"></a><span id="l35.123">       this.textNode = this.enclosingBox.emailAddresses;</span>
<a href="#l35.124"></a><span id="l35.124">     }</span>
<a href="#l35.125"></a><span id="l35.125" class="difflineplus">+  } else {</span>
<a href="#l35.126"></a><span id="l35.126" class="difflineplus">+   this.useToggle = false;</span>
<a href="#l35.127"></a><span id="l35.127">   }</span>
<a href="#l35.128"></a><span id="l35.128" class="difflineminus">-  else</span>
<a href="#l35.129"></a><span id="l35.129" class="difflineminus">-   this.useToggle = false;</span>
<a href="#l35.130"></a><span id="l35.130"> </span>
<a href="#l35.131"></a><span id="l35.131">   if (&quot;outputFunction&quot; in headerListInfo)</span>
<a href="#l35.132"></a><span id="l35.132">     this.outputFunction = headerListInfo.outputFunction;</span>
<a href="#l35.133"></a><span id="l35.133">   else</span>
<a href="#l35.134"></a><span id="l35.134">     this.outputFunction = updateHeaderValue;</span>
<a href="#l35.135"></a><span id="l35.135"> </span>
<a href="#l35.136"></a><span id="l35.136">   // Stash this so that the &lt;mail-multi-emailheaderfield/&gt; binding can</span>
<a href="#l35.137"></a><span id="l35.137">   // later attach it to any &lt;mail-emailaddress&gt; tags it creates for later</span>
<a href="#l35.138"></a><span id="l35.138">   // extraction and use by UpdateEmailNodeDetails.</span>
<a href="#l35.139"></a><span id="l35.139">   this.enclosingBox.headerName = headerListInfo.name;</span>
<a href="#l35.140"></a><span id="l35.140"> </span>
<a href="#l35.141"></a><span id="l35.141"> }</span>
<a href="#l35.142"></a><span id="l35.142"> </span>
<a href="#l35.143"></a><span id="l35.143" class="difflineminus">-function initializeHeaderViewTables()</span>
<a href="#l35.144"></a><span id="l35.144" class="difflineminus">-{</span>
<a href="#l35.145"></a><span id="l35.145" class="difflineplus">+function initializeHeaderViewTables() {</span>
<a href="#l35.146"></a><span id="l35.146">   // Iterate over each header in our header list arrays and create header entries</span>
<a href="#l35.147"></a><span id="l35.147">   // for each one. These header entries are then stored in the appropriate header</span>
<a href="#l35.148"></a><span id="l35.148">   // table.</span>
<a href="#l35.149"></a><span id="l35.149">   for (let header of gExpandedHeaderList) {</span>
<a href="#l35.150"></a><span id="l35.150">     gExpandedHeaderView[header.name] = new createHeaderEntry(&quot;expanded&quot;, header);</span>
<a href="#l35.151"></a><span id="l35.151">   }</span>
<a href="#l35.152"></a><span id="l35.152"> </span>
<a href="#l35.153"></a><span id="l35.153">   let extraHeaders =</span>
<a href="#l35.154"></a><span id="l35.154" class="difflineat">@@ -204,18 +201,17 @@ function initializeHeaderViewTables()</span>
<a href="#l35.155"></a><span id="l35.155"> </span>
<a href="#l35.156"></a><span id="l35.156">   if (Services.prefs.getBoolPref(&quot;mailnews.headers.showSender&quot;)) {</span>
<a href="#l35.157"></a><span id="l35.157">     var senderEntry = { name: &quot;sender&quot;, outputFunction: OutputEmailAddresses };</span>
<a href="#l35.158"></a><span id="l35.158">     gExpandedHeaderView[senderEntry.name] =</span>
<a href="#l35.159"></a><span id="l35.159">       new createHeaderEntry(&quot;expanded&quot;, senderEntry);</span>
<a href="#l35.160"></a><span id="l35.160">   }</span>
<a href="#l35.161"></a><span id="l35.161"> }</span>
<a href="#l35.162"></a><span id="l35.162"> </span>
<a href="#l35.163"></a><span id="l35.163" class="difflineminus">-function OnLoadMsgHeaderPane()</span>
<a href="#l35.164"></a><span id="l35.164" class="difflineminus">-{</span>
<a href="#l35.165"></a><span id="l35.165" class="difflineplus">+function OnLoadMsgHeaderPane() {</span>
<a href="#l35.166"></a><span id="l35.166">   // Load any preferences that at are global with regards to</span>
<a href="#l35.167"></a><span id="l35.167">   // displaying a message...</span>
<a href="#l35.168"></a><span id="l35.168">   gMinNumberOfHeaders = Services.prefs.getIntPref(&quot;mailnews.headers.minNumHeaders&quot;);</span>
<a href="#l35.169"></a><span id="l35.169">   gShowCondensedEmailAddresses = Services.prefs.getBoolPref(&quot;mail.showCondensedAddresses&quot;);</span>
<a href="#l35.170"></a><span id="l35.170">   gHeadersShowReferences = Services.prefs.getBoolPref(&quot;mailnews.headers.showReferences&quot;);</span>
<a href="#l35.171"></a><span id="l35.171"> </span>
<a href="#l35.172"></a><span id="l35.172">   // listen to the</span>
<a href="#l35.173"></a><span id="l35.173">   Services.prefs.addObserver(&quot;mail.showCondensedAddresses&quot;, MsgHdrViewObserver);</span>
<a href="#l35.174"></a><span id="l35.174" class="difflineat">@@ -227,50 +223,48 @@ function OnLoadMsgHeaderPane()</span>
<a href="#l35.175"></a><span id="l35.175">   // change.</span>
<a href="#l35.176"></a><span id="l35.176">   MailServices.ab.addAddressBookListener(AddressBookListener,</span>
<a href="#l35.177"></a><span id="l35.177">                                          Ci.nsIAbListener.all);</span>
<a href="#l35.178"></a><span id="l35.178"> </span>
<a href="#l35.179"></a><span id="l35.179">   // If an invalid index is selected; reset to 0.  One way this can happen</span>
<a href="#l35.180"></a><span id="l35.180">   // is if a value of 1 was persisted to localStore.rdf by Tb2 (when there were</span>
<a href="#l35.181"></a><span id="l35.181">   // two panels), and then the user upgraded to Tb3, which only has one.</span>
<a href="#l35.182"></a><span id="l35.182">   // Presumably this can also catch cases of extension uninstalls as well.</span>
<a href="#l35.183"></a><span id="l35.183" class="difflineminus">-  let deckElement = document.getElementById(&quot;msgHeaderViewDeck&quot;)</span>
<a href="#l35.184"></a><span id="l35.184" class="difflineplus">+  let deckElement = document.getElementById(&quot;msgHeaderViewDeck&quot;);</span>
<a href="#l35.185"></a><span id="l35.185"> </span>
<a href="#l35.186"></a><span id="l35.186">   // If the selectedIndex was 0, then we were using the compact header, (if we</span>
<a href="#l35.187"></a><span id="l35.187">   // were coming from TB2, but we'll check that in the feature configurator).</span>
<a href="#l35.188"></a><span id="l35.188">   deckElement.usedCompactHeader = (deckElement.selectedIndex == 0);</span>
<a href="#l35.189"></a><span id="l35.189"> </span>
<a href="#l35.190"></a><span id="l35.190">   if (deckElement.selectedIndex &lt; 0 ||</span>
<a href="#l35.191"></a><span id="l35.191">       deckElement.selectedIndex &gt;= deckElement.childElementCount) {</span>
<a href="#l35.192"></a><span id="l35.192">     deckElement.selectedIndex = 0;</span>
<a href="#l35.193"></a><span id="l35.193">   }</span>
<a href="#l35.194"></a><span id="l35.194"> </span>
<a href="#l35.195"></a><span id="l35.195" class="difflineminus">-  initToolbarMenu();</span>
<a href="#l35.196"></a><span id="l35.196" class="difflineminus">-</span>
<a href="#l35.197"></a><span id="l35.197">   // Only offer openInTab and openInNewWindow if this window supports tabs...</span>
<a href="#l35.198"></a><span id="l35.198">   // (i.e. is not a standalone message window), since those actions are likely</span>
<a href="#l35.199"></a><span id="l35.199">   // to be significantly less common in that case.</span>
<a href="#l35.200"></a><span id="l35.200">   if (document.getElementById(&quot;otherActionsOpenIn&quot;)) {</span>
<a href="#l35.201"></a><span id="l35.201" class="difflineminus">-    let opensAreHidden = document.getElementById(&quot;tabmail&quot;) ? false : true;</span>
<a href="#l35.202"></a><span id="l35.202" class="difflineplus">+    let opensAreHidden = !document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l35.203"></a><span id="l35.203">     document.getElementById(&quot;otherActionsOpenIn&quot;).hidden = opensAreHidden;</span>
<a href="#l35.204"></a><span id="l35.204">   }</span>
<a href="#l35.205"></a><span id="l35.205"> </span>
<a href="#l35.206"></a><span id="l35.206">   // Dispatch an event letting any listeners know that we have loaded</span>
<a href="#l35.207"></a><span id="l35.207">   // the message pane.</span>
<a href="#l35.208"></a><span id="l35.208">   var headerViewElement = document.getElementById(&quot;msgHeaderView&quot;);</span>
<a href="#l35.209"></a><span id="l35.209">   headerViewElement.dispatchEvent(new Event(&quot;messagepane-loaded&quot;,</span>
<a href="#l35.210"></a><span id="l35.210">     { bubbles: false, cancelable: true }));</span>
<a href="#l35.211"></a><span id="l35.211"> </span>
<a href="#l35.212"></a><span id="l35.212">   initInlineToolbox(&quot;header-view-toolbox&quot;, &quot;header-view-toolbar&quot;,</span>
<a href="#l35.213"></a><span id="l35.213">                     &quot;CustomizeHeaderToolbar&quot;, function() {</span>
<a href="#l35.214"></a><span id="l35.214">                       UpdateJunkButton();</span>
<a href="#l35.215"></a><span id="l35.215">                       UpdateReplyButtons();</span>
<a href="#l35.216"></a><span id="l35.216">                     });</span>
<a href="#l35.217"></a><span id="l35.217">   initInlineToolbox(&quot;attachment-view-toolbox&quot;, &quot;attachment-view-toolbar&quot;,</span>
<a href="#l35.218"></a><span id="l35.218" class="difflineminus">-                    &quot;CustomizeAttachmentToolbar&quot;, function () {</span>
<a href="#l35.219"></a><span id="l35.219" class="difflineplus">+                    &quot;CustomizeAttachmentToolbar&quot;, function() {</span>
<a href="#l35.220"></a><span id="l35.220">                       updateSaveAllAttachmentsButton();</span>
<a href="#l35.221"></a><span id="l35.221">                     });</span>
<a href="#l35.222"></a><span id="l35.222"> </span>
<a href="#l35.223"></a><span id="l35.223">   top.controllers.appendController(AttachmentMenuController);</span>
<a href="#l35.224"></a><span id="l35.224"> }</span>
<a href="#l35.225"></a><span id="l35.225"> </span>
<a href="#l35.226"></a><span id="l35.226"> /**</span>
<a href="#l35.227"></a><span id="l35.227">  * Initialize an inline toolbox and its toolbar to have the appropriate</span>
<a href="#l35.228"></a><span id="l35.228" class="difflineat">@@ -313,80 +307,67 @@ function initInlineToolbox(toolboxId, to</span>
<a href="#l35.229"></a><span id="l35.229">       /* set toolbar attributes to default values */</span>
<a href="#l35.230"></a><span id="l35.230">       iconsize = toolbar.getAttribute(&quot;defaulticonsize&quot;);</span>
<a href="#l35.231"></a><span id="l35.231">       toolbar.setAttribute(&quot;iconsize&quot;, iconsize);</span>
<a href="#l35.232"></a><span id="l35.232">       Services.xulStore.persist(toolbar, &quot;iconsize&quot;);</span>
<a href="#l35.233"></a><span id="l35.233">     }</span>
<a href="#l35.234"></a><span id="l35.234">   }</span>
<a href="#l35.235"></a><span id="l35.235"> }</span>
<a href="#l35.236"></a><span id="l35.236"> </span>
<a href="#l35.237"></a><span id="l35.237" class="difflineminus">-function initToolbarMenu() {</span>
<a href="#l35.238"></a><span id="l35.238" class="difflineminus">-  // Get the mode as persisted on the toolbar itself.</span>
<a href="#l35.239"></a><span id="l35.239" class="difflineminus">-  let mode = document.getElementById(&quot;header-view-toolbar&quot;)</span>
<a href="#l35.240"></a><span id="l35.240" class="difflineminus">-                     .getAttribute(&quot;mode&quot;);</span>
<a href="#l35.241"></a><span id="l35.241" class="difflineminus">-</span>
<a href="#l35.242"></a><span id="l35.242" class="difflineminus">-  return;</span>
<a href="#l35.243"></a><span id="l35.243" class="difflineminus">-}</span>
<a href="#l35.244"></a><span id="l35.244" class="difflineminus">-</span>
<a href="#l35.245"></a><span id="l35.245" class="difflineminus">-function OnUnloadMsgHeaderPane()</span>
<a href="#l35.246"></a><span id="l35.246" class="difflineminus">-{</span>
<a href="#l35.247"></a><span id="l35.247" class="difflineplus">+function OnUnloadMsgHeaderPane() {</span>
<a href="#l35.248"></a><span id="l35.248">   Services.prefs.removeObserver(&quot;mail.showCondensedAddresses&quot;, MsgHdrViewObserver);</span>
<a href="#l35.249"></a><span id="l35.249">   Services.prefs.removeObserver(&quot;mailnews.headers.showReferences&quot;, MsgHdrViewObserver);</span>
<a href="#l35.250"></a><span id="l35.250"> </span>
<a href="#l35.251"></a><span id="l35.251">   MailServices.ab.removeAddressBookListener(AddressBookListener);</span>
<a href="#l35.252"></a><span id="l35.252"> </span>
<a href="#l35.253"></a><span id="l35.253">   // dispatch an event letting any listeners know that we have unloaded</span>
<a href="#l35.254"></a><span id="l35.254">   // the message pane</span>
<a href="#l35.255"></a><span id="l35.255">   var headerViewElement = document.getElementById(&quot;msgHeaderView&quot;);</span>
<a href="#l35.256"></a><span id="l35.256">   headerViewElement.dispatchEvent(new Event(&quot;messagepane-unloaded&quot;,</span>
<a href="#l35.257"></a><span id="l35.257">     { bubbles: false, cancelable: true }));</span>
<a href="#l35.258"></a><span id="l35.258"> }</span>
<a href="#l35.259"></a><span id="l35.259"> </span>
<a href="#l35.260"></a><span id="l35.260" class="difflineminus">-var MsgHdrViewObserver =</span>
<a href="#l35.261"></a><span id="l35.261" class="difflineminus">-{</span>
<a href="#l35.262"></a><span id="l35.262" class="difflineminus">-  observe: function(subject, topic, prefName)</span>
<a href="#l35.263"></a><span id="l35.263" class="difflineminus">-  {</span>
<a href="#l35.264"></a><span id="l35.264" class="difflineplus">+var MsgHdrViewObserver = {</span>
<a href="#l35.265"></a><span id="l35.265" class="difflineplus">+  observe(subject, topic, prefName) {</span>
<a href="#l35.266"></a><span id="l35.266">     // verify that we're changing the mail pane config pref</span>
<a href="#l35.267"></a><span id="l35.267">     if (topic == &quot;nsPref:changed&quot;) {</span>
<a href="#l35.268"></a><span id="l35.268">       if (prefName == &quot;mail.showCondensedAddresses&quot;) {</span>
<a href="#l35.269"></a><span id="l35.269">         gShowCondensedEmailAddresses =</span>
<a href="#l35.270"></a><span id="l35.270">           Services.prefs.getBoolPref(&quot;mail.showCondensedAddresses&quot;);</span>
<a href="#l35.271"></a><span id="l35.271">         ReloadMessage();</span>
<a href="#l35.272"></a><span id="l35.272" class="difflineminus">-      }</span>
<a href="#l35.273"></a><span id="l35.273" class="difflineminus">-      else if (prefName == &quot;mailnews.headers.showReferences&quot;) {</span>
<a href="#l35.274"></a><span id="l35.274" class="difflineplus">+      } else if (prefName == &quot;mailnews.headers.showReferences&quot;) {</span>
<a href="#l35.275"></a><span id="l35.275">         gHeadersShowReferences =</span>
<a href="#l35.276"></a><span id="l35.276">           Services.prefs.getBoolPref(&quot;mailnews.headers.showReferences&quot;);</span>
<a href="#l35.277"></a><span id="l35.277">         ReloadMessage();</span>
<a href="#l35.278"></a><span id="l35.278">       }</span>
<a href="#l35.279"></a><span id="l35.279">     }</span>
<a href="#l35.280"></a><span id="l35.280" class="difflineminus">-  }</span>
<a href="#l35.281"></a><span id="l35.281" class="difflineplus">+  },</span>
<a href="#l35.282"></a><span id="l35.282"> };</span>
<a href="#l35.283"></a><span id="l35.283"> </span>
<a href="#l35.284"></a><span id="l35.284" class="difflineminus">-var AddressBookListener =</span>
<a href="#l35.285"></a><span id="l35.285" class="difflineminus">-{</span>
<a href="#l35.286"></a><span id="l35.286" class="difflineminus">-  onItemAdded: function(aParentDir, aItem) {</span>
<a href="#l35.287"></a><span id="l35.287" class="difflineplus">+var AddressBookListener = {</span>
<a href="#l35.288"></a><span id="l35.288" class="difflineplus">+  onItemAdded(aParentDir, aItem) {</span>
<a href="#l35.289"></a><span id="l35.289">     OnAddressBookDataChanged(nsIAbListener.itemAdded,</span>
<a href="#l35.290"></a><span id="l35.290">                              aParentDir, aItem);</span>
<a href="#l35.291"></a><span id="l35.291">   },</span>
<a href="#l35.292"></a><span id="l35.292" class="difflineminus">-  onItemRemoved: function(aParentDir, aItem) {</span>
<a href="#l35.293"></a><span id="l35.293" class="difflineplus">+  onItemRemoved(aParentDir, aItem) {</span>
<a href="#l35.294"></a><span id="l35.294">     OnAddressBookDataChanged(aItem instanceof nsIAbCard ?</span>
<a href="#l35.295"></a><span id="l35.295">                                nsIAbListener.directoryItemRemoved :</span>
<a href="#l35.296"></a><span id="l35.296">                                nsIAbListener.directoryRemoved,</span>
<a href="#l35.297"></a><span id="l35.297">                              aParentDir, aItem);</span>
<a href="#l35.298"></a><span id="l35.298">   },</span>
<a href="#l35.299"></a><span id="l35.299" class="difflineminus">-  onItemPropertyChanged: function(aItem, aProperty, aOldValue, aNewValue) {</span>
<a href="#l35.300"></a><span id="l35.300" class="difflineplus">+  onItemPropertyChanged(aItem, aProperty, aOldValue, aNewValue) {</span>
<a href="#l35.301"></a><span id="l35.301">     // We only need updates for card changes, address book and mailing list</span>
<a href="#l35.302"></a><span id="l35.302">     // ones don't affect us here.</span>
<a href="#l35.303"></a><span id="l35.303">     if (aItem instanceof Ci.nsIAbCard)</span>
<a href="#l35.304"></a><span id="l35.304">       OnAddressBookDataChanged(nsIAbListener.itemChanged, null, aItem);</span>
<a href="#l35.305"></a><span id="l35.305" class="difflineminus">-  }</span>
<a href="#l35.306"></a><span id="l35.306" class="difflineplus">+  },</span>
<a href="#l35.307"></a><span id="l35.307"> };</span>
<a href="#l35.308"></a><span id="l35.308"> </span>
<a href="#l35.309"></a><span id="l35.309"> function OnAddressBookDataChanged(aAction, aParentDir, aItem) {</span>
<a href="#l35.310"></a><span id="l35.310" class="difflineminus">-  gEmailAddressHeaderNames.forEach(function (headerName) {</span>
<a href="#l35.311"></a><span id="l35.311" class="difflineplus">+  gEmailAddressHeaderNames.forEach(function(headerName) {</span>
<a href="#l35.312"></a><span id="l35.312">     let headerEntry = null;</span>
<a href="#l35.313"></a><span id="l35.313"> </span>
<a href="#l35.314"></a><span id="l35.314">     if (headerName in gExpandedHeaderView) {</span>
<a href="#l35.315"></a><span id="l35.315">       headerEntry = gExpandedHeaderView[headerName];</span>
<a href="#l35.316"></a><span id="l35.316">       if (headerEntry)</span>
<a href="#l35.317"></a><span id="l35.317">         headerEntry.enclosingBox.updateExtraAddressProcessing(aAction,</span>
<a href="#l35.318"></a><span id="l35.318">                                                               aParentDir,</span>
<a href="#l35.319"></a><span id="l35.319">                                                               aItem);</span>
<a href="#l35.320"></a><span id="l35.320" class="difflineat">@@ -396,18 +377,17 @@ function OnAddressBookDataChanged(aActio</span>
<a href="#l35.321"></a><span id="l35.321"> </span>
<a href="#l35.322"></a><span id="l35.322"> /**</span>
<a href="#l35.323"></a><span id="l35.323">  * The messageHeaderSink is the class that gets notified of a message's headers</span>
<a href="#l35.324"></a><span id="l35.324">  * as we display the message through our mime converter.</span>
<a href="#l35.325"></a><span id="l35.325">  */</span>
<a href="#l35.326"></a><span id="l35.326"> var messageHeaderSink = {</span>
<a href="#l35.327"></a><span id="l35.327">     QueryInterface: ChromeUtils.generateQI(</span>
<a href="#l35.328"></a><span id="l35.328">       [Ci.nsIMsgHeaderSink]),</span>
<a href="#l35.329"></a><span id="l35.329" class="difflineminus">-    onStartHeaders: function()</span>
<a href="#l35.330"></a><span id="l35.330" class="difflineminus">-    {</span>
<a href="#l35.331"></a><span id="l35.331" class="difflineplus">+    onStartHeaders() {</span>
<a href="#l35.332"></a><span id="l35.332">       this.mSaveHdr = null;</span>
<a href="#l35.333"></a><span id="l35.333">       // Every time we start to redisplay a message, check the view all headers</span>
<a href="#l35.334"></a><span id="l35.334">       // pref...</span>
<a href="#l35.335"></a><span id="l35.335">       var showAllHeadersPref = Services.prefs.getIntPref(&quot;mail.show_headers&quot;);</span>
<a href="#l35.336"></a><span id="l35.336">       if (showAllHeadersPref == 2) {</span>
<a href="#l35.337"></a><span id="l35.337">         gViewAllHeaders = true;</span>
<a href="#l35.338"></a><span id="l35.338">       } else {</span>
<a href="#l35.339"></a><span id="l35.339">         if (gViewAllHeaders) {</span>
<a href="#l35.340"></a><span id="l35.340" class="difflineat">@@ -428,18 +408,17 @@ var messageHeaderSink = {</span>
<a href="#l35.341"></a><span id="l35.341">       gBuildAttachmentsForCurrentMsg = false;</span>
<a href="#l35.342"></a><span id="l35.342">       ClearAttachmentList();</span>
<a href="#l35.343"></a><span id="l35.343">       gMessageNotificationBar.clearMsgNotifications();</span>
<a href="#l35.344"></a><span id="l35.344"> </span>
<a href="#l35.345"></a><span id="l35.345">       for (let index in gMessageListeners)</span>
<a href="#l35.346"></a><span id="l35.346">         gMessageListeners[index].onStartHeaders();</span>
<a href="#l35.347"></a><span id="l35.347">     },</span>
<a href="#l35.348"></a><span id="l35.348"> </span>
<a href="#l35.349"></a><span id="l35.349" class="difflineminus">-    onEndHeaders: function()</span>
<a href="#l35.350"></a><span id="l35.350" class="difflineminus">-    {</span>
<a href="#l35.351"></a><span id="l35.351" class="difflineplus">+    onEndHeaders() {</span>
<a href="#l35.352"></a><span id="l35.352">       // Give add-ons a chance to modify currentHeaderData before it actually</span>
<a href="#l35.353"></a><span id="l35.353">       // gets displayed.</span>
<a href="#l35.354"></a><span id="l35.354">       for (let index in gMessageListeners)</span>
<a href="#l35.355"></a><span id="l35.355">         if (&quot;onBeforeShowHeaderPane&quot; in gMessageListeners[index])</span>
<a href="#l35.356"></a><span id="l35.356">           gMessageListeners[index].onBeforeShowHeaderPane();</span>
<a href="#l35.357"></a><span id="l35.357"> </span>
<a href="#l35.358"></a><span id="l35.358">       // Load feed web page if so configured. This entry point works for</span>
<a href="#l35.359"></a><span id="l35.359">       // messagepane loads in 3pane folder tab, 3pane message tab, and the</span>
<a href="#l35.360"></a><span id="l35.360" class="difflineat">@@ -465,25 +444,23 @@ var messageHeaderSink = {</span>
<a href="#l35.361"></a><span id="l35.361"> </span>
<a href="#l35.362"></a><span id="l35.362">       gMessageNotificationBar.setDraftEditMessage();</span>
<a href="#l35.363"></a><span id="l35.363">       UpdateJunkButton();</span>
<a href="#l35.364"></a><span id="l35.364"> </span>
<a href="#l35.365"></a><span id="l35.365">       for (let index in gMessageListeners)</span>
<a href="#l35.366"></a><span id="l35.366">         gMessageListeners[index].onEndHeaders();</span>
<a href="#l35.367"></a><span id="l35.367">     },</span>
<a href="#l35.368"></a><span id="l35.368"> </span>
<a href="#l35.369"></a><span id="l35.369" class="difflineminus">-    processHeaders: function(headerNameEnumerator, headerValueEnumerator,</span>
<a href="#l35.370"></a><span id="l35.370" class="difflineminus">-                             dontCollectAddress)</span>
<a href="#l35.371"></a><span id="l35.371" class="difflineminus">-    {</span>
<a href="#l35.372"></a><span id="l35.372" class="difflineplus">+    processHeaders(headerNameEnumerator, headerValueEnumerator, dontCollectAddress) {</span>
<a href="#l35.373"></a><span id="l35.373">       this.onStartHeaders();</span>
<a href="#l35.374"></a><span id="l35.374"> </span>
<a href="#l35.375"></a><span id="l35.375">       const kMailboxSeparator = &quot;, &quot;;</span>
<a href="#l35.376"></a><span id="l35.376">       var index = 0;</span>
<a href="#l35.377"></a><span id="l35.377">       while (headerNameEnumerator.hasMore()) {</span>
<a href="#l35.378"></a><span id="l35.378" class="difflineminus">-        var header = new Object;</span>
<a href="#l35.379"></a><span id="l35.379" class="difflineplus">+        var header = {};</span>
<a href="#l35.380"></a><span id="l35.380">         header.headerValue = headerValueEnumerator.getNext();</span>
<a href="#l35.381"></a><span id="l35.381">         header.headerName = headerNameEnumerator.getNext();</span>
<a href="#l35.382"></a><span id="l35.382"> </span>
<a href="#l35.383"></a><span id="l35.383">         // For consistency's sake, let us force all header names to be lower</span>
<a href="#l35.384"></a><span id="l35.384">         // case so we don't have to worry about looking for: Cc and CC, etc.</span>
<a href="#l35.385"></a><span id="l35.385">         var lowerCaseHeaderName = header.headerName.toLowerCase();</span>
<a href="#l35.386"></a><span id="l35.386"> </span>
<a href="#l35.387"></a><span id="l35.387">         // If we have an x-mailer, x-mimeole, or x-newsreader string,</span>
<a href="#l35.388"></a><span id="l35.388" class="difflineat">@@ -520,46 +497,46 @@ var messageHeaderSink = {</span>
<a href="#l35.389"></a><span id="l35.389">             currentHeaderData[lowerCaseHeaderName].headerValue =</span>
<a href="#l35.390"></a><span id="l35.390">               currentHeaderData[lowerCaseHeaderName].headerValue + &quot;,&quot; +</span>
<a href="#l35.391"></a><span id="l35.391">                 header.headerValue;</span>
<a href="#l35.392"></a><span id="l35.392">           } else {</span>
<a href="#l35.393"></a><span id="l35.393">             // Use the index to create a unique header name like:</span>
<a href="#l35.394"></a><span id="l35.394">             // received5, received6, etc</span>
<a href="#l35.395"></a><span id="l35.395">             currentHeaderData[lowerCaseHeaderName + index++] = header;</span>
<a href="#l35.396"></a><span id="l35.396">           }</span>
<a href="#l35.397"></a><span id="l35.397" class="difflineplus">+        } else {</span>
<a href="#l35.398"></a><span id="l35.398" class="difflineplus">+         currentHeaderData[lowerCaseHeaderName] = header;</span>
<a href="#l35.399"></a><span id="l35.399">         }</span>
<a href="#l35.400"></a><span id="l35.400" class="difflineminus">-        else</span>
<a href="#l35.401"></a><span id="l35.401" class="difflineminus">-         currentHeaderData[lowerCaseHeaderName] = header;</span>
<a href="#l35.402"></a><span id="l35.402">       } // while we have more headers to parse</span>
<a href="#l35.403"></a><span id="l35.403"> </span>
<a href="#l35.404"></a><span id="l35.404">       // Process message tags as if they were headers in the message.</span>
<a href="#l35.405"></a><span id="l35.405">       SetTagHeader();</span>
<a href="#l35.406"></a><span id="l35.406"> </span>
<a href="#l35.407"></a><span id="l35.407">       if ((&quot;from&quot; in currentHeaderData) &amp;&amp; (&quot;sender&quot; in currentHeaderData)) {</span>
<a href="#l35.408"></a><span id="l35.408" class="difflineminus">-        var senderMailbox = kMailboxSeparator +</span>
<a href="#l35.409"></a><span id="l35.409" class="difflineplus">+        let senderMailbox = kMailboxSeparator +</span>
<a href="#l35.410"></a><span id="l35.410">           MailServices.headerParser.extractHeaderAddressMailboxes(</span>
<a href="#l35.411"></a><span id="l35.411">             currentHeaderData.sender.headerValue) + kMailboxSeparator;</span>
<a href="#l35.412"></a><span id="l35.412" class="difflineminus">-        var fromMailboxes = kMailboxSeparator +</span>
<a href="#l35.413"></a><span id="l35.413" class="difflineplus">+        let fromMailboxes = kMailboxSeparator +</span>
<a href="#l35.414"></a><span id="l35.414">           MailServices.headerParser.extractHeaderAddressMailboxes(</span>
<a href="#l35.415"></a><span id="l35.415">             currentHeaderData.from.headerValue) + kMailboxSeparator;</span>
<a href="#l35.416"></a><span id="l35.416">         if (fromMailboxes.includes(senderMailbox))</span>
<a href="#l35.417"></a><span id="l35.417">           delete currentHeaderData.sender;</span>
<a href="#l35.418"></a><span id="l35.418">       }</span>
<a href="#l35.419"></a><span id="l35.419"> </span>
<a href="#l35.420"></a><span id="l35.420">       // We don't need to show the reply-to header if its value is either</span>
<a href="#l35.421"></a><span id="l35.421">       // the From field (totally pointless) or the To field (common for</span>
<a href="#l35.422"></a><span id="l35.422">       // mailing lists, but not that useful).</span>
<a href="#l35.423"></a><span id="l35.423">       if ((&quot;from&quot; in currentHeaderData) &amp;&amp;</span>
<a href="#l35.424"></a><span id="l35.424">           (&quot;to&quot; in currentHeaderData) &amp;&amp;</span>
<a href="#l35.425"></a><span id="l35.425">           (&quot;reply-to&quot; in currentHeaderData)) {</span>
<a href="#l35.426"></a><span id="l35.426" class="difflineminus">-        var replyToMailbox = MailServices.headerParser.extractHeaderAddressMailboxes(</span>
<a href="#l35.427"></a><span id="l35.427" class="difflineplus">+        let replyToMailbox = MailServices.headerParser.extractHeaderAddressMailboxes(</span>
<a href="#l35.428"></a><span id="l35.428">             currentHeaderData[&quot;reply-to&quot;].headerValue);</span>
<a href="#l35.429"></a><span id="l35.429" class="difflineminus">-        var fromMailboxes = MailServices.headerParser.extractHeaderAddressMailboxes(</span>
<a href="#l35.430"></a><span id="l35.430" class="difflineplus">+        let fromMailboxes = MailServices.headerParser.extractHeaderAddressMailboxes(</span>
<a href="#l35.431"></a><span id="l35.431">             currentHeaderData.from.headerValue);</span>
<a href="#l35.432"></a><span id="l35.432" class="difflineminus">-        var toMailboxes = MailServices.headerParser.extractHeaderAddressMailboxes(</span>
<a href="#l35.433"></a><span id="l35.433" class="difflineplus">+        let toMailboxes = MailServices.headerParser.extractHeaderAddressMailboxes(</span>
<a href="#l35.434"></a><span id="l35.434">             currentHeaderData.to.headerValue);</span>
<a href="#l35.435"></a><span id="l35.435"> </span>
<a href="#l35.436"></a><span id="l35.436">         if (replyToMailbox == fromMailboxes || replyToMailbox == toMailboxes)</span>
<a href="#l35.437"></a><span id="l35.437">           delete currentHeaderData[&quot;reply-to&quot;];</span>
<a href="#l35.438"></a><span id="l35.438">       }</span>
<a href="#l35.439"></a><span id="l35.439"> </span>
<a href="#l35.440"></a><span id="l35.440">       // For content-base urls stored uri encoded, we want to decode for</span>
<a href="#l35.441"></a><span id="l35.441">       // display (and encode for external link open).</span>
<a href="#l35.442"></a><span id="l35.442" class="difflineat">@@ -572,19 +549,17 @@ var messageHeaderSink = {</span>
<a href="#l35.443"></a><span id="l35.443">       if (gFolderDisplay.selectedMessageIsFeed)</span>
<a href="#l35.444"></a><span id="l35.444">         expandedfromLabel.value = expandedfromLabel.getAttribute(&quot;valueAuthor&quot;);</span>
<a href="#l35.445"></a><span id="l35.445">       else</span>
<a href="#l35.446"></a><span id="l35.446">         expandedfromLabel.value = expandedfromLabel.getAttribute(&quot;valueFrom&quot;);</span>
<a href="#l35.447"></a><span id="l35.447"> </span>
<a href="#l35.448"></a><span id="l35.448">       this.onEndHeaders();</span>
<a href="#l35.449"></a><span id="l35.449">     },</span>
<a href="#l35.450"></a><span id="l35.450"> </span>
<a href="#l35.451"></a><span id="l35.451" class="difflineminus">-    handleAttachment: function(contentType, url, displayName, uri,</span>
<a href="#l35.452"></a><span id="l35.452" class="difflineminus">-                               isExternalAttachment)</span>
<a href="#l35.453"></a><span id="l35.453" class="difflineminus">-    {</span>
<a href="#l35.454"></a><span id="l35.454" class="difflineplus">+    handleAttachment(contentType, url, displayName, uri, isExternalAttachment) {</span>
<a href="#l35.455"></a><span id="l35.455">       this.skipAttachment = true;</span>
<a href="#l35.456"></a><span id="l35.456"> </span>
<a href="#l35.457"></a><span id="l35.457">       // Don't show vcards as external attachments in the UI. libmime already</span>
<a href="#l35.458"></a><span id="l35.458">       // renders them inline.</span>
<a href="#l35.459"></a><span id="l35.459">       if (!this.mSaveHdr)</span>
<a href="#l35.460"></a><span id="l35.460">         this.mSaveHdr = messenger.messageServiceFromURI(uri)</span>
<a href="#l35.461"></a><span id="l35.461">                                  .messageURIToMsgHdr(uri);</span>
<a href="#l35.462"></a><span id="l35.462">       if (contentType == &quot;text/x-vcard&quot;) {</span>
<a href="#l35.463"></a><span id="l35.463" class="difflineat">@@ -599,18 +574,17 @@ var messageHeaderSink = {</span>
<a href="#l35.464"></a><span id="l35.464">         let fileHandler = Services.io.getProtocolHandler(&quot;file&quot;)</span>
<a href="#l35.465"></a><span id="l35.465">           .QueryInterface(Ci.nsIFileProtocolHandler);</span>
<a href="#l35.466"></a><span id="l35.466">         try {</span>
<a href="#l35.467"></a><span id="l35.467">           let file = fileHandler.getFileFromURLSpec(url);</span>
<a href="#l35.468"></a><span id="l35.468">           // Can't get size for detached attachments which are no longer</span>
<a href="#l35.469"></a><span id="l35.469">           // available on the specified location.</span>
<a href="#l35.470"></a><span id="l35.470">           if (file.exists())</span>
<a href="#l35.471"></a><span id="l35.471">             size = file.fileSize;</span>
<a href="#l35.472"></a><span id="l35.472" class="difflineminus">-        }</span>
<a href="#l35.473"></a><span id="l35.473" class="difflineminus">-        catch(e) {</span>
<a href="#l35.474"></a><span id="l35.474" class="difflineplus">+        } catch (e) {</span>
<a href="#l35.475"></a><span id="l35.475">           Cu.reportError(&quot;Couldn't open external attachment; &quot; +</span>
<a href="#l35.476"></a><span id="l35.476">                          &quot;url=&quot; + url + &quot;; &quot; + e);</span>
<a href="#l35.477"></a><span id="l35.477">         }</span>
<a href="#l35.478"></a><span id="l35.478">       }</span>
<a href="#l35.479"></a><span id="l35.479"> </span>
<a href="#l35.480"></a><span id="l35.480">       currentAttachments.push(new AttachmentInfo(contentType, url, displayName,</span>
<a href="#l35.481"></a><span id="l35.481">                                                  uri, isExternalAttachment,</span>
<a href="#l35.482"></a><span id="l35.482">                                                  size));</span>
<a href="#l35.483"></a><span id="l35.483" class="difflineat">@@ -634,18 +608,17 @@ var messageHeaderSink = {</span>
<a href="#l35.484"></a><span id="l35.484">         if (appmenunode)</span>
<a href="#l35.485"></a><span id="l35.485">           appmenunode.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l35.486"></a><span id="l35.486"> </span>
<a href="#l35.487"></a><span id="l35.487">         // convert the uri into a hdr</span>
<a href="#l35.488"></a><span id="l35.488">         this.mSaveHdr.markHasAttachments(true);</span>
<a href="#l35.489"></a><span id="l35.489">       }</span>
<a href="#l35.490"></a><span id="l35.490">     },</span>
<a href="#l35.491"></a><span id="l35.491"> </span>
<a href="#l35.492"></a><span id="l35.492" class="difflineminus">-    addAttachmentField: function(field, value)</span>
<a href="#l35.493"></a><span id="l35.493" class="difflineminus">-    {</span>
<a href="#l35.494"></a><span id="l35.494" class="difflineplus">+    addAttachmentField(field, value) {</span>
<a href="#l35.495"></a><span id="l35.495">       if (this.skipAttachment)</span>
<a href="#l35.496"></a><span id="l35.496">         return;</span>
<a href="#l35.497"></a><span id="l35.497"> </span>
<a href="#l35.498"></a><span id="l35.498">       let last = currentAttachments[currentAttachments.length - 1];</span>
<a href="#l35.499"></a><span id="l35.499">       if (field == &quot;X-Mozilla-PartSize&quot; &amp;&amp; !last.url.startsWith(&quot;file&quot;) &amp;&amp;</span>
<a href="#l35.500"></a><span id="l35.500">           !last.isDeleted) {</span>
<a href="#l35.501"></a><span id="l35.501">         let size = parseInt(value);</span>
<a href="#l35.502"></a><span id="l35.502"> </span>
<a href="#l35.503"></a><span id="l35.503" class="difflineat">@@ -657,44 +630,41 @@ var messageHeaderSink = {</span>
<a href="#l35.504"></a><span id="l35.504">             size = -1;</span>
<a href="#l35.505"></a><span id="l35.505">           if (size &gt; Number.MAX_SAFE_INTEGER)</span>
<a href="#l35.506"></a><span id="l35.506">             size = Number.MAX_SAFE_INTEGER;</span>
<a href="#l35.507"></a><span id="l35.507">         }</span>
<a href="#l35.508"></a><span id="l35.508"> </span>
<a href="#l35.509"></a><span id="l35.509">         // libmime returns -1 if it never managed to figure out the size.</span>
<a href="#l35.510"></a><span id="l35.510">         if (size != -1)</span>
<a href="#l35.511"></a><span id="l35.511">           last.size = size;</span>
<a href="#l35.512"></a><span id="l35.512" class="difflineminus">-      }</span>
<a href="#l35.513"></a><span id="l35.513" class="difflineminus">-      else if (field == &quot;X-Mozilla-PartDownloaded&quot; &amp;&amp; value == &quot;0&quot;) {</span>
<a href="#l35.514"></a><span id="l35.514" class="difflineplus">+      } else if (field == &quot;X-Mozilla-PartDownloaded&quot; &amp;&amp; value == &quot;0&quot;) {</span>
<a href="#l35.515"></a><span id="l35.515">         // We haven't downloaded the attachment, so any size we get from</span>
<a href="#l35.516"></a><span id="l35.516">         // libmime is almost certainly inaccurate. Just get rid of it. (Note:</span>
<a href="#l35.517"></a><span id="l35.517">         // this relies on the fact that PartDownloaded comes after PartSize from</span>
<a href="#l35.518"></a><span id="l35.518">         // the MIME emitter.)</span>
<a href="#l35.519"></a><span id="l35.519">         last.size = null;</span>
<a href="#l35.520"></a><span id="l35.520">       }</span>
<a href="#l35.521"></a><span id="l35.521">     },</span>
<a href="#l35.522"></a><span id="l35.522"> </span>
<a href="#l35.523"></a><span id="l35.523" class="difflineminus">-    onEndAllAttachments: function()</span>
<a href="#l35.524"></a><span id="l35.524" class="difflineminus">-    {</span>
<a href="#l35.525"></a><span id="l35.525" class="difflineplus">+    onEndAllAttachments() {</span>
<a href="#l35.526"></a><span id="l35.526">       displayAttachmentsForExpandedView();</span>
<a href="#l35.527"></a><span id="l35.527"> </span>
<a href="#l35.528"></a><span id="l35.528">       for (let listener of gMessageListeners) {</span>
<a href="#l35.529"></a><span id="l35.529">         if (&quot;onEndAttachments&quot; in listener)</span>
<a href="#l35.530"></a><span id="l35.530">           listener.onEndAttachments();</span>
<a href="#l35.531"></a><span id="l35.531">       }</span>
<a href="#l35.532"></a><span id="l35.532">     },</span>
<a href="#l35.533"></a><span id="l35.533"> </span>
<a href="#l35.534"></a><span id="l35.534">     /**</span>
<a href="#l35.535"></a><span id="l35.535">      * This event is generated by nsMsgStatusFeedback when it gets an</span>
<a href="#l35.536"></a><span id="l35.536">      * OnStateChange event for STATE_STOP.  This is the same event that</span>
<a href="#l35.537"></a><span id="l35.537">      * generates the &quot;msgLoaded&quot; property flag change event.  This best</span>
<a href="#l35.538"></a><span id="l35.538">      * corresponds to the end of the streaming process.</span>
<a href="#l35.539"></a><span id="l35.539">      */</span>
<a href="#l35.540"></a><span id="l35.540" class="difflineminus">-    onEndMsgDownload: function(url)</span>
<a href="#l35.541"></a><span id="l35.541" class="difflineminus">-    {</span>
<a href="#l35.542"></a><span id="l35.542" class="difflineplus">+    onEndMsgDownload(url) {</span>
<a href="#l35.543"></a><span id="l35.543">       gMessageDisplay.onLoadCompleted();</span>
<a href="#l35.544"></a><span id="l35.544"> </span>
<a href="#l35.545"></a><span id="l35.545">       let expanded = Services.prefs.getBoolPref(</span>
<a href="#l35.546"></a><span id="l35.546">         &quot;mailnews.attachments.display.start_expanded&quot;);</span>
<a href="#l35.547"></a><span id="l35.547"> </span>
<a href="#l35.548"></a><span id="l35.548">       if (expanded)</span>
<a href="#l35.549"></a><span id="l35.549">         toggleAttachmentList(true);</span>
<a href="#l35.550"></a><span id="l35.550"> </span>
<a href="#l35.551"></a><span id="l35.551" class="difflineat">@@ -728,66 +698,59 @@ var messageHeaderSink = {</span>
<a href="#l35.552"></a><span id="l35.552">             }</span>
<a href="#l35.553"></a><span id="l35.553">           });</span>
<a href="#l35.554"></a><span id="l35.554">         }</span>
<a href="#l35.555"></a><span id="l35.555">       }</span>
<a href="#l35.556"></a><span id="l35.556"> </span>
<a href="#l35.557"></a><span id="l35.557">       OnMsgParsed(url);</span>
<a href="#l35.558"></a><span id="l35.558">     },</span>
<a href="#l35.559"></a><span id="l35.559"> </span>
<a href="#l35.560"></a><span id="l35.560" class="difflineminus">-    onEndMsgHeaders: function(url)</span>
<a href="#l35.561"></a><span id="l35.561" class="difflineminus">-    {</span>
<a href="#l35.562"></a><span id="l35.562" class="difflineplus">+    onEndMsgHeaders(url) {</span>
<a href="#l35.563"></a><span id="l35.563">       OnMsgLoaded(url);</span>
<a href="#l35.564"></a><span id="l35.564">     },</span>
<a href="#l35.565"></a><span id="l35.565"> </span>
<a href="#l35.566"></a><span id="l35.566" class="difflineminus">-    onMsgHasRemoteContent: function(aMsgHdr, aContentURI, aCanOverride)</span>
<a href="#l35.567"></a><span id="l35.567" class="difflineminus">-    {</span>
<a href="#l35.568"></a><span id="l35.568" class="difflineplus">+    onMsgHasRemoteContent(aMsgHdr, aContentURI, aCanOverride) {</span>
<a href="#l35.569"></a><span id="l35.569">       gMessageNotificationBar.setRemoteContentMsg(aMsgHdr, aContentURI, aCanOverride);</span>
<a href="#l35.570"></a><span id="l35.570">     },</span>
<a href="#l35.571"></a><span id="l35.571"> </span>
<a href="#l35.572"></a><span id="l35.572" class="difflineminus">-    mSecurityInfo  : null,</span>
<a href="#l35.573"></a><span id="l35.573" class="difflineplus">+    mSecurityInfo: null,</span>
<a href="#l35.574"></a><span id="l35.574">     mSaveHdr: null,</span>
<a href="#l35.575"></a><span id="l35.575" class="difflineminus">-    get securityInfo()</span>
<a href="#l35.576"></a><span id="l35.576" class="difflineminus">-    {</span>
<a href="#l35.577"></a><span id="l35.577" class="difflineplus">+    get securityInfo() {</span>
<a href="#l35.578"></a><span id="l35.578">       return this.mSecurityInfo;</span>
<a href="#l35.579"></a><span id="l35.579">     },</span>
<a href="#l35.580"></a><span id="l35.580" class="difflineminus">-    set securityInfo(aSecurityInfo)</span>
<a href="#l35.581"></a><span id="l35.581" class="difflineminus">-    {</span>
<a href="#l35.582"></a><span id="l35.582" class="difflineplus">+    set securityInfo(aSecurityInfo) {</span>
<a href="#l35.583"></a><span id="l35.583">       this.mSecurityInfo = aSecurityInfo;</span>
<a href="#l35.584"></a><span id="l35.584">     },</span>
<a href="#l35.585"></a><span id="l35.585"> </span>
<a href="#l35.586"></a><span id="l35.586">     mDummyMsgHeader: null,</span>
<a href="#l35.587"></a><span id="l35.587"> </span>
<a href="#l35.588"></a><span id="l35.588" class="difflineminus">-    get dummyMsgHeader()</span>
<a href="#l35.589"></a><span id="l35.589" class="difflineminus">-    {</span>
<a href="#l35.590"></a><span id="l35.590" class="difflineplus">+    get dummyMsgHeader() {</span>
<a href="#l35.591"></a><span id="l35.591">       if (!this.mDummyMsgHeader)</span>
<a href="#l35.592"></a><span id="l35.592">         this.mDummyMsgHeader = new nsDummyMsgHeader();</span>
<a href="#l35.593"></a><span id="l35.593">       // The URI resolution will never work on the dummy header;</span>
<a href="#l35.594"></a><span id="l35.594">       // save it now... we know it will be needed eventually.</span>
<a href="#l35.595"></a><span id="l35.595">       // (And save it every time we come through here, not just when</span>
<a href="#l35.596"></a><span id="l35.596">       // we create it; the onStartHeaders might come after creation!)</span>
<a href="#l35.597"></a><span id="l35.597">       this.mSaveHdr = this.mDummyMsgHeader;</span>
<a href="#l35.598"></a><span id="l35.598">       return this.mDummyMsgHeader;</span>
<a href="#l35.599"></a><span id="l35.599">     },</span>
<a href="#l35.600"></a><span id="l35.600">     mProperties: null,</span>
<a href="#l35.601"></a><span id="l35.601" class="difflineminus">-    get properties()</span>
<a href="#l35.602"></a><span id="l35.602" class="difflineminus">-    {</span>
<a href="#l35.603"></a><span id="l35.603" class="difflineplus">+    get properties() {</span>
<a href="#l35.604"></a><span id="l35.604">       if (!this.mProperties)</span>
<a href="#l35.605"></a><span id="l35.605">         this.mProperties = Cc[&quot;@mozilla.org/hash-property-bag;1&quot;].</span>
<a href="#l35.606"></a><span id="l35.606">           createInstance(Ci.nsIWritablePropertyBag2);</span>
<a href="#l35.607"></a><span id="l35.607">       return this.mProperties;</span>
<a href="#l35.608"></a><span id="l35.608">     },</span>
<a href="#l35.609"></a><span id="l35.609"> </span>
<a href="#l35.610"></a><span id="l35.610" class="difflineminus">-    resetProperties: function() {</span>
<a href="#l35.611"></a><span id="l35.611" class="difflineplus">+    resetProperties() {</span>
<a href="#l35.612"></a><span id="l35.612">       this.mProperties = null;</span>
<a href="#l35.613"></a><span id="l35.613" class="difflineminus">-    }</span>
<a href="#l35.614"></a><span id="l35.614" class="difflineplus">+    },</span>
<a href="#l35.615"></a><span id="l35.615"> };</span>
<a href="#l35.616"></a><span id="l35.616"> </span>
<a href="#l35.617"></a><span id="l35.617" class="difflineminus">-function SetTagHeader()</span>
<a href="#l35.618"></a><span id="l35.618" class="difflineminus">-{</span>
<a href="#l35.619"></a><span id="l35.619" class="difflineplus">+function SetTagHeader() {</span>
<a href="#l35.620"></a><span id="l35.620">   // It would be nice if we passed in the msgHdr from the back end.</span>
<a href="#l35.621"></a><span id="l35.621">   var msgHdr = gFolderDisplay.selectedMessage;</span>
<a href="#l35.622"></a><span id="l35.622">   if (!msgHdr)</span>
<a href="#l35.623"></a><span id="l35.623">     return; // no msgHdr to add our tags to</span>
<a href="#l35.624"></a><span id="l35.624"> </span>
<a href="#l35.625"></a><span id="l35.625">   // get the list of known tags</span>
<a href="#l35.626"></a><span id="l35.626">   var tagArray = MailServices.tags.getAllTags({});</span>
<a href="#l35.627"></a><span id="l35.627">   var tagKeys = {};</span>
<a href="#l35.628"></a><span id="l35.628" class="difflineat">@@ -815,28 +778,26 @@ function SetTagHeader()</span>
<a href="#l35.629"></a><span id="l35.629">   var msgKeys = msgKeyArray.join(&quot; &quot;);</span>
<a href="#l35.630"></a><span id="l35.630"> </span>
<a href="#l35.631"></a><span id="l35.631">   if (msgKeys)</span>
<a href="#l35.632"></a><span id="l35.632">     currentHeaderData.tags = {headerName: &quot;tags&quot;, headerValue: msgKeys};</span>
<a href="#l35.633"></a><span id="l35.633">   else // no more tags, so clear out the header field</span>
<a href="#l35.634"></a><span id="l35.634">     delete currentHeaderData.tags;</span>
<a href="#l35.635"></a><span id="l35.635"> }</span>
<a href="#l35.636"></a><span id="l35.636"> </span>
<a href="#l35.637"></a><span id="l35.637" class="difflineminus">-function EnsureSubjectValue()</span>
<a href="#l35.638"></a><span id="l35.638" class="difflineminus">-{</span>
<a href="#l35.639"></a><span id="l35.639" class="difflineplus">+function EnsureSubjectValue() {</span>
<a href="#l35.640"></a><span id="l35.640">   if (!(&quot;subject&quot; in currentHeaderData)) {</span>
<a href="#l35.641"></a><span id="l35.641" class="difflineminus">-    let foo = new Object;</span>
<a href="#l35.642"></a><span id="l35.642" class="difflineplus">+    let foo = {};</span>
<a href="#l35.643"></a><span id="l35.643">     foo.headerValue = &quot;&quot;;</span>
<a href="#l35.644"></a><span id="l35.644">     foo.headerName = &quot;subject&quot;;</span>
<a href="#l35.645"></a><span id="l35.645">     currentHeaderData[foo.headerName] = foo;</span>
<a href="#l35.646"></a><span id="l35.646">   }</span>
<a href="#l35.647"></a><span id="l35.647"> }</span>
<a href="#l35.648"></a><span id="l35.648"> </span>
<a href="#l35.649"></a><span id="l35.649" class="difflineminus">-function OnTagsChange()</span>
<a href="#l35.650"></a><span id="l35.650" class="difflineminus">-{</span>
<a href="#l35.651"></a><span id="l35.651" class="difflineplus">+function OnTagsChange() {</span>
<a href="#l35.652"></a><span id="l35.652">   // rebuild the tag headers</span>
<a href="#l35.653"></a><span id="l35.653">   SetTagHeader();</span>
<a href="#l35.654"></a><span id="l35.654"> </span>
<a href="#l35.655"></a><span id="l35.655">   // Now update the expanded header view to rebuild the tags,</span>
<a href="#l35.656"></a><span id="l35.656">   // and then show or hide the tag header box.</span>
<a href="#l35.657"></a><span id="l35.657">   if (gBuiltExpandedView) {</span>
<a href="#l35.658"></a><span id="l35.658">     let headerEntry = gExpandedHeaderView.tags;</span>
<a href="#l35.659"></a><span id="l35.659">     if (headerEntry) {</span>
<a href="#l35.660"></a><span id="l35.660" class="difflineat">@@ -853,73 +814,69 @@ function OnTagsChange()</span>
<a href="#l35.661"></a><span id="l35.661">   }</span>
<a href="#l35.662"></a><span id="l35.662"> }</span>
<a href="#l35.663"></a><span id="l35.663"> </span>
<a href="#l35.664"></a><span id="l35.664"> /**</span>
<a href="#l35.665"></a><span id="l35.665">  * Flush out any local state being held by a header entry for a given table.</span>
<a href="#l35.666"></a><span id="l35.666">  *</span>
<a href="#l35.667"></a><span id="l35.667">  * @param aHeaderTable Table of header entries</span>
<a href="#l35.668"></a><span id="l35.668">  */</span>
<a href="#l35.669"></a><span id="l35.669" class="difflineminus">-function ClearHeaderView(aHeaderTable)</span>
<a href="#l35.670"></a><span id="l35.670" class="difflineminus">-{</span>
<a href="#l35.671"></a><span id="l35.671" class="difflineplus">+function ClearHeaderView(aHeaderTable) {</span>
<a href="#l35.672"></a><span id="l35.672">   for (let name in aHeaderTable) {</span>
<a href="#l35.673"></a><span id="l35.673">     let headerEntry = aHeaderTable[name];</span>
<a href="#l35.674"></a><span id="l35.674">     if (headerEntry.enclosingBox.clearHeaderValues)</span>
<a href="#l35.675"></a><span id="l35.675">       headerEntry.enclosingBox.clearHeaderValues();</span>
<a href="#l35.676"></a><span id="l35.676"> </span>
<a href="#l35.677"></a><span id="l35.677">     headerEntry.valid = false;</span>
<a href="#l35.678"></a><span id="l35.678">   }</span>
<a href="#l35.679"></a><span id="l35.679"> }</span>
<a href="#l35.680"></a><span id="l35.680"> </span>
<a href="#l35.681"></a><span id="l35.681"> /**</span>
<a href="#l35.682"></a><span id="l35.682">  * Make sure that any valid header entry in the table is collapsed.</span>
<a href="#l35.683"></a><span id="l35.683">  *</span>
<a href="#l35.684"></a><span id="l35.684">  * @param aHeaderTable Table of header entries</span>
<a href="#l35.685"></a><span id="l35.685">  */</span>
<a href="#l35.686"></a><span id="l35.686" class="difflineminus">-function hideHeaderView(aHeaderTable)</span>
<a href="#l35.687"></a><span id="l35.687" class="difflineminus">-{</span>
<a href="#l35.688"></a><span id="l35.688" class="difflineplus">+function hideHeaderView(aHeaderTable) {</span>
<a href="#l35.689"></a><span id="l35.689">   for (let name in aHeaderTable) {</span>
<a href="#l35.690"></a><span id="l35.690">     let headerEntry = aHeaderTable[name];</span>
<a href="#l35.691"></a><span id="l35.691">     headerEntry.enclosingRow.collapsed = true;</span>
<a href="#l35.692"></a><span id="l35.692">   }</span>
<a href="#l35.693"></a><span id="l35.693"> }</span>
<a href="#l35.694"></a><span id="l35.694"> </span>
<a href="#l35.695"></a><span id="l35.695"> /**</span>
<a href="#l35.696"></a><span id="l35.696">  * Make sure that any valid header entry in the table specified is visible.</span>
<a href="#l35.697"></a><span id="l35.697">  *</span>
<a href="#l35.698"></a><span id="l35.698">  * @param aHeaderTable Table of header entries</span>
<a href="#l35.699"></a><span id="l35.699">  */</span>
<a href="#l35.700"></a><span id="l35.700" class="difflineminus">-function showHeaderView(aHeaderTable)</span>
<a href="#l35.701"></a><span id="l35.701" class="difflineminus">-{</span>
<a href="#l35.702"></a><span id="l35.702" class="difflineplus">+function showHeaderView(aHeaderTable) {</span>
<a href="#l35.703"></a><span id="l35.703">   for (let name in aHeaderTable) {</span>
<a href="#l35.704"></a><span id="l35.704">     let headerEntry = aHeaderTable[name];</span>
<a href="#l35.705"></a><span id="l35.705">     if (headerEntry.valid) {</span>
<a href="#l35.706"></a><span id="l35.706">       headerEntry.enclosingRow.collapsed = false;</span>
<a href="#l35.707"></a><span id="l35.707">     } else {</span>
<a href="#l35.708"></a><span id="l35.708">       // if the entry is invalid, always make sure it's collapsed</span>
<a href="#l35.709"></a><span id="l35.709">       headerEntry.enclosingRow.collapsed = true;</span>
<a href="#l35.710"></a><span id="l35.710">     }</span>
<a href="#l35.711"></a><span id="l35.711">   }</span>
<a href="#l35.712"></a><span id="l35.712"> }</span>
<a href="#l35.713"></a><span id="l35.713"> </span>
<a href="#l35.714"></a><span id="l35.714"> /**</span>
<a href="#l35.715"></a><span id="l35.715">  * Enumerate through the list of headers and find the number that are visible</span>
<a href="#l35.716"></a><span id="l35.716">  * add empty entries if we don't have the minimum number of rows.</span>
<a href="#l35.717"></a><span id="l35.717">  */</span>
<a href="#l35.718"></a><span id="l35.718" class="difflineminus">-function EnsureMinimumNumberOfHeaders (headerTable)</span>
<a href="#l35.719"></a><span id="l35.719" class="difflineminus">-{</span>
<a href="#l35.720"></a><span id="l35.720" class="difflineplus">+function EnsureMinimumNumberOfHeaders(headerTable) {</span>
<a href="#l35.721"></a><span id="l35.721">   // 0 means we don't have a minimum... do nothing special</span>
<a href="#l35.722"></a><span id="l35.722">   if (!gMinNumberOfHeaders)</span>
<a href="#l35.723"></a><span id="l35.723">     return;</span>
<a href="#l35.724"></a><span id="l35.724"> </span>
<a href="#l35.725"></a><span id="l35.725">   var numVisibleHeaders = 0;</span>
<a href="#l35.726"></a><span id="l35.726">   for (let name in headerTable) {</span>
<a href="#l35.727"></a><span id="l35.727">     let headerEntry = headerTable[name];</span>
<a href="#l35.728"></a><span id="l35.728">     if (headerEntry.valid)</span>
<a href="#l35.729"></a><span id="l35.729" class="difflineminus">-      numVisibleHeaders ++;</span>
<a href="#l35.730"></a><span id="l35.730" class="difflineplus">+      numVisibleHeaders++;</span>
<a href="#l35.731"></a><span id="l35.731">   }</span>
<a href="#l35.732"></a><span id="l35.732"> </span>
<a href="#l35.733"></a><span id="l35.733">   if (numVisibleHeaders &lt; gMinNumberOfHeaders) {</span>
<a href="#l35.734"></a><span id="l35.734">     // How many empty headers do we need to add?</span>
<a href="#l35.735"></a><span id="l35.735">     var numEmptyHeaders = gMinNumberOfHeaders - numVisibleHeaders;</span>
<a href="#l35.736"></a><span id="l35.736"> </span>
<a href="#l35.737"></a><span id="l35.737">     // We may have already dynamically created our empty rows and we just need</span>
<a href="#l35.738"></a><span id="l35.738">     // to make them visible.</span>
<a href="#l35.739"></a><span id="l35.739" class="difflineat">@@ -944,18 +901,17 @@ function EnsureMinimumNumberOfHeaders (h</span>
<a href="#l35.740"></a><span id="l35.740"> </span>
<a href="#l35.741"></a><span id="l35.741">   }</span>
<a href="#l35.742"></a><span id="l35.742"> }</span>
<a href="#l35.743"></a><span id="l35.743"> </span>
<a href="#l35.744"></a><span id="l35.744"> /**</span>
<a href="#l35.745"></a><span id="l35.745">  * Make sure the appropriate fields in the expanded header view are collapsed</span>
<a href="#l35.746"></a><span id="l35.746">  * or visible...</span>
<a href="#l35.747"></a><span id="l35.747">  */</span>
<a href="#l35.748"></a><span id="l35.748" class="difflineminus">-function updateExpandedView()</span>
<a href="#l35.749"></a><span id="l35.749" class="difflineminus">-{</span>
<a href="#l35.750"></a><span id="l35.750" class="difflineplus">+function updateExpandedView() {</span>
<a href="#l35.751"></a><span id="l35.751">   // If the expanded view isn't selected, don't bother updating it.</span>
<a href="#l35.752"></a><span id="l35.752">   if (document.getElementById(&quot;msgHeaderViewDeck&quot;).selectedIndex != 0)</span>
<a href="#l35.753"></a><span id="l35.753">     return;</span>
<a href="#l35.754"></a><span id="l35.754"> </span>
<a href="#l35.755"></a><span id="l35.755">   if (gMinNumberOfHeaders)</span>
<a href="#l35.756"></a><span id="l35.756">     EnsureMinimumNumberOfHeaders(gExpandedHeaderView);</span>
<a href="#l35.757"></a><span id="l35.757">   showHeaderView(gExpandedHeaderView);</span>
<a href="#l35.758"></a><span id="l35.758"> </span>
<a href="#l35.759"></a><span id="l35.759" class="difflineat">@@ -964,26 +920,27 @@ function updateExpandedView()</span>
<a href="#l35.760"></a><span id="l35.760">   syncGridColumnWidths();</span>
<a href="#l35.761"></a><span id="l35.761"> </span>
<a href="#l35.762"></a><span id="l35.762">   UpdateJunkButton();</span>
<a href="#l35.763"></a><span id="l35.763">   UpdateReplyButtons();</span>
<a href="#l35.764"></a><span id="l35.764">   displayAttachmentsForExpandedView();</span>
<a href="#l35.765"></a><span id="l35.765"> </span>
<a href="#l35.766"></a><span id="l35.766">   try {</span>
<a href="#l35.767"></a><span id="l35.767">     AdjustHeaderView(Services.prefs.getIntPref(&quot;mail.show_headers&quot;));</span>
<a href="#l35.768"></a><span id="l35.768" class="difflineminus">-  } catch (e) { logException(e); }</span>
<a href="#l35.769"></a><span id="l35.769" class="difflineplus">+  } catch (e) {</span>
<a href="#l35.770"></a><span id="l35.770" class="difflineplus">+    logException(e);</span>
<a href="#l35.771"></a><span id="l35.771" class="difflineplus">+  }</span>
<a href="#l35.772"></a><span id="l35.772"> }</span>
<a href="#l35.773"></a><span id="l35.773"> </span>
<a href="#l35.774"></a><span id="l35.774"> /**</span>
<a href="#l35.775"></a><span id="l35.775">  * Ensure that the name columns in both grids are the same size, since the only</span>
<a href="#l35.776"></a><span id="l35.776">  * reason that we're using two grids at all is to workaround the XUL box</span>
<a href="#l35.777"></a><span id="l35.777">  * model's inability to float elements.</span>
<a href="#l35.778"></a><span id="l35.778">  */</span>
<a href="#l35.779"></a><span id="l35.779" class="difflineminus">-function syncGridColumnWidths()</span>
<a href="#l35.780"></a><span id="l35.780" class="difflineminus">-{</span>
<a href="#l35.781"></a><span id="l35.781" class="difflineplus">+function syncGridColumnWidths() {</span>
<a href="#l35.782"></a><span id="l35.782">   let nameColumn = document.getElementById(&quot;expandedHeadersNameColumn&quot;);</span>
<a href="#l35.783"></a><span id="l35.783">   let nameColumn2 = document.getElementById(&quot;expandedHeaders2NameColumn&quot;);</span>
<a href="#l35.784"></a><span id="l35.784"> </span>
<a href="#l35.785"></a><span id="l35.785">   // Reset the minimum widths to 0 so that clientWidth will return the</span>
<a href="#l35.786"></a><span id="l35.786">   // preferred intrinsic width of each column.</span>
<a href="#l35.787"></a><span id="l35.787">   nameColumn.minWidth = nameColumn2.minWidth = 0;</span>
<a href="#l35.788"></a><span id="l35.788"> </span>
<a href="#l35.789"></a><span id="l35.789">   // Set minWidth on the smaller of the two columns to be the width of the</span>
<a href="#l35.790"></a><span id="l35.790" class="difflineat">@@ -996,31 +953,29 @@ function syncGridColumnWidths()</span>
<a href="#l35.791"></a><span id="l35.791"> }</span>
<a href="#l35.792"></a><span id="l35.792"> </span>
<a href="#l35.793"></a><span id="l35.793"> /**</span>
<a href="#l35.794"></a><span id="l35.794">  * Default method for updating a header value into a header entry</span>
<a href="#l35.795"></a><span id="l35.795">  *</span>
<a href="#l35.796"></a><span id="l35.796">  * @param aHeaderEntry  A single header from currentHeaderData</span>
<a href="#l35.797"></a><span id="l35.797">  * @param aHeaderValue  The new value for headerEntry</span>
<a href="#l35.798"></a><span id="l35.798">  */</span>
<a href="#l35.799"></a><span id="l35.799" class="difflineminus">-function updateHeaderValue(aHeaderEntry, aHeaderValue)</span>
<a href="#l35.800"></a><span id="l35.800" class="difflineminus">-{</span>
<a href="#l35.801"></a><span id="l35.801" class="difflineplus">+function updateHeaderValue(aHeaderEntry, aHeaderValue) {</span>
<a href="#l35.802"></a><span id="l35.802">   aHeaderEntry.enclosingBox.headerValue = aHeaderValue;</span>
<a href="#l35.803"></a><span id="l35.803"> }</span>
<a href="#l35.804"></a><span id="l35.804"> </span>
<a href="#l35.805"></a><span id="l35.805"> /**</span>
<a href="#l35.806"></a><span id="l35.806">  * Create the DOM nodes (aka &quot;View&quot;) for a non-standard header and insert them</span>
<a href="#l35.807"></a><span id="l35.807">  * into the grid.  Create and return the corresponding headerEntry object.</span>
<a href="#l35.808"></a><span id="l35.808">  *</span>
<a href="#l35.809"></a><span id="l35.809">  * @param {String} headerName  name of the header we're adding, used to</span>
<a href="#l35.810"></a><span id="l35.810">  *                             construct the element IDs (in lower case)</span>
<a href="#l35.811"></a><span id="l35.811">  * @param {String} label       name of the header as displayed in the UI</span>
<a href="#l35.812"></a><span id="l35.812">  */</span>
<a href="#l35.813"></a><span id="l35.813" class="difflineminus">-function HeaderView(headerName, label)</span>
<a href="#l35.814"></a><span id="l35.814" class="difflineminus">-{</span>
<a href="#l35.815"></a><span id="l35.815" class="difflineplus">+function HeaderView(headerName, label) {</span>
<a href="#l35.816"></a><span id="l35.816">   headerName = headerName.toLowerCase();</span>
<a href="#l35.817"></a><span id="l35.817">   let rowId = &quot;expanded&quot; + headerName + &quot;Row&quot;;</span>
<a href="#l35.818"></a><span id="l35.818">   let idName = &quot;expanded&quot; + headerName + &quot;Box&quot;;</span>
<a href="#l35.819"></a><span id="l35.819">   let newHeaderNode;</span>
<a href="#l35.820"></a><span id="l35.820">   // If a row for this header already exists, do not create another one.</span>
<a href="#l35.821"></a><span id="l35.821">   let newRowNode = document.getElementById(rowId);</span>
<a href="#l35.822"></a><span id="l35.822">   if (!newRowNode) {</span>
<a href="#l35.823"></a><span id="l35.823">     // Create new collapsed row.</span>
<a href="#l35.824"></a><span id="l35.824" class="difflineat">@@ -1059,18 +1014,17 @@ function HeaderView(headerName, label)</span>
<a href="#l35.825"></a><span id="l35.825">   this.outputFunction = updateHeaderValue;</span>
<a href="#l35.826"></a><span id="l35.826"> }</span>
<a href="#l35.827"></a><span id="l35.827"> </span>
<a href="#l35.828"></a><span id="l35.828"> /**</span>
<a href="#l35.829"></a><span id="l35.829">  * Removes all non-predefined header nodes from the view.</span>
<a href="#l35.830"></a><span id="l35.830">  *</span>
<a href="#l35.831"></a><span id="l35.831">  * @param aHeaderTable  Table of header entries.</span>
<a href="#l35.832"></a><span id="l35.832">  */</span>
<a href="#l35.833"></a><span id="l35.833" class="difflineminus">-function RemoveNewHeaderViews(aHeaderTable)</span>
<a href="#l35.834"></a><span id="l35.834" class="difflineminus">-{</span>
<a href="#l35.835"></a><span id="l35.835" class="difflineplus">+function RemoveNewHeaderViews(aHeaderTable) {</span>
<a href="#l35.836"></a><span id="l35.836">   for (let name in aHeaderTable) {</span>
<a href="#l35.837"></a><span id="l35.837">     let headerEntry = aHeaderTable[name];</span>
<a href="#l35.838"></a><span id="l35.838">     if (headerEntry.isNewHeader)</span>
<a href="#l35.839"></a><span id="l35.839">       headerEntry.enclosingRow.remove();</span>
<a href="#l35.840"></a><span id="l35.840">   }</span>
<a href="#l35.841"></a><span id="l35.841"> }</span>
<a href="#l35.842"></a><span id="l35.842"> </span>
<a href="#l35.843"></a><span id="l35.843"> /**</span>
<a href="#l35.844"></a><span id="l35.844" class="difflineat">@@ -1102,24 +1056,23 @@ function UpdateExpandedMessageHeaders() </span>
<a href="#l35.845"></a><span id="l35.845">         headerEntry = gExpandedHeaderView[headerName];</span>
<a href="#l35.846"></a><span id="l35.846"> </span>
<a href="#l35.847"></a><span id="l35.847">     if (!headerEntry &amp;&amp; gViewAllHeaders) {</span>
<a href="#l35.848"></a><span id="l35.848">       // for view all headers, if we don't have a header field for this</span>
<a href="#l35.849"></a><span id="l35.849">       // value....cheat and create one....then fill in a headerEntry</span>
<a href="#l35.850"></a><span id="l35.850">       if (headerName == &quot;message-id&quot; || headerName == &quot;in-reply-to&quot;) {</span>
<a href="#l35.851"></a><span id="l35.851">         var messageIdEntry = {</span>
<a href="#l35.852"></a><span id="l35.852">           name: headerName,</span>
<a href="#l35.853"></a><span id="l35.853" class="difflineminus">-          outputFunction: OutputMessageIds</span>
<a href="#l35.854"></a><span id="l35.854" class="difflineplus">+          outputFunction: OutputMessageIds,</span>
<a href="#l35.855"></a><span id="l35.855">         };</span>
<a href="#l35.856"></a><span id="l35.856">         gExpandedHeaderView[headerName] = new createHeaderEntry(&quot;expanded&quot;,</span>
<a href="#l35.857"></a><span id="l35.857">                                                                 messageIdEntry);</span>
<a href="#l35.858"></a><span id="l35.858" class="difflineminus">-      }</span>
<a href="#l35.859"></a><span id="l35.859" class="difflineminus">-      // Don't bother showing X-Mozilla-LocalizedDate, since that value is</span>
<a href="#l35.860"></a><span id="l35.860" class="difflineminus">-      // displayed below the message header toolbar.</span>
<a href="#l35.861"></a><span id="l35.861" class="difflineminus">-      else if (headerName != &quot;x-mozilla-localizeddate&quot;) {</span>
<a href="#l35.862"></a><span id="l35.862" class="difflineplus">+      } else if (headerName != &quot;x-mozilla-localizeddate&quot;) {</span>
<a href="#l35.863"></a><span id="l35.863" class="difflineplus">+        // Don't bother showing X-Mozilla-LocalizedDate, since that value is</span>
<a href="#l35.864"></a><span id="l35.864" class="difflineplus">+        // displayed below the message header toolbar.</span>
<a href="#l35.865"></a><span id="l35.865">         gExpandedHeaderView[headerName] =</span>
<a href="#l35.866"></a><span id="l35.866">           new HeaderView(headerName, currentHeaderData[headerName].headerName);</span>
<a href="#l35.867"></a><span id="l35.867">       }</span>
<a href="#l35.868"></a><span id="l35.868"> </span>
<a href="#l35.869"></a><span id="l35.869">       headerEntry = gExpandedHeaderView[headerName];</span>
<a href="#l35.870"></a><span id="l35.870">     }</span>
<a href="#l35.871"></a><span id="l35.871"> </span>
<a href="#l35.872"></a><span id="l35.872">     if (headerEntry) {</span>
<a href="#l35.873"></a><span id="l35.873" class="difflineat">@@ -1147,29 +1100,26 @@ function UpdateExpandedMessageHeaders() </span>
<a href="#l35.874"></a><span id="l35.874">   }</span>
<a href="#l35.875"></a><span id="l35.875"> </span>
<a href="#l35.876"></a><span id="l35.876">   gBuiltExpandedView = true;</span>
<a href="#l35.877"></a><span id="l35.877"> </span>
<a href="#l35.878"></a><span id="l35.878">   // Now update the view to make sure the right elements are visible.</span>
<a href="#l35.879"></a><span id="l35.879">   updateExpandedView();</span>
<a href="#l35.880"></a><span id="l35.880"> }</span>
<a href="#l35.881"></a><span id="l35.881"> </span>
<a href="#l35.882"></a><span id="l35.882" class="difflineminus">-function ClearCurrentHeaders()</span>
<a href="#l35.883"></a><span id="l35.883" class="difflineminus">-{</span>
<a href="#l35.884"></a><span id="l35.884" class="difflineplus">+function ClearCurrentHeaders() {</span>
<a href="#l35.885"></a><span id="l35.885">   currentHeaderData = {};</span>
<a href="#l35.886"></a><span id="l35.886" class="difflineminus">-  currentAttachments = new Array();</span>
<a href="#l35.887"></a><span id="l35.887" class="difflineplus">+  currentAttachments = [];</span>
<a href="#l35.888"></a><span id="l35.888"> }</span>
<a href="#l35.889"></a><span id="l35.889"> </span>
<a href="#l35.890"></a><span id="l35.890" class="difflineminus">-function ShowMessageHeaderPane()</span>
<a href="#l35.891"></a><span id="l35.891" class="difflineminus">-{</span>
<a href="#l35.892"></a><span id="l35.892" class="difflineplus">+function ShowMessageHeaderPane() {</span>
<a href="#l35.893"></a><span id="l35.893">   document.getElementById(&quot;msgHeaderView&quot;).collapsed = false;</span>
<a href="#l35.894"></a><span id="l35.894"> }</span>
<a href="#l35.895"></a><span id="l35.895"> </span>
<a href="#l35.896"></a><span id="l35.896" class="difflineminus">-function HideMessageHeaderPane()</span>
<a href="#l35.897"></a><span id="l35.897" class="difflineminus">-{</span>
<a href="#l35.898"></a><span id="l35.898" class="difflineplus">+function HideMessageHeaderPane() {</span>
<a href="#l35.899"></a><span id="l35.899">   document.getElementById(&quot;msgHeaderView&quot;).collapsed = true;</span>
<a href="#l35.900"></a><span id="l35.900"> </span>
<a href="#l35.901"></a><span id="l35.901">   // Disable the Message/Attachments menuitem.</span>
<a href="#l35.902"></a><span id="l35.902">   document.getElementById(&quot;msgAttachmentMenu&quot;).setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l35.903"></a><span id="l35.903"> </span>
<a href="#l35.904"></a><span id="l35.904">   // If the App Menu is being used, disable the attachment menu in there as</span>
<a href="#l35.905"></a><span id="l35.905">   // well.</span>
<a href="#l35.906"></a><span id="l35.906">   let appMenuNode = document.getElementById(&quot;appmenu_msgAttachmentMenu&quot;);</span>
<a href="#l35.907"></a><span id="l35.907" class="difflineat">@@ -1186,31 +1136,29 @@ function HideMessageHeaderPane()</span>
<a href="#l35.908"></a><span id="l35.908"> /**</span>
<a href="#l35.909"></a><span id="l35.909">  * Take string of newsgroups separated by commas, split it</span>
<a href="#l35.910"></a><span id="l35.910">  * into newsgroups and send them to the corresponding</span>
<a href="#l35.911"></a><span id="l35.911">  * mail-newsgroups-headerfield element.</span>
<a href="#l35.912"></a><span id="l35.912">  *</span>
<a href="#l35.913"></a><span id="l35.913">  * @param headerEntry  the entry data structure for this header</span>
<a href="#l35.914"></a><span id="l35.914">  * @param headerValue  the string value for the header from the message</span>
<a href="#l35.915"></a><span id="l35.915">  */</span>
<a href="#l35.916"></a><span id="l35.916" class="difflineminus">-function OutputNewsgroups(headerEntry, headerValue)</span>
<a href="#l35.917"></a><span id="l35.917" class="difflineminus">-{</span>
<a href="#l35.918"></a><span id="l35.918" class="difflineplus">+function OutputNewsgroups(headerEntry, headerValue) {</span>
<a href="#l35.919"></a><span id="l35.919">   headerValue.split(&quot;,&quot;).forEach(</span>
<a href="#l35.920"></a><span id="l35.920">     newsgroup =&gt; headerEntry.enclosingBox.addNewsgroupView(newsgroup));</span>
<a href="#l35.921"></a><span id="l35.921"> </span>
<a href="#l35.922"></a><span id="l35.922">   headerEntry.enclosingBox.buildViews();</span>
<a href="#l35.923"></a><span id="l35.923"> }</span>
<a href="#l35.924"></a><span id="l35.924"> </span>
<a href="#l35.925"></a><span id="l35.925"> /**</span>
<a href="#l35.926"></a><span id="l35.926">  * Take string of message-ids separated by whitespace, split it</span>
<a href="#l35.927"></a><span id="l35.927">  * into message-ids and send them together with the index number</span>
<a href="#l35.928"></a><span id="l35.928">  * to the corresponding mail-messageids-headerfield element.</span>
<a href="#l35.929"></a><span id="l35.929">  */</span>
<a href="#l35.930"></a><span id="l35.930" class="difflineminus">-function OutputMessageIds(headerEntry, headerValue)</span>
<a href="#l35.931"></a><span id="l35.931" class="difflineminus">-{</span>
<a href="#l35.932"></a><span id="l35.932" class="difflineplus">+function OutputMessageIds(headerEntry, headerValue) {</span>
<a href="#l35.933"></a><span id="l35.933">   let messageIdArray = headerValue.split(/\s+/);</span>
<a href="#l35.934"></a><span id="l35.934"> </span>
<a href="#l35.935"></a><span id="l35.935">   headerEntry.enclosingBox.clearHeaderValues();</span>
<a href="#l35.936"></a><span id="l35.936">   for (let i = 0; i &lt; messageIdArray.length; i++)</span>
<a href="#l35.937"></a><span id="l35.937">     headerEntry.enclosingBox.addMessageIdView(messageIdArray[i]);</span>
<a href="#l35.938"></a><span id="l35.938"> </span>
<a href="#l35.939"></a><span id="l35.939">   headerEntry.enclosingBox.fillMessageIdNodes();</span>
<a href="#l35.940"></a><span id="l35.940"> }</span>
<a href="#l35.941"></a><span id="l35.941" class="difflineat">@@ -1220,18 +1168,17 @@ function OutputMessageIds(headerEntry, h</span>
<a href="#l35.942"></a><span id="l35.942">  * addresses, extracts them one by one, linkifying each email address into</span>
<a href="#l35.943"></a><span id="l35.943">  * a mailto url. Then we add the link-ified email address to the parentDiv</span>
<a href="#l35.944"></a><span id="l35.944">  * passed in.</span>
<a href="#l35.945"></a><span id="l35.945">  *</span>
<a href="#l35.946"></a><span id="l35.946">  * @param headerEntry     parent div</span>
<a href="#l35.947"></a><span id="l35.947">  * @param emailAddresses  comma separated list of the addresses for this</span>
<a href="#l35.948"></a><span id="l35.948">  *                        header field</span>
<a href="#l35.949"></a><span id="l35.949">  */</span>
<a href="#l35.950"></a><span id="l35.950" class="difflineminus">-function OutputEmailAddresses(headerEntry, emailAddresses)</span>
<a href="#l35.951"></a><span id="l35.951" class="difflineminus">-{</span>
<a href="#l35.952"></a><span id="l35.952" class="difflineplus">+function OutputEmailAddresses(headerEntry, emailAddresses) {</span>
<a href="#l35.953"></a><span id="l35.953">   if (!emailAddresses)</span>
<a href="#l35.954"></a><span id="l35.954">     return;</span>
<a href="#l35.955"></a><span id="l35.955"> </span>
<a href="#l35.956"></a><span id="l35.956">   var addresses = {};</span>
<a href="#l35.957"></a><span id="l35.957">   var fullNames = {};</span>
<a href="#l35.958"></a><span id="l35.958">   var names = {};</span>
<a href="#l35.959"></a><span id="l35.959">   var numAddresses =  0;</span>
<a href="#l35.960"></a><span id="l35.960"> </span>
<a href="#l35.961"></a><span id="l35.961" class="difflineat">@@ -1266,18 +1213,17 @@ function OutputEmailAddresses(headerEntr</span>
<a href="#l35.962"></a><span id="l35.962"> </span>
<a href="#l35.963"></a><span id="l35.963">     index++;</span>
<a href="#l35.964"></a><span id="l35.964">   }</span>
<a href="#l35.965"></a><span id="l35.965"> </span>
<a href="#l35.966"></a><span id="l35.966">   if (headerEntry.useToggle)</span>
<a href="#l35.967"></a><span id="l35.967">     headerEntry.enclosingBox.buildViews();</span>
<a href="#l35.968"></a><span id="l35.968"> }</span>
<a href="#l35.969"></a><span id="l35.969"> </span>
<a href="#l35.970"></a><span id="l35.970" class="difflineminus">-function updateEmailAddressNode(emailAddressNode, address)</span>
<a href="#l35.971"></a><span id="l35.971" class="difflineminus">-{</span>
<a href="#l35.972"></a><span id="l35.972" class="difflineplus">+function updateEmailAddressNode(emailAddressNode, address) {</span>
<a href="#l35.973"></a><span id="l35.973">   emailAddressNode.setAttribute(&quot;emailAddress&quot;, address.emailAddress || &quot;&quot;);</span>
<a href="#l35.974"></a><span id="l35.974">   emailAddressNode.setAttribute(&quot;fullAddress&quot;, address.fullAddress || &quot;&quot;);</span>
<a href="#l35.975"></a><span id="l35.975">   emailAddressNode.setAttribute(&quot;displayName&quot;, address.displayName || &quot;&quot;);</span>
<a href="#l35.976"></a><span id="l35.976"> </span>
<a href="#l35.977"></a><span id="l35.977">   if (address.emailAddress)</span>
<a href="#l35.978"></a><span id="l35.978">     UpdateEmailNodeDetails(address.emailAddress, emailAddressNode);</span>
<a href="#l35.979"></a><span id="l35.979"> }</span>
<a href="#l35.980"></a><span id="l35.980"> </span>
<a href="#l35.981"></a><span id="l35.981" class="difflineat">@@ -1327,18 +1273,17 @@ function UpdateEmailNodeDetails(aEmailAd</span>
<a href="#l35.982"></a><span id="l35.982">     aDocumentNode.chatContact = chatContact;</span>
<a href="#l35.983"></a><span id="l35.983">     aDocumentNode.chatContactObserver = function(aSubject, aTopic, aData) {</span>
<a href="#l35.984"></a><span id="l35.984">       if (aTopic == &quot;contact-removed&quot;) {</span>
<a href="#l35.985"></a><span id="l35.985">         this.chatContact.removeObserver(this.chatContactObserver);</span>
<a href="#l35.986"></a><span id="l35.986">         delete this.chatContact;</span>
<a href="#l35.987"></a><span id="l35.987">         delete this.chatContactObserver;</span>
<a href="#l35.988"></a><span id="l35.988">         this.removeAttribute(&quot;chatStatus&quot;);</span>
<a href="#l35.989"></a><span id="l35.989">         this.removeAttribute(&quot;presenceTooltip&quot;);</span>
<a href="#l35.990"></a><span id="l35.990" class="difflineminus">-      }</span>
<a href="#l35.991"></a><span id="l35.991" class="difflineminus">-      else if (aTopic == &quot;contact-status-changed&quot;) {</span>
<a href="#l35.992"></a><span id="l35.992" class="difflineplus">+      } else if (aTopic == &quot;contact-status-changed&quot;) {</span>
<a href="#l35.993"></a><span id="l35.993">         UpdateEmailPresenceDetails(this, this.chatContact);</span>
<a href="#l35.994"></a><span id="l35.994">       }</span>
<a href="#l35.995"></a><span id="l35.995">     }.bind(aDocumentNode);</span>
<a href="#l35.996"></a><span id="l35.996">     chatContact.addObserver(aDocumentNode.chatContactObserver);</span>
<a href="#l35.997"></a><span id="l35.997">   }</span>
<a href="#l35.998"></a><span id="l35.998">   UpdateEmailPresenceDetails(aDocumentNode, chatContact);</span>
<a href="#l35.999"></a><span id="l35.999"> </span>
<a href="#l35.1000"></a><span id="l35.1000">   // When we are adding cards, we don't want to move the display around if the</span>
<a href="#l35.1001"></a><span id="l35.1001" class="difflineat">@@ -1383,18 +1328,17 @@ function UpdateEmailPresenceDetails(aDoc</span>
<a href="#l35.1002"></a><span id="l35.1002">                     statusUtils.toLabel(aChatContact.statusType);</span>
<a href="#l35.1003"></a><span id="l35.1003">   let statusText = aChatContact.statusText;</span>
<a href="#l35.1004"></a><span id="l35.1004">   if (statusText)</span>
<a href="#l35.1005"></a><span id="l35.1005">     tooltipText += &quot; - &quot; + statusText;</span>
<a href="#l35.1006"></a><span id="l35.1006">   aDocumentNode.setAttribute(&quot;presenceTooltip&quot;, tooltipText);</span>
<a href="#l35.1007"></a><span id="l35.1007"> }</span>
<a href="#l35.1008"></a><span id="l35.1008"> </span>
<a href="#l35.1009"></a><span id="l35.1009"> function UpdateExtraAddressProcessing(aAddressData, aDocumentNode, aAction,</span>
<a href="#l35.1010"></a><span id="l35.1010" class="difflineminus">-                                      aParentDir, aItem)</span>
<a href="#l35.1011"></a><span id="l35.1011" class="difflineminus">-{</span>
<a href="#l35.1012"></a><span id="l35.1012" class="difflineplus">+                                      aParentDir, aItem) {</span>
<a href="#l35.1013"></a><span id="l35.1013">   switch (aAction) {</span>
<a href="#l35.1014"></a><span id="l35.1014">   case nsIAbListener.itemChanged:</span>
<a href="#l35.1015"></a><span id="l35.1015">     if (aAddressData &amp;&amp;</span>
<a href="#l35.1016"></a><span id="l35.1016">         aDocumentNode.cardDetails.card &amp;&amp;</span>
<a href="#l35.1017"></a><span id="l35.1017">         aItem.hasEmailAddress(aAddressData.emailAddress)) {</span>
<a href="#l35.1018"></a><span id="l35.1018">       aDocumentNode.cardDetails.card = aItem;</span>
<a href="#l35.1019"></a><span id="l35.1019">       var displayName = DisplayNameUtils.formatDisplayName(</span>
<a href="#l35.1020"></a><span id="l35.1020">         aAddressData.emailAddress,</span>
<a href="#l35.1021"></a><span id="l35.1021" class="difflineat">@@ -1414,18 +1358,17 @@ function UpdateExtraAddressProcessing(aA</span>
<a href="#l35.1022"></a><span id="l35.1022">     break;</span>
<a href="#l35.1023"></a><span id="l35.1023">   case nsIAbListener.itemAdded:</span>
<a href="#l35.1024"></a><span id="l35.1024">     // Is it a new address book?</span>
<a href="#l35.1025"></a><span id="l35.1025">     if (aItem instanceof nsIAbDirectory) {</span>
<a href="#l35.1026"></a><span id="l35.1026">       // If we don't have a match, search again for updates (e.g. a interface</span>
<a href="#l35.1027"></a><span id="l35.1027">       // to an existing book may just have been added).</span>
<a href="#l35.1028"></a><span id="l35.1028">       if (!aDocumentNode.cardDetails.card)</span>
<a href="#l35.1029"></a><span id="l35.1029">         UpdateEmailNodeDetails(aAddressData.emailAddress, aDocumentNode);</span>
<a href="#l35.1030"></a><span id="l35.1030" class="difflineminus">-    }</span>
<a href="#l35.1031"></a><span id="l35.1031" class="difflineminus">-    else if (aItem instanceof nsIAbCard) {</span>
<a href="#l35.1032"></a><span id="l35.1032" class="difflineplus">+    } else if (aItem instanceof nsIAbCard) {</span>
<a href="#l35.1033"></a><span id="l35.1033">       // If we don't have a card, does this new one match?</span>
<a href="#l35.1034"></a><span id="l35.1034">       if (aDocumentNode.cardDetails &amp;&amp; !aDocumentNode.cardDetails.card &amp;&amp;</span>
<a href="#l35.1035"></a><span id="l35.1035">           aItem.hasEmailAddress(aAddressData.emailAddress)) {</span>
<a href="#l35.1036"></a><span id="l35.1036">         // Just in case we have a bogus parent directory.</span>
<a href="#l35.1037"></a><span id="l35.1037">         if (aParentDir instanceof nsIAbDirectory) {</span>
<a href="#l35.1038"></a><span id="l35.1038">           var cardDetails = { book: aParentDir, card: aItem };</span>
<a href="#l35.1039"></a><span id="l35.1039">           UpdateEmailNodeDetails(aAddressData.emailAddress, aDocumentNode,</span>
<a href="#l35.1040"></a><span id="l35.1040">                                  cardDetails);</span>
<a href="#l35.1041"></a><span id="l35.1041" class="difflineat">@@ -1446,43 +1389,40 @@ function UpdateExtraAddressProcessing(aA</span>
<a href="#l35.1042"></a><span id="l35.1042">     break;</span>
<a href="#l35.1043"></a><span id="l35.1043">   case nsIAbListener.directoryRemoved:</span>
<a href="#l35.1044"></a><span id="l35.1044">     if (aDocumentNode.cardDetails.book == aItem)</span>
<a href="#l35.1045"></a><span id="l35.1045">       UpdateEmailNodeDetails(aAddressData.emailAddress, aDocumentNode);</span>
<a href="#l35.1046"></a><span id="l35.1046">     break;</span>
<a href="#l35.1047"></a><span id="l35.1047">   }</span>
<a href="#l35.1048"></a><span id="l35.1048"> }</span>
<a href="#l35.1049"></a><span id="l35.1049"> </span>
<a href="#l35.1050"></a><span id="l35.1050" class="difflineminus">-function findEmailNodeFromPopupNode(elt, popup)</span>
<a href="#l35.1051"></a><span id="l35.1051" class="difflineminus">-{</span>
<a href="#l35.1052"></a><span id="l35.1052" class="difflineplus">+function findEmailNodeFromPopupNode(elt, popup) {</span>
<a href="#l35.1053"></a><span id="l35.1053">   // This annoying little function is needed because in the binding for</span>
<a href="#l35.1054"></a><span id="l35.1054">   // mail-emailaddress, we set the context on the &lt;description&gt;, but that if</span>
<a href="#l35.1055"></a><span id="l35.1055">   // the user clicks on the label, then popupNode is set to it, rather than</span>
<a href="#l35.1056"></a><span id="l35.1056">   // the description.  So we have walk up the parent until we find the</span>
<a href="#l35.1057"></a><span id="l35.1057">   // element with the popup set, and then return its parent.</span>
<a href="#l35.1058"></a><span id="l35.1058"> </span>
<a href="#l35.1059"></a><span id="l35.1059">   while (elt.getAttribute(&quot;popup&quot;) != popup) {</span>
<a href="#l35.1060"></a><span id="l35.1060">     elt = elt.parentNode;</span>
<a href="#l35.1061"></a><span id="l35.1061">     if (elt == null)</span>
<a href="#l35.1062"></a><span id="l35.1062">       return null;</span>
<a href="#l35.1063"></a><span id="l35.1063">   }</span>
<a href="#l35.1064"></a><span id="l35.1064">   return elt.parentNode;</span>
<a href="#l35.1065"></a><span id="l35.1065"> }</span>
<a href="#l35.1066"></a><span id="l35.1066"> </span>
<a href="#l35.1067"></a><span id="l35.1067" class="difflineminus">-function hideEmailNewsPopup(addressNode)</span>
<a href="#l35.1068"></a><span id="l35.1068" class="difflineminus">-{</span>
<a href="#l35.1069"></a><span id="l35.1069" class="difflineplus">+function hideEmailNewsPopup(addressNode) {</span>
<a href="#l35.1070"></a><span id="l35.1070">   addressNode = addressNode.hasAttribute(&quot;newsgroup&quot;) ?</span>
<a href="#l35.1071"></a><span id="l35.1071">                   addressNode.closest(&quot;mail-newsgroup&quot;) :</span>
<a href="#l35.1072"></a><span id="l35.1072">                   addressNode.closest(&quot;mail-emailaddress&quot;);</span>
<a href="#l35.1073"></a><span id="l35.1073">   // highlight the emailBox/newsgroupBox</span>
<a href="#l35.1074"></a><span id="l35.1074">   addressNode.removeAttribute(&quot;selected&quot;);</span>
<a href="#l35.1075"></a><span id="l35.1075"> }</span>
<a href="#l35.1076"></a><span id="l35.1076"> </span>
<a href="#l35.1077"></a><span id="l35.1077" class="difflineminus">-function setupEmailAddressPopup(emailAddressNode)</span>
<a href="#l35.1078"></a><span id="l35.1078" class="difflineminus">-{</span>
<a href="#l35.1079"></a><span id="l35.1079" class="difflineplus">+function setupEmailAddressPopup(emailAddressNode) {</span>
<a href="#l35.1080"></a><span id="l35.1080">   emailAddressNode = emailAddressNode.closest(&quot;mail-emailaddress&quot;);</span>
<a href="#l35.1081"></a><span id="l35.1081">   emailAddressNode.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l35.1082"></a><span id="l35.1082">   var emailAddressPlaceHolder = document.getElementById(&quot;emailAddressPlaceHolder&quot;);</span>
<a href="#l35.1083"></a><span id="l35.1083">   emailAddressPlaceHolder.setAttribute(&quot;label&quot;, emailAddressNode.getAttribute(&quot;label&quot;));</span>
<a href="#l35.1084"></a><span id="l35.1084"> </span>
<a href="#l35.1085"></a><span id="l35.1085">   if (emailAddressNode.cardDetails &amp;&amp; emailAddressNode.cardDetails.card) {</span>
<a href="#l35.1086"></a><span id="l35.1086">     document.getElementById(&quot;addToAddressBookItem&quot;).setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l35.1087"></a><span id="l35.1087">     if (!emailAddressNode.cardDetails.book.readOnly) {</span>
<a href="#l35.1088"></a><span id="l35.1088" class="difflineat">@@ -1494,45 +1434,43 @@ function setupEmailAddressPopup(emailAdd</span>
<a href="#l35.1089"></a><span id="l35.1089">     }</span>
<a href="#l35.1090"></a><span id="l35.1090">   } else {</span>
<a href="#l35.1091"></a><span id="l35.1091">     document.getElementById(&quot;addToAddressBookItem&quot;).removeAttribute(&quot;hidden&quot;);</span>
<a href="#l35.1092"></a><span id="l35.1092">     document.getElementById(&quot;editContactItem&quot;).setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l35.1093"></a><span id="l35.1093">     document.getElementById(&quot;viewContactItem&quot;).setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l35.1094"></a><span id="l35.1094">   }</span>
<a href="#l35.1095"></a><span id="l35.1095"> }</span>
<a href="#l35.1096"></a><span id="l35.1096"> </span>
<a href="#l35.1097"></a><span id="l35.1097" class="difflineminus">-function onClickEmailStar(event, emailAddressNode)</span>
<a href="#l35.1098"></a><span id="l35.1098" class="difflineminus">-{</span>
<a href="#l35.1099"></a><span id="l35.1099" class="difflineplus">+function onClickEmailStar(event, emailAddressNode) {</span>
<a href="#l35.1100"></a><span id="l35.1100">   // Only care about left-click events</span>
<a href="#l35.1101"></a><span id="l35.1101">   if (event.button != 0)</span>
<a href="#l35.1102"></a><span id="l35.1102">     return;</span>
<a href="#l35.1103"></a><span id="l35.1103"> </span>
<a href="#l35.1104"></a><span id="l35.1104">   if (emailAddressNode &amp;&amp; emailAddressNode.cardDetails &amp;&amp;</span>
<a href="#l35.1105"></a><span id="l35.1105">       emailAddressNode.cardDetails.card) {</span>
<a href="#l35.1106"></a><span id="l35.1106">     EditContact(emailAddressNode);</span>
<a href="#l35.1107"></a><span id="l35.1107">   } else {</span>
<a href="#l35.1108"></a><span id="l35.1108">     AddContact(emailAddressNode);</span>
<a href="#l35.1109"></a><span id="l35.1109">   }</span>
<a href="#l35.1110"></a><span id="l35.1110"> }</span>
<a href="#l35.1111"></a><span id="l35.1111"> </span>
<a href="#l35.1112"></a><span id="l35.1112" class="difflineminus">-function onClickEmailPresence(event, emailAddressNode)</span>
<a href="#l35.1113"></a><span id="l35.1113" class="difflineminus">-{</span>
<a href="#l35.1114"></a><span id="l35.1114" class="difflineplus">+function onClickEmailPresence(event, emailAddressNode) {</span>
<a href="#l35.1115"></a><span id="l35.1115">   // Only care about left-click events</span>
<a href="#l35.1116"></a><span id="l35.1116">   if (event.button != 0)</span>
<a href="#l35.1117"></a><span id="l35.1117">     return;</span>
<a href="#l35.1118"></a><span id="l35.1118"> </span>
<a href="#l35.1119"></a><span id="l35.1119">   let prplConv = emailAddressNode.chatContact.createConversation();</span>
<a href="#l35.1120"></a><span id="l35.1120">   let uiConv = Services.conversations.getUIConversation(prplConv);</span>
<a href="#l35.1121"></a><span id="l35.1121"> </span>
<a href="#l35.1122"></a><span id="l35.1122">   let win = window;</span>
<a href="#l35.1123"></a><span id="l35.1123">   if (!(&quot;focusConversation&quot; in chatHandler)) {</span>
<a href="#l35.1124"></a><span id="l35.1124">     win = Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l35.1125"></a><span id="l35.1125" class="difflineminus">-    if (win)</span>
<a href="#l35.1126"></a><span id="l35.1126" class="difflineplus">+    if (win) {</span>
<a href="#l35.1127"></a><span id="l35.1127">       win.focus();</span>
<a href="#l35.1128"></a><span id="l35.1128" class="difflineminus">-    else {</span>
<a href="#l35.1129"></a><span id="l35.1129" class="difflineplus">+    } else {</span>
<a href="#l35.1130"></a><span id="l35.1130">       window.openDialog(&quot;chrome://messenger/content/&quot;, &quot;_blank&quot;,</span>
<a href="#l35.1131"></a><span id="l35.1131">                         &quot;chrome,extrachrome,menubar,resizable,scrollbars,status,toolbar&quot;, null,</span>
<a href="#l35.1132"></a><span id="l35.1132">                         {tabType: &quot;chat&quot;,</span>
<a href="#l35.1133"></a><span id="l35.1133">                          tabParams: {convType: &quot;focus&quot;, conv: uiConv}});</span>
<a href="#l35.1134"></a><span id="l35.1134">       return;</span>
<a href="#l35.1135"></a><span id="l35.1135">     }</span>
<a href="#l35.1136"></a><span id="l35.1136">   }</span>
<a href="#l35.1137"></a><span id="l35.1137"> </span>
<a href="#l35.1138"></a><span id="l35.1138" class="difflineat">@@ -1541,18 +1479,17 @@ function onClickEmailPresence(event, ema</span>
<a href="#l35.1139"></a><span id="l35.1139"> }</span>
<a href="#l35.1140"></a><span id="l35.1140"> </span>
<a href="#l35.1141"></a><span id="l35.1141"> /**</span>
<a href="#l35.1142"></a><span id="l35.1142">  * Takes the email address node, adds a new contact from the node's</span>
<a href="#l35.1143"></a><span id="l35.1143">  * displayName and emailAddress attributes to the personal address book.</span>
<a href="#l35.1144"></a><span id="l35.1144">  *</span>
<a href="#l35.1145"></a><span id="l35.1145">  * @param emailAddressNode  a node with displayName and emailAddress attributes</span>
<a href="#l35.1146"></a><span id="l35.1146">  */</span>
<a href="#l35.1147"></a><span id="l35.1147" class="difflineminus">-function AddContact(emailAddressNode)</span>
<a href="#l35.1148"></a><span id="l35.1148" class="difflineminus">-{</span>
<a href="#l35.1149"></a><span id="l35.1149" class="difflineplus">+function AddContact(emailAddressNode) {</span>
<a href="#l35.1150"></a><span id="l35.1150">   emailAddressNode = emailAddressNode.closest(&quot;mail-emailaddress&quot;);</span>
<a href="#l35.1151"></a><span id="l35.1151">   // When we collect an address, it updates the AB which sends out</span>
<a href="#l35.1152"></a><span id="l35.1152">   // notifications to update the UI. In the add case we don't want to update</span>
<a href="#l35.1153"></a><span id="l35.1153">   // the UI so that accidentally double-clicking on the star doesn't lead</span>
<a href="#l35.1154"></a><span id="l35.1154">   // to something strange (i.e star would be moved out from underneath,</span>
<a href="#l35.1155"></a><span id="l35.1155">   // leaving something else there).</span>
<a href="#l35.1156"></a><span id="l35.1156">   emailAddressNode.setAttribute(&quot;updatingUI&quot;, true);</span>
<a href="#l35.1157"></a><span id="l35.1157"> </span>
<a href="#l35.1158"></a><span id="l35.1158" class="difflineat">@@ -1565,33 +1502,31 @@ function AddContact(emailAddressNode)</span>
<a href="#l35.1159"></a><span id="l35.1159">   card.primaryEmail = emailAddressNode.getAttribute(&quot;emailAddress&quot;);</span>
<a href="#l35.1160"></a><span id="l35.1160"> </span>
<a href="#l35.1161"></a><span id="l35.1161">   // Just save the new node straight away.</span>
<a href="#l35.1162"></a><span id="l35.1162">   addressBook.addCard(card);</span>
<a href="#l35.1163"></a><span id="l35.1163"> </span>
<a href="#l35.1164"></a><span id="l35.1164">   emailAddressNode.removeAttribute(&quot;updatingUI&quot;);</span>
<a href="#l35.1165"></a><span id="l35.1165"> }</span>
<a href="#l35.1166"></a><span id="l35.1166"> </span>
<a href="#l35.1167"></a><span id="l35.1167" class="difflineminus">-function EditContact(emailAddressNode)</span>
<a href="#l35.1168"></a><span id="l35.1168" class="difflineminus">-{</span>
<a href="#l35.1169"></a><span id="l35.1169" class="difflineplus">+function EditContact(emailAddressNode) {</span>
<a href="#l35.1170"></a><span id="l35.1170">   emailAddressNode = emailAddressNode.closest(&quot;mail-emailaddress&quot;);</span>
<a href="#l35.1171"></a><span id="l35.1171">   if (emailAddressNode.cardDetails.card)</span>
<a href="#l35.1172"></a><span id="l35.1172">     editContactInlineUI.showEditContactPanel(emailAddressNode.cardDetails,</span>
<a href="#l35.1173"></a><span id="l35.1173">                                              emailAddressNode);</span>
<a href="#l35.1174"></a><span id="l35.1174"> }</span>
<a href="#l35.1175"></a><span id="l35.1175"> </span>
<a href="#l35.1176"></a><span id="l35.1176"> /**</span>
<a href="#l35.1177"></a><span id="l35.1177">  * Takes the email address title button, extracts the email address we stored</span>
<a href="#l35.1178"></a><span id="l35.1178">  * in there and opens a compose window with that address.</span>
<a href="#l35.1179"></a><span id="l35.1179">  *</span>
<a href="#l35.1180"></a><span id="l35.1180">  * @param addressNode  a node which has a &quot;fullAddress&quot; or &quot;newsgroup&quot; attribute</span>
<a href="#l35.1181"></a><span id="l35.1181">  * @param aEvent       the event object when user triggers the menuitem</span>
<a href="#l35.1182"></a><span id="l35.1182">  */</span>
<a href="#l35.1183"></a><span id="l35.1183" class="difflineminus">-function SendMailToNode(addressNode, aEvent)</span>
<a href="#l35.1184"></a><span id="l35.1184" class="difflineminus">-{</span>
<a href="#l35.1185"></a><span id="l35.1185" class="difflineplus">+function SendMailToNode(addressNode, aEvent) {</span>
<a href="#l35.1186"></a><span id="l35.1186"> </span>
<a href="#l35.1187"></a><span id="l35.1187">   addressNode = addressNode.hasAttribute(&quot;newsgroup&quot;) ?</span>
<a href="#l35.1188"></a><span id="l35.1188">                   addressNode.closest(&quot;mail-newsgroup&quot;) :</span>
<a href="#l35.1189"></a><span id="l35.1189">                   addressNode.closest(&quot;mail-emailaddress&quot;);</span>
<a href="#l35.1190"></a><span id="l35.1190">   let fields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l35.1191"></a><span id="l35.1191">                  .createInstance(Ci.nsIMsgCompFields);</span>
<a href="#l35.1192"></a><span id="l35.1192">   let params = Cc[&quot;@mozilla.org/messengercompose/composeparams;1&quot;]</span>
<a href="#l35.1193"></a><span id="l35.1193">                  .createInstance(Ci.nsIMsgComposeParams);</span>
<a href="#l35.1194"></a><span id="l35.1194" class="difflineat">@@ -1624,18 +1559,17 @@ function SendMailToNode(addressNode, aEv</span>
<a href="#l35.1195"></a><span id="l35.1195">  * Takes the email address or newsgroup title button, extracts the address/name</span>
<a href="#l35.1196"></a><span id="l35.1196">  * we stored in there and copies it to the clipboard.</span>
<a href="#l35.1197"></a><span id="l35.1197">  *</span>
<a href="#l35.1198"></a><span id="l35.1198">  * @param addressNode  a node which has an &quot;emailAddress&quot; or &quot;newsgroup&quot;</span>
<a href="#l35.1199"></a><span id="l35.1199">  *                     attribute</span>
<a href="#l35.1200"></a><span id="l35.1200">  * @param aIncludeName when true, also copy the name onto the clipboard,</span>
<a href="#l35.1201"></a><span id="l35.1201">  *                     otherwise only the email address</span>
<a href="#l35.1202"></a><span id="l35.1202">  */</span>
<a href="#l35.1203"></a><span id="l35.1203" class="difflineminus">-function CopyEmailNewsAddress(addressNode, aIncludeName = false)</span>
<a href="#l35.1204"></a><span id="l35.1204" class="difflineminus">-{</span>
<a href="#l35.1205"></a><span id="l35.1205" class="difflineplus">+function CopyEmailNewsAddress(addressNode, aIncludeName = false) {</span>
<a href="#l35.1206"></a><span id="l35.1206">   addressNode = addressNode.hasAttribute(&quot;newsgroup&quot;) ?</span>
<a href="#l35.1207"></a><span id="l35.1207">                   addressNode.closest(&quot;mail-newsgroup&quot;) :</span>
<a href="#l35.1208"></a><span id="l35.1208">                   addressNode.closest(&quot;mail-emailaddress&quot;);</span>
<a href="#l35.1209"></a><span id="l35.1209">   let clipboard = Cc[&quot;@mozilla.org/widget/clipboardhelper;1&quot;]</span>
<a href="#l35.1210"></a><span id="l35.1210">                     .getService(Ci.nsIClipboardHelper);</span>
<a href="#l35.1211"></a><span id="l35.1211">   let address = addressNode.getAttribute(aIncludeName ? &quot;fullAddress&quot;</span>
<a href="#l35.1212"></a><span id="l35.1212">                                                       : &quot;emailAddress&quot;) ||</span>
<a href="#l35.1213"></a><span id="l35.1213">                 addressNode.getAttribute(&quot;newsgroup&quot;);</span>
<a href="#l35.1214"></a><span id="l35.1214" class="difflineat">@@ -1647,48 +1581,45 @@ function CopyEmailNewsAddress(addressNod</span>
<a href="#l35.1215"></a><span id="l35.1215">  * address or header value.</span>
<a href="#l35.1216"></a><span id="l35.1216">  *</span>
<a href="#l35.1217"></a><span id="l35.1217">  * @param aHeaderNode  A node which has an &quot;emailAddress&quot; attribute</span>
<a href="#l35.1218"></a><span id="l35.1218">  *                     or a &quot;headerName&quot; attribute.</span>
<a href="#l35.1219"></a><span id="l35.1219">  * @param aMessage     Optional nsIMsgHdr of the message from which the values</span>
<a href="#l35.1220"></a><span id="l35.1220">  *                     are taken. Will be used to preselect its folder in the</span>
<a href="#l35.1221"></a><span id="l35.1221">  *                     filter list.</span>
<a href="#l35.1222"></a><span id="l35.1222">  */</span>
<a href="#l35.1223"></a><span id="l35.1223" class="difflineminus">-function CreateFilter(aHeaderNode, aMessage)</span>
<a href="#l35.1224"></a><span id="l35.1224" class="difflineminus">-{</span>
<a href="#l35.1225"></a><span id="l35.1225" class="difflineplus">+function CreateFilter(aHeaderNode, aMessage) {</span>
<a href="#l35.1226"></a><span id="l35.1226">   aHeaderNode = aHeaderNode.closest(&quot;mail-emailaddress&quot;);</span>
<a href="#l35.1227"></a><span id="l35.1227">   let nodeIsAddress = aHeaderNode.hasAttribute(&quot;emailAddress&quot;);</span>
<a href="#l35.1228"></a><span id="l35.1228">   let nodeValue = nodeIsAddress ? aHeaderNode.getAttribute(&quot;emailAddress&quot;) :</span>
<a href="#l35.1229"></a><span id="l35.1229">                                   aHeaderNode.textContent;</span>
<a href="#l35.1230"></a><span id="l35.1230">   let folder = aMessage ? aMessage.folder : null;</span>
<a href="#l35.1231"></a><span id="l35.1231">   top.MsgFilters(nodeValue, folder, aHeaderNode.getAttribute(&quot;headerName&quot;));</span>
<a href="#l35.1232"></a><span id="l35.1232"> }</span>
<a href="#l35.1233"></a><span id="l35.1233"> </span>
<a href="#l35.1234"></a><span id="l35.1234"> /**</span>
<a href="#l35.1235"></a><span id="l35.1235">  * Get the newsgroup server corresponding to the currently selected message.</span>
<a href="#l35.1236"></a><span id="l35.1236">  *</span>
<a href="#l35.1237"></a><span id="l35.1237">  * @return nsISubscribableServer for the newsgroup, or null</span>
<a href="#l35.1238"></a><span id="l35.1238">  */</span>
<a href="#l35.1239"></a><span id="l35.1239" class="difflineminus">-function GetNewsgroupServer()</span>
<a href="#l35.1240"></a><span id="l35.1240" class="difflineminus">-{</span>
<a href="#l35.1241"></a><span id="l35.1241" class="difflineplus">+function GetNewsgroupServer() {</span>
<a href="#l35.1242"></a><span id="l35.1242">   if (gFolderDisplay.selectedMessageIsNews) {</span>
<a href="#l35.1243"></a><span id="l35.1243">     let server = gFolderDisplay.selectedMessage.folder.server;</span>
<a href="#l35.1244"></a><span id="l35.1244">     if (server)</span>
<a href="#l35.1245"></a><span id="l35.1245">       return server.QueryInterface(Ci.nsISubscribableServer);</span>
<a href="#l35.1246"></a><span id="l35.1246">   }</span>
<a href="#l35.1247"></a><span id="l35.1247">   return null;</span>
<a href="#l35.1248"></a><span id="l35.1248"> }</span>
<a href="#l35.1249"></a><span id="l35.1249"> </span>
<a href="#l35.1250"></a><span id="l35.1250"> /**</span>
<a href="#l35.1251"></a><span id="l35.1251">  * Initialize the newsgroup popup, showing/hiding menu items as appropriate.</span>
<a href="#l35.1252"></a><span id="l35.1252">  *</span>
<a href="#l35.1253"></a><span id="l35.1253">  * @param newsgroupNode  a node which has a &quot;newsgroup&quot; attribute</span>
<a href="#l35.1254"></a><span id="l35.1254">  */</span>
<a href="#l35.1255"></a><span id="l35.1255" class="difflineminus">-function setupNewsgroupPopup(newsgroupNode)</span>
<a href="#l35.1256"></a><span id="l35.1256" class="difflineminus">-{</span>
<a href="#l35.1257"></a><span id="l35.1257" class="difflineplus">+function setupNewsgroupPopup(newsgroupNode) {</span>
<a href="#l35.1258"></a><span id="l35.1258">   let newsgroupPlaceHolder = document.getElementById(&quot;newsgroupPlaceHolder&quot;);</span>
<a href="#l35.1259"></a><span id="l35.1259">   let newsgroup = newsgroupNode.getAttribute(&quot;newsgroup&quot;);</span>
<a href="#l35.1260"></a><span id="l35.1260">   newsgroupNode.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l35.1261"></a><span id="l35.1261">   newsgroupPlaceHolder.setAttribute(&quot;label&quot;, newsgroup);</span>
<a href="#l35.1262"></a><span id="l35.1262"> </span>
<a href="#l35.1263"></a><span id="l35.1263">   let server = GetNewsgroupServer();</span>
<a href="#l35.1264"></a><span id="l35.1264">   if (server) {</span>
<a href="#l35.1265"></a><span id="l35.1265">     // XXX Why is this necessary when nsISubscribableServer contains</span>
<a href="#l35.1266"></a><span id="l35.1266" class="difflineat">@@ -1708,47 +1639,44 @@ function setupNewsgroupPopup(newsgroupNo</span>
<a href="#l35.1267"></a><span id="l35.1267">           .setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l35.1268"></a><span id="l35.1268"> }</span>
<a href="#l35.1269"></a><span id="l35.1269"> </span>
<a href="#l35.1270"></a><span id="l35.1270"> /**</span>
<a href="#l35.1271"></a><span id="l35.1271">  * Subscribe to a newsgroup based on the newsgroup title button</span>
<a href="#l35.1272"></a><span id="l35.1272">  *</span>
<a href="#l35.1273"></a><span id="l35.1273">  * @param newsgroupNode  a node which has a &quot;newsgroup&quot; attribute</span>
<a href="#l35.1274"></a><span id="l35.1274">  */</span>
<a href="#l35.1275"></a><span id="l35.1275" class="difflineminus">-function SubscribeToNewsgroup(newsgroupNode)</span>
<a href="#l35.1276"></a><span id="l35.1276" class="difflineminus">-{</span>
<a href="#l35.1277"></a><span id="l35.1277" class="difflineplus">+function SubscribeToNewsgroup(newsgroupNode) {</span>
<a href="#l35.1278"></a><span id="l35.1278">   let server = GetNewsgroupServer();</span>
<a href="#l35.1279"></a><span id="l35.1279">   if (server) {</span>
<a href="#l35.1280"></a><span id="l35.1280">     let newsgroup = newsgroupNode.getAttribute(&quot;newsgroup&quot;);</span>
<a href="#l35.1281"></a><span id="l35.1281">     server.subscribe(newsgroup);</span>
<a href="#l35.1282"></a><span id="l35.1282">     server.commitSubscribeChanges();</span>
<a href="#l35.1283"></a><span id="l35.1283">   }</span>
<a href="#l35.1284"></a><span id="l35.1284"> }</span>
<a href="#l35.1285"></a><span id="l35.1285"> </span>
<a href="#l35.1286"></a><span id="l35.1286"> /**</span>
<a href="#l35.1287"></a><span id="l35.1287">  * Takes the newsgroup address title button, extracts the newsgroup name we</span>
<a href="#l35.1288"></a><span id="l35.1288">  * stored in there and copies it to the clipboard.</span>
<a href="#l35.1289"></a><span id="l35.1289">  *</span>
<a href="#l35.1290"></a><span id="l35.1290">  * @param newsgroupNode  a node which has a &quot;newsgroup&quot; attribute</span>
<a href="#l35.1291"></a><span id="l35.1291">  */</span>
<a href="#l35.1292"></a><span id="l35.1292" class="difflineminus">-function CopyNewsgroupName(newsgroupNode)</span>
<a href="#l35.1293"></a><span id="l35.1293" class="difflineminus">-{</span>
<a href="#l35.1294"></a><span id="l35.1294" class="difflineplus">+function CopyNewsgroupName(newsgroupNode) {</span>
<a href="#l35.1295"></a><span id="l35.1295">   let clipboard = Cc[&quot;@mozilla.org/widget/clipboardhelper;1&quot;]</span>
<a href="#l35.1296"></a><span id="l35.1296">                     .getService(Ci.nsIClipboardHelper);</span>
<a href="#l35.1297"></a><span id="l35.1297">   clipboard.copyString(newsgroupNode.getAttribute(&quot;newsgroup&quot;));</span>
<a href="#l35.1298"></a><span id="l35.1298"> }</span>
<a href="#l35.1299"></a><span id="l35.1299"> </span>
<a href="#l35.1300"></a><span id="l35.1300"> /**</span>
<a href="#l35.1301"></a><span id="l35.1301">  * Takes the newsgroup address title button, extracts the newsgroup name we</span>
<a href="#l35.1302"></a><span id="l35.1302">  * stored in there and copies it URL to it.</span>
<a href="#l35.1303"></a><span id="l35.1303">  *</span>
<a href="#l35.1304"></a><span id="l35.1304">  * @param newsgroupNode  a node which has a &quot;newsgroup&quot; attribute</span>
<a href="#l35.1305"></a><span id="l35.1305">  */</span>
<a href="#l35.1306"></a><span id="l35.1306" class="difflineminus">-function CopyNewsgroupURL(newsgroupNode)</span>
<a href="#l35.1307"></a><span id="l35.1307" class="difflineminus">-{</span>
<a href="#l35.1308"></a><span id="l35.1308" class="difflineplus">+function CopyNewsgroupURL(newsgroupNode) {</span>
<a href="#l35.1309"></a><span id="l35.1309">   let server = GetNewsgroupServer();</span>
<a href="#l35.1310"></a><span id="l35.1310">   if (!server)</span>
<a href="#l35.1311"></a><span id="l35.1311">     return;</span>
<a href="#l35.1312"></a><span id="l35.1312"> </span>
<a href="#l35.1313"></a><span id="l35.1313">   let ng = newsgroupNode.getAttribute(&quot;newsgroup&quot;);</span>
<a href="#l35.1314"></a><span id="l35.1314"> </span>
<a href="#l35.1315"></a><span id="l35.1315">   let url;</span>
<a href="#l35.1316"></a><span id="l35.1316">   if (server.socketType != Ci.nsMsgSocketType.SSL) {</span>
<a href="#l35.1317"></a><span id="l35.1317" class="difflineat">@@ -1763,89 +1691,84 @@ function CopyNewsgroupURL(newsgroupNode)</span>
<a href="#l35.1318"></a><span id="l35.1318">     url += &quot;/&quot; + ng;</span>
<a href="#l35.1319"></a><span id="l35.1319">   }</span>
<a href="#l35.1320"></a><span id="l35.1320"> </span>
<a href="#l35.1321"></a><span id="l35.1321">   try {</span>
<a href="#l35.1322"></a><span id="l35.1322">     let uri = Services.io.newURI(url);</span>
<a href="#l35.1323"></a><span id="l35.1323">     let clipboard = Cc[&quot;@mozilla.org/widget/clipboardhelper;1&quot;]</span>
<a href="#l35.1324"></a><span id="l35.1324">                       .getService(Ci.nsIClipboardHelper);</span>
<a href="#l35.1325"></a><span id="l35.1325">     clipboard.copyString(decodeURI(uri.spec));</span>
<a href="#l35.1326"></a><span id="l35.1326" class="difflineminus">-  } catch(e) {</span>
<a href="#l35.1327"></a><span id="l35.1327" class="difflineminus">-     Cu.reportError(&quot;Invalid URL: &quot;+ url);</span>
<a href="#l35.1328"></a><span id="l35.1328" class="difflineplus">+  } catch (e) {</span>
<a href="#l35.1329"></a><span id="l35.1329" class="difflineplus">+     Cu.reportError(&quot;Invalid URL: &quot; + url);</span>
<a href="#l35.1330"></a><span id="l35.1330">   }</span>
<a href="#l35.1331"></a><span id="l35.1331"> }</span>
<a href="#l35.1332"></a><span id="l35.1332"> </span>
<a href="#l35.1333"></a><span id="l35.1333"> /**</span>
<a href="#l35.1334"></a><span id="l35.1334">  * Create a new attachment object which goes into the data attachment array.</span>
<a href="#l35.1335"></a><span id="l35.1335">  * This method checks whether the passed attachment is empty or not.</span>
<a href="#l35.1336"></a><span id="l35.1336">  *</span>
<a href="#l35.1337"></a><span id="l35.1337">  * @param contentType  The attachment's mimetype</span>
<a href="#l35.1338"></a><span id="l35.1338">  * @param url  The URL for the attachment</span>
<a href="#l35.1339"></a><span id="l35.1339">  * @param name  The name to be displayed for this attachment (usually the</span>
<a href="#l35.1340"></a><span id="l35.1340">  *              filename)</span>
<a href="#l35.1341"></a><span id="l35.1341">  * @param uri  The URI for the message containing the attachment</span>
<a href="#l35.1342"></a><span id="l35.1342">  * @param isExternalAttachment  True if the attachment has been detached</span>
<a href="#l35.1343"></a><span id="l35.1343">  * @param size  The size in bytes of the attachment</span>
<a href="#l35.1344"></a><span id="l35.1344">  */</span>
<a href="#l35.1345"></a><span id="l35.1345"> function AttachmentInfo(contentType, url, name, uri,</span>
<a href="#l35.1346"></a><span id="l35.1346" class="difflineminus">-                        isExternalAttachment, size)</span>
<a href="#l35.1347"></a><span id="l35.1347" class="difflineminus">-{</span>
<a href="#l35.1348"></a><span id="l35.1348" class="difflineplus">+                        isExternalAttachment, size) {</span>
<a href="#l35.1349"></a><span id="l35.1349">   this.contentType = contentType;</span>
<a href="#l35.1350"></a><span id="l35.1350">   this.name = name;</span>
<a href="#l35.1351"></a><span id="l35.1351">   this.uri = uri;</span>
<a href="#l35.1352"></a><span id="l35.1352">   this.isExternalAttachment = isExternalAttachment;</span>
<a href="#l35.1353"></a><span id="l35.1353">   this.size = size;</span>
<a href="#l35.1354"></a><span id="l35.1354">   let match;</span>
<a href="#l35.1355"></a><span id="l35.1355"> </span>
<a href="#l35.1356"></a><span id="l35.1356">   // Remove [?&amp;]part= from remote urls, after getting the partID.</span>
<a href="#l35.1357"></a><span id="l35.1357">   // Remote urls, unlike non external mail part urls, may also contain query</span>
<a href="#l35.1358"></a><span id="l35.1358">   // strings starting with ?; PART_RE does not handle this.</span>
<a href="#l35.1359"></a><span id="l35.1359">   if (url.startsWith(&quot;http&quot;) || url.startsWith(&quot;file&quot;)) {</span>
<a href="#l35.1360"></a><span id="l35.1360">     match = url.match(/[?&amp;]part=[^&amp;]+$/);</span>
<a href="#l35.1361"></a><span id="l35.1361">     match = match &amp;&amp; match[0];</span>
<a href="#l35.1362"></a><span id="l35.1362">     this.partID = match &amp;&amp; match.split(&quot;part=&quot;)[1];</span>
<a href="#l35.1363"></a><span id="l35.1363">     url = url.replace(match, &quot;&quot;);</span>
<a href="#l35.1364"></a><span id="l35.1364" class="difflineminus">-  }</span>
<a href="#l35.1365"></a><span id="l35.1365" class="difflineminus">-  else {</span>
<a href="#l35.1366"></a><span id="l35.1366" class="difflineplus">+  } else {</span>
<a href="#l35.1367"></a><span id="l35.1367">     match = GlodaUtils.PART_RE.exec(url);</span>
<a href="#l35.1368"></a><span id="l35.1368">     this.partID = match &amp;&amp; match[1];</span>
<a href="#l35.1369"></a><span id="l35.1369">   }</span>
<a href="#l35.1370"></a><span id="l35.1370"> </span>
<a href="#l35.1371"></a><span id="l35.1371">   // Make sure to communicate it if it's an external http attachment and not a</span>
<a href="#l35.1372"></a><span id="l35.1372">   // local attachment. For feeds attachments (enclosures) are always remote,</span>
<a href="#l35.1373"></a><span id="l35.1373">   // so there is nothing to communicate.</span>
<a href="#l35.1374"></a><span id="l35.1374">   if (isExternalAttachment &amp;&amp; url.startsWith(&quot;http&quot;) &amp;&amp;</span>
<a href="#l35.1375"></a><span id="l35.1375">       !gFolderDisplay.selectedMessageIsFeed) {</span>
<a href="#l35.1376"></a><span id="l35.1376">     if (this.name) {</span>
<a href="#l35.1377"></a><span id="l35.1377">       this.name = url + &quot; - &quot; + this.name;</span>
<a href="#l35.1378"></a><span id="l35.1378" class="difflineminus">-    }</span>
<a href="#l35.1379"></a><span id="l35.1379" class="difflineminus">-    else {</span>
<a href="#l35.1380"></a><span id="l35.1380" class="difflineplus">+    } else {</span>
<a href="#l35.1381"></a><span id="l35.1381">       this.name = url;</span>
<a href="#l35.1382"></a><span id="l35.1382">     }</span>
<a href="#l35.1383"></a><span id="l35.1383">   }</span>
<a href="#l35.1384"></a><span id="l35.1384"> </span>
<a href="#l35.1385"></a><span id="l35.1385">   this.url = url;</span>
<a href="#l35.1386"></a><span id="l35.1386"> }</span>
<a href="#l35.1387"></a><span id="l35.1387"> </span>
<a href="#l35.1388"></a><span id="l35.1388"> AttachmentInfo.prototype = {</span>
<a href="#l35.1389"></a><span id="l35.1389">   /**</span>
<a href="#l35.1390"></a><span id="l35.1390">    * Save this attachment to a file.</span>
<a href="#l35.1391"></a><span id="l35.1391">    */</span>
<a href="#l35.1392"></a><span id="l35.1392" class="difflineminus">-  save: function AttachmentInfo_save()</span>
<a href="#l35.1393"></a><span id="l35.1393" class="difflineminus">-  {</span>
<a href="#l35.1394"></a><span id="l35.1394" class="difflineplus">+  save() {</span>
<a href="#l35.1395"></a><span id="l35.1395">     messenger.saveAttachment(this.contentType, this.url,</span>
<a href="#l35.1396"></a><span id="l35.1396">                              encodeURIComponent(this.name),</span>
<a href="#l35.1397"></a><span id="l35.1397">                              this.uri, this.isExternalAttachment);</span>
<a href="#l35.1398"></a><span id="l35.1398">   },</span>
<a href="#l35.1399"></a><span id="l35.1399"> </span>
<a href="#l35.1400"></a><span id="l35.1400">   /**</span>
<a href="#l35.1401"></a><span id="l35.1401">    * Open this attachment.</span>
<a href="#l35.1402"></a><span id="l35.1402">    */</span>
<a href="#l35.1403"></a><span id="l35.1403" class="difflineminus">-  open: function AttachmentInfo_open()</span>
<a href="#l35.1404"></a><span id="l35.1404" class="difflineminus">-  {</span>
<a href="#l35.1405"></a><span id="l35.1405" class="difflineplus">+  open() {</span>
<a href="#l35.1406"></a><span id="l35.1406">     if (!this.hasFile)</span>
<a href="#l35.1407"></a><span id="l35.1407">       return;</span>
<a href="#l35.1408"></a><span id="l35.1408"> </span>
<a href="#l35.1409"></a><span id="l35.1409">     if (this.isEmpty) {</span>
<a href="#l35.1410"></a><span id="l35.1410">       var prompt = document.getElementById(&quot;bundle_messenger&quot;)</span>
<a href="#l35.1411"></a><span id="l35.1411">                            .getString(&quot;emptyAttachment&quot;);</span>
<a href="#l35.1412"></a><span id="l35.1412">       msgWindow.promptDialog.alert(null, prompt);</span>
<a href="#l35.1413"></a><span id="l35.1413">     } else {</span>
<a href="#l35.1414"></a><span id="l35.1414" class="difflineat">@@ -1856,58 +1779,54 @@ AttachmentInfo.prototype = {</span>
<a href="#l35.1415"></a><span id="l35.1415">   },</span>
<a href="#l35.1416"></a><span id="l35.1416"> </span>
<a href="#l35.1417"></a><span id="l35.1417">   /**</span>
<a href="#l35.1418"></a><span id="l35.1418">    * Detach this attachment from the message.</span>
<a href="#l35.1419"></a><span id="l35.1419">    *</span>
<a href="#l35.1420"></a><span id="l35.1420">    * @param aSaveFirst  true if the attachment should be saved before detaching,</span>
<a href="#l35.1421"></a><span id="l35.1421">    *                    false otherwise</span>
<a href="#l35.1422"></a><span id="l35.1422">    */</span>
<a href="#l35.1423"></a><span id="l35.1423" class="difflineminus">-  detach: function AttachmentInfo_detach(aSaveFirst)</span>
<a href="#l35.1424"></a><span id="l35.1424" class="difflineminus">-  {</span>
<a href="#l35.1425"></a><span id="l35.1425" class="difflineplus">+  detach(aSaveFirst) {</span>
<a href="#l35.1426"></a><span id="l35.1426">     messenger.detachAttachment(this.contentType, this.url,</span>
<a href="#l35.1427"></a><span id="l35.1427">                                encodeURIComponent(this.name),</span>
<a href="#l35.1428"></a><span id="l35.1428">                                this.uri, aSaveFirst);</span>
<a href="#l35.1429"></a><span id="l35.1429">   },</span>
<a href="#l35.1430"></a><span id="l35.1430"> </span>
<a href="#l35.1431"></a><span id="l35.1431">   /**</span>
<a href="#l35.1432"></a><span id="l35.1432">    * This method checks whether the attachment has been deleted or not.</span>
<a href="#l35.1433"></a><span id="l35.1433">    *</span>
<a href="#l35.1434"></a><span id="l35.1434">    * @return true if the attachment has been deleted, false otherwise</span>
<a href="#l35.1435"></a><span id="l35.1435">    */</span>
<a href="#l35.1436"></a><span id="l35.1436" class="difflineminus">-  get isDeleted()</span>
<a href="#l35.1437"></a><span id="l35.1437" class="difflineminus">-  {</span>
<a href="#l35.1438"></a><span id="l35.1438" class="difflineplus">+  get isDeleted() {</span>
<a href="#l35.1439"></a><span id="l35.1439">     return this.contentType == &quot;text/x-moz-deleted&quot;;</span>
<a href="#l35.1440"></a><span id="l35.1440">   },</span>
<a href="#l35.1441"></a><span id="l35.1441"> </span>
<a href="#l35.1442"></a><span id="l35.1442">   /**</span>
<a href="#l35.1443"></a><span id="l35.1443">    * This method checks whether the attachment has an associated file or not.</span>
<a href="#l35.1444"></a><span id="l35.1444">    * Deleted attachments or detached attachments with missing external files</span>
<a href="#l35.1445"></a><span id="l35.1445">    * do *not* have a file.</span>
<a href="#l35.1446"></a><span id="l35.1446">    *</span>
<a href="#l35.1447"></a><span id="l35.1447">    * @return true if the attachment has an associated file, false otherwise</span>
<a href="#l35.1448"></a><span id="l35.1448">    */</span>
<a href="#l35.1449"></a><span id="l35.1449" class="difflineminus">-  get hasFile()</span>
<a href="#l35.1450"></a><span id="l35.1450" class="difflineminus">-  {</span>
<a href="#l35.1451"></a><span id="l35.1451" class="difflineplus">+  get hasFile() {</span>
<a href="#l35.1452"></a><span id="l35.1452">     if (this.isDeleted)</span>
<a href="#l35.1453"></a><span id="l35.1453">       return false;</span>
<a href="#l35.1454"></a><span id="l35.1454">     if (this.isExternalAttachment &amp;&amp; this.url.startsWith(&quot;file:&quot;) &amp;&amp;</span>
<a href="#l35.1455"></a><span id="l35.1455">         this.size === null)</span>
<a href="#l35.1456"></a><span id="l35.1456">       return false;</span>
<a href="#l35.1457"></a><span id="l35.1457"> </span>
<a href="#l35.1458"></a><span id="l35.1458">     return true;</span>
<a href="#l35.1459"></a><span id="l35.1459">   },</span>
<a href="#l35.1460"></a><span id="l35.1460"> </span>
<a href="#l35.1461"></a><span id="l35.1461">   /**</span>
<a href="#l35.1462"></a><span id="l35.1462">    * This method checks whether the attachment is empty or not.</span>
<a href="#l35.1463"></a><span id="l35.1463">    *</span>
<a href="#l35.1464"></a><span id="l35.1464">    * @return  true if the attachment is empty, false otherwise</span>
<a href="#l35.1465"></a><span id="l35.1465">    */</span>
<a href="#l35.1466"></a><span id="l35.1466" class="difflineminus">-  get isEmpty()</span>
<a href="#l35.1467"></a><span id="l35.1467" class="difflineminus">-  {</span>
<a href="#l35.1468"></a><span id="l35.1468" class="difflineplus">+  get isEmpty() {</span>
<a href="#l35.1469"></a><span id="l35.1469">     // Create an input stream on the attachment url.</span>
<a href="#l35.1470"></a><span id="l35.1470">     let url = Services.io.newURI(this.url);</span>
<a href="#l35.1471"></a><span id="l35.1471">     let channel = Services.io.newChannelFromURI2(url,</span>
<a href="#l35.1472"></a><span id="l35.1472">                                                  null,</span>
<a href="#l35.1473"></a><span id="l35.1473">                                                  Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l35.1474"></a><span id="l35.1474">                                                  null,</span>
<a href="#l35.1475"></a><span id="l35.1475">                                                  Ci.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l35.1476"></a><span id="l35.1476">                                                  Ci.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l35.1477"></a><span id="l35.1477" class="difflineat">@@ -1946,50 +1865,46 @@ AttachmentInfo.prototype = {</span>
<a href="#l35.1478"></a><span id="l35.1478">     return (bytesAvailable == 0);</span>
<a href="#l35.1479"></a><span id="l35.1479">   },</span>
<a href="#l35.1480"></a><span id="l35.1480"> };</span>
<a href="#l35.1481"></a><span id="l35.1481"> </span>
<a href="#l35.1482"></a><span id="l35.1482"> /**</span>
<a href="#l35.1483"></a><span id="l35.1483">  * Return true if possible attachments in the currently loaded message can be</span>
<a href="#l35.1484"></a><span id="l35.1484">  * deleted/detached.</span>
<a href="#l35.1485"></a><span id="l35.1485">  */</span>
<a href="#l35.1486"></a><span id="l35.1486" class="difflineminus">-function CanDetachAttachments()</span>
<a href="#l35.1487"></a><span id="l35.1487" class="difflineminus">-{</span>
<a href="#l35.1488"></a><span id="l35.1488" class="difflineplus">+function CanDetachAttachments() {</span>
<a href="#l35.1489"></a><span id="l35.1489">   var canDetach = !gFolderDisplay.selectedMessageIsNews &amp;&amp;</span>
<a href="#l35.1490"></a><span id="l35.1490">                   (!gFolderDisplay.selectedMessageIsImap ||</span>
<a href="#l35.1491"></a><span id="l35.1491">                    MailOfflineMgr.isOnline());</span>
<a href="#l35.1492"></a><span id="l35.1492">   if (canDetach &amp;&amp; (&quot;content-type&quot; in currentHeaderData))</span>
<a href="#l35.1493"></a><span id="l35.1493">     canDetach = !ContentTypeIsSMIME(currentHeaderData[&quot;content-type&quot;].headerValue);</span>
<a href="#l35.1494"></a><span id="l35.1494">   return canDetach;</span>
<a href="#l35.1495"></a><span id="l35.1495"> }</span>
<a href="#l35.1496"></a><span id="l35.1496"> </span>
<a href="#l35.1497"></a><span id="l35.1497"> /**</span>
<a href="#l35.1498"></a><span id="l35.1498">  * Return true if the content type is an S/MIME one.</span>
<a href="#l35.1499"></a><span id="l35.1499">  */</span>
<a href="#l35.1500"></a><span id="l35.1500" class="difflineminus">-function ContentTypeIsSMIME(contentType)</span>
<a href="#l35.1501"></a><span id="l35.1501" class="difflineminus">-{</span>
<a href="#l35.1502"></a><span id="l35.1502" class="difflineplus">+function ContentTypeIsSMIME(contentType) {</span>
<a href="#l35.1503"></a><span id="l35.1503">   // S/MIME is application/pkcs7-mime and application/pkcs7-signature</span>
<a href="#l35.1504"></a><span id="l35.1504">   // - also match application/x-pkcs7-mime and application/x-pkcs7-signature.</span>
<a href="#l35.1505"></a><span id="l35.1505">   return /application\/(x-)?pkcs7-(mime|signature)/.test(contentType);</span>
<a href="#l35.1506"></a><span id="l35.1506"> }</span>
<a href="#l35.1507"></a><span id="l35.1507"> </span>
<a href="#l35.1508"></a><span id="l35.1508" class="difflineminus">-function onShowAttachmentToolbarContextMenu()</span>
<a href="#l35.1509"></a><span id="l35.1509" class="difflineminus">-{</span>
<a href="#l35.1510"></a><span id="l35.1510" class="difflineplus">+function onShowAttachmentToolbarContextMenu() {</span>
<a href="#l35.1511"></a><span id="l35.1511">   let expandBar = document.getElementById(&quot;context-expandAttachmentBar&quot;);</span>
<a href="#l35.1512"></a><span id="l35.1512">   let expanded = Services.prefs.getBoolPref(</span>
<a href="#l35.1513"></a><span id="l35.1513">     &quot;mailnews.attachments.display.start_expanded&quot;);</span>
<a href="#l35.1514"></a><span id="l35.1514">   expandBar.setAttribute(&quot;checked&quot;, expanded);</span>
<a href="#l35.1515"></a><span id="l35.1515"> }</span>
<a href="#l35.1516"></a><span id="l35.1516"> </span>
<a href="#l35.1517"></a><span id="l35.1517"> /**</span>
<a href="#l35.1518"></a><span id="l35.1518">  * Set up the attachment item context menu, showing or hiding the appropriate</span>
<a href="#l35.1519"></a><span id="l35.1519">  * menu items.</span>
<a href="#l35.1520"></a><span id="l35.1520">  */</span>
<a href="#l35.1521"></a><span id="l35.1521" class="difflineminus">-function onShowAttachmentItemContextMenu()</span>
<a href="#l35.1522"></a><span id="l35.1522" class="difflineminus">-{</span>
<a href="#l35.1523"></a><span id="l35.1523" class="difflineplus">+function onShowAttachmentItemContextMenu() {</span>
<a href="#l35.1524"></a><span id="l35.1524">   let attachmentList = document.getElementById(&quot;attachmentList&quot;);</span>
<a href="#l35.1525"></a><span id="l35.1525">   let attachmentInfo = document.getElementById(&quot;attachmentInfo&quot;);</span>
<a href="#l35.1526"></a><span id="l35.1526">   let attachmentName = document.getElementById(&quot;attachmentName&quot;);</span>
<a href="#l35.1527"></a><span id="l35.1527">   let contextMenu    = document.getElementById(&quot;attachmentItemContext&quot;);</span>
<a href="#l35.1528"></a><span id="l35.1528">   let openMenu       = document.getElementById(&quot;context-openAttachment&quot;);</span>
<a href="#l35.1529"></a><span id="l35.1529">   let saveMenu       = document.getElementById(&quot;context-saveAttachment&quot;);</span>
<a href="#l35.1530"></a><span id="l35.1530">   let detachMenu     = document.getElementById(&quot;context-detachAttachment&quot;);</span>
<a href="#l35.1531"></a><span id="l35.1531">   let deleteMenu     = document.getElementById(&quot;context-deleteAttachment&quot;);</span>
<a href="#l35.1532"></a><span id="l35.1532" class="difflineat">@@ -2000,18 +1915,17 @@ function onShowAttachmentItemContextMenu</span>
<a href="#l35.1533"></a><span id="l35.1533">   // &quot;1 attachment&quot; label, filename, or file size, just grab the first (and</span>
<a href="#l35.1534"></a><span id="l35.1534">   // only) attachment as our &quot;selected&quot; attachments.</span>
<a href="#l35.1535"></a><span id="l35.1535">   var selectedAttachments;</span>
<a href="#l35.1536"></a><span id="l35.1536">   if (contextMenu.triggerNode == attachmentInfo ||</span>
<a href="#l35.1537"></a><span id="l35.1537">       contextMenu.triggerNode.parentNode == attachmentInfo) {</span>
<a href="#l35.1538"></a><span id="l35.1538">     selectedAttachments = [attachmentList.getItemAtIndex(0).attachment];</span>
<a href="#l35.1539"></a><span id="l35.1539">     if (contextMenu.triggerNode == attachmentName)</span>
<a href="#l35.1540"></a><span id="l35.1540">       attachmentName.setAttribute(&quot;selected&quot;, true);</span>
<a href="#l35.1541"></a><span id="l35.1541" class="difflineminus">-  }</span>
<a href="#l35.1542"></a><span id="l35.1542" class="difflineminus">-  else {</span>
<a href="#l35.1543"></a><span id="l35.1543" class="difflineplus">+  } else {</span>
<a href="#l35.1544"></a><span id="l35.1544">     selectedAttachments =</span>
<a href="#l35.1545"></a><span id="l35.1545">       [...attachmentList.selectedItems].map(item =&gt; item.attachment);</span>
<a href="#l35.1546"></a><span id="l35.1546">   }</span>
<a href="#l35.1547"></a><span id="l35.1547">   contextMenu.attachments = selectedAttachments;</span>
<a href="#l35.1548"></a><span id="l35.1548"> </span>
<a href="#l35.1549"></a><span id="l35.1549">   var allSelectedDetached = selectedAttachments.every(function(attachment) {</span>
<a href="#l35.1550"></a><span id="l35.1550">     return attachment.isExternalAttachment;</span>
<a href="#l35.1551"></a><span id="l35.1551">   });</span>
<a href="#l35.1552"></a><span id="l35.1552" class="difflineat">@@ -2029,122 +1943,113 @@ function onShowAttachmentItemContextMenu</span>
<a href="#l35.1553"></a><span id="l35.1553">   detachMenu.disabled = !canDetachSelected;</span>
<a href="#l35.1554"></a><span id="l35.1554">   deleteMenu.disabled = !canDetachSelected;</span>
<a href="#l35.1555"></a><span id="l35.1555">   copyUrlMenuSep.hidden = copyUrlMenu.hidden = !allSelectedHttp;</span>
<a href="#l35.1556"></a><span id="l35.1556"> }</span>
<a href="#l35.1557"></a><span id="l35.1557"> </span>
<a href="#l35.1558"></a><span id="l35.1558"> /**</span>
<a href="#l35.1559"></a><span id="l35.1559">  * Close the attachment item context menu, performing any cleanup as necessary.</span>
<a href="#l35.1560"></a><span id="l35.1560">  */</span>
<a href="#l35.1561"></a><span id="l35.1561" class="difflineminus">-function onHideAttachmentItemContextMenu()</span>
<a href="#l35.1562"></a><span id="l35.1562" class="difflineminus">-{</span>
<a href="#l35.1563"></a><span id="l35.1563" class="difflineplus">+function onHideAttachmentItemContextMenu() {</span>
<a href="#l35.1564"></a><span id="l35.1564">   let attachmentName = document.getElementById(&quot;attachmentName&quot;);</span>
<a href="#l35.1565"></a><span id="l35.1565">   let contextMenu = document.getElementById(&quot;attachmentItemContext&quot;);</span>
<a href="#l35.1566"></a><span id="l35.1566"> </span>
<a href="#l35.1567"></a><span id="l35.1567">   // If we opened the context menu from the attachmentName label, we need to</span>
<a href="#l35.1568"></a><span id="l35.1568">   // get rid of the &quot;selected&quot; attribute.</span>
<a href="#l35.1569"></a><span id="l35.1569">   if (contextMenu.triggerNode == attachmentName)</span>
<a href="#l35.1570"></a><span id="l35.1570">     attachmentName.removeAttribute(&quot;selected&quot;);</span>
<a href="#l35.1571"></a><span id="l35.1571"> }</span>
<a href="#l35.1572"></a><span id="l35.1572"> </span>
<a href="#l35.1573"></a><span id="l35.1573"> /**</span>
<a href="#l35.1574"></a><span id="l35.1574">  * Enable/disable menu items as appropriate for the single-attachment save all</span>
<a href="#l35.1575"></a><span id="l35.1575">  * toolbar button.</span>
<a href="#l35.1576"></a><span id="l35.1576">  */</span>
<a href="#l35.1577"></a><span id="l35.1577" class="difflineminus">-function onShowSaveAttachmentMenuSingle()</span>
<a href="#l35.1578"></a><span id="l35.1578" class="difflineminus">-{</span>
<a href="#l35.1579"></a><span id="l35.1579" class="difflineminus">-  let openItem   = document.getElementById('button-openAttachment');</span>
<a href="#l35.1580"></a><span id="l35.1580" class="difflineminus">-  let saveItem   = document.getElementById('button-saveAttachment');</span>
<a href="#l35.1581"></a><span id="l35.1581" class="difflineminus">-  let detachItem = document.getElementById('button-detachAttachment');</span>
<a href="#l35.1582"></a><span id="l35.1582" class="difflineminus">-  let deleteItem = document.getElementById('button-deleteAttachment');</span>
<a href="#l35.1583"></a><span id="l35.1583" class="difflineplus">+function onShowSaveAttachmentMenuSingle() {</span>
<a href="#l35.1584"></a><span id="l35.1584" class="difflineplus">+  let openItem   = document.getElementById(&quot;button-openAttachment&quot;);</span>
<a href="#l35.1585"></a><span id="l35.1585" class="difflineplus">+  let saveItem   = document.getElementById(&quot;button-saveAttachment&quot;);</span>
<a href="#l35.1586"></a><span id="l35.1586" class="difflineplus">+  let detachItem = document.getElementById(&quot;button-detachAttachment&quot;);</span>
<a href="#l35.1587"></a><span id="l35.1587" class="difflineplus">+  let deleteItem = document.getElementById(&quot;button-deleteAttachment&quot;);</span>
<a href="#l35.1588"></a><span id="l35.1588"> </span>
<a href="#l35.1589"></a><span id="l35.1589">   let detached = currentAttachments[0].isExternalAttachment;</span>
<a href="#l35.1590"></a><span id="l35.1590">   let deleted  = !currentAttachments[0].hasFile;</span>
<a href="#l35.1591"></a><span id="l35.1591">   let canDetach = CanDetachAttachments() &amp;&amp; !deleted &amp;&amp; !detached;</span>
<a href="#l35.1592"></a><span id="l35.1592"> </span>
<a href="#l35.1593"></a><span id="l35.1593">   openItem.disabled = deleted;</span>
<a href="#l35.1594"></a><span id="l35.1594">   saveItem.disabled = deleted;</span>
<a href="#l35.1595"></a><span id="l35.1595">   detachItem.disabled = !canDetach;</span>
<a href="#l35.1596"></a><span id="l35.1596">   deleteItem.disabled = !canDetach;</span>
<a href="#l35.1597"></a><span id="l35.1597"> }</span>
<a href="#l35.1598"></a><span id="l35.1598"> </span>
<a href="#l35.1599"></a><span id="l35.1599"> /**</span>
<a href="#l35.1600"></a><span id="l35.1600">  * Enable/disable menu items as appropriate for the multiple-attachment save all</span>
<a href="#l35.1601"></a><span id="l35.1601">  * toolbar button.</span>
<a href="#l35.1602"></a><span id="l35.1602">  */</span>
<a href="#l35.1603"></a><span id="l35.1603" class="difflineminus">-function onShowSaveAttachmentMenuMultiple()</span>
<a href="#l35.1604"></a><span id="l35.1604" class="difflineminus">-{</span>
<a href="#l35.1605"></a><span id="l35.1605" class="difflineminus">-  let openAllItem   = document.getElementById('button-openAllAttachments');</span>
<a href="#l35.1606"></a><span id="l35.1606" class="difflineminus">-  let saveAllItem   = document.getElementById('button-saveAllAttachments');</span>
<a href="#l35.1607"></a><span id="l35.1607" class="difflineminus">-  let detachAllItem = document.getElementById('button-detachAllAttachments');</span>
<a href="#l35.1608"></a><span id="l35.1608" class="difflineminus">-  let deleteAllItem = document.getElementById('button-deleteAllAttachments');</span>
<a href="#l35.1609"></a><span id="l35.1609" class="difflineplus">+function onShowSaveAttachmentMenuMultiple() {</span>
<a href="#l35.1610"></a><span id="l35.1610" class="difflineplus">+  let openAllItem   = document.getElementById(&quot;button-openAllAttachments&quot;);</span>
<a href="#l35.1611"></a><span id="l35.1611" class="difflineplus">+  let saveAllItem   = document.getElementById(&quot;button-saveAllAttachments&quot;);</span>
<a href="#l35.1612"></a><span id="l35.1612" class="difflineplus">+  let detachAllItem = document.getElementById(&quot;button-detachAllAttachments&quot;);</span>
<a href="#l35.1613"></a><span id="l35.1613" class="difflineplus">+  let deleteAllItem = document.getElementById(&quot;button-deleteAllAttachments&quot;);</span>
<a href="#l35.1614"></a><span id="l35.1614"> </span>
<a href="#l35.1615"></a><span id="l35.1615">   let allDetached = currentAttachments.every(function(attachment) {</span>
<a href="#l35.1616"></a><span id="l35.1616">     return attachment.isExternalAttachment;</span>
<a href="#l35.1617"></a><span id="l35.1617">   });</span>
<a href="#l35.1618"></a><span id="l35.1618">   let allDeleted = currentAttachments.every(function(attachment) {</span>
<a href="#l35.1619"></a><span id="l35.1619">     return !attachment.hasFile;</span>
<a href="#l35.1620"></a><span id="l35.1620">   });</span>
<a href="#l35.1621"></a><span id="l35.1621">   let canDetach = CanDetachAttachments() &amp;&amp; !allDeleted &amp;&amp; !allDetached;</span>
<a href="#l35.1622"></a><span id="l35.1622"> </span>
<a href="#l35.1623"></a><span id="l35.1623">   openAllItem.disabled = allDeleted;</span>
<a href="#l35.1624"></a><span id="l35.1624">   saveAllItem.disabled = allDeleted;</span>
<a href="#l35.1625"></a><span id="l35.1625">   detachAllItem.disabled = !canDetach;</span>
<a href="#l35.1626"></a><span id="l35.1626">   deleteAllItem.disabled = !canDetach;</span>
<a href="#l35.1627"></a><span id="l35.1627"> }</span>
<a href="#l35.1628"></a><span id="l35.1628"> </span>
<a href="#l35.1629"></a><span id="l35.1629" class="difflineminus">-function MessageIdClick(node, event)</span>
<a href="#l35.1630"></a><span id="l35.1630" class="difflineminus">-{</span>
<a href="#l35.1631"></a><span id="l35.1631" class="difflineplus">+function MessageIdClick(node, event) {</span>
<a href="#l35.1632"></a><span id="l35.1632">   if (event.button == 0) {</span>
<a href="#l35.1633"></a><span id="l35.1633">     var messageId = GetMessageIdFromNode(node, true);</span>
<a href="#l35.1634"></a><span id="l35.1634">     OpenMessageForMessageId(messageId);</span>
<a href="#l35.1635"></a><span id="l35.1635">   }</span>
<a href="#l35.1636"></a><span id="l35.1636"> }</span>
<a href="#l35.1637"></a><span id="l35.1637"> </span>
<a href="#l35.1638"></a><span id="l35.1638"> /**</span>
<a href="#l35.1639"></a><span id="l35.1639">  * This is our oncommand handler for the attachment list items. A double click</span>
<a href="#l35.1640"></a><span id="l35.1640">  * or enter press in an attachmentitem simulates &quot;opening&quot; the attachment.</span>
<a href="#l35.1641"></a><span id="l35.1641">  *</span>
<a href="#l35.1642"></a><span id="l35.1642">  * @param event  the event object</span>
<a href="#l35.1643"></a><span id="l35.1643">  */</span>
<a href="#l35.1644"></a><span id="l35.1644" class="difflineminus">-function attachmentItemCommand(event)</span>
<a href="#l35.1645"></a><span id="l35.1645" class="difflineminus">-{</span>
<a href="#l35.1646"></a><span id="l35.1646" class="difflineplus">+function attachmentItemCommand(event) {</span>
<a href="#l35.1647"></a><span id="l35.1647">   HandleSelectedAttachments(&quot;open&quot;);</span>
<a href="#l35.1648"></a><span id="l35.1648"> }</span>
<a href="#l35.1649"></a><span id="l35.1649"> </span>
<a href="#l35.1650"></a><span id="l35.1650" class="difflineminus">-var AttachmentListController =</span>
<a href="#l35.1651"></a><span id="l35.1651" class="difflineminus">-{</span>
<a href="#l35.1652"></a><span id="l35.1652" class="difflineminus">-  supportsCommand: function(command)</span>
<a href="#l35.1653"></a><span id="l35.1653" class="difflineminus">-  {</span>
<a href="#l35.1654"></a><span id="l35.1654" class="difflineplus">+var AttachmentListController = {</span>
<a href="#l35.1655"></a><span id="l35.1655" class="difflineplus">+  supportsCommand(command) {</span>
<a href="#l35.1656"></a><span id="l35.1656">     switch (command) {</span>
<a href="#l35.1657"></a><span id="l35.1657">       case &quot;cmd_selectAll&quot;:</span>
<a href="#l35.1658"></a><span id="l35.1658">       case &quot;cmd_delete&quot;:</span>
<a href="#l35.1659"></a><span id="l35.1659">       case &quot;cmd_shiftDelete&quot;:</span>
<a href="#l35.1660"></a><span id="l35.1660">       case &quot;cmd_saveAsFile&quot;:</span>
<a href="#l35.1661"></a><span id="l35.1661">         return true;</span>
<a href="#l35.1662"></a><span id="l35.1662">       default:</span>
<a href="#l35.1663"></a><span id="l35.1663">         return false;</span>
<a href="#l35.1664"></a><span id="l35.1664">     }</span>
<a href="#l35.1665"></a><span id="l35.1665">   },</span>
<a href="#l35.1666"></a><span id="l35.1666"> </span>
<a href="#l35.1667"></a><span id="l35.1667" class="difflineminus">-  isCommandEnabled: function(command)</span>
<a href="#l35.1668"></a><span id="l35.1668" class="difflineminus">-  {</span>
<a href="#l35.1669"></a><span id="l35.1669" class="difflineplus">+  isCommandEnabled(command) {</span>
<a href="#l35.1670"></a><span id="l35.1670">     switch (command) {</span>
<a href="#l35.1671"></a><span id="l35.1671">       case &quot;cmd_selectAll&quot;:</span>
<a href="#l35.1672"></a><span id="l35.1672">       case &quot;cmd_delete&quot;:</span>
<a href="#l35.1673"></a><span id="l35.1673">       case &quot;cmd_shiftDelete&quot;:</span>
<a href="#l35.1674"></a><span id="l35.1674">       case &quot;cmd_saveAsFile&quot;:</span>
<a href="#l35.1675"></a><span id="l35.1675">         return true;</span>
<a href="#l35.1676"></a><span id="l35.1676">       default:</span>
<a href="#l35.1677"></a><span id="l35.1677">         return false;</span>
<a href="#l35.1678"></a><span id="l35.1678">     }</span>
<a href="#l35.1679"></a><span id="l35.1679">   },</span>
<a href="#l35.1680"></a><span id="l35.1680"> </span>
<a href="#l35.1681"></a><span id="l35.1681" class="difflineminus">-  doCommand: function(command)</span>
<a href="#l35.1682"></a><span id="l35.1682" class="difflineminus">-  {</span>
<a href="#l35.1683"></a><span id="l35.1683" class="difflineplus">+  doCommand(command) {</span>
<a href="#l35.1684"></a><span id="l35.1684">     // If the user invoked a key short cut then it is possible that we got here</span>
<a href="#l35.1685"></a><span id="l35.1685">     // for a command which is really disabled. kick out if the command should</span>
<a href="#l35.1686"></a><span id="l35.1686">     // be disabled.</span>
<a href="#l35.1687"></a><span id="l35.1687">     if (!this.isCommandEnabled(command))</span>
<a href="#l35.1688"></a><span id="l35.1688">       return;</span>
<a href="#l35.1689"></a><span id="l35.1689"> </span>
<a href="#l35.1690"></a><span id="l35.1690">     var attachmentList = document.getElementById(&quot;attachmentList&quot;);</span>
<a href="#l35.1691"></a><span id="l35.1691"> </span>
<a href="#l35.1692"></a><span id="l35.1692" class="difflineat">@@ -2153,126 +2058,122 @@ var AttachmentListController =</span>
<a href="#l35.1693"></a><span id="l35.1693">         attachmentList.selectAll();</span>
<a href="#l35.1694"></a><span id="l35.1694">         return;</span>
<a href="#l35.1695"></a><span id="l35.1695">       case &quot;cmd_delete&quot;:</span>
<a href="#l35.1696"></a><span id="l35.1696">       case &quot;cmd_shiftDelete&quot;:</span>
<a href="#l35.1697"></a><span id="l35.1697">         HandleSelectedAttachments(&quot;delete&quot;);</span>
<a href="#l35.1698"></a><span id="l35.1698">         return;</span>
<a href="#l35.1699"></a><span id="l35.1699">       case &quot;cmd_saveAsFile&quot;:</span>
<a href="#l35.1700"></a><span id="l35.1700">         HandleSelectedAttachments(&quot;saveAs&quot;);</span>
<a href="#l35.1701"></a><span id="l35.1701" class="difflineminus">-        return;</span>
<a href="#l35.1702"></a><span id="l35.1702">     }</span>
<a href="#l35.1703"></a><span id="l35.1703">   },</span>
<a href="#l35.1704"></a><span id="l35.1704"> </span>
<a href="#l35.1705"></a><span id="l35.1705" class="difflineminus">-  onEvent: function(event)</span>
<a href="#l35.1706"></a><span id="l35.1706" class="difflineminus">-  {}</span>
<a href="#l35.1707"></a><span id="l35.1707" class="difflineplus">+  onEvent(event) {},</span>
<a href="#l35.1708"></a><span id="l35.1708"> };</span>
<a href="#l35.1709"></a><span id="l35.1709"> </span>
<a href="#l35.1710"></a><span id="l35.1710"> var AttachmentMenuController = {</span>
<a href="#l35.1711"></a><span id="l35.1711">   commands: {</span>
<a href="#l35.1712"></a><span id="l35.1712">     cmd_openAllAttachments: {</span>
<a href="#l35.1713"></a><span id="l35.1713" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l35.1714"></a><span id="l35.1714" class="difflineplus">+      isEnabled() {</span>
<a href="#l35.1715"></a><span id="l35.1715">         return AttachmentMenuController._someFilesAvailable();</span>
<a href="#l35.1716"></a><span id="l35.1716">       },</span>
<a href="#l35.1717"></a><span id="l35.1717"> </span>
<a href="#l35.1718"></a><span id="l35.1718" class="difflineminus">-      doCommand: function() {</span>
<a href="#l35.1719"></a><span id="l35.1719" class="difflineplus">+      doCommand() {</span>
<a href="#l35.1720"></a><span id="l35.1720">         HandleAllAttachments(&quot;open&quot;);</span>
<a href="#l35.1721"></a><span id="l35.1721">       },</span>
<a href="#l35.1722"></a><span id="l35.1722">     },</span>
<a href="#l35.1723"></a><span id="l35.1723"> </span>
<a href="#l35.1724"></a><span id="l35.1724">     cmd_saveAllAttachments: {</span>
<a href="#l35.1725"></a><span id="l35.1725" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l35.1726"></a><span id="l35.1726" class="difflineplus">+      isEnabled() {</span>
<a href="#l35.1727"></a><span id="l35.1727">         return AttachmentMenuController._someFilesAvailable();</span>
<a href="#l35.1728"></a><span id="l35.1728">       },</span>
<a href="#l35.1729"></a><span id="l35.1729"> </span>
<a href="#l35.1730"></a><span id="l35.1730" class="difflineminus">-      doCommand: function() {</span>
<a href="#l35.1731"></a><span id="l35.1731" class="difflineplus">+      doCommand() {</span>
<a href="#l35.1732"></a><span id="l35.1732">         HandleAllAttachments(&quot;save&quot;);</span>
<a href="#l35.1733"></a><span id="l35.1733">       },</span>
<a href="#l35.1734"></a><span id="l35.1734">     },</span>
<a href="#l35.1735"></a><span id="l35.1735"> </span>
<a href="#l35.1736"></a><span id="l35.1736">     cmd_detachAllAttachments: {</span>
<a href="#l35.1737"></a><span id="l35.1737" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l35.1738"></a><span id="l35.1738" class="difflineplus">+      isEnabled() {</span>
<a href="#l35.1739"></a><span id="l35.1739">         return AttachmentMenuController._canDetachFiles();</span>
<a href="#l35.1740"></a><span id="l35.1740">       },</span>
<a href="#l35.1741"></a><span id="l35.1741"> </span>
<a href="#l35.1742"></a><span id="l35.1742" class="difflineminus">-      doCommand: function() {</span>
<a href="#l35.1743"></a><span id="l35.1743" class="difflineplus">+      doCommand() {</span>
<a href="#l35.1744"></a><span id="l35.1744">         HandleAllAttachments(&quot;detach&quot;);</span>
<a href="#l35.1745"></a><span id="l35.1745">       },</span>
<a href="#l35.1746"></a><span id="l35.1746">     },</span>
<a href="#l35.1747"></a><span id="l35.1747"> </span>
<a href="#l35.1748"></a><span id="l35.1748">     cmd_deleteAllAttachments: {</span>
<a href="#l35.1749"></a><span id="l35.1749" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l35.1750"></a><span id="l35.1750" class="difflineplus">+      isEnabled() {</span>
<a href="#l35.1751"></a><span id="l35.1751">         return AttachmentMenuController._canDetachFiles();</span>
<a href="#l35.1752"></a><span id="l35.1752">       },</span>
<a href="#l35.1753"></a><span id="l35.1753"> </span>
<a href="#l35.1754"></a><span id="l35.1754" class="difflineminus">-      doCommand: function() {</span>
<a href="#l35.1755"></a><span id="l35.1755" class="difflineplus">+      doCommand() {</span>
<a href="#l35.1756"></a><span id="l35.1756">         HandleAllAttachments(&quot;delete&quot;);</span>
<a href="#l35.1757"></a><span id="l35.1757">       },</span>
<a href="#l35.1758"></a><span id="l35.1758">     },</span>
<a href="#l35.1759"></a><span id="l35.1759">   },</span>
<a href="#l35.1760"></a><span id="l35.1760"> </span>
<a href="#l35.1761"></a><span id="l35.1761" class="difflineminus">-  _canDetachFiles: function() {</span>
<a href="#l35.1762"></a><span id="l35.1762" class="difflineplus">+  _canDetachFiles() {</span>
<a href="#l35.1763"></a><span id="l35.1763">     let someNotDetached = currentAttachments.some(function(aAttachment) {</span>
<a href="#l35.1764"></a><span id="l35.1764">       return !aAttachment.isExternalAttachment;</span>
<a href="#l35.1765"></a><span id="l35.1765">     });</span>
<a href="#l35.1766"></a><span id="l35.1766"> </span>
<a href="#l35.1767"></a><span id="l35.1767">     return CanDetachAttachments() &amp;&amp;</span>
<a href="#l35.1768"></a><span id="l35.1768">            someNotDetached &amp;&amp;</span>
<a href="#l35.1769"></a><span id="l35.1769">            this._someFilesAvailable();</span>
<a href="#l35.1770"></a><span id="l35.1770">   },</span>
<a href="#l35.1771"></a><span id="l35.1771"> </span>
<a href="#l35.1772"></a><span id="l35.1772" class="difflineminus">-  _someFilesAvailable: function() {</span>
<a href="#l35.1773"></a><span id="l35.1773" class="difflineplus">+  _someFilesAvailable() {</span>
<a href="#l35.1774"></a><span id="l35.1774">     return currentAttachments.some(function(aAttachment) {</span>
<a href="#l35.1775"></a><span id="l35.1775">       return aAttachment.hasFile;</span>
<a href="#l35.1776"></a><span id="l35.1776">     });</span>
<a href="#l35.1777"></a><span id="l35.1777">   },</span>
<a href="#l35.1778"></a><span id="l35.1778"> </span>
<a href="#l35.1779"></a><span id="l35.1779" class="difflineminus">-  supportsCommand: function(aCommand) {</span>
<a href="#l35.1780"></a><span id="l35.1780" class="difflineplus">+  supportsCommand(aCommand) {</span>
<a href="#l35.1781"></a><span id="l35.1781">     return (aCommand in this.commands);</span>
<a href="#l35.1782"></a><span id="l35.1782">   },</span>
<a href="#l35.1783"></a><span id="l35.1783"> </span>
<a href="#l35.1784"></a><span id="l35.1784" class="difflineminus">-  isCommandEnabled: function(aCommand) {</span>
<a href="#l35.1785"></a><span id="l35.1785" class="difflineplus">+  isCommandEnabled(aCommand) {</span>
<a href="#l35.1786"></a><span id="l35.1786">     if (!this.supportsCommand(aCommand))</span>
<a href="#l35.1787"></a><span id="l35.1787">       return false;</span>
<a href="#l35.1788"></a><span id="l35.1788"> </span>
<a href="#l35.1789"></a><span id="l35.1789">     return this.commands[aCommand].isEnabled();</span>
<a href="#l35.1790"></a><span id="l35.1790">   },</span>
<a href="#l35.1791"></a><span id="l35.1791"> </span>
<a href="#l35.1792"></a><span id="l35.1792" class="difflineminus">-  doCommand: function(aCommand) {</span>
<a href="#l35.1793"></a><span id="l35.1793" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l35.1794"></a><span id="l35.1794">     if (!this.supportsCommand(aCommand))</span>
<a href="#l35.1795"></a><span id="l35.1795">       return;</span>
<a href="#l35.1796"></a><span id="l35.1796">     let cmd = this.commands[aCommand];</span>
<a href="#l35.1797"></a><span id="l35.1797">     if (!cmd.isEnabled())</span>
<a href="#l35.1798"></a><span id="l35.1798">       return;</span>
<a href="#l35.1799"></a><span id="l35.1799">     cmd.doCommand();</span>
<a href="#l35.1800"></a><span id="l35.1800">   },</span>
<a href="#l35.1801"></a><span id="l35.1801"> </span>
<a href="#l35.1802"></a><span id="l35.1802" class="difflineminus">-  onEvent: function(aEvent) {}</span>
<a href="#l35.1803"></a><span id="l35.1803" class="difflineplus">+  onEvent(aEvent) {},</span>
<a href="#l35.1804"></a><span id="l35.1804"> };</span>
<a href="#l35.1805"></a><span id="l35.1805"> </span>
<a href="#l35.1806"></a><span id="l35.1806"> function goUpdateAttachmentCommands() {</span>
<a href="#l35.1807"></a><span id="l35.1807" class="difflineminus">-  goUpdateCommand('cmd_openAllAttachments');</span>
<a href="#l35.1808"></a><span id="l35.1808" class="difflineminus">-  goUpdateCommand('cmd_saveAllAttachments');</span>
<a href="#l35.1809"></a><span id="l35.1809" class="difflineminus">-  goUpdateCommand('cmd_detachAllAttachments');</span>
<a href="#l35.1810"></a><span id="l35.1810" class="difflineminus">-  goUpdateCommand('cmd_deleteAllAttachments');</span>
<a href="#l35.1811"></a><span id="l35.1811" class="difflineplus">+  goUpdateCommand(&quot;cmd_openAllAttachments&quot;);</span>
<a href="#l35.1812"></a><span id="l35.1812" class="difflineplus">+  goUpdateCommand(&quot;cmd_saveAllAttachments&quot;);</span>
<a href="#l35.1813"></a><span id="l35.1813" class="difflineplus">+  goUpdateCommand(&quot;cmd_detachAllAttachments&quot;);</span>
<a href="#l35.1814"></a><span id="l35.1814" class="difflineplus">+  goUpdateCommand(&quot;cmd_deleteAllAttachments&quot;);</span>
<a href="#l35.1815"></a><span id="l35.1815"> }</span>
<a href="#l35.1816"></a><span id="l35.1816"> </span>
<a href="#l35.1817"></a><span id="l35.1817" class="difflineminus">-function displayAttachmentsForExpandedView()</span>
<a href="#l35.1818"></a><span id="l35.1818" class="difflineminus">-{</span>
<a href="#l35.1819"></a><span id="l35.1819" class="difflineplus">+function displayAttachmentsForExpandedView() {</span>
<a href="#l35.1820"></a><span id="l35.1820">   var bundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l35.1821"></a><span id="l35.1821">   var numAttachments = currentAttachments.length;</span>
<a href="#l35.1822"></a><span id="l35.1822">   var totalSize = 0;</span>
<a href="#l35.1823"></a><span id="l35.1823">   var attachmentView = document.getElementById(&quot;attachmentView&quot;);</span>
<a href="#l35.1824"></a><span id="l35.1824">   var attachmentSplitter = document.getElementById(&quot;attachment-splitter&quot;);</span>
<a href="#l35.1825"></a><span id="l35.1825"> </span>
<a href="#l35.1826"></a><span id="l35.1826">   if (numAttachments &lt;= 0) {</span>
<a href="#l35.1827"></a><span id="l35.1827">     attachmentView.collapsed = true;</span>
<a href="#l35.1828"></a><span id="l35.1828">     attachmentSplitter.collapsed = true;</span>
<a href="#l35.1829"></a><span id="l35.1829" class="difflineminus">-  }</span>
<a href="#l35.1830"></a><span id="l35.1830" class="difflineminus">-  else if (!gBuildAttachmentsForCurrentMsg) {</span>
<a href="#l35.1831"></a><span id="l35.1831" class="difflineplus">+  } else if (!gBuildAttachmentsForCurrentMsg) {</span>
<a href="#l35.1832"></a><span id="l35.1832">     attachmentView.collapsed = false;</span>
<a href="#l35.1833"></a><span id="l35.1833"> </span>
<a href="#l35.1834"></a><span id="l35.1834">     var attachmentList = document.getElementById(&quot;attachmentList&quot;);</span>
<a href="#l35.1835"></a><span id="l35.1835"> </span>
<a href="#l35.1836"></a><span id="l35.1836">     var viewMode = Services.prefs.getIntPref(&quot;mailnews.attachments.display.view&quot;);</span>
<a href="#l35.1837"></a><span id="l35.1837">     var views = [&quot;small&quot;, &quot;large&quot;, &quot;tile&quot;];</span>
<a href="#l35.1838"></a><span id="l35.1838">     attachmentList.view = views[viewMode];</span>
<a href="#l35.1839"></a><span id="l35.1839">     attachmentList.controllers.appendController(AttachmentListController);</span>
<a href="#l35.1840"></a><span id="l35.1840" class="difflineat">@@ -2339,18 +2240,17 @@ function displayAttachmentsForExpandedVi</span>
<a href="#l35.1841"></a><span id="l35.1841">     gBuildAttachmentsForCurrentMsg = true;</span>
<a href="#l35.1842"></a><span id="l35.1842">   }</span>
<a href="#l35.1843"></a><span id="l35.1843"> }</span>
<a href="#l35.1844"></a><span id="l35.1844"> </span>
<a href="#l35.1845"></a><span id="l35.1845"> /**</span>
<a href="#l35.1846"></a><span id="l35.1846">  * Update the &quot;save all attachments&quot; button in the attachment pane, showing</span>
<a href="#l35.1847"></a><span id="l35.1847">  * the proper button and enabling/disabling it as appropriate.</span>
<a href="#l35.1848"></a><span id="l35.1848">  */</span>
<a href="#l35.1849"></a><span id="l35.1849" class="difflineminus">-function updateSaveAllAttachmentsButton()</span>
<a href="#l35.1850"></a><span id="l35.1850" class="difflineminus">-{</span>
<a href="#l35.1851"></a><span id="l35.1851" class="difflineplus">+function updateSaveAllAttachmentsButton() {</span>
<a href="#l35.1852"></a><span id="l35.1852">   let saveAllSingle   = document.getElementById(&quot;attachmentSaveAllSingle&quot;);</span>
<a href="#l35.1853"></a><span id="l35.1853">   let saveAllMultiple = document.getElementById(&quot;attachmentSaveAllMultiple&quot;);</span>
<a href="#l35.1854"></a><span id="l35.1854"> </span>
<a href="#l35.1855"></a><span id="l35.1855">   // If we can't find the buttons, they're not on the toolbar, so bail out!</span>
<a href="#l35.1856"></a><span id="l35.1856">   if (!saveAllSingle || !saveAllMultiple)</span>
<a href="#l35.1857"></a><span id="l35.1857">     return;</span>
<a href="#l35.1858"></a><span id="l35.1858"> </span>
<a href="#l35.1859"></a><span id="l35.1859">   let allDeleted = currentAttachments.every(function(attachment) {</span>
<a href="#l35.1860"></a><span id="l35.1860" class="difflineat">@@ -2369,18 +2269,17 @@ function updateSaveAllAttachmentsButton(</span>
<a href="#l35.1861"></a><span id="l35.1861">  *</span>
<a href="#l35.1862"></a><span id="l35.1862">  * @param expanded  True if the attachment list should be expanded, false</span>
<a href="#l35.1863"></a><span id="l35.1863">  *                  otherwise. If |expanded| is not specified, toggle the state.</span>
<a href="#l35.1864"></a><span id="l35.1864">  * @param updateFocus  (optional) True if the focus should be updated, focusing</span>
<a href="#l35.1865"></a><span id="l35.1865">  *                     on the attachmentList when expanding, or the messagepane</span>
<a href="#l35.1866"></a><span id="l35.1866">  *                     when collapsing (but only when the attachmentList was</span>
<a href="#l35.1867"></a><span id="l35.1867">  *                     originally focused).</span>
<a href="#l35.1868"></a><span id="l35.1868">  */</span>
<a href="#l35.1869"></a><span id="l35.1869" class="difflineminus">-function toggleAttachmentList(expanded, updateFocus)</span>
<a href="#l35.1870"></a><span id="l35.1870" class="difflineminus">-{</span>
<a href="#l35.1871"></a><span id="l35.1871" class="difflineplus">+function toggleAttachmentList(expanded, updateFocus) {</span>
<a href="#l35.1872"></a><span id="l35.1872">   var attachmentView = document.getElementById(&quot;attachmentView&quot;);</span>
<a href="#l35.1873"></a><span id="l35.1873">   var attachmentBar = document.getElementById(&quot;attachmentBar&quot;);</span>
<a href="#l35.1874"></a><span id="l35.1874">   var attachmentToggle = document.getElementById(&quot;attachmentToggle&quot;);</span>
<a href="#l35.1875"></a><span id="l35.1875">   var attachmentList = document.getElementById(&quot;attachmentList&quot;);</span>
<a href="#l35.1876"></a><span id="l35.1876">   var attachmentSplitter = document.getElementById(&quot;attachment-splitter&quot;);</span>
<a href="#l35.1877"></a><span id="l35.1877">   var bundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l35.1878"></a><span id="l35.1878"> </span>
<a href="#l35.1879"></a><span id="l35.1879">   if (expanded === undefined)</span>
<a href="#l35.1880"></a><span id="l35.1880" class="difflineat">@@ -2422,75 +2321,68 @@ function toggleAttachmentList(expanded, </span>
<a href="#l35.1881"></a><span id="l35.1881">       SetFocusMessagePane();</span>
<a href="#l35.1882"></a><span id="l35.1882">   }</span>
<a href="#l35.1883"></a><span id="l35.1883"> }</span>
<a href="#l35.1884"></a><span id="l35.1884"> </span>
<a href="#l35.1885"></a><span id="l35.1885"> /**</span>
<a href="#l35.1886"></a><span id="l35.1886">  * Pick out a nice icon for the attachment.</span>
<a href="#l35.1887"></a><span id="l35.1887">  * @param attachment  the nsIMsgAttachment object to show icon for</span>
<a href="#l35.1888"></a><span id="l35.1888">  */</span>
<a href="#l35.1889"></a><span id="l35.1889" class="difflineminus">-function getIconForAttachment(attachment)</span>
<a href="#l35.1890"></a><span id="l35.1890" class="difflineminus">-{</span>
<a href="#l35.1891"></a><span id="l35.1891" class="difflineplus">+function getIconForAttachment(attachment) {</span>
<a href="#l35.1892"></a><span id="l35.1892">   if (attachment.isDeleted) {</span>
<a href="#l35.1893"></a><span id="l35.1893">     return &quot;chrome://messenger/skin/icon/attachment-deleted.png&quot;;</span>
<a href="#l35.1894"></a><span id="l35.1894" class="difflineminus">-  } else {</span>
<a href="#l35.1895"></a><span id="l35.1895" class="difflineminus">-    return &quot;moz-icon://&quot; + attachment.name + &quot;?size=16&amp;amp;contentType=&quot; +</span>
<a href="#l35.1896"></a><span id="l35.1896" class="difflineminus">-           attachment.contentType;</span>
<a href="#l35.1897"></a><span id="l35.1897">   }</span>
<a href="#l35.1898"></a><span id="l35.1898" class="difflineplus">+  return `moz-icon://${attachment.name}?size=16&amp;amp;contentType=${attachment.contentType}`;</span>
<a href="#l35.1899"></a><span id="l35.1899"> }</span>
<a href="#l35.1900"></a><span id="l35.1900"> </span>
<a href="#l35.1901"></a><span id="l35.1901"> /**</span>
<a href="#l35.1902"></a><span id="l35.1902">  * Public method called when we create the attachments file menu</span>
<a href="#l35.1903"></a><span id="l35.1903">  */</span>
<a href="#l35.1904"></a><span id="l35.1904" class="difflineminus">-function FillAttachmentListPopup(aEvent, aPopup)</span>
<a href="#l35.1905"></a><span id="l35.1905" class="difflineminus">-{</span>
<a href="#l35.1906"></a><span id="l35.1906" class="difflineplus">+function FillAttachmentListPopup(aEvent, aPopup) {</span>
<a href="#l35.1907"></a><span id="l35.1907">   // First clear out the old view...</span>
<a href="#l35.1908"></a><span id="l35.1908">   ClearAttachmentMenu(aPopup);</span>
<a href="#l35.1909"></a><span id="l35.1909"> </span>
<a href="#l35.1910"></a><span id="l35.1910">   for (let [attachmentIndex, attachment] of currentAttachments.entries())</span>
<a href="#l35.1911"></a><span id="l35.1911">     addAttachmentToPopup(aPopup, attachment, attachmentIndex);</span>
<a href="#l35.1912"></a><span id="l35.1912"> </span>
<a href="#l35.1913"></a><span id="l35.1913">   goUpdateAttachmentCommands();</span>
<a href="#l35.1914"></a><span id="l35.1914"> }</span>
<a href="#l35.1915"></a><span id="l35.1915"> </span>
<a href="#l35.1916"></a><span id="l35.1916"> // Public method used to clear the file attachment menu</span>
<a href="#l35.1917"></a><span id="l35.1917" class="difflineminus">-function ClearAttachmentMenu(popup)</span>
<a href="#l35.1918"></a><span id="l35.1918" class="difflineminus">-{</span>
<a href="#l35.1919"></a><span id="l35.1919" class="difflineplus">+function ClearAttachmentMenu(popup) {</span>
<a href="#l35.1920"></a><span id="l35.1920">   if (popup) {</span>
<a href="#l35.1921"></a><span id="l35.1921">     while (popup.firstChild.localName == &quot;menu&quot;)</span>
<a href="#l35.1922"></a><span id="l35.1922">       popup.firstChild.remove();</span>
<a href="#l35.1923"></a><span id="l35.1923">   }</span>
<a href="#l35.1924"></a><span id="l35.1924"> }</span>
<a href="#l35.1925"></a><span id="l35.1925"> </span>
<a href="#l35.1926"></a><span id="l35.1926"> /**</span>
<a href="#l35.1927"></a><span id="l35.1927">  * Create a menu for a single attachment.</span>
<a href="#l35.1928"></a><span id="l35.1928">  *</span>
<a href="#l35.1929"></a><span id="l35.1929">  * @param popup  the popup to add the menu to</span>
<a href="#l35.1930"></a><span id="l35.1930">  * @param attachment  the AttachmentInfo object to add</span>
<a href="#l35.1931"></a><span id="l35.1931">  * @param attachmentIndex  the index (starting at 0) of this attachment</span>
<a href="#l35.1932"></a><span id="l35.1932">  */</span>
<a href="#l35.1933"></a><span id="l35.1933" class="difflineminus">-function addAttachmentToPopup(popup, attachment, attachmentIndex)</span>
<a href="#l35.1934"></a><span id="l35.1934" class="difflineminus">-{</span>
<a href="#l35.1935"></a><span id="l35.1935" class="difflineplus">+function addAttachmentToPopup(popup, attachment, attachmentIndex) {</span>
<a href="#l35.1936"></a><span id="l35.1936">   if (!popup)</span>
<a href="#l35.1937"></a><span id="l35.1937">     return;</span>
<a href="#l35.1938"></a><span id="l35.1938"> </span>
<a href="#l35.1939"></a><span id="l35.1939">   var item = document.createElement(&quot;menu&quot;);</span>
<a href="#l35.1940"></a><span id="l35.1940">   if (!item)</span>
<a href="#l35.1941"></a><span id="l35.1941">     return;</span>
<a href="#l35.1942"></a><span id="l35.1942"> </span>
<a href="#l35.1943"></a><span id="l35.1943">   function getString(aName) {</span>
<a href="#l35.1944"></a><span id="l35.1944">     return document.getElementById(&quot;bundle_messenger&quot;).getString(aName);</span>
<a href="#l35.1945"></a><span id="l35.1945">   }</span>
<a href="#l35.1946"></a><span id="l35.1946"> </span>
<a href="#l35.1947"></a><span id="l35.1947">   // Insert the item just before the separator. The separator is the 2nd to</span>
<a href="#l35.1948"></a><span id="l35.1948">   // last element in the popup.</span>
<a href="#l35.1949"></a><span id="l35.1949">   item.setAttribute(&quot;class&quot;, &quot;menu-iconic&quot;);</span>
<a href="#l35.1950"></a><span id="l35.1950">   item.setAttribute(&quot;image&quot;, getIconForAttachment(attachment));</span>
<a href="#l35.1951"></a><span id="l35.1951"> </span>
<a href="#l35.1952"></a><span id="l35.1952" class="difflineminus">-  var numItemsInPopup = popup.childNodes.length;</span>
<a href="#l35.1953"></a><span id="l35.1953">   // find the separator</span>
<a href="#l35.1954"></a><span id="l35.1954">   var indexOfSeparator = 0;</span>
<a href="#l35.1955"></a><span id="l35.1955">   while (popup.childNodes[indexOfSeparator].localName != &quot;menuseparator&quot;)</span>
<a href="#l35.1956"></a><span id="l35.1956">     indexOfSeparator++;</span>
<a href="#l35.1957"></a><span id="l35.1957">   // We increment the attachmentIndex here since we only use it for the</span>
<a href="#l35.1958"></a><span id="l35.1958">   // label and accesskey attributes, and we want the accesskeys for the</span>
<a href="#l35.1959"></a><span id="l35.1959">   // attachments list in the menu to be 1-indexed.</span>
<a href="#l35.1960"></a><span id="l35.1960">   attachmentIndex++;</span>
<a href="#l35.1961"></a><span id="l35.1961" class="difflineat">@@ -2566,79 +2458,73 @@ function addAttachmentToPopup(popup, att</span>
<a href="#l35.1962"></a><span id="l35.1962">   menuitementry = openpopup.appendChild(menuitementry);</span>
<a href="#l35.1963"></a><span id="l35.1963"> }</span>
<a href="#l35.1964"></a><span id="l35.1964"> </span>
<a href="#l35.1965"></a><span id="l35.1965"> /**</span>
<a href="#l35.1966"></a><span id="l35.1966">  * Open an attachment from the attachment bar.</span>
<a href="#l35.1967"></a><span id="l35.1967">  *</span>
<a href="#l35.1968"></a><span id="l35.1968">  * @param event the event that triggered this action</span>
<a href="#l35.1969"></a><span id="l35.1969">  */</span>
<a href="#l35.1970"></a><span id="l35.1970" class="difflineminus">-function OpenAttachmentFromBar(event)</span>
<a href="#l35.1971"></a><span id="l35.1971" class="difflineminus">-{</span>
<a href="#l35.1972"></a><span id="l35.1972" class="difflineplus">+function OpenAttachmentFromBar(event) {</span>
<a href="#l35.1973"></a><span id="l35.1973">   if (event.button == 0) {</span>
<a href="#l35.1974"></a><span id="l35.1974">     // Only open on the first click; ignore double-clicks so that the user</span>
<a href="#l35.1975"></a><span id="l35.1975">     // doesn't end up with the attachment opened multiple times.</span>
<a href="#l35.1976"></a><span id="l35.1976">     if (event.detail == 1)</span>
<a href="#l35.1977"></a><span id="l35.1977" class="difflineminus">-      TryHandleAllAttachments('open');</span>
<a href="#l35.1978"></a><span id="l35.1978" class="difflineplus">+      TryHandleAllAttachments(&quot;open&quot;);</span>
<a href="#l35.1979"></a><span id="l35.1979">     RestoreFocusAfterHdrButton();</span>
<a href="#l35.1980"></a><span id="l35.1980">     event.stopPropagation();</span>
<a href="#l35.1981"></a><span id="l35.1981">   }</span>
<a href="#l35.1982"></a><span id="l35.1982"> }</span>
<a href="#l35.1983"></a><span id="l35.1983"> </span>
<a href="#l35.1984"></a><span id="l35.1984"> /**</span>
<a href="#l35.1985"></a><span id="l35.1985">  * Handle all the attachments in this message (save them, open them, etc).</span>
<a href="#l35.1986"></a><span id="l35.1986">  *</span>
<a href="#l35.1987"></a><span id="l35.1987">  * @param action one of &quot;open&quot;, &quot;save&quot;, &quot;saveAs&quot;, &quot;detach&quot;, or &quot;delete&quot;</span>
<a href="#l35.1988"></a><span id="l35.1988">  */</span>
<a href="#l35.1989"></a><span id="l35.1989" class="difflineminus">-function HandleAllAttachments(action)</span>
<a href="#l35.1990"></a><span id="l35.1990" class="difflineminus">-{</span>
<a href="#l35.1991"></a><span id="l35.1991" class="difflineplus">+function HandleAllAttachments(action) {</span>
<a href="#l35.1992"></a><span id="l35.1992">   HandleMultipleAttachments(currentAttachments, action);</span>
<a href="#l35.1993"></a><span id="l35.1993"> }</span>
<a href="#l35.1994"></a><span id="l35.1994"> </span>
<a href="#l35.1995"></a><span id="l35.1995"> /**</span>
<a href="#l35.1996"></a><span id="l35.1996">  * Try to handle all the attachments in this message (save them, open them,</span>
<a href="#l35.1997"></a><span id="l35.1997">  * etc). If the action fails for whatever reason, catch the error and report it.</span>
<a href="#l35.1998"></a><span id="l35.1998">  *</span>
<a href="#l35.1999"></a><span id="l35.1999">  * @param action  one of &quot;open&quot;, &quot;save&quot;, &quot;saveAs&quot;, &quot;detach&quot;, or &quot;delete&quot;</span>
<a href="#l35.2000"></a><span id="l35.2000">  */</span>
<a href="#l35.2001"></a><span id="l35.2001" class="difflineminus">-function TryHandleAllAttachments(action)</span>
<a href="#l35.2002"></a><span id="l35.2002" class="difflineminus">-{</span>
<a href="#l35.2003"></a><span id="l35.2003" class="difflineplus">+function TryHandleAllAttachments(action) {</span>
<a href="#l35.2004"></a><span id="l35.2004">   try {</span>
<a href="#l35.2005"></a><span id="l35.2005" class="difflineminus">-    HandleAllAttachments(action)</span>
<a href="#l35.2006"></a><span id="l35.2006" class="difflineminus">-  }</span>
<a href="#l35.2007"></a><span id="l35.2007" class="difflineminus">-  catch (e) {</span>
<a href="#l35.2008"></a><span id="l35.2008" class="difflineplus">+    HandleAllAttachments(action);</span>
<a href="#l35.2009"></a><span id="l35.2009" class="difflineplus">+  } catch (e) {</span>
<a href="#l35.2010"></a><span id="l35.2010">     Cu.reportError(e);</span>
<a href="#l35.2011"></a><span id="l35.2011">   }</span>
<a href="#l35.2012"></a><span id="l35.2012"> }</span>
<a href="#l35.2013"></a><span id="l35.2013"> </span>
<a href="#l35.2014"></a><span id="l35.2014"> /**</span>
<a href="#l35.2015"></a><span id="l35.2015">  * Handle the currently-selected attachments in this message (save them, open</span>
<a href="#l35.2016"></a><span id="l35.2016">  * them, etc).</span>
<a href="#l35.2017"></a><span id="l35.2017">  *</span>
<a href="#l35.2018"></a><span id="l35.2018">  * @param action  one of &quot;open&quot;, &quot;save&quot;, &quot;saveAs&quot;, &quot;detach&quot;, or &quot;delete&quot;</span>
<a href="#l35.2019"></a><span id="l35.2019">  */</span>
<a href="#l35.2020"></a><span id="l35.2020" class="difflineminus">-function HandleSelectedAttachments(action)</span>
<a href="#l35.2021"></a><span id="l35.2021" class="difflineminus">-{</span>
<a href="#l35.2022"></a><span id="l35.2022" class="difflineplus">+function HandleSelectedAttachments(action) {</span>
<a href="#l35.2023"></a><span id="l35.2023">   let attachmentList = document.getElementById(&quot;attachmentList&quot;);</span>
<a href="#l35.2024"></a><span id="l35.2024">   let selectedAttachments = [];</span>
<a href="#l35.2025"></a><span id="l35.2025">   for (let item of attachmentList.selectedItems) {</span>
<a href="#l35.2026"></a><span id="l35.2026">     selectedAttachments.push(item.attachment);</span>
<a href="#l35.2027"></a><span id="l35.2027">   }</span>
<a href="#l35.2028"></a><span id="l35.2028"> </span>
<a href="#l35.2029"></a><span id="l35.2029">   HandleMultipleAttachments(selectedAttachments, action);</span>
<a href="#l35.2030"></a><span id="l35.2030"> }</span>
<a href="#l35.2031"></a><span id="l35.2031"> </span>
<a href="#l35.2032"></a><span id="l35.2032"> /**</span>
<a href="#l35.2033"></a><span id="l35.2033">  * Perform an action on multiple attachments (e.g. open or save)</span>
<a href="#l35.2034"></a><span id="l35.2034">  *</span>
<a href="#l35.2035"></a><span id="l35.2035">  * @param attachments  an array of AttachmentInfo objects to work with</span>
<a href="#l35.2036"></a><span id="l35.2036">  * @param action  one of &quot;open&quot;, &quot;save&quot;, &quot;saveAs&quot;, &quot;detach&quot;, or &quot;delete&quot;</span>
<a href="#l35.2037"></a><span id="l35.2037">  */</span>
<a href="#l35.2038"></a><span id="l35.2038" class="difflineminus">-function HandleMultipleAttachments(attachments, action)</span>
<a href="#l35.2039"></a><span id="l35.2039" class="difflineminus">-{</span>
<a href="#l35.2040"></a><span id="l35.2040" class="difflineplus">+function HandleMultipleAttachments(attachments, action) {</span>
<a href="#l35.2041"></a><span id="l35.2041">   // convert our attachment data into some c++ friendly structs</span>
<a href="#l35.2042"></a><span id="l35.2042">   var attachmentContentTypeArray = [];</span>
<a href="#l35.2043"></a><span id="l35.2043">   var attachmentUrlArray = [];</span>
<a href="#l35.2044"></a><span id="l35.2044">   var attachmentDisplayNameArray = [];</span>
<a href="#l35.2045"></a><span id="l35.2045">   var attachmentMessageUriArray = [];</span>
<a href="#l35.2046"></a><span id="l35.2046"> </span>
<a href="#l35.2047"></a><span id="l35.2047">   // populate these arrays..</span>
<a href="#l35.2048"></a><span id="l35.2048">   var actionIndex = 0;</span>
<a href="#l35.2049"></a><span id="l35.2049" class="difflineat">@@ -2717,18 +2603,17 @@ function HandleMultipleAttachments(attac</span>
<a href="#l35.2050"></a><span id="l35.2050">                         .getService(Ci.nsIClipboardHelper);</span>
<a href="#l35.2051"></a><span id="l35.2051">       clipboard.copyString(attachmentUrlArray.join(&quot;\n&quot;));</span>
<a href="#l35.2052"></a><span id="l35.2052">       return;</span>
<a href="#l35.2053"></a><span id="l35.2053">     default:</span>
<a href="#l35.2054"></a><span id="l35.2054">       throw new Error(&quot;unknown HandleMultipleAttachments action: &quot; + action);</span>
<a href="#l35.2055"></a><span id="l35.2055">   }</span>
<a href="#l35.2056"></a><span id="l35.2056"> }</span>
<a href="#l35.2057"></a><span id="l35.2057"> </span>
<a href="#l35.2058"></a><span id="l35.2058" class="difflineminus">-function ClearAttachmentList()</span>
<a href="#l35.2059"></a><span id="l35.2059" class="difflineminus">-{</span>
<a href="#l35.2060"></a><span id="l35.2060" class="difflineplus">+function ClearAttachmentList() {</span>
<a href="#l35.2061"></a><span id="l35.2061">   // We also have to disable the Message/Attachments menuitem.</span>
<a href="#l35.2062"></a><span id="l35.2062">   var node = document.getElementById(&quot;msgAttachmentMenu&quot;);</span>
<a href="#l35.2063"></a><span id="l35.2063">   if (node)</span>
<a href="#l35.2064"></a><span id="l35.2064">     node.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l35.2065"></a><span id="l35.2065">   // Do the same on appmenu.</span>
<a href="#l35.2066"></a><span id="l35.2066">   let appmenunode = document.getElementById(&quot;appmenu_msgAttachmentMenu&quot;);</span>
<a href="#l35.2067"></a><span id="l35.2067">   if (appmenunode)</span>
<a href="#l35.2068"></a><span id="l35.2068">     appmenunode.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l35.2069"></a><span id="l35.2069" class="difflineat">@@ -2737,99 +2622,93 @@ function ClearAttachmentList()</span>
<a href="#l35.2070"></a><span id="l35.2070">   var list = document.getElementById(&quot;attachmentList&quot;);</span>
<a href="#l35.2071"></a><span id="l35.2071">   list.clearSelection();</span>
<a href="#l35.2072"></a><span id="l35.2072"> </span>
<a href="#l35.2073"></a><span id="l35.2073">   while (list.hasChildNodes())</span>
<a href="#l35.2074"></a><span id="l35.2074">     list.lastChild.remove();</span>
<a href="#l35.2075"></a><span id="l35.2075"> }</span>
<a href="#l35.2076"></a><span id="l35.2076"> </span>
<a href="#l35.2077"></a><span id="l35.2077"> var attachmentListDNDObserver = {</span>
<a href="#l35.2078"></a><span id="l35.2078" class="difflineminus">-  onDragStart: function (aEvent, aAttachmentData, aDragAction)</span>
<a href="#l35.2079"></a><span id="l35.2079" class="difflineminus">-  {</span>
<a href="#l35.2080"></a><span id="l35.2080" class="difflineplus">+  onDragStart(aEvent, aAttachmentData, aDragAction) {</span>
<a href="#l35.2081"></a><span id="l35.2081">     let target = aEvent.target;</span>
<a href="#l35.2082"></a><span id="l35.2082"> </span>
<a href="#l35.2083"></a><span id="l35.2083">     if (target.localName == &quot;attachmentitem&quot;) {</span>
<a href="#l35.2084"></a><span id="l35.2084">       let selection = target.parentNode.selectedItems;</span>
<a href="#l35.2085"></a><span id="l35.2085">       aAttachmentData.data = new TransferDataSet();</span>
<a href="#l35.2086"></a><span id="l35.2086">       for (let item of selection) {</span>
<a href="#l35.2087"></a><span id="l35.2087">         let transferData = CreateAttachmentTransferData(item.attachment);</span>
<a href="#l35.2088"></a><span id="l35.2088">         if (transferData)</span>
<a href="#l35.2089"></a><span id="l35.2089">           aAttachmentData.data.push(transferData);</span>
<a href="#l35.2090"></a><span id="l35.2090">       }</span>
<a href="#l35.2091"></a><span id="l35.2091">     }</span>
<a href="#l35.2092"></a><span id="l35.2092" class="difflineminus">-  }</span>
<a href="#l35.2093"></a><span id="l35.2093" class="difflineplus">+  },</span>
<a href="#l35.2094"></a><span id="l35.2094"> };</span>
<a href="#l35.2095"></a><span id="l35.2095"> </span>
<a href="#l35.2096"></a><span id="l35.2096"> var attachmentNameDNDObserver = {</span>
<a href="#l35.2097"></a><span id="l35.2097" class="difflineminus">-  onDragStart: function (aEvent, aAttachmentData, aDragAction)</span>
<a href="#l35.2098"></a><span id="l35.2098" class="difflineminus">-  {</span>
<a href="#l35.2099"></a><span id="l35.2099" class="difflineplus">+  onDragStart(aEvent, aAttachmentData, aDragAction) {</span>
<a href="#l35.2100"></a><span id="l35.2100">     var attachmentList = document.getElementById(&quot;attachmentList&quot;);</span>
<a href="#l35.2101"></a><span id="l35.2101">     aAttachmentData.data = CreateAttachmentTransferData(</span>
<a href="#l35.2102"></a><span id="l35.2102">       attachmentList.getItemAtIndex(0).attachment);</span>
<a href="#l35.2103"></a><span id="l35.2103" class="difflineminus">-  }</span>
<a href="#l35.2104"></a><span id="l35.2104" class="difflineplus">+  },</span>
<a href="#l35.2105"></a><span id="l35.2105"> };</span>
<a href="#l35.2106"></a><span id="l35.2106"> </span>
<a href="#l35.2107"></a><span id="l35.2107"> /**</span>
<a href="#l35.2108"></a><span id="l35.2108">  * CopyWebsiteAddress takes the website address title button, extracts</span>
<a href="#l35.2109"></a><span id="l35.2109">  * the website address we stored in there and copies it to the clipboard</span>
<a href="#l35.2110"></a><span id="l35.2110">  */</span>
<a href="#l35.2111"></a><span id="l35.2111" class="difflineminus">-function CopyWebsiteAddress(websiteAddressNode)</span>
<a href="#l35.2112"></a><span id="l35.2112" class="difflineminus">-{</span>
<a href="#l35.2113"></a><span id="l35.2113" class="difflineplus">+function CopyWebsiteAddress(websiteAddressNode) {</span>
<a href="#l35.2114"></a><span id="l35.2114">   if (websiteAddressNode) {</span>
<a href="#l35.2115"></a><span id="l35.2115">     var websiteAddress = websiteAddressNode.textContent;</span>
<a href="#l35.2116"></a><span id="l35.2116"> </span>
<a href="#l35.2117"></a><span id="l35.2117">     var contractid = &quot;@mozilla.org/widget/clipboardhelper;1&quot;;</span>
<a href="#l35.2118"></a><span id="l35.2118">     var iid = Ci.nsIClipboardHelper;</span>
<a href="#l35.2119"></a><span id="l35.2119">     var clipboard = Cc[contractid].getService(iid);</span>
<a href="#l35.2120"></a><span id="l35.2120">     clipboard.copyString(websiteAddress);</span>
<a href="#l35.2121"></a><span id="l35.2121">   }</span>
<a href="#l35.2122"></a><span id="l35.2122"> }</span>
<a href="#l35.2123"></a><span id="l35.2123"> </span>
<a href="#l35.2124"></a><span id="l35.2124" class="difflineminus">-function nsDummyMsgHeader()</span>
<a href="#l35.2125"></a><span id="l35.2125" class="difflineminus">-{</span>
<a href="#l35.2126"></a><span id="l35.2126" class="difflineplus">+function nsDummyMsgHeader() {</span>
<a href="#l35.2127"></a><span id="l35.2127"> }</span>
<a href="#l35.2128"></a><span id="l35.2128"> </span>
<a href="#l35.2129"></a><span id="l35.2129" class="difflineminus">-nsDummyMsgHeader.prototype =</span>
<a href="#l35.2130"></a><span id="l35.2130" class="difflineminus">-{</span>
<a href="#l35.2131"></a><span id="l35.2131" class="difflineminus">-  mProperties : new Array,</span>
<a href="#l35.2132"></a><span id="l35.2132" class="difflineminus">-  getStringProperty : function(aProperty) {</span>
<a href="#l35.2133"></a><span id="l35.2133" class="difflineplus">+nsDummyMsgHeader.prototype = {</span>
<a href="#l35.2134"></a><span id="l35.2134" class="difflineplus">+  mProperties: [],</span>
<a href="#l35.2135"></a><span id="l35.2135" class="difflineplus">+  getStringProperty(aProperty) {</span>
<a href="#l35.2136"></a><span id="l35.2136">     if (aProperty in this.mProperties)</span>
<a href="#l35.2137"></a><span id="l35.2137">       return this.mProperties[aProperty];</span>
<a href="#l35.2138"></a><span id="l35.2138">     return &quot;&quot;;</span>
<a href="#l35.2139"></a><span id="l35.2139">   },</span>
<a href="#l35.2140"></a><span id="l35.2140" class="difflineminus">-  setStringProperty : function(aProperty, aVal) {</span>
<a href="#l35.2141"></a><span id="l35.2141" class="difflineplus">+  setStringProperty(aProperty, aVal) {</span>
<a href="#l35.2142"></a><span id="l35.2142">     this.mProperties[aProperty] = aVal;</span>
<a href="#l35.2143"></a><span id="l35.2143">   },</span>
<a href="#l35.2144"></a><span id="l35.2144" class="difflineminus">-  getUint32Property : function(aProperty) {</span>
<a href="#l35.2145"></a><span id="l35.2145" class="difflineplus">+  getUint32Property(aProperty) {</span>
<a href="#l35.2146"></a><span id="l35.2146">     if (aProperty in this.mProperties)</span>
<a href="#l35.2147"></a><span id="l35.2147">       return parseInt(this.mProperties[aProperty]);</span>
<a href="#l35.2148"></a><span id="l35.2148">     return 0;</span>
<a href="#l35.2149"></a><span id="l35.2149">   },</span>
<a href="#l35.2150"></a><span id="l35.2150" class="difflineminus">-  setUint32Property: function(aProperty, aVal) {</span>
<a href="#l35.2151"></a><span id="l35.2151" class="difflineplus">+  setUint32Property(aProperty, aVal) {</span>
<a href="#l35.2152"></a><span id="l35.2152">     this.mProperties[aProperty] = aVal.toString();</span>
<a href="#l35.2153"></a><span id="l35.2153">   },</span>
<a href="#l35.2154"></a><span id="l35.2154" class="difflineminus">-  markHasAttachments : function(hasAttachments) {},</span>
<a href="#l35.2155"></a><span id="l35.2155" class="difflineminus">-  messageSize : 0,</span>
<a href="#l35.2156"></a><span id="l35.2156" class="difflineminus">-  recipients : null,</span>
<a href="#l35.2157"></a><span id="l35.2157" class="difflineplus">+  markHasAttachments(hasAttachments) {},</span>
<a href="#l35.2158"></a><span id="l35.2158" class="difflineplus">+  messageSize: 0,</span>
<a href="#l35.2159"></a><span id="l35.2159" class="difflineplus">+  recipients: null,</span>
<a href="#l35.2160"></a><span id="l35.2160">   author: null,</span>
<a href="#l35.2161"></a><span id="l35.2161" class="difflineminus">-  subject : &quot;&quot;,</span>
<a href="#l35.2162"></a><span id="l35.2162" class="difflineplus">+  subject: &quot;&quot;,</span>
<a href="#l35.2163"></a><span id="l35.2163">   get mime2DecodedSubject() { return this.subject; },</span>
<a href="#l35.2164"></a><span id="l35.2164" class="difflineminus">-  ccList : null,</span>
<a href="#l35.2165"></a><span id="l35.2165" class="difflineminus">-  listPost : null,</span>
<a href="#l35.2166"></a><span id="l35.2166" class="difflineminus">-  messageId : null,</span>
<a href="#l35.2167"></a><span id="l35.2167" class="difflineminus">-  date : 0,</span>
<a href="#l35.2168"></a><span id="l35.2168" class="difflineminus">-  accountKey : &quot;&quot;,</span>
<a href="#l35.2169"></a><span id="l35.2169" class="difflineminus">-  flags : 0,</span>
<a href="#l35.2170"></a><span id="l35.2170" class="difflineplus">+  ccList: null,</span>
<a href="#l35.2171"></a><span id="l35.2171" class="difflineplus">+  listPost: null,</span>
<a href="#l35.2172"></a><span id="l35.2172" class="difflineplus">+  messageId: null,</span>
<a href="#l35.2173"></a><span id="l35.2173" class="difflineplus">+  date: 0,</span>
<a href="#l35.2174"></a><span id="l35.2174" class="difflineplus">+  accountKey: &quot;&quot;,</span>
<a href="#l35.2175"></a><span id="l35.2175" class="difflineplus">+  flags: 0,</span>
<a href="#l35.2176"></a><span id="l35.2176">   // If you change us to return a fake folder, please update</span>
<a href="#l35.2177"></a><span id="l35.2177">   // folderDisplay.js's FolderDisplayWidget's selectedMessageIsExternal getter.</span>
<a href="#l35.2178"></a><span id="l35.2178" class="difflineminus">-  folder : null</span>
<a href="#l35.2179"></a><span id="l35.2179" class="difflineplus">+  folder: null,</span>
<a href="#l35.2180"></a><span id="l35.2180"> };</span>
<a href="#l35.2181"></a><span id="l35.2181"> </span>
<a href="#l35.2182"></a><span id="l35.2182" class="difflineminus">-function onShowOtherActionsPopup()</span>
<a href="#l35.2183"></a><span id="l35.2183" class="difflineminus">-{</span>
<a href="#l35.2184"></a><span id="l35.2184" class="difflineplus">+function onShowOtherActionsPopup() {</span>
<a href="#l35.2185"></a><span id="l35.2185">   // Enable/disable the Open Conversation button.</span>
<a href="#l35.2186"></a><span id="l35.2186">   let glodaEnabled = Services.prefs.getBoolPref(&quot;mailnews.database.global.indexer.enabled&quot;);</span>
<a href="#l35.2187"></a><span id="l35.2187"> </span>
<a href="#l35.2188"></a><span id="l35.2188">   let openConversation = document.getElementById(&quot;otherActionsOpenConversation&quot;);</span>
<a href="#l35.2189"></a><span id="l35.2189">   openConversation.disabled = !glodaEnabled;</span>
<a href="#l35.2190"></a><span id="l35.2190">   if (glodaEnabled &amp;&amp; gFolderDisplay.selectedCount &gt; 0) {</span>
<a href="#l35.2191"></a><span id="l35.2191">     let message = gFolderDisplay.selectedMessage;</span>
<a href="#l35.2192"></a><span id="l35.2192">     let isMessageIndexed = Gloda.isMessageIndexed(message);</span>
<a href="#l35.2193"></a><span id="l35.2193" class="difflineat">@@ -2841,62 +2720,61 @@ function onShowOtherActionsPopup()</span>
<a href="#l35.2194"></a><span id="l35.2194">     document.getElementById(&quot;markAsUnreadMenuItem&quot;).removeAttribute(&quot;hidden&quot;);</span>
<a href="#l35.2195"></a><span id="l35.2195">   } else {</span>
<a href="#l35.2196"></a><span id="l35.2196">     document.getElementById(&quot;markAsReadMenuItem&quot;).removeAttribute(&quot;hidden&quot;);</span>
<a href="#l35.2197"></a><span id="l35.2197">     document.getElementById(&quot;markAsUnreadMenuItem&quot;).setAttribute(&quot;hidden&quot;,</span>
<a href="#l35.2198"></a><span id="l35.2198">                                                                  true);</span>
<a href="#l35.2199"></a><span id="l35.2199">   }</span>
<a href="#l35.2200"></a><span id="l35.2200"> }</span>
<a href="#l35.2201"></a><span id="l35.2201"> </span>
<a href="#l35.2202"></a><span id="l35.2202" class="difflineminus">-function ConversationOpener()</span>
<a href="#l35.2203"></a><span id="l35.2203" class="difflineminus">-{</span>
<a href="#l35.2204"></a><span id="l35.2204" class="difflineplus">+function ConversationOpener() {</span>
<a href="#l35.2205"></a><span id="l35.2205"> }</span>
<a href="#l35.2206"></a><span id="l35.2206"> </span>
<a href="#l35.2207"></a><span id="l35.2207"> ConversationOpener.prototype = {</span>
<a href="#l35.2208"></a><span id="l35.2208" class="difflineminus">-  openConversationForMessages: function(messages) {</span>
<a href="#l35.2209"></a><span id="l35.2209" class="difflineplus">+  openConversationForMessages(messages) {</span>
<a href="#l35.2210"></a><span id="l35.2210">     if (messages.length &lt; 1)</span>
<a href="#l35.2211"></a><span id="l35.2211">       return;</span>
<a href="#l35.2212"></a><span id="l35.2212">     try {</span>
<a href="#l35.2213"></a><span id="l35.2213">       this._items = [];</span>
<a href="#l35.2214"></a><span id="l35.2214">       this._msgHdr = messages[0];</span>
<a href="#l35.2215"></a><span id="l35.2215">       this._queries = [Gloda.getMessageCollectionForHeaders(messages, this)];</span>
<a href="#l35.2216"></a><span id="l35.2216">     } catch (e) {</span>
<a href="#l35.2217"></a><span id="l35.2217">       logException(e);</span>
<a href="#l35.2218"></a><span id="l35.2218">     }</span>
<a href="#l35.2219"></a><span id="l35.2219">   },</span>
<a href="#l35.2220"></a><span id="l35.2220" class="difflineminus">-  isSelectedMessageIndexed: function() {</span>
<a href="#l35.2221"></a><span id="l35.2221" class="difflineplus">+  isSelectedMessageIndexed() {</span>
<a href="#l35.2222"></a><span id="l35.2222">     let glodaEnabled = Services.prefs</span>
<a href="#l35.2223"></a><span id="l35.2223">       .getBoolPref(&quot;mailnews.database.global.indexer.enabled&quot;);</span>
<a href="#l35.2224"></a><span id="l35.2224"> </span>
<a href="#l35.2225"></a><span id="l35.2225">     if (glodaEnabled &amp;&amp; gFolderDisplay.selectedCount &gt; 0) {</span>
<a href="#l35.2226"></a><span id="l35.2226">       let message = gFolderDisplay.selectedMessage;</span>
<a href="#l35.2227"></a><span id="l35.2227">       return Gloda.isMessageIndexed(message);</span>
<a href="#l35.2228"></a><span id="l35.2228">     }</span>
<a href="#l35.2229"></a><span id="l35.2229">     return false;</span>
<a href="#l35.2230"></a><span id="l35.2230">   },</span>
<a href="#l35.2231"></a><span id="l35.2231" class="difflineminus">-  onItemsAdded: function(aItems) {</span>
<a href="#l35.2232"></a><span id="l35.2232" class="difflineplus">+  onItemsAdded(aItems) {</span>
<a href="#l35.2233"></a><span id="l35.2233">   },</span>
<a href="#l35.2234"></a><span id="l35.2234" class="difflineminus">-  onItemsModified: function(aItems) {</span>
<a href="#l35.2235"></a><span id="l35.2235" class="difflineplus">+  onItemsModified(aItems) {</span>
<a href="#l35.2236"></a><span id="l35.2236">   },</span>
<a href="#l35.2237"></a><span id="l35.2237" class="difflineminus">-  onItemsRemoved: function(aItems) {</span>
<a href="#l35.2238"></a><span id="l35.2238" class="difflineplus">+  onItemsRemoved(aItems) {</span>
<a href="#l35.2239"></a><span id="l35.2239">   },</span>
<a href="#l35.2240"></a><span id="l35.2240" class="difflineminus">-  onQueryCompleted: function(aCollection) {</span>
<a href="#l35.2241"></a><span id="l35.2241" class="difflineplus">+  onQueryCompleted(aCollection) {</span>
<a href="#l35.2242"></a><span id="l35.2242">     try {</span>
<a href="#l35.2243"></a><span id="l35.2243">       if (!aCollection.items.length) {</span>
<a href="#l35.2244"></a><span id="l35.2244">         Cu.reportError(&quot;Couldn't find a collection for msg: &quot; +</span>
<a href="#l35.2245"></a><span id="l35.2245">                        this._msgHdr);</span>
<a href="#l35.2246"></a><span id="l35.2246">       } else {</span>
<a href="#l35.2247"></a><span id="l35.2247">         let aMessage = aCollection.items[0];</span>
<a href="#l35.2248"></a><span id="l35.2248">         let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l35.2249"></a><span id="l35.2249">         tabmail.openTab(&quot;glodaList&quot;, {</span>
<a href="#l35.2250"></a><span id="l35.2250">           conversation: aMessage.conversation,</span>
<a href="#l35.2251"></a><span id="l35.2251">           message: aMessage,</span>
<a href="#l35.2252"></a><span id="l35.2252">           title: aMessage.conversation.subject,</span>
<a href="#l35.2253"></a><span id="l35.2253" class="difflineminus">-          background: false</span>
<a href="#l35.2254"></a><span id="l35.2254" class="difflineplus">+          background: false,</span>
<a href="#l35.2255"></a><span id="l35.2255">         });</span>
<a href="#l35.2256"></a><span id="l35.2256">       }</span>
<a href="#l35.2257"></a><span id="l35.2257">     } catch (e) {</span>
<a href="#l35.2258"></a><span id="l35.2258">       logException(e);</span>
<a href="#l35.2259"></a><span id="l35.2259">     }</span>
<a href="#l35.2260"></a><span id="l35.2260" class="difflineminus">-  }</span>
<a href="#l35.2261"></a><span id="l35.2261" class="difflineminus">-}</span>
<a href="#l35.2262"></a><span id="l35.2262" class="difflineplus">+  },</span>
<a href="#l35.2263"></a><span id="l35.2263" class="difflineplus">+};</span>
<a href="#l35.2264"></a><span id="l35.2264"> </span>
<a href="#l35.2265"></a><span id="l35.2265"> var gConversationOpener = new ConversationOpener();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -1,18 +1,18 @@</span>
<a href="#l36.4"></a><span id="l36.4"> /**</span>
<a href="#l36.5"></a><span id="l36.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l36.6"></a><span id="l36.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l36.7"></a><span id="l36.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l36.8"></a><span id="l36.8"> </span>
<a href="#l36.9"></a><span id="l36.9"> ChromeUtils.import(&quot;resource:///modules/activity/activityModules.jsm&quot;);</span>
<a href="#l36.10"></a><span id="l36.10" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/errUtils.js&quot;);</span>
<a href="#l36.11"></a><span id="l36.11" class="difflineplus">+var { logException } = ChromeUtils.import(&quot;resource:///modules/errUtils.js&quot;, null);</span>
<a href="#l36.12"></a><span id="l36.12"> ChromeUtils.import(&quot;resource:///modules/folderUtils.jsm&quot;);</span>
<a href="#l36.13"></a><span id="l36.13"> ChromeUtils.import(&quot;resource:///modules/IOUtils.js&quot;);</span>
<a href="#l36.14"></a><span id="l36.14" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/jsTreeSelection.js&quot;);</span>
<a href="#l36.15"></a><span id="l36.15" class="difflineplus">+var { JSTreeSelection } = ChromeUtils.import(&quot;resource:///modules/jsTreeSelection.js&quot;, null);</span>
<a href="#l36.16"></a><span id="l36.16"> ChromeUtils.import(&quot;resource:///modules/MailConsts.jsm&quot;);</span>
<a href="#l36.17"></a><span id="l36.17"> ChromeUtils.import(&quot;resource:///modules/MailInstrumentation.jsm&quot;);</span>
<a href="#l36.18"></a><span id="l36.18"> ChromeUtils.import(&quot;resource:///modules/mailnewsMigrator.js&quot;);</span>
<a href="#l36.19"></a><span id="l36.19"> ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l36.20"></a><span id="l36.20"> ChromeUtils.import(&quot;resource:///modules/msgDBCacheManager.js&quot;);</span>
<a href="#l36.21"></a><span id="l36.21"> ChromeUtils.import(&quot;resource:///modules/SessionStoreManager.jsm&quot;);</span>
<a href="#l36.22"></a><span id="l36.22"> ChromeUtils.import(&quot;resource:///modules/SummaryFrameManager.jsm&quot;);</span>
<a href="#l36.23"></a><span id="l36.23"> ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l36.24"></a><span id="l36.24" class="difflineat">@@ -90,17 +90,17 @@ function getWindowsVersionInfo() {</span>
<a href="#l36.25"></a><span id="l36.25">     let GetVersionEx = kernel32.declare(&quot;GetVersionExW&quot;,</span>
<a href="#l36.26"></a><span id="l36.26">                                         ctypes.winapi_abi,</span>
<a href="#l36.27"></a><span id="l36.27">                                         BOOL,</span>
<a href="#l36.28"></a><span id="l36.28">                                         OSVERSIONINFOEXW.ptr);</span>
<a href="#l36.29"></a><span id="l36.29">     let winVer = OSVERSIONINFOEXW();</span>
<a href="#l36.30"></a><span id="l36.30">     winVer.dwOSVersionInfoSize = OSVERSIONINFOEXW.size;</span>
<a href="#l36.31"></a><span id="l36.31"> </span>
<a href="#l36.32"></a><span id="l36.32">     if (0 === GetVersionEx(winVer.address())) {</span>
<a href="#l36.33"></a><span id="l36.33" class="difflineminus">-      throw (&quot;Failure in GetVersionEx (returned 0)&quot;);</span>
<a href="#l36.34"></a><span id="l36.34" class="difflineplus">+      throw new Error(&quot;Failure in GetVersionEx (returned 0)&quot;);</span>
<a href="#l36.35"></a><span id="l36.35">     }</span>
<a href="#l36.36"></a><span id="l36.36"> </span>
<a href="#l36.37"></a><span id="l36.37">     return {</span>
<a href="#l36.38"></a><span id="l36.38">       servicePackMajor: winVer.wServicePackMajor,</span>
<a href="#l36.39"></a><span id="l36.39">       servicePackMinor: winVer.wServicePackMinor,</span>
<a href="#l36.40"></a><span id="l36.40">       buildNumber: winVer.dwBuildNumber,</span>
<a href="#l36.41"></a><span id="l36.41">     };</span>
<a href="#l36.42"></a><span id="l36.42">   } catch (e) {</span>
<a href="#l36.43"></a><span id="l36.43" class="difflineat">@@ -145,83 +145,79 @@ var gNewAccountToLoad = null;</span>
<a href="#l36.44"></a><span id="l36.44"> </span>
<a href="#l36.45"></a><span id="l36.45"> var gDisplayStartupPage = false;</span>
<a href="#l36.46"></a><span id="l36.46"> </span>
<a href="#l36.47"></a><span id="l36.47"> // The object in charge of managing the mail summary pane</span>
<a href="#l36.48"></a><span id="l36.48"> var gSummaryFrameManager;</span>
<a href="#l36.49"></a><span id="l36.49"> </span>
<a href="#l36.50"></a><span id="l36.50"> // the folderListener object</span>
<a href="#l36.51"></a><span id="l36.51"> var folderListener = {</span>
<a href="#l36.52"></a><span id="l36.52" class="difflineminus">-    OnItemAdded: function(parentItem, item) { },</span>
<a href="#l36.53"></a><span id="l36.53" class="difflineplus">+    OnItemAdded(parentItem, item) {},</span>
<a href="#l36.54"></a><span id="l36.54"> </span>
<a href="#l36.55"></a><span id="l36.55" class="difflineminus">-    OnItemRemoved: function(parentItem, item) { },</span>
<a href="#l36.56"></a><span id="l36.56" class="difflineplus">+    OnItemRemoved(parentItem, item) {},</span>
<a href="#l36.57"></a><span id="l36.57"> </span>
<a href="#l36.58"></a><span id="l36.58" class="difflineminus">-    OnItemPropertyChanged: function(item, property, oldValue, newValue) { },</span>
<a href="#l36.59"></a><span id="l36.59" class="difflineplus">+    OnItemPropertyChanged(item, property, oldValue, newValue) {},</span>
<a href="#l36.60"></a><span id="l36.60"> </span>
<a href="#l36.61"></a><span id="l36.61" class="difflineminus">-    OnItemIntPropertyChanged: function(item, property, oldValue, newValue) {</span>
<a href="#l36.62"></a><span id="l36.62" class="difflineplus">+    OnItemIntPropertyChanged(item, property, oldValue, newValue) {</span>
<a href="#l36.63"></a><span id="l36.63">       if (item == gFolderDisplay.displayedFolder) {</span>
<a href="#l36.64"></a><span id="l36.64">         if (property == &quot;TotalMessages&quot; || property == &quot;TotalUnreadMessages&quot;) {</span>
<a href="#l36.65"></a><span id="l36.65">           UpdateStatusMessageCounts(gFolderDisplay.displayedFolder);</span>
<a href="#l36.66"></a><span id="l36.66">         }</span>
<a href="#l36.67"></a><span id="l36.67">       }</span>
<a href="#l36.68"></a><span id="l36.68">     },</span>
<a href="#l36.69"></a><span id="l36.69"> </span>
<a href="#l36.70"></a><span id="l36.70" class="difflineminus">-    OnItemBoolPropertyChanged: function(item, property, oldValue, newValue) { },</span>
<a href="#l36.71"></a><span id="l36.71" class="difflineplus">+    OnItemBoolPropertyChanged(item, property, oldValue, newValue) {},</span>
<a href="#l36.72"></a><span id="l36.72"> </span>
<a href="#l36.73"></a><span id="l36.73" class="difflineminus">-    OnItemUnicharPropertyChanged: function(item, property, oldValue, newValue) { },</span>
<a href="#l36.74"></a><span id="l36.74" class="difflineminus">-    OnItemPropertyFlagChanged: function(item, property, oldFlag, newFlag) { },</span>
<a href="#l36.75"></a><span id="l36.75" class="difflineplus">+    OnItemUnicharPropertyChanged(item, property, oldValue, newValue) {},</span>
<a href="#l36.76"></a><span id="l36.76" class="difflineplus">+    OnItemPropertyFlagChanged(item, property, oldFlag, newFlag) {},</span>
<a href="#l36.77"></a><span id="l36.77"> </span>
<a href="#l36.78"></a><span id="l36.78" class="difflineminus">-    OnItemEvent: function(folder, event) {</span>
<a href="#l36.79"></a><span id="l36.79" class="difflineplus">+    OnItemEvent(folder, event) {</span>
<a href="#l36.80"></a><span id="l36.80">       if (event == &quot;ImapHdrDownloaded&quot;) {</span>
<a href="#l36.81"></a><span id="l36.81">         if (folder) {</span>
<a href="#l36.82"></a><span id="l36.82">           var imapFolder = folder.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l36.83"></a><span id="l36.83">           if (imapFolder) {</span>
<a href="#l36.84"></a><span id="l36.84">             var hdrParser = imapFolder.hdrParser;</span>
<a href="#l36.85"></a><span id="l36.85">             if (hdrParser) {</span>
<a href="#l36.86"></a><span id="l36.86">               var msgHdr = hdrParser.GetNewMsgHdr();</span>
<a href="#l36.87"></a><span id="l36.87" class="difflineminus">-              if (msgHdr)</span>
<a href="#l36.88"></a><span id="l36.88" class="difflineminus">-              {</span>
<a href="#l36.89"></a><span id="l36.89" class="difflineplus">+              if (msgHdr) {</span>
<a href="#l36.90"></a><span id="l36.90">                 var hdrs = hdrParser.headers;</span>
<a href="#l36.91"></a><span id="l36.91">                 if (hdrs &amp;&amp; hdrs.indexOf(&quot;X-attachment-size:&quot;) &gt; 0) {</span>
<a href="#l36.92"></a><span id="l36.92">                   msgHdr.OrFlags(Ci.nsMsgMessageFlags</span>
<a href="#l36.93"></a><span id="l36.93">                                    .Attachment);</span>
<a href="#l36.94"></a><span id="l36.94">                 }</span>
<a href="#l36.95"></a><span id="l36.95">                 if (hdrs &amp;&amp; hdrs.indexOf(&quot;X-image-size:&quot;) &gt; 0) {</span>
<a href="#l36.96"></a><span id="l36.96">                   msgHdr.setStringProperty(&quot;imageSize&quot;, &quot;1&quot;);</span>
<a href="#l36.97"></a><span id="l36.97">                 }</span>
<a href="#l36.98"></a><span id="l36.98">               }</span>
<a href="#l36.99"></a><span id="l36.99">             }</span>
<a href="#l36.100"></a><span id="l36.100">           }</span>
<a href="#l36.101"></a><span id="l36.101">         }</span>
<a href="#l36.102"></a><span id="l36.102" class="difflineminus">-      }</span>
<a href="#l36.103"></a><span id="l36.103" class="difflineminus">-      else if (event == &quot;JunkStatusChanged&quot;) {</span>
<a href="#l36.104"></a><span id="l36.104" class="difflineplus">+      } else if (event == &quot;JunkStatusChanged&quot;) {</span>
<a href="#l36.105"></a><span id="l36.105">         HandleJunkStatusChanged(folder);</span>
<a href="#l36.106"></a><span id="l36.106">       }</span>
<a href="#l36.107"></a><span id="l36.107" class="difflineminus">-    }</span>
<a href="#l36.108"></a><span id="l36.108" class="difflineminus">-}</span>
<a href="#l36.109"></a><span id="l36.109" class="difflineplus">+    },</span>
<a href="#l36.110"></a><span id="l36.110" class="difflineplus">+};</span>
<a href="#l36.111"></a><span id="l36.111"> </span>
<a href="#l36.112"></a><span id="l36.112" class="difflineminus">-function ServerContainsFolder(server, folder)</span>
<a href="#l36.113"></a><span id="l36.113" class="difflineminus">-{</span>
<a href="#l36.114"></a><span id="l36.114" class="difflineplus">+function ServerContainsFolder(server, folder) {</span>
<a href="#l36.115"></a><span id="l36.115">   if (!folder || !server)</span>
<a href="#l36.116"></a><span id="l36.116">     return false;</span>
<a href="#l36.117"></a><span id="l36.117"> </span>
<a href="#l36.118"></a><span id="l36.118">   return server.equals(folder.server);</span>
<a href="#l36.119"></a><span id="l36.119"> }</span>
<a href="#l36.120"></a><span id="l36.120"> </span>
<a href="#l36.121"></a><span id="l36.121" class="difflineminus">-function SelectServer(server)</span>
<a href="#l36.122"></a><span id="l36.122" class="difflineminus">-{</span>
<a href="#l36.123"></a><span id="l36.123" class="difflineplus">+function SelectServer(server) {</span>
<a href="#l36.124"></a><span id="l36.124">   gFolderTreeView.selectFolder(server.rootFolder);</span>
<a href="#l36.125"></a><span id="l36.125"> }</span>
<a href="#l36.126"></a><span id="l36.126"> </span>
<a href="#l36.127"></a><span id="l36.127"> // we have this incoming server listener in case we need to</span>
<a href="#l36.128"></a><span id="l36.128"> // alter the folder pane selection when a server is removed</span>
<a href="#l36.129"></a><span id="l36.129"> // or changed (currently, when the real username or real hostname change)</span>
<a href="#l36.130"></a><span id="l36.130"> var gThreePaneIncomingServerListener = {</span>
<a href="#l36.131"></a><span id="l36.131" class="difflineminus">-    onServerLoaded: function(server) {},</span>
<a href="#l36.132"></a><span id="l36.132" class="difflineminus">-    onServerUnloaded: function(server) {</span>
<a href="#l36.133"></a><span id="l36.133" class="difflineplus">+    onServerLoaded(server) {},</span>
<a href="#l36.134"></a><span id="l36.134" class="difflineplus">+    onServerUnloaded(server) {</span>
<a href="#l36.135"></a><span id="l36.135">       let defaultServer;</span>
<a href="#l36.136"></a><span id="l36.136">       try {</span>
<a href="#l36.137"></a><span id="l36.137">         defaultServer = accountManager.defaultAccount.incomingServer;</span>
<a href="#l36.138"></a><span id="l36.138">       } catch (e) {</span>
<a href="#l36.139"></a><span id="l36.139">        // If there is no default server we have nothing to do.</span>
<a href="#l36.140"></a><span id="l36.140">        return;</span>
<a href="#l36.141"></a><span id="l36.141">       }</span>
<a href="#l36.142"></a><span id="l36.142"> </span>
<a href="#l36.143"></a><span id="l36.143" class="difflineat">@@ -236,38 +232,38 @@ var gThreePaneIncomingServerListener = {</span>
<a href="#l36.144"></a><span id="l36.144"> </span>
<a href="#l36.145"></a><span id="l36.145">       // if nothing is selected at this point, better go select the default</span>
<a href="#l36.146"></a><span id="l36.146">       // this could happen if nothing was selected when the server was removed</span>
<a href="#l36.147"></a><span id="l36.147">       selectedFolders = GetSelectedMsgFolders();</span>
<a href="#l36.148"></a><span id="l36.148">       if (selectedFolders.length == 0) {</span>
<a href="#l36.149"></a><span id="l36.149">         SelectServer(defaultServer);</span>
<a href="#l36.150"></a><span id="l36.150">       }</span>
<a href="#l36.151"></a><span id="l36.151">     },</span>
<a href="#l36.152"></a><span id="l36.152" class="difflineminus">-    onServerChanged: function(server) {</span>
<a href="#l36.153"></a><span id="l36.153" class="difflineplus">+    onServerChanged(server) {</span>
<a href="#l36.154"></a><span id="l36.154">       // if the current selected folder is on the server that changed</span>
<a href="#l36.155"></a><span id="l36.155">       // and that server is an imap or news server,</span>
<a href="#l36.156"></a><span id="l36.156">       // we need to update the selection.</span>
<a href="#l36.157"></a><span id="l36.157">       // on those server types, we'll be reconnecting to the server</span>
<a href="#l36.158"></a><span id="l36.158">       // and our currently selected folder will need to be reloaded</span>
<a href="#l36.159"></a><span id="l36.159">       // or worse, be invalid.</span>
<a href="#l36.160"></a><span id="l36.160" class="difflineminus">-      if (server.type != &quot;imap&quot; &amp;&amp; server.type !=&quot;nntp&quot;)</span>
<a href="#l36.161"></a><span id="l36.161" class="difflineplus">+      if (server.type != &quot;imap&quot; &amp;&amp; server.type != &quot;nntp&quot;)</span>
<a href="#l36.162"></a><span id="l36.162">         return;</span>
<a href="#l36.163"></a><span id="l36.163"> </span>
<a href="#l36.164"></a><span id="l36.164">       var selectedFolders = GetSelectedMsgFolders();</span>
<a href="#l36.165"></a><span id="l36.165">       for (var i = 0; i &lt; selectedFolders.length; i++) {</span>
<a href="#l36.166"></a><span id="l36.166">         // if the selected item is a server, we don't have to update</span>
<a href="#l36.167"></a><span id="l36.167">         // the selection</span>
<a href="#l36.168"></a><span id="l36.168">         if (!(selectedFolders[i].isServer) &amp;&amp; ServerContainsFolder(server, selectedFolders[i])) {</span>
<a href="#l36.169"></a><span id="l36.169">           SelectServer(server);</span>
<a href="#l36.170"></a><span id="l36.170">           // we've made a new selection, we're done</span>
<a href="#l36.171"></a><span id="l36.171">           return;</span>
<a href="#l36.172"></a><span id="l36.172">         }</span>
<a href="#l36.173"></a><span id="l36.173">       }</span>
<a href="#l36.174"></a><span id="l36.174" class="difflineminus">-    }</span>
<a href="#l36.175"></a><span id="l36.175" class="difflineminus">-}</span>
<a href="#l36.176"></a><span id="l36.176" class="difflineplus">+    },</span>
<a href="#l36.177"></a><span id="l36.177" class="difflineplus">+};</span>
<a href="#l36.178"></a><span id="l36.178"> </span>
<a href="#l36.179"></a><span id="l36.179"> // aMsgWindowInitialized: false if we are calling from the onload handler, otherwise true</span>
<a href="#l36.180"></a><span id="l36.180"> function UpdateMailPaneConfig(aMsgWindowInitialized) {</span>
<a href="#l36.181"></a><span id="l36.181">   const dynamicIds = [&quot;messagesBox&quot;, &quot;mailContent&quot;, &quot;threadPaneBox&quot;];</span>
<a href="#l36.182"></a><span id="l36.182">   const layouts = [&quot;standard&quot;, &quot;wide&quot;, &quot;vertical&quot;];</span>
<a href="#l36.183"></a><span id="l36.183">   var layoutView = Services.prefs.getIntPref(&quot;mail.pane_config.dynamic&quot;);</span>
<a href="#l36.184"></a><span id="l36.184">   // Ensure valid value; hard fail if not.</span>
<a href="#l36.185"></a><span id="l36.185">   layoutView = dynamicIds[layoutView] ? layoutView : kStandardPaneConfig;</span>
<a href="#l36.186"></a><span id="l36.186" class="difflineat">@@ -316,18 +312,17 @@ function UpdateMailPaneConfig(aMsgWindow</span>
<a href="#l36.187"></a><span id="l36.187">       desiredParent.appendChild(messagePaneBoxWrapper);</span>
<a href="#l36.188"></a><span id="l36.188">     }</span>
<a href="#l36.189"></a><span id="l36.189">     hdrToolbox.palette  = cloneToolboxPalette;</span>
<a href="#l36.190"></a><span id="l36.190">     hdrToolbox.toolbarset = cloneToolbarset;</span>
<a href="#l36.191"></a><span id="l36.191">     hdrToolbar = document.getElementById(&quot;header-view-toolbar&quot;);</span>
<a href="#l36.192"></a><span id="l36.192">     hdrToolbar.firstPermanentChild = firstPermanentChild;</span>
<a href="#l36.193"></a><span id="l36.193">     hdrToolbar.lastPermanentChild = lastPermanentChild;</span>
<a href="#l36.194"></a><span id="l36.194">     messagePaneSplitter.orient = desiredParent.orient;</span>
<a href="#l36.195"></a><span id="l36.195" class="difflineminus">-    if (aMsgWindowInitialized)</span>
<a href="#l36.196"></a><span id="l36.196" class="difflineminus">-    {</span>
<a href="#l36.197"></a><span id="l36.197" class="difflineplus">+    if (aMsgWindowInitialized) {</span>
<a href="#l36.198"></a><span id="l36.198">       messenger.setWindow(null, null);</span>
<a href="#l36.199"></a><span id="l36.199">       messenger.setWindow(window, msgWindow);</span>
<a href="#l36.200"></a><span id="l36.200">       ReloadMessage();</span>
<a href="#l36.201"></a><span id="l36.201">     }</span>
<a href="#l36.202"></a><span id="l36.202"> </span>
<a href="#l36.203"></a><span id="l36.203">     // The quick filter bar gets badly lied to due to standard XUL/XBL problems,</span>
<a href="#l36.204"></a><span id="l36.204">     //  so we need to generate synthetic notifications after a delay on those</span>
<a href="#l36.205"></a><span id="l36.205">     //  nodes that care about overflow.  The 'lie' comes in the form of being</span>
<a href="#l36.206"></a><span id="l36.206" class="difflineat">@@ -341,93 +336,82 @@ function UpdateMailPaneConfig(aMsgWindow</span>
<a href="#l36.207"></a><span id="l36.207">     //  handler.  We will also generate an onresize notification if it turns out</span>
<a href="#l36.208"></a><span id="l36.208">     //  that onoverflow is not appropriate (and such a handler is registered).</span>
<a href="#l36.209"></a><span id="l36.209">     //  This does require that XUL attributes were used to register the handlers</span>
<a href="#l36.210"></a><span id="l36.210">     //  rather than addEventListener.</span>
<a href="#l36.211"></a><span id="l36.211">     // The choice of the delay is basically a kludge because something like 10ms</span>
<a href="#l36.212"></a><span id="l36.212">     //  may be insufficient to ensure we get enqueued after whatever triggers</span>
<a href="#l36.213"></a><span id="l36.213">     //  the layout discontinuity.  (We need to wait for a paint to happen to</span>
<a href="#l36.214"></a><span id="l36.214">     //  trigger the XBL binding, and then there may be more complexities...)</span>
<a href="#l36.215"></a><span id="l36.215" class="difflineminus">-    setTimeout(function UpdateMailPaneConfig_deferredFixup() {</span>
<a href="#l36.216"></a><span id="l36.216" class="difflineplus">+    setTimeout(function() {</span>
<a href="#l36.217"></a><span id="l36.217">       let threadPaneBox = document.getElementById(&quot;threadPaneBox&quot;);</span>
<a href="#l36.218"></a><span id="l36.218">       let overflowNodes =</span>
<a href="#l36.219"></a><span id="l36.219">         threadPaneBox.querySelectorAll(&quot;[onoverflow]&quot;);</span>
<a href="#l36.220"></a><span id="l36.220"> </span>
<a href="#l36.221"></a><span id="l36.221">       for (let iNode = 0; iNode &lt; overflowNodes.length; iNode++) {</span>
<a href="#l36.222"></a><span id="l36.222">         let node = overflowNodes[iNode];</span>
<a href="#l36.223"></a><span id="l36.223"> </span>
<a href="#l36.224"></a><span id="l36.224">         if (node.scrollWidth &gt; node.clientWidth) {</span>
<a href="#l36.225"></a><span id="l36.225">           let e = document.createEvent(&quot;HTMLEvents&quot;);</span>
<a href="#l36.226"></a><span id="l36.226">           e.initEvent(&quot;overflow&quot;, false, false);</span>
<a href="#l36.227"></a><span id="l36.227">           node.dispatchEvent(e);</span>
<a href="#l36.228"></a><span id="l36.228" class="difflineminus">-        }</span>
<a href="#l36.229"></a><span id="l36.229" class="difflineminus">-        else if (node.onresize) {</span>
<a href="#l36.230"></a><span id="l36.230" class="difflineplus">+        } else if (node.onresize) {</span>
<a href="#l36.231"></a><span id="l36.231">           let e = document.createEvent(&quot;HTMLEvents&quot;);</span>
<a href="#l36.232"></a><span id="l36.232">           e.initEvent(&quot;resize&quot;, false, false);</span>
<a href="#l36.233"></a><span id="l36.233">           node.dispatchEvent(e);</span>
<a href="#l36.234"></a><span id="l36.234">         }</span>
<a href="#l36.235"></a><span id="l36.235">       }</span>
<a href="#l36.236"></a><span id="l36.236">     }, 1500);</span>
<a href="#l36.237"></a><span id="l36.237">   }</span>
<a href="#l36.238"></a><span id="l36.238"> }</span>
<a href="#l36.239"></a><span id="l36.239"> </span>
<a href="#l36.240"></a><span id="l36.240"> var MailPrefObserver = {</span>
<a href="#l36.241"></a><span id="l36.241" class="difflineminus">-  observe: function(subject, topic, prefName) {</span>
<a href="#l36.242"></a><span id="l36.242" class="difflineplus">+  observe(subject, topic, prefName) {</span>
<a href="#l36.243"></a><span id="l36.243">     // verify that we're changing the mail pane config pref</span>
<a href="#l36.244"></a><span id="l36.244" class="difflineminus">-    if (topic == &quot;nsPref:changed&quot;)</span>
<a href="#l36.245"></a><span id="l36.245" class="difflineminus">-    {</span>
<a href="#l36.246"></a><span id="l36.246" class="difflineminus">-      if (prefName == &quot;mail.pane_config.dynamic&quot;)</span>
<a href="#l36.247"></a><span id="l36.247" class="difflineplus">+    if (topic == &quot;nsPref:changed&quot;) {</span>
<a href="#l36.248"></a><span id="l36.248" class="difflineplus">+      if (prefName == &quot;mail.pane_config.dynamic&quot;) {</span>
<a href="#l36.249"></a><span id="l36.249">         UpdateMailPaneConfig(true);</span>
<a href="#l36.250"></a><span id="l36.250" class="difflineminus">-      else if (prefName == &quot;mail.showCondensedAddresses&quot;)</span>
<a href="#l36.251"></a><span id="l36.251" class="difflineminus">-      {</span>
<a href="#l36.252"></a><span id="l36.252" class="difflineplus">+      } else if (prefName == &quot;mail.showCondensedAddresses&quot;) {</span>
<a href="#l36.253"></a><span id="l36.253">         var currentDisplayNameVersion;</span>
<a href="#l36.254"></a><span id="l36.254">         var threadTree = document.getElementById(&quot;threadTree&quot;);</span>
<a href="#l36.255"></a><span id="l36.255"> </span>
<a href="#l36.256"></a><span id="l36.256">         currentDisplayNameVersion =</span>
<a href="#l36.257"></a><span id="l36.257">             Services.prefs.getIntPref(&quot;mail.displayname.version&quot;);</span>
<a href="#l36.258"></a><span id="l36.258"> </span>
<a href="#l36.259"></a><span id="l36.259">         Services.prefs.setIntPref(&quot;mail.displayname.version&quot;,</span>
<a href="#l36.260"></a><span id="l36.260">                                   ++currentDisplayNameVersion);</span>
<a href="#l36.261"></a><span id="l36.261"> </span>
<a href="#l36.262"></a><span id="l36.262" class="difflineminus">-        //refresh the thread pane</span>
<a href="#l36.263"></a><span id="l36.263" class="difflineplus">+        // refresh the thread pane</span>
<a href="#l36.264"></a><span id="l36.264">         threadTree.treeBoxObject.invalidate();</span>
<a href="#l36.265"></a><span id="l36.265">       }</span>
<a href="#l36.266"></a><span id="l36.266">     }</span>
<a href="#l36.267"></a><span id="l36.267" class="difflineminus">-  }</span>
<a href="#l36.268"></a><span id="l36.268" class="difflineplus">+  },</span>
<a href="#l36.269"></a><span id="l36.269"> };</span>
<a href="#l36.270"></a><span id="l36.270"> </span>
<a href="#l36.271"></a><span id="l36.271"> /**</span>
<a href="#l36.272"></a><span id="l36.272">  * Called on startup if there are no accounts.</span>
<a href="#l36.273"></a><span id="l36.273">  */</span>
<a href="#l36.274"></a><span id="l36.274" class="difflineminus">-function AutoConfigWizard(okCallback)</span>
<a href="#l36.275"></a><span id="l36.275" class="difflineminus">-{</span>
<a href="#l36.276"></a><span id="l36.276" class="difflineminus">-  let suppressDialogs = false;</span>
<a href="#l36.277"></a><span id="l36.277" class="difflineminus">-</span>
<a href="#l36.278"></a><span id="l36.278" class="difflineminus">-  // Try to get the suppression pref that we stashed away in accountProvisionerTab.js.</span>
<a href="#l36.279"></a><span id="l36.279" class="difflineminus">-  // If it doesn't exist, nsIPrefBranch throws, so we eat it silently and move along.</span>
<a href="#l36.280"></a><span id="l36.280" class="difflineminus">-  try {</span>
<a href="#l36.281"></a><span id="l36.281" class="difflineminus">-    suppressDialogs = Services.prefs.getBoolPref(&quot;mail.provider.suppress_dialog_on_startup&quot;);</span>
<a href="#l36.282"></a><span id="l36.282" class="difflineminus">-  } catch(e) {};</span>
<a href="#l36.283"></a><span id="l36.283" class="difflineplus">+function AutoConfigWizard(okCallback) {</span>
<a href="#l36.284"></a><span id="l36.284" class="difflineplus">+  let suppressDialogs = Services.prefs.getBoolPref(&quot;mail.provider.suppress_dialog_on_startup&quot;, false);</span>
<a href="#l36.285"></a><span id="l36.285"> </span>
<a href="#l36.286"></a><span id="l36.286">   if (suppressDialogs) {</span>
<a href="#l36.287"></a><span id="l36.287">     // Looks like we were in the middle of filling out an account form. We</span>
<a href="#l36.288"></a><span id="l36.288">     // won't display the dialogs in that case.</span>
<a href="#l36.289"></a><span id="l36.289">     Services.prefs.clearUserPref(&quot;mail.provider.suppress_dialog_on_startup&quot;);</span>
<a href="#l36.290"></a><span id="l36.290">     okCallback();</span>
<a href="#l36.291"></a><span id="l36.291">     return;</span>
<a href="#l36.292"></a><span id="l36.292">   }</span>
<a href="#l36.293"></a><span id="l36.293"> </span>
<a href="#l36.294"></a><span id="l36.294">   NewMailAccount(msgWindow, okCallback);</span>
<a href="#l36.295"></a><span id="l36.295"> }</span>
<a href="#l36.296"></a><span id="l36.296"> </span>
<a href="#l36.297"></a><span id="l36.297"> /**</span>
<a href="#l36.298"></a><span id="l36.298">  * Called on startup to initialize various parts of the main window</span>
<a href="#l36.299"></a><span id="l36.299">  */</span>
<a href="#l36.300"></a><span id="l36.300" class="difflineminus">-function OnLoadMessenger()</span>
<a href="#l36.301"></a><span id="l36.301" class="difflineminus">-{</span>
<a href="#l36.302"></a><span id="l36.302" class="difflineplus">+function OnLoadMessenger() {</span>
<a href="#l36.303"></a><span id="l36.303">   migrateMailnews();</span>
<a href="#l36.304"></a><span id="l36.304">   // Rig up our TabsInTitlebar early so that we can catch any resize events.</span>
<a href="#l36.305"></a><span id="l36.305">   TabsInTitlebar.init();</span>
<a href="#l36.306"></a><span id="l36.306">   // update the pane config before we exit onload otherwise the user may see a flicker if we poke the document</span>
<a href="#l36.307"></a><span id="l36.307">   // in delayedOnLoadMessenger...</span>
<a href="#l36.308"></a><span id="l36.308">   UpdateMailPaneConfig(false);</span>
<a href="#l36.309"></a><span id="l36.309">   CompactTheme.init();</span>
<a href="#l36.310"></a><span id="l36.310"> </span>
<a href="#l36.311"></a><span id="l36.311" class="difflineat">@@ -454,18 +438,17 @@ function OnLoadMessenger()</span>
<a href="#l36.312"></a><span id="l36.312">       ChromeUtils.import(&quot;resource://gre/modules/WindowDraggingUtils.jsm&quot;, {});</span>
<a href="#l36.313"></a><span id="l36.313">     new WindowDraggingElement(document.getElementById(&quot;titlebar&quot;));</span>
<a href="#l36.314"></a><span id="l36.314">   }</span>
<a href="#l36.315"></a><span id="l36.315"> </span>
<a href="#l36.316"></a><span id="l36.316">   ToolbarIconColor.init();</span>
<a href="#l36.317"></a><span id="l36.317"> </span>
<a href="#l36.318"></a><span id="l36.318">   // Set a sane starting width/height for all resolutions on new profiles.</span>
<a href="#l36.319"></a><span id="l36.319">   // Do this before the window loads.</span>
<a href="#l36.320"></a><span id="l36.320" class="difflineminus">-  if (!document.documentElement.hasAttribute(&quot;width&quot;))</span>
<a href="#l36.321"></a><span id="l36.321" class="difflineminus">-  {</span>
<a href="#l36.322"></a><span id="l36.322" class="difflineplus">+  if (!document.documentElement.hasAttribute(&quot;width&quot;)) {</span>
<a href="#l36.323"></a><span id="l36.323">     // Prefer 1024xfull height.</span>
<a href="#l36.324"></a><span id="l36.324">     let defaultHeight = screen.availHeight;</span>
<a href="#l36.325"></a><span id="l36.325">     let defaultWidth = (screen.availWidth &lt;= 1024) ? screen.availWidth : 1024;</span>
<a href="#l36.326"></a><span id="l36.326"> </span>
<a href="#l36.327"></a><span id="l36.327">     // On small screens, default to maximized state.</span>
<a href="#l36.328"></a><span id="l36.328">     if (defaultHeight &lt;= 600)</span>
<a href="#l36.329"></a><span id="l36.329">       document.documentElement.setAttribute(&quot;sizemode&quot;, &quot;maximized&quot;);</span>
<a href="#l36.330"></a><span id="l36.330"> </span>
<a href="#l36.331"></a><span id="l36.331" class="difflineat">@@ -483,27 +466,28 @@ function OnLoadMessenger()</span>
<a href="#l36.332"></a><span id="l36.332">   CreateMailWindowGlobals();</span>
<a href="#l36.333"></a><span id="l36.333">   GetMessagePaneWrapper().collapsed = true;</span>
<a href="#l36.334"></a><span id="l36.334">   msgDBCacheManager.init();</span>
<a href="#l36.335"></a><span id="l36.335">   Services.search.init();</span>
<a href="#l36.336"></a><span id="l36.336"> </span>
<a href="#l36.337"></a><span id="l36.337">   // This needs to be before we throw up the account wizard on first run.</span>
<a href="#l36.338"></a><span id="l36.338">   try {</span>
<a href="#l36.339"></a><span id="l36.339">     MailInstrumentation.init();</span>
<a href="#l36.340"></a><span id="l36.340" class="difflineminus">-  } catch(ex) {logException(ex);}</span>
<a href="#l36.341"></a><span id="l36.341" class="difflineplus">+  } catch (ex) {</span>
<a href="#l36.342"></a><span id="l36.342" class="difflineplus">+    logException(ex);</span>
<a href="#l36.343"></a><span id="l36.343" class="difflineplus">+  }</span>
<a href="#l36.344"></a><span id="l36.344"> </span>
<a href="#l36.345"></a><span id="l36.345">   // - initialize tabmail system</span>
<a href="#l36.346"></a><span id="l36.346">   // Do this before LoadPostAccountWizard since that code selects the first</span>
<a href="#l36.347"></a><span id="l36.347">   //  folder for display, and we want gFolderDisplay setup and ready to handle</span>
<a href="#l36.348"></a><span id="l36.348">   //  that event chain.</span>
<a href="#l36.349"></a><span id="l36.349">   // Also, we definitely need to register the tab type prior to the call to</span>
<a href="#l36.350"></a><span id="l36.350">   //  specialTabs.openSpecialTabsOnStartup below.</span>
<a href="#l36.351"></a><span id="l36.351" class="difflineminus">-  let tabmail = document.getElementById('tabmail');</span>
<a href="#l36.352"></a><span id="l36.352" class="difflineminus">-  if (tabmail)</span>
<a href="#l36.353"></a><span id="l36.353" class="difflineminus">-  {</span>
<a href="#l36.354"></a><span id="l36.354" class="difflineplus">+  let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l36.355"></a><span id="l36.355" class="difflineplus">+  if (tabmail) {</span>
<a href="#l36.356"></a><span id="l36.356">     // mailTabType is defined in mailTabs.js</span>
<a href="#l36.357"></a><span id="l36.357">     tabmail.registerTabType(mailTabType);</span>
<a href="#l36.358"></a><span id="l36.358">     // glodaFacetTab* in glodaFacetTab.js</span>
<a href="#l36.359"></a><span id="l36.359">     tabmail.registerTabType(glodaFacetTabType);</span>
<a href="#l36.360"></a><span id="l36.360">     QuickFilterBarMuxer._init();</span>
<a href="#l36.361"></a><span id="l36.361">     tabmail.registerTabMonitor(GlodaSearchBoxTabMonitor);</span>
<a href="#l36.362"></a><span id="l36.362">     tabmail.registerTabMonitor(statusMessageCountsMonitor);</span>
<a href="#l36.363"></a><span id="l36.363">     tabmail.openFirstTab();</span>
<a href="#l36.364"></a><span id="l36.364" class="difflineat">@@ -536,64 +520,58 @@ function OnLoadMessenger()</span>
<a href="#l36.365"></a><span id="l36.365">   // Set up the summary frame manager to handle loading pages in the</span>
<a href="#l36.366"></a><span id="l36.366">   // multi-message pane</span>
<a href="#l36.367"></a><span id="l36.367">   gSummaryFrameManager = new SummaryFrameManager(</span>
<a href="#l36.368"></a><span id="l36.368">                          document.getElementById(&quot;multimessage&quot;));</span>
<a href="#l36.369"></a><span id="l36.369"> </span>
<a href="#l36.370"></a><span id="l36.370">   window.addEventListener(&quot;AppCommand&quot;, HandleAppCommandEvent, true);</span>
<a href="#l36.371"></a><span id="l36.371"> }</span>
<a href="#l36.372"></a><span id="l36.372"> </span>
<a href="#l36.373"></a><span id="l36.373" class="difflineminus">-function LoadPostAccountWizard()</span>
<a href="#l36.374"></a><span id="l36.374" class="difflineminus">-{</span>
<a href="#l36.375"></a><span id="l36.375" class="difflineplus">+function LoadPostAccountWizard() {</span>
<a href="#l36.376"></a><span id="l36.376">   InitMsgWindow();</span>
<a href="#l36.377"></a><span id="l36.377">   messenger.setWindow(window, msgWindow);</span>
<a href="#l36.378"></a><span id="l36.378"> </span>
<a href="#l36.379"></a><span id="l36.379">   InitPanes();</span>
<a href="#l36.380"></a><span id="l36.380">   MigrateJunkMailSettings();</span>
<a href="#l36.381"></a><span id="l36.381">   MigrateFolderViews();</span>
<a href="#l36.382"></a><span id="l36.382">   MigrateOpenMessageBehavior();</span>
<a href="#l36.383"></a><span id="l36.383">   ChromeUtils.import(&quot;resource:///modules/MailMigrator.jsm&quot;);</span>
<a href="#l36.384"></a><span id="l36.384">   MailMigrator.migratePostAccountWizard();</span>
<a href="#l36.385"></a><span id="l36.385"> </span>
<a href="#l36.386"></a><span id="l36.386">   accountManager.setSpecialFolders();</span>
<a href="#l36.387"></a><span id="l36.387"> </span>
<a href="#l36.388"></a><span id="l36.388">   try {</span>
<a href="#l36.389"></a><span id="l36.389">     accountManager.loadVirtualFolders();</span>
<a href="#l36.390"></a><span id="l36.390" class="difflineminus">-  } catch (e) {Cu.reportError(e);}</span>
<a href="#l36.391"></a><span id="l36.391" class="difflineplus">+  } catch (e) {</span>
<a href="#l36.392"></a><span id="l36.392" class="difflineplus">+    Cu.reportError(e);</span>
<a href="#l36.393"></a><span id="l36.393" class="difflineplus">+  }</span>
<a href="#l36.394"></a><span id="l36.394">   accountManager.addIncomingServerListener(gThreePaneIncomingServerListener);</span>
<a href="#l36.395"></a><span id="l36.395"> </span>
<a href="#l36.396"></a><span id="l36.396">   gPhishingDetector.init();</span>
<a href="#l36.397"></a><span id="l36.397"> </span>
<a href="#l36.398"></a><span id="l36.398">   AddToSession();</span>
<a href="#l36.399"></a><span id="l36.399"> </span>
<a href="#l36.400"></a><span id="l36.400" class="difflineminus">-  //need to add to session before trying to load start folder otherwise listeners aren't</span>
<a href="#l36.401"></a><span id="l36.401" class="difflineminus">-  //set up correctly.</span>
<a href="#l36.402"></a><span id="l36.402" class="difflineplus">+  // need to add to session before trying to load start folder otherwise listeners aren't</span>
<a href="#l36.403"></a><span id="l36.403" class="difflineplus">+  // set up correctly.</span>
<a href="#l36.404"></a><span id="l36.404"> </span>
<a href="#l36.405"></a><span id="l36.405">   let startFolderURI = null, startMsgHdr = null;</span>
<a href="#l36.406"></a><span id="l36.406" class="difflineminus">-  if (&quot;arguments&quot; in window &amp;&amp; window.arguments.length &gt; 0)</span>
<a href="#l36.407"></a><span id="l36.407" class="difflineminus">-  {</span>
<a href="#l36.408"></a><span id="l36.408" class="difflineplus">+  if (&quot;arguments&quot; in window &amp;&amp; window.arguments.length &gt; 0) {</span>
<a href="#l36.409"></a><span id="l36.409">     let arg0 = window.arguments[0];</span>
<a href="#l36.410"></a><span id="l36.410">     // If the argument is a string, it is either a folder URI or a feed URI</span>
<a href="#l36.411"></a><span id="l36.411" class="difflineminus">-    if (typeof arg0 == &quot;string&quot;)</span>
<a href="#l36.412"></a><span id="l36.412" class="difflineminus">-    {</span>
<a href="#l36.413"></a><span id="l36.413" class="difflineplus">+    if (typeof arg0 == &quot;string&quot;) {</span>
<a href="#l36.414"></a><span id="l36.414">       // filter our any feed urls that came in as arguments to the new window...</span>
<a href="#l36.415"></a><span id="l36.415" class="difflineminus">-      if (arg0.toLowerCase().startsWith(&quot;feed:&quot;))</span>
<a href="#l36.416"></a><span id="l36.416" class="difflineminus">-      {</span>
<a href="#l36.417"></a><span id="l36.417" class="difflineplus">+      if (arg0.toLowerCase().startsWith(&quot;feed:&quot;)) {</span>
<a href="#l36.418"></a><span id="l36.418">         let feedHandler = Cc[&quot;@mozilla.org/newsblog-feed-downloader;1&quot;]</span>
<a href="#l36.419"></a><span id="l36.419">           .getService(Ci.nsINewsBlogFeedDownloader);</span>
<a href="#l36.420"></a><span id="l36.420">         if (feedHandler)</span>
<a href="#l36.421"></a><span id="l36.421">           feedHandler.subscribeToFeed(arg0, null, msgWindow);</span>
<a href="#l36.422"></a><span id="l36.422" class="difflineminus">-      }</span>
<a href="#l36.423"></a><span id="l36.423" class="difflineminus">-      else</span>
<a href="#l36.424"></a><span id="l36.424" class="difflineminus">-      {</span>
<a href="#l36.425"></a><span id="l36.425" class="difflineplus">+      } else {</span>
<a href="#l36.426"></a><span id="l36.426">         startFolderURI = arg0;</span>
<a href="#l36.427"></a><span id="l36.427">       }</span>
<a href="#l36.428"></a><span id="l36.428" class="difflineminus">-    }</span>
<a href="#l36.429"></a><span id="l36.429" class="difflineminus">-    else if (arg0)</span>
<a href="#l36.430"></a><span id="l36.430" class="difflineminus">-    {</span>
<a href="#l36.431"></a><span id="l36.431" class="difflineplus">+    } else if (arg0) {</span>
<a href="#l36.432"></a><span id="l36.432">       // arg0 is an object</span>
<a href="#l36.433"></a><span id="l36.433">       if ((&quot;wrappedJSObject&quot; in arg0) &amp;&amp; arg0.wrappedJSObject)</span>
<a href="#l36.434"></a><span id="l36.434">         arg0 = arg0.wrappedJSObject;</span>
<a href="#l36.435"></a><span id="l36.435">       startMsgHdr = (&quot;msgHdr&quot; in arg0) ? arg0.msgHdr : null;</span>
<a href="#l36.436"></a><span id="l36.436">     }</span>
<a href="#l36.437"></a><span id="l36.437">   }</span>
<a href="#l36.438"></a><span id="l36.438"> </span>
<a href="#l36.439"></a><span id="l36.439">   function completeStartup() {</span>
<a href="#l36.440"></a><span id="l36.440" class="difflineat">@@ -635,86 +613,83 @@ function LoadPostAccountWizard()</span>
<a href="#l36.441"></a><span id="l36.441">     Services.obs.notifyObservers(window, &quot;mail-startup-done&quot;);</span>
<a href="#l36.442"></a><span id="l36.442">   }</span>
<a href="#l36.443"></a><span id="l36.443"> </span>
<a href="#l36.444"></a><span id="l36.444">   setTimeout(completeStartup, 0);</span>
<a href="#l36.445"></a><span id="l36.445"> </span>
<a href="#l36.446"></a><span id="l36.446">   // FIX ME - later we will be able to use onload from the overlay</span>
<a href="#l36.447"></a><span id="l36.447">   OnLoadMsgHeaderPane();</span>
<a href="#l36.448"></a><span id="l36.448"> </span>
<a href="#l36.449"></a><span id="l36.449" class="difflineminus">-  //Set focus to the Thread Pane the first time the window is opened.</span>
<a href="#l36.450"></a><span id="l36.450" class="difflineplus">+  // Set focus to the Thread Pane the first time the window is opened.</span>
<a href="#l36.451"></a><span id="l36.451">   SetFocusThreadPane();</span>
<a href="#l36.452"></a><span id="l36.452"> </span>
<a href="#l36.453"></a><span id="l36.453">   // initialize the customizeDone method on the customizeable toolbar</span>
<a href="#l36.454"></a><span id="l36.454">   var toolbox = document.getElementById(&quot;mail-toolbox&quot;);</span>
<a href="#l36.455"></a><span id="l36.455">   toolbox.customizeDone = function(aEvent) { MailToolboxCustomizeDone(aEvent, &quot;CustomizeMailToolbar&quot;); };</span>
<a href="#l36.456"></a><span id="l36.456"> </span>
<a href="#l36.457"></a><span id="l36.457" class="difflineminus">-  var toolbarset = document.getElementById('customToolbars');</span>
<a href="#l36.458"></a><span id="l36.458" class="difflineplus">+  var toolbarset = document.getElementById(&quot;customToolbars&quot;);</span>
<a href="#l36.459"></a><span id="l36.459">   toolbox.toolbarset = toolbarset;</span>
<a href="#l36.460"></a><span id="l36.460"> </span>
<a href="#l36.461"></a><span id="l36.461">   // XXX Do not select the folder until the window displays or the threadpane</span>
<a href="#l36.462"></a><span id="l36.462">   //  will be at minimum size.  We used to have</span>
<a href="#l36.463"></a><span id="l36.463">   //  gFolderDisplay.ensureRowIsVisible use settimeout itself to defer that</span>
<a href="#l36.464"></a><span id="l36.464">   //  calculation, but that was ugly.  Also, in theory we will open the window</span>
<a href="#l36.465"></a><span id="l36.465">   //  faster if we let the event loop start doing things sooner.</span>
<a href="#l36.466"></a><span id="l36.466"> </span>
<a href="#l36.467"></a><span id="l36.467">   if (startMsgHdr)</span>
<a href="#l36.468"></a><span id="l36.468">     window.setTimeout(loadStartMsgHdr, 0, startMsgHdr);</span>
<a href="#l36.469"></a><span id="l36.469">   else</span>
<a href="#l36.470"></a><span id="l36.470">     window.setTimeout(loadStartFolder, 0, startFolderURI);</span>
<a href="#l36.471"></a><span id="l36.471"> }</span>
<a href="#l36.472"></a><span id="l36.472"> </span>
<a href="#l36.473"></a><span id="l36.473" class="difflineminus">-function HandleAppCommandEvent(evt)</span>
<a href="#l36.474"></a><span id="l36.474" class="difflineminus">-{</span>
<a href="#l36.475"></a><span id="l36.475" class="difflineplus">+function HandleAppCommandEvent(evt) {</span>
<a href="#l36.476"></a><span id="l36.476">   evt.stopPropagation();</span>
<a href="#l36.477"></a><span id="l36.477">   switch (evt.command) {</span>
<a href="#l36.478"></a><span id="l36.478">     case &quot;Back&quot;:</span>
<a href="#l36.479"></a><span id="l36.479" class="difflineminus">-      goDoCommand('cmd_goBack');</span>
<a href="#l36.480"></a><span id="l36.480" class="difflineplus">+      goDoCommand(&quot;cmd_goBack&quot;);</span>
<a href="#l36.481"></a><span id="l36.481">       break;</span>
<a href="#l36.482"></a><span id="l36.482">     case &quot;Forward&quot;:</span>
<a href="#l36.483"></a><span id="l36.483" class="difflineminus">-      goDoCommand('cmd_goForward');</span>
<a href="#l36.484"></a><span id="l36.484" class="difflineplus">+      goDoCommand(&quot;cmd_goForward&quot;);</span>
<a href="#l36.485"></a><span id="l36.485">       break;</span>
<a href="#l36.486"></a><span id="l36.486">     case &quot;Stop&quot;:</span>
<a href="#l36.487"></a><span id="l36.487">       msgWindow.StopUrls();</span>
<a href="#l36.488"></a><span id="l36.488">       break;</span>
<a href="#l36.489"></a><span id="l36.489">     case &quot;Search&quot;:</span>
<a href="#l36.490"></a><span id="l36.490" class="difflineminus">-      goDoCommand('cmd_search');</span>
<a href="#l36.491"></a><span id="l36.491" class="difflineplus">+      goDoCommand(&quot;cmd_search&quot;);</span>
<a href="#l36.492"></a><span id="l36.492">       break;</span>
<a href="#l36.493"></a><span id="l36.493">     case &quot;Bookmarks&quot;:</span>
<a href="#l36.494"></a><span id="l36.494">       toAddressBook();</span>
<a href="#l36.495"></a><span id="l36.495">       break;</span>
<a href="#l36.496"></a><span id="l36.496">     case &quot;Home&quot;:</span>
<a href="#l36.497"></a><span id="l36.497">     case &quot;Reload&quot;:</span>
<a href="#l36.498"></a><span id="l36.498">     default:</span>
<a href="#l36.499"></a><span id="l36.499">       break;</span>
<a href="#l36.500"></a><span id="l36.500">   }</span>
<a href="#l36.501"></a><span id="l36.501"> }</span>
<a href="#l36.502"></a><span id="l36.502"> </span>
<a href="#l36.503"></a><span id="l36.503"> /**</span>
<a href="#l36.504"></a><span id="l36.504">  * Look for another 3-pane window.</span>
<a href="#l36.505"></a><span id="l36.505">  */</span>
<a href="#l36.506"></a><span id="l36.506" class="difflineminus">-function FindOther3PaneWindow()</span>
<a href="#l36.507"></a><span id="l36.507" class="difflineminus">-{</span>
<a href="#l36.508"></a><span id="l36.508" class="difflineplus">+function FindOther3PaneWindow() {</span>
<a href="#l36.509"></a><span id="l36.509">   // XXX We'd like to use getZOrderDOMWindowEnumerator here, but it doesn't work</span>
<a href="#l36.510"></a><span id="l36.510">   // on Linux</span>
<a href="#l36.511"></a><span id="l36.511">   let enumerator = Services.wm.getEnumerator(&quot;mail:3pane&quot;);</span>
<a href="#l36.512"></a><span id="l36.512">   while (enumerator.hasMoreElements()) {</span>
<a href="#l36.513"></a><span id="l36.513">     let win = enumerator.getNext();</span>
<a href="#l36.514"></a><span id="l36.514">     if (win != window)</span>
<a href="#l36.515"></a><span id="l36.515">       return win;</span>
<a href="#l36.516"></a><span id="l36.516">   }</span>
<a href="#l36.517"></a><span id="l36.517">   return null;</span>
<a href="#l36.518"></a><span id="l36.518"> }</span>
<a href="#l36.519"></a><span id="l36.519"> </span>
<a href="#l36.520"></a><span id="l36.520"> /**</span>
<a href="#l36.521"></a><span id="l36.521">  * Called by messenger.xul:onunload, the 3-pane window inside of tabs window.</span>
<a href="#l36.522"></a><span id="l36.522">  *  It's being unloaded!  Right now!</span>
<a href="#l36.523"></a><span id="l36.523">  */</span>
<a href="#l36.524"></a><span id="l36.524" class="difflineminus">-function OnUnloadMessenger()</span>
<a href="#l36.525"></a><span id="l36.525" class="difflineminus">-{</span>
<a href="#l36.526"></a><span id="l36.526" class="difflineplus">+function OnUnloadMessenger() {</span>
<a href="#l36.527"></a><span id="l36.527">   Services.obs.notifyObservers(window, &quot;mail-unloading-messenger&quot;);</span>
<a href="#l36.528"></a><span id="l36.528">   accountManager.removeIncomingServerListener(gThreePaneIncomingServerListener);</span>
<a href="#l36.529"></a><span id="l36.529">   Services.prefs.removeObserver(&quot;mail.pane_config.dynamic&quot;, MailPrefObserver);</span>
<a href="#l36.530"></a><span id="l36.530">   Services.prefs.removeObserver(&quot;mail.showCondensedAddresses&quot;, MailPrefObserver);</span>
<a href="#l36.531"></a><span id="l36.531"> </span>
<a href="#l36.532"></a><span id="l36.532">   if (gRightMouseButtonSavedSelection) {</span>
<a href="#l36.533"></a><span id="l36.533">     // Avoid possible cycle leaks.</span>
<a href="#l36.534"></a><span id="l36.534">     gRightMouseButtonSavedSelection.view = null;</span>
<a href="#l36.535"></a><span id="l36.535" class="difflineat">@@ -741,26 +716,27 @@ function OnUnloadMessenger()</span>
<a href="#l36.536"></a><span id="l36.536">   // FIX ME - later we will be able to use onload from the overlay</span>
<a href="#l36.537"></a><span id="l36.537">   OnUnloadMsgHeaderPane();</span>
<a href="#l36.538"></a><span id="l36.538"> </span>
<a href="#l36.539"></a><span id="l36.539">   UnloadPanes();</span>
<a href="#l36.540"></a><span id="l36.540"> </span>
<a href="#l36.541"></a><span id="l36.541">   OnMailWindowUnload();</span>
<a href="#l36.542"></a><span id="l36.542">   try {</span>
<a href="#l36.543"></a><span id="l36.543">     MailInstrumentation.uninit();</span>
<a href="#l36.544"></a><span id="l36.544" class="difflineminus">-  } catch (ex) {logException(ex);}</span>
<a href="#l36.545"></a><span id="l36.545" class="difflineplus">+  } catch (ex) {</span>
<a href="#l36.546"></a><span id="l36.546" class="difflineplus">+    logException(ex);</span>
<a href="#l36.547"></a><span id="l36.547" class="difflineplus">+  }</span>
<a href="#l36.548"></a><span id="l36.548"> }</span>
<a href="#l36.549"></a><span id="l36.549"> </span>
<a href="#l36.550"></a><span id="l36.550"> /**</span>
<a href="#l36.551"></a><span id="l36.551">  * Called by the session store manager periodically and at shutdown to get</span>
<a href="#l36.552"></a><span id="l36.552">  * the state of this window for persistence.</span>
<a href="#l36.553"></a><span id="l36.553">  */</span>
<a href="#l36.554"></a><span id="l36.554" class="difflineminus">-function getWindowStateForSessionPersistence()</span>
<a href="#l36.555"></a><span id="l36.555" class="difflineminus">-{</span>
<a href="#l36.556"></a><span id="l36.556" class="difflineminus">-  let tabmail = document.getElementById('tabmail');</span>
<a href="#l36.557"></a><span id="l36.557" class="difflineplus">+function getWindowStateForSessionPersistence() {</span>
<a href="#l36.558"></a><span id="l36.558" class="difflineplus">+  let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l36.559"></a><span id="l36.559">   let tabsState = tabmail.persistTabs();</span>
<a href="#l36.560"></a><span id="l36.560">   return { type: &quot;3pane&quot;, tabs: tabsState };</span>
<a href="#l36.561"></a><span id="l36.561"> }</span>
<a href="#l36.562"></a><span id="l36.562"> </span>
<a href="#l36.563"></a><span id="l36.563"> /**</span>
<a href="#l36.564"></a><span id="l36.564">  * Attempt to restore our tab states.  This should only be called by</span>
<a href="#l36.565"></a><span id="l36.565">  * |loadStartFolder| or |loadStartMsgHdr|.</span>
<a href="#l36.566"></a><span id="l36.566">  *</span>
<a href="#l36.567"></a><span id="l36.567" class="difflineat">@@ -778,17 +754,17 @@ async function atStartupRestoreTabs(aDon</span>
<a href="#l36.568"></a><span id="l36.568">     let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l36.569"></a><span id="l36.569">     tabmail.restoreTabs(tabsState, aDontRestoreFirstTab);</span>
<a href="#l36.570"></a><span id="l36.570">   }</span>
<a href="#l36.571"></a><span id="l36.571"> </span>
<a href="#l36.572"></a><span id="l36.572">   // it's now safe to load extra Tabs.</span>
<a href="#l36.573"></a><span id="l36.573">   setTimeout(loadExtraTabs, 0);</span>
<a href="#l36.574"></a><span id="l36.574">   SessionStoreManager._restored = true;</span>
<a href="#l36.575"></a><span id="l36.575">   Services.obs.notifyObservers(window, &quot;mail-tabs-session-restored&quot;);</span>
<a href="#l36.576"></a><span id="l36.576" class="difflineminus">-  return state ? true : false;</span>
<a href="#l36.577"></a><span id="l36.577" class="difflineplus">+  return !!state;</span>
<a href="#l36.578"></a><span id="l36.578"> }</span>
<a href="#l36.579"></a><span id="l36.579"> </span>
<a href="#l36.580"></a><span id="l36.580"> /**</span>
<a href="#l36.581"></a><span id="l36.581">  * Loads and restores tabs upon opening a window by evaluating window.arguments[1].</span>
<a href="#l36.582"></a><span id="l36.582">  *</span>
<a href="#l36.583"></a><span id="l36.583">  * The type of the object is specified by it's action property. It can be</span>
<a href="#l36.584"></a><span id="l36.584">  * either &quot;restore&quot; or &quot;open&quot;. &quot;restore&quot; invokes tabmail.restoreTab() for each</span>
<a href="#l36.585"></a><span id="l36.585">  * item in the tabs array. While &quot;open&quot; invokes tabmail.openTab() for each item.</span>
<a href="#l36.586"></a><span id="l36.586" class="difflineat">@@ -798,128 +774,111 @@ async function atStartupRestoreTabs(aDon</span>
<a href="#l36.587"></a><span id="l36.587">  * the object need at least the following properties:</span>
<a href="#l36.588"></a><span id="l36.588">  *</span>
<a href="#l36.589"></a><span id="l36.589">  * {</span>
<a href="#l36.590"></a><span id="l36.590">  *   action = &quot;restore&quot; | &quot;open&quot;</span>
<a href="#l36.591"></a><span id="l36.591">  *   tabs = [];</span>
<a href="#l36.592"></a><span id="l36.592">  * }</span>
<a href="#l36.593"></a><span id="l36.593">  *</span>
<a href="#l36.594"></a><span id="l36.594">  */</span>
<a href="#l36.595"></a><span id="l36.595" class="difflineminus">-function loadExtraTabs()</span>
<a href="#l36.596"></a><span id="l36.596" class="difflineminus">-{</span>
<a href="#l36.597"></a><span id="l36.597" class="difflineminus">-</span>
<a href="#l36.598"></a><span id="l36.598" class="difflineplus">+function loadExtraTabs() {</span>
<a href="#l36.599"></a><span id="l36.599">   if (!(&quot;arguments&quot; in window) || window.arguments.length &lt; 2)</span>
<a href="#l36.600"></a><span id="l36.600">     return;</span>
<a href="#l36.601"></a><span id="l36.601"> </span>
<a href="#l36.602"></a><span id="l36.602">   let tab = window.arguments[1];</span>
<a href="#l36.603"></a><span id="l36.603">   if ((!tab) || (typeof tab != &quot;object&quot;))</span>
<a href="#l36.604"></a><span id="l36.604">     return;</span>
<a href="#l36.605"></a><span id="l36.605"> </span>
<a href="#l36.606"></a><span id="l36.606">   if (&quot;wrappedJSObject&quot; in tab)</span>
<a href="#l36.607"></a><span id="l36.607">     tab = tab.wrappedJSObject;</span>
<a href="#l36.608"></a><span id="l36.608"> </span>
<a href="#l36.609"></a><span id="l36.609">   let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l36.610"></a><span id="l36.610"> </span>
<a href="#l36.611"></a><span id="l36.611">   // we got no action, so suppose its &quot;legacy&quot; code</span>
<a href="#l36.612"></a><span id="l36.612">   if (!(&quot;action&quot; in tab)) {</span>
<a href="#l36.613"></a><span id="l36.613" class="difflineminus">-</span>
<a href="#l36.614"></a><span id="l36.614">     if (&quot;tabType&quot; in tab)</span>
<a href="#l36.615"></a><span id="l36.615">       tabmail.openTab(tab.tabType, tab.tabParams);</span>
<a href="#l36.616"></a><span id="l36.616" class="difflineminus">-</span>
<a href="#l36.617"></a><span id="l36.617">     return;</span>
<a href="#l36.618"></a><span id="l36.618">   }</span>
<a href="#l36.619"></a><span id="l36.619"> </span>
<a href="#l36.620"></a><span id="l36.620">   if (!(&quot;tabs&quot; in tab))</span>
<a href="#l36.621"></a><span id="l36.621">     return;</span>
<a href="#l36.622"></a><span id="l36.622"> </span>
<a href="#l36.623"></a><span id="l36.623">   // this is used if a tab is detached to a new window.</span>
<a href="#l36.624"></a><span id="l36.624">   if (tab.action == &quot;restore&quot;) {</span>
<a href="#l36.625"></a><span id="l36.625" class="difflineminus">-</span>
<a href="#l36.626"></a><span id="l36.626">     for (let i = 0; i &lt; tab.tabs.length; i++)</span>
<a href="#l36.627"></a><span id="l36.627">       tabmail.restoreTab(tab.tabs[i]);</span>
<a href="#l36.628"></a><span id="l36.628"> </span>
<a href="#l36.629"></a><span id="l36.629">     // we currently do not support opening in background or opening a</span>
<a href="#l36.630"></a><span id="l36.630">     // special position. So select the last tab opened.</span>
<a href="#l36.631"></a><span id="l36.631" class="difflineminus">-    tabmail.switchToTab(tabmail.tabInfo[tabmail.tabInfo.length-1])</span>
<a href="#l36.632"></a><span id="l36.632" class="difflineminus">-</span>
<a href="#l36.633"></a><span id="l36.633" class="difflineplus">+    tabmail.switchToTab(tabmail.tabInfo[tabmail.tabInfo.length - 1]);</span>
<a href="#l36.634"></a><span id="l36.634">     return;</span>
<a href="#l36.635"></a><span id="l36.635">   }</span>
<a href="#l36.636"></a><span id="l36.636"> </span>
<a href="#l36.637"></a><span id="l36.637">   if (tab.action == &quot;open&quot;) {</span>
<a href="#l36.638"></a><span id="l36.638">     for (let i = 0; i &lt; tab.tabs.length; i++)</span>
<a href="#l36.639"></a><span id="l36.639">       if (&quot;tabType&quot; in tab.tabs[i])</span>
<a href="#l36.640"></a><span id="l36.640">         tabmail.openTab(tab.tabs[i].tabType, tab.tabs[i].tabParams);</span>
<a href="#l36.641"></a><span id="l36.641" class="difflineminus">-</span>
<a href="#l36.642"></a><span id="l36.642" class="difflineminus">-    return;</span>
<a href="#l36.643"></a><span id="l36.643">   }</span>
<a href="#l36.644"></a><span id="l36.644" class="difflineminus">-</span>
<a href="#l36.645"></a><span id="l36.645"> }</span>
<a href="#l36.646"></a><span id="l36.646"> </span>
<a href="#l36.647"></a><span id="l36.647"> /**</span>
<a href="#l36.648"></a><span id="l36.648">  * Loads the given message header at window open. Exactly one out of this and</span>
<a href="#l36.649"></a><span id="l36.649">  * |loadStartFolder| should be called.</span>
<a href="#l36.650"></a><span id="l36.650">  *</span>
<a href="#l36.651"></a><span id="l36.651">  * @param aStartMsgHdr The message header to load at window open</span>
<a href="#l36.652"></a><span id="l36.652">  */</span>
<a href="#l36.653"></a><span id="l36.653" class="difflineminus">-function loadStartMsgHdr(aStartMsgHdr)</span>
<a href="#l36.654"></a><span id="l36.654" class="difflineminus">-{</span>
<a href="#l36.655"></a><span id="l36.655" class="difflineplus">+function loadStartMsgHdr(aStartMsgHdr) {</span>
<a href="#l36.656"></a><span id="l36.656">   // We'll just clobber the default tab</span>
<a href="#l36.657"></a><span id="l36.657">   atStartupRestoreTabs(true);</span>
<a href="#l36.658"></a><span id="l36.658"> </span>
<a href="#l36.659"></a><span id="l36.659">   MsgDisplayMessageInFolderTab(aStartMsgHdr);</span>
<a href="#l36.660"></a><span id="l36.660"> }</span>
<a href="#l36.661"></a><span id="l36.661"> </span>
<a href="#l36.662"></a><span id="l36.662" class="difflineminus">-function loadStartFolder(initialUri)</span>
<a href="#l36.663"></a><span id="l36.663" class="difflineminus">-{</span>
<a href="#l36.664"></a><span id="l36.664" class="difflineplus">+function loadStartFolder(initialUri) {</span>
<a href="#l36.665"></a><span id="l36.665">     var defaultServer = null;</span>
<a href="#l36.666"></a><span id="l36.666">     var startFolder;</span>
<a href="#l36.667"></a><span id="l36.667">     var isLoginAtStartUpEnabled = false;</span>
<a href="#l36.668"></a><span id="l36.668"> </span>
<a href="#l36.669"></a><span id="l36.669">     // If a URI was explicitly specified, we'll just clobber the default tab</span>
<a href="#l36.670"></a><span id="l36.670">     let loadFolder = !atStartupRestoreTabs(!!initialUri);</span>
<a href="#l36.671"></a><span id="l36.671"> </span>
<a href="#l36.672"></a><span id="l36.672">     if (initialUri)</span>
<a href="#l36.673"></a><span id="l36.673">       loadFolder = true;</span>
<a href="#l36.674"></a><span id="l36.674"> </span>
<a href="#l36.675"></a><span id="l36.675" class="difflineminus">-    //First get default account</span>
<a href="#l36.676"></a><span id="l36.676" class="difflineminus">-    try</span>
<a href="#l36.677"></a><span id="l36.677" class="difflineminus">-    {</span>
<a href="#l36.678"></a><span id="l36.678" class="difflineminus">-        if (initialUri)</span>
<a href="#l36.679"></a><span id="l36.679" class="difflineminus">-        {</span>
<a href="#l36.680"></a><span id="l36.680" class="difflineplus">+    // First get default account</span>
<a href="#l36.681"></a><span id="l36.681" class="difflineplus">+    try {</span>
<a href="#l36.682"></a><span id="l36.682" class="difflineplus">+        if (initialUri) {</span>
<a href="#l36.683"></a><span id="l36.683">             startFolder = MailUtils.getFolderForURI(initialUri);</span>
<a href="#l36.684"></a><span id="l36.684" class="difflineminus">-        }</span>
<a href="#l36.685"></a><span id="l36.685" class="difflineminus">-        else</span>
<a href="#l36.686"></a><span id="l36.686" class="difflineminus">-        {</span>
<a href="#l36.687"></a><span id="l36.687" class="difflineplus">+        } else {</span>
<a href="#l36.688"></a><span id="l36.688">             try {</span>
<a href="#l36.689"></a><span id="l36.689">                 var defaultAccount = accountManager.defaultAccount;</span>
<a href="#l36.690"></a><span id="l36.690">             } catch (x) {</span>
<a href="#l36.691"></a><span id="l36.691">                 return; // exception caused by no default account, ignore it.</span>
<a href="#l36.692"></a><span id="l36.692">             }</span>
<a href="#l36.693"></a><span id="l36.693"> </span>
<a href="#l36.694"></a><span id="l36.694">             defaultServer = defaultAccount.incomingServer;</span>
<a href="#l36.695"></a><span id="l36.695">             var rootMsgFolder = defaultServer.rootMsgFolder;</span>
<a href="#l36.696"></a><span id="l36.696"> </span>
<a href="#l36.697"></a><span id="l36.697">             startFolder = rootMsgFolder;</span>
<a href="#l36.698"></a><span id="l36.698"> </span>
<a href="#l36.699"></a><span id="l36.699">             // Enable check new mail once by turning checkmail pref 'on' to bring</span>
<a href="#l36.700"></a><span id="l36.700">             // all users to one plane. This allows all users to go to Inbox. User can</span>
<a href="#l36.701"></a><span id="l36.701">             // always go to server settings panel and turn off &quot;Check for new mail at startup&quot;</span>
<a href="#l36.702"></a><span id="l36.702" class="difflineminus">-            if (!Services.prefs.getBoolPref(kMailCheckOncePrefName))</span>
<a href="#l36.703"></a><span id="l36.703" class="difflineminus">-            {</span>
<a href="#l36.704"></a><span id="l36.704" class="difflineplus">+            if (!Services.prefs.getBoolPref(kMailCheckOncePrefName)) {</span>
<a href="#l36.705"></a><span id="l36.705">                 Services.prefs.setBoolPref(kMailCheckOncePrefName, true);</span>
<a href="#l36.706"></a><span id="l36.706">                 defaultServer.loginAtStartUp = true;</span>
<a href="#l36.707"></a><span id="l36.707">             }</span>
<a href="#l36.708"></a><span id="l36.708"> </span>
<a href="#l36.709"></a><span id="l36.709">             // Get the user pref to see if the login at startup is enabled for default account</span>
<a href="#l36.710"></a><span id="l36.710">             isLoginAtStartUpEnabled = defaultServer.loginAtStartUp;</span>
<a href="#l36.711"></a><span id="l36.711"> </span>
<a href="#l36.712"></a><span id="l36.712">             // Get Inbox only if login at startup is enabled.</span>
<a href="#l36.713"></a><span id="l36.713" class="difflineminus">-            if (isLoginAtStartUpEnabled)</span>
<a href="#l36.714"></a><span id="l36.714" class="difflineminus">-            {</span>
<a href="#l36.715"></a><span id="l36.715" class="difflineminus">-                //now find Inbox</span>
<a href="#l36.716"></a><span id="l36.716" class="difflineplus">+            if (isLoginAtStartUpEnabled) {</span>
<a href="#l36.717"></a><span id="l36.717" class="difflineplus">+                // now find Inbox</span>
<a href="#l36.718"></a><span id="l36.718">                 var inboxFolder = rootMsgFolder.getFolderWithFlags(Ci.nsMsgFolderFlags.Inbox);</span>
<a href="#l36.719"></a><span id="l36.719">                 if (!inboxFolder) return;</span>
<a href="#l36.720"></a><span id="l36.720"> </span>
<a href="#l36.721"></a><span id="l36.721">                 startFolder = inboxFolder;</span>
<a href="#l36.722"></a><span id="l36.722">             }</span>
<a href="#l36.723"></a><span id="l36.723">         }</span>
<a href="#l36.724"></a><span id="l36.724"> </span>
<a href="#l36.725"></a><span id="l36.725">         // it is possible we were given an initial uri and we need to subscribe or try to add</span>
<a href="#l36.726"></a><span id="l36.726" class="difflineat">@@ -931,187 +890,165 @@ function loadStartFolder(initialUri)</span>
<a href="#l36.727"></a><span id="l36.727">         // or the case where initialUri is non-null (non-startup)</span>
<a href="#l36.728"></a><span id="l36.728">         if (!initialUri &amp;&amp; isLoginAtStartUpEnabled</span>
<a href="#l36.729"></a><span id="l36.729">             &amp;&amp; !defaultServer.isDeferredTo &amp;&amp;</span>
<a href="#l36.730"></a><span id="l36.730">             defaultServer.rootFolder == defaultServer.rootMsgFolder)</span>
<a href="#l36.731"></a><span id="l36.731">           defaultServer.performBiff(msgWindow);</span>
<a href="#l36.732"></a><span id="l36.732">         if (loadFolder) {</span>
<a href="#l36.733"></a><span id="l36.733">           try {</span>
<a href="#l36.734"></a><span id="l36.734">             gFolderTreeView.selectFolder(startFolder);</span>
<a href="#l36.735"></a><span id="l36.735" class="difflineminus">-          } catch(ex) {</span>
<a href="#l36.736"></a><span id="l36.736" class="difflineplus">+          } catch (ex) {</span>
<a href="#l36.737"></a><span id="l36.737">             // This means we tried to select a folder that isn't in the current</span>
<a href="#l36.738"></a><span id="l36.738">             // view. Just select the first one in the view then.</span>
<a href="#l36.739"></a><span id="l36.739">             if (gFolderTreeView._rowMap.length)</span>
<a href="#l36.740"></a><span id="l36.740">               gFolderTreeView.selectFolder(gFolderTreeView._rowMap[0]._folder);</span>
<a href="#l36.741"></a><span id="l36.741">           }</span>
<a href="#l36.742"></a><span id="l36.742">         }</span>
<a href="#l36.743"></a><span id="l36.743" class="difflineminus">-    }</span>
<a href="#l36.744"></a><span id="l36.744" class="difflineminus">-    catch(ex)</span>
<a href="#l36.745"></a><span id="l36.745" class="difflineminus">-    {</span>
<a href="#l36.746"></a><span id="l36.746" class="difflineplus">+    } catch (ex) {</span>
<a href="#l36.747"></a><span id="l36.747">       // this is the case where we're trying to auto-subscribe to a folder.</span>
<a href="#l36.748"></a><span id="l36.748" class="difflineminus">-      if (initialUri &amp;&amp; !startFolder.parent)</span>
<a href="#l36.749"></a><span id="l36.749" class="difflineminus">-      {</span>
<a href="#l36.750"></a><span id="l36.750" class="difflineplus">+      if (initialUri &amp;&amp; !startFolder.parent) {</span>
<a href="#l36.751"></a><span id="l36.751">         // hack to force display of thread pane.</span>
<a href="#l36.752"></a><span id="l36.752">         ShowingThreadPane();</span>
<a href="#l36.753"></a><span id="l36.753">         messenger.loadURL(window, initialUri);</span>
<a href="#l36.754"></a><span id="l36.754">         return;</span>
<a href="#l36.755"></a><span id="l36.755">       }</span>
<a href="#l36.756"></a><span id="l36.756"> </span>
<a href="#l36.757"></a><span id="l36.757">       Cu.reportError(ex);</span>
<a href="#l36.758"></a><span id="l36.758">     }</span>
<a href="#l36.759"></a><span id="l36.759"> </span>
<a href="#l36.760"></a><span id="l36.760">     MsgGetMessagesForAllServers(defaultServer);</span>
<a href="#l36.761"></a><span id="l36.761"> </span>
<a href="#l36.762"></a><span id="l36.762">     if (MailOfflineMgr.isOnline()) {</span>
<a href="#l36.763"></a><span id="l36.763">       // Check if we shut down offline, and restarted online, in which case</span>
<a href="#l36.764"></a><span id="l36.764">       // we may have offline events to playback. Since this is not a pref</span>
<a href="#l36.765"></a><span id="l36.765">       // the user should set, it's not in mailnews.js, so we need a try catch.</span>
<a href="#l36.766"></a><span id="l36.766" class="difflineminus">-      let playbackOfflineEvents = false;</span>
<a href="#l36.767"></a><span id="l36.767" class="difflineminus">-      try {</span>
<a href="#l36.768"></a><span id="l36.768" class="difflineminus">-        playbackOfflineEvents = Services.prefs.getBoolPref(&quot;mailnews.playback_offline&quot;);</span>
<a href="#l36.769"></a><span id="l36.769" class="difflineminus">-      }</span>
<a href="#l36.770"></a><span id="l36.770" class="difflineminus">-      catch(ex) {}</span>
<a href="#l36.771"></a><span id="l36.771" class="difflineminus">-      if (playbackOfflineEvents)</span>
<a href="#l36.772"></a><span id="l36.772" class="difflineminus">-      {</span>
<a href="#l36.773"></a><span id="l36.773" class="difflineplus">+      let playbackOfflineEvents = Services.prefs.getBoolPref(&quot;mailnews.playback_offline&quot;, false);</span>
<a href="#l36.774"></a><span id="l36.774" class="difflineplus">+      if (playbackOfflineEvents) {</span>
<a href="#l36.775"></a><span id="l36.775">         Services.prefs.setBoolPref(&quot;mailnews.playback_offline&quot;, false);</span>
<a href="#l36.776"></a><span id="l36.776">         MailOfflineMgr.offlineManager.goOnline(false, true, msgWindow);</span>
<a href="#l36.777"></a><span id="l36.777">       }</span>
<a href="#l36.778"></a><span id="l36.778"> </span>
<a href="#l36.779"></a><span id="l36.779">       // If appropriate, send unsent messages. This may end up prompting the user,</span>
<a href="#l36.780"></a><span id="l36.780">       // so we need to get it out of the flow of the normal load sequence.</span>
<a href="#l36.781"></a><span id="l36.781" class="difflineminus">-      setTimeout(function checkUnsent() {</span>
<a href="#l36.782"></a><span id="l36.782" class="difflineplus">+      setTimeout(function() {</span>
<a href="#l36.783"></a><span id="l36.783">         if (MailOfflineMgr.shouldSendUnsentMessages())</span>
<a href="#l36.784"></a><span id="l36.784">           SendUnsentMessages();</span>
<a href="#l36.785"></a><span id="l36.785">       }, 0);</span>
<a href="#l36.786"></a><span id="l36.786">     }</span>
<a href="#l36.787"></a><span id="l36.787"> }</span>
<a href="#l36.788"></a><span id="l36.788"> </span>
<a href="#l36.789"></a><span id="l36.789" class="difflineminus">-function AddToSession()</span>
<a href="#l36.790"></a><span id="l36.790" class="difflineminus">-{</span>
<a href="#l36.791"></a><span id="l36.791" class="difflineplus">+function AddToSession() {</span>
<a href="#l36.792"></a><span id="l36.792">   var nsIFolderListener = Ci.nsIFolderListener;</span>
<a href="#l36.793"></a><span id="l36.793">   var notifyFlags = nsIFolderListener.intPropertyChanged | nsIFolderListener.event;</span>
<a href="#l36.794"></a><span id="l36.794">   MailServices.mailSession.AddFolderListener(folderListener, notifyFlags);</span>
<a href="#l36.795"></a><span id="l36.795"> }</span>
<a href="#l36.796"></a><span id="l36.796"> </span>
<a href="#l36.797"></a><span id="l36.797" class="difflineminus">-function InitPanes()</span>
<a href="#l36.798"></a><span id="l36.798" class="difflineminus">-{</span>
<a href="#l36.799"></a><span id="l36.799" class="difflineplus">+function InitPanes() {</span>
<a href="#l36.800"></a><span id="l36.800">   gFolderTreeView.load(document.getElementById(&quot;folderTree&quot;),</span>
<a href="#l36.801"></a><span id="l36.801">                        &quot;folderTree.json&quot;);</span>
<a href="#l36.802"></a><span id="l36.802">   var folderTree = document.getElementById(&quot;folderTree&quot;);</span>
<a href="#l36.803"></a><span id="l36.803" class="difflineminus">-  folderTree.addEventListener(&quot;click&quot;,FolderPaneOnClick,true);</span>
<a href="#l36.804"></a><span id="l36.804" class="difflineminus">-  folderTree.addEventListener(&quot;mousedown&quot;,TreeOnMouseDown,true);</span>
<a href="#l36.805"></a><span id="l36.805" class="difflineplus">+  folderTree.addEventListener(&quot;click&quot;, FolderPaneOnClick, true);</span>
<a href="#l36.806"></a><span id="l36.806" class="difflineplus">+  folderTree.addEventListener(&quot;mousedown&quot;, TreeOnMouseDown, true);</span>
<a href="#l36.807"></a><span id="l36.807">   var threadTree = document.getElementById(&quot;threadTree&quot;);</span>
<a href="#l36.808"></a><span id="l36.808" class="difflineminus">-  threadTree.addEventListener(&quot;click&quot;,ThreadTreeOnClick,true);</span>
<a href="#l36.809"></a><span id="l36.809" class="difflineplus">+  threadTree.addEventListener(&quot;click&quot;, ThreadTreeOnClick, true);</span>
<a href="#l36.810"></a><span id="l36.810"> </span>
<a href="#l36.811"></a><span id="l36.811">   OnLoadThreadPane();</span>
<a href="#l36.812"></a><span id="l36.812">   SetupCommandUpdateHandlers();</span>
<a href="#l36.813"></a><span id="l36.813"> }</span>
<a href="#l36.814"></a><span id="l36.814"> </span>
<a href="#l36.815"></a><span id="l36.815" class="difflineminus">-function UnloadPanes()</span>
<a href="#l36.816"></a><span id="l36.816" class="difflineminus">-{</span>
<a href="#l36.817"></a><span id="l36.817" class="difflineplus">+function UnloadPanes() {</span>
<a href="#l36.818"></a><span id="l36.818">   var threadTree = document.getElementById(&quot;threadTree&quot;);</span>
<a href="#l36.819"></a><span id="l36.819" class="difflineminus">-  threadTree.removeEventListener(&quot;click&quot;,ThreadTreeOnClick,true);</span>
<a href="#l36.820"></a><span id="l36.820" class="difflineplus">+  threadTree.removeEventListener(&quot;click&quot;, ThreadTreeOnClick, true);</span>
<a href="#l36.821"></a><span id="l36.821">   var folderTree = document.getElementById(&quot;folderTree&quot;);</span>
<a href="#l36.822"></a><span id="l36.822" class="difflineminus">-  folderTree.removeEventListener(&quot;click&quot;,FolderPaneOnClick,true);</span>
<a href="#l36.823"></a><span id="l36.823" class="difflineminus">-  folderTree.removeEventListener(&quot;mousedown&quot;,TreeOnMouseDown,true);</span>
<a href="#l36.824"></a><span id="l36.824" class="difflineplus">+  folderTree.removeEventListener(&quot;click&quot;, FolderPaneOnClick, true);</span>
<a href="#l36.825"></a><span id="l36.825" class="difflineplus">+  folderTree.removeEventListener(&quot;mousedown&quot;, TreeOnMouseDown, true);</span>
<a href="#l36.826"></a><span id="l36.826">   gFolderTreeView.unload(&quot;folderTree.json&quot;);</span>
<a href="#l36.827"></a><span id="l36.827">   UnloadCommandUpdateHandlers();</span>
<a href="#l36.828"></a><span id="l36.828"> }</span>
<a href="#l36.829"></a><span id="l36.829"> </span>
<a href="#l36.830"></a><span id="l36.830" class="difflineminus">-function OnLoadThreadPane()</span>
<a href="#l36.831"></a><span id="l36.831" class="difflineminus">-{</span>
<a href="#l36.832"></a><span id="l36.832" class="difflineplus">+function OnLoadThreadPane() {</span>
<a href="#l36.833"></a><span id="l36.833">   // Use an observer to watch the columns element so that we get a notification</span>
<a href="#l36.834"></a><span id="l36.834">   // whenever attributes on the columns change.</span>
<a href="#l36.835"></a><span id="l36.835" class="difflineminus">-  let observer = new MutationObserver(function handleMutations(mutations) {</span>
<a href="#l36.836"></a><span id="l36.836" class="difflineplus">+  let observer = new MutationObserver(function(mutations) {</span>
<a href="#l36.837"></a><span id="l36.837">     gFolderDisplay.hintColumnsChanged();</span>
<a href="#l36.838"></a><span id="l36.838">   });</span>
<a href="#l36.839"></a><span id="l36.839">   observer.observe(document.getElementById(&quot;threadCols&quot;), {</span>
<a href="#l36.840"></a><span id="l36.840">     attributes: true,</span>
<a href="#l36.841"></a><span id="l36.841">     subtree: true,</span>
<a href="#l36.842"></a><span id="l36.842" class="difflineminus">-    attributeFilter: [&quot;hidden&quot;, &quot;ordinal&quot;]</span>
<a href="#l36.843"></a><span id="l36.843" class="difflineplus">+    attributeFilter: [&quot;hidden&quot;, &quot;ordinal&quot;],</span>
<a href="#l36.844"></a><span id="l36.844">   });</span>
<a href="#l36.845"></a><span id="l36.845"> }</span>
<a href="#l36.846"></a><span id="l36.846"> </span>
<a href="#l36.847"></a><span id="l36.847"> /* Functions for accessing particular parts of the window*/</span>
<a href="#l36.848"></a><span id="l36.848" class="difflineminus">-function GetMessagePane()</span>
<a href="#l36.849"></a><span id="l36.849" class="difflineminus">-{</span>
<a href="#l36.850"></a><span id="l36.850" class="difflineplus">+function GetMessagePane() {</span>
<a href="#l36.851"></a><span id="l36.851">   if (!gMessagePane)</span>
<a href="#l36.852"></a><span id="l36.852">     gMessagePane = document.getElementById(&quot;messagepanebox&quot;);</span>
<a href="#l36.853"></a><span id="l36.853">   return gMessagePane;</span>
<a href="#l36.854"></a><span id="l36.854"> }</span>
<a href="#l36.855"></a><span id="l36.855"> </span>
<a href="#l36.856"></a><span id="l36.856" class="difflineminus">-function GetMessagePaneWrapper()</span>
<a href="#l36.857"></a><span id="l36.857" class="difflineminus">-{</span>
<a href="#l36.858"></a><span id="l36.858" class="difflineplus">+function GetMessagePaneWrapper() {</span>
<a href="#l36.859"></a><span id="l36.859">   if (!gMessagePaneWrapper)</span>
<a href="#l36.860"></a><span id="l36.860">     gMessagePaneWrapper = document.getElementById(&quot;messagepaneboxwrapper&quot;);</span>
<a href="#l36.861"></a><span id="l36.861">   return gMessagePaneWrapper;</span>
<a href="#l36.862"></a><span id="l36.862"> }</span>
<a href="#l36.863"></a><span id="l36.863"> </span>
<a href="#l36.864"></a><span id="l36.864" class="difflineminus">-function GetMessagePaneFrame()</span>
<a href="#l36.865"></a><span id="l36.865" class="difflineminus">-{</span>
<a href="#l36.866"></a><span id="l36.866" class="difflineplus">+function GetMessagePaneFrame() {</span>
<a href="#l36.867"></a><span id="l36.867">   // We must use the message pane element directly here, as other tabs can</span>
<a href="#l36.868"></a><span id="l36.868">   // have browser elements as well (which could be set to content primary,</span>
<a href="#l36.869"></a><span id="l36.869">   // which would confuse things with a window.content return).</span>
<a href="#l36.870"></a><span id="l36.870">   return document.getElementById(&quot;messagepane&quot;).contentWindow;</span>
<a href="#l36.871"></a><span id="l36.871"> }</span>
<a href="#l36.872"></a><span id="l36.872"> </span>
<a href="#l36.873"></a><span id="l36.873" class="difflineminus">-function getMailToolbox()</span>
<a href="#l36.874"></a><span id="l36.874" class="difflineminus">-{</span>
<a href="#l36.875"></a><span id="l36.875" class="difflineplus">+function getMailToolbox() {</span>
<a href="#l36.876"></a><span id="l36.876">   return document.getElementById(&quot;mail-toolbox&quot;);</span>
<a href="#l36.877"></a><span id="l36.877"> }</span>
<a href="#l36.878"></a><span id="l36.878"> </span>
<a href="#l36.879"></a><span id="l36.879" class="difflineminus">-function FindInSidebar(currentWindow, id)</span>
<a href="#l36.880"></a><span id="l36.880" class="difflineminus">-{</span>
<a href="#l36.881"></a><span id="l36.881" class="difflineplus">+function FindInSidebar(currentWindow, id) {</span>
<a href="#l36.882"></a><span id="l36.882">   var item = currentWindow.document.getElementById(id);</span>
<a href="#l36.883"></a><span id="l36.883">   if (item)</span>
<a href="#l36.884"></a><span id="l36.884">     return item;</span>
<a href="#l36.885"></a><span id="l36.885"> </span>
<a href="#l36.886"></a><span id="l36.886" class="difflineminus">-  for (var i = 0; i &lt; currentWindow.frames.length; ++i)</span>
<a href="#l36.887"></a><span id="l36.887" class="difflineminus">-  {</span>
<a href="#l36.888"></a><span id="l36.888" class="difflineplus">+  for (var i = 0; i &lt; currentWindow.frames.length; ++i) {</span>
<a href="#l36.889"></a><span id="l36.889">     var frameItem = FindInSidebar(currentWindow.frames[i], id);</span>
<a href="#l36.890"></a><span id="l36.890">     if (frameItem)</span>
<a href="#l36.891"></a><span id="l36.891">       return frameItem;</span>
<a href="#l36.892"></a><span id="l36.892">   }</span>
<a href="#l36.893"></a><span id="l36.893"> </span>
<a href="#l36.894"></a><span id="l36.894">   return null;</span>
<a href="#l36.895"></a><span id="l36.895"> }</span>
<a href="#l36.896"></a><span id="l36.896"> </span>
<a href="#l36.897"></a><span id="l36.897" class="difflineminus">-function GetThreadAndMessagePaneSplitter()</span>
<a href="#l36.898"></a><span id="l36.898" class="difflineminus">-{</span>
<a href="#l36.899"></a><span id="l36.899" class="difflineplus">+function GetThreadAndMessagePaneSplitter() {</span>
<a href="#l36.900"></a><span id="l36.900">   if (!gThreadAndMessagePaneSplitter)</span>
<a href="#l36.901"></a><span id="l36.901" class="difflineminus">-    gThreadAndMessagePaneSplitter = document.getElementById('threadpane-splitter');</span>
<a href="#l36.902"></a><span id="l36.902" class="difflineplus">+    gThreadAndMessagePaneSplitter = document.getElementById(&quot;threadpane-splitter&quot;);</span>
<a href="#l36.903"></a><span id="l36.903">   return gThreadAndMessagePaneSplitter;</span>
<a href="#l36.904"></a><span id="l36.904"> }</span>
<a href="#l36.905"></a><span id="l36.905"> </span>
<a href="#l36.906"></a><span id="l36.906" class="difflineminus">-function IsMessagePaneCollapsed()</span>
<a href="#l36.907"></a><span id="l36.907" class="difflineminus">-{</span>
<a href="#l36.908"></a><span id="l36.908" class="difflineplus">+function IsMessagePaneCollapsed() {</span>
<a href="#l36.909"></a><span id="l36.909">   return document.getElementById(&quot;threadpane-splitter&quot;)</span>
<a href="#l36.910"></a><span id="l36.910">                  .getAttribute(&quot;state&quot;) == &quot;collapsed&quot;;</span>
<a href="#l36.911"></a><span id="l36.911"> }</span>
<a href="#l36.912"></a><span id="l36.912"> </span>
<a href="#l36.913"></a><span id="l36.913" class="difflineminus">-function ClearThreadPaneSelection()</span>
<a href="#l36.914"></a><span id="l36.914" class="difflineminus">-{</span>
<a href="#l36.915"></a><span id="l36.915" class="difflineplus">+function ClearThreadPaneSelection() {</span>
<a href="#l36.916"></a><span id="l36.916">   gFolderDisplay.clearSelection();</span>
<a href="#l36.917"></a><span id="l36.917"> }</span>
<a href="#l36.918"></a><span id="l36.918"> </span>
<a href="#l36.919"></a><span id="l36.919" class="difflineminus">-function ClearMessagePane()</span>
<a href="#l36.920"></a><span id="l36.920" class="difflineminus">-{</span>
<a href="#l36.921"></a><span id="l36.921" class="difflineplus">+function ClearMessagePane() {</span>
<a href="#l36.922"></a><span id="l36.922">   // hide the message header view AND the message pane...</span>
<a href="#l36.923"></a><span id="l36.923">   HideMessageHeaderPane();</span>
<a href="#l36.924"></a><span id="l36.924">   gMessageNotificationBar.clearMsgNotifications();</span>
<a href="#l36.925"></a><span id="l36.925">   ClearPendingReadTimer();</span>
<a href="#l36.926"></a><span id="l36.926">   try {</span>
<a href="#l36.927"></a><span id="l36.927">     // This can fail because cloning imap URI's can fail if the username</span>
<a href="#l36.928"></a><span id="l36.928">     // has been cleared by docshell/base/nsDefaultURIFixup.cpp.</span>
<a href="#l36.929"></a><span id="l36.929">     let messagePane = GetMessagePaneFrame();</span>
<a href="#l36.930"></a><span id="l36.930">     // If we don't do this check, no one else does and we do a non-trivial</span>
<a href="#l36.931"></a><span id="l36.931">     // amount of work.  So do the check.</span>
<a href="#l36.932"></a><span id="l36.932">     if (messagePane.location.href != &quot;about:blank&quot;)</span>
<a href="#l36.933"></a><span id="l36.933">       messagePane.location.href = &quot;about:blank&quot;;</span>
<a href="#l36.934"></a><span id="l36.934" class="difflineminus">-  } catch(ex) {</span>
<a href="#l36.935"></a><span id="l36.935" class="difflineplus">+  } catch (ex) {</span>
<a href="#l36.936"></a><span id="l36.936">       logException(ex, false, &quot;error clearing message pane&quot;);</span>
<a href="#l36.937"></a><span id="l36.937">   }</span>
<a href="#l36.938"></a><span id="l36.938"> }</span>
<a href="#l36.939"></a><span id="l36.939"> </span>
<a href="#l36.940"></a><span id="l36.940"> /**</span>
<a href="#l36.941"></a><span id="l36.941">  * When right-clicks happen, we do not want to corrupt the underlying</span>
<a href="#l36.942"></a><span id="l36.942">  * selection.  The right-click is a transient selection.  So, unless the</span>
<a href="#l36.943"></a><span id="l36.943">  * user is right-clicking on the current selection, we create a new</span>
<a href="#l36.944"></a><span id="l36.944" class="difflineat">@@ -1122,18 +1059,17 @@ function ClearMessagePane()</span>
<a href="#l36.945"></a><span id="l36.945">  * are done.</span>
<a href="#l36.946"></a><span id="l36.946">  *</span>
<a href="#l36.947"></a><span id="l36.947">  * @param aSingleSelect Should the selection we create be a single selection?</span>
<a href="#l36.948"></a><span id="l36.948">  *     This is relevant if the row being clicked on is already part of the</span>
<a href="#l36.949"></a><span id="l36.949">  *     selection.  If it is part of the selection and !aSingleSelect, then we</span>
<a href="#l36.950"></a><span id="l36.950">  *     leave the selection as is.  If it is part of the selection and</span>
<a href="#l36.951"></a><span id="l36.951">  *     aSingleSelect then we create a transient single-row selection.</span>
<a href="#l36.952"></a><span id="l36.952">  */</span>
<a href="#l36.953"></a><span id="l36.953" class="difflineminus">-function ChangeSelectionWithoutContentLoad(event, tree, aSingleSelect)</span>
<a href="#l36.954"></a><span id="l36.954" class="difflineminus">-{</span>
<a href="#l36.955"></a><span id="l36.955" class="difflineplus">+function ChangeSelectionWithoutContentLoad(event, tree, aSingleSelect) {</span>
<a href="#l36.956"></a><span id="l36.956">   var treeBoxObj = tree.treeBoxObject;</span>
<a href="#l36.957"></a><span id="l36.957">   if (!treeBoxObj) {</span>
<a href="#l36.958"></a><span id="l36.958">     event.stopPropagation();</span>
<a href="#l36.959"></a><span id="l36.959">     return;</span>
<a href="#l36.960"></a><span id="l36.960">   }</span>
<a href="#l36.961"></a><span id="l36.961"> </span>
<a href="#l36.962"></a><span id="l36.962">   var treeSelection = treeBoxObj.view.selection;</span>
<a href="#l36.963"></a><span id="l36.963"> </span>
<a href="#l36.964"></a><span id="l36.964" class="difflineat">@@ -1156,17 +1092,17 @@ function ChangeSelectionWithoutContentLo</span>
<a href="#l36.965"></a><span id="l36.965"> </span>
<a href="#l36.966"></a><span id="l36.966">     let transientSelection = new JSTreeSelection(treeBoxObj);</span>
<a href="#l36.967"></a><span id="l36.967">     transientSelection.logAdjustSelectionForReplay();</span>
<a href="#l36.968"></a><span id="l36.968"> </span>
<a href="#l36.969"></a><span id="l36.969">     gRightMouseButtonSavedSelection = {</span>
<a href="#l36.970"></a><span id="l36.970">       // Need to clear out this reference later.</span>
<a href="#l36.971"></a><span id="l36.971">       view: treeBoxObj.view,</span>
<a href="#l36.972"></a><span id="l36.972">       realSelection: treeSelection,</span>
<a href="#l36.973"></a><span id="l36.973" class="difflineminus">-      transientSelection: transientSelection</span>
<a href="#l36.974"></a><span id="l36.974" class="difflineplus">+      transientSelection,</span>
<a href="#l36.975"></a><span id="l36.975">     };</span>
<a href="#l36.976"></a><span id="l36.976"> </span>
<a href="#l36.977"></a><span id="l36.977">     var saveCurrentIndex = treeSelection.currentIndex;</span>
<a href="#l36.978"></a><span id="l36.978"> </span>
<a href="#l36.979"></a><span id="l36.979">     // tell it to log calls to adjustSelection</span>
<a href="#l36.980"></a><span id="l36.980">     // attach it to the view</span>
<a href="#l36.981"></a><span id="l36.981">     treeBoxObj.view.selection = transientSelection;</span>
<a href="#l36.982"></a><span id="l36.982">     // Don't generate any selection events! (we never set this to false, because</span>
<a href="#l36.983"></a><span id="l36.983" class="difflineat">@@ -1175,215 +1111,183 @@ function ChangeSelectionWithoutContentLo</span>
<a href="#l36.984"></a><span id="l36.984">     transientSelection.selectEventsSuppressed = true;</span>
<a href="#l36.985"></a><span id="l36.985">     transientSelection.select(row);</span>
<a href="#l36.986"></a><span id="l36.986">     transientSelection.currentIndex = saveCurrentIndex;</span>
<a href="#l36.987"></a><span id="l36.987">     treeBoxObj.ensureRowIsVisible(row);</span>
<a href="#l36.988"></a><span id="l36.988">   }</span>
<a href="#l36.989"></a><span id="l36.989">   event.stopPropagation();</span>
<a href="#l36.990"></a><span id="l36.990"> }</span>
<a href="#l36.991"></a><span id="l36.991"> </span>
<a href="#l36.992"></a><span id="l36.992" class="difflineminus">-function TreeOnMouseDown(event)</span>
<a href="#l36.993"></a><span id="l36.993" class="difflineminus">-{</span>
<a href="#l36.994"></a><span id="l36.994" class="difflineplus">+function TreeOnMouseDown(event) {</span>
<a href="#l36.995"></a><span id="l36.995">     // Detect right mouse click and change the highlight to the row</span>
<a href="#l36.996"></a><span id="l36.996">     // where the click happened without loading the message headers in</span>
<a href="#l36.997"></a><span id="l36.997">     // the Folder or Thread Pane.</span>
<a href="#l36.998"></a><span id="l36.998">     // Same for middle click, which will open the folder/message in a tab.</span>
<a href="#l36.999"></a><span id="l36.999" class="difflineminus">-    if (event.button == 2 || event.button == 1)</span>
<a href="#l36.1000"></a><span id="l36.1000" class="difflineminus">-    {</span>
<a href="#l36.1001"></a><span id="l36.1001" class="difflineplus">+    if (event.button == 2 || event.button == 1) {</span>
<a href="#l36.1002"></a><span id="l36.1002">       // We want a single selection if this is a middle-click (button 1)</span>
<a href="#l36.1003"></a><span id="l36.1003">       ChangeSelectionWithoutContentLoad(event, event.target.parentNode,</span>
<a href="#l36.1004"></a><span id="l36.1004">                                         event.button == 1);</span>
<a href="#l36.1005"></a><span id="l36.1005">     }</span>
<a href="#l36.1006"></a><span id="l36.1006"> }</span>
<a href="#l36.1007"></a><span id="l36.1007"> </span>
<a href="#l36.1008"></a><span id="l36.1008" class="difflineminus">-function FolderPaneContextMenuNewTab(event)</span>
<a href="#l36.1009"></a><span id="l36.1009" class="difflineminus">-{</span>
<a href="#l36.1010"></a><span id="l36.1010" class="difflineplus">+function FolderPaneContextMenuNewTab(event) {</span>
<a href="#l36.1011"></a><span id="l36.1011">   var bgLoad = Services.prefs.getBoolPref(&quot;mail.tabs.loadInBackground&quot;);</span>
<a href="#l36.1012"></a><span id="l36.1012">   if (event.shiftKey)</span>
<a href="#l36.1013"></a><span id="l36.1013">     bgLoad = !bgLoad;</span>
<a href="#l36.1014"></a><span id="l36.1014">   MsgOpenNewTabForFolder(bgLoad);</span>
<a href="#l36.1015"></a><span id="l36.1015"> }</span>
<a href="#l36.1016"></a><span id="l36.1016"> </span>
<a href="#l36.1017"></a><span id="l36.1017" class="difflineminus">-function FolderPaneOnClick(event)</span>
<a href="#l36.1018"></a><span id="l36.1018" class="difflineminus">-{</span>
<a href="#l36.1019"></a><span id="l36.1019" class="difflineplus">+function FolderPaneOnClick(event) {</span>
<a href="#l36.1020"></a><span id="l36.1020">   var folderTree = document.getElementById(&quot;folderTree&quot;);</span>
<a href="#l36.1021"></a><span id="l36.1021"> </span>
<a href="#l36.1022"></a><span id="l36.1022">   // Middle click on a folder opens the folder in a tab</span>
<a href="#l36.1023"></a><span id="l36.1023">   if (event.button == 1 &amp;&amp; event.originalTarget.localName != &quot;slider&quot; &amp;&amp;</span>
<a href="#l36.1024"></a><span id="l36.1024" class="difflineminus">-      event.originalTarget.localName != &quot;scrollbarbutton&quot;)</span>
<a href="#l36.1025"></a><span id="l36.1025" class="difflineminus">-  {</span>
<a href="#l36.1026"></a><span id="l36.1026" class="difflineplus">+      event.originalTarget.localName != &quot;scrollbarbutton&quot;) {</span>
<a href="#l36.1027"></a><span id="l36.1027">     FolderPaneContextMenuNewTab(event);</span>
<a href="#l36.1028"></a><span id="l36.1028">     RestoreSelectionWithoutContentLoad(folderTree);</span>
<a href="#l36.1029"></a><span id="l36.1029" class="difflineminus">-  }</span>
<a href="#l36.1030"></a><span id="l36.1030" class="difflineminus">-  else if (event.button == 0)</span>
<a href="#l36.1031"></a><span id="l36.1031" class="difflineminus">-  {</span>
<a href="#l36.1032"></a><span id="l36.1032" class="difflineplus">+  } else if (event.button == 0) {</span>
<a href="#l36.1033"></a><span id="l36.1033">     var row = {};</span>
<a href="#l36.1034"></a><span id="l36.1034">     var col = {};</span>
<a href="#l36.1035"></a><span id="l36.1035">     var elt = {};</span>
<a href="#l36.1036"></a><span id="l36.1036">     folderTree.treeBoxObject.getCellAt(event.clientX, event.clientY, row, col, elt);</span>
<a href="#l36.1037"></a><span id="l36.1037">     if (row.value == -1) {</span>
<a href="#l36.1038"></a><span id="l36.1038" class="difflineminus">-      if (event.originalTarget.localName == &quot;treecol&quot;)</span>
<a href="#l36.1039"></a><span id="l36.1039" class="difflineminus">-      {</span>
<a href="#l36.1040"></a><span id="l36.1040" class="difflineplus">+      if (event.originalTarget.localName == &quot;treecol&quot;) {</span>
<a href="#l36.1041"></a><span id="l36.1041">         // clicking on the name column in the folder pane should not sort</span>
<a href="#l36.1042"></a><span id="l36.1042">         event.stopPropagation();</span>
<a href="#l36.1043"></a><span id="l36.1043">       }</span>
<a href="#l36.1044"></a><span id="l36.1044" class="difflineminus">-    }</span>
<a href="#l36.1045"></a><span id="l36.1045" class="difflineminus">-    else if ((event.originalTarget.localName == &quot;slider&quot;) ||</span>
<a href="#l36.1046"></a><span id="l36.1046" class="difflineplus">+    } else if ((event.originalTarget.localName == &quot;slider&quot;) ||</span>
<a href="#l36.1047"></a><span id="l36.1047">              (event.originalTarget.localName == &quot;scrollbarbutton&quot;)) {</span>
<a href="#l36.1048"></a><span id="l36.1048">       event.stopPropagation();</span>
<a href="#l36.1049"></a><span id="l36.1049">     }</span>
<a href="#l36.1050"></a><span id="l36.1050">   }</span>
<a href="#l36.1051"></a><span id="l36.1051"> }</span>
<a href="#l36.1052"></a><span id="l36.1052"> </span>
<a href="#l36.1053"></a><span id="l36.1053" class="difflineminus">-function OpenMessageInNewTab(event)</span>
<a href="#l36.1054"></a><span id="l36.1054" class="difflineminus">-{</span>
<a href="#l36.1055"></a><span id="l36.1055" class="difflineplus">+function OpenMessageInNewTab(event) {</span>
<a href="#l36.1056"></a><span id="l36.1056">   if (!gFolderDisplay.selectedMessage)</span>
<a href="#l36.1057"></a><span id="l36.1057">     return;</span>
<a href="#l36.1058"></a><span id="l36.1058">   var bgLoad = Services.prefs.getBoolPref(&quot;mail.tabs.loadInBackground&quot;);</span>
<a href="#l36.1059"></a><span id="l36.1059">   if (event.shiftKey)</span>
<a href="#l36.1060"></a><span id="l36.1060">     bgLoad = !bgLoad;</span>
<a href="#l36.1061"></a><span id="l36.1061"> </span>
<a href="#l36.1062"></a><span id="l36.1062">   document.getElementById(&quot;tabmail&quot;).openTab(&quot;message&quot;,</span>
<a href="#l36.1063"></a><span id="l36.1063">       {msgHdr: gFolderDisplay.selectedMessage,</span>
<a href="#l36.1064"></a><span id="l36.1064">        viewWrapperToClone: gFolderDisplay.view,</span>
<a href="#l36.1065"></a><span id="l36.1065">        background: bgLoad});</span>
<a href="#l36.1066"></a><span id="l36.1066"> }</span>
<a href="#l36.1067"></a><span id="l36.1067"> </span>
<a href="#l36.1068"></a><span id="l36.1068" class="difflineminus">-function OpenContainingFolder()</span>
<a href="#l36.1069"></a><span id="l36.1069" class="difflineminus">-{</span>
<a href="#l36.1070"></a><span id="l36.1070" class="difflineplus">+function OpenContainingFolder() {</span>
<a href="#l36.1071"></a><span id="l36.1071">   if (!gFolderDisplay.selectedMessage)</span>
<a href="#l36.1072"></a><span id="l36.1072">     return;</span>
<a href="#l36.1073"></a><span id="l36.1073"> </span>
<a href="#l36.1074"></a><span id="l36.1074">   MailUtils.displayMessageInFolderTab(gFolderDisplay.selectedMessage);</span>
<a href="#l36.1075"></a><span id="l36.1075"> }</span>
<a href="#l36.1076"></a><span id="l36.1076"> </span>
<a href="#l36.1077"></a><span id="l36.1077" class="difflineminus">-function ThreadTreeOnClick(event)</span>
<a href="#l36.1078"></a><span id="l36.1078" class="difflineminus">-{</span>
<a href="#l36.1079"></a><span id="l36.1079" class="difflineplus">+function ThreadTreeOnClick(event) {</span>
<a href="#l36.1080"></a><span id="l36.1080">   var threadTree = document.getElementById(&quot;threadTree&quot;);</span>
<a href="#l36.1081"></a><span id="l36.1081"> </span>
<a href="#l36.1082"></a><span id="l36.1082">   // Middle click on a message opens the message in a tab</span>
<a href="#l36.1083"></a><span id="l36.1083">   if (event.button == 1 &amp;&amp; event.originalTarget.localName != &quot;slider&quot; &amp;&amp;</span>
<a href="#l36.1084"></a><span id="l36.1084" class="difflineminus">-      event.originalTarget.localName != &quot;scrollbarbutton&quot;)</span>
<a href="#l36.1085"></a><span id="l36.1085" class="difflineminus">-  {</span>
<a href="#l36.1086"></a><span id="l36.1086" class="difflineplus">+      event.originalTarget.localName != &quot;scrollbarbutton&quot;) {</span>
<a href="#l36.1087"></a><span id="l36.1087">     OpenMessageInNewTab(event);</span>
<a href="#l36.1088"></a><span id="l36.1088">     RestoreSelectionWithoutContentLoad(threadTree);</span>
<a href="#l36.1089"></a><span id="l36.1089">   }</span>
<a href="#l36.1090"></a><span id="l36.1090"> }</span>
<a href="#l36.1091"></a><span id="l36.1091"> </span>
<a href="#l36.1092"></a><span id="l36.1092" class="difflineminus">-function GetSelectedMsgFolders()</span>
<a href="#l36.1093"></a><span id="l36.1093" class="difflineminus">-{</span>
<a href="#l36.1094"></a><span id="l36.1094" class="difflineplus">+function GetSelectedMsgFolders() {</span>
<a href="#l36.1095"></a><span id="l36.1095">   return gFolderTreeView.getSelectedFolders();</span>
<a href="#l36.1096"></a><span id="l36.1096"> }</span>
<a href="#l36.1097"></a><span id="l36.1097"> </span>
<a href="#l36.1098"></a><span id="l36.1098" class="difflineminus">-function SelectFolder(folderUri)</span>
<a href="#l36.1099"></a><span id="l36.1099" class="difflineminus">-{</span>
<a href="#l36.1100"></a><span id="l36.1100" class="difflineplus">+function SelectFolder(folderUri) {</span>
<a href="#l36.1101"></a><span id="l36.1101">   gFolderTreeView.selectFolder(MailUtils.getFolderForURI(folderUri));</span>
<a href="#l36.1102"></a><span id="l36.1102"> }</span>
<a href="#l36.1103"></a><span id="l36.1103"> </span>
<a href="#l36.1104"></a><span id="l36.1104" class="difflineminus">-function ReloadMessage()</span>
<a href="#l36.1105"></a><span id="l36.1105" class="difflineminus">-{</span>
<a href="#l36.1106"></a><span id="l36.1106" class="difflineplus">+function ReloadMessage() {</span>
<a href="#l36.1107"></a><span id="l36.1107">   if (!gFolderDisplay.selectedMessage)</span>
<a href="#l36.1108"></a><span id="l36.1108">     return;</span>
<a href="#l36.1109"></a><span id="l36.1109"> </span>
<a href="#l36.1110"></a><span id="l36.1110">   let view = gFolderDisplay.view.dbView;</span>
<a href="#l36.1111"></a><span id="l36.1111">   if (view)</span>
<a href="#l36.1112"></a><span id="l36.1112">     view.reloadMessage();</span>
<a href="#l36.1113"></a><span id="l36.1113"> }</span>
<a href="#l36.1114"></a><span id="l36.1114"> </span>
<a href="#l36.1115"></a><span id="l36.1115"> // Some of the per account junk mail settings have been</span>
<a href="#l36.1116"></a><span id="l36.1116"> // converted to global prefs. Let's try to migrate some</span>
<a href="#l36.1117"></a><span id="l36.1117"> // of those settings from the default account.</span>
<a href="#l36.1118"></a><span id="l36.1118" class="difflineminus">-function MigrateJunkMailSettings()</span>
<a href="#l36.1119"></a><span id="l36.1119" class="difflineminus">-{</span>
<a href="#l36.1120"></a><span id="l36.1120" class="difflineplus">+function MigrateJunkMailSettings() {</span>
<a href="#l36.1121"></a><span id="l36.1121">   var junkMailSettingsVersion = Services.prefs.getIntPref(&quot;mail.spam.version&quot;);</span>
<a href="#l36.1122"></a><span id="l36.1122" class="difflineminus">-  if (!junkMailSettingsVersion)</span>
<a href="#l36.1123"></a><span id="l36.1123" class="difflineminus">-  {</span>
<a href="#l36.1124"></a><span id="l36.1124" class="difflineplus">+  if (!junkMailSettingsVersion) {</span>
<a href="#l36.1125"></a><span id="l36.1125">     // Get the default account, check to see if we have values for our</span>
<a href="#l36.1126"></a><span id="l36.1126">     // globally migrated prefs.</span>
<a href="#l36.1127"></a><span id="l36.1127">     var defaultAccount;</span>
<a href="#l36.1128"></a><span id="l36.1128">     try {</span>
<a href="#l36.1129"></a><span id="l36.1129">       defaultAccount = accountManager.defaultAccount;</span>
<a href="#l36.1130"></a><span id="l36.1130">     } catch (ex) {}</span>
<a href="#l36.1131"></a><span id="l36.1131" class="difflineminus">-    if (defaultAccount &amp;&amp; defaultAccount.incomingServer)</span>
<a href="#l36.1132"></a><span id="l36.1132" class="difflineminus">-    {</span>
<a href="#l36.1133"></a><span id="l36.1133" class="difflineplus">+    if (defaultAccount &amp;&amp; defaultAccount.incomingServer) {</span>
<a href="#l36.1134"></a><span id="l36.1134">       // we only care about</span>
<a href="#l36.1135"></a><span id="l36.1135">       var prefix = &quot;mail.server.&quot; + defaultAccount.incomingServer.key + &quot;.&quot;;</span>
<a href="#l36.1136"></a><span id="l36.1136" class="difflineminus">-      if (Services.prefs.prefHasUserValue(prefix + &quot;manualMark&quot;))</span>
<a href="#l36.1137"></a><span id="l36.1137" class="difflineminus">-      {</span>
<a href="#l36.1138"></a><span id="l36.1138" class="difflineplus">+      if (Services.prefs.prefHasUserValue(prefix + &quot;manualMark&quot;)) {</span>
<a href="#l36.1139"></a><span id="l36.1139">         Services.prefs.setBoolPref(&quot;mail.spam.manualMark&quot;,</span>
<a href="#l36.1140"></a><span id="l36.1140">           Services.prefs.getBoolPref(prefix + &quot;manualMark&quot;));</span>
<a href="#l36.1141"></a><span id="l36.1141">       }</span>
<a href="#l36.1142"></a><span id="l36.1142" class="difflineminus">-      if (Services.prefs.prefHasUserValue(prefix + &quot;manualMarkMode&quot;))</span>
<a href="#l36.1143"></a><span id="l36.1143" class="difflineminus">-      {</span>
<a href="#l36.1144"></a><span id="l36.1144" class="difflineplus">+      if (Services.prefs.prefHasUserValue(prefix + &quot;manualMarkMode&quot;)) {</span>
<a href="#l36.1145"></a><span id="l36.1145">         Services.prefs.setIntPref(&quot;mail.spam.manualMarkMode&quot;,</span>
<a href="#l36.1146"></a><span id="l36.1146">           Services.prefs.getIntPref(prefix + &quot;manualMarkMode&quot;));</span>
<a href="#l36.1147"></a><span id="l36.1147">       }</span>
<a href="#l36.1148"></a><span id="l36.1148" class="difflineminus">-      if (Services.prefs.prefHasUserValue(prefix + &quot;spamLoggingEnabled&quot;))</span>
<a href="#l36.1149"></a><span id="l36.1149" class="difflineminus">-      {</span>
<a href="#l36.1150"></a><span id="l36.1150" class="difflineplus">+      if (Services.prefs.prefHasUserValue(prefix + &quot;spamLoggingEnabled&quot;)) {</span>
<a href="#l36.1151"></a><span id="l36.1151">         Services.prefs.setBoolPref(&quot;mail.spam.logging.enabled&quot;,</span>
<a href="#l36.1152"></a><span id="l36.1152">           Services.prefs.getBoolPref(prefix + &quot;spamLoggingEnabled&quot;));</span>
<a href="#l36.1153"></a><span id="l36.1153">       }</span>
<a href="#l36.1154"></a><span id="l36.1154" class="difflineminus">-      if (Services.prefs.prefHasUserValue(prefix + &quot;markAsReadOnSpam&quot;))</span>
<a href="#l36.1155"></a><span id="l36.1155" class="difflineminus">-      {</span>
<a href="#l36.1156"></a><span id="l36.1156" class="difflineplus">+      if (Services.prefs.prefHasUserValue(prefix + &quot;markAsReadOnSpam&quot;)) {</span>
<a href="#l36.1157"></a><span id="l36.1157">         Services.prefs.setBoolPref(&quot;mail.spam.markAsReadOnSpam&quot;,</span>
<a href="#l36.1158"></a><span id="l36.1158">           Services.prefs.getBoolPref(prefix + &quot;markAsReadOnSpam&quot;));</span>
<a href="#l36.1159"></a><span id="l36.1159">       }</span>
<a href="#l36.1160"></a><span id="l36.1160">     }</span>
<a href="#l36.1161"></a><span id="l36.1161">     // bump the version so we don't bother doing this again.</span>
<a href="#l36.1162"></a><span id="l36.1162">     Services.prefs.setIntPref(&quot;mail.spam.version&quot;, 1);</span>
<a href="#l36.1163"></a><span id="l36.1163">   }</span>
<a href="#l36.1164"></a><span id="l36.1164"> }</span>
<a href="#l36.1165"></a><span id="l36.1165"> </span>
<a href="#l36.1166"></a><span id="l36.1166"> // The first time a user runs a build that supports folder views, pre-populate the favorite folders list</span>
<a href="#l36.1167"></a><span id="l36.1167"> // with the existing INBOX folders.</span>
<a href="#l36.1168"></a><span id="l36.1168" class="difflineminus">-function MigrateFolderViews()</span>
<a href="#l36.1169"></a><span id="l36.1169" class="difflineminus">-{</span>
<a href="#l36.1170"></a><span id="l36.1170" class="difflineplus">+function MigrateFolderViews() {</span>
<a href="#l36.1171"></a><span id="l36.1171">   var folderViewsVersion = Services.prefs.getIntPref(&quot;mail.folder.views.version&quot;);</span>
<a href="#l36.1172"></a><span id="l36.1172" class="difflineminus">-  if (!folderViewsVersion)</span>
<a href="#l36.1173"></a><span id="l36.1173" class="difflineminus">-  {</span>
<a href="#l36.1174"></a><span id="l36.1174" class="difflineplus">+  if (!folderViewsVersion) {</span>
<a href="#l36.1175"></a><span id="l36.1175">      var servers = accountManager.allServers;</span>
<a href="#l36.1176"></a><span id="l36.1176">      var server;</span>
<a href="#l36.1177"></a><span id="l36.1177">      var inbox;</span>
<a href="#l36.1178"></a><span id="l36.1178" class="difflineminus">-     for (var index = 0; index &lt; servers.length; index++)</span>
<a href="#l36.1179"></a><span id="l36.1179" class="difflineminus">-     {</span>
<a href="#l36.1180"></a><span id="l36.1180" class="difflineplus">+     for (var index = 0; index &lt; servers.length; index++) {</span>
<a href="#l36.1181"></a><span id="l36.1181">        server = servers.queryElementAt(index, Ci.nsIMsgIncomingServer);</span>
<a href="#l36.1182"></a><span id="l36.1182" class="difflineminus">-       if (server)</span>
<a href="#l36.1183"></a><span id="l36.1183" class="difflineminus">-       {</span>
<a href="#l36.1184"></a><span id="l36.1184" class="difflineplus">+       if (server) {</span>
<a href="#l36.1185"></a><span id="l36.1185">          inbox = GetInboxFolder(server);</span>
<a href="#l36.1186"></a><span id="l36.1186">          if (inbox)</span>
<a href="#l36.1187"></a><span id="l36.1187">            inbox.setFlag(Ci.nsMsgFolderFlags.Favorite);</span>
<a href="#l36.1188"></a><span id="l36.1188">        }</span>
<a href="#l36.1189"></a><span id="l36.1189">      }</span>
<a href="#l36.1190"></a><span id="l36.1190">     Services.prefs.setIntPref(&quot;mail.folder.views.version&quot;, 1);</span>
<a href="#l36.1191"></a><span id="l36.1191">   }</span>
<a href="#l36.1192"></a><span id="l36.1192"> }</span>
<a href="#l36.1193"></a><span id="l36.1193"> </span>
<a href="#l36.1194"></a><span id="l36.1194"> // Do a one-time migration of the old mailnews.reuse_message_window pref to the</span>
<a href="#l36.1195"></a><span id="l36.1195"> // newer mail.openMessageBehavior. This does the migration only if the old pref</span>
<a href="#l36.1196"></a><span id="l36.1196"> // is defined.</span>
<a href="#l36.1197"></a><span id="l36.1197" class="difflineminus">-function MigrateOpenMessageBehavior()</span>
<a href="#l36.1198"></a><span id="l36.1198" class="difflineminus">-{</span>
<a href="#l36.1199"></a><span id="l36.1199" class="difflineplus">+function MigrateOpenMessageBehavior() {</span>
<a href="#l36.1200"></a><span id="l36.1200">   let openMessageBehaviorVersion = Services.prefs.getIntPref(</span>
<a href="#l36.1201"></a><span id="l36.1201">                                      &quot;mail.openMessageBehavior.version&quot;);</span>
<a href="#l36.1202"></a><span id="l36.1202" class="difflineminus">-  if (!openMessageBehaviorVersion)</span>
<a href="#l36.1203"></a><span id="l36.1203" class="difflineminus">-  {</span>
<a href="#l36.1204"></a><span id="l36.1204" class="difflineminus">-    let reuseMessageWindow;</span>
<a href="#l36.1205"></a><span id="l36.1205" class="difflineminus">-    try {</span>
<a href="#l36.1206"></a><span id="l36.1206" class="difflineminus">-      reuseMessageWindow = Services.prefs.getBoolPref(</span>
<a href="#l36.1207"></a><span id="l36.1207" class="difflineminus">-                             &quot;mailnews.reuse_message_window&quot;);</span>
<a href="#l36.1208"></a><span id="l36.1208" class="difflineplus">+  if (!openMessageBehaviorVersion) {</span>
<a href="#l36.1209"></a><span id="l36.1209" class="difflineplus">+    // Don't touch this if it isn't defined</span>
<a href="#l36.1210"></a><span id="l36.1210" class="difflineplus">+    if (Services.prefs.getPrefType(&quot;mailnews.reuse_message_window&quot;) ==</span>
<a href="#l36.1211"></a><span id="l36.1211" class="difflineplus">+        Ci.nsIPrefBranch.PREF_BOOL) {</span>
<a href="#l36.1212"></a><span id="l36.1212" class="difflineplus">+      if (Services.prefs.getBoolPref(&quot;mailnews.reuse_message_window&quot;)) {</span>
<a href="#l36.1213"></a><span id="l36.1213" class="difflineplus">+        Services.prefs.setIntPref(&quot;mail.openMessageBehavior&quot;,</span>
<a href="#l36.1214"></a><span id="l36.1214" class="difflineplus">+            MailConsts.OpenMessageBehavior.EXISTING_WINDOW);</span>
<a href="#l36.1215"></a><span id="l36.1215" class="difflineplus">+      } else {</span>
<a href="#l36.1216"></a><span id="l36.1216" class="difflineplus">+        Services.prefs.setIntPref(&quot;mail.openMessageBehavior&quot;,</span>
<a href="#l36.1217"></a><span id="l36.1217" class="difflineplus">+            MailConsts.OpenMessageBehavior.NEW_TAB);</span>
<a href="#l36.1218"></a><span id="l36.1218" class="difflineplus">+      }</span>
<a href="#l36.1219"></a><span id="l36.1219">     }</span>
<a href="#l36.1220"></a><span id="l36.1220" class="difflineminus">-    catch (e) {}</span>
<a href="#l36.1221"></a><span id="l36.1221" class="difflineminus">-</span>
<a href="#l36.1222"></a><span id="l36.1222" class="difflineminus">-    // Don't touch this if it isn't defined</span>
<a href="#l36.1223"></a><span id="l36.1223" class="difflineminus">-    if (reuseMessageWindow === true)</span>
<a href="#l36.1224"></a><span id="l36.1224" class="difflineminus">-      Services.prefs.setIntPref(&quot;mail.openMessageBehavior&quot;,</span>
<a href="#l36.1225"></a><span id="l36.1225" class="difflineminus">-          MailConsts.OpenMessageBehavior.EXISTING_WINDOW);</span>
<a href="#l36.1226"></a><span id="l36.1226" class="difflineminus">-    else if (reuseMessageWindow === false)</span>
<a href="#l36.1227"></a><span id="l36.1227" class="difflineminus">-      Services.prefs.setIntPref(&quot;mail.openMessageBehavior&quot;,</span>
<a href="#l36.1228"></a><span id="l36.1228" class="difflineminus">-          MailConsts.OpenMessageBehavior.NEW_TAB);</span>
<a href="#l36.1229"></a><span id="l36.1229"> </span>
<a href="#l36.1230"></a><span id="l36.1230">     Services.prefs.setIntPref(&quot;mail.openMessageBehavior.version&quot;, 1);</span>
<a href="#l36.1231"></a><span id="l36.1231">   }</span>
<a href="#l36.1232"></a><span id="l36.1232"> }</span>
<a href="#l36.1233"></a><span id="l36.1233"> </span>
<a href="#l36.1234"></a><span id="l36.1234"> function ThreadPaneOnDragStart(aEvent) {</span>
<a href="#l36.1235"></a><span id="l36.1235">   if (aEvent.originalTarget.localName != &quot;treechildren&quot;)</span>
<a href="#l36.1236"></a><span id="l36.1236">     return;</span>
<a href="#l36.1237"></a><span id="l36.1237" class="difflineat">@@ -1421,18 +1325,17 @@ function ThreadPaneOnDragStart(aEvent) {</span>
<a href="#l36.1238"></a><span id="l36.1238">     }</span>
<a href="#l36.1239"></a><span id="l36.1239">     let msgFileName = validateFileName(uniqueFileName);</span>
<a href="#l36.1240"></a><span id="l36.1240">     let msgFileNameLowerCase = msgFileName.toLocaleLowerCase();</span>
<a href="#l36.1241"></a><span id="l36.1241"> </span>
<a href="#l36.1242"></a><span id="l36.1242">     while (true) {</span>
<a href="#l36.1243"></a><span id="l36.1243">       if (!messages[msgFileNameLowerCase]) {</span>
<a href="#l36.1244"></a><span id="l36.1244">         messages[msgFileNameLowerCase] = 1;</span>
<a href="#l36.1245"></a><span id="l36.1245">         break;</span>
<a href="#l36.1246"></a><span id="l36.1246" class="difflineminus">-      }</span>
<a href="#l36.1247"></a><span id="l36.1247" class="difflineminus">-      else {</span>
<a href="#l36.1248"></a><span id="l36.1248" class="difflineplus">+      } else {</span>
<a href="#l36.1249"></a><span id="l36.1249">         let postfix = &quot;-&quot; + messages[msgFileNameLowerCase];</span>
<a href="#l36.1250"></a><span id="l36.1250">         messages[msgFileNameLowerCase]++;</span>
<a href="#l36.1251"></a><span id="l36.1251">         msgFileName = msgFileName + postfix;</span>
<a href="#l36.1252"></a><span id="l36.1252">         msgFileNameLowerCase = msgFileNameLowerCase + postfix;</span>
<a href="#l36.1253"></a><span id="l36.1253">       }</span>
<a href="#l36.1254"></a><span id="l36.1254">     }</span>
<a href="#l36.1255"></a><span id="l36.1255"> </span>
<a href="#l36.1256"></a><span id="l36.1256">     msgFileName = msgFileName + &quot;.eml&quot;;</span>
<a href="#l36.1257"></a><span id="l36.1257" class="difflineat">@@ -1455,17 +1358,17 @@ function ThreadPaneOnDragStart(aEvent) {</span>
<a href="#l36.1258"></a><span id="l36.1258"> }</span>
<a href="#l36.1259"></a><span id="l36.1259"> </span>
<a href="#l36.1260"></a><span id="l36.1260"> function messageFlavorDataProvider() {</span>
<a href="#l36.1261"></a><span id="l36.1261"> }</span>
<a href="#l36.1262"></a><span id="l36.1262"> </span>
<a href="#l36.1263"></a><span id="l36.1263"> messageFlavorDataProvider.prototype = {</span>
<a href="#l36.1264"></a><span id="l36.1264">   QueryInterface: ChromeUtils.generateQI([Ci.nsIFlavorDataProvider]),</span>
<a href="#l36.1265"></a><span id="l36.1265"> </span>
<a href="#l36.1266"></a><span id="l36.1266" class="difflineminus">-  getFlavorData : function(aTransferable, aFlavor, aData, aDataLen) {</span>
<a href="#l36.1267"></a><span id="l36.1267" class="difflineplus">+  getFlavorData(aTransferable, aFlavor, aData, aDataLen) {</span>
<a href="#l36.1268"></a><span id="l36.1268">     if (aFlavor !== &quot;application/x-moz-file-promise&quot;) {</span>
<a href="#l36.1269"></a><span id="l36.1269">       return;</span>
<a href="#l36.1270"></a><span id="l36.1270">     }</span>
<a href="#l36.1271"></a><span id="l36.1271">     let fileUriPrimitive = {};</span>
<a href="#l36.1272"></a><span id="l36.1272">     let dataSize = {};</span>
<a href="#l36.1273"></a><span id="l36.1273">     aTransferable.getTransferData(&quot;application/x-moz-file-promise-url&quot;,</span>
<a href="#l36.1274"></a><span id="l36.1274">                                   fileUriPrimitive, dataSize);</span>
<a href="#l36.1275"></a><span id="l36.1275"> </span>
<a href="#l36.1276"></a><span id="l36.1276" class="difflineat">@@ -1481,18 +1384,18 @@ messageFlavorDataProvider.prototype = {</span>
<a href="#l36.1277"></a><span id="l36.1277">     let file = destDirectory.clone();</span>
<a href="#l36.1278"></a><span id="l36.1278">     file.append(fileName);</span>
<a href="#l36.1279"></a><span id="l36.1279"> </span>
<a href="#l36.1280"></a><span id="l36.1280">     let messageUriPrimitive = {};</span>
<a href="#l36.1281"></a><span id="l36.1281">     aTransferable.getTransferData(&quot;text/x-moz-message&quot;, messageUriPrimitive, dataSize);</span>
<a href="#l36.1282"></a><span id="l36.1282">     let messageUri = messageUriPrimitive.value.QueryInterface(Ci.nsISupportsString);</span>
<a href="#l36.1283"></a><span id="l36.1283"> </span>
<a href="#l36.1284"></a><span id="l36.1284">     messenger.saveAs(messageUri.data, true, null, decodeURIComponent(file.path), true);</span>
<a href="#l36.1285"></a><span id="l36.1285" class="difflineminus">-  }</span>
<a href="#l36.1286"></a><span id="l36.1286" class="difflineminus">-}</span>
<a href="#l36.1287"></a><span id="l36.1287" class="difflineplus">+  },</span>
<a href="#l36.1288"></a><span id="l36.1288" class="difflineplus">+};</span>
<a href="#l36.1289"></a><span id="l36.1289"> </span>
<a href="#l36.1290"></a><span id="l36.1290"> /**</span>
<a href="#l36.1291"></a><span id="l36.1291">  * Returns a new filename that is guaranteed to not be in the Set</span>
<a href="#l36.1292"></a><span id="l36.1292">  * of existing names.</span>
<a href="#l36.1293"></a><span id="l36.1293">  *</span>
<a href="#l36.1294"></a><span id="l36.1294">  * Example use:</span>
<a href="#l36.1295"></a><span id="l36.1295">  *   suggestUniqueFileName(&quot;testname&quot;, &quot;.txt&quot;, new Set(&quot;testname&quot;, &quot;testname1&quot;))</span>
<a href="#l36.1296"></a><span id="l36.1296">  *   returns &quot;testname2.txt&quot;</span>
<a href="#l36.1297"></a><span id="l36.1297" class="difflineat">@@ -1501,17 +1404,17 @@ messageFlavorDataProvider.prototype = {</span>
<a href="#l36.1298"></a><span id="l36.1298">  * @param aIdentifier     proposed filename</span>
<a href="#l36.1299"></a><span id="l36.1299">  * @param aType           extension</span>
<a href="#l36.1300"></a><span id="l36.1300">  * @param aExistingNames  a Set of names already in use</span>
<a href="#l36.1301"></a><span id="l36.1301">  */</span>
<a href="#l36.1302"></a><span id="l36.1302"> function suggestUniqueFileName(aIdentifier, aType, aExistingNames) {</span>
<a href="#l36.1303"></a><span id="l36.1303">   let suffix = 1;</span>
<a href="#l36.1304"></a><span id="l36.1304">   let base = validateFileName(aIdentifier);</span>
<a href="#l36.1305"></a><span id="l36.1305">   let suggestion = base + aType;</span>
<a href="#l36.1306"></a><span id="l36.1306" class="difflineminus">-  while(true) {</span>
<a href="#l36.1307"></a><span id="l36.1307" class="difflineplus">+  while (true) {</span>
<a href="#l36.1308"></a><span id="l36.1308">     if (!aExistingNames.has(suggestion))</span>
<a href="#l36.1309"></a><span id="l36.1309">       break;</span>
<a href="#l36.1310"></a><span id="l36.1310"> </span>
<a href="#l36.1311"></a><span id="l36.1311">     suggestion = base + suffix + aType;</span>
<a href="#l36.1312"></a><span id="l36.1312">     suffix++;</span>
<a href="#l36.1313"></a><span id="l36.1313">   }</span>
<a href="#l36.1314"></a><span id="l36.1314"> </span>
<a href="#l36.1315"></a><span id="l36.1315">   return suggestion;</span>
<a href="#l36.1316"></a><span id="l36.1316" class="difflineat">@@ -1547,23 +1450,23 @@ function ThreadPaneOnDrop(aEvent) {</span>
<a href="#l36.1317"></a><span id="l36.1317">       if (len &gt; 4 &amp;&amp; extFile.leafName.toLowerCase().endsWith(&quot;.eml&quot;))</span>
<a href="#l36.1318"></a><span id="l36.1318">         MailServices.copy.CopyFileMessage(extFile, gFolderDisplay.displayedFolder,</span>
<a href="#l36.1319"></a><span id="l36.1319">                                           null, false, 1, &quot;&quot;, null, msgWindow);</span>
<a href="#l36.1320"></a><span id="l36.1320">     }</span>
<a href="#l36.1321"></a><span id="l36.1321">   }</span>
<a href="#l36.1322"></a><span id="l36.1322"> }</span>
<a href="#l36.1323"></a><span id="l36.1323"> </span>
<a href="#l36.1324"></a><span id="l36.1324"> var LightWeightThemeWebInstaller = {</span>
<a href="#l36.1325"></a><span id="l36.1325" class="difflineminus">-  handleEvent: function (event) {</span>
<a href="#l36.1326"></a><span id="l36.1326" class="difflineplus">+  handleEvent(event) {</span>
<a href="#l36.1327"></a><span id="l36.1327">     switch (event.type) {</span>
<a href="#l36.1328"></a><span id="l36.1328">       case &quot;InstallBrowserTheme&quot;:</span>
<a href="#l36.1329"></a><span id="l36.1329">       case &quot;PreviewBrowserTheme&quot;:</span>
<a href="#l36.1330"></a><span id="l36.1330">       case &quot;ResetBrowserThemePreview&quot;:</span>
<a href="#l36.1331"></a><span id="l36.1331">         // ignore requests from background tabs</span>
<a href="#l36.1332"></a><span id="l36.1332" class="difflineminus">-        if (event.target.ownerDocument.defaultView.top != content)</span>
<a href="#l36.1333"></a><span id="l36.1333" class="difflineplus">+        if (event.target.ownerGlobal.top != content)</span>
<a href="#l36.1334"></a><span id="l36.1334">           return;</span>
<a href="#l36.1335"></a><span id="l36.1335">     }</span>
<a href="#l36.1336"></a><span id="l36.1336">     switch (event.type) {</span>
<a href="#l36.1337"></a><span id="l36.1337">       case &quot;InstallBrowserTheme&quot;:</span>
<a href="#l36.1338"></a><span id="l36.1338">         this._installRequest(event);</span>
<a href="#l36.1339"></a><span id="l36.1339">         break;</span>
<a href="#l36.1340"></a><span id="l36.1340">       case &quot;PreviewBrowserTheme&quot;:</span>
<a href="#l36.1341"></a><span id="l36.1341">         this._preview(event);</span>
<a href="#l36.1342"></a><span id="l36.1342" class="difflineat">@@ -1572,177 +1475,177 @@ var LightWeightThemeWebInstaller = {</span>
<a href="#l36.1343"></a><span id="l36.1343">         this._resetPreview(event);</span>
<a href="#l36.1344"></a><span id="l36.1344">         break;</span>
<a href="#l36.1345"></a><span id="l36.1345">       case &quot;pagehide&quot;:</span>
<a href="#l36.1346"></a><span id="l36.1346">         this._resetPreview();</span>
<a href="#l36.1347"></a><span id="l36.1347">         break;</span>
<a href="#l36.1348"></a><span id="l36.1348">     }</span>
<a href="#l36.1349"></a><span id="l36.1349">   },</span>
<a href="#l36.1350"></a><span id="l36.1350"> </span>
<a href="#l36.1351"></a><span id="l36.1351" class="difflineminus">-  onTabTitleChanged: function (aTab) {</span>
<a href="#l36.1352"></a><span id="l36.1352" class="difflineplus">+  onTabTitleChanged(aTab) {</span>
<a href="#l36.1353"></a><span id="l36.1353">   },</span>
<a href="#l36.1354"></a><span id="l36.1354"> </span>
<a href="#l36.1355"></a><span id="l36.1355" class="difflineminus">-  onTabSwitched: function (aTab, aOldTab) {</span>
<a href="#l36.1356"></a><span id="l36.1356" class="difflineplus">+  onTabSwitched(aTab, aOldTab) {</span>
<a href="#l36.1357"></a><span id="l36.1357">     this._resetPreview();</span>
<a href="#l36.1358"></a><span id="l36.1358">   },</span>
<a href="#l36.1359"></a><span id="l36.1359"> </span>
<a href="#l36.1360"></a><span id="l36.1360" class="difflineminus">-  get _manager () {</span>
<a href="#l36.1361"></a><span id="l36.1361" class="difflineplus">+  get _manager() {</span>
<a href="#l36.1362"></a><span id="l36.1362">     let temp = {};</span>
<a href="#l36.1363"></a><span id="l36.1363">     ChromeUtils.import(&quot;resource://gre/modules/LightweightThemeManager.jsm&quot;, temp);</span>
<a href="#l36.1364"></a><span id="l36.1364">     delete this._manager;</span>
<a href="#l36.1365"></a><span id="l36.1365">     return this._manager = temp.LightweightThemeManager;</span>
<a href="#l36.1366"></a><span id="l36.1366">   },</span>
<a href="#l36.1367"></a><span id="l36.1367"> </span>
<a href="#l36.1368"></a><span id="l36.1368" class="difflineminus">-  _installRequest: function (event) {</span>
<a href="#l36.1369"></a><span id="l36.1369" class="difflineplus">+  _installRequest(event) {</span>
<a href="#l36.1370"></a><span id="l36.1370">     let node = event.target;</span>
<a href="#l36.1371"></a><span id="l36.1371">     let data = this._getThemeFromNode(node);</span>
<a href="#l36.1372"></a><span id="l36.1372">     if (!data)</span>
<a href="#l36.1373"></a><span id="l36.1373">       return;</span>
<a href="#l36.1374"></a><span id="l36.1374"> </span>
<a href="#l36.1375"></a><span id="l36.1375">     if (this._isAllowed(node)) {</span>
<a href="#l36.1376"></a><span id="l36.1376">       this._install(data);</span>
<a href="#l36.1377"></a><span id="l36.1377">       return;</span>
<a href="#l36.1378"></a><span id="l36.1378">     }</span>
<a href="#l36.1379"></a><span id="l36.1379"> </span>
<a href="#l36.1380"></a><span id="l36.1380">     let messengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l36.1381"></a><span id="l36.1381"> </span>
<a href="#l36.1382"></a><span id="l36.1382">     let buttons = [{</span>
<a href="#l36.1383"></a><span id="l36.1383">       label: messengerBundle.getString(&quot;lwthemeInstallRequest.allowButton&quot;),</span>
<a href="#l36.1384"></a><span id="l36.1384">       accessKey: messengerBundle.getString(&quot;lwthemeInstallRequest.allowButton.accesskey&quot;),</span>
<a href="#l36.1385"></a><span id="l36.1385" class="difflineminus">-      callback: function () {</span>
<a href="#l36.1386"></a><span id="l36.1386" class="difflineplus">+      callback() {</span>
<a href="#l36.1387"></a><span id="l36.1387">         LightWeightThemeWebInstaller._install(data);</span>
<a href="#l36.1388"></a><span id="l36.1388" class="difflineminus">-      }</span>
<a href="#l36.1389"></a><span id="l36.1389" class="difflineplus">+      },</span>
<a href="#l36.1390"></a><span id="l36.1390">     }];</span>
<a href="#l36.1391"></a><span id="l36.1391"> </span>
<a href="#l36.1392"></a><span id="l36.1392">     this._removePreviousNotifications();</span>
<a href="#l36.1393"></a><span id="l36.1393"> </span>
<a href="#l36.1394"></a><span id="l36.1394">     let message =</span>
<a href="#l36.1395"></a><span id="l36.1395">       messengerBundle.getFormattedString(&quot;lwthemeInstallRequest.message&quot;,</span>
<a href="#l36.1396"></a><span id="l36.1396">                                          [node.ownerDocument.location.host]);</span>
<a href="#l36.1397"></a><span id="l36.1397"> </span>
<a href="#l36.1398"></a><span id="l36.1398">     let notificationBox = this._getNotificationBox();</span>
<a href="#l36.1399"></a><span id="l36.1399">     let notificationBar =</span>
<a href="#l36.1400"></a><span id="l36.1400">       notificationBox.appendNotification(message, &quot;lwtheme-install-request&quot;, &quot;&quot;,</span>
<a href="#l36.1401"></a><span id="l36.1401">                                          notificationBox.PRIORITY_INFO_MEDIUM,</span>
<a href="#l36.1402"></a><span id="l36.1402">                                          buttons);</span>
<a href="#l36.1403"></a><span id="l36.1403">     notificationBar.persistence = 1;</span>
<a href="#l36.1404"></a><span id="l36.1404">   },</span>
<a href="#l36.1405"></a><span id="l36.1405"> </span>
<a href="#l36.1406"></a><span id="l36.1406" class="difflineminus">-  _executeSoon: function (callback) {</span>
<a href="#l36.1407"></a><span id="l36.1407" class="difflineplus">+  _executeSoon(callback) {</span>
<a href="#l36.1408"></a><span id="l36.1408">     Services.tm.dispatchToMainThread(callback);</span>
<a href="#l36.1409"></a><span id="l36.1409">   },</span>
<a href="#l36.1410"></a><span id="l36.1410"> </span>
<a href="#l36.1411"></a><span id="l36.1411" class="difflineminus">-  _setTheme: function (theme) {</span>
<a href="#l36.1412"></a><span id="l36.1412" class="difflineplus">+  _setTheme(theme) {</span>
<a href="#l36.1413"></a><span id="l36.1413">     this._manager.currentTheme = theme;</span>
<a href="#l36.1414"></a><span id="l36.1414">     return new Promise(this._executeSoon);</span>
<a href="#l36.1415"></a><span id="l36.1415">   },</span>
<a href="#l36.1416"></a><span id="l36.1416"> </span>
<a href="#l36.1417"></a><span id="l36.1417" class="difflineminus">-  _install: async function (newTheme) {</span>
<a href="#l36.1418"></a><span id="l36.1418" class="difflineplus">+  async _install(newTheme) {</span>
<a href="#l36.1419"></a><span id="l36.1419">     let previousTheme = this._manager.currentTheme;</span>
<a href="#l36.1420"></a><span id="l36.1420">     await this._setTheme(newTheme);</span>
<a href="#l36.1421"></a><span id="l36.1421">     if (this._manager.currentTheme &amp;&amp;</span>
<a href="#l36.1422"></a><span id="l36.1422">         this._manager.currentTheme.id == newTheme.id)</span>
<a href="#l36.1423"></a><span id="l36.1423">       this._postInstallNotification(newTheme, previousTheme);</span>
<a href="#l36.1424"></a><span id="l36.1424">   },</span>
<a href="#l36.1425"></a><span id="l36.1425"> </span>
<a href="#l36.1426"></a><span id="l36.1426" class="difflineminus">-  _postInstallNotification: function (newTheme, previousTheme) {</span>
<a href="#l36.1427"></a><span id="l36.1427" class="difflineplus">+  _postInstallNotification(newTheme, previousTheme) {</span>
<a href="#l36.1428"></a><span id="l36.1428">     function text(id) {</span>
<a href="#l36.1429"></a><span id="l36.1429">       return document.getElementById(&quot;bundle_messenger&quot;)</span>
<a href="#l36.1430"></a><span id="l36.1430">                      .getString(&quot;lwthemePostInstallNotification.&quot; + id);</span>
<a href="#l36.1431"></a><span id="l36.1431">     }</span>
<a href="#l36.1432"></a><span id="l36.1432"> </span>
<a href="#l36.1433"></a><span id="l36.1433">     let buttons = [{</span>
<a href="#l36.1434"></a><span id="l36.1434">       label: text(&quot;undoButton&quot;),</span>
<a href="#l36.1435"></a><span id="l36.1435">       accessKey: text(&quot;undoButton.accesskey&quot;),</span>
<a href="#l36.1436"></a><span id="l36.1436" class="difflineminus">-      callback: function () {</span>
<a href="#l36.1437"></a><span id="l36.1437" class="difflineplus">+      callback() {</span>
<a href="#l36.1438"></a><span id="l36.1438">         LightWeightThemeWebInstaller._manager.forgetUsedTheme(newTheme.id);</span>
<a href="#l36.1439"></a><span id="l36.1439">         LightWeightThemeWebInstaller._manager.currentTheme = previousTheme;</span>
<a href="#l36.1440"></a><span id="l36.1440" class="difflineminus">-      }</span>
<a href="#l36.1441"></a><span id="l36.1441" class="difflineplus">+      },</span>
<a href="#l36.1442"></a><span id="l36.1442">     }, {</span>
<a href="#l36.1443"></a><span id="l36.1443">       label: text(&quot;manageButton&quot;),</span>
<a href="#l36.1444"></a><span id="l36.1444">       accessKey: text(&quot;manageButton.accesskey&quot;),</span>
<a href="#l36.1445"></a><span id="l36.1445" class="difflineminus">-      callback: function () {</span>
<a href="#l36.1446"></a><span id="l36.1446" class="difflineplus">+      callback() {</span>
<a href="#l36.1447"></a><span id="l36.1447">         openAddonsMgr(&quot;addons://list/theme&quot;);</span>
<a href="#l36.1448"></a><span id="l36.1448" class="difflineminus">-      }</span>
<a href="#l36.1449"></a><span id="l36.1449" class="difflineplus">+      },</span>
<a href="#l36.1450"></a><span id="l36.1450">     }];</span>
<a href="#l36.1451"></a><span id="l36.1451"> </span>
<a href="#l36.1452"></a><span id="l36.1452">     this._removePreviousNotifications();</span>
<a href="#l36.1453"></a><span id="l36.1453"> </span>
<a href="#l36.1454"></a><span id="l36.1454">     let notificationBox = this._getNotificationBox();</span>
<a href="#l36.1455"></a><span id="l36.1455">     let notificationBar =</span>
<a href="#l36.1456"></a><span id="l36.1456">       notificationBox.appendNotification(text(&quot;message&quot;),</span>
<a href="#l36.1457"></a><span id="l36.1457">                                          &quot;lwtheme-install-notification&quot;, &quot;&quot;,</span>
<a href="#l36.1458"></a><span id="l36.1458">                                          notificationBox.PRIORITY_INFO_MEDIUM,</span>
<a href="#l36.1459"></a><span id="l36.1459">                                          buttons);</span>
<a href="#l36.1460"></a><span id="l36.1460">     notificationBar.persistence = 1;</span>
<a href="#l36.1461"></a><span id="l36.1461">     notificationBar.timeout = Date.now() + 20000; // 20 seconds</span>
<a href="#l36.1462"></a><span id="l36.1462">   },</span>
<a href="#l36.1463"></a><span id="l36.1463"> </span>
<a href="#l36.1464"></a><span id="l36.1464" class="difflineminus">-  _removePreviousNotifications: function () {</span>
<a href="#l36.1465"></a><span id="l36.1465" class="difflineplus">+  _removePreviousNotifications() {</span>
<a href="#l36.1466"></a><span id="l36.1466">     let box = this._getNotificationBox();</span>
<a href="#l36.1467"></a><span id="l36.1467"> </span>
<a href="#l36.1468"></a><span id="l36.1468">     [&quot;lwtheme-install-request&quot;,</span>
<a href="#l36.1469"></a><span id="l36.1469" class="difflineminus">-     &quot;lwtheme-install-notification&quot;].forEach(function (value) {</span>
<a href="#l36.1470"></a><span id="l36.1470" class="difflineplus">+     &quot;lwtheme-install-notification&quot;].forEach(function(value) {</span>
<a href="#l36.1471"></a><span id="l36.1471">         var notification = box.getNotificationWithValue(value);</span>
<a href="#l36.1472"></a><span id="l36.1472">         if (notification)</span>
<a href="#l36.1473"></a><span id="l36.1473">           box.removeNotification(notification);</span>
<a href="#l36.1474"></a><span id="l36.1474">       });</span>
<a href="#l36.1475"></a><span id="l36.1475">   },</span>
<a href="#l36.1476"></a><span id="l36.1476"> </span>
<a href="#l36.1477"></a><span id="l36.1477">   _previewWindow: null,</span>
<a href="#l36.1478"></a><span id="l36.1478" class="difflineminus">-  _preview: function (event) {</span>
<a href="#l36.1479"></a><span id="l36.1479" class="difflineplus">+  _preview(event) {</span>
<a href="#l36.1480"></a><span id="l36.1480">     if (!this._isAllowed(event.target))</span>
<a href="#l36.1481"></a><span id="l36.1481">       return;</span>
<a href="#l36.1482"></a><span id="l36.1482"> </span>
<a href="#l36.1483"></a><span id="l36.1483">     let data = this._getThemeFromNode(event.target);</span>
<a href="#l36.1484"></a><span id="l36.1484">     if (!data)</span>
<a href="#l36.1485"></a><span id="l36.1485">       return;</span>
<a href="#l36.1486"></a><span id="l36.1486"> </span>
<a href="#l36.1487"></a><span id="l36.1487">     this._resetPreview();</span>
<a href="#l36.1488"></a><span id="l36.1488"> </span>
<a href="#l36.1489"></a><span id="l36.1489" class="difflineminus">-    this._previewWindow = event.target.ownerDocument.defaultView;</span>
<a href="#l36.1490"></a><span id="l36.1490" class="difflineplus">+    this._previewWindow = event.target.ownerGlobal;</span>
<a href="#l36.1491"></a><span id="l36.1491">     this._previewWindow.addEventListener(&quot;pagehide&quot;, this, true);</span>
<a href="#l36.1492"></a><span id="l36.1492" class="difflineminus">-    document.getElementById('tabmail').registerTabMonitor(this);</span>
<a href="#l36.1493"></a><span id="l36.1493" class="difflineplus">+    document.getElementById(&quot;tabmail&quot;).registerTabMonitor(this);</span>
<a href="#l36.1494"></a><span id="l36.1494"> </span>
<a href="#l36.1495"></a><span id="l36.1495">     this._manager.previewTheme(data);</span>
<a href="#l36.1496"></a><span id="l36.1496">   },</span>
<a href="#l36.1497"></a><span id="l36.1497"> </span>
<a href="#l36.1498"></a><span id="l36.1498" class="difflineminus">-  _resetPreview: function (event) {</span>
<a href="#l36.1499"></a><span id="l36.1499" class="difflineplus">+  _resetPreview(event) {</span>
<a href="#l36.1500"></a><span id="l36.1500">     if (!this._previewWindow ||</span>
<a href="#l36.1501"></a><span id="l36.1501">         event &amp;&amp; !this._isAllowed(event.target))</span>
<a href="#l36.1502"></a><span id="l36.1502">       return;</span>
<a href="#l36.1503"></a><span id="l36.1503"> </span>
<a href="#l36.1504"></a><span id="l36.1504">     this._previewWindow.removeEventListener(&quot;pagehide&quot;, this, true);</span>
<a href="#l36.1505"></a><span id="l36.1505">     this._previewWindow = null;</span>
<a href="#l36.1506"></a><span id="l36.1506" class="difflineminus">-    document.getElementById('tabmail').unregisterTabMonitor(this);</span>
<a href="#l36.1507"></a><span id="l36.1507" class="difflineplus">+    document.getElementById(&quot;tabmail&quot;).unregisterTabMonitor(this);</span>
<a href="#l36.1508"></a><span id="l36.1508"> </span>
<a href="#l36.1509"></a><span id="l36.1509">     this._manager.resetPreview();</span>
<a href="#l36.1510"></a><span id="l36.1510">   },</span>
<a href="#l36.1511"></a><span id="l36.1511"> </span>
<a href="#l36.1512"></a><span id="l36.1512" class="difflineminus">-  _isAllowed: function (node) {</span>
<a href="#l36.1513"></a><span id="l36.1513" class="difflineplus">+  _isAllowed(node) {</span>
<a href="#l36.1514"></a><span id="l36.1514">     let uri = node.ownerDocument.documentURIObject;</span>
<a href="#l36.1515"></a><span id="l36.1515">     return Services.perms.testPermission(uri, &quot;install&quot;) == Services.perms.ALLOW_ACTION;</span>
<a href="#l36.1516"></a><span id="l36.1516">   },</span>
<a href="#l36.1517"></a><span id="l36.1517"> </span>
<a href="#l36.1518"></a><span id="l36.1518" class="difflineminus">-  _getNotificationBox: function () {</span>
<a href="#l36.1519"></a><span id="l36.1519" class="difflineplus">+  _getNotificationBox() {</span>
<a href="#l36.1520"></a><span id="l36.1520">     // Try and get the notification box for the selected tab.</span>
<a href="#l36.1521"></a><span id="l36.1521" class="difflineminus">-    let browser = document.getElementById('tabmail').getBrowserForSelectedTab();</span>
<a href="#l36.1522"></a><span id="l36.1522" class="difflineplus">+    let browser = document.getElementById(&quot;tabmail&quot;).getBrowserForSelectedTab();</span>
<a href="#l36.1523"></a><span id="l36.1523">     // The messagepane doesn't have a notification bar yet.</span>
<a href="#l36.1524"></a><span id="l36.1524">     if (browser &amp;&amp; browser.parentNode.tagName == &quot;notificationbox&quot;)</span>
<a href="#l36.1525"></a><span id="l36.1525">       return browser.parentNode;</span>
<a href="#l36.1526"></a><span id="l36.1526"> </span>
<a href="#l36.1527"></a><span id="l36.1527">     // Otherwise, default to the global notificationbox</span>
<a href="#l36.1528"></a><span id="l36.1528">     return document.getElementById(&quot;mail-notification-box&quot;);</span>
<a href="#l36.1529"></a><span id="l36.1529">   },</span>
<a href="#l36.1530"></a><span id="l36.1530"> </span>
<a href="#l36.1531"></a><span id="l36.1531" class="difflineminus">-  _getThemeFromNode: function (node) {</span>
<a href="#l36.1532"></a><span id="l36.1532" class="difflineplus">+  _getThemeFromNode(node) {</span>
<a href="#l36.1533"></a><span id="l36.1533">     return this._manager.parseTheme(node.getAttribute(&quot;data-browsertheme&quot;),</span>
<a href="#l36.1534"></a><span id="l36.1534">                                     node.baseURI);</span>
<a href="#l36.1535"></a><span id="l36.1535" class="difflineminus">-  }</span>
<a href="#l36.1536"></a><span id="l36.1536" class="difflineminus">-}</span>
<a href="#l36.1537"></a><span id="l36.1537" class="difflineplus">+  },</span>
<a href="#l36.1538"></a><span id="l36.1538" class="difflineplus">+};</span>
<a href="#l36.1539"></a><span id="l36.1539"> </span>
<a href="#l36.1540"></a><span id="l36.1540"> /**</span>
<a href="#l36.1541"></a><span id="l36.1541">  * Initialize and attach the HTML5 context menu to the specified menupopup</span>
<a href="#l36.1542"></a><span id="l36.1542">  * during the onpopupshowing event.</span>
<a href="#l36.1543"></a><span id="l36.1543">  *</span>
<a href="#l36.1544"></a><span id="l36.1544">  * @param menuPopup the menupopup element</span>
<a href="#l36.1545"></a><span id="l36.1545">  * @param event the event responsible for showing the popup</span>
<a href="#l36.1546"></a><span id="l36.1546">  */</span>
<a href="#l36.1547"></a><span id="l36.1547" class="difflineat">@@ -2064,17 +1967,17 @@ var TabsInTitlebar = {</span>
<a href="#l36.1548"></a><span id="l36.1548">   },</span>
<a href="#l36.1549"></a><span id="l36.1549"> </span>
<a href="#l36.1550"></a><span id="l36.1550">   uninit() {</span>
<a href="#l36.1551"></a><span id="l36.1551">     this._initialized = false;</span>
<a href="#l36.1552"></a><span id="l36.1552">     gDragSpaceObserver.uninit();</span>
<a href="#l36.1553"></a><span id="l36.1553">     Services.prefs.removeObserver(this._drawInTitlePref, this);</span>
<a href="#l36.1554"></a><span id="l36.1554">     Services.prefs.removeObserver(this._autoHidePref, this);</span>
<a href="#l36.1555"></a><span id="l36.1555">     this._menuObserver.disconnect();</span>
<a href="#l36.1556"></a><span id="l36.1556" class="difflineminus">-  }</span>
<a href="#l36.1557"></a><span id="l36.1557" class="difflineplus">+  },</span>
<a href="#l36.1558"></a><span id="l36.1558"> };</span>
<a href="#l36.1559"></a><span id="l36.1559"> </span>
<a href="#l36.1560"></a><span id="l36.1560"> /* Draw */</span>
<a href="#l36.1561"></a><span id="l36.1561"> function onTitlebarMaxClick() {</span>
<a href="#l36.1562"></a><span id="l36.1562">   if (window.windowState == window.STATE_MAXIMIZED)</span>
<a href="#l36.1563"></a><span id="l36.1563">     window.restore();</span>
<a href="#l36.1564"></a><span id="l36.1564">   else</span>
<a href="#l36.1565"></a><span id="l36.1565">     window.maximize();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mail/base/content/msgViewNavigation.js</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mail/base/content/msgViewNavigation.js</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -3,38 +3,36 @@</span>
<a href="#l37.4"></a><span id="l37.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l37.5"></a><span id="l37.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l37.6"></a><span id="l37.6"> </span>
<a href="#l37.7"></a><span id="l37.7"> /*  This file contains the js functions necessary to implement view navigation within the 3 pane. */</span>
<a href="#l37.8"></a><span id="l37.8"> </span>
<a href="#l37.9"></a><span id="l37.9"> ChromeUtils.import(&quot;resource:///modules/folderUtils.jsm&quot;);</span>
<a href="#l37.10"></a><span id="l37.10"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l37.11"></a><span id="l37.11"> </span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-function GetSubFoldersInFolderPaneOrder(folder)</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineminus">-{</span>
<a href="#l37.14"></a><span id="l37.14" class="difflineplus">+function GetSubFoldersInFolderPaneOrder(folder) {</span>
<a href="#l37.15"></a><span id="l37.15">   var subFolders = folder.subFolders;</span>
<a href="#l37.16"></a><span id="l37.16" class="difflineminus">-  var msgFolders = Array();</span>
<a href="#l37.17"></a><span id="l37.17" class="difflineplus">+  var msgFolders = [];</span>
<a href="#l37.18"></a><span id="l37.18"> </span>
<a href="#l37.19"></a><span id="l37.19">   // get all the subfolders</span>
<a href="#l37.20"></a><span id="l37.20">   while (subFolders.hasMoreElements()) {</span>
<a href="#l37.21"></a><span id="l37.21">     msgFolders[msgFolders.length] =</span>
<a href="#l37.22"></a><span id="l37.22">       subFolders.getNext().QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l37.23"></a><span id="l37.23">   }</span>
<a href="#l37.24"></a><span id="l37.24"> </span>
<a href="#l37.25"></a><span id="l37.25">   function compareFolderSortKey(folder1, folder2) {</span>
<a href="#l37.26"></a><span id="l37.26">     return folder1.compareSortKeys(folder2);</span>
<a href="#l37.27"></a><span id="l37.27">   }</span>
<a href="#l37.28"></a><span id="l37.28"> </span>
<a href="#l37.29"></a><span id="l37.29">   // sort the subfolders</span>
<a href="#l37.30"></a><span id="l37.30">   msgFolders.sort(compareFolderSortKey);</span>
<a href="#l37.31"></a><span id="l37.31">   return msgFolders;</span>
<a href="#l37.32"></a><span id="l37.32"> }</span>
<a href="#l37.33"></a><span id="l37.33"> </span>
<a href="#l37.34"></a><span id="l37.34" class="difflineminus">-function FindNextChildFolder(aParent, aAfter)</span>
<a href="#l37.35"></a><span id="l37.35" class="difflineminus">-{</span>
<a href="#l37.36"></a><span id="l37.36" class="difflineplus">+function FindNextChildFolder(aParent, aAfter) {</span>
<a href="#l37.37"></a><span id="l37.37">   // Search the child folders of aParent for unread messages</span>
<a href="#l37.38"></a><span id="l37.38">   // but in the case that we are working up from the current folder</span>
<a href="#l37.39"></a><span id="l37.39">   // we need to skip up to and including the current folder</span>
<a href="#l37.40"></a><span id="l37.40">   // we skip the current folder in case a mail view is hiding unread messages</span>
<a href="#l37.41"></a><span id="l37.41">   if (aParent.getNumUnread(true) &gt; 0) {</span>
<a href="#l37.42"></a><span id="l37.42">     var subFolders = GetSubFoldersInFolderPaneOrder(aParent);</span>
<a href="#l37.43"></a><span id="l37.43">     var i = 0;</span>
<a href="#l37.44"></a><span id="l37.44">     var folder = null;</span>
<a href="#l37.45"></a><span id="l37.45" class="difflineat">@@ -60,30 +58,29 @@ function FindNextChildFolder(aParent, aA</span>
<a href="#l37.46"></a><span id="l37.46">           return folder;</span>
<a href="#l37.47"></a><span id="l37.47">       }</span>
<a href="#l37.48"></a><span id="l37.48">     }</span>
<a href="#l37.49"></a><span id="l37.49">   }</span>
<a href="#l37.50"></a><span id="l37.50"> </span>
<a href="#l37.51"></a><span id="l37.51">   return null;</span>
<a href="#l37.52"></a><span id="l37.52"> }</span>
<a href="#l37.53"></a><span id="l37.53"> </span>
<a href="#l37.54"></a><span id="l37.54" class="difflineminus">-function FindNextFolder()</span>
<a href="#l37.55"></a><span id="l37.55" class="difflineminus">-{</span>
<a href="#l37.56"></a><span id="l37.56" class="difflineplus">+function FindNextFolder() {</span>
<a href="#l37.57"></a><span id="l37.57">   // look for the next folder, this will only look on the current account</span>
<a href="#l37.58"></a><span id="l37.58">   // and below us, in the folder pane</span>
<a href="#l37.59"></a><span id="l37.59">   // note use of gDBView restricts this function to message folders</span>
<a href="#l37.60"></a><span id="l37.60">   // otherwise you could go next unread from a server</span>
<a href="#l37.61"></a><span id="l37.61">   var folder = FindNextChildFolder(gDBView.msgFolder, null);</span>
<a href="#l37.62"></a><span id="l37.62">   if (folder)</span>
<a href="#l37.63"></a><span id="l37.63">     return folder;</span>
<a href="#l37.64"></a><span id="l37.64"> </span>
<a href="#l37.65"></a><span id="l37.65">   // didn't find folder in children</span>
<a href="#l37.66"></a><span id="l37.66">   // go up to the parent, and start at the folder after the current one</span>
<a href="#l37.67"></a><span id="l37.67">   // unless we are at a server, in which case bail out.</span>
<a href="#l37.68"></a><span id="l37.68" class="difflineminus">-  for (folder = gDBView.msgFolder; !folder.isServer; ) {</span>
<a href="#l37.69"></a><span id="l37.69" class="difflineplus">+  for (folder = gDBView.msgFolder; !folder.isServer;) {</span>
<a href="#l37.70"></a><span id="l37.70"> </span>
<a href="#l37.71"></a><span id="l37.71">     var parent = folder.parent;</span>
<a href="#l37.72"></a><span id="l37.72">     folder = FindNextChildFolder(parent, folder);</span>
<a href="#l37.73"></a><span id="l37.73">     if (folder)</span>
<a href="#l37.74"></a><span id="l37.74">       return folder;</span>
<a href="#l37.75"></a><span id="l37.75"> </span>
<a href="#l37.76"></a><span id="l37.76">     // none at this level after the current folder.  go up.</span>
<a href="#l37.77"></a><span id="l37.77">     folder = parent;</span>
<a href="#l37.78"></a><span id="l37.78" class="difflineat">@@ -110,81 +107,77 @@ function FindNextFolder()</span>
<a href="#l37.79"></a><span id="l37.79">   for (j = 0; j &lt;= i; j++) {</span>
<a href="#l37.80"></a><span id="l37.80">     folder = FindNextChildFolder(rootFolders[j], null);</span>
<a href="#l37.81"></a><span id="l37.81">     if (folder)</span>
<a href="#l37.82"></a><span id="l37.82">       return folder;</span>
<a href="#l37.83"></a><span id="l37.83">   }</span>
<a href="#l37.84"></a><span id="l37.84">   return null;</span>
<a href="#l37.85"></a><span id="l37.85"> }</span>
<a href="#l37.86"></a><span id="l37.86"> </span>
<a href="#l37.87"></a><span id="l37.87" class="difflineminus">-function GetRootFoldersInFolderPaneOrder()</span>
<a href="#l37.88"></a><span id="l37.88" class="difflineminus">-{</span>
<a href="#l37.89"></a><span id="l37.89" class="difflineplus">+function GetRootFoldersInFolderPaneOrder() {</span>
<a href="#l37.90"></a><span id="l37.90">   let accounts = allAccountsSorted(false);</span>
<a href="#l37.91"></a><span id="l37.91"> </span>
<a href="#l37.92"></a><span id="l37.92">   let serversMsgFolders = [];</span>
<a href="#l37.93"></a><span id="l37.93">   for (let account of accounts)</span>
<a href="#l37.94"></a><span id="l37.94">     serversMsgFolders.push(account.incomingServer.rootMsgFolder);</span>
<a href="#l37.95"></a><span id="l37.95"> </span>
<a href="#l37.96"></a><span id="l37.96">   return serversMsgFolders;</span>
<a href="#l37.97"></a><span id="l37.97"> }</span>
<a href="#l37.98"></a><span id="l37.98"> </span>
<a href="#l37.99"></a><span id="l37.99" class="difflineminus">-function CrossFolderNavigation(type)</span>
<a href="#l37.100"></a><span id="l37.100" class="difflineminus">-{</span>
<a href="#l37.101"></a><span id="l37.101" class="difflineplus">+function CrossFolderNavigation(type) {</span>
<a href="#l37.102"></a><span id="l37.102">   // do cross folder navigation for next unread message/thread and message history</span>
<a href="#l37.103"></a><span id="l37.103">   if (type != nsMsgNavigationType.nextUnreadMessage &amp;&amp;</span>
<a href="#l37.104"></a><span id="l37.104">       type != nsMsgNavigationType.nextUnreadThread &amp;&amp;</span>
<a href="#l37.105"></a><span id="l37.105">       type != nsMsgNavigationType.forward &amp;&amp;</span>
<a href="#l37.106"></a><span id="l37.106">       type != nsMsgNavigationType.back)</span>
<a href="#l37.107"></a><span id="l37.107">     return;</span>
<a href="#l37.108"></a><span id="l37.108"> </span>
<a href="#l37.109"></a><span id="l37.109">   if (type == nsMsgNavigationType.nextUnreadMessage ||</span>
<a href="#l37.110"></a><span id="l37.110" class="difflineminus">-      type == nsMsgNavigationType.nextUnreadThread)</span>
<a href="#l37.111"></a><span id="l37.111" class="difflineminus">-  {</span>
<a href="#l37.112"></a><span id="l37.112" class="difflineplus">+      type == nsMsgNavigationType.nextUnreadThread) {</span>
<a href="#l37.113"></a><span id="l37.113">     var nextMode = Services.prefs.getIntPref(&quot;mailnews.nav_crosses_folders&quot;);</span>
<a href="#l37.114"></a><span id="l37.114">     // 0: &quot;next&quot; goes to the next folder, without prompting</span>
<a href="#l37.115"></a><span id="l37.115">     // 1: &quot;next&quot; goes to the next folder, and prompts (the default)</span>
<a href="#l37.116"></a><span id="l37.116">     // 2: &quot;next&quot; does nothing when there are no unread messages</span>
<a href="#l37.117"></a><span id="l37.117"> </span>
<a href="#l37.118"></a><span id="l37.118">     // not crossing folders, don't find next</span>
<a href="#l37.119"></a><span id="l37.119">     if (nextMode == 2)</span>
<a href="#l37.120"></a><span id="l37.120">       return;</span>
<a href="#l37.121"></a><span id="l37.121"> </span>
<a href="#l37.122"></a><span id="l37.122">     var folder = FindNextFolder();</span>
<a href="#l37.123"></a><span id="l37.123" class="difflineminus">-    if (folder &amp;&amp; (gDBView.msgFolder.URI != folder.URI))</span>
<a href="#l37.124"></a><span id="l37.124" class="difflineminus">-    {</span>
<a href="#l37.125"></a><span id="l37.125" class="difflineminus">-      if (nextMode == 1)</span>
<a href="#l37.126"></a><span id="l37.126" class="difflineminus">-      {</span>
<a href="#l37.127"></a><span id="l37.127" class="difflineplus">+    if (folder &amp;&amp; (gDBView.msgFolder.URI != folder.URI)) {</span>
<a href="#l37.128"></a><span id="l37.128" class="difflineplus">+      if (nextMode == 1) {</span>
<a href="#l37.129"></a><span id="l37.129">         let promptText = document.getElementById(&quot;bundle_messenger&quot;)</span>
<a href="#l37.130"></a><span id="l37.130">                                  .getFormattedString(&quot;advanceNextPrompt&quot;,</span>
<a href="#l37.131"></a><span id="l37.131">                                                      [folder.name], 1);</span>
<a href="#l37.132"></a><span id="l37.132">         if (Services.prompt.confirmEx(window, null, promptText,</span>
<a href="#l37.133"></a><span id="l37.133">                                       Services.prompt.STD_YES_NO_BUTTONS,</span>
<a href="#l37.134"></a><span id="l37.134">                                       null, null, null, null, {}))</span>
<a href="#l37.135"></a><span id="l37.135">           return;</span>
<a href="#l37.136"></a><span id="l37.136">       }</span>
<a href="#l37.137"></a><span id="l37.137">       gFolderDisplay.pushNavigation(type, true);</span>
<a href="#l37.138"></a><span id="l37.138">       SelectFolder(folder.URI);</span>
<a href="#l37.139"></a><span id="l37.139">     }</span>
<a href="#l37.140"></a><span id="l37.140" class="difflineminus">-  }</span>
<a href="#l37.141"></a><span id="l37.141" class="difflineminus">-  else</span>
<a href="#l37.142"></a><span id="l37.142" class="difflineminus">-  {</span>
<a href="#l37.143"></a><span id="l37.143" class="difflineplus">+  } else {</span>
<a href="#l37.144"></a><span id="l37.144">     // if no message is loaded, relPos should be 0, to</span>
<a href="#l37.145"></a><span id="l37.145">     // go back to the previously loaded message</span>
<a href="#l37.146"></a><span id="l37.146" class="difflineminus">-    var relPos = (type == nsMsgNavigationType.forward)</span>
<a href="#l37.147"></a><span id="l37.147" class="difflineminus">-      ? 1 : ((gMessageDisplay.displayedMessage) ? -1 : 0);</span>
<a href="#l37.148"></a><span id="l37.148" class="difflineplus">+    var relPos = 0;</span>
<a href="#l37.149"></a><span id="l37.149" class="difflineplus">+    if (type == nsMsgNavigationType.forward) {</span>
<a href="#l37.150"></a><span id="l37.150" class="difflineplus">+      relPos = 1;</span>
<a href="#l37.151"></a><span id="l37.151" class="difflineplus">+    } else if (gMessageDisplay.displayedMessage) {</span>
<a href="#l37.152"></a><span id="l37.152" class="difflineplus">+      relPos = -1;</span>
<a href="#l37.153"></a><span id="l37.153" class="difflineplus">+    }</span>
<a href="#l37.154"></a><span id="l37.154">     var folderUri = messenger.getFolderUriAtNavigatePos(relPos);</span>
<a href="#l37.155"></a><span id="l37.155">     var msgHdr = messenger.msgHdrFromURI(messenger.getMsgUriAtNavigatePos(relPos));</span>
<a href="#l37.156"></a><span id="l37.156">     gStartMsgKey = msgHdr.messageKey;</span>
<a href="#l37.157"></a><span id="l37.157">     var curPos = messenger.navigatePos;</span>
<a href="#l37.158"></a><span id="l37.158">     curPos += relPos;</span>
<a href="#l37.159"></a><span id="l37.159">     messenger.navigatePos = curPos;</span>
<a href="#l37.160"></a><span id="l37.160">     SelectFolder(folderUri);</span>
<a href="#l37.161"></a><span id="l37.161">   }</span>
<a href="#l37.162"></a><span id="l37.162"> }</span>
<a href="#l37.163"></a><span id="l37.163"> </span>
<a href="#l37.164"></a><span id="l37.164" class="difflineminus">-function GoNextMessage(type, startFromBeginning)</span>
<a href="#l37.165"></a><span id="l37.165" class="difflineminus">-{</span>
<a href="#l37.166"></a><span id="l37.166" class="difflineplus">+function GoNextMessage(type, startFromBeginning) {</span>
<a href="#l37.167"></a><span id="l37.167">   if (!gFolderDisplay.navigate(type))</span>
<a href="#l37.168"></a><span id="l37.168">     CrossFolderNavigation(type);</span>
<a href="#l37.169"></a><span id="l37.169"> </span>
<a href="#l37.170"></a><span id="l37.170">   SetFocusThreadPaneIfNotOnMessagePane();</span>
<a href="#l37.171"></a><span id="l37.171"> }</span>
<a href="#l37.172"></a><span id="l37.172"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/mail/base/content/multimessageview.js</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/mail/base/content/multimessageview.js</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -62,17 +62,17 @@ LimitIterator.prototype = {</span>
<a href="#l38.4"></a><span id="l38.4"> </span>
<a href="#l38.5"></a><span id="l38.5"> var JS_HAS_SYMBOLS = typeof Symbol === &quot;function&quot;;</span>
<a href="#l38.6"></a><span id="l38.6"> var ITERATOR_SYMBOL = JS_HAS_SYMBOLS ? Symbol.iterator : &quot;@@iterator&quot;;</span>
<a href="#l38.7"></a><span id="l38.7"> </span>
<a href="#l38.8"></a><span id="l38.8"> /**</span>
<a href="#l38.9"></a><span id="l38.9">  * Iterate over the array until we hit the end or the maximum length,</span>
<a href="#l38.10"></a><span id="l38.10">  * whichever comes first.</span>
<a href="#l38.11"></a><span id="l38.11">  */</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-LimitIterator.prototype[ITERATOR_SYMBOL] = function*() {</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineplus">+LimitIterator.prototype[ITERATOR_SYMBOL] = function* () {</span>
<a href="#l38.14"></a><span id="l38.14">   let length = this.length;</span>
<a href="#l38.15"></a><span id="l38.15">   for (let i = 0; i &lt; length; i++)</span>
<a href="#l38.16"></a><span id="l38.16">     yield this._array[i];</span>
<a href="#l38.17"></a><span id="l38.17"> };</span>
<a href="#l38.18"></a><span id="l38.18"> </span>
<a href="#l38.19"></a><span id="l38.19"> /**</span>
<a href="#l38.20"></a><span id="l38.20">  * The MultiMessageSummary class is responsible for populating the message pane</span>
<a href="#l38.21"></a><span id="l38.21">  * with a reasonable summary of a set of messages.</span>
<a href="#l38.22"></a><span id="l38.22" class="difflineat">@@ -91,37 +91,37 @@ MultiMessageSummary.prototype = {</span>
<a href="#l38.23"></a><span id="l38.23">    */</span>
<a href="#l38.24"></a><span id="l38.24">   kMaxMessages: 10000,</span>
<a href="#l38.25"></a><span id="l38.25"> </span>
<a href="#l38.26"></a><span id="l38.26">   /**</span>
<a href="#l38.27"></a><span id="l38.27">    * Register a summarizer for a particular type of message summary.</span>
<a href="#l38.28"></a><span id="l38.28">    *</span>
<a href="#l38.29"></a><span id="l38.29">    * @param aSummarizer The summarizer object.</span>
<a href="#l38.30"></a><span id="l38.30">    */</span>
<a href="#l38.31"></a><span id="l38.31" class="difflineminus">-  registerSummarizer: function(aSummarizer) {</span>
<a href="#l38.32"></a><span id="l38.32" class="difflineplus">+  registerSummarizer(aSummarizer) {</span>
<a href="#l38.33"></a><span id="l38.33">     this._summarizers[aSummarizer.name] = aSummarizer;</span>
<a href="#l38.34"></a><span id="l38.34">     aSummarizer.onregistered(this);</span>
<a href="#l38.35"></a><span id="l38.35">   },</span>
<a href="#l38.36"></a><span id="l38.36"> </span>
<a href="#l38.37"></a><span id="l38.37">   /**</span>
<a href="#l38.38"></a><span id="l38.38">    * Store a mapping from a message header to the summary node in the DOM. We</span>
<a href="#l38.39"></a><span id="l38.39">    * use this to update things when Gloda tells us to.</span>
<a href="#l38.40"></a><span id="l38.40">    *</span>
<a href="#l38.41"></a><span id="l38.41">    * @param aMsgHdr The nsIMsgDBHdr.</span>
<a href="#l38.42"></a><span id="l38.42">    * @param aNode   The related DOM node.</span>
<a href="#l38.43"></a><span id="l38.43">    */</span>
<a href="#l38.44"></a><span id="l38.44" class="difflineminus">-  mapMsgToNode: function(aMsgHdr, aNode) {</span>
<a href="#l38.45"></a><span id="l38.45" class="difflineplus">+  mapMsgToNode(aMsgHdr, aNode) {</span>
<a href="#l38.46"></a><span id="l38.46">     let key = aMsgHdr.messageKey + aMsgHdr.folder.URI;</span>
<a href="#l38.47"></a><span id="l38.47">     this._msgNodes[key] = aNode;</span>
<a href="#l38.48"></a><span id="l38.48">   },</span>
<a href="#l38.49"></a><span id="l38.49"> </span>
<a href="#l38.50"></a><span id="l38.50">   /**</span>
<a href="#l38.51"></a><span id="l38.51">    * Clear all the content from the summary.</span>
<a href="#l38.52"></a><span id="l38.52">    */</span>
<a href="#l38.53"></a><span id="l38.53" class="difflineminus">-  clear: function() {</span>
<a href="#l38.54"></a><span id="l38.54" class="difflineplus">+  clear() {</span>
<a href="#l38.55"></a><span id="l38.55">     this._listener = null;</span>
<a href="#l38.56"></a><span id="l38.56">     this._glodaQuery = null;</span>
<a href="#l38.57"></a><span id="l38.57">     this._msgNodes = {};</span>
<a href="#l38.58"></a><span id="l38.58"> </span>
<a href="#l38.59"></a><span id="l38.59">     // Clear the messages list.</span>
<a href="#l38.60"></a><span id="l38.60">     let messageList = document.getElementById(&quot;message_list&quot;);</span>
<a href="#l38.61"></a><span id="l38.61">     while (messageList.hasChildNodes())</span>
<a href="#l38.62"></a><span id="l38.62">       messageList.lastChild.remove();</span>
<a href="#l38.63"></a><span id="l38.63" class="difflineat">@@ -134,17 +134,17 @@ MultiMessageSummary.prototype = {</span>
<a href="#l38.64"></a><span id="l38.64">   /**</span>
<a href="#l38.65"></a><span id="l38.65">    * Fill in the summary pane describing the selected messages.</span>
<a href="#l38.66"></a><span id="l38.66">    *</span>
<a href="#l38.67"></a><span id="l38.67">    * @param aType       The type of summary to perform (e.g. 'multimessage').</span>
<a href="#l38.68"></a><span id="l38.68">    * @param aMessages   The messages to summarize.</span>
<a href="#l38.69"></a><span id="l38.69">    * @param [aListener] A listener to be notified when the summary starts and</span>
<a href="#l38.70"></a><span id="l38.70">    *                    finishes.</span>
<a href="#l38.71"></a><span id="l38.71">    */</span>
<a href="#l38.72"></a><span id="l38.72" class="difflineminus">-  summarize: function(aType, aMessages, aListener) {</span>
<a href="#l38.73"></a><span id="l38.73" class="difflineplus">+  summarize(aType, aMessages, aListener) {</span>
<a href="#l38.74"></a><span id="l38.74">     this.clear();</span>
<a href="#l38.75"></a><span id="l38.75"> </span>
<a href="#l38.76"></a><span id="l38.76">     this._listener = aListener;</span>
<a href="#l38.77"></a><span id="l38.77">     if (this._listener)</span>
<a href="#l38.78"></a><span id="l38.78">       this._listener.onLoadStarted();</span>
<a href="#l38.79"></a><span id="l38.79"> </span>
<a href="#l38.80"></a><span id="l38.80">     // Enable/disable the archive button as appropriate.</span>
<a href="#l38.81"></a><span id="l38.81">     let archiveBtn = document.getElementById(&quot;hdrArchiveButton&quot;);</span>
<a href="#l38.82"></a><span id="l38.82" class="difflineat">@@ -166,17 +166,17 @@ MultiMessageSummary.prototype = {</span>
<a href="#l38.83"></a><span id="l38.83">   },</span>
<a href="#l38.84"></a><span id="l38.84"> </span>
<a href="#l38.85"></a><span id="l38.85">   /**</span>
<a href="#l38.86"></a><span id="l38.86">    * Set the heading for the summary.</span>
<a href="#l38.87"></a><span id="l38.87">    *</span>
<a href="#l38.88"></a><span id="l38.88">    * @param title    The title for the heading.</span>
<a href="#l38.89"></a><span id="l38.89">    * @param subtitle A smaller subtitle for the heading.</span>
<a href="#l38.90"></a><span id="l38.90">    */</span>
<a href="#l38.91"></a><span id="l38.91" class="difflineminus">-  setHeading: function(title, subtitle) {</span>
<a href="#l38.92"></a><span id="l38.92" class="difflineplus">+  setHeading(title, subtitle) {</span>
<a href="#l38.93"></a><span id="l38.93">     let titleNode = document.getElementById(&quot;summary_title&quot;);</span>
<a href="#l38.94"></a><span id="l38.94">     let subtitleNode = document.getElementById(&quot;summary_subtitle&quot;);</span>
<a href="#l38.95"></a><span id="l38.95">     titleNode.textContent = title || &quot;&quot;;</span>
<a href="#l38.96"></a><span id="l38.96">     subtitleNode.textContent = subtitle || &quot;&quot;;</span>
<a href="#l38.97"></a><span id="l38.97"> </span>
<a href="#l38.98"></a><span id="l38.98">     this._adjustHeadingSize();</span>
<a href="#l38.99"></a><span id="l38.99">   },</span>
<a href="#l38.100"></a><span id="l38.100"> </span>
<a href="#l38.101"></a><span id="l38.101" class="difflineat">@@ -186,28 +186,27 @@ MultiMessageSummary.prototype = {</span>
<a href="#l38.102"></a><span id="l38.102">    * @param aMsgOrThread An nsIMsgDBHdr or an array thereof</span>
<a href="#l38.103"></a><span id="l38.103">    * @param [aOptions]   An optional object to customize the output:</span>
<a href="#l38.104"></a><span id="l38.104">    *                      showSubject: true if the subject of the message</span>
<a href="#l38.105"></a><span id="l38.105">    *                        should be shown; defaults to false</span>
<a href="#l38.106"></a><span id="l38.106">    *                      snippetLength: the length in bytes of the message</span>
<a href="#l38.107"></a><span id="l38.107">    *                        snippet; defaults to undefined (let Gloda decide)</span>
<a href="#l38.108"></a><span id="l38.108">    * @return A DOM node for the summary item.</span>
<a href="#l38.109"></a><span id="l38.109">    */</span>
<a href="#l38.110"></a><span id="l38.110" class="difflineminus">-  makeSummaryItem: function(aMsgOrThread, aOptions) {</span>
<a href="#l38.111"></a><span id="l38.111" class="difflineplus">+  makeSummaryItem(aMsgOrThread, aOptions) {</span>
<a href="#l38.112"></a><span id="l38.112">     let message, thread, numUnread, isStarred, tags;</span>
<a href="#l38.113"></a><span id="l38.113">     if (aMsgOrThread instanceof Ci.nsIMsgDBHdr) {</span>
<a href="#l38.114"></a><span id="l38.114">       thread = null;</span>
<a href="#l38.115"></a><span id="l38.115">       message = aMsgOrThread;</span>
<a href="#l38.116"></a><span id="l38.116"> </span>
<a href="#l38.117"></a><span id="l38.117">       numUnread = message.isRead ? 0 : 1;</span>
<a href="#l38.118"></a><span id="l38.118">       isStarred = message.isFlagged;</span>
<a href="#l38.119"></a><span id="l38.119"> </span>
<a href="#l38.120"></a><span id="l38.120">       tags = this._getTagsForMsg(message);</span>
<a href="#l38.121"></a><span id="l38.121" class="difflineminus">-    }</span>
<a href="#l38.122"></a><span id="l38.122" class="difflineminus">-    else {</span>
<a href="#l38.123"></a><span id="l38.123" class="difflineplus">+    } else {</span>
<a href="#l38.124"></a><span id="l38.124">       thread = aMsgOrThread;</span>
<a href="#l38.125"></a><span id="l38.125">       message = thread[0];</span>
<a href="#l38.126"></a><span id="l38.126"> </span>
<a href="#l38.127"></a><span id="l38.127">       numUnread = thread.reduce(function(x, hdr) {</span>
<a href="#l38.128"></a><span id="l38.128">         return x + (hdr.isRead ? 0 : 1);</span>
<a href="#l38.129"></a><span id="l38.129">       }, 0);</span>
<a href="#l38.130"></a><span id="l38.130">       isStarred = thread.some(function(hdr) { return hdr.isFlagged; });</span>
<a href="#l38.131"></a><span id="l38.131"> </span>
<a href="#l38.132"></a><span id="l38.132" class="difflineat">@@ -221,17 +220,17 @@ MultiMessageSummary.prototype = {</span>
<a href="#l38.133"></a><span id="l38.133">     let row = document.createElement(&quot;li&quot;);</span>
<a href="#l38.134"></a><span id="l38.134">     row.classList.toggle(&quot;thread&quot;, thread &amp;&amp; thread.length &gt; 1);</span>
<a href="#l38.135"></a><span id="l38.135">     row.classList.toggle(&quot;unread&quot;, numUnread &gt; 0);</span>
<a href="#l38.136"></a><span id="l38.136">     row.classList.toggle(&quot;starred&quot;, isStarred);</span>
<a href="#l38.137"></a><span id="l38.137">     row.innerHTML = '&lt;div class=&quot;star&quot;/&gt;' +</span>
<a href="#l38.138"></a><span id="l38.138">                     '&lt;div class=&quot;item_summary&quot;&gt;' +</span>
<a href="#l38.139"></a><span id="l38.139">                       '&lt;div class=&quot;item_header&quot;/&gt;' +</span>
<a href="#l38.140"></a><span id="l38.140">                       '&lt;div class=&quot;snippet&quot;/&gt;' +</span>
<a href="#l38.141"></a><span id="l38.141" class="difflineminus">-                    '&lt;/div&gt;';</span>
<a href="#l38.142"></a><span id="l38.142" class="difflineplus">+                    &quot;&lt;/div&gt;&quot;;</span>
<a href="#l38.143"></a><span id="l38.143"> </span>
<a href="#l38.144"></a><span id="l38.144">     let itemHeaderNode = row.querySelector(&quot;.item_header&quot;);</span>
<a href="#l38.145"></a><span id="l38.145"> </span>
<a href="#l38.146"></a><span id="l38.146">     let authorNode = document.createElement(&quot;span&quot;);</span>
<a href="#l38.147"></a><span id="l38.147">     authorNode.classList.add(&quot;author&quot;);</span>
<a href="#l38.148"></a><span id="l38.148">     authorNode.textContent = DisplayNameUtils.formatDisplayNameList(</span>
<a href="#l38.149"></a><span id="l38.149">       message.mime2DecodedAuthor, &quot;from&quot;</span>
<a href="#l38.150"></a><span id="l38.150">     );</span>
<a href="#l38.151"></a><span id="l38.151" class="difflineat">@@ -259,18 +258,17 @@ MultiMessageSummary.prototype = {</span>
<a href="#l38.152"></a><span id="l38.152">           &quot;numMessages&quot;, [thread.length.toLocaleString()], thread.length</span>
<a href="#l38.153"></a><span id="l38.153">         ) + numUnreadStr + &quot;)&quot;;</span>
<a href="#l38.154"></a><span id="l38.154"> </span>
<a href="#l38.155"></a><span id="l38.155">         let countNode = document.createElement(&quot;span&quot;);</span>
<a href="#l38.156"></a><span id="l38.156">         countNode.classList.add(&quot;count&quot;);</span>
<a href="#l38.157"></a><span id="l38.157">         countNode.textContent = countStr;</span>
<a href="#l38.158"></a><span id="l38.158">         itemHeaderNode.appendChild(countNode);</span>
<a href="#l38.159"></a><span id="l38.159">       }</span>
<a href="#l38.160"></a><span id="l38.160" class="difflineminus">-    }</span>
<a href="#l38.161"></a><span id="l38.161" class="difflineminus">-    else {</span>
<a href="#l38.162"></a><span id="l38.162" class="difflineplus">+    } else {</span>
<a href="#l38.163"></a><span id="l38.163">       let dateNode = document.createElement(&quot;span&quot;);</span>
<a href="#l38.164"></a><span id="l38.164">       dateNode.classList.add(&quot;date&quot;, &quot;right&quot;);</span>
<a href="#l38.165"></a><span id="l38.165">       dateNode.textContent = makeFriendlyDateAgo(new Date(message.date / 1000));</span>
<a href="#l38.166"></a><span id="l38.166">       itemHeaderNode.appendChild(dateNode);</span>
<a href="#l38.167"></a><span id="l38.167"> </span>
<a href="#l38.168"></a><span id="l38.168">       authorNode.classList.add(&quot;primary_header&quot;, &quot;link&quot;);</span>
<a href="#l38.169"></a><span id="l38.169">       authorNode.addEventListener(&quot;click&quot;, function() {</span>
<a href="#l38.170"></a><span id="l38.170">         window.top.gFolderDisplay.selectMessage(message);</span>
<a href="#l38.171"></a><span id="l38.171" class="difflineat">@@ -312,46 +310,46 @@ MultiMessageSummary.prototype = {</span>
<a href="#l38.172"></a><span id="l38.172">   },</span>
<a href="#l38.173"></a><span id="l38.173"> </span>
<a href="#l38.174"></a><span id="l38.174">   /**</span>
<a href="#l38.175"></a><span id="l38.175">    * Show an informative notice about the summarized messages (e.g. if we only</span>
<a href="#l38.176"></a><span id="l38.176">    * summarized some of them).</span>
<a href="#l38.177"></a><span id="l38.177">    *</span>
<a href="#l38.178"></a><span id="l38.178">    * @param aNoticeText The text to show in the notice.</span>
<a href="#l38.179"></a><span id="l38.179">    */</span>
<a href="#l38.180"></a><span id="l38.180" class="difflineminus">-  showNotice: function(aNoticeText) {</span>
<a href="#l38.181"></a><span id="l38.181" class="difflineplus">+  showNotice(aNoticeText) {</span>
<a href="#l38.182"></a><span id="l38.182">     let notice = document.getElementById(&quot;notice&quot;);</span>
<a href="#l38.183"></a><span id="l38.183">     notice.textContent = aNoticeText;</span>
<a href="#l38.184"></a><span id="l38.184">     notice.classList.remove(&quot;hidden&quot;);</span>
<a href="#l38.185"></a><span id="l38.185">   },</span>
<a href="#l38.186"></a><span id="l38.186"> </span>
<a href="#l38.187"></a><span id="l38.187">   /**</span>
<a href="#l38.188"></a><span id="l38.188">    * Given a msgHdr, return a list of tag objects. This function just does the</span>
<a href="#l38.189"></a><span id="l38.189">    * messy work of understanding how tags are stored in nsIMsgDBHdrs.  It would</span>
<a href="#l38.190"></a><span id="l38.190">    * be a good candidate for a utility library.</span>
<a href="#l38.191"></a><span id="l38.191">    *</span>
<a href="#l38.192"></a><span id="l38.192">    * @param aMsgHdr The msgHdr whose tags we want.</span>
<a href="#l38.193"></a><span id="l38.193">    * @return An array of nsIMsgTag objects.</span>
<a href="#l38.194"></a><span id="l38.194">    */</span>
<a href="#l38.195"></a><span id="l38.195" class="difflineminus">-  _getTagsForMsg: function(aMsgHdr) {</span>
<a href="#l38.196"></a><span id="l38.196" class="difflineplus">+  _getTagsForMsg(aMsgHdr) {</span>
<a href="#l38.197"></a><span id="l38.197">     let keywords = new Set(aMsgHdr.getStringProperty(&quot;keywords&quot;).split(&quot; &quot;));</span>
<a href="#l38.198"></a><span id="l38.198">     let allTags = MailServices.tags.getAllTags({});</span>
<a href="#l38.199"></a><span id="l38.199"> </span>
<a href="#l38.200"></a><span id="l38.200">     return allTags.filter(function(tag) {</span>
<a href="#l38.201"></a><span id="l38.201">       return keywords.has(tag.key);</span>
<a href="#l38.202"></a><span id="l38.202">     });</span>
<a href="#l38.203"></a><span id="l38.203">   },</span>
<a href="#l38.204"></a><span id="l38.204"> </span>
<a href="#l38.205"></a><span id="l38.205">   /**</span>
<a href="#l38.206"></a><span id="l38.206">    * Add a list of tags to a DOM node.</span>
<a href="#l38.207"></a><span id="l38.207">    *</span>
<a href="#l38.208"></a><span id="l38.208">    * @param aTags An array (or any iterable) of nsIMsgTag objects.</span>
<a href="#l38.209"></a><span id="l38.209">    * @param aTagsNode The DOM node to contain the list of tags.</span>
<a href="#l38.210"></a><span id="l38.210">    */</span>
<a href="#l38.211"></a><span id="l38.211" class="difflineminus">-  _addTagNodes: function(aTags, aTagsNode) {</span>
<a href="#l38.212"></a><span id="l38.212" class="difflineplus">+  _addTagNodes(aTags, aTagsNode) {</span>
<a href="#l38.213"></a><span id="l38.213">     // Make sure the tags are sorted in their natural order.</span>
<a href="#l38.214"></a><span id="l38.214">     let sortedTags = [...aTags];</span>
<a href="#l38.215"></a><span id="l38.215">     sortedTags.sort(function(a, b) {</span>
<a href="#l38.216"></a><span id="l38.216">       return a.key.localeCompare(b.key) ||</span>
<a href="#l38.217"></a><span id="l38.217">              a.ordinal.localeCompare(b.ordinal);</span>
<a href="#l38.218"></a><span id="l38.218">     });</span>
<a href="#l38.219"></a><span id="l38.219"> </span>
<a href="#l38.220"></a><span id="l38.220">     for (let tag of sortedTags) {</span>
<a href="#l38.221"></a><span id="l38.221" class="difflineat">@@ -368,57 +366,57 @@ MultiMessageSummary.prototype = {</span>
<a href="#l38.222"></a><span id="l38.222">   },</span>
<a href="#l38.223"></a><span id="l38.223"> </span>
<a href="#l38.224"></a><span id="l38.224">   /**</span>
<a href="#l38.225"></a><span id="l38.225">    * Compute the size of the messages in the selection and display it in the</span>
<a href="#l38.226"></a><span id="l38.226">    * element of id &quot;size&quot;.</span>
<a href="#l38.227"></a><span id="l38.227">    *</span>
<a href="#l38.228"></a><span id="l38.228">    * @param aMessages A LimitIterator of the messages to calculate the size of.</span>
<a href="#l38.229"></a><span id="l38.229">    */</span>
<a href="#l38.230"></a><span id="l38.230" class="difflineminus">-  _computeSize: function(aMessages) {</span>
<a href="#l38.231"></a><span id="l38.231" class="difflineplus">+  _computeSize(aMessages) {</span>
<a href="#l38.232"></a><span id="l38.232">     let numBytes = 0;</span>
<a href="#l38.233"></a><span id="l38.233">     for (let msgHdr of aMessages)</span>
<a href="#l38.234"></a><span id="l38.234">       numBytes += msgHdr.messageSize; // XXX do something about news?</span>
<a href="#l38.235"></a><span id="l38.235"> </span>
<a href="#l38.236"></a><span id="l38.236">     let format = aMessages.limited ? &quot;messagesTotalSizeMoreThan&quot; :</span>
<a href="#l38.237"></a><span id="l38.237">                                      &quot;messagesTotalSize&quot;;</span>
<a href="#l38.238"></a><span id="l38.238">     document.getElementById(&quot;size&quot;).textContent = formatString(</span>
<a href="#l38.239"></a><span id="l38.239">       format, [gMessenger.formatFileSize(numBytes)]</span>
<a href="#l38.240"></a><span id="l38.240">     );</span>
<a href="#l38.241"></a><span id="l38.241">   },</span>
<a href="#l38.242"></a><span id="l38.242"> </span>
<a href="#l38.243"></a><span id="l38.243">   /**</span>
<a href="#l38.244"></a><span id="l38.244">    * Adjust the position of the top of the main content so that it fits below</span>
<a href="#l38.245"></a><span id="l38.245">    * the heading.</span>
<a href="#l38.246"></a><span id="l38.246">    */</span>
<a href="#l38.247"></a><span id="l38.247" class="difflineminus">-  _adjustHeadingSize: function() {</span>
<a href="#l38.248"></a><span id="l38.248" class="difflineplus">+  _adjustHeadingSize() {</span>
<a href="#l38.249"></a><span id="l38.249">     let content = document.getElementById(&quot;content&quot;);</span>
<a href="#l38.250"></a><span id="l38.250">     let heading = document.getElementById(&quot;heading&quot;);</span>
<a href="#l38.251"></a><span id="l38.251">     let buttonbox = document.getElementById(&quot;header-view-toolbox&quot;);</span>
<a href="#l38.252"></a><span id="l38.252"> </span>
<a href="#l38.253"></a><span id="l38.253">     content.style.top = Math.max(</span>
<a href="#l38.254"></a><span id="l38.254">       buttonbox.getBoundingClientRect().height,</span>
<a href="#l38.255"></a><span id="l38.255">       heading.getBoundingClientRect().height</span>
<a href="#l38.256"></a><span id="l38.256">     ) + &quot;px&quot;;</span>
<a href="#l38.257"></a><span id="l38.257">   },</span>
<a href="#l38.258"></a><span id="l38.258"> </span>
<a href="#l38.259"></a><span id="l38.259">   // These are listeners for the gloda collections.</span>
<a href="#l38.260"></a><span id="l38.260" class="difflineminus">-  onItemsAdded: function(aItems) {},</span>
<a href="#l38.261"></a><span id="l38.261" class="difflineminus">-  onItemsModified: function(aItems) {</span>
<a href="#l38.262"></a><span id="l38.262" class="difflineplus">+  onItemsAdded(aItems) {},</span>
<a href="#l38.263"></a><span id="l38.263" class="difflineplus">+  onItemsModified(aItems) {</span>
<a href="#l38.264"></a><span id="l38.264">     this._processItems(aItems);</span>
<a href="#l38.265"></a><span id="l38.265">   },</span>
<a href="#l38.266"></a><span id="l38.266" class="difflineminus">-  onItemsRemoved: function(aItems) {},</span>
<a href="#l38.267"></a><span id="l38.267" class="difflineplus">+  onItemsRemoved(aItems) {},</span>
<a href="#l38.268"></a><span id="l38.268"> </span>
<a href="#l38.269"></a><span id="l38.269">   /**</span>
<a href="#l38.270"></a><span id="l38.270">    * Given a set of items from a gloda collection, process them and update</span>
<a href="#l38.271"></a><span id="l38.271">    * the display accordingly.</span>
<a href="#l38.272"></a><span id="l38.272">    *</span>
<a href="#l38.273"></a><span id="l38.273">    * @param aItems Contents of a gloda collection.</span>
<a href="#l38.274"></a><span id="l38.274">    */</span>
<a href="#l38.275"></a><span id="l38.275" class="difflineminus">-  _processItems: function(aItems) {</span>
<a href="#l38.276"></a><span id="l38.276" class="difflineplus">+  _processItems(aItems) {</span>
<a href="#l38.277"></a><span id="l38.277">     let knownMessageNodes = new Map();</span>
<a href="#l38.278"></a><span id="l38.278"> </span>
<a href="#l38.279"></a><span id="l38.279">     for (let glodaMsg of aItems) {</span>
<a href="#l38.280"></a><span id="l38.280">       // Unread and starred will get set if any of the messages in a collapsed</span>
<a href="#l38.281"></a><span id="l38.281">       // thread qualify.  The trick here is that we may get multiple items</span>
<a href="#l38.282"></a><span id="l38.282">       // corresponding to the same thread (and hence DOM node), so we need to</span>
<a href="#l38.283"></a><span id="l38.283">       // detect when we get the first item for a particular DOM node, stash the</span>
<a href="#l38.284"></a><span id="l38.284">       // preexisting status of that DOM node, an only do transitions if the</span>
<a href="#l38.285"></a><span id="l38.285" class="difflineat">@@ -452,22 +450,21 @@ MultiMessageSummary.prototype = {</span>
<a href="#l38.286"></a><span id="l38.286">       // out of sync.</span>
<a href="#l38.287"></a><span id="l38.287">       let tagsNode = headerNode.querySelector(&quot;.tags&quot;);</span>
<a href="#l38.288"></a><span id="l38.288">       while (tagsNode.hasChildNodes())</span>
<a href="#l38.289"></a><span id="l38.289">         tagsNode.lastChild.remove();</span>
<a href="#l38.290"></a><span id="l38.290">       this._addTagNodes(flags.tags, tagsNode);</span>
<a href="#l38.291"></a><span id="l38.291">     }</span>
<a href="#l38.292"></a><span id="l38.292">   },</span>
<a href="#l38.293"></a><span id="l38.293"> </span>
<a href="#l38.294"></a><span id="l38.294" class="difflineminus">-  onQueryCompleted: function(aCollection) {</span>
<a href="#l38.295"></a><span id="l38.295" class="difflineplus">+  onQueryCompleted(aCollection) {</span>
<a href="#l38.296"></a><span id="l38.296">     // If we need something that's just available from GlodaMessages, this is</span>
<a href="#l38.297"></a><span id="l38.297">     // where we'll get it initially.</span>
<a href="#l38.298"></a><span id="l38.298">     if (this._listener)</span>
<a href="#l38.299"></a><span id="l38.299">       this._listener.onLoadCompleted();</span>
<a href="#l38.300"></a><span id="l38.300" class="difflineminus">-    return;</span>
<a href="#l38.301"></a><span id="l38.301">   },</span>
<a href="#l38.302"></a><span id="l38.302"> };</span>
<a href="#l38.303"></a><span id="l38.303"> </span>
<a href="#l38.304"></a><span id="l38.304"> /**</span>
<a href="#l38.305"></a><span id="l38.305">  * A summarizer to use for a single thread.</span>
<a href="#l38.306"></a><span id="l38.306">  */</span>
<a href="#l38.307"></a><span id="l38.307"> function ThreadSummarizer() {}</span>
<a href="#l38.308"></a><span id="l38.308"> </span>
<a href="#l38.309"></a><span id="l38.309" class="difflineat">@@ -490,27 +487,27 @@ ThreadSummarizer.prototype = {</span>
<a href="#l38.310"></a><span id="l38.310">   },</span>
<a href="#l38.311"></a><span id="l38.311"> </span>
<a href="#l38.312"></a><span id="l38.312">   /**</span>
<a href="#l38.313"></a><span id="l38.313">    * A function to be called once the summarizer has been registered with the</span>
<a href="#l38.314"></a><span id="l38.314">    * main summary object.</span>
<a href="#l38.315"></a><span id="l38.315">    *</span>
<a href="#l38.316"></a><span id="l38.316">    * @param aContext The MultiMessageSummary object holding this summarizer.</span>
<a href="#l38.317"></a><span id="l38.317">    */</span>
<a href="#l38.318"></a><span id="l38.318" class="difflineminus">-  onregistered: function(aContext) {</span>
<a href="#l38.319"></a><span id="l38.319" class="difflineplus">+  onregistered(aContext) {</span>
<a href="#l38.320"></a><span id="l38.320">     this.context = aContext;</span>
<a href="#l38.321"></a><span id="l38.321">   },</span>
<a href="#l38.322"></a><span id="l38.322"> </span>
<a href="#l38.323"></a><span id="l38.323">   /**</span>
<a href="#l38.324"></a><span id="l38.324">    * Summarize a list of messages.</span>
<a href="#l38.325"></a><span id="l38.325">    *</span>
<a href="#l38.326"></a><span id="l38.326">    * @param aMessages A LimitIterator of the messages to summarize.</span>
<a href="#l38.327"></a><span id="l38.327">    * @return An array of the messages actually summarized.</span>
<a href="#l38.328"></a><span id="l38.328">    */</span>
<a href="#l38.329"></a><span id="l38.329" class="difflineminus">-  summarize: function(aMessages) {</span>
<a href="#l38.330"></a><span id="l38.330" class="difflineplus">+  summarize(aMessages) {</span>
<a href="#l38.331"></a><span id="l38.331">     let messageList = document.getElementById(&quot;message_list&quot;);</span>
<a href="#l38.332"></a><span id="l38.332"> </span>
<a href="#l38.333"></a><span id="l38.333">     // Remove all ignored messages from summarization.</span>
<a href="#l38.334"></a><span id="l38.334">     let summarizedMessages = [];</span>
<a href="#l38.335"></a><span id="l38.335">     for (let message of aMessages) {</span>
<a href="#l38.336"></a><span id="l38.336">       if (!message.isKilled) {</span>
<a href="#l38.337"></a><span id="l38.337">         summarizedMessages.push(message);</span>
<a href="#l38.338"></a><span id="l38.338">       }</span>
<a href="#l38.339"></a><span id="l38.339" class="difflineat">@@ -591,26 +588,26 @@ MultipleSelectionSummarizer.prototype = </span>
<a href="#l38.340"></a><span id="l38.340">   },</span>
<a href="#l38.341"></a><span id="l38.341"> </span>
<a href="#l38.342"></a><span id="l38.342">   /**</span>
<a href="#l38.343"></a><span id="l38.343">    * A function to be called once the summarizer has been registered with the</span>
<a href="#l38.344"></a><span id="l38.344">    * main summary object.</span>
<a href="#l38.345"></a><span id="l38.345">    *</span>
<a href="#l38.346"></a><span id="l38.346">    * @param aContext The MultiMessageSummary object holding this summarizer.</span>
<a href="#l38.347"></a><span id="l38.347">    */</span>
<a href="#l38.348"></a><span id="l38.348" class="difflineminus">-  onregistered: function(aContext) {</span>
<a href="#l38.349"></a><span id="l38.349" class="difflineplus">+  onregistered(aContext) {</span>
<a href="#l38.350"></a><span id="l38.350">     this.context = aContext;</span>
<a href="#l38.351"></a><span id="l38.351">   },</span>
<a href="#l38.352"></a><span id="l38.352"> </span>
<a href="#l38.353"></a><span id="l38.353">   /**</span>
<a href="#l38.354"></a><span id="l38.354">    * Summarize a list of messages.</span>
<a href="#l38.355"></a><span id="l38.355">    *</span>
<a href="#l38.356"></a><span id="l38.356">    * @param aMessages The messages to summarize.</span>
<a href="#l38.357"></a><span id="l38.357">    */</span>
<a href="#l38.358"></a><span id="l38.358" class="difflineminus">-  summarize: function(aMessages) {</span>
<a href="#l38.359"></a><span id="l38.359" class="difflineplus">+  summarize(aMessages) {</span>
<a href="#l38.360"></a><span id="l38.360">     let messageList = document.getElementById(&quot;message_list&quot;);</span>
<a href="#l38.361"></a><span id="l38.361"> </span>
<a href="#l38.362"></a><span id="l38.362">     let threads = this._buildThreads(aMessages);</span>
<a href="#l38.363"></a><span id="l38.363"> </span>
<a href="#l38.364"></a><span id="l38.364">     // Set the heading based on the number of messages &amp; threads.</span>
<a href="#l38.365"></a><span id="l38.365">     let format = aMessages.limited ? &quot;atLeastNumConversations&quot; :</span>
<a href="#l38.366"></a><span id="l38.366">                                      &quot;numConversations&quot;;</span>
<a href="#l38.367"></a><span id="l38.367">     this.context.setHeading(formatString(</span>
<a href="#l38.368"></a><span id="l38.368" class="difflineat">@@ -659,17 +656,17 @@ MultipleSelectionSummarizer.prototype = </span>
<a href="#l38.369"></a><span id="l38.369">   },</span>
<a href="#l38.370"></a><span id="l38.370"> </span>
<a href="#l38.371"></a><span id="l38.371">   /**</span>
<a href="#l38.372"></a><span id="l38.372">    * Group all the messages to be summarized into threads.</span>
<a href="#l38.373"></a><span id="l38.373">    *</span>
<a href="#l38.374"></a><span id="l38.374">    * @param aMessages The messages to group.</span>
<a href="#l38.375"></a><span id="l38.375">    * @return An array of arrays of messages, grouped by thread.</span>
<a href="#l38.376"></a><span id="l38.376">    */</span>
<a href="#l38.377"></a><span id="l38.377" class="difflineminus">-  _buildThreads: function(aMessages) {</span>
<a href="#l38.378"></a><span id="l38.378" class="difflineplus">+  _buildThreads(aMessages) {</span>
<a href="#l38.379"></a><span id="l38.379">     // First, we group the messages in threads and count the threads.</span>
<a href="#l38.380"></a><span id="l38.380">     let threads = [];</span>
<a href="#l38.381"></a><span id="l38.381">     let threadMap = {};</span>
<a href="#l38.382"></a><span id="l38.382">     for (let msgHdr of aMessages) {</span>
<a href="#l38.383"></a><span id="l38.383">       let viewThreadId = window.top.gFolderDisplay.view.dbView</span>
<a href="#l38.384"></a><span id="l38.384">                                    .getThreadContainingMsgHdr(msgHdr)</span>
<a href="#l38.385"></a><span id="l38.385">                                    .threadKey;</span>
<a href="#l38.386"></a><span id="l38.386">       if (!(viewThreadId in threadMap)) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/mail/base/content/newTagDialog.js</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/mail/base/content/newTagDialog.js</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -8,18 +8,17 @@ ChromeUtils.import(&quot;resource:///modules/</span>
<a href="#l39.4"></a><span id="l39.4"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l39.5"></a><span id="l39.5"> </span>
<a href="#l39.6"></a><span id="l39.6"> var dialog;</span>
<a href="#l39.7"></a><span id="l39.7"> </span>
<a href="#l39.8"></a><span id="l39.8"> /**</span>
<a href="#l39.9"></a><span id="l39.9">  * Pass in keyToEdit as a window argument to turn this dialog into an edit</span>
<a href="#l39.10"></a><span id="l39.10">  * tag dialog.</span>
<a href="#l39.11"></a><span id="l39.11">  */</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-function onLoad()</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineminus">-{</span>
<a href="#l39.14"></a><span id="l39.14" class="difflineplus">+function onLoad() {</span>
<a href="#l39.15"></a><span id="l39.15">   let windowArgs = window.arguments[0];</span>
<a href="#l39.16"></a><span id="l39.16"> </span>
<a href="#l39.17"></a><span id="l39.17">   dialog = {};</span>
<a href="#l39.18"></a><span id="l39.18"> </span>
<a href="#l39.19"></a><span id="l39.19">   dialog.OKButton = document.documentElement.getButton(&quot;accept&quot;);</span>
<a href="#l39.20"></a><span id="l39.20">   dialog.nameField = document.getElementById(&quot;name&quot;);</span>
<a href="#l39.21"></a><span id="l39.21">   dialog.nameField.focus();</span>
<a href="#l39.22"></a><span id="l39.22"> </span>
<a href="#l39.23"></a><span id="l39.23" class="difflineat">@@ -29,18 +28,17 @@ function onLoad()</span>
<a href="#l39.24"></a><span id="l39.24">     initializeForEditing(windowArgs.keyToEdit);</span>
<a href="#l39.25"></a><span id="l39.25"> </span>
<a href="#l39.26"></a><span id="l39.26">   doEnabling();</span>
<a href="#l39.27"></a><span id="l39.27"> }</span>
<a href="#l39.28"></a><span id="l39.28"> </span>
<a href="#l39.29"></a><span id="l39.29"> /**</span>
<a href="#l39.30"></a><span id="l39.30">  * Turn the new tag dialog into an edit existing tag dialog</span>
<a href="#l39.31"></a><span id="l39.31">  */</span>
<a href="#l39.32"></a><span id="l39.32" class="difflineminus">-function initializeForEditing(aTagKey)</span>
<a href="#l39.33"></a><span id="l39.33" class="difflineminus">-{</span>
<a href="#l39.34"></a><span id="l39.34" class="difflineplus">+function initializeForEditing(aTagKey) {</span>
<a href="#l39.35"></a><span id="l39.35">   dialog.editTagKey = aTagKey;</span>
<a href="#l39.36"></a><span id="l39.36"> </span>
<a href="#l39.37"></a><span id="l39.37">   // Change the title of the dialog</span>
<a href="#l39.38"></a><span id="l39.38">   var messengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l39.39"></a><span id="l39.39">   document.title = messengerBundle.getString(&quot;editTagTitle&quot;);</span>
<a href="#l39.40"></a><span id="l39.40"> </span>
<a href="#l39.41"></a><span id="l39.41">   // override the OK button</span>
<a href="#l39.42"></a><span id="l39.42">   document.documentElement.setAttribute(&quot;ondialogaccept&quot;, &quot;return onOKEditTag();&quot;);</span>
<a href="#l39.43"></a><span id="l39.43" class="difflineat">@@ -48,61 +46,54 @@ function initializeForEditing(aTagKey)</span>
<a href="#l39.44"></a><span id="l39.44">   // extract the color and name for the current tag</span>
<a href="#l39.45"></a><span id="l39.45">   document.getElementById(&quot;tagColorPicker&quot;).value = MailServices.tags.getColorForKey(aTagKey);</span>
<a href="#l39.46"></a><span id="l39.46">   dialog.nameField.value = MailServices.tags.getTagForKey(aTagKey);</span>
<a href="#l39.47"></a><span id="l39.47"> }</span>
<a href="#l39.48"></a><span id="l39.48"> </span>
<a href="#l39.49"></a><span id="l39.49"> /**</span>
<a href="#l39.50"></a><span id="l39.50">  * on OK handler for editing a new tag.</span>
<a href="#l39.51"></a><span id="l39.51">  */</span>
<a href="#l39.52"></a><span id="l39.52" class="difflineminus">-function onOKEditTag()</span>
<a href="#l39.53"></a><span id="l39.53" class="difflineminus">-{</span>
<a href="#l39.54"></a><span id="l39.54" class="difflineplus">+function onOKEditTag() {</span>
<a href="#l39.55"></a><span id="l39.55">   // get the tag name of the current key we are editing</span>
<a href="#l39.56"></a><span id="l39.56">   let existingTagName = MailServices.tags.getTagForKey(dialog.editTagKey);</span>
<a href="#l39.57"></a><span id="l39.57"> </span>
<a href="#l39.58"></a><span id="l39.58">   // it's ok if the name didn't change</span>
<a href="#l39.59"></a><span id="l39.59" class="difflineminus">-  if (existingTagName != dialog.nameField.value)</span>
<a href="#l39.60"></a><span id="l39.60" class="difflineminus">-  {</span>
<a href="#l39.61"></a><span id="l39.61" class="difflineplus">+  if (existingTagName != dialog.nameField.value) {</span>
<a href="#l39.62"></a><span id="l39.62">     // don't let the user edit a tag to the name of another existing tag</span>
<a href="#l39.63"></a><span id="l39.63" class="difflineminus">-    if (MailServices.tags.getKeyForTag(dialog.nameField.value))</span>
<a href="#l39.64"></a><span id="l39.64" class="difflineminus">-    {</span>
<a href="#l39.65"></a><span id="l39.65" class="difflineplus">+    if (MailServices.tags.getKeyForTag(dialog.nameField.value)) {</span>
<a href="#l39.66"></a><span id="l39.66">       alertForExistingTag();</span>
<a href="#l39.67"></a><span id="l39.67">       return false; // abort the OK</span>
<a href="#l39.68"></a><span id="l39.68">     }</span>
<a href="#l39.69"></a><span id="l39.69"> </span>
<a href="#l39.70"></a><span id="l39.70">     MailServices.tags.setTagForKey(dialog.editTagKey, dialog.nameField.value);</span>
<a href="#l39.71"></a><span id="l39.71">   }</span>
<a href="#l39.72"></a><span id="l39.72"> </span>
<a href="#l39.73"></a><span id="l39.73">   MailServices.tags.setColorForKey(dialog.editTagKey, document.getElementById(&quot;tagColorPicker&quot;).value);</span>
<a href="#l39.74"></a><span id="l39.74">   return dialog.okCallback();</span>
<a href="#l39.75"></a><span id="l39.75"> }</span>
<a href="#l39.76"></a><span id="l39.76"> </span>
<a href="#l39.77"></a><span id="l39.77"> /**</span>
<a href="#l39.78"></a><span id="l39.78">  * on OK handler for creating a new tag. Alerts the user if a tag with</span>
<a href="#l39.79"></a><span id="l39.79">  * the name already exists.</span>
<a href="#l39.80"></a><span id="l39.80">  */</span>
<a href="#l39.81"></a><span id="l39.81" class="difflineminus">-function onOKNewTag()</span>
<a href="#l39.82"></a><span id="l39.82" class="difflineminus">-{</span>
<a href="#l39.83"></a><span id="l39.83" class="difflineplus">+function onOKNewTag() {</span>
<a href="#l39.84"></a><span id="l39.84">   var name = dialog.nameField.value;</span>
<a href="#l39.85"></a><span id="l39.85"> </span>
<a href="#l39.86"></a><span id="l39.86" class="difflineminus">-  if (MailServices.tags.getKeyForTag(name))</span>
<a href="#l39.87"></a><span id="l39.87" class="difflineminus">-  {</span>
<a href="#l39.88"></a><span id="l39.88" class="difflineplus">+  if (MailServices.tags.getKeyForTag(name)) {</span>
<a href="#l39.89"></a><span id="l39.89">     alertForExistingTag();</span>
<a href="#l39.90"></a><span id="l39.90">     return false;</span>
<a href="#l39.91"></a><span id="l39.91">   }</span>
<a href="#l39.92"></a><span id="l39.92">   return dialog.okCallback(name, document.getElementById(&quot;tagColorPicker&quot;).value);</span>
<a href="#l39.93"></a><span id="l39.93"> }</span>
<a href="#l39.94"></a><span id="l39.94"> </span>
<a href="#l39.95"></a><span id="l39.95"> /**</span>
<a href="#l39.96"></a><span id="l39.96">  * Alerts the user that they are trying to create a tag with a name that</span>
<a href="#l39.97"></a><span id="l39.97">  * already exists.</span>
<a href="#l39.98"></a><span id="l39.98">  */</span>
<a href="#l39.99"></a><span id="l39.99" class="difflineminus">-function alertForExistingTag()</span>
<a href="#l39.100"></a><span id="l39.100" class="difflineminus">-{</span>
<a href="#l39.101"></a><span id="l39.101" class="difflineplus">+function alertForExistingTag() {</span>
<a href="#l39.102"></a><span id="l39.102">   var messengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l39.103"></a><span id="l39.103">   var alertText = messengerBundle.getString(&quot;tagExists&quot;);</span>
<a href="#l39.104"></a><span id="l39.104">   Services.prompt.alert(window, document.title, alertText);</span>
<a href="#l39.105"></a><span id="l39.105"> }</span>
<a href="#l39.106"></a><span id="l39.106"> </span>
<a href="#l39.107"></a><span id="l39.107" class="difflineminus">-function doEnabling()</span>
<a href="#l39.108"></a><span id="l39.108" class="difflineminus">-{</span>
<a href="#l39.109"></a><span id="l39.109" class="difflineplus">+function doEnabling() {</span>
<a href="#l39.110"></a><span id="l39.110">   dialog.OKButton.disabled = !dialog.nameField.value;</span>
<a href="#l39.111"></a><span id="l39.111"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/mail/base/content/nsContextMenu.js</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/mail/base/content/nsContextMenu.js</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -55,17 +55,17 @@ function nsContextMenu(aXulMenu, aIsShif</span>
<a href="#l40.4"></a><span id="l40.4"> }</span>
<a href="#l40.5"></a><span id="l40.5"> </span>
<a href="#l40.6"></a><span id="l40.6"> nsContextMenu.prototype = {</span>
<a href="#l40.7"></a><span id="l40.7">   /**</span>
<a href="#l40.8"></a><span id="l40.8">    * Init: set properties based on the clicked-on element and the state of</span>
<a href="#l40.9"></a><span id="l40.9">    * the world, then determine which context menu items to show based on</span>
<a href="#l40.10"></a><span id="l40.10">    * those properties.</span>
<a href="#l40.11"></a><span id="l40.11">    */</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineminus">-  initMenu : function CM_initMenu(aPopup, aIsShift) {</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineplus">+  initMenu(aPopup, aIsShift) {</span>
<a href="#l40.14"></a><span id="l40.14">     this.menu = aPopup;</span>
<a href="#l40.15"></a><span id="l40.15"> </span>
<a href="#l40.16"></a><span id="l40.16">     // Get contextual info.</span>
<a href="#l40.17"></a><span id="l40.17">     this.setTarget(document.popupNode);</span>
<a href="#l40.18"></a><span id="l40.18">     this.setMessageTargets(document.popupNode);</span>
<a href="#l40.19"></a><span id="l40.19"> </span>
<a href="#l40.20"></a><span id="l40.20">     if (!this.inThreadPane &amp;&amp; this.messagepaneIsBlank) {</span>
<a href="#l40.21"></a><span id="l40.21">       this.shouldDisplay = false;</span>
<a href="#l40.22"></a><span id="l40.22" class="difflineat">@@ -87,33 +87,33 @@ nsContextMenu.prototype = {</span>
<a href="#l40.23"></a><span id="l40.23">     let contextPopup = document.getElementById(&quot;mailContext&quot;);</span>
<a href="#l40.24"></a><span id="l40.24">     for (let item of contextPopup.children) {</span>
<a href="#l40.25"></a><span id="l40.25">       if (!item.hidden)</span>
<a href="#l40.26"></a><span id="l40.26">         return;</span>
<a href="#l40.27"></a><span id="l40.27">     }</span>
<a href="#l40.28"></a><span id="l40.28">     // All items must have been hidden.</span>
<a href="#l40.29"></a><span id="l40.29">     this.shouldDisplay = false;</span>
<a href="#l40.30"></a><span id="l40.30">   },</span>
<a href="#l40.31"></a><span id="l40.31" class="difflineminus">-  initItems : function CM_initItems() {</span>
<a href="#l40.32"></a><span id="l40.32" class="difflineplus">+  initItems() {</span>
<a href="#l40.33"></a><span id="l40.33">     this.initPageMenuSeparator();</span>
<a href="#l40.34"></a><span id="l40.34">     this.initSaveItems();</span>
<a href="#l40.35"></a><span id="l40.35">     this.initClipboardItems();</span>
<a href="#l40.36"></a><span id="l40.36">     this.initMediaPlayerItems();</span>
<a href="#l40.37"></a><span id="l40.37">     this.initBrowserItems();</span>
<a href="#l40.38"></a><span id="l40.38">     this.initMessageItems();</span>
<a href="#l40.39"></a><span id="l40.39">     this.initSpellingItems();</span>
<a href="#l40.40"></a><span id="l40.40">     this.initSeparators();</span>
<a href="#l40.41"></a><span id="l40.41">   },</span>
<a href="#l40.42"></a><span id="l40.42" class="difflineminus">-  addDictionaries: function CM_addDictionaries() {</span>
<a href="#l40.43"></a><span id="l40.43" class="difflineplus">+  addDictionaries() {</span>
<a href="#l40.44"></a><span id="l40.44">     openDictionaryList();</span>
<a href="#l40.45"></a><span id="l40.45">   },</span>
<a href="#l40.46"></a><span id="l40.46" class="difflineminus">-  initPageMenuSeparator: function CM_initPageMenuSeparator() {</span>
<a href="#l40.47"></a><span id="l40.47" class="difflineplus">+  initPageMenuSeparator() {</span>
<a href="#l40.48"></a><span id="l40.48">     this.showItem(&quot;page-menu-separator&quot;, this.hasPageMenu);</span>
<a href="#l40.49"></a><span id="l40.49">   },</span>
<a href="#l40.50"></a><span id="l40.50" class="difflineminus">-  initSpellingItems: function CM_initSpellingItems() {</span>
<a href="#l40.51"></a><span id="l40.51" class="difflineplus">+  initSpellingItems() {</span>
<a href="#l40.52"></a><span id="l40.52">     let canSpell = gSpellChecker.canSpellCheck;</span>
<a href="#l40.53"></a><span id="l40.53">     let onMisspelling = gSpellChecker.overMisspelling;</span>
<a href="#l40.54"></a><span id="l40.54">     this.showItem(&quot;mailContext-spell-check-enabled&quot;, canSpell);</span>
<a href="#l40.55"></a><span id="l40.55">     this.showItem(&quot;mailContext-spell-separator&quot;, canSpell || this.onEditableArea);</span>
<a href="#l40.56"></a><span id="l40.56">     if (canSpell) {</span>
<a href="#l40.57"></a><span id="l40.57">       document.getElementById(&quot;mailContext-spell-check-enabled&quot;)</span>
<a href="#l40.58"></a><span id="l40.58">               .setAttribute(&quot;checked&quot;, gSpellChecker.enabled);</span>
<a href="#l40.59"></a><span id="l40.59">     }</span>
<a href="#l40.60"></a><span id="l40.60" class="difflineat">@@ -144,21 +144,21 @@ nsContextMenu.prototype = {</span>
<a href="#l40.61"></a><span id="l40.61">       // when there is no spellchecker but we might be able to spellcheck</span>
<a href="#l40.62"></a><span id="l40.62">       // add the add to dictionaries item. This will ensure that people</span>
<a href="#l40.63"></a><span id="l40.63">       // with no dictionaries will be able to download them</span>
<a href="#l40.64"></a><span id="l40.64">       this.showItem(&quot;mailContext-spell-add-dictionaries-main&quot;, true);</span>
<a href="#l40.65"></a><span id="l40.65">     } else {</span>
<a href="#l40.66"></a><span id="l40.66">       this.showItem(&quot;mailContext-spell-add-dictionaries-main&quot;, false);</span>
<a href="#l40.67"></a><span id="l40.67">     }</span>
<a href="#l40.68"></a><span id="l40.68">   },</span>
<a href="#l40.69"></a><span id="l40.69" class="difflineminus">-  initSaveItems : function CM_initSaveItems() {</span>
<a href="#l40.70"></a><span id="l40.70" class="difflineplus">+  initSaveItems() {</span>
<a href="#l40.71"></a><span id="l40.71">     this.showItem(&quot;mailContext-savelink&quot;, this.onSaveableLink);</span>
<a href="#l40.72"></a><span id="l40.72">     this.showItem(&quot;mailContext-saveimage&quot;, this.onLoadedImage);</span>
<a href="#l40.73"></a><span id="l40.73">   },</span>
<a href="#l40.74"></a><span id="l40.74" class="difflineminus">-  initClipboardItems : function CM_initClipboardItems() {</span>
<a href="#l40.75"></a><span id="l40.75" class="difflineplus">+  initClipboardItems() {</span>
<a href="#l40.76"></a><span id="l40.76">     // Copy depends on whether there is selected text.</span>
<a href="#l40.77"></a><span id="l40.77">     // Enabling this context menu item is now done through the global</span>
<a href="#l40.78"></a><span id="l40.78">     // command updating system.</span>
<a href="#l40.79"></a><span id="l40.79"> </span>
<a href="#l40.80"></a><span id="l40.80">     goUpdateGlobalEditMenuItems();</span>
<a href="#l40.81"></a><span id="l40.81"> </span>
<a href="#l40.82"></a><span id="l40.82">     this.showItem(&quot;mailContext-cut&quot;, !this.inMessageArea &amp;&amp; this.onTextInput);</span>
<a href="#l40.83"></a><span id="l40.83">     this.showItem(&quot;mailContext-copy&quot;,</span>
<a href="#l40.84"></a><span id="l40.84" class="difflineat">@@ -191,75 +191,74 @@ nsContextMenu.prototype = {</span>
<a href="#l40.85"></a><span id="l40.85">       if (selection.length &gt; 15) {</span>
<a href="#l40.86"></a><span id="l40.86">         key += &quot;.truncated&quot;;</span>
<a href="#l40.87"></a><span id="l40.87">         abbrSelection = selection.slice(0, 15);</span>
<a href="#l40.88"></a><span id="l40.88">       } else {</span>
<a href="#l40.89"></a><span id="l40.89">         abbrSelection = selection;</span>
<a href="#l40.90"></a><span id="l40.90">       }</span>
<a href="#l40.91"></a><span id="l40.91"> </span>
<a href="#l40.92"></a><span id="l40.92">       searchTheWeb.label = bundle.getFormattedString(key, [</span>
<a href="#l40.93"></a><span id="l40.93" class="difflineminus">-        Services.search.currentEngine.name, abbrSelection</span>
<a href="#l40.94"></a><span id="l40.94" class="difflineplus">+        Services.search.currentEngine.name, abbrSelection,</span>
<a href="#l40.95"></a><span id="l40.95">       ]);</span>
<a href="#l40.96"></a><span id="l40.96">       searchTheWeb.value = selection;</span>
<a href="#l40.97"></a><span id="l40.97">     }</span>
<a href="#l40.98"></a><span id="l40.98">   },</span>
<a href="#l40.99"></a><span id="l40.99" class="difflineminus">-  initMediaPlayerItems: function CM_initMediaPlayerItems() {</span>
<a href="#l40.100"></a><span id="l40.100" class="difflineplus">+  initMediaPlayerItems() {</span>
<a href="#l40.101"></a><span id="l40.101">     let onMedia = this.onVideo || this.onAudio;</span>
<a href="#l40.102"></a><span id="l40.102">     // Several mutually exclusive items.... play/pause, mute/unmute, show/hide</span>
<a href="#l40.103"></a><span id="l40.103">     this.showItem(&quot;mailContext-media-play&quot;, onMedia &amp;&amp; this.target.paused);</span>
<a href="#l40.104"></a><span id="l40.104">     this.showItem(&quot;mailContext-media-pause&quot;, onMedia &amp;&amp; !this.target.paused);</span>
<a href="#l40.105"></a><span id="l40.105">     this.showItem(&quot;mailContext-media-mute&quot;, onMedia &amp;&amp; !this.target.muted);</span>
<a href="#l40.106"></a><span id="l40.106">     this.showItem(&quot;mailContext-media-unmute&quot;, onMedia &amp;&amp; this.target.muted);</span>
<a href="#l40.107"></a><span id="l40.107">     if (onMedia) {</span>
<a href="#l40.108"></a><span id="l40.108">       let hasError = this.target.error != null ||</span>
<a href="#l40.109"></a><span id="l40.109">                      this.target.networkState == this.target.NETWORK_NO_SOURCE;</span>
<a href="#l40.110"></a><span id="l40.110">       this.setItemAttr(&quot;mailContext-media-play&quot;, &quot;disabled&quot;, hasError);</span>
<a href="#l40.111"></a><span id="l40.111">       this.setItemAttr(&quot;mailContext-media-pause&quot;, &quot;disabled&quot;, hasError);</span>
<a href="#l40.112"></a><span id="l40.112">       this.setItemAttr(&quot;mailContext-media-mute&quot;, &quot;disabled&quot;, hasError);</span>
<a href="#l40.113"></a><span id="l40.113">       this.setItemAttr(&quot;mailContext-media-unmute&quot;, &quot;disabled&quot;, hasError);</span>
<a href="#l40.114"></a><span id="l40.114">     }</span>
<a href="#l40.115"></a><span id="l40.115">   },</span>
<a href="#l40.116"></a><span id="l40.116" class="difflineminus">-  initBrowserItems: function CM_initBrowserItems() {</span>
<a href="#l40.117"></a><span id="l40.117" class="difflineplus">+  initBrowserItems() {</span>
<a href="#l40.118"></a><span id="l40.118">     // Work out if we are a context menu on a special item e.g. an image, link</span>
<a href="#l40.119"></a><span id="l40.119">     // etc.</span>
<a href="#l40.120"></a><span id="l40.120">     let notOnSpecialItem = !(this.inMessageArea || this.isContentSelected ||</span>
<a href="#l40.121"></a><span id="l40.121">                              this.onCanvas || this.onLink || this.onImage ||</span>
<a href="#l40.122"></a><span id="l40.122">                              this.onPlayableMedia || this.onTextInput);</span>
<a href="#l40.123"></a><span id="l40.123">     // Ensure these commands are updated with their current status.</span>
<a href="#l40.124"></a><span id="l40.124">     if (notOnSpecialItem) {</span>
<a href="#l40.125"></a><span id="l40.125">       goUpdateCommand(&quot;cmd_stop&quot;);</span>
<a href="#l40.126"></a><span id="l40.126">       goUpdateCommand(&quot;cmd_reload&quot;);</span>
<a href="#l40.127"></a><span id="l40.127">     }</span>
<a href="#l40.128"></a><span id="l40.128"> </span>
<a href="#l40.129"></a><span id="l40.129">     // These only needs showing if we're not on something special.</span>
<a href="#l40.130"></a><span id="l40.130">     this.showItem(&quot;mailContext-stop&quot;, notOnSpecialItem);</span>
<a href="#l40.131"></a><span id="l40.131">     this.showItem(&quot;mailContext-reload&quot;, notOnSpecialItem);</span>
<a href="#l40.132"></a><span id="l40.132"> </span>
<a href="#l40.133"></a><span id="l40.133">     let loadedProtocol = &quot;&quot;;</span>
<a href="#l40.134"></a><span id="l40.134" class="difflineminus">-    if (this.target &amp;&amp;</span>
<a href="#l40.135"></a><span id="l40.135" class="difflineminus">-        this.target.ownerDocument.defaultView.top.location)</span>
<a href="#l40.136"></a><span id="l40.136" class="difflineminus">-      loadedProtocol = this.target.ownerDocument.defaultView.top</span>
<a href="#l40.137"></a><span id="l40.137" class="difflineminus">-                           .location.protocol;</span>
<a href="#l40.138"></a><span id="l40.138" class="difflineplus">+    if (this.target &amp;&amp; this.target.ownerGlobal.top.location)</span>
<a href="#l40.139"></a><span id="l40.139" class="difflineplus">+      loadedProtocol = this.target.ownerGlobal.top.location.protocol;</span>
<a href="#l40.140"></a><span id="l40.140"> </span>
<a href="#l40.141"></a><span id="l40.141">     // Only show open in browser if we're not on a special item and we're not</span>
<a href="#l40.142"></a><span id="l40.142">     // on an about: or chrome: protocol - for these protocols the browser is</span>
<a href="#l40.143"></a><span id="l40.143">     // unlikely to show the same thing as we do (if at all), so therefore don't</span>
<a href="#l40.144"></a><span id="l40.144">     // offer the option.</span>
<a href="#l40.145"></a><span id="l40.145">     this.showItem(&quot;mailContext-openInBrowser&quot;,</span>
<a href="#l40.146"></a><span id="l40.146">                   notOnSpecialItem &amp;&amp;</span>
<a href="#l40.147"></a><span id="l40.147">                   loadedProtocol &amp;&amp;</span>
<a href="#l40.148"></a><span id="l40.148">                   loadedProtocol != &quot;about:&quot; &amp;&amp; loadedProtocol != &quot;chrome:&quot;);</span>
<a href="#l40.149"></a><span id="l40.149"> </span>
<a href="#l40.150"></a><span id="l40.150">     // Only show mailContext-openLinkInBrowser if we're on a link and it isn't</span>
<a href="#l40.151"></a><span id="l40.151">     // a mailto link.</span>
<a href="#l40.152"></a><span id="l40.152">     this.showItem(&quot;mailContext-openLinkInBrowser&quot;,</span>
<a href="#l40.153"></a><span id="l40.153">                   this.onLink &amp;&amp; !this.onMailtoLink &amp;&amp;</span>
<a href="#l40.154"></a><span id="l40.154">                   this.linkProtocol != &quot;about&quot; &amp;&amp; this.linkProtocol != &quot;chrome&quot;);</span>
<a href="#l40.155"></a><span id="l40.155">   },</span>
<a href="#l40.156"></a><span id="l40.156" class="difflineminus">-  initMessageItems: function CM_initMessageItems() {</span>
<a href="#l40.157"></a><span id="l40.157" class="difflineplus">+  /* eslint-disable complexity */</span>
<a href="#l40.158"></a><span id="l40.158" class="difflineplus">+  initMessageItems() {</span>
<a href="#l40.159"></a><span id="l40.159">     // If we're not in a message related tab, we're just going to bulk hide most</span>
<a href="#l40.160"></a><span id="l40.160">     // items as this simplifies the logic below.</span>
<a href="#l40.161"></a><span id="l40.161">     if (!this.inMessageArea) {</span>
<a href="#l40.162"></a><span id="l40.162">       const messageTabSpecificItems = [</span>
<a href="#l40.163"></a><span id="l40.163">         &quot;mailContext-openNewWindow&quot;, &quot;threadPaneContext-openNewTab&quot;,</span>
<a href="#l40.164"></a><span id="l40.164">         &quot;mailContext-openConversation&quot;, &quot;mailContext-openContainingFolder&quot;,</span>
<a href="#l40.165"></a><span id="l40.165">         &quot;mailContext-archive&quot;, &quot;mailContext-replySender&quot;,</span>
<a href="#l40.166"></a><span id="l40.166">         &quot;mailContext-replyNewsgroup&quot;, &quot;mailContext-replyAll&quot;,</span>
<a href="#l40.167"></a><span id="l40.167" class="difflineat">@@ -268,17 +267,17 @@ nsContextMenu.prototype = {</span>
<a href="#l40.168"></a><span id="l40.168">         &quot;mailContext-editAsNew&quot;, &quot;mailContext-editDraftMsg&quot;,</span>
<a href="#l40.169"></a><span id="l40.169">         &quot;mailContext-newMsgFromTemplate&quot;, &quot;mailContext-editTemplateMsg&quot;,</span>
<a href="#l40.170"></a><span id="l40.170">         &quot;mailContext-copyMessageUrl&quot;, &quot;mailContext-moveMenu&quot;,</span>
<a href="#l40.171"></a><span id="l40.171">         &quot;mailContext-copyMenu&quot;, &quot;mailContext-moveToFolderAgain&quot;,</span>
<a href="#l40.172"></a><span id="l40.172">         &quot;mailContext-ignoreThread&quot;, &quot;mailContext-ignoreSubthread&quot;,</span>
<a href="#l40.173"></a><span id="l40.173">         &quot;mailContext-watchThread&quot;,</span>
<a href="#l40.174"></a><span id="l40.174">         &quot;mailContext-tags&quot;, &quot;mailContext-mark&quot;, &quot;mailContext-saveAs&quot;,</span>
<a href="#l40.175"></a><span id="l40.175">         &quot;mailContext-printpreview&quot;, &quot;mailContext-print&quot;, &quot;mailContext-delete&quot;,</span>
<a href="#l40.176"></a><span id="l40.176" class="difflineminus">-        &quot;downloadSelected&quot;, &quot;mailContext-reportPhishingURL&quot;</span>
<a href="#l40.177"></a><span id="l40.177" class="difflineplus">+        &quot;downloadSelected&quot;, &quot;mailContext-reportPhishingURL&quot;,</span>
<a href="#l40.178"></a><span id="l40.178">       ];</span>
<a href="#l40.179"></a><span id="l40.179">       for (let i = 0; i &lt; messageTabSpecificItems.length; ++i)</span>
<a href="#l40.180"></a><span id="l40.180">         this.showItem(messageTabSpecificItems[i], false);</span>
<a href="#l40.181"></a><span id="l40.181">       return;</span>
<a href="#l40.182"></a><span id="l40.182">     }</span>
<a href="#l40.183"></a><span id="l40.183"> </span>
<a href="#l40.184"></a><span id="l40.184">     let canMove = gFolderDisplay.canDeleteSelectedMessages;</span>
<a href="#l40.185"></a><span id="l40.185"> </span>
<a href="#l40.186"></a><span id="l40.186" class="difflineat">@@ -383,25 +382,26 @@ nsContextMenu.prototype = {</span>
<a href="#l40.187"></a><span id="l40.187"> </span>
<a href="#l40.188"></a><span id="l40.188">     this.showItem(&quot;mailContext-delete&quot;,</span>
<a href="#l40.189"></a><span id="l40.189">                   msgModifyItems &amp;&amp; (this.isNewsgroup || canMove));</span>
<a href="#l40.190"></a><span id="l40.190"> </span>
<a href="#l40.191"></a><span id="l40.191">     // This function is needed for the case where a folder is just loaded (while</span>
<a href="#l40.192"></a><span id="l40.192">     // there isn't a message loaded in the message pane), a right-click is done</span>
<a href="#l40.193"></a><span id="l40.193">     // in the thread pane. This function will disable enable the 'Delete</span>
<a href="#l40.194"></a><span id="l40.194">     // Message' menu item.</span>
<a href="#l40.195"></a><span id="l40.195" class="difflineminus">-    goUpdateCommand('cmd_delete');</span>
<a href="#l40.196"></a><span id="l40.196" class="difflineplus">+    goUpdateCommand(&quot;cmd_delete&quot;);</span>
<a href="#l40.197"></a><span id="l40.197"> </span>
<a href="#l40.198"></a><span id="l40.198" class="difflineminus">-    this.showItem('downloadSelected',</span>
<a href="#l40.199"></a><span id="l40.199" class="difflineplus">+    this.showItem(&quot;downloadSelected&quot;,</span>
<a href="#l40.200"></a><span id="l40.200">                   this.numSelectedMessages &gt; 1 &amp;&amp; !this.hideMailItems);</span>
<a href="#l40.201"></a><span id="l40.201"> </span>
<a href="#l40.202"></a><span id="l40.202">     this.showItem(&quot;mailContext-reportPhishingURL&quot;,</span>
<a href="#l40.203"></a><span id="l40.203">                   !this.inThreadPane &amp;&amp; this.onLink &amp;&amp; !this.onMailtoLink);</span>
<a href="#l40.204"></a><span id="l40.204">   },</span>
<a href="#l40.205"></a><span id="l40.205" class="difflineminus">-  initSeparators: function CM_initSeparators() {</span>
<a href="#l40.206"></a><span id="l40.206" class="difflineplus">+  /* eslint-enable complexity */</span>
<a href="#l40.207"></a><span id="l40.207" class="difflineplus">+  initSeparators() {</span>
<a href="#l40.208"></a><span id="l40.208">     const mailContextSeparators = [</span>
<a href="#l40.209"></a><span id="l40.209">       &quot;mailContext-sep-open-browser&quot;, &quot;mailContext-sep-link&quot;,</span>
<a href="#l40.210"></a><span id="l40.210">       &quot;mailContext-sep-open&quot;, &quot;mailContext-sep-open2&quot;,</span>
<a href="#l40.211"></a><span id="l40.211">       &quot;mailContext-sep-reply&quot;, &quot;paneContext-afterMove&quot;,</span>
<a href="#l40.212"></a><span id="l40.212">       &quot;mailContext-sep-afterTagAddNew&quot;, &quot;mailContext-sep-afterTagRemoveAll&quot;,</span>
<a href="#l40.213"></a><span id="l40.213">       &quot;mailContext-sep-afterMarkAllRead&quot;, &quot;mailContext-sep-afterMarkFlagged&quot;,</span>
<a href="#l40.214"></a><span id="l40.214">       &quot;mailContext-sep-afterMarkMenu&quot;, &quot;mailContext-afterWatchThread&quot;,</span>
<a href="#l40.215"></a><span id="l40.215">       &quot;mailContext-sep-edit&quot;, &quot;mailContext-sep-editTemplate&quot;,</span>
<a href="#l40.216"></a><span id="l40.216" class="difflineat">@@ -413,17 +413,18 @@ nsContextMenu.prototype = {</span>
<a href="#l40.217"></a><span id="l40.217"> </span>
<a href="#l40.218"></a><span id="l40.218">     this.checkLastSeparator(this.menu);</span>
<a href="#l40.219"></a><span id="l40.219">   },</span>
<a href="#l40.220"></a><span id="l40.220"> </span>
<a href="#l40.221"></a><span id="l40.221">   /**</span>
<a href="#l40.222"></a><span id="l40.222">    * Set the nsContextMenu properties based on the selected node and</span>
<a href="#l40.223"></a><span id="l40.223">    * its ancestors.</span>
<a href="#l40.224"></a><span id="l40.224">    */</span>
<a href="#l40.225"></a><span id="l40.225" class="difflineminus">-  setTarget : function CM_setTarget(aNode) {</span>
<a href="#l40.226"></a><span id="l40.226" class="difflineplus">+  /* eslint-disable complexity */</span>
<a href="#l40.227"></a><span id="l40.227" class="difflineplus">+  setTarget(aNode) {</span>
<a href="#l40.228"></a><span id="l40.228">     // Clear any old spellchecking items from the menu, this used to</span>
<a href="#l40.229"></a><span id="l40.229">     // be in the menu hiding code but wasn't getting called in all</span>
<a href="#l40.230"></a><span id="l40.230">     // situations. Here, we can ensure it gets cleaned up any time the</span>
<a href="#l40.231"></a><span id="l40.231">     // menu is shown. Note: must be before uninit because that clears the</span>
<a href="#l40.232"></a><span id="l40.232">     // internal vars</span>
<a href="#l40.233"></a><span id="l40.233">     // We also need to do that before we possibly bail because we just clicked</span>
<a href="#l40.234"></a><span id="l40.234">     // on some XUL node. Otherwise, dictionary choices just accumulate until we</span>
<a href="#l40.235"></a><span id="l40.235">     // right-click on some HTML element again.</span>
<a href="#l40.236"></a><span id="l40.236" class="difflineat">@@ -490,17 +491,17 @@ nsContextMenu.prototype = {</span>
<a href="#l40.237"></a><span id="l40.237">         this.onTextInput = this.isTargetATextBox(this.target);</span>
<a href="#l40.238"></a><span id="l40.238">       } else if (editFlags &amp; (SpellCheckHelper.INPUT | SpellCheckHelper.TEXTAREA)) {</span>
<a href="#l40.239"></a><span id="l40.239">         if (!this.target.readOnly) {</span>
<a href="#l40.240"></a><span id="l40.240">           this.onEditableArea = true;</span>
<a href="#l40.241"></a><span id="l40.241">           gSpellChecker.init(this.target.editor);</span>
<a href="#l40.242"></a><span id="l40.242">           gSpellChecker.initFromEvent(document.popupRangeParent, document.popupRangeOffset);</span>
<a href="#l40.243"></a><span id="l40.243">         }</span>
<a href="#l40.244"></a><span id="l40.244">       } else if (editFlags &amp; (SpellCheckHelper.CONTENTEDITABLE)) {</span>
<a href="#l40.245"></a><span id="l40.245" class="difflineminus">-        let targetWin = this.target.ownerDocument.defaultView;</span>
<a href="#l40.246"></a><span id="l40.246" class="difflineplus">+        let targetWin = this.target.ownerGlobal;</span>
<a href="#l40.247"></a><span id="l40.247">         let editingSession = targetWin.QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l40.248"></a><span id="l40.248">                                       .getInterface(Ci.nsIWebNavigation)</span>
<a href="#l40.249"></a><span id="l40.249">                                       .QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l40.250"></a><span id="l40.250">                                       .getInterface(Ci.nsIEditingSession);</span>
<a href="#l40.251"></a><span id="l40.251">         gSpellChecker.init(editingSession.getEditorForWindow(targetWin));</span>
<a href="#l40.252"></a><span id="l40.252">         gSpellChecker.initFromEvent(document.popupRangeParent, document.popupRangeOffset);</span>
<a href="#l40.253"></a><span id="l40.253">       } else if (this.target instanceof HTMLCanvasElement) {</span>
<a href="#l40.254"></a><span id="l40.254">         this.onCanvas = true;</span>
<a href="#l40.255"></a><span id="l40.255" class="difflineat">@@ -566,27 +567,27 @@ nsContextMenu.prototype = {</span>
<a href="#l40.256"></a><span id="l40.256"> </span>
<a href="#l40.257"></a><span id="l40.257">     // See if the user clicked on MathML.</span>
<a href="#l40.258"></a><span id="l40.258">     const NS_MathML = &quot;http://www.w3.org/1998/Math/MathML&quot;;</span>
<a href="#l40.259"></a><span id="l40.259">     if ((this.target.nodeType == Node.TEXT_NODE &amp;&amp;</span>
<a href="#l40.260"></a><span id="l40.260">          this.target.parentNode.namespaceURI == NS_MathML) ||</span>
<a href="#l40.261"></a><span id="l40.261">         (this.target.namespaceURI == NS_MathML))</span>
<a href="#l40.262"></a><span id="l40.262">       this.onMathML = true;</span>
<a href="#l40.263"></a><span id="l40.263">   },</span>
<a href="#l40.264"></a><span id="l40.264" class="difflineplus">+  /* eslint-enable complexity */</span>
<a href="#l40.265"></a><span id="l40.265"> </span>
<a href="#l40.266"></a><span id="l40.266" class="difflineminus">-  setMessageTargets: function CM_setMessageTargets(aNode) {</span>
<a href="#l40.267"></a><span id="l40.267" class="difflineplus">+  setMessageTargets(aNode) {</span>
<a href="#l40.268"></a><span id="l40.268">     let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l40.269"></a><span id="l40.269">     if (tabmail) {</span>
<a href="#l40.270"></a><span id="l40.270">       // Not all tabs are message tabs - if we're in a tab mode that is in</span>
<a href="#l40.271"></a><span id="l40.271">       // mailTabType's list of modes, then we'll assume it is a message related</span>
<a href="#l40.272"></a><span id="l40.272">       // tab.</span>
<a href="#l40.273"></a><span id="l40.273">       this.inMessageArea = tabmail.selectedTab.mode.name in mailTabType.modes;</span>
<a href="#l40.274"></a><span id="l40.274">       this.inStandaloneWindow = false;</span>
<a href="#l40.275"></a><span id="l40.275" class="difflineminus">-    }</span>
<a href="#l40.276"></a><span id="l40.276" class="difflineminus">-    else {</span>
<a href="#l40.277"></a><span id="l40.277" class="difflineplus">+    } else {</span>
<a href="#l40.278"></a><span id="l40.278">       // Assume that if we haven't got a tabmail item, then we're in standalone</span>
<a href="#l40.279"></a><span id="l40.279">       // window</span>
<a href="#l40.280"></a><span id="l40.280">       this.inMessageArea = true;</span>
<a href="#l40.281"></a><span id="l40.281">       this.inStandaloneWindow = true;</span>
<a href="#l40.282"></a><span id="l40.282">     }</span>
<a href="#l40.283"></a><span id="l40.283"> </span>
<a href="#l40.284"></a><span id="l40.284">     if (!this.inMessageArea) {</span>
<a href="#l40.285"></a><span id="l40.285">       this.inThreadPane = false;</span>
<a href="#l40.286"></a><span id="l40.286" class="difflineat">@@ -610,40 +611,38 @@ nsContextMenu.prototype = {</span>
<a href="#l40.287"></a><span id="l40.287">   /**</span>
<a href="#l40.288"></a><span id="l40.288">    * Get a computed style property for an element.</span>
<a href="#l40.289"></a><span id="l40.289">    * @param  aElem</span>
<a href="#l40.290"></a><span id="l40.290">    *         A DOM node</span>
<a href="#l40.291"></a><span id="l40.291">    * @param  aProp</span>
<a href="#l40.292"></a><span id="l40.292">    *         The desired CSS property</span>
<a href="#l40.293"></a><span id="l40.293">    * @return the value of the property</span>
<a href="#l40.294"></a><span id="l40.294">    */</span>
<a href="#l40.295"></a><span id="l40.295" class="difflineminus">-  getComputedStyle: function CM_getComputedStyle(aElem, aProp) {</span>
<a href="#l40.296"></a><span id="l40.296" class="difflineminus">-    return aElem.ownerDocument.defaultView.getComputedStyle(aElem, &quot;&quot;)</span>
<a href="#l40.297"></a><span id="l40.297" class="difflineminus">-                .getPropertyValue(aProp);</span>
<a href="#l40.298"></a><span id="l40.298" class="difflineplus">+  getComputedStyle(aElem, aProp) {</span>
<a href="#l40.299"></a><span id="l40.299" class="difflineplus">+    return aElem.ownerGlobal.getComputedStyle(aElem).getPropertyValue(aProp);</span>
<a href="#l40.300"></a><span id="l40.300">   },</span>
<a href="#l40.301"></a><span id="l40.301"> </span>
<a href="#l40.302"></a><span id="l40.302">   /**</span>
<a href="#l40.303"></a><span id="l40.303">    * Generate a URL string from a computed style property, for things like</span>
<a href="#l40.304"></a><span id="l40.304">    * |style=&quot;background-image:url(...)&quot;|</span>
<a href="#l40.305"></a><span id="l40.305">    * @return a &quot;url&quot;-type computed style attribute value, with the &quot;url(&quot; and</span>
<a href="#l40.306"></a><span id="l40.306">    *         &quot;)&quot; stripped.</span>
<a href="#l40.307"></a><span id="l40.307">    */</span>
<a href="#l40.308"></a><span id="l40.308" class="difflineminus">-  getComputedURL: function CM_getComputedURL(aElem, aProp) {</span>
<a href="#l40.309"></a><span id="l40.309" class="difflineminus">-    var url = aElem.ownerDocument.defaultView.getComputedStyle(aElem, &quot;&quot;)</span>
<a href="#l40.310"></a><span id="l40.310" class="difflineminus">-                   .getPropertyCSSValue(aProp);</span>
<a href="#l40.311"></a><span id="l40.311" class="difflineplus">+  getComputedURL(aElem, aProp) {</span>
<a href="#l40.312"></a><span id="l40.312" class="difflineplus">+    var url = aElem.ownerGlobal.getComputedStyle(aElem).getPropertyCSSValue(aProp);</span>
<a href="#l40.313"></a><span id="l40.313">     return (url.primitiveType == CSSPrimitiveValue.CSS_URI) ? url.getStringValue() : null;</span>
<a href="#l40.314"></a><span id="l40.314">   },</span>
<a href="#l40.315"></a><span id="l40.315"> </span>
<a href="#l40.316"></a><span id="l40.316">   /**</span>
<a href="#l40.317"></a><span id="l40.317">    * Determine whether the clicked-on link can be saved, and whether it</span>
<a href="#l40.318"></a><span id="l40.318">    * may be saved according to the ScriptSecurityManager.</span>
<a href="#l40.319"></a><span id="l40.319">    * @return true if the protocol can be persisted and if the target has</span>
<a href="#l40.320"></a><span id="l40.320">    *         permission to link to the URL, false if not</span>
<a href="#l40.321"></a><span id="l40.321">    */</span>
<a href="#l40.322"></a><span id="l40.322" class="difflineminus">-  isLinkSaveable : function CM_isLinkSaveable() {</span>
<a href="#l40.323"></a><span id="l40.323" class="difflineplus">+  isLinkSaveable() {</span>
<a href="#l40.324"></a><span id="l40.324">     try {</span>
<a href="#l40.325"></a><span id="l40.325">       const nsIScriptSecurityManager =</span>
<a href="#l40.326"></a><span id="l40.326">         Ci.nsIScriptSecurityManager;</span>
<a href="#l40.327"></a><span id="l40.327">       Services.scriptSecurityManager.checkLoadURIWithPrincipal(this.target.nodePrincipal,</span>
<a href="#l40.328"></a><span id="l40.328">           this.linkURI, nsIScriptSecurityManager.STANDARD);</span>
<a href="#l40.329"></a><span id="l40.329">     } catch (e) {</span>
<a href="#l40.330"></a><span id="l40.330">       // Don't save things we can't link to.</span>
<a href="#l40.331"></a><span id="l40.331">       return false;</span>
<a href="#l40.332"></a><span id="l40.332" class="difflineat">@@ -656,32 +655,32 @@ nsContextMenu.prototype = {</span>
<a href="#l40.333"></a><span id="l40.333">              this.linkProtocol == &quot;javascript&quot; ||</span>
<a href="#l40.334"></a><span id="l40.334">              this.linkProtocol == &quot;news&quot; ||</span>
<a href="#l40.335"></a><span id="l40.335">              this.linkProtocol == &quot;snews&quot;);</span>
<a href="#l40.336"></a><span id="l40.336">   },</span>
<a href="#l40.337"></a><span id="l40.337"> </span>
<a href="#l40.338"></a><span id="l40.338">   /**</span>
<a href="#l40.339"></a><span id="l40.339">    * Save URL of clicked-on link.</span>
<a href="#l40.340"></a><span id="l40.340">    */</span>
<a href="#l40.341"></a><span id="l40.341" class="difflineminus">-  saveLink : function CM_saveLink() {</span>
<a href="#l40.342"></a><span id="l40.342" class="difflineplus">+  saveLink() {</span>
<a href="#l40.343"></a><span id="l40.343">     saveURL(this.linkURL, this.linkText(), null, true, null, null, document);</span>
<a href="#l40.344"></a><span id="l40.344">   },</span>
<a href="#l40.345"></a><span id="l40.345"> </span>
<a href="#l40.346"></a><span id="l40.346">   /**</span>
<a href="#l40.347"></a><span id="l40.347">    * Save a clicked-on image.</span>
<a href="#l40.348"></a><span id="l40.348">    */</span>
<a href="#l40.349"></a><span id="l40.349" class="difflineminus">-  saveImage : function CM_saveImage() {</span>
<a href="#l40.350"></a><span id="l40.350" class="difflineplus">+  saveImage() {</span>
<a href="#l40.351"></a><span id="l40.351">     saveURL(this.imageURL, null, &quot;SaveImageTitle&quot;, false, null, null, document);</span>
<a href="#l40.352"></a><span id="l40.352">   },</span>
<a href="#l40.353"></a><span id="l40.353"> </span>
<a href="#l40.354"></a><span id="l40.354">   /**</span>
<a href="#l40.355"></a><span id="l40.355">    * Extract email addresses from a mailto: link and put them on the</span>
<a href="#l40.356"></a><span id="l40.356">    * clipboard.</span>
<a href="#l40.357"></a><span id="l40.357">    */</span>
<a href="#l40.358"></a><span id="l40.358" class="difflineminus">-  copyEmail : function CM_copyEmail() {</span>
<a href="#l40.359"></a><span id="l40.359" class="difflineplus">+  copyEmail() {</span>
<a href="#l40.360"></a><span id="l40.360">     // Copy the comma-separated list of email addresses only.</span>
<a href="#l40.361"></a><span id="l40.361">     // There are other ways of embedding email addresses in a mailto:</span>
<a href="#l40.362"></a><span id="l40.362">     // link, but such complex parsing is beyond us.</span>
<a href="#l40.363"></a><span id="l40.363"> </span>
<a href="#l40.364"></a><span id="l40.364">     const kMailToLength = 7; // length of &quot;mailto:&quot;</span>
<a href="#l40.365"></a><span id="l40.365"> </span>
<a href="#l40.366"></a><span id="l40.366">     var url = this.linkURL;</span>
<a href="#l40.367"></a><span id="l40.367">     var qmark = url.indexOf(&quot;?&quot;);</span>
<a href="#l40.368"></a><span id="l40.368" class="difflineat">@@ -691,69 +690,65 @@ nsContextMenu.prototype = {</span>
<a href="#l40.369"></a><span id="l40.369">       addresses = url.substring(kMailToLength, qmark);</span>
<a href="#l40.370"></a><span id="l40.370">     } else {</span>
<a href="#l40.371"></a><span id="l40.371">       addresses = url.substr(kMailToLength);</span>
<a href="#l40.372"></a><span id="l40.372">     }</span>
<a href="#l40.373"></a><span id="l40.373"> </span>
<a href="#l40.374"></a><span id="l40.374">     // Let's try to unescape it using a character set.</span>
<a href="#l40.375"></a><span id="l40.375">     try {</span>
<a href="#l40.376"></a><span id="l40.376">       var characterSet = this.target.ownerDocument.characterSet;</span>
<a href="#l40.377"></a><span id="l40.377" class="difflineminus">-      const textToSubURI = Cc[&quot;@mozilla.org/intl/texttosuburi;1&quot;]</span>
<a href="#l40.378"></a><span id="l40.378" class="difflineminus">-                             .getService(Ci.nsITextToSubURI);</span>
<a href="#l40.379"></a><span id="l40.379" class="difflineminus">-      addresses = textToSubURI.unEscapeURIForUI(characterSet, addresses);</span>
<a href="#l40.380"></a><span id="l40.380" class="difflineminus">-    }</span>
<a href="#l40.381"></a><span id="l40.381" class="difflineminus">-    catch(ex) {</span>
<a href="#l40.382"></a><span id="l40.382" class="difflineplus">+      addresses = Services.textToSubURI.unEscapeURIForUI(characterSet, addresses);</span>
<a href="#l40.383"></a><span id="l40.383" class="difflineplus">+    } catch (ex) {</span>
<a href="#l40.384"></a><span id="l40.384">       // Do nothing.</span>
<a href="#l40.385"></a><span id="l40.385">     }</span>
<a href="#l40.386"></a><span id="l40.386"> </span>
<a href="#l40.387"></a><span id="l40.387">     var clipboard = Cc[&quot;@mozilla.org/widget/clipboardhelper;1&quot;]</span>
<a href="#l40.388"></a><span id="l40.388">                       .getService(Ci.nsIClipboardHelper);</span>
<a href="#l40.389"></a><span id="l40.389">     clipboard.copyString(addresses);</span>
<a href="#l40.390"></a><span id="l40.390">   },</span>
<a href="#l40.391"></a><span id="l40.391"> </span>
<a href="#l40.392"></a><span id="l40.392" class="difflineminus">-  ///////////////</span>
<a href="#l40.393"></a><span id="l40.393" class="difflineminus">-  // Utilities //</span>
<a href="#l40.394"></a><span id="l40.394" class="difflineminus">-  ///////////////</span>
<a href="#l40.395"></a><span id="l40.395" class="difflineplus">+  // ---------</span>
<a href="#l40.396"></a><span id="l40.396" class="difflineplus">+  // Utilities</span>
<a href="#l40.397"></a><span id="l40.397"> </span>
<a href="#l40.398"></a><span id="l40.398">   /**</span>
<a href="#l40.399"></a><span id="l40.399">    * Set a DOM node's hidden property by passing in the node's id or the</span>
<a href="#l40.400"></a><span id="l40.400">    * element itself.</span>
<a href="#l40.401"></a><span id="l40.401">    * @param aItemOrId</span>
<a href="#l40.402"></a><span id="l40.402">    *        a DOM node or the id of a DOM node</span>
<a href="#l40.403"></a><span id="l40.403">    * @param aShow</span>
<a href="#l40.404"></a><span id="l40.404">    *        true to show, false to hide</span>
<a href="#l40.405"></a><span id="l40.405">    */</span>
<a href="#l40.406"></a><span id="l40.406" class="difflineminus">-  showItem : function CM_showItem(aItemOrId, aShow) {</span>
<a href="#l40.407"></a><span id="l40.407" class="difflineplus">+  showItem(aItemOrId, aShow) {</span>
<a href="#l40.408"></a><span id="l40.408">     var item = aItemOrId.constructor == String ? document.getElementById(aItemOrId) : aItemOrId;</span>
<a href="#l40.409"></a><span id="l40.409">     item.hidden = !aShow;</span>
<a href="#l40.410"></a><span id="l40.410">   },</span>
<a href="#l40.411"></a><span id="l40.411"> </span>
<a href="#l40.412"></a><span id="l40.412">   /**</span>
<a href="#l40.413"></a><span id="l40.413">    * Set a DOM node's disabled property by passing in the node's id or the</span>
<a href="#l40.414"></a><span id="l40.414">    * element itself.</span>
<a href="#l40.415"></a><span id="l40.415">    *</span>
<a href="#l40.416"></a><span id="l40.416">    * @param aItemOrId  A DOM node or the id of a DOM node</span>
<a href="#l40.417"></a><span id="l40.417">    * @param aEnabled   True to enable the element, false to disable.</span>
<a href="#l40.418"></a><span id="l40.418">    */</span>
<a href="#l40.419"></a><span id="l40.419" class="difflineminus">-  enableItem: function CM_enableItem(aItemOrId, aEnabled) {</span>
<a href="#l40.420"></a><span id="l40.420" class="difflineplus">+  enableItem(aItemOrId, aEnabled) {</span>
<a href="#l40.421"></a><span id="l40.421">     var item = aItemOrId.constructor == String ? document.getElementById(aItemOrId) : aItemOrId;</span>
<a href="#l40.422"></a><span id="l40.422">     item.disabled = !aEnabled;</span>
<a href="#l40.423"></a><span id="l40.423">   },</span>
<a href="#l40.424"></a><span id="l40.424"> </span>
<a href="#l40.425"></a><span id="l40.425">   /**</span>
<a href="#l40.426"></a><span id="l40.426">    * Most menu items are visible if there's 1 or 0 messages selected, and</span>
<a href="#l40.427"></a><span id="l40.427">    * enabled if there's exactly one selected. Handle those here.</span>
<a href="#l40.428"></a><span id="l40.428">    * Exception: playable media is selected, in which case, don't show them.</span>
<a href="#l40.429"></a><span id="l40.429">    *</span>
<a href="#l40.430"></a><span id="l40.430">    * @param aID   the id of the element to display/enable</span>
<a href="#l40.431"></a><span id="l40.431">    * @param aShow (optional)  an additional criteria to evaluate when we</span>
<a href="#l40.432"></a><span id="l40.432">    *              decide whether to display the element. If false, we'll hide</span>
<a href="#l40.433"></a><span id="l40.433">    *              the item no matter what messages are selected.</span>
<a href="#l40.434"></a><span id="l40.434">    */</span>
<a href="#l40.435"></a><span id="l40.435" class="difflineminus">-  setSingleSelection: function CM_setSingleSelection(aID, aShow) {</span>
<a href="#l40.436"></a><span id="l40.436" class="difflineplus">+  setSingleSelection(aID, aShow) {</span>
<a href="#l40.437"></a><span id="l40.437">     let show = (aShow != undefined) ? aShow : true;</span>
<a href="#l40.438"></a><span id="l40.438">     this.showItem(aID, this.numSelectedMessages == 1 &amp;&amp; !this.hideMailItems &amp;&amp;</span>
<a href="#l40.439"></a><span id="l40.439">                   show &amp;&amp; !this.onPlayableMedia);</span>
<a href="#l40.440"></a><span id="l40.440">     this.enableItem(aID, this.numSelectedMessages == 1);</span>
<a href="#l40.441"></a><span id="l40.441">   },</span>
<a href="#l40.442"></a><span id="l40.442"> </span>
<a href="#l40.443"></a><span id="l40.443">   /**</span>
<a href="#l40.444"></a><span id="l40.444">    * Set given attribute of specified context-menu item. If the</span>
<a href="#l40.445"></a><span id="l40.445" class="difflineat">@@ -761,17 +756,17 @@ nsContextMenu.prototype = {</span>
<a href="#l40.446"></a><span id="l40.446">    * nicely for the disabled attribute).</span>
<a href="#l40.447"></a><span id="l40.447">    * @param  aId</span>
<a href="#l40.448"></a><span id="l40.448">    *         The id of an element</span>
<a href="#l40.449"></a><span id="l40.449">    * @param  aAttr</span>
<a href="#l40.450"></a><span id="l40.450">    *         The attribute name</span>
<a href="#l40.451"></a><span id="l40.451">    * @param  aVal</span>
<a href="#l40.452"></a><span id="l40.452">    *         The value to set the attribute to, or null to remove the attribute</span>
<a href="#l40.453"></a><span id="l40.453">    */</span>
<a href="#l40.454"></a><span id="l40.454" class="difflineminus">-  setItemAttr : function CM_setItemAttr(aId, aAttr, aVal) {</span>
<a href="#l40.455"></a><span id="l40.455" class="difflineplus">+  setItemAttr(aId, aAttr, aVal) {</span>
<a href="#l40.456"></a><span id="l40.456">     var elem = document.getElementById(aId);</span>
<a href="#l40.457"></a><span id="l40.457">     if (elem) {</span>
<a href="#l40.458"></a><span id="l40.458">       if (aVal == null) {</span>
<a href="#l40.459"></a><span id="l40.459">         // null indicates attr should be removed.</span>
<a href="#l40.460"></a><span id="l40.460">         elem.removeAttribute(aAttr);</span>
<a href="#l40.461"></a><span id="l40.461">       } else {</span>
<a href="#l40.462"></a><span id="l40.462">         // Set attr=val.</span>
<a href="#l40.463"></a><span id="l40.463">         elem.setAttribute(aAttr, aVal);</span>
<a href="#l40.464"></a><span id="l40.464" class="difflineat">@@ -779,59 +774,59 @@ nsContextMenu.prototype = {</span>
<a href="#l40.465"></a><span id="l40.465">     }</span>
<a href="#l40.466"></a><span id="l40.466">   },</span>
<a href="#l40.467"></a><span id="l40.467"> </span>
<a href="#l40.468"></a><span id="l40.468">   /**</span>
<a href="#l40.469"></a><span id="l40.469">    * Get an absolute URL for clicked-on link, from the href property or by</span>
<a href="#l40.470"></a><span id="l40.470">    * resolving an XLink URL by hand.</span>
<a href="#l40.471"></a><span id="l40.471">    * @return the string absolute URL for the clicked-on link</span>
<a href="#l40.472"></a><span id="l40.472">    */</span>
<a href="#l40.473"></a><span id="l40.473" class="difflineminus">-  getLinkURL : function CM_getLinkURL() {</span>
<a href="#l40.474"></a><span id="l40.474" class="difflineplus">+  getLinkURL() {</span>
<a href="#l40.475"></a><span id="l40.475">     if (this.link.href) {</span>
<a href="#l40.476"></a><span id="l40.476">       return this.link.href;</span>
<a href="#l40.477"></a><span id="l40.477">     }</span>
<a href="#l40.478"></a><span id="l40.478" class="difflineminus">-    var href = this.link.getAttributeNS(&quot;http://www.w3.org/1999/xlink&quot;,&quot;href&quot;);</span>
<a href="#l40.479"></a><span id="l40.479" class="difflineplus">+    var href = this.link.getAttributeNS(&quot;http://www.w3.org/1999/xlink&quot;, &quot;href&quot;);</span>
<a href="#l40.480"></a><span id="l40.480">     if (!href || (href.trim() == &quot;&quot;)) {</span>
<a href="#l40.481"></a><span id="l40.481">        // Without this we try to save as the current doc,</span>
<a href="#l40.482"></a><span id="l40.482">        // for example, HTML case also throws if empty.</span>
<a href="#l40.483"></a><span id="l40.483">       throw &quot;Empty href&quot;;</span>
<a href="#l40.484"></a><span id="l40.484">     }</span>
<a href="#l40.485"></a><span id="l40.485" class="difflineminus">-    href = this.makeURLAbsolute(this.link.baseURI,href);</span>
<a href="#l40.486"></a><span id="l40.486" class="difflineplus">+    href = this.makeURLAbsolute(this.link.baseURI, href);</span>
<a href="#l40.487"></a><span id="l40.487">     return href;</span>
<a href="#l40.488"></a><span id="l40.488">   },</span>
<a href="#l40.489"></a><span id="l40.489"> </span>
<a href="#l40.490"></a><span id="l40.490">   /**</span>
<a href="#l40.491"></a><span id="l40.491">    * Generate a URI object from the linkURL spec</span>
<a href="#l40.492"></a><span id="l40.492">    * @return an nsIURI if possible, or null if not</span>
<a href="#l40.493"></a><span id="l40.493">    */</span>
<a href="#l40.494"></a><span id="l40.494" class="difflineminus">-  getLinkURI: function CM_getLinkURI() {</span>
<a href="#l40.495"></a><span id="l40.495" class="difflineplus">+  getLinkURI() {</span>
<a href="#l40.496"></a><span id="l40.496">     try {</span>
<a href="#l40.497"></a><span id="l40.497">       return Services.io.newURI(this.linkURL);</span>
<a href="#l40.498"></a><span id="l40.498">     } catch (ex) {</span>
<a href="#l40.499"></a><span id="l40.499">       // e.g. empty URL string</span>
<a href="#l40.500"></a><span id="l40.500">     }</span>
<a href="#l40.501"></a><span id="l40.501">     return null;</span>
<a href="#l40.502"></a><span id="l40.502">   },</span>
<a href="#l40.503"></a><span id="l40.503"> </span>
<a href="#l40.504"></a><span id="l40.504">   /**</span>
<a href="#l40.505"></a><span id="l40.505">    * Get the scheme for the clicked-on linkURI, if present.</span>
<a href="#l40.506"></a><span id="l40.506">    * @return a scheme, possibly undefined, or null if there's no linkURI</span>
<a href="#l40.507"></a><span id="l40.507">    */</span>
<a href="#l40.508"></a><span id="l40.508" class="difflineminus">-  getLinkProtocol: function CM_getLinkProtocol() {</span>
<a href="#l40.509"></a><span id="l40.509" class="difflineplus">+  getLinkProtocol() {</span>
<a href="#l40.510"></a><span id="l40.510">     if (this.linkURI)</span>
<a href="#l40.511"></a><span id="l40.511">       return this.linkURI.scheme; // can be |undefined|</span>
<a href="#l40.512"></a><span id="l40.512"> </span>
<a href="#l40.513"></a><span id="l40.513">     return null;</span>
<a href="#l40.514"></a><span id="l40.514">   },</span>
<a href="#l40.515"></a><span id="l40.515"> </span>
<a href="#l40.516"></a><span id="l40.516">   /**</span>
<a href="#l40.517"></a><span id="l40.517">    * Get some text, any text, for the clicked-on link.</span>
<a href="#l40.518"></a><span id="l40.518">    * @return the link text, title, alt, href, or &quot;&quot; if everything fails</span>
<a href="#l40.519"></a><span id="l40.519">    */</span>
<a href="#l40.520"></a><span id="l40.520" class="difflineminus">-  linkText : function CM_linkText() {</span>
<a href="#l40.521"></a><span id="l40.521" class="difflineplus">+  linkText() {</span>
<a href="#l40.522"></a><span id="l40.522">     var text = gatherTextUnder(this.link);</span>
<a href="#l40.523"></a><span id="l40.523">     if (!text || (text.trim() == &quot;&quot;)) {</span>
<a href="#l40.524"></a><span id="l40.524">       text = this.link.getAttribute(&quot;title&quot;);</span>
<a href="#l40.525"></a><span id="l40.525">       if (!text || (text.trim() == &quot;&quot;)) {</span>
<a href="#l40.526"></a><span id="l40.526">         text = this.link.getAttribute(&quot;alt&quot;);</span>
<a href="#l40.527"></a><span id="l40.527">         if (!text || (text.trim() == &quot;&quot;)) {</span>
<a href="#l40.528"></a><span id="l40.528">           if (this.link.href) {</span>
<a href="#l40.529"></a><span id="l40.529">             text = this.link.href;</span>
<a href="#l40.530"></a><span id="l40.530" class="difflineat">@@ -847,83 +842,82 @@ nsContextMenu.prototype = {</span>
<a href="#l40.531"></a><span id="l40.531"> </span>
<a href="#l40.532"></a><span id="l40.532">     return text;</span>
<a href="#l40.533"></a><span id="l40.533">   },</span>
<a href="#l40.534"></a><span id="l40.534"> </span>
<a href="#l40.535"></a><span id="l40.535">   /**</span>
<a href="#l40.536"></a><span id="l40.536">    * Determines whether the focused window has something selected.</span>
<a href="#l40.537"></a><span id="l40.537">    * @return true if there is a selection, false if not</span>
<a href="#l40.538"></a><span id="l40.538">    */</span>
<a href="#l40.539"></a><span id="l40.539" class="difflineminus">-  isContentSelection : function CM_isContentSelection() {</span>
<a href="#l40.540"></a><span id="l40.540" class="difflineplus">+  isContentSelection() {</span>
<a href="#l40.541"></a><span id="l40.541">     return !document.commandDispatcher.focusedWindow.getSelection().isCollapsed;</span>
<a href="#l40.542"></a><span id="l40.542">   },</span>
<a href="#l40.543"></a><span id="l40.543"> </span>
<a href="#l40.544"></a><span id="l40.544">   /**</span>
<a href="#l40.545"></a><span id="l40.545">    * Determines whether the context menu was triggered by a node that's a child</span>
<a href="#l40.546"></a><span id="l40.546">    * of the threadpane by looking for a parent node with id=&quot;threadTree&quot;.</span>
<a href="#l40.547"></a><span id="l40.547">    * @return true if the popupNode is a child of the threadpane, otherwise false</span>
<a href="#l40.548"></a><span id="l40.548">    */</span>
<a href="#l40.549"></a><span id="l40.549" class="difflineminus">-  popupNodeIsInThreadPane: function CM_popupNodeIsInThreadPane(aNode) {</span>
<a href="#l40.550"></a><span id="l40.550" class="difflineplus">+  popupNodeIsInThreadPane(aNode) {</span>
<a href="#l40.551"></a><span id="l40.551">     var node = aNode;</span>
<a href="#l40.552"></a><span id="l40.552" class="difflineminus">-    while (node)</span>
<a href="#l40.553"></a><span id="l40.553" class="difflineminus">-    {</span>
<a href="#l40.554"></a><span id="l40.554" class="difflineplus">+    while (node) {</span>
<a href="#l40.555"></a><span id="l40.555">       if (node.id == &quot;threadTree&quot;)</span>
<a href="#l40.556"></a><span id="l40.556">         return true;</span>
<a href="#l40.557"></a><span id="l40.557"> </span>
<a href="#l40.558"></a><span id="l40.558">       node = node.parentNode;</span>
<a href="#l40.559"></a><span id="l40.559">     }</span>
<a href="#l40.560"></a><span id="l40.560">     return false;</span>
<a href="#l40.561"></a><span id="l40.561">   },</span>
<a href="#l40.562"></a><span id="l40.562"> </span>
<a href="#l40.563"></a><span id="l40.563">   /**</span>
<a href="#l40.564"></a><span id="l40.564">    * Convert relative URL to absolute, using a provided &lt;base&gt;.</span>
<a href="#l40.565"></a><span id="l40.565">    * @param  aBase</span>
<a href="#l40.566"></a><span id="l40.566">    *         The URL string to use as the base</span>
<a href="#l40.567"></a><span id="l40.567">    * @param  aUrl</span>
<a href="#l40.568"></a><span id="l40.568">    *         The possibly-relative URL string</span>
<a href="#l40.569"></a><span id="l40.569">    * @return The string absolute URL</span>
<a href="#l40.570"></a><span id="l40.570">    */</span>
<a href="#l40.571"></a><span id="l40.571" class="difflineminus">-  makeURLAbsolute : function CM_makeURLAbsolute(aBase, aUrl) {</span>
<a href="#l40.572"></a><span id="l40.572" class="difflineplus">+  makeURLAbsolute(aBase, aUrl) {</span>
<a href="#l40.573"></a><span id="l40.573">     // Construct nsIURL.</span>
<a href="#l40.574"></a><span id="l40.574">     var baseURI  = Services.io.newURI(aBase);</span>
<a href="#l40.575"></a><span id="l40.575"> </span>
<a href="#l40.576"></a><span id="l40.576">     return Services.io.newURI(baseURI.resolve(aUrl)).spec;</span>
<a href="#l40.577"></a><span id="l40.577">   },</span>
<a href="#l40.578"></a><span id="l40.578"> </span>
<a href="#l40.579"></a><span id="l40.579">   /**</span>
<a href="#l40.580"></a><span id="l40.580">    * Determine whether a DOM node is a text or password input, or a textarea.</span>
<a href="#l40.581"></a><span id="l40.581">    * @param  aNode</span>
<a href="#l40.582"></a><span id="l40.582">    *         The DOM node to check</span>
<a href="#l40.583"></a><span id="l40.583">    * @return true for textboxes, false for other elements</span>
<a href="#l40.584"></a><span id="l40.584">    */</span>
<a href="#l40.585"></a><span id="l40.585" class="difflineminus">-  isTargetATextBox : function CM_isTargetATextBox(aNode) {</span>
<a href="#l40.586"></a><span id="l40.586" class="difflineplus">+  isTargetATextBox(aNode) {</span>
<a href="#l40.587"></a><span id="l40.587">     if (aNode instanceof HTMLInputElement)</span>
<a href="#l40.588"></a><span id="l40.588">       return (aNode.type == &quot;text&quot; || aNode.type == &quot;password&quot;);</span>
<a href="#l40.589"></a><span id="l40.589"> </span>
<a href="#l40.590"></a><span id="l40.590">     return (aNode instanceof HTMLTextAreaElement);</span>
<a href="#l40.591"></a><span id="l40.591">   },</span>
<a href="#l40.592"></a><span id="l40.592"> </span>
<a href="#l40.593"></a><span id="l40.593">   /**</span>
<a href="#l40.594"></a><span id="l40.594">    * Hide a separator based on whether there are any non-hidden items between</span>
<a href="#l40.595"></a><span id="l40.595">    * it and the previous separator.</span>
<a href="#l40.596"></a><span id="l40.596">    *</span>
<a href="#l40.597"></a><span id="l40.597">    * @param aSeparatorID  The id of the separator element.</span>
<a href="#l40.598"></a><span id="l40.598">    */</span>
<a href="#l40.599"></a><span id="l40.599" class="difflineminus">-  hideIfAppropriate: function CM_hideIfAppropriate(aSeparatorID) {</span>
<a href="#l40.600"></a><span id="l40.600" class="difflineplus">+  hideIfAppropriate(aSeparatorID) {</span>
<a href="#l40.601"></a><span id="l40.601">     this.showItem(aSeparatorID, this.shouldShowSeparator(aSeparatorID));</span>
<a href="#l40.602"></a><span id="l40.602">   },</span>
<a href="#l40.603"></a><span id="l40.603"> </span>
<a href="#l40.604"></a><span id="l40.604">   /**</span>
<a href="#l40.605"></a><span id="l40.605">    * Determine whether a separator should be shown based on whether</span>
<a href="#l40.606"></a><span id="l40.606">    * there are any non-hidden items between it and the previous separator.</span>
<a href="#l40.607"></a><span id="l40.607">    * @param  aSeparatorID</span>
<a href="#l40.608"></a><span id="l40.608">    *         The id of the separator element</span>
<a href="#l40.609"></a><span id="l40.609">    * @return true if the separator should be shown, false if not</span>
<a href="#l40.610"></a><span id="l40.610">    */</span>
<a href="#l40.611"></a><span id="l40.611" class="difflineminus">-  shouldShowSeparator : function CM_shouldShowSeparator(aSeparatorID) {</span>
<a href="#l40.612"></a><span id="l40.612" class="difflineplus">+  shouldShowSeparator(aSeparatorID) {</span>
<a href="#l40.613"></a><span id="l40.613">     var separator = document.getElementById(aSeparatorID);</span>
<a href="#l40.614"></a><span id="l40.614">     if (separator) {</span>
<a href="#l40.615"></a><span id="l40.615">       var sibling = separator.previousSibling;</span>
<a href="#l40.616"></a><span id="l40.616">       while (sibling &amp;&amp; sibling.localName != &quot;menuseparator&quot;) {</span>
<a href="#l40.617"></a><span id="l40.617">         if (sibling.getAttribute(&quot;hidden&quot;) != &quot;true&quot;)</span>
<a href="#l40.618"></a><span id="l40.618">           return true;</span>
<a href="#l40.619"></a><span id="l40.619">         sibling = sibling.previousSibling;</span>
<a href="#l40.620"></a><span id="l40.620">       }</span>
<a href="#l40.621"></a><span id="l40.621" class="difflineat">@@ -931,59 +925,58 @@ nsContextMenu.prototype = {</span>
<a href="#l40.622"></a><span id="l40.622">     return false;</span>
<a href="#l40.623"></a><span id="l40.623">   },</span>
<a href="#l40.624"></a><span id="l40.624"> </span>
<a href="#l40.625"></a><span id="l40.625">   /**</span>
<a href="#l40.626"></a><span id="l40.626">    * Ensures that there isn't a separator shown at the bottom of the menu.</span>
<a href="#l40.627"></a><span id="l40.627">    *</span>
<a href="#l40.628"></a><span id="l40.628">    * @param aPopup  The menu to check.</span>
<a href="#l40.629"></a><span id="l40.629">    */</span>
<a href="#l40.630"></a><span id="l40.630" class="difflineminus">-  checkLastSeparator: function CM_checkLastSeparator(aPopup) {</span>
<a href="#l40.631"></a><span id="l40.631" class="difflineplus">+  checkLastSeparator(aPopup) {</span>
<a href="#l40.632"></a><span id="l40.632">     let sibling = aPopup.lastChild;</span>
<a href="#l40.633"></a><span id="l40.633">     while (sibling) {</span>
<a href="#l40.634"></a><span id="l40.634">       if (sibling.getAttribute(&quot;hidden&quot;) != &quot;true&quot;) {</span>
<a href="#l40.635"></a><span id="l40.635">         if (sibling.localName == &quot;menuseparator&quot;) {</span>
<a href="#l40.636"></a><span id="l40.636">           // If we got here then the item is a menuseparator and everything</span>
<a href="#l40.637"></a><span id="l40.637">           // below it hidden.</span>
<a href="#l40.638"></a><span id="l40.638">           sibling.setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l40.639"></a><span id="l40.639">           return;</span>
<a href="#l40.640"></a><span id="l40.640">         }</span>
<a href="#l40.641"></a><span id="l40.641" class="difflineminus">-        else</span>
<a href="#l40.642"></a><span id="l40.642" class="difflineminus">-          return;</span>
<a href="#l40.643"></a><span id="l40.643" class="difflineplus">+        return;</span>
<a href="#l40.644"></a><span id="l40.644">       }</span>
<a href="#l40.645"></a><span id="l40.645">       sibling = sibling.previousSibling;</span>
<a href="#l40.646"></a><span id="l40.646">     }</span>
<a href="#l40.647"></a><span id="l40.647">   },</span>
<a href="#l40.648"></a><span id="l40.648"> </span>
<a href="#l40.649"></a><span id="l40.649" class="difflineminus">-  openInBrowser: function CM_openInBrowser() {</span>
<a href="#l40.650"></a><span id="l40.650" class="difflineminus">-    let url = this.target.ownerDocument.defaultView.top.location.href;</span>
<a href="#l40.651"></a><span id="l40.651" class="difflineplus">+  openInBrowser() {</span>
<a href="#l40.652"></a><span id="l40.652" class="difflineplus">+    let url = this.target.ownerGlobal.top.location.href;</span>
<a href="#l40.653"></a><span id="l40.653">     PlacesUtils.history.insert({</span>
<a href="#l40.654"></a><span id="l40.654">       url,</span>
<a href="#l40.655"></a><span id="l40.655">       visits: [{</span>
<a href="#l40.656"></a><span id="l40.656" class="difflineminus">-        date: new Date()</span>
<a href="#l40.657"></a><span id="l40.657" class="difflineminus">-      }]</span>
<a href="#l40.658"></a><span id="l40.658" class="difflineplus">+        date: new Date(),</span>
<a href="#l40.659"></a><span id="l40.659" class="difflineplus">+      }],</span>
<a href="#l40.660"></a><span id="l40.660">     }).catch(Cu.reportError);</span>
<a href="#l40.661"></a><span id="l40.661">     Cc[&quot;@mozilla.org/uriloader/external-protocol-service;1&quot;]</span>
<a href="#l40.662"></a><span id="l40.662">       .getService(Ci.nsIExternalProtocolService)</span>
<a href="#l40.663"></a><span id="l40.663">       .loadURI(Services.io.newURI(url));</span>
<a href="#l40.664"></a><span id="l40.664">   },</span>
<a href="#l40.665"></a><span id="l40.665"> </span>
<a href="#l40.666"></a><span id="l40.666" class="difflineminus">-  openLinkInBrowser: function CM_openLinkInBrowser() {</span>
<a href="#l40.667"></a><span id="l40.667" class="difflineplus">+  openLinkInBrowser() {</span>
<a href="#l40.668"></a><span id="l40.668">     PlacesUtils.history.insert({</span>
<a href="#l40.669"></a><span id="l40.669">       url: this.linkURL,</span>
<a href="#l40.670"></a><span id="l40.670">       visits: [{</span>
<a href="#l40.671"></a><span id="l40.671" class="difflineminus">-        date: new Date()</span>
<a href="#l40.672"></a><span id="l40.672" class="difflineminus">-      }]</span>
<a href="#l40.673"></a><span id="l40.673" class="difflineplus">+        date: new Date(),</span>
<a href="#l40.674"></a><span id="l40.674" class="difflineplus">+      }],</span>
<a href="#l40.675"></a><span id="l40.675">     }).catch(Cu.reportError);</span>
<a href="#l40.676"></a><span id="l40.676">     Cc[&quot;@mozilla.org/uriloader/external-protocol-service;1&quot;]</span>
<a href="#l40.677"></a><span id="l40.677">       .getService(Ci.nsIExternalProtocolService)</span>
<a href="#l40.678"></a><span id="l40.678">       .loadURI(this.linkURI);</span>
<a href="#l40.679"></a><span id="l40.679">   },</span>
<a href="#l40.680"></a><span id="l40.680"> </span>
<a href="#l40.681"></a><span id="l40.681" class="difflineminus">-  mediaCommand : function CM_mediaCommand(command) {</span>
<a href="#l40.682"></a><span id="l40.682" class="difflineplus">+  mediaCommand(command) {</span>
<a href="#l40.683"></a><span id="l40.683">     var media = this.target;</span>
<a href="#l40.684"></a><span id="l40.684"> </span>
<a href="#l40.685"></a><span id="l40.685">     switch (command) {</span>
<a href="#l40.686"></a><span id="l40.686">       case &quot;play&quot;:</span>
<a href="#l40.687"></a><span id="l40.687">         media.play();</span>
<a href="#l40.688"></a><span id="l40.688">         break;</span>
<a href="#l40.689"></a><span id="l40.689">       case &quot;pause&quot;:</span>
<a href="#l40.690"></a><span id="l40.690">         media.pause();</span>
<a href="#l40.691"></a><span id="l40.691" class="difflineat">@@ -992,10 +985,10 @@ nsContextMenu.prototype = {</span>
<a href="#l40.692"></a><span id="l40.692">         media.muted = true;</span>
<a href="#l40.693"></a><span id="l40.693">         break;</span>
<a href="#l40.694"></a><span id="l40.694">       case &quot;unmute&quot;:</span>
<a href="#l40.695"></a><span id="l40.695">         media.muted = false;</span>
<a href="#l40.696"></a><span id="l40.696">         break;</span>
<a href="#l40.697"></a><span id="l40.697">       // XXX hide controls &amp; show controls don't work in emails as Javascript is</span>
<a href="#l40.698"></a><span id="l40.698">       // disabled. May want to consider later for RSS feeds.</span>
<a href="#l40.699"></a><span id="l40.699">     }</span>
<a href="#l40.700"></a><span id="l40.700" class="difflineminus">-  }</span>
<a href="#l40.701"></a><span id="l40.701" class="difflineplus">+  },</span>
<a href="#l40.702"></a><span id="l40.702"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/mail/base/content/nsDragAndDrop.js</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/mail/base/content/nsDragAndDrop.js</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -1,27 +1,22 @@</span>
<a href="#l41.4"></a><span id="l41.4"> // -*- indent-tabs-mode: nil; js-indent-level: 2 -*-</span>
<a href="#l41.5"></a><span id="l41.5"> </span>
<a href="#l41.6"></a><span id="l41.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l41.7"></a><span id="l41.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l41.8"></a><span id="l41.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l41.9"></a><span id="l41.9"> </span>
<a href="#l41.10"></a><span id="l41.10" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l41.11"></a><span id="l41.11" class="difflineminus">-//</span>
<a href="#l41.12"></a><span id="l41.12"> // USE OF THIS API FOR DRAG AND DROP IS DEPRECATED!</span>
<a href="#l41.13"></a><span id="l41.13"> // Do not use this file for new code.</span>
<a href="#l41.14"></a><span id="l41.14"> //</span>
<a href="#l41.15"></a><span id="l41.15"> // Toolkit dropped nsDragAndDrop.js in bug 1162050.</span>
<a href="#l41.16"></a><span id="l41.16"> // Mapped to content/global/nsDragAndDrop.js until we can remove this usage.</span>
<a href="#l41.17"></a><span id="l41.17"> //</span>
<a href="#l41.18"></a><span id="l41.18"> // For documentation about what to use instead, see:</span>
<a href="#l41.19"></a><span id="l41.19"> //   http://developer.mozilla.org/En/DragDrop/Drag_and_Drop</span>
<a href="#l41.20"></a><span id="l41.20" class="difflineminus">-//</span>
<a href="#l41.21"></a><span id="l41.21" class="difflineminus">-////////////////////////////////////////////////////////////////////////</span>
<a href="#l41.22"></a><span id="l41.22" class="difflineminus">-</span>
<a href="#l41.23"></a><span id="l41.23"> </span>
<a href="#l41.24"></a><span id="l41.24"> /**</span>
<a href="#l41.25"></a><span id="l41.25">  *  nsTransferable - a wrapper for nsITransferable that simplifies</span>
<a href="#l41.26"></a><span id="l41.26">  *                   javascript clipboard and drag&amp;drop. for use in</span>
<a href="#l41.27"></a><span id="l41.27">  *                   these situations you should use the nsClipboard</span>
<a href="#l41.28"></a><span id="l41.28">  *                   and nsDragAndDrop wrappers for more convenience</span>
<a href="#l41.29"></a><span id="l41.29">  **/</span>
<a href="#l41.30"></a><span id="l41.30"> </span>
<a href="#l41.31"></a><span id="l41.31" class="difflineat">@@ -29,36 +24,31 @@ var nsTransferable = {</span>
<a href="#l41.32"></a><span id="l41.32">   /**</span>
<a href="#l41.33"></a><span id="l41.33">    * nsITransferable set (TransferData aTransferData) ;</span>
<a href="#l41.34"></a><span id="l41.34">    *</span>
<a href="#l41.35"></a><span id="l41.35">    * Creates a transferable with data for a list of supported types (&quot;flavours&quot;)</span>
<a href="#l41.36"></a><span id="l41.36">    *</span>
<a href="#l41.37"></a><span id="l41.37">    * @param TransferData aTransferData</span>
<a href="#l41.38"></a><span id="l41.38">    *        a javascript object in the format described above</span>
<a href="#l41.39"></a><span id="l41.39">    **/</span>
<a href="#l41.40"></a><span id="l41.40" class="difflineminus">-  set: function (aTransferDataSet)</span>
<a href="#l41.41"></a><span id="l41.41" class="difflineminus">-    {</span>
<a href="#l41.42"></a><span id="l41.42" class="difflineplus">+  set(aTransferDataSet) {</span>
<a href="#l41.43"></a><span id="l41.43">       var trans = this.createTransferable();</span>
<a href="#l41.44"></a><span id="l41.44" class="difflineminus">-      for (var i = 0; i &lt; aTransferDataSet.dataList.length; ++i)</span>
<a href="#l41.45"></a><span id="l41.45" class="difflineminus">-        {</span>
<a href="#l41.46"></a><span id="l41.46" class="difflineplus">+      for (var i = 0; i &lt; aTransferDataSet.dataList.length; ++i) {</span>
<a href="#l41.47"></a><span id="l41.47">           var currData = aTransferDataSet.dataList[i];</span>
<a href="#l41.48"></a><span id="l41.48">           var currFlavour = currData.flavour.contentType;</span>
<a href="#l41.49"></a><span id="l41.49">           trans.addDataFlavor(currFlavour);</span>
<a href="#l41.50"></a><span id="l41.50">           var supports = null; // nsISupports data</span>
<a href="#l41.51"></a><span id="l41.51">           var length = 0;</span>
<a href="#l41.52"></a><span id="l41.52" class="difflineminus">-          if (currData.flavour.dataIIDKey == &quot;nsISupportsString&quot;)</span>
<a href="#l41.53"></a><span id="l41.53" class="difflineminus">-            {</span>
<a href="#l41.54"></a><span id="l41.54" class="difflineplus">+          if (currData.flavour.dataIIDKey == &quot;nsISupportsString&quot;) {</span>
<a href="#l41.55"></a><span id="l41.55">               supports = Cc[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l41.56"></a><span id="l41.56">                            .createInstance(Ci.nsISupportsString);</span>
<a href="#l41.57"></a><span id="l41.57"> </span>
<a href="#l41.58"></a><span id="l41.58">               supports.data = currData.supports;</span>
<a href="#l41.59"></a><span id="l41.59">               length = supports.data.length;</span>
<a href="#l41.60"></a><span id="l41.60" class="difflineminus">-            }</span>
<a href="#l41.61"></a><span id="l41.61" class="difflineminus">-          else</span>
<a href="#l41.62"></a><span id="l41.62" class="difflineminus">-            {</span>
<a href="#l41.63"></a><span id="l41.63" class="difflineplus">+            } else {</span>
<a href="#l41.64"></a><span id="l41.64">               // non-string data.</span>
<a href="#l41.65"></a><span id="l41.65">               supports = currData.supports;</span>
<a href="#l41.66"></a><span id="l41.66">               length = 0; // kFlavorHasDataProvider</span>
<a href="#l41.67"></a><span id="l41.67">             }</span>
<a href="#l41.68"></a><span id="l41.68">           trans.setTransferData(currFlavour, supports, length * 2);</span>
<a href="#l41.69"></a><span id="l41.69">         }</span>
<a href="#l41.70"></a><span id="l41.70">       return trans;</span>
<a href="#l41.71"></a><span id="l41.71">     },</span>
<a href="#l41.72"></a><span id="l41.72" class="difflineat">@@ -75,228 +65,206 @@ var nsTransferable = {</span>
<a href="#l41.73"></a><span id="l41.73">    * @param Function aRetrievalFunc</span>
<a href="#l41.74"></a><span id="l41.74">    *        a reference to a function that returns a nsIArray of nsITransferables</span>
<a href="#l41.75"></a><span id="l41.75">    *        for each item from the specified source (clipboard/drag&amp;drop etc)</span>
<a href="#l41.76"></a><span id="l41.76">    * @param Boolean aAnyFlag</span>
<a href="#l41.77"></a><span id="l41.77">    *        a flag specifying whether or not a specific flavour is requested. If false,</span>
<a href="#l41.78"></a><span id="l41.78">    *        data of the type of the first flavour in the flavourlist parameter is returned,</span>
<a href="#l41.79"></a><span id="l41.79">    *        otherwise the best flavour supported will be returned.</span>
<a href="#l41.80"></a><span id="l41.80">    **/</span>
<a href="#l41.81"></a><span id="l41.81" class="difflineminus">-  get: function (aFlavourSet, aRetrievalFunc, aAnyFlag)</span>
<a href="#l41.82"></a><span id="l41.82" class="difflineminus">-    {</span>
<a href="#l41.83"></a><span id="l41.83" class="difflineplus">+  get(aFlavourSet, aRetrievalFunc, aAnyFlag) {</span>
<a href="#l41.84"></a><span id="l41.84">       if (!aRetrievalFunc)</span>
<a href="#l41.85"></a><span id="l41.85">         throw &quot;No data retrieval handler provided!&quot;;</span>
<a href="#l41.86"></a><span id="l41.86"> </span>
<a href="#l41.87"></a><span id="l41.87">       var array = aRetrievalFunc(aFlavourSet);</span>
<a href="#l41.88"></a><span id="l41.88">       var dataArray = [];</span>
<a href="#l41.89"></a><span id="l41.89"> </span>
<a href="#l41.90"></a><span id="l41.90">       // Iterate over the number of items returned from aRetrievalFunc. For</span>
<a href="#l41.91"></a><span id="l41.91">       // clipboard operations, this is 1, for drag and drop (where multiple</span>
<a href="#l41.92"></a><span id="l41.92">       // items may have been dragged) this could be &gt;1.</span>
<a href="#l41.93"></a><span id="l41.93" class="difflineminus">-      for (let i = 0; i &lt; array.length; i++)</span>
<a href="#l41.94"></a><span id="l41.94" class="difflineminus">-        {</span>
<a href="#l41.95"></a><span id="l41.95" class="difflineplus">+      for (let i = 0; i &lt; array.length; i++) {</span>
<a href="#l41.96"></a><span id="l41.96">           let trans = array.queryElementAt(i, Ci.nsITransferable);</span>
<a href="#l41.97"></a><span id="l41.97">           if (!trans)</span>
<a href="#l41.98"></a><span id="l41.98">             continue;</span>
<a href="#l41.99"></a><span id="l41.99"> </span>
<a href="#l41.100"></a><span id="l41.100" class="difflineminus">-          var data = { };</span>
<a href="#l41.101"></a><span id="l41.101" class="difflineminus">-          var length = { };</span>
<a href="#l41.102"></a><span id="l41.102" class="difflineplus">+          var data = {};</span>
<a href="#l41.103"></a><span id="l41.103" class="difflineplus">+          var length = {};</span>
<a href="#l41.104"></a><span id="l41.104"> </span>
<a href="#l41.105"></a><span id="l41.105" class="difflineminus">-          var currData = null;</span>
<a href="#l41.106"></a><span id="l41.106" class="difflineminus">-          if (aAnyFlag)</span>
<a href="#l41.107"></a><span id="l41.107" class="difflineminus">-            {</span>
<a href="#l41.108"></a><span id="l41.108" class="difflineminus">-              var flavour = { };</span>
<a href="#l41.109"></a><span id="l41.109" class="difflineplus">+          if (aAnyFlag) {</span>
<a href="#l41.110"></a><span id="l41.110" class="difflineplus">+              var flavour = {};</span>
<a href="#l41.111"></a><span id="l41.111">               trans.getAnyTransferData(flavour, data, length);</span>
<a href="#l41.112"></a><span id="l41.112" class="difflineminus">-              if (data &amp;&amp; flavour)</span>
<a href="#l41.113"></a><span id="l41.113" class="difflineminus">-                {</span>
<a href="#l41.114"></a><span id="l41.114" class="difflineplus">+              if (data &amp;&amp; flavour) {</span>
<a href="#l41.115"></a><span id="l41.115">                   var selectedFlavour = aFlavourSet.flavourTable[flavour.value];</span>
<a href="#l41.116"></a><span id="l41.116">                   if (selectedFlavour)</span>
<a href="#l41.117"></a><span id="l41.117">                     dataArray[i] = FlavourToXfer(data.value, length.value, selectedFlavour);</span>
<a href="#l41.118"></a><span id="l41.118">                 }</span>
<a href="#l41.119"></a><span id="l41.119" class="difflineminus">-            }</span>
<a href="#l41.120"></a><span id="l41.120" class="difflineminus">-          else</span>
<a href="#l41.121"></a><span id="l41.121" class="difflineminus">-            {</span>
<a href="#l41.122"></a><span id="l41.122" class="difflineplus">+            } else {</span>
<a href="#l41.123"></a><span id="l41.123">               var firstFlavour = aFlavourSet.flavours[0];</span>
<a href="#l41.124"></a><span id="l41.124">               trans.getTransferData(firstFlavour, data, length);</span>
<a href="#l41.125"></a><span id="l41.125">               if (data &amp;&amp; firstFlavour)</span>
<a href="#l41.126"></a><span id="l41.126">                 dataArray[i] = FlavourToXfer(data.value, length.value, firstFlavour);</span>
<a href="#l41.127"></a><span id="l41.127">             }</span>
<a href="#l41.128"></a><span id="l41.128">         }</span>
<a href="#l41.129"></a><span id="l41.129">       return new TransferDataSet(dataArray);</span>
<a href="#l41.130"></a><span id="l41.130">     },</span>
<a href="#l41.131"></a><span id="l41.131"> </span>
<a href="#l41.132"></a><span id="l41.132">   /**</span>
<a href="#l41.133"></a><span id="l41.133">    * nsITransferable createTransferable (void) ;</span>
<a href="#l41.134"></a><span id="l41.134">    *</span>
<a href="#l41.135"></a><span id="l41.135">    * Creates and returns a transferable object.</span>
<a href="#l41.136"></a><span id="l41.136">    **/</span>
<a href="#l41.137"></a><span id="l41.137" class="difflineminus">-  createTransferable: function ()</span>
<a href="#l41.138"></a><span id="l41.138" class="difflineminus">-    {</span>
<a href="#l41.139"></a><span id="l41.139" class="difflineplus">+  createTransferable() {</span>
<a href="#l41.140"></a><span id="l41.140">       const kXferableContractID = &quot;@mozilla.org/widget/transferable;1&quot;;</span>
<a href="#l41.141"></a><span id="l41.141">       const kXferableIID = Ci.nsITransferable;</span>
<a href="#l41.142"></a><span id="l41.142">       var trans = Cc[kXferableContractID].createInstance(kXferableIID);</span>
<a href="#l41.143"></a><span id="l41.143">       trans.init(null);</span>
<a href="#l41.144"></a><span id="l41.144">       return trans;</span>
<a href="#l41.145"></a><span id="l41.145" class="difflineminus">-    }</span>
<a href="#l41.146"></a><span id="l41.146" class="difflineplus">+    },</span>
<a href="#l41.147"></a><span id="l41.147"> };</span>
<a href="#l41.148"></a><span id="l41.148"> </span>
<a href="#l41.149"></a><span id="l41.149"> /**</span>
<a href="#l41.150"></a><span id="l41.150">  * A FlavourSet is a simple type that represents a collection of Flavour objects.</span>
<a href="#l41.151"></a><span id="l41.151">  * FlavourSet is constructed from an array of Flavours, and stores this list as</span>
<a href="#l41.152"></a><span id="l41.152">  * an array and a hashtable. The rationale for the dual storage is as follows:</span>
<a href="#l41.153"></a><span id="l41.153">  *</span>
<a href="#l41.154"></a><span id="l41.154">  * Array: Ordering is important when adding data flavours to a transferable.</span>
<a href="#l41.155"></a><span id="l41.155">  *        Flavours added first are deemed to be 'preferred' by the client.</span>
<a href="#l41.156"></a><span id="l41.156">  * Hash:  Convenient lookup of flavour data using the content type (MIME type)</span>
<a href="#l41.157"></a><span id="l41.157">  *        of data as a key.</span>
<a href="#l41.158"></a><span id="l41.158">  */</span>
<a href="#l41.159"></a><span id="l41.159" class="difflineminus">-function FlavourSet(aFlavourList)</span>
<a href="#l41.160"></a><span id="l41.160" class="difflineminus">-{</span>
<a href="#l41.161"></a><span id="l41.161" class="difflineplus">+function FlavourSet(aFlavourList) {</span>
<a href="#l41.162"></a><span id="l41.162">   this.flavours = aFlavourList || [];</span>
<a href="#l41.163"></a><span id="l41.163" class="difflineminus">-  this.flavourTable = { };</span>
<a href="#l41.164"></a><span id="l41.164" class="difflineplus">+  this.flavourTable = {};</span>
<a href="#l41.165"></a><span id="l41.165"> </span>
<a href="#l41.166"></a><span id="l41.166">   this._XferID = &quot;FlavourSet&quot;;</span>
<a href="#l41.167"></a><span id="l41.167"> </span>
<a href="#l41.168"></a><span id="l41.168">   for (var i = 0; i &lt; this.flavours.length; ++i)</span>
<a href="#l41.169"></a><span id="l41.169">     this.flavourTable[this.flavours[i].contentType] = this.flavours[i];</span>
<a href="#l41.170"></a><span id="l41.170"> }</span>
<a href="#l41.171"></a><span id="l41.171"> </span>
<a href="#l41.172"></a><span id="l41.172"> FlavourSet.prototype = {</span>
<a href="#l41.173"></a><span id="l41.173" class="difflineminus">-  appendFlavour: function (aFlavour, aFlavourIIDKey)</span>
<a href="#l41.174"></a><span id="l41.174" class="difflineminus">-  {</span>
<a href="#l41.175"></a><span id="l41.175" class="difflineminus">-    var flavour = new Flavour (aFlavour, aFlavourIIDKey);</span>
<a href="#l41.176"></a><span id="l41.176" class="difflineplus">+  appendFlavour(aFlavour, aFlavourIIDKey) {</span>
<a href="#l41.177"></a><span id="l41.177" class="difflineplus">+    var flavour = new Flavour(aFlavour, aFlavourIIDKey);</span>
<a href="#l41.178"></a><span id="l41.178">     this.flavours.push(flavour);</span>
<a href="#l41.179"></a><span id="l41.179">     this.flavourTable[flavour.contentType] = flavour;</span>
<a href="#l41.180"></a><span id="l41.180" class="difflineminus">-  }</span>
<a href="#l41.181"></a><span id="l41.181" class="difflineplus">+  },</span>
<a href="#l41.182"></a><span id="l41.182"> };</span>
<a href="#l41.183"></a><span id="l41.183"> </span>
<a href="#l41.184"></a><span id="l41.184"> /**</span>
<a href="#l41.185"></a><span id="l41.185">  * A Flavour is a simple type that represents a data type that can be handled.</span>
<a href="#l41.186"></a><span id="l41.186">  * It takes a content type (MIME type) which is used when storing data on the</span>
<a href="#l41.187"></a><span id="l41.187">  * system clipboard/drag and drop, and an IIDKey (string interface name</span>
<a href="#l41.188"></a><span id="l41.188">  * which is used to QI data to an appropriate form. The default interface is</span>
<a href="#l41.189"></a><span id="l41.189">  * assumed to be wide-string.</span>
<a href="#l41.190"></a><span id="l41.190">  */</span>
<a href="#l41.191"></a><span id="l41.191" class="difflineminus">-function Flavour(aContentType, aDataIIDKey)</span>
<a href="#l41.192"></a><span id="l41.192" class="difflineminus">-{</span>
<a href="#l41.193"></a><span id="l41.193" class="difflineplus">+function Flavour(aContentType, aDataIIDKey) {</span>
<a href="#l41.194"></a><span id="l41.194">   this.contentType = aContentType;</span>
<a href="#l41.195"></a><span id="l41.195">   this.dataIIDKey = aDataIIDKey || &quot;nsISupportsString&quot;;</span>
<a href="#l41.196"></a><span id="l41.196"> </span>
<a href="#l41.197"></a><span id="l41.197">   this._XferID = &quot;Flavour&quot;;</span>
<a href="#l41.198"></a><span id="l41.198"> }</span>
<a href="#l41.199"></a><span id="l41.199"> </span>
<a href="#l41.200"></a><span id="l41.200"> function TransferDataBase() {}</span>
<a href="#l41.201"></a><span id="l41.201"> TransferDataBase.prototype = {</span>
<a href="#l41.202"></a><span id="l41.202" class="difflineminus">-  push: function (aItems)</span>
<a href="#l41.203"></a><span id="l41.203" class="difflineminus">-  {</span>
<a href="#l41.204"></a><span id="l41.204" class="difflineplus">+  push(aItems) {</span>
<a href="#l41.205"></a><span id="l41.205">     this.dataList.push(aItems);</span>
<a href="#l41.206"></a><span id="l41.206">   },</span>
<a href="#l41.207"></a><span id="l41.207"> </span>
<a href="#l41.208"></a><span id="l41.208" class="difflineminus">-  get first ()</span>
<a href="#l41.209"></a><span id="l41.209" class="difflineminus">-  {</span>
<a href="#l41.210"></a><span id="l41.210" class="difflineplus">+  get first() {</span>
<a href="#l41.211"></a><span id="l41.211">     return &quot;dataList&quot; in this &amp;&amp; this.dataList.length ? this.dataList[0] : null;</span>
<a href="#l41.212"></a><span id="l41.212" class="difflineminus">-  }</span>
<a href="#l41.213"></a><span id="l41.213" class="difflineplus">+  },</span>
<a href="#l41.214"></a><span id="l41.214"> };</span>
<a href="#l41.215"></a><span id="l41.215"> </span>
<a href="#l41.216"></a><span id="l41.216"> /**</span>
<a href="#l41.217"></a><span id="l41.217">  * TransferDataSet is a list (array) of TransferData objects, which represents</span>
<a href="#l41.218"></a><span id="l41.218">  * data dragged from one or more elements.</span>
<a href="#l41.219"></a><span id="l41.219">  */</span>
<a href="#l41.220"></a><span id="l41.220" class="difflineminus">-function TransferDataSet(aTransferDataList)</span>
<a href="#l41.221"></a><span id="l41.221" class="difflineminus">-{</span>
<a href="#l41.222"></a><span id="l41.222" class="difflineplus">+function TransferDataSet(aTransferDataList) {</span>
<a href="#l41.223"></a><span id="l41.223">   this.dataList = aTransferDataList || [];</span>
<a href="#l41.224"></a><span id="l41.224"> </span>
<a href="#l41.225"></a><span id="l41.225">   this._XferID = &quot;TransferDataSet&quot;;</span>
<a href="#l41.226"></a><span id="l41.226"> }</span>
<a href="#l41.227"></a><span id="l41.227"> TransferDataSet.prototype = TransferDataBase.prototype;</span>
<a href="#l41.228"></a><span id="l41.228"> </span>
<a href="#l41.229"></a><span id="l41.229"> /**</span>
<a href="#l41.230"></a><span id="l41.230">  * TransferData is a list (array) of FlavourData for all the applicable content</span>
<a href="#l41.231"></a><span id="l41.231">  * types associated with a drag from a single item.</span>
<a href="#l41.232"></a><span id="l41.232">  */</span>
<a href="#l41.233"></a><span id="l41.233" class="difflineminus">-function TransferData(aFlavourDataList)</span>
<a href="#l41.234"></a><span id="l41.234" class="difflineminus">-{</span>
<a href="#l41.235"></a><span id="l41.235" class="difflineplus">+function TransferData(aFlavourDataList) {</span>
<a href="#l41.236"></a><span id="l41.236">   this.dataList = aFlavourDataList || [];</span>
<a href="#l41.237"></a><span id="l41.237"> </span>
<a href="#l41.238"></a><span id="l41.238">   this._XferID = &quot;TransferData&quot;;</span>
<a href="#l41.239"></a><span id="l41.239"> }</span>
<a href="#l41.240"></a><span id="l41.240"> TransferData.prototype = {</span>
<a href="#l41.241"></a><span id="l41.241">   __proto__: TransferDataBase.prototype,</span>
<a href="#l41.242"></a><span id="l41.242"> </span>
<a href="#l41.243"></a><span id="l41.243" class="difflineminus">-  addDataForFlavour: function (aFlavourString, aData, aLength, aDataIIDKey)</span>
<a href="#l41.244"></a><span id="l41.244" class="difflineminus">-  {</span>
<a href="#l41.245"></a><span id="l41.245" class="difflineplus">+  addDataForFlavour(aFlavourString, aData, aLength, aDataIIDKey) {</span>
<a href="#l41.246"></a><span id="l41.246">     this.dataList.push(new FlavourData(aData, aLength,</span>
<a href="#l41.247"></a><span id="l41.247">                        new Flavour(aFlavourString, aDataIIDKey)));</span>
<a href="#l41.248"></a><span id="l41.248" class="difflineminus">-  }</span>
<a href="#l41.249"></a><span id="l41.249" class="difflineplus">+  },</span>
<a href="#l41.250"></a><span id="l41.250"> };</span>
<a href="#l41.251"></a><span id="l41.251"> </span>
<a href="#l41.252"></a><span id="l41.252"> /**</span>
<a href="#l41.253"></a><span id="l41.253">  * FlavourData is a type that represents data retrieved from the system</span>
<a href="#l41.254"></a><span id="l41.254">  * clipboard or drag and drop. It is constructed internally by the Transferable</span>
<a href="#l41.255"></a><span id="l41.255">  * using the raw (nsISupports) data from the clipboard, the length of the data,</span>
<a href="#l41.256"></a><span id="l41.256">  * and an object of type Flavour representing the type. Clients implementing</span>
<a href="#l41.257"></a><span id="l41.257">  * IDragDropObserver receive an object of this type in their implementation of</span>
<a href="#l41.258"></a><span id="l41.258">  * onDrop. They access the 'data' property to retrieve data, which is either data</span>
<a href="#l41.259"></a><span id="l41.259">  * QI'ed to a usable form, or unicode string.</span>
<a href="#l41.260"></a><span id="l41.260">  */</span>
<a href="#l41.261"></a><span id="l41.261" class="difflineminus">-function FlavourData(aData, aLength, aFlavour)</span>
<a href="#l41.262"></a><span id="l41.262" class="difflineminus">-{</span>
<a href="#l41.263"></a><span id="l41.263" class="difflineplus">+function FlavourData(aData, aLength, aFlavour) {</span>
<a href="#l41.264"></a><span id="l41.264">   this.supports = aData;</span>
<a href="#l41.265"></a><span id="l41.265">   this.contentLength = aLength;</span>
<a href="#l41.266"></a><span id="l41.266">   this.flavour = aFlavour || null;</span>
<a href="#l41.267"></a><span id="l41.267"> </span>
<a href="#l41.268"></a><span id="l41.268">   this._XferID = &quot;FlavourData&quot;;</span>
<a href="#l41.269"></a><span id="l41.269"> }</span>
<a href="#l41.270"></a><span id="l41.270"> </span>
<a href="#l41.271"></a><span id="l41.271"> FlavourData.prototype = {</span>
<a href="#l41.272"></a><span id="l41.272" class="difflineminus">-  get data ()</span>
<a href="#l41.273"></a><span id="l41.273" class="difflineminus">-  {</span>
<a href="#l41.274"></a><span id="l41.274" class="difflineplus">+  get data() {</span>
<a href="#l41.275"></a><span id="l41.275">     if (this.flavour &amp;&amp;</span>
<a href="#l41.276"></a><span id="l41.276">         this.flavour.dataIIDKey != &quot;nsISupportsString&quot;)</span>
<a href="#l41.277"></a><span id="l41.277">       return this.supports.QueryInterface(Ci[this.flavour.dataIIDKey]);</span>
<a href="#l41.278"></a><span id="l41.278"> </span>
<a href="#l41.279"></a><span id="l41.279">     var supports = this.supports;</span>
<a href="#l41.280"></a><span id="l41.280">     if (supports instanceof Ci.nsISupportsString)</span>
<a href="#l41.281"></a><span id="l41.281" class="difflineminus">-      return supports.data.substring(0, this.contentLength/2);</span>
<a href="#l41.282"></a><span id="l41.282" class="difflineplus">+      return supports.data.substring(0, this.contentLength / 2);</span>
<a href="#l41.283"></a><span id="l41.283"> </span>
<a href="#l41.284"></a><span id="l41.284">     return supports;</span>
<a href="#l41.285"></a><span id="l41.285" class="difflineminus">-  }</span>
<a href="#l41.286"></a><span id="l41.286" class="difflineminus">-}</span>
<a href="#l41.287"></a><span id="l41.287" class="difflineplus">+  },</span>
<a href="#l41.288"></a><span id="l41.288" class="difflineplus">+};</span>
<a href="#l41.289"></a><span id="l41.289"> </span>
<a href="#l41.290"></a><span id="l41.290"> /**</span>
<a href="#l41.291"></a><span id="l41.291">  * Create a TransferData object with a single FlavourData entry. Used when</span>
<a href="#l41.292"></a><span id="l41.292">  * unwrapping data of a specific flavour from the drag service.</span>
<a href="#l41.293"></a><span id="l41.293">  */</span>
<a href="#l41.294"></a><span id="l41.294" class="difflineminus">-function FlavourToXfer(aData, aLength, aFlavour)</span>
<a href="#l41.295"></a><span id="l41.295" class="difflineminus">-{</span>
<a href="#l41.296"></a><span id="l41.296" class="difflineplus">+function FlavourToXfer(aData, aLength, aFlavour) {</span>
<a href="#l41.297"></a><span id="l41.297">   return new TransferData([new FlavourData(aData, aLength, aFlavour)]);</span>
<a href="#l41.298"></a><span id="l41.298"> }</span>
<a href="#l41.299"></a><span id="l41.299"> </span>
<a href="#l41.300"></a><span id="l41.300"> var transferUtils = {</span>
<a href="#l41.301"></a><span id="l41.301"> </span>
<a href="#l41.302"></a><span id="l41.302" class="difflineminus">-  retrieveURLFromData: function (aData, flavour)</span>
<a href="#l41.303"></a><span id="l41.303" class="difflineminus">-  {</span>
<a href="#l41.304"></a><span id="l41.304" class="difflineplus">+  retrieveURLFromData(aData, flavour) {</span>
<a href="#l41.305"></a><span id="l41.305">     switch (flavour) {</span>
<a href="#l41.306"></a><span id="l41.306">       case &quot;text/unicode&quot;:</span>
<a href="#l41.307"></a><span id="l41.307">       case &quot;text/plain&quot;:</span>
<a href="#l41.308"></a><span id="l41.308">       case &quot;text/x-moz-text-internal&quot;:</span>
<a href="#l41.309"></a><span id="l41.309">         return aData.replace(/^\s+|\s+$/g, &quot;&quot;);</span>
<a href="#l41.310"></a><span id="l41.310">       case &quot;text/x-moz-url&quot;:</span>
<a href="#l41.311"></a><span id="l41.311">         return ((aData instanceof Ci.nsISupportsString) ? aData.toString() : aData).split(&quot;\n&quot;)[0];</span>
<a href="#l41.312"></a><span id="l41.312">       case &quot;application/x-moz-file&quot;:</span>
<a href="#l41.313"></a><span id="l41.313" class="difflineminus">-        var ioService = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l41.314"></a><span id="l41.314" class="difflineminus">-                          .getService(Ci.nsIIOService);</span>
<a href="#l41.315"></a><span id="l41.315" class="difflineminus">-        var fileHandler = ioService.getProtocolHandler(&quot;file&quot;)</span>
<a href="#l41.316"></a><span id="l41.316" class="difflineminus">-                                   .QueryInterface(Ci.nsIFileProtocolHandler);</span>
<a href="#l41.317"></a><span id="l41.317" class="difflineplus">+        var fileHandler = Services.io.getProtocolHandler(&quot;file&quot;)</span>
<a href="#l41.318"></a><span id="l41.318" class="difflineplus">+                                     .QueryInterface(Ci.nsIFileProtocolHandler);</span>
<a href="#l41.319"></a><span id="l41.319">         return fileHandler.getURLSpecFromFile(aData);</span>
<a href="#l41.320"></a><span id="l41.320">     }</span>
<a href="#l41.321"></a><span id="l41.321">     return null;</span>
<a href="#l41.322"></a><span id="l41.322" class="difflineminus">-  }</span>
<a href="#l41.323"></a><span id="l41.323" class="difflineplus">+  },</span>
<a href="#l41.324"></a><span id="l41.324"> </span>
<a href="#l41.325"></a><span id="l41.325" class="difflineminus">-}</span>
<a href="#l41.326"></a><span id="l41.326" class="difflineplus">+};</span>
<a href="#l41.327"></a><span id="l41.327"> </span>
<a href="#l41.328"></a><span id="l41.328"> /**</span>
<a href="#l41.329"></a><span id="l41.329">  * nsDragAndDrop - a convenience wrapper for nsTransferable, nsITransferable</span>
<a href="#l41.330"></a><span id="l41.330">  *                 and nsIDragService/nsIDragSession.</span>
<a href="#l41.331"></a><span id="l41.331">  *</span>
<a href="#l41.332"></a><span id="l41.332">  * Use: map the handler functions to the 'ondraggesture', 'ondragover' and</span>
<a href="#l41.333"></a><span id="l41.333">  *   'ondragdrop' event handlers on your XML element, e.g.</span>
<a href="#l41.334"></a><span id="l41.334">  *   &lt;xmlelement ondraggesture=&quot;nsDragAndDrop.startDrag(event, observer);&quot;</span>
<a href="#l41.335"></a><span id="l41.335" class="difflineat">@@ -316,20 +284,18 @@ var transferUtils = {</span>
<a href="#l41.336"></a><span id="l41.336">  *     Object getSupportedFlavours ()    // returns a flavour list so that</span>
<a href="#l41.337"></a><span id="l41.337">  *                                       // nsTransferable can determine</span>
<a href="#l41.338"></a><span id="l41.338">  *                                       // whether or not to accept drop.</span>
<a href="#l41.339"></a><span id="l41.339">  **/</span>
<a href="#l41.340"></a><span id="l41.340"> </span>
<a href="#l41.341"></a><span id="l41.341"> var nsDragAndDrop = {</span>
<a href="#l41.342"></a><span id="l41.342"> </span>
<a href="#l41.343"></a><span id="l41.343">   _mDS: null,</span>
<a href="#l41.344"></a><span id="l41.344" class="difflineminus">-  get mDragService()</span>
<a href="#l41.345"></a><span id="l41.345" class="difflineminus">-    {</span>
<a href="#l41.346"></a><span id="l41.346" class="difflineminus">-      if (!this._mDS)</span>
<a href="#l41.347"></a><span id="l41.347" class="difflineminus">-        {</span>
<a href="#l41.348"></a><span id="l41.348" class="difflineplus">+  get mDragService() {</span>
<a href="#l41.349"></a><span id="l41.349" class="difflineplus">+      if (!this._mDS) {</span>
<a href="#l41.350"></a><span id="l41.350">           const kDSContractID = &quot;@mozilla.org/widget/dragservice;1&quot;;</span>
<a href="#l41.351"></a><span id="l41.351">           const kDSIID = Ci.nsIDragService;</span>
<a href="#l41.352"></a><span id="l41.352">           this._mDS = Cc[kDSContractID].getService(kDSIID);</span>
<a href="#l41.353"></a><span id="l41.353">         }</span>
<a href="#l41.354"></a><span id="l41.354">       return this._mDS;</span>
<a href="#l41.355"></a><span id="l41.355">     },</span>
<a href="#l41.356"></a><span id="l41.356"> </span>
<a href="#l41.357"></a><span id="l41.357">   /**</span>
<a href="#l41.358"></a><span id="l41.358" class="difflineat">@@ -338,45 +304,40 @@ var nsDragAndDrop = {</span>
<a href="#l41.359"></a><span id="l41.359">    * called when a drag on an element is started.</span>
<a href="#l41.360"></a><span id="l41.360">    *</span>
<a href="#l41.361"></a><span id="l41.361">    * @param DOMEvent aEvent</span>
<a href="#l41.362"></a><span id="l41.362">    *        the DOM event fired by the drag init</span>
<a href="#l41.363"></a><span id="l41.363">    * @param Object aDragDropObserver</span>
<a href="#l41.364"></a><span id="l41.364">    *        javascript object of format described above that specifies</span>
<a href="#l41.365"></a><span id="l41.365">    *        the way in which the element responds to drag events.</span>
<a href="#l41.366"></a><span id="l41.366">    **/</span>
<a href="#l41.367"></a><span id="l41.367" class="difflineminus">-  startDrag: function (aEvent, aDragDropObserver)</span>
<a href="#l41.368"></a><span id="l41.368" class="difflineminus">-    {</span>
<a href="#l41.369"></a><span id="l41.369" class="difflineplus">+  startDrag(aEvent, aDragDropObserver) {</span>
<a href="#l41.370"></a><span id="l41.370">       if (!(&quot;onDragStart&quot; in aDragDropObserver))</span>
<a href="#l41.371"></a><span id="l41.371">         return;</span>
<a href="#l41.372"></a><span id="l41.372"> </span>
<a href="#l41.373"></a><span id="l41.373">       const kDSIID = Ci.nsIDragService;</span>
<a href="#l41.374"></a><span id="l41.374">       var dragAction = { action: kDSIID.DRAGDROP_ACTION_COPY + kDSIID.DRAGDROP_ACTION_MOVE + kDSIID.DRAGDROP_ACTION_LINK };</span>
<a href="#l41.375"></a><span id="l41.375"> </span>
<a href="#l41.376"></a><span id="l41.376">       var transferData = { data: null };</span>
<a href="#l41.377"></a><span id="l41.377" class="difflineminus">-      try</span>
<a href="#l41.378"></a><span id="l41.378" class="difflineminus">-        {</span>
<a href="#l41.379"></a><span id="l41.379" class="difflineminus">-          aDragDropObserver.onDragStart(aEvent, transferData, dragAction);</span>
<a href="#l41.380"></a><span id="l41.380" class="difflineminus">-        }</span>
<a href="#l41.381"></a><span id="l41.381" class="difflineminus">-      catch (e)</span>
<a href="#l41.382"></a><span id="l41.382" class="difflineminus">-        {</span>
<a href="#l41.383"></a><span id="l41.383" class="difflineminus">-          return;  // not a draggable item, bail!</span>
<a href="#l41.384"></a><span id="l41.384" class="difflineminus">-        }</span>
<a href="#l41.385"></a><span id="l41.385" class="difflineplus">+      try {</span>
<a href="#l41.386"></a><span id="l41.386" class="difflineplus">+        aDragDropObserver.onDragStart(aEvent, transferData, dragAction);</span>
<a href="#l41.387"></a><span id="l41.387" class="difflineplus">+      } catch (e) {</span>
<a href="#l41.388"></a><span id="l41.388" class="difflineplus">+        return;  // not a draggable item, bail!</span>
<a href="#l41.389"></a><span id="l41.389" class="difflineplus">+      }</span>
<a href="#l41.390"></a><span id="l41.390"> </span>
<a href="#l41.391"></a><span id="l41.391">       if (!transferData.data) return;</span>
<a href="#l41.392"></a><span id="l41.392">       transferData = transferData.data;</span>
<a href="#l41.393"></a><span id="l41.393"> </span>
<a href="#l41.394"></a><span id="l41.394">       var dt = aEvent.dataTransfer;</span>
<a href="#l41.395"></a><span id="l41.395">       var count = 0;</span>
<a href="#l41.396"></a><span id="l41.396">       do {</span>
<a href="#l41.397"></a><span id="l41.397">         var tds = transferData._XferID == &quot;TransferData&quot;</span>
<a href="#l41.398"></a><span id="l41.398">                                          ? transferData</span>
<a href="#l41.399"></a><span id="l41.399" class="difflineminus">-                                         : transferData.dataList[count]</span>
<a href="#l41.400"></a><span id="l41.400" class="difflineminus">-        for (var i = 0; i &lt; tds.dataList.length; ++i)</span>
<a href="#l41.401"></a><span id="l41.401" class="difflineminus">-        {</span>
<a href="#l41.402"></a><span id="l41.402" class="difflineplus">+                                         : transferData.dataList[count];</span>
<a href="#l41.403"></a><span id="l41.403" class="difflineplus">+        for (var i = 0; i &lt; tds.dataList.length; ++i) {</span>
<a href="#l41.404"></a><span id="l41.404">           var currData = tds.dataList[i];</span>
<a href="#l41.405"></a><span id="l41.405">           var currFlavour = currData.flavour.contentType;</span>
<a href="#l41.406"></a><span id="l41.406">           var value = currData.supports;</span>
<a href="#l41.407"></a><span id="l41.407">           if (value instanceof Ci.nsISupportsString)</span>
<a href="#l41.408"></a><span id="l41.408">             value = value.toString();</span>
<a href="#l41.409"></a><span id="l41.409">           dt.mozSetDataAt(currFlavour, value, count);</span>
<a href="#l41.410"></a><span id="l41.410">         }</span>
<a href="#l41.411"></a><span id="l41.411"> </span>
<a href="#l41.412"></a><span id="l41.412" class="difflineat">@@ -399,27 +360,24 @@ var nsDragAndDrop = {</span>
<a href="#l41.413"></a><span id="l41.413">    * called when a drag passes over this element</span>
<a href="#l41.414"></a><span id="l41.414">    *</span>
<a href="#l41.415"></a><span id="l41.415">    * @param DOMEvent aEvent</span>
<a href="#l41.416"></a><span id="l41.416">    *        the DOM event fired by passing over the element</span>
<a href="#l41.417"></a><span id="l41.417">    * @param Object aDragDropObserver</span>
<a href="#l41.418"></a><span id="l41.418">    *        javascript object of format described above that specifies</span>
<a href="#l41.419"></a><span id="l41.419">    *        the way in which the element responds to drag events.</span>
<a href="#l41.420"></a><span id="l41.420">    **/</span>
<a href="#l41.421"></a><span id="l41.421" class="difflineminus">-  dragOver: function (aEvent, aDragDropObserver)</span>
<a href="#l41.422"></a><span id="l41.422" class="difflineminus">-    {</span>
<a href="#l41.423"></a><span id="l41.423" class="difflineplus">+  dragOver(aEvent, aDragDropObserver) {</span>
<a href="#l41.424"></a><span id="l41.424">       if (!(&quot;onDragOver&quot; in aDragDropObserver))</span>
<a href="#l41.425"></a><span id="l41.425">         return;</span>
<a href="#l41.426"></a><span id="l41.426">       if (!this.checkCanDrop(aEvent, aDragDropObserver))</span>
<a href="#l41.427"></a><span id="l41.427">         return;</span>
<a href="#l41.428"></a><span id="l41.428">       var flavourSet = aDragDropObserver.getSupportedFlavours();</span>
<a href="#l41.429"></a><span id="l41.429" class="difflineminus">-      for (var flavour in flavourSet.flavourTable)</span>
<a href="#l41.430"></a><span id="l41.430" class="difflineminus">-        {</span>
<a href="#l41.431"></a><span id="l41.431" class="difflineminus">-          if (this.mDragSession.isDataFlavorSupported(flavour))</span>
<a href="#l41.432"></a><span id="l41.432" class="difflineminus">-            {</span>
<a href="#l41.433"></a><span id="l41.433" class="difflineplus">+      for (var flavour in flavourSet.flavourTable) {</span>
<a href="#l41.434"></a><span id="l41.434" class="difflineplus">+          if (this.mDragSession.isDataFlavorSupported(flavour)) {</span>
<a href="#l41.435"></a><span id="l41.435">               aDragDropObserver.onDragOver(aEvent,</span>
<a href="#l41.436"></a><span id="l41.436">                                            flavourSet.flavourTable[flavour],</span>
<a href="#l41.437"></a><span id="l41.437">                                            this.mDragSession);</span>
<a href="#l41.438"></a><span id="l41.438">               aEvent.stopPropagation();</span>
<a href="#l41.439"></a><span id="l41.439">               aEvent.preventDefault();</span>
<a href="#l41.440"></a><span id="l41.440">               break;</span>
<a href="#l41.441"></a><span id="l41.441">             }</span>
<a href="#l41.442"></a><span id="l41.442">         }</span>
<a href="#l41.443"></a><span id="l41.443" class="difflineat">@@ -433,18 +391,17 @@ var nsDragAndDrop = {</span>
<a href="#l41.444"></a><span id="l41.444">    * called when the user drops on the element</span>
<a href="#l41.445"></a><span id="l41.445">    *</span>
<a href="#l41.446"></a><span id="l41.446">    * @param DOMEvent aEvent</span>
<a href="#l41.447"></a><span id="l41.447">    *        the DOM event fired by the drop</span>
<a href="#l41.448"></a><span id="l41.448">    * @param Object aDragDropObserver</span>
<a href="#l41.449"></a><span id="l41.449">    *        javascript object of format described above that specifies</span>
<a href="#l41.450"></a><span id="l41.450">    *        the way in which the element responds to drag events.</span>
<a href="#l41.451"></a><span id="l41.451">    **/</span>
<a href="#l41.452"></a><span id="l41.452" class="difflineminus">-  drop: function (aEvent, aDragDropObserver)</span>
<a href="#l41.453"></a><span id="l41.453" class="difflineminus">-    {</span>
<a href="#l41.454"></a><span id="l41.454" class="difflineplus">+  drop(aEvent, aDragDropObserver) {</span>
<a href="#l41.455"></a><span id="l41.455">       if (!(&quot;onDrop&quot; in aDragDropObserver))</span>
<a href="#l41.456"></a><span id="l41.456">         return;</span>
<a href="#l41.457"></a><span id="l41.457">       if (!this.checkCanDrop(aEvent, aDragDropObserver))</span>
<a href="#l41.458"></a><span id="l41.458">         return;</span>
<a href="#l41.459"></a><span id="l41.459"> </span>
<a href="#l41.460"></a><span id="l41.460">       var flavourSet = aDragDropObserver.getSupportedFlavours();</span>
<a href="#l41.461"></a><span id="l41.461"> </span>
<a href="#l41.462"></a><span id="l41.462">       var dt = aEvent.dataTransfer;</span>
<a href="#l41.463"></a><span id="l41.463" class="difflineat">@@ -466,17 +423,17 @@ var nsDragAndDrop = {</span>
<a href="#l41.464"></a><span id="l41.464">               var length = (typeof data == &quot;string&quot;) ? data.length : kNonStringDataLength;</span>
<a href="#l41.465"></a><span id="l41.465">               dataArray[i] = FlavourToXfer(data, length, flavourSet.flavourTable[type]);</span>
<a href="#l41.466"></a><span id="l41.466">               break;</span>
<a href="#l41.467"></a><span id="l41.467">             }</span>
<a href="#l41.468"></a><span id="l41.468">           }</span>
<a href="#l41.469"></a><span id="l41.469">         }</span>
<a href="#l41.470"></a><span id="l41.470">       }</span>
<a href="#l41.471"></a><span id="l41.471"> </span>
<a href="#l41.472"></a><span id="l41.472" class="difflineminus">-      var transferData = new TransferDataSet(dataArray)</span>
<a href="#l41.473"></a><span id="l41.473" class="difflineplus">+      var transferData = new TransferDataSet(dataArray);</span>
<a href="#l41.474"></a><span id="l41.474"> </span>
<a href="#l41.475"></a><span id="l41.475">       // hand over to the client to respond to dropped data</span>
<a href="#l41.476"></a><span id="l41.476">       var multiple = &quot;canHandleMultipleItems&quot; in aDragDropObserver &amp;&amp; aDragDropObserver.canHandleMultipleItems;</span>
<a href="#l41.477"></a><span id="l41.477">       var dropData = multiple ? transferData : transferData.first.first;</span>
<a href="#l41.478"></a><span id="l41.478">       aDragDropObserver.onDrop(aEvent, dropData, this.mDragSession);</span>
<a href="#l41.479"></a><span id="l41.479">       aEvent.stopPropagation();</span>
<a href="#l41.480"></a><span id="l41.480">     },</span>
<a href="#l41.481"></a><span id="l41.481"> </span>
<a href="#l41.482"></a><span id="l41.482" class="difflineat">@@ -486,18 +443,17 @@ var nsDragAndDrop = {</span>
<a href="#l41.483"></a><span id="l41.483">    * called when a drag leaves this element</span>
<a href="#l41.484"></a><span id="l41.484">    *</span>
<a href="#l41.485"></a><span id="l41.485">    * @param DOMEvent aEvent</span>
<a href="#l41.486"></a><span id="l41.486">    *        the DOM event fired by leaving the element</span>
<a href="#l41.487"></a><span id="l41.487">    * @param Object aDragDropObserver</span>
<a href="#l41.488"></a><span id="l41.488">    *        javascript object of format described above that specifies</span>
<a href="#l41.489"></a><span id="l41.489">    *        the way in which the element responds to drag events.</span>
<a href="#l41.490"></a><span id="l41.490">    **/</span>
<a href="#l41.491"></a><span id="l41.491" class="difflineminus">-  dragExit: function (aEvent, aDragDropObserver)</span>
<a href="#l41.492"></a><span id="l41.492" class="difflineminus">-    {</span>
<a href="#l41.493"></a><span id="l41.493" class="difflineplus">+  dragExit(aEvent, aDragDropObserver) {</span>
<a href="#l41.494"></a><span id="l41.494">       if (!this.checkCanDrop(aEvent, aDragDropObserver))</span>
<a href="#l41.495"></a><span id="l41.495">         return;</span>
<a href="#l41.496"></a><span id="l41.496">       if (&quot;onDragExit&quot; in aDragDropObserver)</span>
<a href="#l41.497"></a><span id="l41.497">         aDragDropObserver.onDragExit(aEvent, this.mDragSession);</span>
<a href="#l41.498"></a><span id="l41.498">     },</span>
<a href="#l41.499"></a><span id="l41.499"> </span>
<a href="#l41.500"></a><span id="l41.500">   /**</span>
<a href="#l41.501"></a><span id="l41.501">    * void dragEnter (DOMEvent aEvent, Object aDragDropObserver) ;</span>
<a href="#l41.502"></a><span id="l41.502" class="difflineat">@@ -505,18 +461,17 @@ var nsDragAndDrop = {</span>
<a href="#l41.503"></a><span id="l41.503">    * called when a drag enters in this element</span>
<a href="#l41.504"></a><span id="l41.504">    *</span>
<a href="#l41.505"></a><span id="l41.505">    * @param DOMEvent aEvent</span>
<a href="#l41.506"></a><span id="l41.506">    *        the DOM event fired by entering in the element</span>
<a href="#l41.507"></a><span id="l41.507">    * @param Object aDragDropObserver</span>
<a href="#l41.508"></a><span id="l41.508">    *        javascript object of format described above that specifies</span>
<a href="#l41.509"></a><span id="l41.509">    *        the way in which the element responds to drag events.</span>
<a href="#l41.510"></a><span id="l41.510">    **/</span>
<a href="#l41.511"></a><span id="l41.511" class="difflineminus">-  dragEnter: function (aEvent, aDragDropObserver)</span>
<a href="#l41.512"></a><span id="l41.512" class="difflineminus">-    {</span>
<a href="#l41.513"></a><span id="l41.513" class="difflineplus">+  dragEnter(aEvent, aDragDropObserver) {</span>
<a href="#l41.514"></a><span id="l41.514">       if (!this.checkCanDrop(aEvent, aDragDropObserver))</span>
<a href="#l41.515"></a><span id="l41.515">         return;</span>
<a href="#l41.516"></a><span id="l41.516">       if (&quot;onDragEnter&quot; in aDragDropObserver)</span>
<a href="#l41.517"></a><span id="l41.517">         aDragDropObserver.onDragEnter(aEvent, this.mDragSession);</span>
<a href="#l41.518"></a><span id="l41.518">     },</span>
<a href="#l41.519"></a><span id="l41.519"> </span>
<a href="#l41.520"></a><span id="l41.520">   /**</span>
<a href="#l41.521"></a><span id="l41.521">    * Boolean checkCanDrop (DOMEvent aEvent, Object aDragDropObserver) ;</span>
<a href="#l41.522"></a><span id="l41.522" class="difflineat">@@ -525,18 +480,17 @@ var nsDragAndDrop = {</span>
<a href="#l41.523"></a><span id="l41.523">    * returns false if there is no current drag session.</span>
<a href="#l41.524"></a><span id="l41.524">    *</span>
<a href="#l41.525"></a><span id="l41.525">    * @param DOMEvent aEvent</span>
<a href="#l41.526"></a><span id="l41.526">    *        the DOM event fired by the drop</span>
<a href="#l41.527"></a><span id="l41.527">    * @param Object aDragDropObserver</span>
<a href="#l41.528"></a><span id="l41.528">    *        javascript object of format described above that specifies</span>
<a href="#l41.529"></a><span id="l41.529">    *        the way in which the element responds to drag events.</span>
<a href="#l41.530"></a><span id="l41.530">    **/</span>
<a href="#l41.531"></a><span id="l41.531" class="difflineminus">-  checkCanDrop: function (aEvent, aDragDropObserver)</span>
<a href="#l41.532"></a><span id="l41.532" class="difflineminus">-    {</span>
<a href="#l41.533"></a><span id="l41.533" class="difflineplus">+  checkCanDrop(aEvent, aDragDropObserver) {</span>
<a href="#l41.534"></a><span id="l41.534">       if (!this.mDragSession)</span>
<a href="#l41.535"></a><span id="l41.535">         this.mDragSession = this.mDragService.getCurrentSession();</span>
<a href="#l41.536"></a><span id="l41.536">       if (!this.mDragSession)</span>
<a href="#l41.537"></a><span id="l41.537">         return false;</span>
<a href="#l41.538"></a><span id="l41.538">       this.mDragSession.canDrop = this.mDragSession.sourceNode != aEvent.target;</span>
<a href="#l41.539"></a><span id="l41.539">       if (&quot;canDrop&quot; in aDragDropObserver)</span>
<a href="#l41.540"></a><span id="l41.540">         this.mDragSession.canDrop &amp;= aDragDropObserver.canDrop(aEvent, this.mDragSession);</span>
<a href="#l41.541"></a><span id="l41.541">       return true;</span>
<a href="#l41.542"></a><span id="l41.542" class="difflineat">@@ -549,33 +503,30 @@ var nsDragAndDrop = {</span>
<a href="#l41.543"></a><span id="l41.543">    * @param DOMEvent aEvent</span>
<a href="#l41.544"></a><span id="l41.544">    *        the DOM event fired by leaving the element</span>
<a href="#l41.545"></a><span id="l41.545">    * @param Object aDragDropObserver</span>
<a href="#l41.546"></a><span id="l41.546">    *        javascript object of format described above that specifies</span>
<a href="#l41.547"></a><span id="l41.547">    *        the way in which the element responds to drag events.</span>
<a href="#l41.548"></a><span id="l41.548">    * @param String aDraggedText</span>
<a href="#l41.549"></a><span id="l41.549">    *        the text being dragged</span>
<a href="#l41.550"></a><span id="l41.550">    **/</span>
<a href="#l41.551"></a><span id="l41.551" class="difflineminus">-  dragDropSecurityCheck: function (aEvent, aDragSession, aDraggedText)</span>
<a href="#l41.552"></a><span id="l41.552" class="difflineminus">-    {</span>
<a href="#l41.553"></a><span id="l41.553" class="difflineplus">+  dragDropSecurityCheck(aEvent, aDragSession, aDraggedText) {</span>
<a href="#l41.554"></a><span id="l41.554">       // Strip leading and trailing whitespace, then try to create a</span>
<a href="#l41.555"></a><span id="l41.555">       // URI from the dropped string. If that succeeds, we're</span>
<a href="#l41.556"></a><span id="l41.556">       // dropping a URI and we need to do a security check to make</span>
<a href="#l41.557"></a><span id="l41.557">       // sure the source document can load the dropped URI. We don't</span>
<a href="#l41.558"></a><span id="l41.558">       // so much care about creating the real URI here</span>
<a href="#l41.559"></a><span id="l41.559">       // (i.e. encoding differences etc don't matter), we just want</span>
<a href="#l41.560"></a><span id="l41.560">       // to know if aDraggedText really is a URI.</span>
<a href="#l41.561"></a><span id="l41.561"> </span>
<a href="#l41.562"></a><span id="l41.562" class="difflineminus">-      aDraggedText = aDraggedText.replace(/^\s*|\s*$/g, '');</span>
<a href="#l41.563"></a><span id="l41.563" class="difflineplus">+      aDraggedText = aDraggedText.replace(/^\s*|\s*$/g, &quot;&quot;);</span>
<a href="#l41.564"></a><span id="l41.564"> </span>
<a href="#l41.565"></a><span id="l41.565">       var uri;</span>
<a href="#l41.566"></a><span id="l41.566" class="difflineminus">-      var ioService = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l41.567"></a><span id="l41.567" class="difflineminus">-                        .getService(Ci.nsIIOService);</span>
<a href="#l41.568"></a><span id="l41.568">       try {</span>
<a href="#l41.569"></a><span id="l41.569" class="difflineminus">-        uri = ioService.newURI(aDraggedText);</span>
<a href="#l41.570"></a><span id="l41.570" class="difflineplus">+        uri = Services.io.newURI(aDraggedText);</span>
<a href="#l41.571"></a><span id="l41.571">       } catch (e) {</span>
<a href="#l41.572"></a><span id="l41.572">       }</span>
<a href="#l41.573"></a><span id="l41.573"> </span>
<a href="#l41.574"></a><span id="l41.574">       if (!uri)</span>
<a href="#l41.575"></a><span id="l41.575">         return;</span>
<a href="#l41.576"></a><span id="l41.576"> </span>
<a href="#l41.577"></a><span id="l41.577">       // aDraggedText is a URI, do the security check.</span>
<a href="#l41.578"></a><span id="l41.578">       const nsIScriptSecurityManager = Ci.nsIScriptSecurityManager;</span>
<a href="#l41.579"></a><span id="l41.579" class="difflineat">@@ -584,22 +535,22 @@ var nsDragAndDrop = {</span>
<a href="#l41.580"></a><span id="l41.580"> </span>
<a href="#l41.581"></a><span id="l41.581">       if (!aDragSession)</span>
<a href="#l41.582"></a><span id="l41.582">         aDragSession = this.mDragService.getCurrentSession();</span>
<a href="#l41.583"></a><span id="l41.583"> </span>
<a href="#l41.584"></a><span id="l41.584">       var sourceDoc = aDragSession.sourceDocument;</span>
<a href="#l41.585"></a><span id="l41.585">       // Use &quot;file:///&quot; as the default sourceURI so that drops of file:// URIs</span>
<a href="#l41.586"></a><span id="l41.586">       // are always allowed.</span>
<a href="#l41.587"></a><span id="l41.587">       var principal = sourceDoc ? sourceDoc.nodePrincipal</span>
<a href="#l41.588"></a><span id="l41.588" class="difflineminus">-                                : secMan.createCodebasePrincipal(ioService.newURI(&quot;file:///&quot;), {});</span>
<a href="#l41.589"></a><span id="l41.589" class="difflineplus">+                                : secMan.createCodebasePrincipal(Services.io.newURI(&quot;file:///&quot;), {});</span>
<a href="#l41.590"></a><span id="l41.590"> </span>
<a href="#l41.591"></a><span id="l41.591">       try {</span>
<a href="#l41.592"></a><span id="l41.592">         secMan.checkLoadURIStrWithPrincipal(principal, aDraggedText,</span>
<a href="#l41.593"></a><span id="l41.593">                                             nsIScriptSecurityManager.STANDARD);</span>
<a href="#l41.594"></a><span id="l41.594">       } catch (e) {</span>
<a href="#l41.595"></a><span id="l41.595">         // Stop event propagation right here.</span>
<a href="#l41.596"></a><span id="l41.596">         aEvent.stopPropagation();</span>
<a href="#l41.597"></a><span id="l41.597"> </span>
<a href="#l41.598"></a><span id="l41.598">         throw &quot;Drop of &quot; + aDraggedText + &quot; denied.&quot;;</span>
<a href="#l41.599"></a><span id="l41.599">       }</span>
<a href="#l41.600"></a><span id="l41.600" class="difflineminus">-    }</span>
<a href="#l41.601"></a><span id="l41.601" class="difflineplus">+    },</span>
<a href="#l41.602"></a><span id="l41.602"> };</span>
<a href="#l41.603"></a><span id="l41.603"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/mail/base/content/phishingDetector.js</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/mail/base/content/phishingDetector.js</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -12,27 +12,25 @@ var kPhishingWithIPAddress = 1;</span>
<a href="#l42.4"></a><span id="l42.4"> var kPhishingWithMismatchedHosts = 2;</span>
<a href="#l42.5"></a><span id="l42.5"> </span>
<a href="#l42.6"></a><span id="l42.6"> </span>
<a href="#l42.7"></a><span id="l42.7"> var gPhishingDetector = {</span>
<a href="#l42.8"></a><span id="l42.8">   mCheckForIPAddresses: true,</span>
<a href="#l42.9"></a><span id="l42.9">   mCheckForMismatchedHosts: true,</span>
<a href="#l42.10"></a><span id="l42.10">   mDisallowFormActions: true,</span>
<a href="#l42.11"></a><span id="l42.11"> </span>
<a href="#l42.12"></a><span id="l42.12" class="difflineminus">-  shutdown: function()</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineminus">-  {</span>
<a href="#l42.14"></a><span id="l42.14" class="difflineplus">+  shutdown() {</span>
<a href="#l42.15"></a><span id="l42.15">   },</span>
<a href="#l42.16"></a><span id="l42.16"> </span>
<a href="#l42.17"></a><span id="l42.17">   /**</span>
<a href="#l42.18"></a><span id="l42.18">    * Initialize the phishing warden.</span>
<a href="#l42.19"></a><span id="l42.19">    * Initialize the black and white list url tables.</span>
<a href="#l42.20"></a><span id="l42.20">    * Update the local tables if necessary.</span>
<a href="#l42.21"></a><span id="l42.21">    */</span>
<a href="#l42.22"></a><span id="l42.22" class="difflineminus">-  init: function()</span>
<a href="#l42.23"></a><span id="l42.23" class="difflineminus">-  {</span>
<a href="#l42.24"></a><span id="l42.24" class="difflineplus">+  init() {</span>
<a href="#l42.25"></a><span id="l42.25">     ChromeUtils.import(&quot;resource:///modules/hostnameUtils.jsm&quot;, this);</span>
<a href="#l42.26"></a><span id="l42.26"> </span>
<a href="#l42.27"></a><span id="l42.27">     this.mCheckForIPAddresses = Services.prefs.getBoolPref(&quot;mail.phishing.detection.ipaddresses&quot;);</span>
<a href="#l42.28"></a><span id="l42.28">     this.mCheckForMismatchedHosts = Services.prefs.getBoolPref(&quot;mail.phishing.detection.mismatched_hosts&quot;);</span>
<a href="#l42.29"></a><span id="l42.29">     this.mDisallowFormActions = Services.prefs.getBoolPref(&quot;mail.phishing.detection.disallow_form_actions&quot;);</span>
<a href="#l42.30"></a><span id="l42.30">   },</span>
<a href="#l42.31"></a><span id="l42.31"> </span>
<a href="#l42.32"></a><span id="l42.32">   /**</span>
<a href="#l42.33"></a><span id="l42.33" class="difflineat">@@ -40,126 +38,117 @@ var gPhishingDetector = {</span>
<a href="#l42.34"></a><span id="l42.34">    * phishing URLs. Also checks for forms with action URLs, which are disallowed.</span>
<a href="#l42.35"></a><span id="l42.35">    * Assumes the message has finished loading in the message pane (i.e. OnMsgParsed has fired).</span>
<a href="#l42.36"></a><span id="l42.36">    *</span>
<a href="#l42.37"></a><span id="l42.37">    * @param aUrl nsIURI for the message being analyzed.</span>
<a href="#l42.38"></a><span id="l42.38">    *</span>
<a href="#l42.39"></a><span id="l42.39">    * @return asynchronously calls gMessageNotificationBar.setPhishingMsg if the message</span>
<a href="#l42.40"></a><span id="l42.40">    *         is identified as a scam.</span>
<a href="#l42.41"></a><span id="l42.41">    */</span>
<a href="#l42.42"></a><span id="l42.42" class="difflineminus">-  analyzeMsgForPhishingURLs: function (aUrl)</span>
<a href="#l42.43"></a><span id="l42.43" class="difflineminus">-  {</span>
<a href="#l42.44"></a><span id="l42.44" class="difflineplus">+  analyzeMsgForPhishingURLs(aUrl) {</span>
<a href="#l42.45"></a><span id="l42.45">     if (!aUrl || !Services.prefs.getBoolPref(&quot;mail.phishing.detection.enabled&quot;))</span>
<a href="#l42.46"></a><span id="l42.46">       return;</span>
<a href="#l42.47"></a><span id="l42.47"> </span>
<a href="#l42.48"></a><span id="l42.48">     try {</span>
<a href="#l42.49"></a><span id="l42.49">       // nsIMsgMailNewsUrl.folder can throw an NS_ERROR_FAILURE, especially if</span>
<a href="#l42.50"></a><span id="l42.50">       // we are opening an .eml file.</span>
<a href="#l42.51"></a><span id="l42.51">       var folder = aUrl.folder;</span>
<a href="#l42.52"></a><span id="l42.52"> </span>
<a href="#l42.53"></a><span id="l42.53">       // Ignore nntp and RSS messages.</span>
<a href="#l42.54"></a><span id="l42.54" class="difflineminus">-      if (folder.server.type == 'nntp' || folder.server.type == 'rss')</span>
<a href="#l42.55"></a><span id="l42.55" class="difflineplus">+      if (folder.server.type == &quot;nntp&quot; || folder.server.type == &quot;rss&quot;)</span>
<a href="#l42.56"></a><span id="l42.56">         return;</span>
<a href="#l42.57"></a><span id="l42.57"> </span>
<a href="#l42.58"></a><span id="l42.58">       // Also ignore messages in Sent/Drafts/Templates/Outbox.</span>
<a href="#l42.59"></a><span id="l42.59">       let outgoingFlags = Ci.nsMsgFolderFlags.SentMail | Ci.nsMsgFolderFlags.Drafts |</span>
<a href="#l42.60"></a><span id="l42.60">                           Ci.nsMsgFolderFlags.Templates | Ci.nsMsgFolderFlags.Queue;</span>
<a href="#l42.61"></a><span id="l42.61">       if (folder.isSpecialFolder(outgoingFlags, true))</span>
<a href="#l42.62"></a><span id="l42.62">         return;</span>
<a href="#l42.63"></a><span id="l42.63"> </span>
<a href="#l42.64"></a><span id="l42.64">     } catch (ex) {</span>
<a href="#l42.65"></a><span id="l42.65">         if (ex.result != Cr.NS_ERROR_FAILURE)</span>
<a href="#l42.66"></a><span id="l42.66">           throw ex;</span>
<a href="#l42.67"></a><span id="l42.67">     }</span>
<a href="#l42.68"></a><span id="l42.68"> </span>
<a href="#l42.69"></a><span id="l42.69">     // extract the link nodes in the message and analyze them, looking for suspicious URLs...</span>
<a href="#l42.70"></a><span id="l42.70" class="difflineminus">-    var linkNodes = document.getElementById('messagepane').contentDocument.links;</span>
<a href="#l42.71"></a><span id="l42.71" class="difflineplus">+    var linkNodes = document.getElementById(&quot;messagepane&quot;).contentDocument.links;</span>
<a href="#l42.72"></a><span id="l42.72">     for (var index = 0; index &lt; linkNodes.length; index++)</span>
<a href="#l42.73"></a><span id="l42.73">       this.analyzeUrl(linkNodes[index].href, gatherTextUnder(linkNodes[index]));</span>
<a href="#l42.74"></a><span id="l42.74"> </span>
<a href="#l42.75"></a><span id="l42.75">     // extract the action urls associated with any form elements in the message and analyze them.</span>
<a href="#l42.76"></a><span id="l42.76" class="difflineminus">-    let formNodes = document.getElementById('messagepane').contentDocument.querySelectorAll(&quot;form[action]&quot;);</span>
<a href="#l42.77"></a><span id="l42.77" class="difflineplus">+    let formNodes = document.getElementById(&quot;messagepane&quot;).contentDocument.querySelectorAll(&quot;form[action]&quot;);</span>
<a href="#l42.78"></a><span id="l42.78"> </span>
<a href="#l42.79"></a><span id="l42.79" class="difflineminus">-    if (this.mDisallowFormActions &amp;&amp; formNodes.length &gt; 0)</span>
<a href="#l42.80"></a><span id="l42.80" class="difflineminus">-    {</span>
<a href="#l42.81"></a><span id="l42.81" class="difflineplus">+    if (this.mDisallowFormActions &amp;&amp; formNodes.length &gt; 0) {</span>
<a href="#l42.82"></a><span id="l42.82">       gMessageNotificationBar.setPhishingMsg();</span>
<a href="#l42.83"></a><span id="l42.83" class="difflineminus">-    }</span>
<a href="#l42.84"></a><span id="l42.84" class="difflineminus">-    else</span>
<a href="#l42.85"></a><span id="l42.85" class="difflineminus">-    {</span>
<a href="#l42.86"></a><span id="l42.86" class="difflineminus">-      for (index = 0; index &lt; formNodes.length; index++)</span>
<a href="#l42.87"></a><span id="l42.87" class="difflineminus">-      {</span>
<a href="#l42.88"></a><span id="l42.88" class="difflineplus">+    } else {</span>
<a href="#l42.89"></a><span id="l42.89" class="difflineplus">+      for (index = 0; index &lt; formNodes.length; index++) {</span>
<a href="#l42.90"></a><span id="l42.90">         this.analyzeUrl(formNodes[index].action);</span>
<a href="#l42.91"></a><span id="l42.91">       }</span>
<a href="#l42.92"></a><span id="l42.92">     }</span>
<a href="#l42.93"></a><span id="l42.93">   },</span>
<a href="#l42.94"></a><span id="l42.94"> </span>
<a href="#l42.95"></a><span id="l42.95">   /**</span>
<a href="#l42.96"></a><span id="l42.96">    * Analyze the url contained in aLinkNode for phishing attacks. If a phishing URL is found,</span>
<a href="#l42.97"></a><span id="l42.97">    *</span>
<a href="#l42.98"></a><span id="l42.98">    * @param aHref the url to be analyzed</span>
<a href="#l42.99"></a><span id="l42.99">    * @param aLinkText (optional) user visible link text associated with aHref in case</span>
<a href="#l42.100"></a><span id="l42.100">    *        we are dealing with a link node.</span>
<a href="#l42.101"></a><span id="l42.101">    * @return asynchronously calls gMessageNotificationBar.setPhishingMsg if the link node</span>
<a href="#l42.102"></a><span id="l42.102">    *         contains a phishing URL.</span>
<a href="#l42.103"></a><span id="l42.103">    */</span>
<a href="#l42.104"></a><span id="l42.104" class="difflineminus">-  analyzeUrl: function (aUrl, aLinkText)</span>
<a href="#l42.105"></a><span id="l42.105" class="difflineminus">-  {</span>
<a href="#l42.106"></a><span id="l42.106" class="difflineplus">+  analyzeUrl(aUrl, aLinkText) {</span>
<a href="#l42.107"></a><span id="l42.107">     if (!aUrl)</span>
<a href="#l42.108"></a><span id="l42.108">       return;</span>
<a href="#l42.109"></a><span id="l42.109"> </span>
<a href="#l42.110"></a><span id="l42.110">     var hrefURL;</span>
<a href="#l42.111"></a><span id="l42.111">     // make sure relative link urls don't make us bail out</span>
<a href="#l42.112"></a><span id="l42.112">     try {</span>
<a href="#l42.113"></a><span id="l42.113">       hrefURL = Services.io.newURI(aUrl);</span>
<a href="#l42.114"></a><span id="l42.114" class="difflineminus">-    } catch(ex) { return; }</span>
<a href="#l42.115"></a><span id="l42.115" class="difflineplus">+    } catch (ex) {</span>
<a href="#l42.116"></a><span id="l42.116" class="difflineplus">+      return;</span>
<a href="#l42.117"></a><span id="l42.117" class="difflineplus">+    }</span>
<a href="#l42.118"></a><span id="l42.118"> </span>
<a href="#l42.119"></a><span id="l42.119">     // only check for phishing urls if the url is an http or https link.</span>
<a href="#l42.120"></a><span id="l42.120">     // this prevents us from flagging imap and other internally handled urls</span>
<a href="#l42.121"></a><span id="l42.121" class="difflineminus">-    if (hrefURL.schemeIs('http') || hrefURL.schemeIs('https'))</span>
<a href="#l42.122"></a><span id="l42.122" class="difflineminus">-    {</span>
<a href="#l42.123"></a><span id="l42.123" class="difflineplus">+    if (hrefURL.schemeIs(&quot;http&quot;) || hrefURL.schemeIs(&quot;https&quot;)) {</span>
<a href="#l42.124"></a><span id="l42.124">       // The link is not suspicious if the visible text is the same as the URL,</span>
<a href="#l42.125"></a><span id="l42.125">       // even if the URL is an IP address. URLs are commonly surrounded by</span>
<a href="#l42.126"></a><span id="l42.126">       // &lt; &gt; or &quot;&quot; (RFC2396E) - so strip those from the link text before comparing.</span>
<a href="#l42.127"></a><span id="l42.127">       if (aLinkText)</span>
<a href="#l42.128"></a><span id="l42.128">         aLinkText = aLinkText.replace(/^&lt;(.+)&gt;$|^&quot;(.+)&quot;$/, &quot;$1$2&quot;);</span>
<a href="#l42.129"></a><span id="l42.129"> </span>
<a href="#l42.130"></a><span id="l42.130">       var failsStaticTests = false;</span>
<a href="#l42.131"></a><span id="l42.131">       // If the link text and url differs by something other than a trailing</span>
<a href="#l42.132"></a><span id="l42.132">       // slash, do some further checks.</span>
<a href="#l42.133"></a><span id="l42.133">       if (aLinkText &amp;&amp; aLinkText != aUrl &amp;&amp;</span>
<a href="#l42.134"></a><span id="l42.134" class="difflineminus">-          aLinkText.replace(/\/+$/, &quot;&quot;) != aUrl.replace(/\/+$/, &quot;&quot;))</span>
<a href="#l42.135"></a><span id="l42.135" class="difflineminus">-      {</span>
<a href="#l42.136"></a><span id="l42.136" class="difflineminus">-        if (this.mCheckForIPAddresses)</span>
<a href="#l42.137"></a><span id="l42.137" class="difflineminus">-        {</span>
<a href="#l42.138"></a><span id="l42.138" class="difflineplus">+          aLinkText.replace(/\/+$/, &quot;&quot;) != aUrl.replace(/\/+$/, &quot;&quot;)) {</span>
<a href="#l42.139"></a><span id="l42.139" class="difflineplus">+        if (this.mCheckForIPAddresses) {</span>
<a href="#l42.140"></a><span id="l42.140">           let unobscuredHostNameValue = this.isLegalIPAddress(hrefURL.host, true);</span>
<a href="#l42.141"></a><span id="l42.141">           if (unobscuredHostNameValue)</span>
<a href="#l42.142"></a><span id="l42.142">             failsStaticTests = !this.isLegalLocalIPAddress(unobscuredHostNameValue);</span>
<a href="#l42.143"></a><span id="l42.143">         }</span>
<a href="#l42.144"></a><span id="l42.144"> </span>
<a href="#l42.145"></a><span id="l42.145" class="difflineminus">-        if (!failsStaticTests &amp;&amp; this.mCheckForMismatchedHosts)</span>
<a href="#l42.146"></a><span id="l42.146" class="difflineminus">-        {</span>
<a href="#l42.147"></a><span id="l42.147" class="difflineplus">+        if (!failsStaticTests &amp;&amp; this.mCheckForMismatchedHosts) {</span>
<a href="#l42.148"></a><span id="l42.148">           failsStaticTests = (aLinkText &amp;&amp;</span>
<a href="#l42.149"></a><span id="l42.149" class="difflineminus">-            this.misMatchedHostWithLinkText(hrefURL, aLinkText))</span>
<a href="#l42.150"></a><span id="l42.150" class="difflineplus">+            this.misMatchedHostWithLinkText(hrefURL, aLinkText));</span>
<a href="#l42.151"></a><span id="l42.151">         }</span>
<a href="#l42.152"></a><span id="l42.152">       }</span>
<a href="#l42.153"></a><span id="l42.153">       // We don't use dynamic checks anymore. The old implementation was removed</span>
<a href="#l42.154"></a><span id="l42.154">       // in bug bug 1085382. Using the toolkit safebrowsing is bug 778611.</span>
<a href="#l42.155"></a><span id="l42.155">       if (failsStaticTests) {</span>
<a href="#l42.156"></a><span id="l42.156">         gMessageNotificationBar.setPhishingMsg();</span>
<a href="#l42.157"></a><span id="l42.157">       }</span>
<a href="#l42.158"></a><span id="l42.158">     }</span>
<a href="#l42.159"></a><span id="l42.159">   },</span>
<a href="#l42.160"></a><span id="l42.160"> </span>
<a href="#l42.161"></a><span id="l42.161">   /**</span>
<a href="#l42.162"></a><span id="l42.162">    * Opens the default browser to a page where the user can submit the given url</span>
<a href="#l42.163"></a><span id="l42.163">    * as a phish.</span>
<a href="#l42.164"></a><span id="l42.164">    * @param aPhishingURL the url we want to report back as a phishing attack</span>
<a href="#l42.165"></a><span id="l42.165">    */</span>
<a href="#l42.166"></a><span id="l42.166" class="difflineminus">-   reportPhishingURL: function(aPhishingURL)</span>
<a href="#l42.167"></a><span id="l42.167" class="difflineminus">-   {</span>
<a href="#l42.168"></a><span id="l42.168" class="difflineplus">+   reportPhishingURL(aPhishingURL) {</span>
<a href="#l42.169"></a><span id="l42.169">      let reportUrl = Services.urlFormatter.formatURLPref(</span>
<a href="#l42.170"></a><span id="l42.170">        &quot;browser.safebrowsing.reportPhishURL&quot;);</span>
<a href="#l42.171"></a><span id="l42.171">      reportUrl += &quot;&amp;url=&quot; + encodeURIComponent(aPhishingURL);</span>
<a href="#l42.172"></a><span id="l42.172"> </span>
<a href="#l42.173"></a><span id="l42.173">      let uri = Services.io.newURI(reportUrl);</span>
<a href="#l42.174"></a><span id="l42.174">      let protocolSvc = Cc[&quot;@mozilla.org/uriloader/external-protocol-service;1&quot;]</span>
<a href="#l42.175"></a><span id="l42.175">                        .getService(Ci.nsIExternalProtocolService);</span>
<a href="#l42.176"></a><span id="l42.176">      protocolSvc.loadURI(uri);</span>
<a href="#l42.177"></a><span id="l42.177" class="difflineat">@@ -168,25 +157,23 @@ var gPhishingDetector = {</span>
<a href="#l42.178"></a><span id="l42.178">   /**</span>
<a href="#l42.179"></a><span id="l42.179">    * Private helper method to determine if the link node contains a user visible</span>
<a href="#l42.180"></a><span id="l42.180">    * url with a host name that differs from the actual href the user would get</span>
<a href="#l42.181"></a><span id="l42.181">    * taken to.</span>
<a href="#l42.182"></a><span id="l42.182">    * i.e. &lt;a href=&quot;http://myevilsite.com&quot;&gt;http://mozilla.org&lt;/a&gt;</span>
<a href="#l42.183"></a><span id="l42.183">    *</span>
<a href="#l42.184"></a><span id="l42.184">    * @return true if aHrefURL.host does NOT match the host of the link node text</span>
<a href="#l42.185"></a><span id="l42.185">    */</span>
<a href="#l42.186"></a><span id="l42.186" class="difflineminus">-  misMatchedHostWithLinkText: function(aHrefURL, aLinkNodeText)</span>
<a href="#l42.187"></a><span id="l42.187" class="difflineminus">-  {</span>
<a href="#l42.188"></a><span id="l42.188" class="difflineplus">+  misMatchedHostWithLinkText(aHrefURL, aLinkNodeText) {</span>
<a href="#l42.189"></a><span id="l42.189">     // gatherTextUnder puts a space between each piece of text it gathers,</span>
<a href="#l42.190"></a><span id="l42.190">     // so strip the spaces out (see bug 326082 for details).</span>
<a href="#l42.191"></a><span id="l42.191">     aLinkNodeText = aLinkNodeText.replace(/ /g, &quot;&quot;);</span>
<a href="#l42.192"></a><span id="l42.192"> </span>
<a href="#l42.193"></a><span id="l42.193">     // Only worry about http: and https: urls.</span>
<a href="#l42.194"></a><span id="l42.194" class="difflineminus">-    if (/^https?:/.test(aLinkNodeText))</span>
<a href="#l42.195"></a><span id="l42.195" class="difflineminus">-    {</span>
<a href="#l42.196"></a><span id="l42.196" class="difflineplus">+    if (/^https?:/.test(aLinkNodeText)) {</span>
<a href="#l42.197"></a><span id="l42.197">       let linkTextURI = Services.io.newURI(aLinkNodeText);</span>
<a href="#l42.198"></a><span id="l42.198"> </span>
<a href="#l42.199"></a><span id="l42.199">       // Compare the base domain of the href and the link text.</span>
<a href="#l42.200"></a><span id="l42.200">       try {</span>
<a href="#l42.201"></a><span id="l42.201">         return Services.eTLD.getBaseDomain(aHrefURL) !=</span>
<a href="#l42.202"></a><span id="l42.202">                Services.eTLD.getBaseDomain(linkTextURI);</span>
<a href="#l42.203"></a><span id="l42.203">       } catch (e) {</span>
<a href="#l42.204"></a><span id="l42.204">         // If we throw above, one of the URIs probably has no TLD (e.g.</span>
<a href="#l42.205"></a><span id="l42.205" class="difflineat">@@ -201,31 +188,31 @@ var gPhishingDetector = {</span>
<a href="#l42.206"></a><span id="l42.206">   /**</span>
<a href="#l42.207"></a><span id="l42.207">    * If the current message has been identified as an email scam, prompts the user with a warning</span>
<a href="#l42.208"></a><span id="l42.208">    * before allowing the link click to be processed. The warning prompt includes the unobscured host name</span>
<a href="#l42.209"></a><span id="l42.209">    * of the http(s) url the user clicked on.</span>
<a href="#l42.210"></a><span id="l42.210">    *</span>
<a href="#l42.211"></a><span id="l42.211">    * @param aUrl the url</span>
<a href="#l42.212"></a><span id="l42.212">    * @return true if the link should be allowed to load</span>
<a href="#l42.213"></a><span id="l42.213">    */</span>
<a href="#l42.214"></a><span id="l42.214" class="difflineminus">-  warnOnSuspiciousLinkClick: function(aUrl)</span>
<a href="#l42.215"></a><span id="l42.215" class="difflineminus">-  {</span>
<a href="#l42.216"></a><span id="l42.216" class="difflineplus">+  warnOnSuspiciousLinkClick(aUrl) {</span>
<a href="#l42.217"></a><span id="l42.217">     // If the loaded message has *not* been flagged as a scam...</span>
<a href="#l42.218"></a><span id="l42.218">     if (!gMessageNotificationBar.isShowingPhishingNotification())</span>
<a href="#l42.219"></a><span id="l42.219">       return true; // ...allow the link to load.</span>
<a href="#l42.220"></a><span id="l42.220"> </span>
<a href="#l42.221"></a><span id="l42.221">     var hrefURL;</span>
<a href="#l42.222"></a><span id="l42.222">     // make sure relative link urls don't make us bail out</span>
<a href="#l42.223"></a><span id="l42.223">     try {</span>
<a href="#l42.224"></a><span id="l42.224">       hrefURL = Services.io.newURI(aUrl);</span>
<a href="#l42.225"></a><span id="l42.225" class="difflineminus">-    } catch(ex) { return false; }</span>
<a href="#l42.226"></a><span id="l42.226" class="difflineplus">+    } catch (ex) {</span>
<a href="#l42.227"></a><span id="l42.227" class="difflineplus">+      return false;</span>
<a href="#l42.228"></a><span id="l42.228" class="difflineplus">+    }</span>
<a href="#l42.229"></a><span id="l42.229"> </span>
<a href="#l42.230"></a><span id="l42.230">     // only prompt for http and https urls</span>
<a href="#l42.231"></a><span id="l42.231" class="difflineminus">-    if (hrefURL.schemeIs('http') || hrefURL.schemeIs('https'))</span>
<a href="#l42.232"></a><span id="l42.232" class="difflineminus">-    {</span>
<a href="#l42.233"></a><span id="l42.233" class="difflineplus">+    if (hrefURL.schemeIs(&quot;http&quot;) || hrefURL.schemeIs(&quot;https&quot;)) {</span>
<a href="#l42.234"></a><span id="l42.234">       // unobscure the host name in case it's an encoded ip address..</span>
<a href="#l42.235"></a><span id="l42.235">       let unobscuredHostNameValue = this.isLegalIPAddress(hrefURL.host, true)</span>
<a href="#l42.236"></a><span id="l42.236">         || hrefURL.host;</span>
<a href="#l42.237"></a><span id="l42.237"> </span>
<a href="#l42.238"></a><span id="l42.238">       var brandShortName = document.getElementById(&quot;bundle_brand&quot;)</span>
<a href="#l42.239"></a><span id="l42.239">                                    .getString(&quot;brandShortName&quot;);</span>
<a href="#l42.240"></a><span id="l42.240">       var bundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l42.241"></a><span id="l42.241">       var titleMsg = bundle.getString(&quot;confirmPhishingTitle&quot;);</span>
<a href="#l42.242"></a><span id="l42.242" class="difflineat">@@ -235,10 +222,10 @@ var gPhishingDetector = {</span>
<a href="#l42.243"></a><span id="l42.243">       const nsIPS = Ci.nsIPromptService;</span>
<a href="#l42.244"></a><span id="l42.244">       return !Services.prompt.confirmEx(window, titleMsg, dialogMsg,</span>
<a href="#l42.245"></a><span id="l42.245">                                         nsIPS.STD_YES_NO_BUTTONS +</span>
<a href="#l42.246"></a><span id="l42.246">                                         nsIPS.BUTTON_POS_1_DEFAULT,</span>
<a href="#l42.247"></a><span id="l42.247">                                         &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, {}); /* the yes button is in position 0 */</span>
<a href="#l42.248"></a><span id="l42.248">     }</span>
<a href="#l42.249"></a><span id="l42.249"> </span>
<a href="#l42.250"></a><span id="l42.250">     return true; // allow the link to load</span>
<a href="#l42.251"></a><span id="l42.251" class="difflineminus">-  }</span>
<a href="#l42.252"></a><span id="l42.252" class="difflineplus">+  },</span>
<a href="#l42.253"></a><span id="l42.253"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/mail/base/content/plugins.js</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/mail/base/content/plugins.js</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -12,18 +12,17 @@ ChromeUtils.import(&quot;resource://gre/modul</span>
<a href="#l43.4"></a><span id="l43.4"> ChromeUtils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;);</span>
<a href="#l43.5"></a><span id="l43.5"> </span>
<a href="#l43.6"></a><span id="l43.6"> if (AppConstants.MOZ_CRASHREPORTER) {</span>
<a href="#l43.7"></a><span id="l43.7">   XPCOMUtils.defineLazyServiceGetter(this, &quot;gCrashReporter&quot;,</span>
<a href="#l43.8"></a><span id="l43.8">                                      &quot;@mozilla.org/xre/app-info;1&quot;,</span>
<a href="#l43.9"></a><span id="l43.9">                                      &quot;nsICrashReporter&quot;);</span>
<a href="#l43.10"></a><span id="l43.10"> }</span>
<a href="#l43.11"></a><span id="l43.11"> </span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-function getPluginInfo(pluginElement)</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineminus">-{</span>
<a href="#l43.14"></a><span id="l43.14" class="difflineplus">+function getPluginInfo(pluginElement) {</span>
<a href="#l43.15"></a><span id="l43.15">   var tagMimetype;</span>
<a href="#l43.16"></a><span id="l43.16">   var pluginsPage;</span>
<a href="#l43.17"></a><span id="l43.17">   if (pluginElement instanceof HTMLAppletElement) {</span>
<a href="#l43.18"></a><span id="l43.18">     tagMimetype = &quot;application/x-java-vm&quot;;</span>
<a href="#l43.19"></a><span id="l43.19">   } else {</span>
<a href="#l43.20"></a><span id="l43.20">     if (pluginElement instanceof HTMLObjectElement) {</span>
<a href="#l43.21"></a><span id="l43.21">       pluginsPage = pluginElement.getAttribute(&quot;codebase&quot;);</span>
<a href="#l43.22"></a><span id="l43.22">     } else {</span>
<a href="#l43.23"></a><span id="l43.23" class="difflineat">@@ -44,84 +43,84 @@ function getPluginInfo(pluginElement)</span>
<a href="#l43.24"></a><span id="l43.24">     tagMimetype = pluginElement.QueryInterface(Ci.nsIObjectLoadingContent)</span>
<a href="#l43.25"></a><span id="l43.25">                  .actualType;</span>
<a href="#l43.26"></a><span id="l43.26"> </span>
<a href="#l43.27"></a><span id="l43.27">     if (tagMimetype == &quot;&quot;) {</span>
<a href="#l43.28"></a><span id="l43.28">       tagMimetype = pluginElement.type;</span>
<a href="#l43.29"></a><span id="l43.29">     }</span>
<a href="#l43.30"></a><span id="l43.30">   }</span>
<a href="#l43.31"></a><span id="l43.31"> </span>
<a href="#l43.32"></a><span id="l43.32" class="difflineminus">-  return {mimetype: tagMimetype, pluginsPage: pluginsPage};</span>
<a href="#l43.33"></a><span id="l43.33" class="difflineplus">+  return {mimetype: tagMimetype, pluginsPage};</span>
<a href="#l43.34"></a><span id="l43.34"> }</span>
<a href="#l43.35"></a><span id="l43.35"> </span>
<a href="#l43.36"></a><span id="l43.36"> /**</span>
<a href="#l43.37"></a><span id="l43.37">  * Format a URL</span>
<a href="#l43.38"></a><span id="l43.38">  * eg:</span>
<a href="#l43.39"></a><span id="l43.39">  * echo formatURL(&quot;https://addons.mozilla.org/%LOCALE%/%APP%/%VERSION%/&quot;);</span>
<a href="#l43.40"></a><span id="l43.40">  * &gt; https://addons.mozilla.org/en-US/firefox/3.0a1/</span>
<a href="#l43.41"></a><span id="l43.41">  *</span>
<a href="#l43.42"></a><span id="l43.42">  * Currently supported built-ins are LOCALE, APP, and any value from nsIXULAppInfo, uppercased.</span>
<a href="#l43.43"></a><span id="l43.43">  */</span>
<a href="#l43.44"></a><span id="l43.44"> function formatURL(aFormat, aIsPref) {</span>
<a href="#l43.45"></a><span id="l43.45">   var formatter = Services.urlFormatter;</span>
<a href="#l43.46"></a><span id="l43.46">   return aIsPref ? formatter.formatURLPref(aFormat) : formatter.formatURL(aFormat);</span>
<a href="#l43.47"></a><span id="l43.47"> }</span>
<a href="#l43.48"></a><span id="l43.48"> </span>
<a href="#l43.49"></a><span id="l43.49"> var gPluginHandler = {</span>
<a href="#l43.50"></a><span id="l43.50" class="difflineminus">-  addEventListeners: function ph_addEventListeners(browser) {</span>
<a href="#l43.51"></a><span id="l43.51" class="difflineplus">+  addEventListeners(browser) {</span>
<a href="#l43.52"></a><span id="l43.52">     // Note that the XBL binding is untrusted</span>
<a href="#l43.53"></a><span id="l43.53">     browser.addEventListener(&quot;PluginBindingAttached&quot;, gPluginHandler, true, true);</span>
<a href="#l43.54"></a><span id="l43.54" class="difflineminus">-    browser.addEventListener(&quot;PluginCrashed&quot;,         gPluginHandler, true);</span>
<a href="#l43.55"></a><span id="l43.55" class="difflineminus">-    browser.addEventListener(&quot;PluginOutdated&quot;,        gPluginHandler, true);</span>
<a href="#l43.56"></a><span id="l43.56" class="difflineminus">-    browser.addEventListener(&quot;NewPluginInstalled&quot;,    gPluginHandler, true);</span>
<a href="#l43.57"></a><span id="l43.57" class="difflineplus">+    browser.addEventListener(&quot;PluginCrashed&quot;, gPluginHandler, true);</span>
<a href="#l43.58"></a><span id="l43.58" class="difflineplus">+    browser.addEventListener(&quot;PluginOutdated&quot;, gPluginHandler, true);</span>
<a href="#l43.59"></a><span id="l43.59" class="difflineplus">+    browser.addEventListener(&quot;NewPluginInstalled&quot;, gPluginHandler, true);</span>
<a href="#l43.60"></a><span id="l43.60">   },</span>
<a href="#l43.61"></a><span id="l43.61"> </span>
<a href="#l43.62"></a><span id="l43.62" class="difflineminus">-  removeEventListeners: function ph_removeEventListeners(browser) {</span>
<a href="#l43.63"></a><span id="l43.63" class="difflineplus">+  removeEventListeners(browser) {</span>
<a href="#l43.64"></a><span id="l43.64">     browser.removeEventListener(&quot;PluginBindingAttached&quot;, gPluginHandler);</span>
<a href="#l43.65"></a><span id="l43.65">     browser.removeEventListener(&quot;PluginCrashed&quot;, gPluginHandler);</span>
<a href="#l43.66"></a><span id="l43.66">     browser.removeEventListener(&quot;PluginOutdated&quot;, gPluginHandler);</span>
<a href="#l43.67"></a><span id="l43.67">     browser.removeEventListener(&quot;NewPluginInstalled&quot;, gPluginHandler);</span>
<a href="#l43.68"></a><span id="l43.68">   },</span>
<a href="#l43.69"></a><span id="l43.69"> </span>
<a href="#l43.70"></a><span id="l43.70" class="difflineminus">-  getPluginUI: function (plugin, anonId) {</span>
<a href="#l43.71"></a><span id="l43.71" class="difflineplus">+  getPluginUI(plugin, anonId) {</span>
<a href="#l43.72"></a><span id="l43.72">     return plugin.ownerDocument.getAnonymousElementByAttribute(plugin, &quot;anonid&quot;, anonId);</span>
<a href="#l43.73"></a><span id="l43.73">   },</span>
<a href="#l43.74"></a><span id="l43.74"> </span>
<a href="#l43.75"></a><span id="l43.75">   get CrashSubmit() {</span>
<a href="#l43.76"></a><span id="l43.76">     delete this.CrashSubmit;</span>
<a href="#l43.77"></a><span id="l43.77">     ChromeUtils.import(&quot;resource://gre/modules/CrashSubmit.jsm&quot;, this);</span>
<a href="#l43.78"></a><span id="l43.78">     return this.CrashSubmit;</span>
<a href="#l43.79"></a><span id="l43.79">   },</span>
<a href="#l43.80"></a><span id="l43.80"> </span>
<a href="#l43.81"></a><span id="l43.81">   // Map the plugin's name to a filtered version more suitable for user UI.</span>
<a href="#l43.82"></a><span id="l43.82" class="difflineminus">-  makeNicePluginName : function ph_makeNicePluginName(aName, aFilename) {</span>
<a href="#l43.83"></a><span id="l43.83" class="difflineplus">+  makeNicePluginName(aName, aFilename) {</span>
<a href="#l43.84"></a><span id="l43.84">     if (aName == &quot;Shockwave Flash&quot;)</span>
<a href="#l43.85"></a><span id="l43.85">       return &quot;Adobe Flash&quot;;</span>
<a href="#l43.86"></a><span id="l43.86"> </span>
<a href="#l43.87"></a><span id="l43.87">     // Clean up the plugin name by stripping off any trailing version numbers</span>
<a href="#l43.88"></a><span id="l43.88">     // or &quot;plugin&quot;. EG, &quot;Foo Bar Plugin 1.23_02&quot; --&gt; &quot;Foo Bar&quot;</span>
<a href="#l43.89"></a><span id="l43.89">     return aName.replace(/\bplug-?in\b/i, &quot;&quot;).replace(/[\s\d\.\-\_\(\)]+$/, &quot;&quot;);</span>
<a href="#l43.90"></a><span id="l43.90">   },</span>
<a href="#l43.91"></a><span id="l43.91"> </span>
<a href="#l43.92"></a><span id="l43.92">   /**</span>
<a href="#l43.93"></a><span id="l43.93">    * Update the visibility of the plugin overlay.</span>
<a href="#l43.94"></a><span id="l43.94">    */</span>
<a href="#l43.95"></a><span id="l43.95" class="difflineminus">-  setVisibility : function (plugin, overlay, shouldShow) {</span>
<a href="#l43.96"></a><span id="l43.96" class="difflineplus">+  setVisibility(plugin, overlay, shouldShow) {</span>
<a href="#l43.97"></a><span id="l43.97">     overlay.classList.toggle(&quot;visible&quot;, shouldShow);</span>
<a href="#l43.98"></a><span id="l43.98">   },</span>
<a href="#l43.99"></a><span id="l43.99"> </span>
<a href="#l43.100"></a><span id="l43.100">   /**</span>
<a href="#l43.101"></a><span id="l43.101">    * Check whether the plugin should be visible on the page. A plugin should</span>
<a href="#l43.102"></a><span id="l43.102">    * not be visible if the overlay is too big, or if any other page content</span>
<a href="#l43.103"></a><span id="l43.103">    * overlays it.</span>
<a href="#l43.104"></a><span id="l43.104">    *</span>
<a href="#l43.105"></a><span id="l43.105">    * This function will handle showing or hiding the overlay.</span>
<a href="#l43.106"></a><span id="l43.106">    * @returns true if the plugin is invisible.</span>
<a href="#l43.107"></a><span id="l43.107">    */</span>
<a href="#l43.108"></a><span id="l43.108" class="difflineminus">-  shouldShowOverlay : function (plugin, overlay) {</span>
<a href="#l43.109"></a><span id="l43.109" class="difflineplus">+  shouldShowOverlay(plugin, overlay) {</span>
<a href="#l43.110"></a><span id="l43.110">     // If the overlay size is 0, we haven't done layout yet. Presume that</span>
<a href="#l43.111"></a><span id="l43.111">     // plugins are visible until we know otherwise.</span>
<a href="#l43.112"></a><span id="l43.112">     if (overlay.scrollWidth == 0) {</span>
<a href="#l43.113"></a><span id="l43.113">       return true;</span>
<a href="#l43.114"></a><span id="l43.114">     }</span>
<a href="#l43.115"></a><span id="l43.115"> </span>
<a href="#l43.116"></a><span id="l43.116">     // Is the &lt;object&gt;'s size too small to hold what we want to show?</span>
<a href="#l43.117"></a><span id="l43.117">     let pluginRect = plugin.getBoundingClientRect();</span>
<a href="#l43.118"></a><span id="l43.118" class="difflineat">@@ -156,17 +155,17 @@ var gPluginHandler = {</span>
<a href="#l43.119"></a><span id="l43.119">       if (el !== plugin) {</span>
<a href="#l43.120"></a><span id="l43.120">         return false;</span>
<a href="#l43.121"></a><span id="l43.121">       }</span>
<a href="#l43.122"></a><span id="l43.122">     }</span>
<a href="#l43.123"></a><span id="l43.123"> </span>
<a href="#l43.124"></a><span id="l43.124">     return true;</span>
<a href="#l43.125"></a><span id="l43.125">   },</span>
<a href="#l43.126"></a><span id="l43.126"> </span>
<a href="#l43.127"></a><span id="l43.127" class="difflineminus">-  addLinkClickCallback: function ph_addLinkClickCallback(linkNode, callbackName, ...callbackArgs) {</span>
<a href="#l43.128"></a><span id="l43.128" class="difflineplus">+  addLinkClickCallback(linkNode, callbackName, ...callbackArgs) {</span>
<a href="#l43.129"></a><span id="l43.129">     // XXX just doing (callback)(arg) was giving a same-origin error. bug?</span>
<a href="#l43.130"></a><span id="l43.130">     let self = this;</span>
<a href="#l43.131"></a><span id="l43.131">     linkNode.addEventListener(&quot;click&quot;,</span>
<a href="#l43.132"></a><span id="l43.132">                               function(evt) {</span>
<a href="#l43.133"></a><span id="l43.133">                                 if (!evt.isTrusted)</span>
<a href="#l43.134"></a><span id="l43.134">                                   return;</span>
<a href="#l43.135"></a><span id="l43.135">                                 evt.preventDefault();</span>
<a href="#l43.136"></a><span id="l43.136">                                 if (callbackArgs.length == 0)</span>
<a href="#l43.137"></a><span id="l43.137" class="difflineat">@@ -186,17 +185,17 @@ var gPluginHandler = {</span>
<a href="#l43.138"></a><span id="l43.138">                                   evt.preventDefault();</span>
<a href="#l43.139"></a><span id="l43.139">                                   (self[callbackName]).apply(self, callbackArgs);</span>
<a href="#l43.140"></a><span id="l43.140">                                 }</span>
<a href="#l43.141"></a><span id="l43.141">                               },</span>
<a href="#l43.142"></a><span id="l43.142">                               true);</span>
<a href="#l43.143"></a><span id="l43.143">   },</span>
<a href="#l43.144"></a><span id="l43.144"> </span>
<a href="#l43.145"></a><span id="l43.145">   // Helper to get the binding handler type from a plugin object</span>
<a href="#l43.146"></a><span id="l43.146" class="difflineminus">-  _getBindingType : function(plugin) {</span>
<a href="#l43.147"></a><span id="l43.147" class="difflineplus">+  _getBindingType(plugin) {</span>
<a href="#l43.148"></a><span id="l43.148">     if (!(plugin instanceof Ci.nsIObjectLoadingContent))</span>
<a href="#l43.149"></a><span id="l43.149">       return null;</span>
<a href="#l43.150"></a><span id="l43.150"> </span>
<a href="#l43.151"></a><span id="l43.151">     switch (plugin.pluginFallbackType) {</span>
<a href="#l43.152"></a><span id="l43.152">       case Ci.nsIObjectLoadingContent.PLUGIN_UNSUPPORTED:</span>
<a href="#l43.153"></a><span id="l43.153">         return &quot;PluginNotFound&quot;;</span>
<a href="#l43.154"></a><span id="l43.154">       case Ci.nsIObjectLoadingContent.PLUGIN_DISABLED:</span>
<a href="#l43.155"></a><span id="l43.155">         return &quot;PluginDisabled&quot;;</span>
<a href="#l43.156"></a><span id="l43.156" class="difflineat">@@ -213,20 +212,19 @@ var gPluginHandler = {</span>
<a href="#l43.157"></a><span id="l43.157">       case Ci.nsIObjectLoadingContent.PLUGIN_PLAY_PREVIEW:</span>
<a href="#l43.158"></a><span id="l43.158">         return &quot;PluginPlayPreview&quot;;</span>
<a href="#l43.159"></a><span id="l43.159">       default:</span>
<a href="#l43.160"></a><span id="l43.160">         // Not all states map to a handler</span>
<a href="#l43.161"></a><span id="l43.161">         return null;</span>
<a href="#l43.162"></a><span id="l43.162">     }</span>
<a href="#l43.163"></a><span id="l43.163">   },</span>
<a href="#l43.164"></a><span id="l43.164"> </span>
<a href="#l43.165"></a><span id="l43.165" class="difflineminus">-  handleEvent : function ph_handleEvent(event) {</span>
<a href="#l43.166"></a><span id="l43.166" class="difflineplus">+  handleEvent(event) {</span>
<a href="#l43.167"></a><span id="l43.167">     let self = gPluginHandler;</span>
<a href="#l43.168"></a><span id="l43.168">     let plugin = event.target;</span>
<a href="#l43.169"></a><span id="l43.169" class="difflineminus">-    let doc = plugin.ownerDocument;</span>
<a href="#l43.170"></a><span id="l43.170"> </span>
<a href="#l43.171"></a><span id="l43.171">     // We're expecting the target to be a plugin.</span>
<a href="#l43.172"></a><span id="l43.172">     if (!(plugin instanceof Ci.nsIObjectLoadingContent))</span>
<a href="#l43.173"></a><span id="l43.173">       return;</span>
<a href="#l43.174"></a><span id="l43.174"> </span>
<a href="#l43.175"></a><span id="l43.175">     let eventType = event.type;</span>
<a href="#l43.176"></a><span id="l43.176">     if (eventType == &quot;PluginBindingAttached&quot;) {</span>
<a href="#l43.177"></a><span id="l43.177">       // The plugin binding fires this event when it is created.</span>
<a href="#l43.178"></a><span id="l43.178" class="difflineat">@@ -279,65 +277,63 @@ var gPluginHandler = {</span>
<a href="#l43.179"></a><span id="l43.179">           this._setPluginNotificationIcon(browser);</span>
<a href="#l43.180"></a><span id="l43.180">         };</span>
<a href="#l43.181"></a><span id="l43.181">         plugin.addEventListener(&quot;overflow&quot;, resizeListener);</span>
<a href="#l43.182"></a><span id="l43.182">         plugin.addEventListener(&quot;underflow&quot;, resizeListener);</span>
<a href="#l43.183"></a><span id="l43.183">       }</span>
<a href="#l43.184"></a><span id="l43.184">     }</span>
<a href="#l43.185"></a><span id="l43.185">   },</span>
<a href="#l43.186"></a><span id="l43.186"> </span>
<a href="#l43.187"></a><span id="l43.187" class="difflineminus">-  newPluginInstalled : function(event) {</span>
<a href="#l43.188"></a><span id="l43.188" class="difflineplus">+  newPluginInstalled(event) {</span>
<a href="#l43.189"></a><span id="l43.189">     // browser elements are anonymous so we can't just use target.</span>
<a href="#l43.190"></a><span id="l43.190">     var browser = event.originalTarget;</span>
<a href="#l43.191"></a><span id="l43.191"> </span>
<a href="#l43.192"></a><span id="l43.192">     // reload the browser to make the new plugin show.</span>
<a href="#l43.193"></a><span id="l43.193">     browser.reload();</span>
<a href="#l43.194"></a><span id="l43.194">   },</span>
<a href="#l43.195"></a><span id="l43.195"> </span>
<a href="#l43.196"></a><span id="l43.196">   // Callback for user clicking on a disabled plugin</span>
<a href="#l43.197"></a><span id="l43.197" class="difflineminus">-  managePlugins: function ph_managePlugins(aEvent) {</span>
<a href="#l43.198"></a><span id="l43.198" class="difflineplus">+  managePlugins(aEvent) {</span>
<a href="#l43.199"></a><span id="l43.199">     openAddonsMgr(&quot;addons://list/plugin&quot;);</span>
<a href="#l43.200"></a><span id="l43.200">   },</span>
<a href="#l43.201"></a><span id="l43.201"> </span>
<a href="#l43.202"></a><span id="l43.202">   // Callback for user clicking &quot;submit a report&quot; link</span>
<a href="#l43.203"></a><span id="l43.203" class="difflineminus">-  submitReport : function ph_submitReport(pluginDumpID, browserDumpID, plugin) {</span>
<a href="#l43.204"></a><span id="l43.204" class="difflineplus">+  submitReport(pluginDumpID, browserDumpID, plugin) {</span>
<a href="#l43.205"></a><span id="l43.205">     let keyVals = {};</span>
<a href="#l43.206"></a><span id="l43.206">     if (plugin) {</span>
<a href="#l43.207"></a><span id="l43.207">       let userComment = this.getPluginUI(plugin, &quot;submitComment&quot;).value.trim();</span>
<a href="#l43.208"></a><span id="l43.208">       if (userComment)</span>
<a href="#l43.209"></a><span id="l43.209">         keyVals.PluginUserComment = userComment;</span>
<a href="#l43.210"></a><span id="l43.210">       if (this.getPluginUI(plugin, &quot;submitURLOptIn&quot;).checked)</span>
<a href="#l43.211"></a><span id="l43.211">         keyVals.PluginContentURL = plugin.ownerDocument.URL;</span>
<a href="#l43.212"></a><span id="l43.212">     }</span>
<a href="#l43.213"></a><span id="l43.213" class="difflineminus">-    var curBrowser = document.getElementById('tabmail').getBrowserForSelectedTab();</span>
<a href="#l43.214"></a><span id="l43.214">     this.CrashSubmit.submit(pluginDumpID, { extraExtraKeyVals: keyVals });</span>
<a href="#l43.215"></a><span id="l43.215">     if (browserDumpID)</span>
<a href="#l43.216"></a><span id="l43.216">       this.CrashSubmit.submit(browserDumpID);</span>
<a href="#l43.217"></a><span id="l43.217">   },</span>
<a href="#l43.218"></a><span id="l43.218"> </span>
<a href="#l43.219"></a><span id="l43.219">   // Callback for user clicking a &quot;reload page&quot; link</span>
<a href="#l43.220"></a><span id="l43.220" class="difflineminus">-  reloadPage: function ph_reloadPage(browser) {</span>
<a href="#l43.221"></a><span id="l43.221" class="difflineplus">+  reloadPage(browser) {</span>
<a href="#l43.222"></a><span id="l43.222">     browser.reload();</span>
<a href="#l43.223"></a><span id="l43.223">   },</span>
<a href="#l43.224"></a><span id="l43.224"> </span>
<a href="#l43.225"></a><span id="l43.225">   // Callback for user clicking the help icon</span>
<a href="#l43.226"></a><span id="l43.226" class="difflineminus">-  openPluginCrashHelpPage: function ph_openHelpPage() {</span>
<a href="#l43.227"></a><span id="l43.227" class="difflineplus">+  openPluginCrashHelpPage() {</span>
<a href="#l43.228"></a><span id="l43.228">     // Grab the plugin crash support URL</span>
<a href="#l43.229"></a><span id="l43.229">     let url = Services.urlFormatter.formatURLPref(&quot;plugins.crash.supportUrl&quot;);</span>
<a href="#l43.230"></a><span id="l43.230">     // Now open up a content tab to display it in</span>
<a href="#l43.231"></a><span id="l43.231" class="difflineminus">-    let tabmail = document.getElementById('tabmail');</span>
<a href="#l43.232"></a><span id="l43.232" class="difflineplus">+    let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l43.233"></a><span id="l43.233">     tabmail.openTab(&quot;contentTab&quot;, {contentPage: url,</span>
<a href="#l43.234"></a><span id="l43.234">                                    background: false});</span>
<a href="#l43.235"></a><span id="l43.235">   },</span>
<a href="#l43.236"></a><span id="l43.236"> </span>
<a href="#l43.237"></a><span id="l43.237">   // Event listener for blocklisted/outdated/carbonFailure plugins.</span>
<a href="#l43.238"></a><span id="l43.238" class="difflineminus">-  pluginUnavailable: function(plugin, eventType) {</span>
<a href="#l43.239"></a><span id="l43.239" class="difflineminus">-    var tabmail = document.getElementById('tabmail');</span>
<a href="#l43.240"></a><span id="l43.240" class="difflineminus">-    let browser = tabmail.getBrowserForDocument(plugin.ownerDocument</span>
<a href="#l43.241"></a><span id="l43.241" class="difflineminus">-                                                .defaultView).browser;</span>
<a href="#l43.242"></a><span id="l43.242" class="difflineplus">+  pluginUnavailable(plugin, eventType) {</span>
<a href="#l43.243"></a><span id="l43.243" class="difflineplus">+    var tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l43.244"></a><span id="l43.244" class="difflineplus">+    let browser = tabmail.getBrowserForDocument(plugin.ownerGlobal).browser;</span>
<a href="#l43.245"></a><span id="l43.245"> </span>
<a href="#l43.246"></a><span id="l43.246">     var notificationBox = getNotificationBox(browser.contentWindow);</span>
<a href="#l43.247"></a><span id="l43.247"> </span>
<a href="#l43.248"></a><span id="l43.248">     // Should only display one of these warnings per page.</span>
<a href="#l43.249"></a><span id="l43.249">     // In order of priority, they are: outdated &gt; blocklisted</span>
<a href="#l43.250"></a><span id="l43.250">     let outdatedNotification = notificationBox.getNotificationWithValue(&quot;outdated-plugins&quot;);</span>
<a href="#l43.251"></a><span id="l43.251">     let blockedNotification  = notificationBox.getNotificationWithValue(&quot;blocked-plugins&quot;);</span>
<a href="#l43.252"></a><span id="l43.252"> </span>
<a href="#l43.253"></a><span id="l43.253" class="difflineat">@@ -351,18 +347,17 @@ var gPluginHandler = {</span>
<a href="#l43.254"></a><span id="l43.254">     function showOutdatedPluginsInfo() {</span>
<a href="#l43.255"></a><span id="l43.255">       Services.prefs.setBoolPref(&quot;plugins.update.notifyUser&quot;, false);</span>
<a href="#l43.256"></a><span id="l43.256">       var url = formatURL(&quot;plugins.update.url&quot;, true);</span>
<a href="#l43.257"></a><span id="l43.257">       tabmail.openTab(&quot;contentTab&quot;, {contentPage: url,</span>
<a href="#l43.258"></a><span id="l43.258">                                      background: false});</span>
<a href="#l43.259"></a><span id="l43.259">       return true;</span>
<a href="#l43.260"></a><span id="l43.260">     }</span>
<a href="#l43.261"></a><span id="l43.261"> </span>
<a href="#l43.262"></a><span id="l43.262" class="difflineminus">-    function carbonFailurePluginsRestartBrowser()</span>
<a href="#l43.263"></a><span id="l43.263" class="difflineminus">-    {</span>
<a href="#l43.264"></a><span id="l43.264" class="difflineplus">+    function carbonFailurePluginsRestartBrowser() {</span>
<a href="#l43.265"></a><span id="l43.265">       // Notify all windows that an application quit has been requested.</span>
<a href="#l43.266"></a><span id="l43.266">       let cancelQuit = Cc[&quot;@mozilla.org/supports-PRBool;1&quot;].</span>
<a href="#l43.267"></a><span id="l43.267">                          createInstance(Ci.nsISupportsPRBool);</span>
<a href="#l43.268"></a><span id="l43.268">       Services.obs.notifyObservers(cancelQuit, &quot;quit-application-requested&quot;);</span>
<a href="#l43.269"></a><span id="l43.269"> </span>
<a href="#l43.270"></a><span id="l43.270">       // Something aborted the quit process.</span>
<a href="#l43.271"></a><span id="l43.271">       if (cancelQuit.data)</span>
<a href="#l43.272"></a><span id="l43.272">         return;</span>
<a href="#l43.273"></a><span id="l43.273" class="difflineat">@@ -370,57 +365,57 @@ var gPluginHandler = {</span>
<a href="#l43.274"></a><span id="l43.274">       Services.startup.quit(Ci.nsIAppStartup.eRestarti386 |</span>
<a href="#l43.275"></a><span id="l43.275">                             Ci.nsIAppStartup.eRestart |</span>
<a href="#l43.276"></a><span id="l43.276">                             Ci.nsIAppStartup.eAttemptQuit);</span>
<a href="#l43.277"></a><span id="l43.277">     }</span>
<a href="#l43.278"></a><span id="l43.278"> </span>
<a href="#l43.279"></a><span id="l43.279">     let messengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l43.280"></a><span id="l43.280"> </span>
<a href="#l43.281"></a><span id="l43.281">     let notifications = {</span>
<a href="#l43.282"></a><span id="l43.282" class="difflineminus">-      PluginBlocklisted : {</span>
<a href="#l43.283"></a><span id="l43.283" class="difflineplus">+      PluginBlocklisted: {</span>
<a href="#l43.284"></a><span id="l43.284">         barID: &quot;blocked-plugins&quot;,</span>
<a href="#l43.285"></a><span id="l43.285">         iconURL: &quot;chrome://messenger/skin/icons/pluginBlocked.svg&quot;,</span>
<a href="#l43.286"></a><span id="l43.286">         message: messengerBundle.getString(&quot;blockedpluginsMessage.title&quot;),</span>
<a href="#l43.287"></a><span id="l43.287">         buttons: [{</span>
<a href="#l43.288"></a><span id="l43.288">           label: messengerBundle.getString(&quot;blockedpluginsMessage.infoButton.label&quot;),</span>
<a href="#l43.289"></a><span id="l43.289">           accessKey: messengerBundle.getString(&quot;blockedpluginsMessage.infoButton.accesskey&quot;),</span>
<a href="#l43.290"></a><span id="l43.290">           popup: null,</span>
<a href="#l43.291"></a><span id="l43.291" class="difflineminus">-          callback: showBlocklistInfo</span>
<a href="#l43.292"></a><span id="l43.292" class="difflineplus">+          callback: showBlocklistInfo,</span>
<a href="#l43.293"></a><span id="l43.293">         },</span>
<a href="#l43.294"></a><span id="l43.294">         {</span>
<a href="#l43.295"></a><span id="l43.295">           label: messengerBundle.getString(&quot;blockedpluginsMessage.searchButton.label&quot;),</span>
<a href="#l43.296"></a><span id="l43.296">           accessKey: messengerBundle.getString(&quot;blockedpluginsMessage.searchButton.accesskey&quot;),</span>
<a href="#l43.297"></a><span id="l43.297">           popup: null,</span>
<a href="#l43.298"></a><span id="l43.298" class="difflineminus">-          callback: showOutdatedPluginsInfo</span>
<a href="#l43.299"></a><span id="l43.299" class="difflineplus">+          callback: showOutdatedPluginsInfo,</span>
<a href="#l43.300"></a><span id="l43.300">         }],</span>
<a href="#l43.301"></a><span id="l43.301">       },</span>
<a href="#l43.302"></a><span id="l43.302">       PluginOutdated: {</span>
<a href="#l43.303"></a><span id="l43.303">         barID: &quot;outdated-plugins&quot;,</span>
<a href="#l43.304"></a><span id="l43.304">         iconURL: &quot;chrome://mozapps/skin/plugins/pluginGeneric.svg&quot;,</span>
<a href="#l43.305"></a><span id="l43.305">         message: messengerBundle.getString(&quot;outdatedpluginsMessage.title&quot;),</span>
<a href="#l43.306"></a><span id="l43.306">         buttons: [{</span>
<a href="#l43.307"></a><span id="l43.307">           label: messengerBundle.getString(&quot;outdatedpluginsMessage.updateButton.label&quot;),</span>
<a href="#l43.308"></a><span id="l43.308">           accessKey: messengerBundle.getString(&quot;outdatedpluginsMessage.updateButton.accesskey&quot;),</span>
<a href="#l43.309"></a><span id="l43.309">           popup: null,</span>
<a href="#l43.310"></a><span id="l43.310" class="difflineminus">-          callback: showOutdatedPluginsInfo</span>
<a href="#l43.311"></a><span id="l43.311" class="difflineplus">+          callback: showOutdatedPluginsInfo,</span>
<a href="#l43.312"></a><span id="l43.312">         }],</span>
<a href="#l43.313"></a><span id="l43.313" class="difflineminus">-      }</span>
<a href="#l43.314"></a><span id="l43.314" class="difflineplus">+      },</span>
<a href="#l43.315"></a><span id="l43.315">     };</span>
<a href="#l43.316"></a><span id="l43.316">     if (AppConstants.platform == &quot;macosx&quot;) {</span>
<a href="#l43.317"></a><span id="l43.317">       notifications[&quot;npapi-carbon-event-model-failure&quot;] = {</span>
<a href="#l43.318"></a><span id="l43.318">         barID: &quot;carbon-failure-plugins&quot;,</span>
<a href="#l43.319"></a><span id="l43.319">         iconURL: &quot;chrome://mozapps/skin/plugins/pluginGeneric.svg&quot;,</span>
<a href="#l43.320"></a><span id="l43.320">         message: messengerBundle.getString(&quot;carbonFailurePluginsMessage.message&quot;),</span>
<a href="#l43.321"></a><span id="l43.321">         buttons: [{</span>
<a href="#l43.322"></a><span id="l43.322">           label: messengerBundle.getString(&quot;carbonFailurePluginsMessage.restartButton.label&quot;),</span>
<a href="#l43.323"></a><span id="l43.323">           accessKey: messengerBundle.getString(&quot;carbonFailurePluginsMessage.restartButton.accesskey&quot;),</span>
<a href="#l43.324"></a><span id="l43.324">           popup: null,</span>
<a href="#l43.325"></a><span id="l43.325" class="difflineminus">-          callback: carbonFailurePluginsRestartBrowser</span>
<a href="#l43.326"></a><span id="l43.326" class="difflineplus">+          callback: carbonFailurePluginsRestartBrowser,</span>
<a href="#l43.327"></a><span id="l43.327">         }],</span>
<a href="#l43.328"></a><span id="l43.328" class="difflineminus">-      }</span>
<a href="#l43.329"></a><span id="l43.329" class="difflineplus">+      };</span>
<a href="#l43.330"></a><span id="l43.330">     }</span>
<a href="#l43.331"></a><span id="l43.331"> </span>
<a href="#l43.332"></a><span id="l43.332">     // If there is already an outdated plugin notification then do nothing</span>
<a href="#l43.333"></a><span id="l43.333">     if (outdatedNotification)</span>
<a href="#l43.334"></a><span id="l43.334">       return;</span>
<a href="#l43.335"></a><span id="l43.335"> </span>
<a href="#l43.336"></a><span id="l43.336">     if ((AppConstants.platform == &quot;macosx&quot;) &amp;&amp;</span>
<a href="#l43.337"></a><span id="l43.337">         (eventType == &quot;npapi-carbon-event-model-failure&quot;)) {</span>
<a href="#l43.338"></a><span id="l43.338" class="difflineat">@@ -437,38 +432,36 @@ var gPluginHandler = {</span>
<a href="#l43.339"></a><span id="l43.339">       // if this is not a Universal build, just follow PluginNotFound path</span>
<a href="#l43.340"></a><span id="l43.340">       if (!macutils.isUniversalBinary)</span>
<a href="#l43.341"></a><span id="l43.341">         eventType = &quot;PluginNotFound&quot;;</span>
<a href="#l43.342"></a><span id="l43.342">     }</span>
<a href="#l43.343"></a><span id="l43.343"> </span>
<a href="#l43.344"></a><span id="l43.344">     if (eventType == &quot;PluginBlocklisted&quot;) {</span>
<a href="#l43.345"></a><span id="l43.345">       if (blockedNotification)</span>
<a href="#l43.346"></a><span id="l43.346">         return;</span>
<a href="#l43.347"></a><span id="l43.347" class="difflineminus">-    }</span>
<a href="#l43.348"></a><span id="l43.348" class="difflineminus">-    else if (eventType == &quot;PluginOutdated&quot;) {</span>
<a href="#l43.349"></a><span id="l43.349" class="difflineplus">+    } else if (eventType == &quot;PluginOutdated&quot;) {</span>
<a href="#l43.350"></a><span id="l43.350">       if (Services.prefs.getBoolPref(&quot;plugins.hide_infobar_for_outdated_plugin&quot;))</span>
<a href="#l43.351"></a><span id="l43.351">         return;</span>
<a href="#l43.352"></a><span id="l43.352"> </span>
<a href="#l43.353"></a><span id="l43.353">       // Cancel any notification about blocklisted plugins.</span>
<a href="#l43.354"></a><span id="l43.354">       if (blockedNotification)</span>
<a href="#l43.355"></a><span id="l43.355">         blockedNotification.close();</span>
<a href="#l43.356"></a><span id="l43.356" class="difflineminus">-    }</span>
<a href="#l43.357"></a><span id="l43.357" class="difflineminus">-    else if (eventType == &quot;PluginNotFound&quot;) {</span>
<a href="#l43.358"></a><span id="l43.358" class="difflineplus">+    } else if (eventType == &quot;PluginNotFound&quot;) {</span>
<a href="#l43.359"></a><span id="l43.359">       return;</span>
<a href="#l43.360"></a><span id="l43.360">     }</span>
<a href="#l43.361"></a><span id="l43.361"> </span>
<a href="#l43.362"></a><span id="l43.362">     let notify = notifications[eventType];</span>
<a href="#l43.363"></a><span id="l43.363">     notificationBox.appendNotification(notify.message, notify.barID, notify.iconURL,</span>
<a href="#l43.364"></a><span id="l43.364">                                        notificationBox.PRIORITY_WARNING_MEDIUM,</span>
<a href="#l43.365"></a><span id="l43.365">                                        notify.buttons);</span>
<a href="#l43.366"></a><span id="l43.366">   },</span>
<a href="#l43.367"></a><span id="l43.367"> </span>
<a href="#l43.368"></a><span id="l43.368">   // Crashed-plugin observer. Notified once per plugin crash, before events</span>
<a href="#l43.369"></a><span id="l43.369">   // are dispatched to individual plugin instances.</span>
<a href="#l43.370"></a><span id="l43.370" class="difflineminus">-  pluginCrashed : function(subject, topic, data) {</span>
<a href="#l43.371"></a><span id="l43.371" class="difflineplus">+  pluginCrashed(subject, topic, data) {</span>
<a href="#l43.372"></a><span id="l43.372">     let propertyBag = subject;</span>
<a href="#l43.373"></a><span id="l43.373">     if (!(propertyBag instanceof Ci.nsIPropertyBag2) ||</span>
<a href="#l43.374"></a><span id="l43.374">         !(propertyBag instanceof Ci.nsIWritablePropertyBag2))</span>
<a href="#l43.375"></a><span id="l43.375">      return;</span>
<a href="#l43.376"></a><span id="l43.376"> </span>
<a href="#l43.377"></a><span id="l43.377">     if (AppConstants.MOZ_CRASHREPORTER) {</span>
<a href="#l43.378"></a><span id="l43.378">       let pluginDumpID = propertyBag.getPropertyAsAString(&quot;pluginDumpID&quot;);</span>
<a href="#l43.379"></a><span id="l43.379">       let browserDumpID = propertyBag.getPropertyAsAString(&quot;browserDumpID&quot;);</span>
<a href="#l43.380"></a><span id="l43.380" class="difflineat">@@ -481,30 +474,30 @@ var gPluginHandler = {</span>
<a href="#l43.381"></a><span id="l43.381">         // Submission is async, so we can't easily show failure UI.</span>
<a href="#l43.382"></a><span id="l43.382">         propertyBag.setPropertyAsBool(&quot;submittedCrashReport&quot;, true);</span>
<a href="#l43.383"></a><span id="l43.383">       }</span>
<a href="#l43.384"></a><span id="l43.384">     }</span>
<a href="#l43.385"></a><span id="l43.385">   },</span>
<a href="#l43.386"></a><span id="l43.386"> </span>
<a href="#l43.387"></a><span id="l43.387">   // Crashed-plugin event listener. Called for every instance of a</span>
<a href="#l43.388"></a><span id="l43.388">   // plugin in content.</span>
<a href="#l43.389"></a><span id="l43.389" class="difflineminus">-  pluginInstanceCrashed: function (plugin, aEvent) {</span>
<a href="#l43.390"></a><span id="l43.390" class="difflineplus">+  pluginInstanceCrashed(plugin, aEvent) {</span>
<a href="#l43.391"></a><span id="l43.391">     if (!(aEvent instanceof PluginCrashedEvent))</span>
<a href="#l43.392"></a><span id="l43.392">       return;</span>
<a href="#l43.393"></a><span id="l43.393"> </span>
<a href="#l43.394"></a><span id="l43.394">     let submittedReport = aEvent.submittedCrashReport;</span>
<a href="#l43.395"></a><span id="l43.395">     let doPrompt        = true; // XXX followup for aEvent.doPrompt;</span>
<a href="#l43.396"></a><span id="l43.396">     let submitReports   = true; // XXX followup for aEvent.submitReports;</span>
<a href="#l43.397"></a><span id="l43.397">     let pluginName      = aEvent.pluginName;</span>
<a href="#l43.398"></a><span id="l43.398">     let pluginFilename  = aEvent.pluginFilename;</span>
<a href="#l43.399"></a><span id="l43.399">     let pluginDumpID    = aEvent.pluginDumpID;</span>
<a href="#l43.400"></a><span id="l43.400">     let browserDumpID   = aEvent.browserDumpID;</span>
<a href="#l43.401"></a><span id="l43.401"> </span>
<a href="#l43.402"></a><span id="l43.402">     let messengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l43.403"></a><span id="l43.403" class="difflineminus">-    let tabmail = document.getElementById('tabmail');</span>
<a href="#l43.404"></a><span id="l43.404" class="difflineplus">+    let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l43.405"></a><span id="l43.405"> </span>
<a href="#l43.406"></a><span id="l43.406">     // Remap the plugin name to a more user-presentable form.</span>
<a href="#l43.407"></a><span id="l43.407">     pluginName = this.makeNicePluginName(pluginName, pluginFilename);</span>
<a href="#l43.408"></a><span id="l43.408"> </span>
<a href="#l43.409"></a><span id="l43.409">     let messageString = messengerBundle.getFormattedString(&quot;crashedpluginsMessage.title&quot;, [pluginName]);</span>
<a href="#l43.410"></a><span id="l43.410"> </span>
<a href="#l43.411"></a><span id="l43.411">     //</span>
<a href="#l43.412"></a><span id="l43.412">     // Configure the crashed-plugin placeholder.</span>
<a href="#l43.413"></a><span id="l43.413" class="difflineat">@@ -518,25 +511,23 @@ var gPluginHandler = {</span>
<a href="#l43.414"></a><span id="l43.414">     let statusDiv = this.getPluginUI(plugin, &quot;submitStatus&quot;);</span>
<a href="#l43.415"></a><span id="l43.415"> </span>
<a href="#l43.416"></a><span id="l43.416">     if (AppConstants.MOZ_CRASHREPORTER) {</span>
<a href="#l43.417"></a><span id="l43.417">       let status;</span>
<a href="#l43.418"></a><span id="l43.418"> </span>
<a href="#l43.419"></a><span id="l43.419">       // Determine which message to show regarding crash reports.</span>
<a href="#l43.420"></a><span id="l43.420">       if (submittedReport) { // submitReports &amp;&amp; !doPrompt, handled in observer</span>
<a href="#l43.421"></a><span id="l43.421">         status = &quot;submitted&quot;;</span>
<a href="#l43.422"></a><span id="l43.422" class="difflineminus">-      }</span>
<a href="#l43.423"></a><span id="l43.423" class="difflineminus">-      else if (!submitReports &amp;&amp; !doPrompt) {</span>
<a href="#l43.424"></a><span id="l43.424" class="difflineplus">+      } else if (!submitReports &amp;&amp; !doPrompt) {</span>
<a href="#l43.425"></a><span id="l43.425">         status = &quot;noSubmit&quot;;</span>
<a href="#l43.426"></a><span id="l43.426" class="difflineminus">-      }</span>
<a href="#l43.427"></a><span id="l43.427" class="difflineminus">-      else { // doPrompt</span>
<a href="#l43.428"></a><span id="l43.428" class="difflineplus">+      } else { // doPrompt</span>
<a href="#l43.429"></a><span id="l43.429">         status = &quot;please&quot;;</span>
<a href="#l43.430"></a><span id="l43.430">         // XXX can we make the link target actually be blank?</span>
<a href="#l43.431"></a><span id="l43.431">         this.getPluginUI(plugin, &quot;submitButton&quot;).addEventListener(&quot;click&quot;,</span>
<a href="#l43.432"></a><span id="l43.432" class="difflineminus">-          function (event) {</span>
<a href="#l43.433"></a><span id="l43.433" class="difflineplus">+          function(event) {</span>
<a href="#l43.434"></a><span id="l43.434">             if (event.button != 0 || !event.isTrusted)</span>
<a href="#l43.435"></a><span id="l43.435">               return;</span>
<a href="#l43.436"></a><span id="l43.436">             this.submitReport(pluginDumpID, browserDumpID, plugin);</span>
<a href="#l43.437"></a><span id="l43.437">             pref.setBoolPref(&quot;&quot;, optInCB.checked);</span>
<a href="#l43.438"></a><span id="l43.438">           }.bind(this));</span>
<a href="#l43.439"></a><span id="l43.439">         let optInCB = this.getPluginUI(plugin, &quot;submitURLOptIn&quot;);</span>
<a href="#l43.440"></a><span id="l43.440">         let pref = Services.prefs.getBranch(&quot;dom.ipc.plugins.reportCrashURL&quot;);</span>
<a href="#l43.441"></a><span id="l43.441">         optInCB.checked = pref.getBoolPref(&quot;&quot;);</span>
<a href="#l43.442"></a><span id="l43.442" class="difflineat">@@ -555,29 +546,29 @@ var gPluginHandler = {</span>
<a href="#l43.443"></a><span id="l43.443"> </span>
<a href="#l43.444"></a><span id="l43.444">       // If we're showing the link to manually trigger report submission, we'll</span>
<a href="#l43.445"></a><span id="l43.445">       // want to be able to update all the instances of the UI for this crash to</span>
<a href="#l43.446"></a><span id="l43.446">       // show an updated message when a report is submitted.</span>
<a href="#l43.447"></a><span id="l43.447">       if (doPrompt) {</span>
<a href="#l43.448"></a><span id="l43.448">         let observer = {</span>
<a href="#l43.449"></a><span id="l43.449">           QueryInterface: ChromeUtils.generateQI([Ci.nsIObserver,</span>
<a href="#l43.450"></a><span id="l43.450">                                                   Ci.nsISupportsWeakReference]),</span>
<a href="#l43.451"></a><span id="l43.451" class="difflineminus">-          observe : function(subject, topic, data) {</span>
<a href="#l43.452"></a><span id="l43.452" class="difflineplus">+          observe(subject, topic, data) {</span>
<a href="#l43.453"></a><span id="l43.453">             let propertyBag = subject;</span>
<a href="#l43.454"></a><span id="l43.454">             if (!(propertyBag instanceof Ci.nsIPropertyBag2))</span>
<a href="#l43.455"></a><span id="l43.455">               return;</span>
<a href="#l43.456"></a><span id="l43.456">             // Ignore notifications for other crashes.</span>
<a href="#l43.457"></a><span id="l43.457">             if (propertyBag.get(&quot;minidumpID&quot;) != pluginDumpID)</span>
<a href="#l43.458"></a><span id="l43.458">               return;</span>
<a href="#l43.459"></a><span id="l43.459">             statusDiv.setAttribute(&quot;status&quot;, data);</span>
<a href="#l43.460"></a><span id="l43.460">           },</span>
<a href="#l43.461"></a><span id="l43.461"> </span>
<a href="#l43.462"></a><span id="l43.462" class="difflineminus">-          handleEvent : function(event) {</span>
<a href="#l43.463"></a><span id="l43.463" class="difflineplus">+          handleEvent(event) {</span>
<a href="#l43.464"></a><span id="l43.464">               // Not expected to be called, just here for the closure.</span>
<a href="#l43.465"></a><span id="l43.465" class="difflineminus">-          }</span>
<a href="#l43.466"></a><span id="l43.466" class="difflineplus">+          },</span>
<a href="#l43.467"></a><span id="l43.467">         };</span>
<a href="#l43.468"></a><span id="l43.468"> </span>
<a href="#l43.469"></a><span id="l43.469">         // Use a weak reference, so we don't have to remove it...</span>
<a href="#l43.470"></a><span id="l43.470">         Services.obs.addObserver(observer, &quot;crash-report-status&quot;, true);</span>
<a href="#l43.471"></a><span id="l43.471">         // ...alas, now we need something to hold a strong reference to prevent</span>
<a href="#l43.472"></a><span id="l43.472">         // it from being GC. But I don't want to manually manage the reference's</span>
<a href="#l43.473"></a><span id="l43.473">         // lifetime (which should be no greater than the page).</span>
<a href="#l43.474"></a><span id="l43.474">         // Clever solution? Use a closue with an event listener on the document.</span>
<a href="#l43.475"></a><span id="l43.475" class="difflineat">@@ -607,21 +598,20 @@ var gPluginHandler = {</span>
<a href="#l43.476"></a><span id="l43.476">     this.setVisibility(plugin, overlay, isShowing);</span>
<a href="#l43.477"></a><span id="l43.477"> </span>
<a href="#l43.478"></a><span id="l43.478">     if (isShowing) {</span>
<a href="#l43.479"></a><span id="l43.479">       // If a previous plugin on the page was too small and resulted in adding a</span>
<a href="#l43.480"></a><span id="l43.480">       // notification bar, then remove it because this plugin instance is big</span>
<a href="#l43.481"></a><span id="l43.481">       // enough to serve as in-content notification.</span>
<a href="#l43.482"></a><span id="l43.482">       hideNotificationBar();</span>
<a href="#l43.483"></a><span id="l43.483">       doc.mozNoPluginCrashedNotification = true;</span>
<a href="#l43.484"></a><span id="l43.484" class="difflineminus">-    } else {</span>
<a href="#l43.485"></a><span id="l43.485" class="difflineplus">+    } else if (!doc.mozNoPluginCrashedNotification) {</span>
<a href="#l43.486"></a><span id="l43.486">       // If another plugin on the page was large enough to show our UI, we don't</span>
<a href="#l43.487"></a><span id="l43.487">       // want to show a notification bar.</span>
<a href="#l43.488"></a><span id="l43.488" class="difflineminus">-      if (!doc.mozNoPluginCrashedNotification)</span>
<a href="#l43.489"></a><span id="l43.489" class="difflineminus">-        showNotificationBar(pluginDumpID, browserDumpID);</span>
<a href="#l43.490"></a><span id="l43.490" class="difflineplus">+      showNotificationBar(pluginDumpID, browserDumpID);</span>
<a href="#l43.491"></a><span id="l43.491">     }</span>
<a href="#l43.492"></a><span id="l43.492"> </span>
<a href="#l43.493"></a><span id="l43.493">     function hideNotificationBar() {</span>
<a href="#l43.494"></a><span id="l43.494">       let notification = notificationBox.getNotificationWithValue(&quot;plugin-crashed&quot;);</span>
<a href="#l43.495"></a><span id="l43.495">       if (notification)</span>
<a href="#l43.496"></a><span id="l43.496">         notificationBox.removeNotification(notification, true);</span>
<a href="#l43.497"></a><span id="l43.497">     }</span>
<a href="#l43.498"></a><span id="l43.498"> </span>
<a href="#l43.499"></a><span id="l43.499" class="difflineat">@@ -639,24 +629,24 @@ var gPluginHandler = {</span>
<a href="#l43.500"></a><span id="l43.500">       let reloadKey   = messengerBundle.getString(&quot;crashedpluginsMessage.reloadButton.accesskey&quot;);</span>
<a href="#l43.501"></a><span id="l43.501">       let submitLabel = messengerBundle.getString(&quot;crashedpluginsMessage.submitButton.label&quot;);</span>
<a href="#l43.502"></a><span id="l43.502">       let submitKey   = messengerBundle.getString(&quot;crashedpluginsMessage.submitButton.accesskey&quot;);</span>
<a href="#l43.503"></a><span id="l43.503"> </span>
<a href="#l43.504"></a><span id="l43.504">       let buttons = [{</span>
<a href="#l43.505"></a><span id="l43.505">         label: reloadLabel,</span>
<a href="#l43.506"></a><span id="l43.506">         accessKey: reloadKey,</span>
<a href="#l43.507"></a><span id="l43.507">         popup: null,</span>
<a href="#l43.508"></a><span id="l43.508" class="difflineminus">-        callback: function() { browser.reload(); },</span>
<a href="#l43.509"></a><span id="l43.509" class="difflineplus">+        callback() { browser.reload(); },</span>
<a href="#l43.510"></a><span id="l43.510">       }];</span>
<a href="#l43.511"></a><span id="l43.511">       if (AppConstants.MOZ_CRASHREPORTER) {</span>
<a href="#l43.512"></a><span id="l43.512">         let submitButton = {</span>
<a href="#l43.513"></a><span id="l43.513">           label: submitLabel,</span>
<a href="#l43.514"></a><span id="l43.514">           accessKey: submitKey,</span>
<a href="#l43.515"></a><span id="l43.515">           popup: null,</span>
<a href="#l43.516"></a><span id="l43.516" class="difflineminus">-            callback: function() { gPluginHandler.submitReport(pluginDumpID, browserDumpID); },</span>
<a href="#l43.517"></a><span id="l43.517" class="difflineplus">+            callback() { gPluginHandler.submitReport(pluginDumpID, browserDumpID); },</span>
<a href="#l43.518"></a><span id="l43.518">         };</span>
<a href="#l43.519"></a><span id="l43.519">         if (pluginDumpID)</span>
<a href="#l43.520"></a><span id="l43.520">           buttons.push(submitButton);</span>
<a href="#l43.521"></a><span id="l43.521">       }</span>
<a href="#l43.522"></a><span id="l43.522"> </span>
<a href="#l43.523"></a><span id="l43.523">       notification = notificationBox.appendNotification(messageString, &quot;plugin-crashed&quot;,</span>
<a href="#l43.524"></a><span id="l43.524">                                                         iconURL, priority, buttons);</span>
<a href="#l43.525"></a><span id="l43.525"> </span>
<a href="#l43.526"></a><span id="l43.526" class="difflineat">@@ -672,11 +662,11 @@ var gPluginHandler = {</span>
<a href="#l43.527"></a><span id="l43.527">       description.appendChild(link);</span>
<a href="#l43.528"></a><span id="l43.528"> </span>
<a href="#l43.529"></a><span id="l43.529">       // Remove the notification when the page is reloaded.</span>
<a href="#l43.530"></a><span id="l43.530">       doc.defaultView.top.addEventListener(&quot;unload&quot;, function() {</span>
<a href="#l43.531"></a><span id="l43.531">         notificationBox.removeNotification(notification);</span>
<a href="#l43.532"></a><span id="l43.532">       });</span>
<a href="#l43.533"></a><span id="l43.533">     }</span>
<a href="#l43.534"></a><span id="l43.534"> </span>
<a href="#l43.535"></a><span id="l43.535" class="difflineminus">-  }</span>
<a href="#l43.536"></a><span id="l43.536" class="difflineplus">+  },</span>
<a href="#l43.537"></a><span id="l43.537"> };</span>
<a href="#l43.538"></a><span id="l43.538"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/mail/base/content/quickFilterBar.js</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/mail/base/content/quickFilterBar.js</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -1,59 +1,64 @@</span>
<a href="#l44.4"></a><span id="l44.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l44.5"></a><span id="l44.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l44.6"></a><span id="l44.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l44.7"></a><span id="l44.7"> </span>
<a href="#l44.8"></a><span id="l44.8"> ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l44.9"></a><span id="l44.9"> ChromeUtils.import(&quot;resource:///modules/errUtils.js&quot;);</span>
<a href="#l44.10"></a><span id="l44.10" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/QuickFilterManager.jsm&quot;);</span>
<a href="#l44.11"></a><span id="l44.11" class="difflineplus">+var {</span>
<a href="#l44.12"></a><span id="l44.12" class="difflineplus">+  MessageTextFilter,</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineplus">+  QuickFilterManager,</span>
<a href="#l44.14"></a><span id="l44.14" class="difflineplus">+  QuickFilterSearchListener,</span>
<a href="#l44.15"></a><span id="l44.15" class="difflineplus">+  QuickFilterState,</span>
<a href="#l44.16"></a><span id="l44.16" class="difflineplus">+} = ChromeUtils.import(&quot;resource:///modules/QuickFilterManager.jsm&quot;, null);</span>
<a href="#l44.17"></a><span id="l44.17"> ChromeUtils.import(&quot;resource:///modules/SearchSpec.jsm&quot;);</span>
<a href="#l44.18"></a><span id="l44.18"> </span>
<a href="#l44.19"></a><span id="l44.19" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l44.20"></a><span id="l44.20" class="difflineminus">-//// Proper Code</span>
<a href="#l44.21"></a><span id="l44.21" class="difflineplus">+// -----------</span>
<a href="#l44.22"></a><span id="l44.22" class="difflineplus">+// Proper Code</span>
<a href="#l44.23"></a><span id="l44.23"> </span>
<a href="#l44.24"></a><span id="l44.24"> /**</span>
<a href="#l44.25"></a><span id="l44.25">  * There is only one message filter bar widget; the muxer deals with tab</span>
<a href="#l44.26"></a><span id="l44.26">  *  changes and directing modifications to and reflecting the state of the</span>
<a href="#l44.27"></a><span id="l44.27">  *  actual filterer objects.</span>
<a href="#l44.28"></a><span id="l44.28">  */</span>
<a href="#l44.29"></a><span id="l44.29"> var QuickFilterBarMuxer = {</span>
<a href="#l44.30"></a><span id="l44.30">   /**</span>
<a href="#l44.31"></a><span id="l44.31">    * This gets called by OnLoadMessenger in order to ensure that the monitor</span>
<a href="#l44.32"></a><span id="l44.32">    *  gets registered prior to the first tab being opened.  This avoids</span>
<a href="#l44.33"></a><span id="l44.33">    *  complications about generating synthetic tab notifications.</span>
<a href="#l44.34"></a><span id="l44.34">    */</span>
<a href="#l44.35"></a><span id="l44.35" class="difflineminus">-  _init: function QFBM__init() {</span>
<a href="#l44.36"></a><span id="l44.36" class="difflineplus">+  _init() {</span>
<a href="#l44.37"></a><span id="l44.37">     // -- folder display hookup</span>
<a href="#l44.38"></a><span id="l44.38">     FolderDisplayListenerManager.registerListener(this);</span>
<a href="#l44.39"></a><span id="l44.39"> </span>
<a href="#l44.40"></a><span id="l44.40">     // -- tab monitor hookup</span>
<a href="#l44.41"></a><span id="l44.41">     this.tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l44.42"></a><span id="l44.42">     this.tabmail.registerTabMonitor(this);</span>
<a href="#l44.43"></a><span id="l44.43"> </span>
<a href="#l44.44"></a><span id="l44.44">     // -- window hookups</span>
<a href="#l44.45"></a><span id="l44.45">     let dis = this;</span>
<a href="#l44.46"></a><span id="l44.46">     // know when a resize happens so we can expand things collapsed by our</span>
<a href="#l44.47"></a><span id="l44.47">     //  overflow handler (registered by attribute in the XUL file).</span>
<a href="#l44.48"></a><span id="l44.48" class="difflineminus">-    window.addEventListener(&quot;resize&quot;, function QFBM_resizeWrap() {</span>
<a href="#l44.49"></a><span id="l44.49" class="difflineplus">+    window.addEventListener(&quot;resize&quot;, function() {</span>
<a href="#l44.50"></a><span id="l44.50">                               dis.onWindowResize();</span>
<a href="#l44.51"></a><span id="l44.51">                             });</span>
<a href="#l44.52"></a><span id="l44.52"> </span>
<a href="#l44.53"></a><span id="l44.53">     this._bindUI();</span>
<a href="#l44.54"></a><span id="l44.54">   },</span>
<a href="#l44.55"></a><span id="l44.55"> </span>
<a href="#l44.56"></a><span id="l44.56" class="difflineminus">-  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l44.57"></a><span id="l44.57" class="difflineplus">+  // ---------------------</span>
<a href="#l44.58"></a><span id="l44.58">   // FolderDisplayListener</span>
<a href="#l44.59"></a><span id="l44.59"> </span>
<a href="#l44.60"></a><span id="l44.60">   /**</span>
<a href="#l44.61"></a><span id="l44.61">    * Decide whether to display the filter bar toggle button whenever a folder</span>
<a href="#l44.62"></a><span id="l44.62">    *  display is made active.  makeActive is what triggers the display of</span>
<a href="#l44.63"></a><span id="l44.63">    *  account central so this is the perfect spot to do so.</span>
<a href="#l44.64"></a><span id="l44.64">    */</span>
<a href="#l44.65"></a><span id="l44.65" class="difflineminus">-  onMakeActive: function QFBM_onMakeActive(aFolderDisplay) {</span>
<a href="#l44.66"></a><span id="l44.66" class="difflineplus">+  onMakeActive(aFolderDisplay) {</span>
<a href="#l44.67"></a><span id="l44.67">     let tab = aFolderDisplay._tabInfo;</span>
<a href="#l44.68"></a><span id="l44.68">     this._updateToggle(tab);</span>
<a href="#l44.69"></a><span id="l44.69">     // The case in that previous aFolderDisplay is showing a normal folder is</span>
<a href="#l44.70"></a><span id="l44.70">     // handled by onLoadingFolder. Here we handle the case where previous</span>
<a href="#l44.71"></a><span id="l44.71">     // aFolderDisplay shows an account folder instead (this cannot be done</span>
<a href="#l44.72"></a><span id="l44.72">     // in onLoadingFolder because that event is not raised).</span>
<a href="#l44.73"></a><span id="l44.73">     if (!aFolderDisplay.displayedFolder ||</span>
<a href="#l44.74"></a><span id="l44.74">         aFolderDisplay.displayedFolder.isServer) {</span>
<a href="#l44.75"></a><span id="l44.75" class="difflineat">@@ -64,44 +69,43 @@ var QuickFilterBarMuxer = {</span>
<a href="#l44.76"></a><span id="l44.76">       filterer.displayedFolder = null;</span>
<a href="#l44.77"></a><span id="l44.77">     }</span>
<a href="#l44.78"></a><span id="l44.78">   },</span>
<a href="#l44.79"></a><span id="l44.79"> </span>
<a href="#l44.80"></a><span id="l44.80">   /**</span>
<a href="#l44.81"></a><span id="l44.81">    * Based on the passed in 3pane aTabInfo, determine whether or not the</span>
<a href="#l44.82"></a><span id="l44.82">    * quickFilter toggle should be enabled, and set it appropriately.</span>
<a href="#l44.83"></a><span id="l44.83">    */</span>
<a href="#l44.84"></a><span id="l44.84" class="difflineminus">-  _updateToggle: function QFBM__updateToggle(aTabInfo) {</span>
<a href="#l44.85"></a><span id="l44.85" class="difflineplus">+  _updateToggle(aTabInfo) {</span>
<a href="#l44.86"></a><span id="l44.86">     if (!this.isCommandEnabled(&quot;cmd_toggleQuickFilterBar&quot;, aTabInfo)) {</span>
<a href="#l44.87"></a><span id="l44.87">       document.getElementById(&quot;view_toolbars_popup_quickFilterBar&quot;)</span>
<a href="#l44.88"></a><span id="l44.88">               .setAttribute(&quot;checked&quot;, false);</span>
<a href="#l44.89"></a><span id="l44.89">     }</span>
<a href="#l44.90"></a><span id="l44.90"> </span>
<a href="#l44.91"></a><span id="l44.91">     this._updateCommands();</span>
<a href="#l44.92"></a><span id="l44.92">   },</span>
<a href="#l44.93"></a><span id="l44.93"> </span>
<a href="#l44.94"></a><span id="l44.94">   /**</span>
<a href="#l44.95"></a><span id="l44.95">    * Update the commands associated with the quick filter bar.</span>
<a href="#l44.96"></a><span id="l44.96">    */</span>
<a href="#l44.97"></a><span id="l44.97" class="difflineminus">-  _updateCommands: function QFBM__updateCommands() {</span>
<a href="#l44.98"></a><span id="l44.98" class="difflineplus">+  _updateCommands() {</span>
<a href="#l44.99"></a><span id="l44.99">     goUpdateCommand(&quot;cmd_popQuickFilterBarStack&quot;);</span>
<a href="#l44.100"></a><span id="l44.100">     goUpdateCommand(&quot;cmd_showQuickFilterBar&quot;);</span>
<a href="#l44.101"></a><span id="l44.101">     goUpdateCommand(&quot;cmd_toggleQuickFilterBar&quot;);</span>
<a href="#l44.102"></a><span id="l44.102">   },</span>
<a href="#l44.103"></a><span id="l44.103"> </span>
<a href="#l44.104"></a><span id="l44.104">   /**</span>
<a href="#l44.105"></a><span id="l44.105">    * Clear out our state when notified the user has changed folders and re-apply</span>
<a href="#l44.106"></a><span id="l44.106">    *  search constraints if we are in sticky mode.  It is important that we</span>
<a href="#l44.107"></a><span id="l44.107">    *  re-apply search constraints here in onLoadingFolder as this is the only</span>
<a href="#l44.108"></a><span id="l44.108">    *  notification we receive where we have a chance to avoid creating a view</span>
<a href="#l44.109"></a><span id="l44.109">    *  just to nuke it and re-create it with our new search constraints shortly</span>
<a href="#l44.110"></a><span id="l44.110">    *  afterwards.</span>
<a href="#l44.111"></a><span id="l44.111">    */</span>
<a href="#l44.112"></a><span id="l44.112" class="difflineminus">-  onLoadingFolder: function QFBM_onFolderChanged(aFolderDisplay,</span>
<a href="#l44.113"></a><span id="l44.113" class="difflineminus">-                                                 aIsOutbound) {</span>
<a href="#l44.114"></a><span id="l44.114" class="difflineplus">+  onLoadingFolder(aFolderDisplay, aIsOutbound) {</span>
<a href="#l44.115"></a><span id="l44.115">     let tab = aFolderDisplay._tabInfo;</span>
<a href="#l44.116"></a><span id="l44.116">     let filterer = (&quot;quickFilter&quot; in tab._ext) ? tab._ext.quickFilter : null;</span>
<a href="#l44.117"></a><span id="l44.117">     if (!filterer)</span>
<a href="#l44.118"></a><span id="l44.118">       return;</span>
<a href="#l44.119"></a><span id="l44.119"> </span>
<a href="#l44.120"></a><span id="l44.120">     // check if there actually was a change (notification might not be for us)</span>
<a href="#l44.121"></a><span id="l44.121">     if (tab.folderDisplay.displayedFolder != filterer.displayedFolder) {</span>
<a href="#l44.122"></a><span id="l44.122">       // perform state propagation to a new filter state</span>
<a href="#l44.123"></a><span id="l44.123" class="difflineat">@@ -114,18 +118,17 @@ var QuickFilterBarMuxer = {</span>
<a href="#l44.124"></a><span id="l44.124">   /**</span>
<a href="#l44.125"></a><span id="l44.125">    * Once the view is fully populated:</span>
<a href="#l44.126"></a><span id="l44.126">    * - Invoke postFilterProcess on all filter definitions that expose such a</span>
<a href="#l44.127"></a><span id="l44.127">    *   method.  If they return a value, cram it in their state and (assuming</span>
<a href="#l44.128"></a><span id="l44.128">    *   this is the current tab), call their reflectInDOM method so they can</span>
<a href="#l44.129"></a><span id="l44.129">    *   update their state.</span>
<a href="#l44.130"></a><span id="l44.130">    * - Update UI to reflect some/no matches.</span>
<a href="#l44.131"></a><span id="l44.131">    */</span>
<a href="#l44.132"></a><span id="l44.132" class="difflineminus">-  onActiveMessagesLoaded:</span>
<a href="#l44.133"></a><span id="l44.133" class="difflineminus">-      function QFBM_onFolderDisplayMessagesLoaded(aFolderDisplay) {</span>
<a href="#l44.134"></a><span id="l44.134" class="difflineplus">+  onActiveMessagesLoaded(aFolderDisplay) {</span>
<a href="#l44.135"></a><span id="l44.135">     let filterer = this.maybeActiveFilterer;</span>
<a href="#l44.136"></a><span id="l44.136">     if (!filterer)</span>
<a href="#l44.137"></a><span id="l44.137">       return;</span>
<a href="#l44.138"></a><span id="l44.138"> </span>
<a href="#l44.139"></a><span id="l44.139">     let filtering = aFolderDisplay.view.search.userTerms != null;</span>
<a href="#l44.140"></a><span id="l44.140"> </span>
<a href="#l44.141"></a><span id="l44.141">     // - postFilterProcess everyone who cares</span>
<a href="#l44.142"></a><span id="l44.142">     // This may need to be converted into an asynchronous process at some point.</span>
<a href="#l44.143"></a><span id="l44.143" class="difflineat">@@ -152,59 +155,56 @@ var QuickFilterBarMuxer = {</span>
<a href="#l44.144"></a><span id="l44.144">     this.reflectFiltererResults(filterer, aFolderDisplay);</span>
<a href="#l44.145"></a><span id="l44.145">   },</span>
<a href="#l44.146"></a><span id="l44.146"> </span>
<a href="#l44.147"></a><span id="l44.147">   /**</span>
<a href="#l44.148"></a><span id="l44.148">    * If we're searching, update the filter results.  (If we stop searching,</span>
<a href="#l44.149"></a><span id="l44.149">    *  we're going to end up in the onFolderDisplayMessagesLoaded</span>
<a href="#l44.150"></a><span id="l44.150">    *  notification.  Mayhaps we should lose that vector and just use this one.)</span>
<a href="#l44.151"></a><span id="l44.151">    */</span>
<a href="#l44.152"></a><span id="l44.152" class="difflineminus">-  onSearching: function QFBM_onSearching(</span>
<a href="#l44.153"></a><span id="l44.153" class="difflineminus">-      aFolderDisplay, aIsSearching) {</span>
<a href="#l44.154"></a><span id="l44.154" class="difflineplus">+  onSearching(aFolderDisplay, aIsSearching) {</span>
<a href="#l44.155"></a><span id="l44.155">     // we only care if we just started searching and we are active</span>
<a href="#l44.156"></a><span id="l44.156">     if (!aIsSearching || !aFolderDisplay.active)</span>
<a href="#l44.157"></a><span id="l44.157">       return;</span>
<a href="#l44.158"></a><span id="l44.158"> </span>
<a href="#l44.159"></a><span id="l44.159">     // - Update match status.</span>
<a href="#l44.160"></a><span id="l44.160">     this.reflectFiltererResults(this.activeFilterer, aFolderDisplay);</span>
<a href="#l44.161"></a><span id="l44.161">   },</span>
<a href="#l44.162"></a><span id="l44.162"> </span>
<a href="#l44.163"></a><span id="l44.163"> </span>
<a href="#l44.164"></a><span id="l44.164" class="difflineminus">-  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l44.165"></a><span id="l44.165" class="difflineplus">+  // ---------------------</span>
<a href="#l44.166"></a><span id="l44.166">   // UI State Manipulation</span>
<a href="#l44.167"></a><span id="l44.167"> </span>
<a href="#l44.168"></a><span id="l44.168">   /**</span>
<a href="#l44.169"></a><span id="l44.169">    * Add appropriate event handlers to the DOM elements.  We do this rather</span>
<a href="#l44.170"></a><span id="l44.170">    *  than requiring lots of boilerplate &quot;oncommand&quot; junk on the nodes.</span>
<a href="#l44.171"></a><span id="l44.171">    *</span>
<a href="#l44.172"></a><span id="l44.172">    * We hook up the following:</span>
<a href="#l44.173"></a><span id="l44.173">    * - &quot;command&quot; event listener.</span>
<a href="#l44.174"></a><span id="l44.174">    * - reflect filter state</span>
<a href="#l44.175"></a><span id="l44.175">    */</span>
<a href="#l44.176"></a><span id="l44.176" class="difflineminus">-  _bindUI: function QFBM__bindUI() {</span>
<a href="#l44.177"></a><span id="l44.177" class="difflineplus">+  _bindUI() {</span>
<a href="#l44.178"></a><span id="l44.178">     for (let filterDef of QuickFilterManager.filterDefs) {</span>
<a href="#l44.179"></a><span id="l44.179">       let domNode = document.getElementById(filterDef.domId);</span>
<a href="#l44.180"></a><span id="l44.180">       // the loop let binding does not latch, at least in 1.9.2</span>
<a href="#l44.181"></a><span id="l44.181">       let latchedFilterDef = filterDef;</span>
<a href="#l44.182"></a><span id="l44.182"> </span>
<a href="#l44.183"></a><span id="l44.183">       let handler;</span>
<a href="#l44.184"></a><span id="l44.184">       if (!(&quot;onCommand&quot; in filterDef)) {</span>
<a href="#l44.185"></a><span id="l44.185">         handler = function(aEvent) {</span>
<a href="#l44.186"></a><span id="l44.186">           try {</span>
<a href="#l44.187"></a><span id="l44.187">             let postValue = domNode.checked ? true : null;</span>
<a href="#l44.188"></a><span id="l44.188">             QuickFilterBarMuxer.activeFilterer.setFilterValue(</span>
<a href="#l44.189"></a><span id="l44.189">               latchedFilterDef.name, postValue);</span>
<a href="#l44.190"></a><span id="l44.190">             QuickFilterBarMuxer.deferredUpdateSearch();</span>
<a href="#l44.191"></a><span id="l44.191" class="difflineminus">-          }</span>
<a href="#l44.192"></a><span id="l44.192" class="difflineminus">-          catch (ex) {</span>
<a href="#l44.193"></a><span id="l44.193" class="difflineplus">+          } catch (ex) {</span>
<a href="#l44.194"></a><span id="l44.194">             logException(ex);</span>
<a href="#l44.195"></a><span id="l44.195">           }</span>
<a href="#l44.196"></a><span id="l44.196">         };</span>
<a href="#l44.197"></a><span id="l44.197" class="difflineminus">-      }</span>
<a href="#l44.198"></a><span id="l44.198" class="difflineminus">-      else {</span>
<a href="#l44.199"></a><span id="l44.199" class="difflineplus">+      } else {</span>
<a href="#l44.200"></a><span id="l44.200">         handler = function(aEvent) {</span>
<a href="#l44.201"></a><span id="l44.201">           let filterValues = QuickFilterBarMuxer.activeFilterer.filterValues;</span>
<a href="#l44.202"></a><span id="l44.202">           let preValue = (latchedFilterDef.name in filterValues) ?</span>
<a href="#l44.203"></a><span id="l44.203">                            filterValues[latchedFilterDef.name] : null;</span>
<a href="#l44.204"></a><span id="l44.204">           let [postValue, update] =</span>
<a href="#l44.205"></a><span id="l44.205">             latchedFilterDef.onCommand(preValue, domNode, aEvent, document);</span>
<a href="#l44.206"></a><span id="l44.206">           QuickFilterBarMuxer.activeFilterer.setFilterValue(</span>
<a href="#l44.207"></a><span id="l44.207">             latchedFilterDef.name, postValue, !update);</span>
<a href="#l44.208"></a><span id="l44.208" class="difflineat">@@ -221,19 +221,17 @@ var QuickFilterBarMuxer = {</span>
<a href="#l44.209"></a><span id="l44.209"> </span>
<a href="#l44.210"></a><span id="l44.210">   /**</span>
<a href="#l44.211"></a><span id="l44.211">    * Update the UI to reflect the state of the filterer constraints.</span>
<a href="#l44.212"></a><span id="l44.212">    *</span>
<a href="#l44.213"></a><span id="l44.213">    * @param aFilterer The active filterer.</span>
<a href="#l44.214"></a><span id="l44.214">    * @param aFolderDisplay The active FolderDisplayWidget.</span>
<a href="#l44.215"></a><span id="l44.215">    * @param [aFilterName] If only a single filter needs to be updated, name it.</span>
<a href="#l44.216"></a><span id="l44.216">    */</span>
<a href="#l44.217"></a><span id="l44.217" class="difflineminus">-  reflectFiltererState: function QFBM_reflectFiltererState(aFilterer,</span>
<a href="#l44.218"></a><span id="l44.218" class="difflineminus">-                                                           aFolderDisplay,</span>
<a href="#l44.219"></a><span id="l44.219" class="difflineminus">-                                                           aFilterName) {</span>
<a href="#l44.220"></a><span id="l44.220" class="difflineplus">+  reflectFiltererState(aFilterer, aFolderDisplay, aFilterName) {</span>
<a href="#l44.221"></a><span id="l44.221">     // If we aren't visible then there is no need to update the widgets.</span>
<a href="#l44.222"></a><span id="l44.222">     if (aFilterer.visible) {</span>
<a href="#l44.223"></a><span id="l44.223">       let filterValues = aFilterer.filterValues;</span>
<a href="#l44.224"></a><span id="l44.224">       for (let filterDef of QuickFilterManager.filterDefs) {</span>
<a href="#l44.225"></a><span id="l44.225">         // If we only need to update one state, check and skip as appropriate.</span>
<a href="#l44.226"></a><span id="l44.226">         if (aFilterName &amp;&amp; filterDef.name != aFilterName)</span>
<a href="#l44.227"></a><span id="l44.227">           continue;</span>
<a href="#l44.228"></a><span id="l44.228"> </span>
<a href="#l44.229"></a><span id="l44.229" class="difflineat">@@ -263,58 +261,51 @@ var QuickFilterBarMuxer = {</span>
<a href="#l44.230"></a><span id="l44.230">    * We can have one of four states:</span>
<a href="#l44.231"></a><span id="l44.231">    * - No filter is active; no attributes exposed for CSS to do anything.</span>
<a href="#l44.232"></a><span id="l44.232">    * - A filter is active and we are still searching; filterActive=searching.</span>
<a href="#l44.233"></a><span id="l44.233">    * - A filter is active, completed searching, and we have results;</span>
<a href="#l44.234"></a><span id="l44.234">    *   filterActive=matches.</span>
<a href="#l44.235"></a><span id="l44.235">    * - A filter is active, completed searching, and we have no results;</span>
<a href="#l44.236"></a><span id="l44.236">    *   filterActive=nomatches.</span>
<a href="#l44.237"></a><span id="l44.237">    */</span>
<a href="#l44.238"></a><span id="l44.238" class="difflineminus">-  reflectFiltererResults: function QFBM_reflectFiltererResults(aFilterer,</span>
<a href="#l44.239"></a><span id="l44.239" class="difflineminus">-                                                               aFolderDisplay) {</span>
<a href="#l44.240"></a><span id="l44.240" class="difflineplus">+  reflectFiltererResults(aFilterer, aFolderDisplay) {</span>
<a href="#l44.241"></a><span id="l44.241">     let view = aFolderDisplay.view;</span>
<a href="#l44.242"></a><span id="l44.242">     let threadPane = document.getElementById(&quot;threadTree&quot;);</span>
<a href="#l44.243"></a><span id="l44.243">     let qfb = document.getElementById(&quot;quick-filter-bar&quot;);</span>
<a href="#l44.244"></a><span id="l44.244"> </span>
<a href="#l44.245"></a><span id="l44.245">     // bail early if the view is in the process of being created</span>
<a href="#l44.246"></a><span id="l44.246">     if (!view.dbView)</span>
<a href="#l44.247"></a><span id="l44.247">       return;</span>
<a href="#l44.248"></a><span id="l44.248"> </span>
<a href="#l44.249"></a><span id="l44.249">     // no filter active</span>
<a href="#l44.250"></a><span id="l44.250">     if (!view.search || !view.search.userTerms) {</span>
<a href="#l44.251"></a><span id="l44.251">       threadPane.removeAttribute(&quot;filterActive&quot;);</span>
<a href="#l44.252"></a><span id="l44.252">       qfb.removeAttribute(&quot;filterActive&quot;);</span>
<a href="#l44.253"></a><span id="l44.253" class="difflineminus">-    }</span>
<a href="#l44.254"></a><span id="l44.254" class="difflineminus">-    // filter active, still searching</span>
<a href="#l44.255"></a><span id="l44.255" class="difflineminus">-    else if (view.searching) {</span>
<a href="#l44.256"></a><span id="l44.256" class="difflineplus">+    } else if (view.searching) { // filter active, still searching</span>
<a href="#l44.257"></a><span id="l44.257">       // Do not set this immediately; wait a bit and then only set this if we</span>
<a href="#l44.258"></a><span id="l44.258">       //  still are in this same state (and we are still the active tab...)</span>
<a href="#l44.259"></a><span id="l44.259">       setTimeout(function() {</span>
<a href="#l44.260"></a><span id="l44.260">         if (!view.searching ||</span>
<a href="#l44.261"></a><span id="l44.261">             (QuickFilterBarMuxer.maybeActiveFilterer != aFilterer))</span>
<a href="#l44.262"></a><span id="l44.262">           return;</span>
<a href="#l44.263"></a><span id="l44.263">         threadPane.setAttribute(&quot;filterActive&quot;, &quot;searching&quot;);</span>
<a href="#l44.264"></a><span id="l44.264">         qfb.setAttribute(&quot;filterActive&quot;, &quot;searching&quot;);</span>
<a href="#l44.265"></a><span id="l44.265">       }, 500);</span>
<a href="#l44.266"></a><span id="l44.266" class="difflineminus">-    }</span>
<a href="#l44.267"></a><span id="l44.267" class="difflineminus">-    // filter completed, results</span>
<a href="#l44.268"></a><span id="l44.268" class="difflineminus">-    else if (view.dbView.numMsgsInView) {</span>
<a href="#l44.269"></a><span id="l44.269" class="difflineplus">+    } else if (view.dbView.numMsgsInView) { // filter completed, results</span>
<a href="#l44.270"></a><span id="l44.270">       // some matches</span>
<a href="#l44.271"></a><span id="l44.271">       threadPane.setAttribute(&quot;filterActive&quot;, &quot;matches&quot;);</span>
<a href="#l44.272"></a><span id="l44.272">       qfb.setAttribute(&quot;filterActive&quot;, &quot;matches&quot;);</span>
<a href="#l44.273"></a><span id="l44.273" class="difflineminus">-    }</span>
<a href="#l44.274"></a><span id="l44.274" class="difflineminus">-    // filter completed, no results</span>
<a href="#l44.275"></a><span id="l44.275" class="difflineminus">-    else {</span>
<a href="#l44.276"></a><span id="l44.276" class="difflineplus">+    } else { // filter completed, no results</span>
<a href="#l44.277"></a><span id="l44.277">       // no matches! :(</span>
<a href="#l44.278"></a><span id="l44.278">       threadPane.setAttribute(&quot;filterActive&quot;, &quot;nomatches&quot;);</span>
<a href="#l44.279"></a><span id="l44.279">       qfb.setAttribute(&quot;filterActive&quot;, &quot;nomatches&quot;);</span>
<a href="#l44.280"></a><span id="l44.280">     }</span>
<a href="#l44.281"></a><span id="l44.281">   },</span>
<a href="#l44.282"></a><span id="l44.282"> </span>
<a href="#l44.283"></a><span id="l44.283" class="difflineminus">-  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l44.284"></a><span id="l44.284" class="difflineplus">+  // ----------------</span>
<a href="#l44.285"></a><span id="l44.285">   // Resizing regimen</span>
<a href="#l44.286"></a><span id="l44.286"> </span>
<a href="#l44.287"></a><span id="l44.287">   /**</span>
<a href="#l44.288"></a><span id="l44.288">    * Are the button labels currently collapsed?</span>
<a href="#l44.289"></a><span id="l44.289">    */</span>
<a href="#l44.290"></a><span id="l44.290">   _buttonLabelsCollapsed: false,</span>
<a href="#l44.291"></a><span id="l44.291"> </span>
<a href="#l44.292"></a><span id="l44.292">   /**</span>
<a href="#l44.293"></a><span id="l44.293" class="difflineat">@@ -339,17 +330,17 @@ var QuickFilterBarMuxer = {</span>
<a href="#l44.294"></a><span id="l44.294">    *   so that once it gets large enough again we can restore the buttons.</span>
<a href="#l44.295"></a><span id="l44.295">    * - On overflow we also lose the minwidth constraint on the search box so it</span>
<a href="#l44.296"></a><span id="l44.296">    *   resizes down in a reasonable fashion.</span>
<a href="#l44.297"></a><span id="l44.297">    *</span>
<a href="#l44.298"></a><span id="l44.298">    * This method handles the overflow case where we transition to collapsed</span>
<a href="#l44.299"></a><span id="l44.299">    * buttons.  Our onWindowResize logic handles detecting when it is time to</span>
<a href="#l44.300"></a><span id="l44.300">    * un-collapse.</span>
<a href="#l44.301"></a><span id="l44.301">    */</span>
<a href="#l44.302"></a><span id="l44.302" class="difflineminus">-  onOverflow: function QFBM_onOverflow() {</span>
<a href="#l44.303"></a><span id="l44.303" class="difflineplus">+  onOverflow() {</span>
<a href="#l44.304"></a><span id="l44.304">     // If we are already collapsed, there is nothing more to do.</span>
<a href="#l44.305"></a><span id="l44.305">     if (this._buttonLabelsCollapsed)</span>
<a href="#l44.306"></a><span id="l44.306">       return;</span>
<a href="#l44.307"></a><span id="l44.307"> </span>
<a href="#l44.308"></a><span id="l44.308">     let quickFilterBarBox =</span>
<a href="#l44.309"></a><span id="l44.309">       document.getElementById(&quot;quick-filter-bar-main-bar&quot;);</span>
<a href="#l44.310"></a><span id="l44.310">     let collapsibleButtonBox =</span>
<a href="#l44.311"></a><span id="l44.311">       document.getElementById(&quot;quick-filter-bar-collapsible-buttons&quot;);</span>
<a href="#l44.312"></a><span id="l44.312" class="difflineat">@@ -367,17 +358,17 @@ var QuickFilterBarMuxer = {</span>
<a href="#l44.313"></a><span id="l44.313"> </span>
<a href="#l44.314"></a><span id="l44.314">   },</span>
<a href="#l44.315"></a><span id="l44.315"> </span>
<a href="#l44.316"></a><span id="l44.316">   /**</span>
<a href="#l44.317"></a><span id="l44.317">    * Counterpart to |onOverflow| un-collapses the buttons once the quick filter</span>
<a href="#l44.318"></a><span id="l44.318">    *  bar gets wide enough to support the desired minimum widget of the bar when</span>
<a href="#l44.319"></a><span id="l44.319">    *  the buttons are not collapsed.</span>
<a href="#l44.320"></a><span id="l44.320">    */</span>
<a href="#l44.321"></a><span id="l44.321" class="difflineminus">-  onWindowResize: function QFB_onWindowResize() {</span>
<a href="#l44.322"></a><span id="l44.322" class="difflineplus">+  onWindowResize() {</span>
<a href="#l44.323"></a><span id="l44.323">     // nothing to do here if the buttons are not collapsed</span>
<a href="#l44.324"></a><span id="l44.324">     if (!this._buttonLabelsCollapsed)</span>
<a href="#l44.325"></a><span id="l44.325">       return;</span>
<a href="#l44.326"></a><span id="l44.326"> </span>
<a href="#l44.327"></a><span id="l44.327">     let quickFilterBarBox =</span>
<a href="#l44.328"></a><span id="l44.328">       document.getElementById(&quot;quick-filter-bar-main-bar&quot;);</span>
<a href="#l44.329"></a><span id="l44.329">     // the client width is how big it actually is (thanks to overflow:hidden)</span>
<a href="#l44.330"></a><span id="l44.330">     if (quickFilterBarBox.clientWidth &lt; this._minExpandedBarWidth)</span>
<a href="#l44.331"></a><span id="l44.331" class="difflineat">@@ -393,123 +384,119 @@ var QuickFilterBarMuxer = {</span>
<a href="#l44.332"></a><span id="l44.332">       this._savedOffTextWidgetMinWidth = null;</span>
<a href="#l44.333"></a><span id="l44.333">     }</span>
<a href="#l44.334"></a><span id="l44.334"> </span>
<a href="#l44.335"></a><span id="l44.335">     let collapsibleButtonBox =</span>
<a href="#l44.336"></a><span id="l44.336">       document.getElementById(&quot;quick-filter-bar-collapsible-buttons&quot;);</span>
<a href="#l44.337"></a><span id="l44.337">     collapsibleButtonBox.removeAttribute(&quot;shrink&quot;);</span>
<a href="#l44.338"></a><span id="l44.338">   },</span>
<a href="#l44.339"></a><span id="l44.339"> </span>
<a href="#l44.340"></a><span id="l44.340" class="difflineminus">-  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l44.341"></a><span id="l44.341" class="difflineplus">+  // -----------------------</span>
<a href="#l44.342"></a><span id="l44.342">   // Tab Monitor Interaction</span>
<a href="#l44.343"></a><span id="l44.343"> </span>
<a href="#l44.344"></a><span id="l44.344">   monitorName: &quot;quickFilter&quot;,</span>
<a href="#l44.345"></a><span id="l44.345"> </span>
<a href="#l44.346"></a><span id="l44.346" class="difflineminus">-  onTabTitleChanged: function QFBM_onTabTitleChanged(aTab) {</span>
<a href="#l44.347"></a><span id="l44.347" class="difflineplus">+  onTabTitleChanged(aTab) {</span>
<a href="#l44.348"></a><span id="l44.348">     // nop</span>
<a href="#l44.349"></a><span id="l44.349">   },</span>
<a href="#l44.350"></a><span id="l44.350"> </span>
<a href="#l44.351"></a><span id="l44.351">   /**</span>
<a href="#l44.352"></a><span id="l44.352">    * Whenever an appropriate new tab is opened, initialize its quick filter</span>
<a href="#l44.353"></a><span id="l44.353">    *  state.</span>
<a href="#l44.354"></a><span id="l44.354">    */</span>
<a href="#l44.355"></a><span id="l44.355" class="difflineminus">-  onTabOpened: function QFBM_onTabOpened(aTab, aFirstTab, aOldTab) {</span>
<a href="#l44.356"></a><span id="l44.356" class="difflineplus">+  onTabOpened(aTab, aFirstTab, aOldTab) {</span>
<a href="#l44.357"></a><span id="l44.357">     if (aTab.mode.name == &quot;folder&quot; ||</span>
<a href="#l44.358"></a><span id="l44.358">         aTab.mode.name == &quot;glodaList&quot;) {</span>
<a href="#l44.359"></a><span id="l44.359">       let modelTab =</span>
<a href="#l44.360"></a><span id="l44.360">         this.tabmail.getTabInfoForCurrentOrFirstModeInstance(aTab.mode);</span>
<a href="#l44.361"></a><span id="l44.361">       let oldFilterer = (modelTab &amp;&amp; (&quot;quickFilter&quot; in modelTab._ext)) ?</span>
<a href="#l44.362"></a><span id="l44.362">                           modelTab._ext.quickFilter : undefined;</span>
<a href="#l44.363"></a><span id="l44.363">       aTab._ext.quickFilter = new QuickFilterState(oldFilterer);</span>
<a href="#l44.364"></a><span id="l44.364">       this.updateSearch(aTab);</span>
<a href="#l44.365"></a><span id="l44.365">       this._updateToggle(aTab);</span>
<a href="#l44.366"></a><span id="l44.366">     }</span>
<a href="#l44.367"></a><span id="l44.367">   },</span>
<a href="#l44.368"></a><span id="l44.368"> </span>
<a href="#l44.369"></a><span id="l44.369" class="difflineminus">-  onTabRestored: function QFBM_onTabRestored(aTab, aState, aFirstTab) {</span>
<a href="#l44.370"></a><span id="l44.370" class="difflineplus">+  onTabRestored(aTab, aState, aFirstTab) {</span>
<a href="#l44.371"></a><span id="l44.371">     let filterer = aTab._ext.quickFilter = new QuickFilterState(null, aState);</span>
<a href="#l44.372"></a><span id="l44.372">     this.updateSearch(aTab);</span>
<a href="#l44.373"></a><span id="l44.373">     if (aTab == this.tabmail.currentTabInfo)</span>
<a href="#l44.374"></a><span id="l44.374">       this.reflectFiltererState(filterer, aTab.folderDisplay);</span>
<a href="#l44.375"></a><span id="l44.375">   },</span>
<a href="#l44.376"></a><span id="l44.376"> </span>
<a href="#l44.377"></a><span id="l44.377" class="difflineminus">-  onTabPersist: function QFBM_onTabPersist(aTab) {</span>
<a href="#l44.378"></a><span id="l44.378" class="difflineplus">+  onTabPersist(aTab) {</span>
<a href="#l44.379"></a><span id="l44.379">     let filterer = (&quot;quickFilter&quot; in aTab._ext) ? aTab._ext.quickFilter : null;</span>
<a href="#l44.380"></a><span id="l44.380">     if (filterer)</span>
<a href="#l44.381"></a><span id="l44.381">       return filterer.persistToObj();</span>
<a href="#l44.382"></a><span id="l44.382">     return null;</span>
<a href="#l44.383"></a><span id="l44.383">   },</span>
<a href="#l44.384"></a><span id="l44.384"> </span>
<a href="#l44.385"></a><span id="l44.385">   /**</span>
<a href="#l44.386"></a><span id="l44.386">    * On tab switch we need to:</span>
<a href="#l44.387"></a><span id="l44.387">    * - Restore state for already existing state</span>
<a href="#l44.388"></a><span id="l44.388">    * - Create state if it's a new (to us) tab</span>
<a href="#l44.389"></a><span id="l44.389">    */</span>
<a href="#l44.390"></a><span id="l44.390" class="difflineminus">-  onTabSwitched: function QFBM_onTabSwitched(aTab, aOldTab) {</span>
<a href="#l44.391"></a><span id="l44.391" class="difflineplus">+  onTabSwitched(aTab, aOldTab) {</span>
<a href="#l44.392"></a><span id="l44.392">     // (Note: we used to explicitly handle the possibility that the user had</span>
<a href="#l44.393"></a><span id="l44.393">     // typed something but an ontimeout had not yet fired in the textbox.</span>
<a href="#l44.394"></a><span id="l44.394">     // We are bailing on that because it adds complexity without much functional</span>
<a href="#l44.395"></a><span id="l44.395">     // gain.  Our UI will be consistent when we switch back to the tab, which</span>
<a href="#l44.396"></a><span id="l44.396">     // is good enough.)</span>
<a href="#l44.397"></a><span id="l44.397"> </span>
<a href="#l44.398"></a><span id="l44.398">     let filterer = this.maybeActiveFilterer;</span>
<a href="#l44.399"></a><span id="l44.399">     if (filterer)</span>
<a href="#l44.400"></a><span id="l44.400">       this.reflectFiltererState(filterer, aTab.folderDisplay);</span>
<a href="#l44.401"></a><span id="l44.401">     this._updateCommands();</span>
<a href="#l44.402"></a><span id="l44.402">   },</span>
<a href="#l44.403"></a><span id="l44.403"> </span>
<a href="#l44.404"></a><span id="l44.404" class="difflineminus">-  supportsCommand: function QFBM_supportsCommand(aCommand, aTab) {</span>
<a href="#l44.405"></a><span id="l44.405" class="difflineplus">+  supportsCommand(aCommand, aTab) {</span>
<a href="#l44.406"></a><span id="l44.406">     // we are not active on tab types we do not support (message tabs)</span>
<a href="#l44.407"></a><span id="l44.407">     if (!(&quot;quickFilter&quot; in aTab._ext))</span>
<a href="#l44.408"></a><span id="l44.408">       return null;</span>
<a href="#l44.409"></a><span id="l44.409"> </span>
<a href="#l44.410"></a><span id="l44.410">     if (aCommand == &quot;cmd_popQuickFilterBarStack&quot; ||</span>
<a href="#l44.411"></a><span id="l44.411">         aCommand == &quot;cmd_showQuickFilterBar&quot; ||</span>
<a href="#l44.412"></a><span id="l44.412">         aCommand == &quot;cmd_toggleQuickFilterBar&quot;)</span>
<a href="#l44.413"></a><span id="l44.413">       return true;</span>
<a href="#l44.414"></a><span id="l44.414" class="difflineminus">-    else</span>
<a href="#l44.415"></a><span id="l44.415" class="difflineminus">-      return null;</span>
<a href="#l44.416"></a><span id="l44.416" class="difflineplus">+    return null;</span>
<a href="#l44.417"></a><span id="l44.417">   },</span>
<a href="#l44.418"></a><span id="l44.418" class="difflineminus">-  isCommandEnabled: function QFBM_isCommandEnabled(aCommand, aTab) {</span>
<a href="#l44.419"></a><span id="l44.419" class="difflineplus">+  isCommandEnabled(aCommand, aTab) {</span>
<a href="#l44.420"></a><span id="l44.420">     // we are not active on tab types we do not support (message tabs)</span>
<a href="#l44.421"></a><span id="l44.421">     if (!(&quot;quickFilter&quot; in aTab._ext))</span>
<a href="#l44.422"></a><span id="l44.422">       return null;</span>
<a href="#l44.423"></a><span id="l44.423"> </span>
<a href="#l44.424"></a><span id="l44.424">     let isFolderView = (aTab.mode.name == &quot;folder&quot; &amp;&amp;</span>
<a href="#l44.425"></a><span id="l44.425">                         aTab.folderDisplay.displayedFolder &amp;&amp;</span>
<a href="#l44.426"></a><span id="l44.426">                         !aTab.folderDisplay.displayedFolder.isServer);</span>
<a href="#l44.427"></a><span id="l44.427">     let isGlodaList = aTab.mode.name == &quot;glodaList&quot;;</span>
<a href="#l44.428"></a><span id="l44.428"> </span>
<a href="#l44.429"></a><span id="l44.429">     if (!isFolderView &amp;&amp; !isGlodaList)</span>
<a href="#l44.430"></a><span id="l44.430">       return null;</span>
<a href="#l44.431"></a><span id="l44.431"> </span>
<a href="#l44.432"></a><span id="l44.432">     if (aCommand == &quot;cmd_popQuickFilterBarStack&quot; ||</span>
<a href="#l44.433"></a><span id="l44.433">         aCommand == &quot;cmd_showQuickFilterBar&quot; ||</span>
<a href="#l44.434"></a><span id="l44.434">         aCommand == &quot;cmd_toggleQuickFilterBar&quot;)</span>
<a href="#l44.435"></a><span id="l44.435">       return true;</span>
<a href="#l44.436"></a><span id="l44.436" class="difflineminus">-    else</span>
<a href="#l44.437"></a><span id="l44.437" class="difflineminus">-      return null;</span>
<a href="#l44.438"></a><span id="l44.438" class="difflineplus">+    return null;</span>
<a href="#l44.439"></a><span id="l44.439">   },</span>
<a href="#l44.440"></a><span id="l44.440" class="difflineminus">-  doCommand: function QFBM_doCommand(aCommand, aTab) {</span>
<a href="#l44.441"></a><span id="l44.441" class="difflineplus">+  doCommand(aCommand, aTab) {</span>
<a href="#l44.442"></a><span id="l44.442">     // we are not active on tab types we do not support (message tabs)</span>
<a href="#l44.443"></a><span id="l44.443">     if (!(&quot;quickFilter&quot; in aTab._ext))</span>
<a href="#l44.444"></a><span id="l44.444">       return null;</span>
<a href="#l44.445"></a><span id="l44.445"> </span>
<a href="#l44.446"></a><span id="l44.446">     if (aCommand == &quot;cmd_popQuickFilterBarStack&quot;) {</span>
<a href="#l44.447"></a><span id="l44.447">       QuickFilterBarMuxer.cmdEscapeFilterStack();</span>
<a href="#l44.448"></a><span id="l44.448">       return true;</span>
<a href="#l44.449"></a><span id="l44.449" class="difflineminus">-    }</span>
<a href="#l44.450"></a><span id="l44.450" class="difflineminus">-    else if (aCommand == &quot;cmd_showQuickFilterBar&quot;) {</span>
<a href="#l44.451"></a><span id="l44.451" class="difflineplus">+    } else if (aCommand == &quot;cmd_showQuickFilterBar&quot;) {</span>
<a href="#l44.452"></a><span id="l44.452">       let textWidget = document.getElementById(QuickFilterManager.textBoxDomId);</span>
<a href="#l44.453"></a><span id="l44.453" class="difflineminus">-      if (this.activeFilterer.visible == false)</span>
<a href="#l44.454"></a><span id="l44.454" class="difflineplus">+      if (!this.activeFilterer.visible)</span>
<a href="#l44.455"></a><span id="l44.455">         QuickFilterBarMuxer._showFilterBar(true);</span>
<a href="#l44.456"></a><span id="l44.456">       textWidget.select();</span>
<a href="#l44.457"></a><span id="l44.457">       return true;</span>
<a href="#l44.458"></a><span id="l44.458" class="difflineminus">-    }</span>
<a href="#l44.459"></a><span id="l44.459" class="difflineminus">-    else if (aCommand == &quot;cmd_toggleQuickFilterBar&quot;) {</span>
<a href="#l44.460"></a><span id="l44.460" class="difflineplus">+    } else if (aCommand == &quot;cmd_toggleQuickFilterBar&quot;) {</span>
<a href="#l44.461"></a><span id="l44.461">       let show = !this.activeFilterer.visible;</span>
<a href="#l44.462"></a><span id="l44.462">       this._showFilterBar(show);</span>
<a href="#l44.463"></a><span id="l44.463">       if (show) {</span>
<a href="#l44.464"></a><span id="l44.464">         let textWidget = document.getElementById(QuickFilterManager.textBoxDomId);</span>
<a href="#l44.465"></a><span id="l44.465">         textWidget.select();</span>
<a href="#l44.466"></a><span id="l44.466">       }</span>
<a href="#l44.467"></a><span id="l44.467">       return true;</span>
<a href="#l44.468"></a><span id="l44.468">     }</span>
<a href="#l44.469"></a><span id="l44.469" class="difflineat">@@ -525,62 +512,62 @@ var QuickFilterBarMuxer = {</span>
<a href="#l44.470"></a><span id="l44.470"> </span>
<a href="#l44.471"></a><span id="l44.471">   get activeFilterer() {</span>
<a href="#l44.472"></a><span id="l44.472">     if (this.tabmail.currentTabInfo &amp;&amp;</span>
<a href="#l44.473"></a><span id="l44.473">         &quot;quickFilter&quot; in this.tabmail.currentTabInfo._ext)</span>
<a href="#l44.474"></a><span id="l44.474">       return this.tabmail.currentTabInfo._ext.quickFilter;</span>
<a href="#l44.475"></a><span id="l44.475">     throw errorWithDebug(&quot;There is no active filterer but we want one.&quot;);</span>
<a href="#l44.476"></a><span id="l44.476">   },</span>
<a href="#l44.477"></a><span id="l44.477"> </span>
<a href="#l44.478"></a><span id="l44.478" class="difflineminus">-  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l44.479"></a><span id="l44.479" class="difflineplus">+  // ----------------------</span>
<a href="#l44.480"></a><span id="l44.480">   // Event Handling Support</span>
<a href="#l44.481"></a><span id="l44.481"> </span>
<a href="#l44.482"></a><span id="l44.482">   /**</span>
<a href="#l44.483"></a><span id="l44.483">    * Retrieve the current filter state value (presumably an object) for mutation</span>
<a href="#l44.484"></a><span id="l44.484">    *  purposes.  This causes the filter to be the last touched filter for escape</span>
<a href="#l44.485"></a><span id="l44.485">    *  undo-ish purposes.</span>
<a href="#l44.486"></a><span id="l44.486">    */</span>
<a href="#l44.487"></a><span id="l44.487" class="difflineminus">-  getFilterValueForMutation: function QFBM_getFilterValueForMutation(aName) {</span>
<a href="#l44.488"></a><span id="l44.488" class="difflineplus">+  getFilterValueForMutation(aName) {</span>
<a href="#l44.489"></a><span id="l44.489">     return this.activeFilterer.getFilterValue(aName);</span>
<a href="#l44.490"></a><span id="l44.490">   },</span>
<a href="#l44.491"></a><span id="l44.491"> </span>
<a href="#l44.492"></a><span id="l44.492">   /**</span>
<a href="#l44.493"></a><span id="l44.493">    * Set the filter state for the given named filter to the given value.  This</span>
<a href="#l44.494"></a><span id="l44.494">    *  causes the filter to be the last touched filter for escape undo-ish</span>
<a href="#l44.495"></a><span id="l44.495">    *  purposes.</span>
<a href="#l44.496"></a><span id="l44.496">    *</span>
<a href="#l44.497"></a><span id="l44.497">    * @param aName Filter name.</span>
<a href="#l44.498"></a><span id="l44.498">    * @param aValue The new filter state.</span>
<a href="#l44.499"></a><span id="l44.499">    */</span>
<a href="#l44.500"></a><span id="l44.500" class="difflineminus">-  setFilterValue: function QFBM_setFilterValue(aName, aValue) {</span>
<a href="#l44.501"></a><span id="l44.501" class="difflineplus">+  setFilterValue(aName, aValue) {</span>
<a href="#l44.502"></a><span id="l44.502">     this.activeFilterer.setFilterValue(aName, aValue);</span>
<a href="#l44.503"></a><span id="l44.503">   },</span>
<a href="#l44.504"></a><span id="l44.504"> </span>
<a href="#l44.505"></a><span id="l44.505">   /**</span>
<a href="#l44.506"></a><span id="l44.506">    * For UI responsiveness purposes, defer the actual initiation of the search</span>
<a href="#l44.507"></a><span id="l44.507">    *  until after the button click handling has completed and had the ability</span>
<a href="#l44.508"></a><span id="l44.508">    *  to paint such.</span>
<a href="#l44.509"></a><span id="l44.509">    */</span>
<a href="#l44.510"></a><span id="l44.510" class="difflineminus">-  deferredUpdateSearch: function QFBM_deferredUpdateSearch() {</span>
<a href="#l44.511"></a><span id="l44.511" class="difflineplus">+  deferredUpdateSearch() {</span>
<a href="#l44.512"></a><span id="l44.512">     setTimeout(this._deferredInvocUpdateSearch, 10);</span>
<a href="#l44.513"></a><span id="l44.513">   },</span>
<a href="#l44.514"></a><span id="l44.514"> </span>
<a href="#l44.515"></a><span id="l44.515">   /**</span>
<a href="#l44.516"></a><span id="l44.516">    * The actual helper function to call updateSearch for deferredUpdateSearch</span>
<a href="#l44.517"></a><span id="l44.517">    *  that makes 'this' relevant.</span>
<a href="#l44.518"></a><span id="l44.518">    */</span>
<a href="#l44.519"></a><span id="l44.519" class="difflineminus">-  _deferredInvocUpdateSearch: function QFBM__deferredInvocUpdateSearch() {</span>
<a href="#l44.520"></a><span id="l44.520" class="difflineplus">+  _deferredInvocUpdateSearch() {</span>
<a href="#l44.521"></a><span id="l44.521">     QuickFilterBarMuxer.updateSearch();</span>
<a href="#l44.522"></a><span id="l44.522">   },</span>
<a href="#l44.523"></a><span id="l44.523"> </span>
<a href="#l44.524"></a><span id="l44.524">   /**</span>
<a href="#l44.525"></a><span id="l44.525">    * Update the user terms part of the search definition to reflect the active</span>
<a href="#l44.526"></a><span id="l44.526">    *  filterer's current state.</span>
<a href="#l44.527"></a><span id="l44.527">    */</span>
<a href="#l44.528"></a><span id="l44.528" class="difflineminus">-  updateSearch: function QFBM_updateSearch(aTab) {</span>
<a href="#l44.529"></a><span id="l44.529" class="difflineplus">+  updateSearch(aTab) {</span>
<a href="#l44.530"></a><span id="l44.530">     let tab = aTab || this.tabmail.currentTabInfo;</span>
<a href="#l44.531"></a><span id="l44.531">     // bail if things don't really exist yet</span>
<a href="#l44.532"></a><span id="l44.532">     if (!tab.folderDisplay || !tab.folderDisplay.view.search)</span>
<a href="#l44.533"></a><span id="l44.533">       return;</span>
<a href="#l44.534"></a><span id="l44.534"> </span>
<a href="#l44.535"></a><span id="l44.535">     let filterer = tab._ext.quickFilter;</span>
<a href="#l44.536"></a><span id="l44.536">     filterer.displayedFolder = tab.folderDisplay.displayedFolder;</span>
<a href="#l44.537"></a><span id="l44.537"> </span>
<a href="#l44.538"></a><span id="l44.538" class="difflineat">@@ -590,71 +577,70 @@ var QuickFilterBarMuxer = {</span>
<a href="#l44.539"></a><span id="l44.539">     for (let [listener, filterDef] of listeners) {</span>
<a href="#l44.540"></a><span id="l44.540">       // it registers itself with the search session.</span>
<a href="#l44.541"></a><span id="l44.541">       new QuickFilterSearchListener(</span>
<a href="#l44.542"></a><span id="l44.542">         tab.folderDisplay, filterer, filterDef,</span>
<a href="#l44.543"></a><span id="l44.543">         listener, QuickFilterBarMuxer);</span>
<a href="#l44.544"></a><span id="l44.544">     }</span>
<a href="#l44.545"></a><span id="l44.545">     tab.folderDisplay.view.search.userTerms = terms;</span>
<a href="#l44.546"></a><span id="l44.546">     // Uncomment to know what the search state is when we (try and) update it.</span>
<a href="#l44.547"></a><span id="l44.547" class="difflineminus">-    //dump(tab.folderDisplay.view.search.prettyString());</span>
<a href="#l44.548"></a><span id="l44.548" class="difflineplus">+    // dump(tab.folderDisplay.view.search.prettyString());</span>
<a href="#l44.549"></a><span id="l44.549">   },</span>
<a href="#l44.550"></a><span id="l44.550"> </span>
<a href="#l44.551"></a><span id="l44.551" class="difflineminus">-  _showFilterBar: function QFBM__showFilterBar(aShow) {</span>
<a href="#l44.552"></a><span id="l44.552" class="difflineplus">+  _showFilterBar(aShow) {</span>
<a href="#l44.553"></a><span id="l44.553">     this.activeFilterer.visible = aShow;</span>
<a href="#l44.554"></a><span id="l44.554">     if (!aShow) {</span>
<a href="#l44.555"></a><span id="l44.555">       this.activeFilterer.clear();</span>
<a href="#l44.556"></a><span id="l44.556">       this.updateSearch();</span>
<a href="#l44.557"></a><span id="l44.557">       let threadPane = document.getElementById(&quot;threadTree&quot;);</span>
<a href="#l44.558"></a><span id="l44.558">       threadPane.focus();</span>
<a href="#l44.559"></a><span id="l44.559">     }</span>
<a href="#l44.560"></a><span id="l44.560">     this.reflectFiltererState(this.activeFilterer,</span>
<a href="#l44.561"></a><span id="l44.561">                               this.tabmail.currentTabInfo.folderDisplay);</span>
<a href="#l44.562"></a><span id="l44.562">   },</span>
<a href="#l44.563"></a><span id="l44.563"> </span>
<a href="#l44.564"></a><span id="l44.564">   /**</span>
<a href="#l44.565"></a><span id="l44.565">    * Invoked when the user chooses the popup from the gloda search box.</span>
<a href="#l44.566"></a><span id="l44.566">    */</span>
<a href="#l44.567"></a><span id="l44.567" class="difflineminus">-  cmdGlodaSearchDownSell: function QFBM_cmdGlodaSearchDownSell(aEvent) {</span>
<a href="#l44.568"></a><span id="l44.568" class="difflineplus">+  cmdGlodaSearchDownSell(aEvent) {</span>
<a href="#l44.569"></a><span id="l44.569">     aEvent.stopPropagation();</span>
<a href="#l44.570"></a><span id="l44.570">     this._showFilterBar(true);</span>
<a href="#l44.571"></a><span id="l44.571">     let textWidget = document.getElementById(</span>
<a href="#l44.572"></a><span id="l44.572">                        QuickFilterManager.textBoxDomId);</span>
<a href="#l44.573"></a><span id="l44.573">     textWidget.select();</span>
<a href="#l44.574"></a><span id="l44.574">   },</span>
<a href="#l44.575"></a><span id="l44.575"> </span>
<a href="#l44.576"></a><span id="l44.576">   /**</span>
<a href="#l44.577"></a><span id="l44.577">    * User explicitly closed the filter bar.</span>
<a href="#l44.578"></a><span id="l44.578">    */</span>
<a href="#l44.579"></a><span id="l44.579" class="difflineminus">-  cmdClose: function QFBM_cmdClose(aEvent) {</span>
<a href="#l44.580"></a><span id="l44.580" class="difflineplus">+  cmdClose(aEvent) {</span>
<a href="#l44.581"></a><span id="l44.581">     this._showFilterBar(false);</span>
<a href="#l44.582"></a><span id="l44.582">   },</span>
<a href="#l44.583"></a><span id="l44.583"> </span>
<a href="#l44.584"></a><span id="l44.584">   /**</span>
<a href="#l44.585"></a><span id="l44.585">    * User hit the escape key; do our undo-ish thing keeping in mind that this</span>
<a href="#l44.586"></a><span id="l44.586">    *  may be invoked in situations where the filter bar is not legal / enabled.</span>
<a href="#l44.587"></a><span id="l44.587">    */</span>
<a href="#l44.588"></a><span id="l44.588" class="difflineminus">-  cmdEscapeFilterStack: function QFBM_cmdEscapeFilterStack() {</span>
<a href="#l44.589"></a><span id="l44.589" class="difflineplus">+  cmdEscapeFilterStack() {</span>
<a href="#l44.590"></a><span id="l44.590">     let filterer = this.maybeActiveFilterer;</span>
<a href="#l44.591"></a><span id="l44.591">     if (!filterer || !filterer.visible)</span>
<a href="#l44.592"></a><span id="l44.592">       return;</span>
<a href="#l44.593"></a><span id="l44.593"> </span>
<a href="#l44.594"></a><span id="l44.594">     // update the search if we were relaxing something</span>
<a href="#l44.595"></a><span id="l44.595">     if (filterer.userHitEscape()) {</span>
<a href="#l44.596"></a><span id="l44.596">       this.updateSearch();</span>
<a href="#l44.597"></a><span id="l44.597">       this.reflectFiltererState(filterer,</span>
<a href="#l44.598"></a><span id="l44.598">                                 this.tabmail.currentTabInfo.folderDisplay);</span>
<a href="#l44.599"></a><span id="l44.599" class="difflineminus">-    }</span>
<a href="#l44.600"></a><span id="l44.600" class="difflineminus">-    // close the filter since there was nothing left to relax</span>
<a href="#l44.601"></a><span id="l44.601" class="difflineminus">-    else {</span>
<a href="#l44.602"></a><span id="l44.602" class="difflineplus">+    } else {</span>
<a href="#l44.603"></a><span id="l44.603" class="difflineplus">+      // close the filter since there was nothing left to relax</span>
<a href="#l44.604"></a><span id="l44.604">       this.cmdClose();</span>
<a href="#l44.605"></a><span id="l44.605">     }</span>
<a href="#l44.606"></a><span id="l44.606">   },</span>
<a href="#l44.607"></a><span id="l44.607"> </span>
<a href="#l44.608"></a><span id="l44.608" class="difflineminus">-  _testHelperResetFilterState: function QFBM_resetFilterState() {</span>
<a href="#l44.609"></a><span id="l44.609" class="difflineplus">+  _testHelperResetFilterState() {</span>
<a href="#l44.610"></a><span id="l44.610">     let filterer = this.maybeActiveFilterer;</span>
<a href="#l44.611"></a><span id="l44.611">     if (!filterer)</span>
<a href="#l44.612"></a><span id="l44.612">       return;</span>
<a href="#l44.613"></a><span id="l44.613">     let tab = this.tabmail.currentTabInfo;</span>
<a href="#l44.614"></a><span id="l44.614">     tab._ext.quickFilter = filterer = new QuickFilterState();</span>
<a href="#l44.615"></a><span id="l44.615">     this.updateSearch();</span>
<a href="#l44.616"></a><span id="l44.616">     this.reflectFiltererState(filterer, tab.folderDisplay);</span>
<a href="#l44.617"></a><span id="l44.617">   },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/mail/base/content/safeMode.js</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/mail/base/content/safeMode.js</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -23,18 +23,17 @@ function disableAddons() {</span>
<a href="#l45.4"></a><span id="l45.4">     aAddons.forEach(function(aAddon) {</span>
<a href="#l45.5"></a><span id="l45.5">       if (aAddon.type == &quot;theme&quot;) {</span>
<a href="#l45.6"></a><span id="l45.6">         // Setting userDisabled to false on the default theme activates it,</span>
<a href="#l45.7"></a><span id="l45.7">         // disables all other themes and deactivates the applied persona, if</span>
<a href="#l45.8"></a><span id="l45.8">         // any.</span>
<a href="#l45.9"></a><span id="l45.9">         const DEFAULT_THEME_ID = &quot;{972ce4c6-7e08-4474-a285-3208198ce6fd}&quot;;</span>
<a href="#l45.10"></a><span id="l45.10">         if (aAddon.id == DEFAULT_THEME_ID)</span>
<a href="#l45.11"></a><span id="l45.11">           aAddon.userDisabled = false;</span>
<a href="#l45.12"></a><span id="l45.12" class="difflineminus">-      }</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineminus">-      else {</span>
<a href="#l45.14"></a><span id="l45.14" class="difflineplus">+      } else {</span>
<a href="#l45.15"></a><span id="l45.15">         aAddon.userDisabled = true;</span>
<a href="#l45.16"></a><span id="l45.16">       }</span>
<a href="#l45.17"></a><span id="l45.17">     });</span>
<a href="#l45.18"></a><span id="l45.18"> </span>
<a href="#l45.19"></a><span id="l45.19">     restartApp();</span>
<a href="#l45.20"></a><span id="l45.20">   });</span>
<a href="#l45.21"></a><span id="l45.21"> }</span>
<a href="#l45.22"></a><span id="l45.22"> </span>
<a href="#l45.23"></a><span id="l45.23" class="difflineat">@@ -42,17 +41,17 @@ function onOK() {</span>
<a href="#l45.24"></a><span id="l45.24">   try {</span>
<a href="#l45.25"></a><span id="l45.25">     if (document.getElementById(&quot;resetToolbars&quot;).checked)</span>
<a href="#l45.26"></a><span id="l45.26">       deleteLocalstore();</span>
<a href="#l45.27"></a><span id="l45.27">     if (document.getElementById(&quot;disableAddons&quot;).checked) {</span>
<a href="#l45.28"></a><span id="l45.28">       disableAddons();</span>
<a href="#l45.29"></a><span id="l45.29">       // disableAddons will asynchronously restart the application</span>
<a href="#l45.30"></a><span id="l45.30">       return false;</span>
<a href="#l45.31"></a><span id="l45.31">     }</span>
<a href="#l45.32"></a><span id="l45.32" class="difflineminus">-  } catch(e) {</span>
<a href="#l45.33"></a><span id="l45.33" class="difflineplus">+  } catch (e) {</span>
<a href="#l45.34"></a><span id="l45.34">   }</span>
<a href="#l45.35"></a><span id="l45.35"> </span>
<a href="#l45.36"></a><span id="l45.36">   restartApp();</span>
<a href="#l45.37"></a><span id="l45.37">   return false;</span>
<a href="#l45.38"></a><span id="l45.38"> }</span>
<a href="#l45.39"></a><span id="l45.39"> </span>
<a href="#l45.40"></a><span id="l45.40"> function onCancel() {</span>
<a href="#l45.41"></a><span id="l45.41">   Services.startup.quit(Services.startup.eForceQuit);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1" class="difflineminus">--- a/mail/base/content/sanitize.js</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineplus">+++ b/mail/base/content/sanitize.js</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineat">@@ -4,42 +4,38 @@</span>
<a href="#l46.4"></a><span id="l46.4"> </span>
<a href="#l46.5"></a><span id="l46.5"> ChromeUtils.import(&quot;resource://gre/modules/PlacesUtils.jsm&quot;);</span>
<a href="#l46.6"></a><span id="l46.6"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l46.7"></a><span id="l46.7"> ChromeUtils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;);</span>
<a href="#l46.8"></a><span id="l46.8"> </span>
<a href="#l46.9"></a><span id="l46.9"> function Sanitizer() {}</span>
<a href="#l46.10"></a><span id="l46.10"> Sanitizer.prototype = {</span>
<a href="#l46.11"></a><span id="l46.11">   // warning to the caller: this one may raise an exception (e.g. bug #265028)</span>
<a href="#l46.12"></a><span id="l46.12" class="difflineminus">-  clearItem: function (aItemName)</span>
<a href="#l46.13"></a><span id="l46.13" class="difflineminus">-  {</span>
<a href="#l46.14"></a><span id="l46.14" class="difflineplus">+  clearItem(aItemName) {</span>
<a href="#l46.15"></a><span id="l46.15">     if (this.items[aItemName].canClear)</span>
<a href="#l46.16"></a><span id="l46.16">       this.items[aItemName].clear();</span>
<a href="#l46.17"></a><span id="l46.17">   },</span>
<a href="#l46.18"></a><span id="l46.18"> </span>
<a href="#l46.19"></a><span id="l46.19" class="difflineminus">-  canClearItem: function (aItemName)</span>
<a href="#l46.20"></a><span id="l46.20" class="difflineminus">-  {</span>
<a href="#l46.21"></a><span id="l46.21" class="difflineplus">+  canClearItem(aItemName) {</span>
<a href="#l46.22"></a><span id="l46.22">     return this.items[aItemName].canClear;</span>
<a href="#l46.23"></a><span id="l46.23">   },</span>
<a href="#l46.24"></a><span id="l46.24"> </span>
<a href="#l46.25"></a><span id="l46.25">   prefDomain: &quot;&quot;,</span>
<a href="#l46.26"></a><span id="l46.26"> </span>
<a href="#l46.27"></a><span id="l46.27" class="difflineminus">-  getNameFromPreference: function (aPreferenceName)</span>
<a href="#l46.28"></a><span id="l46.28" class="difflineminus">-  {</span>
<a href="#l46.29"></a><span id="l46.29" class="difflineplus">+  getNameFromPreference(aPreferenceName) {</span>
<a href="#l46.30"></a><span id="l46.30">     return aPreferenceName.substr(this.prefDomain.length);</span>
<a href="#l46.31"></a><span id="l46.31">   },</span>
<a href="#l46.32"></a><span id="l46.32"> </span>
<a href="#l46.33"></a><span id="l46.33">   /**</span>
<a href="#l46.34"></a><span id="l46.34">    * Deletes privacy sensitive data in a batch, according to user preferences</span>
<a href="#l46.35"></a><span id="l46.35">    *</span>
<a href="#l46.36"></a><span id="l46.36">    * @returns  null if everything's fine;  an object in the form</span>
<a href="#l46.37"></a><span id="l46.37">    *           { itemName: error, ... } on (partial) failure</span>
<a href="#l46.38"></a><span id="l46.38">    */</span>
<a href="#l46.39"></a><span id="l46.39" class="difflineminus">-  sanitize: function ()</span>
<a href="#l46.40"></a><span id="l46.40" class="difflineminus">-  {</span>
<a href="#l46.41"></a><span id="l46.41" class="difflineplus">+  sanitize() {</span>
<a href="#l46.42"></a><span id="l46.42">     var branch = Services.prefs.getBranch(this.prefDomain);</span>
<a href="#l46.43"></a><span id="l46.43">     var errors = null;</span>
<a href="#l46.44"></a><span id="l46.44"> </span>
<a href="#l46.45"></a><span id="l46.45">     // Cache the range of times to clear</span>
<a href="#l46.46"></a><span id="l46.46">     if (this.ignoreTimespan)</span>
<a href="#l46.47"></a><span id="l46.47">       var range = null;  // If we ignore timespan, clear everything</span>
<a href="#l46.48"></a><span id="l46.48">     else</span>
<a href="#l46.49"></a><span id="l46.49">       range = this.range || Sanitizer.getClearRange();</span>
<a href="#l46.50"></a><span id="l46.50" class="difflineat">@@ -50,71 +46,65 @@ Sanitizer.prototype = {</span>
<a href="#l46.51"></a><span id="l46.51">       if (&quot;clear&quot; in item &amp;&amp; item.canClear &amp;&amp; branch.getBoolPref(itemName)) {</span>
<a href="#l46.52"></a><span id="l46.52">         // Some of these clear() may raise exceptions (see bug #265028)</span>
<a href="#l46.53"></a><span id="l46.53">         // to sanitize as much as possible, we catch and store them,</span>
<a href="#l46.54"></a><span id="l46.54">         // rather than fail fast.</span>
<a href="#l46.55"></a><span id="l46.55">         // Callers should check returned errors and give user feedback</span>
<a href="#l46.56"></a><span id="l46.56">         // about items that could not be sanitized</span>
<a href="#l46.57"></a><span id="l46.57">         try {</span>
<a href="#l46.58"></a><span id="l46.58">           item.clear();</span>
<a href="#l46.59"></a><span id="l46.59" class="difflineminus">-        } catch(er) {</span>
<a href="#l46.60"></a><span id="l46.60" class="difflineplus">+        } catch (er) {</span>
<a href="#l46.61"></a><span id="l46.61">           if (!errors)</span>
<a href="#l46.62"></a><span id="l46.62">             errors = {};</span>
<a href="#l46.63"></a><span id="l46.63">           errors[itemName] = er;</span>
<a href="#l46.64"></a><span id="l46.64">           dump(&quot;Error sanitizing &quot; + itemName + &quot;: &quot; + er + &quot;\n&quot;);</span>
<a href="#l46.65"></a><span id="l46.65">         }</span>
<a href="#l46.66"></a><span id="l46.66">       }</span>
<a href="#l46.67"></a><span id="l46.67">     }</span>
<a href="#l46.68"></a><span id="l46.68">     return errors;</span>
<a href="#l46.69"></a><span id="l46.69">   },</span>
<a href="#l46.70"></a><span id="l46.70"> </span>
<a href="#l46.71"></a><span id="l46.71">   // Time span only makes sense in certain cases.  Consumers who want</span>
<a href="#l46.72"></a><span id="l46.72">   // to only clear some private data can opt in by setting this to false,</span>
<a href="#l46.73"></a><span id="l46.73">   // and can optionally specify a specific range.  If timespan is not ignored,</span>
<a href="#l46.74"></a><span id="l46.74">   // and range is not set, sanitize() will use the value of the timespan</span>
<a href="#l46.75"></a><span id="l46.75">   // pref to determine a range</span>
<a href="#l46.76"></a><span id="l46.76" class="difflineminus">-  ignoreTimespan : true,</span>
<a href="#l46.77"></a><span id="l46.77" class="difflineminus">-  range : null,</span>
<a href="#l46.78"></a><span id="l46.78" class="difflineplus">+  ignoreTimespan: true,</span>
<a href="#l46.79"></a><span id="l46.79" class="difflineplus">+  range: null,</span>
<a href="#l46.80"></a><span id="l46.80"> </span>
<a href="#l46.81"></a><span id="l46.81">   items: {</span>
<a href="#l46.82"></a><span id="l46.82">     cache: {</span>
<a href="#l46.83"></a><span id="l46.83" class="difflineminus">-      clear: function ()</span>
<a href="#l46.84"></a><span id="l46.84" class="difflineminus">-      {</span>
<a href="#l46.85"></a><span id="l46.85" class="difflineplus">+      clear() {</span>
<a href="#l46.86"></a><span id="l46.86">         try {</span>
<a href="#l46.87"></a><span id="l46.87">           // Cache doesn't consult timespan, nor does it have the</span>
<a href="#l46.88"></a><span id="l46.88">           // facility for timespan-based eviction.  Wipe it.</span>
<a href="#l46.89"></a><span id="l46.89" class="difflineminus">-          let cache = Cc[&quot;@mozilla.org/netwerk/cache-storage-service;1&quot;]</span>
<a href="#l46.90"></a><span id="l46.90" class="difflineminus">-                        .getService(Ci.nsICacheStorageService);</span>
<a href="#l46.91"></a><span id="l46.91" class="difflineminus">-          cache.clear();</span>
<a href="#l46.92"></a><span id="l46.92" class="difflineplus">+          Services.cache2.clear();</span>
<a href="#l46.93"></a><span id="l46.93">         } catch (ex) {}</span>
<a href="#l46.94"></a><span id="l46.94"> </span>
<a href="#l46.95"></a><span id="l46.95">       },</span>
<a href="#l46.96"></a><span id="l46.96"> </span>
<a href="#l46.97"></a><span id="l46.97" class="difflineminus">-      get canClear()</span>
<a href="#l46.98"></a><span id="l46.98" class="difflineminus">-      {</span>
<a href="#l46.99"></a><span id="l46.99" class="difflineplus">+      get canClear() {</span>
<a href="#l46.100"></a><span id="l46.100">         return true;</span>
<a href="#l46.101"></a><span id="l46.101" class="difflineminus">-      }</span>
<a href="#l46.102"></a><span id="l46.102" class="difflineplus">+      },</span>
<a href="#l46.103"></a><span id="l46.103">     },</span>
<a href="#l46.104"></a><span id="l46.104"> </span>
<a href="#l46.105"></a><span id="l46.105">     cookies: {</span>
<a href="#l46.106"></a><span id="l46.106" class="difflineminus">-      clear: function ()</span>
<a href="#l46.107"></a><span id="l46.107" class="difflineminus">-      {</span>
<a href="#l46.108"></a><span id="l46.108" class="difflineplus">+      clear() {</span>
<a href="#l46.109"></a><span id="l46.109">         if (this.range) {</span>
<a href="#l46.110"></a><span id="l46.110">           // Iterate through the cookies and delete any created after our cutoff.</span>
<a href="#l46.111"></a><span id="l46.111">           var cookiesEnum = Services.cookies.enumerator;</span>
<a href="#l46.112"></a><span id="l46.112">           while (cookiesEnum.hasMoreElements()) {</span>
<a href="#l46.113"></a><span id="l46.113">             var cookie = cookiesEnum.getNext().QueryInterface(Ci.nsICookie2);</span>
<a href="#l46.114"></a><span id="l46.114"> </span>
<a href="#l46.115"></a><span id="l46.115">             if (cookie.creationTime &gt; this.range[0])</span>
<a href="#l46.116"></a><span id="l46.116">               // This cookie was created after our cutoff, clear it</span>
<a href="#l46.117"></a><span id="l46.117">               Services.cookies.remove(cookie.host, cookie.name, cookie.path,</span>
<a href="#l46.118"></a><span id="l46.118">                                       false, cookie.originAttributes);</span>
<a href="#l46.119"></a><span id="l46.119">           }</span>
<a href="#l46.120"></a><span id="l46.120" class="difflineminus">-        }</span>
<a href="#l46.121"></a><span id="l46.121" class="difflineminus">-        else {</span>
<a href="#l46.122"></a><span id="l46.122" class="difflineplus">+        } else {</span>
<a href="#l46.123"></a><span id="l46.123">           // Remove everything</span>
<a href="#l46.124"></a><span id="l46.124">           Services.cookies.removeAll();</span>
<a href="#l46.125"></a><span id="l46.125">         }</span>
<a href="#l46.126"></a><span id="l46.126"> </span>
<a href="#l46.127"></a><span id="l46.127">         // Clear plugin data.</span>
<a href="#l46.128"></a><span id="l46.128">         const phInterface = Ci.nsIPluginHost;</span>
<a href="#l46.129"></a><span id="l46.129">         const FLAG_CLEAR_ALL = phInterface.FLAG_CLEAR_ALL;</span>
<a href="#l46.130"></a><span id="l46.130">         let ph = Cc[&quot;@mozilla.org/plugin/host;1&quot;].getService(phInterface);</span>
<a href="#l46.131"></a><span id="l46.131" class="difflineat">@@ -147,51 +137,46 @@ Sanitizer.prototype = {</span>
<a href="#l46.132"></a><span id="l46.132">         // clear any network geolocation provider sessions</span>
<a href="#l46.133"></a><span id="l46.133">         try {</span>
<a href="#l46.134"></a><span id="l46.134">             var branch = Services.prefs.getBranch(&quot;geo.wifi.access_token.&quot;);</span>
<a href="#l46.135"></a><span id="l46.135">             branch.deleteBranch(&quot;&quot;);</span>
<a href="#l46.136"></a><span id="l46.136">         } catch (e) {}</span>
<a href="#l46.137"></a><span id="l46.137"> </span>
<a href="#l46.138"></a><span id="l46.138">       },</span>
<a href="#l46.139"></a><span id="l46.139"> </span>
<a href="#l46.140"></a><span id="l46.140" class="difflineminus">-      get canClear()</span>
<a href="#l46.141"></a><span id="l46.141" class="difflineminus">-      {</span>
<a href="#l46.142"></a><span id="l46.142" class="difflineplus">+      get canClear() {</span>
<a href="#l46.143"></a><span id="l46.143">         return true;</span>
<a href="#l46.144"></a><span id="l46.144" class="difflineminus">-      }</span>
<a href="#l46.145"></a><span id="l46.145" class="difflineplus">+      },</span>
<a href="#l46.146"></a><span id="l46.146">     },</span>
<a href="#l46.147"></a><span id="l46.147"> </span>
<a href="#l46.148"></a><span id="l46.148">     history: {</span>
<a href="#l46.149"></a><span id="l46.149" class="difflineminus">-      clear: function ()</span>
<a href="#l46.150"></a><span id="l46.150" class="difflineminus">-      {</span>
<a href="#l46.151"></a><span id="l46.151" class="difflineplus">+      clear() {</span>
<a href="#l46.152"></a><span id="l46.152">         if (this.range)</span>
<a href="#l46.153"></a><span id="l46.153">           PlacesUtils.history.removeVisitsByTimeframe(this.range[0], this.range[1]);</span>
<a href="#l46.154"></a><span id="l46.154">         else</span>
<a href="#l46.155"></a><span id="l46.155">           PlacesUtils.history.clear();</span>
<a href="#l46.156"></a><span id="l46.156"> </span>
<a href="#l46.157"></a><span id="l46.157">         try {</span>
<a href="#l46.158"></a><span id="l46.158" class="difflineminus">-          var os = Cc[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l46.159"></a><span id="l46.159" class="difflineminus">-                     .getService(Ci.nsIObserverService);</span>
<a href="#l46.160"></a><span id="l46.160" class="difflineminus">-          os.notifyObservers(null, &quot;browser:purge-session-history&quot;);</span>
<a href="#l46.161"></a><span id="l46.161" class="difflineminus">-        } catch (e) { }</span>
<a href="#l46.162"></a><span id="l46.162" class="difflineplus">+          Services.obs.notifyObservers(null, &quot;browser:purge-session-history&quot;);</span>
<a href="#l46.163"></a><span id="l46.163" class="difflineplus">+        } catch (e) {}</span>
<a href="#l46.164"></a><span id="l46.164"> </span>
<a href="#l46.165"></a><span id="l46.165">         try {</span>
<a href="#l46.166"></a><span id="l46.166">           var predictor = Cc[&quot;@mozilla.org/network/predictor;1&quot;]</span>
<a href="#l46.167"></a><span id="l46.167">                             .getService(Ci.nsINetworkPredictor);</span>
<a href="#l46.168"></a><span id="l46.168">           predictor.reset();</span>
<a href="#l46.169"></a><span id="l46.169" class="difflineminus">-        } catch (e) { }</span>
<a href="#l46.170"></a><span id="l46.170" class="difflineplus">+        } catch (e) {}</span>
<a href="#l46.171"></a><span id="l46.171">       },</span>
<a href="#l46.172"></a><span id="l46.172"> </span>
<a href="#l46.173"></a><span id="l46.173" class="difflineminus">-      get canClear()</span>
<a href="#l46.174"></a><span id="l46.174" class="difflineminus">-      {</span>
<a href="#l46.175"></a><span id="l46.175" class="difflineplus">+      get canClear() {</span>
<a href="#l46.176"></a><span id="l46.176">         // bug 347231: Always allow clearing history due to dependencies on</span>
<a href="#l46.177"></a><span id="l46.177">         // the browser:purge-session-history notification. (like error console)</span>
<a href="#l46.178"></a><span id="l46.178">         return true;</span>
<a href="#l46.179"></a><span id="l46.179" class="difflineminus">-      }</span>
<a href="#l46.180"></a><span id="l46.180" class="difflineplus">+      },</span>
<a href="#l46.181"></a><span id="l46.181">     },</span>
<a href="#l46.182"></a><span id="l46.182" class="difflineminus">-  }</span>
<a href="#l46.183"></a><span id="l46.183" class="difflineplus">+  },</span>
<a href="#l46.184"></a><span id="l46.184"> };</span>
<a href="#l46.185"></a><span id="l46.185"> </span>
<a href="#l46.186"></a><span id="l46.186"> // &quot;Static&quot; members</span>
<a href="#l46.187"></a><span id="l46.187"> Sanitizer.prefDomain          = &quot;privacy.sanitize.&quot;;</span>
<a href="#l46.188"></a><span id="l46.188"> Sanitizer.prefShutdown        = &quot;sanitizeOnShutdown&quot;;</span>
<a href="#l46.189"></a><span id="l46.189"> Sanitizer.prefDidShutdown     = &quot;didShutdownSanitize&quot;;</span>
<a href="#l46.190"></a><span id="l46.190"> </span>
<a href="#l46.191"></a><span id="l46.191"> // Time span constants corresponding to values of the privacy.sanitize.timeSpan</span>
<a href="#l46.192"></a><span id="l46.192" class="difflineat">@@ -201,17 +186,17 @@ Sanitizer.TIMESPAN_HOUR       = 1;</span>
<a href="#l46.193"></a><span id="l46.193"> Sanitizer.TIMESPAN_2HOURS     = 2;</span>
<a href="#l46.194"></a><span id="l46.194"> Sanitizer.TIMESPAN_4HOURS     = 3;</span>
<a href="#l46.195"></a><span id="l46.195"> Sanitizer.TIMESPAN_TODAY      = 4;</span>
<a href="#l46.196"></a><span id="l46.196"> </span>
<a href="#l46.197"></a><span id="l46.197"> // Return a 2 element array representing the start and end times,</span>
<a href="#l46.198"></a><span id="l46.198"> // in the uSec-since-epoch format that PRTime likes.  If we should</span>
<a href="#l46.199"></a><span id="l46.199"> // clear everything, return null.  Use ts if it is defined; otherwise</span>
<a href="#l46.200"></a><span id="l46.200"> // use the timeSpan pref.</span>
<a href="#l46.201"></a><span id="l46.201" class="difflineminus">-Sanitizer.getClearRange = function (ts) {</span>
<a href="#l46.202"></a><span id="l46.202" class="difflineplus">+Sanitizer.getClearRange = function(ts) {</span>
<a href="#l46.203"></a><span id="l46.203">   if (ts === undefined)</span>
<a href="#l46.204"></a><span id="l46.204">     ts = Sanitizer.prefs.getIntPref(&quot;timeSpan&quot;);</span>
<a href="#l46.205"></a><span id="l46.205">   if (ts === Sanitizer.TIMESPAN_EVERYTHING)</span>
<a href="#l46.206"></a><span id="l46.206">     return null;</span>
<a href="#l46.207"></a><span id="l46.207"> </span>
<a href="#l46.208"></a><span id="l46.208">   // PRTime is microseconds while JS time is milliseconds</span>
<a href="#l46.209"></a><span id="l46.209">   var endDate = Date.now() * 1000;</span>
<a href="#l46.210"></a><span id="l46.210">   switch (ts) {</span>
<a href="#l46.211"></a><span id="l46.211" class="difflineat">@@ -233,46 +218,42 @@ Sanitizer.getClearRange = function (ts) </span>
<a href="#l46.212"></a><span id="l46.212">       break;</span>
<a href="#l46.213"></a><span id="l46.213">     default:</span>
<a href="#l46.214"></a><span id="l46.214">       throw &quot;Invalid time span for clear private data: &quot; + ts;</span>
<a href="#l46.215"></a><span id="l46.215">   }</span>
<a href="#l46.216"></a><span id="l46.216">   return [startDate, endDate];</span>
<a href="#l46.217"></a><span id="l46.217"> };</span>
<a href="#l46.218"></a><span id="l46.218"> </span>
<a href="#l46.219"></a><span id="l46.219"> Sanitizer._prefs = null;</span>
<a href="#l46.220"></a><span id="l46.220" class="difflineminus">-Sanitizer.__defineGetter__(&quot;prefs&quot;, function()</span>
<a href="#l46.221"></a><span id="l46.221" class="difflineminus">-{</span>
<a href="#l46.222"></a><span id="l46.222" class="difflineplus">+Sanitizer.__defineGetter__(&quot;prefs&quot;, function() {</span>
<a href="#l46.223"></a><span id="l46.223">   return Sanitizer._prefs ? Sanitizer._prefs</span>
<a href="#l46.224"></a><span id="l46.224">     : Sanitizer._prefs = Services.prefs</span>
<a href="#l46.225"></a><span id="l46.225">                                  .getBranch(Sanitizer</span>
<a href="#l46.226"></a><span id="l46.226">                                  .prefDomain);</span>
<a href="#l46.227"></a><span id="l46.227"> });</span>
<a href="#l46.228"></a><span id="l46.228"> </span>
<a href="#l46.229"></a><span id="l46.229"> // Shows sanitization UI</span>
<a href="#l46.230"></a><span id="l46.230" class="difflineminus">-Sanitizer.showUI = function(aParentWindow)</span>
<a href="#l46.231"></a><span id="l46.231" class="difflineminus">-{</span>
<a href="#l46.232"></a><span id="l46.232" class="difflineplus">+Sanitizer.showUI = function(aParentWindow) {</span>
<a href="#l46.233"></a><span id="l46.233">   Services.ww.openWindow(AppConstants.platform == &quot;macosx&quot; ? null : aParentWindow,</span>
<a href="#l46.234"></a><span id="l46.234">                          &quot;chrome://messenger/content/sanitize.xul&quot;,</span>
<a href="#l46.235"></a><span id="l46.235">                          &quot;Sanitize&quot;,</span>
<a href="#l46.236"></a><span id="l46.236">                          &quot;chrome,titlebar,dialog,centerscreen,modal&quot;,</span>
<a href="#l46.237"></a><span id="l46.237">                          null);</span>
<a href="#l46.238"></a><span id="l46.238"> };</span>
<a href="#l46.239"></a><span id="l46.239"> </span>
<a href="#l46.240"></a><span id="l46.240"> /**</span>
<a href="#l46.241"></a><span id="l46.241">  * Deletes privacy sensitive data in a batch, optionally showing the</span>
<a href="#l46.242"></a><span id="l46.242">  * sanitize UI, according to user preferences</span>
<a href="#l46.243"></a><span id="l46.243">  */</span>
<a href="#l46.244"></a><span id="l46.244" class="difflineminus">-Sanitizer.sanitize = function(aParentWindow)</span>
<a href="#l46.245"></a><span id="l46.245" class="difflineminus">-{</span>
<a href="#l46.246"></a><span id="l46.246" class="difflineplus">+Sanitizer.sanitize = function(aParentWindow) {</span>
<a href="#l46.247"></a><span id="l46.247">   Sanitizer.showUI(aParentWindow);</span>
<a href="#l46.248"></a><span id="l46.248"> };</span>
<a href="#l46.249"></a><span id="l46.249"> </span>
<a href="#l46.250"></a><span id="l46.250"> // this is called on startup and shutdown, to perform pending sanitizations</span>
<a href="#l46.251"></a><span id="l46.251" class="difflineminus">-Sanitizer._checkAndSanitize = function()</span>
<a href="#l46.252"></a><span id="l46.252" class="difflineminus">-{</span>
<a href="#l46.253"></a><span id="l46.253" class="difflineplus">+Sanitizer._checkAndSanitize = function() {</span>
<a href="#l46.254"></a><span id="l46.254">   const prefs = Sanitizer.prefs;</span>
<a href="#l46.255"></a><span id="l46.255">   if (prefs.getBoolPref(Sanitizer.prefShutdown) &amp;&amp;</span>
<a href="#l46.256"></a><span id="l46.256">       !prefs.prefHasUserValue(Sanitizer.prefDidShutdown)) {</span>
<a href="#l46.257"></a><span id="l46.257">     // this is a shutdown or a startup after an unclean exit</span>
<a href="#l46.258"></a><span id="l46.258">     var s = new Sanitizer();</span>
<a href="#l46.259"></a><span id="l46.259">     s.prefDomain = &quot;privacy.clearOnShutdown.&quot;;</span>
<a href="#l46.260"></a><span id="l46.260">     s.sanitize() || // sanitize() returns null on full success</span>
<a href="#l46.261"></a><span id="l46.261">       prefs.setBoolPref(Sanitizer.prefDidShutdown, true);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1" class="difflineminus">--- a/mail/base/content/sanitizeDialog.js</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineplus">+++ b/mail/base/content/sanitizeDialog.js</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineat">@@ -1,44 +1,39 @@</span>
<a href="#l47.4"></a><span id="l47.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l47.5"></a><span id="l47.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l47.6"></a><span id="l47.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l47.7"></a><span id="l47.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l47.8"></a><span id="l47.8"> </span>
<a href="#l47.9"></a><span id="l47.9"> var gSanitizePromptDialog = {</span>
<a href="#l47.10"></a><span id="l47.10"> </span>
<a href="#l47.11"></a><span id="l47.11" class="difflineminus">-  get bundleBrowser()</span>
<a href="#l47.12"></a><span id="l47.12" class="difflineminus">-  {</span>
<a href="#l47.13"></a><span id="l47.13" class="difflineplus">+  get bundleBrowser() {</span>
<a href="#l47.14"></a><span id="l47.14">     if (!this._bundleBrowser)</span>
<a href="#l47.15"></a><span id="l47.15">       this._bundleBrowser = document.getElementById(&quot;bundleBrowser&quot;);</span>
<a href="#l47.16"></a><span id="l47.16">     return this._bundleBrowser;</span>
<a href="#l47.17"></a><span id="l47.17">   },</span>
<a href="#l47.18"></a><span id="l47.18"> </span>
<a href="#l47.19"></a><span id="l47.19" class="difflineminus">-  get selectedTimespan()</span>
<a href="#l47.20"></a><span id="l47.20" class="difflineminus">-  {</span>
<a href="#l47.21"></a><span id="l47.21" class="difflineplus">+  get selectedTimespan() {</span>
<a href="#l47.22"></a><span id="l47.22">     var durList = document.getElementById(&quot;sanitizeDurationChoice&quot;);</span>
<a href="#l47.23"></a><span id="l47.23">     return parseInt(durList.value);</span>
<a href="#l47.24"></a><span id="l47.24">   },</span>
<a href="#l47.25"></a><span id="l47.25"> </span>
<a href="#l47.26"></a><span id="l47.26" class="difflineminus">-  get sanitizePreferences()</span>
<a href="#l47.27"></a><span id="l47.27" class="difflineminus">-  {</span>
<a href="#l47.28"></a><span id="l47.28" class="difflineplus">+  get sanitizePreferences() {</span>
<a href="#l47.29"></a><span id="l47.29">     if (!this._sanitizePreferences) {</span>
<a href="#l47.30"></a><span id="l47.30">       this._sanitizePreferences =</span>
<a href="#l47.31"></a><span id="l47.31">         document.getElementById(&quot;sanitizePreferences&quot;);</span>
<a href="#l47.32"></a><span id="l47.32">     }</span>
<a href="#l47.33"></a><span id="l47.33">     return this._sanitizePreferences;</span>
<a href="#l47.34"></a><span id="l47.34">   },</span>
<a href="#l47.35"></a><span id="l47.35"> </span>
<a href="#l47.36"></a><span id="l47.36" class="difflineminus">-  get warningBox()</span>
<a href="#l47.37"></a><span id="l47.37" class="difflineminus">-  {</span>
<a href="#l47.38"></a><span id="l47.38" class="difflineplus">+  get warningBox() {</span>
<a href="#l47.39"></a><span id="l47.39">     return document.getElementById(&quot;sanitizeEverythingWarningBox&quot;);</span>
<a href="#l47.40"></a><span id="l47.40">   },</span>
<a href="#l47.41"></a><span id="l47.41"> </span>
<a href="#l47.42"></a><span id="l47.42" class="difflineminus">-  init: function ()</span>
<a href="#l47.43"></a><span id="l47.43" class="difflineminus">-  {</span>
<a href="#l47.44"></a><span id="l47.44" class="difflineplus">+  init() {</span>
<a href="#l47.45"></a><span id="l47.45">     // This is used by selectByTimespan() to determine if the window has loaded.</span>
<a href="#l47.46"></a><span id="l47.46">     this._inited = true;</span>
<a href="#l47.47"></a><span id="l47.47"> </span>
<a href="#l47.48"></a><span id="l47.48">     var s = new Sanitizer();</span>
<a href="#l47.49"></a><span id="l47.49">     s.prefDomain = &quot;privacy.cpd.&quot;;</span>
<a href="#l47.50"></a><span id="l47.50"> </span>
<a href="#l47.51"></a><span id="l47.51">     let sanitizeItemList = document.querySelectorAll(&quot;#itemList &gt; [preference]&quot;);</span>
<a href="#l47.52"></a><span id="l47.52">     for (let i = 0; i &lt; sanitizeItemList.length; i++) {</span>
<a href="#l47.53"></a><span id="l47.53" class="difflineat">@@ -54,23 +49,22 @@ var gSanitizePromptDialog = {</span>
<a href="#l47.54"></a><span id="l47.54">     document.documentElement.getButton(&quot;accept&quot;).label =</span>
<a href="#l47.55"></a><span id="l47.55">       this.bundleBrowser.getString(&quot;sanitizeButtonOK&quot;);</span>
<a href="#l47.56"></a><span id="l47.56"> </span>
<a href="#l47.57"></a><span id="l47.57">     if (this.selectedTimespan === Sanitizer.TIMESPAN_EVERYTHING) {</span>
<a href="#l47.58"></a><span id="l47.58">       this.prepareWarning();</span>
<a href="#l47.59"></a><span id="l47.59">       this.warningBox.hidden = false;</span>
<a href="#l47.60"></a><span id="l47.60">       document.title =</span>
<a href="#l47.61"></a><span id="l47.61">         this.bundleBrowser.getString(&quot;sanitizeDialog2.everything.title&quot;);</span>
<a href="#l47.62"></a><span id="l47.62" class="difflineplus">+    } else {</span>
<a href="#l47.63"></a><span id="l47.63" class="difflineplus">+      this.warningBox.hidden = true;</span>
<a href="#l47.64"></a><span id="l47.64">     }</span>
<a href="#l47.65"></a><span id="l47.65" class="difflineminus">-    else</span>
<a href="#l47.66"></a><span id="l47.66" class="difflineminus">-      this.warningBox.hidden = true;</span>
<a href="#l47.67"></a><span id="l47.67">   },</span>
<a href="#l47.68"></a><span id="l47.68"> </span>
<a href="#l47.69"></a><span id="l47.69" class="difflineminus">-  selectByTimespan: function ()</span>
<a href="#l47.70"></a><span id="l47.70" class="difflineminus">-  {</span>
<a href="#l47.71"></a><span id="l47.71" class="difflineplus">+  selectByTimespan() {</span>
<a href="#l47.72"></a><span id="l47.72">     // This method is the onselect handler for the duration dropdown.  As a</span>
<a href="#l47.73"></a><span id="l47.73">     // result it's called a couple of times before onload calls init().</span>
<a href="#l47.74"></a><span id="l47.74">     if (!this._inited)</span>
<a href="#l47.75"></a><span id="l47.75">       return;</span>
<a href="#l47.76"></a><span id="l47.76"> </span>
<a href="#l47.77"></a><span id="l47.77">     var warningBox = this.warningBox;</span>
<a href="#l47.78"></a><span id="l47.78"> </span>
<a href="#l47.79"></a><span id="l47.79">     // If clearing everything</span>
<a href="#l47.80"></a><span id="l47.80" class="difflineat">@@ -89,18 +83,17 @@ var gSanitizePromptDialog = {</span>
<a href="#l47.81"></a><span id="l47.81">     if (!warningBox.hidden) {</span>
<a href="#l47.82"></a><span id="l47.82">       window.resizeBy(0, -warningBox.boxObject.height);</span>
<a href="#l47.83"></a><span id="l47.83">       warningBox.hidden = true;</span>
<a href="#l47.84"></a><span id="l47.84">     }</span>
<a href="#l47.85"></a><span id="l47.85">     window.document.title =</span>
<a href="#l47.86"></a><span id="l47.86">       window.document.documentElement.getAttribute(&quot;noneverythingtitle&quot;);</span>
<a href="#l47.87"></a><span id="l47.87">   },</span>
<a href="#l47.88"></a><span id="l47.88"> </span>
<a href="#l47.89"></a><span id="l47.89" class="difflineminus">-  sanitize: function ()</span>
<a href="#l47.90"></a><span id="l47.90" class="difflineminus">-  {</span>
<a href="#l47.91"></a><span id="l47.91" class="difflineplus">+  sanitize() {</span>
<a href="#l47.92"></a><span id="l47.92">     // Update pref values before handing off to the sanitizer (bug 453440)</span>
<a href="#l47.93"></a><span id="l47.93">     this.updatePrefs();</span>
<a href="#l47.94"></a><span id="l47.94">     var s = new Sanitizer();</span>
<a href="#l47.95"></a><span id="l47.95">     s.prefDomain = &quot;privacy.cpd.&quot;;</span>
<a href="#l47.96"></a><span id="l47.96"> </span>
<a href="#l47.97"></a><span id="l47.97">     s.range = Sanitizer.getClearRange(this.selectedTimespan);</span>
<a href="#l47.98"></a><span id="l47.98">     s.ignoreTimespan = !s.range;</span>
<a href="#l47.99"></a><span id="l47.99"> </span>
<a href="#l47.100"></a><span id="l47.100" class="difflineat">@@ -115,134 +108,128 @@ var gSanitizePromptDialog = {</span>
<a href="#l47.101"></a><span id="l47.101">   /**</span>
<a href="#l47.102"></a><span id="l47.102">    * If the panel that displays a warning when the duration is &quot;Everything&quot; is</span>
<a href="#l47.103"></a><span id="l47.103">    * not set up, sets it up.  Otherwise does nothing.</span>
<a href="#l47.104"></a><span id="l47.104">    *</span>
<a href="#l47.105"></a><span id="l47.105">    * @param aDontShowItemList Whether only the warning message should be updated.</span>
<a href="#l47.106"></a><span id="l47.106">    *                          True means the item list visibility status should not</span>
<a href="#l47.107"></a><span id="l47.107">    *                          be changed.</span>
<a href="#l47.108"></a><span id="l47.108">    */</span>
<a href="#l47.109"></a><span id="l47.109" class="difflineminus">-  prepareWarning: function (aDontShowItemList) {</span>
<a href="#l47.110"></a><span id="l47.110" class="difflineplus">+  prepareWarning(aDontShowItemList) {</span>
<a href="#l47.111"></a><span id="l47.111">     // If the date and time-aware locale warning string is ever used again,</span>
<a href="#l47.112"></a><span id="l47.112">     // initialize it here.  Currently we use the no-visits warning string,</span>
<a href="#l47.113"></a><span id="l47.113">     // which does not include date and time.  See bug 480169 comment 48.</span>
<a href="#l47.114"></a><span id="l47.114"> </span>
<a href="#l47.115"></a><span id="l47.115">     var warningStringID;</span>
<a href="#l47.116"></a><span id="l47.116">     if (this.hasNonSelectedItems()) {</span>
<a href="#l47.117"></a><span id="l47.117">       warningStringID = &quot;sanitizeSelectedWarning&quot;;</span>
<a href="#l47.118"></a><span id="l47.118">       if (!aDontShowItemList)</span>
<a href="#l47.119"></a><span id="l47.119">         this.showItemList();</span>
<a href="#l47.120"></a><span id="l47.120" class="difflineminus">-    }</span>
<a href="#l47.121"></a><span id="l47.121" class="difflineminus">-    else {</span>
<a href="#l47.122"></a><span id="l47.122" class="difflineplus">+    } else {</span>
<a href="#l47.123"></a><span id="l47.123">       warningStringID = &quot;sanitizeEverythingWarning2&quot;;</span>
<a href="#l47.124"></a><span id="l47.124">     }</span>
<a href="#l47.125"></a><span id="l47.125"> </span>
<a href="#l47.126"></a><span id="l47.126">     var warningDesc = document.getElementById(&quot;sanitizeEverythingWarning&quot;);</span>
<a href="#l47.127"></a><span id="l47.127">     warningDesc.textContent =</span>
<a href="#l47.128"></a><span id="l47.128">       this.bundleBrowser.getString(warningStringID);</span>
<a href="#l47.129"></a><span id="l47.129">   },</span>
<a href="#l47.130"></a><span id="l47.130"> </span>
<a href="#l47.131"></a><span id="l47.131">   /**</span>
<a href="#l47.132"></a><span id="l47.132">    * Called when the value of a preference element is synced from the actual</span>
<a href="#l47.133"></a><span id="l47.133">    * pref.  Enables or disables the OK button appropriately.</span>
<a href="#l47.134"></a><span id="l47.134">    */</span>
<a href="#l47.135"></a><span id="l47.135" class="difflineminus">-  onReadGeneric: function ()</span>
<a href="#l47.136"></a><span id="l47.136" class="difflineminus">-  {</span>
<a href="#l47.137"></a><span id="l47.137" class="difflineplus">+  onReadGeneric() {</span>
<a href="#l47.138"></a><span id="l47.138">     var found = false;</span>
<a href="#l47.139"></a><span id="l47.139"> </span>
<a href="#l47.140"></a><span id="l47.140">     // Find any other pref that's checked and enabled.</span>
<a href="#l47.141"></a><span id="l47.141">     var i = 0;</span>
<a href="#l47.142"></a><span id="l47.142">     while (!found &amp;&amp; i &lt; this.sanitizePreferences.childNodes.length) {</span>
<a href="#l47.143"></a><span id="l47.143">       var preference = this.sanitizePreferences.childNodes[i];</span>
<a href="#l47.144"></a><span id="l47.144"> </span>
<a href="#l47.145"></a><span id="l47.145">       found = !!preference.value &amp;&amp;</span>
<a href="#l47.146"></a><span id="l47.146">               !preference.disabled;</span>
<a href="#l47.147"></a><span id="l47.147">       i++;</span>
<a href="#l47.148"></a><span id="l47.148">     }</span>
<a href="#l47.149"></a><span id="l47.149"> </span>
<a href="#l47.150"></a><span id="l47.150">     try {</span>
<a href="#l47.151"></a><span id="l47.151">       document.documentElement.getButton(&quot;accept&quot;).disabled = !found;</span>
<a href="#l47.152"></a><span id="l47.152" class="difflineminus">-    }</span>
<a href="#l47.153"></a><span id="l47.153" class="difflineminus">-    catch (e) { }</span>
<a href="#l47.154"></a><span id="l47.154" class="difflineplus">+    } catch (e) {}</span>
<a href="#l47.155"></a><span id="l47.155"> </span>
<a href="#l47.156"></a><span id="l47.156">     // Update the warning prompt if needed</span>
<a href="#l47.157"></a><span id="l47.157">     this.prepareWarning(true);</span>
<a href="#l47.158"></a><span id="l47.158"> </span>
<a href="#l47.159"></a><span id="l47.159">     return undefined;</span>
<a href="#l47.160"></a><span id="l47.160">   },</span>
<a href="#l47.161"></a><span id="l47.161"> </span>
<a href="#l47.162"></a><span id="l47.162">   /**</span>
<a href="#l47.163"></a><span id="l47.163">    * Sanitizer.prototype.sanitize() requires the prefs to be up-to-date.</span>
<a href="#l47.164"></a><span id="l47.164">    * Because the type of this prefwindow is &quot;child&quot; -- and that's needed because</span>
<a href="#l47.165"></a><span id="l47.165">    * without it the dialog has no OK and Cancel buttons -- the prefs are not</span>
<a href="#l47.166"></a><span id="l47.166">    * updated on dialogaccept on platforms that don't support instant-apply</span>
<a href="#l47.167"></a><span id="l47.167">    * (i.e., Windows).  We must therefore manually set the prefs from their</span>
<a href="#l47.168"></a><span id="l47.168">    * corresponding preference elements.</span>
<a href="#l47.169"></a><span id="l47.169">    */</span>
<a href="#l47.170"></a><span id="l47.170" class="difflineminus">-  updatePrefs : function ()</span>
<a href="#l47.171"></a><span id="l47.171" class="difflineminus">-  {</span>
<a href="#l47.172"></a><span id="l47.172" class="difflineminus">-    var tsPref = document.getElementById(&quot;privacy.sanitize.timeSpan&quot;);</span>
<a href="#l47.173"></a><span id="l47.173" class="difflineplus">+  updatePrefs() {</span>
<a href="#l47.174"></a><span id="l47.174">     Sanitizer.prefs.setIntPref(&quot;timeSpan&quot;, this.selectedTimespan);</span>
<a href="#l47.175"></a><span id="l47.175"> </span>
<a href="#l47.176"></a><span id="l47.176">     // Now manually set the prefs from their corresponding preference</span>
<a href="#l47.177"></a><span id="l47.177">     // elements.</span>
<a href="#l47.178"></a><span id="l47.178">     var prefs = this.sanitizePreferences.rootBranch;</span>
<a href="#l47.179"></a><span id="l47.179">     for (let i = 0; i &lt; this.sanitizePreferences.childNodes.length; ++i) {</span>
<a href="#l47.180"></a><span id="l47.180">       var p = this.sanitizePreferences.childNodes[i];</span>
<a href="#l47.181"></a><span id="l47.181">       prefs.setBoolPref(p.name, p.value);</span>
<a href="#l47.182"></a><span id="l47.182">     }</span>
<a href="#l47.183"></a><span id="l47.183">   },</span>
<a href="#l47.184"></a><span id="l47.184"> </span>
<a href="#l47.185"></a><span id="l47.185">   /**</span>
<a href="#l47.186"></a><span id="l47.186">    * Check if all of the history items have been selected like the default status.</span>
<a href="#l47.187"></a><span id="l47.187">    */</span>
<a href="#l47.188"></a><span id="l47.188" class="difflineminus">-  hasNonSelectedItems: function () {</span>
<a href="#l47.189"></a><span id="l47.189" class="difflineplus">+  hasNonSelectedItems() {</span>
<a href="#l47.190"></a><span id="l47.190">     let checkboxes = document.querySelectorAll(&quot;#itemList &gt; [preference]&quot;);</span>
<a href="#l47.191"></a><span id="l47.191">     for (let i = 0; i &lt; checkboxes.length; ++i) {</span>
<a href="#l47.192"></a><span id="l47.192">       let pref = document.getElementById(checkboxes[i].getAttribute(&quot;preference&quot;));</span>
<a href="#l47.193"></a><span id="l47.193">       if (!pref.value)</span>
<a href="#l47.194"></a><span id="l47.194">         return true;</span>
<a href="#l47.195"></a><span id="l47.195">     }</span>
<a href="#l47.196"></a><span id="l47.196">     return false;</span>
<a href="#l47.197"></a><span id="l47.197">   },</span>
<a href="#l47.198"></a><span id="l47.198"> </span>
<a href="#l47.199"></a><span id="l47.199">   /**</span>
<a href="#l47.200"></a><span id="l47.200">    * Show the history items list.</span>
<a href="#l47.201"></a><span id="l47.201">    */</span>
<a href="#l47.202"></a><span id="l47.202" class="difflineminus">-  showItemList: function () {</span>
<a href="#l47.203"></a><span id="l47.203" class="difflineplus">+  showItemList() {</span>
<a href="#l47.204"></a><span id="l47.204">     var itemList = document.getElementById(&quot;itemList&quot;);</span>
<a href="#l47.205"></a><span id="l47.205">     var expanderButton = document.getElementById(&quot;detailsExpander&quot;);</span>
<a href="#l47.206"></a><span id="l47.206"> </span>
<a href="#l47.207"></a><span id="l47.207">     if (itemList.collapsed) {</span>
<a href="#l47.208"></a><span id="l47.208">       expanderButton.className = &quot;expander-up&quot;;</span>
<a href="#l47.209"></a><span id="l47.209">       itemList.setAttribute(&quot;collapsed&quot;, &quot;false&quot;);</span>
<a href="#l47.210"></a><span id="l47.210">       if (document.documentElement.boxObject.height)</span>
<a href="#l47.211"></a><span id="l47.211">         window.resizeBy(0, itemList.boxObject.height);</span>
<a href="#l47.212"></a><span id="l47.212">     }</span>
<a href="#l47.213"></a><span id="l47.213">   },</span>
<a href="#l47.214"></a><span id="l47.214"> </span>
<a href="#l47.215"></a><span id="l47.215">   /**</span>
<a href="#l47.216"></a><span id="l47.216">    * Hide the history items list.</span>
<a href="#l47.217"></a><span id="l47.217">    */</span>
<a href="#l47.218"></a><span id="l47.218" class="difflineminus">-  hideItemList: function () {</span>
<a href="#l47.219"></a><span id="l47.219" class="difflineplus">+  hideItemList() {</span>
<a href="#l47.220"></a><span id="l47.220">     var itemList = document.getElementById(&quot;itemList&quot;);</span>
<a href="#l47.221"></a><span id="l47.221">     var expanderButton = document.getElementById(&quot;detailsExpander&quot;);</span>
<a href="#l47.222"></a><span id="l47.222"> </span>
<a href="#l47.223"></a><span id="l47.223">     if (!itemList.collapsed) {</span>
<a href="#l47.224"></a><span id="l47.224">       expanderButton.className = &quot;expander-down&quot;;</span>
<a href="#l47.225"></a><span id="l47.225">       window.resizeBy(0, -itemList.boxObject.height);</span>
<a href="#l47.226"></a><span id="l47.226">       itemList.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l47.227"></a><span id="l47.227">     }</span>
<a href="#l47.228"></a><span id="l47.228">   },</span>
<a href="#l47.229"></a><span id="l47.229"> </span>
<a href="#l47.230"></a><span id="l47.230">   /**</span>
<a href="#l47.231"></a><span id="l47.231">    * Called by the item list expander button to toggle the list's visibility.</span>
<a href="#l47.232"></a><span id="l47.232">    */</span>
<a href="#l47.233"></a><span id="l47.233" class="difflineminus">-  toggleItemList: function ()</span>
<a href="#l47.234"></a><span id="l47.234" class="difflineminus">-  {</span>
<a href="#l47.235"></a><span id="l47.235" class="difflineplus">+  toggleItemList() {</span>
<a href="#l47.236"></a><span id="l47.236">     var itemList = document.getElementById(&quot;itemList&quot;);</span>
<a href="#l47.237"></a><span id="l47.237"> </span>
<a href="#l47.238"></a><span id="l47.238">     if (itemList.collapsed)</span>
<a href="#l47.239"></a><span id="l47.239">       this.showItemList();</span>
<a href="#l47.240"></a><span id="l47.240">     else</span>
<a href="#l47.241"></a><span id="l47.241">       this.hideItemList();</span>
<a href="#l47.242"></a><span id="l47.242" class="difflineminus">-  }</span>
<a href="#l47.243"></a><span id="l47.243" class="difflineplus">+  },</span>
<a href="#l47.244"></a><span id="l47.244"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1" class="difflineminus">--- a/mail/base/content/search.xml</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineplus">+++ b/mail/base/content/search.xml</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineat">@@ -89,94 +89,91 @@</span>
<a href="#l48.4"></a><span id="l48.4">           ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l48.5"></a><span id="l48.5"> </span>
<a href="#l48.6"></a><span id="l48.6">           Services.prefs.removeObserver(&quot;mailnews.database.global.indexer.enabled&quot;,</span>
<a href="#l48.7"></a><span id="l48.7">                                         this._prefObserver);</span>
<a href="#l48.8"></a><span id="l48.8">           Services.obs.removeObserver(this, &quot;autocomplete-did-enter-text&quot;);</span>
<a href="#l48.9"></a><span id="l48.9">         ]]&gt;</span>
<a href="#l48.10"></a><span id="l48.10">       &lt;/destructor&gt;</span>
<a href="#l48.11"></a><span id="l48.11"> </span>
<a href="#l48.12"></a><span id="l48.12" class="difflineminus">-      &lt;field name=&quot;_prefObserver&quot;&gt;({</span>
<a href="#l48.13"></a><span id="l48.13" class="difflineplus">+      &lt;field name=&quot;_prefObserver&quot;&gt;&lt;![CDATA[</span>
<a href="#l48.14"></a><span id="l48.14" class="difflineplus">+      ({</span>
<a href="#l48.15"></a><span id="l48.15">         inputSearch: this,</span>
<a href="#l48.16"></a><span id="l48.16" class="difflineminus">-        observe: function(subject, topic, data)</span>
<a href="#l48.17"></a><span id="l48.17" class="difflineminus">-        {</span>
<a href="#l48.18"></a><span id="l48.18" class="difflineplus">+        observe(subject, topic, data) {</span>
<a href="#l48.19"></a><span id="l48.19">           ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l48.20"></a><span id="l48.20"> </span>
<a href="#l48.21"></a><span id="l48.21">           if (topic == &quot;nsPref:changed&quot;) {</span>
<a href="#l48.22"></a><span id="l48.22">             subject.QueryInterface(Ci.nsIPrefBranch);</span>
<a href="#l48.23"></a><span id="l48.23">             switch (data) {</span>
<a href="#l48.24"></a><span id="l48.24">             case &quot;mailnews.database.global.indexer.enabled&quot;:</span>
<a href="#l48.25"></a><span id="l48.25">               this.inputSearch.glodaEnabled =</span>
<a href="#l48.26"></a><span id="l48.26">                 Services.prefs.getBoolPref(</span>
<a href="#l48.27"></a><span id="l48.27">                   &quot;mailnews.database.global.indexer.enabled&quot;);</span>
<a href="#l48.28"></a><span id="l48.28">               this.inputSearch.collapsed = !this.inputSearch.glodaEnabled;</span>
<a href="#l48.29"></a><span id="l48.29">               break;</span>
<a href="#l48.30"></a><span id="l48.30">             }</span>
<a href="#l48.31"></a><span id="l48.31">           }</span>
<a href="#l48.32"></a><span id="l48.32">         },</span>
<a href="#l48.33"></a><span id="l48.33"> </span>
<a href="#l48.34"></a><span id="l48.34">         QueryInterface: ChromeUtils.generateQI([&quot;nsIObserver&quot;]),</span>
<a href="#l48.35"></a><span id="l48.35" class="difflineminus">-        });</span>
<a href="#l48.36"></a><span id="l48.36" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l48.37"></a><span id="l48.37" class="difflineplus">+      });</span>
<a href="#l48.38"></a><span id="l48.38" class="difflineplus">+      ]]&gt;&lt;/field&gt;</span>
<a href="#l48.39"></a><span id="l48.39">       &lt;field name=&quot;glodaCompleter&quot;&gt;null&lt;/field&gt;</span>
<a href="#l48.40"></a><span id="l48.40">       &lt;property name=&quot;menupopup&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l48.41"></a><span id="l48.41">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l48.42"></a><span id="l48.42" class="difflineminus">-          return document.getAnonymousElementByAttribute(</span>
<a href="#l48.43"></a><span id="l48.43" class="difflineminus">-                   this, 'anonid', 'quick-search-menupopup');</span>
<a href="#l48.44"></a><span id="l48.44" class="difflineplus">+          return document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;quick-search-menupopup&quot;);</span>
<a href="#l48.45"></a><span id="l48.45">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l48.46"></a><span id="l48.46">       &lt;/property&gt;</span>
<a href="#l48.47"></a><span id="l48.47"> </span>
<a href="#l48.48"></a><span id="l48.48">       &lt;property name=&quot;state&quot;&gt;</span>
<a href="#l48.49"></a><span id="l48.49">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l48.50"></a><span id="l48.50" class="difflineminus">-          return {</span>
<a href="#l48.51"></a><span id="l48.51" class="difflineminus">-            'string': this.value</span>
<a href="#l48.52"></a><span id="l48.52" class="difflineminus">-          };</span>
<a href="#l48.53"></a><span id="l48.53" class="difflineplus">+          return { string: this.value };</span>
<a href="#l48.54"></a><span id="l48.54">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l48.55"></a><span id="l48.55">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l48.56"></a><span id="l48.56" class="difflineminus">-          this.value = val['string'];</span>
<a href="#l48.57"></a><span id="l48.57" class="difflineplus">+          this.value = val.string;</span>
<a href="#l48.58"></a><span id="l48.58">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l48.59"></a><span id="l48.59">       &lt;/property&gt;</span>
<a href="#l48.60"></a><span id="l48.60"> </span>
<a href="#l48.61"></a><span id="l48.61">       // DND Observer</span>
<a href="#l48.62"></a><span id="l48.62">       &lt;field name=&quot;searchInputDNDObserver&quot; readonly=&quot;true&quot;&gt;&lt;![CDATA[</span>
<a href="#l48.63"></a><span id="l48.63">       ({</span>
<a href="#l48.64"></a><span id="l48.64">         inputSearch: this,</span>
<a href="#l48.65"></a><span id="l48.65"> </span>
<a href="#l48.66"></a><span id="l48.66" class="difflineminus">-        onDrop: function (aEvent, aXferData, aDragSession) {</span>
<a href="#l48.67"></a><span id="l48.67" class="difflineplus">+        onDrop(aEvent, aXferData, aDragSession) {</span>
<a href="#l48.68"></a><span id="l48.68">           try {</span>
<a href="#l48.69"></a><span id="l48.69">             if (aXferData.data) {</span>
<a href="#l48.70"></a><span id="l48.70">               this.inputSearch.focus();</span>
<a href="#l48.71"></a><span id="l48.71">               this.inputSearch.value = aXferData.data;</span>
<a href="#l48.72"></a><span id="l48.72">               // XXX for some reason the input field is _cleared_ even though</span>
<a href="#l48.73"></a><span id="l48.73">               // the search works.</span>
<a href="#l48.74"></a><span id="l48.74">               this.inputSearch.doSearch();</span>
<a href="#l48.75"></a><span id="l48.75">             }</span>
<a href="#l48.76"></a><span id="l48.76">           } catch (e) {</span>
<a href="#l48.77"></a><span id="l48.77">             logException(e);</span>
<a href="#l48.78"></a><span id="l48.78">           }</span>
<a href="#l48.79"></a><span id="l48.79">         },</span>
<a href="#l48.80"></a><span id="l48.80"> </span>
<a href="#l48.81"></a><span id="l48.81" class="difflineminus">-        getSupportedFlavours: function () {</span>
<a href="#l48.82"></a><span id="l48.82" class="difflineplus">+        getSupportedFlavours() {</span>
<a href="#l48.83"></a><span id="l48.83">           var flavourSet = new FlavourSet();</span>
<a href="#l48.84"></a><span id="l48.84">           flavourSet.appendFlavour(&quot;text/unicode&quot;);</span>
<a href="#l48.85"></a><span id="l48.85">           return flavourSet;</span>
<a href="#l48.86"></a><span id="l48.86" class="difflineminus">-        }</span>
<a href="#l48.87"></a><span id="l48.87" class="difflineplus">+        },</span>
<a href="#l48.88"></a><span id="l48.88">       })</span>
<a href="#l48.89"></a><span id="l48.89">       ]]&gt;&lt;/field&gt;</span>
<a href="#l48.90"></a><span id="l48.90"> </span>
<a href="#l48.91"></a><span id="l48.91">       &lt;method name=&quot;observe&quot;&gt;</span>
<a href="#l48.92"></a><span id="l48.92">         &lt;parameter name=&quot;aSubject&quot;/&gt;</span>
<a href="#l48.93"></a><span id="l48.93">         &lt;parameter name=&quot;aTopic&quot;/&gt;</span>
<a href="#l48.94"></a><span id="l48.94">         &lt;parameter name=&quot;aData&quot;/&gt;</span>
<a href="#l48.95"></a><span id="l48.95">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l48.96"></a><span id="l48.96">         try {</span>
<a href="#l48.97"></a><span id="l48.97">           if (aTopic == &quot;autocomplete-did-enter-text&quot; &amp;&amp; aSubject == this) {</span>
<a href="#l48.98"></a><span id="l48.98">             let selectedIndex = this.popup.selectedIndex;</span>
<a href="#l48.99"></a><span id="l48.99">             let curResult = this.glodaCompleter.curResult;</span>
<a href="#l48.100"></a><span id="l48.100" class="difflineminus">-            if (! curResult)</span>
<a href="#l48.101"></a><span id="l48.101" class="difflineplus">+            if (!curResult)</span>
<a href="#l48.102"></a><span id="l48.102">               return; // autocomplete didn't even finish.</span>
<a href="#l48.103"></a><span id="l48.103">             let row = curResult.getObjectAt(selectedIndex);</span>
<a href="#l48.104"></a><span id="l48.104">             if (row == null)</span>
<a href="#l48.105"></a><span id="l48.105">               return;</span>
<a href="#l48.106"></a><span id="l48.106">             if (row.fullText) {</span>
<a href="#l48.107"></a><span id="l48.107">               // The autocomplete-did-enter-text notification is synchronously</span>
<a href="#l48.108"></a><span id="l48.108">               // generated by nsAutoCompleteController which will attempt to</span>
<a href="#l48.109"></a><span id="l48.109">               // call ClosePopup after we return and then tell the searchbox</span>
<a href="#l48.110"></a><span id="l48.110" class="difflineat">@@ -190,19 +187,19 @@</span>
<a href="#l48.111"></a><span id="l48.111">               setTimeout(this.doSearch.bind(this), 0);</span>
<a href="#l48.112"></a><span id="l48.112">             } else if (row.nounDef) {</span>
<a href="#l48.113"></a><span id="l48.113">               let theQuery = Gloda.newQuery(Gloda.NOUN_MESSAGE);</span>
<a href="#l48.114"></a><span id="l48.114">               if (row.nounDef.name == &quot;tag&quot;) {</span>
<a href="#l48.115"></a><span id="l48.115">                 theQuery = theQuery.tags(row.item);</span>
<a href="#l48.116"></a><span id="l48.116">               } else if (row.nounDef.name == &quot;identity&quot;) {</span>
<a href="#l48.117"></a><span id="l48.117">                 theQuery = theQuery.involves(row.item);</span>
<a href="#l48.118"></a><span id="l48.118">               }</span>
<a href="#l48.119"></a><span id="l48.119" class="difflineminus">-              theQuery.orderBy('-date');</span>
<a href="#l48.120"></a><span id="l48.120" class="difflineplus">+              theQuery.orderBy(&quot;-date&quot;);</span>
<a href="#l48.121"></a><span id="l48.121">               document.getElementById(&quot;tabmail&quot;).openTab(&quot;glodaFacet&quot;, {</span>
<a href="#l48.122"></a><span id="l48.122" class="difflineminus">-                query: theQuery</span>
<a href="#l48.123"></a><span id="l48.123" class="difflineplus">+                query: theQuery,</span>
<a href="#l48.124"></a><span id="l48.124">               });</span>
<a href="#l48.125"></a><span id="l48.125">             }</span>
<a href="#l48.126"></a><span id="l48.126">           }</span>
<a href="#l48.127"></a><span id="l48.127">         } catch (e) {</span>
<a href="#l48.128"></a><span id="l48.128">           logException(e);</span>
<a href="#l48.129"></a><span id="l48.129">         }</span>
<a href="#l48.130"></a><span id="l48.130">         ]]&gt;&lt;/body&gt;</span>
<a href="#l48.131"></a><span id="l48.131">       &lt;/method&gt;</span>
<a href="#l48.132"></a><span id="l48.132" class="difflineat">@@ -222,19 +219,19 @@</span>
<a href="#l48.133"></a><span id="l48.133"> </span>
<a href="#l48.134"></a><span id="l48.134">               if (tabmail.currentTabInfo.mode.name == &quot;glodaFacet&quot;) {</span>
<a href="#l48.135"></a><span id="l48.135">                 // we'd rather reuse the existing tab (and somehow do something</span>
<a href="#l48.136"></a><span id="l48.136">                 // smart with any preexisting facet choices, but that's a</span>
<a href="#l48.137"></a><span id="l48.137">                 // bit hard right now, so doing the cheap thing and closing</span>
<a href="#l48.138"></a><span id="l48.138">                 // this tab and starting over</span>
<a href="#l48.139"></a><span id="l48.139">                 tabmail.closeTab();</span>
<a href="#l48.140"></a><span id="l48.140">               }</span>
<a href="#l48.141"></a><span id="l48.141" class="difflineminus">-              this.value = ''; // clear our value, to avoid persistence</span>
<a href="#l48.142"></a><span id="l48.142" class="difflineplus">+              this.value = &quot;&quot;; // clear our value, to avoid persistence</span>
<a href="#l48.143"></a><span id="l48.143">               let args = {</span>
<a href="#l48.144"></a><span id="l48.144" class="difflineminus">-                searcher: new GlodaMsgSearcher(null, searchString)</span>
<a href="#l48.145"></a><span id="l48.145" class="difflineplus">+                searcher: new GlodaMsgSearcher(null, searchString),</span>
<a href="#l48.146"></a><span id="l48.146">               };</span>
<a href="#l48.147"></a><span id="l48.147">               if (Services.prefs.getBoolPref(&quot;mail.chat.enabled&quot;)) {</span>
<a href="#l48.148"></a><span id="l48.148">                 if (!(&quot;GlodaIMSearcher&quot; in window))</span>
<a href="#l48.149"></a><span id="l48.149">                   ChromeUtils.import(&quot;resource:///modules/search_im.jsm&quot;);</span>
<a href="#l48.150"></a><span id="l48.150">                 args.IMSearcher = new GlodaIMSearcher(null, searchString);</span>
<a href="#l48.151"></a><span id="l48.151">               }</span>
<a href="#l48.152"></a><span id="l48.152">               tabmail.openTab(&quot;glodaFacet&quot;, args);</span>
<a href="#l48.153"></a><span id="l48.153">             }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1" class="difflineminus">--- a/mail/base/content/searchBar.js</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineplus">+++ b/mail/base/content/searchBar.js</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineat">@@ -1,17 +1,17 @@</span>
<a href="#l49.4"></a><span id="l49.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l49.5"></a><span id="l49.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l49.6"></a><span id="l49.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l49.7"></a><span id="l49.7"> </span>
<a href="#l49.8"></a><span id="l49.8"> ChromeUtils.import(&quot;resource:///modules/StringBundle.js&quot;);</span>
<a href="#l49.9"></a><span id="l49.9"> </span>
<a href="#l49.10"></a><span id="l49.10"> var gSearchBundle;</span>
<a href="#l49.11"></a><span id="l49.11"> </span>
<a href="#l49.12"></a><span id="l49.12" class="difflineminus">-var gStatusBar = document.getElementById('statusbar-icon');</span>
<a href="#l49.13"></a><span id="l49.13" class="difflineplus">+var gStatusBar = document.getElementById(&quot;statusbar-icon&quot;);</span>
<a href="#l49.14"></a><span id="l49.14"> </span>
<a href="#l49.15"></a><span id="l49.15"> var gGlodaCompleteStrings = new StringBundle(&quot;chrome://messenger/locale/glodaComplete.properties&quot;);</span>
<a href="#l49.16"></a><span id="l49.16"> </span>
<a href="#l49.17"></a><span id="l49.17"> /**</span>
<a href="#l49.18"></a><span id="l49.18">  * The glodasearch widget is a UI widget (the #searchInput textbox) which is</span>
<a href="#l49.19"></a><span id="l49.19">  * outside of the mailTabType's display panel, but acts as though it were within</span>
<a href="#l49.20"></a><span id="l49.20">  * it..  This means we need to use a tab monitor so that we can appropriately</span>
<a href="#l49.21"></a><span id="l49.21">  * update the contents of the textbox.</span>
<a href="#l49.22"></a><span id="l49.22" class="difflineat">@@ -27,42 +27,42 @@ var gGlodaCompleteStrings = new StringBu</span>
<a href="#l49.23"></a><span id="l49.23">  *  In addition, we want to disable the quick-search modes when a tab is</span>
<a href="#l49.24"></a><span id="l49.24">  *  being displayed that lacks quick search abilities (but we'll leave the</span>
<a href="#l49.25"></a><span id="l49.25">  *  faceted search as it's always available).</span>
<a href="#l49.26"></a><span id="l49.26">  */</span>
<a href="#l49.27"></a><span id="l49.27"> </span>
<a href="#l49.28"></a><span id="l49.28"> var GlodaSearchBoxTabMonitor = {</span>
<a href="#l49.29"></a><span id="l49.29">   monitorName: &quot;glodaSearchBox&quot;,</span>
<a href="#l49.30"></a><span id="l49.30"> </span>
<a href="#l49.31"></a><span id="l49.31" class="difflineminus">-  onTabTitleChanged: function() {</span>
<a href="#l49.32"></a><span id="l49.32" class="difflineplus">+  onTabTitleChanged() {</span>
<a href="#l49.33"></a><span id="l49.33">   },</span>
<a href="#l49.34"></a><span id="l49.34"> </span>
<a href="#l49.35"></a><span id="l49.35" class="difflineminus">-  onTabOpened: function GSBTM_onTabOpened(aTab, aFirstTab, aOldTab) {</span>
<a href="#l49.36"></a><span id="l49.36" class="difflineplus">+  onTabOpened(aTab, aFirstTab, aOldTab) {</span>
<a href="#l49.37"></a><span id="l49.37">     aTab._ext.glodaSearchBox = {</span>
<a href="#l49.38"></a><span id="l49.38">       value: (aTab.mode.name === &quot;glodaFacet&quot;) ? aTab.searchString : &quot;&quot;,</span>
<a href="#l49.39"></a><span id="l49.39">     };</span>
<a href="#l49.40"></a><span id="l49.40"> </span>
<a href="#l49.41"></a><span id="l49.41">     if (aTab.mode.name === &quot;glodaFacet&quot;) {</span>
<a href="#l49.42"></a><span id="l49.42">       let searchInput = aTab.panel</span>
<a href="#l49.43"></a><span id="l49.43">                             .querySelector(&quot;.remote-gloda-search&quot;);</span>
<a href="#l49.44"></a><span id="l49.44">       if (searchInput)</span>
<a href="#l49.45"></a><span id="l49.45">         searchInput.value = aTab.searchString;</span>
<a href="#l49.46"></a><span id="l49.46">     }</span>
<a href="#l49.47"></a><span id="l49.47">   },</span>
<a href="#l49.48"></a><span id="l49.48"> </span>
<a href="#l49.49"></a><span id="l49.49" class="difflineminus">-  onTabSwitched: function (aTab, aOldTab) {</span>
<a href="#l49.50"></a><span id="l49.50" class="difflineplus">+  onTabSwitched(aTab, aOldTab) {</span>
<a href="#l49.51"></a><span id="l49.51">     let searchInput = document.getElementById(&quot;searchInput&quot;);</span>
<a href="#l49.52"></a><span id="l49.52">     if (!searchInput) // customized out of the way</span>
<a href="#l49.53"></a><span id="l49.53">       return;</span>
<a href="#l49.54"></a><span id="l49.54"> </span>
<a href="#l49.55"></a><span id="l49.55">     // save the current search field value</span>
<a href="#l49.56"></a><span id="l49.56">     if (aOldTab) {</span>
<a href="#l49.57"></a><span id="l49.57">       aOldTab._ext.glodaSearchBox.value = searchInput.value;</span>
<a href="#l49.58"></a><span id="l49.58">     }</span>
<a href="#l49.59"></a><span id="l49.59">     // Load (or clear if there is none) the persisted search field value</span>
<a href="#l49.60"></a><span id="l49.60">     // (We check first to avoid weird blank field / empty text transitions on</span>
<a href="#l49.61"></a><span id="l49.61">     // tab change.)</span>
<a href="#l49.62"></a><span id="l49.62">     let desiredValue = aTab._ext.glodaSearchBox.value || &quot;&quot;;</span>
<a href="#l49.63"></a><span id="l49.63">     if (searchInput.value != desiredValue)</span>
<a href="#l49.64"></a><span id="l49.64">       searchInput.value = desiredValue;</span>
<a href="#l49.65"></a><span id="l49.65" class="difflineminus">-  }</span>
<a href="#l49.66"></a><span id="l49.66" class="difflineplus">+  },</span>
<a href="#l49.67"></a><span id="l49.67"> };</span>
<a href="#l49.68"></a><span id="l49.68"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1" class="difflineminus">--- a/mail/base/content/specialTabs.js</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineplus">+++ b/mail/base/content/specialTabs.js</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineat">@@ -12,57 +12,49 @@ ChromeUtils.import(&quot;resource://gre/modul</span>
<a href="#l50.4"></a><span id="l50.4"> </span>
<a href="#l50.5"></a><span id="l50.5"> function tabProgressListener(aTab, aStartsBlank) {</span>
<a href="#l50.6"></a><span id="l50.6">   this.mTab = aTab;</span>
<a href="#l50.7"></a><span id="l50.7">   this.mBrowser = aTab.browser;</span>
<a href="#l50.8"></a><span id="l50.8">   this.mBlank = aStartsBlank;</span>
<a href="#l50.9"></a><span id="l50.9">   this.mProgressListener = null;</span>
<a href="#l50.10"></a><span id="l50.10"> }</span>
<a href="#l50.11"></a><span id="l50.11"> </span>
<a href="#l50.12"></a><span id="l50.12" class="difflineminus">-tabProgressListener.prototype =</span>
<a href="#l50.13"></a><span id="l50.13" class="difflineminus">-{</span>
<a href="#l50.14"></a><span id="l50.14" class="difflineplus">+tabProgressListener.prototype = {</span>
<a href="#l50.15"></a><span id="l50.15">   mTab: null,</span>
<a href="#l50.16"></a><span id="l50.16">   mBrowser: null,</span>
<a href="#l50.17"></a><span id="l50.17">   mBlank: null,</span>
<a href="#l50.18"></a><span id="l50.18">   mProgressListener: null,</span>
<a href="#l50.19"></a><span id="l50.19"> </span>
<a href="#l50.20"></a><span id="l50.20">   // cache flags for correct status bar update after tab switching</span>
<a href="#l50.21"></a><span id="l50.21">   mStateFlags: 0,</span>
<a href="#l50.22"></a><span id="l50.22">   mStatus: 0,</span>
<a href="#l50.23"></a><span id="l50.23">   mMessage: &quot;&quot;,</span>
<a href="#l50.24"></a><span id="l50.24"> </span>
<a href="#l50.25"></a><span id="l50.25">   // count of open requests (should always be 0 or 1)</span>
<a href="#l50.26"></a><span id="l50.26">   mRequestCount: 0,</span>
<a href="#l50.27"></a><span id="l50.27"> </span>
<a href="#l50.28"></a><span id="l50.28" class="difflineminus">-  addProgressListener: function tPL_addProgressListener(aProgressListener) {</span>
<a href="#l50.29"></a><span id="l50.29" class="difflineplus">+  addProgressListener(aProgressListener) {</span>
<a href="#l50.30"></a><span id="l50.30">     this.mProgressListener = aProgressListener;</span>
<a href="#l50.31"></a><span id="l50.31">   },</span>
<a href="#l50.32"></a><span id="l50.32"> </span>
<a href="#l50.33"></a><span id="l50.33" class="difflineminus">-  onProgressChange: function tPL_onProgressChange(aWebProgress, aRequest,</span>
<a href="#l50.34"></a><span id="l50.34" class="difflineminus">-                                                  aCurSelfProgress,</span>
<a href="#l50.35"></a><span id="l50.35" class="difflineminus">-                                                  aMaxSelfProgress,</span>
<a href="#l50.36"></a><span id="l50.36" class="difflineminus">-                                                  aCurTotalProgress,</span>
<a href="#l50.37"></a><span id="l50.37" class="difflineminus">-                                                  aMaxTotalProgress) {</span>
<a href="#l50.38"></a><span id="l50.38" class="difflineplus">+  onProgressChange(aWebProgress, aRequest, aCurSelfProgress, aMaxSelfProgress,</span>
<a href="#l50.39"></a><span id="l50.39" class="difflineplus">+                   aCurTotalProgress, aMaxTotalProgress) {</span>
<a href="#l50.40"></a><span id="l50.40">     if (this.mProgressListener)</span>
<a href="#l50.41"></a><span id="l50.41">       this.mProgressListener.onProgressChange(aWebProgress, aRequest,</span>
<a href="#l50.42"></a><span id="l50.42">         aCurSelfProgress, aMaxSelfProgress, aCurTotalProgress,</span>
<a href="#l50.43"></a><span id="l50.43">         aMaxTotalProgress);</span>
<a href="#l50.44"></a><span id="l50.44">   },</span>
<a href="#l50.45"></a><span id="l50.45" class="difflineminus">-  onProgressChange64: function tPL_onProgressChange64(aWebProgress, aRequest,</span>
<a href="#l50.46"></a><span id="l50.46" class="difflineminus">-                                                      aCurSelfProgress,</span>
<a href="#l50.47"></a><span id="l50.47" class="difflineminus">-                                                      aMaxSelfProgress,</span>
<a href="#l50.48"></a><span id="l50.48" class="difflineminus">-                                                      aCurTotalProgress,</span>
<a href="#l50.49"></a><span id="l50.49" class="difflineminus">-                                                      aMaxTotalProgress) {</span>
<a href="#l50.50"></a><span id="l50.50" class="difflineplus">+  onProgressChange64(aWebProgress, aRequest, aCurSelfProgress, aMaxSelfProgress,</span>
<a href="#l50.51"></a><span id="l50.51" class="difflineplus">+                     aCurTotalProgress, aMaxTotalProgress) {</span>
<a href="#l50.52"></a><span id="l50.52">     if (this.mProgressListener)</span>
<a href="#l50.53"></a><span id="l50.53">       this.mProgressListener.onProgressChange64(aWebProgress, aRequest,</span>
<a href="#l50.54"></a><span id="l50.54">         aCurSelfProgress, aMaxSelfProgress, aCurTotalProgress,</span>
<a href="#l50.55"></a><span id="l50.55">         aMaxTotalProgress);</span>
<a href="#l50.56"></a><span id="l50.56">   },</span>
<a href="#l50.57"></a><span id="l50.57" class="difflineminus">-  onLocationChange: function tPL_onLocationChange(aWebProgress, aRequest,</span>
<a href="#l50.58"></a><span id="l50.58" class="difflineminus">-                                                  aLocationURI, aFlags) {</span>
<a href="#l50.59"></a><span id="l50.59" class="difflineplus">+  onLocationChange(aWebProgress, aRequest, aLocationURI, aFlags) {</span>
<a href="#l50.60"></a><span id="l50.60">     if (this.mProgressListener)</span>
<a href="#l50.61"></a><span id="l50.61">       this.mProgressListener.onLocationChange(aWebProgress, aRequest,</span>
<a href="#l50.62"></a><span id="l50.62">         aLocationURI, aFlags);</span>
<a href="#l50.63"></a><span id="l50.63">     // onLocationChange is called for both the top-level content</span>
<a href="#l50.64"></a><span id="l50.64">     // and the subframes.</span>
<a href="#l50.65"></a><span id="l50.65">     if (aWebProgress.DOMWindow == this.mBrowser.contentWindow) {</span>
<a href="#l50.66"></a><span id="l50.66">       // Don't clear the favicon if this onLocationChange was triggered</span>
<a href="#l50.67"></a><span id="l50.67">       // by a pushState or a replaceState. See bug 550565.</span>
<a href="#l50.68"></a><span id="l50.68" class="difflineat">@@ -86,79 +78,70 @@ tabProgressListener.prototype =</span>
<a href="#l50.69"></a><span id="l50.69">         // anyway just in case. The second condition is for new tabs, otherwise</span>
<a href="#l50.70"></a><span id="l50.70">         // the reload function is enabled until tab is refreshed.</span>
<a href="#l50.71"></a><span id="l50.71">         this.mTab.reloadEnabled =</span>
<a href="#l50.72"></a><span id="l50.72">           !((location == &quot;about:blank&quot; &amp;&amp; !this.mBrowser.contentWindow.opener) ||</span>
<a href="#l50.73"></a><span id="l50.73">             location == &quot;&quot;);</span>
<a href="#l50.74"></a><span id="l50.74">       }</span>
<a href="#l50.75"></a><span id="l50.75">     }</span>
<a href="#l50.76"></a><span id="l50.76">   },</span>
<a href="#l50.77"></a><span id="l50.77" class="difflineminus">-  onStateChange: function tPL_onStateChange(aWebProgress, aRequest, aStateFlags,</span>
<a href="#l50.78"></a><span id="l50.78" class="difflineminus">-                                            aStatus) {</span>
<a href="#l50.79"></a><span id="l50.79" class="difflineplus">+  onStateChange(aWebProgress, aRequest, aStateFlags, aStatus) {</span>
<a href="#l50.80"></a><span id="l50.80">     if (this.mProgressListener)</span>
<a href="#l50.81"></a><span id="l50.81">       this.mProgressListener.onStateChange(aWebProgress, aRequest, aStateFlags,</span>
<a href="#l50.82"></a><span id="l50.82">         aStatus);</span>
<a href="#l50.83"></a><span id="l50.83"> </span>
<a href="#l50.84"></a><span id="l50.84">     if (!aRequest)</span>
<a href="#l50.85"></a><span id="l50.85">       return;</span>
<a href="#l50.86"></a><span id="l50.86"> </span>
<a href="#l50.87"></a><span id="l50.87" class="difflineminus">-    var oldBlank = this.mBlank;</span>
<a href="#l50.88"></a><span id="l50.88" class="difflineminus">-</span>
<a href="#l50.89"></a><span id="l50.89" class="difflineminus">-    const nsIWebProgressListener = Ci.nsIWebProgressListener;</span>
<a href="#l50.90"></a><span id="l50.90" class="difflineminus">-    const nsIChannel = Ci.nsIChannel;</span>
<a href="#l50.91"></a><span id="l50.91">     let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l50.92"></a><span id="l50.92"> </span>
<a href="#l50.93"></a><span id="l50.93" class="difflineminus">-    if (aStateFlags &amp; nsIWebProgressListener.STATE_START) {</span>
<a href="#l50.94"></a><span id="l50.94" class="difflineplus">+    if (aStateFlags &amp; Ci.nsIWebProgressListener.STATE_START) {</span>
<a href="#l50.95"></a><span id="l50.95">       this.mRequestCount++;</span>
<a href="#l50.96"></a><span id="l50.96" class="difflineminus">-    }</span>
<a href="#l50.97"></a><span id="l50.97" class="difflineminus">-    else if (aStateFlags &amp; nsIWebProgressListener.STATE_STOP) {</span>
<a href="#l50.98"></a><span id="l50.98" class="difflineplus">+    } else if (aStateFlags &amp; Ci.nsIWebProgressListener.STATE_STOP) {</span>
<a href="#l50.99"></a><span id="l50.99">       // Since we (try to) only handle STATE_STOP of the last request,</span>
<a href="#l50.100"></a><span id="l50.100">       // the count of open requests should now be 0.</span>
<a href="#l50.101"></a><span id="l50.101">       this.mRequestCount = 0;</span>
<a href="#l50.102"></a><span id="l50.102">     }</span>
<a href="#l50.103"></a><span id="l50.103"> </span>
<a href="#l50.104"></a><span id="l50.104" class="difflineminus">-    if (aStateFlags &amp; nsIWebProgressListener.STATE_START &amp;&amp;</span>
<a href="#l50.105"></a><span id="l50.105" class="difflineminus">-        aStateFlags &amp; nsIWebProgressListener.STATE_IS_NETWORK) {</span>
<a href="#l50.106"></a><span id="l50.106" class="difflineplus">+    if (aStateFlags &amp; Ci.nsIWebProgressListener.STATE_START &amp;&amp;</span>
<a href="#l50.107"></a><span id="l50.107" class="difflineplus">+        aStateFlags &amp; Ci.nsIWebProgressListener.STATE_IS_NETWORK) {</span>
<a href="#l50.108"></a><span id="l50.108">       if (!this.mBlank) {</span>
<a href="#l50.109"></a><span id="l50.109">         this.mTab.title = specialTabs.contentTabType.loadingTabString;</span>
<a href="#l50.110"></a><span id="l50.110">         this.mTab.security.setAttribute(&quot;loading&quot;, &quot;true&quot;);</span>
<a href="#l50.111"></a><span id="l50.111">         tabmail.setTabBusy(this.mTab, true);</span>
<a href="#l50.112"></a><span id="l50.112">         tabmail.setTabTitle(this.mTab);</span>
<a href="#l50.113"></a><span id="l50.113">       }</span>
<a href="#l50.114"></a><span id="l50.114"> </span>
<a href="#l50.115"></a><span id="l50.115">       // Set our unit testing variables accordingly</span>
<a href="#l50.116"></a><span id="l50.116">       this.mTab.pageLoading = true;</span>
<a href="#l50.117"></a><span id="l50.117">       this.mTab.pageLoaded = false;</span>
<a href="#l50.118"></a><span id="l50.118" class="difflineminus">-    }</span>
<a href="#l50.119"></a><span id="l50.119" class="difflineminus">-    else if (aStateFlags &amp; nsIWebProgressListener.STATE_STOP &amp;&amp;</span>
<a href="#l50.120"></a><span id="l50.120" class="difflineminus">-             aStateFlags &amp; nsIWebProgressListener.STATE_IS_NETWORK) {</span>
<a href="#l50.121"></a><span id="l50.121" class="difflineplus">+    } else if (aStateFlags &amp; Ci.nsIWebProgressListener.STATE_STOP &amp;&amp;</span>
<a href="#l50.122"></a><span id="l50.122" class="difflineplus">+               aStateFlags &amp; Ci.nsIWebProgressListener.STATE_IS_NETWORK) {</span>
<a href="#l50.123"></a><span id="l50.123">       this.mBlank = false;</span>
<a href="#l50.124"></a><span id="l50.124">       this.mTab.security.removeAttribute(&quot;loading&quot;);</span>
<a href="#l50.125"></a><span id="l50.125">       tabmail.setTabBusy(this.mTab, false);</span>
<a href="#l50.126"></a><span id="l50.126">       tabmail.setTabTitle(this.mTab);</span>
<a href="#l50.127"></a><span id="l50.127"> </span>
<a href="#l50.128"></a><span id="l50.128">       // Set our unit testing variables accordingly</span>
<a href="#l50.129"></a><span id="l50.129">       this.mTab.pageLoading = false;</span>
<a href="#l50.130"></a><span id="l50.130">       this.mTab.pageLoaded = true;</span>
<a href="#l50.131"></a><span id="l50.131"> </span>
<a href="#l50.132"></a><span id="l50.132">       // If we've finished loading, and we've not had an icon loaded from a</span>
<a href="#l50.133"></a><span id="l50.133">       // link element, then we try using the default icon for the site.</span>
<a href="#l50.134"></a><span id="l50.134">       if (aWebProgress.DOMWindow == this.mBrowser.contentWindow &amp;&amp;</span>
<a href="#l50.135"></a><span id="l50.135">         !this.mBrowser.mIconURL)</span>
<a href="#l50.136"></a><span id="l50.136">         specialTabs.useDefaultIcon(this.mTab);</span>
<a href="#l50.137"></a><span id="l50.137">     }</span>
<a href="#l50.138"></a><span id="l50.138">   },</span>
<a href="#l50.139"></a><span id="l50.139" class="difflineminus">-  onStatusChange: function tPL_onStatusChange(aWebProgress, aRequest, aStatus,</span>
<a href="#l50.140"></a><span id="l50.140" class="difflineminus">-                                              aMessage) {</span>
<a href="#l50.141"></a><span id="l50.141" class="difflineplus">+  onStatusChange(aWebProgress, aRequest, aStatus, aMessage) {</span>
<a href="#l50.142"></a><span id="l50.142">     if (this.mProgressListener)</span>
<a href="#l50.143"></a><span id="l50.143">       this.mProgressListener.onStatusChange(aWebProgress, aRequest, aStatus,</span>
<a href="#l50.144"></a><span id="l50.144">         aMessage);</span>
<a href="#l50.145"></a><span id="l50.145">   },</span>
<a href="#l50.146"></a><span id="l50.146" class="difflineminus">-  onSecurityChange: function tPL_onSecurityChange(aWebProgress, aRequest,</span>
<a href="#l50.147"></a><span id="l50.147" class="difflineminus">-                                                  aOldState, aState, aContentBlockingLogJSON) {</span>
<a href="#l50.148"></a><span id="l50.148" class="difflineplus">+  onSecurityChange(aWebProgress, aRequest, aOldState, aState, aContentBlockingLogJSON) {</span>
<a href="#l50.149"></a><span id="l50.149">     if (this.mProgressListener)</span>
<a href="#l50.150"></a><span id="l50.150">       this.mProgressListener.onSecurityChange(aWebProgress, aRequest, aOldState, aState, aContentBlockingLogJSON);</span>
<a href="#l50.151"></a><span id="l50.151"> </span>
<a href="#l50.152"></a><span id="l50.152">     const wpl = Ci.nsIWebProgressListener;</span>
<a href="#l50.153"></a><span id="l50.153">     const wpl_security_bits = wpl.STATE_IS_SECURE |</span>
<a href="#l50.154"></a><span id="l50.154">                               wpl.STATE_IS_BROKEN |</span>
<a href="#l50.155"></a><span id="l50.155">                               wpl.STATE_IS_INSECURE |</span>
<a href="#l50.156"></a><span id="l50.156">                               wpl.STATE_SECURE_HIGH |</span>
<a href="#l50.157"></a><span id="l50.157" class="difflineat">@@ -180,36 +163,35 @@ tabProgressListener.prototype =</span>
<a href="#l50.158"></a><span id="l50.158">     if (level) {</span>
<a href="#l50.159"></a><span id="l50.159">       this.mTab.security.setAttribute(&quot;level&quot;, level);</span>
<a href="#l50.160"></a><span id="l50.160">       this.mTab.security.hidden = false;</span>
<a href="#l50.161"></a><span id="l50.161">     } else {</span>
<a href="#l50.162"></a><span id="l50.162">       this.mTab.security.hidden = true;</span>
<a href="#l50.163"></a><span id="l50.163">       this.mTab.security.removeAttribute(&quot;level&quot;);</span>
<a href="#l50.164"></a><span id="l50.164">     }</span>
<a href="#l50.165"></a><span id="l50.165">   },</span>
<a href="#l50.166"></a><span id="l50.166" class="difflineminus">-  onRefreshAttempted: function tPL_OnRefreshAttempted(aWebProgress, aURI,</span>
<a href="#l50.167"></a><span id="l50.167" class="difflineminus">-                                                      aDelay, aSameURI) {</span>
<a href="#l50.168"></a><span id="l50.168" class="difflineplus">+  onRefreshAttempted(aWebProgress, aURI, aDelay, aSameURI) {</span>
<a href="#l50.169"></a><span id="l50.169">     if (this.mProgressListener)</span>
<a href="#l50.170"></a><span id="l50.170">       this.mProgressListener.onRefreshAttempted(aWebProgress, aURI, aDelay,</span>
<a href="#l50.171"></a><span id="l50.171">         aSameURI);</span>
<a href="#l50.172"></a><span id="l50.172">   },</span>
<a href="#l50.173"></a><span id="l50.173">   QueryInterface: ChromeUtils.generateQI([Ci.nsIWebProgressListener,</span>
<a href="#l50.174"></a><span id="l50.174">                                           Ci.nsIWebProgressListener2,</span>
<a href="#l50.175"></a><span id="l50.175" class="difflineminus">-                                          Ci.nsISupportsWeakReference])</span>
<a href="#l50.176"></a><span id="l50.176" class="difflineplus">+                                          Ci.nsISupportsWeakReference]),</span>
<a href="#l50.177"></a><span id="l50.177"> };</span>
<a href="#l50.178"></a><span id="l50.178"> </span>
<a href="#l50.179"></a><span id="l50.179"> var DOMLinkHandler = {</span>
<a href="#l50.180"></a><span id="l50.180" class="difflineminus">-  handleEvent: function (event) {</span>
<a href="#l50.181"></a><span id="l50.181" class="difflineplus">+  handleEvent(event) {</span>
<a href="#l50.182"></a><span id="l50.182">     switch (event.type) {</span>
<a href="#l50.183"></a><span id="l50.183">     case &quot;DOMLinkAdded&quot;:</span>
<a href="#l50.184"></a><span id="l50.184">       this.onLinkAdded(event);</span>
<a href="#l50.185"></a><span id="l50.185">       break;</span>
<a href="#l50.186"></a><span id="l50.186">     }</span>
<a href="#l50.187"></a><span id="l50.187">   },</span>
<a href="#l50.188"></a><span id="l50.188" class="difflineminus">-  onLinkAdded: function (event) {</span>
<a href="#l50.189"></a><span id="l50.189" class="difflineplus">+  onLinkAdded(event) {</span>
<a href="#l50.190"></a><span id="l50.190">     let link = event.originalTarget;</span>
<a href="#l50.191"></a><span id="l50.191">     let rel = link.rel &amp;&amp; link.rel.toLowerCase();</span>
<a href="#l50.192"></a><span id="l50.192">     if (!link || !link.ownerDocument || !rel || !link.href)</span>
<a href="#l50.193"></a><span id="l50.193">       return;</span>
<a href="#l50.194"></a><span id="l50.194"> </span>
<a href="#l50.195"></a><span id="l50.195">     if (rel.split(/\s+/).includes(&quot;icon&quot;)) {</span>
<a href="#l50.196"></a><span id="l50.196">       if (!Services.prefs.getBoolPref(&quot;browser.chrome.site_icons&quot;))</span>
<a href="#l50.197"></a><span id="l50.197">         return;</span>
<a href="#l50.198"></a><span id="l50.198" class="difflineat">@@ -218,49 +200,47 @@ var DOMLinkHandler = {</span>
<a href="#l50.199"></a><span id="l50.199">       let uri = makeURI(link.href, targetDoc.characterSet);</span>
<a href="#l50.200"></a><span id="l50.200"> </span>
<a href="#l50.201"></a><span id="l50.201">       // Verify that the load of this icon is legal.</span>
<a href="#l50.202"></a><span id="l50.202">       // Some error or special pages can load their favicon.</span>
<a href="#l50.203"></a><span id="l50.203">       // To be on the safe side, only allow chrome:// favicons.</span>
<a href="#l50.204"></a><span id="l50.204">       let isAllowedPage = (targetDoc.documentURI == &quot;about:home&quot;) ||</span>
<a href="#l50.205"></a><span id="l50.205">         [&quot;about:neterror?&quot;,</span>
<a href="#l50.206"></a><span id="l50.206">          &quot;about:blocked?&quot;,</span>
<a href="#l50.207"></a><span id="l50.207" class="difflineminus">-         &quot;about:certerror?&quot;</span>
<a href="#l50.208"></a><span id="l50.208" class="difflineminus">-        ].some(function (aStart) { targetDoc.documentURI.startsWith(aStart); });</span>
<a href="#l50.209"></a><span id="l50.209" class="difflineplus">+         &quot;about:certerror?&quot;,</span>
<a href="#l50.210"></a><span id="l50.210" class="difflineplus">+        ].some(function(aStart) { targetDoc.documentURI.startsWith(aStart); });</span>
<a href="#l50.211"></a><span id="l50.211"> </span>
<a href="#l50.212"></a><span id="l50.212">       if (!isAllowedPage || !uri.schemeIs(&quot;chrome&quot;)) {</span>
<a href="#l50.213"></a><span id="l50.213">         // Be extra paraniod and just make sure we're not going to load</span>
<a href="#l50.214"></a><span id="l50.214">         // something we shouldn't. Firefox does this, so we're doing the same.</span>
<a href="#l50.215"></a><span id="l50.215">           try {</span>
<a href="#l50.216"></a><span id="l50.216">             Services.scriptSecurityManager.checkLoadURIWithPrincipal(targetDoc.nodePrincipal, uri,</span>
<a href="#l50.217"></a><span id="l50.217">                                            Ci.nsIScriptSecurityManager.DISALLOW_SCRIPT);</span>
<a href="#l50.218"></a><span id="l50.218" class="difflineminus">-          }</span>
<a href="#l50.219"></a><span id="l50.219" class="difflineminus">-          catch (ex) {</span>
<a href="#l50.220"></a><span id="l50.220" class="difflineplus">+          } catch (ex) {</span>
<a href="#l50.221"></a><span id="l50.221">             return;</span>
<a href="#l50.222"></a><span id="l50.222">           }</span>
<a href="#l50.223"></a><span id="l50.223">       }</span>
<a href="#l50.224"></a><span id="l50.224"> </span>
<a href="#l50.225"></a><span id="l50.225">       try {</span>
<a href="#l50.226"></a><span id="l50.226">         var contentPolicy = Cc[&quot;@mozilla.org/layout/content-policy;1&quot;]</span>
<a href="#l50.227"></a><span id="l50.227">                               .getService(Ci.nsIContentPolicy);</span>
<a href="#l50.228"></a><span id="l50.228" class="difflineminus">-      }</span>
<a href="#l50.229"></a><span id="l50.229" class="difflineminus">-      catch (e) {</span>
<a href="#l50.230"></a><span id="l50.230" class="difflineplus">+      } catch (e) {</span>
<a href="#l50.231"></a><span id="l50.231">         // Refuse to load if we can't do a security check.</span>
<a href="#l50.232"></a><span id="l50.232">         return;</span>
<a href="#l50.233"></a><span id="l50.233">       }</span>
<a href="#l50.234"></a><span id="l50.234"> </span>
<a href="#l50.235"></a><span id="l50.235">       // Security says okay, now ask content policy. This is probably trying to</span>
<a href="#l50.236"></a><span id="l50.236">       // ensure that the image loaded always obeys the content policy. There</span>
<a href="#l50.237"></a><span id="l50.237">       // may have been a chance that it was cached and we're trying to load it</span>
<a href="#l50.238"></a><span id="l50.238">       // direct from the cache and not the normal route.</span>
<a href="#l50.239"></a><span id="l50.239">       let tmpChannel = NetUtil.newChannel({</span>
<a href="#l50.240"></a><span id="l50.240" class="difflineminus">-        uri: uri,</span>
<a href="#l50.241"></a><span id="l50.241" class="difflineplus">+        uri,</span>
<a href="#l50.242"></a><span id="l50.242">         loadingNode: targetDoc,</span>
<a href="#l50.243"></a><span id="l50.243">         securityFlags: Ci.nsILoadInfo.SEC_ONLY_FOR_EXPLICIT_CONTENTSEC_CHECK,</span>
<a href="#l50.244"></a><span id="l50.244" class="difflineminus">-        contentPolicyType: Ci.nsIContentPolicy.TYPE_IMAGE</span>
<a href="#l50.245"></a><span id="l50.245" class="difflineplus">+        contentPolicyType: Ci.nsIContentPolicy.TYPE_IMAGE,</span>
<a href="#l50.246"></a><span id="l50.246">       });</span>
<a href="#l50.247"></a><span id="l50.247">       let tmpLoadInfo = tmpChannel.loadInfo;</span>
<a href="#l50.248"></a><span id="l50.248">       if (contentPolicy.shouldLoad(uri, tmpLoadInfo, link.type) !=</span>
<a href="#l50.249"></a><span id="l50.249">                                    Ci.nsIContentPolicy.ACCEPT)</span>
<a href="#l50.250"></a><span id="l50.250">         return;</span>
<a href="#l50.251"></a><span id="l50.251"> </span>
<a href="#l50.252"></a><span id="l50.252">       let tab = document.getElementById(&quot;tabmail&quot;)</span>
<a href="#l50.253"></a><span id="l50.253">                         .getBrowserForDocument(targetDoc.defaultView);</span>
<a href="#l50.254"></a><span id="l50.254" class="difflineat">@@ -268,60 +248,60 @@ var DOMLinkHandler = {</span>
<a href="#l50.255"></a><span id="l50.255">       // If we don't have a browser/tab, then don't load the icon.</span>
<a href="#l50.256"></a><span id="l50.256">       if (!tab)</span>
<a href="#l50.257"></a><span id="l50.257">         return;</span>
<a href="#l50.258"></a><span id="l50.258"> </span>
<a href="#l50.259"></a><span id="l50.259">       // Just set the url on the browser and we'll display the actual icon</span>
<a href="#l50.260"></a><span id="l50.260">       // when we finish loading the page.</span>
<a href="#l50.261"></a><span id="l50.261">       specialTabs.setTabIcon(tab, link.href);</span>
<a href="#l50.262"></a><span id="l50.262">     }</span>
<a href="#l50.263"></a><span id="l50.263" class="difflineminus">-  }</span>
<a href="#l50.264"></a><span id="l50.264" class="difflineplus">+  },</span>
<a href="#l50.265"></a><span id="l50.265"> };</span>
<a href="#l50.266"></a><span id="l50.266"> </span>
<a href="#l50.267"></a><span id="l50.267"> var kTelemetryPrompted    = &quot;toolkit.telemetry.prompted&quot;;</span>
<a href="#l50.268"></a><span id="l50.268"> var kTelemetryEnabled     = &quot;toolkit.telemetry.enabled&quot;;</span>
<a href="#l50.269"></a><span id="l50.269"> var kTelemetryRejected    = &quot;toolkit.telemetry.rejected&quot;;</span>
<a href="#l50.270"></a><span id="l50.270"> var kTelemetryServerOwner = &quot;toolkit.telemetry.server_owner&quot;;</span>
<a href="#l50.271"></a><span id="l50.271"> // This is used to reprompt/renotify users when privacy message changes</span>
<a href="#l50.272"></a><span id="l50.272"> var kTelemetryPromptRev   = 2;</span>
<a href="#l50.273"></a><span id="l50.273"> </span>
<a href="#l50.274"></a><span id="l50.274"> var contentTabBaseType = {</span>
<a href="#l50.275"></a><span id="l50.275">   // List of URLs that will receive special treatment when opened in a tab.</span>
<a href="#l50.276"></a><span id="l50.276">   // Note that about:preferences is loaded via a different mechanism.</span>
<a href="#l50.277"></a><span id="l50.277">   inContentWhitelist: [</span>
<a href="#l50.278"></a><span id="l50.278">     &quot;about:addons&quot;,</span>
<a href="#l50.279"></a><span id="l50.279">     &quot;about:blank&quot;,</span>
<a href="#l50.280"></a><span id="l50.280" class="difflineminus">-    &quot;about:*&quot;</span>
<a href="#l50.281"></a><span id="l50.281" class="difflineplus">+    &quot;about:*&quot;,</span>
<a href="#l50.282"></a><span id="l50.282">   ],</span>
<a href="#l50.283"></a><span id="l50.283"> </span>
<a href="#l50.284"></a><span id="l50.284">   // Code to run if a particular document is loaded in a tab.</span>
<a href="#l50.285"></a><span id="l50.285">   // The array members (functions) are for the respective document URLs</span>
<a href="#l50.286"></a><span id="l50.286">   // as specified in inContentWhitelist.</span>
<a href="#l50.287"></a><span id="l50.287">   inContentOverlays: [</span>
<a href="#l50.288"></a><span id="l50.288">     // about:addons</span>
<a href="#l50.289"></a><span id="l50.289" class="difflineminus">-    function (aDocument, aTab) {</span>
<a href="#l50.290"></a><span id="l50.290" class="difflineplus">+    function(aDocument, aTab) {</span>
<a href="#l50.291"></a><span id="l50.291">       // Switch off the context menu.</span>
<a href="#l50.292"></a><span id="l50.292">       aTab.browser.removeAttribute(&quot;context&quot;);</span>
<a href="#l50.293"></a><span id="l50.293"> </span>
<a href="#l50.294"></a><span id="l50.294">       Services.scriptloader.loadSubScript(</span>
<a href="#l50.295"></a><span id="l50.295">         &quot;chrome://messenger/content/aboutAddonsExtra.js&quot;, aDocument.defaultView</span>
<a href="#l50.296"></a><span id="l50.296">       );</span>
<a href="#l50.297"></a><span id="l50.297">     },</span>
<a href="#l50.298"></a><span id="l50.298"> </span>
<a href="#l50.299"></a><span id="l50.299">     // Let's not mess with about:blank.</span>
<a href="#l50.300"></a><span id="l50.300">     null,</span>
<a href="#l50.301"></a><span id="l50.301"> </span>
<a href="#l50.302"></a><span id="l50.302">     // Other about:* pages.</span>
<a href="#l50.303"></a><span id="l50.303" class="difflineminus">-    function (aDocument, aTab) {</span>
<a href="#l50.304"></a><span id="l50.304" class="difflineplus">+    function(aDocument, aTab) {</span>
<a href="#l50.305"></a><span id="l50.305">       // Provide context menu for about:* pages.</span>
<a href="#l50.306"></a><span id="l50.306">       aTab.browser.setAttribute(&quot;context&quot;, &quot;aboutPagesContext&quot;);</span>
<a href="#l50.307"></a><span id="l50.307" class="difflineminus">-    }</span>
<a href="#l50.308"></a><span id="l50.308" class="difflineplus">+    },</span>
<a href="#l50.309"></a><span id="l50.309">   ],</span>
<a href="#l50.310"></a><span id="l50.310"> </span>
<a href="#l50.311"></a><span id="l50.311" class="difflineminus">-  shouldSwitchTo: function onSwitchTo({contentPage: aContentPage, duplicate: aDuplicate}) {</span>
<a href="#l50.312"></a><span id="l50.312" class="difflineplus">+  shouldSwitchTo({contentPage: aContentPage, duplicate: aDuplicate}) {</span>
<a href="#l50.313"></a><span id="l50.313">     if (aDuplicate) {</span>
<a href="#l50.314"></a><span id="l50.314">       return -1;</span>
<a href="#l50.315"></a><span id="l50.315">     }</span>
<a href="#l50.316"></a><span id="l50.316"> </span>
<a href="#l50.317"></a><span id="l50.317">     let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l50.318"></a><span id="l50.318">     let tabInfo = tabmail.tabInfo;</span>
<a href="#l50.319"></a><span id="l50.319"> </span>
<a href="#l50.320"></a><span id="l50.320">     // Remove any anchors - especially for the about: pages, we just want</span>
<a href="#l50.321"></a><span id="l50.321" class="difflineat">@@ -338,43 +318,43 @@ var contentTabBaseType = {</span>
<a href="#l50.322"></a><span id="l50.322">         tabInfo[selectedIndex].browser</span>
<a href="#l50.323"></a><span id="l50.323">                               .setAttribute(&quot;src&quot;, aContentPage);</span>
<a href="#l50.324"></a><span id="l50.324">         return selectedIndex;</span>
<a href="#l50.325"></a><span id="l50.325">       }</span>
<a href="#l50.326"></a><span id="l50.326">     }</span>
<a href="#l50.327"></a><span id="l50.327">     return -1;</span>
<a href="#l50.328"></a><span id="l50.328">   },</span>
<a href="#l50.329"></a><span id="l50.329"> </span>
<a href="#l50.330"></a><span id="l50.330" class="difflineminus">-  closeTab: function onTabClosed(aTab) {</span>
<a href="#l50.331"></a><span id="l50.331" class="difflineplus">+  closeTab(aTab) {</span>
<a href="#l50.332"></a><span id="l50.332">     aTab.browser.removeEventListener(&quot;DOMTitleChanged&quot;,</span>
<a href="#l50.333"></a><span id="l50.333">                                      aTab.titleListener, true);</span>
<a href="#l50.334"></a><span id="l50.334">     aTab.browser.removeEventListener(&quot;DOMWindowClose&quot;,</span>
<a href="#l50.335"></a><span id="l50.335">                                      aTab.closeListener, true);</span>
<a href="#l50.336"></a><span id="l50.336">     aTab.browser.removeEventListener(&quot;DOMLinkAdded&quot;, DOMLinkHandler);</span>
<a href="#l50.337"></a><span id="l50.337">     gPluginHandler.removeEventListeners(aTab.browser);</span>
<a href="#l50.338"></a><span id="l50.338">     aTab.browser.webProgress.removeProgressListener(aTab.filter);</span>
<a href="#l50.339"></a><span id="l50.339">     aTab.filter.removeProgressListener(aTab.progressListener);</span>
<a href="#l50.340"></a><span id="l50.340">     aTab.browser.destroy();</span>
<a href="#l50.341"></a><span id="l50.341">   },</span>
<a href="#l50.342"></a><span id="l50.342"> </span>
<a href="#l50.343"></a><span id="l50.343" class="difflineminus">-  saveTabState: function onSaveTabState(aTab) {</span>
<a href="#l50.344"></a><span id="l50.344" class="difflineplus">+  saveTabState(aTab) {</span>
<a href="#l50.345"></a><span id="l50.345">     aTab.browser.setAttribute(&quot;type&quot;, &quot;content&quot;);</span>
<a href="#l50.346"></a><span id="l50.346">     aTab.browser.removeAttribute(&quot;primary&quot;);</span>
<a href="#l50.347"></a><span id="l50.347">   },</span>
<a href="#l50.348"></a><span id="l50.348"> </span>
<a href="#l50.349"></a><span id="l50.349" class="difflineminus">-  showTab: function onShowTab(aTab) {</span>
<a href="#l50.350"></a><span id="l50.350" class="difflineplus">+  showTab(aTab) {</span>
<a href="#l50.351"></a><span id="l50.351">     aTab.browser.setAttribute(&quot;type&quot;, &quot;content&quot;);</span>
<a href="#l50.352"></a><span id="l50.352">     aTab.browser.setAttribute(&quot;primary&quot;, &quot;true&quot;);</span>
<a href="#l50.353"></a><span id="l50.353">   },</span>
<a href="#l50.354"></a><span id="l50.354"> </span>
<a href="#l50.355"></a><span id="l50.355" class="difflineminus">-  getBrowser: function getBrowser(aTab) {</span>
<a href="#l50.356"></a><span id="l50.356" class="difflineplus">+  getBrowser(aTab) {</span>
<a href="#l50.357"></a><span id="l50.357">     return aTab.browser;</span>
<a href="#l50.358"></a><span id="l50.358">   },</span>
<a href="#l50.359"></a><span id="l50.359"> </span>
<a href="#l50.360"></a><span id="l50.360" class="difflineminus">-  _setUpLoadListener: function setUpLoadListener(aTab) {</span>
<a href="#l50.361"></a><span id="l50.361" class="difflineplus">+  _setUpLoadListener(aTab) {</span>
<a href="#l50.362"></a><span id="l50.362">     let self = this;</span>
<a href="#l50.363"></a><span id="l50.363"> </span>
<a href="#l50.364"></a><span id="l50.364">     function onLoad(aEvent) {</span>
<a href="#l50.365"></a><span id="l50.365">       let doc = aEvent.originalTarget;</span>
<a href="#l50.366"></a><span id="l50.366">       let url = doc.defaultView.location.href;</span>
<a href="#l50.367"></a><span id="l50.367"> </span>
<a href="#l50.368"></a><span id="l50.368">       // If this document has an overlay defined, run it now.</span>
<a href="#l50.369"></a><span id="l50.369">       let ind = self.inContentWhitelist.indexOf(url);</span>
<a href="#l50.370"></a><span id="l50.370" class="difflineat">@@ -389,48 +369,48 @@ var contentTabBaseType = {</span>
<a href="#l50.371"></a><span id="l50.371">       }</span>
<a href="#l50.372"></a><span id="l50.372">     }</span>
<a href="#l50.373"></a><span id="l50.373"> </span>
<a href="#l50.374"></a><span id="l50.374">     aTab.loadListener = onLoad;</span>
<a href="#l50.375"></a><span id="l50.375">     aTab.browser.addEventListener(&quot;load&quot;, aTab.loadListener, true);</span>
<a href="#l50.376"></a><span id="l50.376">   },</span>
<a href="#l50.377"></a><span id="l50.377"> </span>
<a href="#l50.378"></a><span id="l50.378">   // Internal function used to set up the title listener on a content tab.</span>
<a href="#l50.379"></a><span id="l50.379" class="difflineminus">-  _setUpTitleListener: function setUpTitleListener(aTab) {</span>
<a href="#l50.380"></a><span id="l50.380" class="difflineplus">+  _setUpTitleListener(aTab) {</span>
<a href="#l50.381"></a><span id="l50.381">     function onDOMTitleChanged(aEvent) {</span>
<a href="#l50.382"></a><span id="l50.382">       aTab.title = aTab.browser.contentTitle;</span>
<a href="#l50.383"></a><span id="l50.383">       document.getElementById(&quot;tabmail&quot;).setTabTitle(aTab);</span>
<a href="#l50.384"></a><span id="l50.384">     }</span>
<a href="#l50.385"></a><span id="l50.385">     // Save the function we'll use as listener so we can remove it later.</span>
<a href="#l50.386"></a><span id="l50.386">     aTab.titleListener = onDOMTitleChanged;</span>
<a href="#l50.387"></a><span id="l50.387">     // Add the listener.</span>
<a href="#l50.388"></a><span id="l50.388">     aTab.browser.addEventListener(&quot;DOMTitleChanged&quot;, aTab.titleListener, true);</span>
<a href="#l50.389"></a><span id="l50.389">   },</span>
<a href="#l50.390"></a><span id="l50.390"> </span>
<a href="#l50.391"></a><span id="l50.391">     /**</span>
<a href="#l50.392"></a><span id="l50.392">      * Internal function used to set up the close window listener on a content</span>
<a href="#l50.393"></a><span id="l50.393">      * tab.</span>
<a href="#l50.394"></a><span id="l50.394">      */</span>
<a href="#l50.395"></a><span id="l50.395" class="difflineminus">-  _setUpCloseWindowListener: function setUpCloseWindowListener(aTab) {</span>
<a href="#l50.396"></a><span id="l50.396" class="difflineplus">+  _setUpCloseWindowListener(aTab) {</span>
<a href="#l50.397"></a><span id="l50.397">     function onDOMWindowClose(aEvent) {</span>
<a href="#l50.398"></a><span id="l50.398">       if (!aEvent.isTrusted)</span>
<a href="#l50.399"></a><span id="l50.399">         return;</span>
<a href="#l50.400"></a><span id="l50.400"> </span>
<a href="#l50.401"></a><span id="l50.401">       // Redirect any window.close events to closing the tab. As a 3-pane tab</span>
<a href="#l50.402"></a><span id="l50.402">       // must be open, we don't need to worry about being the last tab open.</span>
<a href="#l50.403"></a><span id="l50.403">       document.getElementById(&quot;tabmail&quot;).closeTab(aTab);</span>
<a href="#l50.404"></a><span id="l50.404">       aEvent.preventDefault();</span>
<a href="#l50.405"></a><span id="l50.405">     }</span>
<a href="#l50.406"></a><span id="l50.406">     // Save the function we'll use as listener so we can remove it later.</span>
<a href="#l50.407"></a><span id="l50.407">     aTab.closeListener = onDOMWindowClose;</span>
<a href="#l50.408"></a><span id="l50.408">     // Add the listener.</span>
<a href="#l50.409"></a><span id="l50.409">     aTab.browser.addEventListener(&quot;DOMWindowClose&quot;, aTab.closeListener, true);</span>
<a href="#l50.410"></a><span id="l50.410">   },</span>
<a href="#l50.411"></a><span id="l50.411"> </span>
<a href="#l50.412"></a><span id="l50.412" class="difflineminus">-  supportsCommand: function supportsCommand(aCommand, aTab) {</span>
<a href="#l50.413"></a><span id="l50.413" class="difflineplus">+  supportsCommand(aCommand, aTab) {</span>
<a href="#l50.414"></a><span id="l50.414">     switch (aCommand) {</span>
<a href="#l50.415"></a><span id="l50.415">       case &quot;cmd_fullZoomReduce&quot;:</span>
<a href="#l50.416"></a><span id="l50.416">       case &quot;cmd_fullZoomEnlarge&quot;:</span>
<a href="#l50.417"></a><span id="l50.417">       case &quot;cmd_fullZoomReset&quot;:</span>
<a href="#l50.418"></a><span id="l50.418">       case &quot;cmd_fullZoomToggle&quot;:</span>
<a href="#l50.419"></a><span id="l50.419">       case &quot;cmd_find&quot;:</span>
<a href="#l50.420"></a><span id="l50.420">       case &quot;cmd_findAgain&quot;:</span>
<a href="#l50.421"></a><span id="l50.421">       case &quot;cmd_findPrevious&quot;:</span>
<a href="#l50.422"></a><span id="l50.422" class="difflineat">@@ -442,17 +422,17 @@ var contentTabBaseType = {</span>
<a href="#l50.423"></a><span id="l50.423">       // XXX print preview not currently supported - bug 497994 to implement.</span>
<a href="#l50.424"></a><span id="l50.424">       // case &quot;cmd_printpreview&quot;:</span>
<a href="#l50.425"></a><span id="l50.425">         return true;</span>
<a href="#l50.426"></a><span id="l50.426">       default:</span>
<a href="#l50.427"></a><span id="l50.427">         return false;</span>
<a href="#l50.428"></a><span id="l50.428">     }</span>
<a href="#l50.429"></a><span id="l50.429">   },</span>
<a href="#l50.430"></a><span id="l50.430"> </span>
<a href="#l50.431"></a><span id="l50.431" class="difflineminus">-  isCommandEnabled: function isCommandEnabled(aCommand, aTab) {</span>
<a href="#l50.432"></a><span id="l50.432" class="difflineplus">+  isCommandEnabled(aCommand, aTab) {</span>
<a href="#l50.433"></a><span id="l50.433">     switch (aCommand) {</span>
<a href="#l50.434"></a><span id="l50.434">       case &quot;cmd_fullZoomReduce&quot;:</span>
<a href="#l50.435"></a><span id="l50.435">       case &quot;cmd_fullZoomEnlarge&quot;:</span>
<a href="#l50.436"></a><span id="l50.436">       case &quot;cmd_fullZoomReset&quot;:</span>
<a href="#l50.437"></a><span id="l50.437">       case &quot;cmd_fullZoomToggle&quot;:</span>
<a href="#l50.438"></a><span id="l50.438">       case &quot;cmd_find&quot;:</span>
<a href="#l50.439"></a><span id="l50.439">       case &quot;cmd_findAgain&quot;:</span>
<a href="#l50.440"></a><span id="l50.440">       case &quot;cmd_findPrevious&quot;:</span>
<a href="#l50.441"></a><span id="l50.441" class="difflineat">@@ -466,17 +446,17 @@ var contentTabBaseType = {</span>
<a href="#l50.442"></a><span id="l50.442">         return aTab.reloadEnabled;</span>
<a href="#l50.443"></a><span id="l50.443">       case &quot;cmd_stop&quot;:</span>
<a href="#l50.444"></a><span id="l50.444">         return aTab.busy;</span>
<a href="#l50.445"></a><span id="l50.445">       default:</span>
<a href="#l50.446"></a><span id="l50.446">         return false;</span>
<a href="#l50.447"></a><span id="l50.447">     }</span>
<a href="#l50.448"></a><span id="l50.448">   },</span>
<a href="#l50.449"></a><span id="l50.449"> </span>
<a href="#l50.450"></a><span id="l50.450" class="difflineminus">-  doCommand: function doCommand(aCommand, aTab) {</span>
<a href="#l50.451"></a><span id="l50.451" class="difflineplus">+  doCommand(aCommand, aTab) {</span>
<a href="#l50.452"></a><span id="l50.452">     switch (aCommand) {</span>
<a href="#l50.453"></a><span id="l50.453">       case &quot;cmd_fullZoomReduce&quot;:</span>
<a href="#l50.454"></a><span id="l50.454">         ZoomManager.reduce();</span>
<a href="#l50.455"></a><span id="l50.455">         break;</span>
<a href="#l50.456"></a><span id="l50.456">       case &quot;cmd_fullZoomEnlarge&quot;:</span>
<a href="#l50.457"></a><span id="l50.457">         ZoomManager.enlarge();</span>
<a href="#l50.458"></a><span id="l50.458">         break;</span>
<a href="#l50.459"></a><span id="l50.459">       case &quot;cmd_fullZoomReset&quot;:</span>
<a href="#l50.460"></a><span id="l50.460" class="difflineat">@@ -497,17 +477,17 @@ var contentTabBaseType = {</span>
<a href="#l50.461"></a><span id="l50.461">       case &quot;cmd_printSetup&quot;:</span>
<a href="#l50.462"></a><span id="l50.462">         PrintUtils.showPageSetup();</span>
<a href="#l50.463"></a><span id="l50.463">         break;</span>
<a href="#l50.464"></a><span id="l50.464">       case &quot;cmd_print&quot;:</span>
<a href="#l50.465"></a><span id="l50.465">         let browser = this.getBrowser(aTab);</span>
<a href="#l50.466"></a><span id="l50.466">         PrintUtils.printWindow(browser.outerWindowID, browser);</span>
<a href="#l50.467"></a><span id="l50.467">         break;</span>
<a href="#l50.468"></a><span id="l50.468">       // XXX print preview not currently supported - bug 497994 to implement.</span>
<a href="#l50.469"></a><span id="l50.469" class="difflineminus">-      //case &quot;cmd_printpreview&quot;:</span>
<a href="#l50.470"></a><span id="l50.470" class="difflineplus">+      // case &quot;cmd_printpreview&quot;:</span>
<a href="#l50.471"></a><span id="l50.471">       //  PrintUtils.printPreview();</span>
<a href="#l50.472"></a><span id="l50.472">       //  break;</span>
<a href="#l50.473"></a><span id="l50.473">       case &quot;cmd_stop&quot;:</span>
<a href="#l50.474"></a><span id="l50.474">         aTab.browser.stop();</span>
<a href="#l50.475"></a><span id="l50.475">         break;</span>
<a href="#l50.476"></a><span id="l50.476">       case &quot;cmd_reload&quot;:</span>
<a href="#l50.477"></a><span id="l50.477">         aTab.browser.reload();</span>
<a href="#l50.478"></a><span id="l50.478">         break;</span>
<a href="#l50.479"></a><span id="l50.479" class="difflineat">@@ -538,17 +518,17 @@ var specialTabs = {</span>
<a href="#l50.480"></a><span id="l50.480">    * failed icons due to Bug 740457. This also ensures 301 Moved or</span>
<a href="#l50.481"></a><span id="l50.481">    * redirected urls will work (they won't otherwise in getImageSrc).</span>
<a href="#l50.482"></a><span id="l50.482">    *</span>
<a href="#l50.483"></a><span id="l50.483">    * @param  function successFunc - caller's success function.</span>
<a href="#l50.484"></a><span id="l50.484">    * @param  function errorFunc   - caller's error function.</span>
<a href="#l50.485"></a><span id="l50.485">    * @param  string iconUrl       - url to load.</span>
<a href="#l50.486"></a><span id="l50.486">    * @return HTMLImageElement imageNode</span>
<a href="#l50.487"></a><span id="l50.487">    */</span>
<a href="#l50.488"></a><span id="l50.488" class="difflineminus">-  loadFaviconImageNode: function(successFunc, errorFunc, iconUrl) {</span>
<a href="#l50.489"></a><span id="l50.489" class="difflineplus">+  loadFaviconImageNode(successFunc, errorFunc, iconUrl) {</span>
<a href="#l50.490"></a><span id="l50.490">     let HTMLNS = &quot;http://www.w3.org/1999/xhtml&quot;;</span>
<a href="#l50.491"></a><span id="l50.491">     let imageNode = document.createElementNS(HTMLNS, &quot;img&quot;);</span>
<a href="#l50.492"></a><span id="l50.492">     imageNode.style.visibility = &quot;collapse&quot;;</span>
<a href="#l50.493"></a><span id="l50.493">     imageNode.addEventListener(&quot;load&quot;, event =&gt; successFunc(event, iconUrl),</span>
<a href="#l50.494"></a><span id="l50.494">                                {capture: false, once: true});</span>
<a href="#l50.495"></a><span id="l50.495">     imageNode.addEventListener(&quot;error&quot;, event =&gt; errorFunc(event, iconUrl),</span>
<a href="#l50.496"></a><span id="l50.496">                                {capture: false, once: true});</span>
<a href="#l50.497"></a><span id="l50.497">     imageNode.src = iconUrl;</span>
<a href="#l50.498"></a><span id="l50.498" class="difflineat">@@ -562,23 +542,22 @@ var specialTabs = {</span>
<a href="#l50.499"></a><span id="l50.499"> </span>
<a href="#l50.500"></a><span id="l50.500">   /**</span>
<a href="#l50.501"></a><span id="l50.501">    * Get the favicon by parsing for &lt;link rel=&quot;&quot;&gt; with &quot;icon&quot; from the page's</span>
<a href="#l50.502"></a><span id="l50.502">    * dom &lt;head&gt;.</span>
<a href="#l50.503"></a><span id="l50.503">    *</span>
<a href="#l50.504"></a><span id="l50.504">    * @param  string aUrl          - a url from whose homepage to get a favicon.</span>
<a href="#l50.505"></a><span id="l50.505">    * @param  function aCallback   - callback.</span>
<a href="#l50.506"></a><span id="l50.506">    */</span>
<a href="#l50.507"></a><span id="l50.507" class="difflineminus">-  getFaviconFromPage: function(aUrl, aCallback) {</span>
<a href="#l50.508"></a><span id="l50.508" class="difflineplus">+  getFaviconFromPage(aUrl, aCallback) {</span>
<a href="#l50.509"></a><span id="l50.509">     let url, uri;</span>
<a href="#l50.510"></a><span id="l50.510">     try {</span>
<a href="#l50.511"></a><span id="l50.511">       url = Services.io.newURI(aUrl).prePath;</span>
<a href="#l50.512"></a><span id="l50.512">       uri = Services.io.newURI(url);</span>
<a href="#l50.513"></a><span id="l50.513" class="difflineminus">-    }</span>
<a href="#l50.514"></a><span id="l50.514" class="difflineminus">-    catch (ex) {</span>
<a href="#l50.515"></a><span id="l50.515" class="difflineplus">+    } catch (ex) {</span>
<a href="#l50.516"></a><span id="l50.516">       if (aCallback)</span>
<a href="#l50.517"></a><span id="l50.517">         aCallback(&quot;&quot;);</span>
<a href="#l50.518"></a><span id="l50.518">       return;</span>
<a href="#l50.519"></a><span id="l50.519">     }</span>
<a href="#l50.520"></a><span id="l50.520"> </span>
<a href="#l50.521"></a><span id="l50.521">     let onLoadSuccess = (aEvent =&gt; {</span>
<a href="#l50.522"></a><span id="l50.522">       let iconUri = Services.io.newURI(aEvent.target.src);</span>
<a href="#l50.523"></a><span id="l50.523">       specialTabs.mFaviconService.setAndFetchFaviconForPage(</span>
<a href="#l50.524"></a><span id="l50.524" class="difflineat">@@ -605,18 +584,17 @@ var specialTabs = {</span>
<a href="#l50.525"></a><span id="l50.525">       }</span>
<a href="#l50.526"></a><span id="l50.526"> </span>
<a href="#l50.527"></a><span id="l50.527">       let iconUri;</span>
<a href="#l50.528"></a><span id="l50.528">       let linkNode = dom.head.querySelector('link[rel=&quot;shortcut icon&quot;],' +</span>
<a href="#l50.529"></a><span id="l50.529">                                             'link[rel=&quot;icon&quot;]');</span>
<a href="#l50.530"></a><span id="l50.530">       let href = linkNode ? linkNode.href : null;</span>
<a href="#l50.531"></a><span id="l50.531">       try {</span>
<a href="#l50.532"></a><span id="l50.532">         iconUri = Services.io.newURI(href);</span>
<a href="#l50.533"></a><span id="l50.533" class="difflineminus">-      }</span>
<a href="#l50.534"></a><span id="l50.534" class="difflineminus">-      catch (ex) {</span>
<a href="#l50.535"></a><span id="l50.535" class="difflineplus">+      } catch (ex) {</span>
<a href="#l50.536"></a><span id="l50.536">         onDownloadError(aEvent);</span>
<a href="#l50.537"></a><span id="l50.537">         return;</span>
<a href="#l50.538"></a><span id="l50.538">       }</span>
<a href="#l50.539"></a><span id="l50.539"> </span>
<a href="#l50.540"></a><span id="l50.540">       specialTabs.loadFaviconImageNode(onLoadSuccess, onDownloadError,</span>
<a href="#l50.541"></a><span id="l50.541">                                        iconUri.spec);</span>
<a href="#l50.542"></a><span id="l50.542">     });</span>
<a href="#l50.543"></a><span id="l50.543"> </span>
<a href="#l50.544"></a><span id="l50.544" class="difflineat">@@ -626,17 +604,17 @@ var specialTabs = {</span>
<a href="#l50.545"></a><span id="l50.545">     request.onload = onDownload;</span>
<a href="#l50.546"></a><span id="l50.546">     request.onerror = onDownloadError;</span>
<a href="#l50.547"></a><span id="l50.547">     request.timeout = this.REQUEST_TIMEOUT;</span>
<a href="#l50.548"></a><span id="l50.548">     request.ontimeout = onDownloadError;</span>
<a href="#l50.549"></a><span id="l50.549">     request.send(null);</span>
<a href="#l50.550"></a><span id="l50.550">   },</span>
<a href="#l50.551"></a><span id="l50.551"> </span>
<a href="#l50.552"></a><span id="l50.552">   // This will open any special tabs if necessary on startup.</span>
<a href="#l50.553"></a><span id="l50.553" class="difflineminus">-  openSpecialTabsOnStartup: function() {</span>
<a href="#l50.554"></a><span id="l50.554" class="difflineplus">+  openSpecialTabsOnStartup() {</span>
<a href="#l50.555"></a><span id="l50.555">     let browser = document.getElementById(&quot;dummycontentbrowser&quot;);</span>
<a href="#l50.556"></a><span id="l50.556"> </span>
<a href="#l50.557"></a><span id="l50.557">     // Manually hook up session and global history for the first browser</span>
<a href="#l50.558"></a><span id="l50.558">     // so that we don't have to load global history before bringing up a</span>
<a href="#l50.559"></a><span id="l50.559">     // window.</span>
<a href="#l50.560"></a><span id="l50.560">     // Wire up session and global history before any possible</span>
<a href="#l50.561"></a><span id="l50.561">     // progress notifications for back/forward button updating</span>
<a href="#l50.562"></a><span id="l50.562">     browser.docShell.initSessionHistory();</span>
<a href="#l50.563"></a><span id="l50.563" class="difflineat">@@ -644,21 +622,21 @@ var specialTabs = {</span>
<a href="#l50.564"></a><span id="l50.564"> </span>
<a href="#l50.565"></a><span id="l50.565">     // remove the disablehistory attribute so the browser cleans up, as</span>
<a href="#l50.566"></a><span id="l50.566">     // though it had done this work itself</span>
<a href="#l50.567"></a><span id="l50.567">     browser.removeAttribute(&quot;disablehistory&quot;);</span>
<a href="#l50.568"></a><span id="l50.568"> </span>
<a href="#l50.569"></a><span id="l50.569">     // enable global history</span>
<a href="#l50.570"></a><span id="l50.570">     try {</span>
<a href="#l50.571"></a><span id="l50.571">       browser.docShell.useGlobalHistory = true;</span>
<a href="#l50.572"></a><span id="l50.572" class="difflineminus">-    } catch(ex) {</span>
<a href="#l50.573"></a><span id="l50.573" class="difflineplus">+    } catch (ex) {</span>
<a href="#l50.574"></a><span id="l50.574">       Cu.reportError(&quot;Places database may be locked: &quot; + ex);</span>
<a href="#l50.575"></a><span id="l50.575">     }</span>
<a href="#l50.576"></a><span id="l50.576"> </span>
<a href="#l50.577"></a><span id="l50.577" class="difflineminus">-    let tabmail = document.getElementById('tabmail');</span>
<a href="#l50.578"></a><span id="l50.578" class="difflineplus">+    let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l50.579"></a><span id="l50.579"> </span>
<a href="#l50.580"></a><span id="l50.580">     tabmail.registerTabType(this.contentTabType);</span>
<a href="#l50.581"></a><span id="l50.581">     tabmail.registerTabType(this.chromeTabType);</span>
<a href="#l50.582"></a><span id="l50.582"> </span>
<a href="#l50.583"></a><span id="l50.583">     // If we've upgraded (note: always get these values so that we set</span>
<a href="#l50.584"></a><span id="l50.584">     // the mstone preference for the new version):</span>
<a href="#l50.585"></a><span id="l50.585">     let [fromVer, toVer] = this.getApplicationUpgradeVersions();</span>
<a href="#l50.586"></a><span id="l50.586"> </span>
<a href="#l50.587"></a><span id="l50.587" class="difflineat">@@ -696,37 +674,37 @@ var specialTabs = {</span>
<a href="#l50.588"></a><span id="l50.588">       delete this.loadingTabString;</span>
<a href="#l50.589"></a><span id="l50.589">       return this.loadingTabString = document.getElementById(&quot;bundle_messenger&quot;)</span>
<a href="#l50.590"></a><span id="l50.590">                                              .getString(&quot;loadingTab&quot;);</span>
<a href="#l50.591"></a><span id="l50.591">     },</span>
<a href="#l50.592"></a><span id="l50.592"> </span>
<a href="#l50.593"></a><span id="l50.593">     modes: {</span>
<a href="#l50.594"></a><span id="l50.594">       contentTab: {</span>
<a href="#l50.595"></a><span id="l50.595">         type: &quot;contentTab&quot;,</span>
<a href="#l50.596"></a><span id="l50.596" class="difflineminus">-        maxTabs: 10</span>
<a href="#l50.597"></a><span id="l50.597" class="difflineminus">-      }</span>
<a href="#l50.598"></a><span id="l50.598" class="difflineplus">+        maxTabs: 10,</span>
<a href="#l50.599"></a><span id="l50.599" class="difflineplus">+      },</span>
<a href="#l50.600"></a><span id="l50.600">     },</span>
<a href="#l50.601"></a><span id="l50.601"> </span>
<a href="#l50.602"></a><span id="l50.602">     /**</span>
<a href="#l50.603"></a><span id="l50.603">      * This is the internal function used by content tabs to open a new tab. To</span>
<a href="#l50.604"></a><span id="l50.604">      * open a contentTab, use specialTabs.openTab(&quot;contentTab&quot;, aArgs)</span>
<a href="#l50.605"></a><span id="l50.605">      *</span>
<a href="#l50.606"></a><span id="l50.606">      * @param aArgs The options that content tabs accept.</span>
<a href="#l50.607"></a><span id="l50.607">      * @param aArgs.contentPage A string that holds the URL that is to be opened</span>
<a href="#l50.608"></a><span id="l50.608">      * @param aArgs.clickHandler The click handler for that content tab. See the</span>
<a href="#l50.609"></a><span id="l50.609">      *  &quot;Content Tabs&quot; article on MDC.</span>
<a href="#l50.610"></a><span id="l50.610">      * @param aArgs.onLoad A function that takes an Event and a DOMNode. It is</span>
<a href="#l50.611"></a><span id="l50.611">      *  called when the content page is done loading. The first argument is the</span>
<a href="#l50.612"></a><span id="l50.612">      *  load event, and the second argument is the xul:browser that holds the</span>
<a href="#l50.613"></a><span id="l50.613">      *  contentPage. You can access the inner tab's window object by accessing</span>
<a href="#l50.614"></a><span id="l50.614">      *  the second parameter's contentWindow property.</span>
<a href="#l50.615"></a><span id="l50.615">      */</span>
<a href="#l50.616"></a><span id="l50.616" class="difflineminus">-    openTab: function contentTab_onTabOpened(aTab, aArgs) {</span>
<a href="#l50.617"></a><span id="l50.617" class="difflineminus">-      if (!&quot;contentPage&quot; in aArgs)</span>
<a href="#l50.618"></a><span id="l50.618" class="difflineminus">-        throw(&quot;contentPage must be specified&quot;);</span>
<a href="#l50.619"></a><span id="l50.619" class="difflineplus">+    openTab(aTab, aArgs) {</span>
<a href="#l50.620"></a><span id="l50.620" class="difflineplus">+      if (!(&quot;contentPage&quot; in aArgs))</span>
<a href="#l50.621"></a><span id="l50.621" class="difflineplus">+        throw new Error(&quot;contentPage must be specified&quot;);</span>
<a href="#l50.622"></a><span id="l50.622"> </span>
<a href="#l50.623"></a><span id="l50.623">       // First clone the page and set up the basics.</span>
<a href="#l50.624"></a><span id="l50.624">       let clone = document.getElementById(&quot;contentTab&quot;).firstChild.cloneNode(true);</span>
<a href="#l50.625"></a><span id="l50.625"> </span>
<a href="#l50.626"></a><span id="l50.626">       const findbar = document.createElement(&quot;findbar&quot;);</span>
<a href="#l50.627"></a><span id="l50.627">       // Adding browserid to findbar so that browser property can be set</span>
<a href="#l50.628"></a><span id="l50.628">       // in findbar custom element.</span>
<a href="#l50.629"></a><span id="l50.629">       findbar.setAttribute(&quot;browserid&quot;, &quot;dummycontentbrowser&quot;);</span>
<a href="#l50.630"></a><span id="l50.630" class="difflineat">@@ -784,17 +762,17 @@ var specialTabs = {</span>
<a href="#l50.631"></a><span id="l50.631">       aTab.reloadEnabled = false;</span>
<a href="#l50.632"></a><span id="l50.632"> </span>
<a href="#l50.633"></a><span id="l50.633">       // Now set up the listeners.</span>
<a href="#l50.634"></a><span id="l50.634">       this._setUpLoadListener(aTab);</span>
<a href="#l50.635"></a><span id="l50.635">       this._setUpTitleListener(aTab);</span>
<a href="#l50.636"></a><span id="l50.636">       this._setUpCloseWindowListener(aTab);</span>
<a href="#l50.637"></a><span id="l50.637"> </span>
<a href="#l50.638"></a><span id="l50.638">       if (&quot;onLoad&quot; in aArgs) {</span>
<a href="#l50.639"></a><span id="l50.639" class="difflineminus">-        aTab.browser.addEventListener(&quot;load&quot;, function _contentTab_onLoad (event) {</span>
<a href="#l50.640"></a><span id="l50.640" class="difflineplus">+        aTab.browser.addEventListener(&quot;load&quot;, function _contentTab_onLoad(event) {</span>
<a href="#l50.641"></a><span id="l50.641">           aArgs.onLoad(event, aTab.browser);</span>
<a href="#l50.642"></a><span id="l50.642">           aTab.browser.removeEventListener(&quot;load&quot;, _contentTab_onLoad, true);</span>
<a href="#l50.643"></a><span id="l50.643">         }, true);</span>
<a href="#l50.644"></a><span id="l50.644">       }</span>
<a href="#l50.645"></a><span id="l50.645"> </span>
<a href="#l50.646"></a><span id="l50.646">       // Create a filter and hook it up to our browser</span>
<a href="#l50.647"></a><span id="l50.647">       let filter = Cc[&quot;@mozilla.org/appshell/component/browser-status-filter;1&quot;]</span>
<a href="#l50.648"></a><span id="l50.648">                      .createInstance(Ci.nsIWebProgress);</span>
<a href="#l50.649"></a><span id="l50.649" class="difflineat">@@ -813,96 +791,92 @@ var specialTabs = {</span>
<a href="#l50.650"></a><span id="l50.650">       aTab.pageLoading = false;</span>
<a href="#l50.651"></a><span id="l50.651">       aTab.pageLoaded = false;</span>
<a href="#l50.652"></a><span id="l50.652"> </span>
<a href="#l50.653"></a><span id="l50.653">       // Now start loading the content.</span>
<a href="#l50.654"></a><span id="l50.654">       aTab.title = this.loadingTabString;</span>
<a href="#l50.655"></a><span id="l50.655"> </span>
<a href="#l50.656"></a><span id="l50.656">       let params = {</span>
<a href="#l50.657"></a><span id="l50.657">         triggeringPrincipal: Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l50.658"></a><span id="l50.658" class="difflineminus">-      }</span>
<a href="#l50.659"></a><span id="l50.659" class="difflineplus">+      };</span>
<a href="#l50.660"></a><span id="l50.660">       aTab.browser.loadURI(aArgs.contentPage, params);</span>
<a href="#l50.661"></a><span id="l50.661"> </span>
<a href="#l50.662"></a><span id="l50.662">       this.lastBrowserId++;</span>
<a href="#l50.663"></a><span id="l50.663">     },</span>
<a href="#l50.664"></a><span id="l50.664" class="difflineminus">-    tryCloseTab: function onTryCloseTab(aTab) {</span>
<a href="#l50.665"></a><span id="l50.665" class="difflineplus">+    tryCloseTab(aTab) {</span>
<a href="#l50.666"></a><span id="l50.666">       let docShell = aTab.browser.docShell;</span>
<a href="#l50.667"></a><span id="l50.667">       // If we have a docshell, a contentViewer, and it forbids us from closing</span>
<a href="#l50.668"></a><span id="l50.668">       // the tab, then we return false, which means, we can't close the tab. All</span>
<a href="#l50.669"></a><span id="l50.669">       // other cases return true.</span>
<a href="#l50.670"></a><span id="l50.670">       return !(docShell &amp;&amp; docShell.contentViewer</span>
<a href="#l50.671"></a><span id="l50.671">         &amp;&amp; !docShell.contentViewer.permitUnload());</span>
<a href="#l50.672"></a><span id="l50.672">     },</span>
<a href="#l50.673"></a><span id="l50.673" class="difflineminus">-    persistTab: function onPersistTab(aTab) {</span>
<a href="#l50.674"></a><span id="l50.674" class="difflineplus">+    persistTab(aTab) {</span>
<a href="#l50.675"></a><span id="l50.675">       if (aTab.browser.currentURI.spec == &quot;about:blank&quot;)</span>
<a href="#l50.676"></a><span id="l50.676">         return null;</span>
<a href="#l50.677"></a><span id="l50.677"> </span>
<a href="#l50.678"></a><span id="l50.678">       let onClick = aTab.clickHandler;</span>
<a href="#l50.679"></a><span id="l50.679"> </span>
<a href="#l50.680"></a><span id="l50.680">       return {</span>
<a href="#l50.681"></a><span id="l50.681">         tabURI: aTab.browser.currentURI.spec,</span>
<a href="#l50.682"></a><span id="l50.682" class="difflineminus">-        clickHandler: onClick ? onClick : null</span>
<a href="#l50.683"></a><span id="l50.683" class="difflineplus">+        clickHandler: onClick ? onClick : null,</span>
<a href="#l50.684"></a><span id="l50.684">       };</span>
<a href="#l50.685"></a><span id="l50.685">     },</span>
<a href="#l50.686"></a><span id="l50.686" class="difflineminus">-    restoreTab: function onRestoreTab(aTabmail, aPersistedState) {</span>
<a href="#l50.687"></a><span id="l50.687" class="difflineplus">+    restoreTab(aTabmail, aPersistedState) {</span>
<a href="#l50.688"></a><span id="l50.688">       aTabmail.openTab(&quot;contentTab&quot;, { contentPage: aPersistedState.tabURI,</span>
<a href="#l50.689"></a><span id="l50.689">                                        clickHandler: aPersistedState.clickHandler,</span>
<a href="#l50.690"></a><span id="l50.690">                                        duplicate: aPersistedState.duplicate,</span>
<a href="#l50.691"></a><span id="l50.691" class="difflineminus">-                                       background: true } );</span>
<a href="#l50.692"></a><span id="l50.692" class="difflineminus">-    }</span>
<a href="#l50.693"></a><span id="l50.693" class="difflineplus">+                                       background: true });</span>
<a href="#l50.694"></a><span id="l50.694" class="difflineplus">+    },</span>
<a href="#l50.695"></a><span id="l50.695">   },</span>
<a href="#l50.696"></a><span id="l50.696"> </span>
<a href="#l50.697"></a><span id="l50.697">   /**</span>
<a href="#l50.698"></a><span id="l50.698">    * Split a version number into a triple (major, minor, extension)</span>
<a href="#l50.699"></a><span id="l50.699">    * For example, 7.0.1 =&gt; [7, 0, 1]</span>
<a href="#l50.700"></a><span id="l50.700">    *             10.1a3 =&gt; [10, 1, a3]</span>
<a href="#l50.701"></a><span id="l50.701">    *             10.0 =&gt; [10, 0, &quot;&quot;]</span>
<a href="#l50.702"></a><span id="l50.702">    * This could be a static function, but no current reason for it to</span>
<a href="#l50.703"></a><span id="l50.703">    * be available outside this object's scope; as a method, it doesn't</span>
<a href="#l50.704"></a><span id="l50.704">    * pollute anyone else's namespace</span>
<a href="#l50.705"></a><span id="l50.705">    */</span>
<a href="#l50.706"></a><span id="l50.706" class="difflineminus">-  splitVersion: function(version) {</span>
<a href="#l50.707"></a><span id="l50.707" class="difflineplus">+  splitVersion(version) {</span>
<a href="#l50.708"></a><span id="l50.708">     let re = /^(\d+)\.(\d+)\.?(.*)$/;</span>
<a href="#l50.709"></a><span id="l50.709">     let fields = re.exec(version);</span>
<a href="#l50.710"></a><span id="l50.710">     if (fields === null)</span>
<a href="#l50.711"></a><span id="l50.711">       return null;</span>
<a href="#l50.712"></a><span id="l50.712">     /* First element of the array from regex match is the entire string; drop that */</span>
<a href="#l50.713"></a><span id="l50.713">     fields.shift();</span>
<a href="#l50.714"></a><span id="l50.714">     return fields;</span>
<a href="#l50.715"></a><span id="l50.715">   },</span>
<a href="#l50.716"></a><span id="l50.716"> </span>
<a href="#l50.717"></a><span id="l50.717">   /**</span>
<a href="#l50.718"></a><span id="l50.718">    * In the case of an upgrade, returns the version we're upgrading</span>
<a href="#l50.719"></a><span id="l50.719">    * from, as well as the current version.  In the case of a fresh profile,</span>
<a href="#l50.720"></a><span id="l50.720">    * or the pref being set to ignore - return null and the current version.</span>
<a href="#l50.721"></a><span id="l50.721">    * In either case, updates the pref with the latest version.</span>
<a href="#l50.722"></a><span id="l50.722">    */</span>
<a href="#l50.723"></a><span id="l50.723" class="difflineminus">-  getApplicationUpgradeVersions: function() {</span>
<a href="#l50.724"></a><span id="l50.724" class="difflineminus">-    let savedAppVersion = null;</span>
<a href="#l50.725"></a><span id="l50.725" class="difflineplus">+  getApplicationUpgradeVersions() {</span>
<a href="#l50.726"></a><span id="l50.726">     let prefstring = &quot;mailnews.start_page_override.mstone&quot;;</span>
<a href="#l50.727"></a><span id="l50.727" class="difflineminus">-</span>
<a href="#l50.728"></a><span id="l50.728" class="difflineminus">-    try {</span>
<a href="#l50.729"></a><span id="l50.729" class="difflineminus">-      savedAppVersion = Services.prefs.getCharPref(prefstring);</span>
<a href="#l50.730"></a><span id="l50.730" class="difflineminus">-    } catch (ex) {}</span>
<a href="#l50.731"></a><span id="l50.731" class="difflineplus">+    let savedAppVersion = Services.prefs.getCharPref(prefstring, &quot;&quot;);</span>
<a href="#l50.732"></a><span id="l50.732"> </span>
<a href="#l50.733"></a><span id="l50.733">     let currentApplicationVersion = Services.appinfo.version;</span>
<a href="#l50.734"></a><span id="l50.734"> </span>
<a href="#l50.735"></a><span id="l50.735">     if (savedAppVersion == &quot;ignore&quot;)</span>
<a href="#l50.736"></a><span id="l50.736">       return [null, this.splitVersion(currentApplicationVersion)];</span>
<a href="#l50.737"></a><span id="l50.737"> </span>
<a href="#l50.738"></a><span id="l50.738">     if (savedAppVersion != currentApplicationVersion)</span>
<a href="#l50.739"></a><span id="l50.739">       Services.prefs.setCharPref(prefstring, currentApplicationVersion);</span>
<a href="#l50.740"></a><span id="l50.740"> </span>
<a href="#l50.741"></a><span id="l50.741">     return [this.splitVersion(savedAppVersion), this.splitVersion(currentApplicationVersion)];</span>
<a href="#l50.742"></a><span id="l50.742">   },</span>
<a href="#l50.743"></a><span id="l50.743"> </span>
<a href="#l50.744"></a><span id="l50.744">   /**</span>
<a href="#l50.745"></a><span id="l50.745">    * Shows the what's new page in a content tab.</span>
<a href="#l50.746"></a><span id="l50.746">    */</span>
<a href="#l50.747"></a><span id="l50.747" class="difflineminus">-  showWhatsNewPage: function onShowWhatsNewPage() {</span>
<a href="#l50.748"></a><span id="l50.748" class="difflineplus">+  showWhatsNewPage() {</span>
<a href="#l50.749"></a><span id="l50.749">     let um = Cc[&quot;@mozilla.org/updates/update-manager;1&quot;]</span>
<a href="#l50.750"></a><span id="l50.750">                .getService(Ci.nsIUpdateManager);</span>
<a href="#l50.751"></a><span id="l50.751"> </span>
<a href="#l50.752"></a><span id="l50.752">     try {</span>
<a href="#l50.753"></a><span id="l50.753">       // If the updates.xml file is deleted then getUpdateAt will throw.</span>
<a href="#l50.754"></a><span id="l50.754">       var update = um.getUpdateAt(0)</span>
<a href="#l50.755"></a><span id="l50.755">                      .QueryInterface(Ci.nsIPropertyBag);</span>
<a href="#l50.756"></a><span id="l50.756">     } catch (x) {</span>
<a href="#l50.757"></a><span id="l50.757" class="difflineat">@@ -918,41 +892,35 @@ var specialTabs = {</span>
<a href="#l50.758"></a><span id="l50.758">   },</span>
<a href="#l50.759"></a><span id="l50.759"> </span>
<a href="#l50.760"></a><span id="l50.760">   /**</span>
<a href="#l50.761"></a><span id="l50.761">    * Looks at the existing prefs and determines if we should suggest the user</span>
<a href="#l50.762"></a><span id="l50.762">    * enables telemetry or not.</span>
<a href="#l50.763"></a><span id="l50.763">    *</span>
<a href="#l50.764"></a><span id="l50.764">    * This is controlled by the pref toolkit.telemetry.prompted</span>
<a href="#l50.765"></a><span id="l50.765">    */</span>
<a href="#l50.766"></a><span id="l50.766" class="difflineminus">-  shouldShowTelemetryNotification: function() {</span>
<a href="#l50.767"></a><span id="l50.767" class="difflineplus">+  shouldShowTelemetryNotification() {</span>
<a href="#l50.768"></a><span id="l50.768">     // Toolkit has decided that the pref should have no default value, so this</span>
<a href="#l50.769"></a><span id="l50.769">     // throws if not yet initialized.</span>
<a href="#l50.770"></a><span id="l50.770" class="difflineminus">-    let telemetryPrompted = false;</span>
<a href="#l50.771"></a><span id="l50.771" class="difflineminus">-    try {</span>
<a href="#l50.772"></a><span id="l50.772" class="difflineminus">-      telemetryPrompted = (Services.prefs.getIntPref(kTelemetryPrompted) &gt;= kTelemetryPromptRev);</span>
<a href="#l50.773"></a><span id="l50.773" class="difflineminus">-    } catch (e) { }</span>
<a href="#l50.774"></a><span id="l50.774" class="difflineminus">-    let telemetryEnabled = false;</span>
<a href="#l50.775"></a><span id="l50.775" class="difflineminus">-    try {</span>
<a href="#l50.776"></a><span id="l50.776" class="difflineminus">-      telemetryEnabled = (Services.prefs.getBoolPref(kTelemetryEnabled));</span>
<a href="#l50.777"></a><span id="l50.777" class="difflineminus">-    } catch (e) { }</span>
<a href="#l50.778"></a><span id="l50.778" class="difflineplus">+    let telemetryPrompted = Services.prefs.getIntPref(kTelemetryPrompted, 0) &gt;= kTelemetryPromptRev;</span>
<a href="#l50.779"></a><span id="l50.779" class="difflineplus">+    let telemetryEnabled = Services.prefs.getBoolPref(kTelemetryEnabled, false);</span>
<a href="#l50.780"></a><span id="l50.780">     // In case user already allowed telemetry, do not bother him with any updated</span>
<a href="#l50.781"></a><span id="l50.781">     // prompt. Clear the pref first, in case it was not Int (from older versions).</span>
<a href="#l50.782"></a><span id="l50.782">     if (telemetryEnabled &amp;&amp; !telemetryPrompted) {</span>
<a href="#l50.783"></a><span id="l50.783">       Services.prefs.clearUserPref(kTelemetryPrompted);</span>
<a href="#l50.784"></a><span id="l50.784">       Services.prefs.setIntPref(kTelemetryPrompted, kTelemetryPromptRev);</span>
<a href="#l50.785"></a><span id="l50.785">     }</span>
<a href="#l50.786"></a><span id="l50.786"> </span>
<a href="#l50.787"></a><span id="l50.787">     if (telemetryEnabled || telemetryPrompted)</span>
<a href="#l50.788"></a><span id="l50.788">       return false;</span>
<a href="#l50.789"></a><span id="l50.789"> </span>
<a href="#l50.790"></a><span id="l50.790">     return true;</span>
<a href="#l50.791"></a><span id="l50.791">   },</span>
<a href="#l50.792"></a><span id="l50.792"> </span>
<a href="#l50.793"></a><span id="l50.793" class="difflineminus">-  showTelemetryNotification: function() {</span>
<a href="#l50.794"></a><span id="l50.794" class="difflineplus">+  showTelemetryNotification() {</span>
<a href="#l50.795"></a><span id="l50.795">     var notifyBox = document.getElementById(&quot;mail-notification-box&quot;);</span>
<a href="#l50.796"></a><span id="l50.796"> </span>
<a href="#l50.797"></a><span id="l50.797">     var brandBundle =</span>
<a href="#l50.798"></a><span id="l50.798">       new StringBundle(&quot;chrome://branding/locale/brand.properties&quot;);</span>
<a href="#l50.799"></a><span id="l50.799">     var telemetryBundle =</span>
<a href="#l50.800"></a><span id="l50.800">       new StringBundle(&quot;chrome://messenger/locale/telemetry.properties&quot;);</span>
<a href="#l50.801"></a><span id="l50.801"> </span>
<a href="#l50.802"></a><span id="l50.802">     var productName = brandBundle.get(&quot;brandFullName&quot;);</span>
<a href="#l50.803"></a><span id="l50.803" class="difflineat">@@ -964,42 +932,42 @@ var specialTabs = {</span>
<a href="#l50.804"></a><span id="l50.804">     Services.prefs.clearUserPref(kTelemetryEnabled);</span>
<a href="#l50.805"></a><span id="l50.805">     Services.prefs.clearUserPref(kTelemetryRejected);</span>
<a href="#l50.806"></a><span id="l50.806"> </span>
<a href="#l50.807"></a><span id="l50.807">     var buttons = [</span>
<a href="#l50.808"></a><span id="l50.808">       {</span>
<a href="#l50.809"></a><span id="l50.809">         label:     telemetryBundle.get(&quot;telemetryYesButtonLabel&quot;),</span>
<a href="#l50.810"></a><span id="l50.810">         accessKey: telemetryBundle.get(&quot;telemetryYesButtonAccessKey&quot;),</span>
<a href="#l50.811"></a><span id="l50.811">         popup:     null,</span>
<a href="#l50.812"></a><span id="l50.812" class="difflineminus">-        callback:  function(aNotificationBar, aButton) {</span>
<a href="#l50.813"></a><span id="l50.813" class="difflineplus">+        callback(aNotificationBar, aButton) {</span>
<a href="#l50.814"></a><span id="l50.814">           Services.prefs.setBoolPref(kTelemetryEnabled, true);</span>
<a href="#l50.815"></a><span id="l50.815" class="difflineminus">-        }</span>
<a href="#l50.816"></a><span id="l50.816" class="difflineplus">+        },</span>
<a href="#l50.817"></a><span id="l50.817">       },</span>
<a href="#l50.818"></a><span id="l50.818">       {</span>
<a href="#l50.819"></a><span id="l50.819">         label:     telemetryBundle.get(&quot;telemetryNoButtonLabel&quot;),</span>
<a href="#l50.820"></a><span id="l50.820">         accessKey: telemetryBundle.get(&quot;telemetryNoButtonAccessKey&quot;),</span>
<a href="#l50.821"></a><span id="l50.821">         popup:     null,</span>
<a href="#l50.822"></a><span id="l50.822" class="difflineminus">-        callback:  function(aNotificationBar, aButton) {</span>
<a href="#l50.823"></a><span id="l50.823" class="difflineplus">+        callback(aNotificationBar, aButton) {</span>
<a href="#l50.824"></a><span id="l50.824">           Services.prefs.setBoolPref(kTelemetryRejected, true);</span>
<a href="#l50.825"></a><span id="l50.825" class="difflineminus">-        }</span>
<a href="#l50.826"></a><span id="l50.826" class="difflineminus">-      }</span>
<a href="#l50.827"></a><span id="l50.827" class="difflineplus">+        },</span>
<a href="#l50.828"></a><span id="l50.828" class="difflineplus">+      },</span>
<a href="#l50.829"></a><span id="l50.829">     ];</span>
<a href="#l50.830"></a><span id="l50.830"> </span>
<a href="#l50.831"></a><span id="l50.831">     // Set pref to indicate we've shown the notification.</span>
<a href="#l50.832"></a><span id="l50.832">     Services.prefs.setIntPref(kTelemetryPrompted, kTelemetryPromptRev);</span>
<a href="#l50.833"></a><span id="l50.833"> </span>
<a href="#l50.834"></a><span id="l50.834">     var notification = notifyBox.appendNotification(telemetryText, &quot;telemetry&quot;, null, notifyBox.PRIORITY_INFO_LOW, buttons);</span>
<a href="#l50.835"></a><span id="l50.835">     notification.persistence = 3; // arbitrary number, just so bar sticks around for a bit</span>
<a href="#l50.836"></a><span id="l50.836"> </span>
<a href="#l50.837"></a><span id="l50.837">     let XULNS = &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;;</span>
<a href="#l50.838"></a><span id="l50.838">     let link = notification.ownerDocument.createElementNS(XULNS, &quot;label&quot;);</span>
<a href="#l50.839"></a><span id="l50.839">     link.className = &quot;text-link telemetry-text-link&quot;;</span>
<a href="#l50.840"></a><span id="l50.840">     link.setAttribute(&quot;value&quot;, telemetryBundle.get(&quot;telemetryLinkLabel&quot;));</span>
<a href="#l50.841"></a><span id="l50.841" class="difflineminus">-    link.addEventListener('click', function() {</span>
<a href="#l50.842"></a><span id="l50.842" class="difflineminus">-      openPrivacyPolicy('tab');</span>
<a href="#l50.843"></a><span id="l50.843" class="difflineplus">+    link.addEventListener(&quot;click&quot;, function() {</span>
<a href="#l50.844"></a><span id="l50.844" class="difflineplus">+      openPrivacyPolicy(&quot;tab&quot;);</span>
<a href="#l50.845"></a><span id="l50.845">       // Remove the notification on which the user clicked</span>
<a href="#l50.846"></a><span id="l50.846">       notification.parentNode.removeNotification(notification, true);</span>
<a href="#l50.847"></a><span id="l50.847">       // Add a new notification to that tab, with no &quot;Learn more&quot; link</span>
<a href="#l50.848"></a><span id="l50.848">       notifyBox.appendNotification(telemetryText, &quot;telemetry&quot;, null, notifyBox.PRIORITY_INFO_LOW, buttons);</span>
<a href="#l50.849"></a><span id="l50.849">     });</span>
<a href="#l50.850"></a><span id="l50.850"> </span>
<a href="#l50.851"></a><span id="l50.851">     let description = notification.ownerDocument.getAnonymousElementByAttribute(notification, &quot;anonid&quot;, &quot;messageText&quot;);</span>
<a href="#l50.852"></a><span id="l50.852">     description.appendChild(link);</span>
<a href="#l50.853"></a><span id="l50.853" class="difflineat">@@ -1016,48 +984,48 @@ var specialTabs = {</span>
<a href="#l50.854"></a><span id="l50.854">    *     If this pref is set to true, never show the about:rights notification.</span>
<a href="#l50.855"></a><span id="l50.855">    *     If the pref doesn't exist, then we fallback to checking</span>
<a href="#l50.856"></a><span id="l50.856">    *     mail.rights.version.</span>
<a href="#l50.857"></a><span id="l50.857">    *</span>
<a href="#l50.858"></a><span id="l50.858">    *   mail.rights.version</span>
<a href="#l50.859"></a><span id="l50.859">    *     If this pref isn't set or the value is less than the current version</span>
<a href="#l50.860"></a><span id="l50.860">    *     then we show the about:rights notification.</span>
<a href="#l50.861"></a><span id="l50.861">    */</span>
<a href="#l50.862"></a><span id="l50.862" class="difflineminus">-  shouldShowAboutRightsNotification: function() {</span>
<a href="#l50.863"></a><span id="l50.863" class="difflineplus">+  shouldShowAboutRightsNotification() {</span>
<a href="#l50.864"></a><span id="l50.864">     try {</span>
<a href="#l50.865"></a><span id="l50.865">       return !Services.prefs.getBoolPref(&quot;mail.rights.override&quot;);</span>
<a href="#l50.866"></a><span id="l50.866" class="difflineminus">-    } catch (e) { }</span>
<a href="#l50.867"></a><span id="l50.867" class="difflineplus">+    } catch (e) {}</span>
<a href="#l50.868"></a><span id="l50.868"> </span>
<a href="#l50.869"></a><span id="l50.869">     return Services.prefs.getIntPref(&quot;mail.rights.version&quot;) &lt; this._kAboutRightsVersion;</span>
<a href="#l50.870"></a><span id="l50.870">   },</span>
<a href="#l50.871"></a><span id="l50.871"> </span>
<a href="#l50.872"></a><span id="l50.872" class="difflineminus">-  showAboutRightsNotification: function() {</span>
<a href="#l50.873"></a><span id="l50.873" class="difflineplus">+  showAboutRightsNotification() {</span>
<a href="#l50.874"></a><span id="l50.874">     var notifyBox = document.getElementById(&quot;mail-notification-box&quot;);</span>
<a href="#l50.875"></a><span id="l50.875"> </span>
<a href="#l50.876"></a><span id="l50.876">     var brandBundle =</span>
<a href="#l50.877"></a><span id="l50.877">       Services.strings.createBundle(&quot;chrome://branding/locale/brand.properties&quot;);</span>
<a href="#l50.878"></a><span id="l50.878">     var rightsBundle =</span>
<a href="#l50.879"></a><span id="l50.879">       Services.strings.createBundle(&quot;chrome://messenger/locale/aboutRights.properties&quot;);</span>
<a href="#l50.880"></a><span id="l50.880"> </span>
<a href="#l50.881"></a><span id="l50.881">     var productName = brandBundle.GetStringFromName(&quot;brandFullName&quot;);</span>
<a href="#l50.882"></a><span id="l50.882">     var notifyRightsText = rightsBundle.formatStringFromName(&quot;notifyRightsText&quot;,</span>
<a href="#l50.883"></a><span id="l50.883">                                                              [productName], 1);</span>
<a href="#l50.884"></a><span id="l50.884"> </span>
<a href="#l50.885"></a><span id="l50.885">     var buttons = [</span>
<a href="#l50.886"></a><span id="l50.886">       {</span>
<a href="#l50.887"></a><span id="l50.887">         label: rightsBundle.GetStringFromName(&quot;buttonLabel&quot;),</span>
<a href="#l50.888"></a><span id="l50.888">         accessKey: rightsBundle.GetStringFromName(&quot;buttonAccessKey&quot;),</span>
<a href="#l50.889"></a><span id="l50.889">         popup: null,</span>
<a href="#l50.890"></a><span id="l50.890" class="difflineminus">-        callback: function(aNotificationBar, aButton) {</span>
<a href="#l50.891"></a><span id="l50.891" class="difflineplus">+        callback(aNotificationBar, aButton) {</span>
<a href="#l50.892"></a><span id="l50.892">           // Show the about:rights tab</span>
<a href="#l50.893"></a><span id="l50.893" class="difflineminus">-          document.getElementById('tabmail')</span>
<a href="#l50.894"></a><span id="l50.894" class="difflineplus">+          document.getElementById(&quot;tabmail&quot;)</span>
<a href="#l50.895"></a><span id="l50.895">                   .openTab(&quot;contentTab&quot;, { contentPage: &quot;about:rights&quot;,</span>
<a href="#l50.896"></a><span id="l50.896">                                            clickHandler: &quot;specialTabs.aboutClickHandler(event);&quot; });</span>
<a href="#l50.897"></a><span id="l50.897" class="difflineminus">-        }</span>
<a href="#l50.898"></a><span id="l50.898" class="difflineminus">-      }</span>
<a href="#l50.899"></a><span id="l50.899" class="difflineplus">+        },</span>
<a href="#l50.900"></a><span id="l50.900" class="difflineplus">+      },</span>
<a href="#l50.901"></a><span id="l50.901">     ];</span>
<a href="#l50.902"></a><span id="l50.902"> </span>
<a href="#l50.903"></a><span id="l50.903">     var box = notifyBox.appendNotification(notifyRightsText, &quot;about-rights&quot;,</span>
<a href="#l50.904"></a><span id="l50.904">                                            null, notifyBox.PRIORITY_INFO_LOW,</span>
<a href="#l50.905"></a><span id="l50.905">                                            buttons);</span>
<a href="#l50.906"></a><span id="l50.906">     // arbitrary number, just so bar sticks around for a bit</span>
<a href="#l50.907"></a><span id="l50.907">     box.persistence = 3;</span>
<a href="#l50.908"></a><span id="l50.908"> </span>
<a href="#l50.909"></a><span id="l50.909" class="difflineat">@@ -1065,17 +1033,17 @@ var specialTabs = {</span>
<a href="#l50.910"></a><span id="l50.910">     Services.prefs.setIntPref(&quot;mail.rights.version&quot;, this._kAboutRightsVersion);</span>
<a href="#l50.911"></a><span id="l50.911">   },</span>
<a href="#l50.912"></a><span id="l50.912"> </span>
<a href="#l50.913"></a><span id="l50.913">   /**</span>
<a href="#l50.914"></a><span id="l50.914">    * Handles links when displaying about: pages. Anything that is an about:</span>
<a href="#l50.915"></a><span id="l50.915">    * link can be loaded internally, other links are redirected to an external</span>
<a href="#l50.916"></a><span id="l50.916">    * browser.</span>
<a href="#l50.917"></a><span id="l50.917">    */</span>
<a href="#l50.918"></a><span id="l50.918" class="difflineminus">-  aboutClickHandler: function aboutClickHandler(aEvent) {</span>
<a href="#l50.919"></a><span id="l50.919" class="difflineplus">+  aboutClickHandler(aEvent) {</span>
<a href="#l50.920"></a><span id="l50.920">     // Don't handle events that: a) aren't trusted, b) have already been</span>
<a href="#l50.921"></a><span id="l50.921">     // handled or c) aren't left-click.</span>
<a href="#l50.922"></a><span id="l50.922">     if (!aEvent.isTrusted || aEvent.defaultPrevented || aEvent.button)</span>
<a href="#l50.923"></a><span id="l50.923">       return true;</span>
<a href="#l50.924"></a><span id="l50.924"> </span>
<a href="#l50.925"></a><span id="l50.925">     let href = hRefForClickEvent(aEvent, true);</span>
<a href="#l50.926"></a><span id="l50.926">     if (href) {</span>
<a href="#l50.927"></a><span id="l50.927">       let uri = makeURI(href);</span>
<a href="#l50.928"></a><span id="l50.928" class="difflineat">@@ -1088,17 +1056,17 @@ var specialTabs = {</span>
<a href="#l50.929"></a><span id="l50.929">     return false;</span>
<a href="#l50.930"></a><span id="l50.930">   },</span>
<a href="#l50.931"></a><span id="l50.931"> </span>
<a href="#l50.932"></a><span id="l50.932">   /**</span>
<a href="#l50.933"></a><span id="l50.933">    * The default click handler for content tabs. Any clicks on links will get</span>
<a href="#l50.934"></a><span id="l50.934">    * redirected to an external browser - effectively keeping the user on one</span>
<a href="#l50.935"></a><span id="l50.935">    * page.</span>
<a href="#l50.936"></a><span id="l50.936">    */</span>
<a href="#l50.937"></a><span id="l50.937" class="difflineminus">-  defaultClickHandler: function defaultClickHandler(aEvent) {</span>
<a href="#l50.938"></a><span id="l50.938" class="difflineplus">+  defaultClickHandler(aEvent) {</span>
<a href="#l50.939"></a><span id="l50.939">     // Don't handle events that: a) aren't trusted, b) have already been</span>
<a href="#l50.940"></a><span id="l50.940">     // handled or c) aren't left-click.</span>
<a href="#l50.941"></a><span id="l50.941">     if (!aEvent.isTrusted || aEvent.defaultPrevented || aEvent.button)</span>
<a href="#l50.942"></a><span id="l50.942">       return true;</span>
<a href="#l50.943"></a><span id="l50.943"> </span>
<a href="#l50.944"></a><span id="l50.944">     let href = hRefForClickEvent(aEvent, true);</span>
<a href="#l50.945"></a><span id="l50.945"> </span>
<a href="#l50.946"></a><span id="l50.946">     // We've explicitly allowed http, https and about as additional exposed</span>
<a href="#l50.947"></a><span id="l50.947" class="difflineat">@@ -1126,17 +1094,17 @@ var specialTabs = {</span>
<a href="#l50.948"></a><span id="l50.948">    * sites change or use javascript, this function may not be able to ensure the</span>
<a href="#l50.949"></a><span id="l50.949">    * contentTab stays &quot;within&quot; a site. Extensions using this function should</span>
<a href="#l50.950"></a><span id="l50.950">    * consider this when implementing the extension.</span>
<a href="#l50.951"></a><span id="l50.951">    *</span>
<a href="#l50.952"></a><span id="l50.952">    * @param aEvent      The onclick event that is being handled.</span>
<a href="#l50.953"></a><span id="l50.953">    * @param aSiteRegexp A regexp to match against to determine if the link</span>
<a href="#l50.954"></a><span id="l50.954">    *                    clicked on should be loaded within the browser or not.</span>
<a href="#l50.955"></a><span id="l50.955">    */</span>
<a href="#l50.956"></a><span id="l50.956" class="difflineminus">-  siteClickHandler: function siteClickHandler(aEvent, aSiteRegexp) {</span>
<a href="#l50.957"></a><span id="l50.957" class="difflineplus">+  siteClickHandler(aEvent, aSiteRegexp) {</span>
<a href="#l50.958"></a><span id="l50.958">     // Don't handle events that: a) aren't trusted, b) have already been</span>
<a href="#l50.959"></a><span id="l50.959">     // handled or c) aren't left-click.</span>
<a href="#l50.960"></a><span id="l50.960">     if (!aEvent.isTrusted || aEvent.defaultPrevented || aEvent.button)</span>
<a href="#l50.961"></a><span id="l50.961">       return true;</span>
<a href="#l50.962"></a><span id="l50.962"> </span>
<a href="#l50.963"></a><span id="l50.963">     let href = hRefForClickEvent(aEvent, true);</span>
<a href="#l50.964"></a><span id="l50.964"> </span>
<a href="#l50.965"></a><span id="l50.965">     // We've explicitly allowed http, https and about as additional exposed</span>
<a href="#l50.966"></a><span id="l50.966" class="difflineat">@@ -1162,18 +1130,18 @@ var specialTabs = {</span>
<a href="#l50.967"></a><span id="l50.967">       delete this.loadingTabString;</span>
<a href="#l50.968"></a><span id="l50.968">       return this.loadingTabString = document.getElementById(&quot;bundle_messenger&quot;)</span>
<a href="#l50.969"></a><span id="l50.969">                                              .getString(&quot;loadingTab&quot;);</span>
<a href="#l50.970"></a><span id="l50.970">     },</span>
<a href="#l50.971"></a><span id="l50.971"> </span>
<a href="#l50.972"></a><span id="l50.972">     modes: {</span>
<a href="#l50.973"></a><span id="l50.973">       chromeTab: {</span>
<a href="#l50.974"></a><span id="l50.974">         type: &quot;chromeTab&quot;,</span>
<a href="#l50.975"></a><span id="l50.975" class="difflineminus">-        maxTabs: 10</span>
<a href="#l50.976"></a><span id="l50.976" class="difflineminus">-      }</span>
<a href="#l50.977"></a><span id="l50.977" class="difflineplus">+        maxTabs: 10,</span>
<a href="#l50.978"></a><span id="l50.978" class="difflineplus">+      },</span>
<a href="#l50.979"></a><span id="l50.979">     },</span>
<a href="#l50.980"></a><span id="l50.980"> </span>
<a href="#l50.981"></a><span id="l50.981">     shouldSwitchTo: ({ chromePage: x }) =&gt;</span>
<a href="#l50.982"></a><span id="l50.982">       contentTabBaseType.shouldSwitchTo({ contentPage: x }),</span>
<a href="#l50.983"></a><span id="l50.983"> </span>
<a href="#l50.984"></a><span id="l50.984">     /**</span>
<a href="#l50.985"></a><span id="l50.985">      * This is the internal function used by chrome tabs to open a new tab. To</span>
<a href="#l50.986"></a><span id="l50.986">      * open a chromeTab, use specialTabs.openTab(&quot;chromeTab&quot;, aArgs)</span>
<a href="#l50.987"></a><span id="l50.987" class="difflineat">@@ -1183,19 +1151,19 @@ var specialTabs = {</span>
<a href="#l50.988"></a><span id="l50.988">      * @param aArgs.clickHandler The click handler for that chrome tab. See the</span>
<a href="#l50.989"></a><span id="l50.989">      *  &quot;Content Tabs&quot; article on MDC.</span>
<a href="#l50.990"></a><span id="l50.990">      * @param aArgs.onLoad A function that takes an Event and a DOMNode. It is</span>
<a href="#l50.991"></a><span id="l50.991">      *  called when the chrome page is done loading. The first argument is the</span>
<a href="#l50.992"></a><span id="l50.992">      *  load event, and the second argument is the xul:browser that holds the</span>
<a href="#l50.993"></a><span id="l50.993">      *  chromePage. You can access the inner tab's window object by accessing</span>
<a href="#l50.994"></a><span id="l50.994">      *  the second parameter's chromeWindow property.</span>
<a href="#l50.995"></a><span id="l50.995">      */</span>
<a href="#l50.996"></a><span id="l50.996" class="difflineminus">-    openTab: function chromeTab_onTabOpened(aTab, aArgs) {</span>
<a href="#l50.997"></a><span id="l50.997" class="difflineminus">-      if (!&quot;chromePage&quot; in aArgs)</span>
<a href="#l50.998"></a><span id="l50.998" class="difflineminus">-        throw(&quot;chromePage must be specified&quot;);</span>
<a href="#l50.999"></a><span id="l50.999" class="difflineplus">+    openTab(aTab, aArgs) {</span>
<a href="#l50.1000"></a><span id="l50.1000" class="difflineplus">+      if (!(&quot;chromePage&quot; in aArgs))</span>
<a href="#l50.1001"></a><span id="l50.1001" class="difflineplus">+        throw new Error(&quot;chromePage must be specified&quot;);</span>
<a href="#l50.1002"></a><span id="l50.1002"> </span>
<a href="#l50.1003"></a><span id="l50.1003">       // First clone the page and set up the basics.</span>
<a href="#l50.1004"></a><span id="l50.1004">       let clone = document.getElementById(&quot;chromeTab&quot;).firstChild.cloneNode(true);</span>
<a href="#l50.1005"></a><span id="l50.1005"> </span>
<a href="#l50.1006"></a><span id="l50.1006">       clone.setAttribute(&quot;id&quot;, &quot;chromeTab&quot; + this.lastBrowserId);</span>
<a href="#l50.1007"></a><span id="l50.1007">       clone.setAttribute(&quot;collapsed&quot;, false);</span>
<a href="#l50.1008"></a><span id="l50.1008"> </span>
<a href="#l50.1009"></a><span id="l50.1009">       let toolbox = clone.firstChild;</span>
<a href="#l50.1010"></a><span id="l50.1010" class="difflineat">@@ -1203,23 +1171,16 @@ var specialTabs = {</span>
<a href="#l50.1011"></a><span id="l50.1011">       toolbox.firstChild.setAttribute(&quot;id&quot;, &quot;chromeTabToolbar&quot; + this.lastBrowserId);</span>
<a href="#l50.1012"></a><span id="l50.1012"> </span>
<a href="#l50.1013"></a><span id="l50.1013">       aTab.panel.setAttribute(&quot;id&quot;, &quot;chromeTabWrapper&quot; + this.lastBrowserId);</span>
<a href="#l50.1014"></a><span id="l50.1014">       aTab.panel.appendChild(clone);</span>
<a href="#l50.1015"></a><span id="l50.1015"> </span>
<a href="#l50.1016"></a><span id="l50.1016">       // Start setting up the browser.</span>
<a href="#l50.1017"></a><span id="l50.1017">       aTab.browser = aTab.panel.querySelector(&quot;browser&quot;);</span>
<a href="#l50.1018"></a><span id="l50.1018"> </span>
<a href="#l50.1019"></a><span id="l50.1019" class="difflineminus">-      // As we're opening this tab, showTab may not get called, so set</span>
<a href="#l50.1020"></a><span id="l50.1020" class="difflineminus">-      // the type according to if we're opening in background or not.</span>
<a href="#l50.1021"></a><span id="l50.1021" class="difflineminus">-      let background = (&quot;background&quot; in aArgs) &amp;&amp; aArgs.background;</span>
<a href="#l50.1022"></a><span id="l50.1022" class="difflineminus">-      // XXX not setting type as it's chrome</span>
<a href="#l50.1023"></a><span id="l50.1023" class="difflineminus">-      //aTab.browser.setAttribute(&quot;type&quot;, background ? &quot;content-targetable&quot; :</span>
<a href="#l50.1024"></a><span id="l50.1024" class="difflineminus">-      //                                               &quot;content-primary&quot;);</span>
<a href="#l50.1025"></a><span id="l50.1025" class="difflineminus">-</span>
<a href="#l50.1026"></a><span id="l50.1026">       aTab.browser.setAttribute(&quot;onclick&quot;,</span>
<a href="#l50.1027"></a><span id="l50.1027">                                 &quot;clickHandler&quot; in aArgs &amp;&amp; aArgs.clickHandler ?</span>
<a href="#l50.1028"></a><span id="l50.1028">                                 aArgs.clickHandler :</span>
<a href="#l50.1029"></a><span id="l50.1029">                                 &quot;specialTabs.defaultClickHandler(event);&quot;);</span>
<a href="#l50.1030"></a><span id="l50.1030"> </span>
<a href="#l50.1031"></a><span id="l50.1031">       // Set this attribute so that when favicons fail to load, we remove the</span>
<a href="#l50.1032"></a><span id="l50.1032">       // image attribute and just show the default tab icon.</span>
<a href="#l50.1033"></a><span id="l50.1033">       aTab.tabNode.setAttribute(&quot;onerror&quot;, &quot;this.removeAttribute('image');&quot;);</span>
<a href="#l50.1034"></a><span id="l50.1034" class="difflineat">@@ -1228,104 +1189,104 @@ var specialTabs = {</span>
<a href="#l50.1035"></a><span id="l50.1035"> </span>
<a href="#l50.1036"></a><span id="l50.1036"> </span>
<a href="#l50.1037"></a><span id="l50.1037">       aTab.browser.setAttribute(&quot;id&quot;, &quot;chromeTabBrowser&quot; + this.lastBrowserId);</span>
<a href="#l50.1038"></a><span id="l50.1038"> </span>
<a href="#l50.1039"></a><span id="l50.1039">       // Now set up the listeners.</span>
<a href="#l50.1040"></a><span id="l50.1040">       this._setUpTitleListener(aTab);</span>
<a href="#l50.1041"></a><span id="l50.1041">       this._setUpCloseWindowListener(aTab);</span>
<a href="#l50.1042"></a><span id="l50.1042">       if (&quot;onLoad&quot; in aArgs) {</span>
<a href="#l50.1043"></a><span id="l50.1043" class="difflineminus">-        aTab.browser.addEventListener(&quot;load&quot;, function _chromeTab_onLoad (event) {</span>
<a href="#l50.1044"></a><span id="l50.1044" class="difflineplus">+        aTab.browser.addEventListener(&quot;load&quot;, function _chromeTab_onLoad(event) {</span>
<a href="#l50.1045"></a><span id="l50.1045">           aArgs.onLoad(event, aTab.browser);</span>
<a href="#l50.1046"></a><span id="l50.1046">           aTab.browser.removeEventListener(&quot;load&quot;, _chromeTab_onLoad, true);</span>
<a href="#l50.1047"></a><span id="l50.1047">         }, true);</span>
<a href="#l50.1048"></a><span id="l50.1048">       }</span>
<a href="#l50.1049"></a><span id="l50.1049"> </span>
<a href="#l50.1050"></a><span id="l50.1050">       // Now start loading the content.</span>
<a href="#l50.1051"></a><span id="l50.1051">       aTab.title = this.loadingTabString;</span>
<a href="#l50.1052"></a><span id="l50.1052">       let params = {</span>
<a href="#l50.1053"></a><span id="l50.1053">         triggeringPrincipal: Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l50.1054"></a><span id="l50.1054">       };</span>
<a href="#l50.1055"></a><span id="l50.1055">       aTab.browser.loadURI(aArgs.chromePage, params);</span>
<a href="#l50.1056"></a><span id="l50.1056"> </span>
<a href="#l50.1057"></a><span id="l50.1057">       this.lastBrowserId++;</span>
<a href="#l50.1058"></a><span id="l50.1058">     },</span>
<a href="#l50.1059"></a><span id="l50.1059" class="difflineminus">-    tryCloseTab: function onTryCloseTab(aTab) {</span>
<a href="#l50.1060"></a><span id="l50.1060" class="difflineplus">+    tryCloseTab(aTab) {</span>
<a href="#l50.1061"></a><span id="l50.1061">       let docShell = aTab.browser.docShell;</span>
<a href="#l50.1062"></a><span id="l50.1062">       // If we have a docshell, a contentViewer, and it forbids us from closing</span>
<a href="#l50.1063"></a><span id="l50.1063">       // the tab, then we return false, which means, we can't close the tab. All</span>
<a href="#l50.1064"></a><span id="l50.1064">       // other cases return true.</span>
<a href="#l50.1065"></a><span id="l50.1065">       return !(docShell &amp;&amp; docShell.contentViewer</span>
<a href="#l50.1066"></a><span id="l50.1066">         &amp;&amp; !docShell.contentViewer.permitUnload());</span>
<a href="#l50.1067"></a><span id="l50.1067">     },</span>
<a href="#l50.1068"></a><span id="l50.1068" class="difflineminus">-    closeTab: function onTabClosed(aTab) {</span>
<a href="#l50.1069"></a><span id="l50.1069" class="difflineplus">+    closeTab(aTab) {</span>
<a href="#l50.1070"></a><span id="l50.1070">       aTab.browser.removeEventListener(&quot;load&quot;, aTab.loadListener, true);</span>
<a href="#l50.1071"></a><span id="l50.1071">       aTab.browser.removeEventListener(&quot;DOMTitleChanged&quot;,</span>
<a href="#l50.1072"></a><span id="l50.1072">                                        aTab.titleListener, true);</span>
<a href="#l50.1073"></a><span id="l50.1073">       aTab.browser.removeEventListener(&quot;DOMWindowClose&quot;,</span>
<a href="#l50.1074"></a><span id="l50.1074">                                        aTab.closeListener, true);</span>
<a href="#l50.1075"></a><span id="l50.1075">       aTab.browser.removeEventListener(&quot;DOMLinkAdded&quot;, DOMLinkHandler);</span>
<a href="#l50.1076"></a><span id="l50.1076">       aTab.browser.destroy();</span>
<a href="#l50.1077"></a><span id="l50.1077">     },</span>
<a href="#l50.1078"></a><span id="l50.1078" class="difflineminus">-    saveTabState: function onSaveTabState(aTab) {</span>
<a href="#l50.1079"></a><span id="l50.1079" class="difflineplus">+    saveTabState(aTab) {</span>
<a href="#l50.1080"></a><span id="l50.1080">     },</span>
<a href="#l50.1081"></a><span id="l50.1081" class="difflineminus">-    showTab: function onShowTab(aTab) {</span>
<a href="#l50.1082"></a><span id="l50.1082" class="difflineplus">+    showTab(aTab) {</span>
<a href="#l50.1083"></a><span id="l50.1083">     },</span>
<a href="#l50.1084"></a><span id="l50.1084" class="difflineminus">-    persistTab: function onPersistTab(aTab) {</span>
<a href="#l50.1085"></a><span id="l50.1085" class="difflineplus">+    persistTab(aTab) {</span>
<a href="#l50.1086"></a><span id="l50.1086">       if (aTab.browser.currentURI.spec == &quot;about:blank&quot;)</span>
<a href="#l50.1087"></a><span id="l50.1087">         return null;</span>
<a href="#l50.1088"></a><span id="l50.1088"> </span>
<a href="#l50.1089"></a><span id="l50.1089">       let onClick = aTab.browser.getAttribute(&quot;onclick&quot;);</span>
<a href="#l50.1090"></a><span id="l50.1090"> </span>
<a href="#l50.1091"></a><span id="l50.1091">       return {</span>
<a href="#l50.1092"></a><span id="l50.1092">         tabURI: aTab.browser.currentURI.spec,</span>
<a href="#l50.1093"></a><span id="l50.1093" class="difflineminus">-        clickHandler: onClick ? onClick : null</span>
<a href="#l50.1094"></a><span id="l50.1094" class="difflineplus">+        clickHandler: onClick ? onClick : null,</span>
<a href="#l50.1095"></a><span id="l50.1095">       };</span>
<a href="#l50.1096"></a><span id="l50.1096">     },</span>
<a href="#l50.1097"></a><span id="l50.1097" class="difflineminus">-    restoreTab: function onRestoreTab(aTabmail, aPersistedState) {</span>
<a href="#l50.1098"></a><span id="l50.1098" class="difflineplus">+    restoreTab(aTabmail, aPersistedState) {</span>
<a href="#l50.1099"></a><span id="l50.1099">       aTabmail.openTab(&quot;chromeTab&quot;, { chromePage: aPersistedState.tabURI,</span>
<a href="#l50.1100"></a><span id="l50.1100">                                       clickHandler: aPersistedState.clickHandler,</span>
<a href="#l50.1101"></a><span id="l50.1101" class="difflineminus">-                                      background: true } );</span>
<a href="#l50.1102"></a><span id="l50.1102" class="difflineplus">+                                      background: true });</span>
<a href="#l50.1103"></a><span id="l50.1103">     },</span>
<a href="#l50.1104"></a><span id="l50.1104" class="difflineminus">-    onTitleChanged: function onTitleChanged(aTab) {</span>
<a href="#l50.1105"></a><span id="l50.1105" class="difflineplus">+    onTitleChanged(aTab) {</span>
<a href="#l50.1106"></a><span id="l50.1106">       aTab.title = aTab.browser.contentDocument.title;</span>
<a href="#l50.1107"></a><span id="l50.1107">     },</span>
<a href="#l50.1108"></a><span id="l50.1108" class="difflineminus">-    supportsCommand: function supportsCommand(aCommand, aTab) {</span>
<a href="#l50.1109"></a><span id="l50.1109" class="difflineplus">+    supportsCommand(aCommand, aTab) {</span>
<a href="#l50.1110"></a><span id="l50.1110">       switch (aCommand) {</span>
<a href="#l50.1111"></a><span id="l50.1111">         case &quot;cmd_fullZoomReduce&quot;:</span>
<a href="#l50.1112"></a><span id="l50.1112">         case &quot;cmd_fullZoomEnlarge&quot;:</span>
<a href="#l50.1113"></a><span id="l50.1113">         case &quot;cmd_fullZoomReset&quot;:</span>
<a href="#l50.1114"></a><span id="l50.1114">         case &quot;cmd_fullZoomToggle&quot;:</span>
<a href="#l50.1115"></a><span id="l50.1115">         case &quot;cmd_printSetup&quot;:</span>
<a href="#l50.1116"></a><span id="l50.1116">         case &quot;cmd_print&quot;:</span>
<a href="#l50.1117"></a><span id="l50.1117">         case &quot;button_print&quot;:</span>
<a href="#l50.1118"></a><span id="l50.1118">         // XXX print preview not currently supported - bug 497994 to implement.</span>
<a href="#l50.1119"></a><span id="l50.1119">         // case &quot;cmd_printpreview&quot;:</span>
<a href="#l50.1120"></a><span id="l50.1120">           return true;</span>
<a href="#l50.1121"></a><span id="l50.1121">         default:</span>
<a href="#l50.1122"></a><span id="l50.1122">           return false;</span>
<a href="#l50.1123"></a><span id="l50.1123">       }</span>
<a href="#l50.1124"></a><span id="l50.1124">     },</span>
<a href="#l50.1125"></a><span id="l50.1125" class="difflineminus">-    isCommandEnabled: function isCommandEnabled(aCommand, aTab) {</span>
<a href="#l50.1126"></a><span id="l50.1126" class="difflineplus">+    isCommandEnabled(aCommand, aTab) {</span>
<a href="#l50.1127"></a><span id="l50.1127">       switch (aCommand) {</span>
<a href="#l50.1128"></a><span id="l50.1128">         case &quot;cmd_fullZoomReduce&quot;:</span>
<a href="#l50.1129"></a><span id="l50.1129">         case &quot;cmd_fullZoomEnlarge&quot;:</span>
<a href="#l50.1130"></a><span id="l50.1130">         case &quot;cmd_fullZoomReset&quot;:</span>
<a href="#l50.1131"></a><span id="l50.1131">         case &quot;cmd_fullZoomToggle&quot;:</span>
<a href="#l50.1132"></a><span id="l50.1132">         case &quot;cmd_printSetup&quot;:</span>
<a href="#l50.1133"></a><span id="l50.1133">         case &quot;cmd_print&quot;:</span>
<a href="#l50.1134"></a><span id="l50.1134">         case &quot;button_print&quot;:</span>
<a href="#l50.1135"></a><span id="l50.1135">         // XXX print preview not currently supported - bug 497994 to implement.</span>
<a href="#l50.1136"></a><span id="l50.1136">         // case &quot;cmd_printpreview&quot;:</span>
<a href="#l50.1137"></a><span id="l50.1137">           return true;</span>
<a href="#l50.1138"></a><span id="l50.1138">         default:</span>
<a href="#l50.1139"></a><span id="l50.1139">           return false;</span>
<a href="#l50.1140"></a><span id="l50.1140">       }</span>
<a href="#l50.1141"></a><span id="l50.1141">     },</span>
<a href="#l50.1142"></a><span id="l50.1142" class="difflineminus">-    doCommand: function isCommandEnabled(aCommand, aTab) {</span>
<a href="#l50.1143"></a><span id="l50.1143" class="difflineplus">+    doCommand(aCommand, aTab) {</span>
<a href="#l50.1144"></a><span id="l50.1144">       switch (aCommand) {</span>
<a href="#l50.1145"></a><span id="l50.1145">         case &quot;cmd_fullZoomReduce&quot;:</span>
<a href="#l50.1146"></a><span id="l50.1146">           ZoomManager.reduce();</span>
<a href="#l50.1147"></a><span id="l50.1147">           break;</span>
<a href="#l50.1148"></a><span id="l50.1148">         case &quot;cmd_fullZoomEnlarge&quot;:</span>
<a href="#l50.1149"></a><span id="l50.1149">           ZoomManager.enlarge();</span>
<a href="#l50.1150"></a><span id="l50.1150">           break;</span>
<a href="#l50.1151"></a><span id="l50.1151">         case &quot;cmd_fullZoomReset&quot;:</span>
<a href="#l50.1152"></a><span id="l50.1152" class="difflineat">@@ -1337,40 +1298,40 @@ var specialTabs = {</span>
<a href="#l50.1153"></a><span id="l50.1153">         case &quot;cmd_printSetup&quot;:</span>
<a href="#l50.1154"></a><span id="l50.1154">           PrintUtils.showPageSetup();</span>
<a href="#l50.1155"></a><span id="l50.1155">           break;</span>
<a href="#l50.1156"></a><span id="l50.1156">         case &quot;cmd_print&quot;:</span>
<a href="#l50.1157"></a><span id="l50.1157">           let browser = this.getBrowser(aTab);</span>
<a href="#l50.1158"></a><span id="l50.1158">           PrintUtils.printWindow(browser.outerWindowID, browser);</span>
<a href="#l50.1159"></a><span id="l50.1159">           break;</span>
<a href="#l50.1160"></a><span id="l50.1160">         // XXX print preview not currently supported - bug 497994 to implement.</span>
<a href="#l50.1161"></a><span id="l50.1161" class="difflineminus">-        //case &quot;cmd_printpreview&quot;:</span>
<a href="#l50.1162"></a><span id="l50.1162" class="difflineplus">+        // case &quot;cmd_printpreview&quot;:</span>
<a href="#l50.1163"></a><span id="l50.1163">         //  PrintUtils.printPreview();</span>
<a href="#l50.1164"></a><span id="l50.1164">         //  break;</span>
<a href="#l50.1165"></a><span id="l50.1165">       }</span>
<a href="#l50.1166"></a><span id="l50.1166">     },</span>
<a href="#l50.1167"></a><span id="l50.1167" class="difflineminus">-    getBrowser: function getBrowser(aTab) {</span>
<a href="#l50.1168"></a><span id="l50.1168" class="difflineplus">+    getBrowser(aTab) {</span>
<a href="#l50.1169"></a><span id="l50.1169">       return aTab.browser;</span>
<a href="#l50.1170"></a><span id="l50.1170">     },</span>
<a href="#l50.1171"></a><span id="l50.1171">     // Internal function used to set up the title listener on a content tab.</span>
<a href="#l50.1172"></a><span id="l50.1172" class="difflineminus">-    _setUpTitleListener: function setUpTitleListener(aTab) {</span>
<a href="#l50.1173"></a><span id="l50.1173" class="difflineplus">+    _setUpTitleListener(aTab) {</span>
<a href="#l50.1174"></a><span id="l50.1174">       function onDOMTitleChanged(aEvent) {</span>
<a href="#l50.1175"></a><span id="l50.1175">         document.getElementById(&quot;tabmail&quot;).setTabTitle(aTab);</span>
<a href="#l50.1176"></a><span id="l50.1176">       }</span>
<a href="#l50.1177"></a><span id="l50.1177">       // Save the function we'll use as listener so we can remove it later.</span>
<a href="#l50.1178"></a><span id="l50.1178">       aTab.titleListener = onDOMTitleChanged;</span>
<a href="#l50.1179"></a><span id="l50.1179">       // Add the listener.</span>
<a href="#l50.1180"></a><span id="l50.1180">       aTab.browser.addEventListener(&quot;DOMTitleChanged&quot;,</span>
<a href="#l50.1181"></a><span id="l50.1181">                                     aTab.titleListener, true);</span>
<a href="#l50.1182"></a><span id="l50.1182">     },</span>
<a href="#l50.1183"></a><span id="l50.1183">     /**</span>
<a href="#l50.1184"></a><span id="l50.1184">      * Internal function used to set up the close window listener on a content</span>
<a href="#l50.1185"></a><span id="l50.1185">      * tab.</span>
<a href="#l50.1186"></a><span id="l50.1186">      */</span>
<a href="#l50.1187"></a><span id="l50.1187" class="difflineminus">-    _setUpCloseWindowListener: function setUpCloseWindowListener(aTab) {</span>
<a href="#l50.1188"></a><span id="l50.1188" class="difflineplus">+    _setUpCloseWindowListener(aTab) {</span>
<a href="#l50.1189"></a><span id="l50.1189">       function onDOMWindowClose(aEvent) {</span>
<a href="#l50.1190"></a><span id="l50.1190">       try {</span>
<a href="#l50.1191"></a><span id="l50.1191">         if (!aEvent.isTrusted)</span>
<a href="#l50.1192"></a><span id="l50.1192">           return;</span>
<a href="#l50.1193"></a><span id="l50.1193"> </span>
<a href="#l50.1194"></a><span id="l50.1194">         // Redirect any window.close events to closing the tab. As a 3-pane tab</span>
<a href="#l50.1195"></a><span id="l50.1195">         // must be open, we don't need to worry about being the last tab open.</span>
<a href="#l50.1196"></a><span id="l50.1196">         document.getElementById(&quot;tabmail&quot;).closeTab(aTab);</span>
<a href="#l50.1197"></a><span id="l50.1197" class="difflineat">@@ -1379,76 +1340,73 @@ var specialTabs = {</span>
<a href="#l50.1198"></a><span id="l50.1198">         logException(e);</span>
<a href="#l50.1199"></a><span id="l50.1199">       }</span>
<a href="#l50.1200"></a><span id="l50.1200">       }</span>
<a href="#l50.1201"></a><span id="l50.1201">       // Save the function we'll use as listener so we can remove it later.</span>
<a href="#l50.1202"></a><span id="l50.1202">       aTab.closeListener = onDOMWindowClose;</span>
<a href="#l50.1203"></a><span id="l50.1203">       // Add the listener.</span>
<a href="#l50.1204"></a><span id="l50.1204">       aTab.browser.addEventListener(&quot;DOMWindowClose&quot;,</span>
<a href="#l50.1205"></a><span id="l50.1205">                                     aTab.closeListener, true);</span>
<a href="#l50.1206"></a><span id="l50.1206" class="difflineminus">-    }</span>
<a href="#l50.1207"></a><span id="l50.1207" class="difflineplus">+    },</span>
<a href="#l50.1208"></a><span id="l50.1208">   },</span>
<a href="#l50.1209"></a><span id="l50.1209"> </span>
<a href="#l50.1210"></a><span id="l50.1210">   /**</span>
<a href="#l50.1211"></a><span id="l50.1211">    * Determine if we should load fav icons or not.</span>
<a href="#l50.1212"></a><span id="l50.1212">    *</span>
<a href="#l50.1213"></a><span id="l50.1213">    * @param aURI  An nsIURI containing the current url.</span>
<a href="#l50.1214"></a><span id="l50.1214">    */</span>
<a href="#l50.1215"></a><span id="l50.1215" class="difflineminus">-  _shouldLoadFavIcon: function shouldLoadFavIcon(aURI) {</span>
<a href="#l50.1216"></a><span id="l50.1216" class="difflineplus">+  _shouldLoadFavIcon(aURI) {</span>
<a href="#l50.1217"></a><span id="l50.1217">     return (aURI &amp;&amp;</span>
<a href="#l50.1218"></a><span id="l50.1218">             Services.prefs.getBoolPref(&quot;browser.chrome.site_icons&quot;) &amp;&amp;</span>
<a href="#l50.1219"></a><span id="l50.1219">             Services.prefs.getBoolPref(&quot;browser.chrome.favicons&quot;) &amp;&amp;</span>
<a href="#l50.1220"></a><span id="l50.1220">             (&quot;schemeIs&quot; in aURI) &amp;&amp;</span>
<a href="#l50.1221"></a><span id="l50.1221">             (aURI.schemeIs(&quot;http&quot;) || aURI.schemeIs(&quot;https&quot;)));</span>
<a href="#l50.1222"></a><span id="l50.1222">   },</span>
<a href="#l50.1223"></a><span id="l50.1223"> </span>
<a href="#l50.1224"></a><span id="l50.1224">   /**</span>
<a href="#l50.1225"></a><span id="l50.1225">    * Tries to use the default favicon for a webpage for the specified tab.</span>
<a href="#l50.1226"></a><span id="l50.1226">    * If the web page is just an image, then we'll use the image itself it it</span>
<a href="#l50.1227"></a><span id="l50.1227">    * isn't too big.</span>
<a href="#l50.1228"></a><span id="l50.1228">    * Otherwise we'll use the site's favicon.ico if prefs allow us to.</span>
<a href="#l50.1229"></a><span id="l50.1229">    */</span>
<a href="#l50.1230"></a><span id="l50.1230" class="difflineminus">-  useDefaultIcon: function useDefaultIcon(aTab) {</span>
<a href="#l50.1231"></a><span id="l50.1231" class="difflineminus">-    let tabmail = document.getElementById('tabmail');</span>
<a href="#l50.1232"></a><span id="l50.1232" class="difflineplus">+  useDefaultIcon(aTab) {</span>
<a href="#l50.1233"></a><span id="l50.1233">     var docURIObject = aTab.browser.contentDocument.documentURIObject;</span>
<a href="#l50.1234"></a><span id="l50.1234">     var icon = null;</span>
<a href="#l50.1235"></a><span id="l50.1235">     if (aTab.browser.contentDocument instanceof ImageDocument) {</span>
<a href="#l50.1236"></a><span id="l50.1236">       if (Services.prefs.getBoolPref(&quot;browser.chrome.site_icons&quot;)) {</span>
<a href="#l50.1237"></a><span id="l50.1237">         let sz = Services.prefs.getIntPref(&quot;browser.chrome.image_icons.max_size&quot;);</span>
<a href="#l50.1238"></a><span id="l50.1238">         try {</span>
<a href="#l50.1239"></a><span id="l50.1239">           let req = aTab.browser.contentDocument.imageRequest;</span>
<a href="#l50.1240"></a><span id="l50.1240">           if (req &amp;&amp; req.image &amp;&amp; req.image.width &lt;= sz &amp;&amp;</span>
<a href="#l50.1241"></a><span id="l50.1241">               req.image.height &lt;= sz)</span>
<a href="#l50.1242"></a><span id="l50.1242">             icon = aTab.browser.currentURI.spec;</span>
<a href="#l50.1243"></a><span id="l50.1243" class="difflineminus">-        }</span>
<a href="#l50.1244"></a><span id="l50.1244" class="difflineminus">-        catch (e) { }</span>
<a href="#l50.1245"></a><span id="l50.1245" class="difflineplus">+        } catch (e) {}</span>
<a href="#l50.1246"></a><span id="l50.1246">       }</span>
<a href="#l50.1247"></a><span id="l50.1247" class="difflineminus">-    }</span>
<a href="#l50.1248"></a><span id="l50.1248" class="difflineminus">-    // Use documentURIObject in the check for shouldLoadFavIcon so that we do</span>
<a href="#l50.1249"></a><span id="l50.1249" class="difflineminus">-    // the right thing with about:-style error pages.</span>
<a href="#l50.1250"></a><span id="l50.1250" class="difflineminus">-    else if (this._shouldLoadFavIcon(docURIObject)) {</span>
<a href="#l50.1251"></a><span id="l50.1251" class="difflineplus">+    } else if (this._shouldLoadFavIcon(docURIObject)) {</span>
<a href="#l50.1252"></a><span id="l50.1252" class="difflineplus">+      // Use documentURIObject in the check for shouldLoadFavIcon so that we do</span>
<a href="#l50.1253"></a><span id="l50.1253" class="difflineplus">+      // the right thing with about:-style error pages.</span>
<a href="#l50.1254"></a><span id="l50.1254">       icon = docURIObject.prePath + &quot;/favicon.ico&quot;;</span>
<a href="#l50.1255"></a><span id="l50.1255">     }</span>
<a href="#l50.1256"></a><span id="l50.1256"> </span>
<a href="#l50.1257"></a><span id="l50.1257">     specialTabs.setTabIcon(aTab, icon);</span>
<a href="#l50.1258"></a><span id="l50.1258">   },</span>
<a href="#l50.1259"></a><span id="l50.1259"> </span>
<a href="#l50.1260"></a><span id="l50.1260">   /**</span>
<a href="#l50.1261"></a><span id="l50.1261">    * This sets the specified tab to load and display the given icon for the</span>
<a href="#l50.1262"></a><span id="l50.1262">    * page shown in the browser. It is assumed that the preferences have already</span>
<a href="#l50.1263"></a><span id="l50.1263">    * been checked before calling this function apprioriately.</span>
<a href="#l50.1264"></a><span id="l50.1264">    *</span>
<a href="#l50.1265"></a><span id="l50.1265">    * @param aTab  The tab to set the icon for.</span>
<a href="#l50.1266"></a><span id="l50.1266">    * @param aIcon A string based URL of the icon to try and load.</span>
<a href="#l50.1267"></a><span id="l50.1267">    */</span>
<a href="#l50.1268"></a><span id="l50.1268" class="difflineminus">-  setTabIcon: function(aTab, aIcon) {</span>
<a href="#l50.1269"></a><span id="l50.1269" class="difflineplus">+  setTabIcon(aTab, aIcon) {</span>
<a href="#l50.1270"></a><span id="l50.1270">     if (aIcon &amp;&amp; this.mFaviconService)</span>
<a href="#l50.1271"></a><span id="l50.1271">       this.mFaviconService.setAndFetchFaviconForPage(</span>
<a href="#l50.1272"></a><span id="l50.1272">         aTab.browser.currentURI, makeURI(aIcon), false,</span>
<a href="#l50.1273"></a><span id="l50.1273">         this.mFaviconService.FAVICON_LOAD_NON_PRIVATE,</span>
<a href="#l50.1274"></a><span id="l50.1274">         null, aTab.browser.contentPrincipal);</span>
<a href="#l50.1275"></a><span id="l50.1275"> </span>
<a href="#l50.1276"></a><span id="l50.1276">     // Save this off so we know about it later,</span>
<a href="#l50.1277"></a><span id="l50.1277">     aTab.browser.mIconURL = aIcon;</span>
<a href="#l50.1278"></a><span id="l50.1278">     // and display the new icon.</span>
<a href="#l50.1279"></a><span id="l50.1279">     document.getElementById(&quot;tabmail&quot;).setTabIcon(aTab, aIcon);</span>
<a href="#l50.1280"></a><span id="l50.1280" class="difflineminus">-  }</span>
<a href="#l50.1281"></a><span id="l50.1281" class="difflineplus">+  },</span>
<a href="#l50.1282"></a><span id="l50.1282"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1" class="difflineminus">--- a/mail/base/content/systemIntegrationDialog.js</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineplus">+++ b/mail/base/content/systemIntegrationDialog.js</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineat">@@ -14,18 +14,17 @@ var gSystemIntegrationDialog = {</span>
<a href="#l51.4"></a><span id="l51.4">   _newsCheckbox: null,</span>
<a href="#l51.5"></a><span id="l51.5"> </span>
<a href="#l51.6"></a><span id="l51.6">   _rssCheckbox: null,</span>
<a href="#l51.7"></a><span id="l51.7"> </span>
<a href="#l51.8"></a><span id="l51.8">   _startupCheckbox: null,</span>
<a href="#l51.9"></a><span id="l51.9"> </span>
<a href="#l51.10"></a><span id="l51.10">   _searchCheckbox: null,</span>
<a href="#l51.11"></a><span id="l51.11"> </span>
<a href="#l51.12"></a><span id="l51.12" class="difflineminus">-  onLoad: function()</span>
<a href="#l51.13"></a><span id="l51.13" class="difflineminus">-  {</span>
<a href="#l51.14"></a><span id="l51.14" class="difflineplus">+  onLoad() {</span>
<a href="#l51.15"></a><span id="l51.15">     // Makes Services and SearchIntegration accessible via this.Services</span>
<a href="#l51.16"></a><span id="l51.16">     // and this.SearchIntegration.</span>
<a href="#l51.17"></a><span id="l51.17">     ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;, this);</span>
<a href="#l51.18"></a><span id="l51.18">     ChromeUtils.import(&quot;resource:///modules/SearchIntegration.jsm&quot;, this);</span>
<a href="#l51.19"></a><span id="l51.19"> </span>
<a href="#l51.20"></a><span id="l51.20">     // initialize elements</span>
<a href="#l51.21"></a><span id="l51.21">     this._mailCheckbox    = document.getElementById(&quot;checkMail&quot;);</span>
<a href="#l51.22"></a><span id="l51.22">     this._newsCheckbox    = document.getElementById(&quot;checkNews&quot;);</span>
<a href="#l51.23"></a><span id="l51.23" class="difflineat">@@ -68,47 +67,43 @@ var gSystemIntegrationDialog = {</span>
<a href="#l51.24"></a><span id="l51.24">     if (!this._rssCheckbox.disabled)</span>
<a href="#l51.25"></a><span id="l51.25">       this._rssCheckbox.removeAttribute(&quot;tooltiptext&quot;);</span>
<a href="#l51.26"></a><span id="l51.26"> </span>
<a href="#l51.27"></a><span id="l51.27">     // read the raw pref value and not shellSvc.shouldCheckDefaultMail</span>
<a href="#l51.28"></a><span id="l51.28">     this._startupCheckbox.checked =</span>
<a href="#l51.29"></a><span id="l51.29">       this.Services.prefs.getBoolPref(&quot;mail.shell.checkDefaultClient&quot;);</span>
<a href="#l51.30"></a><span id="l51.30"> </span>
<a href="#l51.31"></a><span id="l51.31">     // Search integration - check whether we should show/disable integration options</span>
<a href="#l51.32"></a><span id="l51.32" class="difflineminus">-    if (this.SearchIntegration)</span>
<a href="#l51.33"></a><span id="l51.33" class="difflineminus">-    {</span>
<a href="#l51.34"></a><span id="l51.34" class="difflineplus">+    if (this.SearchIntegration) {</span>
<a href="#l51.35"></a><span id="l51.35">       this._searchCheckbox.checked = this.SearchIntegration.prefEnabled;</span>
<a href="#l51.36"></a><span id="l51.36">       // On Windows, do not offer the option on startup as it does not perform well.</span>
<a href="#l51.37"></a><span id="l51.37">       if ((this.Services.appinfo.OS == &quot;WINNT&quot;) &amp;&amp; !calledFromPrefs &amp;&amp;</span>
<a href="#l51.38"></a><span id="l51.38">           !this._searchCheckbox.checked) {</span>
<a href="#l51.39"></a><span id="l51.39">         this._searchCheckbox.hidden = true;</span>
<a href="#l51.40"></a><span id="l51.40">         // Even if the user wasn't presented the choice,</span>
<a href="#l51.41"></a><span id="l51.41">         // we do not want to ask again automatically.</span>
<a href="#l51.42"></a><span id="l51.42">         this.SearchIntegration.firstRunDone = true;</span>
<a href="#l51.43"></a><span id="l51.43" class="difflineminus">-      } else {</span>
<a href="#l51.44"></a><span id="l51.44" class="difflineplus">+      } else if (!this.SearchIntegration.osVersionTooLow) {</span>
<a href="#l51.45"></a><span id="l51.45">         // Hide/disable the options if the OS does not support them.</span>
<a href="#l51.46"></a><span id="l51.46" class="difflineminus">-        if (!this.SearchIntegration.osVersionTooLow) {</span>
<a href="#l51.47"></a><span id="l51.47" class="difflineminus">-          this._searchCheckbox.hidden = false;</span>
<a href="#l51.48"></a><span id="l51.48" class="difflineminus">-          if (this.SearchIntegration.osComponentsNotRunning) {</span>
<a href="#l51.49"></a><span id="l51.49" class="difflineminus">-            this._searchCheckbox.checked = false;</span>
<a href="#l51.50"></a><span id="l51.50" class="difflineminus">-            this._searchCheckbox.disabled = true;</span>
<a href="#l51.51"></a><span id="l51.51" class="difflineminus">-          }</span>
<a href="#l51.52"></a><span id="l51.52" class="difflineplus">+        this._searchCheckbox.hidden = false;</span>
<a href="#l51.53"></a><span id="l51.53" class="difflineplus">+        if (this.SearchIntegration.osComponentsNotRunning) {</span>
<a href="#l51.54"></a><span id="l51.54" class="difflineplus">+          this._searchCheckbox.checked = false;</span>
<a href="#l51.55"></a><span id="l51.55" class="difflineplus">+          this._searchCheckbox.disabled = true;</span>
<a href="#l51.56"></a><span id="l51.56">         }</span>
<a href="#l51.57"></a><span id="l51.57">       }</span>
<a href="#l51.58"></a><span id="l51.58">     }</span>
<a href="#l51.59"></a><span id="l51.59">   },</span>
<a href="#l51.60"></a><span id="l51.60"> </span>
<a href="#l51.61"></a><span id="l51.61">   /**</span>
<a href="#l51.62"></a><span id="l51.62">    * Called when the dialog is closed by any button.</span>
<a href="#l51.63"></a><span id="l51.63">    *</span>
<a href="#l51.64"></a><span id="l51.64">    * @param aSetAsDefault  If true, set TB as the default application for the</span>
<a href="#l51.65"></a><span id="l51.65">    *                       checked actions (mail/news/rss). Otherwise do nothing.</span>
<a href="#l51.66"></a><span id="l51.66">    */</span>
<a href="#l51.67"></a><span id="l51.67" class="difflineminus">-  onDialogClose: function(aSetAsDefault)</span>
<a href="#l51.68"></a><span id="l51.68" class="difflineminus">-  {</span>
<a href="#l51.69"></a><span id="l51.69" class="difflineplus">+  onDialogClose(aSetAsDefault) {</span>
<a href="#l51.70"></a><span id="l51.70">     // In all cases, save the user's decision for &quot;always check at startup&quot;.</span>
<a href="#l51.71"></a><span id="l51.71">     this._shellSvc.shouldCheckDefaultClient = this._startupCheckbox.checked;</span>
<a href="#l51.72"></a><span id="l51.72"> </span>
<a href="#l51.73"></a><span id="l51.73">     // If the search checkbox is exposed, the user had the chance to make his choice.</span>
<a href="#l51.74"></a><span id="l51.74">     // So do not ask next time.</span>
<a href="#l51.75"></a><span id="l51.75">     let searchIntegPossible = !this._searchCheckbox.hidden;</span>
<a href="#l51.76"></a><span id="l51.76">     if (searchIntegPossible) {</span>
<a href="#l51.77"></a><span id="l51.77">       this.SearchIntegration.firstRunDone = true;</span>
<a href="#l51.78"></a><span id="l51.78" class="difflineat">@@ -144,10 +139,10 @@ var gSystemIntegrationDialog = {</span>
<a href="#l51.79"></a><span id="l51.79">       this._shellSvc.setDefaultClient(false, appTypes);</span>
<a href="#l51.80"></a><span id="l51.80"> </span>
<a href="#l51.81"></a><span id="l51.81">     // Set the search integration pref if it is changed.</span>
<a href="#l51.82"></a><span id="l51.82">     // The integration will handle the rest.</span>
<a href="#l51.83"></a><span id="l51.83">     if (searchIntegPossible)</span>
<a href="#l51.84"></a><span id="l51.84">       this.SearchIntegration.prefEnabled = this._searchCheckbox.checked;</span>
<a href="#l51.85"></a><span id="l51.85"> </span>
<a href="#l51.86"></a><span id="l51.86">     return true;</span>
<a href="#l51.87"></a><span id="l51.87" class="difflineminus">-  }</span>
<a href="#l51.88"></a><span id="l51.88" class="difflineplus">+  },</span>
<a href="#l51.89"></a><span id="l51.89"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1" class="difflineminus">--- a/mail/base/content/tabmail.xml</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineplus">+++ b/mail/base/content/tabmail.xml</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineat">@@ -46,17 +46,17 @@</span>
<a href="#l52.4"></a><span id="l52.4">     -     there are also a few common ones that all should obey, including:</span>
<a href="#l52.5"></a><span id="l52.5">     -</span>
<a href="#l52.6"></a><span id="l52.6">     -     * &quot;background&quot;: if this is true, the tab will be loaded in the</span>
<a href="#l52.7"></a><span id="l52.7">     -       background.</span>
<a href="#l52.8"></a><span id="l52.8">     -     * &quot;disregardOpener&quot;: if this is true, then the tab opener will not</span>
<a href="#l52.9"></a><span id="l52.9">     -       be switched to automatically by tabmail if the new tab is immediately</span>
<a href="#l52.10"></a><span id="l52.10">     -       closed.</span>
<a href="#l52.11"></a><span id="l52.11">     -</span>
<a href="#l52.12"></a><span id="l52.12" class="difflineminus">-    - * closeTab(aOptionalTabIndexInfoOrTabNode,aNoUndo):</span>
<a href="#l52.13"></a><span id="l52.13" class="difflineplus">+    - * closeTab(aOptionalTabIndexInfoOrTabNode, aNoUndo):</span>
<a href="#l52.14"></a><span id="l52.14">     -     If no argument is provided, the current tab is closed. The first</span>
<a href="#l52.15"></a><span id="l52.15">     -     argument specifies a specific tab to be closed. It can be a tab index,</span>
<a href="#l52.16"></a><span id="l52.16">     -     a tab info object, or a tab's DOM element. In case the second</span>
<a href="#l52.17"></a><span id="l52.17">     -     argument is true, the closed tab can't be restored by calling</span>
<a href="#l52.18"></a><span id="l52.18">     -     undoCloseTab().</span>
<a href="#l52.19"></a><span id="l52.19">     -     Please note, some tabs cannot be closed. Trying to close such tab,</span>
<a href="#l52.20"></a><span id="l52.20">     -     will fail silently.</span>
<a href="#l52.21"></a><span id="l52.21">     - * undoCloseTab():</span>
<a href="#l52.22"></a><span id="l52.22" class="difflineat">@@ -69,17 +69,17 @@</span>
<a href="#l52.23"></a><span id="l52.23">     - * setTabIcon(aTabNodeorInfo, aIcon): Sets the tab icon to the specified</span>
<a href="#l52.24"></a><span id="l52.24">     -     url or removes the icon if no url is specified. Note that this may</span>
<a href="#l52.25"></a><span id="l52.25">     -     override css-provided images.</span>
<a href="#l52.26"></a><span id="l52.26">     - * replaceTabWithWindow(aTab):</span>
<a href="#l52.27"></a><span id="l52.27">     -     Detaches a tab from this tabbar to new window. The argument &quot;aTab&quot; is</span>
<a href="#l52.28"></a><span id="l52.28">     -     required and can be a tab index, a tab info object or a tabs's</span>
<a href="#l52.29"></a><span id="l52.29">     -     DOM element. Calling this method works only for tabs implementing</span>
<a href="#l52.30"></a><span id="l52.30">     -     session restore.</span>
<a href="#l52.31"></a><span id="l52.31" class="difflineminus">-    - * moveTabTo(aTab,aIndex):</span>
<a href="#l52.32"></a><span id="l52.32" class="difflineplus">+    - * moveTabTo(aTab, aIndex):</span>
<a href="#l52.33"></a><span id="l52.33">     -     moves the given tab to the given Index. The first argument can be</span>
<a href="#l52.34"></a><span id="l52.34">     -     a tab index, a tab info object or a tab's DOM element. The second</span>
<a href="#l52.35"></a><span id="l52.35">     -     argument specifies the tabs new absolute position within the tabbar.</span>
<a href="#l52.36"></a><span id="l52.36">     -</span>
<a href="#l52.37"></a><span id="l52.37">     - Less-friendly consumer methods:</span>
<a href="#l52.38"></a><span id="l52.38">     - * persistTab(tab):</span>
<a href="#l52.39"></a><span id="l52.39">     -     serializes a tab into an object, by passing  a tab info object as</span>
<a href="#l52.40"></a><span id="l52.40">     -     argument. It is used for session restore and moving tabs between</span>
<a href="#l52.41"></a><span id="l52.41" class="difflineat">@@ -280,47 +280,47 @@</span>
<a href="#l52.42"></a><span id="l52.42">       &lt;/field&gt;</span>
<a href="#l52.43"></a><span id="l52.43">       &lt;!-- Temporary field that only has a non-null value during a call to</span>
<a href="#l52.44"></a><span id="l52.44">            openTab, and whose value is the currentTabInfo of the tab that was</span>
<a href="#l52.45"></a><span id="l52.45">            open when we received the call to openTab. --&gt;</span>
<a href="#l52.46"></a><span id="l52.46">       &lt;field name=&quot;_mostRecentTabInfo&quot;&gt;</span>
<a href="#l52.47"></a><span id="l52.47">         null</span>
<a href="#l52.48"></a><span id="l52.48">       &lt;/field&gt;</span>
<a href="#l52.49"></a><span id="l52.49">       &lt;field name=&quot;tabTypes&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l52.50"></a><span id="l52.50" class="difflineminus">-        new Object()</span>
<a href="#l52.51"></a><span id="l52.51" class="difflineplus">+        ({})</span>
<a href="#l52.52"></a><span id="l52.52">       &lt;/field&gt;</span>
<a href="#l52.53"></a><span id="l52.53">       &lt;field name=&quot;tabModes&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l52.54"></a><span id="l52.54" class="difflineminus">-        new Object()</span>
<a href="#l52.55"></a><span id="l52.55" class="difflineplus">+        ({})</span>
<a href="#l52.56"></a><span id="l52.56">       &lt;/field&gt;</span>
<a href="#l52.57"></a><span id="l52.57">       &lt;field name=&quot;defaultTabMode&quot;&gt;</span>
<a href="#l52.58"></a><span id="l52.58">         null</span>
<a href="#l52.59"></a><span id="l52.59">       &lt;/field&gt;</span>
<a href="#l52.60"></a><span id="l52.60">       &lt;field name=&quot;tabInfo&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l52.61"></a><span id="l52.61" class="difflineminus">-        new Array()</span>
<a href="#l52.62"></a><span id="l52.62" class="difflineplus">+        []</span>
<a href="#l52.63"></a><span id="l52.63">       &lt;/field&gt;</span>
<a href="#l52.64"></a><span id="l52.64">       &lt;field name=&quot;tabContainer&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l52.65"></a><span id="l52.65">         document.getElementById(this.getAttribute(&quot;tabcontainer&quot;));</span>
<a href="#l52.66"></a><span id="l52.66">       &lt;/field&gt;</span>
<a href="#l52.67"></a><span id="l52.67">       &lt;field name=&quot;panelContainer&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l52.68"></a><span id="l52.68">         document.getElementById(this.getAttribute(&quot;panelcontainer&quot;));</span>
<a href="#l52.69"></a><span id="l52.69">       &lt;/field&gt;</span>
<a href="#l52.70"></a><span id="l52.70">       &lt;field name=&quot;tabMonitors&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l52.71"></a><span id="l52.71" class="difflineminus">-        new Array()</span>
<a href="#l52.72"></a><span id="l52.72" class="difflineplus">+        []</span>
<a href="#l52.73"></a><span id="l52.73">       &lt;/field&gt;</span>
<a href="#l52.74"></a><span id="l52.74">       &lt;field name=&quot;recentlyClosedTabs&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l52.75"></a><span id="l52.75" class="difflineminus">-        new Array();</span>
<a href="#l52.76"></a><span id="l52.76" class="difflineplus">+        [];</span>
<a href="#l52.77"></a><span id="l52.77">       &lt;/field&gt;</span>
<a href="#l52.78"></a><span id="l52.78">       &lt;field name=&quot;mLastTabOpener&quot;&gt;</span>
<a href="#l52.79"></a><span id="l52.79">         null</span>
<a href="#l52.80"></a><span id="l52.80">       &lt;/field&gt;</span>
<a href="#l52.81"></a><span id="l52.81">       &lt;field name=&quot;mTabsProgressListeners&quot;&gt;</span>
<a href="#l52.82"></a><span id="l52.82">         new Set();</span>
<a href="#l52.83"></a><span id="l52.83">       &lt;/field&gt;</span>
<a href="#l52.84"></a><span id="l52.84">       &lt;field name=&quot;unrestoredTabs&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l52.85"></a><span id="l52.85" class="difflineminus">-        new Array();</span>
<a href="#l52.86"></a><span id="l52.86" class="difflineplus">+        [];</span>
<a href="#l52.87"></a><span id="l52.87">       &lt;/field&gt;</span>
<a href="#l52.88"></a><span id="l52.88">       &lt;method name=&quot;createTooltip&quot;&gt;</span>
<a href="#l52.89"></a><span id="l52.89">         &lt;parameter name=&quot;event&quot;/&gt;</span>
<a href="#l52.90"></a><span id="l52.90">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l52.91"></a><span id="l52.91">           event.stopPropagation();</span>
<a href="#l52.92"></a><span id="l52.92">           var tab = document.tooltipNode;</span>
<a href="#l52.93"></a><span id="l52.93">           if (tab.localName != &quot;tab&quot; || this.tabContainer.draggedTab) {</span>
<a href="#l52.94"></a><span id="l52.94">             event.preventDefault();</span>
<a href="#l52.95"></a><span id="l52.95" class="difflineat">@@ -346,18 +346,18 @@</span>
<a href="#l52.96"></a><span id="l52.96">             modeDetails.tabs = [];</span>
<a href="#l52.97"></a><span id="l52.97">             this.tabModes[modeName] = modeDetails;</span>
<a href="#l52.98"></a><span id="l52.98">             if (modeDetails.isDefault)</span>
<a href="#l52.99"></a><span id="l52.99">               this.defaultTabMode = modeDetails;</span>
<a href="#l52.100"></a><span id="l52.100">           }</span>
<a href="#l52.101"></a><span id="l52.101">           if (aTabType.panelId)</span>
<a href="#l52.102"></a><span id="l52.102">             aTabType.panel = document.getElementById(aTabType.panelId);</span>
<a href="#l52.103"></a><span id="l52.103">           else if (!aTabType.perTabPanel) {</span>
<a href="#l52.104"></a><span id="l52.104" class="difflineminus">-            throw(&quot;Trying to register a tab type with neither panelId &quot; +</span>
<a href="#l52.105"></a><span id="l52.105" class="difflineminus">-                  &quot;nor perTabPanel attributes.&quot;)</span>
<a href="#l52.106"></a><span id="l52.106" class="difflineplus">+            throw new Error(&quot;Trying to register a tab type with neither panelId &quot; +</span>
<a href="#l52.107"></a><span id="l52.107" class="difflineplus">+                            &quot;nor perTabPanel attributes.&quot;);</span>
<a href="#l52.108"></a><span id="l52.108">           }</span>
<a href="#l52.109"></a><span id="l52.109"> </span>
<a href="#l52.110"></a><span id="l52.110">           setTimeout(() =&gt; {</span>
<a href="#l52.111"></a><span id="l52.111">             for (let modeName of Object.keys(aTabType.modes)) {</span>
<a href="#l52.112"></a><span id="l52.112">               for (let i = 0; i &lt; this.unrestoredTabs.length;) {</span>
<a href="#l52.113"></a><span id="l52.113">                 let state = this.unrestoredTabs[i];</span>
<a href="#l52.114"></a><span id="l52.114">                 if (state.mode == modeName) {</span>
<a href="#l52.115"></a><span id="l52.115">                   this.restoreTab(state);</span>
<a href="#l52.116"></a><span id="l52.116" class="difflineat">@@ -412,33 +412,31 @@</span>
<a href="#l52.117"></a><span id="l52.117">         --&gt;</span>
<a href="#l52.118"></a><span id="l52.118">       &lt;method name=&quot;_getTabContextForTabbyThing&quot;&gt;</span>
<a href="#l52.119"></a><span id="l52.119">         &lt;parameter name=&quot;aTabIndexNodeOrInfo&quot;/&gt;</span>
<a href="#l52.120"></a><span id="l52.120">         &lt;parameter name=&quot;aDefaultToCurrent&quot;/&gt;</span>
<a href="#l52.121"></a><span id="l52.121">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l52.122"></a><span id="l52.122">           let iTab, tab, tabNode;</span>
<a href="#l52.123"></a><span id="l52.123">           if (aTabIndexNodeOrInfo == null) {</span>
<a href="#l52.124"></a><span id="l52.124">             if (!aDefaultToCurrent)</span>
<a href="#l52.125"></a><span id="l52.125" class="difflineminus">-              throw Error(&quot;You need to specify a tab!&quot;);</span>
<a href="#l52.126"></a><span id="l52.126" class="difflineplus">+              throw new Error(&quot;You need to specify a tab!&quot;);</span>
<a href="#l52.127"></a><span id="l52.127">             iTab = this.tabContainer.selectedIndex;</span>
<a href="#l52.128"></a><span id="l52.128">             return [iTab, this.tabInfo[iTab],</span>
<a href="#l52.129"></a><span id="l52.129">                     this.tabContainer.childNodes[iTab]];</span>
<a href="#l52.130"></a><span id="l52.130">           }</span>
<a href="#l52.131"></a><span id="l52.131"> </span>
<a href="#l52.132"></a><span id="l52.132">           if (typeof(aTabIndexNodeOrInfo) == &quot;number&quot;) {</span>
<a href="#l52.133"></a><span id="l52.133">             iTab = aTabIndexNodeOrInfo;</span>
<a href="#l52.134"></a><span id="l52.134">             tabNode = this.tabContainer.childNodes[iTab];</span>
<a href="#l52.135"></a><span id="l52.135">             tab = this.tabInfo[iTab];</span>
<a href="#l52.136"></a><span id="l52.136" class="difflineminus">-          }</span>
<a href="#l52.137"></a><span id="l52.137" class="difflineminus">-          else if (aTabIndexNodeOrInfo.tagName &amp;&amp; aTabIndexNodeOrInfo.tagName == &quot;tab&quot;) {</span>
<a href="#l52.138"></a><span id="l52.138" class="difflineplus">+          } else if (aTabIndexNodeOrInfo.tagName &amp;&amp; aTabIndexNodeOrInfo.tagName == &quot;tab&quot;) {</span>
<a href="#l52.139"></a><span id="l52.139">             tabNode = aTabIndexNodeOrInfo;</span>
<a href="#l52.140"></a><span id="l52.140">             iTab = this.tabContainer.getIndexOfItem(tabNode);</span>
<a href="#l52.141"></a><span id="l52.141">             tab = this.tabInfo[iTab];</span>
<a href="#l52.142"></a><span id="l52.142" class="difflineminus">-          }</span>
<a href="#l52.143"></a><span id="l52.143" class="difflineminus">-          else {</span>
<a href="#l52.144"></a><span id="l52.144" class="difflineplus">+          } else {</span>
<a href="#l52.145"></a><span id="l52.145">             tab = aTabIndexNodeOrInfo;</span>
<a href="#l52.146"></a><span id="l52.146">             iTab = this.tabInfo.indexOf(tab);</span>
<a href="#l52.147"></a><span id="l52.147">             tabNode = (iTab &gt;= 0) ? this.tabContainer.childNodes[iTab] : null;</span>
<a href="#l52.148"></a><span id="l52.148">           }</span>
<a href="#l52.149"></a><span id="l52.149"> </span>
<a href="#l52.150"></a><span id="l52.150">           return [iTab, tab, tabNode];</span>
<a href="#l52.151"></a><span id="l52.151">         ]]&gt;&lt;/body&gt;</span>
<a href="#l52.152"></a><span id="l52.152">       &lt;/method&gt;</span>
<a href="#l52.153"></a><span id="l52.153" class="difflineat">@@ -481,20 +479,18 @@</span>
<a href="#l52.154"></a><span id="l52.154">           if (tabMode.tabs.length == tabMode.maxTabs) {</span>
<a href="#l52.155"></a><span id="l52.155">             let desiredTab = tabMode.tabs[0];</span>
<a href="#l52.156"></a><span id="l52.156">             this.tabContainer.selectedIndex = this.tabInfo.indexOf(desiredTab);</span>
<a href="#l52.157"></a><span id="l52.157">             return null;</span>
<a href="#l52.158"></a><span id="l52.158">           }</span>
<a href="#l52.159"></a><span id="l52.159"> </span>
<a href="#l52.160"></a><span id="l52.160">           // For &quot;glodaFacet&quot; tab mode, if aArgs is omitted,</span>
<a href="#l52.161"></a><span id="l52.161">           // default to a blank user search.</span>
<a href="#l52.162"></a><span id="l52.162" class="difflineminus">-          if (aTabModeName==&quot;glodaFacet&quot; &amp;&amp; !aArgs) {</span>
<a href="#l52.163"></a><span id="l52.163" class="difflineminus">-            aArgs = {</span>
<a href="#l52.164"></a><span id="l52.164" class="difflineminus">-              searcher: new GlodaMsgSearcher(null, &quot;&quot;)</span>
<a href="#l52.165"></a><span id="l52.165" class="difflineminus">-            };</span>
<a href="#l52.166"></a><span id="l52.166" class="difflineplus">+          if (aTabModeName == &quot;glodaFacet&quot; &amp;&amp; !aArgs) {</span>
<a href="#l52.167"></a><span id="l52.167" class="difflineplus">+            aArgs = { searcher: new GlodaMsgSearcher(null, &quot;&quot;) };</span>
<a href="#l52.168"></a><span id="l52.168">           }</span>
<a href="#l52.169"></a><span id="l52.169"> </span>
<a href="#l52.170"></a><span id="l52.170">           // Do this so that we don't generate strict warnings</span>
<a href="#l52.171"></a><span id="l52.171">           let background = (&quot;background&quot; in aArgs) &amp;&amp; aArgs.background;</span>
<a href="#l52.172"></a><span id="l52.172"> </span>
<a href="#l52.173"></a><span id="l52.173">           // If the mode wants us to, we should switch to an existing tab</span>
<a href="#l52.174"></a><span id="l52.174">           // rather than open a new one. We shouldn't switch to the tab if</span>
<a href="#l52.175"></a><span id="l52.175">           // we're opening it in the background, though.</span>
<a href="#l52.176"></a><span id="l52.176" class="difflineat">@@ -614,17 +610,17 @@</span>
<a href="#l52.177"></a><span id="l52.177">           this._mostRecentTabInfo = null;</span>
<a href="#l52.178"></a><span id="l52.178"> </span>
<a href="#l52.179"></a><span id="l52.179">           t.setAttribute(&quot;label&quot;, tab.title);</span>
<a href="#l52.180"></a><span id="l52.180"> </span>
<a href="#l52.181"></a><span id="l52.181">           if (!background)</span>
<a href="#l52.182"></a><span id="l52.182">             this.setDocumentTitle(tab);</span>
<a href="#l52.183"></a><span id="l52.183"> </span>
<a href="#l52.184"></a><span id="l52.184">           // for styling purposes, apply the type to the tab...</span>
<a href="#l52.185"></a><span id="l52.185" class="difflineminus">-          t.setAttribute('type', tab.mode.type);</span>
<a href="#l52.186"></a><span id="l52.186" class="difflineplus">+          t.setAttribute(&quot;type&quot;, tab.mode.type);</span>
<a href="#l52.187"></a><span id="l52.187"> </span>
<a href="#l52.188"></a><span id="l52.188">           if (!background)</span>
<a href="#l52.189"></a><span id="l52.189">             // Update the toolbar status - we don't need to do menus as they</span>
<a href="#l52.190"></a><span id="l52.190">             // do themselves when we open them.</span>
<a href="#l52.191"></a><span id="l52.191">             UpdateMailToolbar(&quot;tabmail&quot;);</span>
<a href="#l52.192"></a><span id="l52.192"> </span>
<a href="#l52.193"></a><span id="l52.193">           let moving = restoreState ? restoreState.moving : null;</span>
<a href="#l52.194"></a><span id="l52.194"> </span>
<a href="#l52.195"></a><span id="l52.195" class="difflineat">@@ -702,40 +698,39 @@</span>
<a href="#l52.196"></a><span id="l52.196">           // If we're in the middle of opening a new tab</span>
<a href="#l52.197"></a><span id="l52.197">           // (this._mostRecentTabInfo is non-null), we shouldn't consider the</span>
<a href="#l52.198"></a><span id="l52.198">           // current tab</span>
<a href="#l52.199"></a><span id="l52.199">           let tabToConsider = this._mostRecentTabInfo || this.currentTabInfo;</span>
<a href="#l52.200"></a><span id="l52.200">           if (tabToConsider &amp;&amp; tabToConsider.mode == aTabMode)</span>
<a href="#l52.201"></a><span id="l52.201">             return tabToConsider;</span>
<a href="#l52.202"></a><span id="l52.202">           else if (aTabMode.tabs.length)</span>
<a href="#l52.203"></a><span id="l52.203">             return aTabMode.tabs[0];</span>
<a href="#l52.204"></a><span id="l52.204" class="difflineminus">-          else</span>
<a href="#l52.205"></a><span id="l52.205" class="difflineminus">-            return null;</span>
<a href="#l52.206"></a><span id="l52.206" class="difflineplus">+          return null;</span>
<a href="#l52.207"></a><span id="l52.207">         ]]&gt;&lt;/body&gt;</span>
<a href="#l52.208"></a><span id="l52.208">       &lt;/method&gt;</span>
<a href="#l52.209"></a><span id="l52.209">       &lt;method name=&quot;undoCloseTab&quot;&gt;</span>
<a href="#l52.210"></a><span id="l52.210">         &lt;parameter name=&quot;aIdx&quot;/&gt;</span>
<a href="#l52.211"></a><span id="l52.211">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l52.212"></a><span id="l52.212"> </span>
<a href="#l52.213"></a><span id="l52.213">           if (!this.recentlyClosedTabs.length)</span>
<a href="#l52.214"></a><span id="l52.214">             return;</span>
<a href="#l52.215"></a><span id="l52.215"> </span>
<a href="#l52.216"></a><span id="l52.216">           if (aIdx &gt;= this.recentlyClosedTabs.length)</span>
<a href="#l52.217"></a><span id="l52.217" class="difflineminus">-            aIdx = this.recentlyClosedTabs.length-1;</span>
<a href="#l52.218"></a><span id="l52.218" class="difflineplus">+            aIdx = this.recentlyClosedTabs.length - 1;</span>
<a href="#l52.219"></a><span id="l52.219"> </span>
<a href="#l52.220"></a><span id="l52.220">           // splice always returns an array</span>
<a href="#l52.221"></a><span id="l52.221" class="difflineminus">-          let history = (this.recentlyClosedTabs.splice(aIdx,1))[0];</span>
<a href="#l52.222"></a><span id="l52.222" class="difflineplus">+          let history = (this.recentlyClosedTabs.splice(aIdx, 1))[0];</span>
<a href="#l52.223"></a><span id="l52.223"> </span>
<a href="#l52.224"></a><span id="l52.224">           if (!history.tab)</span>
<a href="#l52.225"></a><span id="l52.225">             return;</span>
<a href="#l52.226"></a><span id="l52.226"> </span>
<a href="#l52.227"></a><span id="l52.227">           if (!this.restoreTab(JSON.parse(history.tab)))</span>
<a href="#l52.228"></a><span id="l52.228">             return;</span>
<a href="#l52.229"></a><span id="l52.229"> </span>
<a href="#l52.230"></a><span id="l52.230" class="difflineminus">-          let idx = Math.min(history.idx,this.tabInfo.length);</span>
<a href="#l52.231"></a><span id="l52.231" class="difflineplus">+          let idx = Math.min(history.idx, this.tabInfo.length);</span>
<a href="#l52.232"></a><span id="l52.232">           let tab = this.tabContainer.childNodes[this.tabInfo.length - 1];</span>
<a href="#l52.233"></a><span id="l52.233">           this.moveTabTo(tab, idx);</span>
<a href="#l52.234"></a><span id="l52.234"> </span>
<a href="#l52.235"></a><span id="l52.235">           this.switchToTab(tab);</span>
<a href="#l52.236"></a><span id="l52.236"> </span>
<a href="#l52.237"></a><span id="l52.237">         ]]&gt;&lt;/body&gt;</span>
<a href="#l52.238"></a><span id="l52.238">       &lt;/method&gt;</span>
<a href="#l52.239"></a><span id="l52.239">       &lt;method name=&quot;closeTab&quot;&gt;</span>
<a href="#l52.240"></a><span id="l52.240" class="difflineat">@@ -755,17 +750,17 @@</span>
<a href="#l52.241"></a><span id="l52.241">             // exercise their right to prompt the user for confirmation before</span>
<a href="#l52.242"></a><span id="l52.242">             // closing.</span>
<a href="#l52.243"></a><span id="l52.243">             let tryCloseFunc = tab.mode.tryCloseTab || tab.mode.tabType.tryCloseTab;</span>
<a href="#l52.244"></a><span id="l52.244">             if (tryCloseFunc &amp;&amp; !tryCloseFunc.call(tab.mode.tabType, tab))</span>
<a href="#l52.245"></a><span id="l52.245">               return;</span>
<a href="#l52.246"></a><span id="l52.246"> </span>
<a href="#l52.247"></a><span id="l52.247">             let evt = new CustomEvent(&quot;TabClose&quot;, {</span>
<a href="#l52.248"></a><span id="l52.248">               bubbles: true,</span>
<a href="#l52.249"></a><span id="l52.249" class="difflineminus">-              detail: { tabInfo: tab, moving: tab.moving }</span>
<a href="#l52.250"></a><span id="l52.250" class="difflineplus">+              detail: { tabInfo: tab, moving: tab.moving },</span>
<a href="#l52.251"></a><span id="l52.251">             });</span>
<a href="#l52.252"></a><span id="l52.252">             tabNode.dispatchEvent(evt);</span>
<a href="#l52.253"></a><span id="l52.253"> </span>
<a href="#l52.254"></a><span id="l52.254">             for (let tabMonitor of this.tabMonitors) {</span>
<a href="#l52.255"></a><span id="l52.255">               if (&quot;onTabClosing&quot; in tabMonitor)</span>
<a href="#l52.256"></a><span id="l52.256">                 tabMonitor.onTabClosing(tab);</span>
<a href="#l52.257"></a><span id="l52.257">             }</span>
<a href="#l52.258"></a><span id="l52.258"> </span>
<a href="#l52.259"></a><span id="l52.259" class="difflineat">@@ -831,18 +826,17 @@</span>
<a href="#l52.260"></a><span id="l52.260">         &lt;parameter name=&quot;aTabNode&quot;/&gt;</span>
<a href="#l52.261"></a><span id="l52.261">         &lt;parameter name=&quot;aNoUndo&quot;/&gt;</span>
<a href="#l52.262"></a><span id="l52.262">         &lt;body&gt;</span>
<a href="#l52.263"></a><span id="l52.263">           &lt;![CDATA[</span>
<a href="#l52.264"></a><span id="l52.264">             /**</span>
<a href="#l52.265"></a><span id="l52.265">              * Given a tabNode (or tabby thing), close all of the other tabs</span>
<a href="#l52.266"></a><span id="l52.266">              *  that are closeable.</span>
<a href="#l52.267"></a><span id="l52.267">              */</span>
<a href="#l52.268"></a><span id="l52.268" class="difflineminus">-            let [iTab, thisTab, tabNode] = this._getTabContextForTabbyThing(</span>
<a href="#l52.269"></a><span id="l52.269" class="difflineminus">-                                           aTabNode, false);</span>
<a href="#l52.270"></a><span id="l52.270" class="difflineplus">+            let [, thisTab] = this._getTabContextForTabbyThing(aTabNode, false);</span>
<a href="#l52.271"></a><span id="l52.271"> </span>
<a href="#l52.272"></a><span id="l52.272">             // closeTab mutates the tabInfo array, so start from the end.</span>
<a href="#l52.273"></a><span id="l52.273">             for (let i = this.tabInfo.length - 1; i &gt;= 0; i--) {</span>
<a href="#l52.274"></a><span id="l52.274">               let tab = this.tabInfo[i];</span>
<a href="#l52.275"></a><span id="l52.275">               if ((tab != thisTab) &amp;&amp; tab.canClose)</span>
<a href="#l52.276"></a><span id="l52.276">                 this.closeTab(tab, aNoUndo);</span>
<a href="#l52.277"></a><span id="l52.277">             }</span>
<a href="#l52.278"></a><span id="l52.278">           ]]&gt;</span>
<a href="#l52.279"></a><span id="l52.279" class="difflineat">@@ -875,17 +869,17 @@</span>
<a href="#l52.280"></a><span id="l52.280">             // TabOpen events.</span>
<a href="#l52.281"></a><span id="l52.281">             let moveSession = Cc[&quot;@mozilla.org/uuid-generator;1&quot;]</span>
<a href="#l52.282"></a><span id="l52.282">               .getService(Ci.nsIUUIDGenerator)</span>
<a href="#l52.283"></a><span id="l52.283">               .generateUUID().toString();</span>
<a href="#l52.284"></a><span id="l52.284"> </span>
<a href="#l52.285"></a><span id="l52.285">             tab.moving = moveSession;</span>
<a href="#l52.286"></a><span id="l52.286">             aTab.moving = moveSession;</span>
<a href="#l52.287"></a><span id="l52.287"> </span>
<a href="#l52.288"></a><span id="l52.288" class="difflineminus">-            this.closeTab(aTab,true);</span>
<a href="#l52.289"></a><span id="l52.289" class="difflineplus">+            this.closeTab(aTab, true);</span>
<a href="#l52.290"></a><span id="l52.290"> </span>
<a href="#l52.291"></a><span id="l52.291">             if (aTargetWindow &amp;&amp; aTargetWindow !== &quot;popup&quot;) {</span>
<a href="#l52.292"></a><span id="l52.292">               let targetTabmail = aTargetWindow.document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l52.293"></a><span id="l52.293">               targetTabmail.restoreTab(tab);</span>
<a href="#l52.294"></a><span id="l52.294"> </span>
<a href="#l52.295"></a><span id="l52.295">               if (aTargetPosition) {</span>
<a href="#l52.296"></a><span id="l52.296">                 let droppedTab = targetTabmail.tabInfo[targetTabmail.tabInfo.length - 1];</span>
<a href="#l52.297"></a><span id="l52.297">                 targetTabmail.moveTabTo(droppedTab, aTargetPosition);</span>
<a href="#l52.298"></a><span id="l52.298" class="difflineat">@@ -896,17 +890,17 @@</span>
<a href="#l52.299"></a><span id="l52.299">             if (aTargetWindow === &quot;popup&quot;) {</span>
<a href="#l52.300"></a><span id="l52.300">               features.push(&quot;dialog&quot;, &quot;resizable&quot;, &quot;minimizable&quot;, &quot;centerscreen&quot;, &quot;titlebar&quot;, &quot;close&quot;);</span>
<a href="#l52.301"></a><span id="l52.301">             } else {</span>
<a href="#l52.302"></a><span id="l52.302">               features.push(&quot;dialog=no&quot;, &quot;all&quot;, &quot;status&quot;, &quot;toolbar&quot;);</span>
<a href="#l52.303"></a><span id="l52.303">             }</span>
<a href="#l52.304"></a><span id="l52.304"> </span>
<a href="#l52.305"></a><span id="l52.305">             return window.openDialog(&quot;chrome://messenger/content/&quot;, &quot;_blank&quot;,</span>
<a href="#l52.306"></a><span id="l52.306">               features.join(&quot;,&quot;), null,</span>
<a href="#l52.307"></a><span id="l52.307" class="difflineminus">-              { action : &quot;restore&quot;, tabs: [tab] } ).focus();</span>
<a href="#l52.308"></a><span id="l52.308" class="difflineplus">+              { action: &quot;restore&quot;, tabs: [tab] }).focus();</span>
<a href="#l52.309"></a><span id="l52.309">           ]]&gt;</span>
<a href="#l52.310"></a><span id="l52.310">         &lt;/body&gt;</span>
<a href="#l52.311"></a><span id="l52.311">       &lt;/method&gt;</span>
<a href="#l52.312"></a><span id="l52.312">       &lt;method name=&quot;moveTabTo&quot;&gt;</span>
<a href="#l52.313"></a><span id="l52.313">         &lt;parameter name=&quot;aTabIndexNodeOrInfo&quot;/&gt;</span>
<a href="#l52.314"></a><span id="l52.314">         &lt;parameter name=&quot;aIndex&quot;/&gt;</span>
<a href="#l52.315"></a><span id="l52.315">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l52.316"></a><span id="l52.316">           let [oldIdx, tab, tabNode] =</span>
<a href="#l52.317"></a><span id="l52.317" class="difflineat">@@ -948,17 +942,17 @@</span>
<a href="#l52.318"></a><span id="l52.318"> </span>
<a href="#l52.319"></a><span id="l52.319">             modeIdx = i;</span>
<a href="#l52.320"></a><span id="l52.320">             break;</span>
<a href="#l52.321"></a><span id="l52.321">           }</span>
<a href="#l52.322"></a><span id="l52.322"> </span>
<a href="#l52.323"></a><span id="l52.323">           tab.mode.tabs.splice(modeIdx, 0, tab);</span>
<a href="#l52.324"></a><span id="l52.324"> </span>
<a href="#l52.325"></a><span id="l52.325">           let evt = new CustomEvent(&quot;TabMove&quot;, {</span>
<a href="#l52.326"></a><span id="l52.326" class="difflineminus">-            bubbles: true, view: window, detail: { idx: oldIdx, tabInfo: tab }</span>
<a href="#l52.327"></a><span id="l52.327" class="difflineplus">+            bubbles: true, view: window, detail: { idx: oldIdx, tabInfo: tab },</span>
<a href="#l52.328"></a><span id="l52.328">           });</span>
<a href="#l52.329"></a><span id="l52.329">           tabNode.dispatchEvent(evt);</span>
<a href="#l52.330"></a><span id="l52.330"> </span>
<a href="#l52.331"></a><span id="l52.331">           return aIndex;</span>
<a href="#l52.332"></a><span id="l52.332">          ]]&gt;</span>
<a href="#l52.333"></a><span id="l52.333">          &lt;/body&gt;</span>
<a href="#l52.334"></a><span id="l52.334">        &lt;/method&gt;</span>
<a href="#l52.335"></a><span id="l52.335">        &lt;method name=&quot;persistTab&quot;&gt;</span>
<a href="#l52.336"></a><span id="l52.336" class="difflineat">@@ -978,18 +972,17 @@</span>
<a href="#l52.337"></a><span id="l52.337">            //  to avoid bugs and because we may eventually let extensions store</span>
<a href="#l52.338"></a><span id="l52.338">            //  per-tab information in the persisted state.</span>
<a href="#l52.339"></a><span id="l52.339"> </span>
<a href="#l52.340"></a><span id="l52.340">            let tabState;</span>
<a href="#l52.341"></a><span id="l52.341">            // Wrap this in an exception handler so that if the persistence</span>
<a href="#l52.342"></a><span id="l52.342">            // logic fails, things like tab closure still run to completion.</span>
<a href="#l52.343"></a><span id="l52.343">            try {</span>
<a href="#l52.344"></a><span id="l52.344">              tabState = persistFunc.call(tab.mode.tabType, tab);</span>
<a href="#l52.345"></a><span id="l52.345" class="difflineminus">-           }</span>
<a href="#l52.346"></a><span id="l52.346" class="difflineminus">-           catch(ex) {</span>
<a href="#l52.347"></a><span id="l52.347" class="difflineplus">+           } catch (ex) {</span>
<a href="#l52.348"></a><span id="l52.348">              // Report this so that our unit testing framework sees this</span>
<a href="#l52.349"></a><span id="l52.349">              // error and (extension) developers likewise can see when their</span>
<a href="#l52.350"></a><span id="l52.350">              // extensions are ill-behaved.</span>
<a href="#l52.351"></a><span id="l52.351">              Cu.reportError(ex);</span>
<a href="#l52.352"></a><span id="l52.352">            }</span>
<a href="#l52.353"></a><span id="l52.353"> </span>
<a href="#l52.354"></a><span id="l52.354">            if (!tabState)</span>
<a href="#l52.355"></a><span id="l52.355">              return null;</span>
<a href="#l52.356"></a><span id="l52.356" class="difflineat">@@ -999,17 +992,17 @@</span>
<a href="#l52.357"></a><span id="l52.357">            for (let tabMonitor of this.tabMonitors) {</span>
<a href="#l52.358"></a><span id="l52.358">              if (&quot;onTabPersist&quot; in tabMonitor) {</span>
<a href="#l52.359"></a><span id="l52.359">                let monState = tabMonitor.onTabPersist(tab);</span>
<a href="#l52.360"></a><span id="l52.360">                if (monState !== null)</span>
<a href="#l52.361"></a><span id="l52.361">                  ext[tabMonitor.monitorName] = monState;</span>
<a href="#l52.362"></a><span id="l52.362">              }</span>
<a href="#l52.363"></a><span id="l52.363">            }</span>
<a href="#l52.364"></a><span id="l52.364"> </span>
<a href="#l52.365"></a><span id="l52.365" class="difflineminus">-           return {mode: tab.mode.name, state: tabState, ext: ext}</span>
<a href="#l52.366"></a><span id="l52.366" class="difflineplus">+           return {mode: tab.mode.name, state: tabState, ext};</span>
<a href="#l52.367"></a><span id="l52.367">         ]]&gt;&lt;/body&gt;</span>
<a href="#l52.368"></a><span id="l52.368">       &lt;/method&gt;</span>
<a href="#l52.369"></a><span id="l52.369"> </span>
<a href="#l52.370"></a><span id="l52.370">       &lt;method name=&quot;persistTabs&quot;&gt;</span>
<a href="#l52.371"></a><span id="l52.371">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l52.372"></a><span id="l52.372">           /**</span>
<a href="#l52.373"></a><span id="l52.373">            * Persist the state of all tab modes implementing persistTab methods</span>
<a href="#l52.374"></a><span id="l52.374">            *  to a JSON-serializable object representation and return it.  Call</span>
<a href="#l52.375"></a><span id="l52.375" class="difflineat">@@ -1219,29 +1212,28 @@</span>
<a href="#l52.376"></a><span id="l52.376">           this.removeTabByNode(</span>
<a href="#l52.377"></a><span id="l52.377">             this.tabContainer.childNodes[this.tabContainer.selectedIndex]);</span>
<a href="#l52.378"></a><span id="l52.378">         ]]&gt;&lt;/body&gt;</span>
<a href="#l52.379"></a><span id="l52.379">       &lt;/method&gt;</span>
<a href="#l52.380"></a><span id="l52.380">       &lt;method name=&quot;switchToTab&quot;&gt;</span>
<a href="#l52.381"></a><span id="l52.381">         &lt;parameter name=&quot;aTabIndexNodeOrInfo&quot;/&gt;</span>
<a href="#l52.382"></a><span id="l52.382">         &lt;body&gt;</span>
<a href="#l52.383"></a><span id="l52.383">           &lt;![CDATA[</span>
<a href="#l52.384"></a><span id="l52.384" class="difflineminus">-            let [iTab, tab, tabNode] =</span>
<a href="#l52.385"></a><span id="l52.385" class="difflineplus">+            let [iTab] =</span>
<a href="#l52.386"></a><span id="l52.386">               this._getTabContextForTabbyThing(aTabIndexNodeOrInfo, false);</span>
<a href="#l52.387"></a><span id="l52.387"> </span>
<a href="#l52.388"></a><span id="l52.388">             this.tabContainer.selectedIndex = iTab;</span>
<a href="#l52.389"></a><span id="l52.389">           ]]&gt;</span>
<a href="#l52.390"></a><span id="l52.390">         &lt;/body&gt;</span>
<a href="#l52.391"></a><span id="l52.391">       &lt;/method&gt;</span>
<a href="#l52.392"></a><span id="l52.392">       &lt;!--  UpdateCurrentTab - called in response to changing the current tab --&gt;</span>
<a href="#l52.393"></a><span id="l52.393">       &lt;method name=&quot;updateCurrentTab&quot;&gt;</span>
<a href="#l52.394"></a><span id="l52.394">         &lt;body&gt;</span>
<a href="#l52.395"></a><span id="l52.395">           &lt;![CDATA[</span>
<a href="#l52.396"></a><span id="l52.396" class="difflineminus">-            if (this.currentTabInfo != this.tabInfo[this.tabContainer.selectedIndex])</span>
<a href="#l52.397"></a><span id="l52.397" class="difflineminus">-            {</span>
<a href="#l52.398"></a><span id="l52.398" class="difflineplus">+            if (this.currentTabInfo != this.tabInfo[this.tabContainer.selectedIndex]) {</span>
<a href="#l52.399"></a><span id="l52.399">               if (this.currentTabInfo)</span>
<a href="#l52.400"></a><span id="l52.400">                 this.saveCurrentTabState();</span>
<a href="#l52.401"></a><span id="l52.401"> </span>
<a href="#l52.402"></a><span id="l52.402">               let oldTab = this.currentTabInfo;</span>
<a href="#l52.403"></a><span id="l52.403">               let oldPanel = [...this.panelContainer.children].find(p =&gt; p.hasAttribute(&quot;selected&quot;));</span>
<a href="#l52.404"></a><span id="l52.404">               let tab = this.currentTabInfo =</span>
<a href="#l52.405"></a><span id="l52.405">                 this.tabInfo[this.tabContainer.selectedIndex];</span>
<a href="#l52.406"></a><span id="l52.406"> </span>
<a href="#l52.407"></a><span id="l52.407" class="difflineat">@@ -1299,32 +1291,31 @@</span>
<a href="#l52.408"></a><span id="l52.408">           ]]&gt;</span>
<a href="#l52.409"></a><span id="l52.409">         &lt;/body&gt;</span>
<a href="#l52.410"></a><span id="l52.410">       &lt;/method&gt;</span>
<a href="#l52.411"></a><span id="l52.411">       &lt;method name=&quot;onTabClick&quot;&gt;</span>
<a href="#l52.412"></a><span id="l52.412">         &lt;parameter name=&quot;event&quot;/&gt;</span>
<a href="#l52.413"></a><span id="l52.413">         &lt;body&gt;</span>
<a href="#l52.414"></a><span id="l52.414">           &lt;![CDATA[</span>
<a href="#l52.415"></a><span id="l52.415">             // a middle mouse button click on a tab is a short cut for closing a tab</span>
<a href="#l52.416"></a><span id="l52.416" class="difflineminus">-            if (event.button != 1 || event.target.localName != 'tab')</span>
<a href="#l52.417"></a><span id="l52.417" class="difflineplus">+            if (event.button != 1 || event.target.localName != &quot;tab&quot;)</span>
<a href="#l52.418"></a><span id="l52.418">               return;</span>
<a href="#l52.419"></a><span id="l52.419">             this.removeTabByNode(event.target);</span>
<a href="#l52.420"></a><span id="l52.420">             event.stopPropagation();</span>
<a href="#l52.421"></a><span id="l52.421">           ]]&gt;</span>
<a href="#l52.422"></a><span id="l52.422">         &lt;/body&gt;</span>
<a href="#l52.423"></a><span id="l52.423">       &lt;/method&gt;</span>
<a href="#l52.424"></a><span id="l52.424">       &lt;method name=&quot;setTabTitle&quot;&gt;</span>
<a href="#l52.425"></a><span id="l52.425">         &lt;parameter name=&quot;aTabNodeOrInfo&quot;/&gt;</span>
<a href="#l52.426"></a><span id="l52.426">         &lt;body&gt;</span>
<a href="#l52.427"></a><span id="l52.427">           &lt;![CDATA[</span>
<a href="#l52.428"></a><span id="l52.428" class="difflineminus">-            let [iTab, tab, tabNode] =</span>
<a href="#l52.429"></a><span id="l52.429" class="difflineplus">+            let [iTab, tab] =</span>
<a href="#l52.430"></a><span id="l52.430">               this._getTabContextForTabbyThing(aTabNodeOrInfo, true);</span>
<a href="#l52.431"></a><span id="l52.431"> </span>
<a href="#l52.432"></a><span id="l52.432" class="difflineminus">-            if (tab)</span>
<a href="#l52.433"></a><span id="l52.433" class="difflineminus">-            {</span>
<a href="#l52.434"></a><span id="l52.434" class="difflineplus">+            if (tab) {</span>
<a href="#l52.435"></a><span id="l52.435">               let tabNode =</span>
<a href="#l52.436"></a><span id="l52.436">                 this.tabContainer.childNodes[iTab];</span>
<a href="#l52.437"></a><span id="l52.437"> </span>
<a href="#l52.438"></a><span id="l52.438">               let titleChangeFunc = tab.mode.onTitleChanged ||</span>
<a href="#l52.439"></a><span id="l52.439">                                     tab.mode.tabType.onTitleChanged;</span>
<a href="#l52.440"></a><span id="l52.440">               if (titleChangeFunc) {</span>
<a href="#l52.441"></a><span id="l52.441">                 titleChangeFunc.call(tab.mode.tabType, tab, tabNode);</span>
<a href="#l52.442"></a><span id="l52.442">               }</span>
<a href="#l52.443"></a><span id="l52.443" class="difflineat">@@ -1349,45 +1340,45 @@</span>
<a href="#l52.444"></a><span id="l52.444">               if (iTab == this.tabContainer.selectedIndex)</span>
<a href="#l52.445"></a><span id="l52.445">                 this.setDocumentTitle(tab);</span>
<a href="#l52.446"></a><span id="l52.446"> </span>
<a href="#l52.447"></a><span id="l52.447">               // Notify tab title change</span>
<a href="#l52.448"></a><span id="l52.448">               if (!tab.beforeTabOpen) {</span>
<a href="#l52.449"></a><span id="l52.449">                 let evt = new CustomEvent(&quot;TabAttrModified&quot;, {</span>
<a href="#l52.450"></a><span id="l52.450">                   bubbles: true,</span>
<a href="#l52.451"></a><span id="l52.451">                   cancelable: false,</span>
<a href="#l52.452"></a><span id="l52.452" class="difflineminus">-                  detail: { changed: [&quot;label&quot;], tabInfo: tab }</span>
<a href="#l52.453"></a><span id="l52.453" class="difflineplus">+                  detail: { changed: [&quot;label&quot;], tabInfo: tab },</span>
<a href="#l52.454"></a><span id="l52.454">                 });</span>
<a href="#l52.455"></a><span id="l52.455">                 tabNode.dispatchEvent(evt);</span>
<a href="#l52.456"></a><span id="l52.456">               }</span>
<a href="#l52.457"></a><span id="l52.457">             }</span>
<a href="#l52.458"></a><span id="l52.458">           ]]&gt;</span>
<a href="#l52.459"></a><span id="l52.459">         &lt;/body&gt;</span>
<a href="#l52.460"></a><span id="l52.460">       &lt;/method&gt;</span>
<a href="#l52.461"></a><span id="l52.461">       &lt;!--</span>
<a href="#l52.462"></a><span id="l52.462">         - Sets the tab icon to the specified url, or removes the icon if no</span>
<a href="#l52.463"></a><span id="l52.463">         - url is specified. Note that this may override css provided images.</span>
<a href="#l52.464"></a><span id="l52.464">         --&gt;</span>
<a href="#l52.465"></a><span id="l52.465">       &lt;method name=&quot;setTabIcon&quot;&gt;</span>
<a href="#l52.466"></a><span id="l52.466">         &lt;parameter name=&quot;aTabNodeOrInfo&quot;/&gt;</span>
<a href="#l52.467"></a><span id="l52.467">         &lt;parameter name=&quot;aIcon&quot;/&gt;</span>
<a href="#l52.468"></a><span id="l52.468">         &lt;body&gt;</span>
<a href="#l52.469"></a><span id="l52.469">           &lt;![CDATA[</span>
<a href="#l52.470"></a><span id="l52.470" class="difflineminus">-            let [iTab, tab, tabNode] =</span>
<a href="#l52.471"></a><span id="l52.471" class="difflineplus">+            let [iTab, tab] =</span>
<a href="#l52.472"></a><span id="l52.472">               this._getTabContextForTabbyThing(aTabNodeOrInfo, true);</span>
<a href="#l52.473"></a><span id="l52.473"> </span>
<a href="#l52.474"></a><span id="l52.474">             if (tab) {</span>
<a href="#l52.475"></a><span id="l52.475">               let tabNode = this.tabContainer.childNodes[iTab];</span>
<a href="#l52.476"></a><span id="l52.476">               let oldIcon = tabNode.getAttribute(&quot;image&quot;);</span>
<a href="#l52.477"></a><span id="l52.477"> </span>
<a href="#l52.478"></a><span id="l52.478">               if (oldIcon != aIcon &amp;&amp; !tab.beforeTabOpen) {</span>
<a href="#l52.479"></a><span id="l52.479">                 let evt = new CustomEvent(&quot;TabAttrModified&quot;, {</span>
<a href="#l52.480"></a><span id="l52.480">                   bubbles: true,</span>
<a href="#l52.481"></a><span id="l52.481">                   cancelable: false,</span>
<a href="#l52.482"></a><span id="l52.482" class="difflineminus">-                  detail: { changed: [&quot;image&quot;], tabInfo: tab }</span>
<a href="#l52.483"></a><span id="l52.483" class="difflineplus">+                  detail: { changed: [&quot;image&quot;], tabInfo: tab },</span>
<a href="#l52.484"></a><span id="l52.484">                 });</span>
<a href="#l52.485"></a><span id="l52.485">                 tabNode.dispatchEvent(evt);</span>
<a href="#l52.486"></a><span id="l52.486">               }</span>
<a href="#l52.487"></a><span id="l52.487"> </span>
<a href="#l52.488"></a><span id="l52.488">               if (aIcon)</span>
<a href="#l52.489"></a><span id="l52.489">                 tabNode.setAttribute(&quot;image&quot;, aIcon);</span>
<a href="#l52.490"></a><span id="l52.490">               else</span>
<a href="#l52.491"></a><span id="l52.491">                 tabNode.removeAttribute(&quot;image&quot;);</span>
<a href="#l52.492"></a><span id="l52.492" class="difflineat">@@ -1402,18 +1393,17 @@</span>
<a href="#l52.493"></a><span id="l52.493">       &lt;method name=&quot;_setActiveThinkingState&quot;&gt;</span>
<a href="#l52.494"></a><span id="l52.494">         &lt;parameter name=&quot;aThinkingState&quot;/&gt;</span>
<a href="#l52.495"></a><span id="l52.495">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l52.496"></a><span id="l52.496">           if (aThinkingState) {</span>
<a href="#l52.497"></a><span id="l52.497">             statusFeedback.showProgress(0);</span>
<a href="#l52.498"></a><span id="l52.498">             if (typeof(aThinkingState) == &quot;string&quot;)</span>
<a href="#l52.499"></a><span id="l52.499">               statusFeedback.showStatusString(aThinkingState);</span>
<a href="#l52.500"></a><span id="l52.500">             gStatusBar.removeAttribute(&quot;value&quot;);</span>
<a href="#l52.501"></a><span id="l52.501" class="difflineminus">-          }</span>
<a href="#l52.502"></a><span id="l52.502" class="difflineminus">-          else {</span>
<a href="#l52.503"></a><span id="l52.503" class="difflineplus">+          } else {</span>
<a href="#l52.504"></a><span id="l52.504">             statusFeedback.showProgress(0);</span>
<a href="#l52.505"></a><span id="l52.505">             gStatusBar.value = 0;</span>
<a href="#l52.506"></a><span id="l52.506">           }</span>
<a href="#l52.507"></a><span id="l52.507">         ]]&gt;&lt;/body&gt;</span>
<a href="#l52.508"></a><span id="l52.508">       &lt;/method&gt;</span>
<a href="#l52.509"></a><span id="l52.509">       &lt;method name=&quot;setTabThinking&quot;&gt;</span>
<a href="#l52.510"></a><span id="l52.510">         &lt;parameter name=&quot;aTabNodeOrInfo&quot;/&gt;</span>
<a href="#l52.511"></a><span id="l52.511">         &lt;parameter name=&quot;aThinking&quot;/&gt;</span>
<a href="#l52.512"></a><span id="l52.512" class="difflineat">@@ -1425,18 +1415,17 @@</span>
<a href="#l52.513"></a><span id="l52.513"> </span>
<a href="#l52.514"></a><span id="l52.514">             // if we are the current tab, update the cursor</span>
<a href="#l52.515"></a><span id="l52.515">             if (isSelected)</span>
<a href="#l52.516"></a><span id="l52.516">               this._setActiveThinkingState(aThinking);</span>
<a href="#l52.517"></a><span id="l52.517"> </span>
<a href="#l52.518"></a><span id="l52.518">             // if we are busy, hint our tab</span>
<a href="#l52.519"></a><span id="l52.519">             if (aThinking) {</span>
<a href="#l52.520"></a><span id="l52.520">               tabNode.setAttribute(&quot;thinking&quot;, &quot;true&quot;);</span>
<a href="#l52.521"></a><span id="l52.521" class="difflineminus">-            }</span>
<a href="#l52.522"></a><span id="l52.522" class="difflineminus">-            else {</span>
<a href="#l52.523"></a><span id="l52.523" class="difflineplus">+            } else {</span>
<a href="#l52.524"></a><span id="l52.524">               // if we were thinking and are not selected, set the</span>
<a href="#l52.525"></a><span id="l52.525">               //  &quot;wasThinking&quot; attribute.</span>
<a href="#l52.526"></a><span id="l52.526">               if (tab.thinking &amp;&amp; !isSelected)</span>
<a href="#l52.527"></a><span id="l52.527">                 tabNode.setAttribute(&quot;wasThinking&quot;, &quot;true&quot;);</span>
<a href="#l52.528"></a><span id="l52.528">               tabNode.removeAttribute(&quot;thinking&quot;);</span>
<a href="#l52.529"></a><span id="l52.529">             }</span>
<a href="#l52.530"></a><span id="l52.530"> </span>
<a href="#l52.531"></a><span id="l52.531">             // update the tab info to store the busy state.</span>
<a href="#l52.532"></a><span id="l52.532" class="difflineat">@@ -1455,18 +1444,17 @@</span>
<a href="#l52.533"></a><span id="l52.533"> </span>
<a href="#l52.534"></a><span id="l52.534">             // if we are the current tab, update the cursor</span>
<a href="#l52.535"></a><span id="l52.535">             if (isSelected)</span>
<a href="#l52.536"></a><span id="l52.536">               SetBusyCursor(window, aBusy);</span>
<a href="#l52.537"></a><span id="l52.537"> </span>
<a href="#l52.538"></a><span id="l52.538">             // if we are busy, hint our tab</span>
<a href="#l52.539"></a><span id="l52.539">             if (aBusy) {</span>
<a href="#l52.540"></a><span id="l52.540">               tabNode.setAttribute(&quot;busy&quot;, &quot;true&quot;);</span>
<a href="#l52.541"></a><span id="l52.541" class="difflineminus">-            }</span>
<a href="#l52.542"></a><span id="l52.542" class="difflineminus">-            else {</span>
<a href="#l52.543"></a><span id="l52.543" class="difflineplus">+            } else {</span>
<a href="#l52.544"></a><span id="l52.544">               // if we were busy and are not selected, set the</span>
<a href="#l52.545"></a><span id="l52.545">               //  &quot;wasBusy&quot; attribute.</span>
<a href="#l52.546"></a><span id="l52.546">               if (tab.busy &amp;&amp; !isSelected)</span>
<a href="#l52.547"></a><span id="l52.547">                 tabNode.setAttribute(&quot;wasBusy&quot;, &quot;true&quot;);</span>
<a href="#l52.548"></a><span id="l52.548">               tabNode.removeAttribute(&quot;busy&quot;);</span>
<a href="#l52.549"></a><span id="l52.549">             }</span>
<a href="#l52.550"></a><span id="l52.550"> </span>
<a href="#l52.551"></a><span id="l52.551">             // update the tab info to store the busy state.</span>
<a href="#l52.552"></a><span id="l52.552" class="difflineat">@@ -1480,49 +1468,49 @@</span>
<a href="#l52.553"></a><span id="l52.553">           &lt;![CDATA[</span>
<a href="#l52.554"></a><span id="l52.554">             // this happens when the user did not actually-click on a tab but</span>
<a href="#l52.555"></a><span id="l52.555">             // instead on the strip behind it.</span>
<a href="#l52.556"></a><span id="l52.556">             if (aTabNode.localName != &quot;tab&quot;)</span>
<a href="#l52.557"></a><span id="l52.557">               return false;</span>
<a href="#l52.558"></a><span id="l52.558"> </span>
<a href="#l52.559"></a><span id="l52.559">             let tabContextMenu = document.getElementById(&quot;tabContextMenu&quot;);</span>
<a href="#l52.560"></a><span id="l52.560"> </span>
<a href="#l52.561"></a><span id="l52.561" class="difflineminus">-            let tab = this._getTabContextForTabbyThing(aTabNode, true) [1];</span>
<a href="#l52.562"></a><span id="l52.562" class="difflineplus">+            let tab = this._getTabContextForTabbyThing(aTabNode, true)[1];</span>
<a href="#l52.563"></a><span id="l52.563"> </span>
<a href="#l52.564"></a><span id="l52.564">             // by default &quot;close other tabs&quot; is disabled...</span>
<a href="#l52.565"></a><span id="l52.565">             tabContextMenu</span>
<a href="#l52.566"></a><span id="l52.566" class="difflineminus">-              .querySelector('[anonid=&quot;closeOtherTabs&quot;]')</span>
<a href="#l52.567"></a><span id="l52.567" class="difflineminus">-              .setAttribute(&quot;disabled&quot;,&quot;true&quot;);</span>
<a href="#l52.568"></a><span id="l52.568" class="difflineplus">+              .querySelector(`[anonid=&quot;closeOtherTabs&quot;]`)</span>
<a href="#l52.569"></a><span id="l52.569" class="difflineplus">+              .setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l52.570"></a><span id="l52.570"> </span>
<a href="#l52.571"></a><span id="l52.571">             // ... except if we find at least one other tab that can be closed.</span>
<a href="#l52.572"></a><span id="l52.572">             for (let i = 0; i &lt; this.tabInfo.length; i++) {</span>
<a href="#l52.573"></a><span id="l52.573">               if (this.tabInfo[i].canClose &amp;&amp; this.tabInfo[i] != tab) {</span>
<a href="#l52.574"></a><span id="l52.574">                 tabContextMenu</span>
<a href="#l52.575"></a><span id="l52.575" class="difflineminus">-                  .querySelector('[anonid=&quot;closeOtherTabs&quot;]')</span>
<a href="#l52.576"></a><span id="l52.576" class="difflineplus">+                  .querySelector(`[anonid=&quot;closeOtherTabs&quot;]`)</span>
<a href="#l52.577"></a><span id="l52.577">                   .setAttribute(&quot;disabled&quot;, &quot;false&quot;);</span>
<a href="#l52.578"></a><span id="l52.578">                 break;</span>
<a href="#l52.579"></a><span id="l52.579">               }</span>
<a href="#l52.580"></a><span id="l52.580">             }</span>
<a href="#l52.581"></a><span id="l52.581"> </span>
<a href="#l52.582"></a><span id="l52.582"> </span>
<a href="#l52.583"></a><span id="l52.583">             tabContextMenu</span>
<a href="#l52.584"></a><span id="l52.584" class="difflineminus">-              .querySelector('[anonid=&quot;closeTab&quot;]')</span>
<a href="#l52.585"></a><span id="l52.585" class="difflineplus">+              .querySelector(`[anonid=&quot;closeTab&quot;]`)</span>
<a href="#l52.586"></a><span id="l52.586">               .setAttribute(&quot;disabled&quot;, tab.canClose ? &quot;false&quot; : &quot;true&quot;);</span>
<a href="#l52.587"></a><span id="l52.587"> </span>
<a href="#l52.588"></a><span id="l52.588">             // enable &quot;Open in new Window&quot; iff tab is closable and...</span>
<a href="#l52.589"></a><span id="l52.589">             // ... it can persist its state. Other wise it would get destroyed...</span>
<a href="#l52.590"></a><span id="l52.590">             // ... while moving it to a new window.</span>
<a href="#l52.591"></a><span id="l52.591">             tabContextMenu</span>
<a href="#l52.592"></a><span id="l52.592" class="difflineminus">-              .querySelector('[anonid=&quot;openTabInWindow&quot;]')</span>
<a href="#l52.593"></a><span id="l52.593" class="difflineplus">+              .querySelector(`[anonid=&quot;openTabInWindow&quot;]`)</span>
<a href="#l52.594"></a><span id="l52.594">               .setAttribute(&quot;disabled&quot;,</span>
<a href="#l52.595"></a><span id="l52.595">                             (tab.canClose &amp;&amp; this.persistTab(tab)) ? &quot;false&quot; : &quot;true&quot;);</span>
<a href="#l52.596"></a><span id="l52.596"> </span>
<a href="#l52.597"></a><span id="l52.597">             // If the tab history is empty, disable &quot;Undo Close Tab&quot;</span>
<a href="#l52.598"></a><span id="l52.598">             tabContextMenu</span>
<a href="#l52.599"></a><span id="l52.599" class="difflineminus">-              .querySelector('[anonid=&quot;recentlyClosedTabs&quot;]')</span>
<a href="#l52.600"></a><span id="l52.600" class="difflineplus">+              .querySelector(`[anonid=&quot;recentlyClosedTabs&quot;]`)</span>
<a href="#l52.601"></a><span id="l52.601">               .setAttribute(&quot;disabled&quot;,</span>
<a href="#l52.602"></a><span id="l52.602">                             (this.recentlyClosedTabs.length) ? &quot;false&quot; : &quot;true&quot;);</span>
<a href="#l52.603"></a><span id="l52.603"> </span>
<a href="#l52.604"></a><span id="l52.604">             return true;</span>
<a href="#l52.605"></a><span id="l52.605">           ]]&gt;</span>
<a href="#l52.606"></a><span id="l52.606">         &lt;/body&gt;</span>
<a href="#l52.607"></a><span id="l52.607">       &lt;/method&gt;</span>
<a href="#l52.608"></a><span id="l52.608">       &lt;method name=&quot;supportsCommand&quot;&gt;</span>
<a href="#l52.609"></a><span id="l52.609" class="difflineat">@@ -1664,17 +1652,17 @@</span>
<a href="#l52.610"></a><span id="l52.610">            ]]&gt;</span>
<a href="#l52.611"></a><span id="l52.611">         &lt;/body&gt;</span>
<a href="#l52.612"></a><span id="l52.612">       &lt;/method&gt;</span>
<a href="#l52.613"></a><span id="l52.613">       &lt;method name=&quot;_callTabListeners&quot;&gt;</span>
<a href="#l52.614"></a><span id="l52.614">         &lt;parameter name=&quot;aMethod&quot;/&gt;</span>
<a href="#l52.615"></a><span id="l52.615">         &lt;parameter name=&quot;aArgs&quot;/&gt;</span>
<a href="#l52.616"></a><span id="l52.616">         &lt;body&gt;</span>
<a href="#l52.617"></a><span id="l52.617">           &lt;![CDATA[</span>
<a href="#l52.618"></a><span id="l52.618" class="difflineminus">-            for (let listener of  this.mTabsProgressListeners.values()) {</span>
<a href="#l52.619"></a><span id="l52.619" class="difflineplus">+            for (let listener of this.mTabsProgressListeners.values()) {</span>
<a href="#l52.620"></a><span id="l52.620">               if (aMethod in listener) {</span>
<a href="#l52.621"></a><span id="l52.621">                 try {</span>
<a href="#l52.622"></a><span id="l52.622">                   listener[aMethod](...aArgs);</span>
<a href="#l52.623"></a><span id="l52.623">                 } catch (e) {</span>
<a href="#l52.624"></a><span id="l52.624">                   Cu.reportError(e);</span>
<a href="#l52.625"></a><span id="l52.625">                 }</span>
<a href="#l52.626"></a><span id="l52.626">               }</span>
<a href="#l52.627"></a><span id="l52.627">             }</span>
<a href="#l52.628"></a><span id="l52.628" class="difflineat">@@ -1956,36 +1944,21 @@</span>
<a href="#l52.629"></a><span id="l52.629">       &lt;/xul:vbox&gt;</span>
<a href="#l52.630"></a><span id="l52.630">     &lt;/content&gt;</span>
<a href="#l52.631"></a><span id="l52.631"> </span>
<a href="#l52.632"></a><span id="l52.632">     &lt;implementation implements=&quot;nsITimerCallback&quot;&gt;</span>
<a href="#l52.633"></a><span id="l52.633">       &lt;constructor&gt;</span>
<a href="#l52.634"></a><span id="l52.634">         &lt;![CDATA[</span>
<a href="#l52.635"></a><span id="l52.635">           ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l52.636"></a><span id="l52.636"> </span>
<a href="#l52.637"></a><span id="l52.637" class="difflineminus">-          try {</span>
<a href="#l52.638"></a><span id="l52.638" class="difflineminus">-            this.mTabMinWidth = Services.prefs.getIntPref(&quot;mail.tabs.tabMinWidth&quot;);</span>
<a href="#l52.639"></a><span id="l52.639" class="difflineminus">-          } catch (e) {</span>
<a href="#l52.640"></a><span id="l52.640" class="difflineminus">-          }</span>
<a href="#l52.641"></a><span id="l52.641" class="difflineminus">-          try {</span>
<a href="#l52.642"></a><span id="l52.642" class="difflineminus">-            this.mTabMaxWidth = Services.prefs.getIntPref(&quot;mail.tabs.tabMaxWidth&quot;);</span>
<a href="#l52.643"></a><span id="l52.643" class="difflineminus">-          } catch (e) {</span>
<a href="#l52.644"></a><span id="l52.644" class="difflineminus">-          }</span>
<a href="#l52.645"></a><span id="l52.645" class="difflineminus">-          try {</span>
<a href="#l52.646"></a><span id="l52.646" class="difflineminus">-            this.mTabClipWidth = Services.prefs.getIntPref(&quot;mail.tabs.tabClipWidth&quot;);</span>
<a href="#l52.647"></a><span id="l52.647" class="difflineminus">-          } catch (e) {</span>
<a href="#l52.648"></a><span id="l52.648" class="difflineminus">-          }</span>
<a href="#l52.649"></a><span id="l52.649" class="difflineminus">-          try {</span>
<a href="#l52.650"></a><span id="l52.650" class="difflineminus">-            this.mCloseButtons = Services.prefs.getIntPref(&quot;mail.tabs.closeButtons&quot;);</span>
<a href="#l52.651"></a><span id="l52.651" class="difflineminus">-          } catch (e) {</span>
<a href="#l52.652"></a><span id="l52.652" class="difflineminus">-          }</span>
<a href="#l52.653"></a><span id="l52.653" class="difflineminus">-          try {</span>
<a href="#l52.654"></a><span id="l52.654" class="difflineminus">-            this.mAutoHide = Services.prefs.getBoolPref(&quot;mail.tabs.autoHide&quot;);</span>
<a href="#l52.655"></a><span id="l52.655" class="difflineminus">-          } catch (e) {</span>
<a href="#l52.656"></a><span id="l52.656" class="difflineminus">-          }</span>
<a href="#l52.657"></a><span id="l52.657" class="difflineplus">+          this.mTabMinWidth = Services.prefs.getIntPref(&quot;mail.tabs.tabMinWidth&quot;);</span>
<a href="#l52.658"></a><span id="l52.658" class="difflineplus">+          this.mTabMaxWidth = Services.prefs.getIntPref(&quot;mail.tabs.tabMaxWidth&quot;);</span>
<a href="#l52.659"></a><span id="l52.659" class="difflineplus">+          this.mTabClipWidth = Services.prefs.getIntPref(&quot;mail.tabs.tabClipWidth&quot;);</span>
<a href="#l52.660"></a><span id="l52.660" class="difflineplus">+          this.mCloseButtons = Services.prefs.getIntPref(&quot;mail.tabs.closeButtons&quot;);</span>
<a href="#l52.661"></a><span id="l52.661" class="difflineplus">+          this.mAutoHide = Services.prefs.getBoolPref(&quot;mail.tabs.autoHide&quot;);</span>
<a href="#l52.662"></a><span id="l52.662"> </span>
<a href="#l52.663"></a><span id="l52.663">           if (this.mAutoHide)</span>
<a href="#l52.664"></a><span id="l52.664">             this.mCollapseToolbar.collapsed = true;</span>
<a href="#l52.665"></a><span id="l52.665"> </span>
<a href="#l52.666"></a><span id="l52.666">           this.firstChild.minWidth = this.mTabMinWidth;</span>
<a href="#l52.667"></a><span id="l52.667">           this.firstChild.maxWidth = this.mTabMaxWidth;</span>
<a href="#l52.668"></a><span id="l52.668">           this._updateCloseButtons();</span>
<a href="#l52.669"></a><span id="l52.669"> </span>
<a href="#l52.670"></a><span id="l52.670" class="difflineat">@@ -2045,18 +2018,17 @@</span>
<a href="#l52.671"></a><span id="l52.671">       &lt;field name=&quot;mCollapseToolbar&quot;&gt;</span>
<a href="#l52.672"></a><span id="l52.672">         document.getElementById(this.getAttribute(&quot;collapsetoolbar&quot;));</span>
<a href="#l52.673"></a><span id="l52.673">       &lt;/field&gt;</span>
<a href="#l52.674"></a><span id="l52.674"> </span>
<a href="#l52.675"></a><span id="l52.675">       &lt;field name=&quot;_prefObserver&quot;&gt;&lt;![CDATA[</span>
<a href="#l52.676"></a><span id="l52.676">         ({</span>
<a href="#l52.677"></a><span id="l52.677">         tabbox: this,</span>
<a href="#l52.678"></a><span id="l52.678"> </span>
<a href="#l52.679"></a><span id="l52.679" class="difflineminus">-        observe: function(subject, topic, data)</span>
<a href="#l52.680"></a><span id="l52.680" class="difflineminus">-        {</span>
<a href="#l52.681"></a><span id="l52.681" class="difflineplus">+        observe(subject, topic, data) {</span>
<a href="#l52.682"></a><span id="l52.682">           if (topic == &quot;nsPref:changed&quot;) {</span>
<a href="#l52.683"></a><span id="l52.683">             subject.QueryInterface(Ci.nsIPrefBranch);</span>
<a href="#l52.684"></a><span id="l52.684">             switch (data) {</span>
<a href="#l52.685"></a><span id="l52.685">             case &quot;mail.tabs.closeButtons&quot;:</span>
<a href="#l52.686"></a><span id="l52.686">               this.tabbox.mCloseButtons = subject.getIntPref(&quot;mail.tabs.closeButtons&quot;);</span>
<a href="#l52.687"></a><span id="l52.687">               this.tabbox._updateCloseButtons();</span>
<a href="#l52.688"></a><span id="l52.688">               break;</span>
<a href="#l52.689"></a><span id="l52.689">             case &quot;mail.tabs.autoHide&quot;:</span>
<a href="#l52.690"></a><span id="l52.690" class="difflineat">@@ -2280,52 +2252,51 @@</span>
<a href="#l52.691"></a><span id="l52.691">           let tab = event.target;</span>
<a href="#l52.692"></a><span id="l52.692"> </span>
<a href="#l52.693"></a><span id="l52.693">           if ((event.type != &quot;drop&quot;) &amp;&amp; (event.type != &quot;dragover&quot;))</span>
<a href="#l52.694"></a><span id="l52.694">             return tab;</span>
<a href="#l52.695"></a><span id="l52.695"> </span>
<a href="#l52.696"></a><span id="l52.696">           let boxObject = tab.boxObject;</span>
<a href="#l52.697"></a><span id="l52.697"> </span>
<a href="#l52.698"></a><span id="l52.698">           if (event.screenX &lt; boxObject.screenX + boxObject.width * .25)</span>
<a href="#l52.699"></a><span id="l52.699" class="difflineminus">-            return null</span>
<a href="#l52.700"></a><span id="l52.700" class="difflineplus">+            return null;</span>
<a href="#l52.701"></a><span id="l52.701"> </span>
<a href="#l52.702"></a><span id="l52.702">           if (event.screenX &gt; boxObject.screenX + boxObject.width * .75)</span>
<a href="#l52.703"></a><span id="l52.703">             return null;</span>
<a href="#l52.704"></a><span id="l52.704"> </span>
<a href="#l52.705"></a><span id="l52.705">           return tab;</span>
<a href="#l52.706"></a><span id="l52.706">         ]]&gt;&lt;/body&gt;</span>
<a href="#l52.707"></a><span id="l52.707">       &lt;/method&gt;</span>
<a href="#l52.708"></a><span id="l52.708"> </span>
<a href="#l52.709"></a><span id="l52.709"> </span>
<a href="#l52.710"></a><span id="l52.710">       &lt;method name=&quot;_getDropIndex&quot;&gt;</span>
<a href="#l52.711"></a><span id="l52.711">         &lt;parameter name=&quot;event&quot;/&gt;</span>
<a href="#l52.712"></a><span id="l52.712">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l52.713"></a><span id="l52.713">           let tabs = this.childNodes;</span>
<a href="#l52.714"></a><span id="l52.714"> </span>
<a href="#l52.715"></a><span id="l52.715" class="difflineminus">-          if (window.getComputedStyle(this, null).direction == &quot;ltr&quot;) {</span>
<a href="#l52.716"></a><span id="l52.716" class="difflineplus">+          if (window.getComputedStyle(this).direction == &quot;ltr&quot;) {</span>
<a href="#l52.717"></a><span id="l52.717">             for (let i = 0; i &lt; tabs.length; i++)</span>
<a href="#l52.718"></a><span id="l52.718">               if (event.screenX &lt; (tabs[i].boxObject.screenX + (tabs[i].boxObject.width / 2)))</span>
<a href="#l52.719"></a><span id="l52.719">                 return i;</span>
<a href="#l52.720"></a><span id="l52.720" class="difflineminus">-          }</span>
<a href="#l52.721"></a><span id="l52.721" class="difflineminus">-          else  {</span>
<a href="#l52.722"></a><span id="l52.722" class="difflineplus">+          } else {</span>
<a href="#l52.723"></a><span id="l52.723">             for (let i = 0; i &lt; tabs.length; i++)</span>
<a href="#l52.724"></a><span id="l52.724">               if (event.screenX &gt; (tabs[i].boxObject.screenX + (tabs[i].boxObject.width / 2)))</span>
<a href="#l52.725"></a><span id="l52.725">                 return i;</span>
<a href="#l52.726"></a><span id="l52.726">           }</span>
<a href="#l52.727"></a><span id="l52.727"> </span>
<a href="#l52.728"></a><span id="l52.728">            return tabs.length;</span>
<a href="#l52.729"></a><span id="l52.729">         ]]&gt;&lt;/body&gt;</span>
<a href="#l52.730"></a><span id="l52.730">       &lt;/method&gt;</span>
<a href="#l52.731"></a><span id="l52.731">     &lt;/implementation&gt;</span>
<a href="#l52.732"></a><span id="l52.732">     &lt;handlers&gt;</span>
<a href="#l52.733"></a><span id="l52.733">       &lt;handler event=&quot;select&quot;&gt;&lt;![CDATA[</span>
<a href="#l52.734"></a><span id="l52.734">           this._handleTabSelect();</span>
<a href="#l52.735"></a><span id="l52.735"> </span>
<a href="#l52.736"></a><span id="l52.736" class="difflineminus">-          if (!('updateCurrentTab' in this.tabmail) ||</span>
<a href="#l52.737"></a><span id="l52.737" class="difflineminus">-              event.target.localName != 'tabs')</span>
<a href="#l52.738"></a><span id="l52.738" class="difflineplus">+          if (!(&quot;updateCurrentTab&quot; in this.tabmail) ||</span>
<a href="#l52.739"></a><span id="l52.739" class="difflineplus">+              event.target.localName != &quot;tabs&quot;)</span>
<a href="#l52.740"></a><span id="l52.740">             return;</span>
<a href="#l52.741"></a><span id="l52.741"> </span>
<a href="#l52.742"></a><span id="l52.742">           this.tabmail.updateCurrentTab();</span>
<a href="#l52.743"></a><span id="l52.743">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l52.744"></a><span id="l52.744">       &lt;handler event=&quot;TabSelect&quot; action=&quot;this._handleTabSelect();&quot;/&gt;</span>
<a href="#l52.745"></a><span id="l52.745">       &lt;handler event=&quot;dragstart&quot;&gt;&lt;![CDATA[</span>
<a href="#l52.746"></a><span id="l52.746">         let draggedTab = this._getDragTargetTab(event);</span>
<a href="#l52.747"></a><span id="l52.747"> </span>
<a href="#l52.748"></a><span id="l52.748" class="difflineat">@@ -2410,17 +2381,17 @@</span>
<a href="#l52.749"></a><span id="l52.749"> </span>
<a href="#l52.750"></a><span id="l52.750">           return;</span>
<a href="#l52.751"></a><span id="l52.751">         }</span>
<a href="#l52.752"></a><span id="l52.752"> </span>
<a href="#l52.753"></a><span id="l52.753">         // Bug 516247:</span>
<a href="#l52.754"></a><span id="l52.754">         // in case the user is dragging something else than a tab, and</span>
<a href="#l52.755"></a><span id="l52.755">         // keeps hovering over a tab, we assume he wants to switch to this tab.</span>
<a href="#l52.756"></a><span id="l52.756">         if ((dt.mozTypesAt(0)[0] != &quot;application/x-moz-tabmail-tab&quot;)</span>
<a href="#l52.757"></a><span id="l52.757" class="difflineminus">-            &amp;&amp; (dt.mozTypesAt(0)[1] != &quot;application/x-moz-tabmail-json&quot;))  {</span>
<a href="#l52.758"></a><span id="l52.758" class="difflineplus">+            &amp;&amp; (dt.mozTypesAt(0)[1] != &quot;application/x-moz-tabmail-json&quot;)) {</span>
<a href="#l52.759"></a><span id="l52.759"> </span>
<a href="#l52.760"></a><span id="l52.760">           let tab = this._getDragTargetTab(event);</span>
<a href="#l52.761"></a><span id="l52.761"> </span>
<a href="#l52.762"></a><span id="l52.762">           if (!tab)</span>
<a href="#l52.763"></a><span id="l52.763">             return;</span>
<a href="#l52.764"></a><span id="l52.764"> </span>
<a href="#l52.765"></a><span id="l52.765">           event.preventDefault();</span>
<a href="#l52.766"></a><span id="l52.766">           event.stopPropagation();</span>
<a href="#l52.767"></a><span id="l52.767" class="difflineat">@@ -2455,17 +2426,17 @@</span>
<a href="#l52.768"></a><span id="l52.768">             return;</span>
<a href="#l52.769"></a><span id="l52.769">         }</span>
<a href="#l52.770"></a><span id="l52.770"> </span>
<a href="#l52.771"></a><span id="l52.771">         dt.effectAllowed = &quot;copyMove&quot;;</span>
<a href="#l52.772"></a><span id="l52.772"> </span>
<a href="#l52.773"></a><span id="l52.773">         event.preventDefault();</span>
<a href="#l52.774"></a><span id="l52.774">         event.stopPropagation();</span>
<a href="#l52.775"></a><span id="l52.775"> </span>
<a href="#l52.776"></a><span id="l52.776" class="difflineminus">-        let ltr = (window.getComputedStyle(this, null).direction == &quot;ltr&quot;);</span>
<a href="#l52.777"></a><span id="l52.777" class="difflineplus">+        let ltr = (window.getComputedStyle(this).direction == &quot;ltr&quot;);</span>
<a href="#l52.778"></a><span id="l52.778">         let ind = this._tabDropIndicator;</span>
<a href="#l52.779"></a><span id="l52.779"> </span>
<a href="#l52.780"></a><span id="l52.780">         // Let's scroll</span>
<a href="#l52.781"></a><span id="l52.781">         if (this.hasAttribute(&quot;overflow&quot;)) {</span>
<a href="#l52.782"></a><span id="l52.782"> </span>
<a href="#l52.783"></a><span id="l52.783">           let target = event.originalTarget.getAttribute(&quot;anonid&quot;);</span>
<a href="#l52.784"></a><span id="l52.784"> </span>
<a href="#l52.785"></a><span id="l52.785">           let pixelsToScroll = 0;</span>
<a href="#l52.786"></a><span id="l52.786" class="difflineat">@@ -2494,33 +2465,32 @@</span>
<a href="#l52.787"></a><span id="l52.787"> </span>
<a href="#l52.788"></a><span id="l52.788">         while ((newIndex &lt; tabInfo.length) &amp;&amp; !(tabInfo[newIndex].canClose))</span>
<a href="#l52.789"></a><span id="l52.789">           newIndex++;</span>
<a href="#l52.790"></a><span id="l52.790"> </span>
<a href="#l52.791"></a><span id="l52.791"> </span>
<a href="#l52.792"></a><span id="l52.792">         var scrollRect = this.arrowScrollbox.scrollClientRect;</span>
<a href="#l52.793"></a><span id="l52.793">         var rect = this.getBoundingClientRect();</span>
<a href="#l52.794"></a><span id="l52.794">         var minMargin = scrollRect.left - rect.left;</span>
<a href="#l52.795"></a><span id="l52.795" class="difflineminus">-        var maxMargin = Math.min(minMargin + scrollRect.width,scrollRect.right);</span>
<a href="#l52.796"></a><span id="l52.796" class="difflineplus">+        var maxMargin = Math.min(minMargin + scrollRect.width, scrollRect.right);</span>
<a href="#l52.797"></a><span id="l52.797"> </span>
<a href="#l52.798"></a><span id="l52.798">         if (!ltr)</span>
<a href="#l52.799"></a><span id="l52.799">           [minMargin, maxMargin] = [this.clientWidth - maxMargin, this.clientWidth - minMargin];</span>
<a href="#l52.800"></a><span id="l52.800"> </span>
<a href="#l52.801"></a><span id="l52.801">         var newMargin;</span>
<a href="#l52.802"></a><span id="l52.802"> </span>
<a href="#l52.803"></a><span id="l52.803">         if (newIndex == this.childNodes.length) {</span>
<a href="#l52.804"></a><span id="l52.804"> </span>
<a href="#l52.805"></a><span id="l52.805" class="difflineminus">-          let tabRect = this.childNodes[newIndex-1].getBoundingClientRect();</span>
<a href="#l52.806"></a><span id="l52.806" class="difflineplus">+          let tabRect = this.childNodes[newIndex - 1].getBoundingClientRect();</span>
<a href="#l52.807"></a><span id="l52.807"> </span>
<a href="#l52.808"></a><span id="l52.808">           if (ltr)</span>
<a href="#l52.809"></a><span id="l52.809">             newMargin = tabRect.right - rect.left;</span>
<a href="#l52.810"></a><span id="l52.810">           else</span>
<a href="#l52.811"></a><span id="l52.811">             newMargin = rect.right - tabRect.left;</span>
<a href="#l52.812"></a><span id="l52.812" class="difflineminus">-        }</span>
<a href="#l52.813"></a><span id="l52.813" class="difflineminus">-        else  {</span>
<a href="#l52.814"></a><span id="l52.814" class="difflineplus">+        } else {</span>
<a href="#l52.815"></a><span id="l52.815"> </span>
<a href="#l52.816"></a><span id="l52.816">           let tabRect = this.childNodes[newIndex].getBoundingClientRect();</span>
<a href="#l52.817"></a><span id="l52.817"> </span>
<a href="#l52.818"></a><span id="l52.818">           if (ltr)</span>
<a href="#l52.819"></a><span id="l52.819">             newMargin = tabRect.left - rect.left;</span>
<a href="#l52.820"></a><span id="l52.820">           else</span>
<a href="#l52.821"></a><span id="l52.821">             newMargin = rect.right - tabRect.right;</span>
<a href="#l52.822"></a><span id="l52.822">         }</span>
<a href="#l52.823"></a><span id="l52.823" class="difflineat">@@ -2559,17 +2529,17 @@</span>
<a href="#l52.824"></a><span id="l52.824">             this.mToolbar.firstChild.dispatchEvent(evt);</span>
<a href="#l52.825"></a><span id="l52.825">           else</span>
<a href="#l52.826"></a><span id="l52.826">             this.mToolbar.dispatchEvent(evt);</span>
<a href="#l52.827"></a><span id="l52.827"> </span>
<a href="#l52.828"></a><span id="l52.828">           return;</span>
<a href="#l52.829"></a><span id="l52.829">         }</span>
<a href="#l52.830"></a><span id="l52.830"> </span>
<a href="#l52.831"></a><span id="l52.831"> </span>
<a href="#l52.832"></a><span id="l52.832" class="difflineminus">-        let draggedTab = dt.mozGetDataAt(&quot;application/x-moz-tabmail-tab&quot;,0);</span>
<a href="#l52.833"></a><span id="l52.833" class="difflineplus">+        let draggedTab = dt.mozGetDataAt(&quot;application/x-moz-tabmail-tab&quot;, 0);</span>
<a href="#l52.834"></a><span id="l52.834"> </span>
<a href="#l52.835"></a><span id="l52.835">         if (!draggedTab)</span>
<a href="#l52.836"></a><span id="l52.836">           return;</span>
<a href="#l52.837"></a><span id="l52.837"> </span>
<a href="#l52.838"></a><span id="l52.838">         event.stopPropagation();</span>
<a href="#l52.839"></a><span id="l52.839">         this._tabDropIndicator.collapsed = true;</span>
<a href="#l52.840"></a><span id="l52.840"> </span>
<a href="#l52.841"></a><span id="l52.841">         // Is the tab one of our children?</span>
<a href="#l52.842"></a><span id="l52.842" class="difflineat">@@ -2586,17 +2556,17 @@</span>
<a href="#l52.843"></a><span id="l52.843">           if (!draggedJson)</span>
<a href="#l52.844"></a><span id="l52.844">             return;</span>
<a href="#l52.845"></a><span id="l52.845"> </span>
<a href="#l52.846"></a><span id="l52.846">           draggedJson = JSON.parse(draggedJson);</span>
<a href="#l52.847"></a><span id="l52.847"> </span>
<a href="#l52.848"></a><span id="l52.848">           // Some tab exist only once, so we have to gamble a bit. We close</span>
<a href="#l52.849"></a><span id="l52.849">           // the tab and try to reopen it. If something fails the tab is gone.</span>
<a href="#l52.850"></a><span id="l52.850"> </span>
<a href="#l52.851"></a><span id="l52.851" class="difflineminus">-          tabmail2.closeTab(draggedTab,true);</span>
<a href="#l52.852"></a><span id="l52.852" class="difflineplus">+          tabmail2.closeTab(draggedTab, true);</span>
<a href="#l52.853"></a><span id="l52.853"> </span>
<a href="#l52.854"></a><span id="l52.854">           if (!this.tabmail.restoreTab(draggedJson))</span>
<a href="#l52.855"></a><span id="l52.855">             return;</span>
<a href="#l52.856"></a><span id="l52.856"> </span>
<a href="#l52.857"></a><span id="l52.857">           draggedTab = this.tabmail.tabContainer.childNodes[</span>
<a href="#l52.858"></a><span id="l52.858">             this.tabmail.tabContainer.childNodes.length - 1];</span>
<a href="#l52.859"></a><span id="l52.859">         }</span>
<a href="#l52.860"></a><span id="l52.860"> </span>
<a href="#l52.861"></a><span id="l52.861" class="difflineat">@@ -2640,17 +2610,17 @@</span>
<a href="#l52.862"></a><span id="l52.862">           if (eY &lt; endScreenY &amp;&amp; eY &gt; window.screenY)</span>
<a href="#l52.863"></a><span id="l52.863">             return;</span>
<a href="#l52.864"></a><span id="l52.864">         }</span>
<a href="#l52.865"></a><span id="l52.865"> </span>
<a href="#l52.866"></a><span id="l52.866">         // user wants to deatach tab from window...</span>
<a href="#l52.867"></a><span id="l52.867">         if (dt.mozItemCount != 1)</span>
<a href="#l52.868"></a><span id="l52.868">           return;</span>
<a href="#l52.869"></a><span id="l52.869"> </span>
<a href="#l52.870"></a><span id="l52.870" class="difflineminus">-        let draggedTab = dt.mozGetDataAt(&quot;application/x-moz-tabmail-tab&quot;,0);</span>
<a href="#l52.871"></a><span id="l52.871" class="difflineplus">+        let draggedTab = dt.mozGetDataAt(&quot;application/x-moz-tabmail-tab&quot;, 0);</span>
<a href="#l52.872"></a><span id="l52.872"> </span>
<a href="#l52.873"></a><span id="l52.873">         if (!draggedTab)</span>
<a href="#l52.874"></a><span id="l52.874">           return;</span>
<a href="#l52.875"></a><span id="l52.875"> </span>
<a href="#l52.876"></a><span id="l52.876">         this.tabmail.replaceTabWithWindow(draggedTab);</span>
<a href="#l52.877"></a><span id="l52.877"> </span>
<a href="#l52.878"></a><span id="l52.878">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l52.879"></a><span id="l52.879"> </span>
<a href="#l52.880"></a><span id="l52.880" class="difflineat">@@ -2680,34 +2650,33 @@</span>
<a href="#l52.881"></a><span id="l52.881">         try {</span>
<a href="#l52.882"></a><span id="l52.882">           this._xulWindow =</span>
<a href="#l52.883"></a><span id="l52.883">             window.QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l52.884"></a><span id="l52.884">                   .getInterface(Ci.nsIWebNavigation)</span>
<a href="#l52.885"></a><span id="l52.885">                   .QueryInterface(Ci.nsIDocShellTreeItem)</span>
<a href="#l52.886"></a><span id="l52.886">                   .treeOwner</span>
<a href="#l52.887"></a><span id="l52.887">                   .QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l52.888"></a><span id="l52.888">                   .getInterface(Ci.nsIXULWindow);</span>
<a href="#l52.889"></a><span id="l52.889" class="difflineminus">-        }</span>
<a href="#l52.890"></a><span id="l52.890" class="difflineminus">-        catch(ex) { }</span>
<a href="#l52.891"></a><span id="l52.891" class="difflineplus">+        } catch (ex) {}</span>
<a href="#l52.892"></a><span id="l52.892"> </span>
<a href="#l52.893"></a><span id="l52.893">         let tabmailalltabspopup = this;</span>
<a href="#l52.894"></a><span id="l52.894" class="difflineminus">-        this._mutationObserver = new MutationObserver(function handleMutations(aRecords, aObserver) {</span>
<a href="#l52.895"></a><span id="l52.895" class="difflineplus">+        this._mutationObserver = new MutationObserver(function(aRecords, aObserver) {</span>
<a href="#l52.896"></a><span id="l52.896">           aRecords.forEach(function(mutation) {</span>
<a href="#l52.897"></a><span id="l52.897">             let menuItem = mutation.target.mCorrespondingMenuitem;</span>
<a href="#l52.898"></a><span id="l52.898">             if (menuItem)</span>
<a href="#l52.899"></a><span id="l52.899">               tabmailalltabspopup._setMenuitemAttributes(menuItem, mutation.target);</span>
<a href="#l52.900"></a><span id="l52.900">           });</span>
<a href="#l52.901"></a><span id="l52.901">         });</span>
<a href="#l52.902"></a><span id="l52.902"> </span>
<a href="#l52.903"></a><span id="l52.903">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l52.904"></a><span id="l52.904"> </span>
<a href="#l52.905"></a><span id="l52.905">       &lt;method name=&quot;_menuItemOnCommand&quot;&gt;</span>
<a href="#l52.906"></a><span id="l52.906">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l52.907"></a><span id="l52.907">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l52.908"></a><span id="l52.908" class="difflineminus">-          var tabcontainer = document.getElementById('tabmail')</span>
<a href="#l52.909"></a><span id="l52.909" class="difflineplus">+          var tabcontainer = document.getElementById(&quot;tabmail&quot;)</span>
<a href="#l52.910"></a><span id="l52.910">                                      .tabContainer;</span>
<a href="#l52.911"></a><span id="l52.911">           tabcontainer.selectedItem = aEvent.target.tab;</span>
<a href="#l52.912"></a><span id="l52.912">         ]]&gt;&lt;/body&gt;</span>
<a href="#l52.913"></a><span id="l52.913">       &lt;/method&gt;</span>
<a href="#l52.914"></a><span id="l52.914"> </span>
<a href="#l52.915"></a><span id="l52.915">       &lt;method name=&quot;_tabOnTabClose&quot;&gt;</span>
<a href="#l52.916"></a><span id="l52.916">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l52.917"></a><span id="l52.917">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l52.918"></a><span id="l52.918" class="difflineat">@@ -2737,17 +2706,17 @@</span>
<a href="#l52.919"></a><span id="l52.919">               this._updateTabsVisibilityStatus();</span>
<a href="#l52.920"></a><span id="l52.920">               break;</span>
<a href="#l52.921"></a><span id="l52.921">           }</span>
<a href="#l52.922"></a><span id="l52.922">         ]]&gt;&lt;/body&gt;</span>
<a href="#l52.923"></a><span id="l52.923">       &lt;/method&gt;</span>
<a href="#l52.924"></a><span id="l52.924"> </span>
<a href="#l52.925"></a><span id="l52.925">       &lt;method name=&quot;_updateTabsVisibilityStatus&quot;&gt;</span>
<a href="#l52.926"></a><span id="l52.926">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l52.927"></a><span id="l52.927" class="difflineminus">-          var tabContainer = document.getElementById('tabmail').tabContainer;</span>
<a href="#l52.928"></a><span id="l52.928" class="difflineplus">+          var tabContainer = document.getElementById(&quot;tabmail&quot;).tabContainer;</span>
<a href="#l52.929"></a><span id="l52.929">           // We don't want menu item decoration unless there is overflow.</span>
<a href="#l52.930"></a><span id="l52.930">           if (tabContainer.getAttribute(&quot;overflow&quot;) != &quot;true&quot;)</span>
<a href="#l52.931"></a><span id="l52.931">             return;</span>
<a href="#l52.932"></a><span id="l52.932"> </span>
<a href="#l52.933"></a><span id="l52.933">           var tabstripBO = tabContainer.arrowScrollbox.boxObject;</span>
<a href="#l52.934"></a><span id="l52.934">           for (var i = 0; i &lt; this.childNodes.length; i++) {</span>
<a href="#l52.935"></a><span id="l52.935">             var curTabBO = this.childNodes[i].tab.boxObject;</span>
<a href="#l52.936"></a><span id="l52.936">             if (curTabBO.screenX &gt;= tabstripBO.screenX &amp;&amp;</span>
<a href="#l52.937"></a><span id="l52.937" class="difflineat">@@ -2793,17 +2762,17 @@</span>
<a href="#l52.938"></a><span id="l52.938">             aMenuitem.setAttribute(&quot;busy&quot;, aTab.getAttribute(&quot;busy&quot;));</span>
<a href="#l52.939"></a><span id="l52.939">             aMenuitem.removeAttribute(&quot;image&quot;);</span>
<a href="#l52.940"></a><span id="l52.940">           } else {</span>
<a href="#l52.941"></a><span id="l52.941">             aMenuitem.setAttribute(&quot;image&quot;, aTab.getAttribute(&quot;image&quot;));</span>
<a href="#l52.942"></a><span id="l52.942">             aMenuitem.removeAttribute(&quot;busy&quot;);</span>
<a href="#l52.943"></a><span id="l52.943">           }</span>
<a href="#l52.944"></a><span id="l52.944"> </span>
<a href="#l52.945"></a><span id="l52.945">           // Change the tab icon accordingly.</span>
<a href="#l52.946"></a><span id="l52.946" class="difflineminus">-          let style = window.getComputedStyle(aTab, null);</span>
<a href="#l52.947"></a><span id="l52.947" class="difflineplus">+          let style = window.getComputedStyle(aTab);</span>
<a href="#l52.948"></a><span id="l52.948">           aMenuitem.style.listStyleImage = style.listStyleImage;</span>
<a href="#l52.949"></a><span id="l52.949">           aMenuitem.style.MozImageRegion = style.MozImageRegion;</span>
<a href="#l52.950"></a><span id="l52.950"> </span>
<a href="#l52.951"></a><span id="l52.951">           if (aTab.hasAttribute(&quot;pending&quot;))</span>
<a href="#l52.952"></a><span id="l52.952">             aMenuitem.setAttribute(&quot;pending&quot;, aTab.getAttribute(&quot;pending&quot;));</span>
<a href="#l52.953"></a><span id="l52.953">           else</span>
<a href="#l52.954"></a><span id="l52.954">             aMenuitem.removeAttribute(&quot;pending&quot;);</span>
<a href="#l52.955"></a><span id="l52.955"> </span>
<a href="#l52.956"></a><span id="l52.956" class="difflineat">@@ -2814,25 +2783,25 @@</span>
<a href="#l52.957"></a><span id="l52.957">         ]]&gt;&lt;/body&gt;</span>
<a href="#l52.958"></a><span id="l52.958">       &lt;/method&gt;</span>
<a href="#l52.959"></a><span id="l52.959">     &lt;/implementation&gt;</span>
<a href="#l52.960"></a><span id="l52.960"> </span>
<a href="#l52.961"></a><span id="l52.961">     &lt;handlers&gt;</span>
<a href="#l52.962"></a><span id="l52.962">       &lt;handler event=&quot;popupshowing&quot;&gt;</span>
<a href="#l52.963"></a><span id="l52.963">       &lt;![CDATA[</span>
<a href="#l52.964"></a><span id="l52.964">         // set up the menu popup</span>
<a href="#l52.965"></a><span id="l52.965" class="difflineminus">-        let tabmail = document.getElementById('tabmail');</span>
<a href="#l52.966"></a><span id="l52.966" class="difflineplus">+        let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l52.967"></a><span id="l52.967">         var tabcontainer = tabmail.tabContainer;</span>
<a href="#l52.968"></a><span id="l52.968">         var tabs = tabcontainer.childNodes;</span>
<a href="#l52.969"></a><span id="l52.969"> </span>
<a href="#l52.970"></a><span id="l52.970">         // Listen for changes in the tab bar.</span>
<a href="#l52.971"></a><span id="l52.971">         this._mutationObserver.observe(tabcontainer, {</span>
<a href="#l52.972"></a><span id="l52.972">           attributes: true,</span>
<a href="#l52.973"></a><span id="l52.973">           subtree: true,</span>
<a href="#l52.974"></a><span id="l52.974" class="difflineminus">-          attributeFilter: [&quot;label&quot;, &quot;crop&quot;, &quot;busy&quot;, &quot;image&quot;, &quot;selected&quot;]</span>
<a href="#l52.975"></a><span id="l52.975" class="difflineplus">+          attributeFilter: [&quot;label&quot;, &quot;crop&quot;, &quot;busy&quot;, &quot;image&quot;, &quot;selected&quot;],</span>
<a href="#l52.976"></a><span id="l52.976">         });</span>
<a href="#l52.977"></a><span id="l52.977"> </span>
<a href="#l52.978"></a><span id="l52.978">         tabmail.addEventListener(&quot;TabOpen&quot;, this);</span>
<a href="#l52.979"></a><span id="l52.979">         tabcontainer.arrowScrollbox.addEventListener(&quot;scroll&quot;, this);</span>
<a href="#l52.980"></a><span id="l52.980"> </span>
<a href="#l52.981"></a><span id="l52.981">         // if an animation is in progress and the user</span>
<a href="#l52.982"></a><span id="l52.982">         // clicks on the &quot;all tabs&quot; button, stop the animation</span>
<a href="#l52.983"></a><span id="l52.983">         tabcontainer._stopAnimation();</span>
<a href="#l52.984"></a><span id="l52.984" class="difflineat">@@ -2850,17 +2819,17 @@</span>
<a href="#l52.985"></a><span id="l52.985">           var menuItem = this.lastChild;</span>
<a href="#l52.986"></a><span id="l52.986">           menuItem.removeEventListener(&quot;command&quot;, this);</span>
<a href="#l52.987"></a><span id="l52.987">           menuItem.tab.removeEventListener(&quot;TabClose&quot;, this);</span>
<a href="#l52.988"></a><span id="l52.988">           menuItem.tab.mCorrespondingMenuitem = null;</span>
<a href="#l52.989"></a><span id="l52.989">           menuItem.remove();</span>
<a href="#l52.990"></a><span id="l52.990">         }</span>
<a href="#l52.991"></a><span id="l52.991">         this._mutationObserver.disconnect();</span>
<a href="#l52.992"></a><span id="l52.992"> </span>
<a href="#l52.993"></a><span id="l52.993" class="difflineminus">-        var tabcontainer = document.getElementById('tabmail').tabContainer;</span>
<a href="#l52.994"></a><span id="l52.994" class="difflineplus">+        var tabcontainer = document.getElementById(&quot;tabmail&quot;).tabContainer;</span>
<a href="#l52.995"></a><span id="l52.995">         tabcontainer.arrowScrollbox.removeEventListener(&quot;scroll&quot;, this);</span>
<a href="#l52.996"></a><span id="l52.996">         tabcontainer.tabmail.removeEventListener(&quot;TabOpen&quot;, this);</span>
<a href="#l52.997"></a><span id="l52.997">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l52.998"></a><span id="l52.998">     &lt;/handlers&gt;</span>
<a href="#l52.999"></a><span id="l52.999">   &lt;/binding&gt;</span>
<a href="#l52.1000"></a><span id="l52.1000">   &lt;!-- close-tab-button binding</span>
<a href="#l52.1001"></a><span id="l52.1001">        This binding relies on the structure of the tabmail-tabs binding.</span>
<a href="#l52.1002"></a><span id="l52.1002">        Therefore it should only be used as a child of the tab or the tabs</span>
<a href="#l52.1003"></a><span id="l52.1003" class="difflineat">@@ -2910,21 +2879,21 @@</span>
<a href="#l52.1004"></a><span id="l52.1004">             if (target.className == &quot;tab-close-button&quot;)</span>
<a href="#l52.1005"></a><span id="l52.1005">               target._ignoredClick = true;</span>
<a href="#l52.1006"></a><span id="l52.1006">             if (!clickedOnce) {</span>
<a href="#l52.1007"></a><span id="l52.1007">               clickedOnce = true;</span>
<a href="#l52.1008"></a><span id="l52.1008">               return;</span>
<a href="#l52.1009"></a><span id="l52.1009">             }</span>
<a href="#l52.1010"></a><span id="l52.1010">             tabContainer._blockDblClick = false;</span>
<a href="#l52.1011"></a><span id="l52.1011">             tabContainer.removeEventListener(&quot;click&quot;, enableDblClick, true);</span>
<a href="#l52.1012"></a><span id="l52.1012" class="difflineminus">-          }</span>
<a href="#l52.1013"></a><span id="l52.1013" class="difflineplus">+          };</span>
<a href="#l52.1014"></a><span id="l52.1014">           tabContainer.addEventListener(&quot;click&quot;, enableDblClick, true);</span>
<a href="#l52.1015"></a><span id="l52.1015" class="difflineplus">+        } else { // &quot;tabs&quot;</span>
<a href="#l52.1016"></a><span id="l52.1016" class="difflineplus">+          tabbedBrowser.removeCurrentTab();</span>
<a href="#l52.1017"></a><span id="l52.1017">         }</span>
<a href="#l52.1018"></a><span id="l52.1018" class="difflineminus">-        else // &quot;tabs&quot;</span>
<a href="#l52.1019"></a><span id="l52.1019" class="difflineminus">-          tabbedBrowser.removeCurrentTab();</span>
<a href="#l52.1020"></a><span id="l52.1020">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l52.1021"></a><span id="l52.1021">       &lt;handler event=&quot;dblclick&quot; button=&quot;0&quot; phase=&quot;capturing&quot;&gt;</span>
<a href="#l52.1022"></a><span id="l52.1022">         // for the one-close-button case</span>
<a href="#l52.1023"></a><span id="l52.1023">         event.stopPropagation();</span>
<a href="#l52.1024"></a><span id="l52.1024">       &lt;/handler&gt;</span>
<a href="#l52.1025"></a><span id="l52.1025">     &lt;/handlers&gt;</span>
<a href="#l52.1026"></a><span id="l52.1026">   &lt;/binding&gt;</span>
<a href="#l52.1027"></a><span id="l52.1027"> &lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1" class="difflineminus">--- a/mail/base/content/threadPane.js</span>
<a href="#l53.2"></a><span id="l53.2" class="difflineplus">+++ b/mail/base/content/threadPane.js</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineat">@@ -1,18 +1,17 @@</span>
<a href="#l53.4"></a><span id="l53.4"> /* -*- Mode: Java; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l53.5"></a><span id="l53.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l53.6"></a><span id="l53.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l53.7"></a><span id="l53.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l53.8"></a><span id="l53.8"> </span>
<a href="#l53.9"></a><span id="l53.9"> var gLastMessageUriToLoad = null;</span>
<a href="#l53.10"></a><span id="l53.10"> var gThreadPaneCommandUpdater = null;</span>
<a href="#l53.11"></a><span id="l53.11"> </span>
<a href="#l53.12"></a><span id="l53.12" class="difflineminus">-function ThreadPaneOnClick(event)</span>
<a href="#l53.13"></a><span id="l53.13" class="difflineminus">-{</span>
<a href="#l53.14"></a><span id="l53.14" class="difflineplus">+function ThreadPaneOnClick(event) {</span>
<a href="#l53.15"></a><span id="l53.15">   // We only care about button 0 (left click) events.</span>
<a href="#l53.16"></a><span id="l53.16">   if (event.button != 0) {</span>
<a href="#l53.17"></a><span id="l53.17">     event.stopPropagation();</span>
<a href="#l53.18"></a><span id="l53.18">     return;</span>
<a href="#l53.19"></a><span id="l53.19">   }</span>
<a href="#l53.20"></a><span id="l53.20"> </span>
<a href="#l53.21"></a><span id="l53.21">   // We already handle marking as read/flagged/junk cyclers in nsMsgDBView.cpp</span>
<a href="#l53.22"></a><span id="l53.22">   // so all we need to worry about here is doubleclicks and column header. We</span>
<a href="#l53.23"></a><span id="l53.23" class="difflineat">@@ -59,57 +58,51 @@ function ThreadPaneOnClick(event)</span>
<a href="#l53.24"></a><span id="l53.24">   // If the cell is in a cycler column or if the user doubleclicked on the</span>
<a href="#l53.25"></a><span id="l53.25">   // twisty, don't open the message in a new window.</span>
<a href="#l53.26"></a><span id="l53.26">   if (event.detail == 2 &amp;&amp; !col.value.cycler &amp;&amp; elt.value != &quot;twisty&quot;) {</span>
<a href="#l53.27"></a><span id="l53.27">     ThreadPaneDoubleClick();</span>
<a href="#l53.28"></a><span id="l53.28">     // Doubleclicking should not toggle the open/close state of the thread.</span>
<a href="#l53.29"></a><span id="l53.29">     // This will happen if we don't prevent the event from bubbling to the</span>
<a href="#l53.30"></a><span id="l53.30">     // default handler in tree.xml.</span>
<a href="#l53.31"></a><span id="l53.31">     event.stopPropagation();</span>
<a href="#l53.32"></a><span id="l53.32" class="difflineminus">-  }</span>
<a href="#l53.33"></a><span id="l53.33" class="difflineminus">-  else if (col.value.id == &quot;junkStatusCol&quot;) {</span>
<a href="#l53.34"></a><span id="l53.34" class="difflineplus">+  } else if (col.value.id == &quot;junkStatusCol&quot;) {</span>
<a href="#l53.35"></a><span id="l53.35">     MsgJunkMailInfo(true);</span>
<a href="#l53.36"></a><span id="l53.36" class="difflineminus">-  }</span>
<a href="#l53.37"></a><span id="l53.37" class="difflineminus">-  else if (col.value.id == &quot;threadCol&quot; &amp;&amp; !event.shiftKey &amp;&amp;</span>
<a href="#l53.38"></a><span id="l53.38" class="difflineminus">-           (event.ctrlKey || event.metaKey)) {</span>
<a href="#l53.39"></a><span id="l53.39" class="difflineplus">+  } else if (col.value.id == &quot;threadCol&quot; &amp;&amp; !event.shiftKey &amp;&amp; (event.ctrlKey || event.metaKey)) {</span>
<a href="#l53.40"></a><span id="l53.40">     gDBView.ExpandAndSelectThreadByIndex(row.value, true);</span>
<a href="#l53.41"></a><span id="l53.41">     event.stopPropagation();</span>
<a href="#l53.42"></a><span id="l53.42">   }</span>
<a href="#l53.43"></a><span id="l53.43"> }</span>
<a href="#l53.44"></a><span id="l53.44"> </span>
<a href="#l53.45"></a><span id="l53.45" class="difflineminus">-function HandleColumnClick(columnID)</span>
<a href="#l53.46"></a><span id="l53.46" class="difflineminus">-{</span>
<a href="#l53.47"></a><span id="l53.47" class="difflineplus">+function HandleColumnClick(columnID) {</span>
<a href="#l53.48"></a><span id="l53.48">   if (gFolderDisplay.COLUMNS_MAP_NOSORT.has(columnID))</span>
<a href="#l53.49"></a><span id="l53.49">     return;</span>
<a href="#l53.50"></a><span id="l53.50"> </span>
<a href="#l53.51"></a><span id="l53.51">   let sortType = gFolderDisplay.COLUMNS_MAP.get(columnID);</span>
<a href="#l53.52"></a><span id="l53.52">   let curCustomColumn = gDBView.curCustomColumn;</span>
<a href="#l53.53"></a><span id="l53.53">   if (!sortType) {</span>
<a href="#l53.54"></a><span id="l53.54">     // If the column isn't in the map, check if it's a custom column.</span>
<a href="#l53.55"></a><span id="l53.55">     try {</span>
<a href="#l53.56"></a><span id="l53.56">       // Test for the columnHandler (an error is thrown if it does not exist).</span>
<a href="#l53.57"></a><span id="l53.57">       gDBView.getColumnHandler(columnID);</span>
<a href="#l53.58"></a><span id="l53.58"> </span>
<a href="#l53.59"></a><span id="l53.59">       // Handler is registered - set column to be the current custom column.</span>
<a href="#l53.60"></a><span id="l53.60">       gDBView.curCustomColumn = columnID;</span>
<a href="#l53.61"></a><span id="l53.61">       sortType = &quot;byCustom&quot;;</span>
<a href="#l53.62"></a><span id="l53.62" class="difflineminus">-    }</span>
<a href="#l53.63"></a><span id="l53.63" class="difflineminus">-    catch (ex) {</span>
<a href="#l53.64"></a><span id="l53.64" class="difflineplus">+    } catch (ex) {</span>
<a href="#l53.65"></a><span id="l53.65">       dump(&quot;HandleColumnClick: No custom column handler registered for &quot; +</span>
<a href="#l53.66"></a><span id="l53.66">            &quot;columnID: &quot; + columnID + &quot; - &quot; + ex + &quot;\n&quot;);</span>
<a href="#l53.67"></a><span id="l53.67">       return;</span>
<a href="#l53.68"></a><span id="l53.68">     }</span>
<a href="#l53.69"></a><span id="l53.69">   }</span>
<a href="#l53.70"></a><span id="l53.70"> </span>
<a href="#l53.71"></a><span id="l53.71">   let viewWrapper = gFolderDisplay.view;</span>
<a href="#l53.72"></a><span id="l53.72">   let simpleColumns = false;</span>
<a href="#l53.73"></a><span id="l53.73">   try {</span>
<a href="#l53.74"></a><span id="l53.74">     simpleColumns = !Services.prefs.getBoolPref(&quot;mailnews.thread_pane_column_unthreads&quot;);</span>
<a href="#l53.75"></a><span id="l53.75" class="difflineminus">-  }</span>
<a href="#l53.76"></a><span id="l53.76" class="difflineminus">-  catch (ex) {</span>
<a href="#l53.77"></a><span id="l53.77" class="difflineplus">+  } catch (ex) {</span>
<a href="#l53.78"></a><span id="l53.78">   }</span>
<a href="#l53.79"></a><span id="l53.79"> </span>
<a href="#l53.80"></a><span id="l53.80">   if (sortType == &quot;byThread&quot;) {</span>
<a href="#l53.81"></a><span id="l53.81">     if (simpleColumns)</span>
<a href="#l53.82"></a><span id="l53.82">       MsgToggleThreaded();</span>
<a href="#l53.83"></a><span id="l53.83">     else if (viewWrapper.showThreaded)</span>
<a href="#l53.84"></a><span id="l53.84">       MsgReverseSortThreadPane();</span>
<a href="#l53.85"></a><span id="l53.85">     else</span>
<a href="#l53.86"></a><span id="l53.86" class="difflineat">@@ -123,40 +116,35 @@ function HandleColumnClick(columnID)</span>
<a href="#l53.87"></a><span id="l53.87">     MsgSortThreadPane(sortType);</span>
<a href="#l53.88"></a><span id="l53.88">     return;</span>
<a href="#l53.89"></a><span id="l53.89">   }</span>
<a href="#l53.90"></a><span id="l53.90"> </span>
<a href="#l53.91"></a><span id="l53.91">   if (viewWrapper.primarySortType == nsMsgViewSortType[sortType] &amp;&amp;</span>
<a href="#l53.92"></a><span id="l53.92">       (viewWrapper.primarySortType != nsMsgViewSortType.byCustom ||</span>
<a href="#l53.93"></a><span id="l53.93">        curCustomColumn == columnID)) {</span>
<a href="#l53.94"></a><span id="l53.94">     MsgReverseSortThreadPane();</span>
<a href="#l53.95"></a><span id="l53.95" class="difflineminus">-  }</span>
<a href="#l53.96"></a><span id="l53.96" class="difflineminus">-  else {</span>
<a href="#l53.97"></a><span id="l53.97" class="difflineplus">+  } else {</span>
<a href="#l53.98"></a><span id="l53.98">     MsgSortThreadPane(sortType);</span>
<a href="#l53.99"></a><span id="l53.99">   }</span>
<a href="#l53.100"></a><span id="l53.100"> }</span>
<a href="#l53.101"></a><span id="l53.101"> </span>
<a href="#l53.102"></a><span id="l53.102" class="difflineminus">-function ThreadPaneDoubleClick()</span>
<a href="#l53.103"></a><span id="l53.103" class="difflineminus">-{</span>
<a href="#l53.104"></a><span id="l53.104" class="difflineplus">+function ThreadPaneDoubleClick() {</span>
<a href="#l53.105"></a><span id="l53.105">   if (IsSpecialFolderSelected(Ci.nsMsgFolderFlags.Drafts, true)) {</span>
<a href="#l53.106"></a><span id="l53.106">     MsgComposeDraftMessage();</span>
<a href="#l53.107"></a><span id="l53.107" class="difflineminus">-  }</span>
<a href="#l53.108"></a><span id="l53.108" class="difflineminus">-  else if (IsSpecialFolderSelected(Ci.nsMsgFolderFlags.Templates, true)) {</span>
<a href="#l53.109"></a><span id="l53.109" class="difflineplus">+  } else if (IsSpecialFolderSelected(Ci.nsMsgFolderFlags.Templates, true)) {</span>
<a href="#l53.110"></a><span id="l53.110">     ComposeMessage(Ci.nsIMsgCompType.Template,</span>
<a href="#l53.111"></a><span id="l53.111">                    Ci.nsIMsgCompFormat.Default,</span>
<a href="#l53.112"></a><span id="l53.112">                    gFolderDisplay.displayedFolder,</span>
<a href="#l53.113"></a><span id="l53.113">                    gFolderDisplay.selectedMessageUris);</span>
<a href="#l53.114"></a><span id="l53.114" class="difflineminus">-  }</span>
<a href="#l53.115"></a><span id="l53.115" class="difflineminus">-  else {</span>
<a href="#l53.116"></a><span id="l53.116" class="difflineplus">+  } else {</span>
<a href="#l53.117"></a><span id="l53.117">     MsgOpenSelectedMessages();</span>
<a href="#l53.118"></a><span id="l53.118">   }</span>
<a href="#l53.119"></a><span id="l53.119"> }</span>
<a href="#l53.120"></a><span id="l53.120"> </span>
<a href="#l53.121"></a><span id="l53.121" class="difflineminus">-function ThreadPaneKeyDown(event)</span>
<a href="#l53.122"></a><span id="l53.122" class="difflineminus">-{</span>
<a href="#l53.123"></a><span id="l53.123" class="difflineplus">+function ThreadPaneKeyDown(event) {</span>
<a href="#l53.124"></a><span id="l53.124">   if (event.keyCode != KeyEvent.DOM_VK_RETURN)</span>
<a href="#l53.125"></a><span id="l53.125">     return;</span>
<a href="#l53.126"></a><span id="l53.126"> </span>
<a href="#l53.127"></a><span id="l53.127">   // Grouped By Sort dummy header row &lt;enter&gt; toggles the thread's open/close</span>
<a href="#l53.128"></a><span id="l53.128">   // state. Let tree.xml handle it.</span>
<a href="#l53.129"></a><span id="l53.129">   if (gFolderDisplay.view.showGroupedBySort &amp;&amp;</span>
<a href="#l53.130"></a><span id="l53.130">       gFolderDisplay.treeSelection &amp;&amp; gFolderDisplay.treeSelection.count == 1 &amp;&amp;</span>
<a href="#l53.131"></a><span id="l53.131">       gFolderDisplay.view.isGroupedByHeaderAtIndex(gFolderDisplay.treeSelection.currentIndex)) {</span>
<a href="#l53.132"></a><span id="l53.132" class="difflineat">@@ -165,24 +153,22 @@ function ThreadPaneKeyDown(event)</span>
<a href="#l53.133"></a><span id="l53.133"> </span>
<a href="#l53.134"></a><span id="l53.134">   // Prevent any thread that happens to be last selected (currentIndex) in a</span>
<a href="#l53.135"></a><span id="l53.135">   // single or multi selection from toggling in tree.xml.</span>
<a href="#l53.136"></a><span id="l53.136">   event.stopImmediatePropagation();</span>
<a href="#l53.137"></a><span id="l53.137"> </span>
<a href="#l53.138"></a><span id="l53.138">   ThreadPaneDoubleClick();</span>
<a href="#l53.139"></a><span id="l53.139"> }</span>
<a href="#l53.140"></a><span id="l53.140"> </span>
<a href="#l53.141"></a><span id="l53.141" class="difflineminus">-function MsgSortByThread()</span>
<a href="#l53.142"></a><span id="l53.142" class="difflineminus">-{</span>
<a href="#l53.143"></a><span id="l53.143" class="difflineplus">+function MsgSortByThread() {</span>
<a href="#l53.144"></a><span id="l53.144">   gFolderDisplay.view.showThreaded = true;</span>
<a href="#l53.145"></a><span id="l53.145" class="difflineminus">-  MsgSortThreadPane('byDate');</span>
<a href="#l53.146"></a><span id="l53.146" class="difflineplus">+  MsgSortThreadPane(&quot;byDate&quot;);</span>
<a href="#l53.147"></a><span id="l53.147"> }</span>
<a href="#l53.148"></a><span id="l53.148"> </span>
<a href="#l53.149"></a><span id="l53.149" class="difflineminus">-function MsgSortThreadPane(sortName)</span>
<a href="#l53.150"></a><span id="l53.150" class="difflineminus">-{</span>
<a href="#l53.151"></a><span id="l53.151" class="difflineplus">+function MsgSortThreadPane(sortName) {</span>
<a href="#l53.152"></a><span id="l53.152">   let sortType = nsMsgViewSortType[sortName];</span>
<a href="#l53.153"></a><span id="l53.153">   let grouped = gFolderDisplay.view.showGroupedBySort;</span>
<a href="#l53.154"></a><span id="l53.154">   gFolderDisplay.view._threadExpandAll =</span>
<a href="#l53.155"></a><span id="l53.155">     Boolean(gFolderDisplay.view._viewFlags &amp; nsMsgViewFlagsType.kExpandAll);</span>
<a href="#l53.156"></a><span id="l53.156"> </span>
<a href="#l53.157"></a><span id="l53.157">   if (!grouped) {</span>
<a href="#l53.158"></a><span id="l53.158">     gFolderDisplay.view.sort(sortType, nsMsgViewSortOrder.ascending);</span>
<a href="#l53.159"></a><span id="l53.159">     // Respect user's last expandAll/collapseAll choice, post sort direction change.</span>
<a href="#l53.160"></a><span id="l53.160" class="difflineat">@@ -209,18 +195,17 @@ function MsgSortThreadPane(sortName)</span>
<a href="#l53.161"></a><span id="l53.161"> </span>
<a href="#l53.162"></a><span id="l53.162">   // Virtual folders don't persist viewFlags well in the back end,</span>
<a href="#l53.163"></a><span id="l53.163">   // due to a virtual folder being either 'real' or synthetic, so make</span>
<a href="#l53.164"></a><span id="l53.164">   // sure it's done here.</span>
<a href="#l53.165"></a><span id="l53.165">   if (gFolderDisplay.view.isVirtual)</span>
<a href="#l53.166"></a><span id="l53.166">     gFolderDisplay.view.dbView.viewFlags = gFolderDisplay.view.viewFlags;</span>
<a href="#l53.167"></a><span id="l53.167"> }</span>
<a href="#l53.168"></a><span id="l53.168"> </span>
<a href="#l53.169"></a><span id="l53.169" class="difflineminus">-function MsgReverseSortThreadPane()</span>
<a href="#l53.170"></a><span id="l53.170" class="difflineminus">-{</span>
<a href="#l53.171"></a><span id="l53.171" class="difflineplus">+function MsgReverseSortThreadPane() {</span>
<a href="#l53.172"></a><span id="l53.172">   let grouped = gFolderDisplay.view.showGroupedBySort;</span>
<a href="#l53.173"></a><span id="l53.173">   gFolderDisplay.view._threadExpandAll =</span>
<a href="#l53.174"></a><span id="l53.174">     Boolean(gFolderDisplay.view._viewFlags &amp; nsMsgViewFlagsType.kExpandAll);</span>
<a href="#l53.175"></a><span id="l53.175"> </span>
<a href="#l53.176"></a><span id="l53.176">   // Grouped By view is special for column click sort direction changes.</span>
<a href="#l53.177"></a><span id="l53.177">   if (grouped) {</span>
<a href="#l53.178"></a><span id="l53.178">     if (gDBView.selection.count)</span>
<a href="#l53.179"></a><span id="l53.179">       gFolderDisplay._saveSelection();</span>
<a href="#l53.180"></a><span id="l53.180" class="difflineat">@@ -248,69 +233,62 @@ function MsgReverseSortThreadPane()</span>
<a href="#l53.181"></a><span id="l53.181">     gFolderDisplay._restoreSelection();</span>
<a href="#l53.182"></a><span id="l53.182">   }</span>
<a href="#l53.183"></a><span id="l53.183"> </span>
<a href="#l53.184"></a><span id="l53.184">   // Respect user's last expandAll/collapseAll choice, for both threaded and grouped</span>
<a href="#l53.185"></a><span id="l53.185">   // views, post sort direction change.</span>
<a href="#l53.186"></a><span id="l53.186">   gFolderDisplay.restoreThreadState();</span>
<a href="#l53.187"></a><span id="l53.187"> }</span>
<a href="#l53.188"></a><span id="l53.188"> </span>
<a href="#l53.189"></a><span id="l53.189" class="difflineminus">-function MsgToggleThreaded()</span>
<a href="#l53.190"></a><span id="l53.190" class="difflineminus">-{</span>
<a href="#l53.191"></a><span id="l53.191" class="difflineplus">+function MsgToggleThreaded() {</span>
<a href="#l53.192"></a><span id="l53.192">   if (gFolderDisplay.view.showThreaded)</span>
<a href="#l53.193"></a><span id="l53.193">     gFolderDisplay.view.showUnthreaded = true;</span>
<a href="#l53.194"></a><span id="l53.194">   else</span>
<a href="#l53.195"></a><span id="l53.195">     gFolderDisplay.view.showThreaded = true;</span>
<a href="#l53.196"></a><span id="l53.196"> }</span>
<a href="#l53.197"></a><span id="l53.197"> </span>
<a href="#l53.198"></a><span id="l53.198" class="difflineminus">-function MsgSortThreaded()</span>
<a href="#l53.199"></a><span id="l53.199" class="difflineminus">-{</span>
<a href="#l53.200"></a><span id="l53.200" class="difflineplus">+function MsgSortThreaded() {</span>
<a href="#l53.201"></a><span id="l53.201">   gFolderDisplay.view.showThreaded = true;</span>
<a href="#l53.202"></a><span id="l53.202"> }</span>
<a href="#l53.203"></a><span id="l53.203"> </span>
<a href="#l53.204"></a><span id="l53.204" class="difflineminus">-function MsgGroupBySort()</span>
<a href="#l53.205"></a><span id="l53.205" class="difflineminus">-{</span>
<a href="#l53.206"></a><span id="l53.206" class="difflineplus">+function MsgGroupBySort() {</span>
<a href="#l53.207"></a><span id="l53.207">   gFolderDisplay.view.showGroupedBySort = true;</span>
<a href="#l53.208"></a><span id="l53.208"> }</span>
<a href="#l53.209"></a><span id="l53.209"> </span>
<a href="#l53.210"></a><span id="l53.210" class="difflineminus">-function MsgSortUnthreaded()</span>
<a href="#l53.211"></a><span id="l53.211" class="difflineminus">-{</span>
<a href="#l53.212"></a><span id="l53.212" class="difflineplus">+function MsgSortUnthreaded() {</span>
<a href="#l53.213"></a><span id="l53.213">   gFolderDisplay.view.showUnthreaded = true;</span>
<a href="#l53.214"></a><span id="l53.214"> }</span>
<a href="#l53.215"></a><span id="l53.215"> </span>
<a href="#l53.216"></a><span id="l53.216" class="difflineminus">-function MsgSortAscending()</span>
<a href="#l53.217"></a><span id="l53.217" class="difflineminus">-{</span>
<a href="#l53.218"></a><span id="l53.218" class="difflineplus">+function MsgSortAscending() {</span>
<a href="#l53.219"></a><span id="l53.219">   if (gFolderDisplay.view.showGroupedBySort &amp;&amp; gFolderDisplay.view.isSingleFolder) {</span>
<a href="#l53.220"></a><span id="l53.220">     if (gFolderDisplay.view.isSortedDescending)</span>
<a href="#l53.221"></a><span id="l53.221">        MsgReverseSortThreadPane();</span>
<a href="#l53.222"></a><span id="l53.222"> </span>
<a href="#l53.223"></a><span id="l53.223">     return;</span>
<a href="#l53.224"></a><span id="l53.224">   }</span>
<a href="#l53.225"></a><span id="l53.225"> </span>
<a href="#l53.226"></a><span id="l53.226">   gFolderDisplay.view.sortAscending();</span>
<a href="#l53.227"></a><span id="l53.227"> }</span>
<a href="#l53.228"></a><span id="l53.228"> </span>
<a href="#l53.229"></a><span id="l53.229" class="difflineminus">-function MsgSortDescending()</span>
<a href="#l53.230"></a><span id="l53.230" class="difflineminus">-{</span>
<a href="#l53.231"></a><span id="l53.231" class="difflineplus">+function MsgSortDescending() {</span>
<a href="#l53.232"></a><span id="l53.232">   if (gFolderDisplay.view.showGroupedBySort &amp;&amp; gFolderDisplay.view.isSingleFolder) {</span>
<a href="#l53.233"></a><span id="l53.233">     if (gFolderDisplay.view.isSortedAscending)</span>
<a href="#l53.234"></a><span id="l53.234">        MsgReverseSortThreadPane();</span>
<a href="#l53.235"></a><span id="l53.235"> </span>
<a href="#l53.236"></a><span id="l53.236">     return;</span>
<a href="#l53.237"></a><span id="l53.237">   }</span>
<a href="#l53.238"></a><span id="l53.238"> </span>
<a href="#l53.239"></a><span id="l53.239">   gFolderDisplay.view.sortDescending();</span>
<a href="#l53.240"></a><span id="l53.240"> }</span>
<a href="#l53.241"></a><span id="l53.241"> </span>
<a href="#l53.242"></a><span id="l53.242"> // XXX this should probably migrate into FolderDisplayWidget, or whatever</span>
<a href="#l53.243"></a><span id="l53.243"> //  FolderDisplayWidget ends up using if it refactors column management out.</span>
<a href="#l53.244"></a><span id="l53.244" class="difflineminus">-function UpdateSortIndicators(sortType, sortOrder)</span>
<a href="#l53.245"></a><span id="l53.245" class="difflineminus">-{</span>
<a href="#l53.246"></a><span id="l53.246" class="difflineplus">+function UpdateSortIndicators(sortType, sortOrder) {</span>
<a href="#l53.247"></a><span id="l53.247">   // Remove the sort indicator from all the columns</span>
<a href="#l53.248"></a><span id="l53.248" class="difflineminus">-  var treeColumns = document.getElementById('threadCols').childNodes;</span>
<a href="#l53.249"></a><span id="l53.249" class="difflineplus">+  var treeColumns = document.getElementById(&quot;threadCols&quot;).childNodes;</span>
<a href="#l53.250"></a><span id="l53.250">   for (var i = 0; i &lt; treeColumns.length; i++)</span>
<a href="#l53.251"></a><span id="l53.251">     treeColumns[i].removeAttribute(&quot;sortDirection&quot;);</span>
<a href="#l53.252"></a><span id="l53.252"> </span>
<a href="#l53.253"></a><span id="l53.253">   // show the twisties if the view is threaded</span>
<a href="#l53.254"></a><span id="l53.254">   var threadCol = document.getElementById(&quot;threadCol&quot;);</span>
<a href="#l53.255"></a><span id="l53.255">   var subjectCol = document.getElementById(&quot;subjectCol&quot;);</span>
<a href="#l53.256"></a><span id="l53.256">   var sortedColumn;</span>
<a href="#l53.257"></a><span id="l53.257">   // set the sort indicator on the column we are sorted by</span>
<a href="#l53.258"></a><span id="l53.258" class="difflineat">@@ -335,55 +313,49 @@ function UpdateSortIndicators(sortType, </span>
<a href="#l53.259"></a><span id="l53.259">     threadCol.setAttribute(&quot;sortDirection&quot;, &quot;ascending&quot;);</span>
<a href="#l53.260"></a><span id="l53.260"> </span>
<a href="#l53.261"></a><span id="l53.261">   if (sortedColumn)</span>
<a href="#l53.262"></a><span id="l53.262">     sortedColumn.setAttribute(&quot;sortDirection&quot;,</span>
<a href="#l53.263"></a><span id="l53.263">                               sortOrder == nsMsgViewSortOrder.ascending ?</span>
<a href="#l53.264"></a><span id="l53.264">                                 &quot;ascending&quot; : &quot;descending&quot;);</span>
<a href="#l53.265"></a><span id="l53.265"> }</span>
<a href="#l53.266"></a><span id="l53.266"> </span>
<a href="#l53.267"></a><span id="l53.267" class="difflineminus">-function IsSpecialFolderSelected(flags, checkAncestors)</span>
<a href="#l53.268"></a><span id="l53.268" class="difflineminus">-{</span>
<a href="#l53.269"></a><span id="l53.269" class="difflineplus">+function IsSpecialFolderSelected(flags, checkAncestors) {</span>
<a href="#l53.270"></a><span id="l53.270">   let folder = GetThreadPaneFolder();</span>
<a href="#l53.271"></a><span id="l53.271">   return folder &amp;&amp; folder.isSpecialFolder(flags, checkAncestors);</span>
<a href="#l53.272"></a><span id="l53.272"> }</span>
<a href="#l53.273"></a><span id="l53.273"> </span>
<a href="#l53.274"></a><span id="l53.274" class="difflineminus">-function GetThreadTree()</span>
<a href="#l53.275"></a><span id="l53.275" class="difflineminus">-{</span>
<a href="#l53.276"></a><span id="l53.276" class="difflineminus">-  return document.getElementById(&quot;threadTree&quot;)</span>
<a href="#l53.277"></a><span id="l53.277" class="difflineplus">+function GetThreadTree() {</span>
<a href="#l53.278"></a><span id="l53.278" class="difflineplus">+  return document.getElementById(&quot;threadTree&quot;);</span>
<a href="#l53.279"></a><span id="l53.279"> }</span>
<a href="#l53.280"></a><span id="l53.280"> </span>
<a href="#l53.281"></a><span id="l53.281" class="difflineminus">-function GetThreadPaneFolder()</span>
<a href="#l53.282"></a><span id="l53.282" class="difflineminus">-{</span>
<a href="#l53.283"></a><span id="l53.283" class="difflineplus">+function GetThreadPaneFolder() {</span>
<a href="#l53.284"></a><span id="l53.284">   try {</span>
<a href="#l53.285"></a><span id="l53.285">     return gDBView.msgFolder;</span>
<a href="#l53.286"></a><span id="l53.286" class="difflineminus">-  }</span>
<a href="#l53.287"></a><span id="l53.287" class="difflineminus">-  catch (ex) {</span>
<a href="#l53.288"></a><span id="l53.288" class="difflineplus">+  } catch (ex) {</span>
<a href="#l53.289"></a><span id="l53.289">     return null;</span>
<a href="#l53.290"></a><span id="l53.290">   }</span>
<a href="#l53.291"></a><span id="l53.291"> }</span>
<a href="#l53.292"></a><span id="l53.292"> </span>
<a href="#l53.293"></a><span id="l53.293" class="difflineminus">-function ThreadPaneOnLoad()</span>
<a href="#l53.294"></a><span id="l53.294" class="difflineminus">-{</span>
<a href="#l53.295"></a><span id="l53.295" class="difflineplus">+function ThreadPaneOnLoad() {</span>
<a href="#l53.296"></a><span id="l53.296">   var tree = GetThreadTree();</span>
<a href="#l53.297"></a><span id="l53.297">   // We won't have the tree if we're in a message window, so exit silently</span>
<a href="#l53.298"></a><span id="l53.298">   if (!tree)</span>
<a href="#l53.299"></a><span id="l53.299">     return;</span>
<a href="#l53.300"></a><span id="l53.300"> </span>
<a href="#l53.301"></a><span id="l53.301" class="difflineminus">-  tree.addEventListener(&quot;click&quot;,ThreadPaneOnClick,true);</span>
<a href="#l53.302"></a><span id="l53.302" class="difflineplus">+  tree.addEventListener(&quot;click&quot;, ThreadPaneOnClick, true);</span>
<a href="#l53.303"></a><span id="l53.303"> </span>
<a href="#l53.304"></a><span id="l53.304">   // The mousedown event listener below should only be added in the thread</span>
<a href="#l53.305"></a><span id="l53.305">   // pane of the mailnews 3pane window, not in the advanced search window.</span>
<a href="#l53.306"></a><span id="l53.306" class="difflineminus">-  if(tree.parentNode.id == &quot;searchResultListBox&quot;)</span>
<a href="#l53.307"></a><span id="l53.307" class="difflineplus">+  if (tree.parentNode.id == &quot;searchResultListBox&quot;)</span>
<a href="#l53.308"></a><span id="l53.308">     return;</span>
<a href="#l53.309"></a><span id="l53.309"> </span>
<a href="#l53.310"></a><span id="l53.310" class="difflineminus">-  tree.addEventListener(&quot;mousedown&quot;,TreeOnMouseDown,true);</span>
<a href="#l53.311"></a><span id="l53.311" class="difflineplus">+  tree.addEventListener(&quot;mousedown&quot;, TreeOnMouseDown, true);</span>
<a href="#l53.312"></a><span id="l53.312">   let delay = Services.prefs.getIntPref(&quot;mailnews.threadpane_select_delay&quot;);</span>
<a href="#l53.313"></a><span id="l53.313">   document.getElementById(&quot;threadTree&quot;)._selectDelay = delay;</span>
<a href="#l53.314"></a><span id="l53.314"> }</span>
<a href="#l53.315"></a><span id="l53.315"> </span>
<a href="#l53.316"></a><span id="l53.316" class="difflineminus">-function ThreadPaneSelectionChanged()</span>
<a href="#l53.317"></a><span id="l53.317" class="difflineminus">-{</span>
<a href="#l53.318"></a><span id="l53.318" class="difflineplus">+function ThreadPaneSelectionChanged() {</span>
<a href="#l53.319"></a><span id="l53.319">   UpdateStatusMessageCounts(gFolderDisplay.displayedFolder);</span>
<a href="#l53.320"></a><span id="l53.320">   GetThreadTree().view.selectionChanged();</span>
<a href="#l53.321"></a><span id="l53.321"> }</span>
<a href="#l53.322"></a><span id="l53.322"> </span>
<a href="#l53.323"></a><span id="l53.323" class="difflineminus">-addEventListener(&quot;load&quot;,ThreadPaneOnLoad,true);</span>
<a href="#l53.324"></a><span id="l53.324" class="difflineplus">+addEventListener(&quot;load&quot;, ThreadPaneOnLoad, true);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1" class="difflineminus">--- a/mail/base/content/toolbarIconColor.js</span>
<a href="#l54.2"></a><span id="l54.2" class="difflineplus">+++ b/mail/base/content/toolbarIconColor.js</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineat">@@ -1,72 +1,72 @@</span>
<a href="#l54.4"></a><span id="l54.4"> /**</span>
<a href="#l54.5"></a><span id="l54.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l54.6"></a><span id="l54.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l54.7"></a><span id="l54.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l54.8"></a><span id="l54.8"> </span>
<a href="#l54.9"></a><span id="l54.9"> var ToolbarIconColor = {</span>
<a href="#l54.10"></a><span id="l54.10" class="difflineminus">-  init: function () {</span>
<a href="#l54.11"></a><span id="l54.11" class="difflineplus">+  init() {</span>
<a href="#l54.12"></a><span id="l54.12">     this._initialized = true;</span>
<a href="#l54.13"></a><span id="l54.13"> </span>
<a href="#l54.14"></a><span id="l54.14">     window.addEventListener(&quot;activate&quot;, this);</span>
<a href="#l54.15"></a><span id="l54.15">     window.addEventListener(&quot;deactivate&quot;, this);</span>
<a href="#l54.16"></a><span id="l54.16">     Services.obs.addObserver(this, &quot;lightweight-theme-styling-update&quot;);</span>
<a href="#l54.17"></a><span id="l54.17"> </span>
<a href="#l54.18"></a><span id="l54.18">     // If the window isn't active now, we assume that it has never been active</span>
<a href="#l54.19"></a><span id="l54.19">     // before and will soon become active such that inferFromText will be</span>
<a href="#l54.20"></a><span id="l54.20">     // called from the initial activate event.</span>
<a href="#l54.21"></a><span id="l54.21">     if (Services.focus.activeWindow == window)</span>
<a href="#l54.22"></a><span id="l54.22">       this.inferFromText();</span>
<a href="#l54.23"></a><span id="l54.23">   },</span>
<a href="#l54.24"></a><span id="l54.24"> </span>
<a href="#l54.25"></a><span id="l54.25" class="difflineminus">-  uninit: function () {</span>
<a href="#l54.26"></a><span id="l54.26" class="difflineplus">+  uninit() {</span>
<a href="#l54.27"></a><span id="l54.27">     this._initialized = false;</span>
<a href="#l54.28"></a><span id="l54.28"> </span>
<a href="#l54.29"></a><span id="l54.29">     window.removeEventListener(&quot;activate&quot;, this);</span>
<a href="#l54.30"></a><span id="l54.30">     window.removeEventListener(&quot;deactivate&quot;, this);</span>
<a href="#l54.31"></a><span id="l54.31">     Services.obs.removeObserver(this, &quot;lightweight-theme-styling-update&quot;);</span>
<a href="#l54.32"></a><span id="l54.32">   },</span>
<a href="#l54.33"></a><span id="l54.33"> </span>
<a href="#l54.34"></a><span id="l54.34" class="difflineminus">-  handleEvent: function (event) {</span>
<a href="#l54.35"></a><span id="l54.35" class="difflineplus">+  handleEvent(event) {</span>
<a href="#l54.36"></a><span id="l54.36">     switch (event.type) {</span>
<a href="#l54.37"></a><span id="l54.37">       case &quot;activate&quot;:</span>
<a href="#l54.38"></a><span id="l54.38">       case &quot;deactivate&quot;:</span>
<a href="#l54.39"></a><span id="l54.39">         this.inferFromText();</span>
<a href="#l54.40"></a><span id="l54.40">         break;</span>
<a href="#l54.41"></a><span id="l54.41">     }</span>
<a href="#l54.42"></a><span id="l54.42">   },</span>
<a href="#l54.43"></a><span id="l54.43"> </span>
<a href="#l54.44"></a><span id="l54.44" class="difflineminus">-  observe: function (aSubject, aTopic, aData) {</span>
<a href="#l54.45"></a><span id="l54.45" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l54.46"></a><span id="l54.46">     switch (aTopic) {</span>
<a href="#l54.47"></a><span id="l54.47">       case &quot;lightweight-theme-styling-update&quot;:</span>
<a href="#l54.48"></a><span id="l54.48">         // inferFromText needs to run after LightweightThemeConsumer.jsm's</span>
<a href="#l54.49"></a><span id="l54.49">         // lightweight-theme-styling-update observer.</span>
<a href="#l54.50"></a><span id="l54.50">         setTimeout(() =&gt; { this.inferFromText(); }, 0);</span>
<a href="#l54.51"></a><span id="l54.51">         break;</span>
<a href="#l54.52"></a><span id="l54.52">     }</span>
<a href="#l54.53"></a><span id="l54.53">   },</span>
<a href="#l54.54"></a><span id="l54.54"> </span>
<a href="#l54.55"></a><span id="l54.55" class="difflineminus">-  inferFromText: function () {</span>
<a href="#l54.56"></a><span id="l54.56" class="difflineplus">+  inferFromText() {</span>
<a href="#l54.57"></a><span id="l54.57">     if (!this._initialized)</span>
<a href="#l54.58"></a><span id="l54.58">       return;</span>
<a href="#l54.59"></a><span id="l54.59"> </span>
<a href="#l54.60"></a><span id="l54.60">     function parseRGB(aColorString) {</span>
<a href="#l54.61"></a><span id="l54.61">       let rgb = aColorString.match(/^rgba?\((\d+), (\d+), (\d+)/);</span>
<a href="#l54.62"></a><span id="l54.62">       rgb.shift();</span>
<a href="#l54.63"></a><span id="l54.63">       return rgb.map(x =&gt; parseInt(x));</span>
<a href="#l54.64"></a><span id="l54.64">     }</span>
<a href="#l54.65"></a><span id="l54.65"> </span>
<a href="#l54.66"></a><span id="l54.66">     let toolbarSelector = &quot;toolbox &gt; toolbar:not([collapsed=true])&quot;;</span>
<a href="#l54.67"></a><span id="l54.67" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l54.68"></a><span id="l54.68" class="difflineminus">-    toolbarSelector += &quot;:not([type=menubar])&quot;;</span>
<a href="#l54.69"></a><span id="l54.69" class="difflineminus">-#endif</span>
<a href="#l54.70"></a><span id="l54.70" class="difflineplus">+    if (AppConstants.platform == &quot;macosx&quot;) {</span>
<a href="#l54.71"></a><span id="l54.71" class="difflineplus">+      toolbarSelector += &quot;:not([type=menubar])&quot;;</span>
<a href="#l54.72"></a><span id="l54.72" class="difflineplus">+    }</span>
<a href="#l54.73"></a><span id="l54.73"> </span>
<a href="#l54.74"></a><span id="l54.74">     for (let toolbar of document.querySelectorAll(toolbarSelector)) {</span>
<a href="#l54.75"></a><span id="l54.75">       let [r, g, b] = parseRGB(getComputedStyle(toolbar).color);</span>
<a href="#l54.76"></a><span id="l54.76">       let luminance = 0.2125 * r + 0.7154 * g + 0.0721 * b;</span>
<a href="#l54.77"></a><span id="l54.77">       if (luminance &lt;= 110)</span>
<a href="#l54.78"></a><span id="l54.78">         toolbar.removeAttribute(&quot;brighttext&quot;);</span>
<a href="#l54.79"></a><span id="l54.79">       else</span>
<a href="#l54.80"></a><span id="l54.80">         toolbar.setAttribute(&quot;brighttext&quot;, &quot;true&quot;);</span>
<a href="#l54.81"></a><span id="l54.81">     }</span>
<a href="#l54.82"></a><span id="l54.82" class="difflineminus">-  }</span>
<a href="#l54.83"></a><span id="l54.83" class="difflineminus">-}</span>
<a href="#l54.84"></a><span id="l54.84" class="difflineplus">+  },</span>
<a href="#l54.85"></a><span id="l54.85" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1" class="difflineminus">--- a/mail/base/content/utilityOverlay.js</span>
<a href="#l55.2"></a><span id="l55.2" class="difflineplus">+++ b/mail/base/content/utilityOverlay.js</span>
<a href="#l55.3"></a><span id="l55.3" class="difflineat">@@ -7,49 +7,45 @@ ChromeUtils.import(&quot;resource://gre/modul</span>
<a href="#l55.4"></a><span id="l55.4"> </span>
<a href="#l55.5"></a><span id="l55.5"> var gShowBiDi = false;</span>
<a href="#l55.6"></a><span id="l55.6"> </span>
<a href="#l55.7"></a><span id="l55.7"> function getBrowserURL() {</span>
<a href="#l55.8"></a><span id="l55.8">   return AppConstants.BROWSER_CHROME_URL;</span>
<a href="#l55.9"></a><span id="l55.9"> }</span>
<a href="#l55.10"></a><span id="l55.10"> </span>
<a href="#l55.11"></a><span id="l55.11"> // update menu items that rely on focus</span>
<a href="#l55.12"></a><span id="l55.12" class="difflineminus">-function goUpdateGlobalEditMenuItems()</span>
<a href="#l55.13"></a><span id="l55.13" class="difflineminus">-{</span>
<a href="#l55.14"></a><span id="l55.14" class="difflineminus">-  goUpdateCommand('cmd_undo');</span>
<a href="#l55.15"></a><span id="l55.15" class="difflineminus">-  goUpdateCommand('cmd_redo');</span>
<a href="#l55.16"></a><span id="l55.16" class="difflineminus">-  goUpdateCommand('cmd_cut');</span>
<a href="#l55.17"></a><span id="l55.17" class="difflineminus">-  goUpdateCommand('cmd_copy');</span>
<a href="#l55.18"></a><span id="l55.18" class="difflineminus">-  goUpdateCommand('cmd_paste');</span>
<a href="#l55.19"></a><span id="l55.19" class="difflineminus">-  goUpdateCommand('cmd_selectAll');</span>
<a href="#l55.20"></a><span id="l55.20" class="difflineminus">-  goUpdateCommand('cmd_delete');</span>
<a href="#l55.21"></a><span id="l55.21" class="difflineplus">+function goUpdateGlobalEditMenuItems() {</span>
<a href="#l55.22"></a><span id="l55.22" class="difflineplus">+  goUpdateCommand(&quot;cmd_undo&quot;);</span>
<a href="#l55.23"></a><span id="l55.23" class="difflineplus">+  goUpdateCommand(&quot;cmd_redo&quot;);</span>
<a href="#l55.24"></a><span id="l55.24" class="difflineplus">+  goUpdateCommand(&quot;cmd_cut&quot;);</span>
<a href="#l55.25"></a><span id="l55.25" class="difflineplus">+  goUpdateCommand(&quot;cmd_copy&quot;);</span>
<a href="#l55.26"></a><span id="l55.26" class="difflineplus">+  goUpdateCommand(&quot;cmd_paste&quot;);</span>
<a href="#l55.27"></a><span id="l55.27" class="difflineplus">+  goUpdateCommand(&quot;cmd_selectAll&quot;);</span>
<a href="#l55.28"></a><span id="l55.28" class="difflineplus">+  goUpdateCommand(&quot;cmd_delete&quot;);</span>
<a href="#l55.29"></a><span id="l55.29">   if (gShowBiDi)</span>
<a href="#l55.30"></a><span id="l55.30" class="difflineminus">-    goUpdateCommand('cmd_switchTextDirection');</span>
<a href="#l55.31"></a><span id="l55.31" class="difflineplus">+    goUpdateCommand(&quot;cmd_switchTextDirection&quot;);</span>
<a href="#l55.32"></a><span id="l55.32"> }</span>
<a href="#l55.33"></a><span id="l55.33"> </span>
<a href="#l55.34"></a><span id="l55.34"> // update menu items that rely on the current selection</span>
<a href="#l55.35"></a><span id="l55.35" class="difflineminus">-function goUpdateSelectEditMenuItems()</span>
<a href="#l55.36"></a><span id="l55.36" class="difflineminus">-{</span>
<a href="#l55.37"></a><span id="l55.37" class="difflineminus">-  goUpdateCommand('cmd_cut');</span>
<a href="#l55.38"></a><span id="l55.38" class="difflineminus">-  goUpdateCommand('cmd_copy');</span>
<a href="#l55.39"></a><span id="l55.39" class="difflineminus">-  goUpdateCommand('cmd_delete');</span>
<a href="#l55.40"></a><span id="l55.40" class="difflineminus">-  goUpdateCommand('cmd_selectAll');</span>
<a href="#l55.41"></a><span id="l55.41" class="difflineplus">+function goUpdateSelectEditMenuItems() {</span>
<a href="#l55.42"></a><span id="l55.42" class="difflineplus">+  goUpdateCommand(&quot;cmd_cut&quot;);</span>
<a href="#l55.43"></a><span id="l55.43" class="difflineplus">+  goUpdateCommand(&quot;cmd_copy&quot;);</span>
<a href="#l55.44"></a><span id="l55.44" class="difflineplus">+  goUpdateCommand(&quot;cmd_delete&quot;);</span>
<a href="#l55.45"></a><span id="l55.45" class="difflineplus">+  goUpdateCommand(&quot;cmd_selectAll&quot;);</span>
<a href="#l55.46"></a><span id="l55.46"> }</span>
<a href="#l55.47"></a><span id="l55.47"> </span>
<a href="#l55.48"></a><span id="l55.48"> // update menu items that relate to undo/redo</span>
<a href="#l55.49"></a><span id="l55.49" class="difflineminus">-function goUpdateUndoEditMenuItems()</span>
<a href="#l55.50"></a><span id="l55.50" class="difflineminus">-{</span>
<a href="#l55.51"></a><span id="l55.51" class="difflineminus">-  goUpdateCommand('cmd_undo');</span>
<a href="#l55.52"></a><span id="l55.52" class="difflineminus">-  goUpdateCommand('cmd_redo');</span>
<a href="#l55.53"></a><span id="l55.53" class="difflineplus">+function goUpdateUndoEditMenuItems() {</span>
<a href="#l55.54"></a><span id="l55.54" class="difflineplus">+  goUpdateCommand(&quot;cmd_undo&quot;);</span>
<a href="#l55.55"></a><span id="l55.55" class="difflineplus">+  goUpdateCommand(&quot;cmd_redo&quot;);</span>
<a href="#l55.56"></a><span id="l55.56"> }</span>
<a href="#l55.57"></a><span id="l55.57"> </span>
<a href="#l55.58"></a><span id="l55.58"> // update menu items that depend on clipboard contents</span>
<a href="#l55.59"></a><span id="l55.59" class="difflineminus">-function goUpdatePasteMenuItems()</span>
<a href="#l55.60"></a><span id="l55.60" class="difflineminus">-{</span>
<a href="#l55.61"></a><span id="l55.61" class="difflineminus">-  goUpdateCommand('cmd_paste');</span>
<a href="#l55.62"></a><span id="l55.62" class="difflineplus">+function goUpdatePasteMenuItems() {</span>
<a href="#l55.63"></a><span id="l55.63" class="difflineplus">+  goUpdateCommand(&quot;cmd_paste&quot;);</span>
<a href="#l55.64"></a><span id="l55.64"> }</span>
<a href="#l55.65"></a><span id="l55.65"> </span>
<a href="#l55.66"></a><span id="l55.66"> function goCopyImage() {</span>
<a href="#l55.67"></a><span id="l55.67">   let img = document.popupNode;</span>
<a href="#l55.68"></a><span id="l55.68">   if (/^(https?|data):/i.test(img.src)) {</span>
<a href="#l55.69"></a><span id="l55.69">     goDoCommand(&quot;cmd_copyImage&quot;);</span>
<a href="#l55.70"></a><span id="l55.70">     return;</span>
<a href="#l55.71"></a><span id="l55.71">   }</span>
<a href="#l55.72"></a><span id="l55.72" class="difflineat">@@ -59,182 +55,168 @@ function goCopyImage() {</span>
<a href="#l55.73"></a><span id="l55.73">   param.setLongValue(&quot;imageCopy&quot;,</span>
<a href="#l55.74"></a><span id="l55.74">                      Ci.nsIContentViewerEdit.COPY_IMAGE_DATA);</span>
<a href="#l55.75"></a><span id="l55.75">   document.commandDispatcher.getControllerForCommand(&quot;cmd_copyImage&quot;)</span>
<a href="#l55.76"></a><span id="l55.76">           .QueryInterface(Ci.nsICommandController)</span>
<a href="#l55.77"></a><span id="l55.77">           .doCommandWithParams(&quot;cmd_copyImage&quot;, param);</span>
<a href="#l55.78"></a><span id="l55.78"> }</span>
<a href="#l55.79"></a><span id="l55.79"> </span>
<a href="#l55.80"></a><span id="l55.80"> // update Find As You Type menu items, they rely on focus</span>
<a href="#l55.81"></a><span id="l55.81" class="difflineminus">-function goUpdateFindTypeMenuItems()</span>
<a href="#l55.82"></a><span id="l55.82" class="difflineminus">-{</span>
<a href="#l55.83"></a><span id="l55.83" class="difflineminus">-  goUpdateCommand('cmd_findTypeText');</span>
<a href="#l55.84"></a><span id="l55.84" class="difflineminus">-  goUpdateCommand('cmd_findTypeLinks');</span>
<a href="#l55.85"></a><span id="l55.85" class="difflineplus">+function goUpdateFindTypeMenuItems() {</span>
<a href="#l55.86"></a><span id="l55.86" class="difflineplus">+  goUpdateCommand(&quot;cmd_findTypeText&quot;);</span>
<a href="#l55.87"></a><span id="l55.87" class="difflineplus">+  goUpdateCommand(&quot;cmd_findTypeLinks&quot;);</span>
<a href="#l55.88"></a><span id="l55.88"> }</span>
<a href="#l55.89"></a><span id="l55.89"> </span>
<a href="#l55.90"></a><span id="l55.90"> // Gather all descendent text under given document node.</span>
<a href="#l55.91"></a><span id="l55.91" class="difflineminus">-function gatherTextUnder ( root )</span>
<a href="#l55.92"></a><span id="l55.92" class="difflineminus">-{</span>
<a href="#l55.93"></a><span id="l55.93" class="difflineplus">+function gatherTextUnder(root) {</span>
<a href="#l55.94"></a><span id="l55.94">   var text = &quot;&quot;;</span>
<a href="#l55.95"></a><span id="l55.95">   var node = root.firstChild;</span>
<a href="#l55.96"></a><span id="l55.96">   var depth = 1;</span>
<a href="#l55.97"></a><span id="l55.97" class="difflineminus">-  while ( node &amp;&amp; depth &gt; 0 ) {</span>
<a href="#l55.98"></a><span id="l55.98" class="difflineplus">+  while (node &amp;&amp; depth &gt; 0) {</span>
<a href="#l55.99"></a><span id="l55.99">     // See if this node is text.</span>
<a href="#l55.100"></a><span id="l55.100" class="difflineminus">-    if ( node.nodeType == Node.TEXT_NODE ) {</span>
<a href="#l55.101"></a><span id="l55.101" class="difflineplus">+    if (node.nodeType == Node.TEXT_NODE) {</span>
<a href="#l55.102"></a><span id="l55.102">       // Add this text to our collection.</span>
<a href="#l55.103"></a><span id="l55.103">       text += &quot; &quot; + node.data;</span>
<a href="#l55.104"></a><span id="l55.104" class="difflineminus">-    } else if ( node instanceof HTMLImageElement ) {</span>
<a href="#l55.105"></a><span id="l55.105" class="difflineplus">+    } else if (node instanceof HTMLImageElement) {</span>
<a href="#l55.106"></a><span id="l55.106">       // If it has an alt= attribute, add that.</span>
<a href="#l55.107"></a><span id="l55.107" class="difflineminus">-      var altText = node.getAttribute( &quot;alt&quot; );</span>
<a href="#l55.108"></a><span id="l55.108" class="difflineminus">-      if ( altText &amp;&amp; altText != &quot;&quot; ) {</span>
<a href="#l55.109"></a><span id="l55.109" class="difflineplus">+      var altText = node.getAttribute(&quot;alt&quot;);</span>
<a href="#l55.110"></a><span id="l55.110" class="difflineplus">+      if (altText &amp;&amp; altText != &quot;&quot;) {</span>
<a href="#l55.111"></a><span id="l55.111">         text += &quot; &quot; + altText;</span>
<a href="#l55.112"></a><span id="l55.112">       }</span>
<a href="#l55.113"></a><span id="l55.113">     }</span>
<a href="#l55.114"></a><span id="l55.114">     // Find next node to test.</span>
<a href="#l55.115"></a><span id="l55.115">     // First, see if this node has children.</span>
<a href="#l55.116"></a><span id="l55.116" class="difflineminus">-    if ( node.hasChildNodes() ) {</span>
<a href="#l55.117"></a><span id="l55.117" class="difflineplus">+    if (node.hasChildNodes()) {</span>
<a href="#l55.118"></a><span id="l55.118">       // Go to first child.</span>
<a href="#l55.119"></a><span id="l55.119">       node = node.firstChild;</span>
<a href="#l55.120"></a><span id="l55.120">       depth++;</span>
<a href="#l55.121"></a><span id="l55.121" class="difflineminus">-    } else {</span>
<a href="#l55.122"></a><span id="l55.122" class="difflineplus">+    } else if (node.nextSibling) {</span>
<a href="#l55.123"></a><span id="l55.123">       // No children, try next sibling.</span>
<a href="#l55.124"></a><span id="l55.124" class="difflineminus">-      if ( node.nextSibling ) {</span>
<a href="#l55.125"></a><span id="l55.125" class="difflineminus">-        node = node.nextSibling;</span>
<a href="#l55.126"></a><span id="l55.126" class="difflineminus">-      } else {</span>
<a href="#l55.127"></a><span id="l55.127" class="difflineminus">-        // Last resort is a sibling of an ancestor.</span>
<a href="#l55.128"></a><span id="l55.128" class="difflineminus">-        while ( node &amp;&amp; depth &gt; 0 ) {</span>
<a href="#l55.129"></a><span id="l55.129" class="difflineminus">-          node = node.parentNode;</span>
<a href="#l55.130"></a><span id="l55.130" class="difflineminus">-          depth--;</span>
<a href="#l55.131"></a><span id="l55.131" class="difflineminus">-          if ( node.nextSibling ) {</span>
<a href="#l55.132"></a><span id="l55.132" class="difflineminus">-            node = node.nextSibling;</span>
<a href="#l55.133"></a><span id="l55.133" class="difflineminus">-            break;</span>
<a href="#l55.134"></a><span id="l55.134" class="difflineminus">-          }</span>
<a href="#l55.135"></a><span id="l55.135" class="difflineplus">+      node = node.nextSibling;</span>
<a href="#l55.136"></a><span id="l55.136" class="difflineplus">+    } else {</span>
<a href="#l55.137"></a><span id="l55.137" class="difflineplus">+      // Last resort is a sibling of an ancestor.</span>
<a href="#l55.138"></a><span id="l55.138" class="difflineplus">+      while (node &amp;&amp; depth &gt; 0) {</span>
<a href="#l55.139"></a><span id="l55.139" class="difflineplus">+        node = node.parentNode;</span>
<a href="#l55.140"></a><span id="l55.140" class="difflineplus">+        depth--;</span>
<a href="#l55.141"></a><span id="l55.141" class="difflineplus">+        if (node.nextSibling) {</span>
<a href="#l55.142"></a><span id="l55.142" class="difflineplus">+          node = node.nextSibling;</span>
<a href="#l55.143"></a><span id="l55.143" class="difflineplus">+          break;</span>
<a href="#l55.144"></a><span id="l55.144">         }</span>
<a href="#l55.145"></a><span id="l55.145">       }</span>
<a href="#l55.146"></a><span id="l55.146">     }</span>
<a href="#l55.147"></a><span id="l55.147">   }</span>
<a href="#l55.148"></a><span id="l55.148">   // Strip leading and trailing whitespace.</span>
<a href="#l55.149"></a><span id="l55.149">   text = text.trim();</span>
<a href="#l55.150"></a><span id="l55.150">   // Compress remaining whitespace.</span>
<a href="#l55.151"></a><span id="l55.151" class="difflineminus">-  text = text.replace( /\s+/g, &quot; &quot; );</span>
<a href="#l55.152"></a><span id="l55.152" class="difflineplus">+  text = text.replace(/\s+/g, &quot; &quot;);</span>
<a href="#l55.153"></a><span id="l55.153">   return text;</span>
<a href="#l55.154"></a><span id="l55.154"> }</span>
<a href="#l55.155"></a><span id="l55.155"> </span>
<a href="#l55.156"></a><span id="l55.156" class="difflineminus">-function GenerateValidFilename(filename, extension)</span>
<a href="#l55.157"></a><span id="l55.157" class="difflineminus">-{</span>
<a href="#l55.158"></a><span id="l55.158" class="difflineminus">-  if (filename) // we have a title; let's see if it's usable</span>
<a href="#l55.159"></a><span id="l55.159" class="difflineminus">-  {</span>
<a href="#l55.160"></a><span id="l55.160" class="difflineplus">+function GenerateValidFilename(filename, extension) {</span>
<a href="#l55.161"></a><span id="l55.161" class="difflineplus">+  if (filename) { // we have a title; let's see if it's usable</span>
<a href="#l55.162"></a><span id="l55.162">     // clean up the filename to make it usable and</span>
<a href="#l55.163"></a><span id="l55.163">     // then trim whitespace from beginning and end</span>
<a href="#l55.164"></a><span id="l55.164">     filename = validateFileName(filename).trim();</span>
<a href="#l55.165"></a><span id="l55.165">     if (filename.length &gt; 0)</span>
<a href="#l55.166"></a><span id="l55.166">       return filename + extension;</span>
<a href="#l55.167"></a><span id="l55.167">   }</span>
<a href="#l55.168"></a><span id="l55.168">   return null;</span>
<a href="#l55.169"></a><span id="l55.169"> }</span>
<a href="#l55.170"></a><span id="l55.170"> </span>
<a href="#l55.171"></a><span id="l55.171" class="difflineminus">-function validateFileName(aFileName)</span>
<a href="#l55.172"></a><span id="l55.172" class="difflineminus">-{</span>
<a href="#l55.173"></a><span id="l55.173" class="difflineplus">+function validateFileName(aFileName) {</span>
<a href="#l55.174"></a><span id="l55.174">   var re = /[\/]+/g;</span>
<a href="#l55.175"></a><span id="l55.175">   if (navigator.appVersion.includes(&quot;Windows&quot;)) {</span>
<a href="#l55.176"></a><span id="l55.176">     re = /[\\\/\|]+/g;</span>
<a href="#l55.177"></a><span id="l55.177">     aFileName = aFileName.replace(/[\&quot;]+/g, &quot;'&quot;);</span>
<a href="#l55.178"></a><span id="l55.178">     aFileName = aFileName.replace(/[\*\:\?]+/g, &quot; &quot;);</span>
<a href="#l55.179"></a><span id="l55.179">     aFileName = aFileName.replace(/[\&lt;]+/g, &quot;(&quot;);</span>
<a href="#l55.180"></a><span id="l55.180">     aFileName = aFileName.replace(/[\&gt;]+/g, &quot;)&quot;);</span>
<a href="#l55.181"></a><span id="l55.181" class="difflineplus">+  } else if (navigator.appVersion.includes(&quot;Macintosh&quot;)) {</span>
<a href="#l55.182"></a><span id="l55.182" class="difflineplus">+    re = /[\:\/]+/g;</span>
<a href="#l55.183"></a><span id="l55.183">   }</span>
<a href="#l55.184"></a><span id="l55.184" class="difflineminus">-  else if (navigator.appVersion.includes(&quot;Macintosh&quot;))</span>
<a href="#l55.185"></a><span id="l55.185" class="difflineminus">-    re = /[\:\/]+/g;</span>
<a href="#l55.186"></a><span id="l55.186"> </span>
<a href="#l55.187"></a><span id="l55.187">   if (Services.prefs.getBoolPref(&quot;mail.save_msg_filename_underscores_for_space&quot;))</span>
<a href="#l55.188"></a><span id="l55.188">     aFileName = aFileName.replace(/ /g, &quot;_&quot;);</span>
<a href="#l55.189"></a><span id="l55.189"> </span>
<a href="#l55.190"></a><span id="l55.190">   return aFileName.replace(re, &quot;_&quot;);</span>
<a href="#l55.191"></a><span id="l55.191"> }</span>
<a href="#l55.192"></a><span id="l55.192"> </span>
<a href="#l55.193"></a><span id="l55.193" class="difflineminus">-function goToggleToolbar( id, elementID )</span>
<a href="#l55.194"></a><span id="l55.194" class="difflineminus">-{</span>
<a href="#l55.195"></a><span id="l55.195" class="difflineminus">-  var toolbar = document.getElementById( id );</span>
<a href="#l55.196"></a><span id="l55.196" class="difflineminus">-  var element = document.getElementById( elementID );</span>
<a href="#l55.197"></a><span id="l55.197" class="difflineminus">-  if ( toolbar )</span>
<a href="#l55.198"></a><span id="l55.198" class="difflineminus">-  {</span>
<a href="#l55.199"></a><span id="l55.199" class="difflineplus">+function goToggleToolbar(id, elementID) {</span>
<a href="#l55.200"></a><span id="l55.200" class="difflineplus">+  var toolbar = document.getElementById(id);</span>
<a href="#l55.201"></a><span id="l55.201" class="difflineplus">+  var element = document.getElementById(elementID);</span>
<a href="#l55.202"></a><span id="l55.202" class="difflineplus">+  if (toolbar) {</span>
<a href="#l55.203"></a><span id="l55.203">     var isHidden = toolbar.getAttribute(&quot;hidden&quot;) == &quot;true&quot;;</span>
<a href="#l55.204"></a><span id="l55.204">     toolbar.setAttribute(&quot;hidden&quot;, !isHidden);</span>
<a href="#l55.205"></a><span id="l55.205" class="difflineminus">-    if ( element )</span>
<a href="#l55.206"></a><span id="l55.206" class="difflineminus">-      element.setAttribute(&quot;checked&quot;, isHidden)</span>
<a href="#l55.207"></a><span id="l55.207" class="difflineplus">+    if (element)</span>
<a href="#l55.208"></a><span id="l55.208" class="difflineplus">+      element.setAttribute(&quot;checked&quot;, isHidden);</span>
<a href="#l55.209"></a><span id="l55.209">     Services.xulStore.persist(toolbar, &quot;hidden&quot;);</span>
<a href="#l55.210"></a><span id="l55.210">     Services.xulStore.persist(element, &quot;checked&quot;);</span>
<a href="#l55.211"></a><span id="l55.211">   }</span>
<a href="#l55.212"></a><span id="l55.212"> }</span>
<a href="#l55.213"></a><span id="l55.213"> </span>
<a href="#l55.214"></a><span id="l55.214"> /**</span>
<a href="#l55.215"></a><span id="l55.215">  * Toggle a splitter to show or hide some piece of UI (e.g. the message preview</span>
<a href="#l55.216"></a><span id="l55.216">  * pane).</span>
<a href="#l55.217"></a><span id="l55.217">  *</span>
<a href="#l55.218"></a><span id="l55.218">  * @param splitterId the splliter that should be toggled</span>
<a href="#l55.219"></a><span id="l55.219">  */</span>
<a href="#l55.220"></a><span id="l55.220" class="difflineminus">-function togglePaneSplitter(splitterId)</span>
<a href="#l55.221"></a><span id="l55.221" class="difflineminus">-{</span>
<a href="#l55.222"></a><span id="l55.222" class="difflineplus">+function togglePaneSplitter(splitterId) {</span>
<a href="#l55.223"></a><span id="l55.223">   var splitter = document.getElementById(splitterId);</span>
<a href="#l55.224"></a><span id="l55.224">   var state = splitter.getAttribute(&quot;state&quot;);</span>
<a href="#l55.225"></a><span id="l55.225">   if (state == &quot;collapsed&quot;)</span>
<a href="#l55.226"></a><span id="l55.226">     splitter.setAttribute(&quot;state&quot;, &quot;open&quot;);</span>
<a href="#l55.227"></a><span id="l55.227">   else</span>
<a href="#l55.228"></a><span id="l55.228" class="difflineminus">-    splitter.setAttribute(&quot;state&quot;, &quot;collapsed&quot;)</span>
<a href="#l55.229"></a><span id="l55.229" class="difflineplus">+    splitter.setAttribute(&quot;state&quot;, &quot;collapsed&quot;);</span>
<a href="#l55.230"></a><span id="l55.230"> }</span>
<a href="#l55.231"></a><span id="l55.231"> </span>
<a href="#l55.232"></a><span id="l55.232"> // openUILink handles clicks on UI elements that cause URLs to load.</span>
<a href="#l55.233"></a><span id="l55.233"> // Firefox and SeaMonkey have a function with the same name,</span>
<a href="#l55.234"></a><span id="l55.234"> // so extensions can use this everywhere to open links.</span>
<a href="#l55.235"></a><span id="l55.235"> // We currently only react to left click in Thunderbird.</span>
<a href="#l55.236"></a><span id="l55.236" class="difflineminus">-function openUILink(url, event)</span>
<a href="#l55.237"></a><span id="l55.237" class="difflineminus">-{</span>
<a href="#l55.238"></a><span id="l55.238" class="difflineplus">+function openUILink(url, event) {</span>
<a href="#l55.239"></a><span id="l55.239">   if (!event.button) {</span>
<a href="#l55.240"></a><span id="l55.240">     PlacesUtils.history.insert({</span>
<a href="#l55.241"></a><span id="l55.241">       url,</span>
<a href="#l55.242"></a><span id="l55.242">       visits: [{</span>
<a href="#l55.243"></a><span id="l55.243" class="difflineminus">-        date: new Date()</span>
<a href="#l55.244"></a><span id="l55.244" class="difflineminus">-      }]</span>
<a href="#l55.245"></a><span id="l55.245" class="difflineplus">+        date: new Date(),</span>
<a href="#l55.246"></a><span id="l55.246" class="difflineplus">+      }],</span>
<a href="#l55.247"></a><span id="l55.247">     }).catch(Cu.reportError);</span>
<a href="#l55.248"></a><span id="l55.248">     messenger.launchExternalURL(url);</span>
<a href="#l55.249"></a><span id="l55.249">   }</span>
<a href="#l55.250"></a><span id="l55.250"> }</span>
<a href="#l55.251"></a><span id="l55.251"> </span>
<a href="#l55.252"></a><span id="l55.252" class="difflineminus">-function openWhatsNew()</span>
<a href="#l55.253"></a><span id="l55.253" class="difflineminus">-{</span>
<a href="#l55.254"></a><span id="l55.254" class="difflineplus">+function openWhatsNew() {</span>
<a href="#l55.255"></a><span id="l55.255">   openContentTab(Services.urlFormatter.formatURLPref(&quot;mailnews.start_page.override_url&quot;));</span>
<a href="#l55.256"></a><span id="l55.256"> }</span>
<a href="#l55.257"></a><span id="l55.257"> </span>
<a href="#l55.258"></a><span id="l55.258"> /**</span>
<a href="#l55.259"></a><span id="l55.259">  * Open a web search in the default browser for a given query.</span>
<a href="#l55.260"></a><span id="l55.260">  *</span>
<a href="#l55.261"></a><span id="l55.261">  * @param query the string to search for</span>
<a href="#l55.262"></a><span id="l55.262">  * @param engine (optional) the search engine to use</span>
<a href="#l55.263"></a><span id="l55.263">  */</span>
<a href="#l55.264"></a><span id="l55.264" class="difflineminus">-function openWebSearch(query, engine)</span>
<a href="#l55.265"></a><span id="l55.265" class="difflineminus">-{</span>
<a href="#l55.266"></a><span id="l55.266" class="difflineplus">+function openWebSearch(query, engine) {</span>
<a href="#l55.267"></a><span id="l55.267">   Services.search.init({</span>
<a href="#l55.268"></a><span id="l55.268" class="difflineminus">-    onInitComplete: function() {</span>
<a href="#l55.269"></a><span id="l55.269" class="difflineplus">+    onInitComplete() {</span>
<a href="#l55.270"></a><span id="l55.270">       if (!engine)</span>
<a href="#l55.271"></a><span id="l55.271">         engine = Services.search.currentEngine;</span>
<a href="#l55.272"></a><span id="l55.272">       openLinkExternally(engine.getSubmission(query).uri.spec);</span>
<a href="#l55.273"></a><span id="l55.273" class="difflineminus">-    }</span>
<a href="#l55.274"></a><span id="l55.274" class="difflineplus">+    },</span>
<a href="#l55.275"></a><span id="l55.275">   });</span>
<a href="#l55.276"></a><span id="l55.276"> }</span>
<a href="#l55.277"></a><span id="l55.277"> </span>
<a href="#l55.278"></a><span id="l55.278"> /**</span>
<a href="#l55.279"></a><span id="l55.279">  * Open the specified tab type (possibly in a new window)</span>
<a href="#l55.280"></a><span id="l55.280">  *</span>
<a href="#l55.281"></a><span id="l55.281">  * @param tabType the tab type to open (e.g. &quot;contentTab&quot;)</span>
<a href="#l55.282"></a><span id="l55.282">  * @param tabParams the parameters to pass to the tab</span>
<a href="#l55.283"></a><span id="l55.283">  * @param where 'tab' to open in a new tab (default) or 'window' to open in a</span>
<a href="#l55.284"></a><span id="l55.284">  *        new window</span>
<a href="#l55.285"></a><span id="l55.285">  */</span>
<a href="#l55.286"></a><span id="l55.286" class="difflineminus">-function openTab(tabType, tabParams, where)</span>
<a href="#l55.287"></a><span id="l55.287" class="difflineminus">-{</span>
<a href="#l55.288"></a><span id="l55.288" class="difflineplus">+function openTab(tabType, tabParams, where) {</span>
<a href="#l55.289"></a><span id="l55.289">   if (where != &quot;window&quot;) {</span>
<a href="#l55.290"></a><span id="l55.290">     let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l55.291"></a><span id="l55.291">     if (!tabmail) {</span>
<a href="#l55.292"></a><span id="l55.292">       // Try opening new tabs in an existing 3pane window</span>
<a href="#l55.293"></a><span id="l55.293">       let mail3PaneWindow = Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l55.294"></a><span id="l55.294">       if (mail3PaneWindow) {</span>
<a href="#l55.295"></a><span id="l55.295">         tabmail = mail3PaneWindow.document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l55.296"></a><span id="l55.296">         mail3PaneWindow.focus();</span>
<a href="#l55.297"></a><span id="l55.297" class="difflineat">@@ -246,57 +228,55 @@ function openTab(tabType, tabParams, whe</span>
<a href="#l55.298"></a><span id="l55.298">       return;</span>
<a href="#l55.299"></a><span id="l55.299">     }</span>
<a href="#l55.300"></a><span id="l55.300">   }</span>
<a href="#l55.301"></a><span id="l55.301"> </span>
<a href="#l55.302"></a><span id="l55.302">   // Either we explicitly wanted to open in a new window, or we fell through to</span>
<a href="#l55.303"></a><span id="l55.303">   // here because there's no 3pane.</span>
<a href="#l55.304"></a><span id="l55.304">   window.openDialog(&quot;chrome://messenger/content/&quot;, &quot;_blank&quot;,</span>
<a href="#l55.305"></a><span id="l55.305">                     &quot;chrome,dialog=no,all&quot;, null,</span>
<a href="#l55.306"></a><span id="l55.306" class="difflineminus">-                    { tabType: tabType, tabParams: tabParams });</span>
<a href="#l55.307"></a><span id="l55.307" class="difflineplus">+                    { tabType, tabParams });</span>
<a href="#l55.308"></a><span id="l55.308"> }</span>
<a href="#l55.309"></a><span id="l55.309"> </span>
<a href="#l55.310"></a><span id="l55.310"> /**</span>
<a href="#l55.311"></a><span id="l55.311">  * Open the specified URL as a content tab (or window)</span>
<a href="#l55.312"></a><span id="l55.312">  *</span>
<a href="#l55.313"></a><span id="l55.313">  * @param url the location to open</span>
<a href="#l55.314"></a><span id="l55.314">  * @param where 'tab' to open in a new tab (default) or 'window' to open in a</span>
<a href="#l55.315"></a><span id="l55.315">  *        new window</span>
<a href="#l55.316"></a><span id="l55.316">  * @param handlerRegExp a regular expression (as a string) to use for the</span>
<a href="#l55.317"></a><span id="l55.317">  *        siteClickHandler for determining whether a link should be opened in</span>
<a href="#l55.318"></a><span id="l55.318">  *        Thunderbird or passed to the system</span>
<a href="#l55.319"></a><span id="l55.319">  */</span>
<a href="#l55.320"></a><span id="l55.320" class="difflineminus">-function openContentTab(url, where, handlerRegExp)</span>
<a href="#l55.321"></a><span id="l55.321" class="difflineminus">-{</span>
<a href="#l55.322"></a><span id="l55.322" class="difflineplus">+function openContentTab(url, where, handlerRegExp) {</span>
<a href="#l55.323"></a><span id="l55.323">   let clickHandler = null;</span>
<a href="#l55.324"></a><span id="l55.324">   if (handlerRegExp)</span>
<a href="#l55.325"></a><span id="l55.325">     clickHandler = &quot;specialTabs.siteClickHandler(event, new RegExp(\&quot;&quot; + handlerRegExp + &quot;\&quot;));&quot;;</span>
<a href="#l55.326"></a><span id="l55.326"> </span>
<a href="#l55.327"></a><span id="l55.327" class="difflineminus">-  openTab(&quot;contentTab&quot;, {contentPage: url, clickHandler: clickHandler}, where);</span>
<a href="#l55.328"></a><span id="l55.328" class="difflineplus">+  openTab(&quot;contentTab&quot;, {contentPage: url, clickHandler}, where);</span>
<a href="#l55.329"></a><span id="l55.329"> }</span>
<a href="#l55.330"></a><span id="l55.330"> </span>
<a href="#l55.331"></a><span id="l55.331"> /**</span>
<a href="#l55.332"></a><span id="l55.332">  * Open the preferences page for the specified query in a new tab.</span>
<a href="#l55.333"></a><span id="l55.333">  *</span>
<a href="#l55.334"></a><span id="l55.334">  * @param paneID     ID of prefpane to select automatically.</span>
<a href="#l55.335"></a><span id="l55.335">  * @param tabID      ID of tab to select on the prefpane.</span>
<a href="#l55.336"></a><span id="l55.336">  * @param otherArgs  other prefpane specific arguments.</span>
<a href="#l55.337"></a><span id="l55.337">  */</span>
<a href="#l55.338"></a><span id="l55.338" class="difflineminus">-function openPreferencesTab(paneID, tabID, otherArgs)</span>
<a href="#l55.339"></a><span id="l55.339" class="difflineminus">-{</span>
<a href="#l55.340"></a><span id="l55.340" class="difflineplus">+function openPreferencesTab(paneID, tabID, otherArgs) {</span>
<a href="#l55.341"></a><span id="l55.341">   let url = &quot;about:preferences&quot;;</span>
<a href="#l55.342"></a><span id="l55.342">   let params = {</span>
<a href="#l55.343"></a><span id="l55.343">     contentPage: url,</span>
<a href="#l55.344"></a><span id="l55.344" class="difflineminus">-    paneID: paneID,</span>
<a href="#l55.345"></a><span id="l55.345" class="difflineminus">-    tabID: tabID,</span>
<a href="#l55.346"></a><span id="l55.346" class="difflineminus">-    otherArgs: otherArgs,</span>
<a href="#l55.347"></a><span id="l55.347" class="difflineminus">-    onLoad: function(aEvent, aBrowser) {</span>
<a href="#l55.348"></a><span id="l55.348" class="difflineplus">+    paneID,</span>
<a href="#l55.349"></a><span id="l55.349" class="difflineplus">+    tabID,</span>
<a href="#l55.350"></a><span id="l55.350" class="difflineplus">+    otherArgs,</span>
<a href="#l55.351"></a><span id="l55.351" class="difflineplus">+    onLoad(aEvent, aBrowser) {</span>
<a href="#l55.352"></a><span id="l55.352">       let prefWindow = aBrowser.contentDocument.getElementById(&quot;MailPreferences&quot;);</span>
<a href="#l55.353"></a><span id="l55.353">       aBrowser.contentWindow.selectPaneAndTab(prefWindow, paneID, tabID, otherArgs);</span>
<a href="#l55.354"></a><span id="l55.354" class="difflineminus">-    }</span>
<a href="#l55.355"></a><span id="l55.355" class="difflineplus">+    },</span>
<a href="#l55.356"></a><span id="l55.356">   };</span>
<a href="#l55.357"></a><span id="l55.357">   openTab(&quot;preferencesTab&quot;, params);</span>
<a href="#l55.358"></a><span id="l55.358"> }</span>
<a href="#l55.359"></a><span id="l55.359"> </span>
<a href="#l55.360"></a><span id="l55.360"> /**</span>
<a href="#l55.361"></a><span id="l55.361">  * Open the dictionary list in a new content tab, if possible in an available</span>
<a href="#l55.362"></a><span id="l55.362">  * mail:3pane window, otherwise by opening a new mail:3pane.</span>
<a href="#l55.363"></a><span id="l55.363">  *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l56.1"></a><span id="l56.1" class="difflineminus">--- a/mail/base/jar.mn</span>
<a href="#l56.2"></a><span id="l56.2" class="difflineplus">+++ b/mail/base/jar.mn</span>
<a href="#l56.3"></a><span id="l56.3" class="difflineat">@@ -113,17 +113,17 @@ messenger.jar:</span>
<a href="#l56.4"></a><span id="l56.4">     content/messenger/browserRequest.js             (content/browserRequest.js)</span>
<a href="#l56.5"></a><span id="l56.5">     content/messenger/browserRequest.xul            (content/browserRequest.xul)</span>
<a href="#l56.6"></a><span id="l56.6"> *   content/messenger/safeMode.xul                  (content/safeMode.xul)</span>
<a href="#l56.7"></a><span id="l56.7">     content/messenger/safeMode.js                   (content/safeMode.js)</span>
<a href="#l56.8"></a><span id="l56.8">     content/messenger/sanitize.xul                  (content/sanitize.xul)</span>
<a href="#l56.9"></a><span id="l56.9">     content/messenger/sanitize.js                   (content/sanitize.js)</span>
<a href="#l56.10"></a><span id="l56.10">     content/messenger/sanitizeDialog.css            (content/sanitizeDialog.css)</span>
<a href="#l56.11"></a><span id="l56.11">     content/messenger/sanitizeDialog.js             (content/sanitizeDialog.js)</span>
<a href="#l56.12"></a><span id="l56.12" class="difflineminus">-*   content/messenger/toolbarIconColor.js           (content/toolbarIconColor.js)</span>
<a href="#l56.13"></a><span id="l56.13" class="difflineplus">+    content/messenger/toolbarIconColor.js           (content/toolbarIconColor.js)</span>
<a href="#l56.14"></a><span id="l56.14"> # the following files are mail-specific overrides</span>
<a href="#l56.15"></a><span id="l56.15"> *   content/messenger/license.html                  (/@mozreltopsrcdir@/toolkit/content/license.html)</span>
<a href="#l56.16"></a><span id="l56.16"> % override chrome://global/content/license.html chrome://messenger/content/license.html</span>
<a href="#l56.17"></a><span id="l56.17"> # L10n resources and overrides.</span>
<a href="#l56.18"></a><span id="l56.18"> % override chrome://mozapps/locale/downloads/settingsChange.dtd chrome://messenger/locale/downloads/settingsChange.dtd</span>
<a href="#l56.19"></a><span id="l56.19"> % override chrome://global/locale/netError.dtd chrome://messenger/locale/netError.dtd</span>
<a href="#l56.20"></a><span id="l56.20"> % resource search-plugins chrome://messenger/locale/searchplugins/</span>
<a href="#l56.21"></a><span id="l56.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l57.1"></a><span id="l57.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/messenger.properties</span>
<a href="#l57.2"></a><span id="l57.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/messenger.properties</span>
<a href="#l57.3"></a><span id="l57.3" class="difflineat">@@ -571,19 +571,16 @@ moveToFolderAgain=Move to &quot;%1$S&quot; Again</span>
<a href="#l57.4"></a><span id="l57.4"> moveToFolderAgainAccessKey=t</span>
<a href="#l57.5"></a><span id="l57.5"> #LOCALIZATION NOTE %1$S is the name of the folder we will copy to</span>
<a href="#l57.6"></a><span id="l57.6"> # copyToFolderAgainAccessKey</span>
<a href="#l57.7"></a><span id="l57.7"> # should have the same value as moveToFolderAgainAccessKey as they are the same menu item in the UI</span>
<a href="#l57.8"></a><span id="l57.8"> # copyToFolderAgainAccessKey should also be a letter that occurs before %1$S</span>
<a href="#l57.9"></a><span id="l57.9"> copyToFolderAgain=Copy to &quot;%1$S&quot; Again</span>
<a href="#l57.10"></a><span id="l57.10"> copyToFolderAgainAccessKey=t</span>
<a href="#l57.11"></a><span id="l57.11"> </span>
<a href="#l57.12"></a><span id="l57.12" class="difflineminus">-#LOCALIZATION NOTE %1$S is the e-mail address of the person we will allow remote content for</span>
<a href="#l57.13"></a><span id="l57.13" class="difflineminus">-alwaysLoadRemoteContentForSender2= Always load remote content from %1$S</span>
<a href="#l57.14"></a><span id="l57.14" class="difflineminus">-</span>
<a href="#l57.15"></a><span id="l57.15"> #LOCALIZATION NOTE(mdnBarMessageNormal) %1$S is the name of the sender</span>
<a href="#l57.16"></a><span id="l57.16"> mdnBarMessageNormal=%1$S has asked to be notified when you read this message.</span>
<a href="#l57.17"></a><span id="l57.17"> #LOCALIZATION NOTE(mdnBarMessageAddressDiffers) %1$S is the name of the sender, %2$S is the address(es) to send return receipt to</span>
<a href="#l57.18"></a><span id="l57.18"> mdnBarMessageAddressDiffers=%1$S has asked to be notified (on %2$S) when you read this message.</span>
<a href="#l57.19"></a><span id="l57.19"> </span>
<a href="#l57.20"></a><span id="l57.20"> # mailCommands.js</span>
<a href="#l57.21"></a><span id="l57.21"> emptyJunkFolderTitle=Empty &quot;%S&quot;</span>
<a href="#l57.22"></a><span id="l57.22"> emptyJunkFolderMessage=Delete all messages and subfolders in the Junk folder?</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

