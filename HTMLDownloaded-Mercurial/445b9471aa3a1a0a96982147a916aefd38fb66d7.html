<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 23769:445b9471aa3a1a0a96982147a916aefd38fb66d7</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 445b9471aa3a1a0a96982147a916aefd38fb66d7" />
<meta property="og:url" content="/comm-central/rev/445b9471aa3a1a0a96982147a916aefd38fb66d7" />
<meta property="og:description" content="Bug 1455536 - Port bug 1453881: add_task() doesn't accept generators any more (mailnews part). rs=bustage-fix CLOSED TREE" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 445b9471aa3a1a0a96982147a916aefd38fb66d7 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/445b9471aa3a1a0a96982147a916aefd38fb66d7">shortlog</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/445b9471aa3a1a0a96982147a916aefd38fb66d7">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7">files</a> |
changeset |
<a href="/comm-central/raw-rev/445b9471aa3a1a0a96982147a916aefd38fb66d7">raw</a>  | <a href="/comm-central/archive/445b9471aa3a1a0a96982147a916aefd38fb66d7.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1455536">Bug 1455536</a> - Port <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1453881">bug 1453881</a>: add_task() doesn't accept generators any more (mailnews part). rs=bustage-fix CLOSED TREE
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 20 Apr 2018 06:01:00 +0200</td></tr>

<tr>
 <td>changeset 23769</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/445b9471aa3a1a0a96982147a916aefd38fb66d7">445b9471aa3a1a0a96982147a916aefd38fb66d7</a></td>
</tr>



<tr>
<td>parent 23768</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/bb98b2c207be926079d98ca85e374479e45541fa">bb98b2c207be926079d98ca85e374479e45541fa</a>
</td>
</tr>

<tr>
<td>child 23770</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/cd71d71d5add645603ce2e52adb9802a25db087b">cd71d71d5add645603ce2e52adb9802a25db087b</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=445b9471aa3a1a0a96982147a916aefd38fb66d7">14331</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 20 Apr 2018 18:37:31 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@445b9471aa3a [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=445b9471aa3a1a0a96982147a916aefd38fb66d7">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=445b9471aa3a1a0a96982147a916aefd38fb66d7&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=445b9471aa3a1a0a96982147a916aefd38fb66d7&newProject=comm-central&newRevision=bb98b2c207be926079d98ca85e374479e45541fa&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=445b9471aa3a1a0a96982147a916aefd38fb66d7&newProject=comm-central&newRevision=bb98b2c207be926079d98ca85e374479e45541fa&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=445b9471aa3a1a0a96982147a916aefd38fb66d7&newProject=comm-central&newRevision=bb98b2c207be926079d98ca85e374479e45541fa&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28bustage-fix%29&revcount=50">bustage-fix</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1455536">1455536</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1453881">1453881</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1455536">Bug 1455536</a> - Port <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1453881">bug 1453881</a>: add_task() doesn't accept generators any more (mailnews part). rs=bustage-fix CLOSED TREE</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/base/test/unit/test_imapPump.js">mailnews/base/test/unit/test_imapPump.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/base/test/unit/test_imapPump.js">file</a> |
<a href="/comm-central/annotate/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/base/test/unit/test_imapPump.js">annotate</a> |
<a href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/base/test/unit/test_imapPump.js">diff</a> |
<a href="/comm-central/comparison/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/base/test/unit/test_imapPump.js">comparison</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/base/test/unit/test_imapPump.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/base/test/unit/test_searchChaining.js">mailnews/base/test/unit/test_searchChaining.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/base/test/unit/test_searchChaining.js">file</a> |
<a href="/comm-central/annotate/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/base/test/unit/test_searchChaining.js">annotate</a> |
<a href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/base/test/unit/test_searchChaining.js">diff</a> |
<a href="/comm-central/comparison/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/base/test/unit/test_searchChaining.js">comparison</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/base/test/unit/test_searchChaining.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_attachment.js">mailnews/compose/test/unit/test_attachment.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_attachment.js">file</a> |
<a href="/comm-central/annotate/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_attachment.js">annotate</a> |
<a href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_attachment.js">diff</a> |
<a href="/comm-central/comparison/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_attachment.js">comparison</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_attachment.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_bug155172.js">mailnews/compose/test/unit/test_bug155172.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_bug155172.js">file</a> |
<a href="/comm-central/annotate/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_bug155172.js">annotate</a> |
<a href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_bug155172.js">diff</a> |
<a href="/comm-central/comparison/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_bug155172.js">comparison</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_bug155172.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_detectAttachmentCharset.js">mailnews/compose/test/unit/test_detectAttachmentCharset.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_detectAttachmentCharset.js">file</a> |
<a href="/comm-central/annotate/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_detectAttachmentCharset.js">annotate</a> |
<a href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_detectAttachmentCharset.js">diff</a> |
<a href="/comm-central/comparison/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_detectAttachmentCharset.js">comparison</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_detectAttachmentCharset.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_longLines.js">mailnews/compose/test/unit/test_longLines.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_longLines.js">file</a> |
<a href="/comm-central/annotate/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_longLines.js">annotate</a> |
<a href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_longLines.js">diff</a> |
<a href="/comm-central/comparison/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_longLines.js">comparison</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_longLines.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_messageHeaders.js">mailnews/compose/test/unit/test_messageHeaders.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_messageHeaders.js">file</a> |
<a href="/comm-central/annotate/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_messageHeaders.js">annotate</a> |
<a href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_messageHeaders.js">diff</a> |
<a href="/comm-central/comparison/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_messageHeaders.js">comparison</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_messageHeaders.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_saveDraft.js">mailnews/compose/test/unit/test_saveDraft.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_saveDraft.js">file</a> |
<a href="/comm-central/annotate/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_saveDraft.js">annotate</a> |
<a href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_saveDraft.js">diff</a> |
<a href="/comm-central/comparison/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_saveDraft.js">comparison</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_saveDraft.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_sendObserver.js">mailnews/compose/test/unit/test_sendObserver.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_sendObserver.js">file</a> |
<a href="/comm-central/annotate/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_sendObserver.js">annotate</a> |
<a href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_sendObserver.js">diff</a> |
<a href="/comm-central/comparison/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_sendObserver.js">comparison</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_sendObserver.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_smtpPassword.js">mailnews/compose/test/unit/test_smtpPassword.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_smtpPassword.js">file</a> |
<a href="/comm-central/annotate/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_smtpPassword.js">annotate</a> |
<a href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_smtpPassword.js">diff</a> |
<a href="/comm-central/comparison/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_smtpPassword.js">comparison</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_smtpPassword.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_smtpPassword2.js">mailnews/compose/test/unit/test_smtpPassword2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_smtpPassword2.js">file</a> |
<a href="/comm-central/annotate/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_smtpPassword2.js">annotate</a> |
<a href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_smtpPassword2.js">diff</a> |
<a href="/comm-central/comparison/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_smtpPassword2.js">comparison</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_smtpPassword2.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">mailnews/compose/test/unit/test_smtpPasswordFailure1.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">file</a> |
<a href="/comm-central/annotate/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">annotate</a> |
<a href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">diff</a> |
<a href="/comm-central/comparison/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">comparison</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">mailnews/compose/test/unit/test_smtpPasswordFailure2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">file</a> |
<a href="/comm-central/annotate/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">annotate</a> |
<a href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">diff</a> |
<a href="/comm-central/comparison/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">comparison</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_smtpPasswordFailure3.js">mailnews/compose/test/unit/test_smtpPasswordFailure3.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_smtpPasswordFailure3.js">file</a> |
<a href="/comm-central/annotate/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_smtpPasswordFailure3.js">annotate</a> |
<a href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_smtpPasswordFailure3.js">diff</a> |
<a href="/comm-central/comparison/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_smtpPasswordFailure3.js">comparison</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_smtpPasswordFailure3.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_smtpProxy.js">mailnews/compose/test/unit/test_smtpProxy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_smtpProxy.js">file</a> |
<a href="/comm-central/annotate/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_smtpProxy.js">annotate</a> |
<a href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_smtpProxy.js">diff</a> |
<a href="/comm-central/comparison/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_smtpProxy.js">comparison</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/compose/test/unit/test_smtpProxy.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/imap/test/unit/test_filterNeedsBody.js">mailnews/imap/test/unit/test_filterNeedsBody.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/imap/test/unit/test_filterNeedsBody.js">file</a> |
<a href="/comm-central/annotate/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/imap/test/unit/test_filterNeedsBody.js">annotate</a> |
<a href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/imap/test/unit/test_filterNeedsBody.js">diff</a> |
<a href="/comm-central/comparison/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/imap/test/unit/test_filterNeedsBody.js">comparison</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/imap/test/unit/test_filterNeedsBody.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/imap/test/unit/test_imapFilterActions.js">mailnews/imap/test/unit/test_imapFilterActions.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/imap/test/unit/test_imapFilterActions.js">file</a> |
<a href="/comm-central/annotate/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/imap/test/unit/test_imapFilterActions.js">annotate</a> |
<a href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/imap/test/unit/test_imapFilterActions.js">diff</a> |
<a href="/comm-central/comparison/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/imap/test/unit/test_imapFilterActions.js">comparison</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/imap/test/unit/test_imapFilterActions.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/imap/test/unit/test_imapFilterActionsPostplugin.js">mailnews/imap/test/unit/test_imapFilterActionsPostplugin.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/imap/test/unit/test_imapFilterActionsPostplugin.js">file</a> |
<a href="/comm-central/annotate/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/imap/test/unit/test_imapFilterActionsPostplugin.js">annotate</a> |
<a href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/imap/test/unit/test_imapFilterActionsPostplugin.js">diff</a> |
<a href="/comm-central/comparison/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/imap/test/unit/test_imapFilterActionsPostplugin.js">comparison</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/imap/test/unit/test_imapFilterActionsPostplugin.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/imap/test/unit/test_imapMove.js">mailnews/imap/test/unit/test_imapMove.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/imap/test/unit/test_imapMove.js">file</a> |
<a href="/comm-central/annotate/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/imap/test/unit/test_imapMove.js">annotate</a> |
<a href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/imap/test/unit/test_imapMove.js">diff</a> |
<a href="/comm-central/comparison/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/imap/test/unit/test_imapMove.js">comparison</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/imap/test/unit/test_imapMove.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/imap/test/unit/test_imapPasswordFailure.js">mailnews/imap/test/unit/test_imapPasswordFailure.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/imap/test/unit/test_imapPasswordFailure.js">file</a> |
<a href="/comm-central/annotate/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/imap/test/unit/test_imapPasswordFailure.js">annotate</a> |
<a href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/imap/test/unit/test_imapPasswordFailure.js">diff</a> |
<a href="/comm-central/comparison/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/imap/test/unit/test_imapPasswordFailure.js">comparison</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/imap/test/unit/test_imapPasswordFailure.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/imap/test/unit/test_imapProxy.js">mailnews/imap/test/unit/test_imapProxy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/imap/test/unit/test_imapProxy.js">file</a> |
<a href="/comm-central/annotate/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/imap/test/unit/test_imapProxy.js">annotate</a> |
<a href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/imap/test/unit/test_imapProxy.js">diff</a> |
<a href="/comm-central/comparison/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/imap/test/unit/test_imapProxy.js">comparison</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/imap/test/unit/test_imapProxy.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_duplicateKey.js">mailnews/local/test/unit/test_duplicateKey.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_duplicateKey.js">file</a> |
<a href="/comm-central/annotate/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_duplicateKey.js">annotate</a> |
<a href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_duplicateKey.js">diff</a> |
<a href="/comm-central/comparison/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_duplicateKey.js">comparison</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_duplicateKey.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_movemailDownload.js">mailnews/local/test/unit/test_movemailDownload.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_movemailDownload.js">file</a> |
<a href="/comm-central/annotate/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_movemailDownload.js">annotate</a> |
<a href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_movemailDownload.js">diff</a> |
<a href="/comm-central/comparison/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_movemailDownload.js">comparison</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_movemailDownload.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3MultiCopy.js">mailnews/local/test/unit/test_pop3MultiCopy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3MultiCopy.js">file</a> |
<a href="/comm-central/annotate/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3MultiCopy.js">annotate</a> |
<a href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3MultiCopy.js">diff</a> |
<a href="/comm-central/comparison/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3MultiCopy.js">comparison</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3MultiCopy.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3MultiCopy2.js">mailnews/local/test/unit/test_pop3MultiCopy2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3MultiCopy2.js">file</a> |
<a href="/comm-central/annotate/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3MultiCopy2.js">annotate</a> |
<a href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3MultiCopy2.js">diff</a> |
<a href="/comm-central/comparison/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3MultiCopy2.js">comparison</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3MultiCopy2.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3Password.js">mailnews/local/test/unit/test_pop3Password.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3Password.js">file</a> |
<a href="/comm-central/annotate/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3Password.js">annotate</a> |
<a href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3Password.js">diff</a> |
<a href="/comm-central/comparison/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3Password.js">comparison</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3Password.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3Password2.js">mailnews/local/test/unit/test_pop3Password2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3Password2.js">file</a> |
<a href="/comm-central/annotate/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3Password2.js">annotate</a> |
<a href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3Password2.js">diff</a> |
<a href="/comm-central/comparison/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3Password2.js">comparison</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3Password2.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3Password3.js">mailnews/local/test/unit/test_pop3Password3.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3Password3.js">file</a> |
<a href="/comm-central/annotate/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3Password3.js">annotate</a> |
<a href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3Password3.js">diff</a> |
<a href="/comm-central/comparison/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3Password3.js">comparison</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3Password3.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3PasswordFailure.js">mailnews/local/test/unit/test_pop3PasswordFailure.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3PasswordFailure.js">file</a> |
<a href="/comm-central/annotate/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3PasswordFailure.js">annotate</a> |
<a href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3PasswordFailure.js">diff</a> |
<a href="/comm-central/comparison/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3PasswordFailure.js">comparison</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3PasswordFailure.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3Proxy.js">mailnews/local/test/unit/test_pop3Proxy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3Proxy.js">file</a> |
<a href="/comm-central/annotate/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3Proxy.js">annotate</a> |
<a href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3Proxy.js">diff</a> |
<a href="/comm-central/comparison/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3Proxy.js">comparison</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3Proxy.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3Pump.js">mailnews/local/test/unit/test_pop3Pump.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3Pump.js">file</a> |
<a href="/comm-central/annotate/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3Pump.js">annotate</a> |
<a href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3Pump.js">diff</a> |
<a href="/comm-central/comparison/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3Pump.js">comparison</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/local/test/unit/test_pop3Pump.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/mime/test/unit/test_structured_headers.js">mailnews/mime/test/unit/test_structured_headers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/mime/test/unit/test_structured_headers.js">file</a> |
<a href="/comm-central/annotate/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/mime/test/unit/test_structured_headers.js">annotate</a> |
<a href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/mime/test/unit/test_structured_headers.js">diff</a> |
<a href="/comm-central/comparison/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/mime/test/unit/test_structured_headers.js">comparison</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/mime/test/unit/test_structured_headers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/news/test/unit/test_nntpGroupPassword.js">mailnews/news/test/unit/test_nntpGroupPassword.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/news/test/unit/test_nntpGroupPassword.js">file</a> |
<a href="/comm-central/annotate/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/news/test/unit/test_nntpGroupPassword.js">annotate</a> |
<a href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/news/test/unit/test_nntpGroupPassword.js">diff</a> |
<a href="/comm-central/comparison/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/news/test/unit/test_nntpGroupPassword.js">comparison</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/news/test/unit/test_nntpGroupPassword.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/news/test/unit/test_nntpPassword.js">mailnews/news/test/unit/test_nntpPassword.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/news/test/unit/test_nntpPassword.js">file</a> |
<a href="/comm-central/annotate/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/news/test/unit/test_nntpPassword.js">annotate</a> |
<a href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/news/test/unit/test_nntpPassword.js">diff</a> |
<a href="/comm-central/comparison/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/news/test/unit/test_nntpPassword.js">comparison</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/news/test/unit/test_nntpPassword.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/news/test/unit/test_nntpPassword2.js">mailnews/news/test/unit/test_nntpPassword2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/news/test/unit/test_nntpPassword2.js">file</a> |
<a href="/comm-central/annotate/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/news/test/unit/test_nntpPassword2.js">annotate</a> |
<a href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/news/test/unit/test_nntpPassword2.js">diff</a> |
<a href="/comm-central/comparison/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/news/test/unit/test_nntpPassword2.js">comparison</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/news/test/unit/test_nntpPassword2.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/news/test/unit/test_nntpPassword3.js">mailnews/news/test/unit/test_nntpPassword3.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/news/test/unit/test_nntpPassword3.js">file</a> |
<a href="/comm-central/annotate/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/news/test/unit/test_nntpPassword3.js">annotate</a> |
<a href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/news/test/unit/test_nntpPassword3.js">diff</a> |
<a href="/comm-central/comparison/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/news/test/unit/test_nntpPassword3.js">comparison</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/news/test/unit/test_nntpPassword3.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/news/test/unit/test_nntpProxy.js">mailnews/news/test/unit/test_nntpProxy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/news/test/unit/test_nntpProxy.js">file</a> |
<a href="/comm-central/annotate/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/news/test/unit/test_nntpProxy.js">annotate</a> |
<a href="/comm-central/diff/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/news/test/unit/test_nntpProxy.js">diff</a> |
<a href="/comm-central/comparison/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/news/test/unit/test_nntpProxy.js">comparison</a> |
<a href="/comm-central/log/445b9471aa3a1a0a96982147a916aefd38fb66d7/mailnews/news/test/unit/test_nntpProxy.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/test/unit/test_imapPump.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_imapPump.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -34,24 +34,24 @@ var gTestArray =</span>
<a href="#l1.4"></a><span id="l1.4">   // optionally set server parameters, here enabling debug messages</span>
<a href="#l1.5"></a><span id="l1.5">   function serverParms() {</span>
<a href="#l1.6"></a><span id="l1.6">     if (typeof fsDebugAll == &quot;undefined&quot;)</span>
<a href="#l1.7"></a><span id="l1.7">       ChromeUtils.import(&quot;resource://testing-common/mailnews/maild.js&quot;);</span>
<a href="#l1.8"></a><span id="l1.8">     IMAPPump.server.setDebugLevel(fsDebugAll);</span>
<a href="#l1.9"></a><span id="l1.9">   },</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11">   // the main test</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  function* loadImapMessage()</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+  async function loadImapMessage()</span>
<a href="#l1.14"></a><span id="l1.14">   {</span>
<a href="#l1.15"></a><span id="l1.15">     IMAPPump.mailbox.addMessage(</span>
<a href="#l1.16"></a><span id="l1.16">       new imapMessage(specForFileName(gMessage),</span>
<a href="#l1.17"></a><span id="l1.17">                       IMAPPump.mailbox.uidnext++, []));</span>
<a href="#l1.18"></a><span id="l1.18">     let promiseUrlListener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l1.19"></a><span id="l1.19">     IMAPPump.inbox.updateFolderWithListener(gDummyMsgWindow, promiseUrlListener);</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-    yield promiseUrlListener.promise;</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+    await promiseUrlListener.promise;</span>
<a href="#l1.22"></a><span id="l1.22"> </span>
<a href="#l1.23"></a><span id="l1.23">     Assert.equal(1, IMAPPump.inbox.getTotalMessages(false));</span>
<a href="#l1.24"></a><span id="l1.24">     let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l1.25"></a><span id="l1.25">     Assert.ok(msgHdr instanceof Ci.nsIMsgDBHdr);</span>
<a href="#l1.26"></a><span id="l1.26">   },</span>
<a href="#l1.27"></a><span id="l1.27"> </span>
<a href="#l1.28"></a><span id="l1.28">   // all done</span>
<a href="#l1.29"></a><span id="l1.29">   teardownIMAPPump,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/test/unit/test_searchChaining.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_searchChaining.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -10,57 +10,57 @@</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> ChromeUtils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l2.8"></a><span id="l2.8"> ChromeUtils.import(&quot;resource://testing-common/mailnews/IMAPpump.js&quot;);</span>
<a href="#l2.9"></a><span id="l2.9"> ChromeUtils.import(&quot;resource://testing-common/mailnews/imapd.js&quot;);</span>
<a href="#l2.10"></a><span id="l2.10"> ChromeUtils.import(&quot;resource://testing-common/mailnews/PromiseTestUtils.jsm&quot;);</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-function *setupFolder()</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+async function setupFolder()</span>
<a href="#l2.14"></a><span id="l2.14"> {</span>
<a href="#l2.15"></a><span id="l2.15">   // add a single message to the imap inbox.</span>
<a href="#l2.16"></a><span id="l2.16">   let messages = [];</span>
<a href="#l2.17"></a><span id="l2.17">   let messageGenerator = new MessageGenerator();</span>
<a href="#l2.18"></a><span id="l2.18">   messages = messages.concat(messageGenerator.makeMessage());</span>
<a href="#l2.19"></a><span id="l2.19">   let synthMessage = messages[0];</span>
<a href="#l2.20"></a><span id="l2.20"> </span>
<a href="#l2.21"></a><span id="l2.21">   let msgURI =</span>
<a href="#l2.22"></a><span id="l2.22">     Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l2.23"></a><span id="l2.23">                        btoa(synthMessage.toMessageString()));</span>
<a href="#l2.24"></a><span id="l2.24">   let message = new imapMessage(msgURI.spec, IMAPPump.mailbox.uidnext++, []);</span>
<a href="#l2.25"></a><span id="l2.25">   IMAPPump.mailbox.addMessage(message);</span>
<a href="#l2.26"></a><span id="l2.26"> </span>
<a href="#l2.27"></a><span id="l2.27">   // update folder to download header.</span>
<a href="#l2.28"></a><span id="l2.28">   let listener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l2.29"></a><span id="l2.29">   IMAPPump.inbox.updateFolderWithListener(null, listener);</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-  yield listener.promise;</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+  await listener.promise;</span>
<a href="#l2.32"></a><span id="l2.32"> }</span>
<a href="#l2.33"></a><span id="l2.33"> </span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-function *searchTest()</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+async function searchTest()</span>
<a href="#l2.36"></a><span id="l2.36"> {</span>
<a href="#l2.37"></a><span id="l2.37">   // Get the IMAP inbox...</span>
<a href="#l2.38"></a><span id="l2.38">   var emptyLocal1 = localAccountUtils.rootFolder.createLocalSubfolder(&quot;empty 1&quot;);</span>
<a href="#l2.39"></a><span id="l2.39"> </span>
<a href="#l2.40"></a><span id="l2.40">   let searchSession = Cc[&quot;@mozilla.org/messenger/searchSession;1&quot;]</span>
<a href="#l2.41"></a><span id="l2.41">                         .createInstance(Ci.nsIMsgSearchSession);</span>
<a href="#l2.42"></a><span id="l2.42"> </span>
<a href="#l2.43"></a><span id="l2.43">   let searchTerm = searchSession.createTerm();</span>
<a href="#l2.44"></a><span id="l2.44">   searchTerm.matchAll = true;</span>
<a href="#l2.45"></a><span id="l2.45">   searchSession.appendTerm(searchTerm);</span>
<a href="#l2.46"></a><span id="l2.46">   searchSession.addScopeTerm(Ci.nsMsgSearchScope.offlineMail, emptyLocal1);</span>
<a href="#l2.47"></a><span id="l2.47">   searchSession.addScopeTerm(Ci.nsMsgSearchScope.onlineMail, IMAPPump.inbox);</span>
<a href="#l2.48"></a><span id="l2.48">   let listener = new PromiseTestUtils.PromiseSearchNotify(</span>
<a href="#l2.49"></a><span id="l2.49">                        searchSession, searchListener);</span>
<a href="#l2.50"></a><span id="l2.50">   searchSession.search(null);</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-  yield listener.promise;</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+  await listener.promise;</span>
<a href="#l2.53"></a><span id="l2.53"> </span>
<a href="#l2.54"></a><span id="l2.54">   // After the search completes, there still seem to be active URLs, so we</span>
<a href="#l2.55"></a><span id="l2.55">   //   have to wait before we are done and clear.</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-  yield PromiseTestUtils.promiseDelay(1000);</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+  await PromiseTestUtils.promiseDelay(1000);</span>
<a href="#l2.58"></a><span id="l2.58"> }</span>
<a href="#l2.59"></a><span id="l2.59"> </span>
<a href="#l2.60"></a><span id="l2.60"> // nsIMsgSearchNotify implementation</span>
<a href="#l2.61"></a><span id="l2.61"> var searchListener =</span>
<a href="#l2.62"></a><span id="l2.62"> {</span>
<a href="#l2.63"></a><span id="l2.63">   numTotalMessages: 0,</span>
<a href="#l2.64"></a><span id="l2.64">   QueryInterface: XPCOMUtils.generateQI([Ci.nsIMsgSearchNotify]),</span>
<a href="#l2.65"></a><span id="l2.65">   onNewSearch: function()</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_attachment.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_attachment.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -105,28 +105,28 @@ function checkAttachment(expectedCD, exp</span>
<a href="#l3.4"></a><span id="l3.4">     pos = contentType.indexOf(&quot;\n&quot;, pos);</span>
<a href="#l3.5"></a><span id="l3.5">     Assert.notEqual(pos, -1);</span>
<a href="#l3.6"></a><span id="l3.6">     pos++;</span>
<a href="#l3.7"></a><span id="l3.7">   } while (contentType.startsWith(&quot; &quot;, pos));</span>
<a href="#l3.8"></a><span id="l3.8">   contentType = contentType.substr(0, pos);</span>
<a href="#l3.9"></a><span id="l3.9">   Assert.equal(contentType, expectedCT);</span>
<a href="#l3.10"></a><span id="l3.10"> }</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-function* testInput0() {</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+async function testInput0() {</span>
<a href="#l3.14"></a><span id="l3.14">   for (let folding in ParamFoldingPref) {</span>
<a href="#l3.15"></a><span id="l3.15">     Services.prefs.setIntPref(&quot;mail.strictly_mime.parm_folding&quot;, ParamFoldingPref[folding]);</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-    yield createMessage(input0);</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+    await createMessage(input0);</span>
<a href="#l3.18"></a><span id="l3.18">     checkAttachment(expectedCD0, expectedCTList0[folding]);</span>
<a href="#l3.19"></a><span id="l3.19">   }</span>
<a href="#l3.20"></a><span id="l3.20"> }</span>
<a href="#l3.21"></a><span id="l3.21"> </span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-function* testInput1() {</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+async function testInput1() {</span>
<a href="#l3.24"></a><span id="l3.24">   for (let folding in ParamFoldingPref) {</span>
<a href="#l3.25"></a><span id="l3.25">     Services.prefs.setIntPref(&quot;mail.strictly_mime.parm_folding&quot;, ParamFoldingPref[folding]);</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-    yield createMessage(input1);</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+    await createMessage(input1);</span>
<a href="#l3.28"></a><span id="l3.28">     checkAttachment(expectedCD1, expectedCTList1[folding]);</span>
<a href="#l3.29"></a><span id="l3.29">   }</span>
<a href="#l3.30"></a><span id="l3.30"> }</span>
<a href="#l3.31"></a><span id="l3.31"> </span>
<a href="#l3.32"></a><span id="l3.32"> var tests = [</span>
<a href="#l3.33"></a><span id="l3.33">   testInput0,</span>
<a href="#l3.34"></a><span id="l3.34">   testInput1</span>
<a href="#l3.35"></a><span id="l3.35"> ]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_bug155172.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_bug155172.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -28,17 +28,17 @@ var kIdentityMail = &quot;identity@foo.invali</span>
<a href="#l4.4"></a><span id="l4.4"> var kSender = &quot;from@foo.invalid&quot;;</span>
<a href="#l4.5"></a><span id="l4.5"> var kTo = &quot;to@foo.invalid&quot;;</span>
<a href="#l4.6"></a><span id="l4.6"> var kUsername = &quot;test.smtp@fakeserver&quot;;</span>
<a href="#l4.7"></a><span id="l4.7"> // kPassword 2 is the one defined in signons-smtp.json, the other one</span>
<a href="#l4.8"></a><span id="l4.8"> // is intentionally wrong.</span>
<a href="#l4.9"></a><span id="l4.9"> var kPassword1 = &quot;wrong&quot;;</span>
<a href="#l4.10"></a><span id="l4.10"> var kPassword2 = &quot;smtptest&quot;;</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-add_task(function *() {</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+add_task(async function () {</span>
<a href="#l4.14"></a><span id="l4.14">   registerAlertTestUtils();</span>
<a href="#l4.15"></a><span id="l4.15"> </span>
<a href="#l4.16"></a><span id="l4.16">   function createHandler(d) {</span>
<a href="#l4.17"></a><span id="l4.17">     var handler = new SMTP_RFC2821_handler(d);</span>
<a href="#l4.18"></a><span id="l4.18">     // Username needs to match the login information stored in the signons json</span>
<a href="#l4.19"></a><span id="l4.19">     // file.</span>
<a href="#l4.20"></a><span id="l4.20">     handler.kUsername = kUsername;</span>
<a href="#l4.21"></a><span id="l4.21">     handler.kPassword = kPassword1;</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -46,17 +46,17 @@ add_task(function *() {</span>
<a href="#l4.23"></a><span id="l4.23">     handler.kAuthSchemes = [ &quot;PLAIN&quot;, &quot;LOGIN&quot; ]; // make match expected transaction below</span>
<a href="#l4.24"></a><span id="l4.24">     return handler;</span>
<a href="#l4.25"></a><span id="l4.25">   }</span>
<a href="#l4.26"></a><span id="l4.26"> </span>
<a href="#l4.27"></a><span id="l4.27">   server = setupServerDaemon(createHandler);</span>
<a href="#l4.28"></a><span id="l4.28">   server.setDebugLevel(fsDebugAll);</span>
<a href="#l4.29"></a><span id="l4.29"> </span>
<a href="#l4.30"></a><span id="l4.30">   // Prepare files for passwords (generated by a script in bug 1018624).</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-  yield setupForPassword(&quot;signons-smtp.json&quot;);</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+  await setupForPassword(&quot;signons-smtp.json&quot;);</span>
<a href="#l4.33"></a><span id="l4.33"> </span>
<a href="#l4.34"></a><span id="l4.34">   // Test file</span>
<a href="#l4.35"></a><span id="l4.35">   var testFile = do_get_file(&quot;data/message1.eml&quot;);</span>
<a href="#l4.36"></a><span id="l4.36"> </span>
<a href="#l4.37"></a><span id="l4.37">   // Ensure we have at least one mail account</span>
<a href="#l4.38"></a><span id="l4.38">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l4.39"></a><span id="l4.39"> </span>
<a href="#l4.40"></a><span id="l4.40">   // Handle the server in a try/catch/finally loop so that we always will stop</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_detectAttachmentCharset.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_detectAttachmentCharset.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -18,33 +18,33 @@ function getContentCharset(aContent) {</span>
<a href="#l5.4"></a><span id="l5.4">   let found = aContent.match(/^Content-Type: text\/plain; charset=(.*?);/);</span>
<a href="#l5.5"></a><span id="l5.5">   if (found) {</span>
<a href="#l5.6"></a><span id="l5.6">     Assert.equal(found.length, 2);</span>
<a href="#l5.7"></a><span id="l5.7">     return found[1];</span>
<a href="#l5.8"></a><span id="l5.8">   }</span>
<a href="#l5.9"></a><span id="l5.9">   return null;</span>
<a href="#l5.10"></a><span id="l5.10"> }</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-function *testUTF8() {</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-  yield createMessage(do_get_file(&quot;data/test-UTF-8.txt&quot;));</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+async function testUTF8() {</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+  await createMessage(do_get_file(&quot;data/test-UTF-8.txt&quot;));</span>
<a href="#l5.16"></a><span id="l5.16">   checkAttachmentCharset(&quot;UTF-8&quot;);</span>
<a href="#l5.17"></a><span id="l5.17"> }</span>
<a href="#l5.18"></a><span id="l5.18"> </span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-function *testUTF16BE() {</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineminus">-  yield createMessage(do_get_file(&quot;data/test-UTF-16BE.txt&quot;));</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+async function testUTF16BE() {</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+  await createMessage(do_get_file(&quot;data/test-UTF-16BE.txt&quot;));</span>
<a href="#l5.23"></a><span id="l5.23">   checkAttachmentCharset(&quot;UTF-16BE&quot;);</span>
<a href="#l5.24"></a><span id="l5.24"> }</span>
<a href="#l5.25"></a><span id="l5.25"> </span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-function *testUTF16LE() {</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">-  yield createMessage(do_get_file(&quot;data/test-UTF-16LE.txt&quot;));</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+async function testUTF16LE() {</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+  await createMessage(do_get_file(&quot;data/test-UTF-16LE.txt&quot;));</span>
<a href="#l5.30"></a><span id="l5.30">   checkAttachmentCharset(&quot;UTF-16LE&quot;);</span>
<a href="#l5.31"></a><span id="l5.31"> }</span>
<a href="#l5.32"></a><span id="l5.32"> </span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-function *testShiftJIS() {</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-  yield createMessage(do_get_file(&quot;data/test-SHIFT_JIS.txt&quot;));</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+async function testShiftJIS() {</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+  await createMessage(do_get_file(&quot;data/test-SHIFT_JIS.txt&quot;));</span>
<a href="#l5.37"></a><span id="l5.37">   checkAttachmentCharset(null); // do not detect SHIFT_JIS in this file anymore</span>
<a href="#l5.38"></a><span id="l5.38"> }</span>
<a href="#l5.39"></a><span id="l5.39"> </span>
<a href="#l5.40"></a><span id="l5.40"> var tests = [</span>
<a href="#l5.41"></a><span id="l5.41">   testUTF8,</span>
<a href="#l5.42"></a><span id="l5.42">   testUTF16BE,</span>
<a href="#l5.43"></a><span id="l5.43">   testUTF16LE,</span>
<a href="#l5.44"></a><span id="l5.44">   testShiftJIS</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_longLines.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_longLines.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -79,17 +79,17 @@ let longMultibyteLine = &quot;\u00E1&quot;.repeat(</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5"> // And here a line with a Korean character, encoded as three bytes</span>
<a href="#l6.6"></a><span id="l6.6"> // ec9588 in UTF-8.</span>
<a href="#l6.7"></a><span id="l6.7"> let longMultibyteLineCJK = &quot;&quot;.repeat(400);</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9"> // And some Japanese.</span>
<a href="#l6.10"></a><span id="l6.10"> let longMultibyteLineJapanese = &quot;&quot;.repeat(450);</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-function* testBodyWithLongLine() {</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+async function testBodyWithLongLine() {</span>
<a href="#l6.14"></a><span id="l6.14">   let newline;</span>
<a href="#l6.15"></a><span id="l6.15">   // Windows uses CR+LF, the other platforms just LF.</span>
<a href="#l6.16"></a><span id="l6.16">   // Note: Services.appinfo.OS returns &quot;XPCShell&quot; in the test, so we</span>
<a href="#l6.17"></a><span id="l6.17">   // use this hacky condition to separate Windows from the others.</span>
<a href="#l6.18"></a><span id="l6.18">   if (&quot;@mozilla.org/windows-registry-key;1&quot; in Cc) {</span>
<a href="#l6.19"></a><span id="l6.19">     newline = &quot;\r\n&quot;;</span>
<a href="#l6.20"></a><span id="l6.20">   } else {</span>
<a href="#l6.21"></a><span id="l6.21">     newline = &quot;\n&quot;;</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -103,89 +103,89 @@ function* testBodyWithLongLine() {</span>
<a href="#l6.23"></a><span id="l6.23">   fields.from = &quot;Nobody &lt;nobody@tinderbox.invalid&gt;&quot;;</span>
<a href="#l6.24"></a><span id="l6.24">   fields.to = &quot;Nobody &lt;nobody@tinderbox.invalid&gt;&quot;;</span>
<a href="#l6.25"></a><span id="l6.25">   fields.subject = &quot;Message with 1200 byte line in body&quot;;</span>
<a href="#l6.26"></a><span id="l6.26">   fields.characterSet = &quot;UTF-8&quot;;</span>
<a href="#l6.27"></a><span id="l6.27">   let htmlMessage = &quot;&lt;html&gt;&lt;head&gt;&quot; +</span>
<a href="#l6.28"></a><span id="l6.28">     &quot;&lt;meta http-equiv=\&quot;content-type\&quot; content=\&quot;text/html; charset=utf-8\&quot;&gt;&quot; +</span>
<a href="#l6.29"></a><span id="l6.29">     &quot;&lt;/head&gt;&lt;body&gt;&quot; + longMultibyteLine + &quot;&lt;/body&gt;&lt;/html&gt;&quot;;</span>
<a href="#l6.30"></a><span id="l6.30">   fields.body = htmlMessage;</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-  yield richCreateMessage(fields, [], identity);</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+  await richCreateMessage(fields, [], identity);</span>
<a href="#l6.33"></a><span id="l6.33">   checkDraftHeadersAndBody(</span>
<a href="#l6.34"></a><span id="l6.34">     {</span>
<a href="#l6.35"></a><span id="l6.35">       &quot;Content-Type&quot;: &quot;text/html; charset=UTF-8&quot;,</span>
<a href="#l6.36"></a><span id="l6.36">       &quot;Content-Transfer-Encoding&quot;: &quot;base64&quot;</span>
<a href="#l6.37"></a><span id="l6.37">     },</span>
<a href="#l6.38"></a><span id="l6.38">     htmlMessage</span>
<a href="#l6.39"></a><span id="l6.39">   );</span>
<a href="#l6.40"></a><span id="l6.40"> </span>
<a href="#l6.41"></a><span id="l6.41">   // Again, but this time as plain text.</span>
<a href="#l6.42"></a><span id="l6.42">   fields.body = htmlMessage;</span>
<a href="#l6.43"></a><span id="l6.43">   fields.forcePlainText = true;</span>
<a href="#l6.44"></a><span id="l6.44">   fields.useMultipartAlternative = false;</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineminus">-  yield richCreateMessage(fields, [], identity);</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+  await richCreateMessage(fields, [], identity);</span>
<a href="#l6.47"></a><span id="l6.47">   checkDraftHeadersAndBody(</span>
<a href="#l6.48"></a><span id="l6.48">     {</span>
<a href="#l6.49"></a><span id="l6.49">       &quot;Content-Type&quot;: &quot;text/plain; charset=UTF-8; format=flowed&quot;,</span>
<a href="#l6.50"></a><span id="l6.50">       &quot;Content-Transfer-Encoding&quot;: &quot;base64&quot;</span>
<a href="#l6.51"></a><span id="l6.51">     },</span>
<a href="#l6.52"></a><span id="l6.52">     longMultibyteLine + newline // Expected body: The message without the tags.</span>
<a href="#l6.53"></a><span id="l6.53">   );</span>
<a href="#l6.54"></a><span id="l6.54"> </span>
<a href="#l6.55"></a><span id="l6.55">   // Now CJK.</span>
<a href="#l6.56"></a><span id="l6.56">   fields.forcePlainText = false;</span>
<a href="#l6.57"></a><span id="l6.57">   htmlMessage = &quot;&lt;html&gt;&lt;head&gt;&quot; +</span>
<a href="#l6.58"></a><span id="l6.58">     &quot;&lt;meta http-equiv=\&quot;content-type\&quot; content=\&quot;text/html; charset=utf-8\&quot;&gt;&quot; +</span>
<a href="#l6.59"></a><span id="l6.59">     &quot;&lt;/head&gt;&lt;body&gt;&quot; + longMultibyteLineCJK + &quot;&lt;/body&gt;&lt;/html&gt;&quot;;</span>
<a href="#l6.60"></a><span id="l6.60">   fields.body = htmlMessage;</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineminus">-  yield richCreateMessage(fields, [], identity);</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+  await richCreateMessage(fields, [], identity);</span>
<a href="#l6.63"></a><span id="l6.63">   checkDraftHeadersAndBody(</span>
<a href="#l6.64"></a><span id="l6.64">     {</span>
<a href="#l6.65"></a><span id="l6.65">       &quot;Content-Type&quot;: &quot;text/html; charset=UTF-8&quot;,</span>
<a href="#l6.66"></a><span id="l6.66">       &quot;Content-Transfer-Encoding&quot;: &quot;base64&quot;</span>
<a href="#l6.67"></a><span id="l6.67">     },</span>
<a href="#l6.68"></a><span id="l6.68">     htmlMessage</span>
<a href="#l6.69"></a><span id="l6.69">   );</span>
<a href="#l6.70"></a><span id="l6.70"> </span>
<a href="#l6.71"></a><span id="l6.71">   // Again, but this time as plain text.</span>
<a href="#l6.72"></a><span id="l6.72">   fields.body = htmlMessage;</span>
<a href="#l6.73"></a><span id="l6.73">   fields.forcePlainText = true;</span>
<a href="#l6.74"></a><span id="l6.74">   fields.useMultipartAlternative = false;</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineminus">-  yield richCreateMessage(fields, [], identity);</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+  await richCreateMessage(fields, [], identity);</span>
<a href="#l6.77"></a><span id="l6.77">   checkDraftHeadersAndBody(</span>
<a href="#l6.78"></a><span id="l6.78">     {</span>
<a href="#l6.79"></a><span id="l6.79">       &quot;Content-Type&quot;: &quot;text/plain; charset=UTF-8; format=flowed&quot;,</span>
<a href="#l6.80"></a><span id="l6.80">       &quot;Content-Transfer-Encoding&quot;: &quot;base64&quot;</span>
<a href="#l6.81"></a><span id="l6.81">     },</span>
<a href="#l6.82"></a><span id="l6.82">     longMultibyteLineCJK + newline // Expected body: The message without the tags.</span>
<a href="#l6.83"></a><span id="l6.83">   );</span>
<a href="#l6.84"></a><span id="l6.84"> </span>
<a href="#l6.85"></a><span id="l6.85">   // Now a special test for ISO-2022-JP.</span>
<a href="#l6.86"></a><span id="l6.86">   fields.characterSet = &quot;ISO-2022-JP&quot;;</span>
<a href="#l6.87"></a><span id="l6.87"> </span>
<a href="#l6.88"></a><span id="l6.88">   fields.forcePlainText = false;</span>
<a href="#l6.89"></a><span id="l6.89">   htmlMessage = &quot;&lt;html&gt;&lt;head&gt;&quot; +</span>
<a href="#l6.90"></a><span id="l6.90">     &quot;&lt;meta http-equiv=\&quot;content-type\&quot; content=\&quot;text/html; charset=ISO-2022-JP\&quot;&gt;&quot; +</span>
<a href="#l6.91"></a><span id="l6.91">     &quot;&lt;/head&gt;&lt;body&gt;&quot; + longMultibyteLineJapanese + &quot;&lt;/body&gt;&lt;/html&gt;&quot;;</span>
<a href="#l6.92"></a><span id="l6.92">   fields.body = htmlMessage;</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineminus">-  yield richCreateMessage(fields, [], identity);</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+  await richCreateMessage(fields, [], identity);</span>
<a href="#l6.95"></a><span id="l6.95">   checkDraftHeadersAndBody(</span>
<a href="#l6.96"></a><span id="l6.96">     {</span>
<a href="#l6.97"></a><span id="l6.97">       &quot;Content-Type&quot;: &quot;text/html; charset=ISO-2022-JP&quot;,</span>
<a href="#l6.98"></a><span id="l6.98">       &quot;Content-Transfer-Encoding&quot;: &quot;base64&quot;</span>
<a href="#l6.99"></a><span id="l6.99">     },</span>
<a href="#l6.100"></a><span id="l6.100">     htmlMessage,</span>
<a href="#l6.101"></a><span id="l6.101">     &quot;ISO-2022-JP&quot;</span>
<a href="#l6.102"></a><span id="l6.102">   );</span>
<a href="#l6.103"></a><span id="l6.103"> </span>
<a href="#l6.104"></a><span id="l6.104">   // Again, but this time as plain text.</span>
<a href="#l6.105"></a><span id="l6.105">   fields.body = htmlMessage;</span>
<a href="#l6.106"></a><span id="l6.106">   fields.forcePlainText = true;</span>
<a href="#l6.107"></a><span id="l6.107">   fields.useMultipartAlternative = false;</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineminus">-  yield richCreateMessage(fields, [], identity);</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineplus">+  await richCreateMessage(fields, [], identity);</span>
<a href="#l6.110"></a><span id="l6.110"> </span>
<a href="#l6.111"></a><span id="l6.111">   // Expected body: The message without the tags and chopped up in</span>
<a href="#l6.112"></a><span id="l6.112">   // chunks of 36 characters with a space appended to each line.</span>
<a href="#l6.113"></a><span id="l6.113">   let expectedBody = &quot;&quot;;</span>
<a href="#l6.114"></a><span id="l6.114">   let lastIndex = 0;</span>
<a href="#l6.115"></a><span id="l6.115">   for (let i = 0; i + 36 &lt; longMultibyteLineJapanese.length; i = i + 36) {</span>
<a href="#l6.116"></a><span id="l6.116">     expectedBody = expectedBody + longMultibyteLineJapanese.substr(i, 36) + &quot; \r\n&quot;;</span>
<a href="#l6.117"></a><span id="l6.117">     lastIndex = i + 36;</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineat">@@ -200,17 +200,17 @@ function* testBodyWithLongLine() {</span>
<a href="#l6.119"></a><span id="l6.119">     expectedBody,</span>
<a href="#l6.120"></a><span id="l6.120">     &quot;ISO-2022-JP&quot;</span>
<a href="#l6.121"></a><span id="l6.121">   );</span>
<a href="#l6.122"></a><span id="l6.122"> </span>
<a href="#l6.123"></a><span id="l6.123">   // Again, but this time not flowed.</span>
<a href="#l6.124"></a><span id="l6.124">   fields.body = htmlMessage;</span>
<a href="#l6.125"></a><span id="l6.125">   Services.prefs.setBoolPref(&quot;mailnews.send_plaintext_flowed&quot;, false);</span>
<a href="#l6.126"></a><span id="l6.126"> </span>
<a href="#l6.127"></a><span id="l6.127" class="difflineminus">-  yield richCreateMessage(fields, [], identity);</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineplus">+  await richCreateMessage(fields, [], identity);</span>
<a href="#l6.129"></a><span id="l6.129">   checkDraftHeadersAndBody(</span>
<a href="#l6.130"></a><span id="l6.130">     {</span>
<a href="#l6.131"></a><span id="l6.131">       &quot;Content-Type&quot;: &quot;text/plain; charset=ISO-2022-JP&quot;,</span>
<a href="#l6.132"></a><span id="l6.132">       &quot;Content-Transfer-Encoding&quot;: &quot;7bit&quot;</span>
<a href="#l6.133"></a><span id="l6.133">     },</span>
<a href="#l6.134"></a><span id="l6.134">     expectedBody.replace(/ /g, &quot;&quot;), // No spaces expected this time.</span>
<a href="#l6.135"></a><span id="l6.135">     &quot;ISO-2022-JP&quot;</span>
<a href="#l6.136"></a><span id="l6.136">   );</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_messageHeaders.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_messageHeaders.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -72,150 +72,150 @@ function checkMessageHeaders(msgData, ex</span>
<a href="#l7.4"></a><span id="l7.4">         }</span>
<a href="#l7.5"></a><span id="l7.5">       }</span>
<a href="#l7.6"></a><span id="l7.6">     }</span>
<a href="#l7.7"></a><span id="l7.7">   };</span>
<a href="#l7.8"></a><span id="l7.8">   MimeParser.parseSync(msgData, handler, {onerror: function (e) { throw e; }});</span>
<a href="#l7.9"></a><span id="l7.9">   Assert.ok(seen);</span>
<a href="#l7.10"></a><span id="l7.10"> }</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-function* testEnvelope() {</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+async function testEnvelope() {</span>
<a href="#l7.14"></a><span id="l7.14">   let fields = new CompFields();</span>
<a href="#l7.15"></a><span id="l7.15">   let identity = getSmtpIdentity(&quot;from@tinderbox.invalid&quot;,</span>
<a href="#l7.16"></a><span id="l7.16">     getBasicSmtpServer());</span>
<a href="#l7.17"></a><span id="l7.17">   identity.fullName = &quot;Me&quot;;</span>
<a href="#l7.18"></a><span id="l7.18">   identity.organization = &quot;World Destruction Committee&quot;;</span>
<a href="#l7.19"></a><span id="l7.19">   fields.from = &quot;Nobody &lt;nobody@tinderbox.invalid&gt;&quot;;</span>
<a href="#l7.20"></a><span id="l7.20">   fields.to = &quot;Nobody &lt;nobody@tinderbox.invalid&gt;&quot;;</span>
<a href="#l7.21"></a><span id="l7.21">   fields.cc = &quot;Alex &lt;alex@tinderbox.invalid&gt;&quot;;</span>
<a href="#l7.22"></a><span id="l7.22">   fields.bcc = &quot;Boris &lt;boris@tinderbox.invalid&gt;&quot;;</span>
<a href="#l7.23"></a><span id="l7.23">   fields.replyTo = &quot;Charles &lt;charles@tinderbox.invalid&gt;&quot;;</span>
<a href="#l7.24"></a><span id="l7.24">   fields.organization = &quot;World Salvation Committee&quot;;</span>
<a href="#l7.25"></a><span id="l7.25">   fields.subject = &quot;This is an obscure reference&quot;;</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-  yield richCreateMessage(fields, [], identity);</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+  await richCreateMessage(fields, [], identity);</span>
<a href="#l7.28"></a><span id="l7.28">   checkDraftHeaders({</span>
<a href="#l7.29"></a><span id="l7.29">     // As of bug 87987, the identity does not override the from header.</span>
<a href="#l7.30"></a><span id="l7.30">     &quot;From&quot;: &quot;Nobody &lt;nobody@tinderbox.invalid&gt;&quot;,</span>
<a href="#l7.31"></a><span id="l7.31">     // The identity should override the organization field here.</span>
<a href="#l7.32"></a><span id="l7.32">     &quot;Organization&quot;: &quot;World Destruction Committee&quot;,</span>
<a href="#l7.33"></a><span id="l7.33">     &quot;To&quot;: &quot;Nobody &lt;nobody@tinderbox.invalid&gt;&quot;,</span>
<a href="#l7.34"></a><span id="l7.34">     &quot;Cc&quot;: &quot;Alex &lt;alex@tinderbox.invalid&gt;&quot;,</span>
<a href="#l7.35"></a><span id="l7.35">     &quot;Bcc&quot;: &quot;Boris &lt;boris@tinderbox.invalid&gt;&quot;,</span>
<a href="#l7.36"></a><span id="l7.36">     &quot;Reply-To&quot;: &quot;Charles &lt;charles@tinderbox.invalid&gt;&quot;,</span>
<a href="#l7.37"></a><span id="l7.37">     &quot;Subject&quot;: &quot;This is an obscure reference&quot;,</span>
<a href="#l7.38"></a><span id="l7.38">   });</span>
<a href="#l7.39"></a><span id="l7.39"> }</span>
<a href="#l7.40"></a><span id="l7.40"> </span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-function* testI18NEnvelope() {</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+async function testI18NEnvelope() {</span>
<a href="#l7.43"></a><span id="l7.43">   let fields = new CompFields();</span>
<a href="#l7.44"></a><span id="l7.44">   let identity = getSmtpIdentity(&quot;from@tinderbox.invalid&quot;,</span>
<a href="#l7.45"></a><span id="l7.45">     getBasicSmtpServer());</span>
<a href="#l7.46"></a><span id="l7.46">   identity.fullName = &quot;&quot;;</span>
<a href="#l7.47"></a><span id="l7.47">   identity.organization = &quot;Comit de la destruction du monde&quot;;</span>
<a href="#l7.48"></a><span id="l7.48">   fields.to = &quot;mile &lt;nobody@tinderbox.invalid&gt;&quot;;</span>
<a href="#l7.49"></a><span id="l7.49">   fields.cc = &quot;Andr Chopin &lt;alex@tinderbox.invalid&gt;&quot;;</span>
<a href="#l7.50"></a><span id="l7.50">   fields.bcc = &quot;tienne &lt;boris@tinderbox.invalid&gt;&quot;;</span>
<a href="#l7.51"></a><span id="l7.51">   fields.replyTo = &quot;Frdric &lt;charles@tinderbox.invalid&gt;&quot;;</span>
<a href="#l7.52"></a><span id="l7.52">   fields.subject = &quot;Ceci n'est pas un rfrence obscure&quot;;</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-  yield richCreateMessage(fields, [], identity);</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+  await richCreateMessage(fields, [], identity);</span>
<a href="#l7.55"></a><span id="l7.55">   checkDraftHeaders({</span>
<a href="#l7.56"></a><span id="l7.56">     &quot;From&quot;: &quot;=?UTF-8?B?44Kx44OE44Kh44Or44Kz44Ki44OI44Or?= &lt;from@tinderbox.invalid&gt;&quot;,</span>
<a href="#l7.57"></a><span id="l7.57">     &quot;Organization&quot;: &quot;=?UTF-8?Q?Comit=c3=a9_de_la_destruction_du_monde?=&quot;,</span>
<a href="#l7.58"></a><span id="l7.58">     &quot;To&quot;: &quot;=?UTF-8?B?w4ltaWxl?= &lt;nobody@tinderbox.invalid&gt;&quot;,</span>
<a href="#l7.59"></a><span id="l7.59">     &quot;Cc&quot;: &quot;=?UTF-8?Q?Andr=c3=a9_Chopin?= &lt;alex@tinderbox.invalid&gt;&quot;,</span>
<a href="#l7.60"></a><span id="l7.60">     &quot;Bcc&quot;: &quot;=?UTF-8?Q?=c3=89tienne?= &lt;boris@tinderbox.invalid&gt;&quot;,</span>
<a href="#l7.61"></a><span id="l7.61">     &quot;Reply-To&quot;: &quot;=?UTF-8?B?RnLDqWTDqXJpYw==?= &lt;charles@tinderbox.invalid&gt;&quot;,</span>
<a href="#l7.62"></a><span id="l7.62">     &quot;Subject&quot;: &quot;=?UTF-8?Q?Ceci_n=27est_pas_un_r=c3=a9f=c3=a9rence_obscure?=&quot;,</span>
<a href="#l7.63"></a><span id="l7.63">   });</span>
<a href="#l7.64"></a><span id="l7.64"> }</span>
<a href="#l7.65"></a><span id="l7.65"> </span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-function* testIDNEnvelope() {</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+async function testIDNEnvelope() {</span>
<a href="#l7.68"></a><span id="l7.68">   let fields = new CompFields();</span>
<a href="#l7.69"></a><span id="l7.69">   let domain = &quot;.invalid&quot;;</span>
<a href="#l7.70"></a><span id="l7.70">   // We match against rawHeaderText, so we need to encode the string as a binary</span>
<a href="#l7.71"></a><span id="l7.71">   // string instead of a unicode string.</span>
<a href="#l7.72"></a><span id="l7.72">   let utf8Domain = String.fromCharCode.apply(undefined,</span>
<a href="#l7.73"></a><span id="l7.73">     new TextEncoder(&quot;UTF-8&quot;).encode(domain));</span>
<a href="#l7.74"></a><span id="l7.74">   // Bug 1034658: nsIMsgIdentity doesn't like IDN in its email addresses.</span>
<a href="#l7.75"></a><span id="l7.75">   let identity = getSmtpIdentity(&quot;from@tinderbox.invalid&quot;,</span>
<a href="#l7.76"></a><span id="l7.76">     getBasicSmtpServer());</span>
<a href="#l7.77"></a><span id="l7.77">   fields.to = &quot;Nobody &lt;nobody@&quot; + domain + &quot;&gt;&quot;;</span>
<a href="#l7.78"></a><span id="l7.78">   fields.cc = &quot;Alex &lt;alex@&quot; + domain + &quot;&gt;&quot;;</span>
<a href="#l7.79"></a><span id="l7.79">   fields.bcc = &quot;Boris &lt;boris@&quot; + domain + &quot;&gt;&quot;;</span>
<a href="#l7.80"></a><span id="l7.80">   fields.replyTo = &quot;Charles &lt;charles@&quot; + domain + &quot;&gt;&quot;;</span>
<a href="#l7.81"></a><span id="l7.81">   fields.subject = &quot;This is an obscure reference&quot;;</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-  yield richCreateMessage(fields, [], identity);</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+  await richCreateMessage(fields, [], identity);</span>
<a href="#l7.84"></a><span id="l7.84">   checkDraftHeaders({</span>
<a href="#l7.85"></a><span id="l7.85">     // The identity sets the from field here.</span>
<a href="#l7.86"></a><span id="l7.86">     &quot;From&quot;: &quot;from@tinderbox.invalid&quot;,</span>
<a href="#l7.87"></a><span id="l7.87">     &quot;To&quot;: &quot;Nobody &lt;nobody@&quot; + utf8Domain + &quot;&gt;&quot;,</span>
<a href="#l7.88"></a><span id="l7.88">     &quot;Cc&quot;: &quot;Alex &lt;alex@&quot; + utf8Domain + &quot;&gt;&quot;,</span>
<a href="#l7.89"></a><span id="l7.89">     &quot;Bcc&quot;: &quot;Boris &lt;boris@&quot; + utf8Domain +&quot;&gt;&quot;,</span>
<a href="#l7.90"></a><span id="l7.90">     &quot;Reply-To&quot;: &quot;Charles &lt;charles@&quot; + utf8Domain + &quot;&gt;&quot;,</span>
<a href="#l7.91"></a><span id="l7.91">     &quot;Subject&quot;: &quot;This is an obscure reference&quot;,</span>
<a href="#l7.92"></a><span id="l7.92">   });</span>
<a href="#l7.93"></a><span id="l7.93"> }</span>
<a href="#l7.94"></a><span id="l7.94"> </span>
<a href="#l7.95"></a><span id="l7.95" class="difflineminus">-function* testDraftInfo() {</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+async function testDraftInfo() {</span>
<a href="#l7.97"></a><span id="l7.97">   let fields = new CompFields();</span>
<a href="#l7.98"></a><span id="l7.98">   let identity = getSmtpIdentity(&quot;from@tinderbox.invalid&quot;,</span>
<a href="#l7.99"></a><span id="l7.99">     getBasicSmtpServer());</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineminus">-  yield richCreateMessage(fields, [], identity);</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+  await richCreateMessage(fields, [], identity);</span>
<a href="#l7.102"></a><span id="l7.102">   checkDraftHeaders({</span>
<a href="#l7.103"></a><span id="l7.103">     &quot;FCC&quot;: identity.fccFolder,</span>
<a href="#l7.104"></a><span id="l7.104">     &quot;X-Identity-Key&quot;: identity.key,</span>
<a href="#l7.105"></a><span id="l7.105">     &quot;X-Mozilla-Draft-Info&quot;: &quot;internal/draft; &quot; +</span>
<a href="#l7.106"></a><span id="l7.106">       &quot;vcard=0; receipt=0; DSN=0; uuencode=0; attachmentreminder=0; deliveryformat=4&quot;,</span>
<a href="#l7.107"></a><span id="l7.107">   });</span>
<a href="#l7.108"></a><span id="l7.108"> </span>
<a href="#l7.109"></a><span id="l7.109">   fields.attachVCard = true;</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineminus">-  yield richCreateMessage(fields, [], identity);</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+  await richCreateMessage(fields, [], identity);</span>
<a href="#l7.112"></a><span id="l7.112">   checkDraftHeaders({</span>
<a href="#l7.113"></a><span id="l7.113">     &quot;X-Mozilla-Draft-Info&quot;: &quot;internal/draft; &quot; +</span>
<a href="#l7.114"></a><span id="l7.114">       &quot;vcard=1; receipt=0; DSN=0; uuencode=0; attachmentreminder=0; deliveryformat=4&quot;,</span>
<a href="#l7.115"></a><span id="l7.115">   });</span>
<a href="#l7.116"></a><span id="l7.116"> </span>
<a href="#l7.117"></a><span id="l7.117">   fields.returnReceipt = true;</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineminus">-  yield richCreateMessage(fields, [], identity);</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+  await richCreateMessage(fields, [], identity);</span>
<a href="#l7.120"></a><span id="l7.120">   checkDraftHeaders({</span>
<a href="#l7.121"></a><span id="l7.121">     &quot;X-Mozilla-Draft-Info&quot;: &quot;internal/draft; &quot; +</span>
<a href="#l7.122"></a><span id="l7.122">       &quot;vcard=1; receipt=1; DSN=0; uuencode=0; attachmentreminder=0; deliveryformat=4&quot;,</span>
<a href="#l7.123"></a><span id="l7.123">   });</span>
<a href="#l7.124"></a><span id="l7.124"> </span>
<a href="#l7.125"></a><span id="l7.125">   fields.DSN = true;</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineminus">-  yield richCreateMessage(fields, [], identity);</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineplus">+  await richCreateMessage(fields, [], identity);</span>
<a href="#l7.128"></a><span id="l7.128">   checkDraftHeaders({</span>
<a href="#l7.129"></a><span id="l7.129">     &quot;X-Mozilla-Draft-Info&quot;: &quot;internal/draft; &quot; +</span>
<a href="#l7.130"></a><span id="l7.130">       &quot;vcard=1; receipt=1; DSN=1; uuencode=0; attachmentreminder=0; deliveryformat=4&quot;,</span>
<a href="#l7.131"></a><span id="l7.131">   });</span>
<a href="#l7.132"></a><span id="l7.132"> </span>
<a href="#l7.133"></a><span id="l7.133">   fields.attachmentReminder = true;</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineminus">-  yield richCreateMessage(fields, [], identity);</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineplus">+  await richCreateMessage(fields, [], identity);</span>
<a href="#l7.136"></a><span id="l7.136">   checkDraftHeaders({</span>
<a href="#l7.137"></a><span id="l7.137">     &quot;X-Mozilla-Draft-Info&quot;: &quot;internal/draft; &quot; +</span>
<a href="#l7.138"></a><span id="l7.138">       &quot;vcard=1; receipt=1; DSN=1; uuencode=0; attachmentreminder=1; deliveryformat=4&quot;,</span>
<a href="#l7.139"></a><span id="l7.139">   });</span>
<a href="#l7.140"></a><span id="l7.140"> </span>
<a href="#l7.141"></a><span id="l7.141">   fields.deliveryFormat = Ci.nsIMsgCompSendFormat.Both;</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineminus">-  yield richCreateMessage(fields, [], identity);</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineplus">+  await richCreateMessage(fields, [], identity);</span>
<a href="#l7.144"></a><span id="l7.144">   checkDraftHeaders({</span>
<a href="#l7.145"></a><span id="l7.145">     &quot;X-Mozilla-Draft-Info&quot;: &quot;internal/draft; &quot; +</span>
<a href="#l7.146"></a><span id="l7.146">       &quot;vcard=1; receipt=1; DSN=1; uuencode=0; attachmentreminder=1; deliveryformat=3&quot;,</span>
<a href="#l7.147"></a><span id="l7.147">   });</span>
<a href="#l7.148"></a><span id="l7.148"> }</span>
<a href="#l7.149"></a><span id="l7.149"> </span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-function* testOtherHeaders() {</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineplus">+async function testOtherHeaders() {</span>
<a href="#l7.152"></a><span id="l7.152">   let fields = new CompFields();</span>
<a href="#l7.153"></a><span id="l7.153">   let identity = getSmtpIdentity(&quot;from@tinderbox.invalid&quot;,</span>
<a href="#l7.154"></a><span id="l7.154">     getBasicSmtpServer());</span>
<a href="#l7.155"></a><span id="l7.155">   fields.priority = &quot;high&quot;;</span>
<a href="#l7.156"></a><span id="l7.156">   fields.references = &quot;&lt;fake@tinderbox.invalid&gt; &lt;more@test.invalid&gt;&quot;;</span>
<a href="#l7.157"></a><span id="l7.157">   fields.setHeader(&quot;X-Fake-Header&quot;, &quot;124&quot;);</span>
<a href="#l7.158"></a><span id="l7.158">   let before = Date.now();</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineminus">-  let msgHdr = yield richCreateMessage(fields, [], identity);</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineplus">+  let msgHdr = await richCreateMessage(fields, [], identity);</span>
<a href="#l7.161"></a><span id="l7.161">   let after = Date.now();</span>
<a href="#l7.162"></a><span id="l7.162">   let msgData = mailTestUtils.loadMessageToString(msgHdr.folder, msgHdr);</span>
<a href="#l7.163"></a><span id="l7.163">   checkMessageHeaders(msgData, {</span>
<a href="#l7.164"></a><span id="l7.164">     &quot;Mime-Version&quot;: &quot;1.0&quot;,</span>
<a href="#l7.165"></a><span id="l7.165">     &quot;User-Agent&quot;:  Cc[&quot;@mozilla.org/network/protocol;1?name=http&quot;]</span>
<a href="#l7.166"></a><span id="l7.166">                      .getService(Ci.nsIHttpProtocolHandler).userAgent,</span>
<a href="#l7.167"></a><span id="l7.167">     &quot;X-Priority&quot;: &quot;2 (High)&quot;,</span>
<a href="#l7.168"></a><span id="l7.168">     &quot;References&quot;: &quot;&lt;fake@tinderbox.invalid&gt; &lt;more@test.invalid&gt;&quot;,</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineat">@@ -251,145 +251,145 @@ function* testOtherHeaders() {</span>
<a href="#l7.170"></a><span id="l7.170"> </span>
<a href="#l7.171"></a><span id="l7.171">   // We truncate too-long References. Check this.</span>
<a href="#l7.172"></a><span id="l7.172">   let references = [];</span>
<a href="#l7.173"></a><span id="l7.173">   for (let i = 0; i &lt; 100; i++)</span>
<a href="#l7.174"></a><span id="l7.174">     references.push(&quot;&lt;&quot; + i + &quot;@test.invalid&gt;&quot;);</span>
<a href="#l7.175"></a><span id="l7.175">   let expected = references.slice(47);</span>
<a href="#l7.176"></a><span id="l7.176">   expected.unshift(references[0]);</span>
<a href="#l7.177"></a><span id="l7.177">   fields.references = references.join(&quot; &quot;);</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineminus">-  yield richCreateMessage(fields, [], identity);</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineplus">+  await richCreateMessage(fields, [], identity);</span>
<a href="#l7.180"></a><span id="l7.180">   checkDraftHeaders({</span>
<a href="#l7.181"></a><span id="l7.181">     &quot;References&quot;: expected.join(&quot; &quot;),</span>
<a href="#l7.182"></a><span id="l7.182">     &quot;In-Reply-To&quot;: references[references.length - 1],</span>
<a href="#l7.183"></a><span id="l7.183">   });</span>
<a href="#l7.184"></a><span id="l7.184"> }</span>
<a href="#l7.185"></a><span id="l7.185"> </span>
<a href="#l7.186"></a><span id="l7.186" class="difflineminus">-function* testNewsgroups() {</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineplus">+async function testNewsgroups() {</span>
<a href="#l7.188"></a><span id="l7.188">   let fields = new CompFields();</span>
<a href="#l7.189"></a><span id="l7.189">   let nntpServer = localAccountUtils.create_incoming_server(&quot;nntp&quot;, 534,</span>
<a href="#l7.190"></a><span id="l7.190">       &quot;&quot;, &quot;&quot;);</span>
<a href="#l7.191"></a><span id="l7.191">   nntpServer.QueryInterface(Ci.nsINntpIncomingServer)</span>
<a href="#l7.192"></a><span id="l7.192">     .subscribeToNewsgroup(&quot;mozilla.test&quot;);</span>
<a href="#l7.193"></a><span id="l7.193">   let identity = getSmtpIdentity(&quot;from@tinderbox.invalid&quot;,</span>
<a href="#l7.194"></a><span id="l7.194">     getBasicSmtpServer());</span>
<a href="#l7.195"></a><span id="l7.195">   fields.newsgroups = &quot;mozilla.test, mozilla.test.multimedia&quot;;</span>
<a href="#l7.196"></a><span id="l7.196">   fields.followupTo = &quot;mozilla.test&quot;;</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineminus">-  yield richCreateMessage(fields, [], identity);</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineplus">+  await richCreateMessage(fields, [], identity);</span>
<a href="#l7.199"></a><span id="l7.199">   checkDraftHeaders({</span>
<a href="#l7.200"></a><span id="l7.200">     // The identity should override the compose fields here.</span>
<a href="#l7.201"></a><span id="l7.201">     &quot;Newsgroups&quot;: &quot;mozilla.test,mozilla.test.multimedia&quot;,</span>
<a href="#l7.202"></a><span id="l7.202">     &quot;Followup-To&quot;: &quot;mozilla.test&quot;,</span>
<a href="#l7.203"></a><span id="l7.203">     &quot;X-Mozilla-News-Host&quot;: &quot;localhost&quot;,</span>
<a href="#l7.204"></a><span id="l7.204">   });</span>
<a href="#l7.205"></a><span id="l7.205"> }</span>
<a href="#l7.206"></a><span id="l7.206"> </span>
<a href="#l7.207"></a><span id="l7.207" class="difflineminus">-function* testSendHeaders() {</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineplus">+async function testSendHeaders() {</span>
<a href="#l7.209"></a><span id="l7.209">   let fields = new CompFields();</span>
<a href="#l7.210"></a><span id="l7.210">   let identity = getSmtpIdentity(&quot;from@tinderbox.invalid&quot;,</span>
<a href="#l7.211"></a><span id="l7.211">     getBasicSmtpServer());</span>
<a href="#l7.212"></a><span id="l7.212">   identity.setCharAttribute(&quot;headers&quot;, &quot;bah,humbug&quot;);</span>
<a href="#l7.213"></a><span id="l7.213">   identity.setCharAttribute(&quot;header.bah&quot;, &quot;X-Custom-1: A header value&quot;);</span>
<a href="#l7.214"></a><span id="l7.214">   identity.setUnicharAttribute(&quot;header.humbug&quot;, &quot;X-Custom-2: Enchant&quot;);</span>
<a href="#l7.215"></a><span id="l7.215">   identity.setCharAttribute(&quot;subscribed_mailing_lists&quot;, &quot;list@test.invalid&quot;);</span>
<a href="#l7.216"></a><span id="l7.216">   identity.setCharAttribute(&quot;replyto_mangling_mailing_lists&quot;,</span>
<a href="#l7.217"></a><span id="l7.217">     &quot;replyto@test.invalid&quot;);</span>
<a href="#l7.218"></a><span id="l7.218">   fields.to = &quot;list@test.invalid&quot;;</span>
<a href="#l7.219"></a><span id="l7.219">   fields.cc = &quot;not-list@test.invalid&quot;;</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineminus">-  yield richCreateMessage(fields, [], identity);</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineplus">+  await richCreateMessage(fields, [], identity);</span>
<a href="#l7.222"></a><span id="l7.222">   checkDraftHeaders({</span>
<a href="#l7.223"></a><span id="l7.223">     &quot;X-Custom-1&quot;: &quot;A header value&quot;,</span>
<a href="#l7.224"></a><span id="l7.224">     &quot;X-Custom-2&quot;: &quot;=?UTF-8?Q?_Enchant=c3=a9?=&quot;,</span>
<a href="#l7.225"></a><span id="l7.225">     &quot;Mail-Followup-To&quot;: &quot;list@test.invalid, not-list@test.invalid&quot;,</span>
<a href="#l7.226"></a><span id="l7.226">     &quot;Mail-Reply-To&quot;: undefined,</span>
<a href="#l7.227"></a><span id="l7.227">   });</span>
<a href="#l7.228"></a><span id="l7.228"> </span>
<a href="#l7.229"></a><span id="l7.229">   // Don't set the M-F-T header if there's no list.</span>
<a href="#l7.230"></a><span id="l7.230">   fields.to = &quot;replyto@test.invalid&quot;;</span>
<a href="#l7.231"></a><span id="l7.231">   fields.cc = &quot;&quot;;</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineminus">-  yield richCreateMessage(fields, [], identity);</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineplus">+  await richCreateMessage(fields, [], identity);</span>
<a href="#l7.234"></a><span id="l7.234">   checkDraftHeaders({</span>
<a href="#l7.235"></a><span id="l7.235">     &quot;X-Custom-1&quot;: &quot;A header value&quot;,</span>
<a href="#l7.236"></a><span id="l7.236">     &quot;X-Custom-2&quot;: &quot;=?UTF-8?Q?_Enchant=c3=a9?=&quot;,</span>
<a href="#l7.237"></a><span id="l7.237">     &quot;Mail-Reply-To&quot;: &quot;from@tinderbox.invalid&quot;,</span>
<a href="#l7.238"></a><span id="l7.238">     &quot;Mail-Followup-To&quot;: undefined,</span>
<a href="#l7.239"></a><span id="l7.239">   });</span>
<a href="#l7.240"></a><span id="l7.240"> }</span>
<a href="#l7.241"></a><span id="l7.241"> </span>
<a href="#l7.242"></a><span id="l7.242" class="difflineminus">-function* testContentHeaders() {</span>
<a href="#l7.243"></a><span id="l7.243" class="difflineplus">+async function testContentHeaders() {</span>
<a href="#l7.244"></a><span id="l7.244">   // Disable RFC 2047 fallback</span>
<a href="#l7.245"></a><span id="l7.245">   Services.prefs.setIntPref(&quot;mail.strictly_mime.parm_folding&quot;, 2);</span>
<a href="#l7.246"></a><span id="l7.246">   let fields = new CompFields();</span>
<a href="#l7.247"></a><span id="l7.247">   fields.body = &quot;A body&quot;;</span>
<a href="#l7.248"></a><span id="l7.248">   let identity = getSmtpIdentity(&quot;from@tinderbox.invalid&quot;,</span>
<a href="#l7.249"></a><span id="l7.249">     getBasicSmtpServer());</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineminus">-  yield richCreateMessage(fields, [], identity);</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineplus">+  await richCreateMessage(fields, [], identity);</span>
<a href="#l7.252"></a><span id="l7.252">   checkDraftHeaders({</span>
<a href="#l7.253"></a><span id="l7.253">     &quot;Content-Type&quot;: &quot;text/html; charset=UTF-8&quot;,</span>
<a href="#l7.254"></a><span id="l7.254">     &quot;Content-Transfer-Encoding&quot;: &quot;7bit&quot;</span>
<a href="#l7.255"></a><span id="l7.255">   });</span>
<a href="#l7.256"></a><span id="l7.256"> </span>
<a href="#l7.257"></a><span id="l7.257">   // non-ASCII body should be 8-bit...</span>
<a href="#l7.258"></a><span id="l7.258">   fields.body = &quot;Archologist&quot;;</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineminus">-  yield richCreateMessage(fields, [], identity);</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineplus">+  await richCreateMessage(fields, [], identity);</span>
<a href="#l7.261"></a><span id="l7.261">   checkDraftHeaders({</span>
<a href="#l7.262"></a><span id="l7.262">     &quot;Content-Type&quot;: &quot;text/html; charset=UTF-8&quot;,</span>
<a href="#l7.263"></a><span id="l7.263">     &quot;Content-Transfer-Encoding&quot;: &quot;8bit&quot;</span>
<a href="#l7.264"></a><span id="l7.264">   });</span>
<a href="#l7.265"></a><span id="l7.265"> </span>
<a href="#l7.266"></a><span id="l7.266">   // What if we change the message charset?</span>
<a href="#l7.267"></a><span id="l7.267">   fields.characterSet = &quot;ISO-8859-1&quot;;</span>
<a href="#l7.268"></a><span id="l7.268">   fields.body = &quot;Archologist&quot;;</span>
<a href="#l7.269"></a><span id="l7.269" class="difflineminus">-  yield richCreateMessage(fields, [], identity);</span>
<a href="#l7.270"></a><span id="l7.270" class="difflineplus">+  await richCreateMessage(fields, [], identity);</span>
<a href="#l7.271"></a><span id="l7.271">   checkDraftHeaders({</span>
<a href="#l7.272"></a><span id="l7.272">     &quot;Content-Type&quot;: &quot;text/html; charset=ISO-8859-1&quot;,</span>
<a href="#l7.273"></a><span id="l7.273">     &quot;Content-Transfer-Encoding&quot;: &quot;8bit&quot;</span>
<a href="#l7.274"></a><span id="l7.274">   });</span>
<a href="#l7.275"></a><span id="l7.275"> </span>
<a href="#l7.276"></a><span id="l7.276">   // Attachments</span>
<a href="#l7.277"></a><span id="l7.277">   fields.body = &quot;&quot;;</span>
<a href="#l7.278"></a><span id="l7.278">   let plainAttachment = makeAttachment({</span>
<a href="#l7.279"></a><span id="l7.279">     url: &quot;data:text/plain,ol&quot;,</span>
<a href="#l7.280"></a><span id="l7.280">     name: &quot;attachment.txt&quot;</span>
<a href="#l7.281"></a><span id="l7.281">   });</span>
<a href="#l7.282"></a><span id="l7.282">   let plainAttachmentHeaders = {</span>
<a href="#l7.283"></a><span id="l7.283">     &quot;Content-Type&quot;: &quot;text/plain; charset=UTF-8&quot;,</span>
<a href="#l7.284"></a><span id="l7.284">     &quot;Content-Transfer-Encoding&quot;: &quot;base64&quot;,</span>
<a href="#l7.285"></a><span id="l7.285">     &quot;Content-Disposition&quot;: &quot;attachment; filename=\&quot;attachment.txt\&quot;&quot;,</span>
<a href="#l7.286"></a><span id="l7.286">   };</span>
<a href="#l7.287"></a><span id="l7.287" class="difflineminus">-  yield richCreateMessage(fields, [plainAttachment], identity);</span>
<a href="#l7.288"></a><span id="l7.288" class="difflineplus">+  await richCreateMessage(fields, [plainAttachment], identity);</span>
<a href="#l7.289"></a><span id="l7.289">   checkDraftHeaders({</span>
<a href="#l7.290"></a><span id="l7.290">     &quot;Content-Type&quot;: &quot;text/html; charset=ISO-8859-1&quot;,</span>
<a href="#l7.291"></a><span id="l7.291">     &quot;Content-Transfer-Encoding&quot;: &quot;7bit&quot;</span>
<a href="#l7.292"></a><span id="l7.292">   }, &quot;1&quot;);</span>
<a href="#l7.293"></a><span id="l7.293">   checkDraftHeaders(plainAttachmentHeaders, &quot;2&quot;);</span>
<a href="#l7.294"></a><span id="l7.294"> </span>
<a href="#l7.295"></a><span id="l7.295">   plainAttachment.name = &quot;ol.txt&quot;;</span>
<a href="#l7.296"></a><span id="l7.296">   plainAttachmentHeaders[&quot;Content-Disposition&quot;] =</span>
<a href="#l7.297"></a><span id="l7.297">     &quot;attachment; filename*=ISO-8859-1''%6F%EF%6C%2E%74%78%74&quot;;</span>
<a href="#l7.298"></a><span id="l7.298" class="difflineminus">-  yield richCreateMessage(fields, [plainAttachment], identity);</span>
<a href="#l7.299"></a><span id="l7.299" class="difflineplus">+  await richCreateMessage(fields, [plainAttachment], identity);</span>
<a href="#l7.300"></a><span id="l7.300">   checkDraftHeaders(plainAttachmentHeaders, &quot;2&quot;);</span>
<a href="#l7.301"></a><span id="l7.301"> </span>
<a href="#l7.302"></a><span id="l7.302">   plainAttachment.name = &quot;\ud83d\udca9.txt&quot;;</span>
<a href="#l7.303"></a><span id="l7.303">   plainAttachmentHeaders[&quot;Content-Disposition&quot;] =</span>
<a href="#l7.304"></a><span id="l7.304">     &quot;attachment; filename*=UTF-8''%F0%9F%92%A9%2E%74%78%74&quot;;</span>
<a href="#l7.305"></a><span id="l7.305" class="difflineminus">-  yield richCreateMessage(fields, [plainAttachment], identity);</span>
<a href="#l7.306"></a><span id="l7.306" class="difflineplus">+  await richCreateMessage(fields, [plainAttachment], identity);</span>
<a href="#l7.307"></a><span id="l7.307">   checkDraftHeaders(plainAttachmentHeaders, &quot;2&quot;);</span>
<a href="#l7.308"></a><span id="l7.308"> </span>
<a href="#l7.309"></a><span id="l7.309">   let httpAttachment = makeAttachment({</span>
<a href="#l7.310"></a><span id="l7.310">     url: &quot;data:text/html,&lt;html&gt;&lt;/html&gt;&quot;,</span>
<a href="#l7.311"></a><span id="l7.311">     name: &quot;attachment.html&quot;,</span>
<a href="#l7.312"></a><span id="l7.312">   });</span>
<a href="#l7.313"></a><span id="l7.313">   let httpAttachmentHeaders = {</span>
<a href="#l7.314"></a><span id="l7.314">     &quot;Content-Type&quot;: &quot;text/html&quot;,</span>
<a href="#l7.315"></a><span id="l7.315">     &quot;Content-Disposition&quot;: &quot;attachment; filename=\&quot;attachment.html\&quot;&quot;,</span>
<a href="#l7.316"></a><span id="l7.316">     &quot;Content-Base&quot;: '&quot;data:text/html,&lt;html&gt;&lt;/html&gt;&quot;',</span>
<a href="#l7.317"></a><span id="l7.317">     &quot;Content-Location&quot;: '&quot;data:text/html,&lt;html&gt;&lt;/html&gt;&quot;',</span>
<a href="#l7.318"></a><span id="l7.318">   };</span>
<a href="#l7.319"></a><span id="l7.319" class="difflineminus">-  yield richCreateMessage(fields, [httpAttachment], identity);</span>
<a href="#l7.320"></a><span id="l7.320" class="difflineplus">+  await richCreateMessage(fields, [httpAttachment], identity);</span>
<a href="#l7.321"></a><span id="l7.321">   checkDraftHeaders({</span>
<a href="#l7.322"></a><span id="l7.322">     &quot;Content-Base&quot;: undefined,</span>
<a href="#l7.323"></a><span id="l7.323">     &quot;Content-Location&quot;: undefined</span>
<a href="#l7.324"></a><span id="l7.324">   }, &quot;1&quot;);</span>
<a href="#l7.325"></a><span id="l7.325">   checkDraftHeaders(httpAttachmentHeaders, &quot;2&quot;);</span>
<a href="#l7.326"></a><span id="l7.326"> </span>
<a href="#l7.327"></a><span id="l7.327">   fields.characterSet = &quot;UTF-8&quot;;</span>
<a href="#l7.328"></a><span id="l7.328">   let cloudAttachment = makeAttachment({</span>
<a href="#l7.329"></a><span id="l7.329" class="difflineat">@@ -400,24 +400,24 @@ function* testContentHeaders() {</span>
<a href="#l7.330"></a><span id="l7.330">     contentLocation: &quot;http://localhost.invalid/&quot;,</span>
<a href="#l7.331"></a><span id="l7.331">   });</span>
<a href="#l7.332"></a><span id="l7.332">   let cloudAttachmentHeaders = {</span>
<a href="#l7.333"></a><span id="l7.333">     &quot;Content-Type&quot;: &quot;application/octet-stream&quot;,</span>
<a href="#l7.334"></a><span id="l7.334">     &quot;X-Mozilla-Cloud-Part&quot;: &quot;cloudFile; url=http://localhost.invalid/; &quot; +</span>
<a href="#l7.335"></a><span id="l7.335">       &quot;provider=akey; &quot; +</span>
<a href="#l7.336"></a><span id="l7.336">       &quot;file=&quot; + cloudAttachment.url + &quot;; name=attachment.html&quot;,</span>
<a href="#l7.337"></a><span id="l7.337">   };</span>
<a href="#l7.338"></a><span id="l7.338" class="difflineminus">-  yield richCreateMessage(fields, [cloudAttachment], identity);</span>
<a href="#l7.339"></a><span id="l7.339" class="difflineplus">+  await richCreateMessage(fields, [cloudAttachment], identity);</span>
<a href="#l7.340"></a><span id="l7.340">   checkDraftHeaders(cloudAttachmentHeaders, &quot;2&quot;);</span>
<a href="#l7.341"></a><span id="l7.341"> </span>
<a href="#l7.342"></a><span id="l7.342">   // Some multipart/alternative tests.</span>
<a href="#l7.343"></a><span id="l7.343">   fields.body = &quot;Some text&quot;;</span>
<a href="#l7.344"></a><span id="l7.344">   fields.forcePlainText = false;</span>
<a href="#l7.345"></a><span id="l7.345">   fields.useMultipartAlternative = true;</span>
<a href="#l7.346"></a><span id="l7.346" class="difflineminus">-  yield richCreateMessage(fields, [], identity);</span>
<a href="#l7.347"></a><span id="l7.347" class="difflineplus">+  await richCreateMessage(fields, [], identity);</span>
<a href="#l7.348"></a><span id="l7.348">   checkDraftHeaders({</span>
<a href="#l7.349"></a><span id="l7.349">     &quot;Content-Type&quot;: &quot;multipart/alternative; boundary=.&quot;</span>
<a href="#l7.350"></a><span id="l7.350">   });</span>
<a href="#l7.351"></a><span id="l7.351">   checkDraftHeaders({</span>
<a href="#l7.352"></a><span id="l7.352">     &quot;Content-Type&quot;: &quot;text/plain; charset=UTF-8; format=flowed&quot;,</span>
<a href="#l7.353"></a><span id="l7.353">     &quot;Content-Transfer-Encoding&quot;: &quot;7bit&quot;</span>
<a href="#l7.354"></a><span id="l7.354">   }, &quot;1&quot;);</span>
<a href="#l7.355"></a><span id="l7.355">   checkDraftHeaders({</span>
<a href="#l7.356"></a><span id="l7.356" class="difflineat">@@ -425,17 +425,17 @@ function* testContentHeaders() {</span>
<a href="#l7.357"></a><span id="l7.357">     &quot;Content-Transfer-Encoding&quot;: &quot;7bit&quot;</span>
<a href="#l7.358"></a><span id="l7.358">   }, &quot;2&quot;);</span>
<a href="#l7.359"></a><span id="l7.359"> </span>
<a href="#l7.360"></a><span id="l7.360">   // multipart/mixed</span>
<a href="#l7.361"></a><span id="l7.361">   // + multipart/alternative</span>
<a href="#l7.362"></a><span id="l7.362">   //   + text/plain</span>
<a href="#l7.363"></a><span id="l7.363">   //   + text/html</span>
<a href="#l7.364"></a><span id="l7.364">   // + text/plain attachment</span>
<a href="#l7.365"></a><span id="l7.365" class="difflineminus">-  yield richCreateMessage(fields, [plainAttachment], identity);</span>
<a href="#l7.366"></a><span id="l7.366" class="difflineplus">+  await richCreateMessage(fields, [plainAttachment], identity);</span>
<a href="#l7.367"></a><span id="l7.367">   checkDraftHeaders({</span>
<a href="#l7.368"></a><span id="l7.368">     &quot;Content-Type&quot;: &quot;multipart/mixed; boundary=.&quot;</span>
<a href="#l7.369"></a><span id="l7.369">   });</span>
<a href="#l7.370"></a><span id="l7.370">   checkDraftHeaders({</span>
<a href="#l7.371"></a><span id="l7.371">     &quot;Content-Type&quot;: &quot;multipart/alternative; boundary=.&quot;</span>
<a href="#l7.372"></a><span id="l7.372">   }, &quot;1&quot;);</span>
<a href="#l7.373"></a><span id="l7.373">   checkDraftHeaders({</span>
<a href="#l7.374"></a><span id="l7.374">     &quot;Content-Type&quot;: &quot;text/plain; charset=UTF-8; format=flowed&quot;,</span>
<a href="#l7.375"></a><span id="l7.375" class="difflineat">@@ -443,17 +443,17 @@ function* testContentHeaders() {</span>
<a href="#l7.376"></a><span id="l7.376">   }, &quot;1.1&quot;);</span>
<a href="#l7.377"></a><span id="l7.377">   checkDraftHeaders({</span>
<a href="#l7.378"></a><span id="l7.378">     &quot;Content-Type&quot;: &quot;text/html; charset=UTF-8&quot;,</span>
<a href="#l7.379"></a><span id="l7.379">     &quot;Content-Transfer-Encoding&quot;: &quot;7bit&quot;</span>
<a href="#l7.380"></a><span id="l7.380">   }, &quot;1.2&quot;);</span>
<a href="#l7.381"></a><span id="l7.381">   checkDraftHeaders(plainAttachmentHeaders, &quot;2&quot;);</span>
<a href="#l7.382"></a><span id="l7.382"> </span>
<a href="#l7.383"></a><span id="l7.383">   // Three attachments, and a multipart/alternative. Oh the humanity!</span>
<a href="#l7.384"></a><span id="l7.384" class="difflineminus">-  yield richCreateMessage(fields,</span>
<a href="#l7.385"></a><span id="l7.385" class="difflineplus">+  await richCreateMessage(fields,</span>
<a href="#l7.386"></a><span id="l7.386">     [plainAttachment, httpAttachment, cloudAttachment], identity);</span>
<a href="#l7.387"></a><span id="l7.387">   checkDraftHeaders({</span>
<a href="#l7.388"></a><span id="l7.388">     &quot;Content-Type&quot;: &quot;multipart/mixed; boundary=.&quot;</span>
<a href="#l7.389"></a><span id="l7.389">   });</span>
<a href="#l7.390"></a><span id="l7.390">   checkDraftHeaders({</span>
<a href="#l7.391"></a><span id="l7.391">     &quot;Content-Type&quot;: &quot;multipart/alternative; boundary=.&quot;</span>
<a href="#l7.392"></a><span id="l7.392">   }, &quot;1&quot;);</span>
<a href="#l7.393"></a><span id="l7.393">   checkDraftHeaders({</span>
<a href="#l7.394"></a><span id="l7.394" class="difflineat">@@ -466,68 +466,68 @@ function* testContentHeaders() {</span>
<a href="#l7.395"></a><span id="l7.395">   }, &quot;1.2&quot;);</span>
<a href="#l7.396"></a><span id="l7.396">   checkDraftHeaders(cloudAttachmentHeaders, &quot;2&quot;);</span>
<a href="#l7.397"></a><span id="l7.397">   checkDraftHeaders(plainAttachmentHeaders, &quot;3&quot;);</span>
<a href="#l7.398"></a><span id="l7.398">   checkDraftHeaders(httpAttachmentHeaders, &quot;4&quot;);</span>
<a href="#l7.399"></a><span id="l7.399"> </span>
<a href="#l7.400"></a><span id="l7.400">   // Test a request for plain text with text/html.</span>
<a href="#l7.401"></a><span id="l7.401">   fields.forcePlainText = true;</span>
<a href="#l7.402"></a><span id="l7.402">   fields.useMultipartAlternative = false;</span>
<a href="#l7.403"></a><span id="l7.403" class="difflineminus">-  yield richCreateMessage(fields, [], identity);</span>
<a href="#l7.404"></a><span id="l7.404" class="difflineplus">+  await richCreateMessage(fields, [], identity);</span>
<a href="#l7.405"></a><span id="l7.405">   checkDraftHeaders({</span>
<a href="#l7.406"></a><span id="l7.406">     &quot;Content-Type&quot;: &quot;text/plain; charset=UTF-8; format=flowed&quot;,</span>
<a href="#l7.407"></a><span id="l7.407">     &quot;Content-Transfer-Encoding&quot;: &quot;7bit&quot;</span>
<a href="#l7.408"></a><span id="l7.408">   });</span>
<a href="#l7.409"></a><span id="l7.409"> }</span>
<a href="#l7.410"></a><span id="l7.410"> </span>
<a href="#l7.411"></a><span id="l7.411" class="difflineminus">-function* testSentMessage() {</span>
<a href="#l7.412"></a><span id="l7.412" class="difflineplus">+async function testSentMessage() {</span>
<a href="#l7.413"></a><span id="l7.413">   let server = setupServerDaemon();</span>
<a href="#l7.414"></a><span id="l7.414">   let daemon = server._daemon;</span>
<a href="#l7.415"></a><span id="l7.415">   server.start();</span>
<a href="#l7.416"></a><span id="l7.416">   try {</span>
<a href="#l7.417"></a><span id="l7.417">     let localserver = getBasicSmtpServer(server.port);</span>
<a href="#l7.418"></a><span id="l7.418">     let identity = getSmtpIdentity(&quot;test@tinderbox.invalid&quot;, localserver);</span>
<a href="#l7.419"></a><span id="l7.419" class="difflineminus">-    yield sendMessage({</span>
<a href="#l7.420"></a><span id="l7.420" class="difflineplus">+    await sendMessage({</span>
<a href="#l7.421"></a><span id="l7.421">       &quot;to&quot;: &quot;Nobody &lt;nobody@tinderbox.invalid&gt;&quot;,</span>
<a href="#l7.422"></a><span id="l7.422">       &quot;cc&quot;: &quot;Alex &lt;alex@tinderbox.invalid&gt;&quot;,</span>
<a href="#l7.423"></a><span id="l7.423">       &quot;bcc&quot;: &quot;Boris &lt;boris@tinderbox.invalid&gt;&quot;,</span>
<a href="#l7.424"></a><span id="l7.424">       &quot;replyTo&quot;: &quot;Charles &lt;charles@tinderbox.invalid&gt;&quot;,</span>
<a href="#l7.425"></a><span id="l7.425">     }, identity, {}, []);</span>
<a href="#l7.426"></a><span id="l7.426">     checkMessageHeaders(daemon.post, {</span>
<a href="#l7.427"></a><span id="l7.427">       &quot;From&quot;: &quot;test@tinderbox.invalid&quot;,</span>
<a href="#l7.428"></a><span id="l7.428">       &quot;To&quot;: &quot;Nobody &lt;nobody@tinderbox.invalid&gt;&quot;,</span>
<a href="#l7.429"></a><span id="l7.429">       &quot;Cc&quot;: &quot;Alex &lt;alex@tinderbox.invalid&gt;&quot;,</span>
<a href="#l7.430"></a><span id="l7.430">       &quot;Bcc&quot;: undefined,</span>
<a href="#l7.431"></a><span id="l7.431">       &quot;Reply-To&quot;: &quot;Charles &lt;charles@tinderbox.invalid&gt;&quot;,</span>
<a href="#l7.432"></a><span id="l7.432">       &quot;X-Mozilla-Status&quot;: undefined,</span>
<a href="#l7.433"></a><span id="l7.433">       &quot;X-Mozilla-Keys&quot;: undefined,</span>
<a href="#l7.434"></a><span id="l7.434">       &quot;X-Mozilla-Draft-Info&quot;: undefined,</span>
<a href="#l7.435"></a><span id="l7.435">       &quot;Fcc&quot;: undefined</span>
<a href="#l7.436"></a><span id="l7.436">     });</span>
<a href="#l7.437"></a><span id="l7.437" class="difflineminus">-    yield sendMessage({&quot;bcc&quot;: &quot;Somebody &lt;test@tinderbox.invalid&quot;}, identity);</span>
<a href="#l7.438"></a><span id="l7.438" class="difflineplus">+    await sendMessage({&quot;bcc&quot;: &quot;Somebody &lt;test@tinderbox.invalid&quot;}, identity);</span>
<a href="#l7.439"></a><span id="l7.439">     checkMessageHeaders(daemon.post, {</span>
<a href="#l7.440"></a><span id="l7.440">       &quot;To&quot;: &quot;undisclosed-recipients: ;&quot;</span>
<a href="#l7.441"></a><span id="l7.441">     });</span>
<a href="#l7.442"></a><span id="l7.442" class="difflineminus">-    yield sendMessage({</span>
<a href="#l7.443"></a><span id="l7.443" class="difflineplus">+    await sendMessage({</span>
<a href="#l7.444"></a><span id="l7.444">       &quot;to&quot;: &quot;Somebody &lt;test@tinderbox.invalid&gt;&quot;,</span>
<a href="#l7.445"></a><span id="l7.445">       &quot;returnReceipt&quot;: true,</span>
<a href="#l7.446"></a><span id="l7.446">       &quot;receiptHeaderType&quot;: Ci.nsIMsgMdnGenerator.eDntRrtType,</span>
<a href="#l7.447"></a><span id="l7.447">     }, identity);</span>
<a href="#l7.448"></a><span id="l7.448">     checkMessageHeaders(daemon.post, {</span>
<a href="#l7.449"></a><span id="l7.449">       &quot;Disposition-Notification-To&quot;: &quot;test@tinderbox.invalid&quot;,</span>
<a href="#l7.450"></a><span id="l7.450">       &quot;Return-Receipt-To&quot;: &quot;test@tinderbox.invalid&quot;,</span>
<a href="#l7.451"></a><span id="l7.451">     });</span>
<a href="#l7.452"></a><span id="l7.452">     let cloudAttachment = makeAttachment({</span>
<a href="#l7.453"></a><span id="l7.453">       url: Services.io.newFileURI(do_get_file(&quot;data/test-UTF-8.txt&quot;)).spec,</span>
<a href="#l7.454"></a><span id="l7.454">       sendViaCloud: true,</span>
<a href="#l7.455"></a><span id="l7.455">       cloudProviderKey: &quot;akey&quot;,</span>
<a href="#l7.456"></a><span id="l7.456">       name: &quot;attachment.html&quot;,</span>
<a href="#l7.457"></a><span id="l7.457">       contentLocation: &quot;http://localhost.invalid/&quot;,</span>
<a href="#l7.458"></a><span id="l7.458">     });</span>
<a href="#l7.459"></a><span id="l7.459" class="difflineminus">-    yield sendMessage({to: &quot;test@tinderbox.invalid&quot;}, identity, {},</span>
<a href="#l7.460"></a><span id="l7.460" class="difflineplus">+    await sendMessage({to: &quot;test@tinderbox.invalid&quot;}, identity, {},</span>
<a href="#l7.461"></a><span id="l7.461">       [cloudAttachment]);</span>
<a href="#l7.462"></a><span id="l7.462">     checkMessageHeaders(daemon.post, {</span>
<a href="#l7.463"></a><span id="l7.463">       &quot;Content-Type&quot;: &quot;application/octet-stream&quot;,</span>
<a href="#l7.464"></a><span id="l7.464">       &quot;X-Mozilla-Cloud-Part&quot;: &quot;cloudFile; url=http://localhost.invalid/; &quot; +</span>
<a href="#l7.465"></a><span id="l7.465">         &quot;name=attachment.html&quot;,</span>
<a href="#l7.466"></a><span id="l7.466">     }, &quot;2&quot;);</span>
<a href="#l7.467"></a><span id="l7.467">   } finally {</span>
<a href="#l7.468"></a><span id="l7.468">     server.stop();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_saveDraft.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_saveDraft.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1,15 +1,15 @@</span>
<a href="#l8.4"></a><span id="l8.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l8.5"></a><span id="l8.5"> /*</span>
<a href="#l8.6"></a><span id="l8.6">  * Test suite for checking correctly saved as draft with unread.</span>
<a href="#l8.7"></a><span id="l8.7">  */</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9" class="difflineminus">-add_task(function* checkDraft() {</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineminus">-  yield createMessage();</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+add_task(async function checkDraft() {</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+  await createMessage();</span>
<a href="#l8.13"></a><span id="l8.13">   Assert.equal(gDraftFolder.getTotalMessages(false), 1);</span>
<a href="#l8.14"></a><span id="l8.14">   Assert.equal(gDraftFolder.getNumUnread(false), 1);</span>
<a href="#l8.15"></a><span id="l8.15"> });</span>
<a href="#l8.16"></a><span id="l8.16"> </span>
<a href="#l8.17"></a><span id="l8.17"> function run_test() {</span>
<a href="#l8.18"></a><span id="l8.18">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l8.19"></a><span id="l8.19">   run_next_test();</span>
<a href="#l8.20"></a><span id="l8.20"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_sendObserver.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_sendObserver.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -18,32 +18,32 @@ var observer = {</span>
<a href="#l9.4"></a><span id="l9.4">   observe: function (aSubject, aTopic, aData) {</span>
<a href="#l9.5"></a><span id="l9.5">     if (aTopic == &quot;mail-set-sender&quot;) {</span>
<a href="#l9.6"></a><span id="l9.6">       Assert.ok(aSubject instanceof Ci.nsIMsgCompose);</span>
<a href="#l9.7"></a><span id="l9.7">       gData = aData;</span>
<a href="#l9.8"></a><span id="l9.8">     }</span>
<a href="#l9.9"></a><span id="l9.9">   }</span>
<a href="#l9.10"></a><span id="l9.10"> }</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-add_task(function* testObserver() {</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+add_task(async function testObserver() {</span>
<a href="#l9.14"></a><span id="l9.14">   let fields = new CompFields();</span>
<a href="#l9.15"></a><span id="l9.15">   let identity = getSmtpIdentity(&quot;from@tinderbox.invalid&quot;,</span>
<a href="#l9.16"></a><span id="l9.16">     getBasicSmtpServer());</span>
<a href="#l9.17"></a><span id="l9.17">   identity.fullName = &quot;Observer Tester&quot;;</span>
<a href="#l9.18"></a><span id="l9.18">   fields.to = &quot;Emile &lt;nobody@tinderbox.invalid&gt;&quot;;</span>
<a href="#l9.19"></a><span id="l9.19">   fields.cc = &quot;Alex &lt;alex@tinderbox.invalid&gt;&quot;;</span>
<a href="#l9.20"></a><span id="l9.20">   fields.subject = &quot;Let's test the observer&quot;;</span>
<a href="#l9.21"></a><span id="l9.21"> </span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-  yield richCreateMessage(fields, [], identity);</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+  await richCreateMessage(fields, [], identity);</span>
<a href="#l9.24"></a><span id="l9.24">   // observer data should have:</span>
<a href="#l9.25"></a><span id="l9.25">   // (no account), Ci.nsIMsgSend.nsMsgSaveAsDraft, identity.key</span>
<a href="#l9.26"></a><span id="l9.26">   Assert.equal(gData, &quot;,4,id1&quot;);</span>
<a href="#l9.27"></a><span id="l9.27"> </span>
<a href="#l9.28"></a><span id="l9.28">   // Now try with an account</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-  yield richCreateMessage(fields, [], identity, localAccountUtils.msgAccount);</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+  await richCreateMessage(fields, [], identity, localAccountUtils.msgAccount);</span>
<a href="#l9.31"></a><span id="l9.31">   // observer data should have:</span>
<a href="#l9.32"></a><span id="l9.32">   // (local account key), Ci.nsIMsgSend.nsMsgSaveAsDraft, identity.key</span>
<a href="#l9.33"></a><span id="l9.33">   Assert.equal(gData, &quot;account1,4,id1&quot;);</span>
<a href="#l9.34"></a><span id="l9.34"> });</span>
<a href="#l9.35"></a><span id="l9.35"> </span>
<a href="#l9.36"></a><span id="l9.36"> function run_test() {</span>
<a href="#l9.37"></a><span id="l9.37">   // Ensure we have at least one mail account</span>
<a href="#l9.38"></a><span id="l9.38">   localAccountUtils.loadLocalMailAccount();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_smtpPassword.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtpPassword.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -12,30 +12,30 @@ var server;</span>
<a href="#l10.4"></a><span id="l10.4"> var kIdentityMail = &quot;identity@foo.invalid&quot;;</span>
<a href="#l10.5"></a><span id="l10.5"> var kSender = &quot;from@foo.invalid&quot;;</span>
<a href="#l10.6"></a><span id="l10.6"> var kTo = &quot;to@foo.invalid&quot;;</span>
<a href="#l10.7"></a><span id="l10.7"> var kUsername = &quot;testsmtp&quot;;</span>
<a href="#l10.8"></a><span id="l10.8"> // Password needs to match the login information stored in the signons json</span>
<a href="#l10.9"></a><span id="l10.9"> // file.</span>
<a href="#l10.10"></a><span id="l10.10"> var kPassword = &quot;smtptest&quot;;</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-add_task(function *() {</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+add_task(async function () {</span>
<a href="#l10.14"></a><span id="l10.14">   function createHandler(d) {</span>
<a href="#l10.15"></a><span id="l10.15">     var handler = new SMTP_RFC2821_handler(d);</span>
<a href="#l10.16"></a><span id="l10.16">     // Username needs to match the login information stored in the signons json</span>
<a href="#l10.17"></a><span id="l10.17">     // file.</span>
<a href="#l10.18"></a><span id="l10.18">     handler.kUsername = kUsername;</span>
<a href="#l10.19"></a><span id="l10.19">     handler.kPassword = kPassword;</span>
<a href="#l10.20"></a><span id="l10.20">     handler.kAuthRequired = true;</span>
<a href="#l10.21"></a><span id="l10.21">     return handler;</span>
<a href="#l10.22"></a><span id="l10.22">   }</span>
<a href="#l10.23"></a><span id="l10.23">   server = setupServerDaemon(createHandler);</span>
<a href="#l10.24"></a><span id="l10.24"> </span>
<a href="#l10.25"></a><span id="l10.25">   // Prepare files for passwords (generated by a script in bug 1018624).</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-  yield setupForPassword(&quot;signons-mailnews1.8.json&quot;)</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+  await setupForPassword(&quot;signons-mailnews1.8.json&quot;)</span>
<a href="#l10.28"></a><span id="l10.28"> </span>
<a href="#l10.29"></a><span id="l10.29">   // Test file</span>
<a href="#l10.30"></a><span id="l10.30">   var testFile = do_get_file(&quot;data/message1.eml&quot;);</span>
<a href="#l10.31"></a><span id="l10.31"> </span>
<a href="#l10.32"></a><span id="l10.32">   // Ensure we have at least one mail account</span>
<a href="#l10.33"></a><span id="l10.33">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l10.34"></a><span id="l10.34"> </span>
<a href="#l10.35"></a><span id="l10.35">   // Handle the server in a try/catch/finally loop so that we always will stop</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_smtpPassword2.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtpPassword2.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -8,19 +8,19 @@ ChromeUtils.import(&quot;resource://gre/modul</span>
<a href="#l11.4"></a><span id="l11.4"> load(&quot;../../../resources/passwordStorage.js&quot;);</span>
<a href="#l11.5"></a><span id="l11.5"> </span>
<a href="#l11.6"></a><span id="l11.6"> var kUser1 = &quot;testsmtp&quot;;</span>
<a href="#l11.7"></a><span id="l11.7"> var kUser2 = &quot;testsmtpa&quot;;</span>
<a href="#l11.8"></a><span id="l11.8"> var kProtocol = &quot;smtp&quot;;</span>
<a href="#l11.9"></a><span id="l11.9"> var kHostname = &quot;localhost&quot;;</span>
<a href="#l11.10"></a><span id="l11.10"> var kServerUrl = kProtocol + &quot;://&quot; + kHostname;</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-add_task(function *() {</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+add_task(async function () {</span>
<a href="#l11.14"></a><span id="l11.14">   // Prepare files for passwords (generated by a script in bug 1018624).</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-  yield setupForPassword(&quot;signons-mailnews1.8-multiple.json&quot;)</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+  await setupForPassword(&quot;signons-mailnews1.8-multiple.json&quot;)</span>
<a href="#l11.17"></a><span id="l11.17"> </span>
<a href="#l11.18"></a><span id="l11.18">   // Set up the basic accounts and folders.</span>
<a href="#l11.19"></a><span id="l11.19">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l11.20"></a><span id="l11.20"> </span>
<a href="#l11.21"></a><span id="l11.21">   var smtpServer1 = getBasicSmtpServer();</span>
<a href="#l11.22"></a><span id="l11.22">   var smtpServer2 = getBasicSmtpServer();</span>
<a href="#l11.23"></a><span id="l11.23"> </span>
<a href="#l11.24"></a><span id="l11.24">   smtpServer1.authMethod = 3;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_smtpPasswordFailure1.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtpPasswordFailure1.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -51,30 +51,30 @@ function confirmEx(aDialogTitle, aText, </span>
<a href="#l12.4"></a><span id="l12.4">       dump(&quot;\nCancelling login attempt\n&quot;);</span>
<a href="#l12.5"></a><span id="l12.5">       return 1;</span>
<a href="#l12.6"></a><span id="l12.6">     default:</span>
<a href="#l12.7"></a><span id="l12.7">       do_throw(&quot;unexpected attempt number &quot; + attempt);</span>
<a href="#l12.8"></a><span id="l12.8">       return 1;</span>
<a href="#l12.9"></a><span id="l12.9">   }</span>
<a href="#l12.10"></a><span id="l12.10"> }</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-add_task(function *() {</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+add_task(async function () {</span>
<a href="#l12.14"></a><span id="l12.14">   function createHandler(d) {</span>
<a href="#l12.15"></a><span id="l12.15">     var handler = new SMTP_RFC2821_handler(d);</span>
<a href="#l12.16"></a><span id="l12.16">     // Username needs to match the login information stored in the signons json</span>
<a href="#l12.17"></a><span id="l12.17">     // file.</span>
<a href="#l12.18"></a><span id="l12.18">     handler.kUsername = kUsername;</span>
<a href="#l12.19"></a><span id="l12.19">     handler.kPassword = kValidPassword;</span>
<a href="#l12.20"></a><span id="l12.20">     handler.kAuthRequired = true;</span>
<a href="#l12.21"></a><span id="l12.21">     return handler;</span>
<a href="#l12.22"></a><span id="l12.22">   }</span>
<a href="#l12.23"></a><span id="l12.23">   server = setupServerDaemon(createHandler);</span>
<a href="#l12.24"></a><span id="l12.24"> </span>
<a href="#l12.25"></a><span id="l12.25">   // Prepare files for passwords (generated by a script in bug 1018624).</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineminus">-  yield setupForPassword(&quot;signons-mailnews1.8.json&quot;)</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+  await setupForPassword(&quot;signons-mailnews1.8.json&quot;)</span>
<a href="#l12.28"></a><span id="l12.28"> </span>
<a href="#l12.29"></a><span id="l12.29">   registerAlertTestUtils();</span>
<a href="#l12.30"></a><span id="l12.30"> </span>
<a href="#l12.31"></a><span id="l12.31">   // Test file</span>
<a href="#l12.32"></a><span id="l12.32">   var testFile = do_get_file(&quot;data/message1.eml&quot;);</span>
<a href="#l12.33"></a><span id="l12.33"> </span>
<a href="#l12.34"></a><span id="l12.34">   // Ensure we have at least one mail account</span>
<a href="#l12.35"></a><span id="l12.35">   localAccountUtils.loadLocalMailAccount();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_smtpPasswordFailure2.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtpPasswordFailure2.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -61,31 +61,31 @@ function promptPasswordPS(aParent, aDial</span>
<a href="#l13.4"></a><span id="l13.4">   if (attempt == 2) {</span>
<a href="#l13.5"></a><span id="l13.5">     aPassword.value = kValidPassword;</span>
<a href="#l13.6"></a><span id="l13.6">     aCheckState.value = true;</span>
<a href="#l13.7"></a><span id="l13.7">     return true;</span>
<a href="#l13.8"></a><span id="l13.8">   }</span>
<a href="#l13.9"></a><span id="l13.9">   return false;</span>
<a href="#l13.10"></a><span id="l13.10"> }</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-add_task(function *() {</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+add_task(async function () {</span>
<a href="#l13.14"></a><span id="l13.14">   function createHandler(d) {</span>
<a href="#l13.15"></a><span id="l13.15">     var handler = new SMTP_RFC2821_handler(d);</span>
<a href="#l13.16"></a><span id="l13.16">     // Username needs to match the login information stored in the signons json</span>
<a href="#l13.17"></a><span id="l13.17">     // file.</span>
<a href="#l13.18"></a><span id="l13.18">     handler.kUsername = kUsername;</span>
<a href="#l13.19"></a><span id="l13.19">     handler.kPassword = kValidPassword;</span>
<a href="#l13.20"></a><span id="l13.20">     handler.kAuthRequired = true;</span>
<a href="#l13.21"></a><span id="l13.21">     handler.kAuthSchemes = [ &quot;PLAIN&quot;, &quot;LOGIN&quot; ]; // make match expected transaction below</span>
<a href="#l13.22"></a><span id="l13.22">     return handler;</span>
<a href="#l13.23"></a><span id="l13.23">   }</span>
<a href="#l13.24"></a><span id="l13.24">   server = setupServerDaemon(createHandler);</span>
<a href="#l13.25"></a><span id="l13.25"> </span>
<a href="#l13.26"></a><span id="l13.26">   // Prepare files for passwords (generated by a script in bug 1018624).</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineminus">-  yield setupForPassword(&quot;signons-mailnews1.8.json&quot;)</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+  await setupForPassword(&quot;signons-mailnews1.8.json&quot;)</span>
<a href="#l13.29"></a><span id="l13.29"> </span>
<a href="#l13.30"></a><span id="l13.30">   registerAlertTestUtils();</span>
<a href="#l13.31"></a><span id="l13.31"> </span>
<a href="#l13.32"></a><span id="l13.32">   // Test file</span>
<a href="#l13.33"></a><span id="l13.33">   var testFile = do_get_file(&quot;data/message1.eml&quot;);</span>
<a href="#l13.34"></a><span id="l13.34"> </span>
<a href="#l13.35"></a><span id="l13.35">   // Ensure we have at least one mail account</span>
<a href="#l13.36"></a><span id="l13.36">   localAccountUtils.loadLocalMailAccount();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_smtpPasswordFailure3.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtpPasswordFailure3.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -59,32 +59,32 @@ function promptPasswordPS(aParent, aDial</span>
<a href="#l14.4"></a><span id="l14.4">   if (attempt == 2) {</span>
<a href="#l14.5"></a><span id="l14.5">     aPassword.value = kValidPassword;</span>
<a href="#l14.6"></a><span id="l14.6">     aCheckState.value = true;</span>
<a href="#l14.7"></a><span id="l14.7">     return true;</span>
<a href="#l14.8"></a><span id="l14.8">   }</span>
<a href="#l14.9"></a><span id="l14.9">   return false;</span>
<a href="#l14.10"></a><span id="l14.10"> }</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-add_task(function *() {</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+add_task(async function () {</span>
<a href="#l14.14"></a><span id="l14.14">   function createHandler(d) {</span>
<a href="#l14.15"></a><span id="l14.15">     var handler = new SMTP_RFC2821_handler(d);</span>
<a href="#l14.16"></a><span id="l14.16">     handler.dropOnAuthFailure = true;</span>
<a href="#l14.17"></a><span id="l14.17">     // Username needs to match the login information stored in the signons json</span>
<a href="#l14.18"></a><span id="l14.18">     // file.</span>
<a href="#l14.19"></a><span id="l14.19">     handler.kUsername = kUsername;</span>
<a href="#l14.20"></a><span id="l14.20">     handler.kPassword = kValidPassword;</span>
<a href="#l14.21"></a><span id="l14.21">     handler.kAuthRequired = true;</span>
<a href="#l14.22"></a><span id="l14.22">     handler.kAuthSchemes = [ &quot;PLAIN&quot;, &quot;LOGIN&quot; ]; // make match expected transaction below</span>
<a href="#l14.23"></a><span id="l14.23">     return handler;</span>
<a href="#l14.24"></a><span id="l14.24">   }</span>
<a href="#l14.25"></a><span id="l14.25">   server = setupServerDaemon(createHandler);</span>
<a href="#l14.26"></a><span id="l14.26"> </span>
<a href="#l14.27"></a><span id="l14.27">   // Prepare files for passwords (generated by a script in bug 1018624).</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">-  yield setupForPassword(&quot;signons-mailnews1.8.json&quot;)</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+  await setupForPassword(&quot;signons-mailnews1.8.json&quot;)</span>
<a href="#l14.30"></a><span id="l14.30"> </span>
<a href="#l14.31"></a><span id="l14.31">   registerAlertTestUtils();</span>
<a href="#l14.32"></a><span id="l14.32"> </span>
<a href="#l14.33"></a><span id="l14.33">   // Test file</span>
<a href="#l14.34"></a><span id="l14.34">   var testFile = do_get_file(&quot;data/message1.eml&quot;);</span>
<a href="#l14.35"></a><span id="l14.35"> </span>
<a href="#l14.36"></a><span id="l14.36">   // Ensure we have at least one mail account</span>
<a href="#l14.37"></a><span id="l14.37">   localAccountUtils.loadLocalMailAccount();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_smtpProxy.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtpProxy.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -3,41 +3,41 @@</span>
<a href="#l15.4"></a><span id="l15.4"> // Tests that SMTP over a SOCKS proxy works.</span>
<a href="#l15.5"></a><span id="l15.5"> </span>
<a href="#l15.6"></a><span id="l15.6"> ChromeUtils.import(&quot;resource://testing-common/mailnews/NetworkTestUtils.jsm&quot;);</span>
<a href="#l15.7"></a><span id="l15.7"> ChromeUtils.import(&quot;resource://testing-common/mailnews/PromiseTestUtils.jsm&quot;);</span>
<a href="#l15.8"></a><span id="l15.8"> </span>
<a href="#l15.9"></a><span id="l15.9"> const PORT = 25;</span>
<a href="#l15.10"></a><span id="l15.10"> var daemon, localserver, server;</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-add_task(function* setup() {</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+add_task(async function setup() {</span>
<a href="#l15.14"></a><span id="l15.14">   server = setupServerDaemon();</span>
<a href="#l15.15"></a><span id="l15.15">   daemon = server._daemon;</span>
<a href="#l15.16"></a><span id="l15.16">   server.start();</span>
<a href="#l15.17"></a><span id="l15.17">   NetworkTestUtils.configureProxy(&quot;smtp.tinderbox.invalid&quot;, PORT, server.port);</span>
<a href="#l15.18"></a><span id="l15.18">   localserver = getBasicSmtpServer(PORT, &quot;smtp.tinderbox.invalid&quot;);</span>
<a href="#l15.19"></a><span id="l15.19"> });</span>
<a href="#l15.20"></a><span id="l15.20"> </span>
<a href="#l15.21"></a><span id="l15.21"> let CompFields = CC(&quot;@mozilla.org/messengercompose/composefields;1&quot;,</span>
<a href="#l15.22"></a><span id="l15.22">                     Ci.nsIMsgCompFields);</span>
<a href="#l15.23"></a><span id="l15.23"> </span>
<a href="#l15.24"></a><span id="l15.24" class="difflineminus">-add_task(function* sendMessage() {</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineplus">+add_task(async function sendMessage() {</span>
<a href="#l15.26"></a><span id="l15.26">   equal(daemon.post, undefined);</span>
<a href="#l15.27"></a><span id="l15.27">   let identity = getSmtpIdentity(&quot;test@tinderbox.invalid&quot;, localserver);</span>
<a href="#l15.28"></a><span id="l15.28">   var testFile = do_get_file(&quot;data/message1.eml&quot;);</span>
<a href="#l15.29"></a><span id="l15.29">   var urlListener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l15.30"></a><span id="l15.30">   MailServices.smtp.sendMailMessage(testFile, &quot;somebody@example.org&quot;, identity,</span>
<a href="#l15.31"></a><span id="l15.31">                                     &quot;me@example.org&quot;,</span>
<a href="#l15.32"></a><span id="l15.32">                                     null, urlListener, null, null,</span>
<a href="#l15.33"></a><span id="l15.33">                                     false, {}, {});</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineminus">-  yield urlListener.promise;</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+  await urlListener.promise;</span>
<a href="#l15.36"></a><span id="l15.36">   notEqual(daemon.post, &quot;&quot;);</span>
<a href="#l15.37"></a><span id="l15.37"> });</span>
<a href="#l15.38"></a><span id="l15.38"> </span>
<a href="#l15.39"></a><span id="l15.39" class="difflineminus">-add_task(function* cleanUp() {</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineplus">+add_task(async function cleanUp() {</span>
<a href="#l15.41"></a><span id="l15.41">   NetworkTestUtils.shutdownServers();</span>
<a href="#l15.42"></a><span id="l15.42"> });</span>
<a href="#l15.43"></a><span id="l15.43"> </span>
<a href="#l15.44"></a><span id="l15.44"> function run_test() {</span>
<a href="#l15.45"></a><span id="l15.45">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l15.46"></a><span id="l15.46">   run_next_test();</span>
<a href="#l15.47"></a><span id="l15.47"> }</span>
<a href="#l15.48"></a><span id="l15.48"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_filterNeedsBody.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_filterNeedsBody.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -48,32 +48,32 @@ function setup() {</span>
<a href="#l16.4"></a><span id="l16.4">   // an action that can be modified by tests</span>
<a href="#l16.5"></a><span id="l16.5">   gAction = gFilter.createAction();</span>
<a href="#l16.6"></a><span id="l16.6"> </span>
<a href="#l16.7"></a><span id="l16.7">   // add the custom actions</span>
<a href="#l16.8"></a><span id="l16.8">   MailServices.filters.addCustomAction(actionTestOffline);</span>
<a href="#l16.9"></a><span id="l16.9"> }</span>
<a href="#l16.10"></a><span id="l16.10"> </span>
<a href="#l16.11"></a><span id="l16.11"> // basic preparation done for each test</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-function *runFilterAction() {</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+async function runFilterAction() {</span>
<a href="#l16.14"></a><span id="l16.14">   let filterList = IMAPPump.incomingServer.getFilterList(null);</span>
<a href="#l16.15"></a><span id="l16.15">   while (filterList.filterCount)</span>
<a href="#l16.16"></a><span id="l16.16">     filterList.removeFilterAt(0);</span>
<a href="#l16.17"></a><span id="l16.17">   if (gFilter) {</span>
<a href="#l16.18"></a><span id="l16.18">     gFilter.clearActionList();</span>
<a href="#l16.19"></a><span id="l16.19">     if (gAction) {</span>
<a href="#l16.20"></a><span id="l16.20">       gFilter.appendAction(gAction);</span>
<a href="#l16.21"></a><span id="l16.21">       filterList.insertFilterAt(0, gFilter);</span>
<a href="#l16.22"></a><span id="l16.22">     }</span>
<a href="#l16.23"></a><span id="l16.23">   }</span>
<a href="#l16.24"></a><span id="l16.24">   IMAPPump.mailbox.addMessage(new imapMessage(specForFileName(gMessage),</span>
<a href="#l16.25"></a><span id="l16.25">                               IMAPPump.mailbox.uidnext++, []));</span>
<a href="#l16.26"></a><span id="l16.26">   let listener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l16.27"></a><span id="l16.27">   IMAPPump.inbox.updateFolderWithListener(null, listener);</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineminus">-  yield listener.promise;</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineplus">+  await listener.promise;</span>
<a href="#l16.30"></a><span id="l16.30"> }</span>
<a href="#l16.31"></a><span id="l16.31"> </span>
<a href="#l16.32"></a><span id="l16.32"> function run_test() {</span>
<a href="#l16.33"></a><span id="l16.33">   tests.forEach(x =&gt; add_task(x));</span>
<a href="#l16.34"></a><span id="l16.34">   run_next_test();</span>
<a href="#l16.35"></a><span id="l16.35"> }</span>
<a href="#l16.36"></a><span id="l16.36"> </span>
<a href="#l16.37"></a><span id="l16.37"> // custom action to test offline status</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapFilterActions.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapFilterActions.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -54,275 +54,275 @@ var gTestArray =</span>
<a href="#l17.4"></a><span id="l17.4"> [</span>
<a href="#l17.5"></a><span id="l17.5">   setupIMAPPump,</span>
<a href="#l17.6"></a><span id="l17.6">     // optionally set server parameters, here enabling debug messages</span>
<a href="#l17.7"></a><span id="l17.7">   //function serverParms() {</span>
<a href="#l17.8"></a><span id="l17.8">   //  IMAPPump.server.setDebugLevel(fsDebugAll);</span>
<a href="#l17.9"></a><span id="l17.9">   //},</span>
<a href="#l17.10"></a><span id="l17.10">   setupFilters,</span>
<a href="#l17.11"></a><span id="l17.11">   // The initial tests do not result in new messages added.</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-  function *MoveToFolder() {</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+  async function MoveToFolder() {</span>
<a href="#l17.14"></a><span id="l17.14">     gAction.type = Ci.nsMsgFilterAction.MoveToFolder;</span>
<a href="#l17.15"></a><span id="l17.15">     gAction.targetFolderUri = gSubfolder.URI;</span>
<a href="#l17.16"></a><span id="l17.16">     gInboxCount = folderCount(IMAPPump.inbox);</span>
<a href="#l17.17"></a><span id="l17.17">     gSubfolderCount = folderCount(gSubfolder);</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineminus">-    yield setupTest(gFilter, gAction);</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineplus">+    await setupTest(gFilter, gAction);</span>
<a href="#l17.20"></a><span id="l17.20"> </span>
<a href="#l17.21"></a><span id="l17.21">     testCounts(false, 0, 0, 0);</span>
<a href="#l17.22"></a><span id="l17.22">     Assert.equal(gInboxCount, folderCount(IMAPPump.inbox));</span>
<a href="#l17.23"></a><span id="l17.23">     Assert.equal(gSubfolderCount + 1, folderCount(gSubfolder));</span>
<a href="#l17.24"></a><span id="l17.24">   },</span>
<a href="#l17.25"></a><span id="l17.25">   // do it again, sometimes that causes multiple downloads</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineminus">-  function *MoveToFolder2() {</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineplus">+  async function MoveToFolder2() {</span>
<a href="#l17.28"></a><span id="l17.28">     gAction.type = Ci.nsMsgFilterAction.MoveToFolder;</span>
<a href="#l17.29"></a><span id="l17.29">     gAction.targetFolderUri = gSubfolder.URI;</span>
<a href="#l17.30"></a><span id="l17.30">     gInboxCount = folderCount(IMAPPump.inbox);</span>
<a href="#l17.31"></a><span id="l17.31">     gSubfolderCount = folderCount(gSubfolder);</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineminus">-    yield setupTest(gFilter, gAction);</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+    await setupTest(gFilter, gAction);</span>
<a href="#l17.34"></a><span id="l17.34"> </span>
<a href="#l17.35"></a><span id="l17.35">     testCounts(false, 0, 0, 0);</span>
<a href="#l17.36"></a><span id="l17.36">     Assert.equal(gInboxCount, folderCount(IMAPPump.inbox));</span>
<a href="#l17.37"></a><span id="l17.37">     Assert.equal(gSubfolderCount + 1, folderCount(gSubfolder));</span>
<a href="#l17.38"></a><span id="l17.38">   },</span>
<a href="#l17.39"></a><span id="l17.39">   /**/</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineminus">-  function *MoveToFolderBody() {</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineplus">+  async function MoveToFolderBody() {</span>
<a href="#l17.42"></a><span id="l17.42">     gAction.type = Ci.nsMsgFilterAction.MoveToFolder;</span>
<a href="#l17.43"></a><span id="l17.43">     gAction.targetFolderUri = gSubfolder.URI;</span>
<a href="#l17.44"></a><span id="l17.44">     gInboxCount = folderCount(IMAPPump.inbox);</span>
<a href="#l17.45"></a><span id="l17.45">     gSubfolderCount = folderCount(gSubfolder);</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineminus">-    yield setupTest(gBodyFilter, gAction);</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineplus">+    await setupTest(gBodyFilter, gAction);</span>
<a href="#l17.48"></a><span id="l17.48"> </span>
<a href="#l17.49"></a><span id="l17.49">     testCounts(false, 0, 0, 0);</span>
<a href="#l17.50"></a><span id="l17.50">     Assert.equal(gSubfolderCount + 1, folderCount(gSubfolder));</span>
<a href="#l17.51"></a><span id="l17.51">     // no net messages were added to the inbox</span>
<a href="#l17.52"></a><span id="l17.52">     Assert.equal(gInboxCount, folderCount(IMAPPump.inbox));</span>
<a href="#l17.53"></a><span id="l17.53">   },</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineminus">-  function *MoveToFolderBody2() {</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineplus">+  async function MoveToFolderBody2() {</span>
<a href="#l17.56"></a><span id="l17.56">     gAction.type = Ci.nsMsgFilterAction.MoveToFolder;</span>
<a href="#l17.57"></a><span id="l17.57">     gAction.targetFolderUri = gSubfolder.URI;</span>
<a href="#l17.58"></a><span id="l17.58">     gInboxCount = folderCount(IMAPPump.inbox);</span>
<a href="#l17.59"></a><span id="l17.59">     gSubfolderCount = folderCount(gSubfolder);</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineminus">-    yield setupTest(gBodyFilter, gAction);</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineplus">+    await setupTest(gBodyFilter, gAction);</span>
<a href="#l17.62"></a><span id="l17.62"> </span>
<a href="#l17.63"></a><span id="l17.63">     testCounts(false, 0, 0, 0);</span>
<a href="#l17.64"></a><span id="l17.64">     Assert.equal(gSubfolderCount + 1, folderCount(gSubfolder));</span>
<a href="#l17.65"></a><span id="l17.65">     // no net messages were added to the inbox</span>
<a href="#l17.66"></a><span id="l17.66">     Assert.equal(gInboxCount, folderCount(IMAPPump.inbox));</span>
<a href="#l17.67"></a><span id="l17.67">   },</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineminus">-  function *MarkRead() {</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineplus">+  async function MarkRead() {</span>
<a href="#l17.70"></a><span id="l17.70">     gAction.type = Ci.nsMsgFilterAction.MarkRead;</span>
<a href="#l17.71"></a><span id="l17.71">     gInboxCount = folderCount(IMAPPump.inbox);</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineminus">-    yield setupTest(gFilter, gAction);</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineplus">+    await setupTest(gFilter, gAction);</span>
<a href="#l17.74"></a><span id="l17.74">     testCounts(false, 0, 0, 0);</span>
<a href="#l17.75"></a><span id="l17.75">     Assert.ok(gHeader.isRead);</span>
<a href="#l17.76"></a><span id="l17.76">     Assert.equal(gInboxCount + 1, folderCount(IMAPPump.inbox));</span>
<a href="#l17.77"></a><span id="l17.77">   },</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineminus">-  function *MarkReadBody() {</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineplus">+  async function MarkReadBody() {</span>
<a href="#l17.80"></a><span id="l17.80">     gAction.type = Ci.nsMsgFilterAction.MarkRead;</span>
<a href="#l17.81"></a><span id="l17.81">     gInboxCount = folderCount(IMAPPump.inbox);</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineminus">-    yield setupTest(gBodyFilter, gAction);</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineplus">+    await setupTest(gBodyFilter, gAction);</span>
<a href="#l17.84"></a><span id="l17.84"> </span>
<a href="#l17.85"></a><span id="l17.85">     testCounts(false, 0, 0, 0);</span>
<a href="#l17.86"></a><span id="l17.86">     Assert.ok(gHeader.isRead);</span>
<a href="#l17.87"></a><span id="l17.87">     Assert.equal(gInboxCount + 1, folderCount(IMAPPump.inbox));</span>
<a href="#l17.88"></a><span id="l17.88">   },</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineminus">-  function *KillThread() {</span>
<a href="#l17.90"></a><span id="l17.90" class="difflineplus">+  async function KillThread() {</span>
<a href="#l17.91"></a><span id="l17.91">     gAction.type = Ci.nsMsgFilterAction.KillThread;</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineminus">-    yield setupTest(gFilter, gAction);</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineplus">+    await setupTest(gFilter, gAction);</span>
<a href="#l17.94"></a><span id="l17.94"> </span>
<a href="#l17.95"></a><span id="l17.95">     testCounts(false, 0, 0, 0);</span>
<a href="#l17.96"></a><span id="l17.96">     let thread = db().GetThreadContainingMsgHdr(gHeader);</span>
<a href="#l17.97"></a><span id="l17.97">     Assert.notEqual(0, thread.flags &amp; Ci.nsMsgMessageFlags.Ignored);</span>
<a href="#l17.98"></a><span id="l17.98">   },</span>
<a href="#l17.99"></a><span id="l17.99" class="difflineminus">-  function *KillThreadBody() {</span>
<a href="#l17.100"></a><span id="l17.100" class="difflineplus">+  async function KillThreadBody() {</span>
<a href="#l17.101"></a><span id="l17.101">     gAction.type = Ci.nsMsgFilterAction.KillThread;</span>
<a href="#l17.102"></a><span id="l17.102" class="difflineminus">-    yield setupTest(gBodyFilter, gAction);</span>
<a href="#l17.103"></a><span id="l17.103" class="difflineplus">+    await setupTest(gBodyFilter, gAction);</span>
<a href="#l17.104"></a><span id="l17.104"> </span>
<a href="#l17.105"></a><span id="l17.105">     testCounts(false, 0, 0, 0);</span>
<a href="#l17.106"></a><span id="l17.106">     let thread = db().GetThreadContainingMsgHdr(gHeader);</span>
<a href="#l17.107"></a><span id="l17.107">     Assert.notEqual(0, thread.flags &amp; Ci.nsMsgMessageFlags.Ignored);</span>
<a href="#l17.108"></a><span id="l17.108">   },</span>
<a href="#l17.109"></a><span id="l17.109" class="difflineminus">-  function *KillSubthread() {</span>
<a href="#l17.110"></a><span id="l17.110" class="difflineplus">+  async function KillSubthread() {</span>
<a href="#l17.111"></a><span id="l17.111">     gAction.type = Ci.nsMsgFilterAction.KillSubthread;</span>
<a href="#l17.112"></a><span id="l17.112" class="difflineminus">-    yield setupTest(gFilter, gAction);</span>
<a href="#l17.113"></a><span id="l17.113" class="difflineplus">+    await setupTest(gFilter, gAction);</span>
<a href="#l17.114"></a><span id="l17.114"> </span>
<a href="#l17.115"></a><span id="l17.115">     testCounts(false, 0, 0, 0);</span>
<a href="#l17.116"></a><span id="l17.116">     Assert.notEqual(0, gHeader.flags &amp; Ci.nsMsgMessageFlags.Ignored);</span>
<a href="#l17.117"></a><span id="l17.117">   },</span>
<a href="#l17.118"></a><span id="l17.118" class="difflineminus">-  function *KillSubthreadBody() {</span>
<a href="#l17.119"></a><span id="l17.119" class="difflineplus">+  async function KillSubthreadBody() {</span>
<a href="#l17.120"></a><span id="l17.120">     gAction.type = Ci.nsMsgFilterAction.KillSubthread;</span>
<a href="#l17.121"></a><span id="l17.121" class="difflineminus">-    yield setupTest(gBodyFilter, gAction);</span>
<a href="#l17.122"></a><span id="l17.122" class="difflineplus">+    await setupTest(gBodyFilter, gAction);</span>
<a href="#l17.123"></a><span id="l17.123"> </span>
<a href="#l17.124"></a><span id="l17.124">     testCounts(false, 0, 0, 0);</span>
<a href="#l17.125"></a><span id="l17.125">     Assert.notEqual(0, gHeader.flags &amp; Ci.nsMsgMessageFlags.Ignored);</span>
<a href="#l17.126"></a><span id="l17.126">   },</span>
<a href="#l17.127"></a><span id="l17.127" class="difflineminus">-  function *DoNothing() {</span>
<a href="#l17.128"></a><span id="l17.128" class="difflineplus">+  async function DoNothing() {</span>
<a href="#l17.129"></a><span id="l17.129">     gAction.type = Ci.nsMsgFilterAction.StopExecution;</span>
<a href="#l17.130"></a><span id="l17.130" class="difflineminus">-    yield setupTest(gFilter, gAction);</span>
<a href="#l17.131"></a><span id="l17.131" class="difflineplus">+    await setupTest(gFilter, gAction);</span>
<a href="#l17.132"></a><span id="l17.132"> </span>
<a href="#l17.133"></a><span id="l17.133">     testCounts(true, 1, 1, 1);</span>
<a href="#l17.134"></a><span id="l17.134">   },</span>
<a href="#l17.135"></a><span id="l17.135" class="difflineminus">-  function *DoNothingBody() {</span>
<a href="#l17.136"></a><span id="l17.136" class="difflineplus">+  async function DoNothingBody() {</span>
<a href="#l17.137"></a><span id="l17.137">     gAction.type = Ci.nsMsgFilterAction.StopExecution;</span>
<a href="#l17.138"></a><span id="l17.138" class="difflineminus">-    yield setupTest(gFilter, gAction);</span>
<a href="#l17.139"></a><span id="l17.139" class="difflineplus">+    await setupTest(gFilter, gAction);</span>
<a href="#l17.140"></a><span id="l17.140"> </span>
<a href="#l17.141"></a><span id="l17.141">     testCounts(true, 1, 1, 1);</span>
<a href="#l17.142"></a><span id="l17.142">   },</span>
<a href="#l17.143"></a><span id="l17.143">   // this tests for marking message as junk</span>
<a href="#l17.144"></a><span id="l17.144" class="difflineminus">-  function *JunkScore() {</span>
<a href="#l17.145"></a><span id="l17.145" class="difflineplus">+  async function JunkScore() {</span>
<a href="#l17.146"></a><span id="l17.146">     gAction.type = Ci.nsMsgFilterAction.JunkScore;</span>
<a href="#l17.147"></a><span id="l17.147">     gAction.junkScore = 100;</span>
<a href="#l17.148"></a><span id="l17.148" class="difflineminus">-    yield setupTest(gFilter, gAction);</span>
<a href="#l17.149"></a><span id="l17.149" class="difflineplus">+    await setupTest(gFilter, gAction);</span>
<a href="#l17.150"></a><span id="l17.150"> </span>
<a href="#l17.151"></a><span id="l17.151">     // marking as junk resets new but not unread</span>
<a href="#l17.152"></a><span id="l17.152">     testCounts(false, 1, 0, 0);</span>
<a href="#l17.153"></a><span id="l17.153">     Assert.equal(gHeader.getStringProperty(&quot;junkscore&quot;), &quot;100&quot;);</span>
<a href="#l17.154"></a><span id="l17.154">     Assert.equal(gHeader.getStringProperty(&quot;junkscoreorigin&quot;), &quot;filter&quot;);</span>
<a href="#l17.155"></a><span id="l17.155">   },</span>
<a href="#l17.156"></a><span id="l17.156">   // this tests for marking message as junk</span>
<a href="#l17.157"></a><span id="l17.157" class="difflineminus">-  function *JunkScoreBody() {</span>
<a href="#l17.158"></a><span id="l17.158" class="difflineplus">+  async function JunkScoreBody() {</span>
<a href="#l17.159"></a><span id="l17.159">     gAction.type = Ci.nsMsgFilterAction.JunkScore;</span>
<a href="#l17.160"></a><span id="l17.160">     gAction.junkScore = 100;</span>
<a href="#l17.161"></a><span id="l17.161" class="difflineminus">-    yield setupTest(gBodyFilter, gAction);</span>
<a href="#l17.162"></a><span id="l17.162" class="difflineplus">+    await setupTest(gBodyFilter, gAction);</span>
<a href="#l17.163"></a><span id="l17.163"> </span>
<a href="#l17.164"></a><span id="l17.164">     // marking as junk resets new but not unread</span>
<a href="#l17.165"></a><span id="l17.165">     testCounts(false, 1, 0, 0);</span>
<a href="#l17.166"></a><span id="l17.166">     Assert.equal(gHeader.getStringProperty(&quot;junkscore&quot;), &quot;100&quot;);</span>
<a href="#l17.167"></a><span id="l17.167">     Assert.equal(gHeader.getStringProperty(&quot;junkscoreorigin&quot;), &quot;filter&quot;);</span>
<a href="#l17.168"></a><span id="l17.168">   },</span>
<a href="#l17.169"></a><span id="l17.169">   // The remaining tests add new messages</span>
<a href="#l17.170"></a><span id="l17.170" class="difflineminus">-  function *MarkUnread() {</span>
<a href="#l17.171"></a><span id="l17.171" class="difflineplus">+  async function MarkUnread() {</span>
<a href="#l17.172"></a><span id="l17.172">     gAction.type = Ci.nsMsgFilterAction.MarkUnread;</span>
<a href="#l17.173"></a><span id="l17.173" class="difflineminus">-    yield setupTest(gFilter, gAction);</span>
<a href="#l17.174"></a><span id="l17.174" class="difflineplus">+    await setupTest(gFilter, gAction);</span>
<a href="#l17.175"></a><span id="l17.175"> </span>
<a href="#l17.176"></a><span id="l17.176">     testCounts(true, 1, 1, 1);</span>
<a href="#l17.177"></a><span id="l17.177">     Assert.ok(!gHeader.isRead);</span>
<a href="#l17.178"></a><span id="l17.178">   },</span>
<a href="#l17.179"></a><span id="l17.179" class="difflineminus">-  function *MarkUnreadBody() {</span>
<a href="#l17.180"></a><span id="l17.180" class="difflineplus">+  async function MarkUnreadBody() {</span>
<a href="#l17.181"></a><span id="l17.181">     gAction.type = Ci.nsMsgFilterAction.MarkUnread;</span>
<a href="#l17.182"></a><span id="l17.182" class="difflineminus">-    yield setupTest(gBodyFilter, gAction);</span>
<a href="#l17.183"></a><span id="l17.183" class="difflineplus">+    await setupTest(gBodyFilter, gAction);</span>
<a href="#l17.184"></a><span id="l17.184"> </span>
<a href="#l17.185"></a><span id="l17.185">     testCounts(true, 1, 1, 1);</span>
<a href="#l17.186"></a><span id="l17.186">     Assert.ok(!gHeader.isRead);</span>
<a href="#l17.187"></a><span id="l17.187">   },</span>
<a href="#l17.188"></a><span id="l17.188" class="difflineminus">-  function *WatchThread() {</span>
<a href="#l17.189"></a><span id="l17.189" class="difflineplus">+  async function WatchThread() {</span>
<a href="#l17.190"></a><span id="l17.190">     gAction.type = Ci.nsMsgFilterAction.WatchThread;</span>
<a href="#l17.191"></a><span id="l17.191" class="difflineminus">-    yield setupTest(gFilter, gAction);</span>
<a href="#l17.192"></a><span id="l17.192" class="difflineplus">+    await setupTest(gFilter, gAction);</span>
<a href="#l17.193"></a><span id="l17.193"> </span>
<a href="#l17.194"></a><span id="l17.194">     testCounts(true, 1, 1, 1);</span>
<a href="#l17.195"></a><span id="l17.195">     let thread = db().GetThreadContainingMsgHdr(gHeader);</span>
<a href="#l17.196"></a><span id="l17.196">     Assert.notEqual(0, thread.flags &amp; Ci.nsMsgMessageFlags.Watched);</span>
<a href="#l17.197"></a><span id="l17.197">   },</span>
<a href="#l17.198"></a><span id="l17.198" class="difflineminus">-  function *WatchThreadBody() {</span>
<a href="#l17.199"></a><span id="l17.199" class="difflineplus">+  async function WatchThreadBody() {</span>
<a href="#l17.200"></a><span id="l17.200">     gAction.type = Ci.nsMsgFilterAction.WatchThread;</span>
<a href="#l17.201"></a><span id="l17.201" class="difflineminus">-    yield setupTest(gBodyFilter, gAction);</span>
<a href="#l17.202"></a><span id="l17.202" class="difflineplus">+    await setupTest(gBodyFilter, gAction);</span>
<a href="#l17.203"></a><span id="l17.203"> </span>
<a href="#l17.204"></a><span id="l17.204">     testCounts(true, 1, 1, 1);</span>
<a href="#l17.205"></a><span id="l17.205">     let thread = db().GetThreadContainingMsgHdr(gHeader);</span>
<a href="#l17.206"></a><span id="l17.206">     Assert.notEqual(0, thread.flags &amp; Ci.nsMsgMessageFlags.Watched);</span>
<a href="#l17.207"></a><span id="l17.207">   },</span>
<a href="#l17.208"></a><span id="l17.208" class="difflineminus">-  function *MarkFlagged() {</span>
<a href="#l17.209"></a><span id="l17.209" class="difflineplus">+  async function MarkFlagged() {</span>
<a href="#l17.210"></a><span id="l17.210">     gAction.type = Ci.nsMsgFilterAction.MarkFlagged;</span>
<a href="#l17.211"></a><span id="l17.211" class="difflineminus">-    yield setupTest(gFilter, gAction);</span>
<a href="#l17.212"></a><span id="l17.212" class="difflineplus">+    await setupTest(gFilter, gAction);</span>
<a href="#l17.213"></a><span id="l17.213"> </span>
<a href="#l17.214"></a><span id="l17.214">     testCounts(true, 1, 1, 1);</span>
<a href="#l17.215"></a><span id="l17.215">     Assert.ok(gHeader.isFlagged);</span>
<a href="#l17.216"></a><span id="l17.216">   },</span>
<a href="#l17.217"></a><span id="l17.217" class="difflineminus">-  function *MarkFlaggedBody() {</span>
<a href="#l17.218"></a><span id="l17.218" class="difflineplus">+  async function MarkFlaggedBody() {</span>
<a href="#l17.219"></a><span id="l17.219">     gAction.type = Ci.nsMsgFilterAction.MarkFlagged;</span>
<a href="#l17.220"></a><span id="l17.220" class="difflineminus">-    yield setupTest(gBodyFilter, gAction);</span>
<a href="#l17.221"></a><span id="l17.221" class="difflineplus">+    await setupTest(gBodyFilter, gAction);</span>
<a href="#l17.222"></a><span id="l17.222"> </span>
<a href="#l17.223"></a><span id="l17.223">     testCounts(true, 1, 1, 1);</span>
<a href="#l17.224"></a><span id="l17.224">     Assert.ok(gHeader.isFlagged);</span>
<a href="#l17.225"></a><span id="l17.225">   },</span>
<a href="#l17.226"></a><span id="l17.226" class="difflineminus">-  function *ChangePriority() {</span>
<a href="#l17.227"></a><span id="l17.227" class="difflineplus">+  async function ChangePriority() {</span>
<a href="#l17.228"></a><span id="l17.228">     gAction.type = Ci.nsMsgFilterAction.ChangePriority;</span>
<a href="#l17.229"></a><span id="l17.229">     gAction.priority = Ci.nsMsgPriority.highest;</span>
<a href="#l17.230"></a><span id="l17.230" class="difflineminus">-    yield setupTest(gFilter, gAction);</span>
<a href="#l17.231"></a><span id="l17.231" class="difflineplus">+    await setupTest(gFilter, gAction);</span>
<a href="#l17.232"></a><span id="l17.232"> </span>
<a href="#l17.233"></a><span id="l17.233">     testCounts(true, 1, 1, 1);</span>
<a href="#l17.234"></a><span id="l17.234">     Assert.equal(Ci.nsMsgPriority.highest, gHeader.priority);</span>
<a href="#l17.235"></a><span id="l17.235">   },</span>
<a href="#l17.236"></a><span id="l17.236" class="difflineminus">-  function *ChangePriorityBody() {</span>
<a href="#l17.237"></a><span id="l17.237" class="difflineplus">+  async function ChangePriorityBody() {</span>
<a href="#l17.238"></a><span id="l17.238">     gAction.type = Ci.nsMsgFilterAction.ChangePriority;</span>
<a href="#l17.239"></a><span id="l17.239">     gAction.priority = Ci.nsMsgPriority.highest;</span>
<a href="#l17.240"></a><span id="l17.240" class="difflineminus">-    yield setupTest(gBodyFilter, gAction);</span>
<a href="#l17.241"></a><span id="l17.241" class="difflineplus">+    await setupTest(gBodyFilter, gAction);</span>
<a href="#l17.242"></a><span id="l17.242"> </span>
<a href="#l17.243"></a><span id="l17.243">     testCounts(true, 1, 1, 1);</span>
<a href="#l17.244"></a><span id="l17.244">     Assert.equal(Ci.nsMsgPriority.highest, gHeader.priority);</span>
<a href="#l17.245"></a><span id="l17.245">   },</span>
<a href="#l17.246"></a><span id="l17.246" class="difflineminus">-  function *Label() {</span>
<a href="#l17.247"></a><span id="l17.247" class="difflineplus">+  async function Label() {</span>
<a href="#l17.248"></a><span id="l17.248">     gAction.type = Ci.nsMsgFilterAction.Label;</span>
<a href="#l17.249"></a><span id="l17.249">     gAction.label = 2;</span>
<a href="#l17.250"></a><span id="l17.250" class="difflineminus">-    yield setupTest(gFilter, gAction);</span>
<a href="#l17.251"></a><span id="l17.251" class="difflineplus">+    await setupTest(gFilter, gAction);</span>
<a href="#l17.252"></a><span id="l17.252"> </span>
<a href="#l17.253"></a><span id="l17.253">     testCounts(true, 1, 1, 1);</span>
<a href="#l17.254"></a><span id="l17.254">     Assert.equal(2, gHeader.label);</span>
<a href="#l17.255"></a><span id="l17.255">   },</span>
<a href="#l17.256"></a><span id="l17.256" class="difflineminus">-  function *LabelBody() {</span>
<a href="#l17.257"></a><span id="l17.257" class="difflineplus">+  async function LabelBody() {</span>
<a href="#l17.258"></a><span id="l17.258">     gAction.type = Ci.nsMsgFilterAction.Label;</span>
<a href="#l17.259"></a><span id="l17.259">     gAction.label = 3;</span>
<a href="#l17.260"></a><span id="l17.260" class="difflineminus">-    yield setupTest(gBodyFilter, gAction);</span>
<a href="#l17.261"></a><span id="l17.261" class="difflineplus">+    await setupTest(gBodyFilter, gAction);</span>
<a href="#l17.262"></a><span id="l17.262"> </span>
<a href="#l17.263"></a><span id="l17.263">     testCounts(true, 1, 1, 1);</span>
<a href="#l17.264"></a><span id="l17.264">     Assert.equal(3, gHeader.label);</span>
<a href="#l17.265"></a><span id="l17.265">   },</span>
<a href="#l17.266"></a><span id="l17.266" class="difflineminus">-  function *AddTag() {</span>
<a href="#l17.267"></a><span id="l17.267" class="difflineplus">+  async function AddTag() {</span>
<a href="#l17.268"></a><span id="l17.268">     gAction.type = Ci.nsMsgFilterAction.AddTag;</span>
<a href="#l17.269"></a><span id="l17.269">     gAction.strValue = &quot;TheTag&quot;;</span>
<a href="#l17.270"></a><span id="l17.270" class="difflineminus">-    yield setupTest(gFilter, gAction);</span>
<a href="#l17.271"></a><span id="l17.271" class="difflineplus">+    await setupTest(gFilter, gAction);</span>
<a href="#l17.272"></a><span id="l17.272"> </span>
<a href="#l17.273"></a><span id="l17.273">     testCounts(true, 1, 1, 1);</span>
<a href="#l17.274"></a><span id="l17.274">     Assert.equal(gHeader.getStringProperty(&quot;keywords&quot;), &quot;thetag&quot;);</span>
<a href="#l17.275"></a><span id="l17.275">   },</span>
<a href="#l17.276"></a><span id="l17.276" class="difflineminus">-  function *AddTagBody() {</span>
<a href="#l17.277"></a><span id="l17.277" class="difflineplus">+  async function AddTagBody() {</span>
<a href="#l17.278"></a><span id="l17.278">     gAction.type = Ci.nsMsgFilterAction.AddTag;</span>
<a href="#l17.279"></a><span id="l17.279">     gAction.strValue = &quot;TheTag2&quot;;</span>
<a href="#l17.280"></a><span id="l17.280" class="difflineminus">-    yield setupTest(gBodyFilter, gAction);</span>
<a href="#l17.281"></a><span id="l17.281" class="difflineplus">+    await setupTest(gBodyFilter, gAction);</span>
<a href="#l17.282"></a><span id="l17.282"> </span>
<a href="#l17.283"></a><span id="l17.283">     testCounts(true, 1, 1, 1);</span>
<a href="#l17.284"></a><span id="l17.284">     Assert.equal(gHeader.getStringProperty(&quot;keywords&quot;), &quot;thetag2&quot;);</span>
<a href="#l17.285"></a><span id="l17.285">   },</span>
<a href="#l17.286"></a><span id="l17.286">   // this tests for marking message as good</span>
<a href="#l17.287"></a><span id="l17.287" class="difflineminus">-  function *JunkScoreAsGood() {</span>
<a href="#l17.288"></a><span id="l17.288" class="difflineplus">+  async function JunkScoreAsGood() {</span>
<a href="#l17.289"></a><span id="l17.289">     gAction.type = Ci.nsMsgFilterAction.JunkScore;</span>
<a href="#l17.290"></a><span id="l17.290">     gAction.junkScore = 0;</span>
<a href="#l17.291"></a><span id="l17.291" class="difflineminus">-    yield setupTest(gFilter, gAction);</span>
<a href="#l17.292"></a><span id="l17.292" class="difflineplus">+    await setupTest(gFilter, gAction);</span>
<a href="#l17.293"></a><span id="l17.293"> </span>
<a href="#l17.294"></a><span id="l17.294">     testCounts(true, 1, 1, 1);</span>
<a href="#l17.295"></a><span id="l17.295">     Assert.equal(gHeader.getStringProperty(&quot;junkscore&quot;), &quot;0&quot;);</span>
<a href="#l17.296"></a><span id="l17.296">     Assert.equal(gHeader.getStringProperty(&quot;junkscoreorigin&quot;), &quot;filter&quot;);</span>
<a href="#l17.297"></a><span id="l17.297">   },</span>
<a href="#l17.298"></a><span id="l17.298">   // this tests for marking message as good</span>
<a href="#l17.299"></a><span id="l17.299" class="difflineminus">-  function *JunkScoreAsGoodBody() {</span>
<a href="#l17.300"></a><span id="l17.300" class="difflineplus">+  async function JunkScoreAsGoodBody() {</span>
<a href="#l17.301"></a><span id="l17.301">     gAction.type = Ci.nsMsgFilterAction.JunkScore;</span>
<a href="#l17.302"></a><span id="l17.302">     gAction.junkScore = 0;</span>
<a href="#l17.303"></a><span id="l17.303" class="difflineminus">-    yield setupTest(gBodyFilter, gAction);</span>
<a href="#l17.304"></a><span id="l17.304" class="difflineplus">+    await setupTest(gBodyFilter, gAction);</span>
<a href="#l17.305"></a><span id="l17.305"> </span>
<a href="#l17.306"></a><span id="l17.306">     testCounts(true, 1, 1, 1);</span>
<a href="#l17.307"></a><span id="l17.307">     Assert.equal(gHeader.getStringProperty(&quot;junkscore&quot;), &quot;0&quot;);</span>
<a href="#l17.308"></a><span id="l17.308">     Assert.equal(gHeader.getStringProperty(&quot;junkscoreorigin&quot;), &quot;filter&quot;);</span>
<a href="#l17.309"></a><span id="l17.309">   },</span>
<a href="#l17.310"></a><span id="l17.310" class="difflineminus">-  function *CopyToFolder() {</span>
<a href="#l17.311"></a><span id="l17.311" class="difflineplus">+  async function CopyToFolder() {</span>
<a href="#l17.312"></a><span id="l17.312">     gAction.type = Ci.nsMsgFilterAction.CopyToFolder;</span>
<a href="#l17.313"></a><span id="l17.313">     gAction.targetFolderUri = gSubfolder.URI;</span>
<a href="#l17.314"></a><span id="l17.314">     gInboxCount = folderCount(IMAPPump.inbox);</span>
<a href="#l17.315"></a><span id="l17.315">     gSubfolderCount = folderCount(gSubfolder);</span>
<a href="#l17.316"></a><span id="l17.316" class="difflineminus">-    yield setupTest(gFilter, gAction);</span>
<a href="#l17.317"></a><span id="l17.317" class="difflineplus">+    await setupTest(gFilter, gAction);</span>
<a href="#l17.318"></a><span id="l17.318"> </span>
<a href="#l17.319"></a><span id="l17.319">     testCounts(true, 1, 1, 1);</span>
<a href="#l17.320"></a><span id="l17.320">     Assert.equal(gInboxCount + 1, folderCount(IMAPPump.inbox));</span>
<a href="#l17.321"></a><span id="l17.321">     Assert.equal(gSubfolderCount + 1, folderCount(gSubfolder));</span>
<a href="#l17.322"></a><span id="l17.322">   },</span>
<a href="#l17.323"></a><span id="l17.323" class="difflineminus">-  function *CopyToFolderBody() {</span>
<a href="#l17.324"></a><span id="l17.324" class="difflineplus">+  async function CopyToFolderBody() {</span>
<a href="#l17.325"></a><span id="l17.325">     gAction.type = Ci.nsMsgFilterAction.CopyToFolder;</span>
<a href="#l17.326"></a><span id="l17.326">     gAction.targetFolderUri = gSubfolder.URI;</span>
<a href="#l17.327"></a><span id="l17.327">     gInboxCount = folderCount(IMAPPump.inbox);</span>
<a href="#l17.328"></a><span id="l17.328">     gSubfolderCount = folderCount(gSubfolder);</span>
<a href="#l17.329"></a><span id="l17.329" class="difflineminus">-    yield setupTest(gBodyFilter, gAction);</span>
<a href="#l17.330"></a><span id="l17.330" class="difflineplus">+    await setupTest(gBodyFilter, gAction);</span>
<a href="#l17.331"></a><span id="l17.331"> </span>
<a href="#l17.332"></a><span id="l17.332">     testCounts(true, 1, 1, 1);</span>
<a href="#l17.333"></a><span id="l17.333">     Assert.equal(gInboxCount + 1, folderCount(IMAPPump.inbox));</span>
<a href="#l17.334"></a><span id="l17.334">     Assert.equal(gSubfolderCount + 1, folderCount(gSubfolder));</span>
<a href="#l17.335"></a><span id="l17.335">   },</span>
<a href="#l17.336"></a><span id="l17.336">   /**/</span>
<a href="#l17.337"></a><span id="l17.337">   endTest</span>
<a href="#l17.338"></a><span id="l17.338"> </span>
<a href="#l17.339"></a><span id="l17.339" class="difflineat">@@ -383,17 +383,17 @@ function setupFilters()</span>
<a href="#l17.340"></a><span id="l17.340"> </span>
<a href="#l17.341"></a><span id="l17.341"> /*</span>
<a href="#l17.342"></a><span id="l17.342">  * functions used to support test setup and execution</span>
<a href="#l17.343"></a><span id="l17.343">  */</span>
<a href="#l17.344"></a><span id="l17.344"> </span>
<a href="#l17.345"></a><span id="l17.345"> // basic preparation done for each test</span>
<a href="#l17.346"></a><span id="l17.346"> function setupTest(aFilter, aAction)</span>
<a href="#l17.347"></a><span id="l17.347"> {</span>
<a href="#l17.348"></a><span id="l17.348" class="difflineminus">-  return Task.spawn(function* () {</span>
<a href="#l17.349"></a><span id="l17.349" class="difflineplus">+  return Task.spawn(async function () {</span>
<a href="#l17.350"></a><span id="l17.350">     let filterList = IMAPPump.incomingServer.getFilterList(null);</span>
<a href="#l17.351"></a><span id="l17.351">     while (filterList.filterCount)</span>
<a href="#l17.352"></a><span id="l17.352">       filterList.removeFilterAt(0);</span>
<a href="#l17.353"></a><span id="l17.353">     if (aFilter)</span>
<a href="#l17.354"></a><span id="l17.354">     {</span>
<a href="#l17.355"></a><span id="l17.355">       aFilter.clearActionList();</span>
<a href="#l17.356"></a><span id="l17.356">       if (aAction) {</span>
<a href="#l17.357"></a><span id="l17.357">         aFilter.appendAction(aAction);</span>
<a href="#l17.358"></a><span id="l17.358" class="difflineat">@@ -407,18 +407,18 @@ function setupTest(aFilter, aAction)</span>
<a href="#l17.359"></a><span id="l17.359"> </span>
<a href="#l17.360"></a><span id="l17.360">     gInboxListener = new DBListener();</span>
<a href="#l17.361"></a><span id="l17.361">     gDbService.registerPendingListener(IMAPPump.inbox, gInboxListener);</span>
<a href="#l17.362"></a><span id="l17.362">     gMoveCallbackCount = 0;</span>
<a href="#l17.363"></a><span id="l17.363">     IMAPPump.mailbox.addMessage(new imapMessage(specForFileName(gMessage),</span>
<a href="#l17.364"></a><span id="l17.364">                             IMAPPump.mailbox.uidnext++, []));</span>
<a href="#l17.365"></a><span id="l17.365">     let promiseUrlListener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l17.366"></a><span id="l17.366">     IMAPPump.inbox.updateFolderWithListener(null, promiseUrlListener);</span>
<a href="#l17.367"></a><span id="l17.367" class="difflineminus">-    yield promiseUrlListener.promise;</span>
<a href="#l17.368"></a><span id="l17.368" class="difflineminus">-    yield PromiseTestUtils.promiseDelay(200);</span>
<a href="#l17.369"></a><span id="l17.369" class="difflineplus">+    await promiseUrlListener.promise;</span>
<a href="#l17.370"></a><span id="l17.370" class="difflineplus">+    await PromiseTestUtils.promiseDelay(200);</span>
<a href="#l17.371"></a><span id="l17.371">   });</span>
<a href="#l17.372"></a><span id="l17.372"> }</span>
<a href="#l17.373"></a><span id="l17.373"> </span>
<a href="#l17.374"></a><span id="l17.374"> // Cleanup, null out everything, close all cached connections and stop the</span>
<a href="#l17.375"></a><span id="l17.375"> // server</span>
<a href="#l17.376"></a><span id="l17.376"> function endTest()</span>
<a href="#l17.377"></a><span id="l17.377"> {</span>
<a href="#l17.378"></a><span id="l17.378">   if (gInboxListener)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapFilterActionsPostplugin.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapFilterActionsPostplugin.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -43,139 +43,139 @@ var gDbService = Cc[&quot;@mozilla.org/msgDat</span>
<a href="#l18.4"></a><span id="l18.4"> </span>
<a href="#l18.5"></a><span id="l18.5"> // Definition of tests. The test function name is the filter action</span>
<a href="#l18.6"></a><span id="l18.6"> // being tested, with &quot;Body&quot; appended to tests that use delayed</span>
<a href="#l18.7"></a><span id="l18.7"> // application of filters due to a body search</span>
<a href="#l18.8"></a><span id="l18.8"> var gTestArray =</span>
<a href="#l18.9"></a><span id="l18.9"> [</span>
<a href="#l18.10"></a><span id="l18.10">   setupIMAPPump,</span>
<a href="#l18.11"></a><span id="l18.11">   setupFilters,</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-  function *DoNothing() {</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+  async function DoNothing() {</span>
<a href="#l18.14"></a><span id="l18.14">     gAction.type = Ci.nsMsgFilterAction.StopExecution;</span>
<a href="#l18.15"></a><span id="l18.15">     gInboxCount = folderCount(IMAPPump.inbox);</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineminus">-    yield setupTest(gFilter, gAction);</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineplus">+    await setupTest(gFilter, gAction);</span>
<a href="#l18.18"></a><span id="l18.18">     testCounts(false, 1, 0, 0);</span>
<a href="#l18.19"></a><span id="l18.19">     Assert.equal(gInboxCount + 1, folderCount(IMAPPump.inbox));</span>
<a href="#l18.20"></a><span id="l18.20">   },</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineminus">-  function *Delete() {</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineplus">+  async function Delete() {</span>
<a href="#l18.23"></a><span id="l18.23">     gAction.type = Ci.nsMsgFilterAction.Delete;</span>
<a href="#l18.24"></a><span id="l18.24">     gInboxCount = folderCount(IMAPPump.inbox);</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineminus">-    yield setupTest(gFilter, gAction);</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineplus">+    await setupTest(gFilter, gAction);</span>
<a href="#l18.27"></a><span id="l18.27">     testCounts(false, 0, 0, 0);</span>
<a href="#l18.28"></a><span id="l18.28">     Assert.equal(gInboxCount, folderCount(IMAPPump.inbox));</span>
<a href="#l18.29"></a><span id="l18.29">   },</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineminus">-  function *MoveToFolder() {</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+  async function MoveToFolder() {</span>
<a href="#l18.32"></a><span id="l18.32">     gAction.type = Ci.nsMsgFilterAction.MoveToFolder;</span>
<a href="#l18.33"></a><span id="l18.33">     gAction.targetFolderUri = gSubfolder.URI;</span>
<a href="#l18.34"></a><span id="l18.34">     gInboxCount = folderCount(IMAPPump.inbox);</span>
<a href="#l18.35"></a><span id="l18.35">     gSubfolderCount = folderCount(gSubfolder);</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineminus">-    yield setupTest(gFilter, gAction);</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineplus">+    await setupTest(gFilter, gAction);</span>
<a href="#l18.38"></a><span id="l18.38"> </span>
<a href="#l18.39"></a><span id="l18.39">     testCounts(false, 0, 0, 0);</span>
<a href="#l18.40"></a><span id="l18.40">     Assert.equal(gSubfolderCount + 1, folderCount(gSubfolder));</span>
<a href="#l18.41"></a><span id="l18.41">   // no net messages were added to the inbox</span>
<a href="#l18.42"></a><span id="l18.42">     Assert.equal(gInboxCount, folderCount(IMAPPump.inbox));</span>
<a href="#l18.43"></a><span id="l18.43">   },</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineminus">-  function *MarkRead() {</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineplus">+  async function MarkRead() {</span>
<a href="#l18.46"></a><span id="l18.46">     gAction.type = Ci.nsMsgFilterAction.MarkRead;</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineminus">-    yield setupTest(gFilter, gAction);</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineplus">+    await setupTest(gFilter, gAction);</span>
<a href="#l18.49"></a><span id="l18.49">     testCounts(false, 0, 0, 0);</span>
<a href="#l18.50"></a><span id="l18.50">     Assert.ok(gHeader.isRead);</span>
<a href="#l18.51"></a><span id="l18.51">   },</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineminus">-  function *KillThread() {</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineplus">+  async function KillThread() {</span>
<a href="#l18.54"></a><span id="l18.54">     gAction.type = Ci.nsMsgFilterAction.KillThread;</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineminus">-    yield setupTest(gFilter, gAction);</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineplus">+    await setupTest(gFilter, gAction);</span>
<a href="#l18.57"></a><span id="l18.57">     // In non-postplugin, count here is 0 and not 1.  Need to investigate.</span>
<a href="#l18.58"></a><span id="l18.58">     testCounts(false, 1, 0, 0);</span>
<a href="#l18.59"></a><span id="l18.59">     let thread = db().GetThreadContainingMsgHdr(gHeader);</span>
<a href="#l18.60"></a><span id="l18.60">     Assert.notEqual(0, thread.flags &amp; Ci.nsMsgMessageFlags.Ignored);</span>
<a href="#l18.61"></a><span id="l18.61">   },</span>
<a href="#l18.62"></a><span id="l18.62" class="difflineminus">-  function *WatchThread() {</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineplus">+  async function WatchThread() {</span>
<a href="#l18.64"></a><span id="l18.64">     gAction.type = Ci.nsMsgFilterAction.WatchThread;</span>
<a href="#l18.65"></a><span id="l18.65" class="difflineminus">-    yield setupTest(gFilter, gAction);</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineplus">+    await setupTest(gFilter, gAction);</span>
<a href="#l18.67"></a><span id="l18.67">     // In non-postplugin, count here is 0 and not 1.  Need to investigate.</span>
<a href="#l18.68"></a><span id="l18.68">     testCounts(false, 1, 0, 0);</span>
<a href="#l18.69"></a><span id="l18.69">     let thread = db().GetThreadContainingMsgHdr(gHeader);</span>
<a href="#l18.70"></a><span id="l18.70">     Assert.notEqual(0, thread.flags &amp; Ci.nsMsgMessageFlags.Watched);</span>
<a href="#l18.71"></a><span id="l18.71">   },</span>
<a href="#l18.72"></a><span id="l18.72" class="difflineminus">-  function *KillSubthread() {</span>
<a href="#l18.73"></a><span id="l18.73" class="difflineplus">+  async function KillSubthread() {</span>
<a href="#l18.74"></a><span id="l18.74">     gAction.type = Ci.nsMsgFilterAction.KillSubthread;</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineminus">-    yield setupTest(gFilter, gAction);</span>
<a href="#l18.76"></a><span id="l18.76" class="difflineplus">+    await setupTest(gFilter, gAction);</span>
<a href="#l18.77"></a><span id="l18.77">     // In non-postplugin, count here is 0 and not 1.  Need to investigate.</span>
<a href="#l18.78"></a><span id="l18.78">     testCounts(false, 1, 0, 0);</span>
<a href="#l18.79"></a><span id="l18.79">     Assert.notEqual(0, gHeader.flags &amp; Ci.nsMsgMessageFlags.Ignored);</span>
<a href="#l18.80"></a><span id="l18.80">   },</span>
<a href="#l18.81"></a><span id="l18.81">   // this tests for marking message as junk</span>
<a href="#l18.82"></a><span id="l18.82" class="difflineminus">-  function *JunkScore() {</span>
<a href="#l18.83"></a><span id="l18.83" class="difflineplus">+  async function JunkScore() {</span>
<a href="#l18.84"></a><span id="l18.84">     gAction.type = Ci.nsMsgFilterAction.JunkScore;</span>
<a href="#l18.85"></a><span id="l18.85">     gAction.junkScore = 100;</span>
<a href="#l18.86"></a><span id="l18.86" class="difflineminus">-    yield setupTest(gFilter, gAction);</span>
<a href="#l18.87"></a><span id="l18.87" class="difflineplus">+    await setupTest(gFilter, gAction);</span>
<a href="#l18.88"></a><span id="l18.88">     // marking as junk resets new but not unread</span>
<a href="#l18.89"></a><span id="l18.89">     testCounts(false, 1, 0, 0);</span>
<a href="#l18.90"></a><span id="l18.90">     Assert.equal(gHeader.getStringProperty(&quot;junkscore&quot;), &quot;100&quot;);</span>
<a href="#l18.91"></a><span id="l18.91">     Assert.equal(gHeader.getStringProperty(&quot;junkscoreorigin&quot;), &quot;filter&quot;);</span>
<a href="#l18.92"></a><span id="l18.92">   },</span>
<a href="#l18.93"></a><span id="l18.93" class="difflineminus">-  function *MarkUnread() {</span>
<a href="#l18.94"></a><span id="l18.94" class="difflineplus">+  async function MarkUnread() {</span>
<a href="#l18.95"></a><span id="l18.95">     gAction.type = Ci.nsMsgFilterAction.MarkUnread;</span>
<a href="#l18.96"></a><span id="l18.96" class="difflineminus">-    yield setupTest(gFilter, gAction);</span>
<a href="#l18.97"></a><span id="l18.97" class="difflineplus">+    await setupTest(gFilter, gAction);</span>
<a href="#l18.98"></a><span id="l18.98">     testCounts(true, 1, 1, 1);</span>
<a href="#l18.99"></a><span id="l18.99">     Assert.ok(!gHeader.isRead);</span>
<a href="#l18.100"></a><span id="l18.100">   },</span>
<a href="#l18.101"></a><span id="l18.101" class="difflineminus">-  function *MarkFlagged() {</span>
<a href="#l18.102"></a><span id="l18.102" class="difflineplus">+  async function MarkFlagged() {</span>
<a href="#l18.103"></a><span id="l18.103">     gAction.type = Ci.nsMsgFilterAction.MarkFlagged;</span>
<a href="#l18.104"></a><span id="l18.104" class="difflineminus">-    yield setupTest(gFilter, gAction);</span>
<a href="#l18.105"></a><span id="l18.105" class="difflineplus">+    await setupTest(gFilter, gAction);</span>
<a href="#l18.106"></a><span id="l18.106">     testCounts(true, 1, 1, 1);</span>
<a href="#l18.107"></a><span id="l18.107">     Assert.ok(gHeader.isFlagged);</span>
<a href="#l18.108"></a><span id="l18.108">   },</span>
<a href="#l18.109"></a><span id="l18.109" class="difflineminus">-  function *ChangePriority() {</span>
<a href="#l18.110"></a><span id="l18.110" class="difflineplus">+  async function ChangePriority() {</span>
<a href="#l18.111"></a><span id="l18.111">     gAction.type = Ci.nsMsgFilterAction.ChangePriority;</span>
<a href="#l18.112"></a><span id="l18.112">     gAction.priority = Ci.nsMsgPriority.highest;</span>
<a href="#l18.113"></a><span id="l18.113" class="difflineminus">-    yield setupTest(gFilter, gAction);</span>
<a href="#l18.114"></a><span id="l18.114" class="difflineplus">+    await setupTest(gFilter, gAction);</span>
<a href="#l18.115"></a><span id="l18.115">     testCounts(true, 1, 1, 1);</span>
<a href="#l18.116"></a><span id="l18.116">     Assert.equal(Ci.nsMsgPriority.highest, gHeader.priority);</span>
<a href="#l18.117"></a><span id="l18.117">   },</span>
<a href="#l18.118"></a><span id="l18.118" class="difflineminus">-  function *Label() {</span>
<a href="#l18.119"></a><span id="l18.119" class="difflineplus">+  async function Label() {</span>
<a href="#l18.120"></a><span id="l18.120">     gAction.type = Ci.nsMsgFilterAction.Label;</span>
<a href="#l18.121"></a><span id="l18.121">     gAction.label = 2;</span>
<a href="#l18.122"></a><span id="l18.122" class="difflineminus">-    yield setupTest(gFilter, gAction);</span>
<a href="#l18.123"></a><span id="l18.123" class="difflineplus">+    await setupTest(gFilter, gAction);</span>
<a href="#l18.124"></a><span id="l18.124">     testCounts(true, 1, 1, 1);</span>
<a href="#l18.125"></a><span id="l18.125">     Assert.equal(2, gHeader.label);</span>
<a href="#l18.126"></a><span id="l18.126">   },</span>
<a href="#l18.127"></a><span id="l18.127" class="difflineminus">-  function *AddTag() {</span>
<a href="#l18.128"></a><span id="l18.128" class="difflineplus">+  async function AddTag() {</span>
<a href="#l18.129"></a><span id="l18.129">     gAction.type = Ci.nsMsgFilterAction.AddTag;</span>
<a href="#l18.130"></a><span id="l18.130">     gAction.strValue = &quot;TheTag&quot;;</span>
<a href="#l18.131"></a><span id="l18.131" class="difflineminus">-    yield setupTest(gFilter, gAction);</span>
<a href="#l18.132"></a><span id="l18.132" class="difflineplus">+    await setupTest(gFilter, gAction);</span>
<a href="#l18.133"></a><span id="l18.133">     testCounts(true, 1, 1, 1);</span>
<a href="#l18.134"></a><span id="l18.134">     Assert.equal(gHeader.getStringProperty(&quot;keywords&quot;), &quot;thetag&quot;);</span>
<a href="#l18.135"></a><span id="l18.135">   },</span>
<a href="#l18.136"></a><span id="l18.136">   // this tests for marking message as good</span>
<a href="#l18.137"></a><span id="l18.137" class="difflineminus">-  function *JunkScoreAsGood() {</span>
<a href="#l18.138"></a><span id="l18.138" class="difflineplus">+  async function JunkScoreAsGood() {</span>
<a href="#l18.139"></a><span id="l18.139">     gAction.type = Ci.nsMsgFilterAction.JunkScore;</span>
<a href="#l18.140"></a><span id="l18.140">     gAction.junkScore = 0;</span>
<a href="#l18.141"></a><span id="l18.141" class="difflineminus">-    yield setupTest(gFilter, gAction);</span>
<a href="#l18.142"></a><span id="l18.142" class="difflineplus">+    await setupTest(gFilter, gAction);</span>
<a href="#l18.143"></a><span id="l18.143">     testCounts(true, 1, 1, 1);</span>
<a href="#l18.144"></a><span id="l18.144">     Assert.equal(gHeader.getStringProperty(&quot;junkscore&quot;), &quot;0&quot;);</span>
<a href="#l18.145"></a><span id="l18.145">     Assert.equal(gHeader.getStringProperty(&quot;junkscoreorigin&quot;), &quot;filter&quot;);</span>
<a href="#l18.146"></a><span id="l18.146">   },</span>
<a href="#l18.147"></a><span id="l18.147" class="difflineminus">-  function *CopyToFolder() {</span>
<a href="#l18.148"></a><span id="l18.148" class="difflineplus">+  async function CopyToFolder() {</span>
<a href="#l18.149"></a><span id="l18.149">     gAction.type = Ci.nsMsgFilterAction.CopyToFolder;</span>
<a href="#l18.150"></a><span id="l18.150">     gAction.targetFolderUri = gSubfolder.URI;</span>
<a href="#l18.151"></a><span id="l18.151">     gInboxCount = folderCount(IMAPPump.inbox);</span>
<a href="#l18.152"></a><span id="l18.152">     gSubfolderCount = folderCount(gSubfolder);</span>
<a href="#l18.153"></a><span id="l18.153" class="difflineminus">-    yield setupTest(gFilter, gAction);</span>
<a href="#l18.154"></a><span id="l18.154" class="difflineplus">+    await setupTest(gFilter, gAction);</span>
<a href="#l18.155"></a><span id="l18.155">     testCounts(true, 1, 1, 1);</span>
<a href="#l18.156"></a><span id="l18.156">     Assert.equal(gInboxCount + 1, folderCount(IMAPPump.inbox));</span>
<a href="#l18.157"></a><span id="l18.157">     Assert.equal(gSubfolderCount + 1, folderCount(gSubfolder));</span>
<a href="#l18.158"></a><span id="l18.158">   },</span>
<a href="#l18.159"></a><span id="l18.159" class="difflineminus">-  function *Custom() {</span>
<a href="#l18.160"></a><span id="l18.160" class="difflineplus">+  async function Custom() {</span>
<a href="#l18.161"></a><span id="l18.161">     gAction.type = Ci.nsMsgFilterAction.Custom;</span>
<a href="#l18.162"></a><span id="l18.162">     gAction.customId = 'mailnews@mozilla.org#testOffline';</span>
<a href="#l18.163"></a><span id="l18.163">     gAction.strValue = 'true';</span>
<a href="#l18.164"></a><span id="l18.164">     actionTestOffline.needsBody = true;</span>
<a href="#l18.165"></a><span id="l18.165" class="difflineminus">-    yield setupTest(gFilter, gAction);</span>
<a href="#l18.166"></a><span id="l18.166" class="difflineplus">+    await setupTest(gFilter, gAction);</span>
<a href="#l18.167"></a><span id="l18.167">     testCounts(true, 1, 1, 1);</span>
<a href="#l18.168"></a><span id="l18.168">   },</span>
<a href="#l18.169"></a><span id="l18.169">   /**/</span>
<a href="#l18.170"></a><span id="l18.170">   endTest,</span>
<a href="#l18.171"></a><span id="l18.171"> ];</span>
<a href="#l18.172"></a><span id="l18.172"> </span>
<a href="#l18.173"></a><span id="l18.173"> function run_test() {</span>
<a href="#l18.174"></a><span id="l18.174">   Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l18.175"></a><span id="l18.175" class="difflineat">@@ -212,17 +212,17 @@ function setupFilters()</span>
<a href="#l18.176"></a><span id="l18.176"> </span>
<a href="#l18.177"></a><span id="l18.177"> /*</span>
<a href="#l18.178"></a><span id="l18.178">  * functions used to support test setup and execution</span>
<a href="#l18.179"></a><span id="l18.179">  */</span>
<a href="#l18.180"></a><span id="l18.180"> </span>
<a href="#l18.181"></a><span id="l18.181"> // basic preparation done for each test</span>
<a href="#l18.182"></a><span id="l18.182"> function setupTest(aFilter, aAction)</span>
<a href="#l18.183"></a><span id="l18.183"> {</span>
<a href="#l18.184"></a><span id="l18.184" class="difflineminus">-  return Task.spawn(function* () {</span>
<a href="#l18.185"></a><span id="l18.185" class="difflineplus">+  return Task.spawn(async function () {</span>
<a href="#l18.186"></a><span id="l18.186">     let filterList = IMAPPump.incomingServer.getFilterList(null);</span>
<a href="#l18.187"></a><span id="l18.187">     while (filterList.filterCount)</span>
<a href="#l18.188"></a><span id="l18.188">       filterList.removeFilterAt(0);</span>
<a href="#l18.189"></a><span id="l18.189">     if (aFilter)</span>
<a href="#l18.190"></a><span id="l18.190">     {</span>
<a href="#l18.191"></a><span id="l18.191">       aFilter.clearActionList();</span>
<a href="#l18.192"></a><span id="l18.192">       if (aAction) {</span>
<a href="#l18.193"></a><span id="l18.193">         aFilter.appendAction(aAction);</span>
<a href="#l18.194"></a><span id="l18.194" class="difflineat">@@ -234,18 +234,18 @@ function setupTest(aFilter, aAction)</span>
<a href="#l18.195"></a><span id="l18.195"> </span>
<a href="#l18.196"></a><span id="l18.196">     gInboxListener = new DBListener();</span>
<a href="#l18.197"></a><span id="l18.197">     gDbService.registerPendingListener(IMAPPump.inbox, gInboxListener);</span>
<a href="#l18.198"></a><span id="l18.198">     gMoveCallbackCount = 0;</span>
<a href="#l18.199"></a><span id="l18.199">     IMAPPump.mailbox.addMessage(new imapMessage(specForFileName(gMessage),</span>
<a href="#l18.200"></a><span id="l18.200">                             IMAPPump.mailbox.uidnext++, []));</span>
<a href="#l18.201"></a><span id="l18.201">     let promiseUrlListener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l18.202"></a><span id="l18.202">     IMAPPump.inbox.updateFolderWithListener(null, promiseUrlListener);</span>
<a href="#l18.203"></a><span id="l18.203" class="difflineminus">-    yield promiseUrlListener.promise;</span>
<a href="#l18.204"></a><span id="l18.204" class="difflineminus">-    yield PromiseTestUtils.promiseDelay(200);</span>
<a href="#l18.205"></a><span id="l18.205" class="difflineplus">+    await promiseUrlListener.promise;</span>
<a href="#l18.206"></a><span id="l18.206" class="difflineplus">+    await PromiseTestUtils.promiseDelay(200);</span>
<a href="#l18.207"></a><span id="l18.207">   });</span>
<a href="#l18.208"></a><span id="l18.208"> }</span>
<a href="#l18.209"></a><span id="l18.209"> </span>
<a href="#l18.210"></a><span id="l18.210"> // Cleanup, null out everything, close all cached connections and stop the</span>
<a href="#l18.211"></a><span id="l18.211"> // server</span>
<a href="#l18.212"></a><span id="l18.212"> function endTest()</span>
<a href="#l18.213"></a><span id="l18.213"> {</span>
<a href="#l18.214"></a><span id="l18.214">   if (gInboxListener)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapMove.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapMove.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -20,52 +20,52 @@ var tests = [</span>
<a href="#l19.4"></a><span id="l19.4">   teardownIMAPPump</span>
<a href="#l19.5"></a><span id="l19.5"> ];</span>
<a href="#l19.6"></a><span id="l19.6"> </span>
<a href="#l19.7"></a><span id="l19.7"> function setupCUSTOM1() {</span>
<a href="#l19.8"></a><span id="l19.8">   setupIMAPPump(&quot;CUSTOM1&quot;);</span>
<a href="#l19.9"></a><span id="l19.9">   Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l19.10"></a><span id="l19.10"> }</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-function *startTest()</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+async function startTest()</span>
<a href="#l19.14"></a><span id="l19.14"> {</span>
<a href="#l19.15"></a><span id="l19.15">   IMAPPump.incomingServer.rootFolder.createSubfolder(&quot;folder 1&quot;, null);</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineminus">-  yield PromiseTestUtils.promiseFolderAdded(&quot;folder 1&quot;);</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineplus">+  await PromiseTestUtils.promiseFolderAdded(&quot;folder 1&quot;);</span>
<a href="#l19.18"></a><span id="l19.18"> </span>
<a href="#l19.19"></a><span id="l19.19">   addImapMessage();</span>
<a href="#l19.20"></a><span id="l19.20">   let listener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l19.21"></a><span id="l19.21">   IMAPPump.inbox.updateFolderWithListener(null, listener);</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineminus">-  yield listener.promise;</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineplus">+  await listener.promise;</span>
<a href="#l19.24"></a><span id="l19.24"> </span>
<a href="#l19.25"></a><span id="l19.25">   // ...and download for offline use.</span>
<a href="#l19.26"></a><span id="l19.26">   let promiseUrlListener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l19.27"></a><span id="l19.27">   IMAPPump.inbox.downloadAllForOffline(promiseUrlListener, null);</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineminus">-  yield promiseUrlListener.promise;</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineplus">+  await promiseUrlListener.promise;</span>
<a href="#l19.30"></a><span id="l19.30"> }</span>
<a href="#l19.31"></a><span id="l19.31"> </span>
<a href="#l19.32"></a><span id="l19.32" class="difflineminus">-function *doMove() {</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineplus">+async function doMove() {</span>
<a href="#l19.34"></a><span id="l19.34">   var messages = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l19.35"></a><span id="l19.35">   let rootFolder = IMAPPump.incomingServer.rootFolder;</span>
<a href="#l19.36"></a><span id="l19.36">   gFolder1 = rootFolder.getChildNamed(&quot;folder 1&quot;)</span>
<a href="#l19.37"></a><span id="l19.37">                        .QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l19.38"></a><span id="l19.38">   let msg = IMAPPump.inbox.msgDatabase.GetMsgHdrForKey(IMAPPump.mailbox.uidnext - 1);</span>
<a href="#l19.39"></a><span id="l19.39">   messages.appendElement(msg);</span>
<a href="#l19.40"></a><span id="l19.40">   IMAPPump.server._test = true;</span>
<a href="#l19.41"></a><span id="l19.41">   let listener = new PromiseTestUtils.PromiseCopyListener();</span>
<a href="#l19.42"></a><span id="l19.42">   MailServices.copy.CopyMessages(IMAPPump.inbox, messages, gFolder1, true,</span>
<a href="#l19.43"></a><span id="l19.43">                                  listener, null, false);</span>
<a href="#l19.44"></a><span id="l19.44">   IMAPPump.server.performTest(&quot;UID MOVE&quot;);</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineminus">-  yield listener.promise;</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineplus">+  await listener.promise;</span>
<a href="#l19.47"></a><span id="l19.47"> }</span>
<a href="#l19.48"></a><span id="l19.48"> </span>
<a href="#l19.49"></a><span id="l19.49" class="difflineminus">-function *testMove() {</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineplus">+async function testMove() {</span>
<a href="#l19.51"></a><span id="l19.51">   Assert.equal(IMAPPump.inbox.getTotalMessages(false), 0);</span>
<a href="#l19.52"></a><span id="l19.52">   let listener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l19.53"></a><span id="l19.53">   gFolder1.updateFolderWithListener(null, listener);</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineminus">-  yield listener.promise;</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineplus">+  await listener.promise;</span>
<a href="#l19.56"></a><span id="l19.56">   Assert.equal(gFolder1.getTotalMessages(false), 1);</span>
<a href="#l19.57"></a><span id="l19.57"> </span>
<a href="#l19.58"></a><span id="l19.58">   // maildir should also delete the files.</span>
<a href="#l19.59"></a><span id="l19.59">   if (IMAPPump.inbox.msgStore.storeType == &quot;maildir&quot;)</span>
<a href="#l19.60"></a><span id="l19.60">   {</span>
<a href="#l19.61"></a><span id="l19.61">     let curDir = IMAPPump.inbox.filePath.clone();</span>
<a href="#l19.62"></a><span id="l19.62">     curDir.append(&quot;cur&quot;);</span>
<a href="#l19.63"></a><span id="l19.63">     Assert.ok(curDir.exists());</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapPasswordFailure.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapPasswordFailure.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -52,21 +52,21 @@ function promptPasswordPS(aParent, aDial</span>
<a href="#l20.4"></a><span id="l20.4">   if (attempt == 4) {</span>
<a href="#l20.5"></a><span id="l20.5">     aPassword.value = kValidPassword;</span>
<a href="#l20.6"></a><span id="l20.6">     aCheckState.value = true;</span>
<a href="#l20.7"></a><span id="l20.7">     return true;</span>
<a href="#l20.8"></a><span id="l20.8">   }</span>
<a href="#l20.9"></a><span id="l20.9">   return false;</span>
<a href="#l20.10"></a><span id="l20.10"> }</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-add_task(function *() {</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+add_task(async function () {</span>
<a href="#l20.14"></a><span id="l20.14">   do_test_pending();</span>
<a href="#l20.15"></a><span id="l20.15"> </span>
<a href="#l20.16"></a><span id="l20.16">   // Prepare files for passwords (generated by a script in bug 1018624).</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineminus">-  yield setupForPassword(&quot;signons-mailnews1.8-imap.json&quot;)</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineplus">+  await setupForPassword(&quot;signons-mailnews1.8-imap.json&quot;)</span>
<a href="#l20.19"></a><span id="l20.19"> </span>
<a href="#l20.20"></a><span id="l20.20">   registerAlertTestUtils();</span>
<a href="#l20.21"></a><span id="l20.21"> </span>
<a href="#l20.22"></a><span id="l20.22">   let daemon = new imapDaemon();</span>
<a href="#l20.23"></a><span id="l20.23">   daemon.createMailbox(&quot;Subscribed&quot;, {subscribed : true});</span>
<a href="#l20.24"></a><span id="l20.24">   server = makeServer(daemon, &quot;&quot;, {</span>
<a href="#l20.25"></a><span id="l20.25">     // Make username of server match the singons.txt file</span>
<a href="#l20.26"></a><span id="l20.26">     // (pw there is intentionally invalid)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapProxy.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapProxy.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -5,17 +5,17 @@</span>
<a href="#l21.4"></a><span id="l21.4"> ChromeUtils.import(&quot;resource://testing-common/mailnews/NetworkTestUtils.jsm&quot;);</span>
<a href="#l21.5"></a><span id="l21.5"> ChromeUtils.import(&quot;resource://testing-common/mailnews/PromiseTestUtils.jsm&quot;);</span>
<a href="#l21.6"></a><span id="l21.6"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l21.7"></a><span id="l21.7"> </span>
<a href="#l21.8"></a><span id="l21.8"> var server, daemon, incomingServer;</span>
<a href="#l21.9"></a><span id="l21.9"> </span>
<a href="#l21.10"></a><span id="l21.10"> const PORT = 143;</span>
<a href="#l21.11"></a><span id="l21.11"> </span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-add_task(function* setup() {</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+add_task(async function setup() {</span>
<a href="#l21.14"></a><span id="l21.14">   // Disable new mail notifications</span>
<a href="#l21.15"></a><span id="l21.15">   Services.prefs.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l21.16"></a><span id="l21.16">   Services.prefs.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l21.17"></a><span id="l21.17">   Services.prefs.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l21.18"></a><span id="l21.18">   Services.prefs.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l21.19"></a><span id="l21.19"> </span>
<a href="#l21.20"></a><span id="l21.20">   let daemon = new imapDaemon();</span>
<a href="#l21.21"></a><span id="l21.21">   server = makeServer(daemon, &quot;&quot;);</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineat">@@ -35,33 +35,33 @@ add_task(function* setup() {</span>
<a href="#l21.23"></a><span id="l21.23">   incomingServer = createLocalIMAPServer(PORT, &quot;imap.tinderbox.invalid&quot;);</span>
<a href="#l21.24"></a><span id="l21.24">   let identity = MailServices.accounts.createIdentity();</span>
<a href="#l21.25"></a><span id="l21.25">   let imapAccount = MailServices.accounts.createAccount();</span>
<a href="#l21.26"></a><span id="l21.26">   imapAccount.addIdentity(identity);</span>
<a href="#l21.27"></a><span id="l21.27">   imapAccount.defaultIdentity = identity;</span>
<a href="#l21.28"></a><span id="l21.28">   imapAccount.incomingServer = incomingServer;</span>
<a href="#l21.29"></a><span id="l21.29"> });</span>
<a href="#l21.30"></a><span id="l21.30"> </span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-add_task(function* downloadEmail() {</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineplus">+add_task(async function downloadEmail() {</span>
<a href="#l21.33"></a><span id="l21.33">   let inboxFolder = incomingServer.rootFolder.getChildNamed(&quot;INBOX&quot;);</span>
<a href="#l21.34"></a><span id="l21.34"> </span>
<a href="#l21.35"></a><span id="l21.35">   // Check that we haven't got any messages in the folder, if we have its a test</span>
<a href="#l21.36"></a><span id="l21.36">   // setup issue.</span>
<a href="#l21.37"></a><span id="l21.37">   Assert.equal(inboxFolder.getTotalMessages(false), 0);</span>
<a href="#l21.38"></a><span id="l21.38"> </span>
<a href="#l21.39"></a><span id="l21.39">   // Now get the mail</span>
<a href="#l21.40"></a><span id="l21.40">   let asyncUrlListener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l21.41"></a><span id="l21.41">   inboxFolder.getNewMessages(null, asyncUrlListener);</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineminus">-  yield asyncUrlListener.promise;</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineplus">+  await asyncUrlListener.promise;</span>
<a href="#l21.44"></a><span id="l21.44"> </span>
<a href="#l21.45"></a><span id="l21.45">   // We downloaded a message, so it works!</span>
<a href="#l21.46"></a><span id="l21.46">   Assert.equal(inboxFolder.getTotalMessages(false), 1);</span>
<a href="#l21.47"></a><span id="l21.47"> });</span>
<a href="#l21.48"></a><span id="l21.48"> </span>
<a href="#l21.49"></a><span id="l21.49" class="difflineminus">-add_task(function* cleanUp() {</span>
<a href="#l21.50"></a><span id="l21.50" class="difflineplus">+add_task(async function cleanUp() {</span>
<a href="#l21.51"></a><span id="l21.51">   NetworkTestUtils.shutdownServers();</span>
<a href="#l21.52"></a><span id="l21.52">   incomingServer.closeCachedConnections();</span>
<a href="#l21.53"></a><span id="l21.53">   server.stop();</span>
<a href="#l21.54"></a><span id="l21.54"> });</span>
<a href="#l21.55"></a><span id="l21.55"> </span>
<a href="#l21.56"></a><span id="l21.56"> function run_test() {</span>
<a href="#l21.57"></a><span id="l21.57">   run_next_test();</span>
<a href="#l21.58"></a><span id="l21.58"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/local/test/unit/test_duplicateKey.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_duplicateKey.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -4,24 +4,24 @@</span>
<a href="#l22.4"></a><span id="l22.4"> /**</span>
<a href="#l22.5"></a><span id="l22.5">  * This test deletes intermediate messages, then compacts, then adds more</span>
<a href="#l22.6"></a><span id="l22.6">  * messages, testing for duplicated keys in bug 1202105.</span>
<a href="#l22.7"></a><span id="l22.7">  */</span>
<a href="#l22.8"></a><span id="l22.8"> </span>
<a href="#l22.9"></a><span id="l22.9"> load(&quot;../../../resources/POP3pump.js&quot;);</span>
<a href="#l22.10"></a><span id="l22.10"> ChromeUtils.import(&quot;resource://testing-common/mailnews/PromiseTestUtils.jsm&quot;);</span>
<a href="#l22.11"></a><span id="l22.11"> </span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-add_task(function* runPump() {</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+add_task(async function runPump() {</span>
<a href="#l22.14"></a><span id="l22.14"> </span>
<a href="#l22.15"></a><span id="l22.15">   gPOP3Pump.files = [&quot;../../../data/bugmail1&quot;,</span>
<a href="#l22.16"></a><span id="l22.16">                      &quot;../../../data/bugmail1&quot;,</span>
<a href="#l22.17"></a><span id="l22.17">                      &quot;../../../data/bugmail1&quot;,</span>
<a href="#l22.18"></a><span id="l22.18">                      &quot;../../../data/bugmail1&quot;,</span>
<a href="#l22.19"></a><span id="l22.19">                      &quot;../../../data/bugmail1&quot;];</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineminus">-  yield gPOP3Pump.run();</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineplus">+  await gPOP3Pump.run();</span>
<a href="#l22.22"></a><span id="l22.22"> </span>
<a href="#l22.23"></a><span id="l22.23">   // get message headers for the inbox folder</span>
<a href="#l22.24"></a><span id="l22.24">   var hdrs = showMessages(localAccountUtils.inboxFolder);</span>
<a href="#l22.25"></a><span id="l22.25">   Assert.equal(hdrs.length, 5, &quot;Check initial db count&quot;);</span>
<a href="#l22.26"></a><span id="l22.26"> </span>
<a href="#l22.27"></a><span id="l22.27">   // Deletes 2 middle messages.</span>
<a href="#l22.28"></a><span id="l22.28">   let deletes = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l22.29"></a><span id="l22.29">   deletes.appendElement(hdrs[1]);</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineat">@@ -39,26 +39,26 @@ add_task(function* runPump() {</span>
<a href="#l22.31"></a><span id="l22.31"> </span>
<a href="#l22.32"></a><span id="l22.32">   dump(&quot;Messages after delete\n&quot;);</span>
<a href="#l22.33"></a><span id="l22.33">   hdrs = showMessages(localAccountUtils.inboxFolder);</span>
<a href="#l22.34"></a><span id="l22.34">   Assert.equal(hdrs.length, 3, &quot;Check db length after deleting two messages&quot;);</span>
<a href="#l22.35"></a><span id="l22.35"> </span>
<a href="#l22.36"></a><span id="l22.36">   // compact</span>
<a href="#l22.37"></a><span id="l22.37">   var listener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l22.38"></a><span id="l22.38">   localAccountUtils.inboxFolder.compact(listener, null);</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineminus">-  yield listener.promise;</span>
<a href="#l22.40"></a><span id="l22.40" class="difflineplus">+  await listener.promise;</span>
<a href="#l22.41"></a><span id="l22.41"> </span>
<a href="#l22.42"></a><span id="l22.42">   dump(&quot;Messages after compact\n&quot;);</span>
<a href="#l22.43"></a><span id="l22.43">   hdrs = showMessages(localAccountUtils.inboxFolder);</span>
<a href="#l22.44"></a><span id="l22.44">   Assert.equal(hdrs.length, 3, &quot;Check db length after compact&quot;);</span>
<a href="#l22.45"></a><span id="l22.45"> </span>
<a href="#l22.46"></a><span id="l22.46">   // Add some more messages. This fails in nsMsgDatabase::AddNewHdrToDB with</span>
<a href="#l22.47"></a><span id="l22.47">   // NS_ERROR(&quot;adding hdr that already exists&quot;) before bug 1202105.</span>
<a href="#l22.48"></a><span id="l22.48">   gPOP3Pump.files = [&quot;../../../data/draft1&quot;];</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineminus">-  yield gPOP3Pump.run();</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineplus">+  await gPOP3Pump.run();</span>
<a href="#l22.51"></a><span id="l22.51"> </span>
<a href="#l22.52"></a><span id="l22.52">   dump(&quot;Messages after new message\n&quot;);</span>
<a href="#l22.53"></a><span id="l22.53">   hdrs = showMessages(localAccountUtils.inboxFolder);</span>
<a href="#l22.54"></a><span id="l22.54">   Assert.equal(hdrs.length, 4, &quot;Check db length after adding one message&quot;);</span>
<a href="#l22.55"></a><span id="l22.55"> </span>
<a href="#l22.56"></a><span id="l22.56">   gPOP3Pump = null;</span>
<a href="#l22.57"></a><span id="l22.57"> });</span>
<a href="#l22.58"></a><span id="l22.58"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/local/test/unit/test_movemailDownload.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_movemailDownload.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -58,37 +58,37 @@ var gTestArray = [</span>
<a href="#l23.4"></a><span id="l23.4">     let hdr;</span>
<a href="#l23.5"></a><span id="l23.5">     while (enumerator.hasMoreElements()) {</span>
<a href="#l23.6"></a><span id="l23.6">       let hdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l23.7"></a><span id="l23.7">       gMsgHdrs.push(hdr);</span>
<a href="#l23.8"></a><span id="l23.8">       Assert.equal(hdr.subject, testSubjects[msgCount++]);</span>
<a href="#l23.9"></a><span id="l23.9">     }</span>
<a href="#l23.10"></a><span id="l23.10">     Assert.equal(msgCount, 3);</span>
<a href="#l23.11"></a><span id="l23.11">   },</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-  function *streamMessages() {</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+  async function streamMessages() {</span>
<a href="#l23.14"></a><span id="l23.14">     for (let msgHdr of gMsgHdrs)</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineminus">-      yield streamNextMessage(msgHdr);</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineplus">+      await streamNextMessage(msgHdr);</span>
<a href="#l23.17"></a><span id="l23.17">   }</span>
<a href="#l23.18"></a><span id="l23.18"> ];</span>
<a href="#l23.19"></a><span id="l23.19"> </span>
<a href="#l23.20"></a><span id="l23.20"> function run_test()</span>
<a href="#l23.21"></a><span id="l23.21"> {</span>
<a href="#l23.22"></a><span id="l23.22">   let hostName = &quot;movemail&quot;;</span>
<a href="#l23.23"></a><span id="l23.23">   for (let index = 0; index &lt; localAccountUtils.pluggableStores.length; index++) {</span>
<a href="#l23.24"></a><span id="l23.24">     add_task(setup(localAccountUtils.pluggableStores[index],</span>
<a href="#l23.25"></a><span id="l23.25">                    hostName + &quot;-&quot; + index));</span>
<a href="#l23.26"></a><span id="l23.26">     gTestArray.forEach(x =&gt; add_task(x));</span>
<a href="#l23.27"></a><span id="l23.27">   }</span>
<a href="#l23.28"></a><span id="l23.28"> </span>
<a href="#l23.29"></a><span id="l23.29">   run_next_test();</span>
<a href="#l23.30"></a><span id="l23.30"> }</span>
<a href="#l23.31"></a><span id="l23.31"> </span>
<a href="#l23.32"></a><span id="l23.32" class="difflineminus">-var streamNextMessage = Task.async(function* (aMsgHdr) {</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineplus">+var streamNextMessage = async function (aMsgHdr) {</span>
<a href="#l23.34"></a><span id="l23.34">   let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l23.35"></a><span id="l23.35">   let msgURI = aMsgHdr.folder.getUriForMsg(aMsgHdr);</span>
<a href="#l23.36"></a><span id="l23.36">   dump(&quot;streaming msg &quot; + msgURI + &quot; store token = &quot; +</span>
<a href="#l23.37"></a><span id="l23.37">        aMsgHdr.getStringProperty(&quot;storeToken&quot;));</span>
<a href="#l23.38"></a><span id="l23.38">   let msgServ = messenger.messageServiceFromURI(msgURI);</span>
<a href="#l23.39"></a><span id="l23.39">   let streamListener = new PromiseTestUtils.PromiseStreamListener();</span>
<a href="#l23.40"></a><span id="l23.40">   msgServ.streamMessage(msgURI, streamListener, null, null, false, &quot;&quot;, true);</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineminus">-  let data = yield streamListener.promise;</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineplus">+  let data = await streamListener.promise;</span>
<a href="#l23.43"></a><span id="l23.43">   Assert.ok(data.startsWith(&quot;From &quot;));</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineminus">-});</span>
<a href="#l23.45"></a><span id="l23.45" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3MultiCopy.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3MultiCopy.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -9,29 +9,29 @@ load(&quot;../../../resources/POP3pump.js&quot;);</span>
<a href="#l24.4"></a><span id="l24.4"> ChromeUtils.import(&quot;resource://testing-common/mailnews/PromiseTestUtils.jsm&quot;);</span>
<a href="#l24.5"></a><span id="l24.5"> </span>
<a href="#l24.6"></a><span id="l24.6"> var testSubjects = [&quot;[Bug 397009] A filter will let me tag, but not untag&quot;,</span>
<a href="#l24.7"></a><span id="l24.7">                     &quot;Hello, did you receive my bugmail?&quot;];</span>
<a href="#l24.8"></a><span id="l24.8"> </span>
<a href="#l24.9"></a><span id="l24.9"> Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;,</span>
<a href="#l24.10"></a><span id="l24.10">                            &quot;@mozilla.org/msgstore/maildirstore;1&quot;);</span>
<a href="#l24.11"></a><span id="l24.11"> </span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-add_task(function* runPump() {</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+add_task(async function runPump() {</span>
<a href="#l24.14"></a><span id="l24.14">   // Test for multiple message copy for maildir.</span>
<a href="#l24.15"></a><span id="l24.15">   let storeID = &quot;@mozilla.org/msgstore/maildirstore;1&quot;;</span>
<a href="#l24.16"></a><span id="l24.16">   gPOP3Pump.resetPluggableStore(storeID);</span>
<a href="#l24.17"></a><span id="l24.17">   // Set the default mailbox store.</span>
<a href="#l24.18"></a><span id="l24.18">   Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;, storeID);</span>
<a href="#l24.19"></a><span id="l24.19"> </span>
<a href="#l24.20"></a><span id="l24.20">   // We want to test cross-server copy, so don't defer.</span>
<a href="#l24.21"></a><span id="l24.21">   gPOP3Pump.fakeServer.deferredToAccount = &quot;&quot;;</span>
<a href="#l24.22"></a><span id="l24.22"> </span>
<a href="#l24.23"></a><span id="l24.23">   gPOP3Pump.files = [&quot;../../../data/bugmail1&quot;,</span>
<a href="#l24.24"></a><span id="l24.24">                      &quot;../../../data/draft1&quot;];</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineminus">-  yield gPOP3Pump.run();</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineplus">+  await gPOP3Pump.run();</span>
<a href="#l24.27"></a><span id="l24.27"> </span>
<a href="#l24.28"></a><span id="l24.28">   // get message headers for the inbox folder</span>
<a href="#l24.29"></a><span id="l24.29">   let inbox = gPOP3Pump.fakeServer</span>
<a href="#l24.30"></a><span id="l24.30">                        .rootMsgFolder</span>
<a href="#l24.31"></a><span id="l24.31">                        .getFolderWithFlags(Ci.nsMsgFolderFlags.Inbox);</span>
<a href="#l24.32"></a><span id="l24.32">   dump(&quot;inbox is at &quot; + inbox.filePath.path + &quot;\n&quot;);</span>
<a href="#l24.33"></a><span id="l24.33"> </span>
<a href="#l24.34"></a><span id="l24.34">   // Accumulate messages to copy.</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineat">@@ -51,17 +51,17 @@ add_task(function* runPump() {</span>
<a href="#l24.36"></a><span id="l24.36">                                     .QueryInterface(Ci.nsIMsgLocalMailFolder)</span>
<a href="#l24.37"></a><span id="l24.37">                                     .createLocalSubfolder(&quot;test&quot;);</span>
<a href="#l24.38"></a><span id="l24.38">   dump(&quot;testFolder is at &quot; + testFolder.filePath.path + &quot;\n&quot;);</span>
<a href="#l24.39"></a><span id="l24.39"> </span>
<a href="#l24.40"></a><span id="l24.40">   // Copy messages to that folder.</span>
<a href="#l24.41"></a><span id="l24.41">   let promiseCopyListener = new PromiseTestUtils.PromiseCopyListener();</span>
<a href="#l24.42"></a><span id="l24.42">   MailServices.copy.CopyMessages(inbox, messages, testFolder, false,</span>
<a href="#l24.43"></a><span id="l24.43">                                  promiseCopyListener, null, false);</span>
<a href="#l24.44"></a><span id="l24.44" class="difflineminus">-  yield promiseCopyListener.promise;</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineplus">+  await promiseCopyListener.promise;</span>
<a href="#l24.46"></a><span id="l24.46"> </span>
<a href="#l24.47"></a><span id="l24.47">   // Check the destination headers.</span>
<a href="#l24.48"></a><span id="l24.48">   messages.clear();</span>
<a href="#l24.49"></a><span id="l24.49">   enumerator = testFolder.msgDatabase.EnumerateMessages();</span>
<a href="#l24.50"></a><span id="l24.50">   msgCount = 0;</span>
<a href="#l24.51"></a><span id="l24.51">   let subjects = [];</span>
<a href="#l24.52"></a><span id="l24.52">   while (enumerator.hasMoreElements()) {</span>
<a href="#l24.53"></a><span id="l24.53">     msgCount++;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3MultiCopy2.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3MultiCopy2.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -14,32 +14,32 @@ Services.prefs.setCharPref(&quot;mail.serverD</span>
<a href="#l25.4"></a><span id="l25.4"> </span>
<a href="#l25.5"></a><span id="l25.5"> var gInboxFolder, gTestFolder;</span>
<a href="#l25.6"></a><span id="l25.6"> </span>
<a href="#l25.7"></a><span id="l25.7"> gPOP3Pump.files = [&quot;../../../data/bugmail1&quot;,</span>
<a href="#l25.8"></a><span id="l25.8">                    &quot;../../../data/draft1&quot;];</span>
<a href="#l25.9"></a><span id="l25.9"> var gTestSubjects = [&quot;[Bug 397009] A filter will let me tag, but not untag&quot;,</span>
<a href="#l25.10"></a><span id="l25.10">                      &quot;Hello, did you receive my bugmail?&quot;];</span>
<a href="#l25.11"></a><span id="l25.11"> </span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-add_task(function* setupFolders() {</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+add_task(async function setupFolders() {</span>
<a href="#l25.14"></a><span id="l25.14">   let storeID = &quot;@mozilla.org/msgstore/maildirstore;1&quot;;</span>
<a href="#l25.15"></a><span id="l25.15">   resetPluggableStoreLocal(storeID);</span>
<a href="#l25.16"></a><span id="l25.16"> </span>
<a href="#l25.17"></a><span id="l25.17">   // We want to test cross-server copy, so don't defer.</span>
<a href="#l25.18"></a><span id="l25.18">   gPOP3Pump.fakeServer.deferredToAccount = &quot;&quot;;</span>
<a href="#l25.19"></a><span id="l25.19"> </span>
<a href="#l25.20"></a><span id="l25.20">   // Create a test folder on the Local Folders account.</span>
<a href="#l25.21"></a><span id="l25.21">   gTestFolder = localAccountUtils.rootFolder</span>
<a href="#l25.22"></a><span id="l25.22">                                  .QueryInterface(Ci.nsIMsgLocalMailFolder)</span>
<a href="#l25.23"></a><span id="l25.23">                                  .createLocalSubfolder(&quot;test&quot;);</span>
<a href="#l25.24"></a><span id="l25.24">   dump(&quot;testFolder is at &quot; + gTestFolder.filePath.path + &quot;\n&quot;);</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineminus">-  yield gPOP3Pump.run();</span>
<a href="#l25.26"></a><span id="l25.26" class="difflineplus">+  await gPOP3Pump.run();</span>
<a href="#l25.27"></a><span id="l25.27"> });</span>
<a href="#l25.28"></a><span id="l25.28"> </span>
<a href="#l25.29"></a><span id="l25.29" class="difflineminus">-add_task(function* maildirToMbox() {</span>
<a href="#l25.30"></a><span id="l25.30" class="difflineplus">+add_task(async function maildirToMbox() {</span>
<a href="#l25.31"></a><span id="l25.31">   // Test for multiple message copy for maildir-&gt;mbox.</span>
<a href="#l25.32"></a><span id="l25.32"> </span>
<a href="#l25.33"></a><span id="l25.33">   // get message headers for the inbox folder</span>
<a href="#l25.34"></a><span id="l25.34">   gInboxFolder = gPOP3Pump.fakeServer</span>
<a href="#l25.35"></a><span id="l25.35">                           .rootMsgFolder</span>
<a href="#l25.36"></a><span id="l25.36">                           .getFolderWithFlags(Ci.nsMsgFolderFlags.Inbox);</span>
<a href="#l25.37"></a><span id="l25.37">   dump(&quot;inbox is at &quot; + gInboxFolder.filePath.path + &quot;\n&quot;);</span>
<a href="#l25.38"></a><span id="l25.38"> </span>
<a href="#l25.39"></a><span id="l25.39" class="difflineat">@@ -51,17 +51,17 @@ add_task(function* maildirToMbox() {</span>
<a href="#l25.40"></a><span id="l25.40">     messages.appendElement(hdr);</span>
<a href="#l25.41"></a><span id="l25.41">   }</span>
<a href="#l25.42"></a><span id="l25.42">   Assert.equal(messages.length, 2);</span>
<a href="#l25.43"></a><span id="l25.43"> </span>
<a href="#l25.44"></a><span id="l25.44">   // Move messages to mbox test folder.</span>
<a href="#l25.45"></a><span id="l25.45">   let promiseCopyListener = new PromiseTestUtils.PromiseCopyListener();</span>
<a href="#l25.46"></a><span id="l25.46">   MailServices.copy.CopyMessages(gInboxFolder, messages, gTestFolder, true,</span>
<a href="#l25.47"></a><span id="l25.47">                                  promiseCopyListener, null, false);</span>
<a href="#l25.48"></a><span id="l25.48" class="difflineminus">-  yield promiseCopyListener.promise;</span>
<a href="#l25.49"></a><span id="l25.49" class="difflineplus">+  await promiseCopyListener.promise;</span>
<a href="#l25.50"></a><span id="l25.50"> </span>
<a href="#l25.51"></a><span id="l25.51">   // Check the destination headers.</span>
<a href="#l25.52"></a><span id="l25.52">   messages.clear();</span>
<a href="#l25.53"></a><span id="l25.53">   enumerator = gTestFolder.msgDatabase.EnumerateMessages();</span>
<a href="#l25.54"></a><span id="l25.54">   let subjects = [];</span>
<a href="#l25.55"></a><span id="l25.55">   while (enumerator.hasMoreElements()) {</span>
<a href="#l25.56"></a><span id="l25.56">     let hdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l25.57"></a><span id="l25.57">     messages.appendElement(hdr);</span>
<a href="#l25.58"></a><span id="l25.58" class="difflineat">@@ -83,33 +83,33 @@ add_task(function* maildirToMbox() {</span>
<a href="#l25.59"></a><span id="l25.59">   enumerator = gTestFolder.msgDatabase.EnumerateMessages();</span>
<a href="#l25.60"></a><span id="l25.60">   while (enumerator.hasMoreElements()) {</span>
<a href="#l25.61"></a><span id="l25.61">     let hdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l25.62"></a><span id="l25.62">     let body = mailTestUtils.loadMessageToString(gTestFolder, hdr);</span>
<a href="#l25.63"></a><span id="l25.63">     Assert.ok(body.indexOf(hdr.subject) &gt;= 0);</span>
<a href="#l25.64"></a><span id="l25.64">   }</span>
<a href="#l25.65"></a><span id="l25.65"> });</span>
<a href="#l25.66"></a><span id="l25.66"> </span>
<a href="#l25.67"></a><span id="l25.67" class="difflineminus">-add_task(function* mboxToMaildir() {</span>
<a href="#l25.68"></a><span id="l25.68" class="difflineplus">+add_task(async function mboxToMaildir() {</span>
<a href="#l25.69"></a><span id="l25.69">   // Test for multiple message copy for mbox-&gt;maildir.</span>
<a href="#l25.70"></a><span id="l25.70"> </span>
<a href="#l25.71"></a><span id="l25.71">   // Accumulate messages to copy.</span>
<a href="#l25.72"></a><span id="l25.72">   let messages = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l25.73"></a><span id="l25.73">   let enumerator = gTestFolder.msgDatabase.EnumerateMessages();</span>
<a href="#l25.74"></a><span id="l25.74">   while (enumerator.hasMoreElements()) {</span>
<a href="#l25.75"></a><span id="l25.75">     let hdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l25.76"></a><span id="l25.76">     messages.appendElement(hdr);</span>
<a href="#l25.77"></a><span id="l25.77">   }</span>
<a href="#l25.78"></a><span id="l25.78">   Assert.equal(messages.length, 2);</span>
<a href="#l25.79"></a><span id="l25.79"> </span>
<a href="#l25.80"></a><span id="l25.80">   // Move messages to inbox folder.</span>
<a href="#l25.81"></a><span id="l25.81">   let promiseCopyListener = new PromiseTestUtils.PromiseCopyListener();</span>
<a href="#l25.82"></a><span id="l25.82">   MailServices.copy.CopyMessages(gTestFolder, messages, gInboxFolder, true,</span>
<a href="#l25.83"></a><span id="l25.83">                                  promiseCopyListener, null, false);</span>
<a href="#l25.84"></a><span id="l25.84" class="difflineminus">-  yield promiseCopyListener.promise;</span>
<a href="#l25.85"></a><span id="l25.85" class="difflineplus">+  await promiseCopyListener.promise;</span>
<a href="#l25.86"></a><span id="l25.86"> </span>
<a href="#l25.87"></a><span id="l25.87">   // Check the destination headers.</span>
<a href="#l25.88"></a><span id="l25.88">   messages.clear();</span>
<a href="#l25.89"></a><span id="l25.89">   enumerator = gInboxFolder.msgDatabase.EnumerateMessages();</span>
<a href="#l25.90"></a><span id="l25.90">   let subjects = [];</span>
<a href="#l25.91"></a><span id="l25.91">   while (enumerator.hasMoreElements()) {</span>
<a href="#l25.92"></a><span id="l25.92">     let hdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l25.93"></a><span id="l25.93">     messages.appendElement(hdr);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3Password.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3Password.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -100,25 +100,25 @@ function testNext() {</span>
<a href="#l26.4"></a><span id="l26.4">     do_throw(e);</span>
<a href="#l26.5"></a><span id="l26.5">   } finally {</span>
<a href="#l26.6"></a><span id="l26.6">     var thread = gThreadManager.currentThread;</span>
<a href="#l26.7"></a><span id="l26.7">     while (thread.hasPendingEvents())</span>
<a href="#l26.8"></a><span id="l26.8">       thread.processNextEvent(true);</span>
<a href="#l26.9"></a><span id="l26.9">   }</span>
<a href="#l26.10"></a><span id="l26.10"> }</span>
<a href="#l26.11"></a><span id="l26.11"> </span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-add_task(function *() {</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+add_task(async function () {</span>
<a href="#l26.14"></a><span id="l26.14">   // Disable new mail notifications</span>
<a href="#l26.15"></a><span id="l26.15">   Services.prefs.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l26.16"></a><span id="l26.16">   Services.prefs.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l26.17"></a><span id="l26.17">   Services.prefs.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l26.18"></a><span id="l26.18">   Services.prefs.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l26.19"></a><span id="l26.19"> </span>
<a href="#l26.20"></a><span id="l26.20">   // Prepare files for passwords (generated by a script in bug 1018624).</span>
<a href="#l26.21"></a><span id="l26.21" class="difflineminus">-  yield setupForPassword(&quot;signons-mailnews1.8.json&quot;);</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineplus">+  await setupForPassword(&quot;signons-mailnews1.8.json&quot;);</span>
<a href="#l26.23"></a><span id="l26.23"> </span>
<a href="#l26.24"></a><span id="l26.24">   // Set up the Server</span>
<a href="#l26.25"></a><span id="l26.25">   var serverArray = setupServerDaemon();</span>
<a href="#l26.26"></a><span id="l26.26">   daemon = serverArray[0];</span>
<a href="#l26.27"></a><span id="l26.27">   server = serverArray[1];</span>
<a href="#l26.28"></a><span id="l26.28">   var handler = serverArray[2];</span>
<a href="#l26.29"></a><span id="l26.29">   server.start();</span>
<a href="#l26.30"></a><span id="l26.30"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3Password2.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3Password2.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -102,17 +102,17 @@ function testNext() {</span>
<a href="#l27.4"></a><span id="l27.4">     do_throw(e);</span>
<a href="#l27.5"></a><span id="l27.5">   } finally {</span>
<a href="#l27.6"></a><span id="l27.6">     var thread = gThreadManager.currentThread;</span>
<a href="#l27.7"></a><span id="l27.7">     while (thread.hasPendingEvents())</span>
<a href="#l27.8"></a><span id="l27.8">       thread.processNextEvent(true);</span>
<a href="#l27.9"></a><span id="l27.9">   }</span>
<a href="#l27.10"></a><span id="l27.10"> }</span>
<a href="#l27.11"></a><span id="l27.11"> </span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-add_task(function *() {</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+add_task(async function () {</span>
<a href="#l27.14"></a><span id="l27.14">   // Disable new mail notifications</span>
<a href="#l27.15"></a><span id="l27.15">   Services.prefs.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l27.16"></a><span id="l27.16">   Services.prefs.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l27.17"></a><span id="l27.17">   Services.prefs.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l27.18"></a><span id="l27.18">   Services.prefs.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l27.19"></a><span id="l27.19"> </span>
<a href="#l27.20"></a><span id="l27.20">   // These preferences set up a local pop server that has had its hostname</span>
<a href="#l27.21"></a><span id="l27.21">   // and username changed from the original settings. We can't do this by</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineat">@@ -136,17 +136,17 @@ add_task(function *() {</span>
<a href="#l27.23"></a><span id="l27.23">   Services.prefs.setCharPref(&quot;mail.server.server2.hostname&quot;, &quot;invalid&quot;);</span>
<a href="#l27.24"></a><span id="l27.24">   Services.prefs.setCharPref(&quot;mail.server.server2.name&quot;, &quot;testpop3 on localhost&quot;);</span>
<a href="#l27.25"></a><span id="l27.25">   Services.prefs.setCharPref(&quot;mail.server.server2.realhostname&quot;, &quot;localhost&quot;);</span>
<a href="#l27.26"></a><span id="l27.26">   Services.prefs.setCharPref(&quot;mail.server.server2.realuserName&quot;, &quot;testpop3&quot;);</span>
<a href="#l27.27"></a><span id="l27.27">   Services.prefs.setCharPref(&quot;mail.server.server2.type&quot;, &quot;pop3&quot;);</span>
<a href="#l27.28"></a><span id="l27.28">   Services.prefs.setCharPref(&quot;mail.server.server2.userName&quot;, &quot;othername&quot;);</span>
<a href="#l27.29"></a><span id="l27.29"> </span>
<a href="#l27.30"></a><span id="l27.30">   // Prepare files for passwords (generated by a script in bug 1018624).</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineminus">-  yield setupForPassword(&quot;signons-mailnews1.8-alt.json&quot;);</span>
<a href="#l27.32"></a><span id="l27.32" class="difflineplus">+  await setupForPassword(&quot;signons-mailnews1.8-alt.json&quot;);</span>
<a href="#l27.33"></a><span id="l27.33"> </span>
<a href="#l27.34"></a><span id="l27.34">   // Set up the Server</span>
<a href="#l27.35"></a><span id="l27.35">   var serverArray = setupServerDaemon();</span>
<a href="#l27.36"></a><span id="l27.36">   daemon = serverArray[0];</span>
<a href="#l27.37"></a><span id="l27.37">   server = serverArray[1];</span>
<a href="#l27.38"></a><span id="l27.38">   var handler = serverArray[2];</span>
<a href="#l27.39"></a><span id="l27.39">   server.start();</span>
<a href="#l27.40"></a><span id="l27.40">   Services.prefs.setIntPref(&quot;mail.server.server2.port&quot;, server.port);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3Password3.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3Password3.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -9,19 +9,19 @@ ChromeUtils.import(&quot;resource://gre/modul</span>
<a href="#l28.4"></a><span id="l28.4"> load(&quot;../../../resources/passwordStorage.js&quot;);</span>
<a href="#l28.5"></a><span id="l28.5"> </span>
<a href="#l28.6"></a><span id="l28.6"> var kUser1 = &quot;testpop3&quot;;</span>
<a href="#l28.7"></a><span id="l28.7"> var kUser2 = &quot;testpop3a&quot;;</span>
<a href="#l28.8"></a><span id="l28.8"> var kProtocol = &quot;pop3&quot;;</span>
<a href="#l28.9"></a><span id="l28.9"> var kHostname = &quot;localhost&quot;;</span>
<a href="#l28.10"></a><span id="l28.10"> var kServerUrl = &quot;mailbox://&quot; + kHostname;</span>
<a href="#l28.11"></a><span id="l28.11"> </span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-add_task(function *() {</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+add_task(async function () {</span>
<a href="#l28.14"></a><span id="l28.14">   // Prepare files for passwords (generated by a script in bug 1018624).</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineminus">-  yield setupForPassword(&quot;signons-mailnews1.8-multiple.json&quot;);</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineplus">+  await setupForPassword(&quot;signons-mailnews1.8-multiple.json&quot;);</span>
<a href="#l28.17"></a><span id="l28.17"> </span>
<a href="#l28.18"></a><span id="l28.18">   // Set up the basic accounts and folders.</span>
<a href="#l28.19"></a><span id="l28.19">   // We would use createPop3ServerAndLocalFolders() however we want to have</span>
<a href="#l28.20"></a><span id="l28.20">   // a different username and NO password for this test (as we expect to load</span>
<a href="#l28.21"></a><span id="l28.21">   // it from the signons json file in which the login information is stored).</span>
<a href="#l28.22"></a><span id="l28.22">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l28.23"></a><span id="l28.23"> </span>
<a href="#l28.24"></a><span id="l28.24">   let incomingServer1 = MailServices.accounts.createIncomingServer(kUser1, kHostname,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3PasswordFailure.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3PasswordFailure.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -169,26 +169,26 @@ function* getMail2()</span>
<a href="#l29.4"></a><span id="l29.4">   yield true;</span>
<a href="#l29.5"></a><span id="l29.5"> }</span>
<a href="#l29.6"></a><span id="l29.6"> </span>
<a href="#l29.7"></a><span id="l29.7"> function* end_test()</span>
<a href="#l29.8"></a><span id="l29.8"> {</span>
<a href="#l29.9"></a><span id="l29.9">   do_test_finished();</span>
<a href="#l29.10"></a><span id="l29.10"> }</span>
<a href="#l29.11"></a><span id="l29.11"> </span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-add_task(function *() {</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+add_task(async function () {</span>
<a href="#l29.14"></a><span id="l29.14">   // Disable new mail notifications</span>
<a href="#l29.15"></a><span id="l29.15">   Services.prefs.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l29.16"></a><span id="l29.16">   Services.prefs.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l29.17"></a><span id="l29.17">   Services.prefs.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l29.18"></a><span id="l29.18">   Services.prefs.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l29.19"></a><span id="l29.19">   Services.prefs.setBoolPref(&quot;signon.debug&quot;, true);</span>
<a href="#l29.20"></a><span id="l29.20"> </span>
<a href="#l29.21"></a><span id="l29.21">   // Prepare files for passwords (generated by a script in bug 1018624).</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineminus">-  yield setupForPassword(&quot;signons-mailnews1.8.json&quot;);</span>
<a href="#l29.23"></a><span id="l29.23" class="difflineplus">+  await setupForPassword(&quot;signons-mailnews1.8.json&quot;);</span>
<a href="#l29.24"></a><span id="l29.24"> </span>
<a href="#l29.25"></a><span id="l29.25">   registerAlertTestUtils();</span>
<a href="#l29.26"></a><span id="l29.26"> </span>
<a href="#l29.27"></a><span id="l29.27">   // Set up the Server</span>
<a href="#l29.28"></a><span id="l29.28">   var serverArray = setupServerDaemon();</span>
<a href="#l29.29"></a><span id="l29.29">   daemon = serverArray[0];</span>
<a href="#l29.30"></a><span id="l29.30">   server = serverArray[1];</span>
<a href="#l29.31"></a><span id="l29.31">   var handler = serverArray[2];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3Proxy.js</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3Proxy.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -4,17 +4,17 @@</span>
<a href="#l30.4"></a><span id="l30.4"> </span>
<a href="#l30.5"></a><span id="l30.5"> ChromeUtils.import(&quot;resource://testing-common/mailnews/NetworkTestUtils.jsm&quot;);</span>
<a href="#l30.6"></a><span id="l30.6"> ChromeUtils.import(&quot;resource://testing-common/mailnews/PromiseTestUtils.jsm&quot;);</span>
<a href="#l30.7"></a><span id="l30.7"> </span>
<a href="#l30.8"></a><span id="l30.8"> const PORT = 110;</span>
<a href="#l30.9"></a><span id="l30.9"> </span>
<a href="#l30.10"></a><span id="l30.10"> var server, daemon, incomingServer;</span>
<a href="#l30.11"></a><span id="l30.11"> </span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-add_task(function* setup() {</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+add_task(async function setup() {</span>
<a href="#l30.14"></a><span id="l30.14">   // Disable new mail notifications</span>
<a href="#l30.15"></a><span id="l30.15">   Services.prefs.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l30.16"></a><span id="l30.16">   Services.prefs.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l30.17"></a><span id="l30.17">   Services.prefs.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l30.18"></a><span id="l30.18">   Services.prefs.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l30.19"></a><span id="l30.19"> </span>
<a href="#l30.20"></a><span id="l30.20">   [daemon, server] = setupServerDaemon();</span>
<a href="#l30.21"></a><span id="l30.21">   server.start();</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineat">@@ -22,32 +22,32 @@ add_task(function* setup() {</span>
<a href="#l30.23"></a><span id="l30.23"> </span>
<a href="#l30.24"></a><span id="l30.24">   // Set up the basic accounts and folders</span>
<a href="#l30.25"></a><span id="l30.25">   incomingServer = createPop3ServerAndLocalFolders(PORT, &quot;pop.tinderbox.invalid&quot;);</span>
<a href="#l30.26"></a><span id="l30.26"> </span>
<a href="#l30.27"></a><span id="l30.27">   // Add a message to download</span>
<a href="#l30.28"></a><span id="l30.28">   daemon.setMessages([&quot;message1.eml&quot;]);</span>
<a href="#l30.29"></a><span id="l30.29"> });</span>
<a href="#l30.30"></a><span id="l30.30"> </span>
<a href="#l30.31"></a><span id="l30.31" class="difflineminus">-add_task(function* downloadEmail() {</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineplus">+add_task(async function downloadEmail() {</span>
<a href="#l30.33"></a><span id="l30.33">   // Check that we haven't got any messages in the folder, if we have its a test</span>
<a href="#l30.34"></a><span id="l30.34">   // setup issue.</span>
<a href="#l30.35"></a><span id="l30.35">   equal(localAccountUtils.inboxFolder.getTotalMessages(false), 0);</span>
<a href="#l30.36"></a><span id="l30.36"> </span>
<a href="#l30.37"></a><span id="l30.37">   // Now get the mail</span>
<a href="#l30.38"></a><span id="l30.38">   let urlListener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l30.39"></a><span id="l30.39">   MailServices.pop3.GetNewMail(null, urlListener, localAccountUtils.inboxFolder,</span>
<a href="#l30.40"></a><span id="l30.40">                                incomingServer);</span>
<a href="#l30.41"></a><span id="l30.41" class="difflineminus">-  yield urlListener.promise;</span>
<a href="#l30.42"></a><span id="l30.42" class="difflineplus">+  await urlListener.promise;</span>
<a href="#l30.43"></a><span id="l30.43"> </span>
<a href="#l30.44"></a><span id="l30.44">   // We downloaded a message, so it works!</span>
<a href="#l30.45"></a><span id="l30.45">   equal(localAccountUtils.inboxFolder.getTotalMessages(false), 1);</span>
<a href="#l30.46"></a><span id="l30.46"> });</span>
<a href="#l30.47"></a><span id="l30.47"> </span>
<a href="#l30.48"></a><span id="l30.48" class="difflineminus">-add_task(function* cleanUp() {</span>
<a href="#l30.49"></a><span id="l30.49" class="difflineplus">+add_task(async function cleanUp() {</span>
<a href="#l30.50"></a><span id="l30.50">   NetworkTestUtils.shutdownServers();</span>
<a href="#l30.51"></a><span id="l30.51">   incomingServer.closeCachedConnections();</span>
<a href="#l30.52"></a><span id="l30.52">   server.stop();</span>
<a href="#l30.53"></a><span id="l30.53"> });</span>
<a href="#l30.54"></a><span id="l30.54"> </span>
<a href="#l30.55"></a><span id="l30.55"> function run_test() {</span>
<a href="#l30.56"></a><span id="l30.56">   run_next_test();</span>
<a href="#l30.57"></a><span id="l30.57"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3Pump.js</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3Pump.js</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -2,25 +2,25 @@</span>
<a href="#l31.4"></a><span id="l31.4">  * The intent of this file is to demonstrate a minimal</span>
<a href="#l31.5"></a><span id="l31.5">  * POP3 unit test using the testing file POP3Pump.js</span>
<a href="#l31.6"></a><span id="l31.6">  */</span>
<a href="#l31.7"></a><span id="l31.7"> load(&quot;../../../resources/POP3pump.js&quot;);</span>
<a href="#l31.8"></a><span id="l31.8"> </span>
<a href="#l31.9"></a><span id="l31.9"> var testSubjects = [&quot;[Bug 397009] A filter will let me tag, but not untag&quot;,</span>
<a href="#l31.10"></a><span id="l31.10">                     &quot;Hello, did you receive my bugmail?&quot;];</span>
<a href="#l31.11"></a><span id="l31.11"> </span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-add_task(function* runPump() {</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+add_task(async function runPump() {</span>
<a href="#l31.14"></a><span id="l31.14">   // demonstration of access to the local inbox folder</span>
<a href="#l31.15"></a><span id="l31.15">   dump(&quot;local inbox folder &quot; + localAccountUtils.inboxFolder.URI + &quot; is loaded\n&quot;);</span>
<a href="#l31.16"></a><span id="l31.16">   // demonstration of access to the fake server</span>
<a href="#l31.17"></a><span id="l31.17">   dump(&quot;Server &quot; + gPOP3Pump.fakeServer.prettyName + &quot; is loaded\n&quot;);</span>
<a href="#l31.18"></a><span id="l31.18"> </span>
<a href="#l31.19"></a><span id="l31.19">   gPOP3Pump.files = [&quot;../../../data/bugmail1&quot;,</span>
<a href="#l31.20"></a><span id="l31.20">                       &quot;../../../data/draft1&quot;];</span>
<a href="#l31.21"></a><span id="l31.21" class="difflineminus">-  yield gPOP3Pump.run();</span>
<a href="#l31.22"></a><span id="l31.22" class="difflineplus">+  await gPOP3Pump.run();</span>
<a href="#l31.23"></a><span id="l31.23"> </span>
<a href="#l31.24"></a><span id="l31.24">   // get message headers for the inbox folder</span>
<a href="#l31.25"></a><span id="l31.25">   let enumerator = localAccountUtils.inboxFolder.msgDatabase.EnumerateMessages();</span>
<a href="#l31.26"></a><span id="l31.26">   var msgCount = 0;</span>
<a href="#l31.27"></a><span id="l31.27">   while (enumerator.hasMoreElements()) {</span>
<a href="#l31.28"></a><span id="l31.28">     msgCount++;</span>
<a href="#l31.29"></a><span id="l31.29">     let hdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l31.30"></a><span id="l31.30">     Assert.equal(hdr.subject, testSubjects[msgCount - 1]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/mime/test/unit/test_structured_headers.js</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/mime/test/unit/test_structured_headers.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -16,17 +16,17 @@ function verifyError(block, errorCode) {</span>
<a href="#l32.4"></a><span id="l32.4">     caught = actual.result;</span>
<a href="#l32.5"></a><span id="l32.5">   }</span>
<a href="#l32.6"></a><span id="l32.6">   Assert.equal(caught, errorCode);</span>
<a href="#l32.7"></a><span id="l32.7"> }</span>
<a href="#l32.8"></a><span id="l32.8"> </span>
<a href="#l32.9"></a><span id="l32.9"> var StructuredHeaders = CC(&quot;@mozilla.org/messenger/structuredheaders;1&quot;,</span>
<a href="#l32.10"></a><span id="l32.10">                            Ci.msgIWritableStructuredHeaders);</span>
<a href="#l32.11"></a><span id="l32.11"> </span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-add_task(function* check_addressing() {</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineplus">+add_task(async function check_addressing() {</span>
<a href="#l32.14"></a><span id="l32.14">   let headers = new StructuredHeaders();</span>
<a href="#l32.15"></a><span id="l32.15">   headers.setHeader(&quot;To&quot;, [{name: &quot;undisclosed-recipients&quot;, group: []}]);</span>
<a href="#l32.16"></a><span id="l32.16">   Assert.ok(Array.isArray(headers.getHeader(&quot;To&quot;)));</span>
<a href="#l32.17"></a><span id="l32.17">   let flat = headers.getAddressingHeader(&quot;To&quot;, false);</span>
<a href="#l32.18"></a><span id="l32.18">   Assert.ok(Array.isArray(flat));</span>
<a href="#l32.19"></a><span id="l32.19">   Assert.equal(flat.length, 0);</span>
<a href="#l32.20"></a><span id="l32.20">   let full = headers.getAddressingHeader(&quot;To&quot;, true);</span>
<a href="#l32.21"></a><span id="l32.21">   Assert.ok(Array.isArray(full));</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineat">@@ -39,41 +39,41 @@ add_task(function* check_addressing() {</span>
<a href="#l32.23"></a><span id="l32.23">   Assert.equal(headers.getRawHeader(&quot;To&quot;),</span>
<a href="#l32.24"></a><span id="l32.24">     &quot;=?UTF-8?B?w5M=?= &lt;test@foo.invalid&gt;&quot;);</span>
<a href="#l32.25"></a><span id="l32.25">   headers.setAddressingHeader(&quot;To&quot;,</span>
<a href="#l32.26"></a><span id="l32.26">     [{name: &quot;Comma, Name&quot;, email: &quot;test@foo.invalid&quot;}], 1);</span>
<a href="#l32.27"></a><span id="l32.27">   Assert.equal(headers.getRawHeader(&quot;To&quot;),</span>
<a href="#l32.28"></a><span id="l32.28">     &quot;\&quot;Comma, Name\&quot; &lt;test@foo.invalid&gt;&quot;);</span>
<a href="#l32.29"></a><span id="l32.29"> });</span>
<a href="#l32.30"></a><span id="l32.30"> </span>
<a href="#l32.31"></a><span id="l32.31" class="difflineminus">-add_task(function* check_custom_header() {</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineplus">+add_task(async function check_custom_header() {</span>
<a href="#l32.33"></a><span id="l32.33">   // Load an extension for our custom header.</span>
<a href="#l32.34"></a><span id="l32.34">   let url = Services.io.newFileURI(do_get_file(&quot;custom_header.js&quot;)).spec;</span>
<a href="#l32.35"></a><span id="l32.35">   let promise = new Promise((resolve, reject) =&gt; {</span>
<a href="#l32.36"></a><span id="l32.36">     function observer(subject, topic, data) {</span>
<a href="#l32.37"></a><span id="l32.37">       Assert.equal(topic, &quot;xpcom-category-entry-added&quot;);</span>
<a href="#l32.38"></a><span id="l32.38">       Assert.equal(data, &quot;custom-mime-encoder&quot;);</span>
<a href="#l32.39"></a><span id="l32.39">       resolve();</span>
<a href="#l32.40"></a><span id="l32.40">       Services.obs.removeObserver(observer, &quot;xpcom-category-entry-added&quot;);</span>
<a href="#l32.41"></a><span id="l32.41">     }</span>
<a href="#l32.42"></a><span id="l32.42">     Services.obs.addObserver(observer, &quot;xpcom-category-entry-added&quot;);</span>
<a href="#l32.43"></a><span id="l32.43">   });</span>
<a href="#l32.44"></a><span id="l32.44">   Cc[&quot;@mozilla.org/categorymanager;1&quot;]</span>
<a href="#l32.45"></a><span id="l32.45">     .getService(Ci.nsICategoryManager)</span>
<a href="#l32.46"></a><span id="l32.46">     .addCategoryEntry(&quot;custom-mime-encoder&quot;, &quot;X-Unusual&quot;, url, false, true);</span>
<a href="#l32.47"></a><span id="l32.47">   // The category manager doesn't fire until a later timestep.</span>
<a href="#l32.48"></a><span id="l32.48" class="difflineminus">-  yield promise;</span>
<a href="#l32.49"></a><span id="l32.49" class="difflineplus">+  await promise;</span>
<a href="#l32.50"></a><span id="l32.50">   let headers = new StructuredHeaders();</span>
<a href="#l32.51"></a><span id="l32.51">   headers.setRawHeader(&quot;X-Unusual&quot;, &quot;10&quot;, null);</span>
<a href="#l32.52"></a><span id="l32.52">   Assert.equal(headers.getHeader(&quot;X-Unusual&quot;), 16);</span>
<a href="#l32.53"></a><span id="l32.53">   headers.setHeader(&quot;X-Unusual&quot;, 32);</span>
<a href="#l32.54"></a><span id="l32.54">   Assert.equal(headers.getRawHeader(&quot;X-Unusual&quot;), &quot;20&quot;);</span>
<a href="#l32.55"></a><span id="l32.55"> });</span>
<a href="#l32.56"></a><span id="l32.56"> </span>
<a href="#l32.57"></a><span id="l32.57" class="difflineminus">-add_task(function* check_raw() {</span>
<a href="#l32.58"></a><span id="l32.58" class="difflineplus">+add_task(async function check_raw() {</span>
<a href="#l32.59"></a><span id="l32.59">   let headers = new StructuredHeaders();</span>
<a href="#l32.60"></a><span id="l32.60">   Assert.ok(!headers.hasHeader(&quot;Date&quot;));</span>
<a href="#l32.61"></a><span id="l32.61">   let day = new Date(&quot;2000-01-01T00:00:00Z&quot;);</span>
<a href="#l32.62"></a><span id="l32.62">   headers.setHeader(&quot;Date&quot;, day);</span>
<a href="#l32.63"></a><span id="l32.63">   Assert.ok(headers.hasHeader(&quot;Date&quot;));</span>
<a href="#l32.64"></a><span id="l32.64">   Assert.ok(headers.hasHeader(&quot;date&quot;));</span>
<a href="#l32.65"></a><span id="l32.65">   Assert.equal(headers.getHeader(&quot;Date&quot;), day);</span>
<a href="#l32.66"></a><span id="l32.66">   Assert.equal(headers.getHeader(&quot;date&quot;), day);</span>
<a href="#l32.67"></a><span id="l32.67" class="difflineat">@@ -134,17 +134,17 @@ add_task(function* check_raw() {</span>
<a href="#l32.68"></a><span id="l32.68">   while (enumerator.hasMore()) {</span>
<a href="#l32.69"></a><span id="l32.69">     let value = enumerator.getNext();</span>
<a href="#l32.70"></a><span id="l32.70">     Assert.equal(moreHeaders.getHeader(value), headers.getHeader(value));</span>
<a href="#l32.71"></a><span id="l32.71">   }</span>
<a href="#l32.72"></a><span id="l32.72">   headers.deleteHeader(&quot;Date&quot;);</span>
<a href="#l32.73"></a><span id="l32.73">   Assert.ok(moreHeaders.hasHeader(&quot;Date&quot;));</span>
<a href="#l32.74"></a><span id="l32.74"> })</span>
<a href="#l32.75"></a><span id="l32.75"> </span>
<a href="#l32.76"></a><span id="l32.76" class="difflineminus">-add_task(function* check_nsIMimeHeaders() {</span>
<a href="#l32.77"></a><span id="l32.77" class="difflineplus">+add_task(async function check_nsIMimeHeaders() {</span>
<a href="#l32.78"></a><span id="l32.78">   let headers = Cc[&quot;@mozilla.org/messenger/mimeheaders;1&quot;]</span>
<a href="#l32.79"></a><span id="l32.79">                   .createInstance(Ci.nsIMimeHeaders);</span>
<a href="#l32.80"></a><span id="l32.80">   Assert.ok(headers instanceof Ci.msgIStructuredHeaders);</span>
<a href="#l32.81"></a><span id="l32.81">   Assert.equal(false, headers instanceof Ci.msgIWritableStructuredHeaders);</span>
<a href="#l32.82"></a><span id="l32.82">   headers.initialize(mailTestUtils.loadFileToString(</span>
<a href="#l32.83"></a><span id="l32.83">     do_get_file(&quot;../../../data/draft1&quot;)));</span>
<a href="#l32.84"></a><span id="l32.84">   Assert.equal(headers.getHeader(&quot;To&quot;).length, 1);</span>
<a href="#l32.85"></a><span id="l32.85">   Assert.equal(headers.getHeader(&quot;To&quot;)[0].email, &quot;bugmail@example.org&quot;);</span>
<a href="#l32.86"></a><span id="l32.86" class="difflineat">@@ -157,17 +157,17 @@ add_task(function* check_nsIMimeHeaders(</span>
<a href="#l32.87"></a><span id="l32.87">     &quot;Content-Type&quot;, &quot;Content-Transfer-Encoding&quot;];</span>
<a href="#l32.88"></a><span id="l32.88">   let enumerator = headers.headerNames;</span>
<a href="#l32.89"></a><span id="l32.89">   while (enumerator.hasMore()) {</span>
<a href="#l32.90"></a><span id="l32.90">     let value = enumerator.getNext();</span>
<a href="#l32.91"></a><span id="l32.91">     Assert.equal(value.toLowerCase(), headerList.shift().toLowerCase());</span>
<a href="#l32.92"></a><span id="l32.92">   }</span>
<a href="#l32.93"></a><span id="l32.93"> });</span>
<a href="#l32.94"></a><span id="l32.94"> </span>
<a href="#l32.95"></a><span id="l32.95" class="difflineminus">-add_task(function* checkBuildMimeText() {</span>
<a href="#l32.96"></a><span id="l32.96" class="difflineplus">+add_task(async function checkBuildMimeText() {</span>
<a href="#l32.97"></a><span id="l32.97">   let headers = new StructuredHeaders();</span>
<a href="#l32.98"></a><span id="l32.98">   headers.setHeader(&quot;To&quot;, [{name: &quot;Franois Smith&quot;, email: &quot;user@.invalid&quot;}]);</span>
<a href="#l32.99"></a><span id="l32.99">   headers.setHeader(&quot;From&quot;, [{name: &quot;John Doe&quot;, email: &quot;jdoe@test.invalid&quot;}]);</span>
<a href="#l32.100"></a><span id="l32.100">   headers.setHeader(&quot;Subject&quot;, &quot;A subject that spans a distance quite in &quot; +</span>
<a href="#l32.101"></a><span id="l32.101">     &quot;excess of 80 characters so as to force an intermediary CRLF&quot;);</span>
<a href="#l32.102"></a><span id="l32.102">   headers.setHeader(&quot;User-Agent&quot;, &quot;Mozilla/5.0 (X11; Linux x86_64; rv:40.0) Gecko/20100101 Thunderbird/40.0a1&quot;);</span>
<a href="#l32.103"></a><span id="l32.103">   let mimeText =</span>
<a href="#l32.104"></a><span id="l32.104">     &quot;To: =?UTF-8?Q?Fran=c3=a7ois_Smith?= &lt;user@.invalid&gt;\r\n&quot; +</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mailnews/news/test/unit/test_nntpGroupPassword.js</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mailnews/news/test/unit/test_nntpGroupPassword.js</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -4,18 +4,18 @@</span>
<a href="#l33.4"></a><span id="l33.4">  */</span>
<a href="#l33.5"></a><span id="l33.5"> </span>
<a href="#l33.6"></a><span id="l33.6"> // The basic daemon to use for testing nntpd.js implementations</span>
<a href="#l33.7"></a><span id="l33.7"> var daemon = setupNNTPDaemon();</span>
<a href="#l33.8"></a><span id="l33.8"> </span>
<a href="#l33.9"></a><span id="l33.9"> // Define these up here for checking with the transaction</span>
<a href="#l33.10"></a><span id="l33.10"> var test = null;</span>
<a href="#l33.11"></a><span id="l33.11"> </span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-add_task(function *() {</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineminus">-  yield Services.logins.initializationPromise;</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineplus">+add_task(async function () {</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineplus">+  await Services.logins.initializationPromise;</span>
<a href="#l33.16"></a><span id="l33.16"> </span>
<a href="#l33.17"></a><span id="l33.17">   daemon.groupCredentials = {</span>
<a href="#l33.18"></a><span id="l33.18">     &quot;test.subscribe.empty&quot;: [&quot;group1&quot;, &quot;pass1&quot;],</span>
<a href="#l33.19"></a><span id="l33.19">     &quot;test.filter&quot;: [&quot;group2&quot;, &quot;pass2&quot;]</span>
<a href="#l33.20"></a><span id="l33.20">   };</span>
<a href="#l33.21"></a><span id="l33.21"> </span>
<a href="#l33.22"></a><span id="l33.22">   var server = makeServer(NNTP_RFC4643_extension, daemon);</span>
<a href="#l33.23"></a><span id="l33.23">   server.start();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mailnews/news/test/unit/test_nntpPassword.js</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mailnews/news/test/unit/test_nntpPassword.js</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -9,19 +9,19 @@</span>
<a href="#l34.4"></a><span id="l34.4"> load(&quot;../../../resources/passwordStorage.js&quot;);</span>
<a href="#l34.5"></a><span id="l34.5"> </span>
<a href="#l34.6"></a><span id="l34.6"> // The basic daemon to use for testing nntpd.js implementations</span>
<a href="#l34.7"></a><span id="l34.7"> var daemon = setupNNTPDaemon();</span>
<a href="#l34.8"></a><span id="l34.8"> </span>
<a href="#l34.9"></a><span id="l34.9"> // Define these up here for checking with the transaction</span>
<a href="#l34.10"></a><span id="l34.10"> var test = null;</span>
<a href="#l34.11"></a><span id="l34.11"> </span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-add_task(function *() {</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+add_task(async function () {</span>
<a href="#l34.14"></a><span id="l34.14">   // Prepare files for passwords (generated by a script in bug 1018624).</span>
<a href="#l34.15"></a><span id="l34.15" class="difflineminus">-  yield setupForPassword(&quot;signons-mailnews1.8.json&quot;);</span>
<a href="#l34.16"></a><span id="l34.16" class="difflineplus">+  await setupForPassword(&quot;signons-mailnews1.8.json&quot;);</span>
<a href="#l34.17"></a><span id="l34.17"> </span>
<a href="#l34.18"></a><span id="l34.18">   var server = makeServer(NNTP_RFC4643_extension, daemon);</span>
<a href="#l34.19"></a><span id="l34.19">   server.start();</span>
<a href="#l34.20"></a><span id="l34.20"> </span>
<a href="#l34.21"></a><span id="l34.21">   try {</span>
<a href="#l34.22"></a><span id="l34.22">     var prefix = &quot;news://localhost:&quot; + server.port + &quot;/&quot;;</span>
<a href="#l34.23"></a><span id="l34.23">     var transaction;</span>
<a href="#l34.24"></a><span id="l34.24"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mailnews/news/test/unit/test_nntpPassword2.js</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mailnews/news/test/unit/test_nntpPassword2.js</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -12,17 +12,17 @@ ChromeUtils.import(&quot;resource:///modules/</span>
<a href="#l35.4"></a><span id="l35.4"> load(&quot;../../../resources/passwordStorage.js&quot;);</span>
<a href="#l35.5"></a><span id="l35.5"> </span>
<a href="#l35.6"></a><span id="l35.6"> // The basic daemon to use for testing nntpd.js implementations</span>
<a href="#l35.7"></a><span id="l35.7"> var daemon = setupNNTPDaemon();</span>
<a href="#l35.8"></a><span id="l35.8"> </span>
<a href="#l35.9"></a><span id="l35.9"> // Define these up here for checking with the transaction</span>
<a href="#l35.10"></a><span id="l35.10"> var test = null;</span>
<a href="#l35.11"></a><span id="l35.11"> </span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-add_task(function *() {</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineplus">+add_task(async function () {</span>
<a href="#l35.14"></a><span id="l35.14">   let server = makeServer(NNTP_RFC4643_extension, daemon);</span>
<a href="#l35.15"></a><span id="l35.15">   server.start();</span>
<a href="#l35.16"></a><span id="l35.16"> </span>
<a href="#l35.17"></a><span id="l35.17">   // These preferences set up a local news server that has had its hostname</span>
<a href="#l35.18"></a><span id="l35.18">   // and username changed from the original settings. We can't do this by</span>
<a href="#l35.19"></a><span id="l35.19">   // function calls for this test as they would cause the password to be</span>
<a href="#l35.20"></a><span id="l35.20">   // forgotten when changing the hostname/username and this breaks the test.</span>
<a href="#l35.21"></a><span id="l35.21">   Services.prefs.setCharPref(&quot;mail.account.account1.server&quot;, &quot;server1&quot;);</span>
<a href="#l35.22"></a><span id="l35.22" class="difflineat">@@ -51,17 +51,17 @@ add_task(function *() {</span>
<a href="#l35.23"></a><span id="l35.23">   Services.prefs.setCharPref(&quot;mail.server.server2.name&quot;,</span>
<a href="#l35.24"></a><span id="l35.24">                              &quot;testnntp on localhost&quot;);</span>
<a href="#l35.25"></a><span id="l35.25">   Services.prefs.setIntPref(&quot;mail.server.server2.port&quot;, server.port);</span>
<a href="#l35.26"></a><span id="l35.26">   Services.prefs.setCharPref(&quot;mail.server.server2.realhostname&quot;,</span>
<a href="#l35.27"></a><span id="l35.27">                              &quot;localhost&quot;);</span>
<a href="#l35.28"></a><span id="l35.28">   Services.prefs.setCharPref(&quot;mail.server.server2.type&quot;, &quot;nntp&quot;);</span>
<a href="#l35.29"></a><span id="l35.29"> </span>
<a href="#l35.30"></a><span id="l35.30">   // Prepare files for passwords (generated by a script in bug 1018624).</span>
<a href="#l35.31"></a><span id="l35.31" class="difflineminus">-  yield setupForPassword(&quot;signons-mailnews1.8-alt.json&quot;);</span>
<a href="#l35.32"></a><span id="l35.32" class="difflineplus">+  await setupForPassword(&quot;signons-mailnews1.8-alt.json&quot;);</span>
<a href="#l35.33"></a><span id="l35.33"> </span>
<a href="#l35.34"></a><span id="l35.34">   try {</span>
<a href="#l35.35"></a><span id="l35.35">     // Note, the uri is for hostname &quot;invalid&quot; which is the original uri. See</span>
<a href="#l35.36"></a><span id="l35.36">     // setupProtocolTest parameters.</span>
<a href="#l35.37"></a><span id="l35.37">     var prefix = &quot;news://invalid:&quot; + server.port + &quot;/&quot;;</span>
<a href="#l35.38"></a><span id="l35.38"> </span>
<a href="#l35.39"></a><span id="l35.39">     // Test - group subscribe listing</span>
<a href="#l35.40"></a><span id="l35.40">     test = &quot;news:*&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mailnews/news/test/unit/test_nntpPassword3.js</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mailnews/news/test/unit/test_nntpPassword3.js</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -9,19 +9,19 @@ ChromeUtils.import(&quot;resource://gre/modul</span>
<a href="#l36.4"></a><span id="l36.4"> load(&quot;../../../resources/passwordStorage.js&quot;);</span>
<a href="#l36.5"></a><span id="l36.5"> </span>
<a href="#l36.6"></a><span id="l36.6"> var kUsername = &quot;testnews&quot;;</span>
<a href="#l36.7"></a><span id="l36.7"> var kPassword = &quot;newstest&quot;;</span>
<a href="#l36.8"></a><span id="l36.8"> var kProtocol = &quot;nntp&quot;;</span>
<a href="#l36.9"></a><span id="l36.9"> var kHostname = &quot;localhost&quot;;</span>
<a href="#l36.10"></a><span id="l36.10"> var kServerUrl = &quot;news://&quot; + kHostname;</span>
<a href="#l36.11"></a><span id="l36.11"> </span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-add_task(function *() {</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineplus">+add_task(async function () {</span>
<a href="#l36.14"></a><span id="l36.14">   // Prepare files for passwords (generated by a script in bug 1018624).</span>
<a href="#l36.15"></a><span id="l36.15" class="difflineminus">-  yield setupForPassword(&quot;signons-mailnews1.8.json&quot;)</span>
<a href="#l36.16"></a><span id="l36.16" class="difflineplus">+  await setupForPassword(&quot;signons-mailnews1.8.json&quot;)</span>
<a href="#l36.17"></a><span id="l36.17"> </span>
<a href="#l36.18"></a><span id="l36.18">   // Set up the basic accounts and folders.</span>
<a href="#l36.19"></a><span id="l36.19">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l36.20"></a><span id="l36.20"> </span>
<a href="#l36.21"></a><span id="l36.21">   var incomingServer = MailServices.accounts.createIncomingServer(null, kHostname,</span>
<a href="#l36.22"></a><span id="l36.22">                                                                   kProtocol);</span>
<a href="#l36.23"></a><span id="l36.23"> </span>
<a href="#l36.24"></a><span id="l36.24">   var i;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mailnews/news/test/unit/test_nntpProxy.js</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mailnews/news/test/unit/test_nntpProxy.js</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -4,36 +4,36 @@</span>
<a href="#l37.4"></a><span id="l37.4"> </span>
<a href="#l37.5"></a><span id="l37.5"> ChromeUtils.import(&quot;resource://testing-common/mailnews/NetworkTestUtils.jsm&quot;);</span>
<a href="#l37.6"></a><span id="l37.6"> ChromeUtils.import(&quot;resource://testing-common/mailnews/PromiseTestUtils.jsm&quot;);</span>
<a href="#l37.7"></a><span id="l37.7"> </span>
<a href="#l37.8"></a><span id="l37.8"> const PORT = 119;</span>
<a href="#l37.9"></a><span id="l37.9"> </span>
<a href="#l37.10"></a><span id="l37.10"> var daemon, localserver, server;</span>
<a href="#l37.11"></a><span id="l37.11"> </span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-add_task(function* setup() {</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineplus">+add_task(async function setup() {</span>
<a href="#l37.14"></a><span id="l37.14">   daemon = setupNNTPDaemon();</span>
<a href="#l37.15"></a><span id="l37.15">   server = makeServer(NNTP_RFC2980_handler, daemon);</span>
<a href="#l37.16"></a><span id="l37.16">   server.start();</span>
<a href="#l37.17"></a><span id="l37.17">   NetworkTestUtils.configureProxy(&quot;news.tinderbox.invalid&quot;, PORT, server.port);</span>
<a href="#l37.18"></a><span id="l37.18">   localserver = setupLocalServer(PORT, &quot;news.tinderbox.invalid&quot;);</span>
<a href="#l37.19"></a><span id="l37.19"> });</span>
<a href="#l37.20"></a><span id="l37.20"> </span>
<a href="#l37.21"></a><span id="l37.21" class="difflineminus">-add_task(function* findMessages() {</span>
<a href="#l37.22"></a><span id="l37.22" class="difflineplus">+add_task(async function findMessages() {</span>
<a href="#l37.23"></a><span id="l37.23">   // This is a trivial check that makes sure that we actually do some network</span>
<a href="#l37.24"></a><span id="l37.24">   // traffic without caring about the exact network traffic.</span>
<a href="#l37.25"></a><span id="l37.25">   let folder = localserver.rootFolder.getChildNamed(&quot;test.filter&quot;);</span>
<a href="#l37.26"></a><span id="l37.26">   equal(folder.getTotalMessages(false), 0);</span>
<a href="#l37.27"></a><span id="l37.27">   let asyncUrlListener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l37.28"></a><span id="l37.28">   folder.getNewMessages(null, asyncUrlListener);</span>
<a href="#l37.29"></a><span id="l37.29" class="difflineminus">-  yield asyncUrlListener.promise;</span>
<a href="#l37.30"></a><span id="l37.30" class="difflineplus">+  await asyncUrlListener.promise;</span>
<a href="#l37.31"></a><span id="l37.31">   equal(folder.getTotalMessages(false), 8);</span>
<a href="#l37.32"></a><span id="l37.32"> });</span>
<a href="#l37.33"></a><span id="l37.33"> </span>
<a href="#l37.34"></a><span id="l37.34" class="difflineminus">-add_task(function* cleanUp() {</span>
<a href="#l37.35"></a><span id="l37.35" class="difflineplus">+add_task(async function cleanUp() {</span>
<a href="#l37.36"></a><span id="l37.36">   NetworkTestUtils.shutdownServers();</span>
<a href="#l37.37"></a><span id="l37.37">   localserver.closeCachedConnections();</span>
<a href="#l37.38"></a><span id="l37.38"> });</span>
<a href="#l37.39"></a><span id="l37.39"> </span>
<a href="#l37.40"></a><span id="l37.40"> function run_test() {</span>
<a href="#l37.41"></a><span id="l37.41">   run_next_test();</span>
<a href="#l37.42"></a><span id="l37.42"> }</span>
<a href="#l37.43"></a><span id="l37.43"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

