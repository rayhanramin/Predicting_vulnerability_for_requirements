<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 2749:26d1e9a983fd5456eafa47634ccb7602b937faba</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 26d1e9a983fd5456eafa47634ccb7602b937faba" />
<meta property="og:url" content="/comm-central/rev/26d1e9a983fd5456eafa47634ccb7602b937faba" />
<meta property="og:description" content="Bug 495527 Fix up send later unit tests and create alertTestUtils.js resource. r=bienvenu" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 26d1e9a983fd5456eafa47634ccb7602b937faba 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/26d1e9a983fd5456eafa47634ccb7602b937faba">shortlog</a> |
<a href="/comm-central/log/26d1e9a983fd5456eafa47634ccb7602b937faba">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/26d1e9a983fd5456eafa47634ccb7602b937faba">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/26d1e9a983fd5456eafa47634ccb7602b937faba">files</a> |
changeset |
<a href="/comm-central/raw-rev/26d1e9a983fd5456eafa47634ccb7602b937faba">raw</a>  | <a href="/comm-central/archive/26d1e9a983fd5456eafa47634ccb7602b937faba.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=495527">Bug 495527</a> Fix up send later unit tests and create alertTestUtils.js resource. r=bienvenu
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#97;&#114;&#107;&#32;&#66;&#97;&#110;&#110;&#101;&#114;&#32;&#60;&#98;&#117;&#103;&#122;&#105;&#108;&#108;&#97;&#64;&#115;&#116;&#97;&#110;&#100;&#97;&#114;&#100;&#56;&#46;&#112;&#108;&#117;&#115;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 02 Jun 2009 15:49:45 +0100</td></tr>

<tr>
 <td>changeset 2749</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/26d1e9a983fd5456eafa47634ccb7602b937faba">26d1e9a983fd5456eafa47634ccb7602b937faba</a></td>
</tr>



<tr>
<td>parent 2748</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/e2b8a59771f976ec6292e8cfa992d66bbba12ced">e2b8a59771f976ec6292e8cfa992d66bbba12ced</a>
</td>
</tr>

<tr>
<td>child 2750</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8f47b438d34b057ce1005ce2e00c23a8939e6c5d">8f47b438d34b057ce1005ce2e00c23a8939e6c5d</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=26d1e9a983fd5456eafa47634ccb7602b937faba">2228</a></td></tr>
<tr><td>push user</td><td>bugzilla@standard8.plus.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 02 Jun 2009 14:52:38 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@26d1e9a983fd [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=26d1e9a983fd5456eafa47634ccb7602b937faba">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=26d1e9a983fd5456eafa47634ccb7602b937faba&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=26d1e9a983fd5456eafa47634ccb7602b937faba&newProject=comm-central&newRevision=26d1e9a983fd5456eafa47634ccb7602b937faba&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=26d1e9a983fd5456eafa47634ccb7602b937faba&newProject=comm-central&newRevision=26d1e9a983fd5456eafa47634ccb7602b937faba&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=26d1e9a983fd5456eafa47634ccb7602b937faba&newProject=comm-central&newRevision=26d1e9a983fd5456eafa47634ccb7602b937faba&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28bienvenu%29&revcount=50">bienvenu</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=495527">495527</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=495527">Bug 495527</a> Fix up send later unit tests and create alertTestUtils.js resource. r=bienvenu</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/base/test/unit/test_nsMsgMailSession_Alerts.js">mailnews/base/test/unit/test_nsMsgMailSession_Alerts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/base/test/unit/test_nsMsgMailSession_Alerts.js">file</a> |
<a href="/comm-central/annotate/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/base/test/unit/test_nsMsgMailSession_Alerts.js">annotate</a> |
<a href="/comm-central/diff/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/base/test/unit/test_nsMsgMailSession_Alerts.js">diff</a> |
<a href="/comm-central/comparison/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/base/test/unit/test_nsMsgMailSession_Alerts.js">comparison</a> |
<a href="/comm-central/log/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/base/test/unit/test_nsMsgMailSession_Alerts.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/compose/test/unit/head_compose.js">mailnews/compose/test/unit/head_compose.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/compose/test/unit/head_compose.js">file</a> |
<a href="/comm-central/annotate/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/compose/test/unit/head_compose.js">annotate</a> |
<a href="/comm-central/diff/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/compose/test/unit/head_compose.js">diff</a> |
<a href="/comm-central/comparison/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/compose/test/unit/head_compose.js">comparison</a> |
<a href="/comm-central/log/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/compose/test/unit/head_compose.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/compose/test/unit/test_bug474774.js">mailnews/compose/test/unit/test_bug474774.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/compose/test/unit/test_bug474774.js">file</a> |
<a href="/comm-central/annotate/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/compose/test/unit/test_bug474774.js">annotate</a> |
<a href="/comm-central/diff/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/compose/test/unit/test_bug474774.js">diff</a> |
<a href="/comm-central/comparison/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/compose/test/unit/test_bug474774.js">comparison</a> |
<a href="/comm-central/log/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/compose/test/unit/test_bug474774.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/compose/test/unit/test_sendBackground.js">mailnews/compose/test/unit/test_sendBackground.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/compose/test/unit/test_sendBackground.js">file</a> |
<a href="/comm-central/annotate/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/compose/test/unit/test_sendBackground.js">annotate</a> |
<a href="/comm-central/diff/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/compose/test/unit/test_sendBackground.js">diff</a> |
<a href="/comm-central/comparison/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/compose/test/unit/test_sendBackground.js">comparison</a> |
<a href="/comm-central/log/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/compose/test/unit/test_sendBackground.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/compose/test/unit/test_sendMessageLater.js">mailnews/compose/test/unit/test_sendMessageLater.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/compose/test/unit/test_sendMessageLater.js">file</a> |
<a href="/comm-central/annotate/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/compose/test/unit/test_sendMessageLater.js">annotate</a> |
<a href="/comm-central/diff/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/compose/test/unit/test_sendMessageLater.js">diff</a> |
<a href="/comm-central/comparison/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/compose/test/unit/test_sendMessageLater.js">comparison</a> |
<a href="/comm-central/log/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/compose/test/unit/test_sendMessageLater.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/compose/test/unit/test_sendMessageLater2.js">mailnews/compose/test/unit/test_sendMessageLater2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/compose/test/unit/test_sendMessageLater2.js">file</a> |
<a href="/comm-central/annotate/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/compose/test/unit/test_sendMessageLater2.js">annotate</a> |
<a href="/comm-central/diff/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/compose/test/unit/test_sendMessageLater2.js">diff</a> |
<a href="/comm-central/comparison/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/compose/test/unit/test_sendMessageLater2.js">comparison</a> |
<a href="/comm-central/log/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/compose/test/unit/test_sendMessageLater2.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/compose/test/unit/test_sendMessageLater3.js">mailnews/compose/test/unit/test_sendMessageLater3.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/compose/test/unit/test_sendMessageLater3.js">file</a> |
<a href="/comm-central/annotate/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/compose/test/unit/test_sendMessageLater3.js">annotate</a> |
<a href="/comm-central/diff/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/compose/test/unit/test_sendMessageLater3.js">diff</a> |
<a href="/comm-central/comparison/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/compose/test/unit/test_sendMessageLater3.js">comparison</a> |
<a href="/comm-central/log/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/compose/test/unit/test_sendMessageLater3.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/test/resources/alertTestUtils.js">mailnews/test/resources/alertTestUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/test/resources/alertTestUtils.js">file</a> |
<a href="/comm-central/annotate/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/test/resources/alertTestUtils.js">annotate</a> |
<a href="/comm-central/diff/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/test/resources/alertTestUtils.js">diff</a> |
<a href="/comm-central/comparison/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/test/resources/alertTestUtils.js">comparison</a> |
<a href="/comm-central/log/26d1e9a983fd5456eafa47634ccb7602b937faba/mailnews/test/resources/alertTestUtils.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/test/unit/test_nsMsgMailSession_Alerts.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_nsMsgMailSession_Alerts.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1,89 +1,36 @@</span>
<a href="#l1.4"></a><span id="l1.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l1.5"></a><span id="l1.5"> /*</span>
<a href="#l1.6"></a><span id="l1.6">  * Test suite for nsMsgMailSession functions relating to alerts and their</span>
<a href="#l1.7"></a><span id="l1.7">  * listeners.</span>
<a href="#l1.8"></a><span id="l1.8">  */</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineminus">-</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-// This allows us to check that we get alerts at the right time without</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-// involking the UI.</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-var prompts = {</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-  mDialogTitle: null,</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-  mText: null,</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+load(&quot;../../mailnews/resources/alertTestUtils.js&quot;);</span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-  // not part of the nsIPrompt interface, just makes it easier to test.</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-  reset: function() {</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-    this.mDialogTitle = null;</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">-    this.mText = null;</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-  },</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">-</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-  // nsIPrompt</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-  alert: function(aDialogTitle, aText) {</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">-    do_check_eq(this.mDialogTitle, null);</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-    do_check_eq(this.mText, null);</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+var gDialogTitle = null;</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+var gText = null;</span>
<a href="#l1.31"></a><span id="l1.31"> </span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-    this.mDialogTitle = aDialogTitle;</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-    this.mText = aText;</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-  },</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-  </span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-  alertCheck: function(aDialogTitle, aText, aCheckMsg, aCheckState) {},</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-  </span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-  confirm: function(aDialogTitle, aText) {},</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-  </span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-  confirmCheck: function(aDialogTitle, aText, aCheckMsg, aCheckState) {},</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-  </span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-  confirmEx: function(aDialogTitle, aText, aButtonFlags, aButton0Title,</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-		      aButton1Title, aButton2Title, aCheckMsg, aCheckState) {},</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-  </span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-  prompt: function(aDialogTitle, aText, aValue, aCheckMsg, aCheckState) {},</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-  </span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-  promptUsernameAndPassword: function(aDialogTitle, aText, aUsername,</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-				      aPassword, aCheckMsg, aCheckState) {},</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+function reset() {</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+  gDialogTitle = null;</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+  gText = null;</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+}</span>
<a href="#l1.53"></a><span id="l1.53"> </span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-  promptPassword: function(aDialogTitle, aText, aPassword, aCheckMsg,</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineminus">-			   aCheckState) {},</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineminus">-  </span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-  select: function(aDialogTitle, aText, aCount, aSelectList,</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineminus">-		   aOutSelection) {},</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-  </span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-  QueryInterface: XPCOMUtils.generateQI([Ci.nsIPrompt])</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineminus">-};</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-var WindowWatcher = {</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-  getNewPrompter: function(aParent) {</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineminus">-    return prompts;</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineminus">-  },</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+function alert(aDialogTitle, aText) {</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+  do_check_eq(gDialogTitle, null);</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+  do_check_eq(gText, null);</span>
<a href="#l1.70"></a><span id="l1.70"> </span>
<a href="#l1.71"></a><span id="l1.71" class="difflineminus">-  getNewAuthPrompter: function(aParent) {</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineminus">-    return prompts;</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineminus">-  },</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineminus">-</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineminus">-  QueryInterface: XPCOMUtils.generateQI([Ci.nsIWindowWatcher])</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineminus">-};</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineminus">-</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-var WindowWatcherFactory = {</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineminus">-  createInstance: function createInstance(outer, iid) {</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineminus">-    if (outer != null)</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineminus">-      throw Components.results.NS_ERROR_NO_AGGREGATION;</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineminus">-    return WindowWatcher.QueryInterface(iid);</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineminus">-  }</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineminus">-};</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineminus">-</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineminus">-Components.manager.QueryInterface(Components.interfaces.nsIComponentRegistrar)</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineminus">-          .registerFactory(Components.ID(&quot;{1dfeb90a-2193-45d5-9cb8-864928b2af55}&quot;),</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineminus">-			   &quot;Fake Window Watcher&quot;,</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineminus">-			   &quot;@mozilla.org/embedcomp/window-watcher;1&quot;,</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineminus">-			   WindowWatcherFactory);</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineplus">+  gDialogTitle = aDialogTitle;</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineplus">+  gText = aText;</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineplus">+}</span>
<a href="#l1.94"></a><span id="l1.94"> </span>
<a href="#l1.95"></a><span id="l1.95"> var msgWindow = {</span>
<a href="#l1.96"></a><span id="l1.96">   get promptDialog() {</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineminus">-    return prompts;</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineplus">+    return alertUtilsPrompts;</span>
<a href="#l1.99"></a><span id="l1.99">   },</span>
<a href="#l1.100"></a><span id="l1.100"> </span>
<a href="#l1.101"></a><span id="l1.101">   QueryInterface: XPCOMUtils.generateQI([Ci.nsIMsgWindow])</span>
<a href="#l1.102"></a><span id="l1.102"> };</span>
<a href="#l1.103"></a><span id="l1.103"> </span>
<a href="#l1.104"></a><span id="l1.104"> var msgUrl = {</span>
<a href="#l1.105"></a><span id="l1.105">   _msgWindow: null,</span>
<a href="#l1.106"></a><span id="l1.106"> </span>
<a href="#l1.107"></a><span id="l1.107" class="difflineat">@@ -119,149 +66,149 @@ alertListener.prototype = {</span>
<a href="#l1.108"></a><span id="l1.108"> </span>
<a href="#l1.109"></a><span id="l1.109"> function run_test()</span>
<a href="#l1.110"></a><span id="l1.110"> {</span>
<a href="#l1.111"></a><span id="l1.111">   var mailSession = Cc[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l1.112"></a><span id="l1.112">     .getService(Ci.nsIMsgMailSession);</span>
<a href="#l1.113"></a><span id="l1.113"> </span>
<a href="#l1.114"></a><span id="l1.114">   // Test - No listeners, check alert tries to alert the user.</span>
<a href="#l1.115"></a><span id="l1.115"> </span>
<a href="#l1.116"></a><span id="l1.116" class="difflineminus">-  prompts.reset();</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineplus">+  reset();</span>
<a href="#l1.118"></a><span id="l1.118"> </span>
<a href="#l1.119"></a><span id="l1.119">   msgUrl._msgWindow = msgWindow;</span>
<a href="#l1.120"></a><span id="l1.120"> </span>
<a href="#l1.121"></a><span id="l1.121">   mailSession.alertUser(&quot;test message&quot;, msgUrl);</span>
<a href="#l1.122"></a><span id="l1.122"> </span>
<a href="#l1.123"></a><span id="l1.123">   // The dialog title doesn't get set at the moment.</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineminus">-  do_check_eq(prompts.mDialogTitle, null);</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineminus">-  do_check_eq(prompts.mText, &quot;test message&quot;);</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+  do_check_eq(gDialogTitle, null);</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineplus">+  do_check_eq(gText, &quot;test message&quot;);</span>
<a href="#l1.128"></a><span id="l1.128"> </span>
<a href="#l1.129"></a><span id="l1.129">   // Test - No listeners and no msgWindow, check no alerts.</span>
<a href="#l1.130"></a><span id="l1.130"> </span>
<a href="#l1.131"></a><span id="l1.131" class="difflineminus">-  prompts.reset();</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineplus">+  reset();</span>
<a href="#l1.133"></a><span id="l1.133"> </span>
<a href="#l1.134"></a><span id="l1.134">   msgUrl._msgWindow = null;</span>
<a href="#l1.135"></a><span id="l1.135"> </span>
<a href="#l1.136"></a><span id="l1.136">   mailSession.alertUser(&quot;test no message&quot;, msgUrl);</span>
<a href="#l1.137"></a><span id="l1.137"> </span>
<a href="#l1.138"></a><span id="l1.138">   // The dialog title doesn't get set at the moment.</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineminus">-  do_check_eq(prompts.mDialogTitle, null);</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineminus">-  do_check_eq(prompts.mText, null);</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineplus">+  do_check_eq(gDialogTitle, null);</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineplus">+  do_check_eq(gText, null);</span>
<a href="#l1.143"></a><span id="l1.143"> </span>
<a href="#l1.144"></a><span id="l1.144">   // Test - One listener, returning false (prompt should still happen).</span>
<a href="#l1.145"></a><span id="l1.145"> </span>
<a href="#l1.146"></a><span id="l1.146" class="difflineminus">-  prompts.reset();</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineplus">+  reset();</span>
<a href="#l1.148"></a><span id="l1.148"> </span>
<a href="#l1.149"></a><span id="l1.149">   var listener1 = new alertListener();</span>
<a href="#l1.150"></a><span id="l1.150">   listener1.mReturn = false;</span>
<a href="#l1.151"></a><span id="l1.151"> </span>
<a href="#l1.152"></a><span id="l1.152">   mailSession.addUserFeedbackListener(listener1);</span>
<a href="#l1.153"></a><span id="l1.153"> </span>
<a href="#l1.154"></a><span id="l1.154">   msgUrl._msgWindow = msgWindow;</span>
<a href="#l1.155"></a><span id="l1.155"> </span>
<a href="#l1.156"></a><span id="l1.156">   mailSession.alertUser(&quot;message test&quot;, msgUrl);</span>
<a href="#l1.157"></a><span id="l1.157"> </span>
<a href="#l1.158"></a><span id="l1.158" class="difflineminus">-  do_check_eq(prompts.mDialogTitle, null);</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineminus">-  do_check_eq(prompts.mText, &quot;message test&quot;);</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineplus">+  do_check_eq(gDialogTitle, null);</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineplus">+  do_check_eq(gText, &quot;message test&quot;);</span>
<a href="#l1.162"></a><span id="l1.162"> </span>
<a href="#l1.163"></a><span id="l1.163">   do_check_eq(listener1.mMessage, &quot;message test&quot;);</span>
<a href="#l1.164"></a><span id="l1.164">   do_check_neq(listener1.mMsgWindow, null);</span>
<a href="#l1.165"></a><span id="l1.165"> </span>
<a href="#l1.166"></a><span id="l1.166">   // Test - One listener, returning false, no msg window (prompt shouldn't</span>
<a href="#l1.167"></a><span id="l1.167">   //        happen).</span>
<a href="#l1.168"></a><span id="l1.168"> </span>
<a href="#l1.169"></a><span id="l1.169" class="difflineminus">-  prompts.reset();</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineplus">+  reset();</span>
<a href="#l1.171"></a><span id="l1.171">   listener1.reset();</span>
<a href="#l1.172"></a><span id="l1.172"> </span>
<a href="#l1.173"></a><span id="l1.173">   mailSession.alertUser(&quot;message test no prompt&quot;, null);</span>
<a href="#l1.174"></a><span id="l1.174"> </span>
<a href="#l1.175"></a><span id="l1.175" class="difflineminus">-  do_check_eq(prompts.mDialogTitle, null);</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineminus">-  do_check_eq(prompts.mText, null);</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineplus">+  do_check_eq(gDialogTitle, null);</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineplus">+  do_check_eq(gText, null);</span>
<a href="#l1.179"></a><span id="l1.179"> </span>
<a href="#l1.180"></a><span id="l1.180">   do_check_eq(listener1.mMessage, &quot;message test no prompt&quot;);</span>
<a href="#l1.181"></a><span id="l1.181">   do_check_eq(listener1.mMsgWindow, null);</span>
<a href="#l1.182"></a><span id="l1.182"> </span>
<a href="#l1.183"></a><span id="l1.183">   // Test - Two listeners, both returning false (prompt should happen).</span>
<a href="#l1.184"></a><span id="l1.184"> </span>
<a href="#l1.185"></a><span id="l1.185" class="difflineminus">-  prompts.reset();</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineplus">+  reset();</span>
<a href="#l1.187"></a><span id="l1.187">   listener1.reset();</span>
<a href="#l1.188"></a><span id="l1.188"> </span>
<a href="#l1.189"></a><span id="l1.189">   var listener2 = new alertListener();</span>
<a href="#l1.190"></a><span id="l1.190">   listener2.mReturn = false;</span>
<a href="#l1.191"></a><span id="l1.191"> </span>
<a href="#l1.192"></a><span id="l1.192">   mailSession.addUserFeedbackListener(listener2);</span>
<a href="#l1.193"></a><span id="l1.193"> </span>
<a href="#l1.194"></a><span id="l1.194">   msgUrl._msgWindow = msgWindow;</span>
<a href="#l1.195"></a><span id="l1.195"> </span>
<a href="#l1.196"></a><span id="l1.196">   mailSession.alertUser(&quot;two listeners&quot;, msgUrl);</span>
<a href="#l1.197"></a><span id="l1.197"> </span>
<a href="#l1.198"></a><span id="l1.198" class="difflineminus">-  do_check_eq(prompts.mDialogTitle, null);</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineminus">-  do_check_eq(prompts.mText, &quot;two listeners&quot;);</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineplus">+  do_check_eq(gDialogTitle, null);</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineplus">+  do_check_eq(gText, &quot;two listeners&quot;);</span>
<a href="#l1.202"></a><span id="l1.202"> </span>
<a href="#l1.203"></a><span id="l1.203">   do_check_eq(listener1.mMessage, &quot;two listeners&quot;);</span>
<a href="#l1.204"></a><span id="l1.204">   do_check_neq(listener1.mMsgWindow, null);</span>
<a href="#l1.205"></a><span id="l1.205"> </span>
<a href="#l1.206"></a><span id="l1.206">   do_check_eq(listener2.mMessage, &quot;two listeners&quot;);</span>
<a href="#l1.207"></a><span id="l1.207">   do_check_neq(listener2.mMsgWindow, null);</span>
<a href="#l1.208"></a><span id="l1.208"> </span>
<a href="#l1.209"></a><span id="l1.209">   // Test - Two listeners, one returning true (prompt shouldn't happen).</span>
<a href="#l1.210"></a><span id="l1.210"> </span>
<a href="#l1.211"></a><span id="l1.211" class="difflineminus">-  prompts.reset();</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineplus">+  reset();</span>
<a href="#l1.213"></a><span id="l1.213">   listener1.reset();</span>
<a href="#l1.214"></a><span id="l1.214">   listener2.reset();</span>
<a href="#l1.215"></a><span id="l1.215"> </span>
<a href="#l1.216"></a><span id="l1.216">   listener2.mReturn = true;</span>
<a href="#l1.217"></a><span id="l1.217"> </span>
<a href="#l1.218"></a><span id="l1.218">   msgUrl._msgWindow = msgWindow;</span>
<a href="#l1.219"></a><span id="l1.219"> </span>
<a href="#l1.220"></a><span id="l1.220">   mailSession.alertUser(&quot;no prompt&quot;, msgUrl);</span>
<a href="#l1.221"></a><span id="l1.221"> </span>
<a href="#l1.222"></a><span id="l1.222" class="difflineminus">-  do_check_eq(prompts.mDialogTitle, null);</span>
<a href="#l1.223"></a><span id="l1.223" class="difflineminus">-  do_check_eq(prompts.mText, null);</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineplus">+  do_check_eq(gDialogTitle, null);</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineplus">+  do_check_eq(gText, null);</span>
<a href="#l1.226"></a><span id="l1.226"> </span>
<a href="#l1.227"></a><span id="l1.227">   do_check_eq(listener1.mMessage, &quot;no prompt&quot;);</span>
<a href="#l1.228"></a><span id="l1.228">   do_check_neq(listener1.mMsgWindow, null);</span>
<a href="#l1.229"></a><span id="l1.229"> </span>
<a href="#l1.230"></a><span id="l1.230">   do_check_eq(listener2.mMessage, &quot;no prompt&quot;);</span>
<a href="#l1.231"></a><span id="l1.231">   do_check_neq(listener2.mMsgWindow, null);</span>
<a href="#l1.232"></a><span id="l1.232"> </span>
<a href="#l1.233"></a><span id="l1.233">   // Test - Remove a listener.</span>
<a href="#l1.234"></a><span id="l1.234"> </span>
<a href="#l1.235"></a><span id="l1.235" class="difflineminus">-  prompts.reset();</span>
<a href="#l1.236"></a><span id="l1.236" class="difflineplus">+  reset();</span>
<a href="#l1.237"></a><span id="l1.237">   listener1.reset();</span>
<a href="#l1.238"></a><span id="l1.238">   listener2.reset();</span>
<a href="#l1.239"></a><span id="l1.239"> </span>
<a href="#l1.240"></a><span id="l1.240">   mailSession.removeUserFeedbackListener(listener1);</span>
<a href="#l1.241"></a><span id="l1.241"> </span>
<a href="#l1.242"></a><span id="l1.242">   msgUrl._msgWindow = msgWindow;</span>
<a href="#l1.243"></a><span id="l1.243"> </span>
<a href="#l1.244"></a><span id="l1.244">   mailSession.alertUser(&quot;remove listener&quot;, msgUrl);</span>
<a href="#l1.245"></a><span id="l1.245"> </span>
<a href="#l1.246"></a><span id="l1.246" class="difflineminus">-  do_check_eq(prompts.mDialogTitle, null);</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineminus">-  do_check_eq(prompts.mText, null);</span>
<a href="#l1.248"></a><span id="l1.248" class="difflineplus">+  do_check_eq(gDialogTitle, null);</span>
<a href="#l1.249"></a><span id="l1.249" class="difflineplus">+  do_check_eq(gText, null);</span>
<a href="#l1.250"></a><span id="l1.250"> </span>
<a href="#l1.251"></a><span id="l1.251">   do_check_eq(listener1.mMessage, null);</span>
<a href="#l1.252"></a><span id="l1.252">   do_check_eq(listener1.mMsgWindow, null);</span>
<a href="#l1.253"></a><span id="l1.253"> </span>
<a href="#l1.254"></a><span id="l1.254">   do_check_eq(listener2.mMessage, &quot;remove listener&quot;);</span>
<a href="#l1.255"></a><span id="l1.255">   do_check_neq(listener2.mMsgWindow, null);</span>
<a href="#l1.256"></a><span id="l1.256"> </span>
<a href="#l1.257"></a><span id="l1.257">   // Test - Remove the other listener.</span>
<a href="#l1.258"></a><span id="l1.258"> </span>
<a href="#l1.259"></a><span id="l1.259" class="difflineminus">-  prompts.reset();</span>
<a href="#l1.260"></a><span id="l1.260" class="difflineplus">+  reset();</span>
<a href="#l1.261"></a><span id="l1.261">   listener1.reset();</span>
<a href="#l1.262"></a><span id="l1.262">   listener2.reset();</span>
<a href="#l1.263"></a><span id="l1.263"> </span>
<a href="#l1.264"></a><span id="l1.264">   mailSession.removeUserFeedbackListener(listener2);</span>
<a href="#l1.265"></a><span id="l1.265"> </span>
<a href="#l1.266"></a><span id="l1.266">   msgUrl._msgWindow = msgWindow;</span>
<a href="#l1.267"></a><span id="l1.267"> </span>
<a href="#l1.268"></a><span id="l1.268">   mailSession.alertUser(&quot;no listeners&quot;, msgUrl);</span>
<a href="#l1.269"></a><span id="l1.269"> </span>
<a href="#l1.270"></a><span id="l1.270" class="difflineminus">-  do_check_eq(prompts.mDialogTitle, null);</span>
<a href="#l1.271"></a><span id="l1.271" class="difflineminus">-  do_check_eq(prompts.mText, &quot;no listeners&quot;);</span>
<a href="#l1.272"></a><span id="l1.272" class="difflineplus">+  do_check_eq(gDialogTitle, null);</span>
<a href="#l1.273"></a><span id="l1.273" class="difflineplus">+  do_check_eq(gText, &quot;no listeners&quot;);</span>
<a href="#l1.274"></a><span id="l1.274"> </span>
<a href="#l1.275"></a><span id="l1.275">   do_check_eq(listener1.mMessage, null);</span>
<a href="#l1.276"></a><span id="l1.276">   do_check_eq(listener1.mMsgWindow, null);</span>
<a href="#l1.277"></a><span id="l1.277"> </span>
<a href="#l1.278"></a><span id="l1.278">   do_check_eq(listener2.mMessage, null);</span>
<a href="#l1.279"></a><span id="l1.279">   do_check_eq(listener2.mMsgWindow, null);</span>
<a href="#l1.280"></a><span id="l1.280"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/compose/test/unit/head_compose.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/compose/test/unit/head_compose.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -59,17 +59,18 @@ function do_check_transaction(real, expe</span>
<a href="#l2.4"></a><span id="l2.4">     real.them.pop();</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6">   do_check_eq(real.them.join(&quot;,&quot;), expected.join(&quot;,&quot;));</span>
<a href="#l2.7"></a><span id="l2.7">   dump(&quot;Passed test &quot; + test + &quot;\n&quot;);</span>
<a href="#l2.8"></a><span id="l2.8"> }</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> // This listener is designed just to call OnStopCopy() when its OnStopCopy</span>
<a href="#l2.11"></a><span id="l2.11"> // function is called - the rest of the functions are unneeded for a lot of</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-// tests.</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+// tests (but we can't use asyncCopyListener because we need the</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+// nsIMsgSendListener interface as well).</span>
<a href="#l2.15"></a><span id="l2.15"> var copyListener = {</span>
<a href="#l2.16"></a><span id="l2.16">   // nsIMsgSendListener</span>
<a href="#l2.17"></a><span id="l2.17">   onStartSending: function (aMsgID, aMsgSize) {},</span>
<a href="#l2.18"></a><span id="l2.18">   onProgress: function (aMsgID, aProgress, aProgressMax) {},</span>
<a href="#l2.19"></a><span id="l2.19">   onStatus: function (aMsgID, aMsg) {},</span>
<a href="#l2.20"></a><span id="l2.20">   onStopSending: function (aMsgID, aStatus, aMsg, aReturnFile) {},</span>
<a href="#l2.21"></a><span id="l2.21">   onGetDraftFolderURI: function (aFolderURI) {},</span>
<a href="#l2.22"></a><span id="l2.22">   onSendNotPerformed: function (aMsgID, aStatus) {},</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_bug474774.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_bug474774.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -23,29 +23,37 @@ var msgSendLater = Cc[&quot;@mozilla.org/mess</span>
<a href="#l3.4"></a><span id="l3.4"> // sequence and ensures the data is correct.</span>
<a href="#l3.5"></a><span id="l3.5"> function msll() {</span>
<a href="#l3.6"></a><span id="l3.6"> }</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> msll.prototype = {</span>
<a href="#l3.9"></a><span id="l3.9">   _initialTotal: 0,</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11">   // nsIMsgSendLaterListener</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  onStartSending: function (aTotal) {</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  onStartSending: function (aTotalMessageCount) {</span>
<a href="#l3.14"></a><span id="l3.14">     this._initialTotal = 1;</span>
<a href="#l3.15"></a><span id="l3.15">     do_check_eq(msgSendLater.sendingMessages, true);</span>
<a href="#l3.16"></a><span id="l3.16">   },</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-  onProgress: function (aCurrentMessage, aTotal) {</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+  onMessageStartSending: function (aCurrentMessage, aTotalMessageCount,</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+                                   aMessageHeader, aIdentity) {</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+  },</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+  onMessageSendProgress: function (aCurrentMessage, aTotalMessageCount,</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+                                   aMessageSendPercent, aMessageCopyPercent) {</span>
<a href="#l3.23"></a><span id="l3.23">     // XXX Enable this function</span>
<a href="#l3.24"></a><span id="l3.24">   },</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-  onStopSending: function (aStatus, aMsg, aTotal, aSuccessful) {</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+  onMessageSendError: function (aCurrentMessage, aMessageHeader, aStatus,</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+                                aMsg) {</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+    do_throw(&quot;onMessageSendError should not have been called, status: &quot; + aStatus);</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+  },</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+  onStopSending: function (aStatus, aMsg, aTotalTried, aSuccessful) {</span>
<a href="#l3.31"></a><span id="l3.31">     do_test_finished();</span>
<a href="#l3.32"></a><span id="l3.32">     print(&quot;msll onStopSending\n&quot;);</span>
<a href="#l3.33"></a><span id="l3.33">     try {</span>
<a href="#l3.34"></a><span id="l3.34">       do_check_eq(aStatus, 0);</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-      do_check_eq(aTotal, 1);</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+      do_check_eq(aTotalTried, 1);</span>
<a href="#l3.37"></a><span id="l3.37">       do_check_eq(aSuccessful, 1);</span>
<a href="#l3.38"></a><span id="l3.38">       do_check_eq(this._initialTotal, 1);</span>
<a href="#l3.39"></a><span id="l3.39">       do_check_eq(msgSendLater.sendingMessages, false);</span>
<a href="#l3.40"></a><span id="l3.40"> </span>
<a href="#l3.41"></a><span id="l3.41">       do_check_transaction(transaction,</span>
<a href="#l3.42"></a><span id="l3.42">                            [&quot;EHLO test&quot;,</span>
<a href="#l3.43"></a><span id="l3.43">                             &quot;MAIL FROM:&lt;&quot; + kSender + &quot;&gt; SIZE=&quot; + originalData.length,</span>
<a href="#l3.44"></a><span id="l3.44">                             &quot;RCPT TO:&lt;&quot; + kTo + &quot;&gt;&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_sendBackground.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_sendBackground.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -27,25 +27,32 @@ msll.prototype = {</span>
<a href="#l4.4"></a><span id="l4.4">   _initialTotal: 0,</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6">   // nsIMsgSendLaterListener</span>
<a href="#l4.7"></a><span id="l4.7">   onStartSending: function (aTotal) {</span>
<a href="#l4.8"></a><span id="l4.8">     this._initialTotal = 1;</span>
<a href="#l4.9"></a><span id="l4.9">     do_check_eq(gMsgSendLater.sendingMessages, true);</span>
<a href="#l4.10"></a><span id="l4.10">     do_check_eq(aTotal, 1);</span>
<a href="#l4.11"></a><span id="l4.11">   },</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  onProgress: function (aCurrentMessage, aTotal) {</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-    // XXX Enable this function</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+  onMessageStartSending: function (aCurrentMessage, aTotalMessageCount,</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+                                   aMessageHeader, aIdentity) {</span>
<a href="#l4.16"></a><span id="l4.16">   },</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-  onStopSending: function (aStatus, aMsg, aTotal, aSuccessful) {</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+  onMessageSendProgress: function (aCurrentMessage, aTotalMessageCount,</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+                                   aMessageSendPercent, aMessageCopyPercent) {</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+  }, </span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+  onMessageSendError: function (aCurrentMessage, aMessageHeader, aStatus,</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+                                aMsg) {</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+    do_throw(&quot;onMessageSendError should not have been called, status: &quot; + aStatus);</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+  },</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+  onStopSending: function (aStatus, aMsg, aTotalTried, aSuccessful) {</span>
<a href="#l4.26"></a><span id="l4.26">     do_test_finished();</span>
<a href="#l4.27"></a><span id="l4.27">     print(&quot;msll onStopSending\n&quot;);</span>
<a href="#l4.28"></a><span id="l4.28">     try {</span>
<a href="#l4.29"></a><span id="l4.29">       do_check_eq(aStatus, 0);</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-      do_check_eq(aTotal, 1);</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+      do_check_eq(aTotalTried, 1);</span>
<a href="#l4.32"></a><span id="l4.32">       do_check_eq(aSuccessful, 1);</span>
<a href="#l4.33"></a><span id="l4.33">       do_check_eq(this._initialTotal, 1);</span>
<a href="#l4.34"></a><span id="l4.34">       do_check_eq(gMsgSendLater.sendingMessages, false);</span>
<a href="#l4.35"></a><span id="l4.35"> </span>
<a href="#l4.36"></a><span id="l4.36">       do_check_transaction(transaction,</span>
<a href="#l4.37"></a><span id="l4.37">                            [&quot;EHLO test&quot;,</span>
<a href="#l4.38"></a><span id="l4.38">                             &quot;MAIL FROM:&lt;&quot; + kSender + &quot;&gt; SIZE=&quot; + originalData.length,</span>
<a href="#l4.39"></a><span id="l4.39">                             &quot;RCPT TO:&lt;&quot; + kTo + &quot;&gt;&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_sendMessageLater.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_sendMessageLater.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -28,31 +28,42 @@ var msgSendLater = Cc[&quot;@mozilla.org/mess</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5"> // This listener handles the post-sending of the actual message and checks the</span>
<a href="#l5.6"></a><span id="l5.6"> // sequence and ensures the data is correct.</span>
<a href="#l5.7"></a><span id="l5.7"> function msll() {</span>
<a href="#l5.8"></a><span id="l5.8"> }</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10"> msll.prototype = {</span>
<a href="#l5.11"></a><span id="l5.11">   _initialTotal: 0,</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+  _startedSending: false,</span>
<a href="#l5.13"></a><span id="l5.13"> </span>
<a href="#l5.14"></a><span id="l5.14">   // nsIMsgSendLaterListener</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-  onStartSending: function (aTotal) {</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+  onStartSending: function (aTotalMessageCount) {</span>
<a href="#l5.17"></a><span id="l5.17">     this._initialTotal = 1;</span>
<a href="#l5.18"></a><span id="l5.18">     do_check_eq(msgSendLater.sendingMessages, true);</span>
<a href="#l5.19"></a><span id="l5.19">   },</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineminus">-  onProgress: function (aCurrentMessage, aTotal) {</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+  onMessageStartSending: function (aCurrentMessage, aTotalMessageCount,</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+                                   aMessageHeader, aIdentity) {</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+    this._startedSending = true;</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+  },</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+  onMessageSendProgress: function (aCurrentMessage, aTotalMessageCount,</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+                                   aMessageSendPercent, aMessageCopyPercent) {</span>
<a href="#l5.27"></a><span id="l5.27">     // XXX Enable this function</span>
<a href="#l5.28"></a><span id="l5.28">   },</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">-  onStopSending: function (aStatus, aMsg, aTotal, aSuccessful) {</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+  onMessageSendError: function (aCurrentMessage, aMessageHeader, aStatus,</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+                                aMsg) {</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+    do_throw(&quot;onMessageSendError should not have been called, status: &quot; + aStatus);</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+  },</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+  onStopSending: function (aStatus, aMsg, aTotalTried, aSuccessful) {</span>
<a href="#l5.35"></a><span id="l5.35">     do_test_finished();</span>
<a href="#l5.36"></a><span id="l5.36">     print(&quot;msll onStopSending\n&quot;);</span>
<a href="#l5.37"></a><span id="l5.37">     try {</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+      do_check_eq(this._startedSending, true);</span>
<a href="#l5.39"></a><span id="l5.39">       do_check_eq(aStatus, 0);</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-      do_check_eq(aTotal, 1);</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+      do_check_eq(aTotalTried, 1);</span>
<a href="#l5.42"></a><span id="l5.42">       do_check_eq(aSuccessful, 1);</span>
<a href="#l5.43"></a><span id="l5.43">       do_check_eq(this._initialTotal, 1);</span>
<a href="#l5.44"></a><span id="l5.44">       do_check_eq(msgSendLater.sendingMessages, false);</span>
<a href="#l5.45"></a><span id="l5.45"> </span>
<a href="#l5.46"></a><span id="l5.46">       do_check_transaction(transaction,</span>
<a href="#l5.47"></a><span id="l5.47">                            [&quot;EHLO test&quot;,</span>
<a href="#l5.48"></a><span id="l5.48">                             &quot;MAIL FROM:&lt;&quot; + kSender + &quot;&gt; SIZE=&quot; + originalData.length,</span>
<a href="#l5.49"></a><span id="l5.49">                             &quot;RCPT TO:&lt;&quot; + kTo + &quot;&gt;&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_sendMessageLater2.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_sendMessageLater2.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -6,128 +6,122 @@</span>
<a href="#l6.4"></a><span id="l6.4">  * XXX: This test is intended to additionally test sending of multiple messages</span>
<a href="#l6.5"></a><span id="l6.5">  * from one send later instance, however due to the fact we use one connection</span>
<a href="#l6.6"></a><span id="l6.6">  * per message sent, it is very difficult to consistently get the fake server</span>
<a href="#l6.7"></a><span id="l6.7">  * reconected in time for the next connection. Thus, sending of multiple</span>
<a href="#l6.8"></a><span id="l6.8">  * messages is currently disabled (but commented out for local testing if</span>
<a href="#l6.9"></a><span id="l6.9">  * required), when we fix bug 136871 we should be able to enable the multiple</span>
<a href="#l6.10"></a><span id="l6.10">  * messages option. </span>
<a href="#l6.11"></a><span id="l6.11">  */</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+load(&quot;../../mailnews/resources/asyncTestUtils.js&quot;);</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+</span>
<a href="#l6.15"></a><span id="l6.15"> var test = &quot;sendMessageLater&quot;;</span>
<a href="#l6.16"></a><span id="l6.16"> var server = null;</span>
<a href="#l6.17"></a><span id="l6.17"> var gSentFolder;</span>
<a href="#l6.18"></a><span id="l6.18"> var transaction;</span>
<a href="#l6.19"></a><span id="l6.19"> var originalData;</span>
<a href="#l6.20"></a><span id="l6.20"> var identity = null;</span>
<a href="#l6.21"></a><span id="l6.21"> var gMsgFile =</span>
<a href="#l6.22"></a><span id="l6.22"> [</span>
<a href="#l6.23"></a><span id="l6.23">   do_get_file(&quot;data/message1.eml&quot;),</span>
<a href="#l6.24"></a><span id="l6.24">   do_get_file(&quot;data/429891_testcase.eml&quot;)</span>
<a href="#l6.25"></a><span id="l6.25"> ];</span>
<a href="#l6.26"></a><span id="l6.26"> var gMsgFileData = [];</span>
<a href="#l6.27"></a><span id="l6.27"> var gMsgOrder = [];</span>
<a href="#l6.28"></a><span id="l6.28"> var gCurTestNum = 0;</span>
<a href="#l6.29"></a><span id="l6.29"> var gLastSentMessage = 0;</span>
<a href="#l6.30"></a><span id="l6.30"> </span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+// gMessageSendStatus</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+// 0 = initial value</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+// 1 = send completed before exiting sendUnsentMessages</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+// 2 = sendUnsentMessages has exited.</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+var gMessageSendStatus = 0;</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+</span>
<a href="#l6.37"></a><span id="l6.37"> const kSender = &quot;from@invalid.com&quot;;</span>
<a href="#l6.38"></a><span id="l6.38"> const kTo = &quot;to@invalid.com&quot;;</span>
<a href="#l6.39"></a><span id="l6.39"> </span>
<a href="#l6.40"></a><span id="l6.40"> var msgSendLater = Cc[&quot;@mozilla.org/messengercompose/sendlater;1&quot;]</span>
<a href="#l6.41"></a><span id="l6.41">                      .getService(Ci.nsIMsgSendLater);</span>
<a href="#l6.42"></a><span id="l6.42"> </span>
<a href="#l6.43"></a><span id="l6.43"> // This listener handles the post-sending of the actual message and checks the</span>
<a href="#l6.44"></a><span id="l6.44"> // sequence and ensures the data is correct.</span>
<a href="#l6.45"></a><span id="l6.45"> function msll() {</span>
<a href="#l6.46"></a><span id="l6.46"> }</span>
<a href="#l6.47"></a><span id="l6.47"> </span>
<a href="#l6.48"></a><span id="l6.48"> msll.prototype = {</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+  checkMessageSend: function(aCurrentMessage) {</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+    do_check_transaction(transaction,</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+                         [&quot;EHLO test&quot;,</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+                          &quot;MAIL FROM:&lt;&quot; + kSender + &quot;&gt; SIZE=&quot; + gMsgFileData[gMsgOrder[aCurrentMessage - 1]].length,</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+                          &quot;RCPT TO:&lt;&quot; + kTo + &quot;&gt;&quot;,</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+                          &quot;DATA&quot;]);</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+    transaction = null;</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+    // Compare data file to what the server received</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+    do_check_eq(gMsgFileData[gMsgOrder[aCurrentMessage - 1]], server._handler.post);</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+  },</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+</span>
<a href="#l6.61"></a><span id="l6.61">   // nsIMsgSendLaterListener</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-  onStartSending: function (aTotal) {</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+  onStartSending: function (aTotalMessageCount) {</span>
<a href="#l6.64"></a><span id="l6.64">     do_check_eq(aTotal, gMsgOrder.length);</span>
<a href="#l6.65"></a><span id="l6.65">     do_check_eq(msgSendLater.sendingMessages, true);</span>
<a href="#l6.66"></a><span id="l6.66">   },</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineminus">-  onProgress: function (aCurrentMessage, aTotal) {</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineminus">-    try {</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineminus">-      do_check_eq(aTotal, gMsgOrder.length);</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineminus">-      do_check_eq(gLastSentMessage + 1, aCurrentMessage);</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineminus">-      gLastSentMessage = aCurrentMessage;</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineminus">-      do_check_eq(msgSendLater.sendingMessages, true);</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineminus">-</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineminus">-      do_check_transaction(transaction,</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineminus">-                           [&quot;EHLO test&quot;,</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineminus">-                            &quot;MAIL FROM:&lt;&quot; + kSender + &quot;&gt; SIZE=&quot; + gMsgFileData[gMsgOrder[aCurrentMessage - 1]].length,</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineminus">-                            &quot;RCPT TO:&lt;&quot; + kTo + &quot;&gt;&quot;,</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineminus">-                            &quot;DATA&quot;]);</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineminus">-      transaction = null;</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">-</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-      // Compare data file to what the server received</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineminus">-      do_check_eq(gMsgFileData[gMsgOrder[aCurrentMessage - 1]], server._handler.post);</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineminus">-</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineminus">-      // XXX We've got more messages to receive so restart the server for the</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineminus">-      // new connection, at least until bug 136871 is fixed - we reset and stop</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-      // the server on exit, the next test runs the server for the next message.</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineminus">-      do_timeout(0, &quot;doTest(++gCurTestNum)&quot;);</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineminus">-    } catch (e) {</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineminus">-      do_throw(e);</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineminus">-    } finally {</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">-      // Reset</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineminus">-      server.resetTest();</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineminus">-</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineminus">-      // XXX This is the way we currently try and restart the server which</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineminus">-      // doesn't always work, once we fix bug 136871 just calling resetTest and</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineminus">-      // ensuring we play the transaction should be enough.</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineminus">-      server.stop();</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineminus">-      </span>
<a href="#l6.99"></a><span id="l6.99" class="difflineminus">-      var thread = gThreadManager.currentThread;</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineminus">-      while (thread.hasPendingEvents())</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineminus">-        thread.processNextEvent(true);</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineminus">-      server.start(SMTP_PORT);</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineminus">-</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineminus">-      var thread = gThreadManager.currentThread;</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineminus">-      while (thread.hasPendingEvents())</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineminus">-        thread.processNextEvent(true);</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineminus">-    }</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineplus">+  onMessageStartSending: function (aCurrentMessage, aTotalMessageCount,</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineplus">+                                   aMessageHeader, aIdentity) {</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineplus">+    if (gLastSentMessage &gt; 0)</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+      this.checkMessageSend(aCurrentMessage);</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+    do_check_eq(gLastSentMessage + 1, aCurrentMessage);</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+    gLastSentMessage = aCurrentMessage;</span>
<a href="#l6.114"></a><span id="l6.114">   },</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineminus">-  onStopSending: function (aStatus, aMsg, aTotal, aSuccessful) {</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineplus">+  onMessageSendProgress: function (aCurrentMessage, aTotalMessageCount,</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineplus">+                                   aMessageSendPercent, aMessageCopyPercent) {</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineplus">+    do_check_eq(aTotalMessageCount, gMsgOrder.length);</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineplus">+    do_check_eq(gLastSentMessage, aCurrentMessage);</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineplus">+    do_check_eq(msgSendLater.sendingMessages, true);</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineplus">+  },</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineplus">+  onMessageSendError: function (aCurrentMessage, aMessageHeader, aStatus,</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineplus">+                                aMsg) {</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineplus">+    do_throw(&quot;onMessageSendError should not have been called, status: &quot; + aStatus);</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineplus">+  },</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineplus">+  onStopSending: function (aStatus, aMsg, aTotalTried, aSuccessful) {</span>
<a href="#l6.127"></a><span id="l6.127">     try {</span>
<a href="#l6.128"></a><span id="l6.128">       do_check_eq(aStatus, 0);</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineminus">-      do_check_eq(aTotal, aSuccessful);</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineplus">+      do_check_eq(aTotalTried, aSuccessful);</span>
<a href="#l6.131"></a><span id="l6.131">       do_check_eq(msgSendLater.sendingMessages, false);</span>
<a href="#l6.132"></a><span id="l6.132"> </span>
<a href="#l6.133"></a><span id="l6.133">       // Check that the send later service now thinks we don't have messages to</span>
<a href="#l6.134"></a><span id="l6.134">       // send.</span>
<a href="#l6.135"></a><span id="l6.135">       do_check_eq(msgSendLater.hasUnsentMessages(identity), false);</span>
<a href="#l6.136"></a><span id="l6.136"> </span>
<a href="#l6.137"></a><span id="l6.137">       // XXX This is another send multiple messages hack</span>
<a href="#l6.138"></a><span id="l6.138">       if (!transaction) {</span>
<a href="#l6.139"></a><span id="l6.139">         server.performTest();</span>
<a href="#l6.140"></a><span id="l6.140">         transaction = server.playTransaction();</span>
<a href="#l6.141"></a><span id="l6.141">       }</span>
<a href="#l6.142"></a><span id="l6.142"> </span>
<a href="#l6.143"></a><span id="l6.143" class="difflineminus">-      do_check_transaction(transaction,</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineminus">-                           [&quot;EHLO test&quot;,</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineminus">-                            &quot;MAIL FROM:&lt;&quot; + kSender + &quot;&gt; SIZE=&quot; + gMsgFileData[gMsgOrder[aTotal - 1]].length,</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineminus">-                            &quot;RCPT TO:&lt;&quot; + kTo + &quot;&gt;&quot;,</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineminus">-                            &quot;DATA&quot;]);</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineminus">-      transaction = null;</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineminus">-</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineminus">-      // Compare data file to what the server received</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineminus">-      do_check_eq(gMsgFileData[gMsgOrder[aTotal - 1]], server._handler.post);</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineminus">-</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineminus">-      do_timeout(0, &quot;doTest(++gCurTestNum)&quot;);</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineplus">+      this.checkMessageSend(gLastSentMessage);</span>
<a href="#l6.155"></a><span id="l6.155">     } catch (e) {</span>
<a href="#l6.156"></a><span id="l6.156">       dump(e);</span>
<a href="#l6.157"></a><span id="l6.157">       do_throw(e);</span>
<a href="#l6.158"></a><span id="l6.158">     } finally {</span>
<a href="#l6.159"></a><span id="l6.159">       server.resetTest();</span>
<a href="#l6.160"></a><span id="l6.160">       server.stop();</span>
<a href="#l6.161"></a><span id="l6.161"> </span>
<a href="#l6.162"></a><span id="l6.162">       var thread = gThreadManager.currentThread;</span>
<a href="#l6.163"></a><span id="l6.163">       while (thread.hasPendingEvents())</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineminus">-        thread.processNextEvent(true);</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineplus">+      thread.processNextEvent(true);</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineplus">+    }</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineplus">+    if (gMessageSendStatus == 0) {</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineplus">+      dump(&quot;gMessageSendStatus to 1\n&quot;);</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineplus">+      gMessageSendStatus = 1;</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineplus">+    }</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineplus">+    else if (gMessageSendStatus == 2) {</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineplus">+      dump(&quot;next driver\n&quot;);</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineplus">+      async_driver();</span>
<a href="#l6.174"></a><span id="l6.174">     }</span>
<a href="#l6.175"></a><span id="l6.175">   }</span>
<a href="#l6.176"></a><span id="l6.176"> };</span>
<a href="#l6.177"></a><span id="l6.177"> </span>
<a href="#l6.178"></a><span id="l6.178"> // This function is used to find out when the copying of the message to the</span>
<a href="#l6.179"></a><span id="l6.179"> // unsent message folder is completed, and hence can fire off the actual</span>
<a href="#l6.180"></a><span id="l6.180"> // sending of the message.</span>
<a href="#l6.181"></a><span id="l6.181"> function OnStopCopy(aStatus)</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineat">@@ -140,17 +134,17 @@ function OnStopCopy(aStatus)</span>
<a href="#l6.183"></a><span id="l6.183">   // Check that the send later service thinks we have messages to send.</span>
<a href="#l6.184"></a><span id="l6.184">   do_check_eq(msgSendLater.hasUnsentMessages(identity), true);</span>
<a href="#l6.185"></a><span id="l6.185"> </span>
<a href="#l6.186"></a><span id="l6.186">   // Check we have a message in the unsent message folder</span>
<a href="#l6.187"></a><span id="l6.187">   do_check_eq(gSentFolder.getTotalMessages(false), gMsgOrder.length);</span>
<a href="#l6.188"></a><span id="l6.188"> </span>
<a href="#l6.189"></a><span id="l6.189">   // Start the next step after a brief time so that functions can finish</span>
<a href="#l6.190"></a><span id="l6.190">   // properly</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineminus">-  do_timeout(0, &quot;doTest(++gCurTestNum);&quot;);</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineplus">+  async_driver();</span>
<a href="#l6.193"></a><span id="l6.193"> }</span>
<a href="#l6.194"></a><span id="l6.194"> </span>
<a href="#l6.195"></a><span id="l6.195"> function sendMessageLater(aTestFileIndex)</span>
<a href="#l6.196"></a><span id="l6.196"> {</span>
<a href="#l6.197"></a><span id="l6.197">   gMsgOrder.push(aTestFileIndex);</span>
<a href="#l6.198"></a><span id="l6.198"> </span>
<a href="#l6.199"></a><span id="l6.199">   // Prepare to actually &quot;send&quot; the message later, i.e. dump it in the</span>
<a href="#l6.200"></a><span id="l6.200">   // unsent messages folder.</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineat">@@ -162,90 +156,89 @@ function sendMessageLater(aTestFileIndex</span>
<a href="#l6.202"></a><span id="l6.202">   compFields.to = kTo;</span>
<a href="#l6.203"></a><span id="l6.203"> </span>
<a href="#l6.204"></a><span id="l6.204">   var msgSend = Cc[&quot;@mozilla.org/messengercompose/send;1&quot;]</span>
<a href="#l6.205"></a><span id="l6.205">                   .createInstance(Ci.nsIMsgSend);</span>
<a href="#l6.206"></a><span id="l6.206"> </span>
<a href="#l6.207"></a><span id="l6.207">   msgSend.sendMessageFile(identity, &quot;&quot;, compFields, gMsgFile[aTestFileIndex],</span>
<a href="#l6.208"></a><span id="l6.208">                           false, false, Ci.nsIMsgSend.nsMsgQueueForLater,</span>
<a href="#l6.209"></a><span id="l6.209">                           null, copyListener, null, null);</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineplus">+  return false;</span>
<a href="#l6.211"></a><span id="l6.211"> }</span>
<a href="#l6.212"></a><span id="l6.212"> </span>
<a href="#l6.213"></a><span id="l6.213"> function resetCounts()</span>
<a href="#l6.214"></a><span id="l6.214"> {</span>
<a href="#l6.215"></a><span id="l6.215">   gMsgOrder = [];</span>
<a href="#l6.216"></a><span id="l6.216">   gLastSentMessage = 0;</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineminus">-  do_timeout(0, &quot;doTest(++gCurTestNum);&quot;);</span>
<a href="#l6.218"></a><span id="l6.218"> }</span>
<a href="#l6.219"></a><span id="l6.219"> </span>
<a href="#l6.220"></a><span id="l6.220"> // This function does the actual send later</span>
<a href="#l6.221"></a><span id="l6.221"> function sendUnsentMessages()</span>
<a href="#l6.222"></a><span id="l6.222"> {</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineplus">+  gMessageSendStatus = 0;</span>
<a href="#l6.224"></a><span id="l6.224">   // Handle the server in a try/catch/finally loop so that we always will stop</span>
<a href="#l6.225"></a><span id="l6.225">   // the server if something fails.</span>
<a href="#l6.226"></a><span id="l6.226">   try {</span>
<a href="#l6.227"></a><span id="l6.227">     // Start the fake SMTP server</span>
<a href="#l6.228"></a><span id="l6.228">     server.start(SMTP_PORT);</span>
<a href="#l6.229"></a><span id="l6.229"> </span>
<a href="#l6.230"></a><span id="l6.230">     // Send the unsent message</span>
<a href="#l6.231"></a><span id="l6.231">     msgSendLater.sendUnsentMessages(identity);</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineminus">-</span>
<a href="#l6.233"></a><span id="l6.233">     server.performTest();</span>
<a href="#l6.234"></a><span id="l6.234"> </span>
<a href="#l6.235"></a><span id="l6.235">     transaction = server.playTransaction();</span>
<a href="#l6.236"></a><span id="l6.236">   } catch (e) {</span>
<a href="#l6.237"></a><span id="l6.237">     do_throw(e);</span>
<a href="#l6.238"></a><span id="l6.238">   } finally {</span>
<a href="#l6.239"></a><span id="l6.239">     server.stop();</span>
<a href="#l6.240"></a><span id="l6.240"> </span>
<a href="#l6.241"></a><span id="l6.241">     var thread = gThreadManager.currentThread;</span>
<a href="#l6.242"></a><span id="l6.242">     while (thread.hasPendingEvents())</span>
<a href="#l6.243"></a><span id="l6.243">       thread.processNextEvent(true);</span>
<a href="#l6.244"></a><span id="l6.244">   }</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineplus">+  if (!gMessageSendStatus)</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineplus">+    gMessageSendStatus = 2;</span>
<a href="#l6.247"></a><span id="l6.247" class="difflineplus">+</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineplus">+  return gMessageSendStatus == 1;</span>
<a href="#l6.249"></a><span id="l6.249"> }</span>
<a href="#l6.250"></a><span id="l6.250"> </span>
<a href="#l6.251"></a><span id="l6.251"> function runServerTest()</span>
<a href="#l6.252"></a><span id="l6.252"> {</span>
<a href="#l6.253"></a><span id="l6.253">   server.performTest();</span>
<a href="#l6.254"></a><span id="l6.254"> </span>
<a href="#l6.255"></a><span id="l6.255">   transaction = server.playTransaction();</span>
<a href="#l6.256"></a><span id="l6.256"> }</span>
<a href="#l6.257"></a><span id="l6.257"> </span>
<a href="#l6.258"></a><span id="l6.258" class="difflineminus">-// Beware before commenting out a test</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineminus">-// -- later tests might just depend on earlier ones</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineminus">-const gTestArray =</span>
<a href="#l6.261"></a><span id="l6.261" class="difflineminus">-[</span>
<a href="#l6.262"></a><span id="l6.262" class="difflineminus">-  // Copying message from file to folder.</span>
<a href="#l6.263"></a><span id="l6.263" class="difflineminus">-  function testSendLater1() { sendMessageLater(0); },</span>
<a href="#l6.264"></a><span id="l6.264" class="difflineplus">+function actually_run_test() {</span>
<a href="#l6.265"></a><span id="l6.265" class="difflineplus">+  dump(&quot;in actually_run_test\n&quot;);</span>
<a href="#l6.266"></a><span id="l6.266" class="difflineplus">+</span>
<a href="#l6.267"></a><span id="l6.267" class="difflineplus">+  dump(&quot;Copy Mesage from file to folder\n&quot;);</span>
<a href="#l6.268"></a><span id="l6.268" class="difflineplus">+  yield async_run({func: sendMessageLater, args: [0]});</span>
<a href="#l6.269"></a><span id="l6.269"> </span>
<a href="#l6.270"></a><span id="l6.270" class="difflineminus">-  // Now send unsent message</span>
<a href="#l6.271"></a><span id="l6.271" class="difflineminus">-  function testSendUnsentMessages1() { sendUnsentMessages(); },</span>
<a href="#l6.272"></a><span id="l6.272" class="difflineplus">+  dump(&quot;Send unsent message\n&quot;);</span>
<a href="#l6.273"></a><span id="l6.273" class="difflineplus">+  yield async_run({func: sendUnsentMessages});</span>
<a href="#l6.274"></a><span id="l6.274"> </span>
<a href="#l6.275"></a><span id="l6.275" class="difflineminus">-  function testSentEmpty() {</span>
<a href="#l6.276"></a><span id="l6.276" class="difflineminus">-    do_check_eq(gSentFolder.getTotalMessages(false), 0);</span>
<a href="#l6.277"></a><span id="l6.277" class="difflineminus">-    doTest(++gCurTestNum);</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineminus">-  },</span>
<a href="#l6.279"></a><span id="l6.279" class="difflineplus">+  // Check sent folder is now empty.</span>
<a href="#l6.280"></a><span id="l6.280" class="difflineplus">+  do_check_eq(gSentFolder.getTotalMessages(false), 0);</span>
<a href="#l6.281"></a><span id="l6.281"> </span>
<a href="#l6.282"></a><span id="l6.282" class="difflineminus">-  // This function just resets a few counts where necessary.</span>
<a href="#l6.283"></a><span id="l6.283" class="difflineminus">-  function testResetCounts() { resetCounts(); },</span>
<a href="#l6.284"></a><span id="l6.284" class="difflineplus">+  // and reset counts</span>
<a href="#l6.285"></a><span id="l6.285" class="difflineplus">+  resetCounts();</span>
<a href="#l6.286"></a><span id="l6.286" class="difflineplus">+</span>
<a href="#l6.287"></a><span id="l6.287" class="difflineplus">+  dump(&quot;Copy more messages\n&quot;);</span>
<a href="#l6.288"></a><span id="l6.288" class="difflineplus">+  yield async_run({func: sendMessageLater, args: [1]});</span>
<a href="#l6.289"></a><span id="l6.289"> </span>
<a href="#l6.290"></a><span id="l6.290" class="difflineminus">-  // Now copy more messages...</span>
<a href="#l6.291"></a><span id="l6.291" class="difflineminus">-  function testCopyFileMessage2() {</span>
<a href="#l6.292"></a><span id="l6.292" class="difflineminus">-    sendMessageLater(1);</span>
<a href="#l6.293"></a><span id="l6.293" class="difflineminus">-    // XXX Only do one the second time round, as described at the start of the</span>
<a href="#l6.294"></a><span id="l6.294" class="difflineminus">-    // file.</span>
<a href="#l6.295"></a><span id="l6.295" class="difflineminus">-    //    sendMessageLater(0);</span>
<a href="#l6.296"></a><span id="l6.296" class="difflineminus">-  },</span>
<a href="#l6.297"></a><span id="l6.297" class="difflineminus">-  // ...and send again</span>
<a href="#l6.298"></a><span id="l6.298" class="difflineminus">-  function testSendUnsentMessages2() { sendUnsentMessages(); },</span>
<a href="#l6.299"></a><span id="l6.299" class="difflineplus">+  // XXX Only do one the second time round, as described at the start of the</span>
<a href="#l6.300"></a><span id="l6.300" class="difflineplus">+  // file.</span>
<a href="#l6.301"></a><span id="l6.301" class="difflineplus">+  // yield async_run({func: sendMessageLater, args: [0]});</span>
<a href="#l6.302"></a><span id="l6.302"> </span>
<a href="#l6.303"></a><span id="l6.303" class="difflineminus">-  // XXX This may be needed if sending more than one message in the second</span>
<a href="#l6.304"></a><span id="l6.304" class="difflineminus">-  // stage.</span>
<a href="#l6.305"></a><span id="l6.305" class="difflineminus">-  //  function testRunServer() { runServerTest(); }</span>
<a href="#l6.306"></a><span id="l6.306" class="difflineminus">-];</span>
<a href="#l6.307"></a><span id="l6.307" class="difflineplus">+  dump(&quot;Test send again\n&quot;);</span>
<a href="#l6.308"></a><span id="l6.308" class="difflineplus">+  yield async_run({func: sendUnsentMessages});</span>
<a href="#l6.309"></a><span id="l6.309" class="difflineplus">+</span>
<a href="#l6.310"></a><span id="l6.310" class="difflineplus">+  do_test_finished();</span>
<a href="#l6.311"></a><span id="l6.311" class="difflineplus">+}</span>
<a href="#l6.312"></a><span id="l6.312"> </span>
<a href="#l6.313"></a><span id="l6.313"> function run_test() {</span>
<a href="#l6.314"></a><span id="l6.314">   // Load in the test files so we have a record of length and their data.</span>
<a href="#l6.315"></a><span id="l6.315">   for (var i = 0; i &lt; gMsgFile.length; ++i) {</span>
<a href="#l6.316"></a><span id="l6.316">     gMsgFileData[i] = loadFileToString(gMsgFile[i]);</span>
<a href="#l6.317"></a><span id="l6.317">   }</span>
<a href="#l6.318"></a><span id="l6.318"> </span>
<a href="#l6.319"></a><span id="l6.319">   // Ensure we have a local mail account, an normal account and appropriate</span>
<a href="#l6.320"></a><span id="l6.320" class="difflineat">@@ -285,33 +278,10 @@ function run_test() {</span>
<a href="#l6.321"></a><span id="l6.321">   server = setupServerDaemon();</span>
<a href="#l6.322"></a><span id="l6.322">   server.setDebugLevel(fsDebugRecv);</span>
<a href="#l6.323"></a><span id="l6.323"> </span>
<a href="#l6.324"></a><span id="l6.324">   // &quot;Master&quot; do_test_pending(), paired with a do_test_finished() at the end of</span>
<a href="#l6.325"></a><span id="l6.325">   // all the operations.</span>
<a href="#l6.326"></a><span id="l6.326">   do_test_pending();</span>
<a href="#l6.327"></a><span id="l6.327"> </span>
<a href="#l6.328"></a><span id="l6.328">   // Do the test</span>
<a href="#l6.329"></a><span id="l6.329" class="difflineminus">-  doTest(1);</span>
<a href="#l6.330"></a><span id="l6.330" class="difflineplus">+  async_run({func: actually_run_test});</span>
<a href="#l6.331"></a><span id="l6.331"> }</span>
<a href="#l6.332"></a><span id="l6.332" class="difflineminus">-</span>
<a href="#l6.333"></a><span id="l6.333" class="difflineminus">-function doTest(test)</span>
<a href="#l6.334"></a><span id="l6.334" class="difflineminus">-{</span>
<a href="#l6.335"></a><span id="l6.335" class="difflineminus">-  dump(&quot;doTest &quot; + test + &quot;\n&quot;);</span>
<a href="#l6.336"></a><span id="l6.336" class="difflineminus">-  if (test &lt;= gTestArray.length) {</span>
<a href="#l6.337"></a><span id="l6.337" class="difflineminus">-    gCurTestNum = test;</span>
<a href="#l6.338"></a><span id="l6.338" class="difflineminus">-</span>
<a href="#l6.339"></a><span id="l6.339" class="difflineminus">-    var testFn = gTestArray[test-1];</span>
<a href="#l6.340"></a><span id="l6.340" class="difflineminus">-</span>
<a href="#l6.341"></a><span id="l6.341" class="difflineminus">-    // Set a limit in case the notifications haven't arrived (i.e. a problem)</span>
<a href="#l6.342"></a><span id="l6.342" class="difflineminus">-    do_timeout(10000, &quot;if (gCurTestNum == &quot;+test+&quot;)               \</span>
<a href="#l6.343"></a><span id="l6.343" class="difflineminus">-               do_throw('Notifications not received in 10000 ms for operation &quot;+testFn.name+&quot;, current status is '+gCurrStatus);&quot;);</span>
<a href="#l6.344"></a><span id="l6.344" class="difflineminus">-    try {</span>
<a href="#l6.345"></a><span id="l6.345" class="difflineminus">-      testFn();</span>
<a href="#l6.346"></a><span id="l6.346" class="difflineminus">-    } catch(ex) {</span>
<a href="#l6.347"></a><span id="l6.347" class="difflineminus">-      dump(ex);</span>
<a href="#l6.348"></a><span id="l6.348" class="difflineminus">-      do_throw(ex);</span>
<a href="#l6.349"></a><span id="l6.349" class="difflineminus">-    }</span>
<a href="#l6.350"></a><span id="l6.350" class="difflineminus">-  }</span>
<a href="#l6.351"></a><span id="l6.351" class="difflineminus">-  else {</span>
<a href="#l6.352"></a><span id="l6.352" class="difflineminus">-    do_test_finished(); // for the one in run_test()</span>
<a href="#l6.353"></a><span id="l6.353" class="difflineminus">-  }</span>
<a href="#l6.354"></a><span id="l6.354" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_sendMessageLater3.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_sendMessageLater3.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -2,123 +2,72 @@</span>
<a href="#l7.4"></a><span id="l7.4"> /**</span>
<a href="#l7.5"></a><span id="l7.5">  * Protocol tests for SMTP.</span>
<a href="#l7.6"></a><span id="l7.6">  *</span>
<a href="#l7.7"></a><span id="l7.7">  * For trying to send a message later with no server connected, this test</span>
<a href="#l7.8"></a><span id="l7.8">  * verifies:</span>
<a href="#l7.9"></a><span id="l7.9">  *   - A correct status response.</span>
<a href="#l7.10"></a><span id="l7.10">  *   - A correct state at the end of attempting to send.</span>
<a href="#l7.11"></a><span id="l7.11">  */</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+load(&quot;../../mailnews/resources/alertTestUtils.js&quot;);</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+</span>
<a href="#l7.15"></a><span id="l7.15"> var type = null;</span>
<a href="#l7.16"></a><span id="l7.16"> var test = null;</span>
<a href="#l7.17"></a><span id="l7.17"> var server;</span>
<a href="#l7.18"></a><span id="l7.18"> var sentFolder;</span>
<a href="#l7.19"></a><span id="l7.19"> var transaction;</span>
<a href="#l7.20"></a><span id="l7.20"> var originalData;</span>
<a href="#l7.21"></a><span id="l7.21"> var finished = false;</span>
<a href="#l7.22"></a><span id="l7.22"> var identity = null;</span>
<a href="#l7.23"></a><span id="l7.23"> var testFile = do_get_file(&quot;data/429891_testcase.eml&quot;);</span>
<a href="#l7.24"></a><span id="l7.24"> </span>
<a href="#l7.25"></a><span id="l7.25"> const kSender = &quot;from@invalid.com&quot;;</span>
<a href="#l7.26"></a><span id="l7.26"> const kTo = &quot;to@invalid.com&quot;;</span>
<a href="#l7.27"></a><span id="l7.27"> </span>
<a href="#l7.28"></a><span id="l7.28"> var msgSendLater = Cc[&quot;@mozilla.org/messengercompose/sendlater;1&quot;]</span>
<a href="#l7.29"></a><span id="l7.29">   .getService(Ci.nsIMsgSendLater);</span>
<a href="#l7.30"></a><span id="l7.30"> </span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-// This allows the send code to attempt to display errors to the user without</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-// failing.</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-var prompts = {</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-  alert: function(aDialogTitle, aText) {</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-    dump(&quot;Hiding Alert {\n&quot; + aText + &quot;\n} End Alert\n&quot;);</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">-  },</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">-  </span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-  alertCheck: function(aDialogTitle, aText, aCheckMsg, aCheckState) {},</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-  </span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-  confirm: function(aDialogTitle, aText) {},</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-  </span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-  confirmCheck: function(aDialogTitle, aText, aCheckMsg, aCheckState) {},</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-  </span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-  confirmEx: function(aDialogTitle, aText, aButtonFlags, aButton0Title,</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">-		      aButton1Title, aButton2Title, aCheckMsg, aCheckState) {},</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineminus">-  </span>
<a href="#l7.47"></a><span id="l7.47" class="difflineminus">-  prompt: function(aDialogTitle, aText, aValue, aCheckMsg, aCheckState) {},</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-  </span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-  promptUsernameAndPassword: function(aDialogTitle, aText, aUsername,</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-				      aPassword, aCheckMsg, aCheckState) {},</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-  promptPassword: function(aDialogTitle, aText, aPassword, aCheckMsg,</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-			   aCheckState) {},</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-  </span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-  select: function(aDialogTitle, aText, aCount, aSelectList,</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineminus">-		   aOutSelection) {},</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-  </span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-  QueryInterface: function(iid) {</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineminus">-    if (iid.equals(Components.interfaces.nsIPrompt)</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineminus">-     || iid.equals(Components.interfaces.nsISupports))</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineminus">-      return this;</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-  </span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-    throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-  }</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineminus">-};</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-var WindowWatcher = {</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineminus">-  getNewPrompter: function(aParent) {</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-    return prompts;</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineminus">-  },</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineminus">-</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-  getNewAuthPrompter: function(aParent) {</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineminus">-    return prompts;</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineminus">-  },</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineminus">-  QueryInterface: function(iid) {</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineminus">-    if (iid.equals(Ci.nsIWindowWatcher) || iid.equals(Ci.nsISupports)) {</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineminus">-      return this;</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-    }</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineminus">-    throw Cr.NS_ERROR_NO_INTERFACE;</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-  }</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-};</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineminus">-</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineminus">-var WindowWatcherFactory = {</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineminus">-  createInstance: function createInstance(outer, iid) {</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineminus">-    if (outer != null)</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineminus">-      throw Components.results.NS_ERROR_NO_AGGREGATION;</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineminus">-    return WindowWatcher.QueryInterface(iid);</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineminus">-  }</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineminus">-};</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineminus">-</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineminus">-Components.manager.QueryInterface(Components.interfaces.nsIComponentRegistrar)</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineminus">-          .registerFactory(Components.ID(&quot;{1dfeb90a-2193-45d5-9cb8-864928b2af55}&quot;),</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineminus">-			   &quot;Fake Window Watcher&quot;,</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineminus">-			   &quot;@mozilla.org/embedcomp/window-watcher;1&quot;,</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineminus">-			   WindowWatcherFactory);</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+function alert(aDialogTitle, aText) {</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+  dump(&quot;Hiding Alert {\n&quot; + aText + &quot;\n} End Alert\n&quot;);</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+}</span>
<a href="#l7.101"></a><span id="l7.101"> </span>
<a href="#l7.102"></a><span id="l7.102"> // This listener handles the post-sending of the actual message and checks the</span>
<a href="#l7.103"></a><span id="l7.103"> // sequence and ensures the data is correct.</span>
<a href="#l7.104"></a><span id="l7.104"> function msll() {</span>
<a href="#l7.105"></a><span id="l7.105"> }</span>
<a href="#l7.106"></a><span id="l7.106"> </span>
<a href="#l7.107"></a><span id="l7.107"> msll.prototype = {</span>
<a href="#l7.108"></a><span id="l7.108">   _initialTotal: 0,</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+  _errorRaised: false,</span>
<a href="#l7.110"></a><span id="l7.110"> </span>
<a href="#l7.111"></a><span id="l7.111">   // nsIMsgSendLaterListener</span>
<a href="#l7.112"></a><span id="l7.112">   onStartSending: function (aTotal) {</span>
<a href="#l7.113"></a><span id="l7.113">     this._initialTotal = 1;</span>
<a href="#l7.114"></a><span id="l7.114">     do_check_eq(msgSendLater.sendingMessages, true);</span>
<a href="#l7.115"></a><span id="l7.115">   },</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineminus">-  onProgress: function (aCurrentMessage, aTotal) {</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+  onMessageStartSending: function (aCurrentMessage, aTotalMessageCount,</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+                                   aMessageHeader, aIdentity) {</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+  },</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineplus">+  onMessageSendProgress: function (aCurrentMessage, aTotalMessageCount,</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineplus">+                                   aMessageSendPercent, aMessageCopyPercent) {</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+  },</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+  onMessageSendError: function (aCurrentMessage, aMessageHeader, aStatus,</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+                                aMsg) {</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+    this._errorRaised = true;</span>
<a href="#l7.126"></a><span id="l7.126">   },</span>
<a href="#l7.127"></a><span id="l7.127">   onStopSending: function (aStatus, aMsg, aTotal, aSuccessful) {</span>
<a href="#l7.128"></a><span id="l7.128">     print(&quot;msll onStopSending\n&quot;);</span>
<a href="#l7.129"></a><span id="l7.129"> </span>
<a href="#l7.130"></a><span id="l7.130">     // NS_ERROR_SMTP_SEND_FAILED_REFUSED is 2153066798</span>
<a href="#l7.131"></a><span id="l7.131">     do_check_eq(aStatus, 2153066798);</span>
<a href="#l7.132"></a><span id="l7.132">     do_check_eq(aTotal, 1);</span>
<a href="#l7.133"></a><span id="l7.133">     do_check_eq(aSuccessful, 0);</span>
<a href="#l7.134"></a><span id="l7.134">     do_check_eq(this._initialTotal, 1);</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineplus">+    do_check_eq(this._errorRaised, true);</span>
<a href="#l7.136"></a><span id="l7.136">     do_check_eq(msgSendLater.sendingMessages, false);</span>
<a href="#l7.137"></a><span id="l7.137">     // Check that the send later service still thinks we have messages to send.</span>
<a href="#l7.138"></a><span id="l7.138">     do_check_eq(msgSendLater.hasUnsentMessages(identity), true);</span>
<a href="#l7.139"></a><span id="l7.139"> </span>
<a href="#l7.140"></a><span id="l7.140">     do_test_finished();</span>
<a href="#l7.141"></a><span id="l7.141">   }</span>
<a href="#l7.142"></a><span id="l7.142"> };</span>
<a href="#l7.143"></a><span id="l7.143"> </span>
<a href="#l7.144"></a><span id="l7.144" class="difflineat">@@ -159,16 +108,18 @@ function sendMessageLater()</span>
<a href="#l7.145"></a><span id="l7.145"> </span>
<a href="#l7.146"></a><span id="l7.146">   msgSendLater.addListener(messageListener);</span>
<a href="#l7.147"></a><span id="l7.147"> </span>
<a href="#l7.148"></a><span id="l7.148">   // Send the unsent message</span>
<a href="#l7.149"></a><span id="l7.149">   msgSendLater.sendUnsentMessages(identity);</span>
<a href="#l7.150"></a><span id="l7.150"> }</span>
<a href="#l7.151"></a><span id="l7.151"> </span>
<a href="#l7.152"></a><span id="l7.152"> function run_test() {</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineplus">+  registerAlertTestUtils();</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineplus">+</span>
<a href="#l7.155"></a><span id="l7.155">   // Test file - for bug 429891</span>
<a href="#l7.156"></a><span id="l7.156">   originalData = loadFileToString(testFile);</span>
<a href="#l7.157"></a><span id="l7.157"> </span>
<a href="#l7.158"></a><span id="l7.158">   // Ensure we have a local mail account, an normal account and appropriate</span>
<a href="#l7.159"></a><span id="l7.159">   // servers and identities.</span>
<a href="#l7.160"></a><span id="l7.160">   loadLocalMailAccount();</span>
<a href="#l7.161"></a><span id="l7.161"> </span>
<a href="#l7.162"></a><span id="l7.162">   // Check that the send later service thinks we don't have messages to send.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">new file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- /dev/null</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ b/mailnews/test/resources/alertTestUtils.js</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -0,0 +1,162 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineplus">+/*</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineplus">+ * This file provides support for writing mailnews tests that require hooking</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+ * into the alerts system. Normally these tests would require a UI and fail in</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+ * debug mode, but with this method you can hook into the alerts system and</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+ * avoid the UI.</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+ *</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+ * To register the system:</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+ *</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+ * function run_test() {</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+ *   registerAlertTestUtils();</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+ *   // ...</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+ * }</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+ *</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+ * You can then hook into the alerts just by defining a function of the same</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+ * name as the interface function:</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+ *</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+ * function alert(aDialogTitle, aText) {</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+ *   // do my check</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+ * }</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+ *</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+ * Interface functions that do not have equivalent functions defined and get</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+ * called will be treated as unexpected, and therefore they will call</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+ * do_throw().</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+ */</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+// This allows the send code to attempt to display errors to the user without</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+// failing.</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+var alertUtilsPrompts = {</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+  alert: function(aDialogTitle, aText) {</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+    if (typeof alert == &quot;function&quot;) {</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+      alert(aDialogTitle, aText);</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+      return;</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+    }</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+    do_throw(&quot;alert unexpectedly called\n&quot;);</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+  },</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+  </span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+  alertCheck: function(aDialogTitle, aText, aCheckMsg, aCheckState) {</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+    if (typeof alertCheck == &quot;function&quot;) {</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+      alertCheck(aDialogTitle, aText, aCheckMsg, aCheckState);</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+      return;</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+    }</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+    do_throw(&quot;alertCheck unexpectedly called\n&quot;);</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+  },</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+  </span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+  confirm: function(aDialogTitle, aText) {</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+    if (typeof confirm == &quot;function&quot;) {</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+      confirm(aDialogTitle, aText);</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+      return;</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+    }</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+    do_throw(&quot;confirm unexpectedly called\n&quot;);</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+  },</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+  </span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+  confirmCheck: function(aDialogTitle, aText, aCheckMsg, aCheckState) {</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+    if (typeof confirmCheck == &quot;function&quot;) {</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+      confirmCheck(aDialogTitle, aText, aCheckMsg, aCheckState);</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+      return;</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+    }</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+    do_throw(&quot;confirmCheck unexpectedly called\n&quot;);</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+  },</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+  </span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+  confirmEx: function(aDialogTitle, aText, aButtonFlags, aButton0Title,</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+		      aButton1Title, aButton2Title, aCheckMsg, aCheckState) {</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+    if (typeof confirmEx == &quot;function&quot;) {</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+      confirmEx(aDialogTitle, aText, aButtonFlags, aButton0Title,</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+		aButton1Title, aButton2Title, aCheckMsg, aCheckState);</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+      return;</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+    }</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+    do_throw(&quot;confirmEx unexpectedly called\n&quot;);</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+  },</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+  </span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+  prompt: function(aDialogTitle, aText, aValue, aCheckMsg, aCheckState) {</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+    if (typeof prompt == &quot;function&quot;) {</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+      prompt(aDialogTitle, aText, aValue, aCheckMsg, aCheckState);</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+      return;</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+    }</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+    do_throw(&quot;prompt unexpectedly called\n&quot;);</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+  },</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+  </span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+  promptUsernameAndPassword: function(aDialogTitle, aText, aUsername,</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+				      aPassword, aCheckMsg, aCheckState) {</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+    if (typeof promptUsernameAndPassword == &quot;function&quot;) {</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+      promptUsernameAndPassword(aDialogTitle, aText, aUsername,</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+				aPassword, aCheckMsg, aCheckState);</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+      return;</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+    }</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+    do_throw(&quot;promptUsernameAndPassword unexpectedly called\n&quot;);</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+  },</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+  promptPassword: function(aDialogTitle, aText, aPassword, aCheckMsg,</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+			   aCheckState) {</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+    if (typeof promptPassword == &quot;function&quot;) {</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineplus">+      promptPassword(aDialogTitle, aText, aPassword, aCheckMsg,</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+		     aCheckState);</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+      return;</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+    }</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+    do_throw(&quot;promptPassword unexpectedly called\n&quot;);</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+  },</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineplus">+  </span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+  select: function(aDialogTitle, aText, aCount, aSelectList,</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+		   aOutSelection) {</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+    if (typeof select == &quot;function&quot;) {</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineplus">+      select(aDialogTitle, aText, aCount, aSelectList,</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+	     aOutSelection);</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineplus">+      return;</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+    }</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+    do_throw(&quot;select unexpectedly called\n&quot;);</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+  },</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+  </span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+  QueryInterface: function(iid) {</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+    if (iid.equals(Components.interfaces.nsIPrompt)</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+     || iid.equals(Components.interfaces.nsISupports))</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+      return this;</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineplus">+    throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+  }</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+};</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineplus">+var alertUtilsWindowWatcher = {</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineplus">+  getNewPrompter: function(aParent) {</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineplus">+    return alertUtilsPrompts;</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+  },</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineplus">+</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineplus">+  getNewAuthPrompter: function(aParent) {</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineplus">+    return alertUtilsPrompts;</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+  },</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineplus">+</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineplus">+  QueryInterface: function(iid) {</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineplus">+    if (iid.equals(Ci.nsIWindowWatcher) || iid.equals(Ci.nsISupports)) {</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineplus">+      return this;</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineplus">+    }</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineplus">+</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineplus">+    throw Cr.NS_ERROR_NO_INTERFACE;</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineplus">+  }</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+};</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineplus">+</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineplus">+function registerAlertTestUtils()</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineplus">+{</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineplus">+  var WindowWatcherFactory = {</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineplus">+    createInstance: function createInstance(outer, iid) {</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineplus">+      if (outer != null)</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineplus">+	throw Components.results.NS_ERROR_NO_AGGREGATION;</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineplus">+      return alertUtilsWindowWatcher.QueryInterface(iid);</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineplus">+    }</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineplus">+  };</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineplus">+</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineplus">+  Components.manager.QueryInterface(Components.interfaces.nsIComponentRegistrar)</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineplus">+            .registerFactory(Components.ID(&quot;{1dfeb90a-2193-45d5-9cb8-864928b2af55}&quot;),</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineplus">+			     &quot;Fake Window Watcher&quot;,</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineplus">+			     &quot;@mozilla.org/embedcomp/window-watcher;1&quot;,</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineplus">+			     WindowWatcherFactory);</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineplus">+}</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

