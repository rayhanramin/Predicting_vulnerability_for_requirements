<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 5850:cd4402569153c86725797c26ae610cc85064dba6</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ cd4402569153c86725797c26ae610cc85064dba6" />
<meta property="og:url" content="/comm-central/rev/cd4402569153c86725797c26ae610cc85064dba6" />
<meta property="og:description" content="Bug 377319 Convert mailnews/compose to the external API r=Neil sr=bienvenu" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / cd4402569153c86725797c26ae610cc85064dba6 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/cd4402569153c86725797c26ae610cc85064dba6">shortlog</a> |
<a href="/comm-central/log/cd4402569153c86725797c26ae610cc85064dba6">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/cd4402569153c86725797c26ae610cc85064dba6">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/cd4402569153c86725797c26ae610cc85064dba6">files</a> |
changeset |
<a href="/comm-central/raw-rev/cd4402569153c86725797c26ae610cc85064dba6">raw</a>  | <a href="/comm-central/archive/cd4402569153c86725797c26ae610cc85064dba6.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=377319">Bug 377319</a> Convert mailnews/compose to the external API r=Neil sr=bienvenu
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#97;&#110;&#32;&#72;&#111;&#114;&#97;&#107;&#32;&#60;&#106;&#104;&#111;&#114;&#97;&#107;&#64;&#114;&#101;&#100;&#104;&#97;&#116;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Sat, 19 Jun 2010 11:45:19 +0100</td></tr>

<tr>
 <td>changeset 5850</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/cd4402569153c86725797c26ae610cc85064dba6">cd4402569153c86725797c26ae610cc85064dba6</a></td>
</tr>



<tr>
<td>parent 5849</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/4e969d819c3a965d11df0f34aa5c109af3171c8d">4e969d819c3a965d11df0f34aa5c109af3171c8d</a>
</td>
</tr>

<tr>
<td>child 5851</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/18235de07174fe0984c929101cbab85f1fe148b8">18235de07174fe0984c929101cbab85f1fe148b8</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=cd4402569153c86725797c26ae610cc85064dba6">4532</a></td></tr>
<tr><td>push user</td><td>neil@parkwaycc.co.uk</td></tr>
<tr><td>push date</td><td class="date age">Sat, 19 Jun 2010 10:45:26 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@cd4402569153 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=cd4402569153c86725797c26ae610cc85064dba6">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=cd4402569153c86725797c26ae610cc85064dba6&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=cd4402569153c86725797c26ae610cc85064dba6&newProject=comm-central&newRevision=4e969d819c3a965d11df0f34aa5c109af3171c8d&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=cd4402569153c86725797c26ae610cc85064dba6&newProject=comm-central&newRevision=4e969d819c3a965d11df0f34aa5c109af3171c8d&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=cd4402569153c86725797c26ae610cc85064dba6&newProject=comm-central&newRevision=4e969d819c3a965d11df0f34aa5c109af3171c8d&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Neil%29&revcount=50">Neil</a>, <a href="/comm-central/log?rev=reviewer%28bienvenu%29&revcount=50">bienvenu</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=377319">377319</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=377319">Bug 377319</a> Convert mailnews/compose to the external API r=Neil sr=bienvenu</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgAttachmentHandler.cpp">mailnews/compose/src/nsMsgAttachmentHandler.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgAttachmentHandler.cpp">file</a> |
<a href="/comm-central/annotate/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgAttachmentHandler.cpp">annotate</a> |
<a href="/comm-central/diff/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgAttachmentHandler.cpp">diff</a> |
<a href="/comm-central/comparison/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgAttachmentHandler.cpp">comparison</a> |
<a href="/comm-central/log/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgAttachmentHandler.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgCompFields.cpp">mailnews/compose/src/nsMsgCompFields.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgCompFields.cpp">file</a> |
<a href="/comm-central/annotate/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgCompFields.cpp">annotate</a> |
<a href="/comm-central/diff/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgCompFields.cpp">diff</a> |
<a href="/comm-central/comparison/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgCompFields.cpp">comparison</a> |
<a href="/comm-central/log/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgCompFields.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgCompFields.h">mailnews/compose/src/nsMsgCompFields.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgCompFields.h">file</a> |
<a href="/comm-central/annotate/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgCompFields.h">annotate</a> |
<a href="/comm-central/diff/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgCompFields.h">diff</a> |
<a href="/comm-central/comparison/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgCompFields.h">comparison</a> |
<a href="/comm-central/log/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgCompFields.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgCompUtils.cpp">mailnews/compose/src/nsMsgCompUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgCompUtils.cpp">file</a> |
<a href="/comm-central/annotate/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgCompUtils.cpp">annotate</a> |
<a href="/comm-central/diff/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgCompUtils.cpp">diff</a> |
<a href="/comm-central/comparison/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgCompUtils.cpp">comparison</a> |
<a href="/comm-central/log/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgCompUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgCompose.cpp">mailnews/compose/src/nsMsgCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgCompose.cpp">file</a> |
<a href="/comm-central/annotate/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgCompose.cpp">annotate</a> |
<a href="/comm-central/diff/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgCompose.cpp">diff</a> |
<a href="/comm-central/comparison/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgCompose.cpp">comparison</a> |
<a href="/comm-central/log/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgCompose.h">mailnews/compose/src/nsMsgCompose.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgCompose.h">file</a> |
<a href="/comm-central/annotate/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgCompose.h">annotate</a> |
<a href="/comm-central/diff/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgCompose.h">diff</a> |
<a href="/comm-central/comparison/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgCompose.h">comparison</a> |
<a href="/comm-central/log/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgCompose.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgComposeParams.h">mailnews/compose/src/nsMsgComposeParams.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgComposeParams.h">file</a> |
<a href="/comm-central/annotate/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgComposeParams.h">annotate</a> |
<a href="/comm-central/diff/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgComposeParams.h">diff</a> |
<a href="/comm-central/comparison/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgComposeParams.h">comparison</a> |
<a href="/comm-central/log/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgComposeParams.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgComposeService.cpp">mailnews/compose/src/nsMsgComposeService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgComposeService.cpp">file</a> |
<a href="/comm-central/annotate/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgComposeService.cpp">annotate</a> |
<a href="/comm-central/diff/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgComposeService.cpp">diff</a> |
<a href="/comm-central/comparison/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgComposeService.cpp">comparison</a> |
<a href="/comm-central/log/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgComposeService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgCopy.cpp">mailnews/compose/src/nsMsgCopy.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgCopy.cpp">file</a> |
<a href="/comm-central/annotate/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgCopy.cpp">annotate</a> |
<a href="/comm-central/diff/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgCopy.cpp">diff</a> |
<a href="/comm-central/comparison/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgCopy.cpp">comparison</a> |
<a href="/comm-central/log/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgCopy.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgPrompts.cpp">mailnews/compose/src/nsMsgPrompts.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgPrompts.cpp">file</a> |
<a href="/comm-central/annotate/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgPrompts.cpp">annotate</a> |
<a href="/comm-central/diff/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgPrompts.cpp">diff</a> |
<a href="/comm-central/comparison/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgPrompts.cpp">comparison</a> |
<a href="/comm-central/log/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgPrompts.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgSend.cpp">mailnews/compose/src/nsMsgSend.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgSend.cpp">file</a> |
<a href="/comm-central/annotate/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgSend.cpp">annotate</a> |
<a href="/comm-central/diff/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgSend.cpp">diff</a> |
<a href="/comm-central/comparison/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgSend.cpp">comparison</a> |
<a href="/comm-central/log/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgSend.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgSend.h">mailnews/compose/src/nsMsgSend.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgSend.h">file</a> |
<a href="/comm-central/annotate/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgSend.h">annotate</a> |
<a href="/comm-central/diff/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgSend.h">diff</a> |
<a href="/comm-central/comparison/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgSend.h">comparison</a> |
<a href="/comm-central/log/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsMsgSend.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsSmtpProtocol.cpp">mailnews/compose/src/nsSmtpProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsSmtpProtocol.cpp">file</a> |
<a href="/comm-central/annotate/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsSmtpProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsSmtpProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsSmtpProtocol.cpp">comparison</a> |
<a href="/comm-central/log/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsSmtpProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsSmtpServer.cpp">mailnews/compose/src/nsSmtpServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsSmtpServer.cpp">file</a> |
<a href="/comm-central/annotate/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsSmtpServer.cpp">annotate</a> |
<a href="/comm-central/diff/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsSmtpServer.cpp">diff</a> |
<a href="/comm-central/comparison/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsSmtpServer.cpp">comparison</a> |
<a href="/comm-central/log/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsSmtpServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsSmtpService.cpp">mailnews/compose/src/nsSmtpService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsSmtpService.cpp">file</a> |
<a href="/comm-central/annotate/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsSmtpService.cpp">annotate</a> |
<a href="/comm-central/diff/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsSmtpService.cpp">diff</a> |
<a href="/comm-central/comparison/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsSmtpService.cpp">comparison</a> |
<a href="/comm-central/log/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsSmtpService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsSmtpUrl.cpp">mailnews/compose/src/nsSmtpUrl.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsSmtpUrl.cpp">file</a> |
<a href="/comm-central/annotate/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsSmtpUrl.cpp">annotate</a> |
<a href="/comm-central/diff/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsSmtpUrl.cpp">diff</a> |
<a href="/comm-central/comparison/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsSmtpUrl.cpp">comparison</a> |
<a href="/comm-central/log/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsSmtpUrl.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsURLFetcher.cpp">mailnews/compose/src/nsURLFetcher.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsURLFetcher.cpp">file</a> |
<a href="/comm-central/annotate/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsURLFetcher.cpp">annotate</a> |
<a href="/comm-central/diff/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsURLFetcher.cpp">diff</a> |
<a href="/comm-central/comparison/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsURLFetcher.cpp">comparison</a> |
<a href="/comm-central/log/cd4402569153c86725797c26ae610cc85064dba6/mailnews/compose/src/nsURLFetcher.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAttachmentHandler.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAttachmentHandler.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -42,24 +42,22 @@</span>
<a href="#l1.4"></a><span id="l1.4"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l1.5"></a><span id="l1.5"> #include &quot;nsMsgSend.h&quot;</span>
<a href="#l1.6"></a><span id="l1.6"> #include &quot;nsMsgCompUtils.h&quot;</span>
<a href="#l1.7"></a><span id="l1.7"> #include &quot;nsMsgEncoders.h&quot;</span>
<a href="#l1.8"></a><span id="l1.8"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l1.9"></a><span id="l1.9"> #include &quot;nsURLFetcher.h&quot;</span>
<a href="#l1.10"></a><span id="l1.10"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l1.11"></a><span id="l1.11"> #include &quot;nsMsgCompCID.h&quot;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-#include &quot;nsReadableUtils.h&quot;</span>
<a href="#l1.13"></a><span id="l1.13"> #include &quot;nsIMsgMessageService.h&quot;</span>
<a href="#l1.14"></a><span id="l1.14"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l1.15"></a><span id="l1.15"> #include &quot;nsMsgPrompts.h&quot;</span>
<a href="#l1.16"></a><span id="l1.16"> #include &quot;nsTextFormatter.h&quot;</span>
<a href="#l1.17"></a><span id="l1.17"> #include &quot;nsIPrompt.h&quot;</span>
<a href="#l1.18"></a><span id="l1.18"> #include &quot;nsITextToSubURI.h&quot;</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-#include &quot;nsEscape.h&quot;</span>
<a href="#l1.20"></a><span id="l1.20"> #include &quot;nsIURL.h&quot;</span>
<a href="#l1.21"></a><span id="l1.21"> #include &quot;nsIFileURL.h&quot;</span>
<a href="#l1.22"></a><span id="l1.22"> #include &quot;nsNetCID.h&quot;</span>
<a href="#l1.23"></a><span id="l1.23"> #include &quot;nsIMimeStreamConverter.h&quot;</span>
<a href="#l1.24"></a><span id="l1.24"> #include &quot;nsMsgMimeCID.h&quot;</span>
<a href="#l1.25"></a><span id="l1.25"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l1.26"></a><span id="l1.26"> #include &quot;nsNativeCharsetUtils.h&quot;</span>
<a href="#l1.27"></a><span id="l1.27"> #include &quot;nsComposeStrings.h&quot;</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineat">@@ -99,17 +97,18 @@ nsresult nsSimpleZipper::Zip(nsIFile *aI</span>
<a href="#l1.29"></a><span id="l1.29"> /* static */</span>
<a href="#l1.30"></a><span id="l1.30"> nsresult nsSimpleZipper::AddToZip(nsIZipWriter *aZipWriter, </span>
<a href="#l1.31"></a><span id="l1.31">                                   nsIFile *aFile,</span>
<a href="#l1.32"></a><span id="l1.32">                                   const nsACString &amp;aPath)</span>
<a href="#l1.33"></a><span id="l1.33"> {</span>
<a href="#l1.34"></a><span id="l1.34">   // find out the path this file/dir should have in the zip</span>
<a href="#l1.35"></a><span id="l1.35">   nsCString leafName;</span>
<a href="#l1.36"></a><span id="l1.36">   aFile-&gt;GetNativeLeafName(leafName);</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-  nsCString currentPath(aPath + leafName);</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+  nsCString currentPath(aPath);</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+  currentPath += leafName;</span>
<a href="#l1.40"></a><span id="l1.40">     </span>
<a href="#l1.41"></a><span id="l1.41">   PRBool isDirectory;</span>
<a href="#l1.42"></a><span id="l1.42">   aFile-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l1.43"></a><span id="l1.43">   // append slash for a directory entry</span>
<a href="#l1.44"></a><span id="l1.44">   if (isDirectory)</span>
<a href="#l1.45"></a><span id="l1.45">     currentPath.Append('/');</span>
<a href="#l1.46"></a><span id="l1.46">   </span>
<a href="#l1.47"></a><span id="l1.47">   // add the file or directory entry to the zip</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineat">@@ -587,17 +586,17 @@ nsMsgAttachmentHandler::SnarfMsgAttachme</span>
<a href="#l1.49"></a><span id="l1.49">       goto done;</span>
<a href="#l1.50"></a><span id="l1.50">     }</span>
<a href="#l1.51"></a><span id="l1.51"> </span>
<a href="#l1.52"></a><span id="l1.52">     rv = fetcher-&gt;Initialize(mTmpFile, mOutFile, FetcherURLDoneCallback, this);</span>
<a href="#l1.53"></a><span id="l1.53">     rv = GetMessageServiceFromURI(nsDependentCString(m_uri), getter_AddRefs(messageService));</span>
<a href="#l1.54"></a><span id="l1.54">     if (NS_SUCCEEDED(rv) &amp;&amp; messageService)</span>
<a href="#l1.55"></a><span id="l1.55">     {</span>
<a href="#l1.56"></a><span id="l1.56">       nsCAutoString uri(m_uri);</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-      uri += (uri.FindChar('?') == kNotFound) ? &quot;?&quot; : &quot;&amp;&quot;;</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+      uri += (uri.FindChar('?') == kNotFound) ? '?' : '&amp;';</span>
<a href="#l1.59"></a><span id="l1.59">       uri.Append(&quot;fetchCompleteMessage=true&quot;);</span>
<a href="#l1.60"></a><span id="l1.60">       nsCOMPtr&lt;nsIStreamListener&gt; strListener;</span>
<a href="#l1.61"></a><span id="l1.61">       fetcher-&gt;QueryInterface(NS_GET_IID(nsIStreamListener), getter_AddRefs(strListener));</span>
<a href="#l1.62"></a><span id="l1.62"> </span>
<a href="#l1.63"></a><span id="l1.63">       // initialize a new stream converter, that uses the strListener as its input</span>
<a href="#l1.64"></a><span id="l1.64">       // obtain the input stream listener from the new converter,</span>
<a href="#l1.65"></a><span id="l1.65">       // and pass the converter's input stream listener to DisplayMessage</span>
<a href="#l1.66"></a><span id="l1.66"> </span>
<a href="#l1.67"></a><span id="l1.67" class="difflineat">@@ -706,32 +705,33 @@ nsMsgAttachmentHandler::SnarfAttachment(</span>
<a href="#l1.68"></a><span id="l1.68">   nsCString sourceURISpec;</span>
<a href="#l1.69"></a><span id="l1.69">   mURL-&gt;GetSpec(sourceURISpec);</span>
<a href="#l1.70"></a><span id="l1.70"> #ifdef XP_MACOSX</span>
<a href="#l1.71"></a><span id="l1.71">   if (!m_bogus_attachment &amp;&amp; StringBeginsWith(sourceURISpec, NS_LITERAL_CSTRING(&quot;file://&quot;)))</span>
<a href="#l1.72"></a><span id="l1.72">   {</span>
<a href="#l1.73"></a><span id="l1.73">     // Unescape the path (i.e. un-URLify it) before making a FSSpec</span>
<a href="#l1.74"></a><span id="l1.74">     nsCAutoString filePath;</span>
<a href="#l1.75"></a><span id="l1.75">     filePath.Adopt(nsMsgGetLocalFileFromURL(sourceURISpec.get()));</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineminus">-    nsUnescape(filePath.BeginWriting());</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineplus">+    nsCAutoString unescapedFilePath;</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+    MsgUnescapeString(filePath, 0, unescapedFilePath);</span>
<a href="#l1.79"></a><span id="l1.79"> </span>
<a href="#l1.80"></a><span id="l1.80">     nsCOMPtr&lt;nsILocalFile&gt; sourceFile;</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineminus">-    NS_NewNativeLocalFile(filePath, PR_TRUE, getter_AddRefs(sourceFile));</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+    NS_NewNativeLocalFile(unescapedFilePath, PR_TRUE, getter_AddRefs(sourceFile));</span>
<a href="#l1.83"></a><span id="l1.83">     if (!sourceFile)</span>
<a href="#l1.84"></a><span id="l1.84">       return NS_ERROR_FAILURE;</span>
<a href="#l1.85"></a><span id="l1.85">       </span>
<a href="#l1.86"></a><span id="l1.86">     // check if it is a bundle. if it is, we'll zip it. </span>
<a href="#l1.87"></a><span id="l1.87">     // if not, we'll apple encode it (applesingle or appledouble)</span>
<a href="#l1.88"></a><span id="l1.88">     nsCOMPtr&lt;nsILocalFileMac&gt; macFile(do_QueryInterface(sourceFile));</span>
<a href="#l1.89"></a><span id="l1.89">     PRBool isPackage;</span>
<a href="#l1.90"></a><span id="l1.90">     macFile-&gt;IsPackage(&amp;isPackage);</span>
<a href="#l1.91"></a><span id="l1.91">     if (isPackage)</span>
<a href="#l1.92"></a><span id="l1.92">       rv = ConvertToZipFile(macFile);</span>
<a href="#l1.93"></a><span id="l1.93">     else</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineminus">-      rv = ConvertToAppleEncoding(sourceURISpec, filePath, macFile);</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineplus">+      rv = ConvertToAppleEncoding(sourceURISpec, unescapedFilePath, macFile);</span>
<a href="#l1.96"></a><span id="l1.96">     </span>
<a href="#l1.97"></a><span id="l1.97">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.98"></a><span id="l1.98">   }</span>
<a href="#l1.99"></a><span id="l1.99"> #endif /* XP_MACOSX */</span>
<a href="#l1.100"></a><span id="l1.100"> </span>
<a href="#l1.101"></a><span id="l1.101">   //</span>
<a href="#l1.102"></a><span id="l1.102">   // Ok, here we are, we need to fire the URL off and get the data</span>
<a href="#l1.103"></a><span id="l1.103">   // in the temp file</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineat">@@ -1014,23 +1014,24 @@ nsMsgAttachmentHandler::LoadDataFromFile</span>
<a href="#l1.105"></a><span id="l1.105">   if (!readBuf)</span>
<a href="#l1.106"></a><span id="l1.106">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l1.107"></a><span id="l1.107">   memset(readBuf, 0, readSize + 1);</span>
<a href="#l1.108"></a><span id="l1.108"> </span>
<a href="#l1.109"></a><span id="l1.109">   PRUint32 bytesRead;</span>
<a href="#l1.110"></a><span id="l1.110">   inputFile-&gt;Read(readBuf, readSize, &amp;bytesRead);</span>
<a href="#l1.111"></a><span id="l1.111">   inputFile-&gt;Close();</span>
<a href="#l1.112"></a><span id="l1.112"> </span>
<a href="#l1.113"></a><span id="l1.113" class="difflineplus">+  nsDependentCString cstringReadBuf(readBuf, bytesRead);</span>
<a href="#l1.114"></a><span id="l1.114">   if (charsetConversion)</span>
<a href="#l1.115"></a><span id="l1.115">   {</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineminus">-    if (NS_FAILED(ConvertToUnicode(m_charset, nsDependentCString(readBuf), sigData)))</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineminus">-      CopyASCIItoUTF16(readBuf, sigData);</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineplus">+    if (NS_FAILED(ConvertToUnicode(m_charset, cstringReadBuf, sigData)))</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineplus">+      CopyASCIItoUTF16(cstringReadBuf, sigData);</span>
<a href="#l1.120"></a><span id="l1.120">   }</span>
<a href="#l1.121"></a><span id="l1.121">   else</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineminus">-    CopyASCIItoUTF16(readBuf, sigData);</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineplus">+    CopyASCIItoUTF16(cstringReadBuf, sigData);</span>
<a href="#l1.124"></a><span id="l1.124"> </span>
<a href="#l1.125"></a><span id="l1.125">   PR_FREEIF(readBuf);</span>
<a href="#l1.126"></a><span id="l1.126">   return NS_OK;</span>
<a href="#l1.127"></a><span id="l1.127"> }</span>
<a href="#l1.128"></a><span id="l1.128"> </span>
<a href="#l1.129"></a><span id="l1.129"> nsresult</span>
<a href="#l1.130"></a><span id="l1.130"> nsMsgAttachmentHandler::Abort()</span>
<a href="#l1.131"></a><span id="l1.131"> {</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineat">@@ -1121,22 +1122,22 @@ nsMsgAttachmentHandler::UrlExit(nsresult</span>
<a href="#l1.133"></a><span id="l1.133">       bundle-&gt;GetStringFromID(NS_MSG_FAILURE_ON_OBJ_EMBED_WHILE_SAVING, getter_Copies(msg));</span>
<a href="#l1.134"></a><span id="l1.134">     else</span>
<a href="#l1.135"></a><span id="l1.135">       bundle-&gt;GetStringFromID(NS_MSG_FAILURE_ON_OBJ_EMBED_WHILE_SENDING, getter_Copies(msg));</span>
<a href="#l1.136"></a><span id="l1.136">     if (m_real_name &amp;&amp; *m_real_name)</span>
<a href="#l1.137"></a><span id="l1.137">       printfString = nsTextFormatter::smprintf(msg.get(), m_real_name);</span>
<a href="#l1.138"></a><span id="l1.138">     else</span>
<a href="#l1.139"></a><span id="l1.139">     if (NS_SUCCEEDED(mURL-&gt;GetSpec(turl)) &amp;&amp; !turl.IsEmpty())</span>
<a href="#l1.140"></a><span id="l1.140">       {</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineminus">-        nsCAutoString unescapeUrl(turl);</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineminus">-        nsUnescape(unescapeUrl.BeginWriting());</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineminus">-        if (unescapeUrl.IsEmpty())</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineplus">+        nsCAutoString unescapedUrl;</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineplus">+        MsgUnescapeString(turl, 0, unescapedUrl);</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineplus">+        if (unescapedUrl.IsEmpty())</span>
<a href="#l1.147"></a><span id="l1.147">           printfString = nsTextFormatter::smprintf(msg.get(), turl.get());</span>
<a href="#l1.148"></a><span id="l1.148">         else</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineminus">-          printfString = nsTextFormatter::smprintf(msg.get(), unescapeUrl.get());</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineplus">+          printfString = nsTextFormatter::smprintf(msg.get(), unescapedUrl.get());</span>
<a href="#l1.151"></a><span id="l1.151">       }</span>
<a href="#l1.152"></a><span id="l1.152">     else</span>
<a href="#l1.153"></a><span id="l1.153">       printfString = nsTextFormatter::smprintf(msg.get(), &quot;?&quot;);</span>
<a href="#l1.154"></a><span id="l1.154"> </span>
<a href="#l1.155"></a><span id="l1.155">     nsCOMPtr&lt;nsIPrompt&gt; aPrompt;</span>
<a href="#l1.156"></a><span id="l1.156">     if (m_mime_delivery_state)</span>
<a href="#l1.157"></a><span id="l1.157">       m_mime_delivery_state-&gt;GetDefaultPrompt(getter_AddRefs(aPrompt));</span>
<a href="#l1.158"></a><span id="l1.158">     nsMsgAskBooleanQuestionByString(aPrompt, printfString, &amp;keepOnGoing);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompFields.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompFields.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -44,16 +44,17 @@</span>
<a href="#l2.4"></a><span id="l2.4"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l2.5"></a><span id="l2.5"> #include &quot;prmem.h&quot;</span>
<a href="#l2.6"></a><span id="l2.6"> #include &quot;nsIFileChannel.h&quot;</span>
<a href="#l2.7"></a><span id="l2.7"> #include &quot;nsIMsgMdnGenerator.h&quot;</span>
<a href="#l2.8"></a><span id="l2.8"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l2.9"></a><span id="l2.9"> #include &quot;nsMsgMimeCID.h&quot;</span>
<a href="#l2.10"></a><span id="l2.10"> #include &quot;nsIMimeConverter.h&quot;</span>
<a href="#l2.11"></a><span id="l2.11"> #include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+#include &quot;nsMemory.h&quot;</span>
<a href="#l2.13"></a><span id="l2.13"> </span>
<a href="#l2.14"></a><span id="l2.14"> /* the following macro actually implement addref, release and query interface for our component. */</span>
<a href="#l2.15"></a><span id="l2.15"> NS_IMPL_THREADSAFE_ISUPPORTS1(nsMsgCompFields, nsIMsgCompFields)</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17"> nsMsgCompFields::nsMsgCompFields()</span>
<a href="#l2.18"></a><span id="l2.18"> {</span>
<a href="#l2.19"></a><span id="l2.19">   PRInt16 i;</span>
<a href="#l2.20"></a><span id="l2.20">   for (i = 0; i &lt; MSG_MAX_HEADERS; i ++)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompFields.h</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompFields.h</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -39,16 +39,17 @@</span>
<a href="#l3.4"></a><span id="l3.4"> #ifndef _MsgCompFields_H_</span>
<a href="#l3.5"></a><span id="l3.5"> #define _MsgCompFields_H_</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7"> #include &quot;nsIMsgCompFields.h&quot;</span>
<a href="#l3.8"></a><span id="l3.8"> #include &quot;msgCore.h&quot;</span>
<a href="#l3.9"></a><span id="l3.9"> #include &quot;nsIAbCard.h&quot;</span>
<a href="#l3.10"></a><span id="l3.10"> #include &quot;nsTArray.h&quot;</span>
<a href="#l3.11"></a><span id="l3.11"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l3.13"></a><span id="l3.13"> </span>
<a href="#l3.14"></a><span id="l3.14"> struct nsMsgRecipient</span>
<a href="#l3.15"></a><span id="l3.15"> {</span>
<a href="#l3.16"></a><span id="l3.16">   nsMsgRecipient() : mPreferFormat(nsIAbPreferMailFormat::unknown),</span>
<a href="#l3.17"></a><span id="l3.17">                      mProcessed(PR_FALSE) {}</span>
<a href="#l3.18"></a><span id="l3.18"> </span>
<a href="#l3.19"></a><span id="l3.19">   nsMsgRecipient(const nsMsgRecipient &amp;other)</span>
<a href="#l3.20"></a><span id="l3.20">   {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompUtils.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompUtils.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -35,35 +35,38 @@</span>
<a href="#l4.4"></a><span id="l4.4">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l4.5"></a><span id="l4.5">  *</span>
<a href="#l4.6"></a><span id="l4.6">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l4.7"></a><span id="l4.7"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l4.8"></a><span id="l4.8"> #include &quot;nsMsgCompUtils.h&quot;</span>
<a href="#l4.9"></a><span id="l4.9"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l4.10"></a><span id="l4.10"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l4.11"></a><span id="l4.11"> #include &quot;prmem.h&quot;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-#include &quot;nsEscape.h&quot;</span>
<a href="#l4.13"></a><span id="l4.13"> #include &quot;nsMsgSend.h&quot;</span>
<a href="#l4.14"></a><span id="l4.14"> #include &quot;nsIIOService.h&quot;</span>
<a href="#l4.15"></a><span id="l4.15"> #include &quot;nsIHttpProtocolHandler.h&quot;</span>
<a href="#l4.16"></a><span id="l4.16"> #include &quot;nsMailHeaders.h&quot;</span>
<a href="#l4.17"></a><span id="l4.17"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l4.18"></a><span id="l4.18"> #include &quot;nsIMsgHeaderParser.h&quot;</span>
<a href="#l4.19"></a><span id="l4.19"> #include &quot;nsINntpService.h&quot;</span>
<a href="#l4.20"></a><span id="l4.20"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-#include &quot;nsReadableUtils.h&quot;</span>
<a href="#l4.22"></a><span id="l4.22"> #include &quot;nsDirectoryServiceDefs.h&quot;</span>
<a href="#l4.23"></a><span id="l4.23"> #include &quot;nsIDocumentEncoder.h&quot;    // for editor output flags</span>
<a href="#l4.24"></a><span id="l4.24"> #include &quot;nsIURI.h&quot;</span>
<a href="#l4.25"></a><span id="l4.25"> #include &quot;nsNetCID.h&quot;</span>
<a href="#l4.26"></a><span id="l4.26"> #include &quot;nsMsgPrompts.h&quot;</span>
<a href="#l4.27"></a><span id="l4.27"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l4.28"></a><span id="l4.28"> #include &quot;nsComposeStrings.h&quot;</span>
<a href="#l4.29"></a><span id="l4.29"> #include &quot;nsIMsgCompUtils.h&quot;</span>
<a href="#l4.30"></a><span id="l4.30"> #include &quot;nsIMsgMdnGenerator.h&quot;</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+#include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+#include &quot;nsMemory.h&quot;</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+#include &quot;nsCRTGlue.h&quot;</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+#include &lt;ctype.h&gt;</span>
<a href="#l4.36"></a><span id="l4.36"> </span>
<a href="#l4.37"></a><span id="l4.37"> NS_IMPL_ISUPPORTS1(nsMsgCompUtils, nsIMsgCompUtils)</span>
<a href="#l4.38"></a><span id="l4.38"> </span>
<a href="#l4.39"></a><span id="l4.39"> nsMsgCompUtils::nsMsgCompUtils()</span>
<a href="#l4.40"></a><span id="l4.40"> {</span>
<a href="#l4.41"></a><span id="l4.41"> }</span>
<a href="#l4.42"></a><span id="l4.42"> </span>
<a href="#l4.43"></a><span id="l4.43"> nsMsgCompUtils::~nsMsgCompUtils()</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineat">@@ -631,25 +634,21 @@ mime_generate_headers (nsMsgCompFields *</span>
<a href="#l4.45"></a><span id="l4.45">           nsCOMPtr&lt;nsIStringBundle&gt; composeStringBundle;</span>
<a href="#l4.46"></a><span id="l4.46">           rv = stringService-&gt;CreateBundle(&quot;chrome://messenger/locale/messengercompose/composeMsgs.properties&quot;, getter_AddRefs(composeStringBundle));</span>
<a href="#l4.47"></a><span id="l4.47">           if (NS_SUCCEEDED(rv))</span>
<a href="#l4.48"></a><span id="l4.48">           {</span>
<a href="#l4.49"></a><span id="l4.49">             nsString undisclosedRecipients;</span>
<a href="#l4.50"></a><span id="l4.50">             rv = composeStringBundle-&gt;GetStringFromID(NS_MSG_UNDISCLOSED_RECIPIENTS, getter_Copies(undisclosedRecipients));</span>
<a href="#l4.51"></a><span id="l4.51">             if (NS_SUCCEEDED(rv) &amp;&amp; !undisclosedRecipients.IsEmpty())</span>
<a href="#l4.52"></a><span id="l4.52">             {</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineminus">-              char * cstr = ToNewCString(undisclosedRecipients);</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineminus">-              if (cstr) {</span>
<a href="#l4.55"></a><span id="l4.55">                 PUSH_STRING(&quot;To: &quot;);</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineminus">-                PUSH_STRING(cstr);</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+              PUSH_STRING(NS_LossyConvertUTF16toASCII(undisclosedRecipients).get());</span>
<a href="#l4.58"></a><span id="l4.58">                 PUSH_STRING(&quot;:;&quot;);</span>
<a href="#l4.59"></a><span id="l4.59">                 PUSH_NEWLINE ();</span>
<a href="#l4.60"></a><span id="l4.60">               }</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineminus">-              PR_Free(cstr);</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineminus">-            }</span>
<a href="#l4.63"></a><span id="l4.63">           }</span>
<a href="#l4.64"></a><span id="l4.64">         }</span>
<a href="#l4.65"></a><span id="l4.65">       }</span>
<a href="#l4.66"></a><span id="l4.66">     }</span>
<a href="#l4.67"></a><span id="l4.67">   }</span>
<a href="#l4.68"></a><span id="l4.68"> </span>
<a href="#l4.69"></a><span id="l4.69">   if (pSubject &amp;&amp; *pSubject)</span>
<a href="#l4.70"></a><span id="l4.70">     ENCODE_AND_PUSH(&quot;Subject: &quot;, PR_FALSE, pSubject, charset, usemime);</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineat">@@ -801,17 +800,17 @@ mime_generate_attachment_headers (const </span>
<a href="#l4.72"></a><span id="l4.72">   /* Let's encode the real name */</span>
<a href="#l4.73"></a><span id="l4.73">   char *encodedRealName = nsnull;</span>
<a href="#l4.74"></a><span id="l4.74">   nsCString charset;   // actual charset used for MIME encode</span>
<a href="#l4.75"></a><span id="l4.75">   nsAutoString realName;</span>
<a href="#l4.76"></a><span id="l4.76">   if (real_name)</span>
<a href="#l4.77"></a><span id="l4.77">   {</span>
<a href="#l4.78"></a><span id="l4.78">     // first try main body's charset to encode the file name,</span>
<a href="#l4.79"></a><span id="l4.79">     // then try local file system charset if fails</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineminus">-    CopyUTF8toUTF16(real_name, realName);</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+    CopyUTF8toUTF16(nsDependentCString(real_name), realName);</span>
<a href="#l4.82"></a><span id="l4.82">     if (bodyCharset &amp;&amp; *bodyCharset &amp;&amp;</span>
<a href="#l4.83"></a><span id="l4.83">         nsMsgI18Ncheck_data_in_charset_range(bodyCharset, realName.get()))</span>
<a href="#l4.84"></a><span id="l4.84">       charset.Assign(bodyCharset);</span>
<a href="#l4.85"></a><span id="l4.85">     else</span>
<a href="#l4.86"></a><span id="l4.86">     {</span>
<a href="#l4.87"></a><span id="l4.87">       charset.Assign(nsMsgI18NFileSystemCharset());</span>
<a href="#l4.88"></a><span id="l4.88">       if (!nsMsgI18Ncheck_data_in_charset_range(charset.get(), realName.get()))</span>
<a href="#l4.89"></a><span id="l4.89">         charset.Assign(&quot;UTF-8&quot;); // set to UTF-8 if fails again</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineat">@@ -1170,36 +1169,36 @@ inline static PRBool is7bitCharset(const</span>
<a href="#l4.91"></a><span id="l4.91">                                   // never be greater than 78 = 75 + CRLFLWSP</span>
<a href="#l4.92"></a><span id="l4.92"> /*static */ char *</span>
<a href="#l4.93"></a><span id="l4.93"> RFC2231ParmFolding(const char *parmName, const nsCString&amp; charset,</span>
<a href="#l4.94"></a><span id="l4.94">                    const char *language, const nsString&amp; parmValue)</span>
<a href="#l4.95"></a><span id="l4.95"> {</span>
<a href="#l4.96"></a><span id="l4.96">   NS_ENSURE_TRUE(parmName &amp;&amp; *parmName &amp;&amp; !parmValue.IsEmpty(), nsnull);</span>
<a href="#l4.97"></a><span id="l4.97"> </span>
<a href="#l4.98"></a><span id="l4.98">   PRBool needEscape;</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineminus">-  char *dupParm = nsnull;</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+  nsCString dupParm;</span>
<a href="#l4.101"></a><span id="l4.101"> </span>
<a href="#l4.102"></a><span id="l4.102" class="difflineminus">-  if (!IsASCII(parmValue) || is7bitCharset(charset)) {</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+  if (!NS_IsAscii(parmValue.get()) || is7bitCharset(charset)) {</span>
<a href="#l4.104"></a><span id="l4.104">     needEscape = PR_TRUE;</span>
<a href="#l4.105"></a><span id="l4.105">     nsCAutoString nativeParmValue;</span>
<a href="#l4.106"></a><span id="l4.106">     ConvertFromUnicode(charset.get(), parmValue, nativeParmValue);</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineminus">-    dupParm = nsEscape(nativeParmValue.get(), url_All);</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+    MsgEscapeString(nativeParmValue, nsINetUtil::ESCAPE_ALL, dupParm);</span>
<a href="#l4.109"></a><span id="l4.109">   }</span>
<a href="#l4.110"></a><span id="l4.110">   else {</span>
<a href="#l4.111"></a><span id="l4.111">     needEscape = PR_FALSE;</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineminus">-    dupParm =</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+    dupParm.Adopt(</span>
<a href="#l4.114"></a><span id="l4.114">       msg_make_filename_qtext(NS_LossyConvertUTF16toASCII(parmValue).get(),</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineminus">-                              PR_TRUE);</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+                              PR_TRUE));</span>
<a href="#l4.117"></a><span id="l4.117">   }</span>
<a href="#l4.118"></a><span id="l4.118"> </span>
<a href="#l4.119"></a><span id="l4.119" class="difflineminus">-  if (!dupParm)</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+  if (dupParm.IsEmpty())</span>
<a href="#l4.121"></a><span id="l4.121">     return nsnull;</span>
<a href="#l4.122"></a><span id="l4.122"> </span>
<a href="#l4.123"></a><span id="l4.123">   PRInt32 parmNameLen = PL_strlen(parmName);</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineminus">-  PRInt32 parmValueLen = PL_strlen(dupParm);</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+  PRInt32 parmValueLen = dupParm.Length();</span>
<a href="#l4.126"></a><span id="l4.126"> </span>
<a href="#l4.127"></a><span id="l4.127">   if (needEscape)</span>
<a href="#l4.128"></a><span id="l4.128">     parmNameLen += 5;   // *=__'__'___ or *[0]*=__'__'__ or *[1]*=___</span>
<a href="#l4.129"></a><span id="l4.129">   else</span>
<a href="#l4.130"></a><span id="l4.130">     parmNameLen += 5;   // *[0]=&quot;___&quot;;</span>
<a href="#l4.131"></a><span id="l4.131"> </span>
<a href="#l4.132"></a><span id="l4.132">   PRInt32 languageLen = language ?  PL_strlen(language) : 0;</span>
<a href="#l4.133"></a><span id="l4.133">   PRInt32 charsetLen = charset.Length();</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineat">@@ -1216,27 +1215,26 @@ RFC2231ParmFolding(const char *parmName,</span>
<a href="#l4.135"></a><span id="l4.135">         NS_MsgSACat(&amp;foldedParm, charset.get());</span>
<a href="#l4.136"></a><span id="l4.136">       NS_MsgSACat(&amp;foldedParm, &quot;'&quot;);</span>
<a href="#l4.137"></a><span id="l4.137">       if (languageLen)</span>
<a href="#l4.138"></a><span id="l4.138">         NS_MsgSACat(&amp;foldedParm, language);</span>
<a href="#l4.139"></a><span id="l4.139">       NS_MsgSACat(&amp;foldedParm, &quot;'&quot;);</span>
<a href="#l4.140"></a><span id="l4.140">     }</span>
<a href="#l4.141"></a><span id="l4.141">     else</span>
<a href="#l4.142"></a><span id="l4.142">       NS_MsgSACat(&amp;foldedParm, &quot;=\&quot;&quot;);</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineminus">-    NS_MsgSACat(&amp;foldedParm, dupParm);</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+    NS_MsgSACat(&amp;foldedParm, dupParm.get());</span>
<a href="#l4.145"></a><span id="l4.145">     if (!needEscape)</span>
<a href="#l4.146"></a><span id="l4.146">       NS_MsgSACat(&amp;foldedParm, &quot;\&quot;&quot;);</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineminus">-    goto done;</span>
<a href="#l4.148"></a><span id="l4.148">   }</span>
<a href="#l4.149"></a><span id="l4.149">   else</span>
<a href="#l4.150"></a><span id="l4.150">   {</span>
<a href="#l4.151"></a><span id="l4.151">     int curLineLen = 0;</span>
<a href="#l4.152"></a><span id="l4.152">     int counter = 0;</span>
<a href="#l4.153"></a><span id="l4.153">     char digits[32];</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineminus">-    char *start = dupParm;</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineplus">+    char *start = dupParm.BeginWriting();</span>
<a href="#l4.156"></a><span id="l4.156">     char *end = NULL;</span>
<a href="#l4.157"></a><span id="l4.157">     char tmp = 0;</span>
<a href="#l4.158"></a><span id="l4.158"> </span>
<a href="#l4.159"></a><span id="l4.159">     while (parmValueLen &gt; 0)</span>
<a href="#l4.160"></a><span id="l4.160">     {</span>
<a href="#l4.161"></a><span id="l4.161">       curLineLen = 0;</span>
<a href="#l4.162"></a><span id="l4.162">       if (counter == 0) {</span>
<a href="#l4.163"></a><span id="l4.163">         PR_FREEIF(foldedParm)</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineat">@@ -1307,21 +1305,16 @@ RFC2231ParmFolding(const char *parmName,</span>
<a href="#l4.165"></a><span id="l4.165"> </span>
<a href="#l4.166"></a><span id="l4.166">       parmValueLen -= (end-start);</span>
<a href="#l4.167"></a><span id="l4.167">       if (tmp)</span>
<a href="#l4.168"></a><span id="l4.168">         *end = tmp;</span>
<a href="#l4.169"></a><span id="l4.169">       start = end;</span>
<a href="#l4.170"></a><span id="l4.170">     }</span>
<a href="#l4.171"></a><span id="l4.171">   }</span>
<a href="#l4.172"></a><span id="l4.172"> </span>
<a href="#l4.173"></a><span id="l4.173" class="difflineminus">-done:</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineminus">-  if (needEscape)</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineminus">-    nsMemory::Free(dupParm);</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineminus">-  else</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineminus">-    PR_Free(dupParm);</span>
<a href="#l4.178"></a><span id="l4.178">   return foldedParm;</span>
<a href="#l4.179"></a><span id="l4.179"> }</span>
<a href="#l4.180"></a><span id="l4.180"> </span>
<a href="#l4.181"></a><span id="l4.181"> /*static */ char *</span>
<a href="#l4.182"></a><span id="l4.182"> LegacyParmFolding(const nsCString&amp; aCharset,</span>
<a href="#l4.183"></a><span id="l4.183">                   const nsCString&amp; aFileName, PRInt32 aParmFolding)</span>
<a href="#l4.184"></a><span id="l4.184"> {</span>
<a href="#l4.185"></a><span id="l4.185">   PRBool usemime = nsMsgMIMEGetConformToStandard();</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineat">@@ -1645,17 +1638,20 @@ msg_pick_real_name (nsMsgAttachmentHandl</span>
<a href="#l4.187"></a><span id="l4.187">   attachment-&gt;m_real_name = PL_strdup (s);</span>
<a href="#l4.188"></a><span id="l4.188">   /* Now trim off any named anchors or search data. */</span>
<a href="#l4.189"></a><span id="l4.189">   s3 = PL_strchr (attachment-&gt;m_real_name, '?');</span>
<a href="#l4.190"></a><span id="l4.190">   if (s3) *s3 = 0;</span>
<a href="#l4.191"></a><span id="l4.191">   s3 = PL_strchr (attachment-&gt;m_real_name, '#');</span>
<a href="#l4.192"></a><span id="l4.192">   if (s3) *s3 = 0;</span>
<a href="#l4.193"></a><span id="l4.193"> </span>
<a href="#l4.194"></a><span id="l4.194">   /* Now lose the %XX crap. */</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineminus">-  nsUnescape (attachment-&gt;m_real_name);</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineplus">+  nsCString unescaped_real_name;</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineplus">+  MsgUnescapeString(nsDependentCString(attachment-&gt;m_real_name), 0, unescaped_real_name);</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineplus">+  NS_Free(attachment-&gt;m_real_name);</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineplus">+  attachment-&gt;m_real_name = ToNewCString(unescaped_real_name);</span>
<a href="#l4.200"></a><span id="l4.200">   }</span>
<a href="#l4.201"></a><span id="l4.201"> </span>
<a href="#l4.202"></a><span id="l4.202">   /* Now a special case for attaching uuencoded files...</span>
<a href="#l4.203"></a><span id="l4.203"> </span>
<a href="#l4.204"></a><span id="l4.204">    If we attach a file &quot;foo.txt.uu&quot;, we will send it out with</span>
<a href="#l4.205"></a><span id="l4.205">    Content-Type: text/plain; Content-Transfer-Encoding: x-uuencode.</span>
<a href="#l4.206"></a><span id="l4.206">    When saving such a file, a mail reader will generally decode it first</span>
<a href="#l4.207"></a><span id="l4.207">    (thus removing the uuencoding.)  So, let's make life a little easier by</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineat">@@ -1718,17 +1714,18 @@ nsMsgNewURL(nsIURI** aInstancePtrResult,</span>
<a href="#l4.209"></a><span id="l4.209">   if (nsnull == aInstancePtrResult)</span>
<a href="#l4.210"></a><span id="l4.210">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.211"></a><span id="l4.211">   nsCOMPtr&lt;nsIIOService&gt; pNetService(do_GetService(NS_IOSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l4.212"></a><span id="l4.212">   if (NS_SUCCEEDED(rv) &amp;&amp; pNetService)</span>
<a href="#l4.213"></a><span id="l4.213">   {</span>
<a href="#l4.214"></a><span id="l4.214">     if (PL_strstr(aSpec, &quot;://&quot;) == nsnull &amp;&amp; strncmp(aSpec, &quot;data:&quot;, 5))</span>
<a href="#l4.215"></a><span id="l4.215">     {</span>
<a href="#l4.216"></a><span id="l4.216">       //XXXjag Temporary fix for bug 139362 until the real problem(bug 70083) get fixed</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineminus">-      nsCAutoString uri(NS_LITERAL_CSTRING(&quot;http://&quot;) + nsDependentCString(aSpec));</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineplus">+      nsCAutoString uri(NS_LITERAL_CSTRING(&quot;http://&quot;));</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineplus">+      uri.Append(aSpec);</span>
<a href="#l4.220"></a><span id="l4.220">       rv = pNetService-&gt;NewURI(uri, nsnull, nsnull, aInstancePtrResult);</span>
<a href="#l4.221"></a><span id="l4.221">     }</span>
<a href="#l4.222"></a><span id="l4.222">     else</span>
<a href="#l4.223"></a><span id="l4.223">       rv = pNetService-&gt;NewURI(nsDependentCString(aSpec), nsnull, nsnull, aInstancePtrResult);</span>
<a href="#l4.224"></a><span id="l4.224">   }</span>
<a href="#l4.225"></a><span id="l4.225">   return rv;</span>
<a href="#l4.226"></a><span id="l4.226"> }</span>
<a href="#l4.227"></a><span id="l4.227"> </span>
<a href="#l4.228"></a><span id="l4.228" class="difflineat">@@ -1923,17 +1920,17 @@ GetFolderURIFromUserPrefs(nsMsgDeliverMo</span>
<a href="#l4.229"></a><span id="l4.229">     rv = prefs-&gt;GetCharPref(&quot;mail.default_sendlater_uri&quot;, getter_Copies(uri));</span>
<a href="#l4.230"></a><span id="l4.230">     if (NS_FAILED(rv) || uri.IsEmpty())</span>
<a href="#l4.231"></a><span id="l4.231">       uri.AssignLiteral(ANY_SERVER);</span>
<a href="#l4.232"></a><span id="l4.232">     else</span>
<a href="#l4.233"></a><span id="l4.233">     {</span>
<a href="#l4.234"></a><span id="l4.234">       // check if uri is unescaped, and if so, escape it and reset the pef.</span>
<a href="#l4.235"></a><span id="l4.235">       if (uri.FindChar(' ') != kNotFound)</span>
<a href="#l4.236"></a><span id="l4.236">       {</span>
<a href="#l4.237"></a><span id="l4.237" class="difflineminus">-        uri.ReplaceSubstring(&quot; &quot;, &quot;%20&quot;);</span>
<a href="#l4.238"></a><span id="l4.238" class="difflineplus">+        MsgReplaceSubstring(uri, &quot; &quot;, &quot;%20&quot;);</span>
<a href="#l4.239"></a><span id="l4.239">         prefs-&gt;SetCharPref(&quot;mail.default_sendlater_uri&quot;, uri.get());</span>
<a href="#l4.240"></a><span id="l4.240">       }</span>
<a href="#l4.241"></a><span id="l4.241">     }</span>
<a href="#l4.242"></a><span id="l4.242">     return;</span>
<a href="#l4.243"></a><span id="l4.243">   }</span>
<a href="#l4.244"></a><span id="l4.244"> </span>
<a href="#l4.245"></a><span id="l4.245">   if (!identity)</span>
<a href="#l4.246"></a><span id="l4.246">     return;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -66,17 +66,16 @@</span>
<a href="#l5.4"></a><span id="l5.4"> #include &quot;nsMailHeaders.h&quot;</span>
<a href="#l5.5"></a><span id="l5.5"> #include &quot;nsMsgPrompts.h&quot;</span>
<a href="#l5.6"></a><span id="l5.6"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l5.7"></a><span id="l5.7"> #include &quot;nsICharsetConverterManager.h&quot;</span>
<a href="#l5.8"></a><span id="l5.8"> #include &quot;nsTextFormatter.h&quot;</span>
<a href="#l5.9"></a><span id="l5.9"> #include &quot;nsIPlaintextEditor.h&quot;</span>
<a href="#l5.10"></a><span id="l5.10"> #include &quot;nsIHTMLEditor.h&quot;</span>
<a href="#l5.11"></a><span id="l5.11"> #include &quot;nsIEditorMailSupport.h&quot;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-#include &quot;nsEscape.h&quot;</span>
<a href="#l5.13"></a><span id="l5.13"> #include &quot;plstr.h&quot;</span>
<a href="#l5.14"></a><span id="l5.14"> #include &quot;prmem.h&quot;</span>
<a href="#l5.15"></a><span id="l5.15"> #include &quot;nsIDocShell.h&quot;</span>
<a href="#l5.16"></a><span id="l5.16"> #include &quot;nsIRDFService.h&quot;</span>
<a href="#l5.17"></a><span id="l5.17"> #include &quot;nsRDFCID.h&quot;</span>
<a href="#l5.18"></a><span id="l5.18"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l5.19"></a><span id="l5.19"> #include &quot;nsIAbMDBDirectory.h&quot;</span>
<a href="#l5.20"></a><span id="l5.20"> #include &quot;nsCExternalHandlerService.h&quot;</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineat">@@ -1131,17 +1130,17 @@ NS_IMETHODIMP nsMsgCompose::SendMsg(MSG_</span>
<a href="#l5.22"></a><span id="l5.22">             if (prefBranch)</span>
<a href="#l5.23"></a><span id="l5.23">             {</span>
<a href="#l5.24"></a><span id="l5.24">               nsCString prefName(&quot;mailnews.disable_fallback_to_utf8.&quot;);</span>
<a href="#l5.25"></a><span id="l5.25">               prefName.Append(m_compFields-&gt;GetCharacterSet());</span>
<a href="#l5.26"></a><span id="l5.26">               prefBranch-&gt;GetBoolPref(prefName.get(), &amp;disableFallback);</span>
<a href="#l5.27"></a><span id="l5.27">             }</span>
<a href="#l5.28"></a><span id="l5.28">             if (!disableFallback)</span>
<a href="#l5.29"></a><span id="l5.29">             {</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-              CopyUTF16toUTF8(msgBody.get(), outCString);</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+              CopyUTF16toUTF8(msgBody, outCString);</span>
<a href="#l5.32"></a><span id="l5.32">               m_compFields-&gt;SetCharacterSet(&quot;UTF-8&quot;);</span>
<a href="#l5.33"></a><span id="l5.33">             }</span>
<a href="#l5.34"></a><span id="l5.34">           }</span>
<a href="#l5.35"></a><span id="l5.35">         }</span>
<a href="#l5.36"></a><span id="l5.36">         else if (!fallbackCharset.IsEmpty())</span>
<a href="#l5.37"></a><span id="l5.37">         {</span>
<a href="#l5.38"></a><span id="l5.38">           // re-label to the fallback charset</span>
<a href="#l5.39"></a><span id="l5.39">           m_compFields-&gt;SetCharacterSet(fallbackCharset.get());</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineat">@@ -1201,45 +1200,42 @@ NS_IMETHODIMP nsMsgCompose::SendMsg(MSG_</span>
<a href="#l5.41"></a><span id="l5.41">       nsCString escapedVCard;</span>
<a href="#l5.42"></a><span id="l5.42">       // make sure, if there is no card, this returns an empty string, or NS_ERROR_FAILURE</span>
<a href="#l5.43"></a><span id="l5.43">       rv = identity-&gt;GetEscapedVCard(escapedVCard);</span>
<a href="#l5.44"></a><span id="l5.44"> </span>
<a href="#l5.45"></a><span id="l5.45">       if (NS_SUCCEEDED(rv) &amp;&amp; !escapedVCard.IsEmpty())</span>
<a href="#l5.46"></a><span id="l5.46">       {</span>
<a href="#l5.47"></a><span id="l5.47">           nsCString vCardUrl;</span>
<a href="#l5.48"></a><span id="l5.48">           vCardUrl = &quot;data:text/x-vcard;charset=utf-8;base64,&quot;;</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-          char *unescapedData = ToNewCString(escapedVCard);</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-          if (!unescapedData)</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineminus">-              return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineminus">-          nsUnescape(unescapedData);</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineminus">-          char *result = PL_Base64Encode(unescapedData, 0, nsnull);</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+          nsCString unescapedData;</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+          MsgUnescapeString(escapedVCard, 0, unescapedData);</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+          char *result = PL_Base64Encode(unescapedData.get(), 0, nsnull);</span>
<a href="#l5.57"></a><span id="l5.57">           vCardUrl += result;</span>
<a href="#l5.58"></a><span id="l5.58">           PR_Free(result);</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-          PR_Free(unescapedData);</span>
<a href="#l5.60"></a><span id="l5.60"> </span>
<a href="#l5.61"></a><span id="l5.61">           nsCOMPtr&lt;nsIMsgAttachment&gt; attachment = do_CreateInstance(NS_MSGATTACHMENT_CONTRACTID, &amp;rv);</span>
<a href="#l5.62"></a><span id="l5.62">           if (NS_SUCCEEDED(rv) &amp;&amp; attachment)</span>
<a href="#l5.63"></a><span id="l5.63">           {</span>
<a href="#l5.64"></a><span id="l5.64">               // [comment from 4.x]</span>
<a href="#l5.65"></a><span id="l5.65">               // Send the vCard out with a filename which distinguishes this user. e.g. jsmith.vcf</span>
<a href="#l5.66"></a><span id="l5.66">               // The main reason to do this is for interop with Eudora, which saves off</span>
<a href="#l5.67"></a><span id="l5.67">               // the attachments separately from the message body</span>
<a href="#l5.68"></a><span id="l5.68">               nsCString userid;</span>
<a href="#l5.69"></a><span id="l5.69">               (void)identity-&gt;GetEmail(userid);</span>
<a href="#l5.70"></a><span id="l5.70">               PRInt32 index = userid.FindChar('@');</span>
<a href="#l5.71"></a><span id="l5.71">               if (index != kNotFound)</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineminus">-                  userid.Truncate(index);</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+                  userid.SetLength(index);</span>
<a href="#l5.74"></a><span id="l5.74"> </span>
<a href="#l5.75"></a><span id="l5.75">               if (userid.IsEmpty())</span>
<a href="#l5.76"></a><span id="l5.76">                   attachment-&gt;SetName(NS_LITERAL_STRING(&quot;vcard.vcf&quot;));</span>
<a href="#l5.77"></a><span id="l5.77">               else</span>
<a href="#l5.78"></a><span id="l5.78">               {</span>
<a href="#l5.79"></a><span id="l5.79">                   // Replace any dot with underscore to stop vCards</span>
<a href="#l5.80"></a><span id="l5.80">                   // generating false positives with some heuristic scanners</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineminus">-                  userid.ReplaceChar('.', '_');</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+                  MsgReplaceChar(userid, '.', '_');</span>
<a href="#l5.83"></a><span id="l5.83">                   userid.AppendLiteral(&quot;.vcf&quot;);</span>
<a href="#l5.84"></a><span id="l5.84">                   attachment-&gt;SetName(NS_ConvertASCIItoUTF16(userid));</span>
<a href="#l5.85"></a><span id="l5.85">               }</span>
<a href="#l5.86"></a><span id="l5.86"> </span>
<a href="#l5.87"></a><span id="l5.87">               attachment-&gt;SetUrl(vCardUrl);</span>
<a href="#l5.88"></a><span id="l5.88">               m_compFields-&gt;AddAttachment(attachment);</span>
<a href="#l5.89"></a><span id="l5.89">           }</span>
<a href="#l5.90"></a><span id="l5.90">       }</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineat">@@ -2006,18 +2002,18 @@ nsresult nsMsgCompose::CreateMessage(con</span>
<a href="#l5.92"></a><span id="l5.92">                     nsCOMPtr&lt;nsIMsgIdentity&gt; lookupIdentity2;</span>
<a href="#l5.93"></a><span id="l5.93">                     rv = identities-&gt;QueryElementAt(j, NS_GET_IID(nsIMsgIdentity),</span>
<a href="#l5.94"></a><span id="l5.94">                                                     getter_AddRefs(lookupIdentity2));</span>
<a href="#l5.95"></a><span id="l5.95">                     if (NS_FAILED(rv))</span>
<a href="#l5.96"></a><span id="l5.96">                       continue;</span>
<a href="#l5.97"></a><span id="l5.97"> </span>
<a href="#l5.98"></a><span id="l5.98">                     nsCString curIdentityEmail2;</span>
<a href="#l5.99"></a><span id="l5.99">                     lookupIdentity2-&gt;GetEmail(curIdentityEmail2);</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineminus">-                    if (FindInReadable(curIdentityEmail2, recipientsEmailAddresses) ||</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineminus">-                        FindInReadable(curIdentityEmail2, ccListEmailAddresses))</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+                    if (recipientsEmailAddresses.Find(curIdentityEmail2) != kNotFound ||</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+                        ccListEmailAddresses.Find(curIdentityEmail2) != kNotFound)</span>
<a href="#l5.104"></a><span id="l5.104">                     {</span>
<a href="#l5.105"></a><span id="l5.105">                       // An identity among the recipients -&gt; not reply-to-self.</span>
<a href="#l5.106"></a><span id="l5.106">                       isReplyToOwnMsg = PR_FALSE;</span>
<a href="#l5.107"></a><span id="l5.107">                       break;</span>
<a href="#l5.108"></a><span id="l5.108">                     }</span>
<a href="#l5.109"></a><span id="l5.109">                   }</span>
<a href="#l5.110"></a><span id="l5.110">                   break;</span>
<a href="#l5.111"></a><span id="l5.111">                 }</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineat">@@ -2067,18 +2063,20 @@ nsresult nsMsgCompose::CreateMessage(con</span>
<a href="#l5.113"></a><span id="l5.113">                 NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.114"></a><span id="l5.114">                 composeBundle-&gt;GetStringFromName(NS_LITERAL_STRING(&quot;messageAttachmentSafeName&quot;).get(),</span>
<a href="#l5.115"></a><span id="l5.115">                                                  getter_Copies(sanitizedSubj));</span>
<a href="#l5.116"></a><span id="l5.116">               }</span>
<a href="#l5.117"></a><span id="l5.117">               else</span>
<a href="#l5.118"></a><span id="l5.118">                 sanitizedSubj.Assign(subject);</span>
<a href="#l5.119"></a><span id="l5.119"> </span>
<a href="#l5.120"></a><span id="l5.120">               // change all '.' to '_'  see bug #271211</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineminus">-              sanitizedSubj.ReplaceChar('.', '_');</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineminus">-              attachment-&gt;SetName(addExtension ? sanitizedSubj + NS_LITERAL_STRING(&quot;.eml&quot;) : sanitizedSubj);</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+              MsgReplaceChar(sanitizedSubj, &quot;.&quot;, '_');</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineplus">+              if (addExtension)</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+                sanitizedSubj.AppendLiteral(&quot;.eml&quot;);</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+              attachment-&gt;SetName(sanitizedSubj);</span>
<a href="#l5.127"></a><span id="l5.127">               attachment-&gt;SetUrl(nsDependentCString(uri));</span>
<a href="#l5.128"></a><span id="l5.128">               m_compFields-&gt;AddAttachment(attachment);</span>
<a href="#l5.129"></a><span id="l5.129">             }</span>
<a href="#l5.130"></a><span id="l5.130"> </span>
<a href="#l5.131"></a><span id="l5.131">             if (isFirstPass)</span>
<a href="#l5.132"></a><span id="l5.132">             {</span>
<a href="#l5.133"></a><span id="l5.133">               nsCString fwdPrefix;</span>
<a href="#l5.134"></a><span id="l5.134">               prefs-&gt;GetCharPref(&quot;mail.forward_subject_prefix&quot;, getter_Copies(fwdPrefix));</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineat">@@ -2202,18 +2200,20 @@ QuotingOutputStreamListener::QuotingOutp</span>
<a href="#l5.136"></a><span id="l5.136">       // Setup the cite information....</span>
<a href="#l5.137"></a><span id="l5.137">       nsCString myGetter;</span>
<a href="#l5.138"></a><span id="l5.138">       if (NS_SUCCEEDED(originalMsgHdr-&gt;GetMessageId(getter_Copies(myGetter))))</span>
<a href="#l5.139"></a><span id="l5.139">       {</span>
<a href="#l5.140"></a><span id="l5.140">         if (!myGetter.IsEmpty())</span>
<a href="#l5.141"></a><span id="l5.141">         {</span>
<a href="#l5.142"></a><span id="l5.142">           nsCAutoString buf;</span>
<a href="#l5.143"></a><span id="l5.143">           mCiteReference.AssignLiteral(&quot;mid:&quot;);</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineminus">-          AppendASCIItoUTF16(NS_EscapeURL(myGetter, esc_FileBaseName | esc_Forced, buf),</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineminus">-                             mCiteReference);</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineplus">+          MsgEscapeURL(myGetter,</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineplus">+                       nsINetUtil::ESCAPE_URL_FILE_BASENAME | nsINetUtil::ESCAPE_URL_FORCED,</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineplus">+                       buf);</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineplus">+          mCiteReference.Append(NS_ConvertASCIItoUTF16(buf));</span>
<a href="#l5.150"></a><span id="l5.150">         }</span>
<a href="#l5.151"></a><span id="l5.151">       }</span>
<a href="#l5.152"></a><span id="l5.152"> </span>
<a href="#l5.153"></a><span id="l5.153">       PRInt32 reply_on_top = 0;</span>
<a href="#l5.154"></a><span id="l5.154">       mIdentity-&gt;GetReplyOnTop(&amp;reply_on_top);</span>
<a href="#l5.155"></a><span id="l5.155">       if (reply_on_top == 1)</span>
<a href="#l5.156"></a><span id="l5.156">       {</span>
<a href="#l5.157"></a><span id="l5.157">         // add one newline if a signature comes before the quote, two otherwise</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineat">@@ -2432,22 +2432,18 @@ NS_IMETHODIMP QuotingOutputStreamListene</span>
<a href="#l5.159"></a><span id="l5.159"> {</span>
<a href="#l5.160"></a><span id="l5.160">   nsresult rv = NS_OK;</span>
<a href="#l5.161"></a><span id="l5.161">   nsAutoString aCharset;</span>
<a href="#l5.162"></a><span id="l5.162"> </span>
<a href="#l5.163"></a><span id="l5.163">   if (!mHtmlToQuote.IsEmpty())</span>
<a href="#l5.164"></a><span id="l5.164">   {</span>
<a href="#l5.165"></a><span id="l5.165">     // If we had a selection in the original message to quote, we can add</span>
<a href="#l5.166"></a><span id="l5.166">     // it now that we are done ignoring the original body of the message</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineminus">-    nsCOMPtr&lt;nsIInputStream&gt; stream;</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineminus">-    rv = NS_NewCStringInputStream(getter_AddRefs(stream), mHtmlToQuote);</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineminus">-</span>
<a href="#l5.171"></a><span id="l5.171">     mHeadersOnly = PR_FALSE;</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineminus">-    rv = OnDataAvailable(request, ctxt, stream, 0, mHtmlToQuote.Length());</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineplus">+    rv = AppendToMsgBody(mHtmlToQuote);</span>
<a href="#l5.174"></a><span id="l5.174">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.175"></a><span id="l5.175">   }</span>
<a href="#l5.176"></a><span id="l5.176"> </span>
<a href="#l5.177"></a><span id="l5.177">   nsCOMPtr&lt;nsIMsgCompose&gt; compose = do_QueryReferent(mWeakComposeObj);</span>
<a href="#l5.178"></a><span id="l5.178">   if (compose)</span>
<a href="#l5.179"></a><span id="l5.179">   {</span>
<a href="#l5.180"></a><span id="l5.180">     MSG_ComposeType type;</span>
<a href="#l5.181"></a><span id="l5.181">     compose-&gt;GetType(&amp;type);</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineat">@@ -2553,17 +2549,17 @@ NS_IMETHODIMP QuotingOutputStreamListene</span>
<a href="#l5.183"></a><span id="l5.183">         mHeaders-&gt;ExtractHeader(HEADER_LIST_POST, PR_TRUE, getter_Copies(outCString));</span>
<a href="#l5.184"></a><span id="l5.184">         if (!outCString.IsEmpty())</span>
<a href="#l5.185"></a><span id="l5.185">           mMimeConverter-&gt;DecodeMimeHeader(outCString.get(), charset.get(),</span>
<a href="#l5.186"></a><span id="l5.186">                                            PR_FALSE, PR_TRUE, listPost);</span>
<a href="#l5.187"></a><span id="l5.187"> </span>
<a href="#l5.188"></a><span id="l5.188">         if (!listPost.IsEmpty())</span>
<a href="#l5.189"></a><span id="l5.189">         {</span>
<a href="#l5.190"></a><span id="l5.190">           PRInt32 startPos = listPost.Find(&quot;&lt;mailto:&quot;);</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineminus">-          PRInt32 endPos = listPost.Find(&quot;&gt;&quot;, PR_FALSE, startPos);</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineplus">+          PRInt32 endPos = listPost.FindChar('&gt;', startPos);</span>
<a href="#l5.193"></a><span id="l5.193">           // Extract the e-mail address.</span>
<a href="#l5.194"></a><span id="l5.194">           if (endPos &gt; startPos)</span>
<a href="#l5.195"></a><span id="l5.195">           {</span>
<a href="#l5.196"></a><span id="l5.196">             const PRUint32 mailtoLen = strlen(&quot;&lt;mailto:&quot;);</span>
<a href="#l5.197"></a><span id="l5.197">             listPost = Substring(listPost, startPos + mailtoLen, endPos - (startPos + mailtoLen));</span>
<a href="#l5.198"></a><span id="l5.198">             compFields-&gt;SetListReply(listPost);</span>
<a href="#l5.199"></a><span id="l5.199">             if (type == nsIMsgCompType::ReplyToList)</span>
<a href="#l5.200"></a><span id="l5.200">               compFields-&gt;SetTo(listPost);</span>
<a href="#l5.201"></a><span id="l5.201" class="difflineat">@@ -2763,20 +2759,20 @@ NS_IMETHODIMP QuotingOutputStreamListene</span>
<a href="#l5.202"></a><span id="l5.202">     // just get lots of HTML text in the message...not good.</span>
<a href="#l5.203"></a><span id="l5.203">     //</span>
<a href="#l5.204"></a><span id="l5.204">     // XXX not m_composeHTML? /BenB</span>
<a href="#l5.205"></a><span id="l5.205">     PRBool composeHTML = PR_TRUE;</span>
<a href="#l5.206"></a><span id="l5.206">     compose-&gt;GetComposeHTML(&amp;composeHTML);</span>
<a href="#l5.207"></a><span id="l5.207">     if (!composeHTML)</span>
<a href="#l5.208"></a><span id="l5.208">     {</span>
<a href="#l5.209"></a><span id="l5.209">       // Downsampling. The charset should only consist of ascii.</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineminus">-      char *target_charset = ToNewCString(aCharset);</span>
<a href="#l5.211"></a><span id="l5.211" class="difflineminus">-      PRBool formatflowed = UseFormatFlowed(target_charset);</span>
<a href="#l5.212"></a><span id="l5.212" class="difflineplus">+</span>
<a href="#l5.213"></a><span id="l5.213" class="difflineplus">+      PRBool formatflowed =</span>
<a href="#l5.214"></a><span id="l5.214" class="difflineplus">+        UseFormatFlowed(NS_LossyConvertUTF16toASCII(aCharset).get());</span>
<a href="#l5.215"></a><span id="l5.215">       ConvertToPlainText(formatflowed);</span>
<a href="#l5.216"></a><span id="l5.216" class="difflineminus">-      Recycle(target_charset);</span>
<a href="#l5.217"></a><span id="l5.217">     }</span>
<a href="#l5.218"></a><span id="l5.218"> </span>
<a href="#l5.219"></a><span id="l5.219">     compose-&gt;ProcessSignature(mIdentity, PR_TRUE, &amp;mSignature);</span>
<a href="#l5.220"></a><span id="l5.220"> </span>
<a href="#l5.221"></a><span id="l5.221">     nsCOMPtr&lt;nsIEditor&gt; editor;</span>
<a href="#l5.222"></a><span id="l5.222">     if (NS_SUCCEEDED(compose-&gt;GetEditor(getter_AddRefs(editor))) &amp;&amp; editor)</span>
<a href="#l5.223"></a><span id="l5.223">     {</span>
<a href="#l5.224"></a><span id="l5.224">       if (mQuoteOriginal)</span>
<a href="#l5.225"></a><span id="l5.225" class="difflineat">@@ -2809,33 +2805,46 @@ NS_IMETHODIMP QuotingOutputStreamListene</span>
<a href="#l5.226"></a><span id="l5.226"> </span>
<a href="#l5.227"></a><span id="l5.227">   PRUint32 numWritten = 0;</span>
<a href="#l5.228"></a><span id="l5.228">   rv = inStr-&gt;Read(newBuf, count, &amp;numWritten);</span>
<a href="#l5.229"></a><span id="l5.229">   if (rv == NS_BASE_STREAM_WOULD_BLOCK)</span>
<a href="#l5.230"></a><span id="l5.230">     rv = NS_OK;</span>
<a href="#l5.231"></a><span id="l5.231">   newBuf[numWritten] = '\0';</span>
<a href="#l5.232"></a><span id="l5.232">   if (NS_SUCCEEDED(rv) &amp;&amp; numWritten &gt; 0)</span>
<a href="#l5.233"></a><span id="l5.233">   {</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineplus">+    rv = AppendToMsgBody(nsDependentCString(newBuf, numWritten));</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineplus">+  }</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineplus">+</span>
<a href="#l5.237"></a><span id="l5.237" class="difflineplus">+  PR_FREEIF(newBuf);</span>
<a href="#l5.238"></a><span id="l5.238" class="difflineplus">+  return rv;</span>
<a href="#l5.239"></a><span id="l5.239" class="difflineplus">+}</span>
<a href="#l5.240"></a><span id="l5.240" class="difflineplus">+</span>
<a href="#l5.241"></a><span id="l5.241" class="difflineplus">+NS_IMETHODIMP QuotingOutputStreamListener::AppendToMsgBody(const nsCString &amp;inStr)</span>
<a href="#l5.242"></a><span id="l5.242" class="difflineplus">+{</span>
<a href="#l5.243"></a><span id="l5.243" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l5.244"></a><span id="l5.244" class="difflineplus">+</span>
<a href="#l5.245"></a><span id="l5.245" class="difflineplus">+  if (!inStr.IsEmpty())</span>
<a href="#l5.246"></a><span id="l5.246" class="difflineplus">+  {</span>
<a href="#l5.247"></a><span id="l5.247">     // Create unicode decoder.</span>
<a href="#l5.248"></a><span id="l5.248">     if (!mUnicodeDecoder)</span>
<a href="#l5.249"></a><span id="l5.249">     {</span>
<a href="#l5.250"></a><span id="l5.250">       nsCOMPtr&lt;nsICharsetConverterManager&gt; ccm =</span>
<a href="#l5.251"></a><span id="l5.251">                do_GetService(NS_CHARSETCONVERTERMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l5.252"></a><span id="l5.252">       if (NS_SUCCEEDED(rv))</span>
<a href="#l5.253"></a><span id="l5.253">       {</span>
<a href="#l5.254"></a><span id="l5.254">         rv = ccm-&gt;GetUnicodeDecoderRaw(&quot;UTF-8&quot;,</span>
<a href="#l5.255"></a><span id="l5.255">                                        getter_AddRefs(mUnicodeDecoder));</span>
<a href="#l5.256"></a><span id="l5.256">       }</span>
<a href="#l5.257"></a><span id="l5.257">     }</span>
<a href="#l5.258"></a><span id="l5.258"> </span>
<a href="#l5.259"></a><span id="l5.259">     if (NS_SUCCEEDED(rv))</span>
<a href="#l5.260"></a><span id="l5.260">     {</span>
<a href="#l5.261"></a><span id="l5.261">       PRInt32 unicharLength;</span>
<a href="#l5.262"></a><span id="l5.262" class="difflineminus">-      PRInt32 inputLength = (PRInt32) numWritten;</span>
<a href="#l5.263"></a><span id="l5.263" class="difflineminus">-      rv = mUnicodeDecoder-&gt;GetMaxLength(newBuf, numWritten, &amp;unicharLength);</span>
<a href="#l5.264"></a><span id="l5.264" class="difflineplus">+      PRInt32 inputLength = inStr.Length();</span>
<a href="#l5.265"></a><span id="l5.265" class="difflineplus">+      rv = mUnicodeDecoder-&gt;GetMaxLength(inStr.get(), inStr.Length(), &amp;unicharLength);</span>
<a href="#l5.266"></a><span id="l5.266">       if (NS_SUCCEEDED(rv))</span>
<a href="#l5.267"></a><span id="l5.267">       {</span>
<a href="#l5.268"></a><span id="l5.268">         // Use this local buffer if possible.</span>
<a href="#l5.269"></a><span id="l5.269">         const PRInt32 kLocalBufSize = 4096;</span>
<a href="#l5.270"></a><span id="l5.270">         PRUnichar localBuf[kLocalBufSize];</span>
<a href="#l5.271"></a><span id="l5.271">         PRUnichar *unichars = localBuf;</span>
<a href="#l5.272"></a><span id="l5.272"> </span>
<a href="#l5.273"></a><span id="l5.273">         if (unicharLength &gt; kLocalBufSize)</span>
<a href="#l5.274"></a><span id="l5.274" class="difflineat">@@ -2845,27 +2854,26 @@ NS_IMETHODIMP QuotingOutputStreamListene</span>
<a href="#l5.275"></a><span id="l5.275">               unicharLength &gt; mUnicodeBufferCharacterLength)</span>
<a href="#l5.276"></a><span id="l5.276">           {</span>
<a href="#l5.277"></a><span id="l5.277">             if (mUnicodeConversionBuffer)</span>
<a href="#l5.278"></a><span id="l5.278">               nsMemory::Free(mUnicodeConversionBuffer);</span>
<a href="#l5.279"></a><span id="l5.279">             mUnicodeConversionBuffer = (PRUnichar *) nsMemory::Alloc(unicharLength * sizeof(PRUnichar));</span>
<a href="#l5.280"></a><span id="l5.280">             if (!mUnicodeConversionBuffer)</span>
<a href="#l5.281"></a><span id="l5.281">             {</span>
<a href="#l5.282"></a><span id="l5.282">               mUnicodeBufferCharacterLength = 0;</span>
<a href="#l5.283"></a><span id="l5.283" class="difflineminus">-              PR_Free(newBuf);</span>
<a href="#l5.284"></a><span id="l5.284">               return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l5.285"></a><span id="l5.285">             }</span>
<a href="#l5.286"></a><span id="l5.286">             mUnicodeBufferCharacterLength = unicharLength;</span>
<a href="#l5.287"></a><span id="l5.287">           }</span>
<a href="#l5.288"></a><span id="l5.288">           unichars = mUnicodeConversionBuffer;</span>
<a href="#l5.289"></a><span id="l5.289">         }</span>
<a href="#l5.290"></a><span id="l5.290"> </span>
<a href="#l5.291"></a><span id="l5.291">         PRInt32 consumedInputLength = 0;</span>
<a href="#l5.292"></a><span id="l5.292">         PRInt32 originalInputLength = inputLength;</span>
<a href="#l5.293"></a><span id="l5.293" class="difflineminus">-        char *inputBuffer = newBuf;</span>
<a href="#l5.294"></a><span id="l5.294" class="difflineplus">+        const char *inputBuffer = inStr.get();</span>
<a href="#l5.295"></a><span id="l5.295">         PRInt32 convertedOutputLength = 0;</span>
<a href="#l5.296"></a><span id="l5.296">         PRInt32 outputBufferLength = unicharLength;</span>
<a href="#l5.297"></a><span id="l5.297">         PRUnichar *originalOutputBuffer = unichars;</span>
<a href="#l5.298"></a><span id="l5.298">         do</span>
<a href="#l5.299"></a><span id="l5.299">         {</span>
<a href="#l5.300"></a><span id="l5.300">           rv = mUnicodeDecoder-&gt;Convert(inputBuffer, &amp;inputLength, unichars, &amp;unicharLength);</span>
<a href="#l5.301"></a><span id="l5.301">           if (NS_SUCCEEDED(rv))</span>
<a href="#l5.302"></a><span id="l5.302">           {</span>
<a href="#l5.303"></a><span id="l5.303" class="difflineat">@@ -2893,17 +2901,16 @@ NS_IMETHODIMP QuotingOutputStreamListene</span>
<a href="#l5.304"></a><span id="l5.304">                  (outputBufferLength &gt; convertedOutputLength));</span>
<a href="#l5.305"></a><span id="l5.305"> </span>
<a href="#l5.306"></a><span id="l5.306">         if (convertedOutputLength &gt; 0)</span>
<a href="#l5.307"></a><span id="l5.307">           mMsgBody.Append(originalOutputBuffer, convertedOutputLength);</span>
<a href="#l5.308"></a><span id="l5.308">       }</span>
<a href="#l5.309"></a><span id="l5.309">     }</span>
<a href="#l5.310"></a><span id="l5.310">   }</span>
<a href="#l5.311"></a><span id="l5.311"> </span>
<a href="#l5.312"></a><span id="l5.312" class="difflineminus">-  PR_FREEIF(newBuf);</span>
<a href="#l5.313"></a><span id="l5.313">   return rv;</span>
<a href="#l5.314"></a><span id="l5.314"> }</span>
<a href="#l5.315"></a><span id="l5.315"> </span>
<a href="#l5.316"></a><span id="l5.316"> nsresult</span>
<a href="#l5.317"></a><span id="l5.317"> QuotingOutputStreamListener::SetComposeObj(nsIMsgCompose *obj)</span>
<a href="#l5.318"></a><span id="l5.318"> {</span>
<a href="#l5.319"></a><span id="l5.319">   mWeakComposeObj = do_GetWeakReference(obj);</span>
<a href="#l5.320"></a><span id="l5.320">   return NS_OK;</span>
<a href="#l5.321"></a><span id="l5.321" class="difflineat">@@ -3756,17 +3763,17 @@ nsMsgComposeSendListener::RemoveCurrentD</span>
<a href="#l5.322"></a><span id="l5.322">         NS_ASSERTION(imapFolder, &quot;The draft folder MUST be an imap folder in order to mark the msg delete!&quot;);</span>
<a href="#l5.323"></a><span id="l5.323">         if (NS_SUCCEEDED(rv) &amp;&amp; imapFolder)</span>
<a href="#l5.324"></a><span id="l5.324">         {</span>
<a href="#l5.325"></a><span id="l5.325">           const char * str = PL_strchr(curDraftIdURL.get(), '#');</span>
<a href="#l5.326"></a><span id="l5.326">           NS_ASSERTION(str, &quot;Failed to get current draft id url&quot;);</span>
<a href="#l5.327"></a><span id="l5.327">           if (str)</span>
<a href="#l5.328"></a><span id="l5.328">           {</span>
<a href="#l5.329"></a><span id="l5.329">             nsCAutoString srcStr(str+1);</span>
<a href="#l5.330"></a><span id="l5.330" class="difflineminus">-            PRInt32 err;</span>
<a href="#l5.331"></a><span id="l5.331" class="difflineplus">+            nsresult err;</span>
<a href="#l5.332"></a><span id="l5.332">             nsMsgKey messageID = srcStr.ToInteger(&amp;err, 10);</span>
<a href="#l5.333"></a><span id="l5.333">             if (messageID != nsMsgKey_None)</span>
<a href="#l5.334"></a><span id="l5.334">             {</span>
<a href="#l5.335"></a><span id="l5.335">               rv = imapFolder-&gt;StoreImapFlags(kImapMsgDeletedFlag, PR_TRUE,</span>
<a href="#l5.336"></a><span id="l5.336">                                               &amp;messageID, 1, nsnull);</span>
<a href="#l5.337"></a><span id="l5.337">             }</span>
<a href="#l5.338"></a><span id="l5.338">           }</span>
<a href="#l5.339"></a><span id="l5.339">         }</span>
<a href="#l5.340"></a><span id="l5.340" class="difflineat">@@ -3912,17 +3919,17 @@ nsMsgCompose::ConvertTextToHTML(nsILocal</span>
<a href="#l5.341"></a><span id="l5.341"> </span>
<a href="#l5.342"></a><span id="l5.342">   rv = LoadDataFromFile(aSigFile, origBuf);</span>
<a href="#l5.343"></a><span id="l5.343">   if (NS_FAILED(rv))</span>
<a href="#l5.344"></a><span id="l5.344">     return rv;</span>
<a href="#l5.345"></a><span id="l5.345"> </span>
<a href="#l5.346"></a><span id="l5.346">   // Ok, once we are here, we need to escape the data to make sure that</span>
<a href="#l5.347"></a><span id="l5.347">   // we don't do HTML stuff with plain text sigs.</span>
<a href="#l5.348"></a><span id="l5.348">   //</span>
<a href="#l5.349"></a><span id="l5.349" class="difflineminus">-  PRUnichar *escaped = nsEscapeHTML2(origBuf.get());</span>
<a href="#l5.350"></a><span id="l5.350" class="difflineplus">+  PRUnichar *escaped = MsgEscapeHTML2(origBuf.get(), origBuf.Length());</span>
<a href="#l5.351"></a><span id="l5.351">   if (escaped)</span>
<a href="#l5.352"></a><span id="l5.352">   {</span>
<a href="#l5.353"></a><span id="l5.353">     aSigData.Append(escaped);</span>
<a href="#l5.354"></a><span id="l5.354">     NS_Free(escaped);</span>
<a href="#l5.355"></a><span id="l5.355">   }</span>
<a href="#l5.356"></a><span id="l5.356">   else</span>
<a href="#l5.357"></a><span id="l5.357">     aSigData.Append(origBuf);</span>
<a href="#l5.358"></a><span id="l5.358">   return NS_OK;</span>
<a href="#l5.359"></a><span id="l5.359" class="difflineat">@@ -3972,17 +3979,17 @@ nsMsgCompose::LoadDataFromFile(nsILocalF</span>
<a href="#l5.360"></a><span id="l5.360">   inputFile-&gt;Close();</span>
<a href="#l5.361"></a><span id="l5.361"> </span>
<a href="#l5.362"></a><span id="l5.362">   readSize = (PRUint32) fileSize;</span>
<a href="#l5.363"></a><span id="l5.363"> </span>
<a href="#l5.364"></a><span id="l5.364">   nsCAutoString sigEncoding(nsMsgI18NParseMetaCharset(file));</span>
<a href="#l5.365"></a><span id="l5.365">   PRBool removeSigCharset = !sigEncoding.IsEmpty() &amp;&amp; m_composeHTML;</span>
<a href="#l5.366"></a><span id="l5.366"> </span>
<a href="#l5.367"></a><span id="l5.367">   if (sigEncoding.IsEmpty()) {</span>
<a href="#l5.368"></a><span id="l5.368" class="difflineminus">-    if (aAllowUTF8 &amp;&amp; IsUTF8(nsDependentCString(readBuf))) {</span>
<a href="#l5.369"></a><span id="l5.369" class="difflineplus">+    if (aAllowUTF8 &amp;&amp; MsgIsUTF8(nsDependentCString(readBuf))) {</span>
<a href="#l5.370"></a><span id="l5.370">       sigEncoding.Assign(&quot;UTF-8&quot;);</span>
<a href="#l5.371"></a><span id="l5.371">     }</span>
<a href="#l5.372"></a><span id="l5.372">     else if (sigEncoding.IsEmpty() &amp;&amp; aAllowUTF16 &amp;&amp;</span>
<a href="#l5.373"></a><span id="l5.373">              readSize % 2 == 0 &amp;&amp; readSize &gt;= 2 &amp;&amp;</span>
<a href="#l5.374"></a><span id="l5.374">              ((readBuf[0] == char(0xFE) &amp;&amp; readBuf[1] == char(0xFF)) ||</span>
<a href="#l5.375"></a><span id="l5.375">               (readBuf[0] == char(0xFF) &amp;&amp; readBuf[1] == char(0xFE)))) {</span>
<a href="#l5.376"></a><span id="l5.376">       sigEncoding.Assign(&quot;UTF-16&quot;);</span>
<a href="#l5.377"></a><span id="l5.377">     }</span>
<a href="#l5.378"></a><span id="l5.378" class="difflineat">@@ -3998,29 +4005,21 @@ nsMsgCompose::LoadDataFromFile(nsILocalF</span>
<a href="#l5.379"></a><span id="l5.379">   PR_FREEIF(readBuf);</span>
<a href="#l5.380"></a><span id="l5.380"> </span>
<a href="#l5.381"></a><span id="l5.381">   if (NS_FAILED(ConvertToUnicode(sigEncoding.get(), readStr, sigData)))</span>
<a href="#l5.382"></a><span id="l5.382">     CopyASCIItoUTF16(readStr, sigData);</span>
<a href="#l5.383"></a><span id="l5.383"> </span>
<a href="#l5.384"></a><span id="l5.384">   //remove sig meta charset to allow user charset override during composition</span>
<a href="#l5.385"></a><span id="l5.385">   if (removeSigCharset)</span>
<a href="#l5.386"></a><span id="l5.386">   {</span>
<a href="#l5.387"></a><span id="l5.387" class="difflineminus">-    nsAutoString metaCharset(NS_LITERAL_STRING(&quot;charset=&quot;));</span>
<a href="#l5.388"></a><span id="l5.388" class="difflineminus">-    AppendASCIItoUTF16(sigEncoding, metaCharset);</span>
<a href="#l5.389"></a><span id="l5.389" class="difflineminus">-    // When we move to frozen linkage, this should become:</span>
<a href="#l5.390"></a><span id="l5.390" class="difflineminus">-    // PRInt32 offset = sigData.Find(metaCharset, CaseInsensitiveCompare) ;</span>
<a href="#l5.391"></a><span id="l5.391" class="difflineminus">-    //  if (offset &gt;= 0)</span>
<a href="#l5.392"></a><span id="l5.392" class="difflineminus">-    //    sigData.Cut(offset, metaCharset.Length());</span>
<a href="#l5.393"></a><span id="l5.393" class="difflineminus">-    nsAString::const_iterator realstart, start, end;</span>
<a href="#l5.394"></a><span id="l5.394" class="difflineminus">-    sigData.BeginReading(start);</span>
<a href="#l5.395"></a><span id="l5.395" class="difflineminus">-    sigData.EndReading(end);</span>
<a href="#l5.396"></a><span id="l5.396" class="difflineminus">-    realstart = start;</span>
<a href="#l5.397"></a><span id="l5.397" class="difflineminus">-    if (FindInReadable(metaCharset, start, end,</span>
<a href="#l5.398"></a><span id="l5.398" class="difflineminus">-                       nsCaseInsensitiveStringComparator()))</span>
<a href="#l5.399"></a><span id="l5.399" class="difflineminus">-      sigData.Cut(Distance(realstart, start), Distance(start, end));</span>
<a href="#l5.400"></a><span id="l5.400" class="difflineplus">+    nsCAutoString metaCharset(&quot;charset=&quot;);</span>
<a href="#l5.401"></a><span id="l5.401" class="difflineplus">+    metaCharset.Append(sigEncoding);</span>
<a href="#l5.402"></a><span id="l5.402" class="difflineplus">+    PRInt32 pos = sigData.Find(metaCharset.BeginReading(), PR_TRUE);</span>
<a href="#l5.403"></a><span id="l5.403" class="difflineplus">+    if (pos != kNotFound)</span>
<a href="#l5.404"></a><span id="l5.404" class="difflineplus">+      sigData.Cut(pos, metaCharset.Length());</span>
<a href="#l5.405"></a><span id="l5.405">   }</span>
<a href="#l5.406"></a><span id="l5.406"> </span>
<a href="#l5.407"></a><span id="l5.407">   return NS_OK;</span>
<a href="#l5.408"></a><span id="l5.408"> }</span>
<a href="#l5.409"></a><span id="l5.409"> </span>
<a href="#l5.410"></a><span id="l5.410"> nsresult</span>
<a href="#l5.411"></a><span id="l5.411"> nsMsgCompose::BuildQuotedMessageAndSignature(void)</span>
<a href="#l5.412"></a><span id="l5.412"> {</span>
<a href="#l5.413"></a><span id="l5.413" class="difflineat">@@ -4191,17 +4190,17 @@ nsMsgCompose::ProcessSignature(nsIMsgIde</span>
<a href="#l5.414"></a><span id="l5.414">       if (htmlSig)</span>
<a href="#l5.415"></a><span id="l5.415">         ConvertBufToPlainText(prefSigText, PR_FALSE);</span>
<a href="#l5.416"></a><span id="l5.416">       sigData.Append(prefSigText);</span>
<a href="#l5.417"></a><span id="l5.417">     }</span>
<a href="#l5.418"></a><span id="l5.418">     else</span>
<a href="#l5.419"></a><span id="l5.419">     {</span>
<a href="#l5.420"></a><span id="l5.420">       if (!htmlSig)</span>
<a href="#l5.421"></a><span id="l5.421">       {</span>
<a href="#l5.422"></a><span id="l5.422" class="difflineminus">-        PRUnichar* escaped = nsEscapeHTML2(prefSigText.get());</span>
<a href="#l5.423"></a><span id="l5.423" class="difflineplus">+        PRUnichar* escaped = MsgEscapeHTML2(prefSigText.get(), prefSigText.Length());</span>
<a href="#l5.424"></a><span id="l5.424">         if (escaped)</span>
<a href="#l5.425"></a><span id="l5.425">         {</span>
<a href="#l5.426"></a><span id="l5.426">           sigData.Append(escaped);</span>
<a href="#l5.427"></a><span id="l5.427">           NS_Free(escaped);</span>
<a href="#l5.428"></a><span id="l5.428">         }</span>
<a href="#l5.429"></a><span id="l5.429">         else</span>
<a href="#l5.430"></a><span id="l5.430">           sigData.Append(prefSigText);</span>
<a href="#l5.431"></a><span id="l5.431">       }</span>
<a href="#l5.432"></a><span id="l5.432" class="difflineat">@@ -4224,17 +4223,17 @@ nsMsgCompose::ProcessSignature(nsIMsgIde</span>
<a href="#l5.433"></a><span id="l5.433">   if (!sigData.IsEmpty())</span>
<a href="#l5.434"></a><span id="l5.434">   {</span>
<a href="#l5.435"></a><span id="l5.435">     if (m_composeHTML)</span>
<a href="#l5.436"></a><span id="l5.436">     {</span>
<a href="#l5.437"></a><span id="l5.437">       sigOutput.AppendLiteral(htmlBreak);</span>
<a href="#l5.438"></a><span id="l5.438">       if (htmlSig)</span>
<a href="#l5.439"></a><span id="l5.439">         sigOutput.AppendLiteral(htmlsigopen);</span>
<a href="#l5.440"></a><span id="l5.440">       else</span>
<a href="#l5.441"></a><span id="l5.441" class="difflineminus">-        sigOutput.AppendASCII(preopen);</span>
<a href="#l5.442"></a><span id="l5.442" class="difflineplus">+        sigOutput.Append(NS_ConvertASCIItoUTF16(preopen));</span>
<a href="#l5.443"></a><span id="l5.443">     }</span>
<a href="#l5.444"></a><span id="l5.444">     else</span>
<a href="#l5.445"></a><span id="l5.445">       sigOutput.AppendLiteral(CRLF);</span>
<a href="#l5.446"></a><span id="l5.446"> </span>
<a href="#l5.447"></a><span id="l5.447">     if ((reply_on_top != 1 || sig_bottom || !aQuoted) &amp;&amp;</span>
<a href="#l5.448"></a><span id="l5.448">         sigData.Find(&quot;\r-- \r&quot;, PR_TRUE) &lt; 0 &amp;&amp;</span>
<a href="#l5.449"></a><span id="l5.449">         sigData.Find(&quot;\n-- \n&quot;, PR_TRUE) &lt; 0 &amp;&amp;</span>
<a href="#l5.450"></a><span id="l5.450">         sigData.Find(&quot;\n-- \r&quot;, PR_TRUE) &lt; 0)</span>
<a href="#l5.451"></a><span id="l5.451" class="difflineat">@@ -4327,17 +4326,17 @@ nsMsgCompose::BuildBodyMessageAndSignatu</span>
<a href="#l5.452"></a><span id="l5.452">   nsAutoString tSignature;</span>
<a href="#l5.453"></a><span id="l5.453">   if (addSignature)</span>
<a href="#l5.454"></a><span id="l5.454">     ProcessSignature(m_identity, addDashes, &amp;tSignature);</span>
<a href="#l5.455"></a><span id="l5.455"> </span>
<a href="#l5.456"></a><span id="l5.456">   // if type is new, but we have body, this is probably a mapi send, so we need to</span>
<a href="#l5.457"></a><span id="l5.457">   // replace '\n' with &lt;br&gt; so that the line breaks won't be lost by html.</span>
<a href="#l5.458"></a><span id="l5.458">   // if mailtourl, do the same.</span>
<a href="#l5.459"></a><span id="l5.459">   if (m_composeHTML &amp;&amp; (mType == nsIMsgCompType::New || mType == nsIMsgCompType::MailToUrl))</span>
<a href="#l5.460"></a><span id="l5.460" class="difflineminus">-    body.ReplaceSubstring(NS_LITERAL_STRING(&quot;\n&quot;).get(), NS_LITERAL_STRING(&quot;&lt;br&gt;&quot;).get());</span>
<a href="#l5.461"></a><span id="l5.461" class="difflineplus">+    MsgReplaceSubstring(body, NS_LITERAL_STRING(&quot;\n&quot;), NS_LITERAL_STRING(&quot;&lt;br&gt;&quot;));</span>
<a href="#l5.462"></a><span id="l5.462"> </span>
<a href="#l5.463"></a><span id="l5.463">   // Restore flowed text wrapping for Drafts/Templates.</span>
<a href="#l5.464"></a><span id="l5.464">   // Look for unquoted lines - if we have an unquoted line</span>
<a href="#l5.465"></a><span id="l5.465">   // that ends in a space, join this line with the next one</span>
<a href="#l5.466"></a><span id="l5.466">   // by removing the end of line char(s).</span>
<a href="#l5.467"></a><span id="l5.467">   PRInt32 wrapping_enabled = 0;</span>
<a href="#l5.468"></a><span id="l5.468">   GetWrapLength(&amp;wrapping_enabled);</span>
<a href="#l5.469"></a><span id="l5.469">   if (!m_composeHTML &amp;&amp; !addSignature &amp;&amp; wrapping_enabled)</span>
<a href="#l5.470"></a><span id="l5.470" class="difflineat">@@ -4428,19 +4427,17 @@ nsresult nsMsgCompose::NotifyStateListen</span>
<a href="#l5.471"></a><span id="l5.471"> </span>
<a href="#l5.472"></a><span id="l5.472">   return NS_OK;</span>
<a href="#l5.473"></a><span id="l5.473"> }</span>
<a href="#l5.474"></a><span id="l5.474"> </span>
<a href="#l5.475"></a><span id="l5.475"> nsresult nsMsgCompose::AttachmentPrettyName(const nsACString &amp; scheme, const char* charset, nsACString&amp; _retval)</span>
<a href="#l5.476"></a><span id="l5.476"> {</span>
<a href="#l5.477"></a><span id="l5.477">   nsresult rv;</span>
<a href="#l5.478"></a><span id="l5.478"> </span>
<a href="#l5.479"></a><span id="l5.479" class="difflineminus">-  nsCAutoString utf8Scheme;</span>
<a href="#l5.480"></a><span id="l5.480" class="difflineminus">-</span>
<a href="#l5.481"></a><span id="l5.481" class="difflineminus">-  if (StringHead(scheme, 5).LowerCaseEqualsLiteral(&quot;file:&quot;))</span>
<a href="#l5.482"></a><span id="l5.482" class="difflineplus">+  if (MsgLowerCaseEqualsLiteral(StringHead(scheme, 5), &quot;file:&quot;))</span>
<a href="#l5.483"></a><span id="l5.483">   {</span>
<a href="#l5.484"></a><span id="l5.484">     nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l5.485"></a><span id="l5.485">     rv = NS_GetFileFromURLSpec(scheme,</span>
<a href="#l5.486"></a><span id="l5.486">                                getter_AddRefs(file));</span>
<a href="#l5.487"></a><span id="l5.487">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.488"></a><span id="l5.488">     nsAutoString leafName;</span>
<a href="#l5.489"></a><span id="l5.489">     rv = file-&gt;GetLeafName(leafName);</span>
<a href="#l5.490"></a><span id="l5.490">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.491"></a><span id="l5.491" class="difflineat">@@ -4457,17 +4454,17 @@ nsresult nsMsgCompose::AttachmentPrettyN</span>
<a href="#l5.492"></a><span id="l5.492">   nsAutoString retUrl;</span>
<a href="#l5.493"></a><span id="l5.493">   rv = textToSubURI-&gt;UnEscapeURIForUI(nsDependentCString(cset), scheme, retUrl);</span>
<a href="#l5.494"></a><span id="l5.494"> </span>
<a href="#l5.495"></a><span id="l5.495">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.496"></a><span id="l5.496">     CopyUTF16toUTF8(retUrl, _retval);</span>
<a href="#l5.497"></a><span id="l5.497">   } else {</span>
<a href="#l5.498"></a><span id="l5.498">     _retval.Assign(scheme);</span>
<a href="#l5.499"></a><span id="l5.499">   }</span>
<a href="#l5.500"></a><span id="l5.500" class="difflineminus">-  if (StringHead(scheme, 5).LowerCaseEqualsLiteral(&quot;http:&quot;))</span>
<a href="#l5.501"></a><span id="l5.501" class="difflineplus">+  if (MsgLowerCaseEqualsLiteral(StringHead(scheme, 5), &quot;http:&quot;))</span>
<a href="#l5.502"></a><span id="l5.502">     _retval.Cut(0, 7);</span>
<a href="#l5.503"></a><span id="l5.503"> </span>
<a href="#l5.504"></a><span id="l5.504">   return NS_OK;</span>
<a href="#l5.505"></a><span id="l5.505"> }</span>
<a href="#l5.506"></a><span id="l5.506"> </span>
<a href="#l5.507"></a><span id="l5.507"> nsresult nsMsgCompose::GetABDirectories(const nsACString&amp; aDirUri,</span>
<a href="#l5.508"></a><span id="l5.508">                                         nsIRDFService *aRDFService,</span>
<a href="#l5.509"></a><span id="l5.509">                                         nsCOMArray&lt;nsIAbDirectory&gt; &amp;aDirArray)</span>
<a href="#l5.510"></a><span id="l5.510" class="difflineat">@@ -4878,39 +4875,35 @@ nsMsgCompose::CheckAndPopulateRecipients</span>
<a href="#l5.511"></a><span id="l5.511">   PRBool atLeastOneRecipientPrefersPlainText = PR_FALSE;</span>
<a href="#l5.512"></a><span id="l5.512">   PRBool atLeastOneRecipientPrefersHTML = PR_FALSE;</span>
<a href="#l5.513"></a><span id="l5.513"> </span>
<a href="#l5.514"></a><span id="l5.514">   for (i = 0; i &lt; MAX_OF_RECIPIENT_ARRAY; ++i)</span>
<a href="#l5.515"></a><span id="l5.515">   {</span>
<a href="#l5.516"></a><span id="l5.516">     PRUint32 nbrRecipients = recipientsList[i].Length();</span>
<a href="#l5.517"></a><span id="l5.517">     if (nbrRecipients == 0)</span>
<a href="#l5.518"></a><span id="l5.518">       continue;</span>
<a href="#l5.519"></a><span id="l5.519" class="difflineminus">-    recipientsStr.SetLength(0);</span>
<a href="#l5.520"></a><span id="l5.520" class="difflineplus">+    recipientsStr.Truncate();</span>
<a href="#l5.521"></a><span id="l5.521"> </span>
<a href="#l5.522"></a><span id="l5.522">     for (j = 0; j &lt; nbrRecipients; ++j)</span>
<a href="#l5.523"></a><span id="l5.523">     {</span>
<a href="#l5.524"></a><span id="l5.524">       nsMsgRecipient &amp;recipient = recipientsList[i][j];</span>
<a href="#l5.525"></a><span id="l5.525"> </span>
<a href="#l5.526"></a><span id="l5.526">       // if we don't have a prefer format for a recipient, check the domain in</span>
<a href="#l5.527"></a><span id="l5.527">       // case we have a format defined for it</span>
<a href="#l5.528"></a><span id="l5.528">       if (recipient.mPreferFormat == nsIAbPreferMailFormat::unknown &amp;&amp;</span>
<a href="#l5.529"></a><span id="l5.529">           (plaintextDomains.Length() || htmlDomains.Length()))</span>
<a href="#l5.530"></a><span id="l5.530">       {</span>
<a href="#l5.531"></a><span id="l5.531">         PRInt32 atPos = recipient.mEmail.FindChar('@');</span>
<a href="#l5.532"></a><span id="l5.532">         if (atPos &gt;= 0)</span>
<a href="#l5.533"></a><span id="l5.533">         {</span>
<a href="#l5.534"></a><span id="l5.534" class="difflineminus">-          recipient.mEmail.Right(domain, recipient.mEmail.Length() - atPos - 1);</span>
<a href="#l5.535"></a><span id="l5.535" class="difflineminus">-          // when we move to frozen linkage this should be:</span>
<a href="#l5.536"></a><span id="l5.536" class="difflineminus">-          // if (plaintextDomains.Find(domain, CaseInsensitiveCompare) &gt;= 0)</span>
<a href="#l5.537"></a><span id="l5.537" class="difflineminus">-          if (FindInReadable(domain, plaintextDomains, nsCaseInsensitiveStringComparator()))</span>
<a href="#l5.538"></a><span id="l5.538" class="difflineplus">+          domain = Substring(recipient.mEmail, atPos + 1);</span>
<a href="#l5.539"></a><span id="l5.539" class="difflineplus">+          if (CaseInsensitiveFindInReadable(domain, plaintextDomains))</span>
<a href="#l5.540"></a><span id="l5.540">             recipient.mPreferFormat = nsIAbPreferMailFormat::plaintext;</span>
<a href="#l5.541"></a><span id="l5.541">           else</span>
<a href="#l5.542"></a><span id="l5.542" class="difflineminus">-            // when we move to frozen linkage this should be:</span>
<a href="#l5.543"></a><span id="l5.543" class="difflineminus">-            // if (htmlDomains.Find(domain, CaseInsensitiveCompare) &gt;= 0)</span>
<a href="#l5.544"></a><span id="l5.544" class="difflineminus">-            if (FindInReadable(domain, htmlDomains, nsCaseInsensitiveStringComparator()))</span>
<a href="#l5.545"></a><span id="l5.545" class="difflineplus">+            if (CaseInsensitiveFindInReadable(domain, htmlDomains))</span>
<a href="#l5.546"></a><span id="l5.546">               recipient.mPreferFormat = nsIAbPreferMailFormat::html;</span>
<a href="#l5.547"></a><span id="l5.547">         }</span>
<a href="#l5.548"></a><span id="l5.548">       }</span>
<a href="#l5.549"></a><span id="l5.549"> </span>
<a href="#l5.550"></a><span id="l5.550">       switch (recipient.mPreferFormat)</span>
<a href="#l5.551"></a><span id="l5.551">       {</span>
<a href="#l5.552"></a><span id="l5.552">       case nsIAbPreferMailFormat::html:</span>
<a href="#l5.553"></a><span id="l5.553">         atLeastOneRecipientPrefersHTML = PR_TRUE;</span>
<a href="#l5.554"></a><span id="l5.554" class="difflineat">@@ -5124,18 +5117,18 @@ nsresult nsMsgCompose::TagConvertible(ns</span>
<a href="#l5.555"></a><span id="l5.555">         nsAutoString className;</span>
<a href="#l5.556"></a><span id="l5.556">         className.AssignLiteral(&quot;class&quot;);</span>
<a href="#l5.557"></a><span id="l5.557">         if (NS_SUCCEEDED(pAttributes-&gt;GetNamedItem(className,</span>
<a href="#l5.558"></a><span id="l5.558">                                                    getter_AddRefs(pItem)))</span>
<a href="#l5.559"></a><span id="l5.559">             &amp;&amp; pItem)</span>
<a href="#l5.560"></a><span id="l5.560">         {</span>
<a href="#l5.561"></a><span id="l5.561">           nsAutoString classValue;</span>
<a href="#l5.562"></a><span id="l5.562">           if (NS_SUCCEEDED(pItem-&gt;GetNodeValue(classValue))</span>
<a href="#l5.563"></a><span id="l5.563" class="difflineminus">-              &amp;&amp; (classValue.EqualsIgnoreCase(&quot;moz-txt&quot;, 7) ||</span>
<a href="#l5.564"></a><span id="l5.564" class="difflineminus">-                  classValue.EqualsIgnoreCase(&quot;\&quot;moz-txt&quot;, 8)))</span>
<a href="#l5.565"></a><span id="l5.565" class="difflineplus">+              &amp;&amp; (StringBeginsWith(classValue, NS_LITERAL_STRING(&quot;moz-txt&quot;), nsCaseInsensitiveStringComparator()) ||</span>
<a href="#l5.566"></a><span id="l5.566" class="difflineplus">+                  StringBeginsWith(classValue, NS_LITERAL_STRING(&quot;\&quot;moz-txt&quot;), nsCaseInsensitiveStringComparator())))</span>
<a href="#l5.567"></a><span id="l5.567">           {</span>
<a href="#l5.568"></a><span id="l5.568">             *_retval = nsIMsgCompConvertible::Plain;</span>
<a href="#l5.569"></a><span id="l5.569">             return rv;  // Inconsistent :-(</span>
<a href="#l5.570"></a><span id="l5.570">           }</span>
<a href="#l5.571"></a><span id="l5.571">         }</span>
<a href="#l5.572"></a><span id="l5.572">       }</span>
<a href="#l5.573"></a><span id="l5.573"> </span>
<a href="#l5.574"></a><span id="l5.574">       // Maybe, it's an &lt;a&gt; element inserted by another recognizer (e.g. 4.x')</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -179,16 +179,17 @@ public:</span>
<a href="#l6.4"></a><span id="l6.4">     NS_DECL_ISUPPORTS</span>
<a href="#l6.5"></a><span id="l6.5">     NS_DECL_NSIREQUESTOBSERVER</span>
<a href="#l6.6"></a><span id="l6.6">     NS_DECL_NSISTREAMLISTENER</span>
<a href="#l6.7"></a><span id="l6.7">     NS_DECL_NSIMSGQUOTINGOUTPUTSTREAMLISTENER</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9">     NS_IMETHOD  SetComposeObj(nsIMsgCompose *obj);</span>
<a href="#l6.10"></a><span id="l6.10"> 	  NS_IMETHOD  ConvertToPlainText(PRBool formatflowed = PR_FALSE);</span>
<a href="#l6.11"></a><span id="l6.11">     NS_IMETHOD InsertToCompose(nsIEditor *aEditor, PRBool aHTMLEditor);</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+    NS_IMETHOD AppendToMsgBody(const nsCString &amp;inStr);</span>
<a href="#l6.13"></a><span id="l6.13"> </span>
<a href="#l6.14"></a><span id="l6.14"> private:</span>
<a href="#l6.15"></a><span id="l6.15">     nsWeakPtr                 mWeakComposeObj;</span>
<a href="#l6.16"></a><span id="l6.16">     nsString       				    mMsgBody;</span>
<a href="#l6.17"></a><span id="l6.17">     nsString       				    mCitePrefix;</span>
<a href="#l6.18"></a><span id="l6.18">     nsString       				    mSignature;</span>
<a href="#l6.19"></a><span id="l6.19">     PRBool						        mQuoteHeaders;</span>
<a href="#l6.20"></a><span id="l6.20">     PRBool						        mHeadersOnly;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgComposeParams.h</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgComposeParams.h</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -34,16 +34,17 @@</span>
<a href="#l7.4"></a><span id="l7.4">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l7.5"></a><span id="l7.5">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l7.6"></a><span id="l7.6">  *</span>
<a href="#l7.7"></a><span id="l7.7">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9"> #include &quot;nsIMsgComposeParams.h&quot;</span>
<a href="#l7.10"></a><span id="l7.10"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l7.11"></a><span id="l7.11"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l7.13"></a><span id="l7.13"> class nsMsgComposeParams : public nsIMsgComposeParams</span>
<a href="#l7.14"></a><span id="l7.14"> {</span>
<a href="#l7.15"></a><span id="l7.15"> public: </span>
<a href="#l7.16"></a><span id="l7.16">   nsMsgComposeParams();</span>
<a href="#l7.17"></a><span id="l7.17">   virtual ~nsMsgComposeParams();</span>
<a href="#l7.18"></a><span id="l7.18"> </span>
<a href="#l7.19"></a><span id="l7.19">   NS_DECL_ISUPPORTS</span>
<a href="#l7.20"></a><span id="l7.20">   NS_DECL_NSIMSGCOMPOSEPARAMS</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgComposeService.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgComposeService.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -52,17 +52,16 @@</span>
<a href="#l8.4"></a><span id="l8.4"> #include &quot;nsISmtpUrl.h&quot;</span>
<a href="#l8.5"></a><span id="l8.5"> #include &quot;nsIURI.h&quot;</span>
<a href="#l8.6"></a><span id="l8.6"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l8.7"></a><span id="l8.7"> #include &quot;nsIMsgComposeParams.h&quot;</span>
<a href="#l8.8"></a><span id="l8.8"> #include &quot;nsXPCOM.h&quot;</span>
<a href="#l8.9"></a><span id="l8.9"> #include &quot;nsISupportsPrimitives.h&quot;</span>
<a href="#l8.10"></a><span id="l8.10"> #include &quot;nsIWindowWatcher.h&quot;</span>
<a href="#l8.11"></a><span id="l8.11"> #include &quot;nsIDOMWindow.h&quot;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-#include &quot;nsEscape.h&quot;</span>
<a href="#l8.13"></a><span id="l8.13"> #include &quot;nsIContentViewer.h&quot;</span>
<a href="#l8.14"></a><span id="l8.14"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l8.15"></a><span id="l8.15"> #include &quot;nsIDocShell.h&quot;</span>
<a href="#l8.16"></a><span id="l8.16"> #include &quot;nsPIDOMWindow.h&quot;</span>
<a href="#l8.17"></a><span id="l8.17"> #include &quot;nsIDOMDocument.h&quot;</span>
<a href="#l8.18"></a><span id="l8.18"> #include &quot;nsIDOMHTMLDocument.h&quot;</span>
<a href="#l8.19"></a><span id="l8.19"> #include &quot;nsIDOMElement.h&quot;</span>
<a href="#l8.20"></a><span id="l8.20"> #include &quot;nsIXULWindow.h&quot;</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineat">@@ -100,16 +99,17 @@</span>
<a href="#l8.22"></a><span id="l8.22"> // &lt;for functions=&quot;HTMLSantinize&quot;&gt;</span>
<a href="#l8.23"></a><span id="l8.23"> #include &quot;nsIParser.h&quot;</span>
<a href="#l8.24"></a><span id="l8.24"> #include &quot;nsParserCIID.h&quot;</span>
<a href="#l8.25"></a><span id="l8.25"> #include &quot;nsIContentSink.h&quot;</span>
<a href="#l8.26"></a><span id="l8.26"> #include &quot;mozISanitizingSerializer.h&quot;</span>
<a href="#l8.27"></a><span id="l8.27"> </span>
<a href="#l8.28"></a><span id="l8.28"> #include &quot;nsICommandLine.h&quot;</span>
<a href="#l8.29"></a><span id="l8.29"> #include &quot;nsIAppStartup.h&quot;</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+#include &quot;nsMsgUtils.h&quot;</span>
<a href="#l8.31"></a><span id="l8.31"> </span>
<a href="#l8.32"></a><span id="l8.32"> #ifdef XP_WIN32</span>
<a href="#l8.33"></a><span id="l8.33"> #include &lt;windows.h&gt;</span>
<a href="#l8.34"></a><span id="l8.34"> #include &lt;shellapi.h&gt;</span>
<a href="#l8.35"></a><span id="l8.35"> #include &quot;nsIWidget.h&quot;</span>
<a href="#l8.36"></a><span id="l8.36"> #endif</span>
<a href="#l8.37"></a><span id="l8.37"> </span>
<a href="#l8.38"></a><span id="l8.38"> static NS_DEFINE_CID(kParserCID, NS_PARSER_CID);</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineat">@@ -489,19 +489,18 @@ nsMsgComposeService::GetOrigWindowSelect</span>
<a href="#l8.40"></a><span id="l8.40">     // If &quot;mailnews.reply_quoting_selection.multi_word&quot; is on, then there must be at least</span>
<a href="#l8.41"></a><span id="l8.41">     // two words selected in order to quote just the selected text</span>
<a href="#l8.42"></a><span id="l8.42">     if (requireMultipleWords)</span>
<a href="#l8.43"></a><span id="l8.43">     {</span>
<a href="#l8.44"></a><span id="l8.44">       nsCOMPtr&lt;nsILineBreaker&gt; lineBreaker = do_GetService(NS_LBRK_CONTRACTID, &amp;rv);</span>
<a href="#l8.45"></a><span id="l8.45"> </span>
<a href="#l8.46"></a><span id="l8.46">       if (NS_SUCCEEDED(rv))</span>
<a href="#l8.47"></a><span id="l8.47">       {</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-        const nsPromiseFlatString&amp; tString = PromiseFlatString(selPlain);</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-        const PRUint32 length = tString.Length();</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-        const PRUnichar* unicodeStr = tString.get();</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+        const PRUint32 length = selPlain.Length();</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+        const PRUnichar* unicodeStr = selPlain.get();</span>
<a href="#l8.53"></a><span id="l8.53">         PRInt32 endWordPos = lineBreaker-&gt;Next(unicodeStr, length, 0);</span>
<a href="#l8.54"></a><span id="l8.54">         </span>
<a href="#l8.55"></a><span id="l8.55">         // If there's not even one word, then there's not multiple words</span>
<a href="#l8.56"></a><span id="l8.56">         if (endWordPos == NS_LINEBREAKER_NEED_MORE_TEXT)</span>
<a href="#l8.57"></a><span id="l8.57">           return NS_ERROR_ABORT;</span>
<a href="#l8.58"></a><span id="l8.58"> </span>
<a href="#l8.59"></a><span id="l8.59">         // If after the first word is only space, then there's not multiple words</span>
<a href="#l8.60"></a><span id="l8.60">         const PRUnichar* end;</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineat">@@ -509,17 +508,17 @@ nsMsgComposeService::GetOrigWindowSelect</span>
<a href="#l8.62"></a><span id="l8.62">           ;</span>
<a href="#l8.63"></a><span id="l8.63">         if (!*end)</span>
<a href="#l8.64"></a><span id="l8.64">           return NS_ERROR_ABORT;</span>
<a href="#l8.65"></a><span id="l8.65">       }</span>
<a href="#l8.66"></a><span id="l8.66">     }</span>
<a href="#l8.67"></a><span id="l8.67"> </span>
<a href="#l8.68"></a><span id="l8.68">     if (!charsOnlyIf.IsEmpty())</span>
<a href="#l8.69"></a><span id="l8.69">     {</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineminus">-      if (selPlain.FindCharInSet(NS_ConvertUTF8toUTF16(charsOnlyIf)) &lt; 0)</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+      if (MsgFindCharInSet(selPlain, charsOnlyIf.get()) &lt; 0)</span>
<a href="#l8.72"></a><span id="l8.72">         return NS_ERROR_ABORT;</span>
<a href="#l8.73"></a><span id="l8.73">     }</span>
<a href="#l8.74"></a><span id="l8.74">   }</span>
<a href="#l8.75"></a><span id="l8.75"> </span>
<a href="#l8.76"></a><span id="l8.76">   nsCOMPtr&lt;nsIContentViewer&gt; contentViewer;</span>
<a href="#l8.77"></a><span id="l8.77">   rv = docShell-&gt;GetContentViewer(getter_AddRefs(contentViewer));</span>
<a href="#l8.78"></a><span id="l8.78">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.79"></a><span id="l8.79"> </span>
<a href="#l8.80"></a><span id="l8.80" class="difflineat">@@ -556,17 +555,17 @@ nsMsgComposeService::OpenComposeWindow(c</span>
<a href="#l8.81"></a><span id="l8.81"> </span>
<a href="#l8.82"></a><span id="l8.82">   /* Actually, the only way to implement forward inline is to simulate a template message.</span>
<a href="#l8.83"></a><span id="l8.83">      Maybe one day when we will have more time we can change that</span>
<a href="#l8.84"></a><span id="l8.84">   */</span>
<a href="#l8.85"></a><span id="l8.85">   if (type == nsIMsgCompType::ForwardInline || type == nsIMsgCompType::Draft || type == nsIMsgCompType::Template</span>
<a href="#l8.86"></a><span id="l8.86">     || type == nsIMsgCompType::ReplyWithTemplate || type == nsIMsgCompType::Redirect)</span>
<a href="#l8.87"></a><span id="l8.87">   {</span>
<a href="#l8.88"></a><span id="l8.88">     nsCAutoString uriToOpen(originalMsgURI);</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineminus">-    uriToOpen += (uriToOpen.FindChar('?') == kNotFound) ? &quot;?&quot; : &quot;&amp;&quot;;</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+    uriToOpen += (uriToOpen.FindChar('?') == kNotFound) ? '?' : '&amp;';</span>
<a href="#l8.91"></a><span id="l8.91">     uriToOpen.Append(&quot;fetchCompleteMessage=true&quot;);</span>
<a href="#l8.92"></a><span id="l8.92">     if (type == nsIMsgCompType::Redirect)</span>
<a href="#l8.93"></a><span id="l8.93">       uriToOpen.Append(&quot;&amp;redirect=true&quot;);</span>
<a href="#l8.94"></a><span id="l8.94"> </span>
<a href="#l8.95"></a><span id="l8.95">     aMsgWindow-&gt;SetCharsetOverride(true);</span>
<a href="#l8.96"></a><span id="l8.96">     return LoadDraftOrTemplate(uriToOpen, type == nsIMsgCompType::ForwardInline || type == nsIMsgCompType::Draft ?</span>
<a href="#l8.97"></a><span id="l8.97">                                nsMimeOutput::nsMimeMessageDraftOrTemplate : nsMimeOutput::nsMimeMessageEditorTemplate,</span>
<a href="#l8.98"></a><span id="l8.98">                                identity, originalMsgURI, origMsgHdr, type == nsIMsgCompType::ForwardInline,</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineat">@@ -603,26 +602,27 @@ nsMsgComposeService::OpenComposeWindow(c</span>
<a href="#l8.100"></a><span id="l8.100">           nsCAutoString newsURI(originalMsgURI);</span>
<a href="#l8.101"></a><span id="l8.101">           nsCAutoString group;</span>
<a href="#l8.102"></a><span id="l8.102">           nsCAutoString host;</span>
<a href="#l8.103"></a><span id="l8.103"> </span>
<a href="#l8.104"></a><span id="l8.104">           PRInt32 slashpos = newsURI.RFindChar('/');</span>
<a href="#l8.105"></a><span id="l8.105">           if (slashpos &gt; 0 )</span>
<a href="#l8.106"></a><span id="l8.106">           {</span>
<a href="#l8.107"></a><span id="l8.107">             // uri is &quot;[s]news://host[:port]/group&quot;</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineminus">-            newsURI.Left(host, slashpos);</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineminus">-            newsURI.Right(group, newsURI.Length() - slashpos - 1);</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+            host = StringHead(newsURI, slashpos);</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+            group = Substring(newsURI, slashpos + 1);</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineplus">+</span>
<a href="#l8.113"></a><span id="l8.113">           }</span>
<a href="#l8.114"></a><span id="l8.114">           else</span>
<a href="#l8.115"></a><span id="l8.115">             group = originalMsgURI;</span>
<a href="#l8.116"></a><span id="l8.116"> </span>
<a href="#l8.117"></a><span id="l8.117">           nsCAutoString unescapedName;</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineminus">-          NS_UnescapeURL(group,</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineminus">-                         esc_FileBaseName|esc_Forced|esc_AlwaysCopy,</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineminus">-                         unescapedName);</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+          MsgUnescapeString(group,</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+                            nsINetUtil::ESCAPE_URL_FILE_BASENAME | nsINetUtil::ESCAPE_URL_FORCED,</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+                            unescapedName);</span>
<a href="#l8.124"></a><span id="l8.124">           pMsgCompFields-&gt;SetNewsgroups(NS_ConvertUTF8toUTF16(unescapedName));</span>
<a href="#l8.125"></a><span id="l8.125">           pMsgCompFields-&gt;SetNewshost(host.get());</span>
<a href="#l8.126"></a><span id="l8.126">         }</span>
<a href="#l8.127"></a><span id="l8.127">         else</span>
<a href="#l8.128"></a><span id="l8.128">         {</span>
<a href="#l8.129"></a><span id="l8.129">           pMsgComposeParams-&gt;SetOriginalMsgURI(originalMsgURI);</span>
<a href="#l8.130"></a><span id="l8.130">           pMsgComposeParams-&gt;SetOrigMsgHdr(origMsgHdr);</span>
<a href="#l8.131"></a><span id="l8.131">         }</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineat">@@ -685,17 +685,17 @@ NS_IMETHODIMP nsMsgComposeService::GetPa</span>
<a href="#l8.133"></a><span id="l8.133">       if (HTMLBodyPart.IsEmpty())</span>
<a href="#l8.134"></a><span id="l8.134">       {</span>
<a href="#l8.135"></a><span id="l8.135">         if (composeHTMLFormat)</span>
<a href="#l8.136"></a><span id="l8.136">         {</span>
<a href="#l8.137"></a><span id="l8.137">           char *escaped = MsgEscapeHTML(bodyPart.get());</span>
<a href="#l8.138"></a><span id="l8.138">           if (!escaped)</span>
<a href="#l8.139"></a><span id="l8.139">             return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l8.140"></a><span id="l8.140"> </span>
<a href="#l8.141"></a><span id="l8.141" class="difflineminus">-          CopyUTF8toUTF16(escaped, sanitizedBody);</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineplus">+          CopyUTF8toUTF16(nsDependentCString(escaped), sanitizedBody);</span>
<a href="#l8.143"></a><span id="l8.143">           nsMemory::Free(escaped);</span>
<a href="#l8.144"></a><span id="l8.144">         }</span>
<a href="#l8.145"></a><span id="l8.145">         else</span>
<a href="#l8.146"></a><span id="l8.146">           CopyUTF8toUTF16(bodyPart, rawBody);</span>
<a href="#l8.147"></a><span id="l8.147">       }</span>
<a href="#l8.148"></a><span id="l8.148">       else</span>
<a href="#l8.149"></a><span id="l8.149">         CopyUTF8toUTF16(HTMLBodyPart, rawBody);</span>
<a href="#l8.150"></a><span id="l8.150"> </span>
<a href="#l8.151"></a><span id="l8.151" class="difflineat">@@ -1187,17 +1187,17 @@ NS_IMETHODIMP nsMsgComposeService::Reply</span>
<a href="#l8.152"></a><span id="l8.152">     // ### probably want to return a specific error and</span>
<a href="#l8.153"></a><span id="l8.153">     // have the calling code disable the filter.</span>
<a href="#l8.154"></a><span id="l8.154">     NS_ASSERTION(PR_FALSE, &quot;failed to get msg hdr&quot;);</span>
<a href="#l8.155"></a><span id="l8.155">     return NS_ERROR_FAILURE;</span>
<a href="#l8.156"></a><span id="l8.156">   }</span>
<a href="#l8.157"></a><span id="l8.157">   // we need to convert the template uri, which is of the form</span>
<a href="#l8.158"></a><span id="l8.158">   // &lt;folder uri&gt;?messageId=&lt;messageId&gt;&amp;subject=&lt;subject&gt;</span>
<a href="#l8.159"></a><span id="l8.159">   nsCOMPtr &lt;nsIMsgMessageService&gt; msgService;</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineminus">-  rv = GetMessageServiceFromURI(nsDependentCString(templateMsgHdrUri), getter_AddRefs(msgService));</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineplus">+  rv = GetMessageServiceFromURI(templateMsgHdrUri, getter_AddRefs(msgService));</span>
<a href="#l8.162"></a><span id="l8.162">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.163"></a><span id="l8.163"> </span>
<a href="#l8.164"></a><span id="l8.164">   nsCOMPtr&lt;nsISupports&gt; listenerSupports;</span>
<a href="#l8.165"></a><span id="l8.165">   helper-&gt;QueryInterface(NS_GET_IID(nsISupports), getter_AddRefs(listenerSupports));</span>
<a href="#l8.166"></a><span id="l8.166"> </span>
<a href="#l8.167"></a><span id="l8.167">   rv = msgService-&gt;StreamMessage(templateMsgHdrUri.get(), listenerSupports,</span>
<a href="#l8.168"></a><span id="l8.168">                                  aMsgWindow, helper,</span>
<a href="#l8.169"></a><span id="l8.169">                                  PR_FALSE, // convert data</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineat">@@ -1597,17 +1597,17 @@ nsMsgComposeService::RunMessageThroughMi</span>
<a href="#l8.171"></a><span id="l8.171">   }</span>
<a href="#l8.172"></a><span id="l8.172">   mimeConverter-&gt;SetOverrideComposeFormat(aOverrideComposeFormat);</span>
<a href="#l8.173"></a><span id="l8.173">   mimeConverter-&gt;SetIdentity(aIdentity);</span>
<a href="#l8.174"></a><span id="l8.174">   mimeConverter-&gt;SetOriginalMsgURI(aOriginalMsgURI);</span>
<a href="#l8.175"></a><span id="l8.175">   mimeConverter-&gt;SetOrigMsgHdr(aOrigMsgHdr);</span>
<a href="#l8.176"></a><span id="l8.176"> </span>
<a href="#l8.177"></a><span id="l8.177">   nsCOMPtr&lt;nsIURI&gt; url;</span>
<a href="#l8.178"></a><span id="l8.178">   PRBool fileUrl = StringBeginsWith(aMsgURI, NS_LITERAL_CSTRING(&quot;file:&quot;));</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineminus">-  if (fileUrl || nsDependentCString(aMsgURI).Find(&quot;&amp;type=application/x-message-display&quot;) &gt;= 0)</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineplus">+  if (fileUrl || PromiseFlatCString(aMsgURI).Find(&quot;&amp;type=application/x-message-display&quot;) &gt;= 0)</span>
<a href="#l8.181"></a><span id="l8.181">     rv = NS_NewURI(getter_AddRefs(url), aMsgURI);</span>
<a href="#l8.182"></a><span id="l8.182">   else</span>
<a href="#l8.183"></a><span id="l8.183">     rv = messageService-&gt;GetUrlForUri(PromiseFlatCString(aMsgURI).get(), getter_AddRefs(url), aMsgWindow);</span>
<a href="#l8.184"></a><span id="l8.184">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.185"></a><span id="l8.185"> </span>
<a href="#l8.186"></a><span id="l8.186">   // ignore errors here - it's not fatal, and in the case of mailbox messages,</span>
<a href="#l8.187"></a><span id="l8.187">   // we're always passing in an invalid spec...</span>
<a href="#l8.188"></a><span id="l8.188">   (void )url-&gt;SetSpec(aMsgURI);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCopy.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCopy.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -56,16 +56,17 @@</span>
<a href="#l9.4"></a><span id="l9.4"> #include &quot;nsIMsgImapMailFolder.h&quot;</span>
<a href="#l9.5"></a><span id="l9.5"> #include &quot;nsThreadUtils.h&quot;</span>
<a href="#l9.6"></a><span id="l9.6"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l9.7"></a><span id="l9.7"> #include &quot;nsIMsgProgress.h&quot;</span>
<a href="#l9.8"></a><span id="l9.8"> #include &quot;nsComposeStrings.h&quot;</span>
<a href="#l9.9"></a><span id="l9.9"> #include &quot;prmem.h&quot;</span>
<a href="#l9.10"></a><span id="l9.10"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l9.11"></a><span id="l9.11"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+#include &quot;nsMsgUtils.h&quot;</span>
<a href="#l9.13"></a><span id="l9.13"> </span>
<a href="#l9.14"></a><span id="l9.14"> static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l9.15"></a><span id="l9.15"> </span>
<a href="#l9.16"></a><span id="l9.16"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.17"></a><span id="l9.17"> // This is the listener class for the copy operation. We have to create this class</span>
<a href="#l9.18"></a><span id="l9.18"> // to listen for message copy completion and eventually notify the caller</span>
<a href="#l9.19"></a><span id="l9.19"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.20"></a><span id="l9.20"> NS_IMPL_THREADSAFE_ADDREF(CopyListener)</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineat">@@ -297,17 +298,17 @@ nsMsgCopy::DoCopy(nsIFile *aDiskFile, ns</span>
<a href="#l9.22"></a><span id="l9.22">         PRBool shutdownInProgress = PR_FALSE;</span>
<a href="#l9.23"></a><span id="l9.23">         rv = accountManager-&gt;GetShutdownInProgress(&amp;shutdownInProgress);</span>
<a href="#l9.24"></a><span id="l9.24"> </span>
<a href="#l9.25"></a><span id="l9.25">         if (NS_SUCCEEDED(rv) &amp;&amp; shutdownInProgress &amp;&amp; imapFolder)</span>
<a href="#l9.26"></a><span id="l9.26">         {</span>
<a href="#l9.27"></a><span id="l9.27">           // set the following only when we were in the middle of shutdown</span>
<a href="#l9.28"></a><span id="l9.28">           // process</span>
<a href="#l9.29"></a><span id="l9.29">             copyListener-&gt;mCopyInProgress = PR_TRUE;</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-            NS_GetCurrentThread(getter_AddRefs(thread));</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+            thread = do_GetCurrentThread();</span>
<a href="#l9.32"></a><span id="l9.32">         }</span>
<a href="#l9.33"></a><span id="l9.33">     }</span>
<a href="#l9.34"></a><span id="l9.34">     nsCOMPtr&lt;nsIMsgCopyService&gt; copyService = do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l9.35"></a><span id="l9.35">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.36"></a><span id="l9.36"> </span>
<a href="#l9.37"></a><span id="l9.37">     rv = copyService-&gt;CopyFileMessage(aDiskFile, dstFolder, aMsgToReplace,</span>
<a href="#l9.38"></a><span id="l9.38">                                       aIsDraft, nsMsgMessageFlags::Read, EmptyCString(),</span>
<a href="#l9.39"></a><span id="l9.39">                                       copyListener, msgWindow);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgPrompts.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgPrompts.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -37,16 +37,18 @@</span>
<a href="#l10.4"></a><span id="l10.4"> #include &quot;nsMsgPrompts.h&quot;</span>
<a href="#l10.5"></a><span id="l10.5"> </span>
<a href="#l10.6"></a><span id="l10.6"> #include &quot;nsMsgCopy.h&quot;</span>
<a href="#l10.7"></a><span id="l10.7"> #include &quot;nsIPrompt.h&quot;</span>
<a href="#l10.8"></a><span id="l10.8"> #include &quot;nsIWindowWatcher.h&quot;</span>
<a href="#l10.9"></a><span id="l10.9"> #include &quot;nsMsgCompCID.h&quot;</span>
<a href="#l10.10"></a><span id="l10.10"> #include &quot;nsComposeStrings.h&quot;</span>
<a href="#l10.11"></a><span id="l10.11"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+#include &quot;nsMsgUtils.h&quot;</span>
<a href="#l10.14"></a><span id="l10.14"> </span>
<a href="#l10.15"></a><span id="l10.15"> nsresult</span>
<a href="#l10.16"></a><span id="l10.16"> nsMsgGetMessageByID(PRInt32 aMsgID, nsString&amp; aResult)</span>
<a href="#l10.17"></a><span id="l10.17"> {</span>
<a href="#l10.18"></a><span id="l10.18">   nsresult rv;</span>
<a href="#l10.19"></a><span id="l10.19">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService(do_GetService(&quot;@mozilla.org/intl/stringbundle;1&quot;, &amp;rv));</span>
<a href="#l10.20"></a><span id="l10.20">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.21"></a><span id="l10.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -43,32 +43,30 @@</span>
<a href="#l11.4"></a><span id="l11.4"> #include &quot;nsMsgSendPart.h&quot;</span>
<a href="#l11.5"></a><span id="l11.5"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l11.6"></a><span id="l11.6"> #include &quot;nsMsgNewsCID.h&quot;</span>
<a href="#l11.7"></a><span id="l11.7"> #include &quot;nsIMsgHeaderParser.h&quot;</span>
<a href="#l11.8"></a><span id="l11.8"> #include &quot;nsISmtpService.h&quot;  // for actually sending the message...</span>
<a href="#l11.9"></a><span id="l11.9"> #include &quot;nsINntpService.h&quot;  // for actually posting the message...</span>
<a href="#l11.10"></a><span id="l11.10"> #include &quot;nsIMsgMailSession.h&quot;</span>
<a href="#l11.11"></a><span id="l11.11"> #include &quot;nsIMsgIdentity.h&quot;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-#include &quot;nsEscape.h&quot;</span>
<a href="#l11.13"></a><span id="l11.13"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l11.14"></a><span id="l11.14"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l11.15"></a><span id="l11.15"> #include &quot;nsIMsgMailNewsUrl.h&quot;</span>
<a href="#l11.16"></a><span id="l11.16"> #include &quot;nsMsgEncoders.h&quot;</span>
<a href="#l11.17"></a><span id="l11.17"> #include &quot;nsMsgCompUtils.h&quot;</span>
<a href="#l11.18"></a><span id="l11.18"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l11.19"></a><span id="l11.19"> #include &quot;nsICharsetConverterManager.h&quot;</span>
<a href="#l11.20"></a><span id="l11.20"> #include &quot;nsIMsgSendListener.h&quot;</span>
<a href="#l11.21"></a><span id="l11.21"> #include &quot;nsIMsgCopyServiceListener.h&quot;</span>
<a href="#l11.22"></a><span id="l11.22"> #include &quot;nsIFile.h&quot;</span>
<a href="#l11.23"></a><span id="l11.23"> #include &quot;nsIURL.h&quot;</span>
<a href="#l11.24"></a><span id="l11.24"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l11.25"></a><span id="l11.25"> #include &quot;nsIFileURL.h&quot;</span>
<a href="#l11.26"></a><span id="l11.26"> #include &quot;nsMsgCopy.h&quot;</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-#include &quot;nsReadableUtils.h&quot;</span>
<a href="#l11.28"></a><span id="l11.28"> #include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l11.29"></a><span id="l11.29"> #include &quot;nsMsgPrompts.h&quot;</span>
<a href="#l11.30"></a><span id="l11.30"> #include &quot;nsIDOMHTMLBodyElement.h&quot;</span>
<a href="#l11.31"></a><span id="l11.31"> #include &quot;nsIDOMHTMLImageElement.h&quot;</span>
<a href="#l11.32"></a><span id="l11.32"> #include &quot;nsIDOMHTMLLinkElement.h&quot;</span>
<a href="#l11.33"></a><span id="l11.33"> #include &quot;nsIDOMHTMLAnchorElement.h&quot;</span>
<a href="#l11.34"></a><span id="l11.34"> #include &quot;nsCExternalHandlerService.h&quot;</span>
<a href="#l11.35"></a><span id="l11.35"> #include &quot;nsIMIMEService.h&quot;</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineat">@@ -103,17 +101,18 @@</span>
<a href="#l11.37"></a><span id="l11.37"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l11.38"></a><span id="l11.38"> #include &quot;nsNativeCharsetUtils.h&quot;</span>
<a href="#l11.39"></a><span id="l11.39"> #include &quot;nsIAbCard.h&quot;</span>
<a href="#l11.40"></a><span id="l11.40"> #include &quot;nsIMsgProgress.h&quot;</span>
<a href="#l11.41"></a><span id="l11.41"> #include &quot;nsIMsgMessageService.h&quot;</span>
<a href="#l11.42"></a><span id="l11.42"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l11.43"></a><span id="l11.43"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l11.44"></a><span id="l11.44"> #include &quot;nsComposeStrings.h&quot;</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+#include &quot;nsStringGlue.h&quot;</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+#include &quot;nsMsgUtils.h&quot;</span>
<a href="#l11.48"></a><span id="l11.48"> </span>
<a href="#l11.49"></a><span id="l11.49"> static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l11.50"></a><span id="l11.50"> </span>
<a href="#l11.51"></a><span id="l11.51"> #define PREF_MAIL_SEND_STRUCT &quot;mail.send_struct&quot;</span>
<a href="#l11.52"></a><span id="l11.52"> #define PREF_MAIL_STRICTLY_MIME &quot;mail.strictly_mime&quot;</span>
<a href="#l11.53"></a><span id="l11.53"> #define PREF_MAIL_MESSAGE_WARNING_SIZE &quot;mailnews.message_warning_size&quot;</span>
<a href="#l11.54"></a><span id="l11.54"> #define PREF_MAIL_COLLECT_EMAIL_ADDRESS_OUTGOING &quot;mail.collect_email_address_outgoing&quot;</span>
<a href="#l11.55"></a><span id="l11.55"> #define PREF_MAIL_DONT_ATTACH_SOURCE &quot;mail.compose.dont_attach_source_of_local_network_links&quot;</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineat">@@ -406,17 +405,17 @@ nsresult nsMsgComposeAndSend::GetNotific</span>
<a href="#l11.57"></a><span id="l11.57">   if (msgWindow) {</span>
<a href="#l11.58"></a><span id="l11.58">     nsCOMPtr&lt;nsIDocShell&gt; docShell;</span>
<a href="#l11.59"></a><span id="l11.59">     msgWindow-&gt;GetRootDocShell(getter_AddRefs(docShell));</span>
<a href="#l11.60"></a><span id="l11.60">     nsCOMPtr&lt;nsIInterfaceRequestor&gt; ir(do_QueryInterface(docShell));</span>
<a href="#l11.61"></a><span id="l11.61">     nsCOMPtr&lt;nsIInterfaceRequestor&gt; notificationCallbacks;</span>
<a href="#l11.62"></a><span id="l11.62">     msgWindow-&gt;GetNotificationCallbacks(getter_AddRefs(notificationCallbacks));</span>
<a href="#l11.63"></a><span id="l11.63">     if (notificationCallbacks) {</span>
<a href="#l11.64"></a><span id="l11.64">       nsCOMPtr&lt;nsIInterfaceRequestor&gt; aggregrateIR;</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineminus">-      NS_NewInterfaceRequestorAggregation(notificationCallbacks, ir, getter_AddRefs(aggregrateIR));</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+      MsgNewInterfaceRequestorAggregation(notificationCallbacks, ir, getter_AddRefs(aggregrateIR));</span>
<a href="#l11.67"></a><span id="l11.67">       ir = aggregrateIR;</span>
<a href="#l11.68"></a><span id="l11.68">     }</span>
<a href="#l11.69"></a><span id="l11.69">     if (ir) {</span>
<a href="#l11.70"></a><span id="l11.70">       NS_ADDREF(*aCallbacks = ir);</span>
<a href="#l11.71"></a><span id="l11.71">       return NS_OK;</span>
<a href="#l11.72"></a><span id="l11.72">     }</span>
<a href="#l11.73"></a><span id="l11.73">   }</span>
<a href="#l11.74"></a><span id="l11.74">   return NS_ERROR_FAILURE;</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineat">@@ -1423,38 +1422,38 @@ nsMsgComposeAndSend::GetEmbeddedObjectIn</span>
<a href="#l11.76"></a><span id="l11.76">           return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l11.77"></a><span id="l11.77"> </span>
<a href="#l11.78"></a><span id="l11.78">         uri-&gt;GetSpec(spec);</span>
<a href="#l11.79"></a><span id="l11.79"> </span>
<a href="#l11.80"></a><span id="l11.80">         // Ok, now get the path to the root doc and tack on the name we</span>
<a href="#l11.81"></a><span id="l11.81">         // got from the GetSrc() call....</span>
<a href="#l11.82"></a><span id="l11.82">         NS_ConvertUTF8toUTF16 workURL(spec);</span>
<a href="#l11.83"></a><span id="l11.83"> </span>
<a href="#l11.84"></a><span id="l11.84" class="difflineminus">-        PRInt32 loc = workURL.RFind(&quot;/&quot;);</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineplus">+        PRInt32 loc = workURL.RFindChar('/');</span>
<a href="#l11.86"></a><span id="l11.86">         if (loc &gt;= 0)</span>
<a href="#l11.87"></a><span id="l11.87">           workURL.SetLength(loc+1);</span>
<a href="#l11.88"></a><span id="l11.88">         workURL.Append(tUrl);</span>
<a href="#l11.89"></a><span id="l11.89">         NS_ConvertUTF16toUTF8 workurlC(workURL);</span>
<a href="#l11.90"></a><span id="l11.90">         if (NS_FAILED(nsMsgNewURL(&amp;attachment-&gt;url, workurlC.get())))</span>
<a href="#l11.91"></a><span id="l11.91">         {</span>
<a href="#l11.92"></a><span id="l11.92">           // rhp - just try to continue and send it without this image.</span>
<a href="#l11.93"></a><span id="l11.93">           return NS_OK;</span>
<a href="#l11.94"></a><span id="l11.94">         }</span>
<a href="#l11.95"></a><span id="l11.95">       }</span>
<a href="#l11.96"></a><span id="l11.96">     }</span>
<a href="#l11.97"></a><span id="l11.97"> </span>
<a href="#l11.98"></a><span id="l11.98">     NS_IF_ADDREF(attachment-&gt;url);</span>
<a href="#l11.99"></a><span id="l11.99"> </span>
<a href="#l11.100"></a><span id="l11.100">     rv = image-&gt;GetName(tName);</span>
<a href="#l11.101"></a><span id="l11.101">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineminus">-    attachment-&gt;real_name = ToNewCString(tName); // XXX i18n</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineminus">-</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineminus">-    image-&gt;GetLongDesc(tDesc);</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineplus">+</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineplus">+    attachment-&gt;real_name = ToNewCString(NS_LossyConvertUTF16toASCII(tName)); // XXX i18n</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineplus">+    rv = image-&gt;GetLongDesc(tDesc);</span>
<a href="#l11.108"></a><span id="l11.108">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineminus">-    attachment-&gt;description = ToNewCString(tDesc); // XXX i18n</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineplus">+    attachment-&gt;description = ToNewCString(NS_LossyConvertUTF16toASCII(tDesc)); // XXX i18n</span>
<a href="#l11.111"></a><span id="l11.111"> </span>
<a href="#l11.112"></a><span id="l11.112">   }</span>
<a href="#l11.113"></a><span id="l11.113">   else if (link)        // Is this a link?</span>
<a href="#l11.114"></a><span id="l11.114">   {</span>
<a href="#l11.115"></a><span id="l11.115">     nsString    tUrl;</span>
<a href="#l11.116"></a><span id="l11.116"> </span>
<a href="#l11.117"></a><span id="l11.117">     // Create the URI</span>
<a href="#l11.118"></a><span id="l11.118">     rv = link-&gt;GetHref(tUrl);</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineat">@@ -1478,17 +1477,17 @@ nsMsgComposeAndSend::GetEmbeddedObjectIn</span>
<a href="#l11.120"></a><span id="l11.120">     CopyUTF16toUTF8(tUrl, turlC);</span>
<a href="#l11.121"></a><span id="l11.121">     rv = nsMsgNewURL(&amp;attachment-&gt;url, turlC.get());</span>
<a href="#l11.122"></a><span id="l11.122">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.123"></a><span id="l11.123"> </span>
<a href="#l11.124"></a><span id="l11.124">     NS_IF_ADDREF(attachment-&gt;url);</span>
<a href="#l11.125"></a><span id="l11.125"> </span>
<a href="#l11.126"></a><span id="l11.126">     rv = anchor-&gt;GetName(tName);</span>
<a href="#l11.127"></a><span id="l11.127">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineminus">-    attachment-&gt;real_name = ToNewCString(tName);</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineplus">+    attachment-&gt;real_name = ToNewCString(NS_LossyConvertUTF16toASCII(tName));</span>
<a href="#l11.130"></a><span id="l11.130">   }</span>
<a href="#l11.131"></a><span id="l11.131">   else</span>
<a href="#l11.132"></a><span id="l11.132">   {</span>
<a href="#l11.133"></a><span id="l11.133">     // If we get here, we got something we didn't expect!</span>
<a href="#l11.134"></a><span id="l11.134">     // Just try to continue and send it without this thing.</span>
<a href="#l11.135"></a><span id="l11.135">     return NS_OK;</span>
<a href="#l11.136"></a><span id="l11.136">   }</span>
<a href="#l11.137"></a><span id="l11.137"> </span>
<a href="#l11.138"></a><span id="l11.138" class="difflineat">@@ -1729,17 +1728,17 @@ nsMsgComposeAndSend::GetBodyFromEditor()</span>
<a href="#l11.139"></a><span id="l11.139">           if (prefBranch)</span>
<a href="#l11.140"></a><span id="l11.140">           {</span>
<a href="#l11.141"></a><span id="l11.141">             nsCString prefName(&quot;mailnews.disable_fallback_to_utf8.&quot;);</span>
<a href="#l11.142"></a><span id="l11.142">             prefName.Append(aCharset);</span>
<a href="#l11.143"></a><span id="l11.143">             prefBranch-&gt;GetBoolPref(prefName.get(), &amp;disableFallback);</span>
<a href="#l11.144"></a><span id="l11.144">           }</span>
<a href="#l11.145"></a><span id="l11.145">           if (!disableFallback)</span>
<a href="#l11.146"></a><span id="l11.146">           {</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineminus">-            CopyUTF16toUTF8(bodyText, outCString);</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineplus">+            CopyUTF16toUTF8(nsDependentString(bodyText), outCString);</span>
<a href="#l11.149"></a><span id="l11.149">             mCompFields-&gt;SetCharacterSet(&quot;UTF-8&quot;);</span>
<a href="#l11.150"></a><span id="l11.150">           }</span>
<a href="#l11.151"></a><span id="l11.151">         }</span>
<a href="#l11.152"></a><span id="l11.152">       }</span>
<a href="#l11.153"></a><span id="l11.153">       else if (!fallbackCharset.IsEmpty())</span>
<a href="#l11.154"></a><span id="l11.154">       {</span>
<a href="#l11.155"></a><span id="l11.155">         // re-label to the fallback charset</span>
<a href="#l11.156"></a><span id="l11.156">         mCompFields-&gt;SetCharacterSet(fallbackCharset.get());</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineat">@@ -1759,17 +1758,17 @@ nsMsgComposeAndSend::GetBodyFromEditor()</span>
<a href="#l11.158"></a><span id="l11.158">                                   aCharset, origHTMLBody, &amp;newBody);</span>
<a href="#l11.159"></a><span id="l11.159">       if (NS_SUCCEEDED(rv))</span>
<a href="#l11.160"></a><span id="l11.160">       {</span>
<a href="#l11.161"></a><span id="l11.161">         PR_FREEIF(origHTMLBody);</span>
<a href="#l11.162"></a><span id="l11.162">         origHTMLBody = (PRUnichar *)newBody;</span>
<a href="#l11.163"></a><span id="l11.163">       }</span>
<a href="#l11.164"></a><span id="l11.164">     }</span>
<a href="#l11.165"></a><span id="l11.165"> </span>
<a href="#l11.166"></a><span id="l11.166" class="difflineminus">-    Recycle(bodyText);    //Don't need it anymore</span>
<a href="#l11.167"></a><span id="l11.167" class="difflineplus">+    NS_Free(bodyText);    //Don't need it anymore</span>
<a href="#l11.168"></a><span id="l11.168">   }</span>
<a href="#l11.169"></a><span id="l11.169">   else</span>
<a href="#l11.170"></a><span id="l11.170">     return NS_ERROR_FAILURE;</span>
<a href="#l11.171"></a><span id="l11.171"> </span>
<a href="#l11.172"></a><span id="l11.172">   // If our holder for the original body text is STILL null, then just</span>
<a href="#l11.173"></a><span id="l11.173">   // just copy what we have as the original body text.</span>
<a href="#l11.174"></a><span id="l11.174">   //</span>
<a href="#l11.175"></a><span id="l11.175">   if (!origHTMLBody)</span>
<a href="#l11.176"></a><span id="l11.176" class="difflineat">@@ -2048,17 +2047,17 @@ nsMsgComposeAndSend::ProcessMultipartRel</span>
<a href="#l11.177"></a><span id="l11.177">       }</span>
<a href="#l11.178"></a><span id="l11.178">       else if (body)</span>
<a href="#l11.179"></a><span id="l11.179">       {</span>
<a href="#l11.180"></a><span id="l11.180">         body-&gt;GetBackground(domURL);</span>
<a href="#l11.181"></a><span id="l11.181">         body-&gt;SetBackground(newSpec);</span>
<a href="#l11.182"></a><span id="l11.182">       }</span>
<a href="#l11.183"></a><span id="l11.183"> </span>
<a href="#l11.184"></a><span id="l11.184">       if (!domURL.IsEmpty())</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineminus">-        domSaveArray[j].url = ToNewCString(domURL);</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineplus">+        domSaveArray[j].url = ToNewCString(NS_LossyConvertUTF16toASCII(domURL));</span>
<a href="#l11.187"></a><span id="l11.187">     }</span>
<a href="#l11.188"></a><span id="l11.188">   }</span>
<a href="#l11.189"></a><span id="l11.189"> </span>
<a href="#l11.190"></a><span id="l11.190">   rv = GetBodyFromEditor();</span>
<a href="#l11.191"></a><span id="l11.191"> </span>
<a href="#l11.192"></a><span id="l11.192">   //</span>
<a href="#l11.193"></a><span id="l11.193">   // Ok, now we need to un-whack the DOM or we have a screwed up document on</span>
<a href="#l11.194"></a><span id="l11.194">   // Send failure.</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineat">@@ -2295,17 +2294,18 @@ nsMsgComposeAndSend::AddCompFieldLocalAt</span>
<a href="#l11.196"></a><span id="l11.196">                       mimeFinder-&gt;GetTypeFromExtension(fileExt, type);</span>
<a href="#l11.197"></a><span id="l11.197">   #ifndef XP_MACOSX</span>
<a href="#l11.198"></a><span id="l11.198">                     if (!type.Equals(&quot;multipart/appledouble&quot;))  // can't do apple double on non-macs</span>
<a href="#l11.199"></a><span id="l11.199">   #endif</span>
<a href="#l11.200"></a><span id="l11.200">                       m_attachments[newLoc].m_type = ToNewCString(type);</span>
<a href="#l11.201"></a><span id="l11.201">                     // rtf and vcs files may look like text to sniffers,</span>
<a href="#l11.202"></a><span id="l11.202">                     // but they're not human readable.</span>
<a href="#l11.203"></a><span id="l11.203">                     if (type.IsEmpty() &amp;&amp; !fileExt.IsEmpty() &amp;&amp;</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineminus">-                         (fileExt.LowerCaseEqualsLiteral(&quot;rtf&quot;) || fileExt.LowerCaseEqualsLiteral(&quot;vcs&quot;)))</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineplus">+                         (MsgLowerCaseEqualsLiteral(fileExt, &quot;rtf&quot;) ||</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineplus">+                          MsgLowerCaseEqualsLiteral(fileExt, &quot;vcs&quot;)))</span>
<a href="#l11.207"></a><span id="l11.207">                       m_attachments[newLoc].m_type = PL_strdup(APPLICATION_OCTET_STREAM);</span>
<a href="#l11.208"></a><span id="l11.208">                     }</span>
<a href="#l11.209"></a><span id="l11.209">                   }</span>
<a href="#l11.210"></a><span id="l11.210">                 }</span>
<a href="#l11.211"></a><span id="l11.211">               }</span>
<a href="#l11.212"></a><span id="l11.212">             }</span>
<a href="#l11.213"></a><span id="l11.213">           }</span>
<a href="#l11.214"></a><span id="l11.214">           else</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineat">@@ -2934,17 +2934,17 @@ nsMsgComposeAndSend::InitCompositionFiel</span>
<a href="#l11.216"></a><span id="l11.216">           }</span>
<a href="#l11.217"></a><span id="l11.217">         }</span>
<a href="#l11.218"></a><span id="l11.218">       }</span>
<a href="#l11.219"></a><span id="l11.219"> </span>
<a href="#l11.220"></a><span id="l11.220">       if (useDefaultFCC)</span>
<a href="#l11.221"></a><span id="l11.221">       {</span>
<a href="#l11.222"></a><span id="l11.222">         nsCString uri;</span>
<a href="#l11.223"></a><span id="l11.223">         GetFolderURIFromUserPrefs(nsMsgDeliverNow, mUserIdentity, uri);</span>
<a href="#l11.224"></a><span id="l11.224" class="difflineminus">-        mCompFields-&gt;SetFcc(uri.LowerCaseEqualsLiteral(&quot;nocopy://&quot;) ? &quot;&quot; : uri.get());</span>
<a href="#l11.225"></a><span id="l11.225" class="difflineplus">+        mCompFields-&gt;SetFcc(MsgLowerCaseEqualsLiteral(uri, &quot;nocopy://&quot;) ? &quot;&quot; : uri.get());</span>
<a href="#l11.226"></a><span id="l11.226">       }</span>
<a href="#l11.227"></a><span id="l11.227">     }</span>
<a href="#l11.228"></a><span id="l11.228">   }</span>
<a href="#l11.229"></a><span id="l11.229"> </span>
<a href="#l11.230"></a><span id="l11.230">   //</span>
<a href="#l11.231"></a><span id="l11.231">   // Deal with an additional FCC operation for this email.</span>
<a href="#l11.232"></a><span id="l11.232">   //</span>
<a href="#l11.233"></a><span id="l11.233">   const char *fieldsFCC2 = fields-&gt;GetFcc2();</span>
<a href="#l11.234"></a><span id="l11.234" class="difflineat">@@ -3065,18 +3065,18 @@ nsMsgComposeAndSend::AddDefaultCustomHea</span>
<a href="#l11.235"></a><span id="l11.235">     while (end != -1) {</span>
<a href="#l11.236"></a><span id="l11.236">       end = headersList.FindChar(',', start);</span>
<a href="#l11.237"></a><span id="l11.237">       if (end == -1) {</span>
<a href="#l11.238"></a><span id="l11.238">         len = headersList.Length() - start;</span>
<a href="#l11.239"></a><span id="l11.239">       } else {</span>
<a href="#l11.240"></a><span id="l11.240">         len = end - start;</span>
<a href="#l11.241"></a><span id="l11.241">       }</span>
<a href="#l11.242"></a><span id="l11.242">       // grab the name of the current header pref</span>
<a href="#l11.243"></a><span id="l11.243" class="difflineminus">-      nsCAutoString headerName(NS_LITERAL_CSTRING(&quot;header.&quot;) +</span>
<a href="#l11.244"></a><span id="l11.244" class="difflineminus">-                               Substring(headersList, start, len));</span>
<a href="#l11.245"></a><span id="l11.245" class="difflineplus">+      nsCAutoString headerName(&quot;header.&quot;);</span>
<a href="#l11.246"></a><span id="l11.246" class="difflineplus">+      headerName.Append(Substring(headersList, start, len));</span>
<a href="#l11.247"></a><span id="l11.247">       start = end + 1;</span>
<a href="#l11.248"></a><span id="l11.248"> </span>
<a href="#l11.249"></a><span id="l11.249">       nsCString headerVal;</span>
<a href="#l11.250"></a><span id="l11.250">       rv = mUserIdentity-&gt;GetCharAttribute(headerName.get(), headerVal);</span>
<a href="#l11.251"></a><span id="l11.251">       if (NS_SUCCEEDED(rv)) {</span>
<a href="#l11.252"></a><span id="l11.252">         PRInt32 colonIdx = headerVal.FindChar(':') + 1;</span>
<a href="#l11.253"></a><span id="l11.253">         if (colonIdx != 0) { // check that the header is *most likely* valid.</span>
<a href="#l11.254"></a><span id="l11.254">           char * convHeader =</span>
<a href="#l11.255"></a><span id="l11.255" class="difflineat">@@ -3106,18 +3106,18 @@ nsMsgComposeAndSend::AddDefaultCustomHea</span>
<a href="#l11.256"></a><span id="l11.256"> nsresult</span>
<a href="#l11.257"></a><span id="l11.257"> nsMsgComposeAndSend::AddMailFollowupToHeader() {</span>
<a href="#l11.258"></a><span id="l11.258">   nsresult rv;</span>
<a href="#l11.259"></a><span id="l11.259"> </span>
<a href="#l11.260"></a><span id="l11.260">   // Get OtherRandomHeaders...</span>
<a href="#l11.261"></a><span id="l11.261">   nsDependentCString customHeaders(mCompFields-&gt;GetOtherRandomHeaders());</span>
<a href="#l11.262"></a><span id="l11.262">   // ...and look for MFT-Header.  Stop here if MFT is already set.</span>
<a href="#l11.263"></a><span id="l11.263">   NS_NAMED_LITERAL_CSTRING(mftHeaderLabel, &quot;Mail-Followup-To: &quot;);</span>
<a href="#l11.264"></a><span id="l11.264" class="difflineminus">-  if ((StringHead(customHeaders, mftHeaderLabel.Length()) == mftHeaderLabel) ||</span>
<a href="#l11.265"></a><span id="l11.265" class="difflineminus">-      (customHeaders.Find(NS_LITERAL_CSTRING(&quot;\r\n&quot;) + mftHeaderLabel) != -1))</span>
<a href="#l11.266"></a><span id="l11.266" class="difflineplus">+  if (StringBeginsWith(customHeaders, mftHeaderLabel) ||</span>
<a href="#l11.267"></a><span id="l11.267" class="difflineplus">+      customHeaders.Find(&quot;\r\nMail-Followup-To: &quot;) != -1)</span>
<a href="#l11.268"></a><span id="l11.268">     return NS_OK;</span>
<a href="#l11.269"></a><span id="l11.269"> </span>
<a href="#l11.270"></a><span id="l11.270">   // Get list of subscribed mailing lists</span>
<a href="#l11.271"></a><span id="l11.271">   nsCAutoString mailing_lists;</span>
<a href="#l11.272"></a><span id="l11.272">   rv = mUserIdentity-&gt;GetCharAttribute(&quot;subscribed_mailing_lists&quot;, mailing_lists);</span>
<a href="#l11.273"></a><span id="l11.273">   // Stop here if this list is missing or empty</span>
<a href="#l11.274"></a><span id="l11.274">   if (NS_FAILED(rv) || mailing_lists.IsEmpty())</span>
<a href="#l11.275"></a><span id="l11.275">     return NS_OK;</span>
<a href="#l11.276"></a><span id="l11.276" class="difflineat">@@ -3183,18 +3183,20 @@ nsMsgComposeAndSend::AddMailFollowupToHe</span>
<a href="#l11.277"></a><span id="l11.277"> nsresult</span>
<a href="#l11.278"></a><span id="l11.278"> nsMsgComposeAndSend::AddMailReplyToHeader() {</span>
<a href="#l11.279"></a><span id="l11.279">   nsresult rv;</span>
<a href="#l11.280"></a><span id="l11.280"> </span>
<a href="#l11.281"></a><span id="l11.281">   // Get OtherRandomHeaders...</span>
<a href="#l11.282"></a><span id="l11.282">   nsDependentCString customHeaders(mCompFields-&gt;GetOtherRandomHeaders());</span>
<a href="#l11.283"></a><span id="l11.283">   // ...and look for MRT-Header.  Stop here if MRT is already set.</span>
<a href="#l11.284"></a><span id="l11.284">   NS_NAMED_LITERAL_CSTRING(mrtHeaderLabel, &quot;Mail-Reply-To: &quot;);</span>
<a href="#l11.285"></a><span id="l11.285" class="difflineplus">+  nsCAutoString headers_match = nsCAutoString(&quot;\r\n&quot;);</span>
<a href="#l11.286"></a><span id="l11.286" class="difflineplus">+  headers_match.Append(mrtHeaderLabel);</span>
<a href="#l11.287"></a><span id="l11.287">   if ((StringHead(customHeaders, mrtHeaderLabel.Length()) == mrtHeaderLabel) ||</span>
<a href="#l11.288"></a><span id="l11.288" class="difflineminus">-      (customHeaders.Find(NS_LITERAL_CSTRING(&quot;\r\n&quot;) + mrtHeaderLabel) != -1))</span>
<a href="#l11.289"></a><span id="l11.289" class="difflineplus">+      (customHeaders.Find(headers_match) != -1))</span>
<a href="#l11.290"></a><span id="l11.290">     return NS_OK;</span>
<a href="#l11.291"></a><span id="l11.291"> </span>
<a href="#l11.292"></a><span id="l11.292">   // Get list of reply-to mangling mailing lists</span>
<a href="#l11.293"></a><span id="l11.293">   nsCAutoString mailing_lists;</span>
<a href="#l11.294"></a><span id="l11.294">   rv = mUserIdentity-&gt;GetCharAttribute(&quot;replyto_mangling_mailing_lists&quot;, mailing_lists);</span>
<a href="#l11.295"></a><span id="l11.295">   // Stop here if this list is missing or empty</span>
<a href="#l11.296"></a><span id="l11.296">   if (NS_FAILED(rv) || mailing_lists.IsEmpty())</span>
<a href="#l11.297"></a><span id="l11.297">     return NS_OK;</span>
<a href="#l11.298"></a><span id="l11.298" class="difflineat">@@ -3692,21 +3694,23 @@ nsMsgComposeAndSend::DeliverFileAsMail()</span>
<a href="#l11.299"></a><span id="l11.299">   {</span>
<a href="#l11.300"></a><span id="l11.300">     // MIME-PartII conversion</span>
<a href="#l11.301"></a><span id="l11.301">     PR_FREEIF(buf);</span>
<a href="#l11.302"></a><span id="l11.302">     buf = convbuf;</span>
<a href="#l11.303"></a><span id="l11.303">   }</span>
<a href="#l11.304"></a><span id="l11.304"> </span>
<a href="#l11.305"></a><span id="l11.305">   strip_nonprintable(buf);</span>
<a href="#l11.306"></a><span id="l11.306"> </span>
<a href="#l11.307"></a><span id="l11.307" class="difflineminus">-  convbuf = nsEscape(buf, url_Path);</span>
<a href="#l11.308"></a><span id="l11.308" class="difflineminus">-  if (convbuf)</span>
<a href="#l11.309"></a><span id="l11.309" class="difflineplus">+  nsCString escaped_buf;</span>
<a href="#l11.310"></a><span id="l11.310" class="difflineplus">+  MsgEscapeString(nsDependentCString(buf), nsINetUtil::ESCAPE_URL_PATH, escaped_buf);</span>
<a href="#l11.311"></a><span id="l11.311" class="difflineplus">+</span>
<a href="#l11.312"></a><span id="l11.312" class="difflineplus">+  if (!escaped_buf.IsEmpty())</span>
<a href="#l11.313"></a><span id="l11.313">   {</span>
<a href="#l11.314"></a><span id="l11.314">     NS_Free(buf);</span>
<a href="#l11.315"></a><span id="l11.315" class="difflineminus">-    buf = convbuf;</span>
<a href="#l11.316"></a><span id="l11.316" class="difflineplus">+    buf = ToNewCString(escaped_buf);</span>
<a href="#l11.317"></a><span id="l11.317">   }</span>
<a href="#l11.318"></a><span id="l11.318"> </span>
<a href="#l11.319"></a><span id="l11.319">   nsCOMPtr&lt;nsISmtpService&gt; smtpService(do_GetService(NS_SMTPSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l11.320"></a><span id="l11.320">   if (NS_SUCCEEDED(rv) &amp;&amp; smtpService)</span>
<a href="#l11.321"></a><span id="l11.321">   {</span>
<a href="#l11.322"></a><span id="l11.322">     MsgDeliveryListener *deliveryListener = new MsgDeliveryListener(this, PR_FALSE);</span>
<a href="#l11.323"></a><span id="l11.323">     if (!deliveryListener)</span>
<a href="#l11.324"></a><span id="l11.324">       return NS_ERROR_OUT_OF_MEMORY;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSend.h</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSend.h</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -133,16 +133,17 @@</span>
<a href="#l12.4"></a><span id="l12.4">    defined, which added a BASE tag to the bodies.  We stopped doing this in</span>
<a href="#l12.5"></a><span id="l12.5">    4.0.  */</span>
<a href="#l12.6"></a><span id="l12.6"> #define GENERATE_CONTENT_BASE</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8"> </span>
<a href="#l12.9"></a><span id="l12.9"> //</span>
<a href="#l12.10"></a><span id="l12.10"> // Necessary includes</span>
<a href="#l12.11"></a><span id="l12.11"> //</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l12.13"></a><span id="l12.13"> #include &quot;nsIMsgSend.h&quot;</span>
<a href="#l12.14"></a><span id="l12.14"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l12.15"></a><span id="l12.15"> #include &quot;msgCore.h&quot;</span>
<a href="#l12.16"></a><span id="l12.16"> #include &quot;prprf.h&quot;</span>
<a href="#l12.17"></a><span id="l12.17"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l12.18"></a><span id="l12.18"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l12.19"></a><span id="l12.19"> #include &quot;nsIURL.h&quot;</span>
<a href="#l12.20"></a><span id="l12.20"> #include &quot;nsMsgAttachmentHandler.h&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpProtocol.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpProtocol.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -52,29 +52,28 @@</span>
<a href="#l13.4"></a><span id="l13.4"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l13.5"></a><span id="l13.5"> #include &quot;nsISocketTransport.h&quot;</span>
<a href="#l13.6"></a><span id="l13.6"> #include &quot;nsIMsgHeaderParser.h&quot;</span>
<a href="#l13.7"></a><span id="l13.7"> #include &quot;nsIMsgMailNewsUrl.h&quot;</span>
<a href="#l13.8"></a><span id="l13.8"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l13.9"></a><span id="l13.9"> #include &quot;nsMsgCompCID.h&quot;</span>
<a href="#l13.10"></a><span id="l13.10"> #include &quot;nsIPrompt.h&quot;</span>
<a href="#l13.11"></a><span id="l13.11"> #include &quot;nsIAuthPrompt.h&quot;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+#include &quot;nsStringGlue.h&quot;</span>
<a href="#l13.14"></a><span id="l13.14"> #include &quot;nsTextFormatter.h&quot;</span>
<a href="#l13.15"></a><span id="l13.15"> #include &quot;nsIMsgIdentity.h&quot;</span>
<a href="#l13.16"></a><span id="l13.16"> #include &quot;nsISmtpServer.h&quot;</span>
<a href="#l13.17"></a><span id="l13.17"> #include &quot;prtime.h&quot;</span>
<a href="#l13.18"></a><span id="l13.18"> #include &quot;prlog.h&quot;</span>
<a href="#l13.19"></a><span id="l13.19"> #include &quot;prerror.h&quot;</span>
<a href="#l13.20"></a><span id="l13.20"> #include &quot;prprf.h&quot;</span>
<a href="#l13.21"></a><span id="l13.21"> #include &quot;prmem.h&quot;</span>
<a href="#l13.22"></a><span id="l13.22"> #include &quot;plbase64.h&quot;</span>
<a href="#l13.23"></a><span id="l13.23"> #include &quot;prnetdb.h&quot;</span>
<a href="#l13.24"></a><span id="l13.24"> #include &quot;prsystem.h&quot;</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineminus">-#include &quot;nsEscape.h&quot;</span>
<a href="#l13.26"></a><span id="l13.26"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l13.27"></a><span id="l13.27"> #include &quot;nsIPipe.h&quot;</span>
<a href="#l13.28"></a><span id="l13.28"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l13.29"></a><span id="l13.29"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l13.30"></a><span id="l13.30"> #include &quot;nsISignatureVerifier.h&quot;</span>
<a href="#l13.31"></a><span id="l13.31"> #include &quot;nsISSLSocketControl.h&quot;</span>
<a href="#l13.32"></a><span id="l13.32"> #include &quot;nsComposeStrings.h&quot;</span>
<a href="#l13.33"></a><span id="l13.33"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineat">@@ -388,17 +387,18 @@ void nsSmtpProtocol::AppendHelloArgument</span>
<a href="#l13.35"></a><span id="l13.35">                   NS_ASSERTION(!PR_IsNetAddrType(&amp;iaddr, PR_IpAddrV4Mapped),</span>
<a href="#l13.36"></a><span id="l13.36">                                &quot;unexpected IPv4-mapped IPv6 address&quot;);</span>
<a href="#l13.37"></a><span id="l13.37"> </span>
<a href="#l13.38"></a><span id="l13.38">                   if (iaddr.raw.family == PR_AF_INET6)   // IPv6 style address?</span>
<a href="#l13.39"></a><span id="l13.39">                       aResult.AppendLiteral(&quot;[IPv6:&quot;);</span>
<a href="#l13.40"></a><span id="l13.40">                   else</span>
<a href="#l13.41"></a><span id="l13.41">                       aResult.AppendLiteral(&quot;[&quot;);</span>
<a href="#l13.42"></a><span id="l13.42"> </span>
<a href="#l13.43"></a><span id="l13.43" class="difflineminus">-                  aResult.Append(nsDependentCString(ipAddressString) + NS_LITERAL_CSTRING(&quot;]&quot;));</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+                  aResult.Append(ipAddressString);</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+                  aResult.Append(']');</span>
<a href="#l13.46"></a><span id="l13.46">               }</span>
<a href="#l13.47"></a><span id="l13.47">           }</span>
<a href="#l13.48"></a><span id="l13.48">       }</span>
<a href="#l13.49"></a><span id="l13.49">   }</span>
<a href="#l13.50"></a><span id="l13.50"> }</span>
<a href="#l13.51"></a><span id="l13.51"> </span>
<a href="#l13.52"></a><span id="l13.52"> /////////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l13.53"></a><span id="l13.53"> // we suppport the nsIStreamListener interface</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineat">@@ -741,58 +741,58 @@ PRInt32 nsSmtpProtocol::SendEhloResponse</span>
<a href="#l13.55"></a><span id="l13.55">     PRInt32 startPos = 0;</span>
<a href="#l13.56"></a><span id="l13.56">     PRInt32 endPos;</span>
<a href="#l13.57"></a><span id="l13.57">     do</span>
<a href="#l13.58"></a><span id="l13.58">     {</span>
<a href="#l13.59"></a><span id="l13.59">         endPos = m_responseText.FindChar('\n', startPos + 1);</span>
<a href="#l13.60"></a><span id="l13.60">         nsCAutoString responseLine;</span>
<a href="#l13.61"></a><span id="l13.61">         responseLine.Assign(Substring(m_responseText, startPos,</span>
<a href="#l13.62"></a><span id="l13.62">             (endPos &gt;= 0 ? endPos : responseLength) - startPos));</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineminus">-        responseLine.CompressWhitespace();</span>
<a href="#l13.64"></a><span id="l13.64"> </span>
<a href="#l13.65"></a><span id="l13.65" class="difflineminus">-        if (responseLine.Compare(&quot;STARTTLS&quot;, PR_TRUE) == 0)</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineplus">+        MsgCompressWhitespace(responseLine);</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineplus">+        if (responseLine.Equals(NS_LITERAL_CSTRING(&quot;STARTTLS&quot;), nsCaseInsensitiveCStringComparator()))</span>
<a href="#l13.68"></a><span id="l13.68">         {</span>
<a href="#l13.69"></a><span id="l13.69">             SetFlag(SMTP_EHLO_STARTTLS_ENABLED);</span>
<a href="#l13.70"></a><span id="l13.70">         }</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineminus">-        else if (responseLine.Compare(&quot;DSN&quot;, PR_TRUE) == 0)</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineplus">+        else if (responseLine.Equals(NS_LITERAL_CSTRING(&quot;DSN&quot;), nsCaseInsensitiveCStringComparator()))</span>
<a href="#l13.73"></a><span id="l13.73">         {</span>
<a href="#l13.74"></a><span id="l13.74">             SetFlag(SMTP_EHLO_DSN_ENABLED);</span>
<a href="#l13.75"></a><span id="l13.75">         }</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineminus">-        else if (responseLine.Compare(&quot;AUTH&quot;, PR_TRUE, 4) == 0)</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineplus">+        else if (StringBeginsWith(responseLine, NS_LITERAL_CSTRING(&quot;AUTH&quot;), nsCaseInsensitiveCStringComparator()))</span>
<a href="#l13.78"></a><span id="l13.78">         {</span>
<a href="#l13.79"></a><span id="l13.79">             SetFlag(SMTP_AUTH);</span>
<a href="#l13.80"></a><span id="l13.80"> </span>
<a href="#l13.81"></a><span id="l13.81" class="difflineminus">-            if (responseLine.Find(&quot;GSSAPI&quot;, PR_TRUE, 5) &gt;= 0)</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineplus">+            if (responseLine.Find(NS_LITERAL_CSTRING(&quot;GSSAPI&quot;), CaseInsensitiveCompare) &gt;= 0)</span>
<a href="#l13.83"></a><span id="l13.83">                 SetFlag(SMTP_AUTH_GSSAPI_ENABLED);</span>
<a href="#l13.84"></a><span id="l13.84"> </span>
<a href="#l13.85"></a><span id="l13.85">             nsresult rv;</span>
<a href="#l13.86"></a><span id="l13.86">             nsCOMPtr&lt;nsISignatureVerifier&gt; verifier = do_GetService(SIGNATURE_VERIFIER_CONTRACTID, &amp;rv);</span>
<a href="#l13.87"></a><span id="l13.87">             // this checks if psm is installed...</span>
<a href="#l13.88"></a><span id="l13.88">             if (NS_SUCCEEDED(rv))</span>
<a href="#l13.89"></a><span id="l13.89">             {</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineminus">-                if (responseLine.Find(&quot;CRAM-MD5&quot;, PR_TRUE, 5) &gt;= 0)</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineplus">+                if (responseLine.Find(NS_LITERAL_CSTRING(&quot;CRAM-MD5&quot;), CaseInsensitiveCompare) &gt;= 0)</span>
<a href="#l13.92"></a><span id="l13.92">                     SetFlag(SMTP_AUTH_CRAM_MD5_ENABLED);</span>
<a href="#l13.93"></a><span id="l13.93"> </span>
<a href="#l13.94"></a><span id="l13.94" class="difflineminus">-                if (responseLine.Find(&quot;NTLM&quot;, PR_TRUE, 5) &gt;= 0)</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineplus">+                if (responseLine.Find(NS_LITERAL_CSTRING(&quot;NTLM&quot;), CaseInsensitiveCompare) &gt;= 0)</span>
<a href="#l13.96"></a><span id="l13.96">                     SetFlag(SMTP_AUTH_NTLM_ENABLED);</span>
<a href="#l13.97"></a><span id="l13.97"> </span>
<a href="#l13.98"></a><span id="l13.98" class="difflineminus">-                if (responseLine.Find(&quot;MSN&quot;, PR_TRUE, 5) &gt;= 0)</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineplus">+                if (responseLine.Find(NS_LITERAL_CSTRING(&quot;MSN&quot;), CaseInsensitiveCompare) &gt;= 0)</span>
<a href="#l13.100"></a><span id="l13.100">                     SetFlag(SMTP_AUTH_MSN_ENABLED);</span>
<a href="#l13.101"></a><span id="l13.101">             }</span>
<a href="#l13.102"></a><span id="l13.102"> </span>
<a href="#l13.103"></a><span id="l13.103" class="difflineminus">-            if (responseLine.Find(&quot;PLAIN&quot;, PR_TRUE, 5) &gt;= 0)</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineplus">+            if (responseLine.Find(NS_LITERAL_CSTRING(&quot;PLAIN&quot;), CaseInsensitiveCompare) &gt;= 0)</span>
<a href="#l13.105"></a><span id="l13.105">                 SetFlag(SMTP_AUTH_PLAIN_ENABLED);</span>
<a href="#l13.106"></a><span id="l13.106"> </span>
<a href="#l13.107"></a><span id="l13.107" class="difflineminus">-            if (responseLine.Find(&quot;LOGIN&quot;, PR_TRUE, 5) &gt;= 0)</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineplus">+            if (responseLine.Find(NS_LITERAL_CSTRING(&quot;LOGIN&quot;), CaseInsensitiveCompare) &gt;= 0)</span>
<a href="#l13.109"></a><span id="l13.109">                 SetFlag(SMTP_AUTH_LOGIN_ENABLED);</span>
<a href="#l13.110"></a><span id="l13.110"> </span>
<a href="#l13.111"></a><span id="l13.111" class="difflineminus">-            if (responseLine.Find(&quot;EXTERNAL&quot;, PR_TRUE, 5) &gt;= 0)</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineplus">+            if (responseLine.Find(NS_LITERAL_CSTRING(&quot;EXTERNAL&quot;), CaseInsensitiveCompare) &gt;= 0)</span>
<a href="#l13.113"></a><span id="l13.113">                 SetFlag(SMTP_AUTH_EXTERNAL_ENABLED);</span>
<a href="#l13.114"></a><span id="l13.114">         }</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineminus">-        else if (responseLine.Compare(&quot;SIZE&quot;, PR_TRUE, 4) == 0)</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineplus">+        else if (StringBeginsWith(responseLine, NS_LITERAL_CSTRING(&quot;SIZE&quot;), nsCaseInsensitiveCStringComparator()))</span>
<a href="#l13.117"></a><span id="l13.117">         {</span>
<a href="#l13.118"></a><span id="l13.118">             SetFlag(SMTP_EHLO_SIZE_ENABLED);</span>
<a href="#l13.119"></a><span id="l13.119"> </span>
<a href="#l13.120"></a><span id="l13.120">             m_sizelimit = atol((responseLine.get()) + 4);</span>
<a href="#l13.121"></a><span id="l13.121">         }</span>
<a href="#l13.122"></a><span id="l13.122"> </span>
<a href="#l13.123"></a><span id="l13.123">         startPos = endPos + 1;</span>
<a href="#l13.124"></a><span id="l13.124">     } while (endPos &gt;= 0);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpServer.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpServer.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -33,17 +33,16 @@</span>
<a href="#l14.4"></a><span id="l14.4">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l14.5"></a><span id="l14.5">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l14.6"></a><span id="l14.6">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l14.7"></a><span id="l14.7">  *</span>
<a href="#l14.8"></a><span id="l14.8">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l14.11"></a><span id="l14.11"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-#include &quot;nsEscape.h&quot;</span>
<a href="#l14.13"></a><span id="l14.13"> #include &quot;nsSmtpServer.h&quot;</span>
<a href="#l14.14"></a><span id="l14.14"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l14.15"></a><span id="l14.15"> #include &quot;nsIAuthPrompt.h&quot;</span>
<a href="#l14.16"></a><span id="l14.16"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l14.17"></a><span id="l14.17"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l14.18"></a><span id="l14.18"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l14.19"></a><span id="l14.19"> #include &quot;nsISmtpService.h&quot;</span>
<a href="#l14.20"></a><span id="l14.20"> #include &quot;nsMsgCompCID.h&quot;</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineat">@@ -507,18 +506,17 @@ nsSmtpServer::ForgetPassword()</span>
<a href="#l14.22"></a><span id="l14.22">   // Get the current server URI without the username</span>
<a href="#l14.23"></a><span id="l14.23">   nsCAutoString serverUri(NS_LITERAL_CSTRING(&quot;smtp://&quot;));</span>
<a href="#l14.24"></a><span id="l14.24"> </span>
<a href="#l14.25"></a><span id="l14.25">   nsCString hostname;</span>
<a href="#l14.26"></a><span id="l14.26">   rv = GetHostname(hostname);</span>
<a href="#l14.27"></a><span id="l14.27"> </span>
<a href="#l14.28"></a><span id="l14.28">   if (NS_SUCCEEDED(rv) &amp;&amp; !hostname.IsEmpty()) {</span>
<a href="#l14.29"></a><span id="l14.29">     nsCString escapedHostname;</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-    *((char **)getter_Copies(escapedHostname)) =</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-      nsEscape(hostname.get(), url_Path);</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+    MsgEscapeString(hostname, nsINetUtil::ESCAPE_URL_PATH, escapedHostname);</span>
<a href="#l14.33"></a><span id="l14.33">     // not all servers have a hostname</span>
<a href="#l14.34"></a><span id="l14.34">     serverUri.Append(escapedHostname);</span>
<a href="#l14.35"></a><span id="l14.35">   }</span>
<a href="#l14.36"></a><span id="l14.36"> </span>
<a href="#l14.37"></a><span id="l14.37">   PRUint32 count;</span>
<a href="#l14.38"></a><span id="l14.38">   nsILoginInfo** logins;</span>
<a href="#l14.39"></a><span id="l14.39"> </span>
<a href="#l14.40"></a><span id="l14.40">   NS_ConvertUTF8toUTF16 currServer(serverUri);</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineat">@@ -569,18 +567,17 @@ nsSmtpServer::GetServerURI(nsACString &amp;a</span>
<a href="#l14.42"></a><span id="l14.42">         uri.AppendLiteral(&quot;@&quot;);</span>
<a href="#l14.43"></a><span id="l14.43">     }</span>
<a href="#l14.44"></a><span id="l14.44"> </span>
<a href="#l14.45"></a><span id="l14.45">     nsCString hostname;</span>
<a href="#l14.46"></a><span id="l14.46">     rv = GetHostname(hostname);</span>
<a href="#l14.47"></a><span id="l14.47"> </span>
<a href="#l14.48"></a><span id="l14.48">     if (NS_SUCCEEDED(rv) &amp;&amp; !hostname.IsEmpty()) {</span>
<a href="#l14.49"></a><span id="l14.49">         nsCString escapedHostname;</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineminus">-        *((char **)getter_Copies(escapedHostname)) =</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineminus">-            nsEscape(hostname.get(), url_Path);</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+        MsgEscapeString(hostname, nsINetUtil::ESCAPE_URL_PATH, escapedHostname);</span>
<a href="#l14.53"></a><span id="l14.53">         // not all servers have a hostname</span>
<a href="#l14.54"></a><span id="l14.54">         uri.Append(escapedHostname);</span>
<a href="#l14.55"></a><span id="l14.55">     }</span>
<a href="#l14.56"></a><span id="l14.56"> </span>
<a href="#l14.57"></a><span id="l14.57">     aResult = uri;</span>
<a href="#l14.58"></a><span id="l14.58">     return NS_OK;</span>
<a href="#l14.59"></a><span id="l14.59"> }</span>
<a href="#l14.60"></a><span id="l14.60"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpService.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpService.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -33,17 +33,16 @@</span>
<a href="#l15.4"></a><span id="l15.4">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l15.5"></a><span id="l15.5">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l15.6"></a><span id="l15.6">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l15.7"></a><span id="l15.7">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l15.8"></a><span id="l15.8">  *</span>
<a href="#l15.9"></a><span id="l15.9">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l15.10"></a><span id="l15.10"> </span>
<a href="#l15.11"></a><span id="l15.11"> #include &quot;msgCore.h&quot;    // precompiled header...</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-#include &quot;nsReadableUtils.h&quot;</span>
<a href="#l15.13"></a><span id="l15.13"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l15.14"></a><span id="l15.14"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l15.15"></a><span id="l15.15"> #include &quot;nsIIOService.h&quot;</span>
<a href="#l15.16"></a><span id="l15.16"> #include &quot;nsIPipe.h&quot;</span>
<a href="#l15.17"></a><span id="l15.17"> #include &quot;nsNetCID.h&quot;</span>
<a href="#l15.18"></a><span id="l15.18"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l15.19"></a><span id="l15.19"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l15.20"></a><span id="l15.20"> #include &quot;nsSmtpService.h&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpUrl.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpUrl.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -36,23 +36,24 @@</span>
<a href="#l16.4"></a><span id="l16.4">  *</span>
<a href="#l16.5"></a><span id="l16.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l16.6"></a><span id="l16.6"> </span>
<a href="#l16.7"></a><span id="l16.7"> #include &quot;msgCore.h&quot;</span>
<a href="#l16.8"></a><span id="l16.8"> </span>
<a href="#l16.9"></a><span id="l16.9"> #include &quot;nsIURI.h&quot;</span>
<a href="#l16.10"></a><span id="l16.10"> #include &quot;nsNetCID.h&quot;</span>
<a href="#l16.11"></a><span id="l16.11"> #include &quot;nsSmtpUrl.h&quot;</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-#include &quot;nsReadableUtils.h&quot;</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-#include &quot;nsEscape.h&quot;</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+#include &quot;nsStringGlue.h&quot;</span>
<a href="#l16.16"></a><span id="l16.16"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l16.17"></a><span id="l16.17"> #include &quot;nsIMimeConverter.h&quot;</span>
<a href="#l16.18"></a><span id="l16.18"> #include &quot;nsMsgMimeCID.h&quot;</span>
<a href="#l16.19"></a><span id="l16.19"> #include &quot;nsISupportsObsolete.h&quot;</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineplus">+#include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineplus">+#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineplus">+#include &quot;nsCRT.h&quot;</span>
<a href="#l16.23"></a><span id="l16.23"> </span>
<a href="#l16.24"></a><span id="l16.24"> /////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l16.25"></a><span id="l16.25"> // mailto url definition</span>
<a href="#l16.26"></a><span id="l16.26"> /////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l16.27"></a><span id="l16.27"> nsMailtoUrl::nsMailtoUrl()</span>
<a href="#l16.28"></a><span id="l16.28"> {</span>
<a href="#l16.29"></a><span id="l16.29">   mFormat = nsIMsgCompFormat::Default;</span>
<a href="#l16.30"></a><span id="l16.30">   m_baseURL = do_CreateInstance(NS_SIMPLEURI_CONTRACTID);</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineat">@@ -103,17 +104,17 @@ nsresult nsMailtoUrl::ParseMailtoUrl(cha</span>
<a href="#l16.32"></a><span id="l16.32">       char *value = 0;</span>
<a href="#l16.33"></a><span id="l16.33">       char *eq = PL_strchr(token, '=');</span>
<a href="#l16.34"></a><span id="l16.34">       if (eq)</span>
<a href="#l16.35"></a><span id="l16.35">       {</span>
<a href="#l16.36"></a><span id="l16.36">         value = eq+1;</span>
<a href="#l16.37"></a><span id="l16.37">         *eq = 0;</span>
<a href="#l16.38"></a><span id="l16.38">       }</span>
<a href="#l16.39"></a><span id="l16.39"> </span>
<a href="#l16.40"></a><span id="l16.40" class="difflineminus">-      switch (toupper(*token))</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+      switch (NS_ToUpper(*token))</span>
<a href="#l16.42"></a><span id="l16.42">       {</span>
<a href="#l16.43"></a><span id="l16.43">         /* DO NOT support attachment= in mailto urls. This poses a security fire hole!!! </span>
<a href="#l16.44"></a><span id="l16.44">                           case 'A':</span>
<a href="#l16.45"></a><span id="l16.45">                           if (!PL_strcasecmp (token, &quot;attachment&quot;))</span>
<a href="#l16.46"></a><span id="l16.46">                           m_attachmentPart = value;</span>
<a href="#l16.47"></a><span id="l16.47">                           break;</span>
<a href="#l16.48"></a><span id="l16.48">                      */</span>
<a href="#l16.49"></a><span id="l16.49">       case 'B':</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineat">@@ -433,25 +434,23 @@ nsresult nsMailtoUrl::ParseUrl()</span>
<a href="#l16.51"></a><span id="l16.51">   // we can get the path from the simple url.....</span>
<a href="#l16.52"></a><span id="l16.52">   nsCString escapedPath;</span>
<a href="#l16.53"></a><span id="l16.53">   m_baseURL-&gt;GetPath(escapedPath);</span>
<a href="#l16.54"></a><span id="l16.54"> </span>
<a href="#l16.55"></a><span id="l16.55">   PRInt32 startOfSearchPart = escapedPath.FindChar('?');</span>
<a href="#l16.56"></a><span id="l16.56">   if (startOfSearchPart &gt;= 0)</span>
<a href="#l16.57"></a><span id="l16.57">   {</span>
<a href="#l16.58"></a><span id="l16.58">     // now parse out the search field...</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineminus">-    nsCString searchPart;</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineminus">-    PRUint32 numExtraChars = escapedPath.Right(searchPart,</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineminus">-                                               escapedPath.Length() -</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineminus">-                                               startOfSearchPart);</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineplus">+    nsCAutoString searchPart(Substring(escapedPath, startOfSearchPart));</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineplus">+</span>
<a href="#l16.65"></a><span id="l16.65">     if (!searchPart.IsEmpty())</span>
<a href="#l16.66"></a><span id="l16.66">     {</span>
<a href="#l16.67"></a><span id="l16.67">       // now we need to strip off the search part from the</span>
<a href="#l16.68"></a><span id="l16.68">       // to part....</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineminus">-      escapedPath.Cut(startOfSearchPart, numExtraChars);</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineplus">+      escapedPath.SetLength(startOfSearchPart);</span>
<a href="#l16.71"></a><span id="l16.71">       MsgUnescapeString(escapedPath, 0, m_toPart);</span>
<a href="#l16.72"></a><span id="l16.72">       ParseMailtoUrl(searchPart.BeginWriting());</span>
<a href="#l16.73"></a><span id="l16.73">     }</span>
<a href="#l16.74"></a><span id="l16.74">   }</span>
<a href="#l16.75"></a><span id="l16.75">   else if (!escapedPath.IsEmpty())</span>
<a href="#l16.76"></a><span id="l16.76">   {</span>
<a href="#l16.77"></a><span id="l16.77">     MsgUnescapeString(escapedPath, 0, m_toPart);</span>
<a href="#l16.78"></a><span id="l16.78">   }</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineat">@@ -692,19 +691,17 @@ NS_IMPL_ISUPPORTS_INHERITED1(nsSmtpUrl, </span>
<a href="#l16.80"></a><span id="l16.80"> // Begin nsISmtpUrl specific support</span>
<a href="#l16.81"></a><span id="l16.81"> </span>
<a href="#l16.82"></a><span id="l16.82"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l16.83"></a><span id="l16.83"> </span>
<a href="#l16.84"></a><span id="l16.84"> NS_IMETHODIMP</span>
<a href="#l16.85"></a><span id="l16.85"> nsSmtpUrl::SetRecipients(const char * aRecipientsList)</span>
<a href="#l16.86"></a><span id="l16.86"> {</span>
<a href="#l16.87"></a><span id="l16.87">   NS_ENSURE_ARG(aRecipientsList);</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineminus">-  m_toPart = aRecipientsList;</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineminus">-  if (!m_toPart.IsEmpty())</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineminus">-    nsUnescape(m_toPart.BeginWriting());</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineplus">+  MsgUnescapeString(nsDependentCString(aRecipientsList), 0, m_toPart);</span>
<a href="#l16.92"></a><span id="l16.92">   return NS_OK;</span>
<a href="#l16.93"></a><span id="l16.93"> }</span>
<a href="#l16.94"></a><span id="l16.94"> </span>
<a href="#l16.95"></a><span id="l16.95"> NS_IMETHODIMP</span>
<a href="#l16.96"></a><span id="l16.96"> nsSmtpUrl::GetRecipients(char ** aRecipientsList)</span>
<a href="#l16.97"></a><span id="l16.97"> {</span>
<a href="#l16.98"></a><span id="l16.98">   NS_ENSURE_ARG_POINTER(aRecipientsList);</span>
<a href="#l16.99"></a><span id="l16.99">   if (aRecipientsList)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/compose/src/nsURLFetcher.cpp</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/compose/src/nsURLFetcher.cpp</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -43,28 +43,29 @@</span>
<a href="#l17.4"></a><span id="l17.4"> #include &lt;stdio.h&gt;</span>
<a href="#l17.5"></a><span id="l17.5"> #include &quot;nscore.h&quot;</span>
<a href="#l17.6"></a><span id="l17.6"> #include &quot;nsIFactory.h&quot;</span>
<a href="#l17.7"></a><span id="l17.7"> #include &quot;nsISupports.h&quot;</span>
<a href="#l17.8"></a><span id="l17.8"> #include &quot;comi18n.h&quot;</span>
<a href="#l17.9"></a><span id="l17.9"> #include &quot;prmem.h&quot;</span>
<a href="#l17.10"></a><span id="l17.10"> #include &quot;plstr.h&quot;</span>
<a href="#l17.11"></a><span id="l17.11"> #include &quot;nsIComponentManager.h&quot;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+#include &quot;nsStringGlue.h&quot;</span>
<a href="#l17.14"></a><span id="l17.14"> #include &quot;nsIIOService.h&quot;</span>
<a href="#l17.15"></a><span id="l17.15"> #include &quot;nsIChannel.h&quot;</span>
<a href="#l17.16"></a><span id="l17.16"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l17.17"></a><span id="l17.17"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l17.18"></a><span id="l17.18"> #include &quot;nsIHttpChannel.h&quot;</span>
<a href="#l17.19"></a><span id="l17.19"> #include &quot;nsIWebProgress.h&quot;</span>
<a href="#l17.20"></a><span id="l17.20"> #include &quot;nsMsgAttachmentHandler.h&quot;</span>
<a href="#l17.21"></a><span id="l17.21"> #include &quot;nsMsgSend.h&quot;</span>
<a href="#l17.22"></a><span id="l17.22"> #include &quot;nsISeekableStream.h&quot;</span>
<a href="#l17.23"></a><span id="l17.23"> #include &quot;nsIStreamConverterService.h&quot;</span>
<a href="#l17.24"></a><span id="l17.24"> #include &quot;nsIMsgProgress.h&quot;</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineplus">+#include &quot;nsMsgUtils.h&quot;</span>
<a href="#l17.26"></a><span id="l17.26"> </span>
<a href="#l17.27"></a><span id="l17.27"> NS_IMPL_ISUPPORTS7(nsURLFetcher,</span>
<a href="#l17.28"></a><span id="l17.28">                    nsIURLFetcher,</span>
<a href="#l17.29"></a><span id="l17.29">                    nsIStreamListener,</span>
<a href="#l17.30"></a><span id="l17.30">                    nsIRequestObserver,</span>
<a href="#l17.31"></a><span id="l17.31">                    nsIURIContentListener,</span>
<a href="#l17.32"></a><span id="l17.32">                    nsIInterfaceRequestor,</span>
<a href="#l17.33"></a><span id="l17.33">                    nsIWebProgressListener,</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineat">@@ -309,18 +310,18 @@ nsURLFetcher::OnStopRequest(nsIRequest *</span>
<a href="#l17.35"></a><span id="l17.35"> </span>
<a href="#l17.36"></a><span id="l17.36">   // time to close the output stream...</span>
<a href="#l17.37"></a><span id="l17.37">   if (mOutStream)</span>
<a href="#l17.38"></a><span id="l17.38">   {</span>
<a href="#l17.39"></a><span id="l17.39">     mOutStream-&gt;Close();</span>
<a href="#l17.40"></a><span id="l17.40">     mOutStream = nsnull;</span>
<a href="#l17.41"></a><span id="l17.41">   </span>
<a href="#l17.42"></a><span id="l17.42">     /* In case of multipart/x-mixed-replace, we need to truncate the file to the current part size */</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineminus">-    if (mConverterContentType.LowerCaseEqualsLiteral(MULTIPART_MIXED_REPLACE))</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineminus">-  {</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineplus">+    if (MsgLowerCaseEqualsLiteral(mConverterContentType, MULTIPART_MIXED_REPLACE))</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineplus">+    {</span>
<a href="#l17.47"></a><span id="l17.47">       PRInt64 fileSize;</span>
<a href="#l17.48"></a><span id="l17.48">       LL_I2L(fileSize, mTotalWritten);</span>
<a href="#l17.49"></a><span id="l17.49">       mLocalFile-&gt;SetFileSize(fileSize);</span>
<a href="#l17.50"></a><span id="l17.50">     }</span>
<a href="#l17.51"></a><span id="l17.51">   }</span>
<a href="#l17.52"></a><span id="l17.52"> </span>
<a href="#l17.53"></a><span id="l17.53">   // Now if there is a callback, we need to call it...</span>
<a href="#l17.54"></a><span id="l17.54">   if (mCallback)</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineat">@@ -471,17 +472,17 @@ nsURLFetcherStreamConsumer::~nsURLFetche</span>
<a href="#l17.56"></a><span id="l17.56"> </span>
<a href="#l17.57"></a><span id="l17.57"> /* void onStartRequest (in nsIRequest request, in nsISupports ctxt); */</span>
<a href="#l17.58"></a><span id="l17.58"> NS_IMETHODIMP nsURLFetcherStreamConsumer::OnStartRequest(nsIRequest *aRequest, nsISupports *ctxt)</span>
<a href="#l17.59"></a><span id="l17.59"> {</span>
<a href="#l17.60"></a><span id="l17.60">   if (!mURLFetcher || !mURLFetcher-&gt;mOutStream)</span>
<a href="#l17.61"></a><span id="l17.61">     return NS_ERROR_FAILURE;</span>
<a href="#l17.62"></a><span id="l17.62"> </span>
<a href="#l17.63"></a><span id="l17.63">   /* In case of multipart/x-mixed-replace, we need to erase the output file content */</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineminus">-  if (mURLFetcher-&gt;mConverterContentType.LowerCaseEqualsLiteral(MULTIPART_MIXED_REPLACE))</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineplus">+  if (MsgLowerCaseEqualsLiteral(mURLFetcher-&gt;mConverterContentType, MULTIPART_MIXED_REPLACE))</span>
<a href="#l17.66"></a><span id="l17.66">   {</span>
<a href="#l17.67"></a><span id="l17.67">     nsCOMPtr&lt;nsISeekableStream&gt; seekStream = do_QueryInterface(mURLFetcher-&gt;mOutStream);</span>
<a href="#l17.68"></a><span id="l17.68">     if (seekStream)</span>
<a href="#l17.69"></a><span id="l17.69">       seekStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, 0);</span>
<a href="#l17.70"></a><span id="l17.70">     mURLFetcher-&gt;mTotalWritten = 0;</span>
<a href="#l17.71"></a><span id="l17.71">   }</span>
<a href="#l17.72"></a><span id="l17.72"> </span>
<a href="#l17.73"></a><span id="l17.73">   return NS_OK;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

