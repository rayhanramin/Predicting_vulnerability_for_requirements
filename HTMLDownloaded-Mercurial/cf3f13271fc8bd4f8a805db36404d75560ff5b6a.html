<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 12844:cf3f13271fc8bd4f8a805db36404d75560ff5b6a</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ cf3f13271fc8bd4f8a805db36404d75560ff5b6a" />
<meta property="og:url" content="/comm-central/rev/cf3f13271fc8bd4f8a805db36404d75560ff5b6a" />
<meta property="og:description" content="Bug 901048 - Move IMAPpump.js into a module, part 1: collect the variables. r=Standard8" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / cf3f13271fc8bd4f8a805db36404d75560ff5b6a 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/cf3f13271fc8bd4f8a805db36404d75560ff5b6a">shortlog</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/cf3f13271fc8bd4f8a805db36404d75560ff5b6a">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a">files</a> |
changeset |
<a href="/comm-central/raw-rev/cf3f13271fc8bd4f8a805db36404d75560ff5b6a">raw</a>  | <a href="/comm-central/archive/cf3f13271fc8bd4f8a805db36404d75560ff5b6a.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=901048">Bug 901048</a> - Move IMAPpump.js into a module, part 1: collect the variables. r=Standard8
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#115;&#104;&#117;&#97;&#32;&#67;&#114;&#97;&#110;&#109;&#101;&#114;&#32;&#60;&#80;&#105;&#100;&#103;&#101;&#111;&#116;&#49;&#56;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 02 Aug 2013 15:01:58 -0500</td></tr>

<tr>
 <td>changeset 12844</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/cf3f13271fc8bd4f8a805db36404d75560ff5b6a">cf3f13271fc8bd4f8a805db36404d75560ff5b6a</a></td>
</tr>



<tr>
<td>parent 12843</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/099f9cfcdec5354e78f8590c6264629e4cdd6e19">099f9cfcdec5354e78f8590c6264629e4cdd6e19</a>
</td>
</tr>

<tr>
<td>child 12845</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/7da78d07a9624a62cfdb4b21dab490139ea77162">7da78d07a9624a62cfdb4b21dab490139ea77162</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=cf3f13271fc8bd4f8a805db36404d75560ff5b6a">9383</a></td></tr>
<tr><td>push user</td><td>Pidgeot18@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 02 Aug 2013 20:03:34 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@7da78d07a962 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7da78d07a9624a62cfdb4b21dab490139ea77162">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7da78d07a9624a62cfdb4b21dab490139ea77162&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7da78d07a9624a62cfdb4b21dab490139ea77162&newProject=comm-central&newRevision=cf3f13271fc8bd4f8a805db36404d75560ff5b6a&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7da78d07a9624a62cfdb4b21dab490139ea77162&newProject=comm-central&newRevision=cf3f13271fc8bd4f8a805db36404d75560ff5b6a&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7da78d07a9624a62cfdb4b21dab490139ea77162&newProject=comm-central&newRevision=cf3f13271fc8bd4f8a805db36404d75560ff5b6a&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Standard8%29&revcount=50">Standard8</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=901048">901048</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=901048">Bug 901048</a> - Move IMAPpump.js into a module, part 1: collect the variables. r=Standard8</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/base/test/unit/test_imapPump.js">mailnews/base/test/unit/test_imapPump.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/base/test/unit/test_imapPump.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/base/test/unit/test_imapPump.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/base/test/unit/test_imapPump.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/base/test/unit/test_imapPump.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/base/test/unit/test_imapPump.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/base/test/unit/test_postPluginFilters.js">mailnews/base/test/unit/test_postPluginFilters.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/base/test/unit/test_postPluginFilters.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/base/test/unit/test_postPluginFilters.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/base/test/unit/test_postPluginFilters.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/base/test/unit/test_postPluginFilters.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/base/test/unit/test_postPluginFilters.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_gmail.js">mailnews/base/test/unit/test_testsuite_fakeserver_imapd_gmail.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_gmail.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_gmail.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_gmail.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_gmail.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_gmail.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_list-extended.js">mailnews/base/test/unit/test_testsuite_fakeserver_imapd_list-extended.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_list-extended.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_list-extended.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_list-extended.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_list-extended.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_list-extended.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_autosync_date_constraints.js">mailnews/imap/test/unit/test_autosync_date_constraints.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_autosync_date_constraints.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_autosync_date_constraints.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_autosync_date_constraints.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_autosync_date_constraints.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_autosync_date_constraints.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_bccProperty.js">mailnews/imap/test/unit/test_bccProperty.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_bccProperty.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_bccProperty.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_bccProperty.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_bccProperty.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_bccProperty.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_bug460636.js">mailnews/imap/test/unit/test_bug460636.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_bug460636.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_bug460636.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_bug460636.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_bug460636.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_bug460636.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_compactOfflineStore.js">mailnews/imap/test/unit/test_compactOfflineStore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_compactOfflineStore.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_compactOfflineStore.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_compactOfflineStore.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_compactOfflineStore.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_compactOfflineStore.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_copyThenMove.js">mailnews/imap/test/unit/test_copyThenMove.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_copyThenMove.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_copyThenMove.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_copyThenMove.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_copyThenMove.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_copyThenMove.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_customCommandReturnsFetchResponse.js">mailnews/imap/test/unit/test_customCommandReturnsFetchResponse.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_customCommandReturnsFetchResponse.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_customCommandReturnsFetchResponse.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_customCommandReturnsFetchResponse.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_customCommandReturnsFetchResponse.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_customCommandReturnsFetchResponse.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_downloadOffline.js">mailnews/imap/test/unit/test_downloadOffline.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_downloadOffline.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_downloadOffline.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_downloadOffline.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_downloadOffline.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_downloadOffline.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_fetchCustomAttribute.js">mailnews/imap/test/unit/test_fetchCustomAttribute.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_fetchCustomAttribute.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_fetchCustomAttribute.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_fetchCustomAttribute.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_fetchCustomAttribute.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_fetchCustomAttribute.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_filterCustomHeaders.js">mailnews/imap/test/unit/test_filterCustomHeaders.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_filterCustomHeaders.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_filterCustomHeaders.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_filterCustomHeaders.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_filterCustomHeaders.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_filterCustomHeaders.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_filterNeedsBody.js">mailnews/imap/test/unit/test_filterNeedsBody.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_filterNeedsBody.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_filterNeedsBody.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_filterNeedsBody.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_filterNeedsBody.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_filterNeedsBody.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_folderOfflineFlags.js">mailnews/imap/test/unit/test_folderOfflineFlags.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_folderOfflineFlags.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_folderOfflineFlags.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_folderOfflineFlags.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_folderOfflineFlags.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_folderOfflineFlags.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_gmailAttributes.js">mailnews/imap/test/unit/test_gmailAttributes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_gmailAttributes.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_gmailAttributes.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_gmailAttributes.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_gmailAttributes.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_gmailAttributes.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_gmailOfflineMsgStore.js">mailnews/imap/test/unit/test_gmailOfflineMsgStore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_gmailOfflineMsgStore.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_gmailOfflineMsgStore.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_gmailOfflineMsgStore.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_gmailOfflineMsgStore.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_gmailOfflineMsgStore.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapAttachmentSaves.js">mailnews/imap/test/unit/test_imapAttachmentSaves.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapAttachmentSaves.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapAttachmentSaves.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapAttachmentSaves.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapAttachmentSaves.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapAttachmentSaves.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapAutoSync.js">mailnews/imap/test/unit/test_imapAutoSync.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapAutoSync.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapAutoSync.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapAutoSync.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapAutoSync.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapAutoSync.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapContentLength.js">mailnews/imap/test/unit/test_imapContentLength.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapContentLength.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapContentLength.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapContentLength.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapContentLength.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapContentLength.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapCopyTimeout.js">mailnews/imap/test/unit/test_imapCopyTimeout.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapCopyTimeout.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapCopyTimeout.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapCopyTimeout.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapCopyTimeout.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapCopyTimeout.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapFlagChange.js">mailnews/imap/test/unit/test_imapFlagChange.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapFlagChange.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapFlagChange.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapFlagChange.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapFlagChange.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapFlagChange.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapFolderCopy.js">mailnews/imap/test/unit/test_imapFolderCopy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapFolderCopy.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapFolderCopy.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapFolderCopy.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapFolderCopy.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapFolderCopy.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapHdrChunking.js">mailnews/imap/test/unit/test_imapHdrChunking.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapHdrChunking.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapHdrChunking.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapHdrChunking.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapHdrChunking.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapHdrChunking.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapHdrStreaming.js">mailnews/imap/test/unit/test_imapHdrStreaming.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapHdrStreaming.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapHdrStreaming.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapHdrStreaming.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapHdrStreaming.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapHdrStreaming.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapID.js">mailnews/imap/test/unit/test_imapID.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapID.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapID.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapID.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapID.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapID.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapMove.js">mailnews/imap/test/unit/test_imapMove.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapMove.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapMove.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapMove.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapMove.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapMove.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapSearch.js">mailnews/imap/test/unit/test_imapSearch.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapSearch.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapSearch.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapSearch.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapSearch.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapSearch.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapStatusCloseDBs.js">mailnews/imap/test/unit/test_imapStatusCloseDBs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapStatusCloseDBs.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapStatusCloseDBs.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapStatusCloseDBs.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapStatusCloseDBs.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapStatusCloseDBs.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapStoreMsgOffline.js">mailnews/imap/test/unit/test_imapStoreMsgOffline.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapStoreMsgOffline.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapStoreMsgOffline.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapStoreMsgOffline.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapStoreMsgOffline.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapStoreMsgOffline.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapUndo.js">mailnews/imap/test/unit/test_imapUndo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapUndo.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapUndo.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapUndo.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapUndo.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_imapUndo.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_largeOfflineStore.js">mailnews/imap/test/unit/test_largeOfflineStore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_largeOfflineStore.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_largeOfflineStore.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_largeOfflineStore.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_largeOfflineStore.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_largeOfflineStore.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_listClosesDB.js">mailnews/imap/test/unit/test_listClosesDB.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_listClosesDB.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_listClosesDB.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_listClosesDB.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_listClosesDB.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_listClosesDB.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_listSubscribed.js">mailnews/imap/test/unit/test_listSubscribed.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_listSubscribed.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_listSubscribed.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_listSubscribed.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_listSubscribed.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_listSubscribed.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_localToImapFilter.js">mailnews/imap/test/unit/test_localToImapFilter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_localToImapFilter.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_localToImapFilter.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_localToImapFilter.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_localToImapFilter.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_localToImapFilter.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_localToImapFilterQuarantine.js">mailnews/imap/test/unit/test_localToImapFilterQuarantine.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_localToImapFilterQuarantine.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_localToImapFilterQuarantine.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_localToImapFilterQuarantine.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_localToImapFilterQuarantine.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_localToImapFilterQuarantine.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_lsub.js">mailnews/imap/test/unit/test_lsub.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_lsub.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_lsub.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_lsub.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_lsub.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_lsub.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_mailboxes.js">mailnews/imap/test/unit/test_mailboxes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_mailboxes.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_mailboxes.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_mailboxes.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_mailboxes.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_mailboxes.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_offlineCopy.js">mailnews/imap/test/unit/test_offlineCopy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_offlineCopy.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_offlineCopy.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_offlineCopy.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_offlineCopy.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_offlineCopy.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_offlineDraftDataloss.js">mailnews/imap/test/unit/test_offlineDraftDataloss.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_offlineDraftDataloss.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_offlineDraftDataloss.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_offlineDraftDataloss.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_offlineDraftDataloss.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_offlineDraftDataloss.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_offlinePlayback.js">mailnews/imap/test/unit/test_offlinePlayback.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_offlinePlayback.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_offlinePlayback.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_offlinePlayback.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_offlinePlayback.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_offlinePlayback.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_offlineStoreLocking.js">mailnews/imap/test/unit/test_offlineStoreLocking.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_offlineStoreLocking.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_offlineStoreLocking.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_offlineStoreLocking.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_offlineStoreLocking.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_offlineStoreLocking.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_partsOnDemand.js">mailnews/imap/test/unit/test_partsOnDemand.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_partsOnDemand.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_partsOnDemand.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_partsOnDemand.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_partsOnDemand.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_partsOnDemand.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_preserveDataOnMove.js">mailnews/imap/test/unit/test_preserveDataOnMove.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_preserveDataOnMove.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_preserveDataOnMove.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_preserveDataOnMove.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_preserveDataOnMove.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_preserveDataOnMove.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_saveImapDraft.js">mailnews/imap/test/unit/test_saveImapDraft.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_saveImapDraft.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_saveImapDraft.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_saveImapDraft.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_saveImapDraft.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_saveImapDraft.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_saveTemplate.js">mailnews/imap/test/unit/test_saveTemplate.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_saveTemplate.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_saveTemplate.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_saveTemplate.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_saveTemplate.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_saveTemplate.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_starttlsFailure.js">mailnews/imap/test/unit/test_starttlsFailure.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_starttlsFailure.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_starttlsFailure.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_starttlsFailure.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_starttlsFailure.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_starttlsFailure.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_stopMovingToLocalFolder.js">mailnews/imap/test/unit/test_stopMovingToLocalFolder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_stopMovingToLocalFolder.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_stopMovingToLocalFolder.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_stopMovingToLocalFolder.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_stopMovingToLocalFolder.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_stopMovingToLocalFolder.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_syncChanges.js">mailnews/imap/test/unit/test_syncChanges.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_syncChanges.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_syncChanges.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_syncChanges.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_syncChanges.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_syncChanges.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_trustSpamAssassin.js">mailnews/imap/test/unit/test_trustSpamAssassin.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_trustSpamAssassin.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_trustSpamAssassin.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_trustSpamAssassin.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_trustSpamAssassin.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/imap/test/unit/test_trustSpamAssassin.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/test/resources/IMAPpump.js">mailnews/test/resources/IMAPpump.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/test/resources/IMAPpump.js">file</a> |
<a href="/comm-central/annotate/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/test/resources/IMAPpump.js">annotate</a> |
<a href="/comm-central/diff/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/test/resources/IMAPpump.js">diff</a> |
<a href="/comm-central/comparison/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/test/resources/IMAPpump.js">comparison</a> |
<a href="/comm-central/log/cf3f13271fc8bd4f8a805db36404d75560ff5b6a/mailnews/test/resources/IMAPpump.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/test/unit/test_imapPump.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_imapPump.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -27,22 +27,22 @@ setupIMAPPump();</span>
<a href="#l1.4"></a><span id="l1.4"> var tests = [</span>
<a href="#l1.5"></a><span id="l1.5">   loadImapMessage,</span>
<a href="#l1.6"></a><span id="l1.6">   endTest</span>
<a href="#l1.7"></a><span id="l1.7"> ]</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> // load and update a message in the imap fake server</span>
<a href="#l1.10"></a><span id="l1.10"> function loadImapMessage()</span>
<a href="#l1.11"></a><span id="l1.11"> {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  gIMAPMailbox.addMessage(new imapMessage(specForFileName(gMessage),</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-                          gIMAPMailbox.uidnext++, []));</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(gDummyMsgWindow, asyncUrlListener);</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+  IMAPPump.mailbox.addMessage(new imapMessage(specForFileName(gMessage),</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+                          IMAPPump.mailbox.uidnext++, []));</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+  IMAPPump.inbox.updateFolderWithListener(gDummyMsgWindow, asyncUrlListener);</span>
<a href="#l1.18"></a><span id="l1.18">   yield false;</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-  do_check_eq(1, gIMAPInbox.getTotalMessages(false));</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-  let msgHdr = mailTestUtils.firstMsgHdr(gIMAPInbox);</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+  do_check_eq(1, IMAPPump.inbox.getTotalMessages(false));</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+  let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l1.23"></a><span id="l1.23">   do_check_true(msgHdr instanceof Ci.nsIMsgDBHdr);</span>
<a href="#l1.24"></a><span id="l1.24">   yield true;</span>
<a href="#l1.25"></a><span id="l1.25"> }</span>
<a href="#l1.26"></a><span id="l1.26"> </span>
<a href="#l1.27"></a><span id="l1.27"> // Cleanup at end</span>
<a href="#l1.28"></a><span id="l1.28"> function endTest()</span>
<a href="#l1.29"></a><span id="l1.29"> {</span>
<a href="#l1.30"></a><span id="l1.30">   teardownIMAPPump();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/test/unit/test_postPluginFilters.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_postPluginFilters.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -170,17 +170,17 @@ DBListener.prototype =</span>
<a href="#l2.4"></a><span id="l2.4">     },</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6">   onAnnouncerGoingAway:</span>
<a href="#l2.7"></a><span id="l2.7">     function onAnnouncerGoingAway(instigator)</span>
<a href="#l2.8"></a><span id="l2.8">     {</span>
<a href="#l2.9"></a><span id="l2.9">       if (gInboxListener)</span>
<a href="#l2.10"></a><span id="l2.10">       {</span>
<a href="#l2.11"></a><span id="l2.11">         try {</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-          gIMAPInbox.msgDatabase.RemoveListener(gInboxListener);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+          IMAPPump.inbox.msgDatabase.RemoveListener(gInboxListener);</span>
<a href="#l2.14"></a><span id="l2.14">         }</span>
<a href="#l2.15"></a><span id="l2.15">         catch (e) {dump(&quot; listener not found\n&quot;);}</span>
<a href="#l2.16"></a><span id="l2.16">       }</span>
<a href="#l2.17"></a><span id="l2.17">     },</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19">   onReadChanged:</span>
<a href="#l2.20"></a><span id="l2.20">     function onReadChanged(aInstigator)</span>
<a href="#l2.21"></a><span id="l2.21">     {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_gmail.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_gmail.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -27,31 +27,31 @@ var tests = [</span>
<a href="#l3.4"></a><span id="l3.4">   testXlist,</span>
<a href="#l3.5"></a><span id="l3.5">   endTest</span>
<a href="#l3.6"></a><span id="l3.6"> ]</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> // mbox mailboxes cannot contain both child mailboxes and messages, so this will</span>
<a href="#l3.9"></a><span id="l3.9"> // be one test case.</span>
<a href="#l3.10"></a><span id="l3.10"> function setupMailboxes()</span>
<a href="#l3.11"></a><span id="l3.11"> {</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  gIMAPMailbox.specialUseFlag = &quot;\\Inbox&quot;;</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;[Gmail]&quot;, {flags : [&quot;\\Noselect&quot;]});</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;[Gmail]/All Mail&quot;, {specialUseFlag : &quot;\\AllMail&quot;});</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;[Gmail]/Drafts&quot;, {specialUseFlag : &quot;\\Drafts&quot;});</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;[Gmail]/Sent&quot;, {specialUseFlag : &quot;\\Sent&quot;});</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;[Gmail]/Spam&quot;, {specialUseFlag : &quot;\\Spam&quot;});</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;[Gmail]/Starred&quot;, {specialUseFlag : &quot;\\Starred&quot;});</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;[Gmail]/Trash&quot;, {specialUseFlag : &quot;\\Trash&quot;});</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;test&quot;, {});</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+  IMAPPump.mailbox.specialUseFlag = &quot;\\Inbox&quot;;</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;[Gmail]&quot;, {flags : [&quot;\\Noselect&quot;]});</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;[Gmail]/All Mail&quot;, {specialUseFlag : &quot;\\AllMail&quot;});</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;[Gmail]/Drafts&quot;, {specialUseFlag : &quot;\\Drafts&quot;});</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;[Gmail]/Sent&quot;, {specialUseFlag : &quot;\\Sent&quot;});</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;[Gmail]/Spam&quot;, {specialUseFlag : &quot;\\Spam&quot;});</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;[Gmail]/Starred&quot;, {specialUseFlag : &quot;\\Starred&quot;});</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;[Gmail]/Trash&quot;, {specialUseFlag : &quot;\\Trash&quot;});</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;test&quot;, {});</span>
<a href="#l3.30"></a><span id="l3.30"> </span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-  handler = gIMAPServer._handlerCreator(gIMAPDaemon);</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+  handler = IMAPPump.server._handlerCreator(IMAPPump.daemon);</span>
<a href="#l3.33"></a><span id="l3.33">   let response = handler.onError('1', 'LOGIN user password');</span>
<a href="#l3.34"></a><span id="l3.34">   do_check_true(response.contains('OK'));</span>
<a href="#l3.35"></a><span id="l3.35">   // wait for imap pump to do its thing or else we get memory leaks</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+  IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l3.38"></a><span id="l3.38">   yield false;</span>
<a href="#l3.39"></a><span id="l3.39"> }</span>
<a href="#l3.40"></a><span id="l3.40"> </span>
<a href="#l3.41"></a><span id="l3.41"> // test that 'XLIST &quot;&quot; &quot;*&quot;' returns the proper responses</span>
<a href="#l3.42"></a><span id="l3.42"> function testXlist()</span>
<a href="#l3.43"></a><span id="l3.43"> {</span>
<a href="#l3.44"></a><span id="l3.44">   let response = handler.onError('2', 'XLIST &quot;&quot; &quot;*&quot;');</span>
<a href="#l3.45"></a><span id="l3.45"> </span>
<a href="#l3.46"></a><span id="l3.46" class="difflineat">@@ -84,10 +84,10 @@ function run_test()</span>
<a href="#l3.47"></a><span id="l3.47">  * helper functions</span>
<a href="#l3.48"></a><span id="l3.48">  */</span>
<a href="#l3.49"></a><span id="l3.49"> </span>
<a href="#l3.50"></a><span id="l3.50"> function recursiveDeleteMailboxes(aMailbox)</span>
<a href="#l3.51"></a><span id="l3.51"> {</span>
<a href="#l3.52"></a><span id="l3.52">   for each (var child in aMailbox.allChildren) {</span>
<a href="#l3.53"></a><span id="l3.53">     recursiveDeleteMailboxes(child);</span>
<a href="#l3.54"></a><span id="l3.54">   }</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-  gIMAPDaemon.deleteMailbox(aMailbox);</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+  IMAPPump.daemon.deleteMailbox(aMailbox);</span>
<a href="#l3.57"></a><span id="l3.57"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_list-extended.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_list-extended.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -33,33 +33,33 @@ var tests = [</span>
<a href="#l4.4"></a><span id="l4.4">   testListSelectMultiple,</span>
<a href="#l4.5"></a><span id="l4.5">   endTest</span>
<a href="#l4.6"></a><span id="l4.6"> ]</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8"> // mbox mailboxes cannot contain both child mailboxes and messages, so this will</span>
<a href="#l4.9"></a><span id="l4.9"> // be one test case.</span>
<a href="#l4.10"></a><span id="l4.10"> function setupMailboxes()</span>
<a href="#l4.11"></a><span id="l4.11"> {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  gIMAPMailbox.flags = [&quot;\\Marked&quot;, &quot;\\NoInferiors&quot;];</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-  gIMAPMailbox.subscribed = true;</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;Fruit&quot;, {});</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;Fruit/Apple&quot;, {});</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;Fruit/Banana&quot;, {subscribed : true});</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;Fruit/Peach&quot;, {nonExistent : true,</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+  IMAPPump.mailbox.flags = [&quot;\\Marked&quot;, &quot;\\NoInferiors&quot;];</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+  IMAPPump.mailbox.subscribed = true;</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;Fruit&quot;, {});</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;Fruit/Apple&quot;, {});</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;Fruit/Banana&quot;, {subscribed : true});</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;Fruit/Peach&quot;, {nonExistent : true,</span>
<a href="#l4.24"></a><span id="l4.24">                                             subscribed : true});</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;Tofu&quot;, {});</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;Vegetable&quot;, {subscribed : true});</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;Vegetable/Broccoli&quot;, {subscribed : true});</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;Vegetable/Corn&quot;, {});</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;Tofu&quot;, {});</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;Vegetable&quot;, {subscribed : true});</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;Vegetable/Broccoli&quot;, {subscribed : true});</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;Vegetable/Corn&quot;, {});</span>
<a href="#l4.33"></a><span id="l4.33"> </span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-  handler = gIMAPServer._handlerCreator(gIMAPDaemon);</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+  handler = IMAPPump.server._handlerCreator(IMAPPump.daemon);</span>
<a href="#l4.36"></a><span id="l4.36">   let response = handler.onError('1', 'LOGIN user password');</span>
<a href="#l4.37"></a><span id="l4.37">   do_check_true(response.contains('OK'));</span>
<a href="#l4.38"></a><span id="l4.38">   // wait for imap pump to do it's thing or else we get memory leaks</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+  IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l4.41"></a><span id="l4.41">   yield false;</span>
<a href="#l4.42"></a><span id="l4.42"> }</span>
<a href="#l4.43"></a><span id="l4.43"> </span>
<a href="#l4.44"></a><span id="l4.44"> // test that 'LIST &quot;&quot; &quot;*&quot;' returns the proper responses (standard LIST usage)</span>
<a href="#l4.45"></a><span id="l4.45"> function testList()</span>
<a href="#l4.46"></a><span id="l4.46"> {</span>
<a href="#l4.47"></a><span id="l4.47">   let response = handler.onError('2', 'LIST &quot;&quot; &quot;*&quot;');</span>
<a href="#l4.48"></a><span id="l4.48"> </span>
<a href="#l4.49"></a><span id="l4.49" class="difflineat">@@ -163,10 +163,10 @@ function run_test()</span>
<a href="#l4.50"></a><span id="l4.50">  * helper functions</span>
<a href="#l4.51"></a><span id="l4.51">  */</span>
<a href="#l4.52"></a><span id="l4.52"> </span>
<a href="#l4.53"></a><span id="l4.53"> function recursiveDeleteMailboxes(aMailbox)</span>
<a href="#l4.54"></a><span id="l4.54"> {</span>
<a href="#l4.55"></a><span id="l4.55">   for each (var child in aMailbox.allChildren) {</span>
<a href="#l4.56"></a><span id="l4.56">     recursiveDeleteMailboxes(child);</span>
<a href="#l4.57"></a><span id="l4.57">   }</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineminus">-  gIMAPDaemon.deleteMailbox(aMailbox);</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+  IMAPPump.daemon.deleteMailbox(aMailbox);</span>
<a href="#l4.60"></a><span id="l4.60"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_autosync_date_constraints.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_autosync_date_constraints.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -23,22 +23,22 @@ function addMessagesToServer(messages, m</span>
<a href="#l5.4"></a><span id="l5.4">   });</span>
<a href="#l5.5"></a><span id="l5.5"> }</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7"> var tests = [</span>
<a href="#l5.8"></a><span id="l5.8">   setup,</span>
<a href="#l5.9"></a><span id="l5.9">   function downloadForOffline() {</span>
<a href="#l5.10"></a><span id="l5.10">     // ...and download for offline use.</span>
<a href="#l5.11"></a><span id="l5.11">     // This downloads all messages, ignoring the autosync age constraints.</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-    gIMAPInbox.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+    IMAPPump.inbox.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l5.14"></a><span id="l5.14">     yield false;</span>
<a href="#l5.15"></a><span id="l5.15">   },</span>
<a href="#l5.16"></a><span id="l5.16">   function applyRetentionSettings() {</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-    gIMAPInbox.applyRetentionSettings();</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-    let enumerator = gIMAPInbox.msgDatabase.EnumerateMessages();</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+    IMAPPump.inbox.applyRetentionSettings();</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+    let enumerator = IMAPPump.inbox.msgDatabase.EnumerateMessages();</span>
<a href="#l5.21"></a><span id="l5.21">     if (enumerator) {</span>
<a href="#l5.22"></a><span id="l5.22">       let now = new Date();</span>
<a href="#l5.23"></a><span id="l5.23">       let dateInSeconds = now.getSeconds();</span>
<a href="#l5.24"></a><span id="l5.24">       let cutOffDateInSeconds = dateInSeconds - (5 * 60 * 24);</span>
<a href="#l5.25"></a><span id="l5.25">       while (enumerator.hasMoreElements()) {</span>
<a href="#l5.26"></a><span id="l5.26">         let header = enumerator.getNext();</span>
<a href="#l5.27"></a><span id="l5.27">         if (header instanceof Components.interfaces.nsIMsgDBHdr) {</span>
<a href="#l5.28"></a><span id="l5.28">           if (header.dateInSeconds &lt; cutOffDateInSeconds)</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineat">@@ -52,18 +52,18 @@ var tests = [</span>
<a href="#l5.30"></a><span id="l5.30">   teardown</span>
<a href="#l5.31"></a><span id="l5.31"> ];</span>
<a href="#l5.32"></a><span id="l5.32"> </span>
<a href="#l5.33"></a><span id="l5.33"> function setup() {</span>
<a href="#l5.34"></a><span id="l5.34">   Services.prefs.setIntPref(&quot;mail.server.server1.autosync_max_age_days&quot;, 4);</span>
<a href="#l5.35"></a><span id="l5.35"> </span>
<a href="#l5.36"></a><span id="l5.36">   setupIMAPPump();</span>
<a href="#l5.37"></a><span id="l5.37"> </span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-  gRootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-  gMsgImapInboxFolder = gIMAPInbox.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+  gRootFolder = IMAPPump.incomingServer.rootFolder;</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+  gMsgImapInboxFolder = IMAPPump.inbox.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l5.42"></a><span id="l5.42">   // these hacks are required because we've created the inbox before</span>
<a href="#l5.43"></a><span id="l5.43">   // running initial folder discovery, and adding the folder bails</span>
<a href="#l5.44"></a><span id="l5.44">   // out before we set it as verified online, so we bail out, and</span>
<a href="#l5.45"></a><span id="l5.45">   // then remove the INBOX folder since it's not verified.</span>
<a href="#l5.46"></a><span id="l5.46">   gMsgImapInboxFolder.hierarchyDelimiter = '/';</span>
<a href="#l5.47"></a><span id="l5.47">   gMsgImapInboxFolder.verifiedAsOnlineFolder = true;</span>
<a href="#l5.48"></a><span id="l5.48"> </span>
<a href="#l5.49"></a><span id="l5.49"> </span>
<a href="#l5.50"></a><span id="l5.50" class="difflineat">@@ -74,17 +74,17 @@ function setup() {</span>
<a href="#l5.51"></a><span id="l5.51"> </span>
<a href="#l5.52"></a><span id="l5.52">   // build up a diverse list of messages</span>
<a href="#l5.53"></a><span id="l5.53">   let messages = [];</span>
<a href="#l5.54"></a><span id="l5.54">   messages = messages.concat(messageGenerator.makeMessage({age: {days: 2, hours: 1}}));</span>
<a href="#l5.55"></a><span id="l5.55">   messages = messages.concat(messageGenerator.makeMessage({age: {days: 8, hours: 1}}));</span>
<a href="#l5.56"></a><span id="l5.56">   messages = messages.concat(messageGenerator.makeMessage({age: {days: 10, hours: 1}}));</span>
<a href="#l5.57"></a><span id="l5.57"> </span>
<a href="#l5.58"></a><span id="l5.58">   addMessagesToServer(messages,</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-                      gIMAPDaemon.getMailbox(&quot;INBOX&quot;), gIMAPInbox);</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+                      IMAPPump.daemon.getMailbox(&quot;INBOX&quot;), IMAPPump.inbox);</span>
<a href="#l5.61"></a><span id="l5.61"> }</span>
<a href="#l5.62"></a><span id="l5.62"> </span>
<a href="#l5.63"></a><span id="l5.63"> function teardown() {</span>
<a href="#l5.64"></a><span id="l5.64">   teardownIMAPPump();</span>
<a href="#l5.65"></a><span id="l5.65"> }</span>
<a href="#l5.66"></a><span id="l5.66"> </span>
<a href="#l5.67"></a><span id="l5.67"> function run_test() {</span>
<a href="#l5.68"></a><span id="l5.68">   async_run_tests(tests);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_bccProperty.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_bccProperty.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -26,32 +26,32 @@ function setup() {</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5">   /*</span>
<a href="#l6.6"></a><span id="l6.6">    * Ok, prelude done. Read the original message from disk</span>
<a href="#l6.7"></a><span id="l6.7">    * (through a file URI), and add it to the Inbox.</span>
<a href="#l6.8"></a><span id="l6.8">    */</span>
<a href="#l6.9"></a><span id="l6.9">   let msgfileuri =</span>
<a href="#l6.10"></a><span id="l6.10">     Services.io.newFileURI(gMsgFile).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  gIMAPMailbox.addMessage(new imapMessage(msgfileuri.spec,</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-                                          gIMAPMailbox.uidnext++, []));</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+  IMAPPump.mailbox.addMessage(new imapMessage(msgfileuri.spec,</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+                                          IMAPPump.mailbox.uidnext++, []));</span>
<a href="#l6.16"></a><span id="l6.16"> </span>
<a href="#l6.17"></a><span id="l6.17">   // ...and download for offline use.</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-  gIMAPInbox.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+  IMAPPump.inbox.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l6.20"></a><span id="l6.20">   yield false;</span>
<a href="#l6.21"></a><span id="l6.21"> }</span>
<a href="#l6.22"></a><span id="l6.22"> </span>
<a href="#l6.23"></a><span id="l6.23"> function downloadAllForOffline() {</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-  gIMAPInbox.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+  IMAPPump.inbox.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l6.26"></a><span id="l6.26">   yield false;</span>
<a href="#l6.27"></a><span id="l6.27"> }</span>
<a href="#l6.28"></a><span id="l6.28"> </span>
<a href="#l6.29"></a><span id="l6.29"> function checkBccs() {</span>
<a href="#l6.30"></a><span id="l6.30">   // locate the new message by enumerating through the database</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-  let enumerator = gIMAPInbox.msgDatabase.EnumerateMessages();</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+  let enumerator = IMAPPump.inbox.msgDatabase.EnumerateMessages();</span>
<a href="#l6.33"></a><span id="l6.33">   while(enumerator.hasMoreElements()) {</span>
<a href="#l6.34"></a><span id="l6.34">     let hdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l6.35"></a><span id="l6.35">     do_check_true(hdr.bccList.contains(&quot;Another Person&quot;));</span>
<a href="#l6.36"></a><span id="l6.36">     do_check_true(hdr.bccList.contains(&quot;&lt;u1@example.com&gt;&quot;));</span>
<a href="#l6.37"></a><span id="l6.37">     do_check_false(hdr.bccList.contains(&quot;IDoNotExist&quot;));</span>
<a href="#l6.38"></a><span id="l6.38">   }</span>
<a href="#l6.39"></a><span id="l6.39"> }</span>
<a href="#l6.40"></a><span id="l6.40"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_bug460636.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_bug460636.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -25,18 +25,18 @@ function setup() {</span>
<a href="#l7.4"></a><span id="l7.4"> </span>
<a href="#l7.5"></a><span id="l7.5">   /*</span>
<a href="#l7.6"></a><span id="l7.6">    * Ok, prelude done. Read the original message from disk</span>
<a href="#l7.7"></a><span id="l7.7">    * (through a file URI), and add it to the Inbox.</span>
<a href="#l7.8"></a><span id="l7.8">    */</span>
<a href="#l7.9"></a><span id="l7.9">   var msgfileuri =</span>
<a href="#l7.10"></a><span id="l7.10">     Services.io.newFileURI(gMsgFile).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  gIMAPMailbox.addMessage(new imapMessage(msgfileuri.spec, gIMAPMailbox.uidnext++, []));</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+  IMAPPump.mailbox.addMessage(new imapMessage(msgfileuri.spec, IMAPPump.mailbox.uidnext++, []));</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+  IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l7.16"></a><span id="l7.16">   yield false;</span>
<a href="#l7.17"></a><span id="l7.17"> </span>
<a href="#l7.18"></a><span id="l7.18">   /*</span>
<a href="#l7.19"></a><span id="l7.19">    * Save the message to a local file. IMapMD corresponds to</span>
<a href="#l7.20"></a><span id="l7.20">    * &lt;profile_dir&gt;/mailtest/ImapMail (where fakeserver puts the IMAP mailbox</span>
<a href="#l7.21"></a><span id="l7.21">    * files). If we pass the test, we'll remove the file afterwards</span>
<a href="#l7.22"></a><span id="l7.22">    * (cf. UrlListener), otherwise it's kept in IMapMD.</span>
<a href="#l7.23"></a><span id="l7.23">    */</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineat">@@ -49,17 +49,17 @@ function setup() {</span>
<a href="#l7.25"></a><span id="l7.25">    *                        in boolean aGenerateDummyEnvelope,</span>
<a href="#l7.26"></a><span id="l7.26">    *                        in nsIUrlListener aUrlListener, out nsIURI aURL,</span>
<a href="#l7.27"></a><span id="l7.27">    *                        in boolean canonicalLineEnding,</span>
<a href="#l7.28"></a><span id="l7.28">    *                        in nsIMsgWindow aMsgWindow);</span>
<a href="#l7.29"></a><span id="l7.29">    * Enforcing canonicalLineEnding (i.e., CRLF) makes sure that the</span>
<a href="#l7.30"></a><span id="l7.30">    * test also runs successfully on platforms not using CRLF by default.</span>
<a href="#l7.31"></a><span id="l7.31">    */</span>
<a href="#l7.32"></a><span id="l7.32">   gIMAPService.SaveMessageToDisk(&quot;imap-message://user@localhost/INBOX#&quot;</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-                                 + (gIMAPMailbox.uidnext-1), gSavedMsgFile,</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+                                 + (IMAPPump.mailbox.uidnext-1), gSavedMsgFile,</span>
<a href="#l7.35"></a><span id="l7.35">                                  false, asyncUrlListener, {}, true, null);</span>
<a href="#l7.36"></a><span id="l7.36">   yield false;</span>
<a href="#l7.37"></a><span id="l7.37"> }</span>
<a href="#l7.38"></a><span id="l7.38"> </span>
<a href="#l7.39"></a><span id="l7.39"> function checkSavedMessage() {</span>
<a href="#l7.40"></a><span id="l7.40">   do_check_eq(IOUtils.loadFileToString(gMsgFile),</span>
<a href="#l7.41"></a><span id="l7.41"> 	      IOUtils.loadFileToString(gSavedMsgFile));</span>
<a href="#l7.42"></a><span id="l7.42"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_compactOfflineStore.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_compactOfflineStore.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -62,132 +62,132 @@ function addGeneratedMessagesToServer(me</span>
<a href="#l8.4"></a><span id="l8.4">   });</span>
<a href="#l8.5"></a><span id="l8.5"> }</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8"> function checkOfflineStore(prevOfflineStoreSize) {</span>
<a href="#l8.9"></a><span id="l8.9">   dump(&quot;checking offline store\n&quot;);</span>
<a href="#l8.10"></a><span id="l8.10">   let offset = new Object;</span>
<a href="#l8.11"></a><span id="l8.11">   let size = new Object;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  let enumerator = gIMAPInbox.msgDatabase.EnumerateMessages();</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+  let enumerator = IMAPPump.inbox.msgDatabase.EnumerateMessages();</span>
<a href="#l8.14"></a><span id="l8.14">   if (enumerator)</span>
<a href="#l8.15"></a><span id="l8.15">   {</span>
<a href="#l8.16"></a><span id="l8.16">     while (enumerator.hasMoreElements())</span>
<a href="#l8.17"></a><span id="l8.17">     {</span>
<a href="#l8.18"></a><span id="l8.18">       let header = enumerator.getNext();</span>
<a href="#l8.19"></a><span id="l8.19">       // this will verify that the message in the offline store</span>
<a href="#l8.20"></a><span id="l8.20">       // starts with &quot;From &quot; - otherwise, it returns an error.</span>
<a href="#l8.21"></a><span id="l8.21">       if (header instanceof Components.interfaces.nsIMsgDBHdr &amp;&amp;</span>
<a href="#l8.22"></a><span id="l8.22">          (header.flags &amp; Ci.nsMsgMessageFlags.Offline))</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">-        gIMAPInbox.getOfflineFileStream(header.messageKey, offset, size).close();</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+        IMAPPump.inbox.getOfflineFileStream(header.messageKey, offset, size).close();</span>
<a href="#l8.25"></a><span id="l8.25">     }</span>
<a href="#l8.26"></a><span id="l8.26">   }</span>
<a href="#l8.27"></a><span id="l8.27">   // check that the offline store shrunk by at least 100 bytes.</span>
<a href="#l8.28"></a><span id="l8.28">   // (exact calculation might be fragile).</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineminus">-  do_check_true(prevOfflineStoreSize &gt; gIMAPInbox.filePath.fileSize + 100);</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+  do_check_true(prevOfflineStoreSize &gt; IMAPPump.inbox.filePath.fileSize + 100);</span>
<a href="#l8.31"></a><span id="l8.31"> }</span>
<a href="#l8.32"></a><span id="l8.32"> </span>
<a href="#l8.33"></a><span id="l8.33"> var tests = [</span>
<a href="#l8.34"></a><span id="l8.34">   setup,</span>
<a href="#l8.35"></a><span id="l8.35">   function downloadForOffline() {</span>
<a href="#l8.36"></a><span id="l8.36">     // ...and download for offline use.</span>
<a href="#l8.37"></a><span id="l8.37">     dump(&quot;Downloading for offline use\n&quot;);</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-    gIMAPInbox.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+    IMAPPump.inbox.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l8.40"></a><span id="l8.40">     yield false;</span>
<a href="#l8.41"></a><span id="l8.41">   },</span>
<a href="#l8.42"></a><span id="l8.42">   function markOneMsgDeleted() {</span>
<a href="#l8.43"></a><span id="l8.43">     // mark a message deleted, and then do a compact of just</span>
<a href="#l8.44"></a><span id="l8.44">     // that folder.</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineminus">-    let msgHdr = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gMsgId5);</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+    let msgHdr = IMAPPump.inbox.msgDatabase.getMsgHdrForMessageID(gMsgId5);</span>
<a href="#l8.47"></a><span id="l8.47">     let array = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l8.48"></a><span id="l8.48">     array.appendElement(msgHdr, false);</span>
<a href="#l8.49"></a><span id="l8.49">     // store the deleted flag</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-    gIMAPInbox.storeImapFlags(0x0008, true, [msgHdr.messageKey], 1, asyncUrlListener);</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+    IMAPPump.inbox.storeImapFlags(0x0008, true, [msgHdr.messageKey], 1, asyncUrlListener);</span>
<a href="#l8.52"></a><span id="l8.52">     yield false;</span>
<a href="#l8.53"></a><span id="l8.53">   },</span>
<a href="#l8.54"></a><span id="l8.54">   function compactOneFolder() {</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-    gIMAPIncomingServer.deleteModel = Ci.nsMsgImapDeleteModels.IMAPDelete;</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+    IMAPPump.incomingServer.deleteModel = Ci.nsMsgImapDeleteModels.IMAPDelete;</span>
<a href="#l8.57"></a><span id="l8.57">     // asyncUrlListener will get called when both expunge and offline store</span>
<a href="#l8.58"></a><span id="l8.58">     // compaction are finished. dummyMsgWindow is required to make the backend</span>
<a href="#l8.59"></a><span id="l8.59">     // compact the offline store.</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineminus">-    gIMAPInbox.compact(asyncUrlListener, gDummyMsgWindow);</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+    IMAPPump.inbox.compact(asyncUrlListener, gDummyMsgWindow);</span>
<a href="#l8.62"></a><span id="l8.62">     yield false;</span>
<a href="#l8.63"></a><span id="l8.63">   },</span>
<a href="#l8.64"></a><span id="l8.64">   function deleteOneMessage() {</span>
<a href="#l8.65"></a><span id="l8.65">     // check that nstmp file has been cleaned up.</span>
<a href="#l8.66"></a><span id="l8.66">     let tmpFile = gRootFolder.filePath;</span>
<a href="#l8.67"></a><span id="l8.67">     tmpFile.append(&quot;nstmp&quot;);</span>
<a href="#l8.68"></a><span id="l8.68">     do_check_false(tmpFile.exists());</span>
<a href="#l8.69"></a><span id="l8.69">     dump(&quot;deleting one message\n&quot;);</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineminus">-    gIMAPIncomingServer.deleteModel = Ci.nsMsgImapDeleteModels.MoveToTrash;</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineminus">-    let msgHdr = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+    IMAPPump.incomingServer.deleteModel = Ci.nsMsgImapDeleteModels.MoveToTrash;</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+    let msgHdr = IMAPPump.inbox.msgDatabase.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l8.74"></a><span id="l8.74">     let array = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l8.75"></a><span id="l8.75">     array.appendElement(msgHdr, false);</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineminus">-    gIMAPInbox.deleteMessages(array, null, false, true, CopyListener, false);</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+    IMAPPump.inbox.deleteMessages(array, null, false, true, CopyListener, false);</span>
<a href="#l8.78"></a><span id="l8.78">     let trashFolder = gRootFolder.getChildNamed(&quot;Trash&quot;);</span>
<a href="#l8.79"></a><span id="l8.79">     // hack to force uid validity to get initialized for trash.</span>
<a href="#l8.80"></a><span id="l8.80">     trashFolder.updateFolder(null);</span>
<a href="#l8.81"></a><span id="l8.81">     yield false;</span>
<a href="#l8.82"></a><span id="l8.82">   },</span>
<a href="#l8.83"></a><span id="l8.83">   function compactOfflineStore() {</span>
<a href="#l8.84"></a><span id="l8.84">     dump(&quot;compacting offline store\n&quot;);</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineminus">-    gImapInboxOfflineStoreSize = gIMAPInbox.filePath.fileSize;</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+    gImapInboxOfflineStoreSize = IMAPPump.inbox.filePath.fileSize;</span>
<a href="#l8.87"></a><span id="l8.87">     gRootFolder.compactAll(asyncUrlListener, null, true);</span>
<a href="#l8.88"></a><span id="l8.88">     yield false;</span>
<a href="#l8.89"></a><span id="l8.89">   },</span>
<a href="#l8.90"></a><span id="l8.90">   function checkCompactionResult() {</span>
<a href="#l8.91"></a><span id="l8.91">     checkOfflineStore(gImapInboxOfflineStoreSize);</span>
<a href="#l8.92"></a><span id="l8.92">     asyncUrlListener.OnStopRunningUrl(null, 0);</span>
<a href="#l8.93"></a><span id="l8.93">     yield false;</span>
<a href="#l8.94"></a><span id="l8.94">   },</span>
<a href="#l8.95"></a><span id="l8.95">   function testPendingRemoval() {</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineminus">-    let msgHdr = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gMsgId2);</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineminus">-    gIMAPInbox.markPendingRemoval(msgHdr, true);</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineminus">-    gImapInboxOfflineStoreSize = gIMAPInbox.filePath.fileSize;</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+    let msgHdr = IMAPPump.inbox.msgDatabase.getMsgHdrForMessageID(gMsgId2);</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+    IMAPPump.inbox.markPendingRemoval(msgHdr, true);</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+    gImapInboxOfflineStoreSize = IMAPPump.inbox.filePath.fileSize;</span>
<a href="#l8.102"></a><span id="l8.102">     gRootFolder.compactAll(asyncUrlListener, null, true);</span>
<a href="#l8.103"></a><span id="l8.103">     yield false;</span>
<a href="#l8.104"></a><span id="l8.104">   },</span>
<a href="#l8.105"></a><span id="l8.105">   function checkCompactionResult() {</span>
<a href="#l8.106"></a><span id="l8.106">     let tmpFile = gRootFolder.filePath;</span>
<a href="#l8.107"></a><span id="l8.107">     tmpFile.append(&quot;nstmp&quot;);</span>
<a href="#l8.108"></a><span id="l8.108">     do_check_false(tmpFile.exists());</span>
<a href="#l8.109"></a><span id="l8.109">     checkOfflineStore(gImapInboxOfflineStoreSize);</span>
<a href="#l8.110"></a><span id="l8.110">     asyncUrlListener.OnStopRunningUrl(null, 0);</span>
<a href="#l8.111"></a><span id="l8.111">     yield false;</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineminus">-    let msgHdr = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gMsgId2);</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+    let msgHdr = IMAPPump.inbox.msgDatabase.getMsgHdrForMessageID(gMsgId2);</span>
<a href="#l8.114"></a><span id="l8.114">     do_check_eq(msgHdr.flags &amp; Ci.nsMsgMessageFlags.Offline, 0);</span>
<a href="#l8.115"></a><span id="l8.115">   },</span>
<a href="#l8.116"></a><span id="l8.116">   teardown</span>
<a href="#l8.117"></a><span id="l8.117"> ];</span>
<a href="#l8.118"></a><span id="l8.118"> </span>
<a href="#l8.119"></a><span id="l8.119"> function setup() {</span>
<a href="#l8.120"></a><span id="l8.120">   setupIMAPPump();</span>
<a href="#l8.121"></a><span id="l8.121"> </span>
<a href="#l8.122"></a><span id="l8.122" class="difflineminus">-  gRootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+  gRootFolder = IMAPPump.incomingServer.rootFolder;</span>
<a href="#l8.124"></a><span id="l8.124">   // these hacks are required because we've created the inbox before</span>
<a href="#l8.125"></a><span id="l8.125">   // running initial folder discovery, and adding the folder bails</span>
<a href="#l8.126"></a><span id="l8.126">   // out before we set it as verified online, so we bail out, and</span>
<a href="#l8.127"></a><span id="l8.127">   // then remove the INBOX folder since it's not verified.</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineminus">-  gIMAPInbox.hierarchyDelimiter = '/';</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineminus">-  gIMAPInbox.verifiedAsOnlineFolder = true;</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+  IMAPPump.inbox.hierarchyDelimiter = '/';</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+  IMAPPump.inbox.verifiedAsOnlineFolder = true;</span>
<a href="#l8.132"></a><span id="l8.132"> </span>
<a href="#l8.133"></a><span id="l8.133">   let messageGenerator = new MessageGenerator();</span>
<a href="#l8.134"></a><span id="l8.134">   let messages = [];</span>
<a href="#l8.135"></a><span id="l8.135">   for (let i = 0; i &lt; 50; i++)</span>
<a href="#l8.136"></a><span id="l8.136">     messages = messages.concat(messageGenerator.makeMessage());</span>
<a href="#l8.137"></a><span id="l8.137"> </span>
<a href="#l8.138"></a><span id="l8.138" class="difflineminus">-  addGeneratedMessagesToServer(messages, gIMAPDaemon.getMailbox(&quot;INBOX&quot;));</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineplus">+  addGeneratedMessagesToServer(messages, IMAPPump.daemon.getMailbox(&quot;INBOX&quot;));</span>
<a href="#l8.140"></a><span id="l8.140"> </span>
<a href="#l8.141"></a><span id="l8.141">   // Add a couple of messages to the INBOX</span>
<a href="#l8.142"></a><span id="l8.142">   // this is synchronous, afaik</span>
<a href="#l8.143"></a><span id="l8.143">   addMessagesToServer([{file: gMsgFile1, messageId: gMsgId1},</span>
<a href="#l8.144"></a><span id="l8.144">                         {file: gMsgFile4, messageId: gMsgId4},</span>
<a href="#l8.145"></a><span id="l8.145">                         {file: gMsgFile2, messageId: gMsgId2},</span>
<a href="#l8.146"></a><span id="l8.146">                         {file: gMsgFile5, messageId: gMsgId5}],</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineminus">-                        gIMAPDaemon.getMailbox(&quot;INBOX&quot;), gIMAPInbox);</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineplus">+                        IMAPPump.daemon.getMailbox(&quot;INBOX&quot;), IMAPPump.inbox);</span>
<a href="#l8.149"></a><span id="l8.149"> }</span>
<a href="#l8.150"></a><span id="l8.150"> </span>
<a href="#l8.151"></a><span id="l8.151"> // nsIMsgCopyServiceListener implementation - runs next test when copy</span>
<a href="#l8.152"></a><span id="l8.152"> // is completed.</span>
<a href="#l8.153"></a><span id="l8.153"> var CopyListener = {</span>
<a href="#l8.154"></a><span id="l8.154">   OnStartCopy: function() {},</span>
<a href="#l8.155"></a><span id="l8.155">   OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l8.156"></a><span id="l8.156">   SetMessageKey: function(aKey) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_copyThenMove.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_copyThenMove.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -21,25 +21,25 @@ Components.utils.import(&quot;resource:///mod</span>
<a href="#l9.4"></a><span id="l9.4"> </span>
<a href="#l9.5"></a><span id="l9.5"> var tests = [</span>
<a href="#l9.6"></a><span id="l9.6">   setup,</span>
<a href="#l9.7"></a><span id="l9.7">   function copyFolder1() {</span>
<a href="#l9.8"></a><span id="l9.8">     dump(&quot;gEmpty1 &quot; + gEmptyLocal1.URI + &quot;\n&quot;);</span>
<a href="#l9.9"></a><span id="l9.9">     let folders = new Array;</span>
<a href="#l9.10"></a><span id="l9.10">     folders.push(gEmptyLocal1.QueryInterface(Ci.nsIMsgFolder));</span>
<a href="#l9.11"></a><span id="l9.11">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-    gCopyService.CopyFolders(array, gIMAPInbox, false, CopyListener, null);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+    gCopyService.CopyFolders(array, IMAPPump.inbox, false, CopyListener, null);</span>
<a href="#l9.14"></a><span id="l9.14">     yield false;</span>
<a href="#l9.15"></a><span id="l9.15">   },</span>
<a href="#l9.16"></a><span id="l9.16">   function copyFolder2() {</span>
<a href="#l9.17"></a><span id="l9.17">     dump(&quot;gEmpty2 &quot; + gEmptyLocal2.URI + &quot;\n&quot;);</span>
<a href="#l9.18"></a><span id="l9.18">     let folders = new Array;</span>
<a href="#l9.19"></a><span id="l9.19">     folders.push(gEmptyLocal2);</span>
<a href="#l9.20"></a><span id="l9.20">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-    gCopyService.CopyFolders(array, gIMAPInbox, false, CopyListener, null);</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+    gCopyService.CopyFolders(array, IMAPPump.inbox, false, CopyListener, null);</span>
<a href="#l9.23"></a><span id="l9.23">     yield false;</span>
<a href="#l9.24"></a><span id="l9.24">   },</span>
<a href="#l9.25"></a><span id="l9.25">   function getLocalMessage1() {</span>
<a href="#l9.26"></a><span id="l9.26">     dump(&quot;getLocalMessage\n&quot;);</span>
<a href="#l9.27"></a><span id="l9.27">     var file = do_get_file(&quot;../../../data/bugmail1&quot;);</span>
<a href="#l9.28"></a><span id="l9.28">     gCopyService.CopyFileMessage(file, localAccountUtils.inboxFolder, null, false, 0,</span>
<a href="#l9.29"></a><span id="l9.29">                                 &quot;&quot;, CopyListener, null);</span>
<a href="#l9.30"></a><span id="l9.30">     yield false;</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineat">@@ -51,41 +51,41 @@ var tests = [</span>
<a href="#l9.32"></a><span id="l9.32">     var file = do_get_file(&quot;../../../data/draft1&quot;);</span>
<a href="#l9.33"></a><span id="l9.33">     gCopyService.CopyFileMessage(file, localAccountUtils.inboxFolder, null, false, 0,</span>
<a href="#l9.34"></a><span id="l9.34">                                 &quot;&quot;, CopyListener, null);</span>
<a href="#l9.35"></a><span id="l9.35">     yield false;</span>
<a href="#l9.36"></a><span id="l9.36">   },</span>
<a href="#l9.37"></a><span id="l9.37">   function copyMessages() {</span>
<a href="#l9.38"></a><span id="l9.38">     gMessages.appendElement(localAccountUtils.inboxFolder.GetMessageHeader(gLastKey),</span>
<a href="#l9.39"></a><span id="l9.39">                             false);</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-    let folder1 = gIMAPInbox.getChildNamed(&quot;empty 1&quot;);</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+    let folder1 = IMAPPump.inbox.getChildNamed(&quot;empty 1&quot;);</span>
<a href="#l9.42"></a><span id="l9.42">     gCopyService.CopyMessages(localAccountUtils.inboxFolder, gMessages, folder1, false,</span>
<a href="#l9.43"></a><span id="l9.43">                               CopyListener, null, false);</span>
<a href="#l9.44"></a><span id="l9.44">     yield false;</span>
<a href="#l9.45"></a><span id="l9.45">   },</span>
<a href="#l9.46"></a><span id="l9.46">   function moveMessages() {</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-    let folder2 = gIMAPInbox.getChildNamed(&quot;empty 2&quot;);</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+    let folder2 = IMAPPump.inbox.getChildNamed(&quot;empty 2&quot;);</span>
<a href="#l9.49"></a><span id="l9.49">       gCopyService.CopyMessages(localAccountUtils.inboxFolder, gMessages, folder2, true,</span>
<a href="#l9.50"></a><span id="l9.50">                                 CopyListener, null, false);</span>
<a href="#l9.51"></a><span id="l9.51">     yield false;</span>
<a href="#l9.52"></a><span id="l9.52">   },</span>
<a href="#l9.53"></a><span id="l9.53">   function update1() {</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineminus">-    let folder1 = gIMAPInbox.getChildNamed(&quot;empty 1&quot;).QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+    let folder1 = IMAPPump.inbox.getChildNamed(&quot;empty 1&quot;).QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l9.56"></a><span id="l9.56">     folder1.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l9.57"></a><span id="l9.57">     yield false;</span>
<a href="#l9.58"></a><span id="l9.58">   },</span>
<a href="#l9.59"></a><span id="l9.59">   function update2() {</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">-    let folder2 = gIMAPInbox.getChildNamed(&quot;empty 2&quot;).QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+    let folder2 = IMAPPump.inbox.getChildNamed(&quot;empty 2&quot;).QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l9.62"></a><span id="l9.62">     folder2.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l9.63"></a><span id="l9.63">     yield false;</span>
<a href="#l9.64"></a><span id="l9.64">   },</span>
<a href="#l9.65"></a><span id="l9.65">   function verifyFolders() {</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineminus">-    let folder1 = gIMAPInbox.getChildNamed(&quot;empty 1&quot;);</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+    let folder1 = IMAPPump.inbox.getChildNamed(&quot;empty 1&quot;);</span>
<a href="#l9.68"></a><span id="l9.68">     do_check_eq(folderCount(folder1), 2);</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineminus">-    let folder2 = gIMAPInbox.getChildNamed(&quot;empty 2&quot;);</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+    let folder2 = IMAPPump.inbox.getChildNamed(&quot;empty 2&quot;);</span>
<a href="#l9.71"></a><span id="l9.71">     do_check_neq(folder2, null);</span>
<a href="#l9.72"></a><span id="l9.72">     // folder 1 and 2 should each now have two messages in them.</span>
<a href="#l9.73"></a><span id="l9.73">     do_check_neq(folder1, null);</span>
<a href="#l9.74"></a><span id="l9.74">     do_check_eq(folderCount(folder2), 2);</span>
<a href="#l9.75"></a><span id="l9.75">     // The local inbox folder should now be empty, since the second</span>
<a href="#l9.76"></a><span id="l9.76">     // operation was a move.</span>
<a href="#l9.77"></a><span id="l9.77">     do_check_eq(folderCount(localAccountUtils.inboxFolder), 0);</span>
<a href="#l9.78"></a><span id="l9.78">   },</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineat">@@ -116,18 +116,18 @@ function setup() {</span>
<a href="#l9.80"></a><span id="l9.80"> </span>
<a href="#l9.81"></a><span id="l9.81">   gEmptyLocal1 = localAccountUtils.rootFolder.createLocalSubfolder(&quot;empty 1&quot;);</span>
<a href="#l9.82"></a><span id="l9.82">   gEmptyLocal2 = localAccountUtils.rootFolder.createLocalSubfolder(&quot;empty 2&quot;);</span>
<a href="#l9.83"></a><span id="l9.83"> </span>
<a href="#l9.84"></a><span id="l9.84">   // these hacks are required because we've created the inbox before</span>
<a href="#l9.85"></a><span id="l9.85">   // running initial folder discovery, and adding the folder bails</span>
<a href="#l9.86"></a><span id="l9.86">   // out before we set it as verified online, so we bail out, and</span>
<a href="#l9.87"></a><span id="l9.87">   // then remove the INBOX folder since it's not verified.</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineminus">-  gIMAPInbox.hierarchyDelimiter = '/';</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineminus">-  gIMAPInbox.verifiedAsOnlineFolder = true;</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineplus">+  IMAPPump.inbox.hierarchyDelimiter = '/';</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineplus">+  IMAPPump.inbox.verifiedAsOnlineFolder = true;</span>
<a href="#l9.92"></a><span id="l9.92"> }</span>
<a href="#l9.93"></a><span id="l9.93"> </span>
<a href="#l9.94"></a><span id="l9.94"> // nsIMsgCopyServiceListener implementation - runs next test when copy</span>
<a href="#l9.95"></a><span id="l9.95"> // is completed.</span>
<a href="#l9.96"></a><span id="l9.96"> var CopyListener =</span>
<a href="#l9.97"></a><span id="l9.97"> {</span>
<a href="#l9.98"></a><span id="l9.98">   OnStartCopy: function() {},</span>
<a href="#l9.99"></a><span id="l9.99">   OnProgress: function(aProgress, aProgressMax) {},</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_customCommandReturnsFetchResponse.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_customCommandReturnsFetchResponse.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -37,28 +37,28 @@ var tests = [</span>
<a href="#l10.4"></a><span id="l10.4">   testStorePlusCustomList,</span>
<a href="#l10.5"></a><span id="l10.5">   endTest</span>
<a href="#l10.6"></a><span id="l10.6"> ]</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8"> // load and update a message in the imap fake server</span>
<a href="#l10.9"></a><span id="l10.9"> function loadImapMessage()</span>
<a href="#l10.10"></a><span id="l10.10"> {</span>
<a href="#l10.11"></a><span id="l10.11">   gMessage = new imapMessage(specForFileName(gMessageFileName),</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-    gIMAPMailbox.uidnext++, []);</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+    IMAPPump.mailbox.uidnext++, []);</span>
<a href="#l10.14"></a><span id="l10.14">   gMessage.xCustomList = [];</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-  gIMAPMailbox.addMessage(gMessage);</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+  IMAPPump.mailbox.addMessage(gMessage);</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+  IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l10.19"></a><span id="l10.19">   yield false;</span>
<a href="#l10.20"></a><span id="l10.20"> }</span>
<a href="#l10.21"></a><span id="l10.21"> </span>
<a href="#l10.22"></a><span id="l10.22"> function testStoreCustomList()</span>
<a href="#l10.23"></a><span id="l10.23"> {</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineminus">-  let msgHdr = mailTestUtils.firstMsgHdr(gIMAPInbox);</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+  let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l10.26"></a><span id="l10.26">   gExpectedLength = gCustomList.length;</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineminus">-  let uri = gIMAPInbox.issueCommandOnMsgs(&quot;STORE&quot;, msgHdr.messageKey +</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+  let uri = IMAPPump.inbox.issueCommandOnMsgs(&quot;STORE&quot;, msgHdr.messageKey +</span>
<a href="#l10.29"></a><span id="l10.29">     &quot; X-CUSTOM-LIST (&quot; + gCustomList.join(&quot; &quot;) + &quot;)&quot;, gMsgWindow);</span>
<a href="#l10.30"></a><span id="l10.30">   uri.QueryInterface(Ci.nsIMsgMailNewsUrl);</span>
<a href="#l10.31"></a><span id="l10.31">   uri.RegisterListener(storeCustomListSetListener);</span>
<a href="#l10.32"></a><span id="l10.32">   yield false;</span>
<a href="#l10.33"></a><span id="l10.33"> }</span>
<a href="#l10.34"></a><span id="l10.34"> </span>
<a href="#l10.35"></a><span id="l10.35"> // listens for response from customCommandResult request for X-CUSTOM-LIST</span>
<a href="#l10.36"></a><span id="l10.36"> var storeCustomListSetListener = {</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineat">@@ -70,19 +70,19 @@ var storeCustomListSetListener = {</span>
<a href="#l10.38"></a><span id="l10.38">       &quot;(&quot; + gMessage.xCustomList.join(&quot; &quot;) + &quot;)&quot;);</span>
<a href="#l10.39"></a><span id="l10.39">     do_check_eq(gMessage.xCustomList.length, gExpectedLength);</span>
<a href="#l10.40"></a><span id="l10.40">     async_driver();</span>
<a href="#l10.41"></a><span id="l10.41">   }</span>
<a href="#l10.42"></a><span id="l10.42"> };</span>
<a href="#l10.43"></a><span id="l10.43"> </span>
<a href="#l10.44"></a><span id="l10.44"> function testStoreMinusCustomList()</span>
<a href="#l10.45"></a><span id="l10.45"> {</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineminus">-  let msgHdr = mailTestUtils.firstMsgHdr(gIMAPInbox);</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+  let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l10.48"></a><span id="l10.48">   gExpectedLength--;</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineminus">-  let uri = gIMAPInbox.issueCommandOnMsgs(&quot;STORE&quot;, msgHdr.messageKey +</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+  let uri = IMAPPump.inbox.issueCommandOnMsgs(&quot;STORE&quot;, msgHdr.messageKey +</span>
<a href="#l10.51"></a><span id="l10.51">     &quot; -X-CUSTOM-LIST (&quot; + gCustomList[0] + &quot;)&quot;, gMsgWindow);</span>
<a href="#l10.52"></a><span id="l10.52">   uri.QueryInterface(Ci.nsIMsgMailNewsUrl);</span>
<a href="#l10.53"></a><span id="l10.53">   uri.RegisterListener(storeCustomListRemovedListener);</span>
<a href="#l10.54"></a><span id="l10.54">   yield false;</span>
<a href="#l10.55"></a><span id="l10.55"> }</span>
<a href="#l10.56"></a><span id="l10.56"> </span>
<a href="#l10.57"></a><span id="l10.57"> // listens for response from customCommandResult request for X-CUSTOM-LIST</span>
<a href="#l10.58"></a><span id="l10.58"> var storeCustomListRemovedListener = {</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineat">@@ -94,19 +94,19 @@ var storeCustomListRemovedListener = {</span>
<a href="#l10.60"></a><span id="l10.60">       &quot;(&quot; + gMessage.xCustomList.join(&quot; &quot;) + &quot;)&quot;);</span>
<a href="#l10.61"></a><span id="l10.61">     do_check_eq(gMessage.xCustomList.length, gExpectedLength);</span>
<a href="#l10.62"></a><span id="l10.62">     async_driver();</span>
<a href="#l10.63"></a><span id="l10.63">   }</span>
<a href="#l10.64"></a><span id="l10.64"> };</span>
<a href="#l10.65"></a><span id="l10.65"> </span>
<a href="#l10.66"></a><span id="l10.66"> function testStorePlusCustomList()</span>
<a href="#l10.67"></a><span id="l10.67"> {</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineminus">-  let msgHdr = mailTestUtils.firstMsgHdr(gIMAPInbox);</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineplus">+  let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l10.70"></a><span id="l10.70">   gExpectedLength++;</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineminus">-  let uri = gIMAPInbox.issueCommandOnMsgs(&quot;STORE&quot;, msgHdr.messageKey +</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+  let uri = IMAPPump.inbox.issueCommandOnMsgs(&quot;STORE&quot;, msgHdr.messageKey +</span>
<a href="#l10.73"></a><span id="l10.73">     ' +X-CUSTOM-LIST (&quot;Custom4&quot;)', gMsgWindow);</span>
<a href="#l10.74"></a><span id="l10.74">   uri.QueryInterface(Ci.nsIMsgMailNewsUrl);</span>
<a href="#l10.75"></a><span id="l10.75">   uri.RegisterListener(storeCustomListAddedListener);</span>
<a href="#l10.76"></a><span id="l10.76">   yield false;</span>
<a href="#l10.77"></a><span id="l10.77"> }</span>
<a href="#l10.78"></a><span id="l10.78"> </span>
<a href="#l10.79"></a><span id="l10.79"> // listens for response from customCommandResult request for X-CUSTOM-LIST</span>
<a href="#l10.80"></a><span id="l10.80"> var storeCustomListAddedListener = {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_downloadOffline.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_downloadOffline.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -24,50 +24,50 @@ function setup() {</span>
<a href="#l11.4"></a><span id="l11.4"> </span>
<a href="#l11.5"></a><span id="l11.5">  /*</span>
<a href="#l11.6"></a><span id="l11.6">    * Ok, prelude done. Read the original message from disk</span>
<a href="#l11.7"></a><span id="l11.7">    * (through a file URI), and add it to the Inbox.</span>
<a href="#l11.8"></a><span id="l11.8">    */</span>
<a href="#l11.9"></a><span id="l11.9">   let msgfileuri =</span>
<a href="#l11.10"></a><span id="l11.10">     Services.io.newFileURI(gMsgFile).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-  gIMAPMailbox.addMessage(new imapMessage(msgfileuri.spec, gIMAPMailbox.uidnext++, []));</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+  IMAPPump.mailbox.addMessage(new imapMessage(msgfileuri.spec, IMAPPump.mailbox.uidnext++, []));</span>
<a href="#l11.14"></a><span id="l11.14"> </span>
<a href="#l11.15"></a><span id="l11.15">   let messages = [];</span>
<a href="#l11.16"></a><span id="l11.16">   let gMessageGenerator = new MessageGenerator();</span>
<a href="#l11.17"></a><span id="l11.17">   messages = messages.concat(gMessageGenerator.makeMessage());</span>
<a href="#l11.18"></a><span id="l11.18">   gSynthMessage = messages[0];</span>
<a href="#l11.19"></a><span id="l11.19">   let dataUri = Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l11.20"></a><span id="l11.20">                                    btoa(messages[0].toMessageString()),</span>
<a href="#l11.21"></a><span id="l11.21">                                    null, null);</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-  let imapMsg = new imapMessage(dataUri.spec, gIMAPMailbox.uidnext++, []);</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+  let imapMsg = new imapMessage(dataUri.spec, IMAPPump.mailbox.uidnext++, []);</span>
<a href="#l11.24"></a><span id="l11.24">   imapMsg.setSize(5000);</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-  gIMAPMailbox.addMessage(imapMsg);</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+  IMAPPump.mailbox.addMessage(imapMsg);</span>
<a href="#l11.27"></a><span id="l11.27">   </span>
<a href="#l11.28"></a><span id="l11.28">   // ...and download for offline use.</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-  gIMAPInbox.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+  IMAPPump.inbox.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l11.31"></a><span id="l11.31">   yield false;</span>
<a href="#l11.32"></a><span id="l11.32"> }</span>
<a href="#l11.33"></a><span id="l11.33"> </span>
<a href="#l11.34"></a><span id="l11.34"> function downloadAllForOffline() {</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">-  gIMAPInbox.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+  IMAPPump.inbox.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l11.37"></a><span id="l11.37">   yield false;</span>
<a href="#l11.38"></a><span id="l11.38"> }</span>
<a href="#l11.39"></a><span id="l11.39"> </span>
<a href="#l11.40"></a><span id="l11.40"> function verifyDownloaded() {</span>
<a href="#l11.41"></a><span id="l11.41">   // verify that the message headers have the offline flag set.</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">-  let msgEnumerator = gIMAPInbox.msgDatabase.EnumerateMessages();</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+  let msgEnumerator = IMAPPump.inbox.msgDatabase.EnumerateMessages();</span>
<a href="#l11.44"></a><span id="l11.44">   let offset = {};</span>
<a href="#l11.45"></a><span id="l11.45">   let size = {};</span>
<a href="#l11.46"></a><span id="l11.46">   while (msgEnumerator.hasMoreElements()) {</span>
<a href="#l11.47"></a><span id="l11.47">     let header = msgEnumerator.getNext();</span>
<a href="#l11.48"></a><span id="l11.48">     // Verify that each message has been downloaded and looks OK.</span>
<a href="#l11.49"></a><span id="l11.49">     if (header instanceof Components.interfaces.nsIMsgDBHdr &amp;&amp;</span>
<a href="#l11.50"></a><span id="l11.50">         (header.flags &amp; Ci.nsMsgMessageFlags.Offline))</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineminus">-      gIMAPInbox.getOfflineFileStream(header.messageKey, offset, size).close();</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+      IMAPPump.inbox.getOfflineFileStream(header.messageKey, offset, size).close();</span>
<a href="#l11.53"></a><span id="l11.53">     else</span>
<a href="#l11.54"></a><span id="l11.54">       do_throw(&quot;Message not downloaded for offline use&quot;);</span>
<a href="#l11.55"></a><span id="l11.55">   }</span>
<a href="#l11.56"></a><span id="l11.56"> }</span>
<a href="#l11.57"></a><span id="l11.57"> </span>
<a href="#l11.58"></a><span id="l11.58"> function teardown() {</span>
<a href="#l11.59"></a><span id="l11.59">   teardownIMAPPump();</span>
<a href="#l11.60"></a><span id="l11.60"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_fetchCustomAttribute.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_fetchCustomAttribute.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -35,30 +35,30 @@ var tests = [</span>
<a href="#l12.4"></a><span id="l12.4">   testFetchCustomList,</span>
<a href="#l12.5"></a><span id="l12.5">   endTest</span>
<a href="#l12.6"></a><span id="l12.6"> ]</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8"> // load and update a message in the imap fake server</span>
<a href="#l12.9"></a><span id="l12.9"> function loadImapMessage()</span>
<a href="#l12.10"></a><span id="l12.10"> {</span>
<a href="#l12.11"></a><span id="l12.11">   let message = new imapMessage(specForFileName(gMessage),</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-                          gIMAPMailbox.uidnext++, []);</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+                          IMAPPump.mailbox.uidnext++, []);</span>
<a href="#l12.14"></a><span id="l12.14">   message.xCustomValue = gCustomValue;</span>
<a href="#l12.15"></a><span id="l12.15">   message.xCustomList = gCustomList;</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-  gIMAPMailbox.addMessage(message);</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+  IMAPPump.mailbox.addMessage(message);</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+  IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l12.20"></a><span id="l12.20">   yield false;</span>
<a href="#l12.21"></a><span id="l12.21"> }</span>
<a href="#l12.22"></a><span id="l12.22"> </span>
<a href="#l12.23"></a><span id="l12.23"> // Used to verify that nsIServerResponseParser.msg_fetch() can handle</span>
<a href="#l12.24"></a><span id="l12.24"> // not in a parenthesis group - Bug 750012</span>
<a href="#l12.25"></a><span id="l12.25"> function testFetchCustomValue()</span>
<a href="#l12.26"></a><span id="l12.26"> {</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineminus">-  let msgHdr = mailTestUtils.firstMsgHdr(gIMAPInbox);</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineminus">-  let uri = gIMAPInbox.fetchCustomMsgAttribute(&quot;X-CUSTOM-VALUE&quot;, msgHdr.messageKey, gMsgWindow);</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+  let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+  let uri = IMAPPump.inbox.fetchCustomMsgAttribute(&quot;X-CUSTOM-VALUE&quot;, msgHdr.messageKey, gMsgWindow);</span>
<a href="#l12.31"></a><span id="l12.31">   uri.QueryInterface(Ci.nsIMsgMailNewsUrl);</span>
<a href="#l12.32"></a><span id="l12.32">   uri.RegisterListener(fetchCustomValueListener);</span>
<a href="#l12.33"></a><span id="l12.33">   yield false;</span>
<a href="#l12.34"></a><span id="l12.34"> }</span>
<a href="#l12.35"></a><span id="l12.35"> </span>
<a href="#l12.36"></a><span id="l12.36"> // listens for resposne from fetchCustomMsgAttribute request for X-CUSTOM-VALUE</span>
<a href="#l12.37"></a><span id="l12.37"> var fetchCustomValueListener = {</span>
<a href="#l12.38"></a><span id="l12.38">   OnStartRunningUrl: function (aUrl) {},</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineat">@@ -68,18 +68,18 @@ var fetchCustomValueListener = {</span>
<a href="#l12.40"></a><span id="l12.40">     do_check_eq(aUrl.customAttributeResult, gCustomValue);</span>
<a href="#l12.41"></a><span id="l12.41">     async_driver();</span>
<a href="#l12.42"></a><span id="l12.42">   }</span>
<a href="#l12.43"></a><span id="l12.43"> };</span>
<a href="#l12.44"></a><span id="l12.44"> </span>
<a href="#l12.45"></a><span id="l12.45"> // Used to verify that nsIServerResponseParser.msg_fetch() can handle a parenthesis group - Bug 735542</span>
<a href="#l12.46"></a><span id="l12.46"> function testFetchCustomList()</span>
<a href="#l12.47"></a><span id="l12.47"> {</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineminus">-  let msgHdr = mailTestUtils.firstMsgHdr(gIMAPInbox);</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineminus">-  let uri = gIMAPInbox.fetchCustomMsgAttribute(&quot;X-CUSTOM-LIST&quot;, msgHdr.messageKey, gMsgWindow);</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+  let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+  let uri = IMAPPump.inbox.fetchCustomMsgAttribute(&quot;X-CUSTOM-LIST&quot;, msgHdr.messageKey, gMsgWindow);</span>
<a href="#l12.52"></a><span id="l12.52">   uri.QueryInterface(Ci.nsIMsgMailNewsUrl);</span>
<a href="#l12.53"></a><span id="l12.53">   uri.RegisterListener(fetchCustomListListener);</span>
<a href="#l12.54"></a><span id="l12.54">   yield false;</span>
<a href="#l12.55"></a><span id="l12.55"> }</span>
<a href="#l12.56"></a><span id="l12.56"> </span>
<a href="#l12.57"></a><span id="l12.57"> // listens for response from fetchCustomMsgAttribute request for X-CUSTOM-LIST</span>
<a href="#l12.58"></a><span id="l12.58"> var fetchCustomListListener = {</span>
<a href="#l12.59"></a><span id="l12.59">   OnStartRunningUrl: function (aUrl) {},</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_filterCustomHeaders.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_filterCustomHeaders.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -23,17 +23,17 @@ var tests = [</span>
<a href="#l13.4"></a><span id="l13.4">   checkFilterResults,</span>
<a href="#l13.5"></a><span id="l13.5">   endTest</span>
<a href="#l13.6"></a><span id="l13.6"> ]</span>
<a href="#l13.7"></a><span id="l13.7"> </span>
<a href="#l13.8"></a><span id="l13.8"> function run_test()</span>
<a href="#l13.9"></a><span id="l13.9"> {</span>
<a href="#l13.10"></a><span id="l13.10"> </span>
<a href="#l13.11"></a><span id="l13.11">   // Create a test filter.</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-  let filterList = gIMAPIncomingServer.getFilterList(null);</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+  let filterList = IMAPPump.incomingServer.getFilterList(null);</span>
<a href="#l13.14"></a><span id="l13.14">   let filter = filterList.createFilter(&quot;test list-id&quot;);</span>
<a href="#l13.15"></a><span id="l13.15">   let searchTerm = filter.createTerm();</span>
<a href="#l13.16"></a><span id="l13.16">   searchTerm.attrib = Ci.nsMsgSearchAttrib.OtherHeader + 1;</span>
<a href="#l13.17"></a><span id="l13.17">   searchTerm.op = Ci.nsMsgSearchOp.Contains;</span>
<a href="#l13.18"></a><span id="l13.18">   let value = searchTerm.value;</span>
<a href="#l13.19"></a><span id="l13.19">   value.attrib = Ci.nsMsgSearchAttrib.OtherHeader;</span>
<a href="#l13.20"></a><span id="l13.20">   value.str = &quot;gnupg-users.gnupg.org&quot;;</span>
<a href="#l13.21"></a><span id="l13.21">   searchTerm.value = value;</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineat">@@ -51,25 +51,25 @@ function run_test()</span>
<a href="#l13.23"></a><span id="l13.23">   async_run_tests(tests);</span>
<a href="#l13.24"></a><span id="l13.24"> }</span>
<a href="#l13.25"></a><span id="l13.25"> </span>
<a href="#l13.26"></a><span id="l13.26"> function setupTest() {</span>
<a href="#l13.27"></a><span id="l13.27">   Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l13.28"></a><span id="l13.28">   let file = do_get_file(&quot;../../../data/bugmail19&quot;);</span>
<a href="#l13.29"></a><span id="l13.29">   let msgfileuri = Services.io.newFileURI(file).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l13.30"></a><span id="l13.30"> </span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-  gIMAPMailbox.addMessage(new imapMessage(msgfileuri.spec,</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-                                          gIMAPMailbox.uidnext++, []));</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+  IMAPPump.mailbox.addMessage(new imapMessage(msgfileuri.spec,</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+                                          IMAPPump.mailbox.uidnext++, []));</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+  IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l13.37"></a><span id="l13.37">   yield false;</span>
<a href="#l13.38"></a><span id="l13.38"> }</span>
<a href="#l13.39"></a><span id="l13.39"> </span>
<a href="#l13.40"></a><span id="l13.40"> function checkFilterResults() {</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineminus">-  let msgHdr = mailTestUtils.firstMsgHdr(gIMAPInbox);</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+  let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l13.43"></a><span id="l13.43">   do_check_true(msgHdr.isRead);</span>
<a href="#l13.44"></a><span id="l13.44">   yield true;</span>
<a href="#l13.45"></a><span id="l13.45"> }</span>
<a href="#l13.46"></a><span id="l13.46"> </span>
<a href="#l13.47"></a><span id="l13.47"> // Cleanup</span>
<a href="#l13.48"></a><span id="l13.48"> function endTest() {</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineminus">-  gIMAPServer.performTest(&quot;UID STORE&quot;);</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+  IMAPPump.server.performTest(&quot;UID STORE&quot;);</span>
<a href="#l13.51"></a><span id="l13.51">   teardownIMAPPump();</span>
<a href="#l13.52"></a><span id="l13.52"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_filterNeedsBody.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_filterNeedsBody.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -36,46 +36,46 @@ var tests = [</span>
<a href="#l14.4"></a><span id="l14.4">   },</span>
<a href="#l14.5"></a><span id="l14.5">   teardown</span>
<a href="#l14.6"></a><span id="l14.6"> ];</span>
<a href="#l14.7"></a><span id="l14.7"> </span>
<a href="#l14.8"></a><span id="l14.8"> function setup() {</span>
<a href="#l14.9"></a><span id="l14.9">   setupIMAPPump();</span>
<a href="#l14.10"></a><span id="l14.10"> </span>
<a href="#l14.11"></a><span id="l14.11">   // Create a test filter.</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-  let filterList = gIMAPIncomingServer.getFilterList(null);</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+  let filterList = IMAPPump.incomingServer.getFilterList(null);</span>
<a href="#l14.14"></a><span id="l14.14">   gFilter = filterList.createFilter(&quot;test offline&quot;);</span>
<a href="#l14.15"></a><span id="l14.15">   let searchTerm = gFilter.createTerm();</span>
<a href="#l14.16"></a><span id="l14.16">   searchTerm.matchAll = true;</span>
<a href="#l14.17"></a><span id="l14.17"> </span>
<a href="#l14.18"></a><span id="l14.18">   gFilter.appendTerm(searchTerm);</span>
<a href="#l14.19"></a><span id="l14.19">   gFilter.enabled = true;</span>
<a href="#l14.20"></a><span id="l14.20"> </span>
<a href="#l14.21"></a><span id="l14.21">   // an action that can be modified by tests</span>
<a href="#l14.22"></a><span id="l14.22">   gAction = gFilter.createAction();</span>
<a href="#l14.23"></a><span id="l14.23"> </span>
<a href="#l14.24"></a><span id="l14.24">   // add the custom actions</span>
<a href="#l14.25"></a><span id="l14.25">   MailServices.filters.addCustomAction(actionTestOffline);</span>
<a href="#l14.26"></a><span id="l14.26"> }</span>
<a href="#l14.27"></a><span id="l14.27"> </span>
<a href="#l14.28"></a><span id="l14.28"> // basic preparation done for each test</span>
<a href="#l14.29"></a><span id="l14.29"> function runFilterAction(aFilter, aAction) {</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-  let filterList = gIMAPIncomingServer.getFilterList(null);</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+  let filterList = IMAPPump.incomingServer.getFilterList(null);</span>
<a href="#l14.32"></a><span id="l14.32">   while (filterList.filterCount)</span>
<a href="#l14.33"></a><span id="l14.33">     filterList.removeFilterAt(0);</span>
<a href="#l14.34"></a><span id="l14.34">   if (aFilter) {</span>
<a href="#l14.35"></a><span id="l14.35">     aFilter.clearActionList();</span>
<a href="#l14.36"></a><span id="l14.36">     if (aAction) {</span>
<a href="#l14.37"></a><span id="l14.37">       aFilter.appendAction(aAction);</span>
<a href="#l14.38"></a><span id="l14.38">       filterList.insertFilterAt(0, aFilter);</span>
<a href="#l14.39"></a><span id="l14.39">     }</span>
<a href="#l14.40"></a><span id="l14.40">   }</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineminus">-  gIMAPMailbox.addMessage(new imapMessage(specForFileName(gMessage),</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineminus">-                          gIMAPMailbox.uidnext++, []));</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+  IMAPPump.mailbox.addMessage(new imapMessage(specForFileName(gMessage),</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+                          IMAPPump.mailbox.uidnext++, []));</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+  IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l14.47"></a><span id="l14.47">   yield false;</span>
<a href="#l14.48"></a><span id="l14.48"> }</span>
<a href="#l14.49"></a><span id="l14.49"> </span>
<a href="#l14.50"></a><span id="l14.50"> function teardown() {</span>
<a href="#l14.51"></a><span id="l14.51">   teardownIMAPPump();</span>
<a href="#l14.52"></a><span id="l14.52"> }</span>
<a href="#l14.53"></a><span id="l14.53"> </span>
<a href="#l14.54"></a><span id="l14.54"> function run_test() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_folderOfflineFlags.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_folderOfflineFlags.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -29,77 +29,77 @@ var tests = [</span>
<a href="#l15.4"></a><span id="l15.4"> ];</span>
<a href="#l15.5"></a><span id="l15.5"> </span>
<a href="#l15.6"></a><span id="l15.6"> /**</span>
<a href="#l15.7"></a><span id="l15.7">  * Setup the mailboxes that will be used for this test.</span>
<a href="#l15.8"></a><span id="l15.8">  */</span>
<a href="#l15.9"></a><span id="l15.9"> function setup() {</span>
<a href="#l15.10"></a><span id="l15.10">   setupIMAPPump(&quot;GMail&quot;);</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-  gIMAPMailbox.subscribed = true;</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-  gIMAPMailbox.specialUseFlag = &quot;\\Inbox&quot;;</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;[Gmail]&quot;, {flags : [&quot;\\Noselect&quot;], subscribed: true});</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;[Gmail]/All Mail&quot;, {specialUseFlag : &quot;\\AllMail&quot;, subscribed: true});</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;[Gmail]/Drafts&quot;, {specialUseFlag : &quot;\\Drafts&quot;, subscribed: true});</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;[Gmail]/Sent&quot;, {specialUseFlag : &quot;\\Sent&quot;, subscribed: true});</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;[Gmail]/Spam&quot;, {specialUseFlag : &quot;\\Spam&quot;, subscribed: true});</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;[Gmail]/Starred&quot;, {specialUseFlag : &quot;\\Starred&quot;, subscribed: true});</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;[Gmail]/Trash&quot;, {specialUseFlag : &quot;\\Trash&quot;, subscribed: true});</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;folder1&quot;, {subscribed : true});</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;folder2&quot;, {subscribed : true});</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineplus">+  IMAPPump.mailbox.subscribed = true;</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+  IMAPPump.mailbox.specialUseFlag = &quot;\\Inbox&quot;;</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;[Gmail]&quot;, {flags : [&quot;\\Noselect&quot;], subscribed: true});</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;[Gmail]/All Mail&quot;, {specialUseFlag : &quot;\\AllMail&quot;, subscribed: true});</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;[Gmail]/Drafts&quot;, {specialUseFlag : &quot;\\Drafts&quot;, subscribed: true});</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;[Gmail]/Sent&quot;, {specialUseFlag : &quot;\\Sent&quot;, subscribed: true});</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;[Gmail]/Spam&quot;, {specialUseFlag : &quot;\\Spam&quot;, subscribed: true});</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;[Gmail]/Starred&quot;, {specialUseFlag : &quot;\\Starred&quot;, subscribed: true});</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;[Gmail]/Trash&quot;, {specialUseFlag : &quot;\\Trash&quot;, subscribed: true});</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;folder1&quot;, {subscribed : true});</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;folder2&quot;, {subscribed : true});</span>
<a href="#l15.34"></a><span id="l15.34"> </span>
<a href="#l15.35"></a><span id="l15.35">   // select the inbox to force folder discovery, etc.</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+  IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l15.38"></a><span id="l15.38"> </span>
<a href="#l15.39"></a><span id="l15.39">   yield false;</span>
<a href="#l15.40"></a><span id="l15.40"> }</span>
<a href="#l15.41"></a><span id="l15.41"> </span>
<a href="#l15.42"></a><span id="l15.42"> /**</span>
<a href="#l15.43"></a><span id="l15.43">  * Test that folders generally are marked for offline use by default.</span>
<a href="#l15.44"></a><span id="l15.44">  */</span>
<a href="#l15.45"></a><span id="l15.45"> function testGeneralFoldersOffline() {</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineminus">-  do_check_true(gIMAPInbox.getFlag(Ci.nsMsgFolderFlags.Offline));</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineplus">+  do_check_true(IMAPPump.inbox.getFlag(Ci.nsMsgFolderFlags.Offline));</span>
<a href="#l15.48"></a><span id="l15.48"> </span>
<a href="#l15.49"></a><span id="l15.49" class="difflineminus">-  let gmail = gIMAPIncomingServer.rootFolder.getChildNamed(&quot;[Gmail]&quot;);</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineplus">+  let gmail = IMAPPump.incomingServer.rootFolder.getChildNamed(&quot;[Gmail]&quot;);</span>
<a href="#l15.51"></a><span id="l15.51"> </span>
<a href="#l15.52"></a><span id="l15.52">   let allmail = gmail.getFolderWithFlags(Ci.nsMsgFolderFlags.Archive);</span>
<a href="#l15.53"></a><span id="l15.53">   do_check_true(allmail.getFlag(Ci.nsMsgFolderFlags.Offline));</span>
<a href="#l15.54"></a><span id="l15.54"> </span>
<a href="#l15.55"></a><span id="l15.55">   let drafts = gmail.getFolderWithFlags(Ci.nsMsgFolderFlags.Drafts);</span>
<a href="#l15.56"></a><span id="l15.56">   do_check_true(drafts.getFlag(Ci.nsMsgFolderFlags.Offline));</span>
<a href="#l15.57"></a><span id="l15.57"> </span>
<a href="#l15.58"></a><span id="l15.58">   let sent = gmail.getFolderWithFlags(Ci.nsMsgFolderFlags.SentMail);</span>
<a href="#l15.59"></a><span id="l15.59">   do_check_true(sent.getFlag(Ci.nsMsgFolderFlags.Offline));</span>
<a href="#l15.60"></a><span id="l15.60"> </span>
<a href="#l15.61"></a><span id="l15.61" class="difflineminus">-  let rootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineplus">+  let rootFolder = IMAPPump.incomingServer.rootFolder;</span>
<a href="#l15.63"></a><span id="l15.63"> </span>
<a href="#l15.64"></a><span id="l15.64">   let folder1 =  rootFolder.getChildNamed(&quot;folder1&quot;);</span>
<a href="#l15.65"></a><span id="l15.65">   do_check_true(folder1.getFlag(Ci.nsMsgFolderFlags.Offline));</span>
<a href="#l15.66"></a><span id="l15.66"> </span>
<a href="#l15.67"></a><span id="l15.67">   let folder2 =  rootFolder.getChildNamed(&quot;folder2&quot;);</span>
<a href="#l15.68"></a><span id="l15.68">   do_check_true(folder2.getFlag(Ci.nsMsgFolderFlags.Offline));</span>
<a href="#l15.69"></a><span id="l15.69"> </span>
<a href="#l15.70"></a><span id="l15.70">   yield true;</span>
<a href="#l15.71"></a><span id="l15.71"> }</span>
<a href="#l15.72"></a><span id="l15.72"> </span>
<a href="#l15.73"></a><span id="l15.73"> /**</span>
<a href="#l15.74"></a><span id="l15.74">  * Test that Trash isn't flagged for offline use by default.</span>
<a href="#l15.75"></a><span id="l15.75">  */</span>
<a href="#l15.76"></a><span id="l15.76"> function testTrashNotOffline() {</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineminus">-  let gmail = gIMAPIncomingServer.rootFolder.getChildNamed(&quot;[Gmail]&quot;);</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineplus">+  let gmail = IMAPPump.incomingServer.rootFolder.getChildNamed(&quot;[Gmail]&quot;);</span>
<a href="#l15.79"></a><span id="l15.79">   let trash = gmail.getFolderWithFlags(Ci.nsMsgFolderFlags.Trash);</span>
<a href="#l15.80"></a><span id="l15.80">   do_check_false(trash.getFlag(Ci.nsMsgFolderFlags.Offline));</span>
<a href="#l15.81"></a><span id="l15.81">   yield true;</span>
<a href="#l15.82"></a><span id="l15.82"> }</span>
<a href="#l15.83"></a><span id="l15.83"> </span>
<a href="#l15.84"></a><span id="l15.84"> /**</span>
<a href="#l15.85"></a><span id="l15.85">  * Test that Junk isn't flagged for offline use by default.</span>
<a href="#l15.86"></a><span id="l15.86">  */</span>
<a href="#l15.87"></a><span id="l15.87"> function testJunkNotOffline() {</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineminus">-  let gmail = gIMAPIncomingServer.rootFolder.getChildNamed(&quot;[Gmail]&quot;);</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineplus">+  let gmail = IMAPPump.incomingServer.rootFolder.getChildNamed(&quot;[Gmail]&quot;);</span>
<a href="#l15.90"></a><span id="l15.90">   let spam = gmail.getFolderWithFlags(Ci.nsMsgFolderFlags.Junk);</span>
<a href="#l15.91"></a><span id="l15.91">   do_check_false(spam.getFlag(Ci.nsMsgFolderFlags.Offline));</span>
<a href="#l15.92"></a><span id="l15.92">   yield true;</span>
<a href="#l15.93"></a><span id="l15.93"> }</span>
<a href="#l15.94"></a><span id="l15.94"> </span>
<a href="#l15.95"></a><span id="l15.95"> /** Cleanup at the end. */</span>
<a href="#l15.96"></a><span id="l15.96"> function teardown() {</span>
<a href="#l15.97"></a><span id="l15.97">   teardownIMAPPump();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_gmailAttributes.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_gmailAttributes.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -27,63 +27,63 @@ Components.utils.import(&quot;resource://gre/</span>
<a href="#l16.4"></a><span id="l16.4"> const gMessage = &quot;bugmail10&quot;; // message file used as the test message</span>
<a href="#l16.5"></a><span id="l16.5"> </span>
<a href="#l16.6"></a><span id="l16.6"> const gXGmMsgid = &quot;1278455344230334865&quot;;</span>
<a href="#l16.7"></a><span id="l16.7"> const gXGmThrid = &quot;1266894439832287888&quot;;</span>
<a href="#l16.8"></a><span id="l16.8"> const gXGmLabels = '(\\Inbox \\Sent Important &quot;Muy Importante&quot; foo)';</span>
<a href="#l16.9"></a><span id="l16.9"> </span>
<a href="#l16.10"></a><span id="l16.10"> setupIMAPPump(&quot;GMail&quot;);</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-gIMAPMailbox.specialUseFlag = &quot;\\Inbox&quot;;</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-gIMAPMailbox.subscribed = true;</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+IMAPPump.mailbox.specialUseFlag = &quot;\\Inbox&quot;;</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+IMAPPump.mailbox.subscribed = true;</span>
<a href="#l16.16"></a><span id="l16.16"> </span>
<a href="#l16.17"></a><span id="l16.17"> // need all mail folder to identify this as gmail server.</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineminus">-gIMAPDaemon.createMailbox(&quot;[Gmail]&quot;, {flags : [&quot;\\NoSelect&quot;] });</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineminus">-gIMAPDaemon.createMailbox(&quot;[Gmail]/All Mail&quot;, {subscribed : true,</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineplus">+IMAPPump.daemon.createMailbox(&quot;[Gmail]&quot;, {flags : [&quot;\\NoSelect&quot;] });</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineplus">+IMAPPump.daemon.createMailbox(&quot;[Gmail]/All Mail&quot;, {subscribed : true,</span>
<a href="#l16.22"></a><span id="l16.22">                                                specialUseFlag : &quot;\\AllMail&quot;});</span>
<a href="#l16.23"></a><span id="l16.23"> </span>
<a href="#l16.24"></a><span id="l16.24"> // Definition of tests</span>
<a href="#l16.25"></a><span id="l16.25"> var tests = [</span>
<a href="#l16.26"></a><span id="l16.26">   loadImapMessage,</span>
<a href="#l16.27"></a><span id="l16.27">   testFetchXGmMsgid,</span>
<a href="#l16.28"></a><span id="l16.28">   testFetchXGmThrid,</span>
<a href="#l16.29"></a><span id="l16.29">   testFetchXGmLabels,</span>
<a href="#l16.30"></a><span id="l16.30">   endTest</span>
<a href="#l16.31"></a><span id="l16.31"> ]</span>
<a href="#l16.32"></a><span id="l16.32"> </span>
<a href="#l16.33"></a><span id="l16.33"> // load and update a message in the imap fake server</span>
<a href="#l16.34"></a><span id="l16.34"> function loadImapMessage()</span>
<a href="#l16.35"></a><span id="l16.35"> {</span>
<a href="#l16.36"></a><span id="l16.36">   let message = new imapMessage(specForFileName(gMessage),</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineminus">-                                gIMAPMailbox.uidnext++, []);</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineplus">+                                IMAPPump.mailbox.uidnext++, []);</span>
<a href="#l16.39"></a><span id="l16.39">   message.xGmMsgid = gXGmMsgid;</span>
<a href="#l16.40"></a><span id="l16.40">   message.xGmThrid = gXGmThrid;</span>
<a href="#l16.41"></a><span id="l16.41">   message.xGmLabels = gXGmLabels;</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineminus">-  gIMAPMailbox.addMessage(message);</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineplus">+  IMAPPump.mailbox.addMessage(message);</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineplus">+  IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l16.46"></a><span id="l16.46">   yield false;</span>
<a href="#l16.47"></a><span id="l16.47"> }</span>
<a href="#l16.48"></a><span id="l16.48"> </span>
<a href="#l16.49"></a><span id="l16.49"> function testFetchXGmMsgid()</span>
<a href="#l16.50"></a><span id="l16.50"> {</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineminus">-  let msgHdr = mailTestUtils.firstMsgHdr(gIMAPInbox);</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineplus">+  let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l16.53"></a><span id="l16.53">   let val = msgHdr.getStringProperty(&quot;X-GM-MSGID&quot;);</span>
<a href="#l16.54"></a><span id="l16.54">   do_check_eq(val, gXGmMsgid);</span>
<a href="#l16.55"></a><span id="l16.55"> }</span>
<a href="#l16.56"></a><span id="l16.56"> </span>
<a href="#l16.57"></a><span id="l16.57"> function testFetchXGmThrid()</span>
<a href="#l16.58"></a><span id="l16.58"> {</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineminus">-  let msgHdr = mailTestUtils.firstMsgHdr(gIMAPInbox);</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+  let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l16.61"></a><span id="l16.61">   let val = msgHdr.getStringProperty(&quot;X-GM-THRID&quot;);</span>
<a href="#l16.62"></a><span id="l16.62">   do_check_eq(val, gXGmThrid);</span>
<a href="#l16.63"></a><span id="l16.63"> }</span>
<a href="#l16.64"></a><span id="l16.64"> </span>
<a href="#l16.65"></a><span id="l16.65"> function testFetchXGmLabels()</span>
<a href="#l16.66"></a><span id="l16.66"> {</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineminus">-  let msgHdr = mailTestUtils.firstMsgHdr(gIMAPInbox);</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineplus">+  let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l16.69"></a><span id="l16.69">   let val = msgHdr.getStringProperty(&quot;X-GM-LABELS&quot;);</span>
<a href="#l16.70"></a><span id="l16.70">    // We need to remove the starting &quot;(&quot; and ending &quot;)&quot; from gXGmLabels while comparing</span>
<a href="#l16.71"></a><span id="l16.71">   do_check_eq(val, gXGmLabels.substring(1 ,gXGmLabels.length - 1));</span>
<a href="#l16.72"></a><span id="l16.72"> }</span>
<a href="#l16.73"></a><span id="l16.73"> </span>
<a href="#l16.74"></a><span id="l16.74"> // Cleanup at end</span>
<a href="#l16.75"></a><span id="l16.75"> function endTest()</span>
<a href="#l16.76"></a><span id="l16.76"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_gmailOfflineMsgStore.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_gmailOfflineMsgStore.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -69,68 +69,68 @@ var tests = [</span>
<a href="#l17.4"></a><span id="l17.4"> function setup() {</span>
<a href="#l17.5"></a><span id="l17.5">   // We aren't interested in downloading messages automatically</span>
<a href="#l17.6"></a><span id="l17.6">   Services.prefs.setBoolPref(&quot;mail.server.server1.autosync_offline_stores&quot;, false);</span>
<a href="#l17.7"></a><span id="l17.7">   Services.prefs.setBoolPref(&quot;mail.server.server1.offline_download&quot;, true);</span>
<a href="#l17.8"></a><span id="l17.8">   Services.prefs.setBoolPref(&quot;mail.biff.alert.show_preview&quot;, false);</span>
<a href="#l17.9"></a><span id="l17.9"> </span>
<a href="#l17.10"></a><span id="l17.10">   setupIMAPPump(&quot;GMail&quot;);</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-  gIMAPMailbox.specialUseFlag = &quot;\\Inbox&quot;;</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-  gIMAPMailbox.subscribed = true;</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+  IMAPPump.mailbox.specialUseFlag = &quot;\\Inbox&quot;;</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+  IMAPPump.mailbox.subscribed = true;</span>
<a href="#l17.16"></a><span id="l17.16"> </span>
<a href="#l17.17"></a><span id="l17.17">   // need all mail folder to identify this as gmail server.</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;[Gmail]&quot;, {flags : [&quot;\\NoSelect&quot;] });</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;[Gmail]/All Mail&quot;, {subscribed : true,</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;[Gmail]&quot;, {flags : [&quot;\\NoSelect&quot;] });</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;[Gmail]/All Mail&quot;, {subscribed : true,</span>
<a href="#l17.22"></a><span id="l17.22">                                                  specialUseFlag : &quot;\\AllMail&quot;});</span>
<a href="#l17.23"></a><span id="l17.23"> </span>
<a href="#l17.24"></a><span id="l17.24">   // Creating the mailbox &quot;foo&quot;</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;foo&quot;, {subscribed : true});</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineminus">-  fooBox = gIMAPDaemon.getMailbox(&quot;foo&quot;);</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;foo&quot;, {subscribed : true});</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineplus">+  fooBox = IMAPPump.daemon.getMailbox(&quot;foo&quot;);</span>
<a href="#l17.29"></a><span id="l17.29"> </span>
<a href="#l17.30"></a><span id="l17.30">   // Add message1 to inbox.</span>
<a href="#l17.31"></a><span id="l17.31">   let message = new imapMessage(specForFileName(gMessage1),</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineminus">-                            gIMAPMailbox.uidnext++, []);</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+                            IMAPPump.mailbox.uidnext++, []);</span>
<a href="#l17.34"></a><span id="l17.34">   message.messageId = gMsgId1;</span>
<a href="#l17.35"></a><span id="l17.35">   message.xGmMsgid = gXGmMsgid1;</span>
<a href="#l17.36"></a><span id="l17.36">   message.xGmThrid = gXGmThrid1;</span>
<a href="#l17.37"></a><span id="l17.37">   message.xGmLabels = gXGmLabels11; // With labels excluding &quot;//INBOX&quot;</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineminus">-  gIMAPMailbox.addMessage(message);</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+  IMAPPump.mailbox.addMessage(message);</span>
<a href="#l17.40"></a><span id="l17.40"> }</span>
<a href="#l17.41"></a><span id="l17.41"> </span>
<a href="#l17.42"></a><span id="l17.42"> function updateFolder() {</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineplus">+  IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l17.45"></a><span id="l17.45">   yield false;</span>
<a href="#l17.46"></a><span id="l17.46"> }</span>
<a href="#l17.47"></a><span id="l17.47"> </span>
<a href="#l17.48"></a><span id="l17.48"> function selectInboxMsg() {</span>
<a href="#l17.49"></a><span id="l17.49">   // Select mesasage1 from inbox which makes message1 available in offline store.</span>
<a href="#l17.50"></a><span id="l17.50">   let imapService = Cc[&quot;@mozilla.org/messenger/messageservice;1?type=imap&quot;]</span>
<a href="#l17.51"></a><span id="l17.51">                         .getService(Ci.nsIMsgMessageService);</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineminus">-  let db = gIMAPInbox.msgDatabase;</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineplus">+  let db = IMAPPump.inbox.msgDatabase;</span>
<a href="#l17.54"></a><span id="l17.54">   let msg1 = db.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l17.55"></a><span id="l17.55">   let url = new Object;</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineminus">-  imapService.DisplayMessage(gIMAPInbox.getUriForMsg(msg1), streamListener,</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineplus">+  imapService.DisplayMessage(IMAPPump.inbox.getUriForMsg(msg1), streamListener,</span>
<a href="#l17.58"></a><span id="l17.58">                              null, asyncUrlListener, null, url);</span>
<a href="#l17.59"></a><span id="l17.59">   yield false;</span>
<a href="#l17.60"></a><span id="l17.60"> }</span>
<a href="#l17.61"></a><span id="l17.61"> </span>
<a href="#l17.62"></a><span id="l17.62"> function StreamMessageInbox() {</span>
<a href="#l17.63"></a><span id="l17.63">   // Stream message1 from inbox</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineminus">-  let newMsgHdr = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineplus">+  let newMsgHdr = IMAPPump.inbox.msgDatabase.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l17.66"></a><span id="l17.66">   let msgURI = newMsgHdr.folder.getUriForMsg(newMsgHdr);</span>
<a href="#l17.67"></a><span id="l17.67">   let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l17.68"></a><span id="l17.68">   let msgServ = messenger.messageServiceFromURI(msgURI);</span>
<a href="#l17.69"></a><span id="l17.69">   msgServ.streamMessage(msgURI, gStreamListener, null, null, false, &quot;&quot;, false);</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineminus">-  gImapInboxOfflineStoreSizeInitial = gIMAPInbox.filePath.fileSize; // Initial Size of Inbox</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineplus">+  gImapInboxOfflineStoreSizeInitial = IMAPPump.inbox.filePath.fileSize; // Initial Size of Inbox</span>
<a href="#l17.72"></a><span id="l17.72">   yield false;</span>
<a href="#l17.73"></a><span id="l17.73"> }</span>
<a href="#l17.74"></a><span id="l17.74"> </span>
<a href="#l17.75"></a><span id="l17.75"> function createAndUpdate() {</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineminus">-  let rootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineplus">+  let rootFolder = IMAPPump.incomingServer.rootFolder;</span>
<a href="#l17.78"></a><span id="l17.78">   fooFolder =  rootFolder.getChildNamed(&quot;foo&quot;).QueryInterface(Ci.nsIMsgImapMailFolder); // We have created the mailbox earlier.</span>
<a href="#l17.79"></a><span id="l17.79">   fooFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l17.80"></a><span id="l17.80">   yield false;</span>
<a href="#l17.81"></a><span id="l17.81"> }</span>
<a href="#l17.82"></a><span id="l17.82"> </span>
<a href="#l17.83"></a><span id="l17.83"> function addFoo() {</span>
<a href="#l17.84"></a><span id="l17.84">   // Adding our test message</span>
<a href="#l17.85"></a><span id="l17.85">   let message = new imapMessage(specForFileName(gMessage1),</span>
<a href="#l17.86"></a><span id="l17.86" class="difflineat">@@ -188,17 +188,17 @@ function crossStreaming() {</span>
<a href="#l17.87"></a><span id="l17.87">   let msg2 = fooFolder.msgDatabase.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l17.88"></a><span id="l17.88">   do_check_neq(msg2, null);</span>
<a href="#l17.89"></a><span id="l17.89">   let msgURI = fooFolder.getUriForMsg(msg2);</span>
<a href="#l17.90"></a><span id="l17.90">   let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l17.91"></a><span id="l17.91">   let msgServ = messenger.messageServiceFromURI(msgURI);</span>
<a href="#l17.92"></a><span id="l17.92">   // pass true for aLocalOnly since message should be in offline store of Inbox.</span>
<a href="#l17.93"></a><span id="l17.93">   msgServ.streamMessage(msgURI, gStreamListener, null, null, false, &quot;&quot;, true);</span>
<a href="#l17.94"></a><span id="l17.94">   gFooOfflineStoreSizeFinal = fooFolder.filePath.fileSize;</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineminus">-  gImapInboxOfflineStoreSizeFinal = gIMAPInbox.filePath.fileSize;</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineplus">+  gImapInboxOfflineStoreSizeFinal = IMAPPump.inbox.filePath.fileSize;</span>
<a href="#l17.97"></a><span id="l17.97">   do_check_eq(gFooOfflineStoreSizeFinal, gFooOfflineStoreSizeInitial);</span>
<a href="#l17.98"></a><span id="l17.98">   do_check_eq(gImapInboxOfflineStoreSizeFinal,gImapInboxOfflineStoreSizeInitial);</span>
<a href="#l17.99"></a><span id="l17.99">   yield false;</span>
<a href="#l17.100"></a><span id="l17.100"> }</span>
<a href="#l17.101"></a><span id="l17.101"> </span>
<a href="#l17.102"></a><span id="l17.102"> function teardown() {</span>
<a href="#l17.103"></a><span id="l17.103">   teardownIMAPPump();</span>
<a href="#l17.104"></a><span id="l17.104"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapAttachmentSaves.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapAttachmentSaves.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -20,17 +20,17 @@ load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l18.4"></a><span id="l18.4"> </span>
<a href="#l18.5"></a><span id="l18.5"> const kAttachFileName = 'bob.txt';</span>
<a href="#l18.6"></a><span id="l18.6"> </span>
<a href="#l18.7"></a><span id="l18.7"> setupIMAPPump();</span>
<a href="#l18.8"></a><span id="l18.8"> </span>
<a href="#l18.9"></a><span id="l18.9"> // Dummy message window so we can say the inbox is open in a window.</span>
<a href="#l18.10"></a><span id="l18.10"> var dummyMsgWindow =</span>
<a href="#l18.11"></a><span id="l18.11"> {</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-  openFolder : gIMAPInbox,</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+  openFolder : IMAPPump.inbox,</span>
<a href="#l18.14"></a><span id="l18.14">   QueryInterface: XPCOMUtils.generateQI([Ci.nsIMsgWindow,</span>
<a href="#l18.15"></a><span id="l18.15">                                          Ci.nsISupportsWeakReference])</span>
<a href="#l18.16"></a><span id="l18.16">   </span>
<a href="#l18.17"></a><span id="l18.17"> };</span>
<a href="#l18.18"></a><span id="l18.18"> </span>
<a href="#l18.19"></a><span id="l18.19"> var tests = [</span>
<a href="#l18.20"></a><span id="l18.20">   loadImapMessage,</span>
<a href="#l18.21"></a><span id="l18.21">   startMime,</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineat">@@ -49,42 +49,42 @@ function loadImapMessage()</span>
<a href="#l18.23"></a><span id="l18.23">       {filename: kAttachFileName, body: 'I like cheese!'}</span>
<a href="#l18.24"></a><span id="l18.24">     ],</span>
<a href="#l18.25"></a><span id="l18.25">   });</span>
<a href="#l18.26"></a><span id="l18.26"> </span>
<a href="#l18.27"></a><span id="l18.27">   let msgURI =</span>
<a href="#l18.28"></a><span id="l18.28">     Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l18.29"></a><span id="l18.29">                        btoa(smsg.toMessageString()),</span>
<a href="#l18.30"></a><span id="l18.30">                        null, null);</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineminus">-  let imapInbox = gIMAPDaemon.getMailbox(&quot;INBOX&quot;);</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+  let imapInbox = IMAPPump.daemon.getMailbox(&quot;INBOX&quot;);</span>
<a href="#l18.33"></a><span id="l18.33">   let message = new imapMessage(msgURI.spec, imapInbox.uidnext++, []);</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineminus">-  gIMAPMailbox.addMessage(message);</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineplus">+  IMAPPump.mailbox.addMessage(message);</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineplus">+  IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l18.38"></a><span id="l18.38">   yield false;</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineminus">-  do_check_eq(1, gIMAPInbox.getTotalMessages(false));</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineminus">-  let msgHdr = mailTestUtils.firstMsgHdr(gIMAPInbox);</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineplus">+  do_check_eq(1, IMAPPump.inbox.getTotalMessages(false));</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineplus">+  let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l18.43"></a><span id="l18.43">   do_check_true(msgHdr instanceof Ci.nsIMsgDBHdr);</span>
<a href="#l18.44"></a><span id="l18.44"> </span>
<a href="#l18.45"></a><span id="l18.45">   yield true;</span>
<a href="#l18.46"></a><span id="l18.46"> }</span>
<a href="#l18.47"></a><span id="l18.47"> </span>
<a href="#l18.48"></a><span id="l18.48"> // process the message through mime</span>
<a href="#l18.49"></a><span id="l18.49"> function startMime()</span>
<a href="#l18.50"></a><span id="l18.50"> {</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineminus">-  let msgHdr = mailTestUtils.firstMsgHdr(gIMAPInbox);</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineplus">+  let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l18.53"></a><span id="l18.53"> </span>
<a href="#l18.54"></a><span id="l18.54">   mimeMsg.MsgHdrToMimeMessage(msgHdr, gCallbackObject, gCallbackObject.callback,</span>
<a href="#l18.55"></a><span id="l18.55">                               true /* allowDownload */);</span>
<a href="#l18.56"></a><span id="l18.56">   yield false;</span>
<a href="#l18.57"></a><span id="l18.57"> }</span>
<a href="#l18.58"></a><span id="l18.58"> </span>
<a href="#l18.59"></a><span id="l18.59"> // detach any found attachments</span>
<a href="#l18.60"></a><span id="l18.60"> function startDetach()</span>
<a href="#l18.61"></a><span id="l18.61"> {</span>
<a href="#l18.62"></a><span id="l18.62" class="difflineminus">-  let msgHdr = mailTestUtils.firstMsgHdr(gIMAPInbox);</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineplus">+  let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l18.64"></a><span id="l18.64">   let msgURI = msgHdr.folder.generateMessageURI(msgHdr.messageKey);</span>
<a href="#l18.65"></a><span id="l18.65"> </span>
<a href="#l18.66"></a><span id="l18.66">   let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l18.67"></a><span id="l18.67">   let attachment = gCallbackObject.attachments[0];</span>
<a href="#l18.68"></a><span id="l18.68"> </span>
<a href="#l18.69"></a><span id="l18.69">   messenger.detachAttachmentsWOPrompts(gProfileDir, 1,</span>
<a href="#l18.70"></a><span id="l18.70">                                        [attachment.contentType], [attachment.url],</span>
<a href="#l18.71"></a><span id="l18.71">                                        [attachment.name], [msgURI], null);</span>
<a href="#l18.72"></a><span id="l18.72" class="difflineat">@@ -103,17 +103,17 @@ function testDetach()</span>
<a href="#l18.73"></a><span id="l18.73">   let checkFile = gProfileDir.clone();</span>
<a href="#l18.74"></a><span id="l18.74">   checkFile.append(kAttachFileName);</span>
<a href="#l18.75"></a><span id="l18.75">   do_check_true(checkFile.exists());</span>
<a href="#l18.76"></a><span id="l18.76"> </span>
<a href="#l18.77"></a><span id="l18.77">   // The message should now have a detached attachment. Read the message,</span>
<a href="#l18.78"></a><span id="l18.78">   //  and search for &quot;AttachmentDetached&quot; which is added on detachment.</span>
<a href="#l18.79"></a><span id="l18.79"> </span>
<a href="#l18.80"></a><span id="l18.80">   // Get the message header - detached copy has UID 2.</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineminus">-  let msgHdr = gIMAPInbox.GetMessageHeader(2);</span>
<a href="#l18.82"></a><span id="l18.82" class="difflineplus">+  let msgHdr = IMAPPump.inbox.GetMessageHeader(2);</span>
<a href="#l18.83"></a><span id="l18.83">   do_check_neq(msgHdr, null);</span>
<a href="#l18.84"></a><span id="l18.84">   let messageContent = getContentFromMessage(msgHdr);</span>
<a href="#l18.85"></a><span id="l18.85">   do_check_true(messageContent.contains(&quot;AttachmentDetached&quot;));</span>
<a href="#l18.86"></a><span id="l18.86"> }</span>
<a href="#l18.87"></a><span id="l18.87"> </span>
<a href="#l18.88"></a><span id="l18.88"> // Cleanup</span>
<a href="#l18.89"></a><span id="l18.89"> function endTest()</span>
<a href="#l18.90"></a><span id="l18.90"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapAutoSync.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapAutoSync.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -59,62 +59,62 @@ var tests = [</span>
<a href="#l19.4"></a><span id="l19.4"> ]</span>
<a href="#l19.5"></a><span id="l19.5"> </span>
<a href="#l19.6"></a><span id="l19.6"> let gTargetFolder;</span>
<a href="#l19.7"></a><span id="l19.7"> </span>
<a href="#l19.8"></a><span id="l19.8"> function test_createTargetFolder()</span>
<a href="#l19.9"></a><span id="l19.9"> {</span>
<a href="#l19.10"></a><span id="l19.10">   gAutoSyncManager.addListener(gAutoSyncListener);</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-  gIMAPIncomingServer.rootFolder.createSubfolder(&quot;targetFolder&quot;, null);</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+  IMAPPump.incomingServer.rootFolder.createSubfolder(&quot;targetFolder&quot;, null);</span>
<a href="#l19.14"></a><span id="l19.14">   yield false;</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineminus">-  gTargetFolder = gIMAPIncomingServer.rootFolder.getChildNamed(&quot;targetFolder&quot;);</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineplus">+  gTargetFolder = IMAPPump.incomingServer.rootFolder.getChildNamed(&quot;targetFolder&quot;);</span>
<a href="#l19.17"></a><span id="l19.17">   do_check_true(gTargetFolder instanceof Ci.nsIMsgImapMailFolder);</span>
<a href="#l19.18"></a><span id="l19.18">   // set folder to be checked for new messages when inbox is checked.</span>
<a href="#l19.19"></a><span id="l19.19">   gTargetFolder.setFlag(Ci.nsMsgFolderFlags.CheckNew);</span>
<a href="#l19.20"></a><span id="l19.20"> }</span>
<a href="#l19.21"></a><span id="l19.21"> </span>
<a href="#l19.22"></a><span id="l19.22"> function test_checkForNewMessages()</span>
<a href="#l19.23"></a><span id="l19.23"> {</span>
<a href="#l19.24"></a><span id="l19.24">   addMessageToFolder(gTargetFolder);</span>
<a href="#l19.25"></a><span id="l19.25">   // This will update the INBOX and STATUS targetFolder. We only care about</span>
<a href="#l19.26"></a><span id="l19.26">   // the latter.</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineminus">-  gIMAPInbox.getNewMessages(null, null);</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineminus">-  gIMAPServer.performTest(&quot;STATUS&quot;);</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineplus">+  IMAPPump.inbox.getNewMessages(null, null);</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineplus">+  IMAPPump.server.performTest(&quot;STATUS&quot;);</span>
<a href="#l19.31"></a><span id="l19.31">   // Now we'd like to make autosync update folders it knows about, to</span>
<a href="#l19.32"></a><span id="l19.32">   // get the initial autosync out of the way.</span>
<a href="#l19.33"></a><span id="l19.33">   yield true;</span>
<a href="#l19.34"></a><span id="l19.34"> }</span>
<a href="#l19.35"></a><span id="l19.35"> </span>
<a href="#l19.36"></a><span id="l19.36"> function test_triggerAutoSyncIdle()</span>
<a href="#l19.37"></a><span id="l19.37"> {</span>
<a href="#l19.38"></a><span id="l19.38">   // wait for both folders to get updated.</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineminus">-  gAutoSyncListener._waitingForDiscoveryList.push(gIMAPInbox);</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineplus">+  gAutoSyncListener._waitingForDiscoveryList.push(IMAPPump.inbox);</span>
<a href="#l19.41"></a><span id="l19.41">   gAutoSyncListener._waitingForDiscoveryList.push(gTargetFolder);</span>
<a href="#l19.42"></a><span id="l19.42">   gAutoSyncListener._waitingForDiscovery = true;</span>
<a href="#l19.43"></a><span id="l19.43">   let observer = gAutoSyncManager.QueryInterface(Ci.nsIObserver);</span>
<a href="#l19.44"></a><span id="l19.44">   observer.observe(null, &quot;mail-startup-done&quot;, &quot;&quot;);</span>
<a href="#l19.45"></a><span id="l19.45">   observer.observe(null, &quot;mail:appIdle&quot;, &quot;idle&quot;);</span>
<a href="#l19.46"></a><span id="l19.46">   // now we expect to hear that targetFolder was updated.</span>
<a href="#l19.47"></a><span id="l19.47">   yield false;</span>
<a href="#l19.48"></a><span id="l19.48"> }</span>
<a href="#l19.49"></a><span id="l19.49"> </span>
<a href="#l19.50"></a><span id="l19.50"> // move the message to a diffent folder</span>
<a href="#l19.51"></a><span id="l19.51"> function test_moveMessageToTargetFolder()</span>
<a href="#l19.52"></a><span id="l19.52"> {</span>
<a href="#l19.53"></a><span id="l19.53">   let observer = gAutoSyncManager.QueryInterface(Ci.nsIObserver);</span>
<a href="#l19.54"></a><span id="l19.54">   observer.observe(null, &quot;mail:appIdle&quot;, &quot;back&quot;);</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineminus">-  let msgHdr = mailTestUtils.firstMsgHdr(gIMAPInbox);</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineplus">+  let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l19.57"></a><span id="l19.57">   do_check_neq(msgHdr, null);</span>
<a href="#l19.58"></a><span id="l19.58"> </span>
<a href="#l19.59"></a><span id="l19.59">   // Now move this message to the target folder.</span>
<a href="#l19.60"></a><span id="l19.60">   let messages = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l19.61"></a><span id="l19.61">                    .createInstance(Ci.nsIMutableArray);</span>
<a href="#l19.62"></a><span id="l19.62">   messages.appendElement(msgHdr, false);</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineminus">-  MailServices.copy.CopyMessages(gIMAPInbox, messages, gTargetFolder, true,</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineplus">+  MailServices.copy.CopyMessages(IMAPPump.inbox, messages, gTargetFolder, true,</span>
<a href="#l19.65"></a><span id="l19.65">                                  CopyListener, null, false);</span>
<a href="#l19.66"></a><span id="l19.66">   yield false;</span>
<a href="#l19.67"></a><span id="l19.67"> }</span>
<a href="#l19.68"></a><span id="l19.68"> </span>
<a href="#l19.69"></a><span id="l19.69"> function test_waitForTargetUpdate()</span>
<a href="#l19.70"></a><span id="l19.70"> {</span>
<a href="#l19.71"></a><span id="l19.71">   // After the copy, now we expect to get notified of the gTargetFolder</span>
<a href="#l19.72"></a><span id="l19.72">   // getting updated, after we simulate going idle.</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineat">@@ -146,17 +146,17 @@ function run_test()</span>
<a href="#l19.74"></a><span id="l19.74"> {</span>
<a href="#l19.75"></a><span id="l19.75">   // Add folder listeners that will capture async events</span>
<a href="#l19.76"></a><span id="l19.76">   const nsIMFNService = Ci.nsIMsgFolderNotificationService;</span>
<a href="#l19.77"></a><span id="l19.77">   let flags =</span>
<a href="#l19.78"></a><span id="l19.78">         nsIMFNService.folderAdded |</span>
<a href="#l19.79"></a><span id="l19.79">         nsIMFNService.msgsMoveCopyCompleted |</span>
<a href="#l19.80"></a><span id="l19.80">         nsIMFNService.msgAdded;</span>
<a href="#l19.81"></a><span id="l19.81">   MailServices.mfn.addListener(mfnListener, flags);</span>
<a href="#l19.82"></a><span id="l19.82" class="difflineminus">-  addMessageToFolder(gIMAPInbox);</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineplus">+  addMessageToFolder(IMAPPump.inbox);</span>
<a href="#l19.84"></a><span id="l19.84"> </span>
<a href="#l19.85"></a><span id="l19.85">   async_run_tests(tests);</span>
<a href="#l19.86"></a><span id="l19.86"> }</span>
<a href="#l19.87"></a><span id="l19.87"> </span>
<a href="#l19.88"></a><span id="l19.88"> // listeners for various events to drive the tests.</span>
<a href="#l19.89"></a><span id="l19.89"> </span>
<a href="#l19.90"></a><span id="l19.90"> mfnListener =</span>
<a href="#l19.91"></a><span id="l19.91"> {</span>
<a href="#l19.92"></a><span id="l19.92" class="difflineat">@@ -283,15 +283,15 @@ function addMessageToFolder(folder)</span>
<a href="#l19.93"></a><span id="l19.93">   let messages = [];</span>
<a href="#l19.94"></a><span id="l19.94">   let gMessageGenerator = new MessageGenerator();</span>
<a href="#l19.95"></a><span id="l19.95">   messages = messages.concat(gMessageGenerator.makeMessage());</span>
<a href="#l19.96"></a><span id="l19.96"> </span>
<a href="#l19.97"></a><span id="l19.97">   let msgURI =</span>
<a href="#l19.98"></a><span id="l19.98">     Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l19.99"></a><span id="l19.99">                        btoa(messages[0].toMessageString()),</span>
<a href="#l19.100"></a><span id="l19.100">                        null, null);</span>
<a href="#l19.101"></a><span id="l19.101" class="difflineminus">-  let imapMailbox =  gIMAPDaemon.getMailbox(folder.name);</span>
<a href="#l19.102"></a><span id="l19.102" class="difflineplus">+  let imapMailbox =  IMAPPump.daemon.getMailbox(folder.name);</span>
<a href="#l19.103"></a><span id="l19.103">   // We add messages with \Seen flag set so that we won't accidentally</span>
<a href="#l19.104"></a><span id="l19.104">   // trigger the code that updates imap folders that have unread messages moved</span>
<a href="#l19.105"></a><span id="l19.105">   // into them.</span>
<a href="#l19.106"></a><span id="l19.106">   gMessage = new imapMessage(msgURI.spec, imapMailbox.uidnext++, [&quot;\\Seen&quot;]);</span>
<a href="#l19.107"></a><span id="l19.107">   imapMailbox.addMessage(gMessage);</span>
<a href="#l19.108"></a><span id="l19.108"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapContentLength.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapContentLength.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -27,40 +27,40 @@ var tests = [</span>
<a href="#l20.4"></a><span id="l20.4">   addMessageToServer,</span>
<a href="#l20.5"></a><span id="l20.5">   verifyContentLength,</span>
<a href="#l20.6"></a><span id="l20.6">   teardown</span>
<a href="#l20.7"></a><span id="l20.7"> ];</span>
<a href="#l20.8"></a><span id="l20.8"> </span>
<a href="#l20.9"></a><span id="l20.9"> // Adds some messages directly to a mailbox (eg new mail)</span>
<a href="#l20.10"></a><span id="l20.10"> function addMessageToServer() {</span>
<a href="#l20.11"></a><span id="l20.11">   let URI = Services.io.newFileURI(gFile).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-  gIMAPMailbox.addMessage(new imapMessage(URI.spec, gIMAPMailbox.uidnext++, []));</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+  IMAPPump.mailbox.addMessage(new imapMessage(URI.spec, IMAPPump.mailbox.uidnext++, []));</span>
<a href="#l20.14"></a><span id="l20.14"> </span>
<a href="#l20.15"></a><span id="l20.15" class="difflineminus">-  gIMAPInbox.updateFolder(null);</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineplus">+  IMAPPump.inbox.updateFolder(null);</span>
<a href="#l20.17"></a><span id="l20.17">   yield false;</span>
<a href="#l20.18"></a><span id="l20.18"> }</span>
<a href="#l20.19"></a><span id="l20.19"> </span>
<a href="#l20.20"></a><span id="l20.20"> var msgFolderListener = {</span>
<a href="#l20.21"></a><span id="l20.21">   msgAdded: function(aMsgHdr) {</span>
<a href="#l20.22"></a><span id="l20.22">     gMsgHdr = aMsgHdr;</span>
<a href="#l20.23"></a><span id="l20.23">     do_execute_soon(async_driver);</span>
<a href="#l20.24"></a><span id="l20.24">   },</span>
<a href="#l20.25"></a><span id="l20.25"> };</span>
<a href="#l20.26"></a><span id="l20.26"> </span>
<a href="#l20.27"></a><span id="l20.27"> function setup() {</span>
<a href="#l20.28"></a><span id="l20.28">   setupIMAPPump();</span>
<a href="#l20.29"></a><span id="l20.29"> </span>
<a href="#l20.30"></a><span id="l20.30">   // Set up nsIMsgFolderListener to get the header when it's received</span>
<a href="#l20.31"></a><span id="l20.31">   MailServices.mfn.addListener(msgFolderListener, MailServices.mfn.msgAdded);</span>
<a href="#l20.32"></a><span id="l20.32"> </span>
<a href="#l20.33"></a><span id="l20.33" class="difflineminus">-  gIMAPInbox.flags &amp;= ~Ci.nsMsgFolderFlags.Offline;</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineplus">+  IMAPPump.inbox.flags &amp;= ~Ci.nsMsgFolderFlags.Offline;</span>
<a href="#l20.35"></a><span id="l20.35"> }</span>
<a href="#l20.36"></a><span id="l20.36"> </span>
<a href="#l20.37"></a><span id="l20.37"> function verifyContentLength() {</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineminus">-  let messageUri = gIMAPInbox.getUriForMsg(gMsgHdr);</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineplus">+  let messageUri = IMAPPump.inbox.getUriForMsg(gMsgHdr);</span>
<a href="#l20.40"></a><span id="l20.40">   // Convert this to a URI that necko can run</span>
<a href="#l20.41"></a><span id="l20.41">   let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l20.42"></a><span id="l20.42">   let neckoURL = {};</span>
<a href="#l20.43"></a><span id="l20.43">   let messageService = messenger.messageServiceFromURI(messageUri);</span>
<a href="#l20.44"></a><span id="l20.44">   messageService.GetUrlForUri(messageUri, neckoURL, null);</span>
<a href="#l20.45"></a><span id="l20.45">   // Don't use the necko URL directly. Instead, get the spec and create a new</span>
<a href="#l20.46"></a><span id="l20.46">   // URL using the IO service</span>
<a href="#l20.47"></a><span id="l20.47">   let urlToRun = Services.io.newURI(neckoURL.value.spec, null, null);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapCopyTimeout.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapCopyTimeout.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -48,60 +48,60 @@ var tests = [</span>
<a href="#l21.4"></a><span id="l21.4">   waitForOfflinePlayback,</span>
<a href="#l21.5"></a><span id="l21.5">   updateTargetFolder,</span>
<a href="#l21.6"></a><span id="l21.6">   endTest</span>
<a href="#l21.7"></a><span id="l21.7"> ]</span>
<a href="#l21.8"></a><span id="l21.8"> </span>
<a href="#l21.9"></a><span id="l21.9"> let gTargetFolder;</span>
<a href="#l21.10"></a><span id="l21.10"> function createTargetFolder()</span>
<a href="#l21.11"></a><span id="l21.11"> {</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-  gIMAPDaemon.copySleep = 5000;</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-  gIMAPIncomingServer.rootFolder.createSubfolder(&quot;targetFolder&quot;, null);</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+  IMAPPump.daemon.copySleep = 5000;</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineplus">+  IMAPPump.incomingServer.rootFolder.createSubfolder(&quot;targetFolder&quot;, null);</span>
<a href="#l21.16"></a><span id="l21.16">   yield false; </span>
<a href="#l21.17"></a><span id="l21.17" class="difflineminus">-  gTargetFolder = gIMAPIncomingServer.rootFolder.getChildNamed(&quot;targetFolder&quot;);</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineplus">+  gTargetFolder = IMAPPump.incomingServer.rootFolder.getChildNamed(&quot;targetFolder&quot;);</span>
<a href="#l21.19"></a><span id="l21.19">   do_check_true(gTargetFolder instanceof Ci.nsIMsgImapMailFolder);</span>
<a href="#l21.20"></a><span id="l21.20">   gTargetFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l21.21"></a><span id="l21.21">   yield false;</span>
<a href="#l21.22"></a><span id="l21.22"> }  </span>
<a href="#l21.23"></a><span id="l21.23"> </span>
<a href="#l21.24"></a><span id="l21.24"> // load and update a message in the imap fake server</span>
<a href="#l21.25"></a><span id="l21.25"> function loadImapMessage()</span>
<a href="#l21.26"></a><span id="l21.26"> {</span>
<a href="#l21.27"></a><span id="l21.27">   let messages = [];</span>
<a href="#l21.28"></a><span id="l21.28">   let gMessageGenerator = new MessageGenerator();</span>
<a href="#l21.29"></a><span id="l21.29">   messages = messages.concat(gMessageGenerator.makeMessage());</span>
<a href="#l21.30"></a><span id="l21.30"> </span>
<a href="#l21.31"></a><span id="l21.31">   let msgURI =</span>
<a href="#l21.32"></a><span id="l21.32">     Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l21.33"></a><span id="l21.33">                        btoa(messages[0].toMessageString()),</span>
<a href="#l21.34"></a><span id="l21.34">                        null, null);</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineminus">-  let imapInbox = gIMAPDaemon.getMailbox(&quot;INBOX&quot;);</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineplus">+  let imapInbox = IMAPPump.daemon.getMailbox(&quot;INBOX&quot;);</span>
<a href="#l21.37"></a><span id="l21.37">   gMessage = new imapMessage(msgURI.spec, imapInbox.uidnext++, []);</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineminus">-  gIMAPMailbox.addMessage(gMessage);</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineminus">-  gIMAPInbox.updateFolder(null);</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineplus">+  IMAPPump.mailbox.addMessage(gMessage);</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineplus">+  IMAPPump.inbox.updateFolder(null);</span>
<a href="#l21.42"></a><span id="l21.42">   yield false;</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineminus">-  do_check_eq(1, gIMAPInbox.getTotalMessages(false));</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineminus">-  let msgHdr = mailTestUtils.firstMsgHdr(gIMAPInbox);</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineplus">+  do_check_eq(1, IMAPPump.inbox.getTotalMessages(false));</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineplus">+  let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l21.47"></a><span id="l21.47">   do_check_true(msgHdr instanceof Ci.nsIMsgDBHdr);</span>
<a href="#l21.48"></a><span id="l21.48"> </span>
<a href="#l21.49"></a><span id="l21.49">   yield true;</span>
<a href="#l21.50"></a><span id="l21.50"> }</span>
<a href="#l21.51"></a><span id="l21.51"> </span>
<a href="#l21.52"></a><span id="l21.52"> // move the message to a diffent folder</span>
<a href="#l21.53"></a><span id="l21.53"> function moveMessageToTargetFolder()</span>
<a href="#l21.54"></a><span id="l21.54"> {</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineminus">-  let msgHdr = mailTestUtils.firstMsgHdr(gIMAPInbox);</span>
<a href="#l21.56"></a><span id="l21.56" class="difflineplus">+  let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l21.57"></a><span id="l21.57"> </span>
<a href="#l21.58"></a><span id="l21.58">   // Now move this message to the target folder.</span>
<a href="#l21.59"></a><span id="l21.59">   var messages = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l21.60"></a><span id="l21.60">                    .createInstance(Ci.nsIMutableArray);</span>
<a href="#l21.61"></a><span id="l21.61">   messages.appendElement(msgHdr, false);</span>
<a href="#l21.62"></a><span id="l21.62">   // This should cause the move to be done as an offline imap operation</span>
<a href="#l21.63"></a><span id="l21.63">   // that's played back immediately.</span>
<a href="#l21.64"></a><span id="l21.64" class="difflineminus">-  MailServices.copy.CopyMessages(gIMAPInbox, messages, gTargetFolder, true,</span>
<a href="#l21.65"></a><span id="l21.65" class="difflineplus">+  MailServices.copy.CopyMessages(IMAPPump.inbox, messages, gTargetFolder, true,</span>
<a href="#l21.66"></a><span id="l21.66">                                  CopyListener, gDummyMsgWindow, true);</span>
<a href="#l21.67"></a><span id="l21.67">   yield false;</span>
<a href="#l21.68"></a><span id="l21.68"> }</span>
<a href="#l21.69"></a><span id="l21.69"> </span>
<a href="#l21.70"></a><span id="l21.70"> function waitForOfflinePlayback()</span>
<a href="#l21.71"></a><span id="l21.71"> {</span>
<a href="#l21.72"></a><span id="l21.72">   // just wait for the alert about timed out connection.</span>
<a href="#l21.73"></a><span id="l21.73">   yield false;</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineat">@@ -116,17 +116,17 @@ function updateTargetFolder()</span>
<a href="#l21.75"></a><span id="l21.75">   yield false;</span>
<a href="#l21.76"></a><span id="l21.76"> }</span>
<a href="#l21.77"></a><span id="l21.77"> </span>
<a href="#l21.78"></a><span id="l21.78"> // Cleanup</span>
<a href="#l21.79"></a><span id="l21.79"> function endTest()</span>
<a href="#l21.80"></a><span id="l21.80"> {</span>
<a href="#l21.81"></a><span id="l21.81">   do_check_true(gGotAlert);</span>
<a href="#l21.82"></a><span id="l21.82">   // Make sure neither source nor target folder have offline events.</span>
<a href="#l21.83"></a><span id="l21.83" class="difflineminus">-  do_check_false(gIMAPInbox.getFlag(Ci.nsMsgFolderFlags.OfflineEvents));</span>
<a href="#l21.84"></a><span id="l21.84" class="difflineplus">+  do_check_false(IMAPPump.inbox.getFlag(Ci.nsMsgFolderFlags.OfflineEvents));</span>
<a href="#l21.85"></a><span id="l21.85">   do_check_false(gTargetFolder.getFlag(Ci.nsMsgFolderFlags.OfflineEvents));</span>
<a href="#l21.86"></a><span id="l21.86"> </span>
<a href="#l21.87"></a><span id="l21.87">   // fake server does the copy, but then times out, so make sure the target</span>
<a href="#l21.88"></a><span id="l21.88">   // folder has only 1 message, not the multiple ones it would have if we</span>
<a href="#l21.89"></a><span id="l21.89">   // retried.</span>
<a href="#l21.90"></a><span id="l21.90">   do_check_eq(gTargetFolder.getTotalMessages(false), 1);</span>
<a href="#l21.91"></a><span id="l21.91">   teardownIMAPPump();</span>
<a href="#l21.92"></a><span id="l21.92"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapFlagChange.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapFlagChange.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -11,123 +11,123 @@ load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l22.4"></a><span id="l22.4"> </span>
<a href="#l22.5"></a><span id="l22.5"> var gMessage;</span>
<a href="#l22.6"></a><span id="l22.6"> var gSecondFolder;</span>
<a href="#l22.7"></a><span id="l22.7"> var gSynthMessage;</span>
<a href="#l22.8"></a><span id="l22.8"> </span>
<a href="#l22.9"></a><span id="l22.9"> var tests = [</span>
<a href="#l22.10"></a><span id="l22.10">   setup,</span>
<a href="#l22.11"></a><span id="l22.11">   function switchAwayFromInbox() {</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-    let rootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+    let rootFolder = IMAPPump.incomingServer.rootFolder;</span>
<a href="#l22.14"></a><span id="l22.14">     gSecondFolder =  rootFolder.getChildNamed(&quot;secondFolder&quot;)</span>
<a href="#l22.15"></a><span id="l22.15">                            .QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l22.16"></a><span id="l22.16"> </span>
<a href="#l22.17"></a><span id="l22.17">     // Selecting the second folder will close the cached connection</span>
<a href="#l22.18"></a><span id="l22.18">     // on the inbox because fake server only supports one connection at a time.</span>
<a href="#l22.19"></a><span id="l22.19">     //  Then, we can poke at the message on the imap server directly, which</span>
<a href="#l22.20"></a><span id="l22.20">     // simulates the user changing the message from a different machine,</span>
<a href="#l22.21"></a><span id="l22.21">     // and Thunderbird discovering the change when it does a flag sync </span>
<a href="#l22.22"></a><span id="l22.22">     // upon reselecting the Inbox.</span>
<a href="#l22.23"></a><span id="l22.23">     gSecondFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l22.24"></a><span id="l22.24">     yield false;</span>
<a href="#l22.25"></a><span id="l22.25">   },</span>
<a href="#l22.26"></a><span id="l22.26">   function simulateForwardFlagSet() {</span>
<a href="#l22.27"></a><span id="l22.27">     gMessage.setFlag(&quot;$Forwarded&quot;);</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineminus">-    gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineplus">+    IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l22.30"></a><span id="l22.30">     yield false;</span>
<a href="#l22.31"></a><span id="l22.31">   },</span>
<a href="#l22.32"></a><span id="l22.32">   function checkForwardedFlagSet() {</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineminus">-    let msgHdr = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gSynthMessage.messageId);</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineplus">+    let msgHdr = IMAPPump.inbox.msgDatabase.getMsgHdrForMessageID(gSynthMessage.messageId);</span>
<a href="#l22.35"></a><span id="l22.35">     do_check_eq(msgHdr.flags &amp; Ci.nsMsgMessageFlags.Forwarded,</span>
<a href="#l22.36"></a><span id="l22.36">       Ci.nsMsgMessageFlags.Forwarded);</span>
<a href="#l22.37"></a><span id="l22.37">     gSecondFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l22.38"></a><span id="l22.38">     yield false;</span>
<a href="#l22.39"></a><span id="l22.39">   },</span>
<a href="#l22.40"></a><span id="l22.40">   function clearForwardedFlag() {</span>
<a href="#l22.41"></a><span id="l22.41">     gMessage.clearFlag(&quot;$Forwarded&quot;);</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineminus">-    gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineplus">+    IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l22.44"></a><span id="l22.44">     yield false;</span>
<a href="#l22.45"></a><span id="l22.45">   },</span>
<a href="#l22.46"></a><span id="l22.46">   function checkForwardedFlagCleared() {</span>
<a href="#l22.47"></a><span id="l22.47" class="difflineminus">-    let msgHdr = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gSynthMessage.messageId);</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineplus">+    let msgHdr = IMAPPump.inbox.msgDatabase.getMsgHdrForMessageID(gSynthMessage.messageId);</span>
<a href="#l22.49"></a><span id="l22.49">     do_check_eq(msgHdr.flags &amp; Ci.nsMsgMessageFlags.Forwarded, 0);</span>
<a href="#l22.50"></a><span id="l22.50">     gSecondFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l22.51"></a><span id="l22.51">     yield false;</span>
<a href="#l22.52"></a><span id="l22.52">   },</span>
<a href="#l22.53"></a><span id="l22.53">   function setSeenFlag() {</span>
<a href="#l22.54"></a><span id="l22.54">     gMessage.setFlag(&quot;\\Seen&quot;);</span>
<a href="#l22.55"></a><span id="l22.55" class="difflineminus">-    gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l22.56"></a><span id="l22.56" class="difflineplus">+    IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l22.57"></a><span id="l22.57">     yield false;</span>
<a href="#l22.58"></a><span id="l22.58">   },</span>
<a href="#l22.59"></a><span id="l22.59">   function checkSeenFlagSet() {</span>
<a href="#l22.60"></a><span id="l22.60" class="difflineminus">-    let msgHdr = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gSynthMessage.messageId);</span>
<a href="#l22.61"></a><span id="l22.61" class="difflineplus">+    let msgHdr = IMAPPump.inbox.msgDatabase.getMsgHdrForMessageID(gSynthMessage.messageId);</span>
<a href="#l22.62"></a><span id="l22.62">     do_check_eq(msgHdr.flags &amp; Ci.nsMsgMessageFlags.Read,</span>
<a href="#l22.63"></a><span id="l22.63">                 Ci.nsMsgMessageFlags.Read);</span>
<a href="#l22.64"></a><span id="l22.64">     gSecondFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l22.65"></a><span id="l22.65">     yield false;</span>
<a href="#l22.66"></a><span id="l22.66">   },</span>
<a href="#l22.67"></a><span id="l22.67">   function simulateRepliedFlagSet() {</span>
<a href="#l22.68"></a><span id="l22.68">     gMessage.setFlag(&quot;\\Answered&quot;);</span>
<a href="#l22.69"></a><span id="l22.69" class="difflineminus">-    gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l22.70"></a><span id="l22.70" class="difflineplus">+    IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l22.71"></a><span id="l22.71">     yield false;</span>
<a href="#l22.72"></a><span id="l22.72">   },</span>
<a href="#l22.73"></a><span id="l22.73">   function checkRepliedFlagSet() {</span>
<a href="#l22.74"></a><span id="l22.74" class="difflineminus">-    let msgHdr = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gSynthMessage.messageId);</span>
<a href="#l22.75"></a><span id="l22.75" class="difflineplus">+    let msgHdr = IMAPPump.inbox.msgDatabase.getMsgHdrForMessageID(gSynthMessage.messageId);</span>
<a href="#l22.76"></a><span id="l22.76">     do_check_eq(msgHdr.flags &amp; Ci.nsMsgMessageFlags.Replied,</span>
<a href="#l22.77"></a><span id="l22.77">       Ci.nsMsgMessageFlags.Replied);</span>
<a href="#l22.78"></a><span id="l22.78">     gSecondFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l22.79"></a><span id="l22.79">     yield false;</span>
<a href="#l22.80"></a><span id="l22.80">   },</span>
<a href="#l22.81"></a><span id="l22.81">   function simulateTagAdded() {</span>
<a href="#l22.82"></a><span id="l22.82">     gMessage.setFlag(&quot;randomtag&quot;);</span>
<a href="#l22.83"></a><span id="l22.83" class="difflineminus">-    gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l22.84"></a><span id="l22.84" class="difflineplus">+    IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l22.85"></a><span id="l22.85">     yield false;</span>
<a href="#l22.86"></a><span id="l22.86">   },</span>
<a href="#l22.87"></a><span id="l22.87">   function checkTagSet() {</span>
<a href="#l22.88"></a><span id="l22.88" class="difflineminus">-    let msgHdr = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gSynthMessage.messageId);</span>
<a href="#l22.89"></a><span id="l22.89" class="difflineplus">+    let msgHdr = IMAPPump.inbox.msgDatabase.getMsgHdrForMessageID(gSynthMessage.messageId);</span>
<a href="#l22.90"></a><span id="l22.90">     let keywords = msgHdr.getStringProperty(&quot;keywords&quot;);</span>
<a href="#l22.91"></a><span id="l22.91">     do_check_true(keywords.contains(&quot;randomtag&quot;));</span>
<a href="#l22.92"></a><span id="l22.92">     gSecondFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l22.93"></a><span id="l22.93">     yield false;</span>
<a href="#l22.94"></a><span id="l22.94">   },</span>
<a href="#l22.95"></a><span id="l22.95">   function clearTag() {</span>
<a href="#l22.96"></a><span id="l22.96">     gMessage.clearFlag(&quot;randomtag&quot;);</span>
<a href="#l22.97"></a><span id="l22.97" class="difflineminus">-    gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l22.98"></a><span id="l22.98" class="difflineplus">+    IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l22.99"></a><span id="l22.99">     yield false;</span>
<a href="#l22.100"></a><span id="l22.100">   },</span>
<a href="#l22.101"></a><span id="l22.101">   function checkTagCleared() {</span>
<a href="#l22.102"></a><span id="l22.102" class="difflineminus">-    let msgHdr = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gSynthMessage.messageId);</span>
<a href="#l22.103"></a><span id="l22.103" class="difflineplus">+    let msgHdr = IMAPPump.inbox.msgDatabase.getMsgHdrForMessageID(gSynthMessage.messageId);</span>
<a href="#l22.104"></a><span id="l22.104">     let keywords = msgHdr.getStringProperty(&quot;keywords&quot;);</span>
<a href="#l22.105"></a><span id="l22.105">     do_check_false(keywords.contains(&quot;randomtag&quot;));</span>
<a href="#l22.106"></a><span id="l22.106">   },</span>
<a href="#l22.107"></a><span id="l22.107">   teardown</span>
<a href="#l22.108"></a><span id="l22.108"> ];</span>
<a href="#l22.109"></a><span id="l22.109"> </span>
<a href="#l22.110"></a><span id="l22.110"> function setup() {</span>
<a href="#l22.111"></a><span id="l22.111">   Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l22.112"></a><span id="l22.112"> </span>
<a href="#l22.113"></a><span id="l22.113">   setupIMAPPump();</span>
<a href="#l22.114"></a><span id="l22.114"> </span>
<a href="#l22.115"></a><span id="l22.115" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;secondFolder&quot;, {subscribed : true});</span>
<a href="#l22.116"></a><span id="l22.116" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;secondFolder&quot;, {subscribed : true});</span>
<a href="#l22.117"></a><span id="l22.117"> </span>
<a href="#l22.118"></a><span id="l22.118">   // build up a diverse list of messages</span>
<a href="#l22.119"></a><span id="l22.119">   let messages = [];</span>
<a href="#l22.120"></a><span id="l22.120">   let gMessageGenerator = new MessageGenerator();</span>
<a href="#l22.121"></a><span id="l22.121">   messages = messages.concat(gMessageGenerator.makeMessage());</span>
<a href="#l22.122"></a><span id="l22.122">   gSynthMessage = messages[0];</span>
<a href="#l22.123"></a><span id="l22.123"> </span>
<a href="#l22.124"></a><span id="l22.124">   let msgURI =</span>
<a href="#l22.125"></a><span id="l22.125">     Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l22.126"></a><span id="l22.126">                        btoa(gSynthMessage.toMessageString()),</span>
<a href="#l22.127"></a><span id="l22.127">                        null, null);</span>
<a href="#l22.128"></a><span id="l22.128" class="difflineminus">-  gMessage = new imapMessage(msgURI.spec, gIMAPMailbox.uidnext++, []);</span>
<a href="#l22.129"></a><span id="l22.129" class="difflineminus">-  gIMAPMailbox.addMessage(gMessage);</span>
<a href="#l22.130"></a><span id="l22.130" class="difflineplus">+  gMessage = new imapMessage(msgURI.spec, IMAPPump.mailbox.uidnext++, []);</span>
<a href="#l22.131"></a><span id="l22.131" class="difflineplus">+  IMAPPump.mailbox.addMessage(gMessage);</span>
<a href="#l22.132"></a><span id="l22.132"> </span>
<a href="#l22.133"></a><span id="l22.133">   // update folder to download header.</span>
<a href="#l22.134"></a><span id="l22.134" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l22.135"></a><span id="l22.135" class="difflineplus">+  IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l22.136"></a><span id="l22.136">   yield false;</span>
<a href="#l22.137"></a><span id="l22.137"> }</span>
<a href="#l22.138"></a><span id="l22.138"> </span>
<a href="#l22.139"></a><span id="l22.139"> asyncUrlListener.callback = function(aUrl, aExitCode) {</span>
<a href="#l22.140"></a><span id="l22.140">   do_check_eq(aExitCode, 0);</span>
<a href="#l22.141"></a><span id="l22.141"> };</span>
<a href="#l22.142"></a><span id="l22.142"> </span>
<a href="#l22.143"></a><span id="l22.143"> function teardown() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapFolderCopy.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapFolderCopy.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -15,83 +15,83 @@ Components.utils.import(&quot;resource:///mod</span>
<a href="#l23.4"></a><span id="l23.4"> </span>
<a href="#l23.5"></a><span id="l23.5"> var tests = [</span>
<a href="#l23.6"></a><span id="l23.6">   setup,</span>
<a href="#l23.7"></a><span id="l23.7">   function copyFolder1() {</span>
<a href="#l23.8"></a><span id="l23.8">     dump(&quot;gEmpty1 &quot; + gEmptyLocal1.URI + &quot;\n&quot;);</span>
<a href="#l23.9"></a><span id="l23.9">     let folders = new Array;</span>
<a href="#l23.10"></a><span id="l23.10">     folders.push(gEmptyLocal1.QueryInterface(Ci.nsIMsgFolder));</span>
<a href="#l23.11"></a><span id="l23.11">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-    MailServices.copy.CopyFolders(array, gIMAPInbox, false, CopyListener, null);</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+    MailServices.copy.CopyFolders(array, IMAPPump.inbox, false, CopyListener, null);</span>
<a href="#l23.14"></a><span id="l23.14">     yield false;</span>
<a href="#l23.15"></a><span id="l23.15">   },</span>
<a href="#l23.16"></a><span id="l23.16">   function copyFolder2() {</span>
<a href="#l23.17"></a><span id="l23.17">     dump(&quot;gEmpty2 &quot; + gEmptyLocal2.URI + &quot;\n&quot;);</span>
<a href="#l23.18"></a><span id="l23.18">     let folders = new Array;</span>
<a href="#l23.19"></a><span id="l23.19">     folders.push(gEmptyLocal2);</span>
<a href="#l23.20"></a><span id="l23.20">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l23.21"></a><span id="l23.21" class="difflineminus">-    MailServices.copy.CopyFolders(array, gIMAPInbox, false, CopyListener, null);</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineplus">+    MailServices.copy.CopyFolders(array, IMAPPump.inbox, false, CopyListener, null);</span>
<a href="#l23.23"></a><span id="l23.23">     yield false;</span>
<a href="#l23.24"></a><span id="l23.24">   },</span>
<a href="#l23.25"></a><span id="l23.25">   function copyFolder3() {</span>
<a href="#l23.26"></a><span id="l23.26">     dump(&quot;gEmpty3 &quot; + gEmptyLocal3.URI + &quot;\n&quot;);</span>
<a href="#l23.27"></a><span id="l23.27">     let folders = new Array;</span>
<a href="#l23.28"></a><span id="l23.28">     folders.push(gEmptyLocal3);</span>
<a href="#l23.29"></a><span id="l23.29">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineminus">-    MailServices.copy.CopyFolders(array, gIMAPInbox, false, CopyListener, null);</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineplus">+    MailServices.copy.CopyFolders(array, IMAPPump.inbox, false, CopyListener, null);</span>
<a href="#l23.32"></a><span id="l23.32">     yield false;</span>
<a href="#l23.33"></a><span id="l23.33">   },</span>
<a href="#l23.34"></a><span id="l23.34">   function verifyFolders() {</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineminus">-    let folder1 = gIMAPInbox.getChildNamed(&quot;empty 1&quot;);</span>
<a href="#l23.36"></a><span id="l23.36" class="difflineplus">+    let folder1 = IMAPPump.inbox.getChildNamed(&quot;empty 1&quot;);</span>
<a href="#l23.37"></a><span id="l23.37">     dump(&quot;found folder1\n&quot;);</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineminus">-    let folder2 = gIMAPInbox.getChildNamed(&quot;empty 2&quot;);</span>
<a href="#l23.39"></a><span id="l23.39" class="difflineplus">+    let folder2 = IMAPPump.inbox.getChildNamed(&quot;empty 2&quot;);</span>
<a href="#l23.40"></a><span id="l23.40">     dump(&quot;found folder2\n&quot;);</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineminus">-    let folder3 = gIMAPInbox.getChildNamed(&quot;empty 3&quot;);</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineplus">+    let folder3 = IMAPPump.inbox.getChildNamed(&quot;empty 3&quot;);</span>
<a href="#l23.43"></a><span id="l23.43">     dump(&quot;found folder3\n&quot;);</span>
<a href="#l23.44"></a><span id="l23.44">     do_check_neq(folder1, null);</span>
<a href="#l23.45"></a><span id="l23.45">     do_check_neq(folder2, null);</span>
<a href="#l23.46"></a><span id="l23.46">     do_check_neq(folder3, null);</span>
<a href="#l23.47"></a><span id="l23.47">   },</span>
<a href="#l23.48"></a><span id="l23.48">   function moveImapFolder1() {</span>
<a href="#l23.49"></a><span id="l23.49">     let folders = new Array;</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineminus">-    let folder1 = gIMAPInbox.getChildNamed(&quot;empty 1&quot;);</span>
<a href="#l23.51"></a><span id="l23.51" class="difflineminus">-    let folder2 = gIMAPInbox.getChildNamed(&quot;empty 2&quot;);</span>
<a href="#l23.52"></a><span id="l23.52" class="difflineplus">+    let folder1 = IMAPPump.inbox.getChildNamed(&quot;empty 1&quot;);</span>
<a href="#l23.53"></a><span id="l23.53" class="difflineplus">+    let folder2 = IMAPPump.inbox.getChildNamed(&quot;empty 2&quot;);</span>
<a href="#l23.54"></a><span id="l23.54">     folders.push(folder2.QueryInterface(Ci.nsIMsgFolder));</span>
<a href="#l23.55"></a><span id="l23.55">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l23.56"></a><span id="l23.56">     MailServices.copy.CopyFolders(array, folder1, true, CopyListener, null);</span>
<a href="#l23.57"></a><span id="l23.57">     yield false;</span>
<a href="#l23.58"></a><span id="l23.58">   },</span>
<a href="#l23.59"></a><span id="l23.59">   function moveImapFolder2() {</span>
<a href="#l23.60"></a><span id="l23.60">     let folders = new Array;</span>
<a href="#l23.61"></a><span id="l23.61" class="difflineminus">-    let folder1 = gIMAPInbox.getChildNamed(&quot;empty 1&quot;);</span>
<a href="#l23.62"></a><span id="l23.62" class="difflineminus">-    let folder3 = gIMAPInbox.getChildNamed(&quot;empty 3&quot;);</span>
<a href="#l23.63"></a><span id="l23.63" class="difflineplus">+    let folder1 = IMAPPump.inbox.getChildNamed(&quot;empty 1&quot;);</span>
<a href="#l23.64"></a><span id="l23.64" class="difflineplus">+    let folder3 = IMAPPump.inbox.getChildNamed(&quot;empty 3&quot;);</span>
<a href="#l23.65"></a><span id="l23.65">     folders.push(folder3.QueryInterface(Ci.nsIMsgFolder));</span>
<a href="#l23.66"></a><span id="l23.66">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l23.67"></a><span id="l23.67">     MailServices.copy.CopyFolders(array, folder1, true, CopyListener, null);</span>
<a href="#l23.68"></a><span id="l23.68">     yield false;</span>
<a href="#l23.69"></a><span id="l23.69">   },</span>
<a href="#l23.70"></a><span id="l23.70">   function verifyImapFolders() {</span>
<a href="#l23.71"></a><span id="l23.71" class="difflineminus">-    let folder1 = gIMAPInbox.getChildNamed(&quot;empty 1&quot;);</span>
<a href="#l23.72"></a><span id="l23.72" class="difflineplus">+    let folder1 = IMAPPump.inbox.getChildNamed(&quot;empty 1&quot;);</span>
<a href="#l23.73"></a><span id="l23.73">     dump(&quot;found folder1\n&quot;);</span>
<a href="#l23.74"></a><span id="l23.74">     let folder2 = folder1.getChildNamed(&quot;empty 2&quot;);</span>
<a href="#l23.75"></a><span id="l23.75">     dump(&quot;found folder2\n&quot;);</span>
<a href="#l23.76"></a><span id="l23.76">     let folder3 = folder1.getChildNamed(&quot;empty 3&quot;);</span>
<a href="#l23.77"></a><span id="l23.77">     dump(&quot;found folder3\n&quot;);</span>
<a href="#l23.78"></a><span id="l23.78">     do_check_neq(folder1, null);</span>
<a href="#l23.79"></a><span id="l23.79">     do_check_neq(folder2, null);</span>
<a href="#l23.80"></a><span id="l23.80">     do_check_neq(folder3, null);</span>
<a href="#l23.81"></a><span id="l23.81">   },</span>
<a href="#l23.82"></a><span id="l23.82">   function testImapFolderCopyFailure() {</span>
<a href="#l23.83"></a><span id="l23.83">     let folders = new Array;</span>
<a href="#l23.84"></a><span id="l23.84">     folders.push(gNotEmptyLocal4.QueryInterface(Ci.nsIMsgFolder));</span>
<a href="#l23.85"></a><span id="l23.85">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l23.86"></a><span id="l23.86" class="difflineminus">-    gIMAPDaemon.commandToFail = &quot;APPEND&quot;;</span>
<a href="#l23.87"></a><span id="l23.87" class="difflineplus">+    IMAPPump.daemon.commandToFail = &quot;APPEND&quot;;</span>
<a href="#l23.88"></a><span id="l23.88">     // we expect NS_MSG_ERROR_IMAP_COMMAND_FAILED;</span>
<a href="#l23.89"></a><span id="l23.89">     CopyListener._expectedStatus = 0x80550021;</span>
<a href="#l23.90"></a><span id="l23.90" class="difflineminus">-    MailServices.copy.CopyFolders(array, gIMAPInbox, false, CopyListener, null);</span>
<a href="#l23.91"></a><span id="l23.91" class="difflineplus">+    MailServices.copy.CopyFolders(array, IMAPPump.inbox, false, CopyListener, null);</span>
<a href="#l23.92"></a><span id="l23.92"> </span>
<a href="#l23.93"></a><span id="l23.93">     // In failure case OnStopCopy is sent twice, the first one comes from</span>
<a href="#l23.94"></a><span id="l23.94">     // nsMsgCopyService, the second one comes from nsImapFolderCopyState.</span>
<a href="#l23.95"></a><span id="l23.95">     yield false;</span>
<a href="#l23.96"></a><span id="l23.96"> </span>
<a href="#l23.97"></a><span id="l23.97">     yield false;</span>
<a href="#l23.98"></a><span id="l23.98">   },</span>
<a href="#l23.99"></a><span id="l23.99">   teardown</span>
<a href="#l23.100"></a><span id="l23.100" class="difflineat">@@ -109,18 +109,18 @@ function setup() {</span>
<a href="#l23.101"></a><span id="l23.101">   let message = messageGenerator.makeMessage();</span>
<a href="#l23.102"></a><span id="l23.102">   gNotEmptyLocal4.QueryInterface(Ci.nsIMsgLocalMailFolder);</span>
<a href="#l23.103"></a><span id="l23.103">   gNotEmptyLocal4.addMessage(message.toMboxString());</span>
<a href="#l23.104"></a><span id="l23.104"> </span>
<a href="#l23.105"></a><span id="l23.105">   // these hacks are required because we've created the inbox before</span>
<a href="#l23.106"></a><span id="l23.106">   // running initial folder discovery, and adding the folder bails</span>
<a href="#l23.107"></a><span id="l23.107">   // out before we set it as verified online, so we bail out, and</span>
<a href="#l23.108"></a><span id="l23.108">   // then remove the INBOX folder since it's not verified.</span>
<a href="#l23.109"></a><span id="l23.109" class="difflineminus">-  gIMAPInbox.hierarchyDelimiter = '/';</span>
<a href="#l23.110"></a><span id="l23.110" class="difflineminus">-  gIMAPInbox.verifiedAsOnlineFolder = true;</span>
<a href="#l23.111"></a><span id="l23.111" class="difflineplus">+  IMAPPump.inbox.hierarchyDelimiter = '/';</span>
<a href="#l23.112"></a><span id="l23.112" class="difflineplus">+  IMAPPump.inbox.verifiedAsOnlineFolder = true;</span>
<a href="#l23.113"></a><span id="l23.113"> }</span>
<a href="#l23.114"></a><span id="l23.114"> </span>
<a href="#l23.115"></a><span id="l23.115"> // nsIMsgCopyServiceListener implementation - runs next test when copy</span>
<a href="#l23.116"></a><span id="l23.116"> // is completed.</span>
<a href="#l23.117"></a><span id="l23.117"> var CopyListener = {</span>
<a href="#l23.118"></a><span id="l23.118">   _expectedStatus : 0,</span>
<a href="#l23.119"></a><span id="l23.119">   OnStartCopy: function() {},</span>
<a href="#l23.120"></a><span id="l23.120">   OnProgress: function(aProgress, aProgressMax) {},</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapHdrChunking.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapHdrChunking.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -20,17 +20,17 @@ load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l24.4"></a><span id="l24.4"> setupIMAPPump();</span>
<a href="#l24.5"></a><span id="l24.5"> </span>
<a href="#l24.6"></a><span id="l24.6"> const kBiffStateAtom = Cc[&quot;@mozilla.org/atom-service;1&quot;]</span>
<a href="#l24.7"></a><span id="l24.7">                          .getService(Ci.nsIAtomService)</span>
<a href="#l24.8"></a><span id="l24.8">                          .getAtom(&quot;BiffState&quot;);</span>
<a href="#l24.9"></a><span id="l24.9"> // Dummy message window so we can say the inbox is open in a window.</span>
<a href="#l24.10"></a><span id="l24.10"> var dummyMsgWindow =</span>
<a href="#l24.11"></a><span id="l24.11"> {</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-  openFolder : gIMAPInbox,</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+  openFolder : IMAPPump.inbox,</span>
<a href="#l24.14"></a><span id="l24.14">   QueryInterface: XPCOMUtils.generateQI([Ci.nsIMsgWindow,</span>
<a href="#l24.15"></a><span id="l24.15">                                          Ci.nsISupportsWeakReference])</span>
<a href="#l24.16"></a><span id="l24.16"> };</span>
<a href="#l24.17"></a><span id="l24.17"> </span>
<a href="#l24.18"></a><span id="l24.18"> var gFolderListener = {</span>
<a href="#l24.19"></a><span id="l24.19">   _gotNewMailBiff: false,</span>
<a href="#l24.20"></a><span id="l24.20">   OnItemIntPropertyChanged : function(aItem, aProperty, aOldValue, aNewValue) {</span>
<a href="#l24.21"></a><span id="l24.21">     if (aProperty == kBiffStateAtom &amp;&amp;</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineat">@@ -55,43 +55,43 @@ function uploadImapMessages()</span>
<a href="#l24.23"></a><span id="l24.23">   let messageGenerator = new MessageGenerator();</span>
<a href="#l24.24"></a><span id="l24.24">   let scenarioFactory = new MessageScenarioFactory(messageGenerator);</span>
<a href="#l24.25"></a><span id="l24.25"> </span>
<a href="#l24.26"></a><span id="l24.26">   // build up a list of messages</span>
<a href="#l24.27"></a><span id="l24.27">   let messages = [];</span>
<a href="#l24.28"></a><span id="l24.28">   messages = messages.concat(scenarioFactory.directReply(10));</span>
<a href="#l24.29"></a><span id="l24.29"> </span>
<a href="#l24.30"></a><span id="l24.30">   // Add 10 messages with uids 1-10.</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineminus">-  let imapInbox = gIMAPDaemon.getMailbox(&quot;INBOX&quot;)</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineplus">+  let imapInbox = IMAPPump.daemon.getMailbox(&quot;INBOX&quot;)</span>
<a href="#l24.33"></a><span id="l24.33">   // Create the imapMessages and store them on the mailbox</span>
<a href="#l24.34"></a><span id="l24.34">   messages.forEach(function (message)</span>
<a href="#l24.35"></a><span id="l24.35">   {</span>
<a href="#l24.36"></a><span id="l24.36">     let dataUri = Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l24.37"></a><span id="l24.37">                                      btoa(message.toMessageString()),</span>
<a href="#l24.38"></a><span id="l24.38">                                      null, null);</span>
<a href="#l24.39"></a><span id="l24.39">     imapInbox.addMessage(new imapMessage(dataUri.spec, imapInbox.uidnext++, []));</span>
<a href="#l24.40"></a><span id="l24.40">   });</span>
<a href="#l24.41"></a><span id="l24.41">   // updateFolderWithListener with null for nsIMsgWindow makes biff notify.</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineplus">+  IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l24.44"></a><span id="l24.44">   yield false;</span>
<a href="#l24.45"></a><span id="l24.45"> }</span>
<a href="#l24.46"></a><span id="l24.46"> </span>
<a href="#l24.47"></a><span id="l24.47"> function testMessageFetched() {</span>
<a href="#l24.48"></a><span id="l24.48">   // If we're really chunking, then the message fetch should have started before</span>
<a href="#l24.49"></a><span id="l24.49">   // we finished the updateFolder URL.</span>
<a href="#l24.50"></a><span id="l24.50">   do_check_true(gFolderListener._gotNewMailBiff);</span>
<a href="#l24.51"></a><span id="l24.51">   // Should have only downloaded first chunk of headers when message</span>
<a href="#l24.52"></a><span id="l24.52">   // has finished streaming.</span>
<a href="#l24.53"></a><span id="l24.53" class="difflineminus">-  do_check_eq(gIMAPInbox.msgDatabase.dBFolderInfo.numMessages, 3);</span>
<a href="#l24.54"></a><span id="l24.54" class="difflineplus">+  do_check_eq(IMAPPump.inbox.msgDatabase.dBFolderInfo.numMessages, 3);</span>
<a href="#l24.55"></a><span id="l24.55">   yield false;</span>
<a href="#l24.56"></a><span id="l24.56"> }</span>
<a href="#l24.57"></a><span id="l24.57"> </span>
<a href="#l24.58"></a><span id="l24.58"> function testHdrsDownloaded() {</span>
<a href="#l24.59"></a><span id="l24.59">   // Make sure we got all 10 headers.</span>
<a href="#l24.60"></a><span id="l24.60" class="difflineminus">-  do_check_eq(gIMAPInbox.msgDatabase.dBFolderInfo.numMessages, 10);</span>
<a href="#l24.61"></a><span id="l24.61" class="difflineplus">+  do_check_eq(IMAPPump.inbox.msgDatabase.dBFolderInfo.numMessages, 10);</span>
<a href="#l24.62"></a><span id="l24.62">   yield true;</span>
<a href="#l24.63"></a><span id="l24.63"> }</span>
<a href="#l24.64"></a><span id="l24.64"> </span>
<a href="#l24.65"></a><span id="l24.65"> // Cleanup</span>
<a href="#l24.66"></a><span id="l24.66"> function endTest() {</span>
<a href="#l24.67"></a><span id="l24.67">   teardownIMAPPump();</span>
<a href="#l24.68"></a><span id="l24.68"> }</span>
<a href="#l24.69"></a><span id="l24.69"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapHdrStreaming.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapHdrStreaming.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -72,41 +72,41 @@ function addMessagesToServer(messages, m</span>
<a href="#l25.4"></a><span id="l25.4"> }</span>
<a href="#l25.5"></a><span id="l25.5"> </span>
<a href="#l25.6"></a><span id="l25.6"> var incomingServer, server;</span>
<a href="#l25.7"></a><span id="l25.7"> function run_test() {</span>
<a href="#l25.8"></a><span id="l25.8"> </span>
<a href="#l25.9"></a><span id="l25.9">   // Add a couple of messages to the INBOX</span>
<a href="#l25.10"></a><span id="l25.10">   // this is synchronous, afaik</span>
<a href="#l25.11"></a><span id="l25.11">   addMessagesToServer([{file: gMsgFile1, messageId: gMsgId1}],</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-                        gIMAPDaemon.getMailbox(&quot;INBOX&quot;));</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+                        IMAPPump.daemon.getMailbox(&quot;INBOX&quot;));</span>
<a href="#l25.14"></a><span id="l25.14">   Services.prefs.setBoolPref(&quot;mail.server.server1.autosync_offline_stores&quot;, false);</span>
<a href="#l25.15"></a><span id="l25.15">   async_run_tests(tests);</span>
<a href="#l25.16"></a><span id="l25.16">  }</span>
<a href="#l25.17"></a><span id="l25.17"> </span>
<a href="#l25.18"></a><span id="l25.18"> var tests = [</span>
<a href="#l25.19"></a><span id="l25.19">   test_updateFolder,</span>
<a href="#l25.20"></a><span id="l25.20">   test_downloadForOffline,</span>
<a href="#l25.21"></a><span id="l25.21">   test_streamHeaders,</span>
<a href="#l25.22"></a><span id="l25.22">   endTest</span>
<a href="#l25.23"></a><span id="l25.23"> ]</span>
<a href="#l25.24"></a><span id="l25.24"> </span>
<a href="#l25.25"></a><span id="l25.25"> function test_updateFolder() {</span>
<a href="#l25.26"></a><span id="l25.26" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l25.27"></a><span id="l25.27" class="difflineplus">+  IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l25.28"></a><span id="l25.28">   yield false;</span>
<a href="#l25.29"></a><span id="l25.29"> }</span>
<a href="#l25.30"></a><span id="l25.30"> </span>
<a href="#l25.31"></a><span id="l25.31"> function test_downloadForOffline() {</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineminus">-  gIMAPInbox.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineplus">+  IMAPPump.inbox.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l25.34"></a><span id="l25.34">   yield false;</span>
<a href="#l25.35"></a><span id="l25.35"> }</span>
<a href="#l25.36"></a><span id="l25.36"> </span>
<a href="#l25.37"></a><span id="l25.37"> function test_streamHeaders()</span>
<a href="#l25.38"></a><span id="l25.38"> {</span>
<a href="#l25.39"></a><span id="l25.39" class="difflineminus">-  let newMsgHdr = gIMAPInbox.GetMessageHeader(1);</span>
<a href="#l25.40"></a><span id="l25.40" class="difflineplus">+  let newMsgHdr = IMAPPump.inbox.GetMessageHeader(1);</span>
<a href="#l25.41"></a><span id="l25.41">   let msgURI = newMsgHdr.folder.getUriForMsg(newMsgHdr);</span>
<a href="#l25.42"></a><span id="l25.42">   let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l25.43"></a><span id="l25.43">   let msgServ = messenger.messageServiceFromURI(msgURI);</span>
<a href="#l25.44"></a><span id="l25.44">   msgServ.streamHeaders(msgURI, streamListener, asyncUrlListener,true);</span>
<a href="#l25.45"></a><span id="l25.45">   yield false;</span>
<a href="#l25.46"></a><span id="l25.46"> }</span>
<a href="#l25.47"></a><span id="l25.47"> </span>
<a href="#l25.48"></a><span id="l25.48"> function endTest()</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapID.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapID.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -9,33 +9,33 @@ load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l26.4"></a><span id="l26.4"> </span>
<a href="#l26.5"></a><span id="l26.5"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l26.6"></a><span id="l26.6"> </span>
<a href="#l26.7"></a><span id="l26.7"> const kIDResponse = &quot;(\&quot;name\&quot; \&quot;GImap\&quot; \&quot;vendor\&quot; \&quot;Google, Inc.\&quot; \&quot;support-url\&quot; \&quot;http://mail.google.com/support\&quot;)&quot;;</span>
<a href="#l26.8"></a><span id="l26.8"> </span>
<a href="#l26.9"></a><span id="l26.9"> var tests = [</span>
<a href="#l26.10"></a><span id="l26.10">   setup,</span>
<a href="#l26.11"></a><span id="l26.11">   function updateInbox() {</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-    let rootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-    gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineplus">+    let rootFolder = IMAPPump.incomingServer.rootFolder;</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineplus">+    IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l26.16"></a><span id="l26.16">     yield false;</span>
<a href="#l26.17"></a><span id="l26.17">   },</span>
<a href="#l26.18"></a><span id="l26.18">   function checkIDHandling() {</span>
<a href="#l26.19"></a><span id="l26.19" class="difflineminus">-    do_check_eq(gIMAPDaemon.clientID, &quot;(\&quot;name\&quot; \&quot;XPCShell\&quot; \&quot;version\&quot; \&quot;5\&quot;)&quot;);</span>
<a href="#l26.20"></a><span id="l26.20" class="difflineminus">-    do_check_eq(gIMAPIncomingServer.serverIDPref, kIDResponse);</span>
<a href="#l26.21"></a><span id="l26.21" class="difflineplus">+    do_check_eq(IMAPPump.daemon.clientID, &quot;(\&quot;name\&quot; \&quot;XPCShell\&quot; \&quot;version\&quot; \&quot;5\&quot;)&quot;);</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineplus">+    do_check_eq(IMAPPump.incomingServer.serverIDPref, kIDResponse);</span>
<a href="#l26.23"></a><span id="l26.23">   },</span>
<a href="#l26.24"></a><span id="l26.24">   teardown</span>
<a href="#l26.25"></a><span id="l26.25"> ]</span>
<a href="#l26.26"></a><span id="l26.26"> </span>
<a href="#l26.27"></a><span id="l26.27"> function setup() {</span>
<a href="#l26.28"></a><span id="l26.28">   setupIMAPPump(&quot;GMail&quot;);</span>
<a href="#l26.29"></a><span id="l26.29" class="difflineminus">-  gIMAPDaemon.idResponse = kIDResponse;</span>
<a href="#l26.30"></a><span id="l26.30" class="difflineplus">+  IMAPPump.daemon.idResponse = kIDResponse;</span>
<a href="#l26.31"></a><span id="l26.31"> </span>
<a href="#l26.32"></a><span id="l26.32">   // update folder to kick start tests.</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineplus">+  IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l26.35"></a><span id="l26.35">   yield false;</span>
<a href="#l26.36"></a><span id="l26.36"> }</span>
<a href="#l26.37"></a><span id="l26.37"> </span>
<a href="#l26.38"></a><span id="l26.38"> function teardown() {</span>
<a href="#l26.39"></a><span id="l26.39">   teardownIMAPPump();</span>
<a href="#l26.40"></a><span id="l26.40"> }</span>
<a href="#l26.41"></a><span id="l26.41"> </span>
<a href="#l26.42"></a><span id="l26.42"> function run_test() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapMove.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapMove.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -12,62 +12,62 @@ var gMessages = Cc[&quot;@mozilla.org/array;1</span>
<a href="#l27.4"></a><span id="l27.4"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l27.5"></a><span id="l27.5"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l27.6"></a><span id="l27.6"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l27.7"></a><span id="l27.7"> </span>
<a href="#l27.8"></a><span id="l27.8"> // IMAP pump</span>
<a href="#l27.9"></a><span id="l27.9"> load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l27.10"></a><span id="l27.10"> setupIMAPPump(&quot;CUSTOM1&quot;);</span>
<a href="#l27.11"></a><span id="l27.11"> </span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-var gIMAPInbox, gFolder1;</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+var gFolder1;</span>
<a href="#l27.14"></a><span id="l27.14"> </span>
<a href="#l27.15"></a><span id="l27.15"> var tests = [</span>
<a href="#l27.16"></a><span id="l27.16">   startTest,</span>
<a href="#l27.17"></a><span id="l27.17">   doMove,</span>
<a href="#l27.18"></a><span id="l27.18">   testMove,</span>
<a href="#l27.19"></a><span id="l27.19">   endTest</span>
<a href="#l27.20"></a><span id="l27.20"> ];</span>
<a href="#l27.21"></a><span id="l27.21"> </span>
<a href="#l27.22"></a><span id="l27.22"> function startTest()</span>
<a href="#l27.23"></a><span id="l27.23"> {</span>
<a href="#l27.24"></a><span id="l27.24">   Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l27.25"></a><span id="l27.25">   // Add folder listeners that will capture async events</span>
<a href="#l27.26"></a><span id="l27.26">   MailServices.mfn.addListener(mfnListener, MailServices.mfn.folderAdded);</span>
<a href="#l27.27"></a><span id="l27.27"> </span>
<a href="#l27.28"></a><span id="l27.28" class="difflineminus">-  gIMAPIncomingServer.rootFolder.createSubfolder(&quot;folder 1&quot;, null);</span>
<a href="#l27.29"></a><span id="l27.29" class="difflineplus">+  IMAPPump.incomingServer.rootFolder.createSubfolder(&quot;folder 1&quot;, null);</span>
<a href="#l27.30"></a><span id="l27.30">   yield false;</span>
<a href="#l27.31"></a><span id="l27.31">   let messages = [];</span>
<a href="#l27.32"></a><span id="l27.32">   let gMessageGenerator = new MessageGenerator();</span>
<a href="#l27.33"></a><span id="l27.33">   messages = messages.concat(gMessageGenerator.makeMessage());</span>
<a href="#l27.34"></a><span id="l27.34">   gSynthMessage = messages[0];</span>
<a href="#l27.35"></a><span id="l27.35">   let dataUri = Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l27.36"></a><span id="l27.36">                   btoa(messages[0].toMessageString()),</span>
<a href="#l27.37"></a><span id="l27.37">                   null, null);</span>
<a href="#l27.38"></a><span id="l27.38" class="difflineminus">-  let imapMsg = new imapMessage(dataUri.spec, gIMAPMailbox.uidnext++, []);</span>
<a href="#l27.39"></a><span id="l27.39" class="difflineminus">-  gIMAPMailbox.addMessage(imapMsg);</span>
<a href="#l27.40"></a><span id="l27.40" class="difflineplus">+  let imapMsg = new imapMessage(dataUri.spec, IMAPPump.mailbox.uidnext++, []);</span>
<a href="#l27.41"></a><span id="l27.41" class="difflineplus">+  IMAPPump.mailbox.addMessage(imapMsg);</span>
<a href="#l27.42"></a><span id="l27.42"> </span>
<a href="#l27.43"></a><span id="l27.43" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l27.44"></a><span id="l27.44" class="difflineplus">+  IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l27.45"></a><span id="l27.45">   yield false;</span>
<a href="#l27.46"></a><span id="l27.46"> }</span>
<a href="#l27.47"></a><span id="l27.47"> </span>
<a href="#l27.48"></a><span id="l27.48"> function doMove() {</span>
<a href="#l27.49"></a><span id="l27.49" class="difflineminus">-  let rootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l27.50"></a><span id="l27.50" class="difflineplus">+  let rootFolder = IMAPPump.incomingServer.rootFolder;</span>
<a href="#l27.51"></a><span id="l27.51">   gFolder1 = rootFolder.getChildNamed(&quot;folder 1&quot;)</span>
<a href="#l27.52"></a><span id="l27.52">                .QueryInterface(Components.interfaces.nsIMsgImapMailFolder);</span>
<a href="#l27.53"></a><span id="l27.53" class="difflineminus">-  let msg = gIMAPInbox.msgDatabase.GetMsgHdrForKey(gIMAPMailbox.uidnext - 1);</span>
<a href="#l27.54"></a><span id="l27.54" class="difflineplus">+  let msg = IMAPPump.inbox.msgDatabase.GetMsgHdrForKey(IMAPPump.mailbox.uidnext - 1);</span>
<a href="#l27.55"></a><span id="l27.55">   gMessages.appendElement(msg, false);</span>
<a href="#l27.56"></a><span id="l27.56" class="difflineminus">-  gIMAPServer._test = true;</span>
<a href="#l27.57"></a><span id="l27.57" class="difflineminus">-  MailServices.copy.CopyMessages(gIMAPInbox, gMessages, gFolder1, true,</span>
<a href="#l27.58"></a><span id="l27.58" class="difflineplus">+  IMAPPump.server._test = true;</span>
<a href="#l27.59"></a><span id="l27.59" class="difflineplus">+  MailServices.copy.CopyMessages(IMAPPump.inbox, gMessages, gFolder1, true,</span>
<a href="#l27.60"></a><span id="l27.60">                             asyncCopyListener, null, false);</span>
<a href="#l27.61"></a><span id="l27.61" class="difflineminus">-  gIMAPServer.performTest(&quot;UID MOVE&quot;);</span>
<a href="#l27.62"></a><span id="l27.62" class="difflineplus">+  IMAPPump.server.performTest(&quot;UID MOVE&quot;);</span>
<a href="#l27.63"></a><span id="l27.63">   yield false;</span>
<a href="#l27.64"></a><span id="l27.64"> }</span>
<a href="#l27.65"></a><span id="l27.65"> </span>
<a href="#l27.66"></a><span id="l27.66"> function testMove() {</span>
<a href="#l27.67"></a><span id="l27.67" class="difflineminus">-  do_check_eq(gIMAPInbox.getTotalMessages(false), 0);</span>
<a href="#l27.68"></a><span id="l27.68" class="difflineplus">+  do_check_eq(IMAPPump.inbox.getTotalMessages(false), 0);</span>
<a href="#l27.69"></a><span id="l27.69">   gFolder1.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l27.70"></a><span id="l27.70">   yield false;</span>
<a href="#l27.71"></a><span id="l27.71">   do_check_eq(gFolder1.getTotalMessages(false), 1);</span>
<a href="#l27.72"></a><span id="l27.72">   yield true;</span>
<a href="#l27.73"></a><span id="l27.73"> }</span>
<a href="#l27.74"></a><span id="l27.74"> </span>
<a href="#l27.75"></a><span id="l27.75"> var mfnListener =</span>
<a href="#l27.76"></a><span id="l27.76"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapSearch.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapSearch.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -239,44 +239,44 @@ var searchTests =</span>
<a href="#l28.4"></a><span id="l28.4">       op: Contains,</span>
<a href="#l28.5"></a><span id="l28.5">       customHeader: &quot;withspace&quot;,</span>
<a href="#l28.6"></a><span id="l28.6">       count: 1},</span>
<a href="#l28.7"></a><span id="l28.7"> ];</span>
<a href="#l28.8"></a><span id="l28.8"> </span>
<a href="#l28.9"></a><span id="l28.9"> // load and update a message in the imap fake server</span>
<a href="#l28.10"></a><span id="l28.10"> function loadImapMessage()</span>
<a href="#l28.11"></a><span id="l28.11"> {</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-  gIMAPMailbox.addMessage(new imapMessage(specForFileName(gMessage),</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineminus">-                          gIMAPMailbox.uidnext++, []));</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineplus">+  IMAPPump.mailbox.addMessage(new imapMessage(specForFileName(gMessage),</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineplus">+                          IMAPPump.mailbox.uidnext++, []));</span>
<a href="#l28.17"></a><span id="l28.17" class="difflineplus">+  IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l28.18"></a><span id="l28.18">   yield false;</span>
<a href="#l28.19"></a><span id="l28.19"> </span>
<a href="#l28.20"></a><span id="l28.20" class="difflineminus">-  do_check_eq(1, gIMAPInbox.getTotalMessages(false));</span>
<a href="#l28.21"></a><span id="l28.21" class="difflineplus">+  do_check_eq(1, IMAPPump.inbox.getTotalMessages(false));</span>
<a href="#l28.22"></a><span id="l28.22">   yield true;</span>
<a href="#l28.23"></a><span id="l28.23"> }</span>
<a href="#l28.24"></a><span id="l28.24"> </span>
<a href="#l28.25"></a><span id="l28.25"> // process each test from queue, calls itself upon completion of each search</span>
<a href="#l28.26"></a><span id="l28.26"> var testObject;</span>
<a href="#l28.27"></a><span id="l28.27"> function testSearch()</span>
<a href="#l28.28"></a><span id="l28.28"> {</span>
<a href="#l28.29"></a><span id="l28.29">   let test;</span>
<a href="#l28.30"></a><span id="l28.30">   while (test = searchTests.shift())</span>
<a href="#l28.31"></a><span id="l28.31">   {</span>
<a href="#l28.32"></a><span id="l28.32">     if (test &amp;&amp; test.dbHeader)</span>
<a href="#l28.33"></a><span id="l28.33">     {</span>
<a href="#l28.34"></a><span id="l28.34">       //  test of a custom db header</span>
<a href="#l28.35"></a><span id="l28.35">       dump(&quot;testing dbHeader &quot; + test.dbHeader + &quot;\n&quot;);</span>
<a href="#l28.36"></a><span id="l28.36" class="difflineminus">-      let customValue = mailTestUtils.firstMsgHdr(gIMAPInbox)</span>
<a href="#l28.37"></a><span id="l28.37" class="difflineplus">+      let customValue = mailTestUtils.firstMsgHdr(IMAPPump.inbox)</span>
<a href="#l28.38"></a><span id="l28.38">                                      .getProperty(test.dbHeader);</span>
<a href="#l28.39"></a><span id="l28.39">       do_check_eq(customValue, test.testString);</span>
<a href="#l28.40"></a><span id="l28.40">     }</span>
<a href="#l28.41"></a><span id="l28.41">     else if (test)</span>
<a href="#l28.42"></a><span id="l28.42">     {</span>
<a href="#l28.43"></a><span id="l28.43">       dump(&quot;testing for string '&quot; + test.testString + &quot;'\n&quot;);</span>
<a href="#l28.44"></a><span id="l28.44" class="difflineminus">-      testObject = new TestSearch(gIMAPInbox,</span>
<a href="#l28.45"></a><span id="l28.45" class="difflineplus">+      testObject = new TestSearch(IMAPPump.inbox,</span>
<a href="#l28.46"></a><span id="l28.46">                            test.testString,</span>
<a href="#l28.47"></a><span id="l28.47">                            test.testAttribute,</span>
<a href="#l28.48"></a><span id="l28.48">                            test.op,</span>
<a href="#l28.49"></a><span id="l28.49">                            test.count,</span>
<a href="#l28.50"></a><span id="l28.50">                            async_driver,</span>
<a href="#l28.51"></a><span id="l28.51">                            null,</span>
<a href="#l28.52"></a><span id="l28.52">                            test.customHeader ? test.customHeader : &quot;X-Bugzilla-Watch-Reason&quot;);</span>
<a href="#l28.53"></a><span id="l28.53">       yield false;</span>
<a href="#l28.54"></a><span id="l28.54" class="difflineat">@@ -290,17 +290,17 @@ function testSearch()</span>
<a href="#l28.55"></a><span id="l28.55"> function endTest()</span>
<a href="#l28.56"></a><span id="l28.56"> {</span>
<a href="#l28.57"></a><span id="l28.57">   teardownIMAPPump();</span>
<a href="#l28.58"></a><span id="l28.58"> }</span>
<a href="#l28.59"></a><span id="l28.59"> </span>
<a href="#l28.60"></a><span id="l28.60"> function run_test()</span>
<a href="#l28.61"></a><span id="l28.61"> {</span>
<a href="#l28.62"></a><span id="l28.62">   // don't use offline store</span>
<a href="#l28.63"></a><span id="l28.63" class="difflineminus">-  gIMAPInbox.clearFlag(Ci.nsMsgFolderFlags.Offline);</span>
<a href="#l28.64"></a><span id="l28.64" class="difflineplus">+  IMAPPump.inbox.clearFlag(Ci.nsMsgFolderFlags.Offline);</span>
<a href="#l28.65"></a><span id="l28.65"> </span>
<a href="#l28.66"></a><span id="l28.66">   async_run_tests(tests);</span>
<a href="#l28.67"></a><span id="l28.67"> }</span>
<a href="#l28.68"></a><span id="l28.68"> </span>
<a href="#l28.69"></a><span id="l28.69"> /*</span>
<a href="#l28.70"></a><span id="l28.70">  * helper function</span>
<a href="#l28.71"></a><span id="l28.71">  */</span>
<a href="#l28.72"></a><span id="l28.72"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapStatusCloseDBs.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapStatusCloseDBs.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -13,38 +13,38 @@ var tests = [</span>
<a href="#l29.4"></a><span id="l29.4">   teardown</span>
<a href="#l29.5"></a><span id="l29.5"> ];</span>
<a href="#l29.6"></a><span id="l29.6"> </span>
<a href="#l29.7"></a><span id="l29.7"> function setup() {</span>
<a href="#l29.8"></a><span id="l29.8">   Services.prefs.setBoolPref(&quot;mail.check_all_imap_folders_for_new&quot;, true);</span>
<a href="#l29.9"></a><span id="l29.9"> </span>
<a href="#l29.10"></a><span id="l29.10">   setupIMAPPump();</span>
<a href="#l29.11"></a><span id="l29.11"> </span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;folder 1&quot;, {subscribed : true});</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;folder 2&quot;, {subscribed : true});</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;folder 1&quot;, {subscribed : true});</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;folder 2&quot;, {subscribed : true});</span>
<a href="#l29.16"></a><span id="l29.16"> </span>
<a href="#l29.17"></a><span id="l29.17" class="difflineminus">-  gIMAPServer.performTest(&quot;SUBSCRIBE&quot;);</span>
<a href="#l29.18"></a><span id="l29.18" class="difflineplus">+  IMAPPump.server.performTest(&quot;SUBSCRIBE&quot;);</span>
<a href="#l29.19"></a><span id="l29.19"> </span>
<a href="#l29.20"></a><span id="l29.20" class="difflineminus">-  let rootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l29.21"></a><span id="l29.21" class="difflineplus">+  let rootFolder = IMAPPump.incomingServer.rootFolder;</span>
<a href="#l29.22"></a><span id="l29.22">   gFolder1 = rootFolder.getChildNamed(&quot;folder 1&quot;);</span>
<a href="#l29.23"></a><span id="l29.23">   gFolder2 = rootFolder.getChildNamed(&quot;folder 2&quot;);</span>
<a href="#l29.24"></a><span id="l29.24"> </span>
<a href="#l29.25"></a><span id="l29.25" class="difflineminus">-  gIMAPInbox.getNewMessages(null, null);</span>
<a href="#l29.26"></a><span id="l29.26" class="difflineminus">-  gIMAPServer.performTest(&quot;STATUS&quot;);</span>
<a href="#l29.27"></a><span id="l29.27" class="difflineplus">+  IMAPPump.inbox.getNewMessages(null, null);</span>
<a href="#l29.28"></a><span id="l29.28" class="difflineplus">+  IMAPPump.server.performTest(&quot;STATUS&quot;);</span>
<a href="#l29.29"></a><span id="l29.29">   // don't know if this will work, but we'll try. Wait for</span>
<a href="#l29.30"></a><span id="l29.30">   // second status response</span>
<a href="#l29.31"></a><span id="l29.31" class="difflineminus">-  gIMAPServer.performTest(&quot;STATUS&quot;);</span>
<a href="#l29.32"></a><span id="l29.32" class="difflineplus">+  IMAPPump.server.performTest(&quot;STATUS&quot;);</span>
<a href="#l29.33"></a><span id="l29.33">   mailTestUtils.do_timeout_function(1000, async_driver);</span>
<a href="#l29.34"></a><span id="l29.34">   yield false;</span>
<a href="#l29.35"></a><span id="l29.35"> }</span>
<a href="#l29.36"></a><span id="l29.36"> </span>
<a href="#l29.37"></a><span id="l29.37"> function check() {</span>
<a href="#l29.38"></a><span id="l29.38">   const gDbService = Cc[&quot;@mozilla.org/msgDatabase/msgDBService;1&quot;]</span>
<a href="#l29.39"></a><span id="l29.39">                        .getService(Ci.nsIMsgDBService);</span>
<a href="#l29.40"></a><span id="l29.40" class="difflineminus">-  do_check_neq(gDbService.cachedDBForFolder(gIMAPInbox), null);</span>
<a href="#l29.41"></a><span id="l29.41" class="difflineplus">+  do_check_neq(gDbService.cachedDBForFolder(IMAPPump.inbox), null);</span>
<a href="#l29.42"></a><span id="l29.42">   do_check_eq(gDbService.cachedDBForFolder(gFolder1), null);</span>
<a href="#l29.43"></a><span id="l29.43">   do_check_eq(gDbService.cachedDBForFolder(gFolder2), null);</span>
<a href="#l29.44"></a><span id="l29.44"> }</span>
<a href="#l29.45"></a><span id="l29.45"> </span>
<a href="#l29.46"></a><span id="l29.46"> function teardown() {</span>
<a href="#l29.47"></a><span id="l29.47">   teardownIMAPPump();</span>
<a href="#l29.48"></a><span id="l29.48"> }</span>
<a href="#l29.49"></a><span id="l29.49"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapStoreMsgOffline.js</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapStoreMsgOffline.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -89,91 +89,91 @@ function setup() {</span>
<a href="#l30.4"></a><span id="l30.4">   // Services.prefs.setIntPref(&quot;mail.imap.mime_parts_on_demand_threshold&quot;, 3000);</span>
<a href="#l30.5"></a><span id="l30.5"> </span>
<a href="#l30.6"></a><span id="l30.6">   setupIMAPPump();</span>
<a href="#l30.7"></a><span id="l30.7"> </span>
<a href="#l30.8"></a><span id="l30.8">   // these hacks are required because we've created the inbox before</span>
<a href="#l30.9"></a><span id="l30.9">   // running initial folder discovery, and adding the folder bails</span>
<a href="#l30.10"></a><span id="l30.10">   // out before we set it as verified online, so we bail out, and</span>
<a href="#l30.11"></a><span id="l30.11">   // then remove the INBOX folder since it's not verified.</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-  gIMAPInbox.hierarchyDelimiter = '/';</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineminus">-  gIMAPInbox.verifiedAsOnlineFolder = true;</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineplus">+  IMAPPump.inbox.hierarchyDelimiter = '/';</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineplus">+  IMAPPump.inbox.verifiedAsOnlineFolder = true;</span>
<a href="#l30.16"></a><span id="l30.16"> </span>
<a href="#l30.17"></a><span id="l30.17"> </span>
<a href="#l30.18"></a><span id="l30.18">   // Add a couple of messages to the INBOX</span>
<a href="#l30.19"></a><span id="l30.19">   // this is synchronous, afaik</span>
<a href="#l30.20"></a><span id="l30.20">   addMessagesToServer([{file: gMsgFile1, messageId: gMsgId1},</span>
<a href="#l30.21"></a><span id="l30.21">                         {file: gMsgFile2, messageId: gMsgId2},</span>
<a href="#l30.22"></a><span id="l30.22">                         {file: gMsgFile3, messageId: gMsgId3},</span>
<a href="#l30.23"></a><span id="l30.23"> //                         {file: gMsgFile5, messageId: gMsgId5},</span>
<a href="#l30.24"></a><span id="l30.24">                       ],</span>
<a href="#l30.25"></a><span id="l30.25" class="difflineminus">-                        gIMAPDaemon.getMailbox(&quot;INBOX&quot;), gIMAPInbox);</span>
<a href="#l30.26"></a><span id="l30.26" class="difflineplus">+                        IMAPPump.daemon.getMailbox(&quot;INBOX&quot;), IMAPPump.inbox);</span>
<a href="#l30.27"></a><span id="l30.27"> }</span>
<a href="#l30.28"></a><span id="l30.28"> </span>
<a href="#l30.29"></a><span id="l30.29"> var gIMAPService;</span>
<a href="#l30.30"></a><span id="l30.30"> </span>
<a href="#l30.31"></a><span id="l30.31"> var tests = [</span>
<a href="#l30.32"></a><span id="l30.32">   setup,</span>
<a href="#l30.33"></a><span id="l30.33">   function updateFolder() {</span>
<a href="#l30.34"></a><span id="l30.34" class="difflineminus">-    gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l30.35"></a><span id="l30.35" class="difflineplus">+    IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l30.36"></a><span id="l30.36">     yield false;</span>
<a href="#l30.37"></a><span id="l30.37">   },</span>
<a href="#l30.38"></a><span id="l30.38">   function selectFirstMsg() {</span>
<a href="#l30.39"></a><span id="l30.39"> </span>
<a href="#l30.40"></a><span id="l30.40">   // We postpone creating the imap service until after we've set the prefs</span>
<a href="#l30.41"></a><span id="l30.41">   // that it reads on its startup.</span>
<a href="#l30.42"></a><span id="l30.42">   gIMAPService = Cc[&quot;@mozilla.org/messenger/messageservice;1?type=imap&quot;]</span>
<a href="#l30.43"></a><span id="l30.43">                        .getService(Ci.nsIMsgMessageService);</span>
<a href="#l30.44"></a><span id="l30.44"> </span>
<a href="#l30.45"></a><span id="l30.45" class="difflineminus">-    let db = gIMAPInbox.msgDatabase;</span>
<a href="#l30.46"></a><span id="l30.46" class="difflineplus">+    let db = IMAPPump.inbox.msgDatabase;</span>
<a href="#l30.47"></a><span id="l30.47">     let msg1 = db.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l30.48"></a><span id="l30.48">     let url = new Object;</span>
<a href="#l30.49"></a><span id="l30.49" class="difflineminus">-    gIMAPService.DisplayMessage(gIMAPInbox.getUriForMsg(msg1),</span>
<a href="#l30.50"></a><span id="l30.50" class="difflineplus">+    gIMAPService.DisplayMessage(IMAPPump.inbox.getUriForMsg(msg1),</span>
<a href="#l30.51"></a><span id="l30.51">                                             streamListener,</span>
<a href="#l30.52"></a><span id="l30.52">                                             null,</span>
<a href="#l30.53"></a><span id="l30.53">                                             asyncUrlListener,</span>
<a href="#l30.54"></a><span id="l30.54">                                             null,</span>
<a href="#l30.55"></a><span id="l30.55">                                             url);</span>
<a href="#l30.56"></a><span id="l30.56">     yield false;</span>
<a href="#l30.57"></a><span id="l30.57">   },</span>
<a href="#l30.58"></a><span id="l30.58">   function select2ndMsg() {</span>
<a href="#l30.59"></a><span id="l30.59" class="difflineminus">-    let msg1 = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l30.60"></a><span id="l30.60" class="difflineplus">+    let msg1 = IMAPPump.inbox.msgDatabase.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l30.61"></a><span id="l30.61">     do_check_neq(msg1.flags &amp; nsMsgMessageFlags.Offline, 0);</span>
<a href="#l30.62"></a><span id="l30.62" class="difflineminus">-    let db = gIMAPInbox.msgDatabase;</span>
<a href="#l30.63"></a><span id="l30.63" class="difflineplus">+    let db = IMAPPump.inbox.msgDatabase;</span>
<a href="#l30.64"></a><span id="l30.64">     let msg2 = db.getMsgHdrForMessageID(gMsgId2);</span>
<a href="#l30.65"></a><span id="l30.65">     let url = new Object;</span>
<a href="#l30.66"></a><span id="l30.66" class="difflineminus">-    gIMAPService.DisplayMessage(gIMAPInbox.getUriForMsg(msg2),</span>
<a href="#l30.67"></a><span id="l30.67" class="difflineplus">+    gIMAPService.DisplayMessage(IMAPPump.inbox.getUriForMsg(msg2),</span>
<a href="#l30.68"></a><span id="l30.68">                                             streamListener,</span>
<a href="#l30.69"></a><span id="l30.69">                                             null,</span>
<a href="#l30.70"></a><span id="l30.70">                                             asyncUrlListener,</span>
<a href="#l30.71"></a><span id="l30.71">                                             null,</span>
<a href="#l30.72"></a><span id="l30.72">                                             url);</span>
<a href="#l30.73"></a><span id="l30.73">     yield false;</span>
<a href="#l30.74"></a><span id="l30.74">   },</span>
<a href="#l30.75"></a><span id="l30.75">   function select3rdMsg() {</span>
<a href="#l30.76"></a><span id="l30.76" class="difflineminus">-    let msg2 = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gMsgId2);</span>
<a href="#l30.77"></a><span id="l30.77" class="difflineplus">+    let msg2 = IMAPPump.inbox.msgDatabase.getMsgHdrForMessageID(gMsgId2);</span>
<a href="#l30.78"></a><span id="l30.78">     do_check_neq(msg2.flags &amp; nsMsgMessageFlags.Offline, 0);</span>
<a href="#l30.79"></a><span id="l30.79" class="difflineminus">-    let db = gIMAPInbox.msgDatabase;</span>
<a href="#l30.80"></a><span id="l30.80" class="difflineplus">+    let db = IMAPPump.inbox.msgDatabase;</span>
<a href="#l30.81"></a><span id="l30.81">     let msg3 = db.getMsgHdrForMessageID(gMsgId3);</span>
<a href="#l30.82"></a><span id="l30.82">     let url = new Object;</span>
<a href="#l30.83"></a><span id="l30.83" class="difflineminus">-    gIMAPService.DisplayMessage(gIMAPInbox.getUriForMsg(msg3),</span>
<a href="#l30.84"></a><span id="l30.84" class="difflineplus">+    gIMAPService.DisplayMessage(IMAPPump.inbox.getUriForMsg(msg3),</span>
<a href="#l30.85"></a><span id="l30.85">                                             streamListener,</span>
<a href="#l30.86"></a><span id="l30.86">                                             null,</span>
<a href="#l30.87"></a><span id="l30.87">                                             asyncUrlListener,</span>
<a href="#l30.88"></a><span id="l30.88">                                             null,</span>
<a href="#l30.89"></a><span id="l30.89">                                             url);</span>
<a href="#l30.90"></a><span id="l30.90">     yield false;</span>
<a href="#l30.91"></a><span id="l30.91">   },</span>
<a href="#l30.92"></a><span id="l30.92">   function verify3rdMsg() {</span>
<a href="#l30.93"></a><span id="l30.93" class="difflineminus">-    let msg3 = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gMsgId3);</span>
<a href="#l30.94"></a><span id="l30.94" class="difflineplus">+    let msg3 = IMAPPump.inbox.msgDatabase.getMsgHdrForMessageID(gMsgId3);</span>
<a href="#l30.95"></a><span id="l30.95">     // can't turn this on because our fake server doesn't support body structure.</span>
<a href="#l30.96"></a><span id="l30.96"> //    do_check_eq(msg3.flags &amp; nsMsgMessageFlags.Offline, 0);</span>
<a href="#l30.97"></a><span id="l30.97">   },</span>
<a href="#l30.98"></a><span id="l30.98">   function addNewMsgs() {</span>
<a href="#l30.99"></a><span id="l30.99" class="difflineminus">-    let mbox = gIMAPDaemon.getMailbox(&quot;INBOX&quot;)</span>
<a href="#l30.100"></a><span id="l30.100" class="difflineplus">+    let mbox = IMAPPump.daemon.getMailbox(&quot;INBOX&quot;)</span>
<a href="#l30.101"></a><span id="l30.101">     // make a couple messges</span>
<a href="#l30.102"></a><span id="l30.102">     let messages = [];</span>
<a href="#l30.103"></a><span id="l30.103">     let bodyString = &quot;&quot;;</span>
<a href="#l30.104"></a><span id="l30.104">     for (i = 0; i &lt; 100; i++)</span>
<a href="#l30.105"></a><span id="l30.105">       bodyString += &quot;1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890\r\n&quot;;</span>
<a href="#l30.106"></a><span id="l30.106"> </span>
<a href="#l30.107"></a><span id="l30.107">     let gMessageGenerator = new MessageGenerator();</span>
<a href="#l30.108"></a><span id="l30.108">     messages = messages.concat(gMessageGenerator.makeMessage({body: {body: bodyString, contentType: &quot;text/plain&quot;}}));</span>
<a href="#l30.109"></a><span id="l30.109" class="difflineat">@@ -184,47 +184,47 @@ var tests = [</span>
<a href="#l30.110"></a><span id="l30.110"> </span>
<a href="#l30.111"></a><span id="l30.111">     messages.forEach(function (message)</span>
<a href="#l30.112"></a><span id="l30.112">     {</span>
<a href="#l30.113"></a><span id="l30.113">       let dataUri = Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l30.114"></a><span id="l30.114">                                        btoa(message.toMessageString()),</span>
<a href="#l30.115"></a><span id="l30.115">                                        null, null);</span>
<a href="#l30.116"></a><span id="l30.116">       mbox.addMessage(new imapMessage(dataUri.spec, mbox.uidnext++, []));</span>
<a href="#l30.117"></a><span id="l30.117">     });</span>
<a href="#l30.118"></a><span id="l30.118" class="difflineminus">-    gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l30.119"></a><span id="l30.119" class="difflineplus">+    IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l30.120"></a><span id="l30.120">     yield false;</span>
<a href="#l30.121"></a><span id="l30.121">   },</span>
<a href="#l30.122"></a><span id="l30.122">   function testQueuedOfflineDownload()</span>
<a href="#l30.123"></a><span id="l30.123">   {</span>
<a href="#l30.124"></a><span id="l30.124">     // Make sure that streaming the same message and then trying to download</span>
<a href="#l30.125"></a><span id="l30.125">     // it for offline use doesn't end up in it getting added to the offline </span>
<a href="#l30.126"></a><span id="l30.126">     // store twice.</span>
<a href="#l30.127"></a><span id="l30.127" class="difflineminus">-    gImapInboxOfflineStoreSize = gIMAPInbox.filePath.fileSize + gFirstMsgSize;</span>
<a href="#l30.128"></a><span id="l30.128" class="difflineminus">-    let newMsgHdr = gIMAPInbox.GetMessageHeader(gFirstNewMsg);</span>
<a href="#l30.129"></a><span id="l30.129" class="difflineplus">+    gImapInboxOfflineStoreSize = IMAPPump.inbox.filePath.fileSize + gFirstMsgSize;</span>
<a href="#l30.130"></a><span id="l30.130" class="difflineplus">+    let newMsgHdr = IMAPPump.inbox.GetMessageHeader(gFirstNewMsg);</span>
<a href="#l30.131"></a><span id="l30.131">     let msgURI = newMsgHdr.folder.getUriForMsg(newMsgHdr);</span>
<a href="#l30.132"></a><span id="l30.132">     let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l30.133"></a><span id="l30.133">     let msgServ = messenger.messageServiceFromURI(msgURI);</span>
<a href="#l30.134"></a><span id="l30.134">     msgServ.streamMessage(msgURI, gStreamListener, null, null, false, &quot;&quot;, false);</span>
<a href="#l30.135"></a><span id="l30.135">     yield false;</span>
<a href="#l30.136"></a><span id="l30.136">   },</span>
<a href="#l30.137"></a><span id="l30.137">   function firstStreamFinished()</span>
<a href="#l30.138"></a><span id="l30.138">   {</span>
<a href="#l30.139"></a><span id="l30.139">     // nsIMsgFolder.DownloadMessagesForOffline does not take a listener, so</span>
<a href="#l30.140"></a><span id="l30.140">     // we invoke nsIImapService.downloadMessagesForOffline directly with a </span>
<a href="#l30.141"></a><span id="l30.141">     // listener.</span>
<a href="#l30.142"></a><span id="l30.142">     MailServices.imap.downloadMessagesForOffline(gFirstNewMsg,</span>
<a href="#l30.143"></a><span id="l30.143" class="difflineminus">-                                                 gIMAPInbox,</span>
<a href="#l30.144"></a><span id="l30.144" class="difflineplus">+                                                 IMAPPump.inbox,</span>
<a href="#l30.145"></a><span id="l30.145">                                                  asyncUrlListener,</span>
<a href="#l30.146"></a><span id="l30.146">                                                  null);</span>
<a href="#l30.147"></a><span id="l30.147">     yield false;</span>
<a href="#l30.148"></a><span id="l30.148">   },</span>
<a href="#l30.149"></a><span id="l30.149">   function checkOfflineStoreSize()</span>
<a href="#l30.150"></a><span id="l30.150">   {</span>
<a href="#l30.151"></a><span id="l30.151">     dump(&quot;checking offline store size\n&quot;);</span>
<a href="#l30.152"></a><span id="l30.152" class="difflineminus">-    do_check_true(gIMAPInbox.filePath.fileSize &lt;= gImapInboxOfflineStoreSize);</span>
<a href="#l30.153"></a><span id="l30.153" class="difflineplus">+    do_check_true(IMAPPump.inbox.filePath.fileSize &lt;= gImapInboxOfflineStoreSize);</span>
<a href="#l30.154"></a><span id="l30.154">   },</span>
<a href="#l30.155"></a><span id="l30.155">   teardown</span>
<a href="#l30.156"></a><span id="l30.156"> ]</span>
<a href="#l30.157"></a><span id="l30.157"> </span>
<a href="#l30.158"></a><span id="l30.158"> let gStreamListener = {</span>
<a href="#l30.159"></a><span id="l30.159">   QueryInterface : XPCOMUtils.generateQI([Ci.nsIStreamListener]),</span>
<a href="#l30.160"></a><span id="l30.160">   _stream : null,</span>
<a href="#l30.161"></a><span id="l30.161">   _data : null,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapUndo.js</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapUndo.js</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -63,50 +63,50 @@ alertListener.prototype = {</span>
<a href="#l31.4"></a><span id="l31.4">     dump(&quot;got alert &quot; + aMessage + &quot;\n&quot;);</span>
<a href="#l31.5"></a><span id="l31.5">     do_throw ('TEST FAILED ' + aMessage);</span>
<a href="#l31.6"></a><span id="l31.6">   }</span>
<a href="#l31.7"></a><span id="l31.7"> };</span>
<a href="#l31.8"></a><span id="l31.8"> </span>
<a href="#l31.9"></a><span id="l31.9"> var tests = [</span>
<a href="#l31.10"></a><span id="l31.10">   setup,</span>
<a href="#l31.11"></a><span id="l31.11">   function updateFolder() {</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-    gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+    IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l31.14"></a><span id="l31.14">     yield false;</span>
<a href="#l31.15"></a><span id="l31.15">   },</span>
<a href="#l31.16"></a><span id="l31.16">   function deleteMessage() {</span>
<a href="#l31.17"></a><span id="l31.17" class="difflineminus">-    let msgToDelete = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l31.18"></a><span id="l31.18" class="difflineplus">+    let msgToDelete = IMAPPump.inbox.msgDatabase.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l31.19"></a><span id="l31.19">     gMessages.appendElement(msgToDelete, false);</span>
<a href="#l31.20"></a><span id="l31.20" class="difflineminus">-    gIMAPInbox.deleteMessages(gMessages, gMsgWindow, false, true, asyncCopyListener, true);</span>
<a href="#l31.21"></a><span id="l31.21" class="difflineplus">+    IMAPPump.inbox.deleteMessages(gMessages, gMsgWindow, false, true, asyncCopyListener, true);</span>
<a href="#l31.22"></a><span id="l31.22">     yield false;</span>
<a href="#l31.23"></a><span id="l31.23">   },</span>
<a href="#l31.24"></a><span id="l31.24">   function expunge() {</span>
<a href="#l31.25"></a><span id="l31.25" class="difflineminus">-    gIMAPInbox.expunge(asyncUrlListener, gMsgWindow);</span>
<a href="#l31.26"></a><span id="l31.26" class="difflineplus">+    IMAPPump.inbox.expunge(asyncUrlListener, gMsgWindow);</span>
<a href="#l31.27"></a><span id="l31.27">     yield false;</span>
<a href="#l31.28"></a><span id="l31.28"> </span>
<a href="#l31.29"></a><span id="l31.29">     // Ensure that the message has been surely deleted.</span>
<a href="#l31.30"></a><span id="l31.30" class="difflineminus">-    do_check_eq(gIMAPInbox.msgDatabase.dBFolderInfo.numMessages, 3);</span>
<a href="#l31.31"></a><span id="l31.31" class="difflineplus">+    do_check_eq(IMAPPump.inbox.msgDatabase.dBFolderInfo.numMessages, 3);</span>
<a href="#l31.32"></a><span id="l31.32">   },</span>
<a href="#l31.33"></a><span id="l31.33">   function undoDelete() {</span>
<a href="#l31.34"></a><span id="l31.34">     gMsgWindow.transactionManager.undoTransaction();</span>
<a href="#l31.35"></a><span id="l31.35">     // after undo, we select the trash and then the inbox, so that we sync</span>
<a href="#l31.36"></a><span id="l31.36">     // up with the server, and clear out the effects of having done the</span>
<a href="#l31.37"></a><span id="l31.37">     // delete offline.</span>
<a href="#l31.38"></a><span id="l31.38">     let trash = gRootFolder.getChildNamed(&quot;Trash&quot;);</span>
<a href="#l31.39"></a><span id="l31.39">     trash.QueryInterface(Ci.nsIMsgImapMailFolder)</span>
<a href="#l31.40"></a><span id="l31.40">          .updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l31.41"></a><span id="l31.41">     yield false;</span>
<a href="#l31.42"></a><span id="l31.42">   },</span>
<a href="#l31.43"></a><span id="l31.43">   function goBackToInbox() {</span>
<a href="#l31.44"></a><span id="l31.44" class="difflineminus">-    gIMAPInbox.updateFolderWithListener(gMsgWindow, asyncUrlListener);</span>
<a href="#l31.45"></a><span id="l31.45" class="difflineplus">+    IMAPPump.inbox.updateFolderWithListener(gMsgWindow, asyncUrlListener);</span>
<a href="#l31.46"></a><span id="l31.46">     yield false;</span>
<a href="#l31.47"></a><span id="l31.47">   },</span>
<a href="#l31.48"></a><span id="l31.48">   function verifyFolders() {</span>
<a href="#l31.49"></a><span id="l31.49" class="difflineminus">-    let msgRestored = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l31.50"></a><span id="l31.50" class="difflineplus">+    let msgRestored = IMAPPump.inbox.msgDatabase.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l31.51"></a><span id="l31.51">     do_check_neq(msgRestored, null);</span>
<a href="#l31.52"></a><span id="l31.52" class="difflineminus">-    do_check_eq(gIMAPInbox.msgDatabase.dBFolderInfo.numMessages, 4);</span>
<a href="#l31.53"></a><span id="l31.53" class="difflineplus">+    do_check_eq(IMAPPump.inbox.msgDatabase.dBFolderInfo.numMessages, 4);</span>
<a href="#l31.54"></a><span id="l31.54">   },</span>
<a href="#l31.55"></a><span id="l31.55">   teardown</span>
<a href="#l31.56"></a><span id="l31.56"> ];</span>
<a href="#l31.57"></a><span id="l31.57"> </span>
<a href="#l31.58"></a><span id="l31.58"> function setup() {</span>
<a href="#l31.59"></a><span id="l31.59">   setupIMAPPump();</span>
<a href="#l31.60"></a><span id="l31.60"> </span>
<a href="#l31.61"></a><span id="l31.61">   var listener1 = new alertListener();</span>
<a href="#l31.62"></a><span id="l31.62" class="difflineat">@@ -114,32 +114,32 @@ function setup() {</span>
<a href="#l31.63"></a><span id="l31.63">   MailServices.mailSession.addUserFeedbackListener(listener1);</span>
<a href="#l31.64"></a><span id="l31.64"> </span>
<a href="#l31.65"></a><span id="l31.65">   Services.prefs.setBoolPref(&quot;mail.server.server1.autosync_offline_stores&quot;, false);</span>
<a href="#l31.66"></a><span id="l31.66">   Services.prefs.setBoolPref(&quot;mail.server.server1.offline_download&quot;, false);</span>
<a href="#l31.67"></a><span id="l31.67"> </span>
<a href="#l31.68"></a><span id="l31.68">   gMsgWindow = Cc[&quot;@mozilla.org/messenger/msgwindow;1&quot;]</span>
<a href="#l31.69"></a><span id="l31.69">                   .createInstance(Components.interfaces.nsIMsgWindow);</span>
<a href="#l31.70"></a><span id="l31.70"> </span>
<a href="#l31.71"></a><span id="l31.71" class="difflineminus">-  gRootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l31.72"></a><span id="l31.72" class="difflineplus">+  gRootFolder = IMAPPump.incomingServer.rootFolder;</span>
<a href="#l31.73"></a><span id="l31.73">   // these hacks are required because we've created the inbox before</span>
<a href="#l31.74"></a><span id="l31.74">   // running initial folder discovery, and adding the folder bails</span>
<a href="#l31.75"></a><span id="l31.75">   // out before we set it as verified online, so we bail out, and</span>
<a href="#l31.76"></a><span id="l31.76">   // then remove the INBOX folder since it's not verified.</span>
<a href="#l31.77"></a><span id="l31.77" class="difflineminus">-  gIMAPInbox.hierarchyDelimiter = '/';</span>
<a href="#l31.78"></a><span id="l31.78" class="difflineminus">-  gIMAPInbox.verifiedAsOnlineFolder = true;</span>
<a href="#l31.79"></a><span id="l31.79" class="difflineplus">+  IMAPPump.inbox.hierarchyDelimiter = '/';</span>
<a href="#l31.80"></a><span id="l31.80" class="difflineplus">+  IMAPPump.inbox.verifiedAsOnlineFolder = true;</span>
<a href="#l31.81"></a><span id="l31.81"> </span>
<a href="#l31.82"></a><span id="l31.82"> </span>
<a href="#l31.83"></a><span id="l31.83">   // Add a couple of messages to the INBOX</span>
<a href="#l31.84"></a><span id="l31.84">   // this is synchronous, afaik</span>
<a href="#l31.85"></a><span id="l31.85">   addMessagesToServer([{file: gMsgFile1, messageId: gMsgId1},</span>
<a href="#l31.86"></a><span id="l31.86">                        {file: gMsgFile4, messageId: gMsgId4},</span>
<a href="#l31.87"></a><span id="l31.87">                        {file: gMsgFile5, messageId: gMsgId5},</span>
<a href="#l31.88"></a><span id="l31.88">                        {file: gMsgFile2, messageId: gMsgId2}],</span>
<a href="#l31.89"></a><span id="l31.89" class="difflineminus">-                      gIMAPMailbox, gIMAPInbox);</span>
<a href="#l31.90"></a><span id="l31.90" class="difflineplus">+                      IMAPPump.mailbox, IMAPPump.inbox);</span>
<a href="#l31.91"></a><span id="l31.91"> }</span>
<a href="#l31.92"></a><span id="l31.92"> </span>
<a href="#l31.93"></a><span id="l31.93"> asyncUrlListener.callback = function(aUrl, aExitCode) {</span>
<a href="#l31.94"></a><span id="l31.94">   do_check_eq(aExitCode, 0);</span>
<a href="#l31.95"></a><span id="l31.95"> };</span>
<a href="#l31.96"></a><span id="l31.96"> </span>
<a href="#l31.97"></a><span id="l31.97"> function teardown() {</span>
<a href="#l31.98"></a><span id="l31.98">   // Cleanup, null out everything, close all cached connections and stop the</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_largeOfflineStore.js</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_largeOfflineStore.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -19,17 +19,17 @@ var tests = [</span>
<a href="#l32.4"></a><span id="l32.4">   check_result,</span>
<a href="#l32.5"></a><span id="l32.5">   teardown</span>
<a href="#l32.6"></a><span id="l32.6"> ];</span>
<a href="#l32.7"></a><span id="l32.7"> </span>
<a href="#l32.8"></a><span id="l32.8"> function run_test() {</span>
<a href="#l32.9"></a><span id="l32.9">   setupIMAPPump();</span>
<a href="#l32.10"></a><span id="l32.10"> </span>
<a href="#l32.11"></a><span id="l32.11">   // Figure out the name of the IMAP inbox</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-  let inboxFile = gIMAPIncomingServer.rootMsgFolder.filePath;</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineplus">+  let inboxFile = IMAPPump.incomingServer.rootMsgFolder.filePath;</span>
<a href="#l32.14"></a><span id="l32.14">   inboxFile.append(&quot;INBOX&quot;);</span>
<a href="#l32.15"></a><span id="l32.15">   if (!inboxFile.exists())</span>
<a href="#l32.16"></a><span id="l32.16">     inboxFile.create(Ci.nsIFile.NORMAL_FILE_TYPE, parseInt(&quot;0644&quot;, 8));</span>
<a href="#l32.17"></a><span id="l32.17"> </span>
<a href="#l32.18"></a><span id="l32.18">   let neededFreeSpace = 0x200000000;</span>
<a href="#l32.19"></a><span id="l32.19">   // On Windows, check whether the drive is NTFS. If it is, mark the file as</span>
<a href="#l32.20"></a><span id="l32.20">   // sparse. If it isn't, then bail out now, because in all probability it is</span>
<a href="#l32.21"></a><span id="l32.21">   // FAT32, which doesn't support file sizes greater than 4 GB.</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineat">@@ -61,74 +61,74 @@ function setup() {</span>
<a href="#l32.23"></a><span id="l32.23">   let messages = [];</span>
<a href="#l32.24"></a><span id="l32.24">   let messageGenerator = new MessageGenerator();</span>
<a href="#l32.25"></a><span id="l32.25">   let scenarioFactory = new MessageScenarioFactory(messageGenerator);</span>
<a href="#l32.26"></a><span id="l32.26"> </span>
<a href="#l32.27"></a><span id="l32.27">   messages = messages.concat(scenarioFactory.directReply(2));</span>
<a href="#l32.28"></a><span id="l32.28">   let dataUri = Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l32.29"></a><span id="l32.29">                                    btoa(messages[0].toMessageString()),</span>
<a href="#l32.30"></a><span id="l32.30">                                    null, null);</span>
<a href="#l32.31"></a><span id="l32.31" class="difflineminus">-  let imapMsg = new imapMessage(dataUri.spec, gIMAPMailbox.uidnext++, []);</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineminus">-  gIMAPMailbox.addMessage(imapMsg);</span>
<a href="#l32.33"></a><span id="l32.33" class="difflineplus">+  let imapMsg = new imapMessage(dataUri.spec, IMAPPump.mailbox.uidnext++, []);</span>
<a href="#l32.34"></a><span id="l32.34" class="difflineplus">+  IMAPPump.mailbox.addMessage(imapMsg);</span>
<a href="#l32.35"></a><span id="l32.35"> </span>
<a href="#l32.36"></a><span id="l32.36">   dataUri = Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l32.37"></a><span id="l32.37">                                btoa(messages[1].toMessageString()),</span>
<a href="#l32.38"></a><span id="l32.38">                                null, null);</span>
<a href="#l32.39"></a><span id="l32.39" class="difflineminus">-  imapMsg = new imapMessage(dataUri.spec, gIMAPMailbox.uidnext++, []);</span>
<a href="#l32.40"></a><span id="l32.40" class="difflineminus">-  gIMAPMailbox.addMessage(imapMsg);</span>
<a href="#l32.41"></a><span id="l32.41" class="difflineplus">+  imapMsg = new imapMessage(dataUri.spec, IMAPPump.mailbox.uidnext++, []);</span>
<a href="#l32.42"></a><span id="l32.42" class="difflineplus">+  IMAPPump.mailbox.addMessage(imapMsg);</span>
<a href="#l32.43"></a><span id="l32.43"> </span>
<a href="#l32.44"></a><span id="l32.44">   // Extend local IMAP inbox to over 4 GiB.</span>
<a href="#l32.45"></a><span id="l32.45">   let outputStream = Cc[&quot;@mozilla.org/network/file-output-stream;1&quot;]</span>
<a href="#l32.46"></a><span id="l32.46">                        .createInstance(Ci.nsIFileOutputStream)</span>
<a href="#l32.47"></a><span id="l32.47">                        .QueryInterface(Ci.nsISeekableStream);</span>
<a href="#l32.48"></a><span id="l32.48">   // Open in write-only mode, no truncate.</span>
<a href="#l32.49"></a><span id="l32.49" class="difflineminus">-  outputStream.init(gIMAPInbox.filePath, 0x02, -1, 0);</span>
<a href="#l32.50"></a><span id="l32.50" class="difflineplus">+  outputStream.init(IMAPPump.inbox.filePath, 0x02, -1, 0);</span>
<a href="#l32.51"></a><span id="l32.51">   // seek to 15 bytes past 4GB.</span>
<a href="#l32.52"></a><span id="l32.52">   outputStream.seek(0, 0x10000000f);</span>
<a href="#l32.53"></a><span id="l32.53">   // Write an empty &quot;from&quot; line.</span>
<a href="#l32.54"></a><span id="l32.54">   outputStream.write(&quot;from\r\n&quot;, 6);</span>
<a href="#l32.55"></a><span id="l32.55">   outputStream.close();</span>
<a href="#l32.56"></a><span id="l32.56"> </span>
<a href="#l32.57"></a><span id="l32.57">   // Save initial file size.</span>
<a href="#l32.58"></a><span id="l32.58" class="difflineminus">-  gOfflineStoreSize = gIMAPInbox.filePath.fileSize;</span>
<a href="#l32.59"></a><span id="l32.59" class="difflineplus">+  gOfflineStoreSize = IMAPPump.inbox.filePath.fileSize;</span>
<a href="#l32.60"></a><span id="l32.60">   do_print(&quot;Offline store size (before 1st downloadAllForOffline()) = &quot; +</span>
<a href="#l32.61"></a><span id="l32.61">            gOfflineStoreSize);</span>
<a href="#l32.62"></a><span id="l32.62"> </span>
<a href="#l32.63"></a><span id="l32.63">   // Download for offline use, to append created messages to local IMAP inbox.</span>
<a href="#l32.64"></a><span id="l32.64" class="difflineminus">-  gIMAPInbox.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l32.65"></a><span id="l32.65" class="difflineplus">+  IMAPPump.inbox.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l32.66"></a><span id="l32.66">   yield false;</span>
<a href="#l32.67"></a><span id="l32.67"> }</span>
<a href="#l32.68"></a><span id="l32.68"> </span>
<a href="#l32.69"></a><span id="l32.69"> function check_result() {</span>
<a href="#l32.70"></a><span id="l32.70">   // Call downloadAllForOffline() a second time.</span>
<a href="#l32.71"></a><span id="l32.71" class="difflineminus">-  gIMAPInbox.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l32.72"></a><span id="l32.72" class="difflineplus">+  IMAPPump.inbox.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l32.73"></a><span id="l32.73">   yield false;</span>
<a href="#l32.74"></a><span id="l32.74"> </span>
<a href="#l32.75"></a><span id="l32.75">   // Make sure offline store grew (i.e., we were not writing over data).</span>
<a href="#l32.76"></a><span id="l32.76" class="difflineminus">-  let offlineStoreSize = gIMAPInbox.filePath.fileSize;</span>
<a href="#l32.77"></a><span id="l32.77" class="difflineplus">+  let offlineStoreSize = IMAPPump.inbox.filePath.fileSize;</span>
<a href="#l32.78"></a><span id="l32.78">   do_print(&quot;Offline store size (after 2nd downloadAllForOffline()) = &quot; +</span>
<a href="#l32.79"></a><span id="l32.79">            offlineStoreSize + &quot;. (Msg hdr offsets should be close to it.)&quot;);</span>
<a href="#l32.80"></a><span id="l32.80">   do_check_true(offlineStoreSize &gt; gOfflineStoreSize);</span>
<a href="#l32.81"></a><span id="l32.81"> </span>
<a href="#l32.82"></a><span id="l32.82">   // Verify that the message headers have the offline flag set.</span>
<a href="#l32.83"></a><span id="l32.83" class="difflineminus">-  let msgEnumerator = gIMAPInbox.msgDatabase.EnumerateMessages();</span>
<a href="#l32.84"></a><span id="l32.84" class="difflineplus">+  let msgEnumerator = IMAPPump.inbox.msgDatabase.EnumerateMessages();</span>
<a href="#l32.85"></a><span id="l32.85">   let offset = {};</span>
<a href="#l32.86"></a><span id="l32.86">   let size = {};</span>
<a href="#l32.87"></a><span id="l32.87">   while (msgEnumerator.hasMoreElements()) {</span>
<a href="#l32.88"></a><span id="l32.88">     let header = msgEnumerator.getNext();</span>
<a href="#l32.89"></a><span id="l32.89">     // Verify that each message has been downloaded and looks OK.</span>
<a href="#l32.90"></a><span id="l32.90">     if (!(header instanceof Components.interfaces.nsIMsgDBHdr &amp;&amp;</span>
<a href="#l32.91"></a><span id="l32.91">           (header.flags &amp; Ci.nsMsgMessageFlags.Offline)))</span>
<a href="#l32.92"></a><span id="l32.92">       do_throw(&quot;Message not downloaded for offline use&quot;);</span>
<a href="#l32.93"></a><span id="l32.93"> </span>
<a href="#l32.94"></a><span id="l32.94" class="difflineminus">-    gIMAPInbox.getOfflineFileStream(header.messageKey, offset, size).close();</span>
<a href="#l32.95"></a><span id="l32.95" class="difflineplus">+    IMAPPump.inbox.getOfflineFileStream(header.messageKey, offset, size).close();</span>
<a href="#l32.96"></a><span id="l32.96">     do_print(&quot;Msg hdr offset = &quot; + offset.value);</span>
<a href="#l32.97"></a><span id="l32.97">   }</span>
<a href="#l32.98"></a><span id="l32.98"> };</span>
<a href="#l32.99"></a><span id="l32.99"> </span>
<a href="#l32.100"></a><span id="l32.100"> function teardown() {</span>
<a href="#l32.101"></a><span id="l32.101">   // Free up disk space - if you want to look at the file after running</span>
<a href="#l32.102"></a><span id="l32.102">   // this test, comment out this line.</span>
<a href="#l32.103"></a><span id="l32.103" class="difflineminus">-  if (gIMAPInbox)</span>
<a href="#l32.104"></a><span id="l32.104" class="difflineminus">-    gIMAPInbox.filePath.remove(false);</span>
<a href="#l32.105"></a><span id="l32.105" class="difflineplus">+  if (IMAPPump.inbox)</span>
<a href="#l32.106"></a><span id="l32.106" class="difflineplus">+    IMAPPump.inbox.filePath.remove(false);</span>
<a href="#l32.107"></a><span id="l32.107"> </span>
<a href="#l32.108"></a><span id="l32.108">   teardownIMAPPump();</span>
<a href="#l32.109"></a><span id="l32.109"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_listClosesDB.js</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_listClosesDB.js</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -13,38 +13,38 @@ var tests = [</span>
<a href="#l33.4"></a><span id="l33.4">   updateInbox,</span>
<a href="#l33.5"></a><span id="l33.5">   checkCachedDBForFolder,</span>
<a href="#l33.6"></a><span id="l33.6">   teardown</span>
<a href="#l33.7"></a><span id="l33.7"> ];</span>
<a href="#l33.8"></a><span id="l33.8"> </span>
<a href="#l33.9"></a><span id="l33.9"> function setup() {</span>
<a href="#l33.10"></a><span id="l33.10">   setupIMAPPump();</span>
<a href="#l33.11"></a><span id="l33.11"> </span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;folder1&quot;, {subscribed : true});</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;folder1/sub1&quot;, &quot;&quot;, {subscribed : true});</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;folder1/sub1/sub2&quot;, &quot;&quot;, {subscribed : true});</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;folder1/sub1/sub2/sub3&quot;, &quot;&quot;, {subscribed : true});</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;folder1&quot;, {subscribed : true});</span>
<a href="#l33.17"></a><span id="l33.17" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;folder1/sub1&quot;, &quot;&quot;, {subscribed : true});</span>
<a href="#l33.18"></a><span id="l33.18" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;folder1/sub1/sub2&quot;, &quot;&quot;, {subscribed : true});</span>
<a href="#l33.19"></a><span id="l33.19" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;folder1/sub1/sub2/sub3&quot;, &quot;&quot;, {subscribed : true});</span>
<a href="#l33.20"></a><span id="l33.20"> </span>
<a href="#l33.21"></a><span id="l33.21" class="difflineminus">-  gIMAPIncomingServer.usingSubscription = false;</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineplus">+  IMAPPump.incomingServer.usingSubscription = false;</span>
<a href="#l33.23"></a><span id="l33.23"> </span>
<a href="#l33.24"></a><span id="l33.24" class="difflineminus">-  let rootFolder = gIMAPIncomingServer.rootFolder.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l33.25"></a><span id="l33.25" class="difflineplus">+  let rootFolder = IMAPPump.incomingServer.rootFolder.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l33.26"></a><span id="l33.26">   rootFolder.hierarchyDelimiter = '/';</span>
<a href="#l33.27"></a><span id="l33.27" class="difflineminus">-  gIMAPInbox.hierarchyDelimiter = '/';</span>
<a href="#l33.28"></a><span id="l33.28" class="difflineplus">+  IMAPPump.inbox.hierarchyDelimiter = '/';</span>
<a href="#l33.29"></a><span id="l33.29">   rootFolder.addSubfolder(&quot;folder1&quot;);</span>
<a href="#l33.30"></a><span id="l33.30">   rootFolder.addSubfolder(&quot;folder1/sub1&quot;);</span>
<a href="#l33.31"></a><span id="l33.31">   rootFolder.addSubfolder(&quot;folder1/sub1/sub2&quot;);</span>
<a href="#l33.32"></a><span id="l33.32">   gSub3 = rootFolder.addSubfolder(&quot;folder1/sub1/sub2/sub3&quot;);</span>
<a href="#l33.33"></a><span id="l33.33" class="difflineminus">-  gIMAPServer.performTest(&quot;LIST&quot;);</span>
<a href="#l33.34"></a><span id="l33.34" class="difflineplus">+  IMAPPump.server.performTest(&quot;LIST&quot;);</span>
<a href="#l33.35"></a><span id="l33.35"> </span>
<a href="#l33.36"></a><span id="l33.36">   do_timeout(1000, async_driver);</span>
<a href="#l33.37"></a><span id="l33.37">   yield false;</span>
<a href="#l33.38"></a><span id="l33.38"> }</span>
<a href="#l33.39"></a><span id="l33.39"> </span>
<a href="#l33.40"></a><span id="l33.40"> function updateInbox() {</span>
<a href="#l33.41"></a><span id="l33.41" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l33.42"></a><span id="l33.42" class="difflineplus">+  IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l33.43"></a><span id="l33.43">   yield false;</span>
<a href="#l33.44"></a><span id="l33.44"> }</span>
<a href="#l33.45"></a><span id="l33.45"> </span>
<a href="#l33.46"></a><span id="l33.46"> function checkCachedDBForFolder() {</span>
<a href="#l33.47"></a><span id="l33.47">   const gDbService = Cc[&quot;@mozilla.org/msgDatabase/msgDBService;1&quot;]</span>
<a href="#l33.48"></a><span id="l33.48">                        .getService(Ci.nsIMsgDBService);</span>
<a href="#l33.49"></a><span id="l33.49">   do_check_eq(gDbService.cachedDBForFolder(gSub3), null);</span>
<a href="#l33.50"></a><span id="l33.50"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_listSubscribed.js</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_listSubscribed.js</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -35,33 +35,33 @@ var tests = [</span>
<a href="#l34.4"></a><span id="l34.4">   testListSubscribed,</span>
<a href="#l34.5"></a><span id="l34.5">   testZimbraServerVersions,</span>
<a href="#l34.6"></a><span id="l34.6">   endTest</span>
<a href="#l34.7"></a><span id="l34.7"> ]</span>
<a href="#l34.8"></a><span id="l34.8"> </span>
<a href="#l34.9"></a><span id="l34.9"> // setup the mailboxes that will be used for this test</span>
<a href="#l34.10"></a><span id="l34.10"> function setupMailboxes()</span>
<a href="#l34.11"></a><span id="l34.11"> {</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-  gIMAPMailbox.subscribed = true;</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;folder1&quot;, {subscribed : true, flags : [&quot;\\Noselect&quot;]});</span>
<a href="#l34.14"></a><span id="l34.14" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;folder1/folder11&quot;, {subscribed : true, flags : [&quot;\\Noinferiors&quot;]});</span>
<a href="#l34.15"></a><span id="l34.15" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;folder2&quot;, {subscribed : true, nonExistent : true});</span>
<a href="#l34.16"></a><span id="l34.16" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;folder3&quot;, {});</span>
<a href="#l34.17"></a><span id="l34.17" class="difflineplus">+  IMAPPump.mailbox.subscribed = true;</span>
<a href="#l34.18"></a><span id="l34.18" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;folder1&quot;, {subscribed : true, flags : [&quot;\\Noselect&quot;]});</span>
<a href="#l34.19"></a><span id="l34.19" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;folder1/folder11&quot;, {subscribed : true, flags : [&quot;\\Noinferiors&quot;]});</span>
<a href="#l34.20"></a><span id="l34.20" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;folder2&quot;, {subscribed : true, nonExistent : true});</span>
<a href="#l34.21"></a><span id="l34.21" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;folder3&quot;, {});</span>
<a href="#l34.22"></a><span id="l34.22"> </span>
<a href="#l34.23"></a><span id="l34.23">   // select the inbox to force folder discovery, etc.</span>
<a href="#l34.24"></a><span id="l34.24" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l34.25"></a><span id="l34.25" class="difflineplus">+  IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l34.26"></a><span id="l34.26">   yield false;</span>
<a href="#l34.27"></a><span id="l34.27"> }</span>
<a href="#l34.28"></a><span id="l34.28"> </span>
<a href="#l34.29"></a><span id="l34.29"> // tests that LIST (SUBSCRIBED) returns the proper response</span>
<a href="#l34.30"></a><span id="l34.30"> function testListSubscribed()</span>
<a href="#l34.31"></a><span id="l34.31"> {</span>
<a href="#l34.32"></a><span id="l34.32">   // check that we have \Noselect and \Noinferiors flags - these would not have</span>
<a href="#l34.33"></a><span id="l34.33">   // been returned if we had used LSUB instead of LIST(SUBSCRIBED)</span>
<a href="#l34.34"></a><span id="l34.34" class="difflineminus">-  let rootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l34.35"></a><span id="l34.35" class="difflineplus">+  let rootFolder = IMAPPump.incomingServer.rootFolder;</span>
<a href="#l34.36"></a><span id="l34.36">   let folder1 = rootFolder.getChildNamed(&quot;folder1&quot;);</span>
<a href="#l34.37"></a><span id="l34.37">   do_check_true(folder1.getFlag(nsMsgFolderFlags.ImapNoselect));</span>
<a href="#l34.38"></a><span id="l34.38">   do_check_false(folder1.getFlag(nsMsgFolderFlags.ImapNoinferiors));</span>
<a href="#l34.39"></a><span id="l34.39"> </span>
<a href="#l34.40"></a><span id="l34.40">   // make sure the above test was not a fluke</span>
<a href="#l34.41"></a><span id="l34.41">   let folder11 = folder1.getChildNamed(&quot;folder11&quot;);</span>
<a href="#l34.42"></a><span id="l34.42">   do_check_false(folder11.getFlag(nsMsgFolderFlags.ImapNoselect));</span>
<a href="#l34.43"></a><span id="l34.43">   do_check_true(folder11.getFlag(nsMsgFolderFlags.ImapNoinferiors));</span>
<a href="#l34.44"></a><span id="l34.44" class="difflineat">@@ -88,28 +88,28 @@ function testZimbraServerVersions() {</span>
<a href="#l34.45"></a><span id="l34.45">   let testValues = [ { version : '6.3.1_GA_2790', expectedResult : false },</span>
<a href="#l34.46"></a><span id="l34.46">                      { version : '7.2.2_GA_2790', expectedResult : false },</span>
<a href="#l34.47"></a><span id="l34.47">                      { version : '7.2.3_GA_2790', expectedResult : true },</span>
<a href="#l34.48"></a><span id="l34.48">                      { version : '8.0.2_GA_2790', expectedResult : false },</span>
<a href="#l34.49"></a><span id="l34.49">                      { version : '8.0.3_GA_2790', expectedResult : true },</span>
<a href="#l34.50"></a><span id="l34.50">                      { version : '9.0.0_GA_2790', expectedResult : true } ];</span>
<a href="#l34.51"></a><span id="l34.51"> </span>
<a href="#l34.52"></a><span id="l34.52">   for (let i = 0; i &lt; testValues.length; i++) {</span>
<a href="#l34.53"></a><span id="l34.53" class="difflineminus">-    gIMAPDaemon.idResponse = '(&quot;NAME&quot; &quot;Zimbra&quot; ' +</span>
<a href="#l34.54"></a><span id="l34.54" class="difflineplus">+    IMAPPump.daemon.idResponse = '(&quot;NAME&quot; &quot;Zimbra&quot; ' +</span>
<a href="#l34.55"></a><span id="l34.55">                              '&quot;VERSION&quot; &quot;' + testValues[i].version + '&quot; ' +</span>
<a href="#l34.56"></a><span id="l34.56">                              '&quot;RELEASE&quot; &quot;20120815212257&quot; ' +</span>
<a href="#l34.57"></a><span id="l34.57">                              '&quot;USER&quot; &quot;user@domain.com&quot; ' +</span>
<a href="#l34.58"></a><span id="l34.58">                              '&quot;SERVER&quot; &quot;14b63305-d002-4f1b-bcd9-23d402d4ef40&quot;)';</span>
<a href="#l34.59"></a><span id="l34.59" class="difflineminus">-    gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l34.60"></a><span id="l34.60" class="difflineminus">-    gIMAPIncomingServer.performExpand(null);</span>
<a href="#l34.61"></a><span id="l34.61" class="difflineplus">+    IMAPPump.incomingServer.closeCachedConnections();</span>
<a href="#l34.62"></a><span id="l34.62" class="difflineplus">+    IMAPPump.incomingServer.performExpand(null);</span>
<a href="#l34.63"></a><span id="l34.63">     // select inbox is just to wait on performExpand since performExpand does not have listener</span>
<a href="#l34.64"></a><span id="l34.64" class="difflineminus">-    gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l34.65"></a><span id="l34.65" class="difflineplus">+    IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l34.66"></a><span id="l34.66">     yield false;</span>
<a href="#l34.67"></a><span id="l34.67">     // if we send LSUB instead of LIST(SUBSCRIBED), then we should not have \NoSelect flag</span>
<a href="#l34.68"></a><span id="l34.68" class="difflineminus">-    let rootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l34.69"></a><span id="l34.69" class="difflineplus">+    let rootFolder = IMAPPump.incomingServer.rootFolder;</span>
<a href="#l34.70"></a><span id="l34.70">     let folder1 = rootFolder.getChildNamed(&quot;folder1&quot;);</span>
<a href="#l34.71"></a><span id="l34.71">     do_check_eq(folder1.getFlag(nsMsgFolderFlags.ImapNoselect), testValues[i].expectedResult);</span>
<a href="#l34.72"></a><span id="l34.72">   }</span>
<a href="#l34.73"></a><span id="l34.73"> }</span>
<a href="#l34.74"></a><span id="l34.74"> </span>
<a href="#l34.75"></a><span id="l34.75"> // Cleanup at end</span>
<a href="#l34.76"></a><span id="l34.76"> function endTest()</span>
<a href="#l34.77"></a><span id="l34.77"> {</span>
<a href="#l34.78"></a><span id="l34.78" class="difflineat">@@ -134,10 +134,10 @@ function specForFileName(aFileName)</span>
<a href="#l34.79"></a><span id="l34.79">   return msgfileuri.spec;</span>
<a href="#l34.80"></a><span id="l34.80"> }</span>
<a href="#l34.81"></a><span id="l34.81"> </span>
<a href="#l34.82"></a><span id="l34.82"> function recursiveDeleteMailboxes(aMailbox)</span>
<a href="#l34.83"></a><span id="l34.83"> {</span>
<a href="#l34.84"></a><span id="l34.84">   for each (var child in aMailbox.allChildren) {</span>
<a href="#l34.85"></a><span id="l34.85">     recursiveDeleteMailboxes(child);</span>
<a href="#l34.86"></a><span id="l34.86">   }</span>
<a href="#l34.87"></a><span id="l34.87" class="difflineminus">-  gIMAPDaemon.deleteMailbox(aMailbox);</span>
<a href="#l34.88"></a><span id="l34.88" class="difflineplus">+  IMAPPump.daemon.deleteMailbox(aMailbox);</span>
<a href="#l34.89"></a><span id="l34.89"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_localToImapFilter.js</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_localToImapFilter.js</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -24,64 +24,64 @@ const gFiles = [&quot;../../../data/bugmail1&quot;</span>
<a href="#l35.4"></a><span id="l35.4"> </span>
<a href="#l35.5"></a><span id="l35.5"> var tests = [</span>
<a href="#l35.6"></a><span id="l35.6">   setup,</span>
<a href="#l35.7"></a><span id="l35.7">   function copyFolder1() {</span>
<a href="#l35.8"></a><span id="l35.8">     dump(&quot;gEmpty1 &quot; + gEmptyLocal1.URI + &quot;\n&quot;);</span>
<a href="#l35.9"></a><span id="l35.9">     let folders = new Array;</span>
<a href="#l35.10"></a><span id="l35.10">     folders.push(gEmptyLocal1.QueryInterface(Ci.nsIMsgFolder));</span>
<a href="#l35.11"></a><span id="l35.11">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-    MailServices.copy.CopyFolders(array, gIMAPInbox, false, CopyListener, null);</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineplus">+    MailServices.copy.CopyFolders(array, IMAPPump.inbox, false, CopyListener, null);</span>
<a href="#l35.14"></a><span id="l35.14">     yield false;</span>
<a href="#l35.15"></a><span id="l35.15">   },</span>
<a href="#l35.16"></a><span id="l35.16">   function copyFolder2() {</span>
<a href="#l35.17"></a><span id="l35.17">     dump(&quot;gEmpty2 &quot; + gEmptyLocal2.URI + &quot;\n&quot;);</span>
<a href="#l35.18"></a><span id="l35.18">     let folders = new Array;</span>
<a href="#l35.19"></a><span id="l35.19">     folders.push(gEmptyLocal2);</span>
<a href="#l35.20"></a><span id="l35.20">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l35.21"></a><span id="l35.21" class="difflineminus">-    MailServices.copy.CopyFolders(array, gIMAPInbox, false, CopyListener, null);</span>
<a href="#l35.22"></a><span id="l35.22" class="difflineplus">+    MailServices.copy.CopyFolders(array, IMAPPump.inbox, false, CopyListener, null);</span>
<a href="#l35.23"></a><span id="l35.23">     yield false;</span>
<a href="#l35.24"></a><span id="l35.24">   },</span>
<a href="#l35.25"></a><span id="l35.25">   function getLocalMessages() {</span>
<a href="#l35.26"></a><span id="l35.26">     // setup copy then move mail filters on the inbox</span>
<a href="#l35.27"></a><span id="l35.27">     let filterList = gPOP3Pump.fakeServer.getFilterList(null);</span>
<a href="#l35.28"></a><span id="l35.28">     let filter = filterList.createFilter(&quot;copyThenMoveAll&quot;);</span>
<a href="#l35.29"></a><span id="l35.29">     let searchTerm = filter.createTerm();</span>
<a href="#l35.30"></a><span id="l35.30">     searchTerm.matchAll = true;</span>
<a href="#l35.31"></a><span id="l35.31">     filter.appendTerm(searchTerm);</span>
<a href="#l35.32"></a><span id="l35.32">     let copyAction = filter.createAction();</span>
<a href="#l35.33"></a><span id="l35.33">     copyAction.type = Ci.nsMsgFilterAction.CopyToFolder;</span>
<a href="#l35.34"></a><span id="l35.34" class="difflineminus">-    copyAction.targetFolderUri = gIMAPInbox.getChildNamed(&quot;empty 1&quot;).URI;</span>
<a href="#l35.35"></a><span id="l35.35" class="difflineplus">+    copyAction.targetFolderUri = IMAPPump.inbox.getChildNamed(&quot;empty 1&quot;).URI;</span>
<a href="#l35.36"></a><span id="l35.36">     filter.appendAction(copyAction);</span>
<a href="#l35.37"></a><span id="l35.37">     let moveAction = filter.createAction();</span>
<a href="#l35.38"></a><span id="l35.38">     moveAction.type = Ci.nsMsgFilterAction.MoveToFolder;</span>
<a href="#l35.39"></a><span id="l35.39" class="difflineminus">-    moveAction.targetFolderUri = gIMAPInbox.getChildNamed(&quot;empty 2&quot;).URI;</span>
<a href="#l35.40"></a><span id="l35.40" class="difflineplus">+    moveAction.targetFolderUri = IMAPPump.inbox.getChildNamed(&quot;empty 2&quot;).URI;</span>
<a href="#l35.41"></a><span id="l35.41">     filter.appendAction(moveAction);</span>
<a href="#l35.42"></a><span id="l35.42">     filter.enabled = true;</span>
<a href="#l35.43"></a><span id="l35.43">     filterList.insertFilterAt(0, filter);</span>
<a href="#l35.44"></a><span id="l35.44"> </span>
<a href="#l35.45"></a><span id="l35.45">     gPOP3Pump.files = gFiles;</span>
<a href="#l35.46"></a><span id="l35.46">     gPOP3Pump.onDone = async_driver;</span>
<a href="#l35.47"></a><span id="l35.47">     gPOP3Pump.run();</span>
<a href="#l35.48"></a><span id="l35.48">     yield false;</span>
<a href="#l35.49"></a><span id="l35.49">   },</span>
<a href="#l35.50"></a><span id="l35.50">   function update1() {</span>
<a href="#l35.51"></a><span id="l35.51" class="difflineminus">-    let folder1 = gIMAPInbox.getChildNamed(&quot;empty 1&quot;).QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l35.52"></a><span id="l35.52" class="difflineplus">+    let folder1 = IMAPPump.inbox.getChildNamed(&quot;empty 1&quot;).QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l35.53"></a><span id="l35.53">     folder1.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l35.54"></a><span id="l35.54">     yield false;</span>
<a href="#l35.55"></a><span id="l35.55">   },</span>
<a href="#l35.56"></a><span id="l35.56">   function update2() {</span>
<a href="#l35.57"></a><span id="l35.57" class="difflineminus">-    let folder2 = gIMAPInbox.getChildNamed(&quot;empty 2&quot;).QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l35.58"></a><span id="l35.58" class="difflineplus">+    let folder2 = IMAPPump.inbox.getChildNamed(&quot;empty 2&quot;).QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l35.59"></a><span id="l35.59">     folder2.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l35.60"></a><span id="l35.60">     yield false;</span>
<a href="#l35.61"></a><span id="l35.61">   },</span>
<a href="#l35.62"></a><span id="l35.62">   function verifyFolders() {</span>
<a href="#l35.63"></a><span id="l35.63" class="difflineminus">-    let folder1 = gIMAPInbox.getChildNamed(&quot;empty 1&quot;);</span>
<a href="#l35.64"></a><span id="l35.64" class="difflineplus">+    let folder1 = IMAPPump.inbox.getChildNamed(&quot;empty 1&quot;);</span>
<a href="#l35.65"></a><span id="l35.65">     listMessages(folder1);</span>
<a href="#l35.66"></a><span id="l35.66" class="difflineminus">-    let folder2 = gIMAPInbox.getChildNamed(&quot;empty 2&quot;);</span>
<a href="#l35.67"></a><span id="l35.67" class="difflineplus">+    let folder2 = IMAPPump.inbox.getChildNamed(&quot;empty 2&quot;);</span>
<a href="#l35.68"></a><span id="l35.68">     listMessages(folder2);</span>
<a href="#l35.69"></a><span id="l35.69">     listMessages(localAccountUtils.inboxFolder);</span>
<a href="#l35.70"></a><span id="l35.70">     do_check_neq(folder1, null);</span>
<a href="#l35.71"></a><span id="l35.71">     do_check_neq(folder2, null);</span>
<a href="#l35.72"></a><span id="l35.72">     // folder 1 and 2 should each now have 2 messages in them.</span>
<a href="#l35.73"></a><span id="l35.73">     do_check_eq(folderCount(folder1), 2);</span>
<a href="#l35.74"></a><span id="l35.74">     do_check_eq(folderCount(folder2), 2);</span>
<a href="#l35.75"></a><span id="l35.75">     // the local inbox folder should now be empty, since the second</span>
<a href="#l35.76"></a><span id="l35.76" class="difflineat">@@ -109,18 +109,18 @@ function setup() {</span>
<a href="#l35.77"></a><span id="l35.77">                                   .rootFolder.createLocalSubfolder(&quot;empty 1&quot;);</span>
<a href="#l35.78"></a><span id="l35.78">   gEmptyLocal2 = localAccountUtils.incomingServer</span>
<a href="#l35.79"></a><span id="l35.79">                                   .rootFolder.createLocalSubfolder(&quot;empty 2&quot;);</span>
<a href="#l35.80"></a><span id="l35.80"> </span>
<a href="#l35.81"></a><span id="l35.81">   // these hacks are required because we've created the inbox before</span>
<a href="#l35.82"></a><span id="l35.82">   // running initial folder discovery, and adding the folder bails</span>
<a href="#l35.83"></a><span id="l35.83">   // out before we set it as verified online, so we bail out, and</span>
<a href="#l35.84"></a><span id="l35.84">   // then remove the INBOX folder since it's not verified.</span>
<a href="#l35.85"></a><span id="l35.85" class="difflineminus">-  gIMAPInbox.hierarchyDelimiter = '/';</span>
<a href="#l35.86"></a><span id="l35.86" class="difflineminus">-  gIMAPInbox.verifiedAsOnlineFolder = true;</span>
<a href="#l35.87"></a><span id="l35.87" class="difflineplus">+  IMAPPump.inbox.hierarchyDelimiter = '/';</span>
<a href="#l35.88"></a><span id="l35.88" class="difflineplus">+  IMAPPump.inbox.verifiedAsOnlineFolder = true;</span>
<a href="#l35.89"></a><span id="l35.89"> }</span>
<a href="#l35.90"></a><span id="l35.90"> </span>
<a href="#l35.91"></a><span id="l35.91"> // nsIMsgCopyServiceListener implementation - runs next test when copy</span>
<a href="#l35.92"></a><span id="l35.92"> // is completed.</span>
<a href="#l35.93"></a><span id="l35.93"> var CopyListener =</span>
<a href="#l35.94"></a><span id="l35.94"> {</span>
<a href="#l35.95"></a><span id="l35.95">   OnStartCopy: function OnStartCopy() {},</span>
<a href="#l35.96"></a><span id="l35.96">   OnProgress: function OnProgress(aProgress, aProgressMax) {},</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_localToImapFilterQuarantine.js</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_localToImapFilterQuarantine.js</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -36,20 +36,20 @@ const quarantineTests = [</span>
<a href="#l36.4"></a><span id="l36.4">   updateSubfolderAndTest,</span>
<a href="#l36.5"></a><span id="l36.5">   get2Messages,</span>
<a href="#l36.6"></a><span id="l36.6">   updateSubfolderAndTest2,</span>
<a href="#l36.7"></a><span id="l36.7">   endTest</span>
<a href="#l36.8"></a><span id="l36.8"> ];</span>
<a href="#l36.9"></a><span id="l36.9"> </span>
<a href="#l36.10"></a><span id="l36.10"> function createSubfolder()</span>
<a href="#l36.11"></a><span id="l36.11"> {</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-  gIMAPIncomingServer.rootFolder.createSubfolder(&quot;subfolder&quot;, null);</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineplus">+  IMAPPump.incomingServer.rootFolder.createSubfolder(&quot;subfolder&quot;, null);</span>
<a href="#l36.14"></a><span id="l36.14">   dl('wait for folderAdded notification');</span>
<a href="#l36.15"></a><span id="l36.15">   yield false;</span>
<a href="#l36.16"></a><span id="l36.16" class="difflineminus">-  gSubfolder = gIMAPIncomingServer.rootFolder.getChildNamed(&quot;subfolder&quot;);</span>
<a href="#l36.17"></a><span id="l36.17" class="difflineplus">+  gSubfolder = IMAPPump.incomingServer.rootFolder.getChildNamed(&quot;subfolder&quot;);</span>
<a href="#l36.18"></a><span id="l36.18">   do_check_true(gSubfolder instanceof Ci.nsIMsgImapMailFolder);</span>
<a href="#l36.19"></a><span id="l36.19">   gSubfolder.updateFolderWithListener(null, urlListener);</span>
<a href="#l36.20"></a><span id="l36.20">   dl('wait for OnStopRunningURL');</span>
<a href="#l36.21"></a><span id="l36.21">   yield false;</span>
<a href="#l36.22"></a><span id="l36.22"> }</span>
<a href="#l36.23"></a><span id="l36.23"> </span>
<a href="#l36.24"></a><span id="l36.24"> function getLocalMessages() {</span>
<a href="#l36.25"></a><span id="l36.25">   // setup copy then move mail filters on the inbox</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_lsub.js</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_lsub.js</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -27,35 +27,35 @@ var tests = [</span>
<a href="#l37.4"></a><span id="l37.4">   setupMailboxes,</span>
<a href="#l37.5"></a><span id="l37.5">   testLsub,</span>
<a href="#l37.6"></a><span id="l37.6">   endTest</span>
<a href="#l37.7"></a><span id="l37.7"> ]</span>
<a href="#l37.8"></a><span id="l37.8"> </span>
<a href="#l37.9"></a><span id="l37.9"> // setup the mailboxes that will be used for this test</span>
<a href="#l37.10"></a><span id="l37.10"> function setupMailboxes()</span>
<a href="#l37.11"></a><span id="l37.11"> {</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-  gIMAPMailbox.subscribed = true;</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;folder1&quot;, {subscribed : true, flags : [&quot;\\Noselect&quot;]});</span>
<a href="#l37.14"></a><span id="l37.14" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;folder1/folder11&quot;, {subscribed : true, flags : [&quot;\\Noinferiors&quot;]});</span>
<a href="#l37.15"></a><span id="l37.15" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;folder2&quot;, {subscribed : true, nonExistent : true});</span>
<a href="#l37.16"></a><span id="l37.16" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;folder3&quot;, {});</span>
<a href="#l37.17"></a><span id="l37.17" class="difflineplus">+  IMAPPump.mailbox.subscribed = true;</span>
<a href="#l37.18"></a><span id="l37.18" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;folder1&quot;, {subscribed : true, flags : [&quot;\\Noselect&quot;]});</span>
<a href="#l37.19"></a><span id="l37.19" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;folder1/folder11&quot;, {subscribed : true, flags : [&quot;\\Noinferiors&quot;]});</span>
<a href="#l37.20"></a><span id="l37.20" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;folder2&quot;, {subscribed : true, nonExistent : true});</span>
<a href="#l37.21"></a><span id="l37.21" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;folder3&quot;, {});</span>
<a href="#l37.22"></a><span id="l37.22"> </span>
<a href="#l37.23"></a><span id="l37.23">   // select the inbox to force folder discovery, etc.</span>
<a href="#l37.24"></a><span id="l37.24" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l37.25"></a><span id="l37.25" class="difflineplus">+  IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l37.26"></a><span id="l37.26">   yield false;</span>
<a href="#l37.27"></a><span id="l37.27"> }</span>
<a href="#l37.28"></a><span id="l37.28"> </span>
<a href="#l37.29"></a><span id="l37.29"> // tests that LSUB returns the proper response</span>
<a href="#l37.30"></a><span id="l37.30"> function testLsub()</span>
<a href="#l37.31"></a><span id="l37.31"> {</span>
<a href="#l37.32"></a><span id="l37.32">   let nsMsgFolderFlags = Ci.nsMsgFolderFlags;</span>
<a href="#l37.33"></a><span id="l37.33"> </span>
<a href="#l37.34"></a><span id="l37.34">   // check that we have \Noselect and \Noinferiors flags - these would not have</span>
<a href="#l37.35"></a><span id="l37.35">   // been returned if we had used LSUB instead of LIST(SUBSCRIBED)</span>
<a href="#l37.36"></a><span id="l37.36" class="difflineminus">-  let rootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l37.37"></a><span id="l37.37" class="difflineplus">+  let rootFolder = IMAPPump.incomingServer.rootFolder;</span>
<a href="#l37.38"></a><span id="l37.38">   let folder1 = rootFolder.getChildNamed(&quot;folder1&quot;);</span>
<a href="#l37.39"></a><span id="l37.39">   do_check_true(folder1.getFlag(nsMsgFolderFlags.ImapNoselect));</span>
<a href="#l37.40"></a><span id="l37.40">   do_check_false(folder1.getFlag(nsMsgFolderFlags.ImapNoinferiors));</span>
<a href="#l37.41"></a><span id="l37.41"> </span>
<a href="#l37.42"></a><span id="l37.42">   // make sure the above test was not a fluke</span>
<a href="#l37.43"></a><span id="l37.43">   let folder11 = folder1.getChildNamed(&quot;folder11&quot;);</span>
<a href="#l37.44"></a><span id="l37.44">   do_check_false(folder11.getFlag(nsMsgFolderFlags.ImapNoselect));</span>
<a href="#l37.45"></a><span id="l37.45">   do_check_true(folder11.getFlag(nsMsgFolderFlags.ImapNoinferiors));</span>
<a href="#l37.46"></a><span id="l37.46" class="difflineat">@@ -99,10 +99,10 @@ function specForFileName(aFileName)</span>
<a href="#l37.47"></a><span id="l37.47">   return msgfileuri.spec;</span>
<a href="#l37.48"></a><span id="l37.48"> }</span>
<a href="#l37.49"></a><span id="l37.49"> </span>
<a href="#l37.50"></a><span id="l37.50"> function recursiveDeleteMailboxes(aMailbox)</span>
<a href="#l37.51"></a><span id="l37.51"> {</span>
<a href="#l37.52"></a><span id="l37.52">   for each (var child in aMailbox.allChildren) {</span>
<a href="#l37.53"></a><span id="l37.53">     recursiveDeleteMailboxes(child);</span>
<a href="#l37.54"></a><span id="l37.54">   }</span>
<a href="#l37.55"></a><span id="l37.55" class="difflineminus">-  gIMAPDaemon.deleteMailbox(aMailbox);</span>
<a href="#l37.56"></a><span id="l37.56" class="difflineplus">+  IMAPPump.daemon.deleteMailbox(aMailbox);</span>
<a href="#l37.57"></a><span id="l37.57"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_mailboxes.js</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_mailboxes.js</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -5,34 +5,34 @@</span>
<a href="#l38.4"></a><span id="l38.4"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l38.5"></a><span id="l38.5"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l38.6"></a><span id="l38.6"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l38.7"></a><span id="l38.7"> load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l38.8"></a><span id="l38.8"> </span>
<a href="#l38.9"></a><span id="l38.9"> function setup() {</span>
<a href="#l38.10"></a><span id="l38.10">   setupIMAPPump();</span>
<a href="#l38.11"></a><span id="l38.11"> </span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;I18N box\u00E1&quot;, {subscribed : true});</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;Unsubscribed box&quot;);</span>
<a href="#l38.14"></a><span id="l38.14" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;I18N box\u00E1&quot;, {subscribed : true});</span>
<a href="#l38.15"></a><span id="l38.15" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;Unsubscribed box&quot;);</span>
<a href="#l38.16"></a><span id="l38.16">   // Create an all upper case trash folder name to make sure</span>
<a href="#l38.17"></a><span id="l38.17">   // we handle special folder names case-insensitively.</span>
<a href="#l38.18"></a><span id="l38.18" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;TRASH&quot;, {subscribed : true});</span>
<a href="#l38.19"></a><span id="l38.19" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;TRASH&quot;, {subscribed : true});</span>
<a href="#l38.20"></a><span id="l38.20"> </span>
<a href="#l38.21"></a><span id="l38.21">   // Get the server list...</span>
<a href="#l38.22"></a><span id="l38.22" class="difflineminus">-  gIMAPServer.performTest(&quot;LIST&quot;);</span>
<a href="#l38.23"></a><span id="l38.23" class="difflineplus">+  IMAPPump.server.performTest(&quot;LIST&quot;);</span>
<a href="#l38.24"></a><span id="l38.24"> </span>
<a href="#l38.25"></a><span id="l38.25" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l38.26"></a><span id="l38.26" class="difflineplus">+  IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l38.27"></a><span id="l38.27">   yield false;</span>
<a href="#l38.28"></a><span id="l38.28"> }</span>
<a href="#l38.29"></a><span id="l38.29"> </span>
<a href="#l38.30"></a><span id="l38.30"> var tests = [</span>
<a href="#l38.31"></a><span id="l38.31">   setup,</span>
<a href="#l38.32"></a><span id="l38.32">   function checkDiscovery() {</span>
<a href="#l38.33"></a><span id="l38.33">     dump(&quot;in check discovery\n&quot;);</span>
<a href="#l38.34"></a><span id="l38.34" class="difflineminus">-    let rootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l38.35"></a><span id="l38.35" class="difflineplus">+    let rootFolder = IMAPPump.incomingServer.rootFolder;</span>
<a href="#l38.36"></a><span id="l38.36">     // Check that we've subscribed to the boxes returned by LSUB. We also get</span>
<a href="#l38.37"></a><span id="l38.37">     // checking of proper i18n in mailboxes for free here.</span>
<a href="#l38.38"></a><span id="l38.38">     do_check_true(rootFolder.containsChildNamed(&quot;Inbox&quot;));</span>
<a href="#l38.39"></a><span id="l38.39">     do_check_true(rootFolder.containsChildNamed(&quot;TRASH&quot;));</span>
<a href="#l38.40"></a><span id="l38.40">     // Make sure we haven't created an extra &quot;Trash&quot; folder.</span>
<a href="#l38.41"></a><span id="l38.41">     let trashes = rootFolder.getFoldersWithFlags(Ci.nsMsgFolderFlags.Trash);</span>
<a href="#l38.42"></a><span id="l38.42">     do_check_eq(trashes.length, 1);</span>
<a href="#l38.43"></a><span id="l38.43">     do_check_eq(rootFolder.numSubFolders, 3);</span>
<a href="#l38.44"></a><span id="l38.44" class="difflineat">@@ -44,26 +44,26 @@ var tests = [</span>
<a href="#l38.45"></a><span id="l38.45"> </span>
<a href="#l38.46"></a><span id="l38.46">     MailServices.imap.renameLeaf(i18nChild,</span>
<a href="#l38.47"></a><span id="l38.47">                                  &quot;test \u00E4&quot;,</span>
<a href="#l38.48"></a><span id="l38.48">                                  asyncUrlListener,</span>
<a href="#l38.49"></a><span id="l38.49">                                  null);</span>
<a href="#l38.50"></a><span id="l38.50">     yield false;</span>
<a href="#l38.51"></a><span id="l38.51">   },</span>
<a href="#l38.52"></a><span id="l38.52">   function checkRename() {</span>
<a href="#l38.53"></a><span id="l38.53" class="difflineminus">-    let rootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l38.54"></a><span id="l38.54" class="difflineplus">+    let rootFolder = IMAPPump.incomingServer.rootFolder;</span>
<a href="#l38.55"></a><span id="l38.55">     do_check_true(rootFolder.containsChildNamed(&quot;test \u00E4&quot;));</span>
<a href="#l38.56"></a><span id="l38.56">     let newChild = rootFolder.getChildNamed(&quot;test \u00E4&quot;).</span>
<a href="#l38.57"></a><span id="l38.57">                    QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l38.58"></a><span id="l38.58">     newChild.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l38.59"></a><span id="l38.59">     yield false;</span>
<a href="#l38.60"></a><span id="l38.60">   },</span>
<a href="#l38.61"></a><span id="l38.61">   function checkEmptyFolder() {</span>
<a href="#l38.62"></a><span id="l38.62">     try {</span>
<a href="#l38.63"></a><span id="l38.63" class="difflineminus">-    let serverSink = gIMAPServer.QueryInterface(Ci.nsIImapServerSink);</span>
<a href="#l38.64"></a><span id="l38.64" class="difflineplus">+    let serverSink = IMAPPump.server.QueryInterface(Ci.nsIImapServerSink);</span>
<a href="#l38.65"></a><span id="l38.65">       serverSink.possibleImapMailbox(&quot;/&quot;, '/', 0);</span>
<a href="#l38.66"></a><span id="l38.66">     }</span>
<a href="#l38.67"></a><span id="l38.67">     catch (ex) {</span>
<a href="#l38.68"></a><span id="l38.68">       // we expect this to fail, but not crash or assert.</span>
<a href="#l38.69"></a><span id="l38.69">     }</span>
<a href="#l38.70"></a><span id="l38.70">   },</span>
<a href="#l38.71"></a><span id="l38.71">   teardown</span>
<a href="#l38.72"></a><span id="l38.72"> ];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_offlineCopy.js</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_offlineCopy.js</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -54,61 +54,61 @@ function setup() {</span>
<a href="#l39.4"></a><span id="l39.4">   // (i.e. The fetching process will be invoked after OnStopCopy)</span>
<a href="#l39.5"></a><span id="l39.5">   // It will cause crash with an assertion</span>
<a href="#l39.6"></a><span id="l39.6">   // (ASSERTION: tried to add duplicate listener: 'index == -1') on teardown.</span>
<a href="#l39.7"></a><span id="l39.7">   Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l39.8"></a><span id="l39.8"> </span>
<a href="#l39.9"></a><span id="l39.9">   setupIMAPPump();</span>
<a href="#l39.10"></a><span id="l39.10"> </span>
<a href="#l39.11"></a><span id="l39.11">   MailServices.mfn.addListener(mfnListener, MailServices.mfn.folderAdded);</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-  gIMAPIncomingServer.rootFolder.createSubfolder(&quot;folder 1&quot;, null);</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineplus">+  IMAPPump.incomingServer.rootFolder.createSubfolder(&quot;folder 1&quot;, null);</span>
<a href="#l39.14"></a><span id="l39.14">   yield false;</span>
<a href="#l39.15"></a><span id="l39.15"> </span>
<a href="#l39.16"></a><span id="l39.16" class="difflineminus">-  gFolder1 = gIMAPIncomingServer.rootFolder.getChildNamed(&quot;folder 1&quot;);</span>
<a href="#l39.17"></a><span id="l39.17" class="difflineplus">+  gFolder1 = IMAPPump.incomingServer.rootFolder.getChildNamed(&quot;folder 1&quot;);</span>
<a href="#l39.18"></a><span id="l39.18">   do_check_true(gFolder1 instanceof Ci.nsIMsgFolder);</span>
<a href="#l39.19"></a><span id="l39.19"> </span>
<a href="#l39.20"></a><span id="l39.20">   // these hacks are required because we've created the inbox before</span>
<a href="#l39.21"></a><span id="l39.21">   // running initial folder discovery, and adding the folder bails</span>
<a href="#l39.22"></a><span id="l39.22">   // out before we set it as verified online, so we bail out, and</span>
<a href="#l39.23"></a><span id="l39.23">   // then remove the INBOX folder since it's not verified.</span>
<a href="#l39.24"></a><span id="l39.24" class="difflineminus">-  gIMAPInbox.hierarchyDelimiter = '/';</span>
<a href="#l39.25"></a><span id="l39.25" class="difflineminus">-  gIMAPInbox.verifiedAsOnlineFolder = true;</span>
<a href="#l39.26"></a><span id="l39.26" class="difflineplus">+  IMAPPump.inbox.hierarchyDelimiter = '/';</span>
<a href="#l39.27"></a><span id="l39.27" class="difflineplus">+  IMAPPump.inbox.verifiedAsOnlineFolder = true;</span>
<a href="#l39.28"></a><span id="l39.28"> </span>
<a href="#l39.29"></a><span id="l39.29">   // Add messages to the INBOX</span>
<a href="#l39.30"></a><span id="l39.30">   // this is synchronous, afaik</span>
<a href="#l39.31"></a><span id="l39.31">   addMessagesToServer([{file: gMsgFile1, messageId: gMsgId1},</span>
<a href="#l39.32"></a><span id="l39.32">                        {file: gMsgFile2, messageId: gMsgId2},</span>
<a href="#l39.33"></a><span id="l39.33">                       ],</span>
<a href="#l39.34"></a><span id="l39.34" class="difflineminus">-                      gIMAPDaemon.getMailbox(&quot;INBOX&quot;), gIMAPInbox);</span>
<a href="#l39.35"></a><span id="l39.35" class="difflineplus">+                      IMAPPump.daemon.getMailbox(&quot;INBOX&quot;), IMAPPump.inbox);</span>
<a href="#l39.36"></a><span id="l39.36"> }</span>
<a href="#l39.37"></a><span id="l39.37"> </span>
<a href="#l39.38"></a><span id="l39.38"> var tests = [</span>
<a href="#l39.39"></a><span id="l39.39">   setup,</span>
<a href="#l39.40"></a><span id="l39.40">   function updateFolder() {</span>
<a href="#l39.41"></a><span id="l39.41" class="difflineminus">-    gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l39.42"></a><span id="l39.42" class="difflineplus">+    IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l39.43"></a><span id="l39.43">     yield false;</span>
<a href="#l39.44"></a><span id="l39.44">   },</span>
<a href="#l39.45"></a><span id="l39.45">   function downloadAllForOffline() {</span>
<a href="#l39.46"></a><span id="l39.46" class="difflineminus">-     gIMAPInbox.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l39.47"></a><span id="l39.47" class="difflineplus">+     IMAPPump.inbox.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l39.48"></a><span id="l39.48">      yield false;</span>
<a href="#l39.49"></a><span id="l39.49">   },</span>
<a href="#l39.50"></a><span id="l39.50">   function copyMessagesToInbox() {</span>
<a href="#l39.51"></a><span id="l39.51"> </span>
<a href="#l39.52"></a><span id="l39.52" class="difflineminus">-    MailServices.copy.CopyFileMessage(gMsgFile3, gIMAPInbox, null, false, 0,</span>
<a href="#l39.53"></a><span id="l39.53" class="difflineplus">+    MailServices.copy.CopyFileMessage(gMsgFile3, IMAPPump.inbox, null, false, 0,</span>
<a href="#l39.54"></a><span id="l39.54">                                       &quot;&quot;, asyncCopyListener, null);</span>
<a href="#l39.55"></a><span id="l39.55">     yield false;</span>
<a href="#l39.56"></a><span id="l39.56"> </span>
<a href="#l39.57"></a><span id="l39.57" class="difflineminus">-    MailServices.copy.CopyFileMessage(gMsgFile4, gIMAPInbox, null, false, 0,</span>
<a href="#l39.58"></a><span id="l39.58" class="difflineplus">+    MailServices.copy.CopyFileMessage(gMsgFile4, IMAPPump.inbox, null, false, 0,</span>
<a href="#l39.59"></a><span id="l39.59">                                       &quot;&quot;, asyncCopyListener, null);</span>
<a href="#l39.60"></a><span id="l39.60">     yield false;</span>
<a href="#l39.61"></a><span id="l39.61"> </span>
<a href="#l39.62"></a><span id="l39.62" class="difflineminus">-    gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l39.63"></a><span id="l39.63" class="difflineplus">+    IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l39.64"></a><span id="l39.64">     yield false;</span>
<a href="#l39.65"></a><span id="l39.65"> </span>
<a href="#l39.66"></a><span id="l39.66" class="difflineminus">-    let db = gIMAPInbox.msgDatabase;</span>
<a href="#l39.67"></a><span id="l39.67" class="difflineplus">+    let db = IMAPPump.inbox.msgDatabase;</span>
<a href="#l39.68"></a><span id="l39.68"> </span>
<a href="#l39.69"></a><span id="l39.69">     // test the headers in the inbox</span>
<a href="#l39.70"></a><span id="l39.70">     let enumerator = db.EnumerateMessages();</span>
<a href="#l39.71"></a><span id="l39.71">     while (enumerator.hasMoreElements())</span>
<a href="#l39.72"></a><span id="l39.72">     {</span>
<a href="#l39.73"></a><span id="l39.73">       var message = enumerator.getNext();</span>
<a href="#l39.74"></a><span id="l39.74">       message instanceof Ci.nsIMsgDBHdr;</span>
<a href="#l39.75"></a><span id="l39.75">       dump('message &lt;'+ message.subject +</span>
<a href="#l39.76"></a><span id="l39.76" class="difflineat">@@ -118,40 +118,40 @@ var tests = [</span>
<a href="#l39.77"></a><span id="l39.77">            '&gt;\n');</span>
<a href="#l39.78"></a><span id="l39.78">       // This fails for file copies in bug 790912. Without  this, messages that</span>
<a href="#l39.79"></a><span id="l39.79">       //  are copied are not visible in pre-pluggableStores versions of TB (pre TB 12)</span>
<a href="#l39.80"></a><span id="l39.80">       do_check_eq(message.messageOffset, parseInt(message.getStringProperty(&quot;storeToken&quot;)));</span>
<a href="#l39.81"></a><span id="l39.81">     }</span>
<a href="#l39.82"></a><span id="l39.82">   },</span>
<a href="#l39.83"></a><span id="l39.83">   function copyMessagesToSubfolder() {</span>
<a href="#l39.84"></a><span id="l39.84">     //  a message created from IMAP download</span>
<a href="#l39.85"></a><span id="l39.85" class="difflineminus">-    let db = gIMAPInbox.msgDatabase;</span>
<a href="#l39.86"></a><span id="l39.86" class="difflineplus">+    let db = IMAPPump.inbox.msgDatabase;</span>
<a href="#l39.87"></a><span id="l39.87">     let msg1 = db.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l39.88"></a><span id="l39.88">     gMessages.appendElement(msg1, false);</span>
<a href="#l39.89"></a><span id="l39.89">     // this is sync, I believe?</span>
<a href="#l39.90"></a><span id="l39.90" class="difflineminus">-    MailServices.copy.CopyMessages(gIMAPInbox, gMessages, gFolder1, false,</span>
<a href="#l39.91"></a><span id="l39.91" class="difflineplus">+    MailServices.copy.CopyMessages(IMAPPump.inbox, gMessages, gFolder1, false,</span>
<a href="#l39.92"></a><span id="l39.92">                                    null, null, true);</span>
<a href="#l39.93"></a><span id="l39.93"> </span>
<a href="#l39.94"></a><span id="l39.94">     // two messages originally created from file copies (like in Send)</span>
<a href="#l39.95"></a><span id="l39.95">     let msg3 = db.getMsgHdrForMessageID(gMsg3Id);</span>
<a href="#l39.96"></a><span id="l39.96">     do_check_true(msg3 instanceof Ci.nsIMsgDBHdr);</span>
<a href="#l39.97"></a><span id="l39.97">     gMessages.clear();</span>
<a href="#l39.98"></a><span id="l39.98">     gMessages.appendElement(msg3, false);</span>
<a href="#l39.99"></a><span id="l39.99" class="difflineminus">-    MailServices.copy.CopyMessages(gIMAPInbox, gMessages, gFolder1, false,</span>
<a href="#l39.100"></a><span id="l39.100" class="difflineplus">+    MailServices.copy.CopyMessages(IMAPPump.inbox, gMessages, gFolder1, false,</span>
<a href="#l39.101"></a><span id="l39.101">                                    null, null, true);</span>
<a href="#l39.102"></a><span id="l39.102"> </span>
<a href="#l39.103"></a><span id="l39.103">     let msg4 = db.getMsgHdrForMessageID(gMsg4Id);</span>
<a href="#l39.104"></a><span id="l39.104">     do_check_true(msg4 instanceof Ci.nsIMsgDBHdr);</span>
<a href="#l39.105"></a><span id="l39.105"> </span>
<a href="#l39.106"></a><span id="l39.106">     // because bug 790912 created messages with correct storeToken but messageOffset=0,</span>
<a href="#l39.107"></a><span id="l39.107">     //  these messages may not copy correctly. Make sure that they do, as fixed in bug 790912</span>
<a href="#l39.108"></a><span id="l39.108">     msg4.messageOffset = 0;</span>
<a href="#l39.109"></a><span id="l39.109">     gMessages.clear();</span>
<a href="#l39.110"></a><span id="l39.110">     gMessages.appendElement(msg4, false);</span>
<a href="#l39.111"></a><span id="l39.111" class="difflineminus">-    MailServices.copy.CopyMessages(gIMAPInbox, gMessages, gFolder1, false,</span>
<a href="#l39.112"></a><span id="l39.112" class="difflineplus">+    MailServices.copy.CopyMessages(IMAPPump.inbox, gMessages, gFolder1, false,</span>
<a href="#l39.113"></a><span id="l39.113">                                    null, null, true);</span>
<a href="#l39.114"></a><span id="l39.114"> </span>
<a href="#l39.115"></a><span id="l39.115">     // test the db headers in folder1</span>
<a href="#l39.116"></a><span id="l39.116">     db = gFolder1.msgDatabase;</span>
<a href="#l39.117"></a><span id="l39.117">     enumerator = db.EnumerateMessages();</span>
<a href="#l39.118"></a><span id="l39.118">     while (enumerator.hasMoreElements())</span>
<a href="#l39.119"></a><span id="l39.119">     {</span>
<a href="#l39.120"></a><span id="l39.120">       var message = enumerator.getNext();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_offlineDraftDataloss.js</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_offlineDraftDataloss.js</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -30,37 +30,37 @@ var tests = [</span>
<a href="#l40.4"></a><span id="l40.4">   checkResult,</span>
<a href="#l40.5"></a><span id="l40.5">   endTest</span>
<a href="#l40.6"></a><span id="l40.6"> ];</span>
<a href="#l40.7"></a><span id="l40.7"> </span>
<a href="#l40.8"></a><span id="l40.8"> let gDraftsFolder;</span>
<a href="#l40.9"></a><span id="l40.9"> </span>
<a href="#l40.10"></a><span id="l40.10"> function createDraftsFolder()</span>
<a href="#l40.11"></a><span id="l40.11"> {</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineminus">-  gIMAPIncomingServer.rootFolder.createSubfolder(&quot;Drafts&quot;, null);</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineplus">+  IMAPPump.incomingServer.rootFolder.createSubfolder(&quot;Drafts&quot;, null);</span>
<a href="#l40.14"></a><span id="l40.14">   yield false;</span>
<a href="#l40.15"></a><span id="l40.15" class="difflineminus">-  gDraftsFolder = gIMAPIncomingServer.rootFolder.getChildNamed(&quot;Drafts&quot;);</span>
<a href="#l40.16"></a><span id="l40.16" class="difflineplus">+  gDraftsFolder = IMAPPump.incomingServer.rootFolder.getChildNamed(&quot;Drafts&quot;);</span>
<a href="#l40.17"></a><span id="l40.17">   do_check_true(gDraftsFolder instanceof Ci.nsIMsgImapMailFolder);</span>
<a href="#l40.18"></a><span id="l40.18">   gDraftsFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l40.19"></a><span id="l40.19">   yield false;</span>
<a href="#l40.20"></a><span id="l40.20"> }</span>
<a href="#l40.21"></a><span id="l40.21"> function goOffline()</span>
<a href="#l40.22"></a><span id="l40.22"> {</span>
<a href="#l40.23"></a><span id="l40.23">   // Don't prompt about offline download when going offline</span>
<a href="#l40.24"></a><span id="l40.24">   Services.prefs.setIntPref(&quot;offline.download.download_messages&quot;, 2);</span>
<a href="#l40.25"></a><span id="l40.25"> </span>
<a href="#l40.26"></a><span id="l40.26" class="difflineminus">-  gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l40.27"></a><span id="l40.27" class="difflineplus">+  IMAPPump.incomingServer.closeCachedConnections();</span>
<a href="#l40.28"></a><span id="l40.28">   let thread = gThreadManager.currentThread;</span>
<a href="#l40.29"></a><span id="l40.29">   while (thread.hasPendingEvents())</span>
<a href="#l40.30"></a><span id="l40.30">     thread.processNextEvent(true);</span>
<a href="#l40.31"></a><span id="l40.31"> </span>
<a href="#l40.32"></a><span id="l40.32">   do_timeout(2000, async_driver);</span>
<a href="#l40.33"></a><span id="l40.33">   yield false;</span>
<a href="#l40.34"></a><span id="l40.34"> </span>
<a href="#l40.35"></a><span id="l40.35" class="difflineminus">-  gIMAPServer.stop();</span>
<a href="#l40.36"></a><span id="l40.36" class="difflineplus">+  IMAPPump.server.stop();</span>
<a href="#l40.37"></a><span id="l40.37">   Services.io.offline = true;</span>
<a href="#l40.38"></a><span id="l40.38"> }</span>
<a href="#l40.39"></a><span id="l40.39"> </span>
<a href="#l40.40"></a><span id="l40.40"> function saveDraft()</span>
<a href="#l40.41"></a><span id="l40.41"> {</span>
<a href="#l40.42"></a><span id="l40.42">   let msgCompose = Cc[&quot;@mozilla.org/messengercompose/compose;1&quot;]</span>
<a href="#l40.43"></a><span id="l40.43">                      .createInstance(Ci.nsIMsgCompose);</span>
<a href="#l40.44"></a><span id="l40.44">   let fields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l40.45"></a><span id="l40.45" class="difflineat">@@ -76,56 +76,56 @@ function saveDraft()</span>
<a href="#l40.46"></a><span id="l40.46"> </span>
<a href="#l40.47"></a><span id="l40.47">   let progress = Cc[&quot;@mozilla.org/messenger/progress;1&quot;]</span>
<a href="#l40.48"></a><span id="l40.48">                    .createInstance(Ci.nsIMsgProgress);</span>
<a href="#l40.49"></a><span id="l40.49">   progress.registerListener(progressListener);</span>
<a href="#l40.50"></a><span id="l40.50">   msgCompose.SendMsg(Ci.nsIMsgSend.nsMsgSaveAsDraft, identity, &quot;&quot;, null,</span>
<a href="#l40.51"></a><span id="l40.51">                      progress);</span>
<a href="#l40.52"></a><span id="l40.52">   yield false;</span>
<a href="#l40.53"></a><span id="l40.53">   // verify that message is not on the server yet</span>
<a href="#l40.54"></a><span id="l40.54" class="difflineminus">-  do_check_eq(gIMAPDaemon.getMailbox(&quot;Drafts&quot;)._messages.length, 0);</span>
<a href="#l40.55"></a><span id="l40.55" class="difflineplus">+  do_check_eq(IMAPPump.daemon.getMailbox(&quot;Drafts&quot;)._messages.length, 0);</span>
<a href="#l40.56"></a><span id="l40.56"> }</span>
<a href="#l40.57"></a><span id="l40.57"> </span>
<a href="#l40.58"></a><span id="l40.58"> function goOnline()</span>
<a href="#l40.59"></a><span id="l40.59"> {</span>
<a href="#l40.60"></a><span id="l40.60">   let offlineManager = Cc[&quot;@mozilla.org/messenger/offline-manager;1&quot;]</span>
<a href="#l40.61"></a><span id="l40.61">                        .getService(Ci.nsIMsgOfflineManager);</span>
<a href="#l40.62"></a><span id="l40.62" class="difflineminus">-  gIMAPDaemon.closing = false;</span>
<a href="#l40.63"></a><span id="l40.63" class="difflineplus">+  IMAPPump.daemon.closing = false;</span>
<a href="#l40.64"></a><span id="l40.64">   Services.io.offline = false;</span>
<a href="#l40.65"></a><span id="l40.65"> </span>
<a href="#l40.66"></a><span id="l40.66" class="difflineminus">-  gIMAPServer.start(IMAP_PORT);</span>
<a href="#l40.67"></a><span id="l40.67" class="difflineplus">+  IMAPPump.server.start(IMAP_PORT);</span>
<a href="#l40.68"></a><span id="l40.68">   offlineManager.inProgress = true;</span>
<a href="#l40.69"></a><span id="l40.69">   offlineManager.goOnline(false, true, null);</span>
<a href="#l40.70"></a><span id="l40.70">   let waitForNotInProgress = function () {</span>
<a href="#l40.71"></a><span id="l40.71">     if (offlineManager.inProgress)</span>
<a href="#l40.72"></a><span id="l40.72">       do_timeout(250, waitForNotInProgress);</span>
<a href="#l40.73"></a><span id="l40.73">     else</span>
<a href="#l40.74"></a><span id="l40.74">       async_driver();</span>
<a href="#l40.75"></a><span id="l40.75">   }</span>
<a href="#l40.76"></a><span id="l40.76">   waitForNotInProgress();</span>
<a href="#l40.77"></a><span id="l40.77">   yield false;</span>
<a href="#l40.78"></a><span id="l40.78"> }</span>
<a href="#l40.79"></a><span id="l40.79"> </span>
<a href="#l40.80"></a><span id="l40.80"> function checkResult()</span>
<a href="#l40.81"></a><span id="l40.81"> {</span>
<a href="#l40.82"></a><span id="l40.82">   // verify that message is now on the server</span>
<a href="#l40.83"></a><span id="l40.83" class="difflineminus">-  do_check_eq(gIMAPDaemon.getMailbox(&quot;Drafts&quot;)._messages.length, 1);</span>
<a href="#l40.84"></a><span id="l40.84" class="difflineplus">+  do_check_eq(IMAPPump.daemon.getMailbox(&quot;Drafts&quot;)._messages.length, 1);</span>
<a href="#l40.85"></a><span id="l40.85">   yield true;</span>
<a href="#l40.86"></a><span id="l40.86"> }</span>
<a href="#l40.87"></a><span id="l40.87"> </span>
<a href="#l40.88"></a><span id="l40.88"> function endTest()</span>
<a href="#l40.89"></a><span id="l40.89"> {</span>
<a href="#l40.90"></a><span id="l40.90">   teardownIMAPPump();</span>
<a href="#l40.91"></a><span id="l40.91">   yield true;</span>
<a href="#l40.92"></a><span id="l40.92"> }</span>
<a href="#l40.93"></a><span id="l40.93"> </span>
<a href="#l40.94"></a><span id="l40.94"> function run_test()</span>
<a href="#l40.95"></a><span id="l40.95"> {</span>
<a href="#l40.96"></a><span id="l40.96">   Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l40.97"></a><span id="l40.97" class="difflineminus">-  let server = gIMAPIncomingServer;</span>
<a href="#l40.98"></a><span id="l40.98" class="difflineplus">+  let server = IMAPPump.incomingServer;</span>
<a href="#l40.99"></a><span id="l40.99"> </span>
<a href="#l40.100"></a><span id="l40.100">   // Add folder listeners that will capture async events</span>
<a href="#l40.101"></a><span id="l40.101">   const nsIMFNService = Ci.nsIMsgFolderNotificationService;</span>
<a href="#l40.102"></a><span id="l40.102"> </span>
<a href="#l40.103"></a><span id="l40.103">   let flags =</span>
<a href="#l40.104"></a><span id="l40.104">         nsIMFNService.msgsMoveCopyCompleted |</span>
<a href="#l40.105"></a><span id="l40.105">         nsIMFNService.folderAdded |</span>
<a href="#l40.106"></a><span id="l40.106">         nsIMFNService.msgAdded;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_offlinePlayback.js</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_offlinePlayback.js</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -15,127 +15,127 @@ var gSecondFolder, gThirdFolder;</span>
<a href="#l41.4"></a><span id="l41.4"> var gSynthMessage1, gSynthMessage2;</span>
<a href="#l41.5"></a><span id="l41.5"> // the message id of bugmail10</span>
<a href="#l41.6"></a><span id="l41.6"> const gMsgId1 = &quot;200806061706.m56H6RWT004933@mrapp54.mozilla.org&quot;;</span>
<a href="#l41.7"></a><span id="l41.7"> var gOfflineManager;</span>
<a href="#l41.8"></a><span id="l41.8"> </span>
<a href="#l41.9"></a><span id="l41.9"> var tests = [</span>
<a href="#l41.10"></a><span id="l41.10">   setup,</span>
<a href="#l41.11"></a><span id="l41.11">   function prepareToGoOffline() {</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">-    let rootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineplus">+    let rootFolder = IMAPPump.incomingServer.rootFolder;</span>
<a href="#l41.14"></a><span id="l41.14">     gSecondFolder = rootFolder.getChildNamed(&quot;secondFolder&quot;)</span>
<a href="#l41.15"></a><span id="l41.15">                       .QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l41.16"></a><span id="l41.16">     gThirdFolder =  rootFolder.getChildNamed(&quot;thirdFolder&quot;)</span>
<a href="#l41.17"></a><span id="l41.17">                       .QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l41.18"></a><span id="l41.18" class="difflineminus">-    gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l41.19"></a><span id="l41.19" class="difflineplus">+    IMAPPump.incomingServer.closeCachedConnections();</span>
<a href="#l41.20"></a><span id="l41.20">     var thread = gThreadManager.currentThread;</span>
<a href="#l41.21"></a><span id="l41.21">     while (thread.hasPendingEvents())</span>
<a href="#l41.22"></a><span id="l41.22">       thread.processNextEvent(true);</span>
<a href="#l41.23"></a><span id="l41.23"> </span>
<a href="#l41.24"></a><span id="l41.24">     dump(&quot;wait 2 seconds, then go offline\n&quot;);</span>
<a href="#l41.25"></a><span id="l41.25">     do_timeout(2000, async_driver);</span>
<a href="#l41.26"></a><span id="l41.26">     yield false;</span>
<a href="#l41.27"></a><span id="l41.27">   },</span>
<a href="#l41.28"></a><span id="l41.28">   function doOfflineOps() {</span>
<a href="#l41.29"></a><span id="l41.29" class="difflineminus">-    gIMAPServer.stop();</span>
<a href="#l41.30"></a><span id="l41.30" class="difflineplus">+    IMAPPump.server.stop();</span>
<a href="#l41.31"></a><span id="l41.31">     Services.io.offline = true;</span>
<a href="#l41.32"></a><span id="l41.32"> </span>
<a href="#l41.33"></a><span id="l41.33">     // Flag the two messages, and then copy them to different folders. Since</span>
<a href="#l41.34"></a><span id="l41.34">     // we're offline, these operations are synchronous.</span>
<a href="#l41.35"></a><span id="l41.35" class="difflineminus">-    let msgHdr1 = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gSynthMessage1.messageId);</span>
<a href="#l41.36"></a><span id="l41.36" class="difflineminus">-    let msgHdr2 = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gSynthMessage2.messageId);</span>
<a href="#l41.37"></a><span id="l41.37" class="difflineplus">+    let msgHdr1 = IMAPPump.inbox.msgDatabase.getMsgHdrForMessageID(gSynthMessage1.messageId);</span>
<a href="#l41.38"></a><span id="l41.38" class="difflineplus">+    let msgHdr2 = IMAPPump.inbox.msgDatabase.getMsgHdrForMessageID(gSynthMessage2.messageId);</span>
<a href="#l41.39"></a><span id="l41.39">     let headers1 = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l41.40"></a><span id="l41.40">                      .createInstance(Ci.nsIMutableArray);</span>
<a href="#l41.41"></a><span id="l41.41">     let headers2 = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l41.42"></a><span id="l41.42">                      .createInstance(Ci.nsIMutableArray);</span>
<a href="#l41.43"></a><span id="l41.43">     headers1.appendElement(msgHdr1, false);</span>
<a href="#l41.44"></a><span id="l41.44">     headers2.appendElement(msgHdr2, false);</span>
<a href="#l41.45"></a><span id="l41.45">     msgHdr1.folder.markMessagesFlagged(headers1, true);</span>
<a href="#l41.46"></a><span id="l41.46">     msgHdr2.folder.markMessagesFlagged(headers2, true);</span>
<a href="#l41.47"></a><span id="l41.47" class="difflineminus">-    MailServices.copy.CopyMessages(gIMAPInbox, headers1, gSecondFolder, true, null,</span>
<a href="#l41.48"></a><span id="l41.48" class="difflineplus">+    MailServices.copy.CopyMessages(IMAPPump.inbox, headers1, gSecondFolder, true, null,</span>
<a href="#l41.49"></a><span id="l41.49">                                    null, true);</span>
<a href="#l41.50"></a><span id="l41.50" class="difflineminus">-    MailServices.copy.CopyMessages(gIMAPInbox, headers2, gThirdFolder, true, null,</span>
<a href="#l41.51"></a><span id="l41.51" class="difflineplus">+    MailServices.copy.CopyMessages(IMAPPump.inbox, headers2, gThirdFolder, true, null,</span>
<a href="#l41.52"></a><span id="l41.52">                                    null, true);</span>
<a href="#l41.53"></a><span id="l41.53">     var file = do_get_file(&quot;../../../data/bugmail10&quot;);</span>
<a href="#l41.54"></a><span id="l41.54" class="difflineminus">-    MailServices.copy.CopyFileMessage(file, gIMAPInbox, null, false, 0,</span>
<a href="#l41.55"></a><span id="l41.55" class="difflineplus">+    MailServices.copy.CopyFileMessage(file, IMAPPump.inbox, null, false, 0,</span>
<a href="#l41.56"></a><span id="l41.56">                                       &quot;&quot;, asyncCopyListener, null);</span>
<a href="#l41.57"></a><span id="l41.57">     yield false;</span>
<a href="#l41.58"></a><span id="l41.58">   },</span>
<a href="#l41.59"></a><span id="l41.59">   function goOnline() {</span>
<a href="#l41.60"></a><span id="l41.60">     gOfflineManager = Cc[&quot;@mozilla.org/messenger/offline-manager;1&quot;]</span>
<a href="#l41.61"></a><span id="l41.61">                            .getService(Ci.nsIMsgOfflineManager);</span>
<a href="#l41.62"></a><span id="l41.62" class="difflineminus">-    gIMAPDaemon.closing = false;</span>
<a href="#l41.63"></a><span id="l41.63" class="difflineplus">+    IMAPPump.daemon.closing = false;</span>
<a href="#l41.64"></a><span id="l41.64">     Services.io.offline = false;</span>
<a href="#l41.65"></a><span id="l41.65"> </span>
<a href="#l41.66"></a><span id="l41.66" class="difflineminus">-    gIMAPServer.start(IMAP_PORT);</span>
<a href="#l41.67"></a><span id="l41.67" class="difflineplus">+    IMAPPump.server.start(IMAP_PORT);</span>
<a href="#l41.68"></a><span id="l41.68">     gOfflineManager.goOnline(false, true, null);</span>
<a href="#l41.69"></a><span id="l41.69">     do_timeout(2000, async_driver);</span>
<a href="#l41.70"></a><span id="l41.70">     yield false;</span>
<a href="#l41.71"></a><span id="l41.71">   },</span>
<a href="#l41.72"></a><span id="l41.72">   function updateSecondFolder() {</span>
<a href="#l41.73"></a><span id="l41.73">     if (gOfflineManager.inProgress)</span>
<a href="#l41.74"></a><span id="l41.74">       do_timeout(2000, updateSecondFolder);</span>
<a href="#l41.75"></a><span id="l41.75">     gSecondFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l41.76"></a><span id="l41.76">     yield false;</span>
<a href="#l41.77"></a><span id="l41.77">   },</span>
<a href="#l41.78"></a><span id="l41.78">   function updateThirdFolder() {</span>
<a href="#l41.79"></a><span id="l41.79">     gThirdFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l41.80"></a><span id="l41.80">     yield false;</span>
<a href="#l41.81"></a><span id="l41.81">   },</span>
<a href="#l41.82"></a><span id="l41.82">   function updateInbox() {</span>
<a href="#l41.83"></a><span id="l41.83" class="difflineminus">-    gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l41.84"></a><span id="l41.84" class="difflineplus">+    IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l41.85"></a><span id="l41.85">     yield false;</span>
<a href="#l41.86"></a><span id="l41.86">   },</span>
<a href="#l41.87"></a><span id="l41.87">   function checkDone() {</span>
<a href="#l41.88"></a><span id="l41.88">     let msgHdr1 = gSecondFolder.msgDatabase.getMsgHdrForMessageID(gSynthMessage1.messageId);</span>
<a href="#l41.89"></a><span id="l41.89">     let msgHdr2 = gThirdFolder.msgDatabase.getMsgHdrForMessageID(gSynthMessage2.messageId);</span>
<a href="#l41.90"></a><span id="l41.90" class="difflineminus">-    let msgHdr3 = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l41.91"></a><span id="l41.91" class="difflineplus">+    let msgHdr3 = IMAPPump.inbox.msgDatabase.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l41.92"></a><span id="l41.92">     do_check_neq(msgHdr1, null);</span>
<a href="#l41.93"></a><span id="l41.93">     do_check_neq(msgHdr2, null);</span>
<a href="#l41.94"></a><span id="l41.94">     do_check_neq(msgHdr3, null);</span>
<a href="#l41.95"></a><span id="l41.95">   },</span>
<a href="#l41.96"></a><span id="l41.96">   teardown</span>
<a href="#l41.97"></a><span id="l41.97"> ];</span>
<a href="#l41.98"></a><span id="l41.98"> </span>
<a href="#l41.99"></a><span id="l41.99"> function setup() {</span>
<a href="#l41.100"></a><span id="l41.100">   setupIMAPPump();</span>
<a href="#l41.101"></a><span id="l41.101"> </span>
<a href="#l41.102"></a><span id="l41.102">   /*</span>
<a href="#l41.103"></a><span id="l41.103">    * Set up an IMAP server.</span>
<a href="#l41.104"></a><span id="l41.104">    */</span>
<a href="#l41.105"></a><span id="l41.105" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;secondFolder&quot;, {subscribed : true});</span>
<a href="#l41.106"></a><span id="l41.106" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;thirdFolder&quot;, {subscribed : true});</span>
<a href="#l41.107"></a><span id="l41.107" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;secondFolder&quot;, {subscribed : true});</span>
<a href="#l41.108"></a><span id="l41.108" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;thirdFolder&quot;, {subscribed : true});</span>
<a href="#l41.109"></a><span id="l41.109">   Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l41.110"></a><span id="l41.110">   // Don't prompt about offline download when going offline</span>
<a href="#l41.111"></a><span id="l41.111">   Services.prefs.setIntPref(&quot;offline.download.download_messages&quot;, 2);</span>
<a href="#l41.112"></a><span id="l41.112"> </span>
<a href="#l41.113"></a><span id="l41.113">   // make a couple messges</span>
<a href="#l41.114"></a><span id="l41.114">   let messages = [];</span>
<a href="#l41.115"></a><span id="l41.115">   let gMessageGenerator = new MessageGenerator();</span>
<a href="#l41.116"></a><span id="l41.116">   messages = messages.concat(gMessageGenerator.makeMessage());</span>
<a href="#l41.117"></a><span id="l41.117">   messages = messages.concat(gMessageGenerator.makeMessage());</span>
<a href="#l41.118"></a><span id="l41.118">   gSynthMessage1 = messages[0];</span>
<a href="#l41.119"></a><span id="l41.119">   gSynthMessage2 = messages[1];</span>
<a href="#l41.120"></a><span id="l41.120"> </span>
<a href="#l41.121"></a><span id="l41.121">   let msgURI =</span>
<a href="#l41.122"></a><span id="l41.122">     Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l41.123"></a><span id="l41.123">                        btoa(messages[0].toMessageString()),</span>
<a href="#l41.124"></a><span id="l41.124">                        null, null);</span>
<a href="#l41.125"></a><span id="l41.125" class="difflineminus">-  let imapInbox =  gIMAPDaemon.getMailbox(&quot;INBOX&quot;)</span>
<a href="#l41.126"></a><span id="l41.126" class="difflineplus">+  let imapInbox =  IMAPPump.daemon.getMailbox(&quot;INBOX&quot;)</span>
<a href="#l41.127"></a><span id="l41.127">   let message = new imapMessage(msgURI.spec, imapInbox.uidnext++, [&quot;\\Seen&quot;]);</span>
<a href="#l41.128"></a><span id="l41.128">   imapInbox.addMessage(message);</span>
<a href="#l41.129"></a><span id="l41.129">   msgURI =</span>
<a href="#l41.130"></a><span id="l41.130">     Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l41.131"></a><span id="l41.131">                        btoa(messages[1].toMessageString()),</span>
<a href="#l41.132"></a><span id="l41.132">                        null, null);</span>
<a href="#l41.133"></a><span id="l41.133">   message = new imapMessage(msgURI.spec, imapInbox.uidnext++, [&quot;\\Seen&quot;]);</span>
<a href="#l41.134"></a><span id="l41.134">   imapInbox.addMessage(message);</span>
<a href="#l41.135"></a><span id="l41.135"> </span>
<a href="#l41.136"></a><span id="l41.136">   // update folder to download header.</span>
<a href="#l41.137"></a><span id="l41.137" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l41.138"></a><span id="l41.138" class="difflineplus">+  IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l41.139"></a><span id="l41.139">   yield false;</span>
<a href="#l41.140"></a><span id="l41.140"> }</span>
<a href="#l41.141"></a><span id="l41.141"> </span>
<a href="#l41.142"></a><span id="l41.142"> function teardown() {</span>
<a href="#l41.143"></a><span id="l41.143">   teardownIMAPPump();</span>
<a href="#l41.144"></a><span id="l41.144"> }</span>
<a href="#l41.145"></a><span id="l41.145"> </span>
<a href="#l41.146"></a><span id="l41.146"> function run_test() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_offlineStoreLocking.js</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_offlineStoreLocking.js</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -37,119 +37,119 @@ function addGeneratedMessagesToServer(me</span>
<a href="#l42.4"></a><span id="l42.4"> }</span>
<a href="#l42.5"></a><span id="l42.5"> </span>
<a href="#l42.6"></a><span id="l42.6"> var gStreamedHdr = null;</span>
<a href="#l42.7"></a><span id="l42.7"> </span>
<a href="#l42.8"></a><span id="l42.8"> function checkOfflineStore(prevOfflineStoreSize) {</span>
<a href="#l42.9"></a><span id="l42.9">   dump(&quot;checking offline store\n&quot;);</span>
<a href="#l42.10"></a><span id="l42.10">   let offset = new Object;</span>
<a href="#l42.11"></a><span id="l42.11">   let size = new Object;</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineminus">-  let enumerator = gIMAPInbox.msgDatabase.EnumerateMessages();</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+  let enumerator = IMAPPump.inbox.msgDatabase.EnumerateMessages();</span>
<a href="#l42.14"></a><span id="l42.14">   if (enumerator)</span>
<a href="#l42.15"></a><span id="l42.15">   {</span>
<a href="#l42.16"></a><span id="l42.16">     while (enumerator.hasMoreElements())</span>
<a href="#l42.17"></a><span id="l42.17">     {</span>
<a href="#l42.18"></a><span id="l42.18">       let header = enumerator.getNext();</span>
<a href="#l42.19"></a><span id="l42.19">       // this will verify that the message in the offline store</span>
<a href="#l42.20"></a><span id="l42.20">       // starts with &quot;From &quot; - otherwise, it returns an error.</span>
<a href="#l42.21"></a><span id="l42.21">       if (header instanceof Components.interfaces.nsIMsgDBHdr &amp;&amp;</span>
<a href="#l42.22"></a><span id="l42.22">          (header.flags &amp; Ci.nsMsgMessageFlags.Offline))</span>
<a href="#l42.23"></a><span id="l42.23" class="difflineminus">-        gIMAPInbox.getOfflineFileStream(header.messageKey, offset, size).close();</span>
<a href="#l42.24"></a><span id="l42.24" class="difflineplus">+        IMAPPump.inbox.getOfflineFileStream(header.messageKey, offset, size).close();</span>
<a href="#l42.25"></a><span id="l42.25">     }</span>
<a href="#l42.26"></a><span id="l42.26">   }</span>
<a href="#l42.27"></a><span id="l42.27">   // check that the offline store shrunk by at least 100 bytes.</span>
<a href="#l42.28"></a><span id="l42.28">   // (exact calculation might be fragile).</span>
<a href="#l42.29"></a><span id="l42.29" class="difflineminus">-  do_check_true(prevOfflineStoreSize &gt; gIMAPInbox.filePath.fileSize + 100);</span>
<a href="#l42.30"></a><span id="l42.30" class="difflineplus">+  do_check_true(prevOfflineStoreSize &gt; IMAPPump.inbox.filePath.fileSize + 100);</span>
<a href="#l42.31"></a><span id="l42.31"> }</span>
<a href="#l42.32"></a><span id="l42.32"> </span>
<a href="#l42.33"></a><span id="l42.33"> var tests = [</span>
<a href="#l42.34"></a><span id="l42.34">   setup,</span>
<a href="#l42.35"></a><span id="l42.35">   function downloadForOffline() {</span>
<a href="#l42.36"></a><span id="l42.36">     // ...and download for offline use.</span>
<a href="#l42.37"></a><span id="l42.37">     dump(&quot;Downloading for offline use\n&quot;);</span>
<a href="#l42.38"></a><span id="l42.38" class="difflineminus">-    gIMAPInbox.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l42.39"></a><span id="l42.39" class="difflineplus">+    IMAPPump.inbox.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l42.40"></a><span id="l42.40">     yield false;</span>
<a href="#l42.41"></a><span id="l42.41">   },</span>
<a href="#l42.42"></a><span id="l42.42">   function deleteOneMsg() {</span>
<a href="#l42.43"></a><span id="l42.43" class="difflineminus">-    let enumerator = gIMAPInbox.msgDatabase.EnumerateMessages();</span>
<a href="#l42.44"></a><span id="l42.44" class="difflineplus">+    let enumerator = IMAPPump.inbox.msgDatabase.EnumerateMessages();</span>
<a href="#l42.45"></a><span id="l42.45">     let msgHdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l42.46"></a><span id="l42.46">     let array = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l42.47"></a><span id="l42.47">     array.appendElement(msgHdr, false);</span>
<a href="#l42.48"></a><span id="l42.48" class="difflineminus">-    gIMAPInbox.deleteMessages(array, null, false, true, CopyListener, false);</span>
<a href="#l42.49"></a><span id="l42.49" class="difflineplus">+    IMAPPump.inbox.deleteMessages(array, null, false, true, CopyListener, false);</span>
<a href="#l42.50"></a><span id="l42.50">     yield false;</span>
<a href="#l42.51"></a><span id="l42.51">   },</span>
<a href="#l42.52"></a><span id="l42.52">   function compactOneFolder() {</span>
<a href="#l42.53"></a><span id="l42.53" class="difflineminus">-    let enumerator = gIMAPInbox.msgDatabase.EnumerateMessages();</span>
<a href="#l42.54"></a><span id="l42.54" class="difflineplus">+    let enumerator = IMAPPump.inbox.msgDatabase.EnumerateMessages();</span>
<a href="#l42.55"></a><span id="l42.55">     let msgHdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l42.56"></a><span id="l42.56">     gStreamedHdr = msgHdr;</span>
<a href="#l42.57"></a><span id="l42.57">     // mark the message as not being offline, and then we'll make sure that</span>
<a href="#l42.58"></a><span id="l42.58">     // streaming the message while we're compacting doesn't result in the</span>
<a href="#l42.59"></a><span id="l42.59">     // message being marked for offline use.</span>
<a href="#l42.60"></a><span id="l42.60">     // Luckily, compaction compacts the offline store first, so it should</span>
<a href="#l42.61"></a><span id="l42.61">     // lock the offline store.</span>
<a href="#l42.62"></a><span id="l42.62" class="difflineminus">-    gIMAPInbox.msgDatabase.MarkOffline(msgHdr.messageKey, false, null);</span>
<a href="#l42.63"></a><span id="l42.63" class="difflineplus">+    IMAPPump.inbox.msgDatabase.MarkOffline(msgHdr.messageKey, false, null);</span>
<a href="#l42.64"></a><span id="l42.64">     let msgURI = msgHdr.folder.getUriForMsg(msgHdr);</span>
<a href="#l42.65"></a><span id="l42.65">     let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l42.66"></a><span id="l42.66">     let msgServ = messenger.messageServiceFromURI(msgURI);</span>
<a href="#l42.67"></a><span id="l42.67">     // UrlListener will get called when both expunge and offline store</span>
<a href="#l42.68"></a><span id="l42.68">     // compaction are finished. dummyMsgWindow is required to make the backend</span>
<a href="#l42.69"></a><span id="l42.69">     // compact the offline store.</span>
<a href="#l42.70"></a><span id="l42.70" class="difflineminus">-    gIMAPInbox.compact(asyncUrlListener, gDummyMsgWindow);</span>
<a href="#l42.71"></a><span id="l42.71" class="difflineplus">+    IMAPPump.inbox.compact(asyncUrlListener, gDummyMsgWindow);</span>
<a href="#l42.72"></a><span id="l42.72">     // Stream the message w/o a stream listener in an attempt to get the url</span>
<a href="#l42.73"></a><span id="l42.73">     // started more quickly, while the compact is still going on.</span>
<a href="#l42.74"></a><span id="l42.74">     msgServ.streamMessage(msgURI, null, null, asyncUrlListener, false, &quot;&quot;, false);</span>
<a href="#l42.75"></a><span id="l42.75">     yield false;</span>
<a href="#l42.76"></a><span id="l42.76"> </span>
<a href="#l42.77"></a><span id="l42.77">     // Because we're streaming the message while compaction is going on,</span>
<a href="#l42.78"></a><span id="l42.78">     // we should not have stored it for offline use.</span>
<a href="#l42.79"></a><span id="l42.79">     do_check_false(gStreamedHdr.flags &amp; Ci.nsMsgMessageFlags.Offline);</span>
<a href="#l42.80"></a><span id="l42.80"> </span>
<a href="#l42.81"></a><span id="l42.81">     yield false;</span>
<a href="#l42.82"></a><span id="l42.82">   },</span>
<a href="#l42.83"></a><span id="l42.83">   function deleteAnOtherMsg() {</span>
<a href="#l42.84"></a><span id="l42.84" class="difflineminus">-    let enumerator = gIMAPInbox.msgDatabase.EnumerateMessages();</span>
<a href="#l42.85"></a><span id="l42.85" class="difflineplus">+    let enumerator = IMAPPump.inbox.msgDatabase.EnumerateMessages();</span>
<a href="#l42.86"></a><span id="l42.86">     let msgHdr = enumerator.getNext();</span>
<a href="#l42.87"></a><span id="l42.87">     let array = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l42.88"></a><span id="l42.88">     array.appendElement(msgHdr, false);</span>
<a href="#l42.89"></a><span id="l42.89" class="difflineminus">-    gIMAPInbox.deleteMessages(array, null, false, true, CopyListener, false);</span>
<a href="#l42.90"></a><span id="l42.90" class="difflineplus">+    IMAPPump.inbox.deleteMessages(array, null, false, true, CopyListener, false);</span>
<a href="#l42.91"></a><span id="l42.91">     yield false;</span>
<a href="#l42.92"></a><span id="l42.92">   },</span>
<a href="#l42.93"></a><span id="l42.93">   function updateTrash() {</span>
<a href="#l42.94"></a><span id="l42.94" class="difflineminus">-    gIMAPTrashFolder = gIMAPIncomingServer.rootFolder.getChildNamed(&quot;Trash&quot;)</span>
<a href="#l42.95"></a><span id="l42.95" class="difflineplus">+    gIMAPTrashFolder = IMAPPump.incomingServer.rootFolder.getChildNamed(&quot;Trash&quot;)</span>
<a href="#l42.96"></a><span id="l42.96">                          .QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l42.97"></a><span id="l42.97">     // hack to force uid validity to get initialized for trash.</span>
<a href="#l42.98"></a><span id="l42.98">     gIMAPTrashFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l42.99"></a><span id="l42.99">     yield false;</span>
<a href="#l42.100"></a><span id="l42.100">   },</span>
<a href="#l42.101"></a><span id="l42.101">   function downloadTrashForOffline() {</span>
<a href="#l42.102"></a><span id="l42.102">     // ...and download for offline use.</span>
<a href="#l42.103"></a><span id="l42.103">     dump(&quot;Downloading for offline use\n&quot;);</span>
<a href="#l42.104"></a><span id="l42.104">     gIMAPTrashFolder.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l42.105"></a><span id="l42.105">     yield false;</span>
<a href="#l42.106"></a><span id="l42.106">   },</span>
<a href="#l42.107"></a><span id="l42.107">   function testOfflineBodyCopy() {</span>
<a href="#l42.108"></a><span id="l42.108">     // In order to check that offline copy of messages doesn't try to copy</span>
<a href="#l42.109"></a><span id="l42.109">     // the body if the offline store is locked, we're going to go offline.</span>
<a href="#l42.110"></a><span id="l42.110">     // Thunderbird itself does move/copies pseudo-offline, but that's too</span>
<a href="#l42.111"></a><span id="l42.111">     // hard to test because of the half-second delay.</span>
<a href="#l42.112"></a><span id="l42.112" class="difflineminus">-    gIMAPServer.stop();</span>
<a href="#l42.113"></a><span id="l42.113" class="difflineplus">+    IMAPPump.server.stop();</span>
<a href="#l42.114"></a><span id="l42.114">     Services.io.offline = true;</span>
<a href="#l42.115"></a><span id="l42.115">     let trashHdr;</span>
<a href="#l42.116"></a><span id="l42.116">     let enumerator = gIMAPTrashFolder.msgDatabase.EnumerateMessages();</span>
<a href="#l42.117"></a><span id="l42.117">     let msgHdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l42.118"></a><span id="l42.118">     gMovedMsgId = msgHdr.messageId;</span>
<a href="#l42.119"></a><span id="l42.119">     let array = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l42.120"></a><span id="l42.120">     array.appendElement(msgHdr, false);</span>
<a href="#l42.121"></a><span id="l42.121" class="difflineminus">-    gIMAPInbox.compact(asyncUrlListener, gDummyMsgWindow);</span>
<a href="#l42.122"></a><span id="l42.122" class="difflineminus">-    MailServices.copy.CopyMessages(gIMAPTrashFolder, array, gIMAPInbox, true,</span>
<a href="#l42.123"></a><span id="l42.123" class="difflineplus">+    IMAPPump.inbox.compact(asyncUrlListener, gDummyMsgWindow);</span>
<a href="#l42.124"></a><span id="l42.124" class="difflineplus">+    MailServices.copy.CopyMessages(gIMAPTrashFolder, array, IMAPPump.inbox, true,</span>
<a href="#l42.125"></a><span id="l42.125">                                    CopyListener, null, true);</span>
<a href="#l42.126"></a><span id="l42.126">   },</span>
<a href="#l42.127"></a><span id="l42.127">   function verifyNoOfflineMsg() {</span>
<a href="#l42.128"></a><span id="l42.128">     try {</span>
<a href="#l42.129"></a><span id="l42.129" class="difflineminus">-    let movedMsg = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gMovedMsgId);</span>
<a href="#l42.130"></a><span id="l42.130" class="difflineplus">+    let movedMsg = IMAPPump.inbox.msgDatabase.getMsgHdrForMessageID(gMovedMsgId);</span>
<a href="#l42.131"></a><span id="l42.131">     do_check_false(movedMsg.flags &amp; Ci.nsMsgMessageFlags.Offline);</span>
<a href="#l42.132"></a><span id="l42.132">     } catch (ex) {dump(ex);}</span>
<a href="#l42.133"></a><span id="l42.133">     yield false;</span>
<a href="#l42.134"></a><span id="l42.134">     yield false;</span>
<a href="#l42.135"></a><span id="l42.135">   },</span>
<a href="#l42.136"></a><span id="l42.136">   teardown</span>
<a href="#l42.137"></a><span id="l42.137"> ];</span>
<a href="#l42.138"></a><span id="l42.138"> </span>
<a href="#l42.139"></a><span id="l42.139" class="difflineat">@@ -157,34 +157,34 @@ function run_test() {</span>
<a href="#l42.140"></a><span id="l42.140">   async_run_tests(tests);</span>
<a href="#l42.141"></a><span id="l42.141"> }</span>
<a href="#l42.142"></a><span id="l42.142"> </span>
<a href="#l42.143"></a><span id="l42.143"> function setup() {</span>
<a href="#l42.144"></a><span id="l42.144">   Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l42.145"></a><span id="l42.145"> </span>
<a href="#l42.146"></a><span id="l42.146">   setupIMAPPump();</span>
<a href="#l42.147"></a><span id="l42.147"> </span>
<a href="#l42.148"></a><span id="l42.148" class="difflineminus">-  gMsgImapInboxFolder = gIMAPInbox.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l42.149"></a><span id="l42.149" class="difflineplus">+  gMsgImapInboxFolder = IMAPPump.inbox.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l42.150"></a><span id="l42.150">   // these hacks are required because we've created the inbox before</span>
<a href="#l42.151"></a><span id="l42.151">   // running initial folder discovery, and adding the folder bails</span>
<a href="#l42.152"></a><span id="l42.152">   // out before we set it as verified online, so we bail out, and</span>
<a href="#l42.153"></a><span id="l42.153">   // then remove the INBOX folder since it's not verified.</span>
<a href="#l42.154"></a><span id="l42.154">   gMsgImapInboxFolder.hierarchyDelimiter = '/';</span>
<a href="#l42.155"></a><span id="l42.155">   gMsgImapInboxFolder.verifiedAsOnlineFolder = true;</span>
<a href="#l42.156"></a><span id="l42.156"> </span>
<a href="#l42.157"></a><span id="l42.157">   let messageGenerator = new MessageGenerator();</span>
<a href="#l42.158"></a><span id="l42.158">   let messages = [];</span>
<a href="#l42.159"></a><span id="l42.159">   let bodyString = &quot;&quot;;</span>
<a href="#l42.160"></a><span id="l42.160">   for (i = 0; i &lt; 100; i++)</span>
<a href="#l42.161"></a><span id="l42.161">     bodyString += &quot;1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890\r\n&quot;;</span>
<a href="#l42.162"></a><span id="l42.162"> </span>
<a href="#l42.163"></a><span id="l42.163">   for (let i = 0; i &lt; 50; i++)</span>
<a href="#l42.164"></a><span id="l42.164">     messages = messages.concat(messageGenerator.makeMessage({body: {body: bodyString, contentType: &quot;text/plain&quot;}}));</span>
<a href="#l42.165"></a><span id="l42.165"> </span>
<a href="#l42.166"></a><span id="l42.166" class="difflineminus">-  addGeneratedMessagesToServer(messages, gIMAPDaemon.getMailbox(&quot;INBOX&quot;));</span>
<a href="#l42.167"></a><span id="l42.167" class="difflineplus">+  addGeneratedMessagesToServer(messages, IMAPPump.daemon.getMailbox(&quot;INBOX&quot;));</span>
<a href="#l42.168"></a><span id="l42.168"> }</span>
<a href="#l42.169"></a><span id="l42.169"> </span>
<a href="#l42.170"></a><span id="l42.170"> // nsIMsgCopyServiceListener implementation - runs next test when copy</span>
<a href="#l42.171"></a><span id="l42.171"> // is completed.</span>
<a href="#l42.172"></a><span id="l42.172"> var CopyListener = </span>
<a href="#l42.173"></a><span id="l42.173"> {</span>
<a href="#l42.174"></a><span id="l42.174">   OnStartCopy: function() {},</span>
<a href="#l42.175"></a><span id="l42.175">   OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l42.176"></a><span id="l42.176" class="difflineat">@@ -201,19 +201,19 @@ var CopyListener =</span>
<a href="#l42.177"></a><span id="l42.177">     async_driver();</span>
<a href="#l42.178"></a><span id="l42.178">   }</span>
<a href="#l42.179"></a><span id="l42.179"> };</span>
<a href="#l42.180"></a><span id="l42.180"> </span>
<a href="#l42.181"></a><span id="l42.181"> function teardown() {</span>
<a href="#l42.182"></a><span id="l42.182">   gMsgImapInboxFolder = null;</span>
<a href="#l42.183"></a><span id="l42.183">   gIMAPTrashFolder = null;</span>
<a href="#l42.184"></a><span id="l42.184"> </span>
<a href="#l42.185"></a><span id="l42.185" class="difflineminus">-  // gIMAPServer has already stopped, we do not need to gIMAPServer.stop().</span>
<a href="#l42.186"></a><span id="l42.186" class="difflineminus">-  gIMAPInbox = null;</span>
<a href="#l42.187"></a><span id="l42.187" class="difflineplus">+  // IMAPPump.server has already stopped, we do not need to IMAPPump.server.stop().</span>
<a href="#l42.188"></a><span id="l42.188" class="difflineplus">+  IMAPPump.inbox = null;</span>
<a href="#l42.189"></a><span id="l42.189">   try {</span>
<a href="#l42.190"></a><span id="l42.190" class="difflineminus">-    gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l42.191"></a><span id="l42.191" class="difflineminus">-    let serverSink = gIMAPIncomingServer.QueryInterface(Ci.nsIImapServerSink);</span>
<a href="#l42.192"></a><span id="l42.192" class="difflineplus">+    IMAPPump.incomingServer.closeCachedConnections();</span>
<a href="#l42.193"></a><span id="l42.193" class="difflineplus">+    let serverSink = IMAPPump.incomingServer.QueryInterface(Ci.nsIImapServerSink);</span>
<a href="#l42.194"></a><span id="l42.194">     serverSink.abortQueuedUrls();</span>
<a href="#l42.195"></a><span id="l42.195">   } catch (ex) {dump(ex);}</span>
<a href="#l42.196"></a><span id="l42.196">   let thread = gThreadManager.currentThread;</span>
<a href="#l42.197"></a><span id="l42.197">   while (thread.hasPendingEvents())</span>
<a href="#l42.198"></a><span id="l42.198">     thread.processNextEvent(true);</span>
<a href="#l42.199"></a><span id="l42.199"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_partsOnDemand.js</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_partsOnDemand.js</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -49,80 +49,80 @@ function setPrefs() {</span>
<a href="#l43.4"></a><span id="l43.4"> // load and update a message in the imap fake server</span>
<a href="#l43.5"></a><span id="l43.5"> function loadImapMessage()</span>
<a href="#l43.6"></a><span id="l43.6"> {</span>
<a href="#l43.7"></a><span id="l43.7">   let gMessageGenerator = new MessageGenerator();</span>
<a href="#l43.8"></a><span id="l43.8"> </span>
<a href="#l43.9"></a><span id="l43.9">   let file = do_get_file(&quot;../../../data/bodystructuretest1&quot;);</span>
<a href="#l43.10"></a><span id="l43.10">   let msgURI = Services.io.newFileURI(file).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l43.11"></a><span id="l43.11"> </span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-  let imapInbox = gIMAPDaemon.getMailbox(&quot;INBOX&quot;);</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineplus">+  let imapInbox = IMAPPump.daemon.getMailbox(&quot;INBOX&quot;);</span>
<a href="#l43.14"></a><span id="l43.14">   let message = new imapMessage(msgURI.spec, imapInbox.uidnext++, []);</span>
<a href="#l43.15"></a><span id="l43.15" class="difflineminus">-  gIMAPMailbox.addMessage(message);</span>
<a href="#l43.16"></a><span id="l43.16" class="difflineplus">+  IMAPPump.mailbox.addMessage(message);</span>
<a href="#l43.17"></a><span id="l43.17">   // add a second message with no external parts. We want to make</span>
<a href="#l43.18"></a><span id="l43.18">   // sure that streaming this message doesn't mark it read, even</span>
<a href="#l43.19"></a><span id="l43.19">   // though we will fallback to fetching the whole message.</span>
<a href="#l43.20"></a><span id="l43.20">   file = do_get_file(&quot;../../../data/bodystructuretest3&quot;);</span>
<a href="#l43.21"></a><span id="l43.21">   msgURI = Services.io.newFileURI(file).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l43.22"></a><span id="l43.22">   message = new imapMessage(msgURI.spec, imapInbox.uidnext++, []);</span>
<a href="#l43.23"></a><span id="l43.23" class="difflineminus">-  gIMAPMailbox.addMessage(message);</span>
<a href="#l43.24"></a><span id="l43.24" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l43.25"></a><span id="l43.25" class="difflineplus">+  IMAPPump.mailbox.addMessage(message);</span>
<a href="#l43.26"></a><span id="l43.26" class="difflineplus">+  IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l43.27"></a><span id="l43.27">   yield false;</span>
<a href="#l43.28"></a><span id="l43.28"> </span>
<a href="#l43.29"></a><span id="l43.29" class="difflineminus">-  do_check_eq(2, gIMAPInbox.getTotalMessages(false));</span>
<a href="#l43.30"></a><span id="l43.30" class="difflineminus">-  let msgHdr = mailTestUtils.firstMsgHdr(gIMAPInbox);</span>
<a href="#l43.31"></a><span id="l43.31" class="difflineplus">+  do_check_eq(2, IMAPPump.inbox.getTotalMessages(false));</span>
<a href="#l43.32"></a><span id="l43.32" class="difflineplus">+  let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l43.33"></a><span id="l43.33">   do_check_true(msgHdr instanceof Ci.nsIMsgDBHdr);</span>
<a href="#l43.34"></a><span id="l43.34">   yield true;</span>
<a href="#l43.35"></a><span id="l43.35"> }</span>
<a href="#l43.36"></a><span id="l43.36"> </span>
<a href="#l43.37"></a><span id="l43.37"> // process the message through mime</span>
<a href="#l43.38"></a><span id="l43.38"> function startMime()</span>
<a href="#l43.39"></a><span id="l43.39"> {</span>
<a href="#l43.40"></a><span id="l43.40" class="difflineminus">-  let msgHdr = mailTestUtils.firstMsgHdr(gIMAPInbox);</span>
<a href="#l43.41"></a><span id="l43.41" class="difflineplus">+  let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l43.42"></a><span id="l43.42"> </span>
<a href="#l43.43"></a><span id="l43.43">   mimeMsg.MsgHdrToMimeMessage(msgHdr, this, function (aMsgHdr, aMimeMessage) {</span>
<a href="#l43.44"></a><span id="l43.44">     let url = aMimeMessage.allUserAttachments[0].url;</span>
<a href="#l43.45"></a><span id="l43.45">     // A URL containing this string indicates that the attachment will be</span>
<a href="#l43.46"></a><span id="l43.46">     // downloaded on demand.</span>
<a href="#l43.47"></a><span id="l43.47">     do_check_true(url.contains(&quot;/;section=&quot;));</span>
<a href="#l43.48"></a><span id="l43.48">     async_driver();</span>
<a href="#l43.49"></a><span id="l43.49">   }, true /* allowDownload */, { partsOnDemand: true });</span>
<a href="#l43.50"></a><span id="l43.50">   yield false;</span>
<a href="#l43.51"></a><span id="l43.51"> }</span>
<a href="#l43.52"></a><span id="l43.52"> </span>
<a href="#l43.53"></a><span id="l43.53"> // test that we don't mark all inline messages as read.</span>
<a href="#l43.54"></a><span id="l43.54"> function testAllInlineMessage()</span>
<a href="#l43.55"></a><span id="l43.55"> {</span>
<a href="#l43.56"></a><span id="l43.56" class="difflineminus">-  let enumerator = gIMAPInbox.msgDatabase.EnumerateMessages();</span>
<a href="#l43.57"></a><span id="l43.57" class="difflineplus">+  let enumerator = IMAPPump.inbox.msgDatabase.EnumerateMessages();</span>
<a href="#l43.58"></a><span id="l43.58"> </span>
<a href="#l43.59"></a><span id="l43.59">   if (enumerator.hasMoreElements())</span>
<a href="#l43.60"></a><span id="l43.60">   {</span>
<a href="#l43.61"></a><span id="l43.61">     gSecondMsg = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l43.62"></a><span id="l43.62">     mimeMsg.MsgHdrToMimeMessage(gSecondMsg, this, function (aMsgHdr, aMimeMessage) {</span>
<a href="#l43.63"></a><span id="l43.63">       async_driver();</span>
<a href="#l43.64"></a><span id="l43.64">     }, true /* allowDownload */, { partsOnDemand: true });</span>
<a href="#l43.65"></a><span id="l43.65">     yield false;</span>
<a href="#l43.66"></a><span id="l43.66">   }</span>
<a href="#l43.67"></a><span id="l43.67"> }</span>
<a href="#l43.68"></a><span id="l43.68"> </span>
<a href="#l43.69"></a><span id="l43.69"> function updateCounts()</span>
<a href="#l43.70"></a><span id="l43.70"> {</span>
<a href="#l43.71"></a><span id="l43.71">   // select the trash, then the inbox again, to force an update of the </span>
<a href="#l43.72"></a><span id="l43.72">   // read state of messages.</span>
<a href="#l43.73"></a><span id="l43.73" class="difflineminus">-  let trash = gIMAPIncomingServer.rootFolder.getChildNamed(&quot;Trash&quot;);</span>
<a href="#l43.74"></a><span id="l43.74" class="difflineplus">+  let trash = IMAPPump.incomingServer.rootFolder.getChildNamed(&quot;Trash&quot;);</span>
<a href="#l43.75"></a><span id="l43.75">   do_check_true(trash instanceof Ci.nsIMsgImapMailFolder);</span>
<a href="#l43.76"></a><span id="l43.76">   trash.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l43.77"></a><span id="l43.77">   yield false;</span>
<a href="#l43.78"></a><span id="l43.78" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l43.79"></a><span id="l43.79" class="difflineplus">+  IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l43.80"></a><span id="l43.80">   yield false;</span>
<a href="#l43.81"></a><span id="l43.81"> }</span>
<a href="#l43.82"></a><span id="l43.82"> </span>
<a href="#l43.83"></a><span id="l43.83"> function testNotRead()</span>
<a href="#l43.84"></a><span id="l43.84"> {</span>
<a href="#l43.85"></a><span id="l43.85" class="difflineminus">-  do_check_eq(2, gIMAPInbox.getNumUnread(false));</span>
<a href="#l43.86"></a><span id="l43.86" class="difflineplus">+  do_check_eq(2, IMAPPump.inbox.getNumUnread(false));</span>
<a href="#l43.87"></a><span id="l43.87">   yield true;</span>
<a href="#l43.88"></a><span id="l43.88"> }</span>
<a href="#l43.89"></a><span id="l43.89"> </span>
<a href="#l43.90"></a><span id="l43.90"> // Cleanup</span>
<a href="#l43.91"></a><span id="l43.91"> function endTest()</span>
<a href="#l43.92"></a><span id="l43.92"> {</span>
<a href="#l43.93"></a><span id="l43.93">   teardownIMAPPump();</span>
<a href="#l43.94"></a><span id="l43.94"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_preserveDataOnMove.js</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_preserveDataOnMove.js</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -26,63 +26,63 @@ var tests = [</span>
<a href="#l44.4"></a><span id="l44.4">   moveMessageToSubfolder,</span>
<a href="#l44.5"></a><span id="l44.5">   testPropertyOnMove,</span>
<a href="#l44.6"></a><span id="l44.6">   endTest</span>
<a href="#l44.7"></a><span id="l44.7"> ]</span>
<a href="#l44.8"></a><span id="l44.8"> </span>
<a href="#l44.9"></a><span id="l44.9"> let gSubfolder;</span>
<a href="#l44.10"></a><span id="l44.10"> function createSubfolder()</span>
<a href="#l44.11"></a><span id="l44.11"> {</span>
<a href="#l44.12"></a><span id="l44.12" class="difflineminus">-  gIMAPIncomingServer.rootFolder.createSubfolder(&quot;Subfolder&quot;, null);</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineplus">+  IMAPPump.incomingServer.rootFolder.createSubfolder(&quot;Subfolder&quot;, null);</span>
<a href="#l44.14"></a><span id="l44.14">   dl('wait for folderAdded notification');</span>
<a href="#l44.15"></a><span id="l44.15">   yield false; </span>
<a href="#l44.16"></a><span id="l44.16" class="difflineminus">-  gSubfolder = gIMAPIncomingServer.rootFolder.getChildNamed(&quot;Subfolder&quot;);</span>
<a href="#l44.17"></a><span id="l44.17" class="difflineplus">+  gSubfolder = IMAPPump.incomingServer.rootFolder.getChildNamed(&quot;Subfolder&quot;);</span>
<a href="#l44.18"></a><span id="l44.18">   do_check_true(gSubfolder instanceof Ci.nsIMsgImapMailFolder);</span>
<a href="#l44.19"></a><span id="l44.19">   gSubfolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l44.20"></a><span id="l44.20">   dl('wait for OnStopRunningURL');</span>
<a href="#l44.21"></a><span id="l44.21">   yield false;</span>
<a href="#l44.22"></a><span id="l44.22"> }  </span>
<a href="#l44.23"></a><span id="l44.23"> </span>
<a href="#l44.24"></a><span id="l44.24"> // load and update a message in the imap fake server</span>
<a href="#l44.25"></a><span id="l44.25"> function loadImapMessage()</span>
<a href="#l44.26"></a><span id="l44.26"> {</span>
<a href="#l44.27"></a><span id="l44.27" class="difflineminus">-  gIMAPMailbox.addMessage(new imapMessage(specForFileName(gMessage),</span>
<a href="#l44.28"></a><span id="l44.28" class="difflineminus">-                          gIMAPMailbox.uidnext++, []));</span>
<a href="#l44.29"></a><span id="l44.29" class="difflineminus">-  gIMAPInbox.updateFolder(null);</span>
<a href="#l44.30"></a><span id="l44.30" class="difflineplus">+  IMAPPump.mailbox.addMessage(new imapMessage(specForFileName(gMessage),</span>
<a href="#l44.31"></a><span id="l44.31" class="difflineplus">+                          IMAPPump.mailbox.uidnext++, []));</span>
<a href="#l44.32"></a><span id="l44.32" class="difflineplus">+  IMAPPump.inbox.updateFolder(null);</span>
<a href="#l44.33"></a><span id="l44.33">   dl('wait for msgAdded notification');</span>
<a href="#l44.34"></a><span id="l44.34">   yield false;</span>
<a href="#l44.35"></a><span id="l44.35" class="difflineminus">-  do_check_eq(1, gIMAPInbox.getTotalMessages(false));</span>
<a href="#l44.36"></a><span id="l44.36" class="difflineminus">-  let msgHdr = mailTestUtils.firstMsgHdr(gIMAPInbox);</span>
<a href="#l44.37"></a><span id="l44.37" class="difflineplus">+  do_check_eq(1, IMAPPump.inbox.getTotalMessages(false));</span>
<a href="#l44.38"></a><span id="l44.38" class="difflineplus">+  let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l44.39"></a><span id="l44.39">   do_check_true(msgHdr instanceof Ci.nsIMsgDBHdr);</span>
<a href="#l44.40"></a><span id="l44.40"> </span>
<a href="#l44.41"></a><span id="l44.41">   // set an arbitrary property</span>
<a href="#l44.42"></a><span id="l44.42">   msgHdr.setStringProperty(&quot;testprop&quot;, &quot;somevalue&quot;);</span>
<a href="#l44.43"></a><span id="l44.43">   yield true;</span>
<a href="#l44.44"></a><span id="l44.44"> }</span>
<a href="#l44.45"></a><span id="l44.45"> </span>
<a href="#l44.46"></a><span id="l44.46"> // move the message to a subfolder</span>
<a href="#l44.47"></a><span id="l44.47"> function moveMessageToSubfolder()</span>
<a href="#l44.48"></a><span id="l44.48"> {</span>
<a href="#l44.49"></a><span id="l44.49" class="difflineminus">-  let msgHdr = mailTestUtils.firstMsgHdr(gIMAPInbox);</span>
<a href="#l44.50"></a><span id="l44.50" class="difflineplus">+  let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l44.51"></a><span id="l44.51"> </span>
<a href="#l44.52"></a><span id="l44.52">   // Now move this message to the subfolder.</span>
<a href="#l44.53"></a><span id="l44.53">   var messages = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l44.54"></a><span id="l44.54">                    .createInstance(Ci.nsIMutableArray);</span>
<a href="#l44.55"></a><span id="l44.55">   messages.appendElement(msgHdr, false);</span>
<a href="#l44.56"></a><span id="l44.56">   /*</span>
<a href="#l44.57"></a><span id="l44.57">   void CopyMessages(in nsIMsgFolder srcFolder,</span>
<a href="#l44.58"></a><span id="l44.58">                     in nsIArray messages,</span>
<a href="#l44.59"></a><span id="l44.59">                     in nsIMsgFolder dstFolder,</span>
<a href="#l44.60"></a><span id="l44.60">                     in boolean isMove,</span>
<a href="#l44.61"></a><span id="l44.61">                     in nsIMsgCopyServiceListener listener,</span>
<a href="#l44.62"></a><span id="l44.62">                     in nsIMsgWindow msgWindow,</span>
<a href="#l44.63"></a><span id="l44.63">                     in boolean allowUndo);</span>
<a href="#l44.64"></a><span id="l44.64">   */</span>
<a href="#l44.65"></a><span id="l44.65"> </span>
<a href="#l44.66"></a><span id="l44.66" class="difflineminus">-  MailServices.copy.CopyMessages(gIMAPInbox, messages, gSubfolder, true,</span>
<a href="#l44.67"></a><span id="l44.67" class="difflineplus">+  MailServices.copy.CopyMessages(IMAPPump.inbox, messages, gSubfolder, true,</span>
<a href="#l44.68"></a><span id="l44.68">                                  asyncCopyListener, null, false);</span>
<a href="#l44.69"></a><span id="l44.69">   dl('wait for OnStopCopy');</span>
<a href="#l44.70"></a><span id="l44.70">   yield false;</span>
<a href="#l44.71"></a><span id="l44.71"> }</span>
<a href="#l44.72"></a><span id="l44.72"> </span>
<a href="#l44.73"></a><span id="l44.73"> function testPropertyOnMove()</span>
<a href="#l44.74"></a><span id="l44.74"> {</span>
<a href="#l44.75"></a><span id="l44.75">   gSubfolder.updateFolderWithListener(null, asyncUrlListener);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_saveImapDraft.js</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_saveImapDraft.js</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -27,20 +27,20 @@ var tests = [</span>
<a href="#l45.4"></a><span id="l45.4">   updateDrafts,</span>
<a href="#l45.5"></a><span id="l45.5">   checkResult,</span>
<a href="#l45.6"></a><span id="l45.6">   endTest</span>
<a href="#l45.7"></a><span id="l45.7"> ];</span>
<a href="#l45.8"></a><span id="l45.8"> </span>
<a href="#l45.9"></a><span id="l45.9"> let gDraftsFolder;</span>
<a href="#l45.10"></a><span id="l45.10"> function createDraftsFolder()</span>
<a href="#l45.11"></a><span id="l45.11"> {</span>
<a href="#l45.12"></a><span id="l45.12" class="difflineminus">-  gIMAPIncomingServer.rootFolder.createSubfolder(&quot;Drafts&quot;, null);</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineplus">+  IMAPPump.incomingServer.rootFolder.createSubfolder(&quot;Drafts&quot;, null);</span>
<a href="#l45.14"></a><span id="l45.14">   dl('wait for folderAdded');</span>
<a href="#l45.15"></a><span id="l45.15">   yield false;</span>
<a href="#l45.16"></a><span id="l45.16" class="difflineminus">-  gDraftsFolder = gIMAPIncomingServer.rootFolder.getChildNamed(&quot;Drafts&quot;);</span>
<a href="#l45.17"></a><span id="l45.17" class="difflineplus">+  gDraftsFolder = IMAPPump.incomingServer.rootFolder.getChildNamed(&quot;Drafts&quot;);</span>
<a href="#l45.18"></a><span id="l45.18">   do_check_true(gDraftsFolder instanceof Ci.nsIMsgImapMailFolder);</span>
<a href="#l45.19"></a><span id="l45.19">   gDraftsFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l45.20"></a><span id="l45.20">   dl('wait for OnStopRunningURL');</span>
<a href="#l45.21"></a><span id="l45.21">   yield false;</span>
<a href="#l45.22"></a><span id="l45.22"> }</span>
<a href="#l45.23"></a><span id="l45.23"> </span>
<a href="#l45.24"></a><span id="l45.24"> function saveDraft()</span>
<a href="#l45.25"></a><span id="l45.25"> {</span>
<a href="#l45.26"></a><span id="l45.26" class="difflineat">@@ -84,17 +84,17 @@ function endTest()</span>
<a href="#l45.27"></a><span id="l45.27"> {</span>
<a href="#l45.28"></a><span id="l45.28">   teardownIMAPPump();</span>
<a href="#l45.29"></a><span id="l45.29">   yield true;</span>
<a href="#l45.30"></a><span id="l45.30"> }</span>
<a href="#l45.31"></a><span id="l45.31"> </span>
<a href="#l45.32"></a><span id="l45.32"> function run_test()</span>
<a href="#l45.33"></a><span id="l45.33"> {</span>
<a href="#l45.34"></a><span id="l45.34">   Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l45.35"></a><span id="l45.35" class="difflineminus">-  let server = gIMAPIncomingServer;</span>
<a href="#l45.36"></a><span id="l45.36" class="difflineplus">+  let server = IMAPPump.incomingServer;</span>
<a href="#l45.37"></a><span id="l45.37"> </span>
<a href="#l45.38"></a><span id="l45.38">   // Add folder listeners that will capture async events</span>
<a href="#l45.39"></a><span id="l45.39">   const nsIMFNService = Ci.nsIMsgFolderNotificationService;</span>
<a href="#l45.40"></a><span id="l45.40"> </span>
<a href="#l45.41"></a><span id="l45.41">   let flags =</span>
<a href="#l45.42"></a><span id="l45.42">         nsIMFNService.msgsMoveCopyCompleted |</span>
<a href="#l45.43"></a><span id="l45.43">         nsIMFNService.folderAdded |</span>
<a href="#l45.44"></a><span id="l45.44">         nsIMFNService.msgAdded;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_saveTemplate.js</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_saveTemplate.js</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineat">@@ -32,20 +32,20 @@ function loadImapMessage()</span>
<a href="#l46.4"></a><span id="l46.4">   let gMessageGenerator = new MessageGenerator();</span>
<a href="#l46.5"></a><span id="l46.5">   // create a synthetic message with attachment</span>
<a href="#l46.6"></a><span id="l46.6">   let smsg = gMessageGenerator.makeMessage();</span>
<a href="#l46.7"></a><span id="l46.7"> </span>
<a href="#l46.8"></a><span id="l46.8">   let msgURI =</span>
<a href="#l46.9"></a><span id="l46.9">     Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l46.10"></a><span id="l46.10">                         btoa(smsg.toMessageString()),</span>
<a href="#l46.11"></a><span id="l46.11">                         null, null);</span>
<a href="#l46.12"></a><span id="l46.12" class="difflineminus">-  let imapInbox =  gIMAPDaemon.getMailbox(&quot;INBOX&quot;)</span>
<a href="#l46.13"></a><span id="l46.13" class="difflineplus">+  let imapInbox =  IMAPPump.daemon.getMailbox(&quot;INBOX&quot;)</span>
<a href="#l46.14"></a><span id="l46.14">   let message = new imapMessage(msgURI.spec, imapInbox.uidnext++, []);</span>
<a href="#l46.15"></a><span id="l46.15" class="difflineminus">-  gIMAPMailbox.addMessage(message);</span>
<a href="#l46.16"></a><span id="l46.16" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l46.17"></a><span id="l46.17" class="difflineplus">+  IMAPPump.mailbox.addMessage(message);</span>
<a href="#l46.18"></a><span id="l46.18" class="difflineplus">+  IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l46.19"></a><span id="l46.19">   yield false;</span>
<a href="#l46.20"></a><span id="l46.20">   MailServices.mfn.addListener(mfnListener, MailServices.mfn.msgAdded);</span>
<a href="#l46.21"></a><span id="l46.21">   yield true;</span>
<a href="#l46.22"></a><span id="l46.22"> }</span>
<a href="#l46.23"></a><span id="l46.23"> </span>
<a href="#l46.24"></a><span id="l46.24"> // Cleanup</span>
<a href="#l46.25"></a><span id="l46.25"> function endTest()</span>
<a href="#l46.26"></a><span id="l46.26"> {</span>
<a href="#l46.27"></a><span id="l46.27" class="difflineat">@@ -66,22 +66,22 @@ saveAsUrlListener.prototype = {</span>
<a href="#l46.28"></a><span id="l46.28">                       .createInstance(Ci.nsIMessenger);</span>
<a href="#l46.29"></a><span id="l46.29">     messenger.saveAs(this.uri, false, this.identity, null);</span>
<a href="#l46.30"></a><span id="l46.30">   }</span>
<a href="#l46.31"></a><span id="l46.31"> };</span>
<a href="#l46.32"></a><span id="l46.32"> </span>
<a href="#l46.33"></a><span id="l46.33"> // This is similar to the method in mailCommands.js, to test the way that</span>
<a href="#l46.34"></a><span id="l46.34"> // it creates a new templates folder before saving the message as a template.</span>
<a href="#l46.35"></a><span id="l46.35"> function saveAsTemplate() {</span>
<a href="#l46.36"></a><span id="l46.36" class="difflineminus">-  let hdr = mailTestUtils.firstMsgHdr(gIMAPInbox);</span>
<a href="#l46.37"></a><span id="l46.37" class="difflineminus">-  let uri = gIMAPInbox.getUriForMsg(hdr);</span>
<a href="#l46.38"></a><span id="l46.38" class="difflineplus">+  let hdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l46.39"></a><span id="l46.39" class="difflineplus">+  let uri = IMAPPump.inbox.getUriForMsg(hdr);</span>
<a href="#l46.40"></a><span id="l46.40">   const Ci = Components.interfaces;</span>
<a href="#l46.41"></a><span id="l46.41">   let identity = MailServices.accounts</span>
<a href="#l46.42"></a><span id="l46.42" class="difflineminus">-                  .getFirstIdentityForServer(gIMAPIncomingServer);</span>
<a href="#l46.43"></a><span id="l46.43" class="difflineminus">-  identity.stationeryFolder = gIMAPIncomingServer.rootFolder.URI + &quot;/Templates&quot;;</span>
<a href="#l46.44"></a><span id="l46.44" class="difflineplus">+                  .getFirstIdentityForServer(IMAPPump.incomingServer);</span>
<a href="#l46.45"></a><span id="l46.45" class="difflineplus">+  identity.stationeryFolder = IMAPPump.incomingServer.rootFolder.URI + &quot;/Templates&quot;;</span>
<a href="#l46.46"></a><span id="l46.46">   let templates = MailUtils.getFolderForURI(identity.stationeryFolder, false);</span>
<a href="#l46.47"></a><span id="l46.47">   // Verify that Templates folder doesn't exist, and then create it.</span>
<a href="#l46.48"></a><span id="l46.48">   do_check_eq(templates.parent, null);</span>
<a href="#l46.49"></a><span id="l46.49">   templates.setFlag(Ci.nsMsgFolderFlags.Templates);</span>
<a href="#l46.50"></a><span id="l46.50">   templates.createStorageIfMissing(new saveAsUrlListener(uri, identity));</span>
<a href="#l46.51"></a><span id="l46.51">   yield false;</span>
<a href="#l46.52"></a><span id="l46.52"> }</span>
<a href="#l46.53"></a><span id="l46.53"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_starttlsFailure.js</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_starttlsFailure.js</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineat">@@ -21,57 +21,57 @@ function alert(aDialogTitle, aText) {</span>
<a href="#l47.4"></a><span id="l47.4"> var tests = [</span>
<a href="#l47.5"></a><span id="l47.5">   setup,</span>
<a href="#l47.6"></a><span id="l47.6">   check_alert,</span>
<a href="#l47.7"></a><span id="l47.7">   teardown</span>
<a href="#l47.8"></a><span id="l47.8"> ];</span>
<a href="#l47.9"></a><span id="l47.9"> </span>
<a href="#l47.10"></a><span id="l47.10"> function setup() {</span>
<a href="#l47.11"></a><span id="l47.11">   // set up IMAP fakeserver and incoming server</span>
<a href="#l47.12"></a><span id="l47.12" class="difflineminus">-  gIMAPDaemon = new imapDaemon();</span>
<a href="#l47.13"></a><span id="l47.13" class="difflineminus">-  gIMAPServer = makeServer(gIMAPDaemon, &quot;&quot;, {dropOnStartTLS: true});</span>
<a href="#l47.14"></a><span id="l47.14" class="difflineminus">-  gIMAPIncomingServer = createLocalIMAPServer();</span>
<a href="#l47.15"></a><span id="l47.15" class="difflineminus">-  gIMAPIncomingServer.socketType = Ci.nsMsgSocketType.alwaysSTARTTLS;</span>
<a href="#l47.16"></a><span id="l47.16" class="difflineplus">+  IMAPPump.daemon = new imapDaemon();</span>
<a href="#l47.17"></a><span id="l47.17" class="difflineplus">+  IMAPPump.server = makeServer(IMAPPump.daemon, &quot;&quot;, {dropOnStartTLS: true});</span>
<a href="#l47.18"></a><span id="l47.18" class="difflineplus">+  IMAPPump.incomingServer = createLocalIMAPServer();</span>
<a href="#l47.19"></a><span id="l47.19" class="difflineplus">+  IMAPPump.incomingServer.socketType = Ci.nsMsgSocketType.alwaysSTARTTLS;</span>
<a href="#l47.20"></a><span id="l47.20"> </span>
<a href="#l47.21"></a><span id="l47.21">   // we need a local account for the IMAP server to have its sent messages in</span>
<a href="#l47.22"></a><span id="l47.22">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l47.23"></a><span id="l47.23"> </span>
<a href="#l47.24"></a><span id="l47.24">   // We need an identity so that updateFolder doesn't fail</span>
<a href="#l47.25"></a><span id="l47.25">   let imapAccount = MailServices.accounts.createAccount();</span>
<a href="#l47.26"></a><span id="l47.26">   let identity = MailServices.accounts.createIdentity();</span>
<a href="#l47.27"></a><span id="l47.27">   imapAccount.addIdentity(identity);</span>
<a href="#l47.28"></a><span id="l47.28">   imapAccount.defaultIdentity = identity;</span>
<a href="#l47.29"></a><span id="l47.29" class="difflineminus">-  imapAccount.incomingServer = gIMAPIncomingServer;</span>
<a href="#l47.30"></a><span id="l47.30" class="difflineplus">+  imapAccount.incomingServer = IMAPPump.incomingServer;</span>
<a href="#l47.31"></a><span id="l47.31">   MailServices.accounts.defaultAccount = imapAccount;</span>
<a href="#l47.32"></a><span id="l47.32"> </span>
<a href="#l47.33"></a><span id="l47.33">   // The server doesn't support more than one connection</span>
<a href="#l47.34"></a><span id="l47.34">   Services.prefs.setIntPref(&quot;mail.server.server1.max_cached_connections&quot;, 1);</span>
<a href="#l47.35"></a><span id="l47.35">   // We aren't interested in downloading messages automatically</span>
<a href="#l47.36"></a><span id="l47.36">   Services.prefs.setBoolPref(&quot;mail.server.server1.download_on_biff&quot;, false);</span>
<a href="#l47.37"></a><span id="l47.37"> </span>
<a href="#l47.38"></a><span id="l47.38" class="difflineminus">-  gIMAPInbox = gIMAPIncomingServer.rootFolder.getChildNamed(&quot;Inbox&quot;)</span>
<a href="#l47.39"></a><span id="l47.39" class="difflineplus">+  IMAPPump.inbox = IMAPPump.incomingServer.rootFolder.getChildNamed(&quot;Inbox&quot;)</span>
<a href="#l47.40"></a><span id="l47.40">                                   .QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l47.41"></a><span id="l47.41"> </span>
<a href="#l47.42"></a><span id="l47.42">   registerAlertTestUtils();</span>
<a href="#l47.43"></a><span id="l47.43"> </span>
<a href="#l47.44"></a><span id="l47.44" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(gDummyMsgWindow, asyncUrlListener);</span>
<a href="#l47.45"></a><span id="l47.45" class="difflineplus">+  IMAPPump.inbox.updateFolderWithListener(gDummyMsgWindow, asyncUrlListener);</span>
<a href="#l47.46"></a><span id="l47.46">   yield false;</span>
<a href="#l47.47"></a><span id="l47.47"> }</span>
<a href="#l47.48"></a><span id="l47.48"> </span>
<a href="#l47.49"></a><span id="l47.49"> asyncUrlListener.callback = function(aUrl, aExitCode) {</span>
<a href="#l47.50"></a><span id="l47.50">   do_check_false(Components.isSuccessCode(aExitCode));</span>
<a href="#l47.51"></a><span id="l47.51"> };</span>
<a href="#l47.52"></a><span id="l47.52"> </span>
<a href="#l47.53"></a><span id="l47.53"> function check_alert() {</span>
<a href="#l47.54"></a><span id="l47.54">   do_check_true(gGotAlert);</span>
<a href="#l47.55"></a><span id="l47.55"> }</span>
<a href="#l47.56"></a><span id="l47.56"> </span>
<a href="#l47.57"></a><span id="l47.57"> function teardown() {</span>
<a href="#l47.58"></a><span id="l47.58" class="difflineminus">-  gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l47.59"></a><span id="l47.59" class="difflineminus">-  gIMAPServer.stop();</span>
<a href="#l47.60"></a><span id="l47.60" class="difflineplus">+  IMAPPump.incomingServer.closeCachedConnections();</span>
<a href="#l47.61"></a><span id="l47.61" class="difflineplus">+  IMAPPump.server.stop();</span>
<a href="#l47.62"></a><span id="l47.62"> </span>
<a href="#l47.63"></a><span id="l47.63">   var thread = gThreadManager.currentThread;</span>
<a href="#l47.64"></a><span id="l47.64">   while (thread.hasPendingEvents())</span>
<a href="#l47.65"></a><span id="l47.65">     thread.processNextEvent(true);</span>
<a href="#l47.66"></a><span id="l47.66"> }</span>
<a href="#l47.67"></a><span id="l47.67"> </span>
<a href="#l47.68"></a><span id="l47.68"> function run_test() {</span>
<a href="#l47.69"></a><span id="l47.69">   async_run_tests(tests);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_stopMovingToLocalFolder.js</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_stopMovingToLocalFolder.js</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineat">@@ -11,18 +11,18 @@ Components.utils.import(&quot;resource:///mod</span>
<a href="#l48.4"></a><span id="l48.4"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l48.5"></a><span id="l48.5"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l48.6"></a><span id="l48.6"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l48.7"></a><span id="l48.7"> </span>
<a href="#l48.8"></a><span id="l48.8"> load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l48.9"></a><span id="l48.9"> setupIMAPPump();</span>
<a href="#l48.10"></a><span id="l48.10"> </span>
<a href="#l48.11"></a><span id="l48.11"> function stop_server() {</span>
<a href="#l48.12"></a><span id="l48.12" class="difflineminus">-  gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l48.13"></a><span id="l48.13" class="difflineminus">-  gIMAPServer.stop();</span>
<a href="#l48.14"></a><span id="l48.14" class="difflineplus">+  IMAPPump.incomingServer.closeCachedConnections();</span>
<a href="#l48.15"></a><span id="l48.15" class="difflineplus">+  IMAPPump.server.stop();</span>
<a href="#l48.16"></a><span id="l48.16">   let thread = gThreadManager.currentThread;</span>
<a href="#l48.17"></a><span id="l48.17">   while (thread.hasPendingEvents())</span>
<a href="#l48.18"></a><span id="l48.18">     thread.processNextEvent(true);</span>
<a href="#l48.19"></a><span id="l48.19"> }</span>
<a href="#l48.20"></a><span id="l48.20"> </span>
<a href="#l48.21"></a><span id="l48.21"> var asyncCopyListener = {</span>
<a href="#l48.22"></a><span id="l48.22">   OnStartCopy: function() {},</span>
<a href="#l48.23"></a><span id="l48.23">   SetMessageKey: function(aMsgKey) {},</span>
<a href="#l48.24"></a><span id="l48.24" class="difflineat">@@ -44,48 +44,48 @@ var tests = [</span>
<a href="#l48.25"></a><span id="l48.25"> </span>
<a href="#l48.26"></a><span id="l48.26"> function setup_messages() {</span>
<a href="#l48.27"></a><span id="l48.27">   Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l48.28"></a><span id="l48.28"> </span>
<a href="#l48.29"></a><span id="l48.29">   let messageGenerator = new MessageGenerator();</span>
<a href="#l48.30"></a><span id="l48.30">   let messageString = messageGenerator.makeMessage().toMessageString();</span>
<a href="#l48.31"></a><span id="l48.31">   let dataUri = Services.io.newURI(&quot;data:text/plain;base64,&quot; + btoa(messageString),</span>
<a href="#l48.32"></a><span id="l48.32">                                    null, null);</span>
<a href="#l48.33"></a><span id="l48.33" class="difflineminus">-  let imapMsg = new imapMessage(dataUri.spec, gIMAPMailbox.uidnext++, []);</span>
<a href="#l48.34"></a><span id="l48.34" class="difflineminus">-  gIMAPMailbox.addMessage(imapMsg);</span>
<a href="#l48.35"></a><span id="l48.35" class="difflineplus">+  let imapMsg = new imapMessage(dataUri.spec, IMAPPump.mailbox.uidnext++, []);</span>
<a href="#l48.36"></a><span id="l48.36" class="difflineplus">+  IMAPPump.mailbox.addMessage(imapMsg);</span>
<a href="#l48.37"></a><span id="l48.37"> </span>
<a href="#l48.38"></a><span id="l48.38" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l48.39"></a><span id="l48.39" class="difflineplus">+  IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l48.40"></a><span id="l48.40">   yield false;</span>
<a href="#l48.41"></a><span id="l48.41"> }</span>
<a href="#l48.42"></a><span id="l48.42"> </span>
<a href="#l48.43"></a><span id="l48.43"> function move_messages() {</span>
<a href="#l48.44"></a><span id="l48.44">   let messages = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l48.45"></a><span id="l48.45" class="difflineminus">-  let msg = gIMAPInbox.msgDatabase.GetMsgHdrForKey(gIMAPMailbox.uidnext - 1);</span>
<a href="#l48.46"></a><span id="l48.46" class="difflineplus">+  let msg = IMAPPump.inbox.msgDatabase.GetMsgHdrForKey(IMAPPump.mailbox.uidnext - 1);</span>
<a href="#l48.47"></a><span id="l48.47">   messages.appendElement(msg, false);</span>
<a href="#l48.48"></a><span id="l48.48" class="difflineminus">-  MailServices.copy.CopyMessages(gIMAPInbox, messages, localAccountUtils.inboxFolder,</span>
<a href="#l48.49"></a><span id="l48.49" class="difflineplus">+  MailServices.copy.CopyMessages(IMAPPump.inbox, messages, localAccountUtils.inboxFolder,</span>
<a href="#l48.50"></a><span id="l48.50">                                  true, asyncCopyListener, null, false);</span>
<a href="#l48.51"></a><span id="l48.51">   yield false;</span>
<a href="#l48.52"></a><span id="l48.52"> }</span>
<a href="#l48.53"></a><span id="l48.53"> </span>
<a href="#l48.54"></a><span id="l48.54"> function check_messages() {</span>
<a href="#l48.55"></a><span id="l48.55" class="difflineminus">-  do_check_eq(gIMAPInbox.getTotalMessages(false), 1);</span>
<a href="#l48.56"></a><span id="l48.56" class="difflineplus">+  do_check_eq(IMAPPump.inbox.getTotalMessages(false), 1);</span>
<a href="#l48.57"></a><span id="l48.57">   do_check_eq(localAccountUtils.inboxFolder.getTotalMessages(false), 0);</span>
<a href="#l48.58"></a><span id="l48.58">   yield true;</span>
<a href="#l48.59"></a><span id="l48.59"> }</span>
<a href="#l48.60"></a><span id="l48.60"> </span>
<a href="#l48.61"></a><span id="l48.61"> function run_test() {</span>
<a href="#l48.62"></a><span id="l48.62">   do_register_cleanup(function() {</span>
<a href="#l48.63"></a><span id="l48.63" class="difflineminus">-    // gIMAPServer.performTest() brings this test to a halt,</span>
<a href="#l48.64"></a><span id="l48.64" class="difflineminus">-    // so we need teardownIMAPPump() without gIMAPServer.performTest().</span>
<a href="#l48.65"></a><span id="l48.65" class="difflineminus">-    gIMAPInbox = null;</span>
<a href="#l48.66"></a><span id="l48.66" class="difflineminus">-    gIMAPServer.resetTest();</span>
<a href="#l48.67"></a><span id="l48.67" class="difflineplus">+    // IMAPPump.server.performTest() brings this test to a halt,</span>
<a href="#l48.68"></a><span id="l48.68" class="difflineplus">+    // so we need teardownIMAPPump() without IMAPPump.server.performTest().</span>
<a href="#l48.69"></a><span id="l48.69" class="difflineplus">+    IMAPPump.inbox = null;</span>
<a href="#l48.70"></a><span id="l48.70" class="difflineplus">+    IMAPPump.server.resetTest();</span>
<a href="#l48.71"></a><span id="l48.71">     try {</span>
<a href="#l48.72"></a><span id="l48.72" class="difflineminus">-      gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l48.73"></a><span id="l48.73" class="difflineminus">-      let serverSink = gIMAPIncomingServer.QueryInterface(Ci.nsIImapServerSink);</span>
<a href="#l48.74"></a><span id="l48.74" class="difflineplus">+      IMAPPump.incomingServer.closeCachedConnections();</span>
<a href="#l48.75"></a><span id="l48.75" class="difflineplus">+      let serverSink = IMAPPump.incomingServer.QueryInterface(Ci.nsIImapServerSink);</span>
<a href="#l48.76"></a><span id="l48.76">       serverSink.abortQueuedUrls();</span>
<a href="#l48.77"></a><span id="l48.77">     } catch (ex) {dump(ex);}</span>
<a href="#l48.78"></a><span id="l48.78" class="difflineminus">-    gIMAPServer.stop();</span>
<a href="#l48.79"></a><span id="l48.79" class="difflineplus">+    IMAPPump.server.stop();</span>
<a href="#l48.80"></a><span id="l48.80">     let thread = gThreadManager.currentThread;</span>
<a href="#l48.81"></a><span id="l48.81">     while (thread.hasPendingEvents())</span>
<a href="#l48.82"></a><span id="l48.82">       thread.processNextEvent(true);</span>
<a href="#l48.83"></a><span id="l48.83">   });</span>
<a href="#l48.84"></a><span id="l48.84">   async_run_tests(tests);</span>
<a href="#l48.85"></a><span id="l48.85"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_syncChanges.js</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_syncChanges.js</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineat">@@ -12,65 +12,65 @@ load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l49.4"></a><span id="l49.4"> </span>
<a href="#l49.5"></a><span id="l49.5"> var gMessage;</span>
<a href="#l49.6"></a><span id="l49.6"> var gSecondFolder;</span>
<a href="#l49.7"></a><span id="l49.7"> var gSynthMessage;</span>
<a href="#l49.8"></a><span id="l49.8"> </span>
<a href="#l49.9"></a><span id="l49.9"> var tests = [</span>
<a href="#l49.10"></a><span id="l49.10">   setup,</span>
<a href="#l49.11"></a><span id="l49.11">   function switchAwayFromInbox() {</span>
<a href="#l49.12"></a><span id="l49.12" class="difflineminus">-    let rootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l49.13"></a><span id="l49.13" class="difflineplus">+    let rootFolder = IMAPPump.incomingServer.rootFolder;</span>
<a href="#l49.14"></a><span id="l49.14">     gSecondFolder =  rootFolder.getChildNamed(&quot;secondFolder&quot;)</span>
<a href="#l49.15"></a><span id="l49.15">                            .QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l49.16"></a><span id="l49.16"> </span>
<a href="#l49.17"></a><span id="l49.17">     // Selecting the second folder will close the cached connection</span>
<a href="#l49.18"></a><span id="l49.18">     // on the inbox because fake server only supports one connection at a time.</span>
<a href="#l49.19"></a><span id="l49.19">     //  Then, we can poke at the message on the imap server directly, which</span>
<a href="#l49.20"></a><span id="l49.20">     // simulates the user changing the message from a different machine,</span>
<a href="#l49.21"></a><span id="l49.21">     // and Thunderbird discovering the change when it does a flag sync </span>
<a href="#l49.22"></a><span id="l49.22">     // upon reselecting the Inbox.</span>
<a href="#l49.23"></a><span id="l49.23">     gSecondFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l49.24"></a><span id="l49.24">     yield false;</span>
<a href="#l49.25"></a><span id="l49.25">   },</span>
<a href="#l49.26"></a><span id="l49.26">   function simulateMailboxEmptied() {</span>
<a href="#l49.27"></a><span id="l49.27">     gMessage.setFlag(&quot;\\Deleted&quot;);</span>
<a href="#l49.28"></a><span id="l49.28" class="difflineminus">-    gIMAPInbox.expunge(asyncUrlListener, null);</span>
<a href="#l49.29"></a><span id="l49.29" class="difflineplus">+    IMAPPump.inbox.expunge(asyncUrlListener, null);</span>
<a href="#l49.30"></a><span id="l49.30">     yield false;</span>
<a href="#l49.31"></a><span id="l49.31" class="difflineminus">-    gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l49.32"></a><span id="l49.32" class="difflineplus">+    IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l49.33"></a><span id="l49.33">     yield false;</span>
<a href="#l49.34"></a><span id="l49.34">   },</span>
<a href="#l49.35"></a><span id="l49.35">   function checkMailboxEmpty() {</span>
<a href="#l49.36"></a><span id="l49.36" class="difflineminus">-    let msgHdr = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gSynthMessage.messageId);</span>
<a href="#l49.37"></a><span id="l49.37" class="difflineminus">-    do_check_eq(gIMAPInbox.getTotalMessages(false), 0);</span>
<a href="#l49.38"></a><span id="l49.38" class="difflineplus">+    let msgHdr = IMAPPump.inbox.msgDatabase.getMsgHdrForMessageID(gSynthMessage.messageId);</span>
<a href="#l49.39"></a><span id="l49.39" class="difflineplus">+    do_check_eq(IMAPPump.inbox.getTotalMessages(false), 0);</span>
<a href="#l49.40"></a><span id="l49.40">   },</span>
<a href="#l49.41"></a><span id="l49.41">   teardown</span>
<a href="#l49.42"></a><span id="l49.42"> ];</span>
<a href="#l49.43"></a><span id="l49.43"> </span>
<a href="#l49.44"></a><span id="l49.44"> function setup() {</span>
<a href="#l49.45"></a><span id="l49.45">   /*</span>
<a href="#l49.46"></a><span id="l49.46">    * Set up an IMAP server.</span>
<a href="#l49.47"></a><span id="l49.47">    */</span>
<a href="#l49.48"></a><span id="l49.48">   setupIMAPPump();</span>
<a href="#l49.49"></a><span id="l49.49"> </span>
<a href="#l49.50"></a><span id="l49.50" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;secondFolder&quot;, {subscribed : true});</span>
<a href="#l49.51"></a><span id="l49.51" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;secondFolder&quot;, {subscribed : true});</span>
<a href="#l49.52"></a><span id="l49.52"> </span>
<a href="#l49.53"></a><span id="l49.53">   let messages = [];</span>
<a href="#l49.54"></a><span id="l49.54">   let gMessageGenerator = new MessageGenerator();</span>
<a href="#l49.55"></a><span id="l49.55">   messages = messages.concat(gMessageGenerator.makeMessage());</span>
<a href="#l49.56"></a><span id="l49.56">   gSynthMessage = messages[0];</span>
<a href="#l49.57"></a><span id="l49.57"> </span>
<a href="#l49.58"></a><span id="l49.58">   let msgURI =</span>
<a href="#l49.59"></a><span id="l49.59">     Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l49.60"></a><span id="l49.60">                        btoa(gSynthMessage.toMessageString()),</span>
<a href="#l49.61"></a><span id="l49.61">                        null, null);</span>
<a href="#l49.62"></a><span id="l49.62" class="difflineminus">-  gMessage = new imapMessage(msgURI.spec, gIMAPMailbox.uidnext++, []);</span>
<a href="#l49.63"></a><span id="l49.63" class="difflineminus">-  gIMAPMailbox.addMessage(gMessage);</span>
<a href="#l49.64"></a><span id="l49.64" class="difflineplus">+  gMessage = new imapMessage(msgURI.spec, IMAPPump.mailbox.uidnext++, []);</span>
<a href="#l49.65"></a><span id="l49.65" class="difflineplus">+  IMAPPump.mailbox.addMessage(gMessage);</span>
<a href="#l49.66"></a><span id="l49.66"> </span>
<a href="#l49.67"></a><span id="l49.67">   // update folder to download header.</span>
<a href="#l49.68"></a><span id="l49.68" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l49.69"></a><span id="l49.69" class="difflineplus">+  IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l49.70"></a><span id="l49.70">   yield false;</span>
<a href="#l49.71"></a><span id="l49.71"> }</span>
<a href="#l49.72"></a><span id="l49.72"> </span>
<a href="#l49.73"></a><span id="l49.73"> asyncUrlListener.callback = function(aUrl, aExitCode) {</span>
<a href="#l49.74"></a><span id="l49.74">   do_check_eq(aExitCode, 0);</span>
<a href="#l49.75"></a><span id="l49.75"> };</span>
<a href="#l49.76"></a><span id="l49.76"> </span>
<a href="#l49.77"></a><span id="l49.77"> function teardown() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_trustSpamAssassin.js</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_trustSpamAssassin.js</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineat">@@ -34,49 +34,49 @@ var tests = [</span>
<a href="#l50.4"></a><span id="l50.4">   markMessageAsGood,</span>
<a href="#l50.5"></a><span id="l50.5">   updateFoldersAndCheck,</span>
<a href="#l50.6"></a><span id="l50.6">   endTest,</span>
<a href="#l50.7"></a><span id="l50.7"> ]</span>
<a href="#l50.8"></a><span id="l50.8"> </span>
<a href="#l50.9"></a><span id="l50.9"> let gJunkFolder;</span>
<a href="#l50.10"></a><span id="l50.10"> function createJunkFolder()</span>
<a href="#l50.11"></a><span id="l50.11"> {</span>
<a href="#l50.12"></a><span id="l50.12" class="difflineminus">-  gIMAPIncomingServer.rootFolder.createSubfolder(&quot;Junk&quot;, null);</span>
<a href="#l50.13"></a><span id="l50.13" class="difflineplus">+  IMAPPump.incomingServer.rootFolder.createSubfolder(&quot;Junk&quot;, null);</span>
<a href="#l50.14"></a><span id="l50.14">   dl('wait for folderAdded');</span>
<a href="#l50.15"></a><span id="l50.15">   yield false;</span>
<a href="#l50.16"></a><span id="l50.16" class="difflineminus">-  gJunkFolder = gIMAPIncomingServer.rootFolder.getChildNamed(&quot;Junk&quot;);</span>
<a href="#l50.17"></a><span id="l50.17" class="difflineplus">+  gJunkFolder = IMAPPump.incomingServer.rootFolder.getChildNamed(&quot;Junk&quot;);</span>
<a href="#l50.18"></a><span id="l50.18">   do_check_true(gJunkFolder instanceof Ci.nsIMsgImapMailFolder);</span>
<a href="#l50.19"></a><span id="l50.19">   gJunkFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l50.20"></a><span id="l50.20">   dl('wait for OnStopRunningURL');</span>
<a href="#l50.21"></a><span id="l50.21">   yield false;</span>
<a href="#l50.22"></a><span id="l50.22"> }</span>
<a href="#l50.23"></a><span id="l50.23"> </span>
<a href="#l50.24"></a><span id="l50.24"> /*</span>
<a href="#l50.25"></a><span id="l50.25">  * Load and update a message in the imap fake server, should move</span>
<a href="#l50.26"></a><span id="l50.26">  *  SpamAssassin-marked junk message to junk folder</span>
<a href="#l50.27"></a><span id="l50.27">  */</span>
<a href="#l50.28"></a><span id="l50.28"> function loadImapMessage()</span>
<a href="#l50.29"></a><span id="l50.29"> {</span>
<a href="#l50.30"></a><span id="l50.30" class="difflineminus">-  gIMAPMailbox.addMessage(new imapMessage(specForFileName(gMessage),</span>
<a href="#l50.31"></a><span id="l50.31" class="difflineminus">-                          gIMAPMailbox.uidnext++, []));</span>
<a href="#l50.32"></a><span id="l50.32" class="difflineplus">+  IMAPPump.mailbox.addMessage(new imapMessage(specForFileName(gMessage),</span>
<a href="#l50.33"></a><span id="l50.33" class="difflineplus">+                          IMAPPump.mailbox.uidnext++, []));</span>
<a href="#l50.34"></a><span id="l50.34">   /*</span>
<a href="#l50.35"></a><span id="l50.35">    * The message matched the SpamAssassin header, so it moved</span>
<a href="#l50.36"></a><span id="l50.36">    *  to the junk folder</span>
<a href="#l50.37"></a><span id="l50.37">    */</span>
<a href="#l50.38"></a><span id="l50.38" class="difflineminus">-  gIMAPInbox.updateFolder(null);</span>
<a href="#l50.39"></a><span id="l50.39" class="difflineplus">+  IMAPPump.inbox.updateFolder(null);</span>
<a href="#l50.40"></a><span id="l50.40">   dl('wait for msgsMoveCopyCompleted');</span>
<a href="#l50.41"></a><span id="l50.41">   yield false;</span>
<a href="#l50.42"></a><span id="l50.42">   gJunkFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l50.43"></a><span id="l50.43">   dl('wait for OnStopRunningURL');</span>
<a href="#l50.44"></a><span id="l50.44">   yield false;</span>
<a href="#l50.45"></a><span id="l50.45"> }</span>
<a href="#l50.46"></a><span id="l50.46"> </span>
<a href="#l50.47"></a><span id="l50.47"> function testMessageInJunk()</span>
<a href="#l50.48"></a><span id="l50.48"> {</span>
<a href="#l50.49"></a><span id="l50.49" class="difflineminus">-  do_check_eq(0, gIMAPInbox.getTotalMessages(false));</span>
<a href="#l50.50"></a><span id="l50.50" class="difflineplus">+  do_check_eq(0, IMAPPump.inbox.getTotalMessages(false));</span>
<a href="#l50.51"></a><span id="l50.51">   do_check_eq(1, gJunkFolder.getTotalMessages(false));</span>
<a href="#l50.52"></a><span id="l50.52">   yield true;</span>
<a href="#l50.53"></a><span id="l50.53"> }</span>
<a href="#l50.54"></a><span id="l50.54"> </span>
<a href="#l50.55"></a><span id="l50.55"> function markMessageAsGood()</span>
<a href="#l50.56"></a><span id="l50.56"> {</span>
<a href="#l50.57"></a><span id="l50.57">   /*</span>
<a href="#l50.58"></a><span id="l50.58">    * This is done in the application in nsMsgDBView, which is difficult</span>
<a href="#l50.59"></a><span id="l50.59" class="difflineat">@@ -103,44 +103,44 @@ function markMessageAsGood()</span>
<a href="#l50.60"></a><span id="l50.60">                     in nsIArray messages,</span>
<a href="#l50.61"></a><span id="l50.61">                     in nsIMsgFolder dstFolder,</span>
<a href="#l50.62"></a><span id="l50.62">                     in boolean isMove,</span>
<a href="#l50.63"></a><span id="l50.63">                     in nsIMsgCopyServiceListener listener,</span>
<a href="#l50.64"></a><span id="l50.64">                     in nsIMsgWindow msgWindow,</span>
<a href="#l50.65"></a><span id="l50.65">                     in boolean allowUndo);</span>
<a href="#l50.66"></a><span id="l50.66">   */</span>
<a href="#l50.67"></a><span id="l50.67"> </span>
<a href="#l50.68"></a><span id="l50.68" class="difflineminus">-  MailServices.copy.CopyMessages(gJunkFolder, messages, gIMAPInbox, true,</span>
<a href="#l50.69"></a><span id="l50.69" class="difflineplus">+  MailServices.copy.CopyMessages(gJunkFolder, messages, IMAPPump.inbox, true,</span>
<a href="#l50.70"></a><span id="l50.70">                                  null, null, false);</span>
<a href="#l50.71"></a><span id="l50.71">   dl('wait for msgsMoveCopyCompleted');</span>
<a href="#l50.72"></a><span id="l50.72">   yield false;</span>
<a href="#l50.73"></a><span id="l50.73"> }</span>
<a href="#l50.74"></a><span id="l50.74"> </span>
<a href="#l50.75"></a><span id="l50.75"> function updateFoldersAndCheck()</span>
<a href="#l50.76"></a><span id="l50.76"> {</span>
<a href="#l50.77"></a><span id="l50.77" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l50.78"></a><span id="l50.78" class="difflineplus">+  IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l50.79"></a><span id="l50.79">   dl('wait for OnStopRunningURL');</span>
<a href="#l50.80"></a><span id="l50.80">   yield false;</span>
<a href="#l50.81"></a><span id="l50.81">   gJunkFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l50.82"></a><span id="l50.82">   dl('wait for OnStopRunningURL');</span>
<a href="#l50.83"></a><span id="l50.83">   yield false;</span>
<a href="#l50.84"></a><span id="l50.84">   // bug 540385 causes this test to fail</span>
<a href="#l50.85"></a><span id="l50.85" class="difflineminus">-  do_check_eq(1, gIMAPInbox.getTotalMessages(false));</span>
<a href="#l50.86"></a><span id="l50.86" class="difflineplus">+  do_check_eq(1, IMAPPump.inbox.getTotalMessages(false));</span>
<a href="#l50.87"></a><span id="l50.87">   do_check_eq(0, gJunkFolder.getTotalMessages(false));</span>
<a href="#l50.88"></a><span id="l50.88">   yield true;</span>
<a href="#l50.89"></a><span id="l50.89"> }</span>
<a href="#l50.90"></a><span id="l50.90"> </span>
<a href="#l50.91"></a><span id="l50.91"> function endTest()</span>
<a href="#l50.92"></a><span id="l50.92"> {</span>
<a href="#l50.93"></a><span id="l50.93">   teardownIMAPPump();</span>
<a href="#l50.94"></a><span id="l50.94"> }</span>
<a href="#l50.95"></a><span id="l50.95"> </span>
<a href="#l50.96"></a><span id="l50.96"> function run_test()</span>
<a href="#l50.97"></a><span id="l50.97"> {</span>
<a href="#l50.98"></a><span id="l50.98" class="difflineminus">-  let server = gIMAPIncomingServer;</span>
<a href="#l50.99"></a><span id="l50.99" class="difflineplus">+  let server = IMAPPump.incomingServer;</span>
<a href="#l50.100"></a><span id="l50.100">   let spamSettings = server.spamSettings;</span>
<a href="#l50.101"></a><span id="l50.101">   server.setBoolValue(&quot;useServerFilter&quot;, true);</span>
<a href="#l50.102"></a><span id="l50.102">   server.setCharValue(&quot;serverFilterName&quot;, &quot;SpamAssassin&quot;);</span>
<a href="#l50.103"></a><span id="l50.103">   server.setIntValue(&quot;serverFilterTrustFlags&quot;, Ci.nsISpamSettings.TRUST_POSITIVES);</span>
<a href="#l50.104"></a><span id="l50.104">   server.setBoolValue(&quot;moveOnSpam&quot;, true);</span>
<a href="#l50.105"></a><span id="l50.105">   server.setIntValue(&quot;moveTargetMode&quot;, Ci.nsISpamSettings.MOVE_TARGET_MODE_ACCOUNT);</span>
<a href="#l50.106"></a><span id="l50.106">   server.setCharValue(&quot;spamActionTargetAccount&quot;, server.serverURI);</span>
<a href="#l50.107"></a><span id="l50.107"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1" class="difflineminus">--- a/mailnews/test/resources/IMAPpump.js</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineplus">+++ b/mailnews/test/resources/IMAPpump.js</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineat">@@ -25,21 +25,23 @@ if (typeof gDEPTH == &quot;undefined&quot;)</span>
<a href="#l51.4"></a><span id="l51.4"> </span>
<a href="#l51.5"></a><span id="l51.5"> // add imap fake server methods if missing</span>
<a href="#l51.6"></a><span id="l51.6"> </span>
<a href="#l51.7"></a><span id="l51.7"> Components.utils.import(&quot;resource://testing-common/mailnews/maild.js&quot;);</span>
<a href="#l51.8"></a><span id="l51.8"> Components.utils.import(&quot;resource://testing-common/mailnews/auth.js&quot;);</span>
<a href="#l51.9"></a><span id="l51.9"> Components.utils.import(&quot;resource://testing-common/mailnews/imapd.js&quot;);</span>
<a href="#l51.10"></a><span id="l51.10"> </span>
<a href="#l51.11"></a><span id="l51.11"> // define globals</span>
<a href="#l51.12"></a><span id="l51.12" class="difflineminus">-var gIMAPDaemon;         // the imap fake server daemon</span>
<a href="#l51.13"></a><span id="l51.13" class="difflineminus">-var gIMAPServer;         // the imap fake server</span>
<a href="#l51.14"></a><span id="l51.14" class="difflineminus">-var gIMAPIncomingServer; // nsIMsgIncomingServer for the imap server</span>
<a href="#l51.15"></a><span id="l51.15" class="difflineminus">-var gIMAPInbox;          // nsIMsgFolder/nsIMsgImapMailFolder for imap inbox</span>
<a href="#l51.16"></a><span id="l51.16" class="difflineminus">-var gIMAPMailbox;        // imap fake server mailbox</span>
<a href="#l51.17"></a><span id="l51.17" class="difflineplus">+var IMAPPump = {</span>
<a href="#l51.18"></a><span id="l51.18" class="difflineplus">+  daemon: null,         // the imap fake server daemon</span>
<a href="#l51.19"></a><span id="l51.19" class="difflineplus">+  server: null,         // the imap fake server</span>
<a href="#l51.20"></a><span id="l51.20" class="difflineplus">+  incomingServer: null, // nsIMsgIncomingServer for the imap server</span>
<a href="#l51.21"></a><span id="l51.21" class="difflineplus">+  inbox: null,          // nsIMsgFolder/nsIMsgImapMailFolder for imap inbox</span>
<a href="#l51.22"></a><span id="l51.22" class="difflineplus">+  mailbox: null         // imap fake server mailbox</span>
<a href="#l51.23"></a><span id="l51.23" class="difflineplus">+};</span>
<a href="#l51.24"></a><span id="l51.24"> var gAppInfo;            // application info</span>
<a href="#l51.25"></a><span id="l51.25"> </span>
<a href="#l51.26"></a><span id="l51.26"> function setupIMAPPump(extensions)</span>
<a href="#l51.27"></a><span id="l51.27"> {</span>
<a href="#l51.28"></a><span id="l51.28">   createAppInfo(&quot;xpcshell@tests.mozilla.org&quot;, &quot;XPCShell&quot;, &quot;5&quot;, &quot;2.0&quot;);</span>
<a href="#l51.29"></a><span id="l51.29"> </span>
<a href="#l51.30"></a><span id="l51.30">   // These are copied from imap's head_server.js to here so we can run</span>
<a href="#l51.31"></a><span id="l51.31">   //   this from any directory.</span>
<a href="#l51.32"></a><span id="l51.32" class="difflineat">@@ -70,66 +72,66 @@ function setupIMAPPump(extensions)</span>
<a href="#l51.33"></a><span id="l51.33">     let server = localAccountUtils.create_incoming_server(&quot;imap&quot;, IMAP_PORT,</span>
<a href="#l51.34"></a><span id="l51.34"> 							  &quot;user&quot;, &quot;password&quot;);</span>
<a href="#l51.35"></a><span id="l51.35">     server.QueryInterface(Ci.nsIImapIncomingServer);</span>
<a href="#l51.36"></a><span id="l51.36">     return server;</span>
<a href="#l51.37"></a><span id="l51.37">   }</span>
<a href="#l51.38"></a><span id="l51.38"> </span>
<a href="#l51.39"></a><span id="l51.39">   // end copy from head_server.js</span>
<a href="#l51.40"></a><span id="l51.40"> </span>
<a href="#l51.41"></a><span id="l51.41" class="difflineminus">-  gIMAPDaemon = new imapDaemon();</span>
<a href="#l51.42"></a><span id="l51.42" class="difflineminus">-  gIMAPServer = makeServer(gIMAPDaemon, extensions);</span>
<a href="#l51.43"></a><span id="l51.43" class="difflineplus">+  IMAPPump.daemon = new imapDaemon();</span>
<a href="#l51.44"></a><span id="l51.44" class="difflineplus">+  IMAPPump.server = makeServer(IMAPPump.daemon, extensions);</span>
<a href="#l51.45"></a><span id="l51.45"> </span>
<a href="#l51.46"></a><span id="l51.46" class="difflineminus">-  gIMAPIncomingServer = createLocalIMAPServer();</span>
<a href="#l51.47"></a><span id="l51.47" class="difflineplus">+  IMAPPump.incomingServer = createLocalIMAPServer();</span>
<a href="#l51.48"></a><span id="l51.48"> </span>
<a href="#l51.49"></a><span id="l51.49">   if (!localAccountUtils.inboxFolder)</span>
<a href="#l51.50"></a><span id="l51.50">     localAccountUtils.loadLocalMailAccount();</span>
<a href="#l51.51"></a><span id="l51.51"> </span>
<a href="#l51.52"></a><span id="l51.52">   // We need an identity so that updateFolder doesn't fail</span>
<a href="#l51.53"></a><span id="l51.53">   let localAccount = MailServices.accounts.createAccount();</span>
<a href="#l51.54"></a><span id="l51.54">   let identity = MailServices.accounts.createIdentity();</span>
<a href="#l51.55"></a><span id="l51.55">   localAccount.addIdentity(identity);</span>
<a href="#l51.56"></a><span id="l51.56">   localAccount.defaultIdentity = identity;</span>
<a href="#l51.57"></a><span id="l51.57">   localAccount.incomingServer = localAccountUtils.incomingServer;</span>
<a href="#l51.58"></a><span id="l51.58">   MailServices.accounts.defaultAccount = localAccount;</span>
<a href="#l51.59"></a><span id="l51.59"> </span>
<a href="#l51.60"></a><span id="l51.60">   // Let's also have another account, using the same identity</span>
<a href="#l51.61"></a><span id="l51.61">   let imapAccount = MailServices.accounts.createAccount();</span>
<a href="#l51.62"></a><span id="l51.62">   imapAccount.addIdentity(identity);</span>
<a href="#l51.63"></a><span id="l51.63">   imapAccount.defaultIdentity = identity;</span>
<a href="#l51.64"></a><span id="l51.64" class="difflineminus">-  imapAccount.incomingServer = gIMAPIncomingServer;</span>
<a href="#l51.65"></a><span id="l51.65" class="difflineplus">+  imapAccount.incomingServer = IMAPPump.incomingServer;</span>
<a href="#l51.66"></a><span id="l51.66"> </span>
<a href="#l51.67"></a><span id="l51.67">   // The server doesn't support more than one connection</span>
<a href="#l51.68"></a><span id="l51.68">   Services.prefs.setIntPref(&quot;mail.server.default.max_cached_connections&quot;, 1);</span>
<a href="#l51.69"></a><span id="l51.69">   // We aren't interested in downloading messages automatically</span>
<a href="#l51.70"></a><span id="l51.70">   Services.prefs.setBoolPref(&quot;mail.server.default.download_on_biff&quot;, false);</span>
<a href="#l51.71"></a><span id="l51.71">   Services.prefs.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l51.72"></a><span id="l51.72">   Services.prefs.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l51.73"></a><span id="l51.73">   Services.prefs.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l51.74"></a><span id="l51.74">   Services.prefs.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l51.75"></a><span id="l51.75">   Services.prefs.setBoolPref(&quot;mail.biff.alert.show_preview&quot;, false);</span>
<a href="#l51.76"></a><span id="l51.76"> </span>
<a href="#l51.77"></a><span id="l51.77" class="difflineminus">-  gIMAPIncomingServer.performExpand(null);</span>
<a href="#l51.78"></a><span id="l51.78" class="difflineplus">+  IMAPPump.incomingServer.performExpand(null);</span>
<a href="#l51.79"></a><span id="l51.79"> </span>
<a href="#l51.80"></a><span id="l51.80" class="difflineminus">-  gIMAPInbox = gIMAPIncomingServer.rootFolder.getChildNamed(&quot;INBOX&quot;);</span>
<a href="#l51.81"></a><span id="l51.81" class="difflineminus">-  gIMAPMailbox = gIMAPDaemon.getMailbox(&quot;INBOX&quot;);</span>
<a href="#l51.82"></a><span id="l51.82" class="difflineminus">-  gIMAPInbox instanceof Ci.nsIMsgImapMailFolder;</span>
<a href="#l51.83"></a><span id="l51.83" class="difflineplus">+  IMAPPump.inbox = IMAPPump.incomingServer.rootFolder.getChildNamed(&quot;INBOX&quot;);</span>
<a href="#l51.84"></a><span id="l51.84" class="difflineplus">+  IMAPPump.mailbox = IMAPPump.daemon.getMailbox(&quot;INBOX&quot;);</span>
<a href="#l51.85"></a><span id="l51.85" class="difflineplus">+  IMAPPump.inbox instanceof Ci.nsIMsgImapMailFolder;</span>
<a href="#l51.86"></a><span id="l51.86"> }</span>
<a href="#l51.87"></a><span id="l51.87"> </span>
<a href="#l51.88"></a><span id="l51.88"> function teardownIMAPPump()</span>
<a href="#l51.89"></a><span id="l51.89"> {</span>
<a href="#l51.90"></a><span id="l51.90" class="difflineminus">-  gIMAPInbox = null;</span>
<a href="#l51.91"></a><span id="l51.91" class="difflineminus">-  gIMAPServer.resetTest();</span>
<a href="#l51.92"></a><span id="l51.92" class="difflineplus">+  IMAPPump.inbox = null;</span>
<a href="#l51.93"></a><span id="l51.93" class="difflineplus">+  IMAPPump.server.resetTest();</span>
<a href="#l51.94"></a><span id="l51.94">   try {</span>
<a href="#l51.95"></a><span id="l51.95" class="difflineminus">-    gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l51.96"></a><span id="l51.96" class="difflineminus">-    let serverSink = gIMAPIncomingServer.QueryInterface(Ci.nsIImapServerSink);</span>
<a href="#l51.97"></a><span id="l51.97" class="difflineplus">+    IMAPPump.incomingServer.closeCachedConnections();</span>
<a href="#l51.98"></a><span id="l51.98" class="difflineplus">+    let serverSink = IMAPPump.incomingServer.QueryInterface(Ci.nsIImapServerSink);</span>
<a href="#l51.99"></a><span id="l51.99">     serverSink.abortQueuedUrls();</span>
<a href="#l51.100"></a><span id="l51.100">   } catch (ex) {dump(ex);}</span>
<a href="#l51.101"></a><span id="l51.101" class="difflineminus">-  gIMAPServer.performTest();</span>
<a href="#l51.102"></a><span id="l51.102" class="difflineminus">-  gIMAPServer.stop();</span>
<a href="#l51.103"></a><span id="l51.103" class="difflineplus">+  IMAPPump.server.performTest();</span>
<a href="#l51.104"></a><span id="l51.104" class="difflineplus">+  IMAPPump.server.stop();</span>
<a href="#l51.105"></a><span id="l51.105">   let thread = gThreadManager.currentThread;</span>
<a href="#l51.106"></a><span id="l51.106">   while (thread.hasPendingEvents())</span>
<a href="#l51.107"></a><span id="l51.107">     thread.processNextEvent(true);</span>
<a href="#l51.108"></a><span id="l51.108"> }</span>
<a href="#l51.109"></a><span id="l51.109"> </span>
<a href="#l51.110"></a><span id="l51.110"> const XULAPPINFO_CONTRACTID = &quot;@mozilla.org/xre/app-info;1&quot;;</span>
<a href="#l51.111"></a><span id="l51.111"> const XULAPPINFO_CID = Components.ID(&quot;{7e10a36e-1085-4302-9e3f-9571fc003ee0}&quot;);</span>
<a href="#l51.112"></a><span id="l51.112"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

