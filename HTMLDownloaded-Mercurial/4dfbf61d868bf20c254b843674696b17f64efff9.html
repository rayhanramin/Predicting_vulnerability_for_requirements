<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 24636:4dfbf61d868bf20c254b843674696b17f64efff9</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 4dfbf61d868bf20c254b843674696b17f64efff9" />
<meta property="og:url" content="/comm-central/rev/4dfbf61d868bf20c254b843674696b17f64efff9" />
<meta property="og:description" content="Bug 1477956 - Change overlay loader so it can run before document load; stop requiring restart to start legacy extension; r=Fallen" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 4dfbf61d868bf20c254b843674696b17f64efff9 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/4dfbf61d868bf20c254b843674696b17f64efff9">shortlog</a> |
<a href="/comm-central/log/4dfbf61d868bf20c254b843674696b17f64efff9">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/4dfbf61d868bf20c254b843674696b17f64efff9">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/4dfbf61d868bf20c254b843674696b17f64efff9">files</a> |
changeset |
<a href="/comm-central/raw-rev/4dfbf61d868bf20c254b843674696b17f64efff9">raw</a>  | <a href="/comm-central/archive/4dfbf61d868bf20c254b843674696b17f64efff9.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1477956">Bug 1477956</a> - Change overlay loader so it can run before document load; stop requiring restart to start legacy extension; r=Fallen
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 03 Sep 2018 21:57:32 +1200</td></tr>

<tr>
 <td>changeset 24636</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/4dfbf61d868bf20c254b843674696b17f64efff9">4dfbf61d868bf20c254b843674696b17f64efff9</a></td>
</tr>



<tr>
<td>parent 24635</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/7a59c0ecec8e892b7175910be9cfdb46dff8e60c">7a59c0ecec8e892b7175910be9cfdb46dff8e60c</a>
</td>
</tr>

<tr>
<td>child 24637</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b67c87c8e4fe8712e75d85e050b107a21198967a">b67c87c8e4fe8712e75d85e050b107a21198967a</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=4dfbf61d868bf20c254b843674696b17f64efff9">14823</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Mon, 03 Sep 2018 09:58:36 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@4da4607269c1 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4da4607269c163cfd28c54cb46e6033db77a7882">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4da4607269c163cfd28c54cb46e6033db77a7882&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4da4607269c163cfd28c54cb46e6033db77a7882&newProject=comm-central&newRevision=4dfbf61d868bf20c254b843674696b17f64efff9&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4da4607269c163cfd28c54cb46e6033db77a7882&newProject=comm-central&newRevision=4dfbf61d868bf20c254b843674696b17f64efff9&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4da4607269c163cfd28c54cb46e6033db77a7882&newProject=comm-central&newRevision=4dfbf61d868bf20c254b843674696b17f64efff9&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Fallen%29&revcount=50">Fallen</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1477956">1477956</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1477956">Bug 1477956</a> - Change overlay loader so it can run before document load; stop requiring restart to start legacy extension; r=Fallen</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4dfbf61d868bf20c254b843674696b17f64efff9/calendar/base/content/calendar-common-sets.js">calendar/base/content/calendar-common-sets.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4dfbf61d868bf20c254b843674696b17f64efff9/calendar/base/content/calendar-common-sets.js">file</a> |
<a href="/comm-central/annotate/4dfbf61d868bf20c254b843674696b17f64efff9/calendar/base/content/calendar-common-sets.js">annotate</a> |
<a href="/comm-central/diff/4dfbf61d868bf20c254b843674696b17f64efff9/calendar/base/content/calendar-common-sets.js">diff</a> |
<a href="/comm-central/comparison/4dfbf61d868bf20c254b843674696b17f64efff9/calendar/base/content/calendar-common-sets.js">comparison</a> |
<a href="/comm-central/log/4dfbf61d868bf20c254b843674696b17f64efff9/calendar/base/content/calendar-common-sets.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4dfbf61d868bf20c254b843674696b17f64efff9/common/src/Overlays.jsm">common/src/Overlays.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4dfbf61d868bf20c254b843674696b17f64efff9/common/src/Overlays.jsm">file</a> |
<a href="/comm-central/annotate/4dfbf61d868bf20c254b843674696b17f64efff9/common/src/Overlays.jsm">annotate</a> |
<a href="/comm-central/diff/4dfbf61d868bf20c254b843674696b17f64efff9/common/src/Overlays.jsm">diff</a> |
<a href="/comm-central/comparison/4dfbf61d868bf20c254b843674696b17f64efff9/common/src/Overlays.jsm">comparison</a> |
<a href="/comm-central/log/4dfbf61d868bf20c254b843674696b17f64efff9/common/src/Overlays.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4dfbf61d868bf20c254b843674696b17f64efff9/mail/base/content/extensions.xml">mail/base/content/extensions.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4dfbf61d868bf20c254b843674696b17f64efff9/mail/base/content/extensions.xml">file</a> |
<a href="/comm-central/annotate/4dfbf61d868bf20c254b843674696b17f64efff9/mail/base/content/extensions.xml">annotate</a> |
<a href="/comm-central/diff/4dfbf61d868bf20c254b843674696b17f64efff9/mail/base/content/extensions.xml">diff</a> |
<a href="/comm-central/comparison/4dfbf61d868bf20c254b843674696b17f64efff9/mail/base/content/extensions.xml">comparison</a> |
<a href="/comm-central/log/4dfbf61d868bf20c254b843674696b17f64efff9/mail/base/content/extensions.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4dfbf61d868bf20c254b843674696b17f64efff9/mail/components/extensions/parent/ext-legacy.js">mail/components/extensions/parent/ext-legacy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4dfbf61d868bf20c254b843674696b17f64efff9/mail/components/extensions/parent/ext-legacy.js">file</a> |
<a href="/comm-central/annotate/4dfbf61d868bf20c254b843674696b17f64efff9/mail/components/extensions/parent/ext-legacy.js">annotate</a> |
<a href="/comm-central/diff/4dfbf61d868bf20c254b843674696b17f64efff9/mail/components/extensions/parent/ext-legacy.js">diff</a> |
<a href="/comm-central/comparison/4dfbf61d868bf20c254b843674696b17f64efff9/mail/components/extensions/parent/ext-legacy.js">comparison</a> |
<a href="/comm-central/log/4dfbf61d868bf20c254b843674696b17f64efff9/mail/components/extensions/parent/ext-legacy.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/content/calendar-common-sets.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/content/calendar-common-sets.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -782,17 +782,17 @@ var calendarController2 = {</span>
<a href="#l1.4"></a><span id="l1.4"> function injectCalendarCommandController() {</span>
<a href="#l1.5"></a><span id="l1.5">     // We need to put our new command controller *before* the one that</span>
<a href="#l1.6"></a><span id="l1.6">     // gets installed by thunderbird. Since we get called pretty early</span>
<a href="#l1.7"></a><span id="l1.7">     // during startup we need to install the function below as a callback</span>
<a href="#l1.8"></a><span id="l1.8">     // that periodically checks when the original thunderbird controller</span>
<a href="#l1.9"></a><span id="l1.9">     // gets alive. Please note that setTimeout with a value of 0 means that</span>
<a href="#l1.10"></a><span id="l1.10">     // we leave the current thread in order to re-enter the message loop.</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    let tbController = top.controllers.getControllerForCommand(&quot;cmd_runJunkControls&quot;);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    let tbController = top.DefaultController;</span>
<a href="#l1.14"></a><span id="l1.14">     if (tbController) {</span>
<a href="#l1.15"></a><span id="l1.15">         calendarController.defaultController = tbController;</span>
<a href="#l1.16"></a><span id="l1.16">         top.controllers.insertControllerAt(0, calendarController);</span>
<a href="#l1.17"></a><span id="l1.17">         document.commandDispatcher.updateCommands(&quot;calendar_commands&quot;);</span>
<a href="#l1.18"></a><span id="l1.18">     } else {</span>
<a href="#l1.19"></a><span id="l1.19">         setTimeout(injectCalendarCommandController, 0);</span>
<a href="#l1.20"></a><span id="l1.20">     }</span>
<a href="#l1.21"></a><span id="l1.21"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/common/src/Overlays.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/common/src/Overlays.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -81,16 +81,20 @@ class Overlays {</span>
<a href="#l2.4"></a><span id="l2.4">     let xulStore = Services.xulStore;</span>
<a href="#l2.5"></a><span id="l2.5">     this.persistedIDs = new Set();</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7">     // Load css styles from the registry</span>
<a href="#l2.8"></a><span id="l2.8">     for (let sheet of this.overlayProvider.style.get(this.location, false)) {</span>
<a href="#l2.9"></a><span id="l2.9">       unloadedSheets.push(sheet);</span>
<a href="#l2.10"></a><span id="l2.10">     }</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+    if (!unloadedOverlays.length &amp;&amp; !unloadedSheets.length) {</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+      return;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+    }</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+</span>
<a href="#l2.16"></a><span id="l2.16">     while (unloadedOverlays.length) {</span>
<a href="#l2.17"></a><span id="l2.17">       let url = unloadedOverlays.shift();</span>
<a href="#l2.18"></a><span id="l2.18">       let xhr = this.fetchOverlay(url);</span>
<a href="#l2.19"></a><span id="l2.19">       let doc = xhr.responseXML;</span>
<a href="#l2.20"></a><span id="l2.20"> </span>
<a href="#l2.21"></a><span id="l2.21">       oconsole.debug(`Applying ${url} to ${this.location}`);</span>
<a href="#l2.22"></a><span id="l2.22"> </span>
<a href="#l2.23"></a><span id="l2.23">       // clean the document a bit</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineat">@@ -165,71 +169,85 @@ class Overlays {</span>
<a href="#l2.25"></a><span id="l2.25">       oconsole.warn(`Could not resolve ${forwardReferences.length} references`, forwardReferences);</span>
<a href="#l2.26"></a><span id="l2.26">     }</span>
<a href="#l2.27"></a><span id="l2.27"> </span>
<a href="#l2.28"></a><span id="l2.28">     // Loading the sheets now to avoid race conditions with xbl bindings</span>
<a href="#l2.29"></a><span id="l2.29">     for (let sheet of unloadedSheets) {</span>
<a href="#l2.30"></a><span id="l2.30">       this.loadCSS(sheet);</span>
<a href="#l2.31"></a><span id="l2.31">     }</span>
<a href="#l2.32"></a><span id="l2.32"> </span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-    for (let bar of this._toolbarsToResolve) {</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-      let currentset = xulStore.getValue(this.location, bar.id, &quot;currentset&quot;);</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-      if (currentset) {</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-        bar.currentSet = currentset;</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-      } else if (bar.getAttribute(&quot;defaultset&quot;)) {</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-        bar.currentSet = bar.getAttribute(&quot;defaultset&quot;);</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+    this._decksToResolve = new Map();</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+    for (let id of this.persistedIDs.values()) {</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+      let element = this.document.getElementById(id);</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+      if (element) {</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+        let attrNames = xulStore.getAttributeEnumerator(this.location, id);</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+        while (attrNames.hasMore()) {</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+          let attrName = attrNames.getNext();</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+          let attrValue = xulStore.getValue(this.location, id, attrName);</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+          if (attrName == &quot;selectedIndex&quot; &amp;&amp; element.localName == &quot;deck&quot;) {</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+            this._decksToResolve.set(element, attrValue);</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+          } else {</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+            element.setAttribute(attrName, attrValue);</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+          }</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+        }</span>
<a href="#l2.53"></a><span id="l2.53">       }</span>
<a href="#l2.54"></a><span id="l2.54">     }</span>
<a href="#l2.55"></a><span id="l2.55"> </span>
<a href="#l2.56"></a><span id="l2.56">     // We've resolved all the forward references we can, we can now go ahead and load the scripts</span>
<a href="#l2.57"></a><span id="l2.57">     let deferredLoad = [];</span>
<a href="#l2.58"></a><span id="l2.58">     for (let script of unloadedScripts) {</span>
<a href="#l2.59"></a><span id="l2.59">       deferredLoad.push(...this.loadScript(script));</span>
<a href="#l2.60"></a><span id="l2.60">     }</span>
<a href="#l2.61"></a><span id="l2.61"> </span>
<a href="#l2.62"></a><span id="l2.62" class="difflineminus">-    let sheet;</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-    let overlayTrigger = this.document.createElement(&quot;overlayTrigger&quot;);</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-    overlayTrigger.addEventListener(&quot;bindingattached&quot;, () =&gt; {</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-      oconsole.debug(&quot;XBL binding attached, continuing with load&quot;);</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-      sheet.remove();</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineminus">-      overlayTrigger.remove();</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+    if (this.document.readyState == &quot;complete&quot;) {</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+      let sheet;</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+      let overlayTrigger = this.document.createElement(&quot;overlayTrigger&quot;);</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+      overlayTrigger.addEventListener(&quot;bindingattached&quot;, () =&gt; {</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+        oconsole.debug(&quot;XBL binding attached, continuing with load&quot;);</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+        sheet.remove();</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+        overlayTrigger.remove();</span>
<a href="#l2.75"></a><span id="l2.75"> </span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-      setTimeout(() =&gt; {</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-        for (let id of this.persistedIDs.values()) {</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-          let element = this.document.getElementById(id);</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineminus">-          if (element) {</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineminus">-            let attrNames = xulStore.getAttributeEnumerator(this.location, id);</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineminus">-            while (attrNames.hasMore()) {</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineminus">-              let attrName = attrNames.getNext();</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-              let attrValue = xulStore.getValue(this.location, id, attrName);</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-              element.setAttribute(attrName, attrValue);</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-              if (attrName == &quot;currentset&quot;) {</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-                element.currentSet = attrValue;</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-              }</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineplus">+        setTimeout(() =&gt; {</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+          this._finish();</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+          // Now execute load handlers since we are done loading scripts</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+          let bubbles = [];</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+          for (let { listener, useCapture } of deferredLoad) {</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+            if (useCapture) {</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+              this._fireEventListener(listener);</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+            } else {</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+              bubbles.push(listener);</span>
<a href="#l2.98"></a><span id="l2.98">             }</span>
<a href="#l2.99"></a><span id="l2.99">           }</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineminus">-        }</span>
<a href="#l2.101"></a><span id="l2.101"> </span>
<a href="#l2.102"></a><span id="l2.102" class="difflineminus">-        // Now execute load handlers since we are done loading scripts</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineminus">-        let bubbles = [];</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineminus">-        for (let { listener, useCapture } of deferredLoad) {</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineminus">-          if (useCapture) {</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineplus">+          for (let listener of bubbles) {</span>
<a href="#l2.107"></a><span id="l2.107">             this._fireEventListener(listener);</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineminus">-          } else {</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineminus">-            bubbles.push(listener);</span>
<a href="#l2.110"></a><span id="l2.110">           }</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineminus">-        }</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineplus">+        }, 0);</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineplus">+      }, { once: true });</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineplus">+      this.document.documentElement.appendChild(overlayTrigger);</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineplus">+      sheet = this.loadCSS(&quot;chrome://messenger/content/overlayBindings.css&quot;);</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineplus">+    } else {</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineplus">+      this.document.defaultView.addEventListener(&quot;load&quot;, this._finish.bind(this), { once: true });</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineplus">+    }</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineplus">+  }</span>
<a href="#l2.120"></a><span id="l2.120"> </span>
<a href="#l2.121"></a><span id="l2.121" class="difflineminus">-        for (let listener of bubbles) {</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineminus">-          this._fireEventListener(listener);</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineminus">-        }</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineminus">-      }, 0);</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineminus">-    }, { once: true });</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineminus">-    this.document.documentElement.appendChild(overlayTrigger);</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineminus">-    sheet = this.loadCSS(&quot;chrome://messenger/content/overlayBindings.css&quot;);</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineplus">+  _finish() {</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineplus">+    for (let [deck, selectedIndex] of this._decksToResolve.entries()) {</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+      deck.setAttribute(&quot;selectedIndex&quot;, selectedIndex);</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineplus">+    }</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineplus">+</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineplus">+    for (let bar of this._toolbarsToResolve) {</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineplus">+      let currentset = Services.xulStore.getValue(this.location, bar.id, &quot;currentset&quot;);</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineplus">+      if (currentset) {</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineplus">+        bar.currentSet = currentset;</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineplus">+      } else if (bar.getAttribute(&quot;defaultset&quot;)) {</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineplus">+        bar.currentSet = bar.getAttribute(&quot;defaultset&quot;);</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineplus">+      }</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineplus">+    }</span>
<a href="#l2.141"></a><span id="l2.141">   }</span>
<a href="#l2.142"></a><span id="l2.142"> </span>
<a href="#l2.143"></a><span id="l2.143">   /**</span>
<a href="#l2.144"></a><span id="l2.144">    * Gets the overlays referenced by processing instruction on a document.</span>
<a href="#l2.145"></a><span id="l2.145">    *</span>
<a href="#l2.146"></a><span id="l2.146">    * @param {DOMDocument} document  The document to read instuctions from</span>
<a href="#l2.147"></a><span id="l2.147">    * @return {String[]}             URLs of the overlays from the document</span>
<a href="#l2.148"></a><span id="l2.148">    */</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineat">@@ -266,32 +284,38 @@ class Overlays {</span>
<a href="#l2.150"></a><span id="l2.150">    * Resolves forward references for the given node. If the node exists in the target document, it</span>
<a href="#l2.151"></a><span id="l2.151">    * is merged in with the target node. If the node has no id it is inserted at documentElement</span>
<a href="#l2.152"></a><span id="l2.152">    * level.</span>
<a href="#l2.153"></a><span id="l2.153">    *</span>
<a href="#l2.154"></a><span id="l2.154">    * @param {Element} node          The DOM Element to resolve in the target document.</span>
<a href="#l2.155"></a><span id="l2.155">    * @return {Boolean}              True, if the node was merged/inserted, false otherwise</span>
<a href="#l2.156"></a><span id="l2.156">    */</span>
<a href="#l2.157"></a><span id="l2.157">   _resolveForwardReference(node) {</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineminus">-    if (node.id &amp;&amp; node.localName == &quot;toolbarpalette&quot;) {</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineminus">-      // These vanish from the document but still exist via the palette property</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineminus">-      let boxes = [...this.document.getElementsByTagName(&quot;toolbox&quot;)];</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineminus">-      let box = boxes.find(box =&gt; box.palette &amp;&amp; box.palette.id == node.id);</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineminus">-      let palette = box ? box.palette : null;</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineplus">+    if (node.id) {</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineplus">+      let target = this.document.getElementById(node.id);</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineplus">+      if (node.localName == &quot;toolbarpalette&quot;) {</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineplus">+        let box;</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineplus">+        if (target) {</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineplus">+          box = target.closest(&quot;toolbox&quot;);</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineplus">+        } else {</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineplus">+          // These vanish from the document but still exist via the palette property</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineplus">+          let boxes = [...this.document.getElementsByTagName(&quot;toolbox&quot;)];</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineplus">+          box = boxes.find(box =&gt; box.palette &amp;&amp; box.palette.id == node.id);</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineplus">+          let palette = box ? box.palette : null;</span>
<a href="#l2.174"></a><span id="l2.174"> </span>
<a href="#l2.175"></a><span id="l2.175" class="difflineminus">-      if (!palette) {</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineminus">-        oconsole.debug(`The palette for ${node.id} could not be found, deferring to later`);</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineminus">-        return false;</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineminus">-      }</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineplus">+          if (!palette) {</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineplus">+            oconsole.debug(`The palette for ${node.id} could not be found, deferring to later`);</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineplus">+            return false;</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineplus">+          }</span>
<a href="#l2.183"></a><span id="l2.183"> </span>
<a href="#l2.184"></a><span id="l2.184" class="difflineminus">-      this._mergeElement(palette, node);</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineminus">-      this._toolbarsToResolve.push(...box.getElementsByTagName(&quot;toolbar&quot;));</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineminus">-    } else if (node.id) {</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineminus">-      let target = this.document.getElementById(node.id);</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineminus">-      if (!target) {</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineplus">+          target = palette;</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineplus">+        }</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineplus">+</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineplus">+        this._toolbarsToResolve.push(...box.querySelectorAll(&quot;toolbar:not([type=\&quot;menubar\&quot;])&quot;));</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineplus">+      } else if (!target) {</span>
<a href="#l2.194"></a><span id="l2.194">         oconsole.debug(`The node ${node.id} could not be found, deferring to later`);</span>
<a href="#l2.195"></a><span id="l2.195">         return false;</span>
<a href="#l2.196"></a><span id="l2.196">       }</span>
<a href="#l2.197"></a><span id="l2.197"> </span>
<a href="#l2.198"></a><span id="l2.198">       this._mergeElement(target, node);</span>
<a href="#l2.199"></a><span id="l2.199">     } else {</span>
<a href="#l2.200"></a><span id="l2.200">        this._insertElement(this.document.documentElement, node);</span>
<a href="#l2.201"></a><span id="l2.201">     }</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineat">@@ -422,52 +446,55 @@ class Overlays {</span>
<a href="#l2.203"></a><span id="l2.203">    * @return {Object[]}                             An object with listener and useCapture,</span>
<a href="#l2.204"></a><span id="l2.204">    *                                                  describing load handlers the script creates</span>
<a href="#l2.205"></a><span id="l2.205">    *                                                  when first run.</span>
<a href="#l2.206"></a><span id="l2.206">    */</span>
<a href="#l2.207"></a><span id="l2.207">   loadScript(node) {</span>
<a href="#l2.208"></a><span id="l2.208">     let deferredLoad = [];</span>
<a href="#l2.209"></a><span id="l2.209"> </span>
<a href="#l2.210"></a><span id="l2.210">     let oldAddEventListener = this.window.addEventListener;</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineminus">-    this.window.addEventListener = function(type, listener, useCapture, ...args) {</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineminus">-      if (type == &quot;load&quot;) {</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineminus">-        if (typeof useCapture == &quot;object&quot;) {</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineminus">-          useCapture = useCapture.capture;</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineminus">-        }</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineplus">+    if (this.document.readyState == &quot;complete&quot;) {</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineplus">+      this.window.addEventListener = function(type, listener, useCapture, ...args) {</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineplus">+        if (type == &quot;load&quot;) {</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineplus">+          if (typeof useCapture == &quot;object&quot;) {</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineplus">+            useCapture = useCapture.capture;</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineplus">+          }</span>
<a href="#l2.222"></a><span id="l2.222"> </span>
<a href="#l2.223"></a><span id="l2.223" class="difflineminus">-        if (typeof useCapture == &quot;undefined&quot;) {</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineminus">-          useCapture = true;</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineplus">+          if (typeof useCapture == &quot;undefined&quot;) {</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineplus">+            useCapture = true;</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineplus">+          }</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineplus">+          deferredLoad.push({ listener, useCapture });</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineplus">+          return null;</span>
<a href="#l2.230"></a><span id="l2.230">         }</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineminus">-        deferredLoad.push({ listener, useCapture });</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineminus">-        return null;</span>
<a href="#l2.233"></a><span id="l2.233" class="difflineminus">-      }</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineminus">-      return oldAddEventListener.call(this, type, listener, useCapture, ...args);</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineminus">-    };</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineplus">+        return oldAddEventListener.call(this, type, listener, useCapture, ...args);</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineplus">+      };</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineplus">+    }</span>
<a href="#l2.239"></a><span id="l2.239"> </span>
<a href="#l2.240"></a><span id="l2.240">     if (node.hasAttribute(&quot;src&quot;)) {</span>
<a href="#l2.241"></a><span id="l2.241">       let url = node.getAttribute(&quot;src&quot;);</span>
<a href="#l2.242"></a><span id="l2.242">       oconsole.debug(`Loading script ${url} into ${this.window.location}`);</span>
<a href="#l2.243"></a><span id="l2.243">       try {</span>
<a href="#l2.244"></a><span id="l2.244">         Services.scriptloader.loadSubScript(url, this.window);</span>
<a href="#l2.245"></a><span id="l2.245">       } catch (ex) {</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineminus">-        oconsole.error(`Error loading script ${url} into ${this.window.location}`, ex.message);</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineplus">+        Cu.reportError(ex);</span>
<a href="#l2.248"></a><span id="l2.248">       }</span>
<a href="#l2.249"></a><span id="l2.249">     } else if (node.textContent) {</span>
<a href="#l2.250"></a><span id="l2.250">       oconsole.debug(`Loading eval'd script into ${this.window.location}`);</span>
<a href="#l2.251"></a><span id="l2.251">       try {</span>
<a href="#l2.252"></a><span id="l2.252">         // It would be great if we could have script errors show the right url, but for now</span>
<a href="#l2.253"></a><span id="l2.253">         // window.eval will have to do.</span>
<a href="#l2.254"></a><span id="l2.254">         this.window.eval(node.textContent);</span>
<a href="#l2.255"></a><span id="l2.255">       } catch (ex) {</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineminus">-        oconsole.error(`Error loading eval script from ${node.baseURI} into ` +</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineminus">-                       this.window.location, ex.message);</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineplus">+        Cu.reportError(ex);</span>
<a href="#l2.259"></a><span id="l2.259">       }</span>
<a href="#l2.260"></a><span id="l2.260">     }</span>
<a href="#l2.261"></a><span id="l2.261"> </span>
<a href="#l2.262"></a><span id="l2.262" class="difflineminus">-    this.window.addEventListener = oldAddEventListener;</span>
<a href="#l2.263"></a><span id="l2.263" class="difflineplus">+    if (this.document.readyState == &quot;complete&quot;) {</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineplus">+      this.window.addEventListener = oldAddEventListener;</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineplus">+    }</span>
<a href="#l2.266"></a><span id="l2.266"> </span>
<a href="#l2.267"></a><span id="l2.267">     // This works because we only care about immediately executed addEventListener calls and</span>
<a href="#l2.268"></a><span id="l2.268">     // loadSubScript is synchronous. Everyone else should be checking readyState anyway.</span>
<a href="#l2.269"></a><span id="l2.269">     return deferredLoad;</span>
<a href="#l2.270"></a><span id="l2.270">   }</span>
<a href="#l2.271"></a><span id="l2.271"> </span>
<a href="#l2.272"></a><span id="l2.272">   /**</span>
<a href="#l2.273"></a><span id="l2.273">    * Load the CSS stylesheet from the given url</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/content/extensions.xml</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/content/extensions.xml</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -31,20 +31,17 @@</span>
<a href="#l3.4"></a><span id="l3.4">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l3.5"></a><span id="l3.5">       &lt;/property&gt;</span>
<a href="#l3.6"></a><span id="l3.6">       &lt;method name=&quot;_updateState&quot;&gt;</span>
<a href="#l3.7"></a><span id="l3.7">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l3.8"></a><span id="l3.8">           this.__proto__.__proto__._updateState.call(this);</span>
<a href="#l3.9"></a><span id="l3.9">           let id = this.mAddon.id;</span>
<a href="#l3.10"></a><span id="l3.10">           let webex = this.webextension;</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-          if (webex &amp;&amp; webex.manifest.legacy &amp;&amp; (</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-                (webex.startupReason != &quot;APP_STARTUP&quot; &amp;&amp; !webex.legacyLoaded) ||</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-                (this.mAddon.userDisabled &amp;&amp; webex.legacyLoaded)</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-              )) {</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+          if (webex &amp;&amp; webex.manifest.legacy &amp;&amp; this.mAddon.userDisabled &amp;&amp; webex.legacyLoaded) {</span>
<a href="#l3.17"></a><span id="l3.17">             this.setAttribute(&quot;notification&quot;, &quot;warning&quot;);</span>
<a href="#l3.18"></a><span id="l3.18">             this._warning.textContent = this._bundle.GetStringFromName(&quot;warnLegacyRestart&quot;);</span>
<a href="#l3.19"></a><span id="l3.19">             this._warningBtn.label = this._bundle.GetStringFromName(&quot;warnLegacyRestartButton&quot;);</span>
<a href="#l3.20"></a><span id="l3.20">             this._warningBtn.setAttribute(&quot;oncommand&quot;, &quot;BrowserUtils.restartApplication()&quot;);</span>
<a href="#l3.21"></a><span id="l3.21">             this._warningBtn.hidden = false;</span>
<a href="#l3.22"></a><span id="l3.22">             this._warningLink.hidden = true;</span>
<a href="#l3.23"></a><span id="l3.23">           }</span>
<a href="#l3.24"></a><span id="l3.24">         ]]&gt;&lt;/body&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/components/extensions/parent/ext-legacy.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/components/extensions/parent/ext-legacy.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -15,23 +15,16 @@ var loadedOnce = new Set();</span>
<a href="#l4.4"></a><span id="l4.4"> this.legacy = class extends ExtensionAPI {</span>
<a href="#l4.5"></a><span id="l4.5">   async onManifestEntry(entryName) {</span>
<a href="#l4.6"></a><span id="l4.6">     if (this.extension.manifest.legacy) {</span>
<a href="#l4.7"></a><span id="l4.7">       await this.register();</span>
<a href="#l4.8"></a><span id="l4.8">     }</span>
<a href="#l4.9"></a><span id="l4.9">   }</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11">   async register() {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    let enumerator = Services.wm.getEnumerator(&quot;mail:3pane&quot;);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-    if (enumerator.hasMoreElements() &amp;&amp; enumerator.getNext().document.readyState == &quot;complete&quot;) {</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-      // It's too late!</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-      console.log(`Legacy WebExtension ${this.extension.id} loading after app startup, refusing to load immediately.`);</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-      return;</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-    }</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-</span>
<a href="#l4.19"></a><span id="l4.19">     this.extension.legacyLoaded = true;</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21">     if (loadedOnce.has(this.extension.id)) {</span>
<a href="#l4.22"></a><span id="l4.22">       console.log(`Legacy WebExtension ${this.extension.id} has already been loaded in this run, refusing to do so again. Please restart`);</span>
<a href="#l4.23"></a><span id="l4.23">       return;</span>
<a href="#l4.24"></a><span id="l4.24">     }</span>
<a href="#l4.25"></a><span id="l4.25">     loadedOnce.add(this.extension.id);</span>
<a href="#l4.26"></a><span id="l4.26"> </span>
<a href="#l4.27"></a><span id="l4.27" class="difflineat">@@ -89,24 +82,55 @@ this.legacy = class extends ExtensionAPI</span>
<a href="#l4.28"></a><span id="l4.28">         }</span>
<a href="#l4.29"></a><span id="l4.29"> </span>
<a href="#l4.30"></a><span id="l4.30">         instance.observe(null, &quot;profile-after-change&quot;, null);</span>
<a href="#l4.31"></a><span id="l4.31">       } catch (e) {</span>
<a href="#l4.32"></a><span id="l4.32">         console.error(&quot;Error firing profile-after-change listener for&quot;, contractid);</span>
<a href="#l4.33"></a><span id="l4.33">       }</span>
<a href="#l4.34"></a><span id="l4.34">     }</span>
<a href="#l4.35"></a><span id="l4.35"> </span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+    // Add overlays to all existing windows.</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+    let enumerator = Services.wm.getEnumerator(&quot;mail:3pane&quot;);</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+    if (enumerator.hasMoreElements() &amp;&amp; enumerator.getNext().document.readyState == &quot;complete&quot;) {</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+      getAllWindows().forEach(w =&gt; Overlays.load(chromeManifest, w));</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+    }</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+    // Listen for new windows to overlay.</span>
<a href="#l4.43"></a><span id="l4.43">     let documentObserver = {</span>
<a href="#l4.44"></a><span id="l4.44">       observe(document) {</span>
<a href="#l4.45"></a><span id="l4.45">         if (ExtensionCommon.instanceOf(document, &quot;XULDocument&quot;)) {</span>
<a href="#l4.46"></a><span id="l4.46">           Overlays.load(chromeManifest, document.defaultView);</span>
<a href="#l4.47"></a><span id="l4.47">         }</span>
<a href="#l4.48"></a><span id="l4.48">       },</span>
<a href="#l4.49"></a><span id="l4.49">     };</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-    Services.obs.addObserver(documentObserver, &quot;chrome-document-loaded&quot;);</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+    Services.obs.addObserver(documentObserver, &quot;chrome-document-interactive&quot;);</span>
<a href="#l4.52"></a><span id="l4.52"> </span>
<a href="#l4.53"></a><span id="l4.53">     this.extension.callOnClose({</span>
<a href="#l4.54"></a><span id="l4.54">       close: () =&gt; {</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-        Services.obs.removeObserver(documentObserver, &quot;chrome-document-loaded&quot;);</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+        Services.obs.removeObserver(documentObserver, &quot;chrome-document-interactive&quot;);</span>
<a href="#l4.57"></a><span id="l4.57">       },</span>
<a href="#l4.58"></a><span id="l4.58">     });</span>
<a href="#l4.59"></a><span id="l4.59">   }</span>
<a href="#l4.60"></a><span id="l4.60"> };</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+function getAllWindows() {</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+  function getChildDocShells(parentDocShell) {</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+    let docShellEnum = parentDocShell.getDocShellEnumerator(</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+      Ci.nsIDocShellTreeItem.typeAll,</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+      Ci.nsIDocShell.ENUMERATE_FORWARDS</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+    );</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+    for (let docShell of docShellEnum) {</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+      docShell.QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+              .getInterface(Ci.nsIWebProgress);</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+      domWindows.push(docShell.domWindow);</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+    }</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+  }</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+  let domWindows = [];</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+  for (let win of Services.ww.getWindowEnumerator()) {</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+    let parentDocShell = win.QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+                            .getInterface(Ci.nsIWebNavigation)</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+                            .QueryInterface(Ci.nsIDocShell);</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+    getChildDocShells(parentDocShell);</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+  }</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+  return domWindows;</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+}</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

