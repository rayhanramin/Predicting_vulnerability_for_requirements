<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 2775:e14d90899db9603776590e173f3e8568e65516e6</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ e14d90899db9603776590e173f3e8568e65516e6" />
<meta property="og:url" content="/comm-central/rev/e14d90899db9603776590e173f3e8568e65516e6" />
<meta property="og:description" content="Bug 137489: hierarchyDelimiter should consistently be a char. r+sr=bienvenu" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / e14d90899db9603776590e173f3e8568e65516e6 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/e14d90899db9603776590e173f3e8568e65516e6">shortlog</a> |
<a href="/comm-central/log/e14d90899db9603776590e173f3e8568e65516e6">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/e14d90899db9603776590e173f3e8568e65516e6">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/e14d90899db9603776590e173f3e8568e65516e6">files</a> |
changeset |
<a href="/comm-central/raw-rev/e14d90899db9603776590e173f3e8568e65516e6">raw</a>  | <a href="/comm-central/archive/e14d90899db9603776590e173f3e8568e65516e6.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=137489">Bug 137489</a>: hierarchyDelimiter should consistently be a char. r+sr=bienvenu
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#97;&#103;&#110;&#117;&#115;&#32;&#77;&#101;&#108;&#105;&#110;&#32;&#60;&#109;&#107;&#109;&#101;&#108;&#105;&#110;&#64;&#105;&#107;&#105;&#46;&#102;&#105;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 04 Jun 2009 22:41:59 +0300</td></tr>

<tr>
 <td>changeset 2775</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/e14d90899db9603776590e173f3e8568e65516e6">e14d90899db9603776590e173f3e8568e65516e6</a></td>
</tr>



<tr>
<td>parent 2774</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/6342c75a84a48bbcdfb6e22dfd1721a67f6a64ce">6342c75a84a48bbcdfb6e22dfd1721a67f6a64ce</a>
</td>
</tr>

<tr>
<td>child 2776</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/7f60d259141f4acad2514fe2349b58bb9139081e">7f60d259141f4acad2514fe2349b58bb9139081e</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=e14d90899db9603776590e173f3e8568e65516e6">2248</a></td></tr>
<tr><td>push user</td><td>mkmelin@iki.fi</td></tr>
<tr><td>push date</td><td class="date age">Thu, 04 Jun 2009 19:42:18 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@e14d90899db9 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e14d90899db9603776590e173f3e8568e65516e6">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e14d90899db9603776590e173f3e8568e65516e6&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e14d90899db9603776590e173f3e8568e65516e6&newProject=comm-central&newRevision=e14d90899db9603776590e173f3e8568e65516e6&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e14d90899db9603776590e173f3e8568e65516e6&newProject=comm-central&newRevision=e14d90899db9603776590e173f3e8568e65516e6&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e14d90899db9603776590e173f3e8568e65516e6&newProject=comm-central&newRevision=e14d90899db9603776590e173f3e8568e65516e6&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=137489">137489</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=137489">Bug 137489</a>: hierarchyDelimiter should consistently be a char. r+sr=bienvenu</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e14d90899db9603776590e173f3e8568e65516e6/mailnews/db/msgdb/public/nsDBFolderInfo.h">mailnews/db/msgdb/public/nsDBFolderInfo.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e14d90899db9603776590e173f3e8568e65516e6/mailnews/db/msgdb/public/nsDBFolderInfo.h">file</a> |
<a href="/comm-central/annotate/e14d90899db9603776590e173f3e8568e65516e6/mailnews/db/msgdb/public/nsDBFolderInfo.h">annotate</a> |
<a href="/comm-central/diff/e14d90899db9603776590e173f3e8568e65516e6/mailnews/db/msgdb/public/nsDBFolderInfo.h">diff</a> |
<a href="/comm-central/comparison/e14d90899db9603776590e173f3e8568e65516e6/mailnews/db/msgdb/public/nsDBFolderInfo.h">comparison</a> |
<a href="/comm-central/log/e14d90899db9603776590e173f3e8568e65516e6/mailnews/db/msgdb/public/nsDBFolderInfo.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/public/nsIImapServerSink.idl">mailnews/imap/public/nsIImapServerSink.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/public/nsIImapServerSink.idl">file</a> |
<a href="/comm-central/annotate/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/public/nsIImapServerSink.idl">annotate</a> |
<a href="/comm-central/diff/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/public/nsIImapServerSink.idl">diff</a> |
<a href="/comm-central/comparison/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/public/nsIImapServerSink.idl">comparison</a> |
<a href="/comm-central/log/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/public/nsIImapServerSink.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/public/nsIMailboxSpec.idl">mailnews/imap/public/nsIMailboxSpec.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/public/nsIMailboxSpec.idl">file</a> |
<a href="/comm-central/annotate/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/public/nsIMailboxSpec.idl">annotate</a> |
<a href="/comm-central/diff/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/public/nsIMailboxSpec.idl">diff</a> |
<a href="/comm-central/comparison/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/public/nsIMailboxSpec.idl">comparison</a> |
<a href="/comm-central/log/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/public/nsIMailboxSpec.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/public/nsIMsgImapMailFolder.idl">mailnews/imap/public/nsIMsgImapMailFolder.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/public/nsIMsgImapMailFolder.idl">file</a> |
<a href="/comm-central/annotate/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/public/nsIMsgImapMailFolder.idl">annotate</a> |
<a href="/comm-central/diff/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/public/nsIMsgImapMailFolder.idl">diff</a> |
<a href="/comm-central/comparison/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/public/nsIMsgImapMailFolder.idl">comparison</a> |
<a href="/comm-central/log/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/public/nsIMsgImapMailFolder.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapCore.h">mailnews/imap/src/nsImapCore.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapCore.h">file</a> |
<a href="/comm-central/annotate/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapCore.h">annotate</a> |
<a href="/comm-central/diff/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapCore.h">diff</a> |
<a href="/comm-central/comparison/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapCore.h">comparison</a> |
<a href="/comm-central/log/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapCore.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapIncomingServer.cpp">mailnews/imap/src/nsImapIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapMailFolder.h">mailnews/imap/src/nsImapMailFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapMailFolder.h">file</a> |
<a href="/comm-central/annotate/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapMailFolder.h">annotate</a> |
<a href="/comm-central/diff/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapMailFolder.h">diff</a> |
<a href="/comm-central/comparison/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapMailFolder.h">comparison</a> |
<a href="/comm-central/log/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapMailFolder.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapProtocol.cpp">mailnews/imap/src/nsImapProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapProtocol.cpp">file</a> |
<a href="/comm-central/annotate/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapProtocol.cpp">comparison</a> |
<a href="/comm-central/log/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapService.cpp">mailnews/imap/src/nsImapService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapService.cpp">file</a> |
<a href="/comm-central/annotate/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapService.cpp">annotate</a> |
<a href="/comm-central/diff/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapService.cpp">diff</a> |
<a href="/comm-central/comparison/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapService.cpp">comparison</a> |
<a href="/comm-central/log/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapService.h">mailnews/imap/src/nsImapService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapService.h">file</a> |
<a href="/comm-central/annotate/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapService.h">annotate</a> |
<a href="/comm-central/diff/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapService.h">diff</a> |
<a href="/comm-central/comparison/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapService.h">comparison</a> |
<a href="/comm-central/log/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapService.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapUtils.cpp">mailnews/imap/src/nsImapUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapUtils.cpp">file</a> |
<a href="/comm-central/annotate/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapUtils.cpp">annotate</a> |
<a href="/comm-central/diff/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapUtils.cpp">diff</a> |
<a href="/comm-central/comparison/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapUtils.cpp">comparison</a> |
<a href="/comm-central/log/e14d90899db9603776590e173f3e8568e65516e6/mailnews/imap/src/nsImapUtils.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsDBFolderInfo.h</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsDBFolderInfo.h</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -69,17 +69,17 @@ public:</span>
<a href="#l1.4"></a><span id="l1.4">     // interface methods.</span>
<a href="#l1.5"></a><span id="l1.5">     NS_DECL_NSIDBFOLDERINFO</span>
<a href="#l1.6"></a><span id="l1.6">     // create the appropriate table and row in a new db.</span>
<a href="#l1.7"></a><span id="l1.7">     nsresult			AddToNewMDB();</span>
<a href="#l1.8"></a><span id="l1.8">   // accessor methods.</span>
<a href="#l1.9"></a><span id="l1.9">   </span>
<a href="#l1.10"></a><span id="l1.10">   PRBool    TestFlag(PRInt32 flags);</span>
<a href="#l1.11"></a><span id="l1.11">   PRInt16   GetIMAPHierarchySeparator() ;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  void      SetIMAPHierarchySeparator(PRInt16 hierarchySeparator) ;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+  void      SetIMAPHierarchySeparator(PRInt16 hierarchyDelimiter) ;</span>
<a href="#l1.14"></a><span id="l1.14">   void      ChangeImapTotalPendingMessages(PRInt32 delta);</span>
<a href="#l1.15"></a><span id="l1.15">   void      ChangeImapUnreadPendingMessages(PRInt32 delta) ;</span>
<a href="#l1.16"></a><span id="l1.16">   </span>
<a href="#l1.17"></a><span id="l1.17">   nsresult      InitFromExistingDB();</span>
<a href="#l1.18"></a><span id="l1.18">   // get and set arbitrary property, aka row cell value.</span>
<a href="#l1.19"></a><span id="l1.19">   nsresult	SetPropertyWithToken(mdb_token aProperty, const nsAString &amp;propertyStr);</span>
<a href="#l1.20"></a><span id="l1.20">   nsresult	SetUint32PropertyWithToken(mdb_token aProperty, PRUint32 propertyValue);</span>
<a href="#l1.21"></a><span id="l1.21">   nsresult	SetInt32PropertyWithToken(mdb_token aProperty, PRInt32 propertyValue);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/imap/public/nsIImapServerSink.idl</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/imap/public/nsIImapServerSink.idl</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -39,62 +39,70 @@</span>
<a href="#l2.4"></a><span id="l2.4"> #include &quot;MailNewsTypes2.idl&quot;</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6"> interface nsIMsgWindow;</span>
<a href="#l2.7"></a><span id="l2.7"> interface nsIMsgMailNewsUrl;</span>
<a href="#l2.8"></a><span id="l2.8"> interface nsIImapProtocol;</span>
<a href="#l2.9"></a><span id="l2.9"> interface nsIImapUrl;</span>
<a href="#l2.10"></a><span id="l2.10"> interface nsIImapMockChannel;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-[scriptable, uuid(3ec99d5f-1355-4eb7-ad70-5bcadc4b8b33)]</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+[scriptable, uuid(a5f8db71-35a5-4143-b59b-abd067138912)]</span>
<a href="#l2.14"></a><span id="l2.14"> interface nsIImapServerSink : nsISupports {</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-  /* returns true if it's a new mailbox */</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-  boolean possibleImapMailbox(in ACString folderPath, in wchar hierarchyDelim, in long boxFlags);</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+  /**</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+   * Check if the given folder path is a possible IMAP mailbox.</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+   * @param folderPath folder path to check</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+   * @param hierarchyDelimiter IMAP hierarchy delimiter in canonical format,</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+   *                           i.e., hierarchy delimiter has been replaced</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+   *                           with '/'</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+   * @param boxFlags IMAP folder flags (for subscription, namespaces etc.)</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+   * @return true if it's a new mailbox</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+   */</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+  boolean possibleImapMailbox(in ACString folderPath,</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+                              in char hierarchyDelimiter, in long boxFlags);</span>
<a href="#l2.28"></a><span id="l2.28">   boolean folderNeedsACLInitialized(in ACString folderPath);</span>
<a href="#l2.29"></a><span id="l2.29">   void addFolderRights(in ACString folderPath, in ACString userName, in ACString rights);</span>
<a href="#l2.30"></a><span id="l2.30">   void refreshFolderRights(in ACString folderPath);</span>
<a href="#l2.31"></a><span id="l2.31">   void discoveryDone();</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-  void onlineFolderDelete(in ACString aFolderName);</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+  void onlineFolderDelete(in ACString folderName);</span>
<a href="#l2.34"></a><span id="l2.34">   void onlineFolderCreateFailed(in ACString aFolderName);</span>
<a href="#l2.35"></a><span id="l2.35">   void onlineFolderRename(in nsIMsgWindow msgWindow, in ACString oldName, in ACString newName);</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-  boolean folderIsNoSelect(in ACString aFolderName);</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-  void setFolderAdminURL(in ACString aFolderName, in ACString adminUrl);</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-  boolean folderVerifiedOnline(in ACString aFolderName);</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+  boolean folderIsNoSelect(in ACString folderName);</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+  void setFolderAdminURL(in ACString folderName, in ACString adminUrl);</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+  boolean folderVerifiedOnline(in ACString folderName);</span>
<a href="#l2.42"></a><span id="l2.42"> </span>
<a href="#l2.43"></a><span id="l2.43">   void setCapability(in unsigned long capability);</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-  boolean loadNextQueuedUrl(in nsIImapProtocol aProtocol);</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+  boolean loadNextQueuedUrl(in nsIImapProtocol protocol);</span>
<a href="#l2.46"></a><span id="l2.46"> </span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-  /*</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-   * Prepare to retry the current url</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-   *</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-   * @param  aImapUrl - url we're going to retry</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-   *</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-   * @returns - channel to associate with the url. We return this</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-   *            because access to the channel should only happen on</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-   *            the ui thread.</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+  /**</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+   * Prepare to retry the given URL.</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+   * @param imapUrl the url we're going to retry</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+   * @return channel to associate with the url. We return this because access</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+   *         to the channel should only happen on the ui thread.</span>
<a href="#l2.60"></a><span id="l2.60">    */</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineminus">-  nsIImapMockChannel prepareToRetryUrl(in nsIImapUrl aImapUrl);</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+  nsIImapMockChannel prepareToRetryUrl(in nsIImapUrl imapUrl);</span>
<a href="#l2.63"></a><span id="l2.63"> </span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-  /*</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-   * Retry the current url</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-   * </span>
<a href="#l2.67"></a><span id="l2.67" class="difflineminus">-   * @param  aImapUrl - url to retry</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-   * @param  aChannel - channel to associate with the url </span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+  /**</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+   * Retry the given URL.</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+   * @param imapUrl url to retry</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+   * @param channel the channel to associate with the url</span>
<a href="#l2.73"></a><span id="l2.73">    */</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-  void retryUrl(in nsIImapUrl aImapUrl, in nsIImapMockChannel aChannel);</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineminus">-  // if previous url failed, this gives server chance to abort urls with same mock channel</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-  void abortQueuedUrls(); </span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-  AString getImapStringByID(in long aMsgId);</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-  AString formatStringWithHostNameByID(in long aMsgId);</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineminus">-  void fEAlert(in AString aString, in nsIMsgMailNewsUrl aUrl);</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineminus">-  void fEAlertFromServer(in ACString aString, in nsIMsgMailNewsUrl aUrl);</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+  void retryUrl(in nsIImapUrl imapUrl, in nsIImapMockChannel channel);</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+  /**</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+   * If previous URL failed, this gives server chance to abort URLs with same</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+   * mock channel.</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+   */</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+  void abortQueuedUrls();</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineplus">+  AString getImapStringByID(in long msgId);</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+  AString formatStringWithHostNameByID(in long msgId);</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+  void fEAlert(in AString alertSring, in nsIMsgMailNewsUrl url);</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+  void fEAlertFromServer(in ACString alertSring, in nsIMsgMailNewsUrl url);</span>
<a href="#l2.92"></a><span id="l2.92">   void commitNamespaces();</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineminus">-  void promptForPassword(out ACString aString, in nsIMsgWindow aMsgWindow);</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+  void promptForPassword(out ACString promptString, in nsIMsgWindow msgWindow);</span>
<a href="#l2.95"></a><span id="l2.95">   attribute boolean userAuthenticated;</span>
<a href="#l2.96"></a><span id="l2.96">   void setMailServerUrls(in ACString manageMailAccount, in ACString manageLists, in ACString manageFilters);</span>
<a href="#l2.97"></a><span id="l2.97"> </span>
<a href="#l2.98"></a><span id="l2.98">   readonly attribute ACString arbitraryHeaders;</span>
<a href="#l2.99"></a><span id="l2.99">   void forgetPassword();</span>
<a href="#l2.100"></a><span id="l2.100"> </span>
<a href="#l2.101"></a><span id="l2.101">   readonly attribute boolean showAttachmentsInline;</span>
<a href="#l2.102"></a><span id="l2.102">   string cramMD5Hash(in string decodedChallenge, in string key);</span>
<a href="#l2.103"></a><span id="l2.103"> };</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/imap/public/nsIMailboxSpec.idl</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/imap/public/nsIMailboxSpec.idl</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -35,17 +35,17 @@</span>
<a href="#l3.4"></a><span id="l3.4">  *</span>
<a href="#l3.5"></a><span id="l3.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l3.8"></a><span id="l3.8"> #include &quot;nsIImapFlagAndUidState.idl&quot;</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> interface nsIMAPNamespace;</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-[scriptable, uuid(29a2ffbd-9dad-41f5-8df7-51feca9bfbfc)]</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+[scriptable, uuid(a9fbbc80-5291-4ed8-a7f7-c2fcad231269)]</span>
<a href="#l3.14"></a><span id="l3.14"> interface nsIMailboxSpec : nsISupports</span>
<a href="#l3.15"></a><span id="l3.15"> {</span>
<a href="#l3.16"></a><span id="l3.16">   attribute long folder_UIDVALIDITY;</span>
<a href="#l3.17"></a><span id="l3.17">   /**</span>
<a href="#l3.18"></a><span id="l3.18">    * The highest modification sequence number the parser has seen </span>
<a href="#l3.19"></a><span id="l3.19">    * for this mailbox. See IMAP RFC 4551</span>
<a href="#l3.20"></a><span id="l3.20">    **/</span>
<a href="#l3.21"></a><span id="l3.21">   attribute unsigned long long highestModSeq;</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -56,17 +56,17 @@ interface nsIMailboxSpec : nsISupports</span>
<a href="#l3.23"></a><span id="l3.23">   /// If server supports UIDNEXT, we store the result here.</span>
<a href="#l3.24"></a><span id="l3.24">   attribute long nextUID;</span>
<a href="#l3.25"></a><span id="l3.25"> </span>
<a href="#l3.26"></a><span id="l3.26">   attribute unsigned long box_flags;</span>
<a href="#l3.27"></a><span id="l3.27">   attribute unsigned long supportedUserFlags;</span>
<a href="#l3.28"></a><span id="l3.28"> </span>
<a href="#l3.29"></a><span id="l3.29">   attribute ACString allocatedPathName;</span>
<a href="#l3.30"></a><span id="l3.30">   attribute AString unicharPathName;</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-  attribute char hierarchySeparator;</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+  attribute char hierarchyDelimiter;</span>
<a href="#l3.33"></a><span id="l3.33">   attribute ACString hostName;</span>
<a href="#l3.34"></a><span id="l3.34"> </span>
<a href="#l3.35"></a><span id="l3.35">   attribute nsIImapFlagAndUidState flagState;</span>
<a href="#l3.36"></a><span id="l3.36"> </span>
<a href="#l3.37"></a><span id="l3.37">   attribute boolean folderSelected;</span>
<a href="#l3.38"></a><span id="l3.38">   attribute boolean discoveredFromLsub;</span>
<a href="#l3.39"></a><span id="l3.39"> </span>
<a href="#l3.40"></a><span id="l3.40">   attribute boolean onlineVerified;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/imap/public/nsIMsgImapMailFolder.idl</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/imap/public/nsIMsgImapMailFolder.idl</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -39,52 +39,55 @@</span>
<a href="#l4.4"></a><span id="l4.4"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l4.5"></a><span id="l4.5"> #include &quot;nsIMsgFolder.idl&quot;</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7"> interface nsIMsgWindow;</span>
<a href="#l4.8"></a><span id="l4.8"> interface nsIImapIncomingServer;</span>
<a href="#l4.9"></a><span id="l4.9"> interface nsIMsgParseMailMsgState;</span>
<a href="#l4.10"></a><span id="l4.10"> interface nsIAutoSyncState;</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-// this is a simple interface which allows the imap folder to update some values</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-// that the folder props js code will use to update the sharing and quota tabs in the folder props.</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-                 </span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+/**</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+ * This is a simple interface which allows the IMAP folder to update some</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+ * values that the folder props js code will use to update the sharing and</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+ * quota tabs in the folder properties.</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+ */</span>
<a href="#l4.20"></a><span id="l4.20"> [scriptable, uuid(09D99F2C-3E23-4f8c-A536-5C277BAA9585)] </span>
<a href="#l4.21"></a><span id="l4.21"> interface nsIMsgImapFolderProps : nsISupports {</span>
<a href="#l4.22"></a><span id="l4.22"> </span>
<a href="#l4.23"></a><span id="l4.23">     void setFolderType(in AString folderType);</span>
<a href="#l4.24"></a><span id="l4.24">     void setFolderTypeDescription(in AString folderTypeDescription);</span>
<a href="#l4.25"></a><span id="l4.25">     void setFolderPermissions(in AString permissions);</span>
<a href="#l4.26"></a><span id="l4.26">     void serverDoesntSupportACL();</span>
<a href="#l4.27"></a><span id="l4.27"> </span>
<a href="#l4.28"></a><span id="l4.28">     /**</span>
<a href="#l4.29"></a><span id="l4.29">      * Toggles the display of quota information in the Quota tab of the folder properties.</span>
<a href="#l4.30"></a><span id="l4.30">      * If on, the quota root, usage, and percentage used are displayed.</span>
<a href="#l4.31"></a><span id="l4.31">      * If off, a status message is displayed. The status message can be set with setQuotaStatus().</span>
<a href="#l4.32"></a><span id="l4.32">      * @param showData If true, display the quota root, usage information and usage percentage bar.</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-     * If false, display the status message.</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+     *                 If false, display the status message.</span>
<a href="#l4.35"></a><span id="l4.35">      */</span>
<a href="#l4.36"></a><span id="l4.36">     void showQuotaData(in boolean showData);</span>
<a href="#l4.37"></a><span id="l4.37"> </span>
<a href="#l4.38"></a><span id="l4.38">     /**</span>
<a href="#l4.39"></a><span id="l4.39">      * Sets the status string displayed in the Quota tab of the folder properties if quota</span>
<a href="#l4.40"></a><span id="l4.40">      * information is not visible.</span>
<a href="#l4.41"></a><span id="l4.41">      */</span>
<a href="#l4.42"></a><span id="l4.42">     void setQuotaStatus(in AString folderQuotaStatus);</span>
<a href="#l4.43"></a><span id="l4.43"> </span>
<a href="#l4.44"></a><span id="l4.44">     /**</span>
<a href="#l4.45"></a><span id="l4.45">      * Updates the quota data displayed in the Quota tab.</span>
<a href="#l4.46"></a><span id="l4.46">      */</span>
<a href="#l4.47"></a><span id="l4.47">     void setQuotaData(in ACString quotaroot, in unsigned long usedKB, in unsigned long maxKB);</span>
<a href="#l4.48"></a><span id="l4.48"> };</span>
<a href="#l4.49"></a><span id="l4.49"> </span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-[scriptable, uuid(a18390ec-f21a-40e0-8d77-a55dc0591698)]</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+[scriptable, uuid(dbee3096-941c-4fd6-91f7-2cc80527b857)]</span>
<a href="#l4.52"></a><span id="l4.52"> interface nsIMsgImapMailFolder : nsISupports {</span>
<a href="#l4.53"></a><span id="l4.53">   void removeSubFolder(in nsIMsgFolder folder);</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineminus">-  void createClientSubfolderInfo(in ACString folderName, in wchar hierarchyDelimiter, in long flags, in boolean suppressNotification);</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+  void createClientSubfolderInfo(in ACString folderName, in char hierarchyDelimiter,</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+                                 in long flags, in boolean suppressNotification);</span>
<a href="#l4.57"></a><span id="l4.57">   void list();</span>
<a href="#l4.58"></a><span id="l4.58">   void renameLocal(in ACString newname, in nsIMsgFolder parent);</span>
<a href="#l4.59"></a><span id="l4.59">   void prepareToRename();</span>
<a href="#l4.60"></a><span id="l4.60">   void performExpand(in nsIMsgWindow aMsgWindow);</span>
<a href="#l4.61"></a><span id="l4.61">   void recursiveCloseActiveConnections(in nsIImapIncomingServer aImapServer);</span>
<a href="#l4.62"></a><span id="l4.62">   void renameClient(in nsIMsgWindow msgWindow, in nsIMsgFolder msgFolder, in ACString oldName, in ACString newName);</span>
<a href="#l4.63"></a><span id="l4.63"> </span>
<a href="#l4.64"></a><span id="l4.64">   // these are used for offline synchronization</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineat">@@ -110,22 +113,22 @@ interface nsIMsgImapMailFolder : nsISupp</span>
<a href="#l4.66"></a><span id="l4.66">   nsIURI fetchCustomMsgAttribute(in ACString msgAttribute, in string uids, in nsIMsgWindow aWindow);</span>
<a href="#l4.67"></a><span id="l4.67">   nsIURI storeCustomKeywords(in nsIMsgWindow aMsgWindow,</span>
<a href="#l4.68"></a><span id="l4.68">                       in ACString aFlagsToAdd,</span>
<a href="#l4.69"></a><span id="l4.69">                       in ACString aFlagsToSubtract,</span>
<a href="#l4.70"></a><span id="l4.70">                       [array, size_is (aNumKeys)] in nsMsgKey aKeysToStore,</span>
<a href="#l4.71"></a><span id="l4.71">                       in unsigned long aNumKeys);</span>
<a href="#l4.72"></a><span id="l4.72"> </span>
<a href="#l4.73"></a><span id="l4.73">   void notifyIfNewMail();</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineminus">-  </span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+</span>
<a href="#l4.76"></a><span id="l4.76">   void initiateAutoSync(in nsIUrlListener aUrlListener);</span>
<a href="#l4.77"></a><span id="l4.77"> </span>
<a href="#l4.78"></a><span id="l4.78">   attribute boolean verifiedAsOnlineFolder;</span>
<a href="#l4.79"></a><span id="l4.79">   attribute boolean explicitlyVerify;</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineminus">-  attribute wchar hierarchyDelimiter;</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+  attribute char hierarchyDelimiter;</span>
<a href="#l4.82"></a><span id="l4.82">   attribute long boxFlags;</span>
<a href="#l4.83"></a><span id="l4.83">   attribute ACString onlineName;</span>
<a href="#l4.84"></a><span id="l4.84">   attribute boolean isNamespace;</span>
<a href="#l4.85"></a><span id="l4.85">   readonly attribute boolean canOpenFolder;</span>
<a href="#l4.86"></a><span id="l4.86">   attribute ACString adminUrl;</span>
<a href="#l4.87"></a><span id="l4.87">   readonly attribute boolean hasAdminUrl;</span>
<a href="#l4.88"></a><span id="l4.88">   attribute boolean performingBiff;</span>
<a href="#l4.89"></a><span id="l4.89">   readonly attribute nsIMsgParseMailMsgState hdrParser;</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineat">@@ -150,24 +153,25 @@ interface nsIMsgImapMailFolder : nsISupp</span>
<a href="#l4.91"></a><span id="l4.91">    * - if there are no storage quotas on this folder, or</span>
<a href="#l4.92"></a><span id="l4.92">    * - if the folder has never been opened.</span>
<a href="#l4.93"></a><span id="l4.93">    * If it is true and maxKB &gt; 0, the folder has a storage quota and</span>
<a href="#l4.94"></a><span id="l4.94">    * the usedKB and maxKB attributes are set to the values provided by</span>
<a href="#l4.95"></a><span id="l4.95">    * the server (in kilobytes), for this quota root.</span>
<a href="#l4.96"></a><span id="l4.96">    * Lotus Notes sends us maxKB = 0, usedKB &gt; 0 for unlimited quota.</span>
<a href="#l4.97"></a><span id="l4.97">    */</span>
<a href="#l4.98"></a><span id="l4.98">   void getQuota(out boolean valid, out unsigned long usedKB, out unsigned long maxKB);</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+</span>
<a href="#l4.100"></a><span id="l4.100">   /**</span>
<a href="#l4.101"></a><span id="l4.101">    * Change the number of &quot;pending&quot; messages in a folder,</span>
<a href="#l4.102"></a><span id="l4.102">    *  messages we know about, but don't have the headers for yet</span>
<a href="#l4.103"></a><span id="l4.103">    *</span>
<a href="#l4.104"></a><span id="l4.104">    * @param aDelta amount to change total by.</span>
<a href="#l4.105"></a><span id="l4.105">    */</span>
<a href="#l4.106"></a><span id="l4.106">   void changePendingTotal(in long aDelta);</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+</span>
<a href="#l4.108"></a><span id="l4.108">   /**</span>
<a href="#l4.109"></a><span id="l4.109">    * Change the number of &quot;pending&quot; unread messages in a folder,</span>
<a href="#l4.110"></a><span id="l4.110">    * unread messages we know about, but don't have the headers for yet</span>
<a href="#l4.111"></a><span id="l4.111">    *</span>
<a href="#l4.112"></a><span id="l4.112">    * @param aDelta amount to change the unread count by.</span>
<a href="#l4.113"></a><span id="l4.113">    */</span>
<a href="#l4.114"></a><span id="l4.114">   void changePendingUnread(in long aDelta);</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineminus">-  </span>
<a href="#l4.116"></a><span id="l4.116"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/imap/src/nsImapCore.h</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapCore.h</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -90,17 +90,17 @@ typedef PRUint16 imapMessageFlagsType;</span>
<a href="#l5.4"></a><span id="l5.4">  * We use a separate xlist trash flag so we can prefer the GMail trash</span>
<a href="#l5.5"></a><span id="l5.5">  * over an existing Trash folder we may have created.</span>
<a href="#l5.6"></a><span id="l5.6">  */</span>
<a href="#l5.7"></a><span id="l5.7"> #define kImapMsgSupportUserFlag       0x8000		</span>
<a href="#l5.8"></a><span id="l5.8"> /* This seems to be the most cost effective way of</span>
<a href="#l5.9"></a><span id="l5.9"> * piggying back the server support user flag info.</span>
<a href="#l5.10"></a><span id="l5.10"> */</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-/* if a url creator does not know the hierarchySeparator, use this */</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+/* if a url creator does not know the hierarchyDelimiter, use this */</span>
<a href="#l5.14"></a><span id="l5.14"> #define kOnlineHierarchySeparatorUnknown '^'</span>
<a href="#l5.15"></a><span id="l5.15"> #define kOnlineHierarchySeparatorNil '|'</span>
<a href="#l5.16"></a><span id="l5.16"> </span>
<a href="#l5.17"></a><span id="l5.17"> #define IMAP_URL_TOKEN_SEPARATOR &quot;&gt;&quot;</span>
<a href="#l5.18"></a><span id="l5.18"> #define kUidUnknown -1</span>
<a href="#l5.19"></a><span id="l5.19"> </span>
<a href="#l5.20"></a><span id="l5.20"> // this has to do with Mime Parts on Demand. It used to live in net.h</span>
<a href="#l5.21"></a><span id="l5.21"> // I'm not sure where this will live, but here is OK temporarily</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1090,17 +1090,18 @@ nsImapIncomingServer::CreateRootFolderFr</span>
<a href="#l6.4"></a><span id="l6.4">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l6.5"></a><span id="l6.5">   newRootFolder-&gt;Init(serverUri.get());</span>
<a href="#l6.6"></a><span id="l6.6">   NS_ADDREF(*rootFolder = newRootFolder);</span>
<a href="#l6.7"></a><span id="l6.7">   return NS_OK;</span>
<a href="#l6.8"></a><span id="l6.8"> }</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10"> // nsIImapServerSink impl</span>
<a href="#l6.11"></a><span id="l6.11"> // aNewFolder will not be set if we're listing for the subscribe UI, since that's the way 4.x worked.</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-NS_IMETHODIMP nsImapIncomingServer::PossibleImapMailbox(const nsACString&amp; folderPath, PRUnichar hierarchyDelimiter,</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+NS_IMETHODIMP nsImapIncomingServer::PossibleImapMailbox(const nsACString&amp; folderPath,</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+                                                        char hierarchyDelimiter,</span>
<a href="#l6.15"></a><span id="l6.15">                                                         PRInt32 boxFlags, PRBool *aNewFolder)</span>
<a href="#l6.16"></a><span id="l6.16"> {</span>
<a href="#l6.17"></a><span id="l6.17">   NS_ENSURE_ARG_POINTER(aNewFolder);</span>
<a href="#l6.18"></a><span id="l6.18">   NS_ENSURE_TRUE(!folderPath.IsEmpty(), NS_ERROR_FAILURE);</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20">   // folderPath is in canonical format, i.e., hierarchy separator has been replaced with '/'</span>
<a href="#l6.21"></a><span id="l6.21">   nsresult rv;</span>
<a href="#l6.22"></a><span id="l6.22">   PRBool found = PR_FALSE;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -550,17 +550,17 @@ nsresult nsImapMailFolder::CreateSubFold</span>
<a href="#l7.4"></a><span id="l7.4">         {</span>
<a href="#l7.5"></a><span id="l7.5">           currentFolderPath-&gt;Remove(PR_FALSE);</span>
<a href="#l7.6"></a><span id="l7.6">           continue; // blow away .msf files for folders with unknown delimiter.</span>
<a href="#l7.7"></a><span id="l7.7">         }</span>
<a href="#l7.8"></a><span id="l7.8">         rv = cacheElement-&gt;GetStringProperty(&quot;onlineName&quot;, onlineFullUtf7Name);</span>
<a href="#l7.9"></a><span id="l7.9">         if (NS_SUCCEEDED(rv) &amp;&amp; !onlineFullUtf7Name.IsEmpty())</span>
<a href="#l7.10"></a><span id="l7.10">         {</span>
<a href="#l7.11"></a><span id="l7.11">           CopyMUTF7toUTF16(onlineFullUtf7Name, currentFolderNameStr);</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-          PRUnichar delimiter = 0;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+          char delimiter = 0;</span>
<a href="#l7.14"></a><span id="l7.14">           GetHierarchyDelimiter(&amp;delimiter);</span>
<a href="#l7.15"></a><span id="l7.15">           PRInt32 leafPos = currentFolderNameStr.RFindChar(delimiter);</span>
<a href="#l7.16"></a><span id="l7.16">           if (leafPos &gt; 0)</span>
<a href="#l7.17"></a><span id="l7.17">             currentFolderNameStr.Cut(0, leafPos + 1);</span>
<a href="#l7.18"></a><span id="l7.18"> </span>
<a href="#l7.19"></a><span id="l7.19">           // take the utf7 full online name, and determine the utf7 leaf name</span>
<a href="#l7.20"></a><span id="l7.20">           CopyASCIItoUTF16(onlineFullUtf7Name, utf7LeafName);</span>
<a href="#l7.21"></a><span id="l7.21">           leafPos = utf7LeafName.RFindChar(delimiter);</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineat">@@ -837,17 +837,20 @@ NS_IMETHODIMP nsImapMailFolder::CreateSu</span>
<a href="#l7.23"></a><span id="l7.23">   }</span>
<a href="#l7.24"></a><span id="l7.24"> </span>
<a href="#l7.25"></a><span id="l7.25">   nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l7.26"></a><span id="l7.26">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l7.27"></a><span id="l7.27"> </span>
<a href="#l7.28"></a><span id="l7.28">   return imapService-&gt;CreateFolder(m_thread, this, folderName, this, nsnull);</span>
<a href="#l7.29"></a><span id="l7.29"> }</span>
<a href="#l7.30"></a><span id="l7.30"> </span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-NS_IMETHODIMP nsImapMailFolder::CreateClientSubfolderInfo(const nsACString&amp; folderName, PRUnichar hierarchyDelimiter, PRInt32 flags, PRBool suppressNotification)</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+NS_IMETHODIMP nsImapMailFolder::CreateClientSubfolderInfo(const nsACString&amp; folderName,</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+                                                          char hierarchyDelimiter,</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+                                                          PRInt32 flags,</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+                                                          PRBool suppressNotification)</span>
<a href="#l7.36"></a><span id="l7.36"> {</span>
<a href="#l7.37"></a><span id="l7.37">   nsresult rv = NS_OK;</span>
<a href="#l7.38"></a><span id="l7.38"> </span>
<a href="#l7.39"></a><span id="l7.39">   //Get a directory based on our current path.</span>
<a href="#l7.40"></a><span id="l7.40">   nsCOMPtr &lt;nsILocalFile&gt; path;</span>
<a href="#l7.41"></a><span id="l7.41">   rv = CreateDirectoryForFolder(getter_AddRefs(path));</span>
<a href="#l7.42"></a><span id="l7.42">   if(NS_FAILED(rv))</span>
<a href="#l7.43"></a><span id="l7.43">     return rv;</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineat">@@ -911,17 +914,17 @@ NS_IMETHODIMP nsImapMailFolder::CreateCl</span>
<a href="#l7.45"></a><span id="l7.45">   //need to set the folder name</span>
<a href="#l7.46"></a><span id="l7.46">     nsCOMPtr &lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l7.47"></a><span id="l7.47">     rv = unusedDB-&gt;GetDBFolderInfo(getter_AddRefs(folderInfo));</span>
<a href="#l7.48"></a><span id="l7.48">     nsCOMPtr &lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(child, &amp;rv);</span>
<a href="#l7.49"></a><span id="l7.49">     if (NS_SUCCEEDED(rv))</span>
<a href="#l7.50"></a><span id="l7.50">     {</span>
<a href="#l7.51"></a><span id="l7.51">       nsCAutoString onlineName(m_onlineFolderName);</span>
<a href="#l7.52"></a><span id="l7.52">       if (!onlineName.IsEmpty())</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-        onlineName.Append(char(hierarchyDelimiter));</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+        onlineName.Append(hierarchyDelimiter);</span>
<a href="#l7.55"></a><span id="l7.55">       LossyAppendUTF16toASCII(folderNameStr, onlineName);</span>
<a href="#l7.56"></a><span id="l7.56">       imapFolder-&gt;SetVerifiedAsOnlineFolder(PR_TRUE);</span>
<a href="#l7.57"></a><span id="l7.57">       imapFolder-&gt;SetOnlineName(onlineName);</span>
<a href="#l7.58"></a><span id="l7.58">       imapFolder-&gt;SetHierarchyDelimiter(hierarchyDelimiter);</span>
<a href="#l7.59"></a><span id="l7.59">       imapFolder-&gt;SetBoxFlags(flags);</span>
<a href="#l7.60"></a><span id="l7.60"> </span>
<a href="#l7.61"></a><span id="l7.61">       child-&gt;SetFlag(nsMsgFolderFlags::Elided);</span>
<a href="#l7.62"></a><span id="l7.62">       nsString unicodeName;</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineat">@@ -1062,30 +1065,30 @@ NS_IMETHODIMP nsImapMailFolder::SetVerif</span>
<a href="#l7.64"></a><span id="l7.64">     while (parent);</span>
<a href="#l7.65"></a><span id="l7.65">   }</span>
<a href="#l7.66"></a><span id="l7.66">   return NS_OK;</span>
<a href="#l7.67"></a><span id="l7.67"> }</span>
<a href="#l7.68"></a><span id="l7.68"> </span>
<a href="#l7.69"></a><span id="l7.69"> NS_IMETHODIMP nsImapMailFolder::GetOnlineDelimiter(char** onlineDelimiter)</span>
<a href="#l7.70"></a><span id="l7.70"> {</span>
<a href="#l7.71"></a><span id="l7.71">   NS_ENSURE_ARG_POINTER(onlineDelimiter);</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-  PRUnichar delimiter = 0;</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+  char delimiter = 0;</span>
<a href="#l7.74"></a><span id="l7.74">   GetHierarchyDelimiter(&amp;delimiter);</span>
<a href="#l7.75"></a><span id="l7.75">   nsAutoString str(delimiter);</span>
<a href="#l7.76"></a><span id="l7.76">   *onlineDelimiter = ToNewCString(str);</span>
<a href="#l7.77"></a><span id="l7.77">   return NS_OK;</span>
<a href="#l7.78"></a><span id="l7.78"> }</span>
<a href="#l7.79"></a><span id="l7.79"> </span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-NS_IMETHODIMP nsImapMailFolder::SetHierarchyDelimiter(PRUnichar aHierarchyDelimiter)</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+NS_IMETHODIMP nsImapMailFolder::SetHierarchyDelimiter(char aHierarchyDelimiter)</span>
<a href="#l7.82"></a><span id="l7.82"> {</span>
<a href="#l7.83"></a><span id="l7.83">   m_hierarchyDelimiter = aHierarchyDelimiter;</span>
<a href="#l7.84"></a><span id="l7.84">   return NS_OK;</span>
<a href="#l7.85"></a><span id="l7.85"> }</span>
<a href="#l7.86"></a><span id="l7.86"> </span>
<a href="#l7.87"></a><span id="l7.87" class="difflineminus">-NS_IMETHODIMP nsImapMailFolder::GetHierarchyDelimiter(PRUnichar *aHierarchyDelimiter)</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+NS_IMETHODIMP nsImapMailFolder::GetHierarchyDelimiter(char *aHierarchyDelimiter)</span>
<a href="#l7.89"></a><span id="l7.89"> {</span>
<a href="#l7.90"></a><span id="l7.90">   NS_ENSURE_ARG_POINTER(aHierarchyDelimiter);</span>
<a href="#l7.91"></a><span id="l7.91">   if (mIsServer)</span>
<a href="#l7.92"></a><span id="l7.92">   {</span>
<a href="#l7.93"></a><span id="l7.93">     // if it's the root folder, we don't know the delimiter. So look at the</span>
<a href="#l7.94"></a><span id="l7.94">     // first child.</span>
<a href="#l7.95"></a><span id="l7.95">     PRInt32 count = mSubFolders.Count();</span>
<a href="#l7.96"></a><span id="l7.96">     if (count &gt; 0)</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineat">@@ -1818,17 +1821,17 @@ NS_IMETHODIMP nsImapMailFolder::ReadFrom</span>
<a href="#l7.98"></a><span id="l7.98"> {</span>
<a href="#l7.99"></a><span id="l7.99">   nsresult rv = nsMsgDBFolder::ReadFromFolderCacheElem(element);</span>
<a href="#l7.100"></a><span id="l7.100">   PRInt32 hierarchyDelimiter = kOnlineHierarchySeparatorUnknown;</span>
<a href="#l7.101"></a><span id="l7.101">   nsCString onlineName;</span>
<a href="#l7.102"></a><span id="l7.102"> </span>
<a href="#l7.103"></a><span id="l7.103">   element-&gt;GetInt32Property(&quot;boxFlags&quot;, &amp;m_boxFlags);</span>
<a href="#l7.104"></a><span id="l7.104">   if (NS_SUCCEEDED(element-&gt;GetInt32Property(&quot;hierDelim&quot;, &amp;hierarchyDelimiter))</span>
<a href="#l7.105"></a><span id="l7.105">       &amp;&amp; hierarchyDelimiter != kOnlineHierarchySeparatorUnknown)</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineminus">-    m_hierarchyDelimiter = (PRUnichar) hierarchyDelimiter;</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+    m_hierarchyDelimiter = (char) hierarchyDelimiter;</span>
<a href="#l7.108"></a><span id="l7.108">   rv = element-&gt;GetStringProperty(&quot;onlineName&quot;, onlineName);</span>
<a href="#l7.109"></a><span id="l7.109">   if (NS_SUCCEEDED(rv) &amp;&amp; !onlineName.IsEmpty())</span>
<a href="#l7.110"></a><span id="l7.110">     m_onlineFolderName.Assign(onlineName);</span>
<a href="#l7.111"></a><span id="l7.111"> </span>
<a href="#l7.112"></a><span id="l7.112">   m_aclFlags = -1; // init to invalid value.</span>
<a href="#l7.113"></a><span id="l7.113">   element-&gt;GetInt32Property(&quot;aclFlags&quot;, (PRInt32 *) &amp;m_aclFlags);</span>
<a href="#l7.114"></a><span id="l7.114">   element-&gt;GetInt32Property(&quot;serverTotal&quot;, &amp;m_numServerTotalMessages);</span>
<a href="#l7.115"></a><span id="l7.115">   element-&gt;GetInt32Property(&quot;serverUnseen&quot;, &amp;m_numServerUnseenMessages);</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineat">@@ -1953,17 +1956,17 @@ nsImapMailFolder::GetDBFolderInfoAndDB(n</span>
<a href="#l7.117"></a><span id="l7.117"> </span>
<a href="#l7.118"></a><span id="l7.118">       nsCString hostname;</span>
<a href="#l7.119"></a><span id="l7.119">       rv = GetHostname(hostname);</span>
<a href="#l7.120"></a><span id="l7.120">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.121"></a><span id="l7.121"> </span>
<a href="#l7.122"></a><span id="l7.122">       nsCString onlineCName;</span>
<a href="#l7.123"></a><span id="l7.123">       rv = nsImapURI2FullName(kImapRootURI, hostname.get(), uri.get(), getter_Copies(onlineCName));</span>
<a href="#l7.124"></a><span id="l7.124">       if (m_hierarchyDelimiter != '/')</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineminus">-        onlineCName.ReplaceChar('/',  char(m_hierarchyDelimiter));</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+        onlineCName.ReplaceChar('/',  m_hierarchyDelimiter);</span>
<a href="#l7.127"></a><span id="l7.127">       m_onlineFolderName.Assign(onlineCName);</span>
<a href="#l7.128"></a><span id="l7.128">       CopyASCIItoUTF16(onlineCName, autoOnlineName);</span>
<a href="#l7.129"></a><span id="l7.129">     }</span>
<a href="#l7.130"></a><span id="l7.130">     (*folderInfo)-&gt;SetProperty(&quot;onlineName&quot;, autoOnlineName);</span>
<a href="#l7.131"></a><span id="l7.131">   }</span>
<a href="#l7.132"></a><span id="l7.132">   return rv;</span>
<a href="#l7.133"></a><span id="l7.133"> }</span>
<a href="#l7.134"></a><span id="l7.134"> </span>
<a href="#l7.135"></a><span id="l7.135" class="difflineat">@@ -3625,25 +3628,28 @@ nsIMAPNamespace *nsImapMailFolder::GetNa</span>
<a href="#l7.136"></a><span id="l7.136"> #ifdef DEBUG_bienvenu</span>
<a href="#l7.137"></a><span id="l7.137">     // Make sure this isn't causing us to open the database</span>
<a href="#l7.138"></a><span id="l7.138">     NS_ASSERTION(m_hierarchyDelimiter != kOnlineHierarchySeparatorUnknown, &quot;haven't set hierarchy delimiter&quot;);</span>
<a href="#l7.139"></a><span id="l7.139"> #endif</span>
<a href="#l7.140"></a><span id="l7.140">     nsCString serverKey;</span>
<a href="#l7.141"></a><span id="l7.141">     nsCString onlineName;</span>
<a href="#l7.142"></a><span id="l7.142">     GetServerKey(serverKey);</span>
<a href="#l7.143"></a><span id="l7.143">     GetOnlineName(onlineName);</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineminus">-    PRUnichar hierarchyDelimiter;</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineplus">+    char hierarchyDelimiter;</span>
<a href="#l7.146"></a><span id="l7.146">     GetHierarchyDelimiter(&amp;hierarchyDelimiter);</span>
<a href="#l7.147"></a><span id="l7.147"> </span>
<a href="#l7.148"></a><span id="l7.148" class="difflineminus">-    m_namespace = nsIMAPNamespaceList::GetNamespaceForFolder(serverKey.get(), onlineName.get(), (char) hierarchyDelimiter);</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineplus">+    m_namespace = nsIMAPNamespaceList::GetNamespaceForFolder(</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineplus">+                    serverKey.get(), onlineName.get(), hierarchyDelimiter);</span>
<a href="#l7.151"></a><span id="l7.151">     NS_ASSERTION(m_namespace, &quot;didn't get namespace for folder&quot;);</span>
<a href="#l7.152"></a><span id="l7.152">     if (m_namespace)</span>
<a href="#l7.153"></a><span id="l7.153">     {</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineminus">-      nsIMAPNamespaceList::SuggestHierarchySeparatorForNamespace(m_namespace, (char) hierarchyDelimiter);</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineminus">-      m_folderIsNamespace = nsIMAPNamespaceList::GetFolderIsNamespace(serverKey.get(), onlineName.get(), (char) hierarchyDelimiter, m_namespace);</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineplus">+      nsIMAPNamespaceList::SuggestHierarchySeparatorForNamespace(m_namespace, hierarchyDelimiter);</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+      m_folderIsNamespace = nsIMAPNamespaceList::GetFolderIsNamespace(</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineplus">+                              serverKey.get(), onlineName.get(),</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineplus">+                              hierarchyDelimiter, m_namespace);</span>
<a href="#l7.160"></a><span id="l7.160">     }</span>
<a href="#l7.161"></a><span id="l7.161">   }</span>
<a href="#l7.162"></a><span id="l7.162">   return m_namespace;</span>
<a href="#l7.163"></a><span id="l7.163"> }</span>
<a href="#l7.164"></a><span id="l7.164"> </span>
<a href="#l7.165"></a><span id="l7.165"> void nsImapMailFolder::SetNamespaceForFolder(nsIMAPNamespace *ns)</span>
<a href="#l7.166"></a><span id="l7.166"> {</span>
<a href="#l7.167"></a><span id="l7.167"> #ifdef DEBUG_bienvenu</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineat">@@ -7587,36 +7593,40 @@ NS_IMETHODIMP nsImapMailFolder::GetIsNam</span>
<a href="#l7.169"></a><span id="l7.169"> #ifdef DEBUG_bienvenu</span>
<a href="#l7.170"></a><span id="l7.170">     // Make sure this isn't causing us to open the database</span>
<a href="#l7.171"></a><span id="l7.171">     NS_ASSERTION(m_hierarchyDelimiter != kOnlineHierarchySeparatorUnknown, &quot;hierarchy delimiter not set&quot;);</span>
<a href="#l7.172"></a><span id="l7.172"> #endif</span>
<a href="#l7.173"></a><span id="l7.173"> </span>
<a href="#l7.174"></a><span id="l7.174">     nsCString onlineName, serverKey;</span>
<a href="#l7.175"></a><span id="l7.175">     GetServerKey(serverKey);</span>
<a href="#l7.176"></a><span id="l7.176">     GetOnlineName(onlineName);</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineminus">-    PRUnichar hierarchyDelimiter;</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineplus">+    char hierarchyDelimiter;</span>
<a href="#l7.179"></a><span id="l7.179">     GetHierarchyDelimiter(&amp;hierarchyDelimiter);</span>
<a href="#l7.180"></a><span id="l7.180"> </span>
<a href="#l7.181"></a><span id="l7.181">     nsCOMPtr&lt;nsIImapHostSessionList&gt; hostSession = do_GetService(kCImapHostSessionList, &amp;rv);</span>
<a href="#l7.182"></a><span id="l7.182">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineminus">-    m_namespace = nsIMAPNamespaceList::GetNamespaceForFolder(serverKey.get(), onlineName.get(), (char) hierarchyDelimiter);</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineplus">+    m_namespace = nsIMAPNamespaceList::GetNamespaceForFolder(</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineplus">+                    serverKey.get(), onlineName.get(), hierarchyDelimiter);</span>
<a href="#l7.186"></a><span id="l7.186">     if (m_namespace == nsnull)</span>
<a href="#l7.187"></a><span id="l7.187">     {</span>
<a href="#l7.188"></a><span id="l7.188">       if (mFlags &amp; nsMsgFolderFlags::ImapOtherUser)</span>
<a href="#l7.189"></a><span id="l7.189">          rv = hostSession-&gt;GetDefaultNamespaceOfTypeForHost(serverKey.get(), kOtherUsersNamespace, m_namespace);</span>
<a href="#l7.190"></a><span id="l7.190">       else if (mFlags &amp; nsMsgFolderFlags::ImapPublic)</span>
<a href="#l7.191"></a><span id="l7.191">         rv = hostSession-&gt;GetDefaultNamespaceOfTypeForHost(serverKey.get(), kPublicNamespace, m_namespace);</span>
<a href="#l7.192"></a><span id="l7.192">       else</span>
<a href="#l7.193"></a><span id="l7.193">         rv = hostSession-&gt;GetDefaultNamespaceOfTypeForHost(serverKey.get(), kPersonalNamespace, m_namespace);</span>
<a href="#l7.194"></a><span id="l7.194">     }</span>
<a href="#l7.195"></a><span id="l7.195">     NS_ASSERTION(m_namespace, &quot;failed to get namespace&quot;);</span>
<a href="#l7.196"></a><span id="l7.196">     if (m_namespace)</span>
<a href="#l7.197"></a><span id="l7.197">     {</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineminus">-      nsIMAPNamespaceList::SuggestHierarchySeparatorForNamespace(m_namespace, (char) hierarchyDelimiter);</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineminus">-      m_folderIsNamespace = nsIMAPNamespaceList::GetFolderIsNamespace(serverKey.get(), onlineName.get(), (char) hierarchyDelimiter, m_namespace);</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineplus">+      nsIMAPNamespaceList::SuggestHierarchySeparatorForNamespace(m_namespace,</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineplus">+                                                                 hierarchyDelimiter);</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineplus">+      m_folderIsNamespace = nsIMAPNamespaceList::GetFolderIsNamespace(</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineplus">+                              serverKey.get(), onlineName.get(),</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineplus">+                              hierarchyDelimiter, m_namespace);</span>
<a href="#l7.205"></a><span id="l7.205">     }</span>
<a href="#l7.206"></a><span id="l7.206">   }</span>
<a href="#l7.207"></a><span id="l7.207">   *aResult = m_folderIsNamespace;</span>
<a href="#l7.208"></a><span id="l7.208">   return rv;</span>
<a href="#l7.209"></a><span id="l7.209"> }</span>
<a href="#l7.210"></a><span id="l7.210"> </span>
<a href="#l7.211"></a><span id="l7.211"> NS_IMETHODIMP nsImapMailFolder::SetIsNamespace(PRBool isNamespace)</span>
<a href="#l7.212"></a><span id="l7.212"> {</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineat">@@ -7625,22 +7635,24 @@ NS_IMETHODIMP nsImapMailFolder::SetIsNam</span>
<a href="#l7.214"></a><span id="l7.214"> }</span>
<a href="#l7.215"></a><span id="l7.215"> </span>
<a href="#l7.216"></a><span id="l7.216"> NS_IMETHODIMP nsImapMailFolder::ResetNamespaceReferences()</span>
<a href="#l7.217"></a><span id="l7.217"> {</span>
<a href="#l7.218"></a><span id="l7.218">   nsCString serverKey;</span>
<a href="#l7.219"></a><span id="l7.219">   nsCString onlineName;</span>
<a href="#l7.220"></a><span id="l7.220">   GetServerKey(serverKey);</span>
<a href="#l7.221"></a><span id="l7.221">   GetOnlineName(onlineName);</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineminus">-  PRUnichar hierarchyDelimiter;</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineplus">+  char hierarchyDelimiter;</span>
<a href="#l7.224"></a><span id="l7.224">   GetHierarchyDelimiter(&amp;hierarchyDelimiter);</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineminus">-  m_namespace = nsIMAPNamespaceList::GetNamespaceForFolder(serverKey.get(), onlineName.get(), (char) hierarchyDelimiter);</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineminus">-//  NS_ASSERTION(m_namespace, &quot;resetting null namespace&quot;);</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineminus">-  m_folderIsNamespace = m_namespace ? nsIMAPNamespaceList::GetFolderIsNamespace(serverKey.get(), onlineName.get(), </span>
<a href="#l7.228"></a><span id="l7.228" class="difflineminus">-                                                                                (char) hierarchyDelimiter, m_namespace) : PR_FALSE;</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineplus">+  m_namespace = nsIMAPNamespaceList::GetNamespaceForFolder(serverKey.get(),</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineplus">+                                                           onlineName.get(),</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineplus">+                                                           hierarchyDelimiter);</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineplus">+  m_folderIsNamespace = m_namespace ? nsIMAPNamespaceList::GetFolderIsNamespace(</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineplus">+                                        serverKey.get(), onlineName.get(),</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineplus">+                                        hierarchyDelimiter, m_namespace) : PR_FALSE;</span>
<a href="#l7.235"></a><span id="l7.235"> </span>
<a href="#l7.236"></a><span id="l7.236">   nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l7.237"></a><span id="l7.237">   GetSubFolders(getter_AddRefs(enumerator));</span>
<a href="#l7.238"></a><span id="l7.238">   if (!enumerator)</span>
<a href="#l7.239"></a><span id="l7.239">     return NS_OK;</span>
<a href="#l7.240"></a><span id="l7.240"> </span>
<a href="#l7.241"></a><span id="l7.241">   nsresult rv;</span>
<a href="#l7.242"></a><span id="l7.242">   PRBool hasMore;</span>
<a href="#l7.243"></a><span id="l7.243" class="difflineat">@@ -7767,21 +7779,21 @@ NS_IMETHODIMP nsImapMailFolder::RenameCl</span>
<a href="#l7.244"></a><span id="l7.244">   nsresult rv;</span>
<a href="#l7.245"></a><span id="l7.245">   nsCOMPtr&lt;nsILocalFile&gt; pathFile;</span>
<a href="#l7.246"></a><span id="l7.246">   rv = GetFilePath(getter_AddRefs(pathFile));</span>
<a href="#l7.247"></a><span id="l7.247">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l7.248"></a><span id="l7.248"> </span>
<a href="#l7.249"></a><span id="l7.249">   nsCOMPtr&lt;nsIMsgImapMailFolder&gt; oldImapFolder = do_QueryInterface(msgFolder, &amp;rv);</span>
<a href="#l7.250"></a><span id="l7.250">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l7.251"></a><span id="l7.251"> </span>
<a href="#l7.252"></a><span id="l7.252" class="difflineminus">-  PRUnichar hierarchyDelimiter = '/';</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineplus">+  char hierarchyDelimiter = '/';</span>
<a href="#l7.254"></a><span id="l7.254">   oldImapFolder-&gt;GetHierarchyDelimiter(&amp;hierarchyDelimiter);</span>
<a href="#l7.255"></a><span id="l7.255">   PRInt32 boxflags=0;</span>
<a href="#l7.256"></a><span id="l7.256">   oldImapFolder-&gt;GetBoxFlags(&amp;boxflags);</span>
<a href="#l7.257"></a><span id="l7.257" class="difflineminus">-  </span>
<a href="#l7.258"></a><span id="l7.258" class="difflineplus">+</span>
<a href="#l7.259"></a><span id="l7.259">   nsAutoString newLeafName;</span>
<a href="#l7.260"></a><span id="l7.260">   nsAutoString newNameString;</span>
<a href="#l7.261"></a><span id="l7.261">   CopyASCIItoUTF16(newName, newNameString);</span>
<a href="#l7.262"></a><span id="l7.262">   newLeafName = newNameString;</span>
<a href="#l7.263"></a><span id="l7.263">   nsAutoString parentName;</span>
<a href="#l7.264"></a><span id="l7.264">   nsAutoString folderNameStr;</span>
<a href="#l7.265"></a><span id="l7.265">   PRInt32 folderStart = newLeafName.RFindChar('/');  //internal use of hierarchyDelimiter is always '/'</span>
<a href="#l7.266"></a><span id="l7.266">   if (folderStart &gt; 0)</span>
<a href="#l7.267"></a><span id="l7.267" class="difflineat">@@ -7821,17 +7833,17 @@ NS_IMETHODIMP nsImapMailFolder::RenameCl</span>
<a href="#l7.268"></a><span id="l7.268">     if (!child || NS_FAILED(rv)) </span>
<a href="#l7.269"></a><span id="l7.269">       return rv;</span>
<a href="#l7.270"></a><span id="l7.270">     child-&gt;SetName(newLeafName);</span>
<a href="#l7.271"></a><span id="l7.271">     imapFolder = do_QueryInterface(child);</span>
<a href="#l7.272"></a><span id="l7.272">     if (imapFolder)</span>
<a href="#l7.273"></a><span id="l7.273">     {</span>
<a href="#l7.274"></a><span id="l7.274">       nsCAutoString onlineName(m_onlineFolderName);</span>
<a href="#l7.275"></a><span id="l7.275">       if (!onlineName.IsEmpty())</span>
<a href="#l7.276"></a><span id="l7.276" class="difflineminus">-      onlineName.Append(char(hierarchyDelimiter));</span>
<a href="#l7.277"></a><span id="l7.277" class="difflineplus">+      onlineName.Append(hierarchyDelimiter);</span>
<a href="#l7.278"></a><span id="l7.278">       LossyAppendUTF16toASCII(folderNameStr, onlineName);</span>
<a href="#l7.279"></a><span id="l7.279">       imapFolder-&gt;SetVerifiedAsOnlineFolder(PR_TRUE);</span>
<a href="#l7.280"></a><span id="l7.280">       imapFolder-&gt;SetOnlineName(onlineName);</span>
<a href="#l7.281"></a><span id="l7.281">       imapFolder-&gt;SetHierarchyDelimiter(hierarchyDelimiter);</span>
<a href="#l7.282"></a><span id="l7.282">       imapFolder-&gt;SetBoxFlags(boxflags);</span>
<a href="#l7.283"></a><span id="l7.283">       // store the online name as the mailbox name in the db folder info</span>
<a href="#l7.284"></a><span id="l7.284">       // I don't think anyone uses the mailbox name, so we'll use it</span>
<a href="#l7.285"></a><span id="l7.285">       // to restore the online name when blowing away an imap db.</span>
<a href="#l7.286"></a><span id="l7.286" class="difflineat">@@ -7884,17 +7896,17 @@ NS_IMETHODIMP nsImapMailFolder::RenameSu</span>
<a href="#l7.287"></a><span id="l7.287">     nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder(do_QueryInterface(item, &amp;rv));</span>
<a href="#l7.288"></a><span id="l7.288">     if (NS_FAILED(rv))</span>
<a href="#l7.289"></a><span id="l7.289">       return rv;</span>
<a href="#l7.290"></a><span id="l7.290"> </span>
<a href="#l7.291"></a><span id="l7.291">     nsCOMPtr&lt;nsIMsgImapMailFolder&gt; folder(do_QueryInterface(msgFolder, &amp;rv));</span>
<a href="#l7.292"></a><span id="l7.292">     if (NS_FAILED(rv))</span>
<a href="#l7.293"></a><span id="l7.293">       return rv;</span>
<a href="#l7.294"></a><span id="l7.294"> </span>
<a href="#l7.295"></a><span id="l7.295" class="difflineminus">-    PRUnichar hierarchyDelimiter = '/';</span>
<a href="#l7.296"></a><span id="l7.296" class="difflineplus">+    char hierarchyDelimiter = '/';</span>
<a href="#l7.297"></a><span id="l7.297">     folder-&gt;GetHierarchyDelimiter(&amp;hierarchyDelimiter);</span>
<a href="#l7.298"></a><span id="l7.298"> </span>
<a href="#l7.299"></a><span id="l7.299">     PRInt32 boxflags;</span>
<a href="#l7.300"></a><span id="l7.300">     folder-&gt;GetBoxFlags(&amp;boxflags);</span>
<a href="#l7.301"></a><span id="l7.301"> </span>
<a href="#l7.302"></a><span id="l7.302">     PRBool verified;</span>
<a href="#l7.303"></a><span id="l7.303">     folder-&gt;GetVerifiedAsOnlineFolder(&amp;verified);</span>
<a href="#l7.304"></a><span id="l7.304"> </span>
<a href="#l7.305"></a><span id="l7.305" class="difflineat">@@ -7937,17 +7949,17 @@ NS_IMETHODIMP nsImapMailFolder::RenameSu</span>
<a href="#l7.306"></a><span id="l7.306">     rv = AddSubfolderWithPath(unicodeLeafName, dbFilePath, getter_AddRefs(child));</span>
<a href="#l7.307"></a><span id="l7.307">     if (!child || NS_FAILED(rv)) return rv;</span>
<a href="#l7.308"></a><span id="l7.308"> </span>
<a href="#l7.309"></a><span id="l7.309">     child-&gt;SetName(folderName);</span>
<a href="#l7.310"></a><span id="l7.310">     nsCOMPtr &lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(child);</span>
<a href="#l7.311"></a><span id="l7.311">     nsCString onlineName;</span>
<a href="#l7.312"></a><span id="l7.312">     GetOnlineName(onlineName);</span>
<a href="#l7.313"></a><span id="l7.313">     nsCAutoString onlineCName(onlineName);</span>
<a href="#l7.314"></a><span id="l7.314" class="difflineminus">-    onlineCName.Append(char(hierarchyDelimiter));</span>
<a href="#l7.315"></a><span id="l7.315" class="difflineplus">+    onlineCName.Append(hierarchyDelimiter);</span>
<a href="#l7.316"></a><span id="l7.316">     onlineCName.Append(utf7LeafName);</span>
<a href="#l7.317"></a><span id="l7.317">     if (imapFolder)</span>
<a href="#l7.318"></a><span id="l7.318">     {</span>
<a href="#l7.319"></a><span id="l7.319">      imapFolder-&gt;SetVerifiedAsOnlineFolder(verified);</span>
<a href="#l7.320"></a><span id="l7.320">      imapFolder-&gt;SetOnlineName(onlineCName);</span>
<a href="#l7.321"></a><span id="l7.321">      imapFolder-&gt;SetHierarchyDelimiter(hierarchyDelimiter);</span>
<a href="#l7.322"></a><span id="l7.322">      imapFolder-&gt;SetBoxFlags(boxflags);</span>
<a href="#l7.323"></a><span id="l7.323"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.h</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.h</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -68,18 +68,16 @@</span>
<a href="#l8.4"></a><span id="l8.4"> #include &quot;nsAutoSyncState.h&quot;</span>
<a href="#l8.5"></a><span id="l8.5"> </span>
<a href="#l8.6"></a><span id="l8.6"> class nsImapMoveCoalescer;</span>
<a href="#l8.7"></a><span id="l8.7"> class nsIMsgIdentity;</span>
<a href="#l8.8"></a><span id="l8.8"> class nsIMsgOfflineImapOperation;</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10"> #define COPY_BUFFER_SIZE 16384</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-/* b64534f0-3d53-11d3-ac2a-00805f8ac968 */</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-</span>
<a href="#l8.14"></a><span id="l8.14"> #define NS_IMAPMAILCOPYSTATE_IID \</span>
<a href="#l8.15"></a><span id="l8.15"> { 0xb64534f0, 0x3d53, 0x11d3, \</span>
<a href="#l8.16"></a><span id="l8.16">     { 0xac, 0x2a, 0x00, 0x80, 0x5f, 0x8a, 0xc9, 0x68 } }</span>
<a href="#l8.17"></a><span id="l8.17"> </span>
<a href="#l8.18"></a><span id="l8.18"> class nsImapMailCopyState: public nsISupports</span>
<a href="#l8.19"></a><span id="l8.19"> {</span>
<a href="#l8.20"></a><span id="l8.20"> public:</span>
<a href="#l8.21"></a><span id="l8.21">     NS_DECLARE_STATIC_IID_ACCESSOR(NS_IMAPMAILCOPYSTATE_IID)</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineat">@@ -471,17 +469,17 @@ protected:</span>
<a href="#l8.23"></a><span id="l8.23">   nsCOMPtr&lt;nsIThread&gt; m_thread;</span>
<a href="#l8.24"></a><span id="l8.24">   nsCOMPtr&lt;nsIUrlListener&gt; m_urlListener;</span>
<a href="#l8.25"></a><span id="l8.25">   PRBool m_urlRunning;</span>
<a href="#l8.26"></a><span id="l8.26"> </span>
<a href="#l8.27"></a><span id="l8.27">   // *** jt - undo move/copy trasaction support</span>
<a href="#l8.28"></a><span id="l8.28">   nsRefPtr&lt;nsMsgTxn&gt; m_pendingUndoTxn;</span>
<a href="#l8.29"></a><span id="l8.29">   nsCOMPtr&lt;nsImapMailCopyState&gt; m_copyState;</span>
<a href="#l8.30"></a><span id="l8.30">   PRMonitor *m_appendMsgMonitor;</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-  PRUnichar m_hierarchyDelimiter;</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+  char m_hierarchyDelimiter;</span>
<a href="#l8.33"></a><span id="l8.33">   PRInt32 m_boxFlags;</span>
<a href="#l8.34"></a><span id="l8.34">   nsCString m_onlineFolderName;</span>
<a href="#l8.35"></a><span id="l8.35">   nsCString m_ownerUserName;  // username of the &quot;other user,&quot; as in</span>
<a href="#l8.36"></a><span id="l8.36">   // &quot;Other Users' Mailboxes&quot;</span>
<a href="#l8.37"></a><span id="l8.37"> </span>
<a href="#l8.38"></a><span id="l8.38">   nsCString m_adminUrl;   // url to run to set admin privileges for this folder</span>
<a href="#l8.39"></a><span id="l8.39">   nsIMAPNamespace  *m_namespace;</span>
<a href="#l8.40"></a><span id="l8.40">   PRPackedBool m_verifiedAsOnlineFolder;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -5832,31 +5832,31 @@ char * nsImapProtocol::OnCreateServerSou</span>
<a href="#l9.4"></a><span id="l9.4">   return sourceMailbox;</span>
<a href="#l9.5"></a><span id="l9.5"> }</span>
<a href="#l9.6"></a><span id="l9.6"> </span>
<a href="#l9.7"></a><span id="l9.7"> //caller must free using PR_Free, safe to call from ui thread</span>
<a href="#l9.8"></a><span id="l9.8"> char * nsImapProtocol::GetFolderPathString()</span>
<a href="#l9.9"></a><span id="l9.9"> {</span>
<a href="#l9.10"></a><span id="l9.10">   char *sourceMailbox = nsnull;</span>
<a href="#l9.11"></a><span id="l9.11">   char onlineSubDirDelimiter = 0;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  PRUnichar hierarchyDelimiter = 0;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+  char hierarchyDelimiter = 0;</span>
<a href="#l9.14"></a><span id="l9.14">   nsCOMPtr &lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l9.15"></a><span id="l9.15"> </span>
<a href="#l9.16"></a><span id="l9.16">   m_runningUrl-&gt;GetOnlineSubDirSeparator(&amp;onlineSubDirDelimiter);</span>
<a href="#l9.17"></a><span id="l9.17">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_runningUrl);</span>
<a href="#l9.18"></a><span id="l9.18">   mailnewsUrl-&gt;GetFolder(getter_AddRefs(msgFolder));</span>
<a href="#l9.19"></a><span id="l9.19">   if (msgFolder)</span>
<a href="#l9.20"></a><span id="l9.20">   {</span>
<a href="#l9.21"></a><span id="l9.21">     nsCOMPtr &lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(msgFolder);</span>
<a href="#l9.22"></a><span id="l9.22">     if (imapFolder)</span>
<a href="#l9.23"></a><span id="l9.23">     {</span>
<a href="#l9.24"></a><span id="l9.24">       imapFolder-&gt;GetHierarchyDelimiter(&amp;hierarchyDelimiter);</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-      if (hierarchyDelimiter != kOnlineHierarchySeparatorUnknown</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-          &amp;&amp; onlineSubDirDelimiter != (char) hierarchyDelimiter)</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-          m_runningUrl-&gt;SetOnlineSubDirSeparator ((char) hierarchyDelimiter);</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+      if (hierarchyDelimiter != kOnlineHierarchySeparatorUnknown &amp;&amp;</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+          onlineSubDirDelimiter != hierarchyDelimiter)</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+          m_runningUrl-&gt;SetOnlineSubDirSeparator(hierarchyDelimiter);</span>
<a href="#l9.31"></a><span id="l9.31">     }</span>
<a href="#l9.32"></a><span id="l9.32">   }</span>
<a href="#l9.33"></a><span id="l9.33">   m_runningUrl-&gt;CreateServerSourceFolderPathString(&amp;sourceMailbox);</span>
<a href="#l9.34"></a><span id="l9.34"> </span>
<a href="#l9.35"></a><span id="l9.35">   return sourceMailbox;</span>
<a href="#l9.36"></a><span id="l9.36"> }</span>
<a href="#l9.37"></a><span id="l9.37"> </span>
<a href="#l9.38"></a><span id="l9.38"> nsresult nsImapProtocol::CreateServerSourceFolderPathString(char **result)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/imap/src/nsImapService.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapService.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -137,53 +137,53 @@ nsImapService::nsImapService()</span>
<a href="#l10.4"></a><span id="l10.4">   {</span>
<a href="#l10.5"></a><span id="l10.5">     nsresult rv;</span>
<a href="#l10.6"></a><span id="l10.6">     nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv)); </span>
<a href="#l10.7"></a><span id="l10.7">     if (NS_SUCCEEDED(rv) &amp;&amp; prefBranch) </span>
<a href="#l10.8"></a><span id="l10.8">     {</span>
<a href="#l10.9"></a><span id="l10.9">       prefBranch-&gt;GetBoolPref(&quot;mail.imap.mime_parts_on_demand&quot;, &amp;gMIMEOnDemand);</span>
<a href="#l10.10"></a><span id="l10.10">       prefBranch-&gt;GetIntPref(&quot;mail.imap.mime_parts_on_demand_threshold&quot;, &amp;gMIMEOnDemandThreshold);</span>
<a href="#l10.11"></a><span id="l10.11">     }</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-    </span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+</span>
<a href="#l10.14"></a><span id="l10.14">     // initialize auto-sync service</span>
<a href="#l10.15"></a><span id="l10.15">     nsCOMPtr&lt;nsIAutoSyncManager&gt; autoSyncMgr = do_GetService(NS_AUTOSYNCMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l10.16"></a><span id="l10.16">     if (NS_SUCCEEDED(rv) &amp;&amp; autoSyncMgr) </span>
<a href="#l10.17"></a><span id="l10.17">     {</span>
<a href="#l10.18"></a><span id="l10.18">       // auto-sync manager initialization goes here</span>
<a href="#l10.19"></a><span id="l10.19">       // assign new strategy objects here... </span>
<a href="#l10.20"></a><span id="l10.20">     }</span>
<a href="#l10.21"></a><span id="l10.21">     NS_ASSERTION(autoSyncMgr != nsnull, &quot;*** Cannot initialize nsAutoSyncManager service.&quot;);</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-      </span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+</span>
<a href="#l10.24"></a><span id="l10.24">     gInitialized = PR_TRUE;</span>
<a href="#l10.25"></a><span id="l10.25">   }</span>
<a href="#l10.26"></a><span id="l10.26"> }</span>
<a href="#l10.27"></a><span id="l10.27"> </span>
<a href="#l10.28"></a><span id="l10.28"> nsImapService::~nsImapService()</span>
<a href="#l10.29"></a><span id="l10.29"> {</span>
<a href="#l10.30"></a><span id="l10.30"> }</span>
<a href="#l10.31"></a><span id="l10.31"> </span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-PRUnichar nsImapService::GetHierarchyDelimiter(nsIMsgFolder *aMsgFolder)</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+char nsImapService::GetHierarchyDelimiter(nsIMsgFolder *aMsgFolder)</span>
<a href="#l10.34"></a><span id="l10.34"> {</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-  PRUnichar delimiter = '/';</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+  char delimiter = '/';</span>
<a href="#l10.37"></a><span id="l10.37">   if (aMsgFolder)</span>
<a href="#l10.38"></a><span id="l10.38">   {</span>
<a href="#l10.39"></a><span id="l10.39">     nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(aMsgFolder);</span>
<a href="#l10.40"></a><span id="l10.40">     if (imapFolder)</span>
<a href="#l10.41"></a><span id="l10.41">       imapFolder-&gt;GetHierarchyDelimiter(&amp;delimiter);</span>
<a href="#l10.42"></a><span id="l10.42">   }</span>
<a href="#l10.43"></a><span id="l10.43">   return delimiter;</span>
<a href="#l10.44"></a><span id="l10.44"> }</span>
<a href="#l10.45"></a><span id="l10.45"> </span>
<a href="#l10.46"></a><span id="l10.46"> // N.B., this returns an escaped folder name, appropriate for putting in a url.</span>
<a href="#l10.47"></a><span id="l10.47"> nsresult nsImapService::GetFolderName(nsIMsgFolder *aImapFolder, nsACString &amp;aFolderName)</span>
<a href="#l10.48"></a><span id="l10.48"> {</span>
<a href="#l10.49"></a><span id="l10.49">   nsresult rv;</span>
<a href="#l10.50"></a><span id="l10.50">   nsCOMPtr&lt;nsIMsgImapMailFolder&gt; aFolder(do_QueryInterface(aImapFolder, &amp;rv));</span>
<a href="#l10.51"></a><span id="l10.51">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-  </span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+</span>
<a href="#l10.54"></a><span id="l10.54">   nsCString onlineName;</span>
<a href="#l10.55"></a><span id="l10.55">   // online name is in imap utf-7 - leave it that way</span>
<a href="#l10.56"></a><span id="l10.56">   rv = aFolder-&gt;GetOnlineName(onlineName);</span>
<a href="#l10.57"></a><span id="l10.57">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.58"></a><span id="l10.58">   if (onlineName.IsEmpty())</span>
<a href="#l10.59"></a><span id="l10.59">   {</span>
<a href="#l10.60"></a><span id="l10.60">     nsCString uri;</span>
<a href="#l10.61"></a><span id="l10.61">     rv = aImapFolder-&gt;GetURI(uri);</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineat">@@ -191,17 +191,17 @@ nsresult nsImapService::GetFolderName(ns</span>
<a href="#l10.63"></a><span id="l10.63">     nsCString hostname;</span>
<a href="#l10.64"></a><span id="l10.64">     rv = aImapFolder-&gt;GetHostname(hostname);</span>
<a href="#l10.65"></a><span id="l10.65">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.66"></a><span id="l10.66">     rv = nsImapURI2FullName(kImapRootURI, hostname.get(), uri.get(), getter_Copies(onlineName));</span>
<a href="#l10.67"></a><span id="l10.67">   }</span>
<a href="#l10.68"></a><span id="l10.68">   // if the hierarchy delimiter is not '/', then we want to escape slashes;</span>
<a href="#l10.69"></a><span id="l10.69">   // otherwise, we do want to escape slashes.</span>
<a href="#l10.70"></a><span id="l10.70">   // we want to escape slashes and '^' first, otherwise, nsEscape will lose them</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineminus">-  PRBool escapeSlashes = (GetHierarchyDelimiter(aImapFolder) != (PRUnichar) '/');</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+  PRBool escapeSlashes = (GetHierarchyDelimiter(aImapFolder) != '/');</span>
<a href="#l10.73"></a><span id="l10.73">   if (escapeSlashes &amp;&amp; !onlineName.IsEmpty())</span>
<a href="#l10.74"></a><span id="l10.74">   {</span>
<a href="#l10.75"></a><span id="l10.75">     char* escapedOnlineName;</span>
<a href="#l10.76"></a><span id="l10.76">     rv = nsImapUrl::EscapeSlashes(onlineName.get(), &amp;escapedOnlineName);</span>
<a href="#l10.77"></a><span id="l10.77">     if (NS_SUCCEEDED(rv))</span>
<a href="#l10.78"></a><span id="l10.78">       onlineName.Adopt(escapedOnlineName);</span>
<a href="#l10.79"></a><span id="l10.79">   }</span>
<a href="#l10.80"></a><span id="l10.80">   // need to escape everything else</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineat">@@ -212,61 +212,61 @@ nsresult nsImapService::GetFolderName(ns</span>
<a href="#l10.82"></a><span id="l10.82"> NS_IMETHODIMP nsImapService::SelectFolder(nsIEventTarget *aClientEventTarget, </span>
<a href="#l10.83"></a><span id="l10.83">                                           nsIMsgFolder *aImapMailFolder, </span>
<a href="#l10.84"></a><span id="l10.84">                                           nsIUrlListener *aUrlListener, </span>
<a href="#l10.85"></a><span id="l10.85">                                           nsIMsgWindow *aMsgWindow,</span>
<a href="#l10.86"></a><span id="l10.86">                                           nsIURI **aURL)</span>
<a href="#l10.87"></a><span id="l10.87"> {</span>
<a href="#l10.88"></a><span id="l10.88">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l10.89"></a><span id="l10.89">   NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineminus">-  </span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+</span>
<a href="#l10.92"></a><span id="l10.92">   if (WeAreOffline())</span>
<a href="#l10.93"></a><span id="l10.93">     return NS_MSG_ERROR_OFFLINE;</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineminus">-  </span>
<a href="#l10.95"></a><span id="l10.95" class="difflineplus">+</span>
<a href="#l10.96"></a><span id="l10.96">   PRBool canOpenThisFolder = PR_TRUE;</span>
<a href="#l10.97"></a><span id="l10.97">   nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(aImapMailFolder);</span>
<a href="#l10.98"></a><span id="l10.98">   if (imapFolder)</span>
<a href="#l10.99"></a><span id="l10.99">     imapFolder-&gt;GetCanOpenFolder(&amp;canOpenThisFolder);</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineminus">-  </span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+</span>
<a href="#l10.102"></a><span id="l10.102">   if (!canOpenThisFolder) </span>
<a href="#l10.103"></a><span id="l10.103">     return NS_OK;</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineminus">-  </span>
<a href="#l10.105"></a><span id="l10.105" class="difflineplus">+</span>
<a href="#l10.106"></a><span id="l10.106">   nsresult rv;</span>
<a href="#l10.107"></a><span id="l10.107">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l10.108"></a><span id="l10.108">   nsCAutoString urlSpec;</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineminus">-  PRUnichar hierarchySeparator = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineplus">+  char hierarchyDelimiter = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l10.111"></a><span id="l10.111">   rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl),</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineminus">-                            aImapMailFolder, aUrlListener, urlSpec, hierarchySeparator);</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineplus">+                            aImapMailFolder, aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l10.114"></a><span id="l10.114"> </span>
<a href="#l10.115"></a><span id="l10.115">   if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l10.116"></a><span id="l10.116">   {</span>
<a href="#l10.117"></a><span id="l10.117">     // nsImapUrl::SetSpec() will set the imap action properly</span>
<a href="#l10.118"></a><span id="l10.118">     rv = imapUrl-&gt;SetImapAction(nsIImapUrl::nsImapSelectFolder);</span>
<a href="#l10.119"></a><span id="l10.119"> </span>
<a href="#l10.120"></a><span id="l10.120">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailNewsUrl = do_QueryInterface(imapUrl);</span>
<a href="#l10.121"></a><span id="l10.121">     // if no msg window, we won't put up error messages (this is almost certainly a biff-inspired get new msgs)</span>
<a href="#l10.122"></a><span id="l10.122">     if (!aMsgWindow)</span>
<a href="#l10.123"></a><span id="l10.123">       mailNewsUrl-&gt;SetSuppressErrorMsgs(PR_TRUE);</span>
<a href="#l10.124"></a><span id="l10.124">     mailNewsUrl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l10.125"></a><span id="l10.125">     mailNewsUrl-&gt;SetUpdatingFolder(PR_TRUE);</span>
<a href="#l10.126"></a><span id="l10.126">     rv = SetImapUrlSink(aImapMailFolder, imapUrl);</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineminus">-    </span>
<a href="#l10.128"></a><span id="l10.128" class="difflineplus">+</span>
<a href="#l10.129"></a><span id="l10.129">     if (NS_SUCCEEDED(rv))</span>
<a href="#l10.130"></a><span id="l10.130">     {</span>
<a href="#l10.131"></a><span id="l10.131">       nsCAutoString folderName;</span>
<a href="#l10.132"></a><span id="l10.132">       GetFolderName(aImapMailFolder, folderName);</span>
<a href="#l10.133"></a><span id="l10.133">       urlSpec.Append(&quot;/select&gt;&quot;);</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineminus">-      urlSpec.Append(char(hierarchySeparator));</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineplus">+      urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l10.136"></a><span id="l10.136">       urlSpec.Append(folderName);</span>
<a href="#l10.137"></a><span id="l10.137">       rv = mailNewsUrl-&gt;SetSpec(urlSpec);</span>
<a href="#l10.138"></a><span id="l10.138">       if (NS_SUCCEEDED(rv))</span>
<a href="#l10.139"></a><span id="l10.139">         rv = GetImapConnectionAndLoadUrl(aClientEventTarget, imapUrl, nsnull, aURL);</span>
<a href="#l10.140"></a><span id="l10.140">     }</span>
<a href="#l10.141"></a><span id="l10.141">   } // if we have a url to run....</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineminus">-  </span>
<a href="#l10.143"></a><span id="l10.143" class="difflineplus">+</span>
<a href="#l10.144"></a><span id="l10.144">   return rv;</span>
<a href="#l10.145"></a><span id="l10.145"> }</span>
<a href="#l10.146"></a><span id="l10.146"> </span>
<a href="#l10.147"></a><span id="l10.147"> // lite select, used to verify UIDVALIDITY while going on/offline</span>
<a href="#l10.148"></a><span id="l10.148"> NS_IMETHODIMP nsImapService::LiteSelectFolder(nsIEventTarget *aClientEventTarget, </span>
<a href="#l10.149"></a><span id="l10.149">                                               nsIMsgFolder *aImapMailFolder, </span>
<a href="#l10.150"></a><span id="l10.150">                                               nsIUrlListener *aUrlListener, </span>
<a href="#l10.151"></a><span id="l10.151">                                               nsIURI **aURL)</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineat">@@ -288,30 +288,30 @@ NS_IMETHODIMP nsImapService::GetUrlForUr</span>
<a href="#l10.153"></a><span id="l10.153"> </span>
<a href="#l10.154"></a><span id="l10.154">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l10.155"></a><span id="l10.155">   nsCAutoString msgKey;</span>
<a href="#l10.156"></a><span id="l10.156">   rv = DecomposeImapURI(messageURI, getter_AddRefs(folder), msgKey);</span>
<a href="#l10.157"></a><span id="l10.157">   if (NS_SUCCEEDED(rv))</span>
<a href="#l10.158"></a><span id="l10.158">   {</span>
<a href="#l10.159"></a><span id="l10.159">     nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l10.160"></a><span id="l10.160">     nsCAutoString urlSpec;</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineminus">-    PRUnichar hierarchySeparator = GetHierarchyDelimiter(folder);</span>
<a href="#l10.162"></a><span id="l10.162" class="difflineminus">-    rv = CreateStartOfImapUrl(messageURI, getter_AddRefs(imapUrl), folder, nsnull, urlSpec, hierarchySeparator);</span>
<a href="#l10.163"></a><span id="l10.163" class="difflineplus">+    char hierarchyDelimiter = GetHierarchyDelimiter(folder);</span>
<a href="#l10.164"></a><span id="l10.164" class="difflineplus">+    rv = CreateStartOfImapUrl(messageURI, getter_AddRefs(imapUrl), folder, nsnull, urlSpec, hierarchyDelimiter);</span>
<a href="#l10.165"></a><span id="l10.165">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.166"></a><span id="l10.166">     rv = SetImapUrlSink(folder, imapUrl);</span>
<a href="#l10.167"></a><span id="l10.167">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.168"></a><span id="l10.168">     nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(imapUrl);</span>
<a href="#l10.169"></a><span id="l10.169">     PRBool useLocalCache = PR_FALSE;</span>
<a href="#l10.170"></a><span id="l10.170">     folder-&gt;HasMsgOffline(atoi(msgKey.get()), &amp;useLocalCache);</span>
<a href="#l10.171"></a><span id="l10.171">     mailnewsUrl-&gt;SetMsgIsInLocalCache(useLocalCache);</span>
<a href="#l10.172"></a><span id="l10.172"> </span>
<a href="#l10.173"></a><span id="l10.173">     nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(imapUrl);</span>
<a href="#l10.174"></a><span id="l10.174">     url-&gt;GetSpec(urlSpec);</span>
<a href="#l10.175"></a><span id="l10.175">     urlSpec.Append(&quot;fetch&gt;UID&gt;&quot;);</span>
<a href="#l10.176"></a><span id="l10.176" class="difflineminus">-    urlSpec.Append(char(hierarchySeparator));</span>
<a href="#l10.177"></a><span id="l10.177" class="difflineplus">+    urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l10.178"></a><span id="l10.178"> </span>
<a href="#l10.179"></a><span id="l10.179">     nsCAutoString folderName;</span>
<a href="#l10.180"></a><span id="l10.180">     GetFolderName(folder, folderName);</span>
<a href="#l10.181"></a><span id="l10.181">     urlSpec.Append(folderName);</span>
<a href="#l10.182"></a><span id="l10.182">     urlSpec.Append(&quot;&gt;&quot;);</span>
<a href="#l10.183"></a><span id="l10.183">     urlSpec.Append(msgKey);</span>
<a href="#l10.184"></a><span id="l10.184">     rv = url-&gt;SetSpec(urlSpec);</span>
<a href="#l10.185"></a><span id="l10.185">     imapUrl-&gt;QueryInterface(NS_GET_IID(nsIURI), (void **) aURL);</span>
<a href="#l10.186"></a><span id="l10.186" class="difflineat">@@ -360,60 +360,60 @@ NS_IMETHODIMP nsImapService::OpenAttachm</span>
<a href="#l10.187"></a><span id="l10.187">     nsDependentCString part(partStart);</span>
<a href="#l10.188"></a><span id="l10.188">     uri += &quot;?&quot;;</span>
<a href="#l10.189"></a><span id="l10.189">     uri += Substring(part, 0, part.FindChar('&amp;'));</span>
<a href="#l10.190"></a><span id="l10.190">     uri += &quot;&amp;type=&quot;;</span>
<a href="#l10.191"></a><span id="l10.191">     uri += aContentType;</span>
<a href="#l10.192"></a><span id="l10.192">     uri += &quot;&amp;filename=&quot;;</span>
<a href="#l10.193"></a><span id="l10.193">     uri += aFileName;</span>
<a href="#l10.194"></a><span id="l10.194">   }</span>
<a href="#l10.195"></a><span id="l10.195" class="difflineminus">-  </span>
<a href="#l10.196"></a><span id="l10.196" class="difflineplus">+</span>
<a href="#l10.197"></a><span id="l10.197">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l10.198"></a><span id="l10.198">   nsCAutoString msgKey;</span>
<a href="#l10.199"></a><span id="l10.199">   nsCAutoString uriMimePart;</span>
<a href="#l10.200"></a><span id="l10.200">   nsCAutoString	folderURI;</span>
<a href="#l10.201"></a><span id="l10.201">   nsMsgKey key;</span>
<a href="#l10.202"></a><span id="l10.202" class="difflineminus">-  </span>
<a href="#l10.203"></a><span id="l10.203" class="difflineplus">+</span>
<a href="#l10.204"></a><span id="l10.204">   rv = DecomposeImapURI(uri, getter_AddRefs(folder), msgKey);</span>
<a href="#l10.205"></a><span id="l10.205">   rv = nsParseImapMessageURI(uri.get(), folderURI, &amp;key, getter_Copies(uriMimePart));</span>
<a href="#l10.206"></a><span id="l10.206">   if (NS_SUCCEEDED(rv))</span>
<a href="#l10.207"></a><span id="l10.207">   {</span>
<a href="#l10.208"></a><span id="l10.208">     nsCOMPtr&lt;nsIImapMessageSink&gt; imapMessageSink(do_QueryInterface(folder, &amp;rv));</span>
<a href="#l10.209"></a><span id="l10.209">     if (NS_SUCCEEDED(rv))</span>
<a href="#l10.210"></a><span id="l10.210">     {</span>
<a href="#l10.211"></a><span id="l10.211">       nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l10.212"></a><span id="l10.212">       nsCAutoString urlSpec;</span>
<a href="#l10.213"></a><span id="l10.213" class="difflineminus">-      PRUnichar hierarchySeparator = GetHierarchyDelimiter(folder);</span>
<a href="#l10.214"></a><span id="l10.214" class="difflineminus">-      rv = CreateStartOfImapUrl(uri, getter_AddRefs(imapUrl), folder, aUrlListener, urlSpec, hierarchySeparator);</span>
<a href="#l10.215"></a><span id="l10.215" class="difflineplus">+      char hierarchyDelimiter = GetHierarchyDelimiter(folder);</span>
<a href="#l10.216"></a><span id="l10.216" class="difflineplus">+      rv = CreateStartOfImapUrl(uri, getter_AddRefs(imapUrl), folder, aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l10.217"></a><span id="l10.217">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.218"></a><span id="l10.218" class="difflineminus">-    </span>
<a href="#l10.219"></a><span id="l10.219" class="difflineplus">+</span>
<a href="#l10.220"></a><span id="l10.220">       urlSpec.Append(&quot;/fetch&gt;UID&gt;&quot;);</span>
<a href="#l10.221"></a><span id="l10.221" class="difflineminus">-      urlSpec.Append(char(hierarchySeparator));</span>
<a href="#l10.222"></a><span id="l10.222" class="difflineminus">-    </span>
<a href="#l10.223"></a><span id="l10.223" class="difflineplus">+      urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l10.224"></a><span id="l10.224" class="difflineplus">+</span>
<a href="#l10.225"></a><span id="l10.225">       nsCString folderName;</span>
<a href="#l10.226"></a><span id="l10.226">       GetFolderName(folder, folderName);</span>
<a href="#l10.227"></a><span id="l10.227">       urlSpec.Append(folderName);</span>
<a href="#l10.228"></a><span id="l10.228">       urlSpec.Append(&quot;&gt;&quot;);</span>
<a href="#l10.229"></a><span id="l10.229">       urlSpec.Append(msgKey);</span>
<a href="#l10.230"></a><span id="l10.230">       urlSpec.Append(uriMimePart);</span>
<a href="#l10.231"></a><span id="l10.231" class="difflineminus">-      </span>
<a href="#l10.232"></a><span id="l10.232" class="difflineplus">+</span>
<a href="#l10.233"></a><span id="l10.233">       if (!uriMimePart.IsEmpty())</span>
<a href="#l10.234"></a><span id="l10.234">       {</span>
<a href="#l10.235"></a><span id="l10.235">         nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailUrl (do_QueryInterface(imapUrl));</span>
<a href="#l10.236"></a><span id="l10.236">         if (mailUrl)</span>
<a href="#l10.237"></a><span id="l10.237">         {</span>
<a href="#l10.238"></a><span id="l10.238">           mailUrl-&gt;SetSpec(urlSpec);</span>
<a href="#l10.239"></a><span id="l10.239">           mailUrl-&gt;SetFileName(nsDependentCString(aFileName));</span>
<a href="#l10.240"></a><span id="l10.240">         }</span>
<a href="#l10.241"></a><span id="l10.241">         rv =  FetchMimePart(imapUrl, nsIImapUrl::nsImapOpenMimePart, folder, imapMessageSink,</span>
<a href="#l10.242"></a><span id="l10.242">                             nsnull, aDisplayConsumer, msgKey, uriMimePart);</span>
<a href="#l10.243"></a><span id="l10.243">       }</span>
<a href="#l10.244"></a><span id="l10.244">     } // if we got a message sink</span>
<a href="#l10.245"></a><span id="l10.245">   } // if we parsed the message uri</span>
<a href="#l10.246"></a><span id="l10.246" class="difflineminus">-  </span>
<a href="#l10.247"></a><span id="l10.247" class="difflineplus">+</span>
<a href="#l10.248"></a><span id="l10.248">   return rv;</span>
<a href="#l10.249"></a><span id="l10.249"> }</span>
<a href="#l10.250"></a><span id="l10.250"> </span>
<a href="#l10.251"></a><span id="l10.251"> NS_IMETHODIMP nsImapService::FetchMimePart(nsIURI *aURI, </span>
<a href="#l10.252"></a><span id="l10.252">                                            const char *aMessageURI, </span>
<a href="#l10.253"></a><span id="l10.253">                                            nsISupports *aDisplayConsumer, </span>
<a href="#l10.254"></a><span id="l10.254">                                            nsIMsgWindow *aMsgWindow, </span>
<a href="#l10.255"></a><span id="l10.255">                                            nsIUrlListener *aUrlListener, </span>
<a href="#l10.256"></a><span id="l10.256" class="difflineat">@@ -502,18 +502,18 @@ NS_IMETHODIMP nsImapService::DisplayMess</span>
<a href="#l10.257"></a><span id="l10.257">   rv = nsParseImapMessageURI(aMessageURI, folderURI, &amp;key, getter_Copies(mimePart));</span>
<a href="#l10.258"></a><span id="l10.258">   if (NS_SUCCEEDED(rv))</span>
<a href="#l10.259"></a><span id="l10.259">   {</span>
<a href="#l10.260"></a><span id="l10.260">     nsCOMPtr&lt;nsIImapMessageSink&gt; imapMessageSink(do_QueryInterface(folder, &amp;rv));</span>
<a href="#l10.261"></a><span id="l10.261">     if (NS_SUCCEEDED(rv))</span>
<a href="#l10.262"></a><span id="l10.262">     {</span>
<a href="#l10.263"></a><span id="l10.263">       nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l10.264"></a><span id="l10.264">       nsCAutoString urlSpec;</span>
<a href="#l10.265"></a><span id="l10.265" class="difflineminus">-      PRUnichar hierarchySeparator = GetHierarchyDelimiter(folder);</span>
<a href="#l10.266"></a><span id="l10.266" class="difflineminus">-      rv = CreateStartOfImapUrl(messageURI, getter_AddRefs(imapUrl), folder, aUrlListener, urlSpec, hierarchySeparator);</span>
<a href="#l10.267"></a><span id="l10.267" class="difflineplus">+      char hierarchyDelimiter = GetHierarchyDelimiter(folder);</span>
<a href="#l10.268"></a><span id="l10.268" class="difflineplus">+      rv = CreateStartOfImapUrl(messageURI, getter_AddRefs(imapUrl), folder, aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l10.269"></a><span id="l10.269">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.270"></a><span id="l10.270">       if (!mimePart.IsEmpty())</span>
<a href="#l10.271"></a><span id="l10.271">       {</span>
<a href="#l10.272"></a><span id="l10.272">         return FetchMimePart(imapUrl, nsIImapUrl::nsImapMsgFetch, folder, imapMessageSink,</span>
<a href="#l10.273"></a><span id="l10.273">                              aURL, aDisplayConsumer, msgKey, mimePart);</span>
<a href="#l10.274"></a><span id="l10.274">       }</span>
<a href="#l10.275"></a><span id="l10.275"> </span>
<a href="#l10.276"></a><span id="l10.276">       nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgurl (do_QueryInterface(imapUrl));</span>
<a href="#l10.277"></a><span id="l10.277" class="difflineat">@@ -763,23 +763,22 @@ NS_IMETHODIMP nsImapService::CopyMessage</span>
<a href="#l10.278"></a><span id="l10.278">   rv = DecomposeImapURI(nsDependentCString(aSrcMailboxURI), getter_AddRefs(folder), msgKey);</span>
<a href="#l10.279"></a><span id="l10.279">   if (NS_SUCCEEDED(rv))</span>
<a href="#l10.280"></a><span id="l10.280">   {</span>
<a href="#l10.281"></a><span id="l10.281">     nsCOMPtr&lt;nsIImapMessageSink&gt; imapMessageSink(do_QueryInterface(folder, &amp;rv));</span>
<a href="#l10.282"></a><span id="l10.282">     if (NS_SUCCEEDED(rv))</span>
<a href="#l10.283"></a><span id="l10.283">     {</span>
<a href="#l10.284"></a><span id="l10.284">       nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l10.285"></a><span id="l10.285">       nsCAutoString urlSpec;</span>
<a href="#l10.286"></a><span id="l10.286" class="difflineminus">-      PRUnichar hierarchySeparator = GetHierarchyDelimiter(folder);</span>
<a href="#l10.287"></a><span id="l10.287" class="difflineplus">+      char hierarchyDelimiter = GetHierarchyDelimiter(folder);</span>
<a href="#l10.288"></a><span id="l10.288">       PRBool hasMsgOffline = PR_FALSE;</span>
<a href="#l10.289"></a><span id="l10.289">       nsMsgKey key = atoi(msgKey.get());</span>
<a href="#l10.290"></a><span id="l10.290" class="difflineminus">-      </span>
<a href="#l10.291"></a><span id="l10.291" class="difflineminus">-      rv = CreateStartOfImapUrl(nsDependentCString(aSrcMailboxURI), getter_AddRefs(imapUrl), </span>
<a href="#l10.292"></a><span id="l10.292" class="difflineminus">-                                folder, aUrlListener, urlSpec, hierarchySeparator);</span>
<a href="#l10.293"></a><span id="l10.293" class="difflineminus">-      </span>
<a href="#l10.294"></a><span id="l10.294" class="difflineplus">+</span>
<a href="#l10.295"></a><span id="l10.295" class="difflineplus">+      rv = CreateStartOfImapUrl(nsDependentCString(aSrcMailboxURI), getter_AddRefs(imapUrl),</span>
<a href="#l10.296"></a><span id="l10.296" class="difflineplus">+                                folder, aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l10.297"></a><span id="l10.297">       if (folder)</span>
<a href="#l10.298"></a><span id="l10.298">       {</span>
<a href="#l10.299"></a><span id="l10.299">         nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgurl (do_QueryInterface(imapUrl));</span>
<a href="#l10.300"></a><span id="l10.300">         folder-&gt;HasMsgOffline(key, &amp;hasMsgOffline);</span>
<a href="#l10.301"></a><span id="l10.301">         if (msgurl)</span>
<a href="#l10.302"></a><span id="l10.302">           msgurl-&gt;SetMsgIsInLocalCache(hasMsgOffline);</span>
<a href="#l10.303"></a><span id="l10.303">       }</span>
<a href="#l10.304"></a><span id="l10.304">       // now try to download the message</span>
<a href="#l10.305"></a><span id="l10.305" class="difflineat">@@ -821,18 +820,18 @@ NS_IMETHODIMP nsImapService::CopyMessage</span>
<a href="#l10.306"></a><span id="l10.306">       nsCString uri;</span>
<a href="#l10.307"></a><span id="l10.307">       srcFolder-&gt;GenerateMessageURI(keys[0], uri);</span>
<a href="#l10.308"></a><span id="l10.308"> </span>
<a href="#l10.309"></a><span id="l10.309">       nsCString messageIds;</span>
<a href="#l10.310"></a><span id="l10.310">       PRUint32 numKeys = keys.Length();</span>
<a href="#l10.311"></a><span id="l10.311">       AllocateImapUidString(keys.Elements(), numKeys, nsnull, messageIds);</span>
<a href="#l10.312"></a><span id="l10.312">       nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l10.313"></a><span id="l10.313">       nsCAutoString urlSpec;</span>
<a href="#l10.314"></a><span id="l10.314" class="difflineminus">-      PRUnichar hierarchySeparator = GetHierarchyDelimiter(folder);</span>
<a href="#l10.315"></a><span id="l10.315" class="difflineminus">-      rv = CreateStartOfImapUrl(uri, getter_AddRefs(imapUrl), folder, aUrlListener, urlSpec, hierarchySeparator);</span>
<a href="#l10.316"></a><span id="l10.316" class="difflineplus">+      char hierarchyDelimiter = GetHierarchyDelimiter(folder);</span>
<a href="#l10.317"></a><span id="l10.317" class="difflineplus">+      rv = CreateStartOfImapUrl(uri, getter_AddRefs(imapUrl), folder, aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l10.318"></a><span id="l10.318">       nsImapAction action;</span>
<a href="#l10.319"></a><span id="l10.319">       if (moveMessage) // don't use ?: syntax here, it seems to break the Mac.</span>
<a href="#l10.320"></a><span id="l10.320">         action = nsIImapUrl::nsImapOnlineToOfflineMove;</span>
<a href="#l10.321"></a><span id="l10.321">       else</span>
<a href="#l10.322"></a><span id="l10.322">         action = nsIImapUrl::nsImapOnlineToOfflineCopy;</span>
<a href="#l10.323"></a><span id="l10.323">       imapUrl-&gt;SetCopyState(aMailboxCopy);</span>
<a href="#l10.324"></a><span id="l10.324">       // now try to display the message</span>
<a href="#l10.325"></a><span id="l10.325">       rv = FetchMessage(imapUrl, action, folder, imapMessageSink, aMsgWindow, </span>
<a href="#l10.326"></a><span id="l10.326" class="difflineat">@@ -846,42 +845,42 @@ NS_IMETHODIMP nsImapService::CopyMessage</span>
<a href="#l10.327"></a><span id="l10.327"> </span>
<a href="#l10.328"></a><span id="l10.328"> NS_IMETHODIMP nsImapService::Search(nsIMsgSearchSession *aSearchSession, </span>
<a href="#l10.329"></a><span id="l10.329">                                     nsIMsgWindow *aMsgWindow, </span>
<a href="#l10.330"></a><span id="l10.330">                                     nsIMsgFolder *aMsgFolder, </span>
<a href="#l10.331"></a><span id="l10.331">                                     const char *aSearchUri)</span>
<a href="#l10.332"></a><span id="l10.332"> {</span>
<a href="#l10.333"></a><span id="l10.333">   nsresult rv = NS_OK;</span>
<a href="#l10.334"></a><span id="l10.334">   nsCAutoString	folderURI;</span>
<a href="#l10.335"></a><span id="l10.335" class="difflineminus">-  </span>
<a href="#l10.336"></a><span id="l10.336" class="difflineplus">+</span>
<a href="#l10.337"></a><span id="l10.337">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l10.338"></a><span id="l10.338">   nsCOMPtr &lt;nsIUrlListener&gt; urlListener = do_QueryInterface(aSearchSession);</span>
<a href="#l10.339"></a><span id="l10.339" class="difflineminus">-  </span>
<a href="#l10.340"></a><span id="l10.340" class="difflineplus">+</span>
<a href="#l10.341"></a><span id="l10.341">   nsCAutoString urlSpec;</span>
<a href="#l10.342"></a><span id="l10.342" class="difflineminus">-  PRUnichar hierarchySeparator = GetHierarchyDelimiter(aMsgFolder);</span>
<a href="#l10.343"></a><span id="l10.343" class="difflineplus">+  char hierarchyDelimiter = GetHierarchyDelimiter(aMsgFolder);</span>
<a href="#l10.344"></a><span id="l10.344">   rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), </span>
<a href="#l10.345"></a><span id="l10.345" class="difflineminus">-                            aMsgFolder, urlListener, urlSpec, hierarchySeparator);</span>
<a href="#l10.346"></a><span id="l10.346" class="difflineplus">+                            aMsgFolder, urlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l10.347"></a><span id="l10.347">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.348"></a><span id="l10.348">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgurl (do_QueryInterface(imapUrl));</span>
<a href="#l10.349"></a><span id="l10.349" class="difflineminus">-  </span>
<a href="#l10.350"></a><span id="l10.350" class="difflineplus">+</span>
<a href="#l10.351"></a><span id="l10.351">   msgurl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l10.352"></a><span id="l10.352">   msgurl-&gt;SetSearchSession(aSearchSession);</span>
<a href="#l10.353"></a><span id="l10.353">   rv = SetImapUrlSink(aMsgFolder, imapUrl);</span>
<a href="#l10.354"></a><span id="l10.354" class="difflineminus">-  </span>
<a href="#l10.355"></a><span id="l10.355" class="difflineplus">+</span>
<a href="#l10.356"></a><span id="l10.356">   if (NS_SUCCEEDED(rv))</span>
<a href="#l10.357"></a><span id="l10.357">   {</span>
<a href="#l10.358"></a><span id="l10.358">     nsCString folderName;</span>
<a href="#l10.359"></a><span id="l10.359">     GetFolderName(aMsgFolder, folderName);</span>
<a href="#l10.360"></a><span id="l10.360" class="difflineminus">-    </span>
<a href="#l10.361"></a><span id="l10.361" class="difflineplus">+</span>
<a href="#l10.362"></a><span id="l10.362">     nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailNewsUrl = do_QueryInterface(imapUrl);</span>
<a href="#l10.363"></a><span id="l10.363">     if (!aMsgWindow)</span>
<a href="#l10.364"></a><span id="l10.364">       mailNewsUrl-&gt;SetSuppressErrorMsgs(PR_TRUE);</span>
<a href="#l10.365"></a><span id="l10.365" class="difflineminus">-    </span>
<a href="#l10.366"></a><span id="l10.366" class="difflineplus">+</span>
<a href="#l10.367"></a><span id="l10.367">     urlSpec.Append(&quot;/search&gt;UID&gt;&quot;);</span>
<a href="#l10.368"></a><span id="l10.368" class="difflineminus">-    urlSpec.Append(char(hierarchySeparator));</span>
<a href="#l10.369"></a><span id="l10.369" class="difflineplus">+    urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l10.370"></a><span id="l10.370">     urlSpec.Append(folderName);</span>
<a href="#l10.371"></a><span id="l10.371">     urlSpec.Append('&gt;');</span>
<a href="#l10.372"></a><span id="l10.372">     // escape aSearchUri so that IMAP special characters (i.e. '\')</span>
<a href="#l10.373"></a><span id="l10.373">     // won't be replaced with '/' in NECKO.</span>
<a href="#l10.374"></a><span id="l10.374">     // it will be unescaped in nsImapUrl::ParseUrl().</span>
<a href="#l10.375"></a><span id="l10.375">     char *search_cmd = nsEscape((char *)aSearchUri, url_XAlphas);</span>
<a href="#l10.376"></a><span id="l10.376">     urlSpec.Append(search_cmd);</span>
<a href="#l10.377"></a><span id="l10.377">     NS_Free(search_cmd);</span>
<a href="#l10.378"></a><span id="l10.378" class="difflineat">@@ -947,69 +946,68 @@ NS_IMETHODIMP nsImapService::SaveMessage</span>
<a href="#l10.379"></a><span id="l10.379">                                                nsIURI **aURL,</span>
<a href="#l10.380"></a><span id="l10.380">                                                PRBool canonicalLineEnding,</span>
<a href="#l10.381"></a><span id="l10.381">                                                nsIMsgWindow *aMsgWindow)</span>
<a href="#l10.382"></a><span id="l10.382"> {</span>
<a href="#l10.383"></a><span id="l10.383">   nsresult rv = NS_OK;</span>
<a href="#l10.384"></a><span id="l10.384">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l10.385"></a><span id="l10.385">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l10.386"></a><span id="l10.386">   nsCAutoString msgKey;</span>
<a href="#l10.387"></a><span id="l10.387" class="difflineminus">-  </span>
<a href="#l10.388"></a><span id="l10.388" class="difflineplus">+</span>
<a href="#l10.389"></a><span id="l10.389">   rv = DecomposeImapURI(nsDependentCString(aMessageURI), getter_AddRefs(folder), msgKey);</span>
<a href="#l10.390"></a><span id="l10.390">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.391"></a><span id="l10.391" class="difflineminus">-  </span>
<a href="#l10.392"></a><span id="l10.392" class="difflineplus">+</span>
<a href="#l10.393"></a><span id="l10.393">   PRBool hasMsgOffline = PR_FALSE;</span>
<a href="#l10.394"></a><span id="l10.394" class="difflineminus">-  </span>
<a href="#l10.395"></a><span id="l10.395" class="difflineplus">+</span>
<a href="#l10.396"></a><span id="l10.396">   if (folder)</span>
<a href="#l10.397"></a><span id="l10.397">     folder-&gt;HasMsgOffline(atoi(msgKey.get()), &amp;hasMsgOffline);</span>
<a href="#l10.398"></a><span id="l10.398" class="difflineminus">-  </span>
<a href="#l10.399"></a><span id="l10.399" class="difflineplus">+</span>
<a href="#l10.400"></a><span id="l10.400">   nsCAutoString urlSpec;</span>
<a href="#l10.401"></a><span id="l10.401" class="difflineminus">-  PRUnichar hierarchySeparator = GetHierarchyDelimiter(folder);</span>
<a href="#l10.402"></a><span id="l10.402" class="difflineplus">+  char hierarchyDelimiter = GetHierarchyDelimiter(folder);</span>
<a href="#l10.403"></a><span id="l10.403">   rv = CreateStartOfImapUrl(nsDependentCString(aMessageURI), getter_AddRefs(imapUrl), </span>
<a href="#l10.404"></a><span id="l10.404" class="difflineminus">-                            folder, aUrlListener, urlSpec, hierarchySeparator);</span>
<a href="#l10.405"></a><span id="l10.405" class="difflineplus">+                            folder, aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l10.406"></a><span id="l10.406">   if (NS_SUCCEEDED(rv)) </span>
<a href="#l10.407"></a><span id="l10.407">   {</span>
<a href="#l10.408"></a><span id="l10.408">     nsCOMPtr&lt;nsIImapMessageSink&gt; imapMessageSink(do_QueryInterface(folder, &amp;rv));</span>
<a href="#l10.409"></a><span id="l10.409">     NS_ENSURE_SUCCESS(rv, rv);  </span>
<a href="#l10.410"></a><span id="l10.410">     nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgUrl = do_QueryInterface(imapUrl, &amp;rv);</span>
<a href="#l10.411"></a><span id="l10.411">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.412"></a><span id="l10.412">     msgUrl-&gt;SetMessageFile(aFile);</span>
<a href="#l10.413"></a><span id="l10.413">     msgUrl-&gt;SetAddDummyEnvelope(aAddDummyEnvelope);</span>
<a href="#l10.414"></a><span id="l10.414">     msgUrl-&gt;SetCanonicalLineEnding(canonicalLineEnding);</span>
<a href="#l10.415"></a><span id="l10.415" class="difflineminus">-    </span>
<a href="#l10.416"></a><span id="l10.416" class="difflineplus">+</span>
<a href="#l10.417"></a><span id="l10.417">     nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(msgUrl);</span>
<a href="#l10.418"></a><span id="l10.418">     if (mailnewsUrl)</span>
<a href="#l10.419"></a><span id="l10.419">       mailnewsUrl-&gt;SetMsgIsInLocalCache(hasMsgOffline);</span>
<a href="#l10.420"></a><span id="l10.420" class="difflineminus">-    </span>
<a href="#l10.421"></a><span id="l10.421" class="difflineplus">+</span>
<a href="#l10.422"></a><span id="l10.422">     nsCOMPtr &lt;nsIStreamListener&gt; saveAsListener;</span>
<a href="#l10.423"></a><span id="l10.423">     mailnewsUrl-&gt;GetSaveAsListener(aAddDummyEnvelope, aFile, getter_AddRefs(saveAsListener));</span>
<a href="#l10.424"></a><span id="l10.424" class="difflineminus">-    </span>
<a href="#l10.425"></a><span id="l10.425" class="difflineplus">+</span>
<a href="#l10.426"></a><span id="l10.426">     return FetchMessage(imapUrl, nsIImapUrl::nsImapSaveMessageToDisk, folder, imapMessageSink, </span>
<a href="#l10.427"></a><span id="l10.427">                         aMsgWindow, saveAsListener, msgKey, PR_FALSE, EmptyCString(), aURL);</span>
<a href="#l10.428"></a><span id="l10.428">   }</span>
<a href="#l10.429"></a><span id="l10.429" class="difflineminus">-  </span>
<a href="#l10.430"></a><span id="l10.430">   return rv;</span>
<a href="#l10.431"></a><span id="l10.431"> }</span>
<a href="#l10.432"></a><span id="l10.432"> </span>
<a href="#l10.433"></a><span id="l10.433"> /* fetching RFC822 messages */</span>
<a href="#l10.434"></a><span id="l10.434"> /* imap4://HOST&gt;fetch&gt;&lt;UID&gt;&gt;MAILBOXPATH&gt;x */</span>
<a href="#l10.435"></a><span id="l10.435"> /*   'x' is the message UID */</span>
<a href="#l10.436"></a><span id="l10.436"> /* will set the 'SEEN' flag */</span>
<a href="#l10.437"></a><span id="l10.437"> NS_IMETHODIMP nsImapService::AddImapFetchToUrl(nsIURI *aUrl,</span>
<a href="#l10.438"></a><span id="l10.438">                                                nsIMsgFolder *aImapMailFolder,</span>
<a href="#l10.439"></a><span id="l10.439">                                                const nsACString &amp;aMessageIdentifierList,</span>
<a href="#l10.440"></a><span id="l10.440">                                                const nsACString &amp;aAdditionalHeader)</span>
<a href="#l10.441"></a><span id="l10.441"> {</span>
<a href="#l10.442"></a><span id="l10.442">   nsCAutoString urlSpec;</span>
<a href="#l10.443"></a><span id="l10.443">   aUrl-&gt;GetSpec(urlSpec);</span>
<a href="#l10.444"></a><span id="l10.444"> </span>
<a href="#l10.445"></a><span id="l10.445" class="difflineminus">-  PRUnichar hierarchySeparator = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l10.446"></a><span id="l10.446" class="difflineplus">+  char hierarchyDelimiter = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l10.447"></a><span id="l10.447"> </span>
<a href="#l10.448"></a><span id="l10.448">   urlSpec.Append(&quot;fetch&gt;UID&gt;&quot;);</span>
<a href="#l10.449"></a><span id="l10.449" class="difflineminus">-  urlSpec.Append(char(hierarchySeparator));</span>
<a href="#l10.450"></a><span id="l10.450" class="difflineplus">+  urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l10.451"></a><span id="l10.451"> </span>
<a href="#l10.452"></a><span id="l10.452">   nsCAutoString folderName;</span>
<a href="#l10.453"></a><span id="l10.453">   GetFolderName(aImapMailFolder, folderName);</span>
<a href="#l10.454"></a><span id="l10.454">   urlSpec.Append(folderName);</span>
<a href="#l10.455"></a><span id="l10.455"> </span>
<a href="#l10.456"></a><span id="l10.456">   urlSpec.Append(&quot;&gt;&quot;);</span>
<a href="#l10.457"></a><span id="l10.457">   urlSpec.Append(aMessageIdentifierList);</span>
<a href="#l10.458"></a><span id="l10.458"> </span>
<a href="#l10.459"></a><span id="l10.459" class="difflineat">@@ -1177,47 +1175,46 @@ NS_IMETHODIMP nsImapService::StreamMessa</span>
<a href="#l10.460"></a><span id="l10.460">                                            const nsACString &amp;aAdditionalHeader,</span>
<a href="#l10.461"></a><span id="l10.461">                                            PRBool aLocalOnly,</span>
<a href="#l10.462"></a><span id="l10.462">                                            nsIURI **aURL)</span>
<a href="#l10.463"></a><span id="l10.463"> {</span>
<a href="#l10.464"></a><span id="l10.464">   NS_ENSURE_ARG_POINTER(aMessageURI);</span>
<a href="#l10.465"></a><span id="l10.465">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l10.466"></a><span id="l10.466">   nsCAutoString msgKey;</span>
<a href="#l10.467"></a><span id="l10.467">   nsCAutoString mimePart;</span>
<a href="#l10.468"></a><span id="l10.468" class="difflineminus">-  nsCAutoString	folderURI;</span>
<a href="#l10.469"></a><span id="l10.469" class="difflineplus">+  nsCAutoString folderURI;</span>
<a href="#l10.470"></a><span id="l10.470">   nsMsgKey key;</span>
<a href="#l10.471"></a><span id="l10.471" class="difflineminus">-  </span>
<a href="#l10.472"></a><span id="l10.472" class="difflineplus">+</span>
<a href="#l10.473"></a><span id="l10.473">   nsresult rv = DecomposeImapURI(nsDependentCString(aMessageURI), getter_AddRefs(folder), msgKey);</span>
<a href="#l10.474"></a><span id="l10.474">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.475"></a><span id="l10.475"> </span>
<a href="#l10.476"></a><span id="l10.476">   if (msgKey.IsEmpty())</span>
<a href="#l10.477"></a><span id="l10.477">     return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l10.478"></a><span id="l10.478">   rv = nsParseImapMessageURI(aMessageURI, folderURI, &amp;key, getter_Copies(mimePart));</span>
<a href="#l10.479"></a><span id="l10.479">   if (NS_SUCCEEDED(rv))</span>
<a href="#l10.480"></a><span id="l10.480">   {</span>
<a href="#l10.481"></a><span id="l10.481">     nsCOMPtr&lt;nsIImapMessageSink&gt; imapMessageSink(do_QueryInterface(folder, &amp;rv));</span>
<a href="#l10.482"></a><span id="l10.482">     if (NS_SUCCEEDED(rv))</span>
<a href="#l10.483"></a><span id="l10.483">     {</span>
<a href="#l10.484"></a><span id="l10.484">       nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l10.485"></a><span id="l10.485">       nsCAutoString urlSpec;</span>
<a href="#l10.486"></a><span id="l10.486" class="difflineminus">-      PRUnichar hierarchySeparator = GetHierarchyDelimiter(folder);</span>
<a href="#l10.487"></a><span id="l10.487" class="difflineplus">+      char hierarchyDelimiter = GetHierarchyDelimiter(folder);</span>
<a href="#l10.488"></a><span id="l10.488">       rv = CreateStartOfImapUrl(nsDependentCString(aMessageURI), getter_AddRefs(imapUrl), </span>
<a href="#l10.489"></a><span id="l10.489" class="difflineminus">-                                folder, aUrlListener, urlSpec, hierarchySeparator);</span>
<a href="#l10.490"></a><span id="l10.490" class="difflineplus">+                                folder, aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l10.491"></a><span id="l10.491">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.492"></a><span id="l10.492">       nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgurl (do_QueryInterface(imapUrl));</span>
<a href="#l10.493"></a><span id="l10.493">       nsCOMPtr&lt;nsIURI&gt; url(do_QueryInterface(imapUrl));</span>
<a href="#l10.494"></a><span id="l10.494"> </span>
<a href="#l10.495"></a><span id="l10.495">       // We need to add the fetch command here for the cache lookup to behave correctly</span>
<a href="#l10.496"></a><span id="l10.496">       rv = AddImapFetchToUrl(url, folder, msgKey, aAdditionalHeader);</span>
<a href="#l10.497"></a><span id="l10.497">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.498"></a><span id="l10.498"> </span>
<a href="#l10.499"></a><span id="l10.499">       nsCOMPtr&lt;nsIMsgIncomingServer&gt; aMsgIncomingServer;</span>
<a href="#l10.500"></a><span id="l10.500" class="difflineminus">-      </span>
<a href="#l10.501"></a><span id="l10.501" class="difflineplus">+</span>
<a href="#l10.502"></a><span id="l10.502">       msgurl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l10.503"></a><span id="l10.503" class="difflineminus">-      </span>
<a href="#l10.504"></a><span id="l10.504">       rv = msgurl-&gt;GetServer(getter_AddRefs(aMsgIncomingServer));</span>
<a href="#l10.505"></a><span id="l10.505"> </span>
<a href="#l10.506"></a><span id="l10.506">       // Try to check if the message is offline</span>
<a href="#l10.507"></a><span id="l10.507">       PRBool hasMsgOffline = PR_FALSE;</span>
<a href="#l10.508"></a><span id="l10.508">       folder-&gt;HasMsgOffline(key, &amp;hasMsgOffline);</span>
<a href="#l10.509"></a><span id="l10.509">       msgurl-&gt;SetMsgIsInLocalCache(hasMsgOffline);</span>
<a href="#l10.510"></a><span id="l10.510"> </span>
<a href="#l10.511"></a><span id="l10.511">       // If we don't have the message available locally, and we can't get it over</span>
<a href="#l10.512"></a><span id="l10.512" class="difflineat">@@ -1291,66 +1288,66 @@ NS_IMETHODIMP nsImapService::IsMsgInMemC</span>
<a href="#l10.513"></a><span id="l10.513">   return NS_OK;</span>
<a href="#l10.514"></a><span id="l10.514"> }</span>
<a href="#l10.515"></a><span id="l10.515"> </span>
<a href="#l10.516"></a><span id="l10.516"> nsresult nsImapService::CreateStartOfImapUrl(const nsACString &amp;aImapURI, </span>
<a href="#l10.517"></a><span id="l10.517">                                              nsIImapUrl **imapUrl,</span>
<a href="#l10.518"></a><span id="l10.518">                                              nsIMsgFolder *aImapMailFolder,</span>
<a href="#l10.519"></a><span id="l10.519">                                              nsIUrlListener *aUrlListener,</span>
<a href="#l10.520"></a><span id="l10.520">                                              nsACString &amp;urlSpec, </span>
<a href="#l10.521"></a><span id="l10.521" class="difflineminus">-                                             PRUnichar &amp;hierarchyDelimiter)</span>
<a href="#l10.522"></a><span id="l10.522" class="difflineplus">+                                             char &amp;hierarchyDelimiter)</span>
<a href="#l10.523"></a><span id="l10.523"> {</span>
<a href="#l10.524"></a><span id="l10.524">   nsresult rv = NS_OK;</span>
<a href="#l10.525"></a><span id="l10.525">   nsCString hostname;</span>
<a href="#l10.526"></a><span id="l10.526">   nsCString username;</span>
<a href="#l10.527"></a><span id="l10.527">   nsCString escapedUsername;</span>
<a href="#l10.528"></a><span id="l10.528" class="difflineminus">-  </span>
<a href="#l10.529"></a><span id="l10.529" class="difflineplus">+</span>
<a href="#l10.530"></a><span id="l10.530">   rv = aImapMailFolder-&gt;GetHostname(hostname);</span>
<a href="#l10.531"></a><span id="l10.531">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.532"></a><span id="l10.532">   rv = aImapMailFolder-&gt;GetUsername(username);</span>
<a href="#l10.533"></a><span id="l10.533">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.534"></a><span id="l10.534"> </span>
<a href="#l10.535"></a><span id="l10.535">   if (!username.IsEmpty())</span>
<a href="#l10.536"></a><span id="l10.536">     *((char **)getter_Copies(escapedUsername)) = nsEscape(username.get(), url_XAlphas);</span>
<a href="#l10.537"></a><span id="l10.537" class="difflineminus">-  </span>
<a href="#l10.538"></a><span id="l10.538" class="difflineplus">+</span>
<a href="#l10.539"></a><span id="l10.539">   PRInt32 port = nsIImapUrl::DEFAULT_IMAP_PORT;</span>
<a href="#l10.540"></a><span id="l10.540">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l10.541"></a><span id="l10.541">   rv = aImapMailFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l10.542"></a><span id="l10.542">   if (NS_SUCCEEDED(rv)) </span>
<a href="#l10.543"></a><span id="l10.543">   {</span>
<a href="#l10.544"></a><span id="l10.544">     server-&gt;GetPort(&amp;port);</span>
<a href="#l10.545"></a><span id="l10.545">     if (port == -1 || port == 0) port = nsIImapUrl::DEFAULT_IMAP_PORT;</span>
<a href="#l10.546"></a><span id="l10.546">   }</span>
<a href="#l10.547"></a><span id="l10.547" class="difflineminus">-  </span>
<a href="#l10.548"></a><span id="l10.548" class="difflineplus">+</span>
<a href="#l10.549"></a><span id="l10.549">   // now we need to create an imap url to load into the connection. The url</span>
<a href="#l10.550"></a><span id="l10.550">   // needs to represent a select folder action. </span>
<a href="#l10.551"></a><span id="l10.551">   rv = CallCreateInstance(kImapUrlCID, imapUrl);</span>
<a href="#l10.552"></a><span id="l10.552">   if (NS_SUCCEEDED(rv) &amp;&amp; *imapUrl)</span>
<a href="#l10.553"></a><span id="l10.553">   {</span>
<a href="#l10.554"></a><span id="l10.554">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(*imapUrl, &amp;rv);</span>
<a href="#l10.555"></a><span id="l10.555">     if (NS_SUCCEEDED(rv) &amp;&amp; mailnewsUrl &amp;&amp; aUrlListener)</span>
<a href="#l10.556"></a><span id="l10.556">       mailnewsUrl-&gt;RegisterListener(aUrlListener);</span>
<a href="#l10.557"></a><span id="l10.557">     nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgurl(do_QueryInterface(*imapUrl));</span>
<a href="#l10.558"></a><span id="l10.558">     (*imapUrl)-&gt;SetExternalLinkUrl(PR_FALSE);</span>
<a href="#l10.559"></a><span id="l10.559">     msgurl-&gt;SetUri(nsDependentCString(aImapURI).get());</span>
<a href="#l10.560"></a><span id="l10.560" class="difflineminus">-    </span>
<a href="#l10.561"></a><span id="l10.561" class="difflineplus">+</span>
<a href="#l10.562"></a><span id="l10.562">     urlSpec = &quot;imap://&quot;;</span>
<a href="#l10.563"></a><span id="l10.563">     urlSpec.Append(escapedUsername);</span>
<a href="#l10.564"></a><span id="l10.564">     urlSpec.Append('@');</span>
<a href="#l10.565"></a><span id="l10.565">     urlSpec.Append(hostname);</span>
<a href="#l10.566"></a><span id="l10.566">     urlSpec.Append(':');</span>
<a href="#l10.567"></a><span id="l10.567" class="difflineminus">-    </span>
<a href="#l10.568"></a><span id="l10.568" class="difflineplus">+</span>
<a href="#l10.569"></a><span id="l10.569">     nsCAutoString portStr;</span>
<a href="#l10.570"></a><span id="l10.570">     portStr.AppendInt(port);</span>
<a href="#l10.571"></a><span id="l10.571">     urlSpec.Append(portStr);</span>
<a href="#l10.572"></a><span id="l10.572" class="difflineminus">-    </span>
<a href="#l10.573"></a><span id="l10.573" class="difflineplus">+</span>
<a href="#l10.574"></a><span id="l10.574">     // *** jefft - force to parse the urlSpec in order to search for</span>
<a href="#l10.575"></a><span id="l10.575">     // the correct incoming server</span>
<a href="#l10.576"></a><span id="l10.576">     rv = mailnewsUrl-&gt;SetSpec(urlSpec);</span>
<a href="#l10.577"></a><span id="l10.577" class="difflineminus">-    </span>
<a href="#l10.578"></a><span id="l10.578" class="difflineplus">+</span>
<a href="#l10.579"></a><span id="l10.579">     hierarchyDelimiter = kOnlineHierarchySeparatorUnknown;</span>
<a href="#l10.580"></a><span id="l10.580">     nsCOMPtr &lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(aImapMailFolder);</span>
<a href="#l10.581"></a><span id="l10.581">     if (imapFolder)</span>
<a href="#l10.582"></a><span id="l10.582">       imapFolder-&gt;GetHierarchyDelimiter(&amp;hierarchyDelimiter);</span>
<a href="#l10.583"></a><span id="l10.583">   }</span>
<a href="#l10.584"></a><span id="l10.584">   return rv;</span>
<a href="#l10.585"></a><span id="l10.585"> }</span>
<a href="#l10.586"></a><span id="l10.586"> </span>
<a href="#l10.587"></a><span id="l10.587" class="difflineat">@@ -1368,42 +1365,42 @@ NS_IMETHODIMP nsImapService::GetHeaders(</span>
<a href="#l10.588"></a><span id="l10.588">   // create a protocol instance to handle the request.</span>
<a href="#l10.589"></a><span id="l10.589">   // NOTE: once we start working with multiple connections, this step will be much more complicated...but for now</span>
<a href="#l10.590"></a><span id="l10.590">   // just create a connection and process the request.</span>
<a href="#l10.591"></a><span id="l10.591">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l10.592"></a><span id="l10.592">   NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l10.593"></a><span id="l10.593"> </span>
<a href="#l10.594"></a><span id="l10.594">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l10.595"></a><span id="l10.595">   nsCAutoString urlSpec;</span>
<a href="#l10.596"></a><span id="l10.596" class="difflineminus">-  PRUnichar hierarchySeparator = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l10.597"></a><span id="l10.597" class="difflineminus">-  </span>
<a href="#l10.598"></a><span id="l10.598" class="difflineplus">+  char hierarchyDelimiter = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l10.599"></a><span id="l10.599" class="difflineplus">+</span>
<a href="#l10.600"></a><span id="l10.600">   nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), aImapMailFolder, </span>
<a href="#l10.601"></a><span id="l10.601" class="difflineminus">-                                     aUrlListener, urlSpec, hierarchySeparator);</span>
<a href="#l10.602"></a><span id="l10.602" class="difflineplus">+                                     aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l10.603"></a><span id="l10.603">   if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l10.604"></a><span id="l10.604">   {</span>
<a href="#l10.605"></a><span id="l10.605">     nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(imapUrl);</span>
<a href="#l10.606"></a><span id="l10.606" class="difflineminus">-    </span>
<a href="#l10.607"></a><span id="l10.607" class="difflineplus">+</span>
<a href="#l10.608"></a><span id="l10.608">     rv = imapUrl-&gt;SetImapAction(nsIImapUrl::nsImapMsgFetch);</span>
<a href="#l10.609"></a><span id="l10.609">     rv = SetImapUrlSink(aImapMailFolder, imapUrl);</span>
<a href="#l10.610"></a><span id="l10.610" class="difflineminus">-    </span>
<a href="#l10.611"></a><span id="l10.611" class="difflineplus">+</span>
<a href="#l10.612"></a><span id="l10.612">     if (NS_SUCCEEDED(rv))</span>
<a href="#l10.613"></a><span id="l10.613">     {</span>
<a href="#l10.614"></a><span id="l10.614">       urlSpec.Append(&quot;/header&gt;&quot;);</span>
<a href="#l10.615"></a><span id="l10.615">       urlSpec.Append(messageIdsAreUID ? uidString : sequenceString);</span>
<a href="#l10.616"></a><span id="l10.616">       urlSpec.Append(&quot;&gt;&quot;);</span>
<a href="#l10.617"></a><span id="l10.617" class="difflineminus">-      urlSpec.Append(char (hierarchySeparator));</span>
<a href="#l10.618"></a><span id="l10.618" class="difflineminus">-      </span>
<a href="#l10.619"></a><span id="l10.619" class="difflineplus">+      urlSpec.Append(char (hierarchyDelimiter));</span>
<a href="#l10.620"></a><span id="l10.620" class="difflineplus">+</span>
<a href="#l10.621"></a><span id="l10.621">       nsCString folderName;</span>
<a href="#l10.622"></a><span id="l10.622" class="difflineminus">-      </span>
<a href="#l10.623"></a><span id="l10.623" class="difflineplus">+</span>
<a href="#l10.624"></a><span id="l10.624">       GetFolderName(aImapMailFolder, folderName);</span>
<a href="#l10.625"></a><span id="l10.625">       urlSpec.Append(folderName);</span>
<a href="#l10.626"></a><span id="l10.626">       urlSpec.Append(&quot;&gt;&quot;);</span>
<a href="#l10.627"></a><span id="l10.627">       urlSpec.Append(messageIdentifierList);</span>
<a href="#l10.628"></a><span id="l10.628">       rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l10.629"></a><span id="l10.629" class="difflineminus">-      </span>
<a href="#l10.630"></a><span id="l10.630" class="difflineplus">+</span>
<a href="#l10.631"></a><span id="l10.631">       if (NS_SUCCEEDED(rv))</span>
<a href="#l10.632"></a><span id="l10.632">         rv = GetImapConnectionAndLoadUrl(aClientEventTarget, imapUrl, nsnull, aURL);</span>
<a href="#l10.633"></a><span id="l10.633">     }</span>
<a href="#l10.634"></a><span id="l10.634">   }</span>
<a href="#l10.635"></a><span id="l10.635">   return rv;</span>
<a href="#l10.636"></a><span id="l10.636"> }</span>
<a href="#l10.637"></a><span id="l10.637"> </span>
<a href="#l10.638"></a><span id="l10.638"> </span>
<a href="#l10.639"></a><span id="l10.639" class="difflineat">@@ -1416,40 +1413,39 @@ NS_IMETHODIMP nsImapService::GetBodyStar</span>
<a href="#l10.640"></a><span id="l10.640">                                           nsIMsgFolder *aImapMailFolder, </span>
<a href="#l10.641"></a><span id="l10.641">                                           nsIUrlListener *aUrlListener, </span>
<a href="#l10.642"></a><span id="l10.642">                                           const nsACString &amp;messageIdentifierList,</span>
<a href="#l10.643"></a><span id="l10.643">                                           PRInt32 numBytes,</span>
<a href="#l10.644"></a><span id="l10.644">                                           nsIURI **aURL)</span>
<a href="#l10.645"></a><span id="l10.645"> {</span>
<a href="#l10.646"></a><span id="l10.646">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l10.647"></a><span id="l10.647">   NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l10.648"></a><span id="l10.648" class="difflineminus">-  </span>
<a href="#l10.649"></a><span id="l10.649" class="difflineplus">+</span>
<a href="#l10.650"></a><span id="l10.650">   nsresult rv;</span>
<a href="#l10.651"></a><span id="l10.651">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l10.652"></a><span id="l10.652">   nsCAutoString urlSpec;</span>
<a href="#l10.653"></a><span id="l10.653"> </span>
<a href="#l10.654"></a><span id="l10.654" class="difflineminus">-  PRUnichar hierarchySeparator = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l10.655"></a><span id="l10.655" class="difflineplus">+  char hierarchyDelimiter = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l10.656"></a><span id="l10.656">   rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), aImapMailFolder, </span>
<a href="#l10.657"></a><span id="l10.657" class="difflineminus">-    aUrlListener, urlSpec, hierarchySeparator);</span>
<a href="#l10.658"></a><span id="l10.658" class="difflineplus">+    aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l10.659"></a><span id="l10.659">   if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l10.660"></a><span id="l10.660">   {</span>
<a href="#l10.661"></a><span id="l10.661">     rv = imapUrl-&gt;SetImapAction(nsIImapUrl::nsImapMsgPreview);</span>
<a href="#l10.662"></a><span id="l10.662">     rv = SetImapUrlSink(aImapMailFolder, imapUrl);</span>
<a href="#l10.663"></a><span id="l10.663" class="difflineminus">-    </span>
<a href="#l10.664"></a><span id="l10.664" class="difflineplus">+</span>
<a href="#l10.665"></a><span id="l10.665">     if (NS_SUCCEEDED(rv))</span>
<a href="#l10.666"></a><span id="l10.666">     {</span>
<a href="#l10.667"></a><span id="l10.667">       nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(imapUrl);</span>
<a href="#l10.668"></a><span id="l10.668" class="difflineminus">-      </span>
<a href="#l10.669"></a><span id="l10.669" class="difflineplus">+</span>
<a href="#l10.670"></a><span id="l10.670">       urlSpec.Append(&quot;/previewBody&gt;&quot;);</span>
<a href="#l10.671"></a><span id="l10.671">       urlSpec.Append(uidString);</span>
<a href="#l10.672"></a><span id="l10.672">       urlSpec.Append(&quot;&gt;&quot;);</span>
<a href="#l10.673"></a><span id="l10.673" class="difflineminus">-      urlSpec.Append(char (hierarchySeparator));</span>
<a href="#l10.674"></a><span id="l10.674" class="difflineminus">-      </span>
<a href="#l10.675"></a><span id="l10.675" class="difflineplus">+      urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l10.676"></a><span id="l10.676" class="difflineplus">+</span>
<a href="#l10.677"></a><span id="l10.677">       nsCString folderName;</span>
<a href="#l10.678"></a><span id="l10.678" class="difflineminus">-      </span>
<a href="#l10.679"></a><span id="l10.679">       GetFolderName(aImapMailFolder, folderName);</span>
<a href="#l10.680"></a><span id="l10.680">       urlSpec.Append(folderName);</span>
<a href="#l10.681"></a><span id="l10.681">       urlSpec.Append(&quot;&gt;&quot;);</span>
<a href="#l10.682"></a><span id="l10.682">       urlSpec.Append(messageIdentifierList);</span>
<a href="#l10.683"></a><span id="l10.683">       urlSpec.Append(&quot;&gt;&quot;);</span>
<a href="#l10.684"></a><span id="l10.684">       urlSpec.AppendInt(numBytes);</span>
<a href="#l10.685"></a><span id="l10.685">       rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l10.686"></a><span id="l10.686">       if (NS_SUCCEEDED(rv))</span>
<a href="#l10.687"></a><span id="l10.687" class="difflineat">@@ -1464,39 +1460,38 @@ nsresult nsImapService::FolderCommand(ns</span>
<a href="#l10.688"></a><span id="l10.688">                                       nsIUrlListener *urlListener,</span>
<a href="#l10.689"></a><span id="l10.689">                                       const char *aCommand,</span>
<a href="#l10.690"></a><span id="l10.690">                                       nsImapAction imapAction,</span>
<a href="#l10.691"></a><span id="l10.691">                                       nsIMsgWindow *msgWindow,</span>
<a href="#l10.692"></a><span id="l10.692">                                       nsIURI **url)</span>
<a href="#l10.693"></a><span id="l10.693"> {</span>
<a href="#l10.694"></a><span id="l10.694">   NS_ENSURE_ARG_POINTER(imapMailFolder);</span>
<a href="#l10.695"></a><span id="l10.695">   NS_ENSURE_ARG_POINTER(clientEventTarget);</span>
<a href="#l10.696"></a><span id="l10.696" class="difflineminus">-  </span>
<a href="#l10.697"></a><span id="l10.697" class="difflineplus">+</span>
<a href="#l10.698"></a><span id="l10.698">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l10.699"></a><span id="l10.699">   nsCAutoString urlSpec;</span>
<a href="#l10.700"></a><span id="l10.700" class="difflineminus">-  </span>
<a href="#l10.701"></a><span id="l10.701" class="difflineminus">-  PRUnichar hierarchySeparator = GetHierarchyDelimiter(imapMailFolder);</span>
<a href="#l10.702"></a><span id="l10.702" class="difflineplus">+</span>
<a href="#l10.703"></a><span id="l10.703" class="difflineplus">+  char hierarchyDelimiter = GetHierarchyDelimiter(imapMailFolder);</span>
<a href="#l10.704"></a><span id="l10.704">   nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl),</span>
<a href="#l10.705"></a><span id="l10.705" class="difflineminus">-                                     imapMailFolder, urlListener, urlSpec, hierarchySeparator);</span>
<a href="#l10.706"></a><span id="l10.706" class="difflineplus">+                                     imapMailFolder, urlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l10.707"></a><span id="l10.707">   if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l10.708"></a><span id="l10.708">   {</span>
<a href="#l10.709"></a><span id="l10.709">     rv = imapUrl-&gt;SetImapAction(imapAction);</span>
<a href="#l10.710"></a><span id="l10.710">     rv = SetImapUrlSink(imapMailFolder, imapUrl);</span>
<a href="#l10.711"></a><span id="l10.711">     nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(imapUrl);</span>
<a href="#l10.712"></a><span id="l10.712">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(imapUrl);</span>
<a href="#l10.713"></a><span id="l10.713">     if (mailnewsurl)</span>
<a href="#l10.714"></a><span id="l10.714">       mailnewsurl-&gt;SetMsgWindow(msgWindow);</span>
<a href="#l10.715"></a><span id="l10.715" class="difflineminus">-    </span>
<a href="#l10.716"></a><span id="l10.716" class="difflineplus">+</span>
<a href="#l10.717"></a><span id="l10.717">     if (NS_SUCCEEDED(rv))</span>
<a href="#l10.718"></a><span id="l10.718">     {</span>
<a href="#l10.719"></a><span id="l10.719">       urlSpec.Append(aCommand);</span>
<a href="#l10.720"></a><span id="l10.720" class="difflineminus">-      urlSpec.Append(char(hierarchySeparator));</span>
<a href="#l10.721"></a><span id="l10.721" class="difflineminus">-      </span>
<a href="#l10.722"></a><span id="l10.722" class="difflineplus">+      urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l10.723"></a><span id="l10.723" class="difflineplus">+</span>
<a href="#l10.724"></a><span id="l10.724">       nsCString folderName;</span>
<a href="#l10.725"></a><span id="l10.725" class="difflineminus">-      </span>
<a href="#l10.726"></a><span id="l10.726">       GetFolderName(imapMailFolder, folderName);</span>
<a href="#l10.727"></a><span id="l10.727">       urlSpec.Append(folderName);</span>
<a href="#l10.728"></a><span id="l10.728">       rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l10.729"></a><span id="l10.729">       if (NS_SUCCEEDED(rv))</span>
<a href="#l10.730"></a><span id="l10.730">         rv = GetImapConnectionAndLoadUrl(clientEventTarget, imapUrl, nsnull, url);</span>
<a href="#l10.731"></a><span id="l10.731">     }</span>
<a href="#l10.732"></a><span id="l10.732">   }</span>
<a href="#l10.733"></a><span id="l10.733">   return rv;</span>
<a href="#l10.734"></a><span id="l10.734" class="difflineat">@@ -1504,17 +1499,17 @@ nsresult nsImapService::FolderCommand(ns</span>
<a href="#l10.735"></a><span id="l10.735"> </span>
<a href="#l10.736"></a><span id="l10.736"> NS_IMETHODIMP</span>
<a href="#l10.737"></a><span id="l10.737"> nsImapService::VerifyLogon(nsIMsgFolder *aFolder, nsIUrlListener *aUrlListener,</span>
<a href="#l10.738"></a><span id="l10.738">                            nsIMsgWindow *aMsgWindow, nsIURI **aURL)</span>
<a href="#l10.739"></a><span id="l10.739"> {</span>
<a href="#l10.740"></a><span id="l10.740">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l10.741"></a><span id="l10.741">   nsCAutoString urlSpec;</span>
<a href="#l10.742"></a><span id="l10.742"> </span>
<a href="#l10.743"></a><span id="l10.743" class="difflineminus">-  PRUnichar delimiter = '/'; // shouldn't matter what is is.</span>
<a href="#l10.744"></a><span id="l10.744" class="difflineplus">+  char delimiter = '/'; // shouldn't matter what is is.</span>
<a href="#l10.745"></a><span id="l10.745">   nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), aFolder,</span>
<a href="#l10.746"></a><span id="l10.746">                                      aUrlListener, urlSpec, delimiter);</span>
<a href="#l10.747"></a><span id="l10.747">   if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l10.748"></a><span id="l10.748">   {</span>
<a href="#l10.749"></a><span id="l10.749">     nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(imapUrl);</span>
<a href="#l10.750"></a><span id="l10.750"> </span>
<a href="#l10.751"></a><span id="l10.751">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailNewsUrl = do_QueryInterface(imapUrl);</span>
<a href="#l10.752"></a><span id="l10.752">     mailNewsUrl-&gt;SetSuppressErrorMsgs(PR_TRUE);</span>
<a href="#l10.753"></a><span id="l10.753" class="difflineat">@@ -1569,29 +1564,29 @@ NS_IMETHODIMP nsImapService::Biff(nsIEve</span>
<a href="#l10.754"></a><span id="l10.754"> {</span>
<a href="#l10.755"></a><span id="l10.755">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l10.756"></a><span id="l10.756">   NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l10.757"></a><span id="l10.757"> </span>
<a href="#l10.758"></a><span id="l10.758">   // static const char *formatString = &quot;biff&gt;%c%s&gt;%ld&quot;;</span>
<a href="#l10.759"></a><span id="l10.759">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l10.760"></a><span id="l10.760">   nsCAutoString urlSpec;</span>
<a href="#l10.761"></a><span id="l10.761"> </span>
<a href="#l10.762"></a><span id="l10.762" class="difflineminus">-  PRUnichar hierarchySeparator = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l10.763"></a><span id="l10.763" class="difflineplus">+  char hierarchyDelimiter = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l10.764"></a><span id="l10.764">   nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl),</span>
<a href="#l10.765"></a><span id="l10.765" class="difflineminus">-    aImapMailFolder, aUrlListener, urlSpec, hierarchySeparator);</span>
<a href="#l10.766"></a><span id="l10.766" class="difflineplus">+    aImapMailFolder, aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l10.767"></a><span id="l10.767">   if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l10.768"></a><span id="l10.768">   {</span>
<a href="#l10.769"></a><span id="l10.769">     rv = imapUrl-&gt;SetImapAction(nsIImapUrl::nsImapExpungeFolder);</span>
<a href="#l10.770"></a><span id="l10.770">     rv = SetImapUrlSink(aImapMailFolder, imapUrl);</span>
<a href="#l10.771"></a><span id="l10.771"> </span>
<a href="#l10.772"></a><span id="l10.772">     nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(imapUrl);</span>
<a href="#l10.773"></a><span id="l10.773">     if (NS_SUCCEEDED(rv))</span>
<a href="#l10.774"></a><span id="l10.774">     {</span>
<a href="#l10.775"></a><span id="l10.775">       urlSpec.Append(&quot;/Biff&gt;&quot;);</span>
<a href="#l10.776"></a><span id="l10.776" class="difflineminus">-      urlSpec.Append(char(hierarchySeparator));</span>
<a href="#l10.777"></a><span id="l10.777" class="difflineplus">+      urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l10.778"></a><span id="l10.778"> </span>
<a href="#l10.779"></a><span id="l10.779">       nsCString folderName;</span>
<a href="#l10.780"></a><span id="l10.780">       GetFolderName(aImapMailFolder, folderName);</span>
<a href="#l10.781"></a><span id="l10.781">       urlSpec.Append(folderName);</span>
<a href="#l10.782"></a><span id="l10.782">       urlSpec.Append(&quot;&gt;&quot;);</span>
<a href="#l10.783"></a><span id="l10.783">       urlSpec.AppendInt(uidHighWater);</span>
<a href="#l10.784"></a><span id="l10.784">       rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l10.785"></a><span id="l10.785">       if (NS_SUCCEEDED(rv))</span>
<a href="#l10.786"></a><span id="l10.786" class="difflineat">@@ -1627,43 +1622,42 @@ NS_IMETHODIMP nsImapService::DeleteMessa</span>
<a href="#l10.787"></a><span id="l10.787">                                             nsIMsgFolder *aImapMailFolder, </span>
<a href="#l10.788"></a><span id="l10.788">                                             nsIUrlListener *aUrlListener, </span>
<a href="#l10.789"></a><span id="l10.789">                                             nsIURI **aURL,</span>
<a href="#l10.790"></a><span id="l10.790">                                             const nsACString &amp;messageIdentifierList,</span>
<a href="#l10.791"></a><span id="l10.791">                                             PRBool messageIdsAreUID)</span>
<a href="#l10.792"></a><span id="l10.792"> {</span>
<a href="#l10.793"></a><span id="l10.793">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l10.794"></a><span id="l10.794">   NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l10.795"></a><span id="l10.795" class="difflineminus">-  </span>
<a href="#l10.796"></a><span id="l10.796" class="difflineplus">+</span>
<a href="#l10.797"></a><span id="l10.797">   // create a protocol instance to handle the request.</span>
<a href="#l10.798"></a><span id="l10.798">   // NOTE: once we start working with multiple connections, this step will be much more complicated...but for now</span>
<a href="#l10.799"></a><span id="l10.799">   // just create a connection and process the request.</span>
<a href="#l10.800"></a><span id="l10.800">   nsresult rv;</span>
<a href="#l10.801"></a><span id="l10.801">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l10.802"></a><span id="l10.802">   nsCAutoString urlSpec;</span>
<a href="#l10.803"></a><span id="l10.803"> </span>
<a href="#l10.804"></a><span id="l10.804" class="difflineminus">-  PRUnichar hierarchySeparator = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l10.805"></a><span id="l10.805" class="difflineplus">+  char hierarchyDelimiter = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l10.806"></a><span id="l10.806">   rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), aImapMailFolder, </span>
<a href="#l10.807"></a><span id="l10.807" class="difflineminus">-    aUrlListener, urlSpec, hierarchySeparator);</span>
<a href="#l10.808"></a><span id="l10.808" class="difflineplus">+    aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l10.809"></a><span id="l10.809">   if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l10.810"></a><span id="l10.810">   {</span>
<a href="#l10.811"></a><span id="l10.811">     rv = imapUrl-&gt;SetImapAction(nsIImapUrl::nsImapMsgFetch);</span>
<a href="#l10.812"></a><span id="l10.812">     rv = SetImapUrlSink(aImapMailFolder, imapUrl);</span>
<a href="#l10.813"></a><span id="l10.813" class="difflineminus">-    </span>
<a href="#l10.814"></a><span id="l10.814" class="difflineplus">+</span>
<a href="#l10.815"></a><span id="l10.815">     if (NS_SUCCEEDED(rv))</span>
<a href="#l10.816"></a><span id="l10.816">     {</span>
<a href="#l10.817"></a><span id="l10.817">       nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(imapUrl);</span>
<a href="#l10.818"></a><span id="l10.818" class="difflineminus">-      </span>
<a href="#l10.819"></a><span id="l10.819" class="difflineplus">+</span>
<a href="#l10.820"></a><span id="l10.820">       urlSpec.Append(&quot;/deletemsg&gt;&quot;);</span>
<a href="#l10.821"></a><span id="l10.821">       urlSpec.Append(messageIdsAreUID ? uidString : sequenceString);</span>
<a href="#l10.822"></a><span id="l10.822">       urlSpec.Append(&quot;&gt;&quot;);</span>
<a href="#l10.823"></a><span id="l10.823" class="difflineminus">-      urlSpec.Append(char (hierarchySeparator));</span>
<a href="#l10.824"></a><span id="l10.824" class="difflineminus">-      </span>
<a href="#l10.825"></a><span id="l10.825" class="difflineplus">+      urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l10.826"></a><span id="l10.826" class="difflineplus">+</span>
<a href="#l10.827"></a><span id="l10.827">       nsCString folderName;</span>
<a href="#l10.828"></a><span id="l10.828" class="difflineminus">-      </span>
<a href="#l10.829"></a><span id="l10.829">       GetFolderName(aImapMailFolder, folderName);</span>
<a href="#l10.830"></a><span id="l10.830">       urlSpec.Append(folderName);</span>
<a href="#l10.831"></a><span id="l10.831">       urlSpec.Append(&quot;&gt;&quot;);</span>
<a href="#l10.832"></a><span id="l10.832">       urlSpec.Append(messageIdentifierList);</span>
<a href="#l10.833"></a><span id="l10.833">       rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l10.834"></a><span id="l10.834">       if (NS_SUCCEEDED(rv))</span>
<a href="#l10.835"></a><span id="l10.835">         rv = GetImapConnectionAndLoadUrl(aClientEventTarget, imapUrl, nsnull, aURL);</span>
<a href="#l10.836"></a><span id="l10.836">     }</span>
<a href="#l10.837"></a><span id="l10.837" class="difflineat">@@ -1723,42 +1717,42 @@ nsresult nsImapService::DiddleFlags(nsIE</span>
<a href="#l10.838"></a><span id="l10.838">                                     nsIURI **aURL,</span>
<a href="#l10.839"></a><span id="l10.839">                                     const nsACString &amp;messageIdentifierList,</span>
<a href="#l10.840"></a><span id="l10.840">                                     const char *howToDiddle,</span>
<a href="#l10.841"></a><span id="l10.841">                                     imapMessageFlagsType flags,</span>
<a href="#l10.842"></a><span id="l10.842">                                     PRBool messageIdsAreUID)</span>
<a href="#l10.843"></a><span id="l10.843"> {</span>
<a href="#l10.844"></a><span id="l10.844">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l10.845"></a><span id="l10.845">   NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l10.846"></a><span id="l10.846" class="difflineminus">-  </span>
<a href="#l10.847"></a><span id="l10.847" class="difflineplus">+</span>
<a href="#l10.848"></a><span id="l10.848">   // create a protocol instance to handle the request.</span>
<a href="#l10.849"></a><span id="l10.849">   // NOTE: once we start working with multiple connections, </span>
<a href="#l10.850"></a><span id="l10.850">   //       this step will be much more complicated...but for now</span>
<a href="#l10.851"></a><span id="l10.851">   // just create a connection and process the request.</span>
<a href="#l10.852"></a><span id="l10.852">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l10.853"></a><span id="l10.853">   nsCAutoString urlSpec;</span>
<a href="#l10.854"></a><span id="l10.854" class="difflineminus">-  </span>
<a href="#l10.855"></a><span id="l10.855" class="difflineminus">-  PRUnichar hierarchySeparator = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l10.856"></a><span id="l10.856" class="difflineplus">+</span>
<a href="#l10.857"></a><span id="l10.857" class="difflineplus">+  char hierarchyDelimiter = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l10.858"></a><span id="l10.858">   nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl),</span>
<a href="#l10.859"></a><span id="l10.859" class="difflineminus">-                                     aImapMailFolder, aUrlListener, urlSpec, hierarchySeparator); </span>
<a href="#l10.860"></a><span id="l10.860" class="difflineplus">+                                     aImapMailFolder, aUrlListener, urlSpec, hierarchyDelimiter); </span>
<a href="#l10.861"></a><span id="l10.861">   if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l10.862"></a><span id="l10.862">   {</span>
<a href="#l10.863"></a><span id="l10.863">     rv = imapUrl-&gt;SetImapAction(nsIImapUrl::nsImapMsgFetch);</span>
<a href="#l10.864"></a><span id="l10.864">     rv = SetImapUrlSink(aImapMailFolder, imapUrl);</span>
<a href="#l10.865"></a><span id="l10.865" class="difflineminus">-    </span>
<a href="#l10.866"></a><span id="l10.866" class="difflineplus">+</span>
<a href="#l10.867"></a><span id="l10.867">     if (NS_SUCCEEDED(rv))</span>
<a href="#l10.868"></a><span id="l10.868">     {</span>
<a href="#l10.869"></a><span id="l10.869">       nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(imapUrl);</span>
<a href="#l10.870"></a><span id="l10.870" class="difflineminus">-      </span>
<a href="#l10.871"></a><span id="l10.871" class="difflineplus">+</span>
<a href="#l10.872"></a><span id="l10.872">       urlSpec.Append('/');</span>
<a href="#l10.873"></a><span id="l10.873">       urlSpec.Append(howToDiddle);</span>
<a href="#l10.874"></a><span id="l10.874">       urlSpec.Append('&gt;');</span>
<a href="#l10.875"></a><span id="l10.875">       urlSpec.Append(messageIdsAreUID ? uidString : sequenceString);</span>
<a href="#l10.876"></a><span id="l10.876">       urlSpec.Append(&quot;&gt;&quot;);</span>
<a href="#l10.877"></a><span id="l10.877" class="difflineminus">-      urlSpec.Append(char(hierarchySeparator));</span>
<a href="#l10.878"></a><span id="l10.878" class="difflineplus">+      urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l10.879"></a><span id="l10.879">       nsCString folderName;</span>
<a href="#l10.880"></a><span id="l10.880">       GetFolderName(aImapMailFolder, folderName);</span>
<a href="#l10.881"></a><span id="l10.881">       urlSpec.Append(folderName);</span>
<a href="#l10.882"></a><span id="l10.882">       urlSpec.Append(&quot;&gt;&quot;);</span>
<a href="#l10.883"></a><span id="l10.883">       urlSpec.Append(messageIdentifierList);</span>
<a href="#l10.884"></a><span id="l10.884">       urlSpec.Append('&gt;');</span>
<a href="#l10.885"></a><span id="l10.885">       urlSpec.AppendInt(flags);</span>
<a href="#l10.886"></a><span id="l10.886">       rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l10.887"></a><span id="l10.887" class="difflineat">@@ -1803,111 +1797,108 @@ nsresult nsImapService::SetImapUrlSink(n</span>
<a href="#l10.888"></a><span id="l10.888"> NS_IMETHODIMP nsImapService::DiscoverAllFolders(nsIEventTarget *aClientEventTarget,</span>
<a href="#l10.889"></a><span id="l10.889">                                                 nsIMsgFolder *aImapMailFolder,</span>
<a href="#l10.890"></a><span id="l10.890">                                                 nsIUrlListener *aUrlListener,</span>
<a href="#l10.891"></a><span id="l10.891">                                                 nsIMsgWindow *aMsgWindow,</span>
<a href="#l10.892"></a><span id="l10.892">                                                 nsIURI **aURL)</span>
<a href="#l10.893"></a><span id="l10.893"> {</span>
<a href="#l10.894"></a><span id="l10.894">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l10.895"></a><span id="l10.895">   NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l10.896"></a><span id="l10.896" class="difflineminus">-  </span>
<a href="#l10.897"></a><span id="l10.897" class="difflineplus">+</span>
<a href="#l10.898"></a><span id="l10.898">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l10.899"></a><span id="l10.899">   nsCAutoString urlSpec;</span>
<a href="#l10.900"></a><span id="l10.900"> </span>
<a href="#l10.901"></a><span id="l10.901" class="difflineminus">-  PRUnichar hierarchySeparator = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l10.902"></a><span id="l10.902" class="difflineplus">+  char hierarchyDelimiter = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l10.903"></a><span id="l10.903">   nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), aImapMailFolder, </span>
<a href="#l10.904"></a><span id="l10.904" class="difflineminus">-                                     aUrlListener, urlSpec, hierarchySeparator);</span>
<a href="#l10.905"></a><span id="l10.905" class="difflineplus">+                                     aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l10.906"></a><span id="l10.906">   if (NS_SUCCEEDED (rv))</span>
<a href="#l10.907"></a><span id="l10.907">   {</span>
<a href="#l10.908"></a><span id="l10.908">     rv = SetImapUrlSink(aImapMailFolder, imapUrl);</span>
<a href="#l10.909"></a><span id="l10.909"> </span>
<a href="#l10.910"></a><span id="l10.910">     if (NS_SUCCEEDED(rv))</span>
<a href="#l10.911"></a><span id="l10.911">     {</span>
<a href="#l10.912"></a><span id="l10.912">       nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(imapUrl);</span>
<a href="#l10.913"></a><span id="l10.913">       nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(imapUrl);</span>
<a href="#l10.914"></a><span id="l10.914">       if (mailnewsurl)</span>
<a href="#l10.915"></a><span id="l10.915">         mailnewsurl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l10.916"></a><span id="l10.916">       urlSpec.Append(&quot;/discoverallboxes&quot;);</span>
<a href="#l10.917"></a><span id="l10.917">       nsCOMPtr &lt;nsIURI&gt; url = do_QueryInterface(imapUrl, &amp;rv);</span>
<a href="#l10.918"></a><span id="l10.918" class="difflineminus">-		  rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l10.919"></a><span id="l10.919" class="difflineplus">+      rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l10.920"></a><span id="l10.920">       if (NS_SUCCEEDED(rv))</span>
<a href="#l10.921"></a><span id="l10.921">         rv = GetImapConnectionAndLoadUrl(aClientEventTarget, imapUrl, nsnull, aURL);</span>
<a href="#l10.922"></a><span id="l10.922">     }</span>
<a href="#l10.923"></a><span id="l10.923">   }</span>
<a href="#l10.924"></a><span id="l10.924">   return rv;</span>
<a href="#l10.925"></a><span id="l10.925"> }</span>
<a href="#l10.926"></a><span id="l10.926"> </span>
<a href="#l10.927"></a><span id="l10.927"> NS_IMETHODIMP nsImapService::DiscoverAllAndSubscribedFolders(nsIEventTarget *aClientEventTarget,</span>
<a href="#l10.928"></a><span id="l10.928">                                                              nsIMsgFolder *aImapMailFolder,</span>
<a href="#l10.929"></a><span id="l10.929">                                                              nsIUrlListener *aUrlListener,</span>
<a href="#l10.930"></a><span id="l10.930">                                                              nsIURI **aURL)</span>
<a href="#l10.931"></a><span id="l10.931"> {</span>
<a href="#l10.932"></a><span id="l10.932">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l10.933"></a><span id="l10.933">   NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l10.934"></a><span id="l10.934" class="difflineminus">-  </span>
<a href="#l10.935"></a><span id="l10.935" class="difflineplus">+</span>
<a href="#l10.936"></a><span id="l10.936">   nsCOMPtr&lt;nsIImapUrl&gt; aImapUrl;</span>
<a href="#l10.937"></a><span id="l10.937">   nsCAutoString urlSpec;</span>
<a href="#l10.938"></a><span id="l10.938" class="difflineminus">-  </span>
<a href="#l10.939"></a><span id="l10.939" class="difflineminus">-  PRUnichar hierarchySeparator = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l10.940"></a><span id="l10.940" class="difflineplus">+</span>
<a href="#l10.941"></a><span id="l10.941" class="difflineplus">+  char hierarchyDelimiter = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l10.942"></a><span id="l10.942">   nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(aImapUrl), aImapMailFolder,</span>
<a href="#l10.943"></a><span id="l10.943" class="difflineminus">-                                     aUrlListener, urlSpec, hierarchySeparator);</span>
<a href="#l10.944"></a><span id="l10.944" class="difflineplus">+                                     aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l10.945"></a><span id="l10.945">   if (NS_SUCCEEDED(rv) &amp;&amp; aImapUrl)</span>
<a href="#l10.946"></a><span id="l10.946">   {</span>
<a href="#l10.947"></a><span id="l10.947">     rv = SetImapUrlSink(aImapMailFolder, aImapUrl);</span>
<a href="#l10.948"></a><span id="l10.948">     if (NS_SUCCEEDED(rv))</span>
<a href="#l10.949"></a><span id="l10.949">     {</span>
<a href="#l10.950"></a><span id="l10.950">       nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(aImapUrl);</span>
<a href="#l10.951"></a><span id="l10.951" class="difflineminus">-      </span>
<a href="#l10.952"></a><span id="l10.952">       urlSpec.Append(&quot;/discoverallandsubscribedboxes&quot;);</span>
<a href="#l10.953"></a><span id="l10.953" class="difflineminus">-			rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l10.954"></a><span id="l10.954" class="difflineplus">+      rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l10.955"></a><span id="l10.955">       if (NS_SUCCEEDED(rv))</span>
<a href="#l10.956"></a><span id="l10.956">         rv = GetImapConnectionAndLoadUrl(aClientEventTarget, aImapUrl, nsnull, aURL);</span>
<a href="#l10.957"></a><span id="l10.957">     }</span>
<a href="#l10.958"></a><span id="l10.958">   }</span>
<a href="#l10.959"></a><span id="l10.959">   return rv;</span>
<a href="#l10.960"></a><span id="l10.960"> }</span>
<a href="#l10.961"></a><span id="l10.961"> </span>
<a href="#l10.962"></a><span id="l10.962"> NS_IMETHODIMP nsImapService::DiscoverChildren(nsIEventTarget *aClientEventTarget,</span>
<a href="#l10.963"></a><span id="l10.963">                                               nsIMsgFolder *aImapMailFolder,</span>
<a href="#l10.964"></a><span id="l10.964">                                               nsIUrlListener *aUrlListener,</span>
<a href="#l10.965"></a><span id="l10.965">                                               const nsACString &amp;folderPath,</span>
<a href="#l10.966"></a><span id="l10.966">                                               nsIURI **aURL)</span>
<a href="#l10.967"></a><span id="l10.967"> {</span>
<a href="#l10.968"></a><span id="l10.968">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l10.969"></a><span id="l10.969">   NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l10.970"></a><span id="l10.970" class="difflineminus">-  </span>
<a href="#l10.971"></a><span id="l10.971" class="difflineplus">+</span>
<a href="#l10.972"></a><span id="l10.972">   nsCOMPtr&lt;nsIImapUrl&gt; aImapUrl;</span>
<a href="#l10.973"></a><span id="l10.973">   nsCAutoString urlSpec;</span>
<a href="#l10.974"></a><span id="l10.974" class="difflineminus">-  </span>
<a href="#l10.975"></a><span id="l10.975" class="difflineminus">-  PRUnichar hierarchySeparator = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l10.976"></a><span id="l10.976" class="difflineplus">+</span>
<a href="#l10.977"></a><span id="l10.977" class="difflineplus">+  char hierarchyDelimiter = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l10.978"></a><span id="l10.978">   nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(aImapUrl), aImapMailFolder, </span>
<a href="#l10.979"></a><span id="l10.979" class="difflineminus">-                                     aUrlListener, urlSpec, hierarchySeparator);</span>
<a href="#l10.980"></a><span id="l10.980" class="difflineplus">+                                     aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l10.981"></a><span id="l10.981">   if (NS_SUCCEEDED (rv))</span>
<a href="#l10.982"></a><span id="l10.982">   {</span>
<a href="#l10.983"></a><span id="l10.983">     rv = SetImapUrlSink(aImapMailFolder, aImapUrl);</span>
<a href="#l10.984"></a><span id="l10.984" class="difflineminus">-    </span>
<a href="#l10.985"></a><span id="l10.985">     if (NS_SUCCEEDED(rv))</span>
<a href="#l10.986"></a><span id="l10.986">     {</span>
<a href="#l10.987"></a><span id="l10.987">       if (!folderPath.IsEmpty())</span>
<a href="#l10.988"></a><span id="l10.988">       {</span>
<a href="#l10.989"></a><span id="l10.989">         nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(aImapUrl);</span>
<a href="#l10.990"></a><span id="l10.990" class="difflineminus">-        </span>
<a href="#l10.991"></a><span id="l10.991">         urlSpec.Append(&quot;/discoverchildren&gt;&quot;);</span>
<a href="#l10.992"></a><span id="l10.992" class="difflineminus">-        urlSpec.Append(char(hierarchySeparator));</span>
<a href="#l10.993"></a><span id="l10.993" class="difflineplus">+        urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l10.994"></a><span id="l10.994">         urlSpec.Append(folderPath);</span>
<a href="#l10.995"></a><span id="l10.995">         rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l10.996"></a><span id="l10.996" class="difflineminus">-        </span>
<a href="#l10.997"></a><span id="l10.997" class="difflineplus">+</span>
<a href="#l10.998"></a><span id="l10.998">         // Make sure the uri has the same hierarchy separator as the one in msg folder </span>
<a href="#l10.999"></a><span id="l10.999">         // obj if it's not kOnlineHierarchySeparatorUnknown (ie, '^').</span>
<a href="#l10.1000"></a><span id="l10.1000">         char uriDelimiter;</span>
<a href="#l10.1001"></a><span id="l10.1001">         nsresult rv1 = aImapUrl-&gt;GetOnlineSubDirSeparator(&amp;uriDelimiter);</span>
<a href="#l10.1002"></a><span id="l10.1002" class="difflineminus">-        if (NS_SUCCEEDED (rv1) &amp;&amp; hierarchySeparator != kOnlineHierarchySeparatorUnknown &amp;&amp;</span>
<a href="#l10.1003"></a><span id="l10.1003" class="difflineminus">-            uriDelimiter != hierarchySeparator)</span>
<a href="#l10.1004"></a><span id="l10.1004" class="difflineminus">-          aImapUrl-&gt;SetOnlineSubDirSeparator((char)hierarchySeparator);</span>
<a href="#l10.1005"></a><span id="l10.1005" class="difflineminus">-        </span>
<a href="#l10.1006"></a><span id="l10.1006" class="difflineplus">+        if (NS_SUCCEEDED (rv1) &amp;&amp; hierarchyDelimiter != kOnlineHierarchySeparatorUnknown &amp;&amp;</span>
<a href="#l10.1007"></a><span id="l10.1007" class="difflineplus">+            uriDelimiter != hierarchyDelimiter)</span>
<a href="#l10.1008"></a><span id="l10.1008" class="difflineplus">+          aImapUrl-&gt;SetOnlineSubDirSeparator(hierarchyDelimiter);</span>
<a href="#l10.1009"></a><span id="l10.1009" class="difflineplus">+</span>
<a href="#l10.1010"></a><span id="l10.1010">         if (NS_SUCCEEDED(rv))</span>
<a href="#l10.1011"></a><span id="l10.1011">           rv = GetImapConnectionAndLoadUrl(aClientEventTarget, aImapUrl, nsnull, aURL);</span>
<a href="#l10.1012"></a><span id="l10.1012">       }</span>
<a href="#l10.1013"></a><span id="l10.1013">       else</span>
<a href="#l10.1014"></a><span id="l10.1014">         rv = NS_ERROR_FAILURE;</span>
<a href="#l10.1015"></a><span id="l10.1015">     }</span>
<a href="#l10.1016"></a><span id="l10.1016">   }</span>
<a href="#l10.1017"></a><span id="l10.1017">   return rv;</span>
<a href="#l10.1018"></a><span id="l10.1018" class="difflineat">@@ -1922,75 +1913,75 @@ NS_IMETHODIMP nsImapService::OnlineMessa</span>
<a href="#l10.1019"></a><span id="l10.1019">                                                nsIUrlListener *aUrlListener,</span>
<a href="#l10.1020"></a><span id="l10.1020">                                                nsIURI **aURL,</span>
<a href="#l10.1021"></a><span id="l10.1021">                                                nsISupports *copyState,</span>
<a href="#l10.1022"></a><span id="l10.1022">                                                nsIMsgWindow *aMsgWindow)</span>
<a href="#l10.1023"></a><span id="l10.1023"> {</span>
<a href="#l10.1024"></a><span id="l10.1024">   NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l10.1025"></a><span id="l10.1025">   NS_ENSURE_ARG_POINTER(aSrcFolder);</span>
<a href="#l10.1026"></a><span id="l10.1026">   NS_ENSURE_ARG_POINTER(aDstFolder);</span>
<a href="#l10.1027"></a><span id="l10.1027" class="difflineminus">-  </span>
<a href="#l10.1028"></a><span id="l10.1028" class="difflineplus">+</span>
<a href="#l10.1029"></a><span id="l10.1029">   nsresult rv;</span>
<a href="#l10.1030"></a><span id="l10.1030">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; srcServer;</span>
<a href="#l10.1031"></a><span id="l10.1031">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; dstServer;</span>
<a href="#l10.1032"></a><span id="l10.1032" class="difflineminus">-  </span>
<a href="#l10.1033"></a><span id="l10.1033" class="difflineplus">+</span>
<a href="#l10.1034"></a><span id="l10.1034">   rv = aSrcFolder-&gt;GetServer(getter_AddRefs(srcServer));</span>
<a href="#l10.1035"></a><span id="l10.1035">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1036"></a><span id="l10.1036" class="difflineminus">-  </span>
<a href="#l10.1037"></a><span id="l10.1037" class="difflineplus">+</span>
<a href="#l10.1038"></a><span id="l10.1038">   rv = aDstFolder-&gt;GetServer(getter_AddRefs(dstServer));</span>
<a href="#l10.1039"></a><span id="l10.1039">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1040"></a><span id="l10.1040" class="difflineminus">-  </span>
<a href="#l10.1041"></a><span id="l10.1041" class="difflineplus">+</span>
<a href="#l10.1042"></a><span id="l10.1042">   PRBool sameServer;</span>
<a href="#l10.1043"></a><span id="l10.1043">   rv = dstServer-&gt;Equals(srcServer, &amp;sameServer);</span>
<a href="#l10.1044"></a><span id="l10.1044">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1045"></a><span id="l10.1045" class="difflineminus">-  </span>
<a href="#l10.1046"></a><span id="l10.1046" class="difflineplus">+</span>
<a href="#l10.1047"></a><span id="l10.1047">   if (!sameServer) </span>
<a href="#l10.1048"></a><span id="l10.1048">   {</span>
<a href="#l10.1049"></a><span id="l10.1049">     NS_ASSERTION(PR_FALSE, &quot;can't use this method to copy across servers&quot;);</span>
<a href="#l10.1050"></a><span id="l10.1050">     // *** can only take message from the same imap host and user accnt</span>
<a href="#l10.1051"></a><span id="l10.1051">     return NS_ERROR_FAILURE;</span>
<a href="#l10.1052"></a><span id="l10.1052">   }</span>
<a href="#l10.1053"></a><span id="l10.1053" class="difflineminus">-  </span>
<a href="#l10.1054"></a><span id="l10.1054" class="difflineplus">+</span>
<a href="#l10.1055"></a><span id="l10.1055">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l10.1056"></a><span id="l10.1056">   nsCAutoString urlSpec;</span>
<a href="#l10.1057"></a><span id="l10.1057" class="difflineminus">-  </span>
<a href="#l10.1058"></a><span id="l10.1058" class="difflineminus">-  PRUnichar hierarchySeparator = GetHierarchyDelimiter(aSrcFolder);</span>
<a href="#l10.1059"></a><span id="l10.1059" class="difflineminus">-  rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), aSrcFolder, aUrlListener, urlSpec, hierarchySeparator);</span>
<a href="#l10.1060"></a><span id="l10.1060" class="difflineplus">+</span>
<a href="#l10.1061"></a><span id="l10.1061" class="difflineplus">+  char hierarchyDelimiter = GetHierarchyDelimiter(aSrcFolder);</span>
<a href="#l10.1062"></a><span id="l10.1062" class="difflineplus">+  rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), aSrcFolder, aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l10.1063"></a><span id="l10.1063">   if (NS_SUCCEEDED(rv))</span>
<a href="#l10.1064"></a><span id="l10.1064">   {</span>
<a href="#l10.1065"></a><span id="l10.1065">     SetImapUrlSink(aSrcFolder, imapUrl);</span>
<a href="#l10.1066"></a><span id="l10.1066">     imapUrl-&gt;SetCopyState(copyState);</span>
<a href="#l10.1067"></a><span id="l10.1067" class="difflineminus">-    </span>
<a href="#l10.1068"></a><span id="l10.1068" class="difflineplus">+</span>
<a href="#l10.1069"></a><span id="l10.1069">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgurl (do_QueryInterface(imapUrl));</span>
<a href="#l10.1070"></a><span id="l10.1070" class="difflineminus">-    </span>
<a href="#l10.1071"></a><span id="l10.1071" class="difflineplus">+</span>
<a href="#l10.1072"></a><span id="l10.1072">     msgurl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l10.1073"></a><span id="l10.1073">     nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(imapUrl);</span>
<a href="#l10.1074"></a><span id="l10.1074" class="difflineminus">-    </span>
<a href="#l10.1075"></a><span id="l10.1075" class="difflineplus">+</span>
<a href="#l10.1076"></a><span id="l10.1076">     if (isMove)</span>
<a href="#l10.1077"></a><span id="l10.1077">       urlSpec.Append(&quot;/onlinemove&gt;&quot;);</span>
<a href="#l10.1078"></a><span id="l10.1078">     else</span>
<a href="#l10.1079"></a><span id="l10.1079">       urlSpec.Append(&quot;/onlinecopy&gt;&quot;);</span>
<a href="#l10.1080"></a><span id="l10.1080">     if (idsAreUids)</span>
<a href="#l10.1081"></a><span id="l10.1081">       urlSpec.Append(uidString);</span>
<a href="#l10.1082"></a><span id="l10.1082">     else</span>
<a href="#l10.1083"></a><span id="l10.1083">       urlSpec.Append(sequenceString);</span>
<a href="#l10.1084"></a><span id="l10.1084">     urlSpec.Append('&gt;');</span>
<a href="#l10.1085"></a><span id="l10.1085" class="difflineminus">-    urlSpec.Append(char(hierarchySeparator));</span>
<a href="#l10.1086"></a><span id="l10.1086" class="difflineminus">-    </span>
<a href="#l10.1087"></a><span id="l10.1087" class="difflineplus">+    urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l10.1088"></a><span id="l10.1088" class="difflineplus">+</span>
<a href="#l10.1089"></a><span id="l10.1089">     nsCString folderName;</span>
<a href="#l10.1090"></a><span id="l10.1090">     GetFolderName(aSrcFolder, folderName);</span>
<a href="#l10.1091"></a><span id="l10.1091">     urlSpec.Append(folderName);</span>
<a href="#l10.1092"></a><span id="l10.1092">     urlSpec.Append('&gt;');</span>
<a href="#l10.1093"></a><span id="l10.1093">     urlSpec.Append(messageIds);</span>
<a href="#l10.1094"></a><span id="l10.1094">     urlSpec.Append('&gt;');</span>
<a href="#l10.1095"></a><span id="l10.1095" class="difflineminus">-    urlSpec.Append(char(hierarchySeparator));</span>
<a href="#l10.1096"></a><span id="l10.1096" class="difflineplus">+    urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l10.1097"></a><span id="l10.1097">     folderName.Adopt(strdup(&quot;&quot;));</span>
<a href="#l10.1098"></a><span id="l10.1098">     GetFolderName(aDstFolder, folderName);</span>
<a href="#l10.1099"></a><span id="l10.1099">     urlSpec.Append(folderName);</span>
<a href="#l10.1100"></a><span id="l10.1100" class="difflineminus">-    </span>
<a href="#l10.1101"></a><span id="l10.1101" class="difflineplus">+</span>
<a href="#l10.1102"></a><span id="l10.1102">     rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l10.1103"></a><span id="l10.1103">     if (NS_SUCCEEDED(rv))</span>
<a href="#l10.1104"></a><span id="l10.1104">       rv = GetImapConnectionAndLoadUrl(aClientEventTarget, imapUrl, nsnull, aURL);</span>
<a href="#l10.1105"></a><span id="l10.1105">   }</span>
<a href="#l10.1106"></a><span id="l10.1106">   return rv;</span>
<a href="#l10.1107"></a><span id="l10.1107"> }</span>
<a href="#l10.1108"></a><span id="l10.1108"> </span>
<a href="#l10.1109"></a><span id="l10.1109"> nsresult nsImapService::OfflineAppendFromFile(nsIFile *aFile,</span>
<a href="#l10.1110"></a><span id="l10.1110" class="difflineat">@@ -2005,17 +1996,17 @@ nsresult nsImapService::OfflineAppendFro</span>
<a href="#l10.1111"></a><span id="l10.1111">   nsCOMPtr&lt;nsIMsgDatabase&gt; destDB;</span>
<a href="#l10.1112"></a><span id="l10.1112">   nsresult rv = aDstFolder-&gt;GetMsgDatabase(getter_AddRefs(destDB));</span>
<a href="#l10.1113"></a><span id="l10.1113">   // ### might need to send some notifications instead of just returning</span>
<a href="#l10.1114"></a><span id="l10.1114"> </span>
<a href="#l10.1115"></a><span id="l10.1115">   if (NS_SUCCEEDED(rv) &amp;&amp; destDB)</span>
<a href="#l10.1116"></a><span id="l10.1116">   {</span>
<a href="#l10.1117"></a><span id="l10.1117">     nsMsgKey fakeKey;</span>
<a href="#l10.1118"></a><span id="l10.1118">     destDB-&gt;GetNextFakeOfflineMsgKey(&amp;fakeKey);</span>
<a href="#l10.1119"></a><span id="l10.1119" class="difflineminus">-    </span>
<a href="#l10.1120"></a><span id="l10.1120" class="difflineplus">+</span>
<a href="#l10.1121"></a><span id="l10.1121">     nsCOMPtr &lt;nsIMsgOfflineImapOperation&gt; op;</span>
<a href="#l10.1122"></a><span id="l10.1122">     rv = destDB-&gt;GetOfflineOpForKey(fakeKey, PR_TRUE, getter_AddRefs(op));</span>
<a href="#l10.1123"></a><span id="l10.1123">     if (NS_SUCCEEDED(rv) &amp;&amp; op)</span>
<a href="#l10.1124"></a><span id="l10.1124">     {</span>
<a href="#l10.1125"></a><span id="l10.1125">       nsCString destFolderUri;</span>
<a href="#l10.1126"></a><span id="l10.1126">       aDstFolder-&gt;GetURI(destFolderUri);</span>
<a href="#l10.1127"></a><span id="l10.1127">       op-&gt;SetOperation(nsIMsgOfflineImapOperation::kAppendDraft); // ### do we care if it's a template?</span>
<a href="#l10.1128"></a><span id="l10.1128">       op-&gt;SetDestinationFolderURI(destFolderUri.get());</span>
<a href="#l10.1129"></a><span id="l10.1129" class="difflineat">@@ -2114,49 +2105,49 @@ NS_IMETHODIMP nsImapService::AppendMessa</span>
<a href="#l10.1130"></a><span id="l10.1130">                                                    nsIUrlListener *aListener,</span>
<a href="#l10.1131"></a><span id="l10.1131">                                                    nsIURI **aURL,</span>
<a href="#l10.1132"></a><span id="l10.1132">                                                    nsISupports *aCopyState,</span>
<a href="#l10.1133"></a><span id="l10.1133">                                                    nsIMsgWindow *aMsgWindow)</span>
<a href="#l10.1134"></a><span id="l10.1134"> {</span>
<a href="#l10.1135"></a><span id="l10.1135">   NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l10.1136"></a><span id="l10.1136">   NS_ENSURE_ARG_POINTER(aFile);</span>
<a href="#l10.1137"></a><span id="l10.1137">   NS_ENSURE_ARG_POINTER(aDstFolder);</span>
<a href="#l10.1138"></a><span id="l10.1138" class="difflineminus">-  </span>
<a href="#l10.1139"></a><span id="l10.1139" class="difflineplus">+</span>
<a href="#l10.1140"></a><span id="l10.1140">   nsresult rv;</span>
<a href="#l10.1141"></a><span id="l10.1141">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l10.1142"></a><span id="l10.1142">   nsCAutoString urlSpec;</span>
<a href="#l10.1143"></a><span id="l10.1143" class="difflineminus">-  </span>
<a href="#l10.1144"></a><span id="l10.1144" class="difflineminus">-  PRUnichar hierarchySeparator = GetHierarchyDelimiter(aDstFolder);</span>
<a href="#l10.1145"></a><span id="l10.1145" class="difflineminus">-  rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), aDstFolder, aListener, urlSpec, hierarchySeparator);</span>
<a href="#l10.1146"></a><span id="l10.1146" class="difflineplus">+</span>
<a href="#l10.1147"></a><span id="l10.1147" class="difflineplus">+  char hierarchyDelimiter = GetHierarchyDelimiter(aDstFolder);</span>
<a href="#l10.1148"></a><span id="l10.1148" class="difflineplus">+  rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), aDstFolder, aListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l10.1149"></a><span id="l10.1149">   if (NS_SUCCEEDED(rv))</span>
<a href="#l10.1150"></a><span id="l10.1150">   {</span>
<a href="#l10.1151"></a><span id="l10.1151">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl = do_QueryInterface(imapUrl);</span>
<a href="#l10.1152"></a><span id="l10.1152">     if (msgUrl &amp;&amp; aMsgWindow)</span>
<a href="#l10.1153"></a><span id="l10.1153">     {</span>
<a href="#l10.1154"></a><span id="l10.1154">       // we get the loadGroup from msgWindow</span>
<a href="#l10.1155"></a><span id="l10.1155">       msgUrl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l10.1156"></a><span id="l10.1156">     }</span>
<a href="#l10.1157"></a><span id="l10.1157" class="difflineminus">-    </span>
<a href="#l10.1158"></a><span id="l10.1158" class="difflineplus">+</span>
<a href="#l10.1159"></a><span id="l10.1159">     SetImapUrlSink(aDstFolder, imapUrl);</span>
<a href="#l10.1160"></a><span id="l10.1160">     imapUrl-&gt;SetMsgFile(aFile);</span>
<a href="#l10.1161"></a><span id="l10.1161">     imapUrl-&gt;SetCopyState(aCopyState);</span>
<a href="#l10.1162"></a><span id="l10.1162" class="difflineminus">-    </span>
<a href="#l10.1163"></a><span id="l10.1163" class="difflineplus">+</span>
<a href="#l10.1164"></a><span id="l10.1164">     nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(imapUrl);</span>
<a href="#l10.1165"></a><span id="l10.1165" class="difflineminus">-    </span>
<a href="#l10.1166"></a><span id="l10.1166" class="difflineplus">+</span>
<a href="#l10.1167"></a><span id="l10.1167">     if (inSelectedState)</span>
<a href="#l10.1168"></a><span id="l10.1168">       urlSpec.Append(&quot;/appenddraftfromfile&gt;&quot;);</span>
<a href="#l10.1169"></a><span id="l10.1169">     else</span>
<a href="#l10.1170"></a><span id="l10.1170">       urlSpec.Append(&quot;/appendmsgfromfile&gt;&quot;);</span>
<a href="#l10.1171"></a><span id="l10.1171" class="difflineminus">-    </span>
<a href="#l10.1172"></a><span id="l10.1172" class="difflineminus">-    urlSpec.Append(char(hierarchySeparator));</span>
<a href="#l10.1173"></a><span id="l10.1173" class="difflineminus">-    </span>
<a href="#l10.1174"></a><span id="l10.1174" class="difflineplus">+</span>
<a href="#l10.1175"></a><span id="l10.1175" class="difflineplus">+    urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l10.1176"></a><span id="l10.1176" class="difflineplus">+</span>
<a href="#l10.1177"></a><span id="l10.1177">     nsCString folderName;</span>
<a href="#l10.1178"></a><span id="l10.1178">     GetFolderName(aDstFolder, folderName);</span>
<a href="#l10.1179"></a><span id="l10.1179">     urlSpec.Append(folderName);</span>
<a href="#l10.1180"></a><span id="l10.1180" class="difflineminus">-    </span>
<a href="#l10.1181"></a><span id="l10.1181" class="difflineplus">+</span>
<a href="#l10.1182"></a><span id="l10.1182">     if (inSelectedState)</span>
<a href="#l10.1183"></a><span id="l10.1183">     {</span>
<a href="#l10.1184"></a><span id="l10.1184">       urlSpec.Append('&gt;');</span>
<a href="#l10.1185"></a><span id="l10.1185">       if (idsAreUids)</span>
<a href="#l10.1186"></a><span id="l10.1186">         urlSpec.Append(uidString);</span>
<a href="#l10.1187"></a><span id="l10.1187">       else</span>
<a href="#l10.1188"></a><span id="l10.1188">         urlSpec.Append(sequenceString);</span>
<a href="#l10.1189"></a><span id="l10.1189">       urlSpec.Append('&gt;');</span>
<a href="#l10.1190"></a><span id="l10.1190" class="difflineat">@@ -2225,45 +2216,45 @@ NS_IMETHODIMP nsImapService::MoveFolder(</span>
<a href="#l10.1191"></a><span id="l10.1191">                                         nsIMsgFolder *dstFolder, </span>
<a href="#l10.1192"></a><span id="l10.1192">                                         nsIUrlListener *urlListener, </span>
<a href="#l10.1193"></a><span id="l10.1193">                                         nsIMsgWindow *msgWindow, </span>
<a href="#l10.1194"></a><span id="l10.1194">                                         nsIURI **url)</span>
<a href="#l10.1195"></a><span id="l10.1195"> {</span>
<a href="#l10.1196"></a><span id="l10.1196">   NS_ENSURE_ARG_POINTER(eventTarget);</span>
<a href="#l10.1197"></a><span id="l10.1197">   NS_ENSURE_ARG_POINTER(srcFolder);</span>
<a href="#l10.1198"></a><span id="l10.1198">   NS_ENSURE_ARG_POINTER(dstFolder);</span>
<a href="#l10.1199"></a><span id="l10.1199" class="difflineminus">-  </span>
<a href="#l10.1200"></a><span id="l10.1200" class="difflineplus">+</span>
<a href="#l10.1201"></a><span id="l10.1201">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l10.1202"></a><span id="l10.1202">   nsCAutoString urlSpec;</span>
<a href="#l10.1203"></a><span id="l10.1203">   nsresult rv;</span>
<a href="#l10.1204"></a><span id="l10.1204" class="difflineminus">-  </span>
<a href="#l10.1205"></a><span id="l10.1205" class="difflineminus">-  PRUnichar default_hierarchySeparator = GetHierarchyDelimiter(dstFolder);</span>
<a href="#l10.1206"></a><span id="l10.1206" class="difflineplus">+</span>
<a href="#l10.1207"></a><span id="l10.1207" class="difflineplus">+  char default_hierarchyDelimiter = GetHierarchyDelimiter(dstFolder);</span>
<a href="#l10.1208"></a><span id="l10.1208">   rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), dstFolder, </span>
<a href="#l10.1209"></a><span id="l10.1209" class="difflineminus">-                            urlListener, urlSpec, default_hierarchySeparator);</span>
<a href="#l10.1210"></a><span id="l10.1210" class="difflineplus">+                            urlListener, urlSpec, default_hierarchyDelimiter);</span>
<a href="#l10.1211"></a><span id="l10.1211">   if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l10.1212"></a><span id="l10.1212">   {</span>
<a href="#l10.1213"></a><span id="l10.1213">     rv = SetImapUrlSink(dstFolder, imapUrl);</span>
<a href="#l10.1214"></a><span id="l10.1214">     if (NS_SUCCEEDED(rv))</span>
<a href="#l10.1215"></a><span id="l10.1215">     {</span>
<a href="#l10.1216"></a><span id="l10.1216">       nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailNewsUrl = do_QueryInterface(imapUrl);</span>
<a href="#l10.1217"></a><span id="l10.1217">       if (mailNewsUrl)</span>
<a href="#l10.1218"></a><span id="l10.1218">         mailNewsUrl-&gt;SetMsgWindow(msgWindow);</span>
<a href="#l10.1219"></a><span id="l10.1219" class="difflineminus">-      char hierarchySeparator = kOnlineHierarchySeparatorUnknown;</span>
<a href="#l10.1220"></a><span id="l10.1220" class="difflineplus">+      char hierarchyDelimiter = kOnlineHierarchySeparatorUnknown;</span>
<a href="#l10.1221"></a><span id="l10.1221">       nsCString folderName;</span>
<a href="#l10.1222"></a><span id="l10.1222" class="difflineminus">-      </span>
<a href="#l10.1223"></a><span id="l10.1223" class="difflineplus">+</span>
<a href="#l10.1224"></a><span id="l10.1224">       nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(imapUrl);</span>
<a href="#l10.1225"></a><span id="l10.1225">       GetFolderName(srcFolder, folderName);</span>
<a href="#l10.1226"></a><span id="l10.1226">       urlSpec.Append(&quot;/movefolderhierarchy&gt;&quot;);</span>
<a href="#l10.1227"></a><span id="l10.1227" class="difflineminus">-      urlSpec.Append(hierarchySeparator);</span>
<a href="#l10.1228"></a><span id="l10.1228" class="difflineplus">+      urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l10.1229"></a><span id="l10.1229">       urlSpec.Append(folderName);</span>
<a href="#l10.1230"></a><span id="l10.1230">       urlSpec.Append('&gt;');</span>
<a href="#l10.1231"></a><span id="l10.1231">       GetFolderName(dstFolder, folderName);</span>
<a href="#l10.1232"></a><span id="l10.1232">       if (!folderName.IsEmpty())</span>
<a href="#l10.1233"></a><span id="l10.1233">       {</span>
<a href="#l10.1234"></a><span id="l10.1234" class="difflineminus">-        urlSpec.Append(hierarchySeparator);</span>
<a href="#l10.1235"></a><span id="l10.1235" class="difflineplus">+        urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l10.1236"></a><span id="l10.1236">         urlSpec.Append(folderName);</span>
<a href="#l10.1237"></a><span id="l10.1237">       }</span>
<a href="#l10.1238"></a><span id="l10.1238">       rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l10.1239"></a><span id="l10.1239">       if (NS_SUCCEEDED(rv))</span>
<a href="#l10.1240"></a><span id="l10.1240">       {</span>
<a href="#l10.1241"></a><span id="l10.1241">         GetFolderName(srcFolder, folderName);</span>
<a href="#l10.1242"></a><span id="l10.1242">         rv = GetImapConnectionAndLoadUrl(eventTarget, imapUrl, nsnull, url);</span>
<a href="#l10.1243"></a><span id="l10.1243">       }</span>
<a href="#l10.1244"></a><span id="l10.1244" class="difflineat">@@ -2280,152 +2271,153 @@ NS_IMETHODIMP nsImapService::RenameLeaf(</span>
<a href="#l10.1245"></a><span id="l10.1245">                                         nsIURI **url)</span>
<a href="#l10.1246"></a><span id="l10.1246"> {</span>
<a href="#l10.1247"></a><span id="l10.1247">   NS_ENSURE_ARG_POINTER(eventTarget);</span>
<a href="#l10.1248"></a><span id="l10.1248">   NS_ENSURE_ARG_POINTER(srcFolder);</span>
<a href="#l10.1249"></a><span id="l10.1249">   </span>
<a href="#l10.1250"></a><span id="l10.1250">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l10.1251"></a><span id="l10.1251">   nsCAutoString urlSpec;</span>
<a href="#l10.1252"></a><span id="l10.1252">   nsresult rv;</span>
<a href="#l10.1253"></a><span id="l10.1253" class="difflineminus">-  </span>
<a href="#l10.1254"></a><span id="l10.1254" class="difflineminus">-	PRUnichar hierarchySeparator = GetHierarchyDelimiter(srcFolder);</span>
<a href="#l10.1255"></a><span id="l10.1255" class="difflineplus">+</span>
<a href="#l10.1256"></a><span id="l10.1256" class="difflineplus">+  char hierarchyDelimiter = GetHierarchyDelimiter(srcFolder);</span>
<a href="#l10.1257"></a><span id="l10.1257">   rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), srcFolder, </span>
<a href="#l10.1258"></a><span id="l10.1258" class="difflineminus">-                            urlListener, urlSpec, hierarchySeparator);</span>
<a href="#l10.1259"></a><span id="l10.1259" class="difflineplus">+                            urlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l10.1260"></a><span id="l10.1260">   if (NS_SUCCEEDED(rv))</span>
<a href="#l10.1261"></a><span id="l10.1261">   {</span>
<a href="#l10.1262"></a><span id="l10.1262">     rv = SetImapUrlSink(srcFolder, imapUrl);</span>
<a href="#l10.1263"></a><span id="l10.1263">     if (NS_SUCCEEDED(rv))</span>
<a href="#l10.1264"></a><span id="l10.1264">     {</span>
<a href="#l10.1265"></a><span id="l10.1265">       nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(imapUrl);</span>
<a href="#l10.1266"></a><span id="l10.1266">       nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailNewsUrl = do_QueryInterface(imapUrl);</span>
<a href="#l10.1267"></a><span id="l10.1267">       if (mailNewsUrl)</span>
<a href="#l10.1268"></a><span id="l10.1268">         mailNewsUrl-&gt;SetMsgWindow(msgWindow);</span>
<a href="#l10.1269"></a><span id="l10.1269">       nsCString folderName;</span>
<a href="#l10.1270"></a><span id="l10.1270">       GetFolderName(srcFolder, folderName);</span>
<a href="#l10.1271"></a><span id="l10.1271">       urlSpec.Append(&quot;/rename&gt;&quot;);</span>
<a href="#l10.1272"></a><span id="l10.1272" class="difflineminus">-      urlSpec.Append(char(hierarchySeparator));</span>
<a href="#l10.1273"></a><span id="l10.1273" class="difflineplus">+      urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l10.1274"></a><span id="l10.1274">       urlSpec.Append(folderName);</span>
<a href="#l10.1275"></a><span id="l10.1275">       urlSpec.Append('&gt;');</span>
<a href="#l10.1276"></a><span id="l10.1276" class="difflineminus">-      urlSpec.Append(char(hierarchySeparator));</span>
<a href="#l10.1277"></a><span id="l10.1277" class="difflineminus">-      </span>
<a href="#l10.1278"></a><span id="l10.1278" class="difflineplus">+      urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l10.1279"></a><span id="l10.1279">       nsCAutoString cStrFolderName(folderName);</span>
<a href="#l10.1280"></a><span id="l10.1280">       // Unescape the name before looking for parent path</span>
<a href="#l10.1281"></a><span id="l10.1281">       nsUnescape(cStrFolderName.BeginWriting());</span>
<a href="#l10.1282"></a><span id="l10.1282" class="difflineminus">-      PRInt32 leafNameStart = cStrFolderName.RFindChar(hierarchySeparator);</span>
<a href="#l10.1283"></a><span id="l10.1283" class="difflineplus">+      PRInt32 leafNameStart = cStrFolderName.RFindChar(hierarchyDelimiter);</span>
<a href="#l10.1284"></a><span id="l10.1284">       if (leafNameStart != -1)</span>
<a href="#l10.1285"></a><span id="l10.1285">       {</span>
<a href="#l10.1286"></a><span id="l10.1286">         cStrFolderName.SetLength(leafNameStart+1);</span>
<a href="#l10.1287"></a><span id="l10.1287">         urlSpec.Append(cStrFolderName);</span>
<a href="#l10.1288"></a><span id="l10.1288">       }</span>
<a href="#l10.1289"></a><span id="l10.1289" class="difflineminus">-      </span>
<a href="#l10.1290"></a><span id="l10.1290" class="difflineplus">+</span>
<a href="#l10.1291"></a><span id="l10.1291">       nsCAutoString utfNewName;</span>
<a href="#l10.1292"></a><span id="l10.1292">       CopyUTF16toMUTF7(nsDependentString(newLeafName), utfNewName);</span>
<a href="#l10.1293"></a><span id="l10.1293">       char* escapedNewName = nsEscape(utfNewName.get(), url_Path);</span>
<a href="#l10.1294"></a><span id="l10.1294">       NS_ENSURE_TRUE(escapedNewName, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l10.1295"></a><span id="l10.1295">       nsCString escapedSlashName;</span>
<a href="#l10.1296"></a><span id="l10.1296">       rv = nsImapUrl::EscapeSlashes(escapedNewName, getter_Copies(escapedSlashName));</span>
<a href="#l10.1297"></a><span id="l10.1297">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1298"></a><span id="l10.1298">       NS_Free(escapedNewName);</span>
<a href="#l10.1299"></a><span id="l10.1299">       urlSpec.Append(escapedSlashName);</span>
<a href="#l10.1300"></a><span id="l10.1300" class="difflineminus">-      </span>
<a href="#l10.1301"></a><span id="l10.1301" class="difflineplus">+</span>
<a href="#l10.1302"></a><span id="l10.1302">       rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l10.1303"></a><span id="l10.1303">       if (NS_SUCCEEDED(rv))</span>
<a href="#l10.1304"></a><span id="l10.1304">         rv = GetImapConnectionAndLoadUrl(eventTarget, imapUrl, nsnull, url);</span>
<a href="#l10.1305"></a><span id="l10.1305">     } // if (NS_SUCCEEDED(rv))</span>
<a href="#l10.1306"></a><span id="l10.1306">   } // if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l10.1307"></a><span id="l10.1307">   return rv;</span>
<a href="#l10.1308"></a><span id="l10.1308"> }</span>
<a href="#l10.1309"></a><span id="l10.1309"> </span>
<a href="#l10.1310"></a><span id="l10.1310"> NS_IMETHODIMP nsImapService::CreateFolder(nsIEventTarget  *eventTarget,</span>
<a href="#l10.1311"></a><span id="l10.1311">                                           nsIMsgFolder *parent,</span>
<a href="#l10.1312"></a><span id="l10.1312">                                           const nsAString &amp;newFolderName,</span>
<a href="#l10.1313"></a><span id="l10.1313">                                           nsIUrlListener *urlListener, </span>
<a href="#l10.1314"></a><span id="l10.1314">                                           nsIURI **url)</span>
<a href="#l10.1315"></a><span id="l10.1315"> {</span>
<a href="#l10.1316"></a><span id="l10.1316">   NS_ENSURE_ARG_POINTER(eventTarget);</span>
<a href="#l10.1317"></a><span id="l10.1317">   NS_ENSURE_ARG_POINTER(parent);</span>
<a href="#l10.1318"></a><span id="l10.1318" class="difflineminus">-  </span>
<a href="#l10.1319"></a><span id="l10.1319" class="difflineplus">+</span>
<a href="#l10.1320"></a><span id="l10.1320">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l10.1321"></a><span id="l10.1321">   nsCAutoString urlSpec;</span>
<a href="#l10.1322"></a><span id="l10.1322">   nsresult rv;</span>
<a href="#l10.1323"></a><span id="l10.1323" class="difflineminus">-  </span>
<a href="#l10.1324"></a><span id="l10.1324" class="difflineminus">-  PRUnichar hierarchySeparator = GetHierarchyDelimiter(parent);</span>
<a href="#l10.1325"></a><span id="l10.1325" class="difflineplus">+</span>
<a href="#l10.1326"></a><span id="l10.1326" class="difflineplus">+  char hierarchyDelimiter = GetHierarchyDelimiter(parent);</span>
<a href="#l10.1327"></a><span id="l10.1327">   rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), parent, </span>
<a href="#l10.1328"></a><span id="l10.1328" class="difflineminus">-                            urlListener, urlSpec, hierarchySeparator);</span>
<a href="#l10.1329"></a><span id="l10.1329" class="difflineplus">+                            urlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l10.1330"></a><span id="l10.1330">   if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l10.1331"></a><span id="l10.1331">   {</span>
<a href="#l10.1332"></a><span id="l10.1332">     rv = SetImapUrlSink(parent, imapUrl);</span>
<a href="#l10.1333"></a><span id="l10.1333">     if (NS_SUCCEEDED(rv))</span>
<a href="#l10.1334"></a><span id="l10.1334">     {</span>
<a href="#l10.1335"></a><span id="l10.1335">       nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(imapUrl);</span>
<a href="#l10.1336"></a><span id="l10.1336" class="difflineminus">-      </span>
<a href="#l10.1337"></a><span id="l10.1337" class="difflineplus">+</span>
<a href="#l10.1338"></a><span id="l10.1338">       nsCString folderName;</span>
<a href="#l10.1339"></a><span id="l10.1339">       GetFolderName(parent, folderName);</span>
<a href="#l10.1340"></a><span id="l10.1340">       urlSpec.Append(&quot;/create&gt;&quot;);</span>
<a href="#l10.1341"></a><span id="l10.1341" class="difflineminus">-      urlSpec.Append(char(hierarchySeparator));</span>
<a href="#l10.1342"></a><span id="l10.1342" class="difflineplus">+      urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l10.1343"></a><span id="l10.1343">       if (!folderName.IsEmpty())</span>
<a href="#l10.1344"></a><span id="l10.1344">       {</span>
<a href="#l10.1345"></a><span id="l10.1345">         nsCString canonicalName;</span>
<a href="#l10.1346"></a><span id="l10.1346" class="difflineminus">-        nsImapUrl::ConvertToCanonicalFormat(folderName.get(), (char) hierarchySeparator, getter_Copies(canonicalName));</span>
<a href="#l10.1347"></a><span id="l10.1347" class="difflineplus">+        nsImapUrl::ConvertToCanonicalFormat(folderName.get(),</span>
<a href="#l10.1348"></a><span id="l10.1348" class="difflineplus">+                                            hierarchyDelimiter,</span>
<a href="#l10.1349"></a><span id="l10.1349" class="difflineplus">+                                            getter_Copies(canonicalName));</span>
<a href="#l10.1350"></a><span id="l10.1350">         urlSpec.Append(canonicalName);</span>
<a href="#l10.1351"></a><span id="l10.1351" class="difflineminus">-        urlSpec.Append(char(hierarchySeparator));</span>
<a href="#l10.1352"></a><span id="l10.1352" class="difflineplus">+        urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l10.1353"></a><span id="l10.1353">       }</span>
<a href="#l10.1354"></a><span id="l10.1354" class="difflineminus">-      </span>
<a href="#l10.1355"></a><span id="l10.1355" class="difflineplus">+</span>
<a href="#l10.1356"></a><span id="l10.1356">       nsCAutoString utfNewName;</span>
<a href="#l10.1357"></a><span id="l10.1357">       rv = CopyUTF16toMUTF7(nsDependentString(newFolderName), utfNewName);</span>
<a href="#l10.1358"></a><span id="l10.1358">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1359"></a><span id="l10.1359">       char* escapedFolderName = nsEscape(utfNewName.get(), url_Path);</span>
<a href="#l10.1360"></a><span id="l10.1360">       urlSpec.Append(escapedFolderName);</span>
<a href="#l10.1361"></a><span id="l10.1361">       NS_Free(escapedFolderName);</span>
<a href="#l10.1362"></a><span id="l10.1362" class="difflineminus">-      </span>
<a href="#l10.1363"></a><span id="l10.1363" class="difflineplus">+</span>
<a href="#l10.1364"></a><span id="l10.1364">       rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l10.1365"></a><span id="l10.1365">       if (NS_SUCCEEDED(rv))</span>
<a href="#l10.1366"></a><span id="l10.1366">         rv = GetImapConnectionAndLoadUrl(eventTarget, imapUrl, nsnull, url);</span>
<a href="#l10.1367"></a><span id="l10.1367">     } // if (NS_SUCCEEDED(rv))</span>
<a href="#l10.1368"></a><span id="l10.1368">   } // if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l10.1369"></a><span id="l10.1369">   return rv;</span>
<a href="#l10.1370"></a><span id="l10.1370"> }</span>
<a href="#l10.1371"></a><span id="l10.1371"> </span>
<a href="#l10.1372"></a><span id="l10.1372"> NS_IMETHODIMP nsImapService::EnsureFolderExists(nsIEventTarget *eventTarget, </span>
<a href="#l10.1373"></a><span id="l10.1373">                                                 nsIMsgFolder *parent,</span>
<a href="#l10.1374"></a><span id="l10.1374">                                                 const nsAString &amp;newFolderName, </span>
<a href="#l10.1375"></a><span id="l10.1375">                                                 nsIUrlListener *urlListener, </span>
<a href="#l10.1376"></a><span id="l10.1376">                                                 nsIURI **url)</span>
<a href="#l10.1377"></a><span id="l10.1377"> {</span>
<a href="#l10.1378"></a><span id="l10.1378">   NS_ENSURE_ARG_POINTER(eventTarget);</span>
<a href="#l10.1379"></a><span id="l10.1379">   NS_ENSURE_ARG_POINTER(parent);</span>
<a href="#l10.1380"></a><span id="l10.1380" class="difflineminus">-  </span>
<a href="#l10.1381"></a><span id="l10.1381" class="difflineplus">+</span>
<a href="#l10.1382"></a><span id="l10.1382">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l10.1383"></a><span id="l10.1383">   nsCAutoString urlSpec;</span>
<a href="#l10.1384"></a><span id="l10.1384">   nsresult rv;</span>
<a href="#l10.1385"></a><span id="l10.1385" class="difflineminus">-  </span>
<a href="#l10.1386"></a><span id="l10.1386" class="difflineminus">-  PRUnichar hierarchySeparator = GetHierarchyDelimiter(parent);</span>
<a href="#l10.1387"></a><span id="l10.1387" class="difflineminus">-  rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), parent, urlListener, urlSpec, hierarchySeparator);</span>
<a href="#l10.1388"></a><span id="l10.1388" class="difflineplus">+</span>
<a href="#l10.1389"></a><span id="l10.1389" class="difflineplus">+  char hierarchyDelimiter = GetHierarchyDelimiter(parent);</span>
<a href="#l10.1390"></a><span id="l10.1390" class="difflineplus">+  rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), parent, urlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l10.1391"></a><span id="l10.1391">   if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l10.1392"></a><span id="l10.1392">   {</span>
<a href="#l10.1393"></a><span id="l10.1393">     rv = SetImapUrlSink(parent, imapUrl);</span>
<a href="#l10.1394"></a><span id="l10.1394">     if (NS_SUCCEEDED(rv))</span>
<a href="#l10.1395"></a><span id="l10.1395">     {</span>
<a href="#l10.1396"></a><span id="l10.1396">       nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(imapUrl);</span>
<a href="#l10.1397"></a><span id="l10.1397" class="difflineminus">-      </span>
<a href="#l10.1398"></a><span id="l10.1398" class="difflineplus">+</span>
<a href="#l10.1399"></a><span id="l10.1399">       nsCString folderName;</span>
<a href="#l10.1400"></a><span id="l10.1400">       GetFolderName(parent, folderName);</span>
<a href="#l10.1401"></a><span id="l10.1401">       urlSpec.Append(&quot;/ensureExists&gt;&quot;);</span>
<a href="#l10.1402"></a><span id="l10.1402" class="difflineminus">-      urlSpec.Append(char(hierarchySeparator));</span>
<a href="#l10.1403"></a><span id="l10.1403" class="difflineplus">+      urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l10.1404"></a><span id="l10.1404">       if (!folderName.IsEmpty())</span>
<a href="#l10.1405"></a><span id="l10.1405">       {</span>
<a href="#l10.1406"></a><span id="l10.1406">         urlSpec.Append(folderName);</span>
<a href="#l10.1407"></a><span id="l10.1407" class="difflineminus">-        urlSpec.Append(char(hierarchySeparator));</span>
<a href="#l10.1408"></a><span id="l10.1408" class="difflineplus">+        urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l10.1409"></a><span id="l10.1409">       }</span>
<a href="#l10.1410"></a><span id="l10.1410">       nsCAutoString utfNewName; </span>
<a href="#l10.1411"></a><span id="l10.1411">       CopyUTF16toMUTF7(nsDependentString(newFolderName), utfNewName);</span>
<a href="#l10.1412"></a><span id="l10.1412">       char* escapedFolderName = nsEscape(utfNewName.get(), url_Path);</span>
<a href="#l10.1413"></a><span id="l10.1413">       urlSpec.Append(escapedFolderName);</span>
<a href="#l10.1414"></a><span id="l10.1414">       NS_Free(escapedFolderName);</span>
<a href="#l10.1415"></a><span id="l10.1415" class="difflineminus">-      </span>
<a href="#l10.1416"></a><span id="l10.1416" class="difflineplus">+</span>
<a href="#l10.1417"></a><span id="l10.1417">       rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l10.1418"></a><span id="l10.1418">       if (NS_SUCCEEDED(rv))</span>
<a href="#l10.1419"></a><span id="l10.1419">         rv = GetImapConnectionAndLoadUrl(eventTarget, imapUrl, nsnull, url);</span>
<a href="#l10.1420"></a><span id="l10.1420">     } // if (NS_SUCCEEDED(rv))</span>
<a href="#l10.1421"></a><span id="l10.1421">   } // if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l10.1422"></a><span id="l10.1422">   return rv;</span>
<a href="#l10.1423"></a><span id="l10.1423"> }</span>
<a href="#l10.1424"></a><span id="l10.1424"> </span>
<a href="#l10.1425"></a><span id="l10.1425" class="difflineat">@@ -2965,29 +2957,28 @@ NS_IMETHODIMP nsImapService::GetListOfFo</span>
<a href="#l10.1426"></a><span id="l10.1426">     PRInt32 slashPos = tempFolderName.FindChar('/');</span>
<a href="#l10.1427"></a><span id="l10.1427">     if (slashPos &gt; 0)</span>
<a href="#l10.1428"></a><span id="l10.1428">     {</span>
<a href="#l10.1429"></a><span id="l10.1429">       tempFolderName.Left(tokenStr,slashPos);</span>
<a href="#l10.1430"></a><span id="l10.1430">       tempFolderName.Right(remStr, tempFolderName.Length()-slashPos);</span>
<a href="#l10.1431"></a><span id="l10.1431">     }</span>
<a href="#l10.1432"></a><span id="l10.1432">     else</span>
<a href="#l10.1433"></a><span id="l10.1433">       tokenStr.Assign(tempFolderName);</span>
<a href="#l10.1434"></a><span id="l10.1434" class="difflineminus">-    </span>
<a href="#l10.1435"></a><span id="l10.1435" class="difflineplus">+</span>
<a href="#l10.1436"></a><span id="l10.1436">     if (tokenStr.Equals(NS_LITERAL_CSTRING(&quot;INBOX&quot;), nsCaseInsensitiveCStringComparator()) &amp;&amp; </span>
<a href="#l10.1437"></a><span id="l10.1437">         !tokenStr.Equals(NS_LITERAL_CSTRING(&quot;INBOX&quot;)))</span>
<a href="#l10.1438"></a><span id="l10.1438">       changedStr.Append(&quot;INBOX&quot;);</span>
<a href="#l10.1439"></a><span id="l10.1439">     else</span>
<a href="#l10.1440"></a><span id="l10.1440">       changedStr.Append(tokenStr);</span>
<a href="#l10.1441"></a><span id="l10.1441" class="difflineminus">-    </span>
<a href="#l10.1442"></a><span id="l10.1442" class="difflineplus">+</span>
<a href="#l10.1443"></a><span id="l10.1443">     if (slashPos &gt; 0 ) </span>
<a href="#l10.1444"></a><span id="l10.1444">       changedStr.Append(remStr);</span>
<a href="#l10.1445"></a><span id="l10.1445" class="difflineminus">-    </span>
<a href="#l10.1446"></a><span id="l10.1446" class="difflineplus">+</span>
<a href="#l10.1447"></a><span id="l10.1447">     rv = rootMsgFolder-&gt;FindSubFolder(changedStr, getter_AddRefs(msgFolder));</span>
<a href="#l10.1448"></a><span id="l10.1448">   }</span>
<a href="#l10.1449"></a><span id="l10.1449" class="difflineminus">-  </span>
<a href="#l10.1450"></a><span id="l10.1450">   return DiscoverChildren(NS_GetCurrentThread(), msgFolder, listener, folderPath, nsnull);</span>
<a href="#l10.1451"></a><span id="l10.1451"> }</span>
<a href="#l10.1452"></a><span id="l10.1452"> </span>
<a href="#l10.1453"></a><span id="l10.1453"> NS_IMETHODIMP nsImapService::GetListOfFoldersOnServer(nsIImapIncomingServer *aServer, </span>
<a href="#l10.1454"></a><span id="l10.1454">                                                       nsIMsgWindow *aMsgWindow)</span>
<a href="#l10.1455"></a><span id="l10.1455"> {</span>
<a href="#l10.1456"></a><span id="l10.1456">   nsresult rv;</span>
<a href="#l10.1457"></a><span id="l10.1457"> </span>
<a href="#l10.1458"></a><span id="l10.1458" class="difflineat">@@ -3022,31 +3013,31 @@ nsresult nsImapService::ChangeFolderSubs</span>
<a href="#l10.1459"></a><span id="l10.1459">                                                  nsIMsgFolder *folder,</span>
<a href="#l10.1460"></a><span id="l10.1460">                                                  const nsAString &amp;folderName, </span>
<a href="#l10.1461"></a><span id="l10.1461">                                                  const char *command,</span>
<a href="#l10.1462"></a><span id="l10.1462">                                                  nsIUrlListener *urlListener, </span>
<a href="#l10.1463"></a><span id="l10.1463">                                                  nsIURI **url)</span>
<a href="#l10.1464"></a><span id="l10.1464"> {</span>
<a href="#l10.1465"></a><span id="l10.1465">   NS_ENSURE_ARG_POINTER(eventTarget);</span>
<a href="#l10.1466"></a><span id="l10.1466">   NS_ENSURE_ARG_POINTER(folder);</span>
<a href="#l10.1467"></a><span id="l10.1467" class="difflineminus">-  </span>
<a href="#l10.1468"></a><span id="l10.1468" class="difflineplus">+</span>
<a href="#l10.1469"></a><span id="l10.1469">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l10.1470"></a><span id="l10.1470">   nsCAutoString urlSpec;</span>
<a href="#l10.1471"></a><span id="l10.1471">   nsresult rv;</span>
<a href="#l10.1472"></a><span id="l10.1472" class="difflineminus">-  PRUnichar hierarchySeparator = GetHierarchyDelimiter(folder);</span>
<a href="#l10.1473"></a><span id="l10.1473" class="difflineplus">+  char hierarchyDelimiter = GetHierarchyDelimiter(folder);</span>
<a href="#l10.1474"></a><span id="l10.1474">   rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), folder, urlListener,</span>
<a href="#l10.1475"></a><span id="l10.1475" class="difflineminus">-                            urlSpec, hierarchySeparator);</span>
<a href="#l10.1476"></a><span id="l10.1476" class="difflineplus">+                            urlSpec, hierarchyDelimiter);</span>
<a href="#l10.1477"></a><span id="l10.1477">   if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l10.1478"></a><span id="l10.1478">   {</span>
<a href="#l10.1479"></a><span id="l10.1479">     rv = SetImapUrlSink(folder, imapUrl);</span>
<a href="#l10.1480"></a><span id="l10.1480">     if (NS_SUCCEEDED(rv))</span>
<a href="#l10.1481"></a><span id="l10.1481">     {</span>
<a href="#l10.1482"></a><span id="l10.1482">       nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(imapUrl);</span>
<a href="#l10.1483"></a><span id="l10.1483">       urlSpec.Append(command);</span>
<a href="#l10.1484"></a><span id="l10.1484" class="difflineminus">-      urlSpec.Append(char(hierarchySeparator));</span>
<a href="#l10.1485"></a><span id="l10.1485" class="difflineplus">+      urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l10.1486"></a><span id="l10.1486">       nsCAutoString utfFolderName;</span>
<a href="#l10.1487"></a><span id="l10.1487">       rv = CopyUTF16toMUTF7(nsDependentString(folderName), utfFolderName);</span>
<a href="#l10.1488"></a><span id="l10.1488">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.1489"></a><span id="l10.1489">       char* escapedFolderName = nsEscape(utfFolderName.get(), url_Path);</span>
<a href="#l10.1490"></a><span id="l10.1490">       urlSpec.Append(escapedFolderName);</span>
<a href="#l10.1491"></a><span id="l10.1491">       NS_Free(escapedFolderName);</span>
<a href="#l10.1492"></a><span id="l10.1492">       rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l10.1493"></a><span id="l10.1493">       if (NS_SUCCEEDED(rv))</span>
<a href="#l10.1494"></a><span id="l10.1494" class="difflineat">@@ -3084,160 +3075,160 @@ NS_IMETHODIMP nsImapService::IssueComman</span>
<a href="#l10.1495"></a><span id="l10.1495">                                                 nsIURI **aURL)</span>
<a href="#l10.1496"></a><span id="l10.1496"> {</span>
<a href="#l10.1497"></a><span id="l10.1497">   NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l10.1498"></a><span id="l10.1498">   NS_ENSURE_ARG_POINTER(anImapFolder);</span>
<a href="#l10.1499"></a><span id="l10.1499">   NS_ENSURE_ARG_POINTER(aMsgWindow);</span>
<a href="#l10.1500"></a><span id="l10.1500">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l10.1501"></a><span id="l10.1501">   nsCAutoString urlSpec;</span>
<a href="#l10.1502"></a><span id="l10.1502">   nsresult rv;</span>
<a href="#l10.1503"></a><span id="l10.1503" class="difflineminus">-  PRUnichar hierarchySeparator = GetHierarchyDelimiter(anImapFolder);</span>
<a href="#l10.1504"></a><span id="l10.1504" class="difflineminus">-  rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), anImapFolder, nsnull, urlSpec, hierarchySeparator);</span>
<a href="#l10.1505"></a><span id="l10.1505" class="difflineminus">-  </span>
<a href="#l10.1506"></a><span id="l10.1506" class="difflineplus">+  char hierarchyDelimiter = GetHierarchyDelimiter(anImapFolder);</span>
<a href="#l10.1507"></a><span id="l10.1507" class="difflineplus">+  rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), anImapFolder, nsnull, urlSpec, hierarchyDelimiter);</span>
<a href="#l10.1508"></a><span id="l10.1508" class="difflineplus">+</span>
<a href="#l10.1509"></a><span id="l10.1509">   if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l10.1510"></a><span id="l10.1510">   {</span>
<a href="#l10.1511"></a><span id="l10.1511">     // nsImapUrl::SetSpec() will set the imap action properly</span>
<a href="#l10.1512"></a><span id="l10.1512">     rv = imapUrl-&gt;SetImapAction(nsIImapUrl::nsImapUserDefinedMsgCommand);</span>
<a href="#l10.1513"></a><span id="l10.1513" class="difflineminus">-    </span>
<a href="#l10.1514"></a><span id="l10.1514" class="difflineplus">+</span>
<a href="#l10.1515"></a><span id="l10.1515">     nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailNewsUrl = do_QueryInterface(imapUrl);</span>
<a href="#l10.1516"></a><span id="l10.1516">     mailNewsUrl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l10.1517"></a><span id="l10.1517">     mailNewsUrl-&gt;SetUpdatingFolder(PR_TRUE);</span>
<a href="#l10.1518"></a><span id="l10.1518">     rv = SetImapUrlSink(anImapFolder, imapUrl);</span>
<a href="#l10.1519"></a><span id="l10.1519" class="difflineminus">-    </span>
<a href="#l10.1520"></a><span id="l10.1520" class="difflineplus">+</span>
<a href="#l10.1521"></a><span id="l10.1521">     if (NS_SUCCEEDED(rv))</span>
<a href="#l10.1522"></a><span id="l10.1522">     {</span>
<a href="#l10.1523"></a><span id="l10.1523">       nsCString folderName;</span>
<a href="#l10.1524"></a><span id="l10.1524">       GetFolderName(anImapFolder, folderName);</span>
<a href="#l10.1525"></a><span id="l10.1525">       urlSpec.Append(&quot;/&quot;);</span>
<a href="#l10.1526"></a><span id="l10.1526">       urlSpec.Append(aCommand);</span>
<a href="#l10.1527"></a><span id="l10.1527">       urlSpec.Append(&quot;&gt;&quot;);</span>
<a href="#l10.1528"></a><span id="l10.1528">       urlSpec.Append(uidString);</span>
<a href="#l10.1529"></a><span id="l10.1529">       urlSpec.Append(&quot;&gt;&quot;);</span>
<a href="#l10.1530"></a><span id="l10.1530" class="difflineminus">-      urlSpec.Append(char(hierarchySeparator));</span>
<a href="#l10.1531"></a><span id="l10.1531" class="difflineplus">+      urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l10.1532"></a><span id="l10.1532">       urlSpec.Append(folderName);</span>
<a href="#l10.1533"></a><span id="l10.1533">       urlSpec.Append(&quot;&gt;&quot;);</span>
<a href="#l10.1534"></a><span id="l10.1534">       urlSpec.Append(uids);</span>
<a href="#l10.1535"></a><span id="l10.1535">       rv = mailNewsUrl-&gt;SetSpec(urlSpec);</span>
<a href="#l10.1536"></a><span id="l10.1536">       if (NS_SUCCEEDED(rv))</span>
<a href="#l10.1537"></a><span id="l10.1537">         rv = GetImapConnectionAndLoadUrl(aClientEventTarget, imapUrl, nsnull, aURL);</span>
<a href="#l10.1538"></a><span id="l10.1538">     }</span>
<a href="#l10.1539"></a><span id="l10.1539">   } // if we have a url to run....</span>
<a href="#l10.1540"></a><span id="l10.1540" class="difflineminus">-  </span>
<a href="#l10.1541"></a><span id="l10.1541" class="difflineplus">+</span>
<a href="#l10.1542"></a><span id="l10.1542">   return rv;</span>
<a href="#l10.1543"></a><span id="l10.1543"> }</span>
<a href="#l10.1544"></a><span id="l10.1544"> </span>
<a href="#l10.1545"></a><span id="l10.1545"> NS_IMETHODIMP nsImapService::FetchCustomMsgAttribute(nsIEventTarget *aClientEventTarget,</span>
<a href="#l10.1546"></a><span id="l10.1546">                                                      nsIMsgFolder *anImapFolder,</span>
<a href="#l10.1547"></a><span id="l10.1547">                                                      nsIMsgWindow *aMsgWindow,</span>
<a href="#l10.1548"></a><span id="l10.1548">                                                      const nsACString &amp;aAttribute,</span>
<a href="#l10.1549"></a><span id="l10.1549">                                                      const nsACString &amp;uids,</span>
<a href="#l10.1550"></a><span id="l10.1550">                                                      nsIURI **aURL)</span>
<a href="#l10.1551"></a><span id="l10.1551"> {</span>
<a href="#l10.1552"></a><span id="l10.1552">   NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l10.1553"></a><span id="l10.1553">   NS_ENSURE_ARG_POINTER(anImapFolder);</span>
<a href="#l10.1554"></a><span id="l10.1554">   NS_ENSURE_ARG_POINTER(aMsgWindow);</span>
<a href="#l10.1555"></a><span id="l10.1555" class="difflineminus">-  </span>
<a href="#l10.1556"></a><span id="l10.1556" class="difflineplus">+</span>
<a href="#l10.1557"></a><span id="l10.1557">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l10.1558"></a><span id="l10.1558">   nsCAutoString urlSpec;</span>
<a href="#l10.1559"></a><span id="l10.1559">   nsresult rv;</span>
<a href="#l10.1560"></a><span id="l10.1560" class="difflineminus">-  PRUnichar hierarchySeparator = GetHierarchyDelimiter(anImapFolder);</span>
<a href="#l10.1561"></a><span id="l10.1561" class="difflineplus">+  char hierarchyDelimiter = GetHierarchyDelimiter(anImapFolder);</span>
<a href="#l10.1562"></a><span id="l10.1562">   rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), anImapFolder, </span>
<a href="#l10.1563"></a><span id="l10.1563" class="difflineminus">-                            nsnull, urlSpec, hierarchySeparator);</span>
<a href="#l10.1564"></a><span id="l10.1564" class="difflineplus">+                            nsnull, urlSpec, hierarchyDelimiter);</span>
<a href="#l10.1565"></a><span id="l10.1565">   if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l10.1566"></a><span id="l10.1566">   {</span>
<a href="#l10.1567"></a><span id="l10.1567">     // nsImapUrl::SetSpec() will set the imap action properly</span>
<a href="#l10.1568"></a><span id="l10.1568">     rv = imapUrl-&gt;SetImapAction(nsIImapUrl::nsImapUserDefinedFetchAttribute);</span>
<a href="#l10.1569"></a><span id="l10.1569" class="difflineminus">-    </span>
<a href="#l10.1570"></a><span id="l10.1570" class="difflineplus">+</span>
<a href="#l10.1571"></a><span id="l10.1571">     nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailNewsUrl = do_QueryInterface(imapUrl);</span>
<a href="#l10.1572"></a><span id="l10.1572">     mailNewsUrl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l10.1573"></a><span id="l10.1573">     mailNewsUrl-&gt;SetUpdatingFolder(PR_TRUE);</span>
<a href="#l10.1574"></a><span id="l10.1574">     rv = SetImapUrlSink(anImapFolder, imapUrl);</span>
<a href="#l10.1575"></a><span id="l10.1575" class="difflineminus">-    </span>
<a href="#l10.1576"></a><span id="l10.1576" class="difflineplus">+</span>
<a href="#l10.1577"></a><span id="l10.1577">     if (NS_SUCCEEDED(rv))</span>
<a href="#l10.1578"></a><span id="l10.1578">     {</span>
<a href="#l10.1579"></a><span id="l10.1579">       nsCString folderName;</span>
<a href="#l10.1580"></a><span id="l10.1580">       GetFolderName(anImapFolder, folderName);</span>
<a href="#l10.1581"></a><span id="l10.1581">       urlSpec.Append(&quot;/customFetch&gt;UID&gt;&quot;);</span>
<a href="#l10.1582"></a><span id="l10.1582" class="difflineminus">-      urlSpec.Append(char(hierarchySeparator));</span>
<a href="#l10.1583"></a><span id="l10.1583" class="difflineplus">+      urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l10.1584"></a><span id="l10.1584">       urlSpec.Append(folderName);</span>
<a href="#l10.1585"></a><span id="l10.1585">       urlSpec.Append(&quot;&gt;&quot;);</span>
<a href="#l10.1586"></a><span id="l10.1586">       urlSpec.Append(uids);</span>
<a href="#l10.1587"></a><span id="l10.1587">       urlSpec.Append(&quot;&gt;&quot;);</span>
<a href="#l10.1588"></a><span id="l10.1588">       urlSpec.Append(aAttribute);</span>
<a href="#l10.1589"></a><span id="l10.1589">       rv = mailNewsUrl-&gt;SetSpec(urlSpec);</span>
<a href="#l10.1590"></a><span id="l10.1590">       if (NS_SUCCEEDED(rv))</span>
<a href="#l10.1591"></a><span id="l10.1591">         rv = GetImapConnectionAndLoadUrl(aClientEventTarget, imapUrl, nsnull, aURL);</span>
<a href="#l10.1592"></a><span id="l10.1592">     }</span>
<a href="#l10.1593"></a><span id="l10.1593">   } // if we have a url to run....</span>
<a href="#l10.1594"></a><span id="l10.1594" class="difflineminus">-  </span>
<a href="#l10.1595"></a><span id="l10.1595" class="difflineplus">+</span>
<a href="#l10.1596"></a><span id="l10.1596">   return rv;</span>
<a href="#l10.1597"></a><span id="l10.1597"> }</span>
<a href="#l10.1598"></a><span id="l10.1598"> </span>
<a href="#l10.1599"></a><span id="l10.1599"> NS_IMETHODIMP nsImapService::StoreCustomKeywords(nsIEventTarget *aClientEventTarget,</span>
<a href="#l10.1600"></a><span id="l10.1600">                                                  nsIMsgFolder *anImapFolder,</span>
<a href="#l10.1601"></a><span id="l10.1601">                                                  nsIMsgWindow *aMsgWindow,</span>
<a href="#l10.1602"></a><span id="l10.1602">                                                  const nsACString &amp;flagsToAdd,</span>
<a href="#l10.1603"></a><span id="l10.1603">                                                  const nsACString &amp;flagsToSubtract,</span>
<a href="#l10.1604"></a><span id="l10.1604">                                                  const nsACString &amp;uids,</span>
<a href="#l10.1605"></a><span id="l10.1605">                                                  nsIURI **aURL)</span>
<a href="#l10.1606"></a><span id="l10.1606"> {</span>
<a href="#l10.1607"></a><span id="l10.1607">   NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l10.1608"></a><span id="l10.1608">   NS_ENSURE_ARG_POINTER(anImapFolder);</span>
<a href="#l10.1609"></a><span id="l10.1609">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l10.1610"></a><span id="l10.1610">   nsCAutoString urlSpec;</span>
<a href="#l10.1611"></a><span id="l10.1611">   nsresult rv;</span>
<a href="#l10.1612"></a><span id="l10.1612" class="difflineminus">-  PRUnichar hierarchySeparator = GetHierarchyDelimiter(anImapFolder);</span>
<a href="#l10.1613"></a><span id="l10.1613" class="difflineminus">-  rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), anImapFolder, nsnull, urlSpec, hierarchySeparator);</span>
<a href="#l10.1614"></a><span id="l10.1614" class="difflineminus">-  </span>
<a href="#l10.1615"></a><span id="l10.1615" class="difflineplus">+  char hierarchyDelimiter = GetHierarchyDelimiter(anImapFolder);</span>
<a href="#l10.1616"></a><span id="l10.1616" class="difflineplus">+  rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), anImapFolder, nsnull, urlSpec, hierarchyDelimiter);</span>
<a href="#l10.1617"></a><span id="l10.1617" class="difflineplus">+</span>
<a href="#l10.1618"></a><span id="l10.1618">   if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l10.1619"></a><span id="l10.1619">   {</span>
<a href="#l10.1620"></a><span id="l10.1620">     // nsImapUrl::SetSpec() will set the imap action properly</span>
<a href="#l10.1621"></a><span id="l10.1621">     rv = imapUrl-&gt;SetImapAction(nsIImapUrl::nsImapMsgStoreCustomKeywords);</span>
<a href="#l10.1622"></a><span id="l10.1622" class="difflineminus">-    </span>
<a href="#l10.1623"></a><span id="l10.1623" class="difflineplus">+</span>
<a href="#l10.1624"></a><span id="l10.1624">     nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailNewsUrl = do_QueryInterface(imapUrl);</span>
<a href="#l10.1625"></a><span id="l10.1625">     mailNewsUrl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l10.1626"></a><span id="l10.1626">     mailNewsUrl-&gt;SetUpdatingFolder(PR_TRUE);</span>
<a href="#l10.1627"></a><span id="l10.1627">     rv = SetImapUrlSink(anImapFolder, imapUrl);</span>
<a href="#l10.1628"></a><span id="l10.1628" class="difflineminus">-    </span>
<a href="#l10.1629"></a><span id="l10.1629" class="difflineplus">+</span>
<a href="#l10.1630"></a><span id="l10.1630">     if (NS_SUCCEEDED(rv))</span>
<a href="#l10.1631"></a><span id="l10.1631">     {</span>
<a href="#l10.1632"></a><span id="l10.1632">       nsCString folderName;</span>
<a href="#l10.1633"></a><span id="l10.1633">       GetFolderName(anImapFolder, folderName);</span>
<a href="#l10.1634"></a><span id="l10.1634">       urlSpec.Append(&quot;/customKeywords&gt;UID&gt;&quot;);</span>
<a href="#l10.1635"></a><span id="l10.1635" class="difflineminus">-      urlSpec.Append(char(hierarchySeparator));</span>
<a href="#l10.1636"></a><span id="l10.1636" class="difflineplus">+      urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l10.1637"></a><span id="l10.1637">       urlSpec.Append(folderName);</span>
<a href="#l10.1638"></a><span id="l10.1638">       urlSpec.Append(&quot;&gt;&quot;);</span>
<a href="#l10.1639"></a><span id="l10.1639">       urlSpec.Append(uids);</span>
<a href="#l10.1640"></a><span id="l10.1640">       urlSpec.Append(&quot;&gt;&quot;);</span>
<a href="#l10.1641"></a><span id="l10.1641">       urlSpec.Append(flagsToAdd);</span>
<a href="#l10.1642"></a><span id="l10.1642">       urlSpec.Append(&quot;&gt;&quot;);</span>
<a href="#l10.1643"></a><span id="l10.1643">       urlSpec.Append(flagsToSubtract);</span>
<a href="#l10.1644"></a><span id="l10.1644">       rv = mailNewsUrl-&gt;SetSpec(urlSpec);</span>
<a href="#l10.1645"></a><span id="l10.1645">       if (NS_SUCCEEDED(rv))</span>
<a href="#l10.1646"></a><span id="l10.1646">         rv = GetImapConnectionAndLoadUrl(aClientEventTarget, imapUrl, nsnull, aURL);</span>
<a href="#l10.1647"></a><span id="l10.1647">     }</span>
<a href="#l10.1648"></a><span id="l10.1648">   } // if we have a url to run....</span>
<a href="#l10.1649"></a><span id="l10.1649" class="difflineminus">-  </span>
<a href="#l10.1650"></a><span id="l10.1650" class="difflineplus">+</span>
<a href="#l10.1651"></a><span id="l10.1651">   return rv;</span>
<a href="#l10.1652"></a><span id="l10.1652"> }</span>
<a href="#l10.1653"></a><span id="l10.1653"> </span>
<a href="#l10.1654"></a><span id="l10.1654"> </span>
<a href="#l10.1655"></a><span id="l10.1655"> NS_IMETHODIMP nsImapService::DownloadMessagesForOffline(const nsACString &amp;messageIds, </span>
<a href="#l10.1656"></a><span id="l10.1656">                                                         nsIMsgFolder *aFolder, </span>
<a href="#l10.1657"></a><span id="l10.1657">                                                         nsIUrlListener *aUrlListener, </span>
<a href="#l10.1658"></a><span id="l10.1658">                                                         nsIMsgWindow *aMsgWindow)</span>
<a href="#l10.1659"></a><span id="l10.1659"> {</span>
<a href="#l10.1660"></a><span id="l10.1660">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l10.1661"></a><span id="l10.1661" class="difflineminus">-  </span>
<a href="#l10.1662"></a><span id="l10.1662" class="difflineplus">+</span>
<a href="#l10.1663"></a><span id="l10.1663">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l10.1664"></a><span id="l10.1664">   nsCAutoString urlSpec;</span>
<a href="#l10.1665"></a><span id="l10.1665">   nsresult rv;</span>
<a href="#l10.1666"></a><span id="l10.1666" class="difflineminus">-  PRUnichar hierarchySeparator = GetHierarchyDelimiter(aFolder);</span>
<a href="#l10.1667"></a><span id="l10.1667" class="difflineplus">+  char hierarchyDelimiter = GetHierarchyDelimiter(aFolder);</span>
<a href="#l10.1668"></a><span id="l10.1668">   rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), aFolder, nsnull,</span>
<a href="#l10.1669"></a><span id="l10.1669" class="difflineminus">-                            urlSpec, hierarchySeparator);</span>
<a href="#l10.1670"></a><span id="l10.1670" class="difflineplus">+                            urlSpec, hierarchyDelimiter);</span>
<a href="#l10.1671"></a><span id="l10.1671">   if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l10.1672"></a><span id="l10.1672">   {</span>
<a href="#l10.1673"></a><span id="l10.1673">     nsCOMPtr&lt;nsIURI&gt; runningURI;</span>
<a href="#l10.1674"></a><span id="l10.1674">     // need to pass in stream listener in order to get the channel created correctly</span>
<a href="#l10.1675"></a><span id="l10.1675">     nsCOMPtr&lt;nsIImapMessageSink&gt; imapMessageSink(do_QueryInterface(aFolder, &amp;rv));</span>
<a href="#l10.1676"></a><span id="l10.1676">     imapMessageSink-&gt;SetNotifyDownloadedLines(PR_TRUE);</span>
<a href="#l10.1677"></a><span id="l10.1677">     rv = FetchMessage(imapUrl, nsImapUrl::nsImapMsgDownloadForOffline,aFolder, imapMessageSink, </span>
<a href="#l10.1678"></a><span id="l10.1678">                       aMsgWindow, nsnull, messageIds, PR_FALSE, EmptyCString(), getter_AddRefs(runningURI));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/imap/src/nsImapService.h</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapService.h</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -59,28 +59,28 @@ class nsImapService : public nsIImapServ</span>
<a href="#l11.4"></a><span id="l11.4">                       public nsIMsgMessageFetchPartService,</span>
<a href="#l11.5"></a><span id="l11.5">                       public nsIProtocolHandler,</span>
<a href="#l11.6"></a><span id="l11.6">                       public nsIMsgProtocolInfo,</span>
<a href="#l11.7"></a><span id="l11.7">                       public nsIContentHandler</span>
<a href="#l11.8"></a><span id="l11.8"> {</span>
<a href="#l11.9"></a><span id="l11.9"> public:</span>
<a href="#l11.10"></a><span id="l11.10">   nsImapService();</span>
<a href="#l11.11"></a><span id="l11.11">   virtual ~nsImapService();</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-	</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+</span>
<a href="#l11.14"></a><span id="l11.14">   NS_DECL_ISUPPORTS</span>
<a href="#l11.15"></a><span id="l11.15">   NS_DECL_NSIMSGPROTOCOLINFO</span>
<a href="#l11.16"></a><span id="l11.16">   NS_DECL_NSIIMAPSERVICE</span>
<a href="#l11.17"></a><span id="l11.17">   NS_DECL_NSIMSGMESSAGESERVICE</span>
<a href="#l11.18"></a><span id="l11.18">   NS_DECL_NSIPROTOCOLHANDLER</span>
<a href="#l11.19"></a><span id="l11.19">   NS_DECL_NSIMSGMESSAGEFETCHPARTSERVICE</span>
<a href="#l11.20"></a><span id="l11.20">   NS_DECL_NSICONTENTHANDLER</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-    </span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+</span>
<a href="#l11.23"></a><span id="l11.23"> protected:</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-  PRUnichar GetHierarchyDelimiter(nsIMsgFolder *aMsgFolder);</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-  </span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+  char GetHierarchyDelimiter(nsIMsgFolder *aMsgFolder);</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+</span>
<a href="#l11.28"></a><span id="l11.28">   nsresult GetFolderName(nsIMsgFolder *aImapFolder, nsACString &amp;aFolderName);</span>
<a href="#l11.29"></a><span id="l11.29"> </span>
<a href="#l11.30"></a><span id="l11.30">   // This is called by both FetchMessage and StreamMessage</span>
<a href="#l11.31"></a><span id="l11.31">   nsresult GetMessageFromUrl(nsIImapUrl *aImapUrl,</span>
<a href="#l11.32"></a><span id="l11.32">                              nsImapAction aImapAction,</span>
<a href="#l11.33"></a><span id="l11.33">                              nsIMsgFolder *aImapMailFolder, </span>
<a href="#l11.34"></a><span id="l11.34">                              nsIImapMessageSink *aImapMessage,</span>
<a href="#l11.35"></a><span id="l11.35">                              nsIMsgWindow *aMsgWindow,</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineat">@@ -88,69 +88,69 @@ protected:</span>
<a href="#l11.37"></a><span id="l11.37">                              PRBool aConvertDataToText,</span>
<a href="#l11.38"></a><span id="l11.38">                              nsIURI **aURL);</span>
<a href="#l11.39"></a><span id="l11.39"> </span>
<a href="#l11.40"></a><span id="l11.40">   nsresult CreateStartOfImapUrl(const nsACString &amp;aImapURI,  // a RDF URI for the current message/folder, can be empty</span>
<a href="#l11.41"></a><span id="l11.41">                                 nsIImapUrl  **imapUrl,</span>
<a href="#l11.42"></a><span id="l11.42">                                 nsIMsgFolder *aImapFolder,</span>
<a href="#l11.43"></a><span id="l11.43">                                 nsIUrlListener *aUrlListener,</span>
<a href="#l11.44"></a><span id="l11.44">                                 nsACString &amp;urlSpec,</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-								                PRUnichar &amp;hierarchyDelimiter);</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineminus">-  </span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+                                char &amp;hierarchyDelimiter);</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+</span>
<a href="#l11.49"></a><span id="l11.49">   nsresult GetImapConnectionAndLoadUrl(nsIEventTarget *aClientEventTarget, </span>
<a href="#l11.50"></a><span id="l11.50">                                        nsIImapUrl *aImapUrl,</span>
<a href="#l11.51"></a><span id="l11.51">                                        nsISupports *aConsumer,</span>
<a href="#l11.52"></a><span id="l11.52">                                        nsIURI **aURL);</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineminus">-  </span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+</span>
<a href="#l11.55"></a><span id="l11.55">   nsresult SetImapUrlSink(nsIMsgFolder *aMsgFolder, nsIImapUrl *aImapUrl);</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-  </span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+</span>
<a href="#l11.58"></a><span id="l11.58">   nsresult FetchMimePart(nsIImapUrl *aImapUrl,</span>
<a href="#l11.59"></a><span id="l11.59">                          nsImapAction aImapAction,</span>
<a href="#l11.60"></a><span id="l11.60">                          nsIMsgFolder *aImapMailFolder, </span>
<a href="#l11.61"></a><span id="l11.61">                          nsIImapMessageSink *aImapMessage,</span>
<a href="#l11.62"></a><span id="l11.62">                          nsIURI **aURL,</span>
<a href="#l11.63"></a><span id="l11.63">                          nsISupports *aDisplayConsumer, </span>
<a href="#l11.64"></a><span id="l11.64">                          const nsACString &amp;messageIdentifierList,</span>
<a href="#l11.65"></a><span id="l11.65">                          const nsACString &amp;mimePart);</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineminus">-  </span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+</span>
<a href="#l11.68"></a><span id="l11.68">   nsresult FolderCommand(nsIEventTarget *clientEventTarget, </span>
<a href="#l11.69"></a><span id="l11.69">                          nsIMsgFolder *imapMailFolder,</span>
<a href="#l11.70"></a><span id="l11.70">                          nsIUrlListener *urlListener,</span>
<a href="#l11.71"></a><span id="l11.71">                          const char *aCommand,</span>
<a href="#l11.72"></a><span id="l11.72">                          nsImapAction imapAction,</span>
<a href="#l11.73"></a><span id="l11.73">                          nsIMsgWindow *msgWindow,</span>
<a href="#l11.74"></a><span id="l11.74">                          nsIURI **url);</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineminus">-  </span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+</span>
<a href="#l11.77"></a><span id="l11.77">   nsresult ChangeFolderSubscription(nsIEventTarget *eventTarget, </span>
<a href="#l11.78"></a><span id="l11.78">                                     nsIMsgFolder *folder,</span>
<a href="#l11.79"></a><span id="l11.79">                                     const nsAString &amp;folderName, </span>
<a href="#l11.80"></a><span id="l11.80">                                     const char *aCommand,</span>
<a href="#l11.81"></a><span id="l11.81">                                     nsIUrlListener *urlListener,</span>
<a href="#l11.82"></a><span id="l11.82">                                     nsIURI **url);</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineminus">-  </span>
<a href="#l11.84"></a><span id="l11.84" class="difflineplus">+</span>
<a href="#l11.85"></a><span id="l11.85">   nsresult DiddleFlags(nsIEventTarget *aClientEventTarget,</span>
<a href="#l11.86"></a><span id="l11.86">                        nsIMsgFolder *aImapMailFolder, </span>
<a href="#l11.87"></a><span id="l11.87">                        nsIUrlListener *aUrlListener, </span>
<a href="#l11.88"></a><span id="l11.88">                        nsIURI **aURL,</span>
<a href="#l11.89"></a><span id="l11.89">                        const nsACString &amp;messageIdentifierList,</span>
<a href="#l11.90"></a><span id="l11.90">                        const char *howToDiddle,</span>
<a href="#l11.91"></a><span id="l11.91">                        imapMessageFlagsType flags,</span>
<a href="#l11.92"></a><span id="l11.92">                        PRBool messageIdsAreUID);</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineminus">-  </span>
<a href="#l11.94"></a><span id="l11.94" class="difflineplus">+</span>
<a href="#l11.95"></a><span id="l11.95">   nsresult OfflineAppendFromFile(nsIFile *aFile,</span>
<a href="#l11.96"></a><span id="l11.96">                                  nsIURI *aUrl,</span>
<a href="#l11.97"></a><span id="l11.97">                                  nsIMsgFolder *aDstFolder,</span>
<a href="#l11.98"></a><span id="l11.98">                                  const nsACString &amp;messageId,  // to be replaced</span>
<a href="#l11.99"></a><span id="l11.99">                                  PRBool inSelectedState, // needs to be in</span>
<a href="#l11.100"></a><span id="l11.100">                                  nsIUrlListener *aListener,</span>
<a href="#l11.101"></a><span id="l11.101">                                  nsIURI **aURL,</span>
<a href="#l11.102"></a><span id="l11.102">                                  nsISupports *aCopyState);</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineminus">-  </span>
<a href="#l11.104"></a><span id="l11.104" class="difflineplus">+</span>
<a href="#l11.105"></a><span id="l11.105">   nsresult GetServerFromUrl(nsIImapUrl *aImapUrl, nsIMsgIncomingServer **aServer);</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineminus">-  </span>
<a href="#l11.107"></a><span id="l11.107" class="difflineplus">+</span>
<a href="#l11.108"></a><span id="l11.108">   // just a little helper method...maybe it should be a macro? which helps break down a imap message uri</span>
<a href="#l11.109"></a><span id="l11.109">   // into the folder and message key equivalents</span>
<a href="#l11.110"></a><span id="l11.110">   nsresult DecomposeImapURI(const nsACString &amp;aMessageURI, nsIMsgFolder **aFolder, nsACString &amp;msgKey);</span>
<a href="#l11.111"></a><span id="l11.111">   nsresult DecomposeImapURI(const nsACString &amp;aMessageURI, nsIMsgFolder **aFolder, nsMsgKey *msgKey);</span>
<a href="#l11.112"></a><span id="l11.112"> </span>
<a href="#l11.113"></a><span id="l11.113"> </span>
<a href="#l11.114"></a><span id="l11.114">   nsCOMPtr&lt;nsICacheSession&gt; mCacheSession;  // handle to the cache session for imap.....</span>
<a href="#l11.115"></a><span id="l11.115">   PRBool mPrintingOperation;                // Flag for printing operations</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/imap/src/nsImapUtils.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapUtils.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -178,17 +178,17 @@ nsImapMailboxSpec::~nsImapMailboxSpec()</span>
<a href="#l12.4"></a><span id="l12.4"> }</span>
<a href="#l12.5"></a><span id="l12.5"> </span>
<a href="#l12.6"></a><span id="l12.6"> NS_IMPL_GETSET(nsImapMailboxSpec, Folder_UIDVALIDITY, PRInt32, mFolder_UIDVALIDITY)</span>
<a href="#l12.7"></a><span id="l12.7"> NS_IMPL_GETSET(nsImapMailboxSpec, HighestModSeq, PRUint64, mHighestModSeq)</span>
<a href="#l12.8"></a><span id="l12.8"> NS_IMPL_GETSET(nsImapMailboxSpec, NumMessages, PRInt32, mNumOfMessages)</span>
<a href="#l12.9"></a><span id="l12.9"> NS_IMPL_GETSET(nsImapMailboxSpec, NumUnseenMessages, PRInt32, mNumOfUnseenMessages)</span>
<a href="#l12.10"></a><span id="l12.10"> NS_IMPL_GETSET(nsImapMailboxSpec, NumRecentMessages, PRInt32, mNumOfRecentMessages)</span>
<a href="#l12.11"></a><span id="l12.11"> NS_IMPL_GETSET(nsImapMailboxSpec, NextUID, PRInt32, mNextUID)</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-NS_IMPL_GETSET(nsImapMailboxSpec, HierarchySeparator, char, mHierarchySeparator)</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+NS_IMPL_GETSET(nsImapMailboxSpec, HierarchyDelimiter, char, mHierarchySeparator)</span>
<a href="#l12.14"></a><span id="l12.14"> NS_IMPL_GETSET(nsImapMailboxSpec, FolderSelected, PRBool, mFolderSelected)</span>
<a href="#l12.15"></a><span id="l12.15"> NS_IMPL_GETSET(nsImapMailboxSpec, DiscoveredFromLsub, PRBool, mDiscoveredFromLsub)</span>
<a href="#l12.16"></a><span id="l12.16"> NS_IMPL_GETSET(nsImapMailboxSpec, OnlineVerified, PRBool, mOnlineVerified)</span>
<a href="#l12.17"></a><span id="l12.17"> NS_IMPL_GETSET(nsImapMailboxSpec, SupportedUserFlags, PRUint32, mSupportedUserFlags)</span>
<a href="#l12.18"></a><span id="l12.18"> NS_IMPL_GETSET(nsImapMailboxSpec, Box_flags, PRUint32, mBoxFlags)</span>
<a href="#l12.19"></a><span id="l12.19"> NS_IMPL_GETSET(nsImapMailboxSpec, NamespaceForFolder, nsIMAPNamespace *, mNamespaceForFolder)</span>
<a href="#l12.20"></a><span id="l12.20"> </span>
<a href="#l12.21"></a><span id="l12.21"> NS_IMETHODIMP nsImapMailboxSpec::GetAllocatedPathName(nsACString &amp;aAllocatedPathName)</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

