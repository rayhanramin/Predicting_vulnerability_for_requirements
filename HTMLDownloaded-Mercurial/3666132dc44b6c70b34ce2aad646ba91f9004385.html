<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 3106:3666132dc44b6c70b34ce2aad646ba91f9004385</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 3666132dc44b6c70b34ce2aad646ba91f9004385" />
<meta property="og:url" content="/comm-central/rev/3666132dc44b6c70b34ce2aad646ba91f9004385" />
<meta property="og:description" content="add filtered enumerator to msg db, r=asuth, sr=standard8, 499806" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 3666132dc44b6c70b34ce2aad646ba91f9004385 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/3666132dc44b6c70b34ce2aad646ba91f9004385">shortlog</a> |
<a href="/comm-central/log/3666132dc44b6c70b34ce2aad646ba91f9004385">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/3666132dc44b6c70b34ce2aad646ba91f9004385">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/3666132dc44b6c70b34ce2aad646ba91f9004385">files</a> |
changeset |
<a href="/comm-central/raw-rev/3666132dc44b6c70b34ce2aad646ba91f9004385">raw</a>  | <a href="/comm-central/archive/3666132dc44b6c70b34ce2aad646ba91f9004385.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
add filtered enumerator to msg db, r=asuth, sr=standard8, 499806
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#68;&#97;&#118;&#105;&#100;&#32;&#66;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#32;&#60;&#98;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#64;&#110;&#118;&#101;&#110;&#116;&#117;&#114;&#101;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 20 Jul 2009 12:37:01 -0700</td></tr>

<tr>
 <td>changeset 3106</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/3666132dc44b6c70b34ce2aad646ba91f9004385">3666132dc44b6c70b34ce2aad646ba91f9004385</a></td>
</tr>



<tr>
<td>parent 3105</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/16d40cae21eb7451c2c745ffc0ee85a4133c37d8">16d40cae21eb7451c2c745ffc0ee85a4133c37d8</a>
</td>
</tr>

<tr>
<td>child 3107</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/6412d3242e23e9e765a6c26566223ed1c6340a5e">6412d3242e23e9e765a6c26566223ed1c6340a5e</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=3666132dc44b6c70b34ce2aad646ba91f9004385">2529</a></td></tr>
<tr><td>push user</td><td>bienvenu@nventure.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 20 Jul 2009 19:36:58 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@3666132dc44b [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=3666132dc44b6c70b34ce2aad646ba91f9004385">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=3666132dc44b6c70b34ce2aad646ba91f9004385&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=3666132dc44b6c70b34ce2aad646ba91f9004385&newProject=comm-central&newRevision=3666132dc44b6c70b34ce2aad646ba91f9004385&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=3666132dc44b6c70b34ce2aad646ba91f9004385&newProject=comm-central&newRevision=3666132dc44b6c70b34ce2aad646ba91f9004385&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=3666132dc44b6c70b34ce2aad646ba91f9004385&newProject=comm-central&newRevision=3666132dc44b6c70b34ce2aad646ba91f9004385&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28asuth%29&revcount=50">asuth</a>, <a href="/comm-central/log?rev=reviewer%28standard8%29&revcount=50">standard8</a>, <a href="/comm-central/log?rev=reviewer%28499806%29&revcount=50">499806</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=499806">499806</a></td></tr>




</table></div>

<div class="page_body description">add filtered enumerator to msg db, r=asuth, sr=standard8, 499806</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/public/nsIMsgSearchTerm.idl">mailnews/base/search/public/nsIMsgSearchTerm.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/public/nsIMsgSearchTerm.idl">file</a> |
<a href="/comm-central/annotate/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/public/nsIMsgSearchTerm.idl">annotate</a> |
<a href="/comm-central/diff/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/public/nsIMsgSearchTerm.idl">diff</a> |
<a href="/comm-central/comparison/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/public/nsIMsgSearchTerm.idl">comparison</a> |
<a href="/comm-central/log/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/public/nsIMsgSearchTerm.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/public/nsIMsgSearchValue.idl">mailnews/base/search/public/nsIMsgSearchValue.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/public/nsIMsgSearchValue.idl">file</a> |
<a href="/comm-central/annotate/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/public/nsIMsgSearchValue.idl">annotate</a> |
<a href="/comm-central/diff/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/public/nsIMsgSearchValue.idl">diff</a> |
<a href="/comm-central/comparison/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/public/nsIMsgSearchValue.idl">comparison</a> |
<a href="/comm-central/log/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/public/nsIMsgSearchValue.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/public/nsMsgSearchAdapter.h">mailnews/base/search/public/nsMsgSearchAdapter.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/public/nsMsgSearchAdapter.h">file</a> |
<a href="/comm-central/annotate/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/public/nsMsgSearchAdapter.h">annotate</a> |
<a href="/comm-central/diff/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/public/nsMsgSearchAdapter.h">diff</a> |
<a href="/comm-central/comparison/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/public/nsMsgSearchAdapter.h">comparison</a> |
<a href="/comm-central/log/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/public/nsMsgSearchAdapter.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/public/nsMsgSearchCore.idl">mailnews/base/search/public/nsMsgSearchCore.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/public/nsMsgSearchCore.idl">file</a> |
<a href="/comm-central/annotate/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/public/nsMsgSearchCore.idl">annotate</a> |
<a href="/comm-central/diff/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/public/nsMsgSearchCore.idl">diff</a> |
<a href="/comm-central/comparison/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/public/nsMsgSearchCore.idl">comparison</a> |
<a href="/comm-central/log/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/public/nsMsgSearchCore.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/public/nsMsgSearchTerm.h">mailnews/base/search/public/nsMsgSearchTerm.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/public/nsMsgSearchTerm.h">file</a> |
<a href="/comm-central/annotate/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/public/nsMsgSearchTerm.h">annotate</a> |
<a href="/comm-central/diff/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/public/nsMsgSearchTerm.h">diff</a> |
<a href="/comm-central/comparison/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/public/nsMsgSearchTerm.h">comparison</a> |
<a href="/comm-central/log/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/public/nsMsgSearchTerm.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/src/nsMsgImapSearch.cpp">mailnews/base/search/src/nsMsgImapSearch.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/src/nsMsgImapSearch.cpp">file</a> |
<a href="/comm-central/annotate/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/src/nsMsgImapSearch.cpp">annotate</a> |
<a href="/comm-central/diff/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/src/nsMsgImapSearch.cpp">diff</a> |
<a href="/comm-central/comparison/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/src/nsMsgImapSearch.cpp">comparison</a> |
<a href="/comm-central/log/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/src/nsMsgImapSearch.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/src/nsMsgLocalSearch.cpp">mailnews/base/search/src/nsMsgLocalSearch.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/src/nsMsgLocalSearch.cpp">file</a> |
<a href="/comm-central/annotate/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/src/nsMsgLocalSearch.cpp">annotate</a> |
<a href="/comm-central/diff/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/src/nsMsgLocalSearch.cpp">diff</a> |
<a href="/comm-central/comparison/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/src/nsMsgLocalSearch.cpp">comparison</a> |
<a href="/comm-central/log/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/src/nsMsgLocalSearch.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/src/nsMsgSearchAdapter.cpp">mailnews/base/search/src/nsMsgSearchAdapter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/src/nsMsgSearchAdapter.cpp">file</a> |
<a href="/comm-central/annotate/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/src/nsMsgSearchAdapter.cpp">annotate</a> |
<a href="/comm-central/diff/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/src/nsMsgSearchAdapter.cpp">diff</a> |
<a href="/comm-central/comparison/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/src/nsMsgSearchAdapter.cpp">comparison</a> |
<a href="/comm-central/log/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/src/nsMsgSearchAdapter.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/src/nsMsgSearchTerm.cpp">mailnews/base/search/src/nsMsgSearchTerm.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/src/nsMsgSearchTerm.cpp">file</a> |
<a href="/comm-central/annotate/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/src/nsMsgSearchTerm.cpp">annotate</a> |
<a href="/comm-central/diff/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/src/nsMsgSearchTerm.cpp">diff</a> |
<a href="/comm-central/comparison/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/src/nsMsgSearchTerm.cpp">comparison</a> |
<a href="/comm-central/log/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/search/src/nsMsgSearchTerm.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/src/searchSpec.js">mailnews/base/src/searchSpec.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/src/searchSpec.js">file</a> |
<a href="/comm-central/annotate/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/src/searchSpec.js">annotate</a> |
<a href="/comm-central/diff/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/src/searchSpec.js">diff</a> |
<a href="/comm-central/comparison/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/src/searchSpec.js">comparison</a> |
<a href="/comm-central/log/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/base/src/searchSpec.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/db/msgdb/public/nsIMsgDatabase.idl">mailnews/db/msgdb/public/nsIMsgDatabase.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/db/msgdb/public/nsIMsgDatabase.idl">file</a> |
<a href="/comm-central/annotate/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/db/msgdb/public/nsIMsgDatabase.idl">annotate</a> |
<a href="/comm-central/diff/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/db/msgdb/public/nsIMsgDatabase.idl">diff</a> |
<a href="/comm-central/comparison/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/db/msgdb/public/nsIMsgDatabase.idl">comparison</a> |
<a href="/comm-central/log/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/db/msgdb/public/nsIMsgDatabase.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/db/msgdb/public/nsMsgDatabase.h">mailnews/db/msgdb/public/nsMsgDatabase.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/db/msgdb/public/nsMsgDatabase.h">file</a> |
<a href="/comm-central/annotate/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/db/msgdb/public/nsMsgDatabase.h">annotate</a> |
<a href="/comm-central/diff/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/db/msgdb/public/nsMsgDatabase.h">diff</a> |
<a href="/comm-central/comparison/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/db/msgdb/public/nsMsgDatabase.h">comparison</a> |
<a href="/comm-central/log/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/db/msgdb/public/nsMsgDatabase.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/db/msgdb/src/nsMsgDatabase.cpp">mailnews/db/msgdb/src/nsMsgDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/db/msgdb/src/nsMsgDatabase.cpp">file</a> |
<a href="/comm-central/annotate/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/db/msgdb/src/nsMsgDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/db/msgdb/src/nsMsgDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/db/msgdb/src/nsMsgDatabase.cpp">comparison</a> |
<a href="/comm-central/log/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/db/msgdb/src/nsMsgDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/db/msgdb/test/unit/test_filter_enumerator.js">mailnews/db/msgdb/test/unit/test_filter_enumerator.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/db/msgdb/test/unit/test_filter_enumerator.js">file</a> |
<a href="/comm-central/annotate/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/db/msgdb/test/unit/test_filter_enumerator.js">annotate</a> |
<a href="/comm-central/diff/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/db/msgdb/test/unit/test_filter_enumerator.js">diff</a> |
<a href="/comm-central/comparison/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/db/msgdb/test/unit/test_filter_enumerator.js">comparison</a> |
<a href="/comm-central/log/3666132dc44b6c70b34ce2aad646ba91f9004385/mailnews/db/msgdb/test/unit/test_filter_enumerator.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3666132dc44b6c70b34ce2aad646ba91f9004385/suite/mailnews/commandglue.js">suite/mailnews/commandglue.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3666132dc44b6c70b34ce2aad646ba91f9004385/suite/mailnews/commandglue.js">file</a> |
<a href="/comm-central/annotate/3666132dc44b6c70b34ce2aad646ba91f9004385/suite/mailnews/commandglue.js">annotate</a> |
<a href="/comm-central/diff/3666132dc44b6c70b34ce2aad646ba91f9004385/suite/mailnews/commandglue.js">diff</a> |
<a href="/comm-central/comparison/3666132dc44b6c70b34ce2aad646ba91f9004385/suite/mailnews/commandglue.js">comparison</a> |
<a href="/comm-central/log/3666132dc44b6c70b34ce2aad646ba91f9004385/suite/mailnews/commandglue.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/search/public/nsIMsgSearchTerm.idl</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/search/public/nsIMsgSearchTerm.idl</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -39,24 +39,32 @@</span>
<a href="#l1.4"></a><span id="l1.4"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l1.5"></a><span id="l1.5"> #include &quot;nsMsgSearchCore.idl&quot;</span>
<a href="#l1.6"></a><span id="l1.6"> #include &quot;nsIMsgSearchValue.idl&quot;</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> interface nsIMsgDBHdr;</span>
<a href="#l1.9"></a><span id="l1.9"> interface nsIMsgDatabase;</span>
<a href="#l1.10"></a><span id="l1.10"> interface nsIMsgSearchScopeTerm;</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-[scriptable, uuid(D14C266B-5028-448d-B3F1-B059BD0055AA)]</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+[scriptable, uuid(ff8e5017-bceb-43d5-98da-cc2b79eb0910)]</span>
<a href="#l1.14"></a><span id="l1.14"> interface nsIMsgSearchTerm : nsISupports {</span>
<a href="#l1.15"></a><span id="l1.15">     attribute nsMsgSearchAttribValue attrib;</span>
<a href="#l1.16"></a><span id="l1.16">     attribute nsMsgSearchOpValue op;</span>
<a href="#l1.17"></a><span id="l1.17">     attribute nsIMsgSearchValue value;</span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19">     attribute boolean booleanAnd;</span>
<a href="#l1.20"></a><span id="l1.20">     attribute ACString arbitraryHeader;</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+    /**</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+     * Not to be confused with arbitraryHeader, which is a header in the</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+     * rfc822 message. This is a property of the nsIMsgDBHdr, and may have</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+     * nothing to do the message headers, e.g., gloda-id.</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+     * value.str will be compared with nsIMsgHdr::GetProperty(hdrProperty).</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+     */</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+    attribute ACString hdrProperty;</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+</span>
<a href="#l1.29"></a><span id="l1.29">     /// identifier for a custom id used for this term, if any.</span>
<a href="#l1.30"></a><span id="l1.30">     attribute ACString customId;</span>
<a href="#l1.31"></a><span id="l1.31"> </span>
<a href="#l1.32"></a><span id="l1.32">     attribute boolean beginsGrouping;</span>
<a href="#l1.33"></a><span id="l1.33">     attribute boolean endsGrouping;</span>
<a href="#l1.34"></a><span id="l1.34"> </span>
<a href="#l1.35"></a><span id="l1.35">     boolean matchRfc822String(in string aString, in string charset, in boolean charsetOverride);</span>
<a href="#l1.36"></a><span id="l1.36">     boolean matchRfc2047String(in string aString, in string charset, in boolean charsetOverride);</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineat">@@ -99,16 +107,32 @@ interface nsIMsgSearchTerm : nsISupports</span>
<a href="#l1.38"></a><span id="l1.38">                                  in boolean charsetOverride,</span>
<a href="#l1.39"></a><span id="l1.39">                                  in nsIMsgDBHdr msg,</span>
<a href="#l1.40"></a><span id="l1.40">                                  in nsIMsgDatabase db,</span>
<a href="#l1.41"></a><span id="l1.41">                                  //[array, size_is(headerLength)] in string headers,</span>
<a href="#l1.42"></a><span id="l1.42">                                  in string headers,</span>
<a href="#l1.43"></a><span id="l1.43">                                  in unsigned long headerLength,</span>
<a href="#l1.44"></a><span id="l1.44">                                  in boolean forFilters);</span>
<a href="#l1.45"></a><span id="l1.45"> </span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+    /**</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+     * Compares value.str with nsIMsgHdr::GetProperty(hdrProperty).</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+     * @param msg   msg to match db hdr property of.</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+     *</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+     * @returns     true if msg matches property, false otherwise.</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+     */</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+    boolean matchHdrProperty(in nsIMsgDBHdr msg);</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+    /**</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+     * Compares value.status with the folder flags of the msg's folder.</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+     * @param msg   msgHdr whose folder's flag we want to compare.</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+     *</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+     * @returns     true if folder's flags match value.status, false otherwise.</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+     */</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+    boolean matchFolderFlag(in nsIMsgDBHdr msg);</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+</span>
<a href="#l1.62"></a><span id="l1.62">     readonly attribute boolean matchAllBeforeDeciding;</span>
<a href="#l1.63"></a><span id="l1.63"> </span>
<a href="#l1.64"></a><span id="l1.64">     readonly attribute ACString termAsString;</span>
<a href="#l1.65"></a><span id="l1.65">     boolean matchKeyword(in ACString keyword); // used for tag searches</span>
<a href="#l1.66"></a><span id="l1.66">     attribute boolean matchAll;</span>
<a href="#l1.67"></a><span id="l1.67">     /**</span>
<a href="#l1.68"></a><span id="l1.68">      * Does the message match the custom search term?</span>
<a href="#l1.69"></a><span id="l1.69">      *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/search/public/nsIMsgSearchValue.idl</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/search/public/nsIMsgSearchValue.idl</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -45,17 +45,18 @@ interface nsIMsgSearchValue : nsISupport</span>
<a href="#l2.4"></a><span id="l2.4">     // type of object</span>
<a href="#l2.5"></a><span id="l2.5">     attribute nsMsgSearchAttribValue attrib;</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7">     // accessing these will throw an exception if the above</span>
<a href="#l2.8"></a><span id="l2.8">     // attribute does not match the type!</span>
<a href="#l2.9"></a><span id="l2.9">     attribute AString str;</span>
<a href="#l2.10"></a><span id="l2.10">     attribute nsMsgPriorityValue priority;</span>
<a href="#l2.11"></a><span id="l2.11">     attribute PRTime date;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    attribute unsigned long status; // see MSG_FLAG in msgcom.h</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+     // see nsMsgMessageFlags.idl and nsMsgFolderFlags.idl</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+    attribute unsigned long status;</span>
<a href="#l2.15"></a><span id="l2.15">     attribute unsigned long size;</span>
<a href="#l2.16"></a><span id="l2.16">     attribute nsMsgKey msgKey;</span>
<a href="#l2.17"></a><span id="l2.17">     attribute long age; // in days</span>
<a href="#l2.18"></a><span id="l2.18">     attribute nsIMsgFolder folder;</span>
<a href="#l2.19"></a><span id="l2.19">     attribute nsMsgLabelValue label;</span>
<a href="#l2.20"></a><span id="l2.20">     attribute nsMsgJunkStatus junkStatus;</span>
<a href="#l2.21"></a><span id="l2.21">     /*</span>
<a href="#l2.22"></a><span id="l2.22">      * junkPercent is set by the message filter plugin, and is approximately</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/search/public/nsMsgSearchAdapter.h</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/search/public/nsMsgSearchAdapter.h</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -53,25 +53,16 @@ class nsIMsgSearchScopeTerm;</span>
<a href="#l3.4"></a><span id="l3.4"> // These Adapter classes contain the smarts to convert search criteria from</span>
<a href="#l3.5"></a><span id="l3.5"> // the canonical structures in msg_srch.h into whatever format is required</span>
<a href="#l3.6"></a><span id="l3.6"> // by their protocol.</span>
<a href="#l3.7"></a><span id="l3.7"> //</span>
<a href="#l3.8"></a><span id="l3.8"> // There is a separate Adapter class for area (pop, imap, nntp, ldap) to contain</span>
<a href="#l3.9"></a><span id="l3.9"> // the special smarts for that protocol.</span>
<a href="#l3.10"></a><span id="l3.10"> //-----------------------------------------------------------------------------</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-inline PRBool IsStringAttribute (nsMsgSearchAttribValue a)</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-{</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-  return ! (a == nsMsgSearchAttrib::Priority || a == nsMsgSearchAttrib::Date ||</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-    a == nsMsgSearchAttrib::MsgStatus || a == nsMsgSearchAttrib::MessageKey ||</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-    a == nsMsgSearchAttrib::Size || a == nsMsgSearchAttrib::AgeInDays ||</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-    a == nsMsgSearchAttrib::FolderInfo || a == nsMsgSearchAttrib::JunkStatus ||</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-    a == nsMsgSearchAttrib::JunkPercent);</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-}</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-</span>
<a href="#l3.21"></a><span id="l3.21"> class nsMsgSearchAdapter : public nsIMsgSearchAdapter</span>
<a href="#l3.22"></a><span id="l3.22"> {</span>
<a href="#l3.23"></a><span id="l3.23"> public:</span>
<a href="#l3.24"></a><span id="l3.24">   nsMsgSearchAdapter (nsIMsgSearchScopeTerm*, nsISupportsArray *);</span>
<a href="#l3.25"></a><span id="l3.25">   virtual ~nsMsgSearchAdapter ();</span>
<a href="#l3.26"></a><span id="l3.26"> </span>
<a href="#l3.27"></a><span id="l3.27">   NS_DECL_ISUPPORTS</span>
<a href="#l3.28"></a><span id="l3.28">   NS_DECL_NSIMSGSEARCHADAPTER</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/search/public/nsMsgSearchCore.idl</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/search/public/nsMsgSearchCore.idl</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -66,17 +66,17 @@ interface nsMsgSearchScope {</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5"> typedef long nsMsgSearchAttribValue;</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7"> /**</span>
<a href="#l4.8"></a><span id="l4.8">  * Definitions of search attribute types. The numerical order</span>
<a href="#l4.9"></a><span id="l4.9">  * from here will also be used to determine the order that the</span>
<a href="#l4.10"></a><span id="l4.10">  * attributes display in the filter editor.</span>
<a href="#l4.11"></a><span id="l4.11">  */</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-[scriptable, uuid(9ED17774-4748-46a6-9A18-E651E3B791F2)]</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+[scriptable, uuid(a83ca7e8-4591-4111-8fb8-fd76ac73c866)]</span>
<a href="#l4.14"></a><span id="l4.14"> interface nsMsgSearchAttrib {</span>
<a href="#l4.15"></a><span id="l4.15">     const nsMsgSearchAttribValue Custom = -2;  /* a custom term, see nsIMsgSearchCustomTerm */</span>
<a href="#l4.16"></a><span id="l4.16">     const nsMsgSearchAttribValue Default = -1;</span>
<a href="#l4.17"></a><span id="l4.17">     const nsMsgSearchAttribValue Subject = 0;  /* mail and news */</span>
<a href="#l4.18"></a><span id="l4.18">     const nsMsgSearchAttribValue Sender = 1;</span>
<a href="#l4.19"></a><span id="l4.19">     const nsMsgSearchAttribValue Body = 2;</span>
<a href="#l4.20"></a><span id="l4.20">     const nsMsgSearchAttribValue Date = 3;</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -114,25 +114,30 @@ interface nsMsgSearchAttrib {</span>
<a href="#l4.23"></a><span id="l4.23">     const nsMsgSearchAttribValue Department = 33;</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25">     // 34 - 43, reserved for ab / LDAP;</span>
<a href="#l4.26"></a><span id="l4.26">     const nsMsgSearchAttribValue HasAttachmentStatus = 44;</span>
<a href="#l4.27"></a><span id="l4.27">     const nsMsgSearchAttribValue JunkStatus = 45;</span>
<a href="#l4.28"></a><span id="l4.28">     const nsMsgSearchAttribValue JunkPercent = 46;</span>
<a href="#l4.29"></a><span id="l4.29">     const nsMsgSearchAttribValue JunkScoreOrigin = 47;</span>
<a href="#l4.30"></a><span id="l4.30">     const nsMsgSearchAttribValue Label = 48; /* mail only...can search by label */</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-    //49 is for showing customize... in ui headers start from 50 onwards up until 99.</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-    const nsMsgSearchAttribValue OtherHeader = 49;  /* for mail and news. MUST ALWAYS BE LAST attribute since we can have an arbitrary # of these... */</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-    const nsMsgSearchAttribValue kNumMsgSearchAttributes = 100;      /* must be last attribute */</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+    const nsMsgSearchAttribValue HdrProperty = 49; // uses nsIMsgSearchTerm::hdrProperty</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+    const nsMsgSearchAttribValue FolderFlag = 50; // uses nsIMsgSearchTerm::status</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+    // 51 is for showing customize - in ui headers start from 52 onwards up until 99.</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+     /** OtherHeader MUST ALWAYS BE LAST attribute since </span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+       * we can have an arbitrary # of these. The number can be changed,</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+       * however, because we never persist AttribValues as integers.</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+      */</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+    const nsMsgSearchAttribValue OtherHeader = 51; </span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+    // must be last attribute</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+    const nsMsgSearchAttribValue kNumMsgSearchAttributes = 100;</span>
<a href="#l4.46"></a><span id="l4.46"> };</span>
<a href="#l4.47"></a><span id="l4.47"> </span>
<a href="#l4.48"></a><span id="l4.48" class="difflineminus">-/* NB: If you add elements to this enum, add only to the end, since</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">- *     RULES.DAT stores enum values persistently</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">- */</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-</span>
<a href="#l4.52"></a><span id="l4.52"> typedef long nsMsgSearchOpValue;</span>
<a href="#l4.53"></a><span id="l4.53"> </span>
<a href="#l4.54"></a><span id="l4.54"> [scriptable, uuid(82cc4518-304e-11d3-831d-00a0c900d445)]</span>
<a href="#l4.55"></a><span id="l4.55"> interface nsMsgSearchOp {</span>
<a href="#l4.56"></a><span id="l4.56">     const nsMsgSearchOpValue Contains = 0; /* for text attributes      */</span>
<a href="#l4.57"></a><span id="l4.57">     const nsMsgSearchOpValue DoesntContain = 1;</span>
<a href="#l4.58"></a><span id="l4.58">     const nsMsgSearchOpValue Is = 2; /* is and isn't also apply to some non-text attrs */</span>
<a href="#l4.59"></a><span id="l4.59">     const nsMsgSearchOpValue Isnt = 3;</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineat">@@ -217,20 +222,23 @@ typedef struct nsMsgSearchValue</span>
<a href="#l4.61"></a><span id="l4.61">       PRUint32 junkPercent;</span>
<a href="#l4.62"></a><span id="l4.62">     } u;</span>
<a href="#l4.63"></a><span id="l4.63">     char *string;</span>
<a href="#l4.64"></a><span id="l4.64"> } nsMsgSearchValue;</span>
<a href="#l4.65"></a><span id="l4.65"> %}</span>
<a href="#l4.66"></a><span id="l4.66"> </span>
<a href="#l4.67"></a><span id="l4.67"> [ptr] native nsMsgSearchTerm(nsMsgSearchTerm);</span>
<a href="#l4.68"></a><span id="l4.68"> </span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+// Please note the ! at the start of this macro, which means the macro</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+// needs to enumerate the non-string attributes.</span>
<a href="#l4.71"></a><span id="l4.71"> %{C++</span>
<a href="#l4.72"></a><span id="l4.72"> #define IS_STRING_ATTRIBUTE(_a) \</span>
<a href="#l4.73"></a><span id="l4.73"> (!(_a == nsMsgSearchAttrib::Priority || _a == nsMsgSearchAttrib::Date || \</span>
<a href="#l4.74"></a><span id="l4.74">    _a == nsMsgSearchAttrib::MsgStatus || _a == nsMsgSearchAttrib::MessageKey || \</span>
<a href="#l4.75"></a><span id="l4.75">    _a == nsMsgSearchAttrib::Size || _a == nsMsgSearchAttrib::AgeInDays || \</span>
<a href="#l4.76"></a><span id="l4.76">    _a == nsMsgSearchAttrib::FolderInfo || _a == nsMsgSearchAttrib::Location || \</span>
<a href="#l4.77"></a><span id="l4.77">    _a == nsMsgSearchAttrib::Label || _a == nsMsgSearchAttrib::JunkStatus || \</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+   _a == nsMsgSearchAttrib::FolderFlag || \</span>
<a href="#l4.79"></a><span id="l4.79">    _a == nsMsgSearchAttrib::JunkPercent || _a == nsMsgSearchAttrib::HasAttachmentStatus))</span>
<a href="#l4.80"></a><span id="l4.80"> %}</span>
<a href="#l4.81"></a><span id="l4.81"> </span>
<a href="#l4.82"></a><span id="l4.82"> [ptr] native nsSearchMenuItem(nsSearchMenuItem);</span>
<a href="#l4.83"></a><span id="l4.83"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/search/public/nsMsgSearchTerm.h</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/search/public/nsMsgSearchTerm.h</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -97,20 +97,27 @@ public:</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5">   static char *  EscapeQuotesInStr(const char *str);</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7">   nsCOMPtr&lt;nsIMsgHeaderParser&gt; m_headerAddressParser;</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9">   nsMsgSearchAttribValue m_attribute;</span>
<a href="#l5.10"></a><span id="l5.10">   nsMsgSearchOpValue m_operator;</span>
<a href="#l5.11"></a><span id="l5.11">   nsMsgSearchValue m_value;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  nsMsgSearchBooleanOperator m_booleanOp;  // boolean operator to be applied to this search term and the search term which precedes it.</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-  nsCString m_arbitraryHeader;         // user specified string for the name of the arbitrary header to be used in the search</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-                    // only has a value when m_attribute = attribOtherHeader!!!!</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-        PRBool m_matchAll; // does this term match all headers?</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+  // boolean operator to be applied to this search term and the search term which precedes it.</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+  nsMsgSearchBooleanOperator m_booleanOp;</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+  // user specified string for the name of the arbitrary header to be used in the search</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+  // only has a value when m_attribute = OtherHeader!!!!</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+  nsCString m_arbitraryHeader;</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+  // db hdr property name to use - used when m_attribute = HdrProperty.</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+  nsCString m_hdrProperty;</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+  PRBool m_matchAll; // does this term match all headers?</span>
<a href="#l5.27"></a><span id="l5.27">   nsCString m_customId; // id of custom search term</span>
<a href="#l5.28"></a><span id="l5.28"> </span>
<a href="#l5.29"></a><span id="l5.29"> protected:</span>
<a href="#l5.30"></a><span id="l5.30">   nsresult MatchString (const char *stringToMatch, const char *charset,</span>
<a href="#l5.31"></a><span id="l5.31">                           PRBool *pResult);</span>
<a href="#l5.32"></a><span id="l5.32">   nsresult OutputValue(nsCString &amp;outputStr);</span>
<a href="#l5.33"></a><span id="l5.33">   nsresult ParseAttribute(char *inStream, nsMsgSearchAttribValue *attrib);</span>
<a href="#l5.34"></a><span id="l5.34">   nsresult ParseOperator(char *inStream, nsMsgSearchOpValue *value);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgImapSearch.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgImapSearch.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -126,17 +126,17 @@ nsresult nsMsgSearchOnlineMail::Encode (</span>
<a href="#l6.4"></a><span id="l6.4">     for (i = 0; i &lt; termCount &amp;&amp; asciiOnly; i++)</span>
<a href="#l6.5"></a><span id="l6.5">     {</span>
<a href="#l6.6"></a><span id="l6.6">       nsCOMPtr&lt;nsIMsgSearchTerm&gt; pTerm;</span>
<a href="#l6.7"></a><span id="l6.7">       searchTerms-&gt;QueryElementAt(i, NS_GET_IID(nsIMsgSearchTerm),</span>
<a href="#l6.8"></a><span id="l6.8">         (void **)getter_AddRefs(pTerm));</span>
<a href="#l6.9"></a><span id="l6.9">       </span>
<a href="#l6.10"></a><span id="l6.10">       nsMsgSearchAttribValue attribute;</span>
<a href="#l6.11"></a><span id="l6.11">       pTerm-&gt;GetAttrib(&amp;attribute);</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-      if (IsStringAttribute(attribute))</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+      if (IS_STRING_ATTRIBUTE(attribute))</span>
<a href="#l6.14"></a><span id="l6.14">       {</span>
<a href="#l6.15"></a><span id="l6.15">         nsString pchar;</span>
<a href="#l6.16"></a><span id="l6.16">         nsCOMPtr &lt;nsIMsgSearchValue&gt; searchValue;</span>
<a href="#l6.17"></a><span id="l6.17">         </span>
<a href="#l6.18"></a><span id="l6.18">         nsresult rv = pTerm-&gt;GetValue(getter_AddRefs(searchValue));</span>
<a href="#l6.19"></a><span id="l6.19">         if (NS_FAILED(rv) || !searchValue)</span>
<a href="#l6.20"></a><span id="l6.20">           continue;</span>
<a href="#l6.21"></a><span id="l6.21">         </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgLocalSearch.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgLocalSearch.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -636,22 +636,31 @@ nsresult nsMsgSearchOfflineMail::Process</span>
<a href="#l7.4"></a><span id="l7.4">       }</span>
<a href="#l7.5"></a><span id="l7.5">       case nsMsgSearchAttrib::JunkScoreOrigin:</span>
<a href="#l7.6"></a><span id="l7.6">       {</span>
<a href="#l7.7"></a><span id="l7.7">          nsCString junkScoreOriginStr;</span>
<a href="#l7.8"></a><span id="l7.8">          msgToMatch-&gt;GetStringProperty(&quot;junkscoreorigin&quot;, getter_Copies(junkScoreOriginStr));</span>
<a href="#l7.9"></a><span id="l7.9">          err = aTerm-&gt;MatchJunkScoreOrigin(junkScoreOriginStr.get(), &amp;result);</span>
<a href="#l7.10"></a><span id="l7.10">          break;</span>
<a href="#l7.11"></a><span id="l7.11">       }</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+      case nsMsgSearchAttrib::HdrProperty:</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+      {</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+        err = aTerm-&gt;MatchHdrProperty(msgToMatch, &amp;result);</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+        break;</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+      }</span>
<a href="#l7.17"></a><span id="l7.17">       case nsMsgSearchAttrib::Custom:</span>
<a href="#l7.18"></a><span id="l7.18">       {</span>
<a href="#l7.19"></a><span id="l7.19">         err = aTerm-&gt;MatchCustom(msgToMatch, &amp;result);</span>
<a href="#l7.20"></a><span id="l7.20">         break;</span>
<a href="#l7.21"></a><span id="l7.21">       }</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+      case nsMsgSearchAttrib::FolderFlag:</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+      {</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+        err = aTerm-&gt;MatchFolderFlag(msgToMatch, &amp;result);</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+        break;</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+      }</span>
<a href="#l7.28"></a><span id="l7.28">       default:</span>
<a href="#l7.29"></a><span id="l7.29">           // XXX todo</span>
<a href="#l7.30"></a><span id="l7.30">           // for the temporary return receipts filters, we use a custom header for Content-Type</span>
<a href="#l7.31"></a><span id="l7.31">           // but unlike the other custom headers, this one doesn't show up in the search / filter</span>
<a href="#l7.32"></a><span id="l7.32">           // UI.  we set the attrib to be nsMsgSearchAttrib::OtherHeader, where as for user</span>
<a href="#l7.33"></a><span id="l7.33">           // defined custom headers start at nsMsgSearchAttrib::OtherHeader + 1</span>
<a href="#l7.34"></a><span id="l7.34">           // Not sure if there is a better way to do this yet.  Maybe reserve the last</span>
<a href="#l7.35"></a><span id="l7.35">           // custom header for ::Content-Type?  But if we do, make sure that change</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgSearchAdapter.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgSearchAdapter.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -559,17 +559,17 @@ nsresult nsMsgSearchAdapter::EncodeImapT</span>
<a href="#l8.4"></a><span id="l8.4"> </span>
<a href="#l8.5"></a><span id="l8.5">         searchTermValue.AppendInt(sizeValue);</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7">         value = ToNewCString(searchTermValue);</span>
<a href="#l8.8"></a><span id="l8.8">         valueWasAllocated = PR_TRUE;</span>
<a href="#l8.9"></a><span id="l8.9">       }</span>
<a href="#l8.10"></a><span id="l8.10">       else</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-      if (IsStringAttribute(attrib))</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+      if (IS_STRING_ATTRIBUTE(attrib))</span>
<a href="#l8.14"></a><span id="l8.14">       {</span>
<a href="#l8.15"></a><span id="l8.15">         PRUnichar *convertedValue; // = reallyDredd ? MSG_EscapeSearchUrl (term-&gt;m_value.u.string) : msg_EscapeImapSearchProtocol(term-&gt;m_value.u.string);</span>
<a href="#l8.16"></a><span id="l8.16">         nsString searchTermValue;</span>
<a href="#l8.17"></a><span id="l8.17">         searchValue-&gt;GetStr(searchTermValue);</span>
<a href="#l8.18"></a><span id="l8.18">         // Ugly switch for Korean mail/news charsets.</span>
<a href="#l8.19"></a><span id="l8.19">         // We want to do this here because here is where</span>
<a href="#l8.20"></a><span id="l8.20">         // we know what charset we want to use.</span>
<a href="#l8.21"></a><span id="l8.21"> #ifdef DOING_CHARSET</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgSearchTerm.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgSearchTerm.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -758,31 +758,27 @@ nsresult nsMsgSearchTerm::MatchArbitrary</span>
<a href="#l9.4"></a><span id="l9.4">                                                 const char * headers,</span>
<a href="#l9.5"></a><span id="l9.5">                                                 PRUint32 headersSize,</span>
<a href="#l9.6"></a><span id="l9.6">                                                 PRBool ForFiltering,</span>
<a href="#l9.7"></a><span id="l9.7">                                                 PRBool *pResult)</span>
<a href="#l9.8"></a><span id="l9.8"> {</span>
<a href="#l9.9"></a><span id="l9.9">   NS_ENSURE_ARG_POINTER(pResult);</span>
<a href="#l9.10"></a><span id="l9.10">   *pResult = PR_FALSE;</span>
<a href="#l9.11"></a><span id="l9.11">   nsresult err = NS_OK;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  PRBool result;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-  GetMatchAllBeforeDeciding(&amp;result);</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+  PRBool matchExpected = m_operator == nsMsgSearchOp::Contains ||</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+                         m_operator == nsMsgSearchOp::Is;</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+  // init result to what we want if we don't find the header at all</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+  PRBool result = !matchExpected;</span>
<a href="#l9.19"></a><span id="l9.19"> </span>
<a href="#l9.20"></a><span id="l9.20">   nsCString dbHdrValue;</span>
<a href="#l9.21"></a><span id="l9.21">   msg-&gt;GetStringProperty(m_arbitraryHeader.get(), getter_Copies(dbHdrValue));</span>
<a href="#l9.22"></a><span id="l9.22">   if (!dbHdrValue.IsEmpty())</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">-  {</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">-    PRBool result2;</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-    err = MatchRfc2047String(dbHdrValue.get(), charset, charsetOverride, &amp;result2);  // match value with the other info...</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-    if (result != result2) // if we found a match</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-      result = result2;</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-    *pResult = result;</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-    return err;</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-  }</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+    // match value with the other info.</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+    return MatchRfc2047String(dbHdrValue.get(), charset, charsetOverride, pResult);</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+</span>
<a href="#l9.34"></a><span id="l9.34">   nsMsgBodyHandler * bodyHandler = new nsMsgBodyHandler (scope, offset,length, msg, db, headers, headersSize, ForFiltering);</span>
<a href="#l9.35"></a><span id="l9.35">   if (!bodyHandler)</span>
<a href="#l9.36"></a><span id="l9.36">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l9.37"></a><span id="l9.37"> </span>
<a href="#l9.38"></a><span id="l9.38">   bodyHandler-&gt;SetStripHeaders (PR_FALSE);</span>
<a href="#l9.39"></a><span id="l9.39"> </span>
<a href="#l9.40"></a><span id="l9.40"> </span>
<a href="#l9.41"></a><span id="l9.41">   nsCAutoString buf;</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineat">@@ -823,33 +819,57 @@ nsresult nsMsgSearchTerm::MatchArbitrary</span>
<a href="#l9.43"></a><span id="l9.43">         *end = '\0';  // eat up the white space</span>
<a href="#l9.44"></a><span id="l9.44">         end--;      // move back and examine the previous character....</span>
<a href="#l9.45"></a><span id="l9.45">       }</span>
<a href="#l9.46"></a><span id="l9.46"> </span>
<a href="#l9.47"></a><span id="l9.47">       // Make sure buf has info besides just the header.</span>
<a href="#l9.48"></a><span id="l9.48">       // Otherwise, it's just an empty header.</span>
<a href="#l9.49"></a><span id="l9.49">       if (headerValue &lt; buf_end &amp;&amp; *headerValue)</span>
<a href="#l9.50"></a><span id="l9.50">       {</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-        PRBool result2;</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineminus">-        err = MatchRfc2047String(headerValue, charset, charsetOverride, &amp;result2);  // match value with the other info...</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineminus">-        if (result != result2) // if we found a match</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+        PRBool stringMatches;</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+        // match value with the other info.</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+        err = MatchRfc2047String(headerValue, charset, charsetOverride, &amp;stringMatches);</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+        if (matchExpected == stringMatches) // if we found a match</span>
<a href="#l9.58"></a><span id="l9.58">         {</span>
<a href="#l9.59"></a><span id="l9.59">           searchingHeaders = PR_FALSE;   // then stop examining the headers</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">-          result = result2;</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+          result = stringMatches;</span>
<a href="#l9.62"></a><span id="l9.62">         }</span>
<a href="#l9.63"></a><span id="l9.63">       }</span>
<a href="#l9.64"></a><span id="l9.64">     }</span>
<a href="#l9.65"></a><span id="l9.65">     if (EMPTY_MESSAGE_LINE(buf))</span>
<a href="#l9.66"></a><span id="l9.66">       searchingHeaders = PR_FALSE;</span>
<a href="#l9.67"></a><span id="l9.67">   }</span>
<a href="#l9.68"></a><span id="l9.68">   delete bodyHandler;</span>
<a href="#l9.69"></a><span id="l9.69">   *pResult = result;</span>
<a href="#l9.70"></a><span id="l9.70">   return err;</span>
<a href="#l9.71"></a><span id="l9.71"> }</span>
<a href="#l9.72"></a><span id="l9.72"> </span>
<a href="#l9.73"></a><span id="l9.73" class="difflineplus">+NS_IMETHODIMP nsMsgSearchTerm::MatchHdrProperty(nsIMsgDBHdr *aHdr, PRBool *aResult)</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineplus">+{</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aHdr);</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineplus">+</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineplus">+  nsCString dbHdrValue;</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineplus">+  aHdr-&gt;GetStringProperty(m_hdrProperty.get(), getter_Copies(dbHdrValue));</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineplus">+  nsresult rv = MatchString(dbHdrValue.get(), nsnull, aResult);</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineplus">+  return rv;</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineplus">+}</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineplus">+</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineplus">+NS_IMETHODIMP nsMsgSearchTerm::MatchFolderFlag(nsIMsgDBHdr *aMsgToMatch, PRBool *aResult)</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineplus">+{</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aMsgToMatch);</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineplus">+  nsresult rv = aMsgToMatch-&gt;GetFolder(getter_AddRefs(msgFolder));</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineplus">+  PRUint32 folderFlags;</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineplus">+  msgFolder-&gt;GetFlags(&amp;folderFlags);</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineplus">+  return MatchStatus(folderFlags, aResult);</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineplus">+}</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineplus">+</span>
<a href="#l9.96"></a><span id="l9.96"> nsresult nsMsgSearchTerm::MatchBody (nsIMsgSearchScopeTerm *scope, PRUint32 offset, PRUint32 length /*in lines*/, const char *folderCharset,</span>
<a href="#l9.97"></a><span id="l9.97">                                       nsIMsgDBHdr *msg, nsIMsgDatabase* db, PRBool *pResult)</span>
<a href="#l9.98"></a><span id="l9.98"> {</span>
<a href="#l9.99"></a><span id="l9.99">   NS_ENSURE_ARG_POINTER(pResult);</span>
<a href="#l9.100"></a><span id="l9.100">   nsresult err = NS_OK;</span>
<a href="#l9.101"></a><span id="l9.101"> </span>
<a href="#l9.102"></a><span id="l9.102">   PRBool result = PR_FALSE;</span>
<a href="#l9.103"></a><span id="l9.103">   *pResult = PR_FALSE;</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineat">@@ -1730,16 +1750,31 @@ nsMsgSearchTerm::GetArbitraryHeader(nsAC</span>
<a href="#l9.105"></a><span id="l9.105"> NS_IMETHODIMP</span>
<a href="#l9.106"></a><span id="l9.106"> nsMsgSearchTerm::SetArbitraryHeader(const nsACString &amp;aValue)</span>
<a href="#l9.107"></a><span id="l9.107"> {</span>
<a href="#l9.108"></a><span id="l9.108">     m_arbitraryHeader = aValue;</span>
<a href="#l9.109"></a><span id="l9.109">     ToLowerCaseExceptSpecials(m_arbitraryHeader);</span>
<a href="#l9.110"></a><span id="l9.110">     return NS_OK;</span>
<a href="#l9.111"></a><span id="l9.111"> }</span>
<a href="#l9.112"></a><span id="l9.112"> </span>
<a href="#l9.113"></a><span id="l9.113" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineplus">+nsMsgSearchTerm::GetHdrProperty(nsACString &amp;aResult)</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineplus">+{</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineplus">+  aResult = m_hdrProperty;</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineplus">+}</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineplus">+</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineplus">+nsMsgSearchTerm::SetHdrProperty(const nsACString &amp;aValue)</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineplus">+{</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineplus">+  m_hdrProperty = aValue;</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineplus">+  ToLowerCaseExceptSpecials(m_hdrProperty);</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineplus">+}</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineplus">+</span>
<a href="#l9.128"></a><span id="l9.128"> NS_IMPL_GETSET(nsMsgSearchTerm, BeginsGrouping, PRBool, mEndsGrouping)</span>
<a href="#l9.129"></a><span id="l9.129"> NS_IMPL_GETSET(nsMsgSearchTerm, EndsGrouping, PRBool, mEndsGrouping)</span>
<a href="#l9.130"></a><span id="l9.130"> </span>
<a href="#l9.131"></a><span id="l9.131"> //</span>
<a href="#l9.132"></a><span id="l9.132"> // Certain possible standard values of a message database row also sometimes</span>
<a href="#l9.133"></a><span id="l9.133"> // appear as header values. To prevent a naming collision, we use all</span>
<a href="#l9.134"></a><span id="l9.134"> // lower case for the standard headers, and first capital when those</span>
<a href="#l9.135"></a><span id="l9.135"> // same strings are requested as arbitrary headers. This routine is used</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineat">@@ -1955,16 +1990,17 @@ nsresult nsMsgResultElement::AssignValue</span>
<a href="#l9.137"></a><span id="l9.137">   case nsMsgSearchAttrib::Priority:</span>
<a href="#l9.138"></a><span id="l9.138">     err = src-&gt;GetPriority(&amp;dst-&gt;u.priority);</span>
<a href="#l9.139"></a><span id="l9.139">     break;</span>
<a href="#l9.140"></a><span id="l9.140">   case nsMsgSearchAttrib::Date:</span>
<a href="#l9.141"></a><span id="l9.141">     err = src-&gt;GetDate(&amp;dst-&gt;u.date);</span>
<a href="#l9.142"></a><span id="l9.142">     break;</span>
<a href="#l9.143"></a><span id="l9.143">   case nsMsgSearchAttrib::HasAttachmentStatus:</span>
<a href="#l9.144"></a><span id="l9.144">   case nsMsgSearchAttrib::MsgStatus:</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineplus">+  case nsMsgSearchAttrib::FolderFlag:</span>
<a href="#l9.146"></a><span id="l9.146">     err = src-&gt;GetStatus(&amp;dst-&gt;u.msgStatus);</span>
<a href="#l9.147"></a><span id="l9.147">     break;</span>
<a href="#l9.148"></a><span id="l9.148">   case nsMsgSearchAttrib::MessageKey:</span>
<a href="#l9.149"></a><span id="l9.149">     err = src-&gt;GetMsgKey(&amp;dst-&gt;u.key);</span>
<a href="#l9.150"></a><span id="l9.150">     break;</span>
<a href="#l9.151"></a><span id="l9.151">   case nsMsgSearchAttrib::AgeInDays:</span>
<a href="#l9.152"></a><span id="l9.152">     err = src-&gt;GetAge(&amp;dst-&gt;u.age);</span>
<a href="#l9.153"></a><span id="l9.153">     break;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/base/src/searchSpec.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/base/src/searchSpec.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -189,16 +189,17 @@ SearchSpec.prototype = {</span>
<a href="#l10.4"></a><span id="l10.4">     let iTerm = 0, term;</span>
<a href="#l10.5"></a><span id="l10.5">     let outTerms = aCloneTerms ? [] : aTerms;</span>
<a href="#l10.6"></a><span id="l10.6">     for (term in fixIterator(aTerms, Ci.nsIMsgSearchTerm)) {</span>
<a href="#l10.7"></a><span id="l10.7">       if (aCloneTerms) {</span>
<a href="#l10.8"></a><span id="l10.8">         let cloneTerm = this.session.createTerm();</span>
<a href="#l10.9"></a><span id="l10.9">         cloneTerm.value = term.value;</span>
<a href="#l10.10"></a><span id="l10.10">         cloneTerm.attrib = term.attrib;</span>
<a href="#l10.11"></a><span id="l10.11">         cloneTerm.arbitraryHeader = term.arbitraryHeader;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+        cloneTerm.hdrProperty = term.hdrProperty;</span>
<a href="#l10.13"></a><span id="l10.13">         cloneTerm.customId = term.customId;</span>
<a href="#l10.14"></a><span id="l10.14">         cloneTerm.op = term.op;</span>
<a href="#l10.15"></a><span id="l10.15">         cloneTerm.booleanAnd = term.booleanAnd;</span>
<a href="#l10.16"></a><span id="l10.16">         cloneTerm.matchAll = term.matchAll;</span>
<a href="#l10.17"></a><span id="l10.17">         term = cloneTerm;</span>
<a href="#l10.18"></a><span id="l10.18">         outTerms.push(term);</span>
<a href="#l10.19"></a><span id="l10.19">       }</span>
<a href="#l10.20"></a><span id="l10.20">       if (iTerm == 0) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsIMsgDatabase.idl</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsIMsgDatabase.idl</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -67,16 +67,17 @@ interface nsIMsgDBHdr;</span>
<a href="#l11.4"></a><span id="l11.4"> interface nsISimpleEnumerator;</span>
<a href="#l11.5"></a><span id="l11.5"> interface nsIMsgThread;</span>
<a href="#l11.6"></a><span id="l11.6"> interface nsIDBFolderInfo;</span>
<a href="#l11.7"></a><span id="l11.7"> interface nsIMsgOfflineImapOperation;</span>
<a href="#l11.8"></a><span id="l11.8"> interface nsIMsgFolder;</span>
<a href="#l11.9"></a><span id="l11.9"> interface nsIOutputStream;</span>
<a href="#l11.10"></a><span id="l11.10"> interface nsIUrlListener;</span>
<a href="#l11.11"></a><span id="l11.11"> interface nsILocalFile;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+interface nsIArray;</span>
<a href="#l11.13"></a><span id="l11.13"> </span>
<a href="#l11.14"></a><span id="l11.14"> [ptr] native octetPtr(PRUint8);</span>
<a href="#l11.15"></a><span id="l11.15"> </span>
<a href="#l11.16"></a><span id="l11.16"> typedef unsigned long nsMsgRetainByPreference;</span>
<a href="#l11.17"></a><span id="l11.17"> </span>
<a href="#l11.18"></a><span id="l11.18"> </span>
<a href="#l11.19"></a><span id="l11.19"> [scriptable, uuid(b01d6b3b-78c2-4958-b836-2259c76dbc24)]</span>
<a href="#l11.20"></a><span id="l11.20"> </span>
<a href="#l11.21"></a><span id="l11.21" class="difflineat">@@ -290,16 +291,48 @@ interface nsIMsgDatabase : nsIDBChangeAn</span>
<a href="#l11.22"></a><span id="l11.22">   nsIMsgDBHdr CopyHdrFromExistingHdr(in nsMsgKey key, in nsIMsgDBHdr existingHdr, in boolean addHdrToDB);</span>
<a href="#l11.23"></a><span id="l11.23"> </span>
<a href="#l11.24"></a><span id="l11.24">   [noscript] void ListAllKeys(in nsMsgKeyArrayRef outputKeys);</span>
<a href="#l11.25"></a><span id="l11.25"> </span>
<a href="#l11.26"></a><span id="l11.26">   nsISimpleEnumerator EnumerateMessages();</span>
<a href="#l11.27"></a><span id="l11.27">   nsISimpleEnumerator ReverseEnumerateMessages();</span>
<a href="#l11.28"></a><span id="l11.28">   nsISimpleEnumerator EnumerateThreads();</span>
<a href="#l11.29"></a><span id="l11.29"> </span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+  /**</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+   * Get an enumerator for use with nextMatchingHdrs. The enumerator</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+   * will only return messages that match the passed-in search terms.</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+   *</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+   * @param     searchTerms       array of search terms to evaluate.</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+   * @param     reverse           start at the end, defaults to false.</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+   *</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+   * @returns   an enumerator for passing into nextMatchingHdrs</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+   */</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+  nsISimpleEnumerator getFilterEnumerator(in nsIArray searchTerms,</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+                                          [optional] in boolean reverse);</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+  /**</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+   * Get the next N matching headers using a filter enumerator</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+   * obtained by calling getFilterEnumerator.</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+   *</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+   * @param     enumerator -      This *must* be a filter enumerator</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+   * @param     numHdrsToLookAt   if non 0, the number of hdrs to advance the</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+   *                              enumerator before returning.</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+   * @param     maxResults        if non 0, the max results to return.</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+   * @param     matchingHdrs      if non null, array of matching hdrs.</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+   * @param     numMatches        if non null, the number of matching hdrs.</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+   *</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+   * @returns   false, if done, true if more hdrs to look at.</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+   */</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+  boolean nextMatchingHdrs(in nsISimpleEnumerator enumerator,</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+                           in long numHdrsToLookAt,</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+                           in long maxResults,</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+                           in nsIMutableArray matchingHdrs,</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+                           out long numMatches);</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineplus">+</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+</span>
<a href="#l11.62"></a><span id="l11.62">   // count the total and unread msgs, and adjust global count if needed</span>
<a href="#l11.63"></a><span id="l11.63">   void syncCounts();</span>
<a href="#l11.64"></a><span id="l11.64"> </span>
<a href="#l11.65"></a><span id="l11.65">   nsIMsgThread GetThreadContainingMsgHdr(in nsIMsgDBHdr msgHdr) ;</span>
<a href="#l11.66"></a><span id="l11.66"> </span>
<a href="#l11.67"></a><span id="l11.67">   // helpers for user command functions like delete, mark read, etc.</span>
<a href="#l11.68"></a><span id="l11.68"> </span>
<a href="#l11.69"></a><span id="l11.69">   void MarkHdrRead(in nsIMsgDBHdr msgHdr, in boolean bRead,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsMsgDatabase.h</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsMsgDatabase.h</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -44,16 +44,17 @@</span>
<a href="#l12.4"></a><span id="l12.4"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l12.5"></a><span id="l12.5"> #include &quot;nsIDBChangeListener.h&quot;</span>
<a href="#l12.6"></a><span id="l12.6"> #include &quot;nsIDBChangeAnnouncer.h&quot;</span>
<a href="#l12.7"></a><span id="l12.7"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l12.8"></a><span id="l12.8"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l12.9"></a><span id="l12.9"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l12.10"></a><span id="l12.10"> #include &quot;nsDBFolderInfo.h&quot;</span>
<a href="#l12.11"></a><span id="l12.11"> #include &quot;nsICollation.h&quot;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+#include &quot;nsIMsgSearchSession.h&quot;</span>
<a href="#l12.13"></a><span id="l12.13"> #include &quot;nsIMimeConverter.h&quot;</span>
<a href="#l12.14"></a><span id="l12.14"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l12.15"></a><span id="l12.15"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l12.16"></a><span id="l12.16"> #include &quot;pldhash.h&quot;</span>
<a href="#l12.17"></a><span id="l12.17"> #include &quot;nsTArray.h&quot;</span>
<a href="#l12.18"></a><span id="l12.18"> #include &quot;nsTObserverArray.h&quot;</span>
<a href="#l12.19"></a><span id="l12.19"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l12.20"></a><span id="l12.20"> class ListContext;</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineat">@@ -92,30 +93,47 @@ public:</span>
<a href="#l12.22"></a><span id="l12.22"> </span>
<a href="#l12.23"></a><span id="l12.23">     nsMsgDBEnumerator(nsMsgDatabase* db, nsIMdbTable *table,</span>
<a href="#l12.24"></a><span id="l12.24">                       nsMsgDBEnumeratorFilter filter, void* closure,</span>
<a href="#l12.25"></a><span id="l12.25">                       PRBool iterateForwards = PR_TRUE);</span>
<a href="#l12.26"></a><span id="l12.26">     virtual ~nsMsgDBEnumerator();</span>
<a href="#l12.27"></a><span id="l12.27"> </span>
<a href="#l12.28"></a><span id="l12.28">     void Clear();</span>
<a href="#l12.29"></a><span id="l12.29"> </span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">-protected:</span>
<a href="#l12.31"></a><span id="l12.31">     nsresult                        GetRowCursor();</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineminus">-    nsresult                        PrefetchNext();</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+    virtual nsresult                PrefetchNext();</span>
<a href="#l12.34"></a><span id="l12.34">     nsRefPtr&lt;nsMsgDatabase&gt;         mDB;</span>
<a href="#l12.35"></a><span id="l12.35">     nsCOMPtr&lt;nsIMdbTableRowCursor&gt;  mRowCursor;</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+    mdb_pos                         mRowPos;</span>
<a href="#l12.37"></a><span id="l12.37">     nsCOMPtr&lt;nsIMsgDBHdr&gt;           mResultHdr;</span>
<a href="#l12.38"></a><span id="l12.38">     PRBool                          mDone;</span>
<a href="#l12.39"></a><span id="l12.39">     PRBool                          mNextPrefetched;</span>
<a href="#l12.40"></a><span id="l12.40">     PRBool                          mIterateForwards;</span>
<a href="#l12.41"></a><span id="l12.41">     nsMsgDBEnumeratorFilter         mFilter;</span>
<a href="#l12.42"></a><span id="l12.42">     nsCOMPtr &lt;nsIMdbTable&gt;          mTable;</span>
<a href="#l12.43"></a><span id="l12.43">     void*                           mClosure;</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+    // This is used when the caller wants to limit how many headers the</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+    // enumerator looks at in any given time slice.</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+    mdb_pos                         mStopPos;</span>
<a href="#l12.47"></a><span id="l12.47"> };</span>
<a href="#l12.48"></a><span id="l12.48"> </span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+class nsMsgFilteredDBEnumerator : public nsMsgDBEnumerator</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+{</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+public:</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+  nsMsgFilteredDBEnumerator(nsMsgDatabase* db, nsIMdbTable *table,</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+                            PRBool reverse, nsIArray *searchTerms);</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineplus">+  virtual ~nsMsgFilteredDBEnumerator();</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+  nsresult InitSearchSession(nsIArray *searchTerms, nsIMsgFolder *folder);</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+protected:</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+  virtual nsresult               PrefetchNext();</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+  nsCOMPtr &lt;nsIMsgSearchSession&gt; m_searchSession;</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineplus">+};</span>
<a href="#l12.63"></a><span id="l12.63"> </span>
<a href="#l12.64"></a><span id="l12.64"> class nsMsgDatabase : public nsIMsgDatabase</span>
<a href="#l12.65"></a><span id="l12.65"> {</span>
<a href="#l12.66"></a><span id="l12.66"> public:</span>
<a href="#l12.67"></a><span id="l12.67">   friend class nsMsgDBService;</span>
<a href="#l12.68"></a><span id="l12.68">   friend class nsMsgPropertyEnumerator; // accesses m_mdbEnv and m_mdbStore</span>
<a href="#l12.69"></a><span id="l12.69"> </span>
<a href="#l12.70"></a><span id="l12.70">   NS_DECL_ISUPPORTS</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -43,16 +43,17 @@</span>
<a href="#l13.4"></a><span id="l13.4"> </span>
<a href="#l13.5"></a><span id="l13.5"> #include &quot;nscore.h&quot;</span>
<a href="#l13.6"></a><span id="l13.6"> #include &quot;msgCore.h&quot;</span>
<a href="#l13.7"></a><span id="l13.7"> #include &quot;nsMsgDatabase.h&quot;</span>
<a href="#l13.8"></a><span id="l13.8"> #include &quot;nsDBFolderInfo.h&quot;</span>
<a href="#l13.9"></a><span id="l13.9"> #include &quot;nsMsgKeySet.h&quot;</span>
<a href="#l13.10"></a><span id="l13.10"> #include &quot;nsIEnumerator.h&quot;</span>
<a href="#l13.11"></a><span id="l13.11"> #include &quot;nsMsgThread.h&quot;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+#include &quot;nsIMsgSearchTerm.h&quot;</span>
<a href="#l13.13"></a><span id="l13.13"> #include &quot;nsIMsgHeaderParser.h&quot;</span>
<a href="#l13.14"></a><span id="l13.14"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l13.15"></a><span id="l13.15"> #include &quot;nsMorkCID.h&quot;</span>
<a href="#l13.16"></a><span id="l13.16"> #include &quot;nsIMdbFactoryFactory.h&quot;</span>
<a href="#l13.17"></a><span id="l13.17"> #include &quot;prlog.h&quot;</span>
<a href="#l13.18"></a><span id="l13.18"> #include &quot;prprf.h&quot;</span>
<a href="#l13.19"></a><span id="l13.19"> #include &quot;nsTime.h&quot;</span>
<a href="#l13.20"></a><span id="l13.20"> #include &quot;nsMsgDBCID.h&quot;</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineat">@@ -2519,20 +2520,22 @@ NS_IMETHODIMP nsMsgDatabase::GetFirstNew</span>
<a href="#l13.22"></a><span id="l13.22"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l13.23"></a><span id="l13.23"> </span>
<a href="#l13.24"></a><span id="l13.24"> nsMsgDBEnumerator::nsMsgDBEnumerator(nsMsgDatabase* db,</span>
<a href="#l13.25"></a><span id="l13.25">                                      nsIMdbTable *table,</span>
<a href="#l13.26"></a><span id="l13.26">                                      nsMsgDBEnumeratorFilter filter,</span>
<a href="#l13.27"></a><span id="l13.27">                                      void* closure,</span>
<a href="#l13.28"></a><span id="l13.28">                                      PRBool iterateForwards)</span>
<a href="#l13.29"></a><span id="l13.29">     : mDB(db), mDone(PR_FALSE), mFilter(filter),</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">-      mClosure(closure), mIterateForwards(iterateForwards)</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+      mClosure(closure), mIterateForwards(iterateForwards),</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+      mStopPos(-1)</span>
<a href="#l13.33"></a><span id="l13.33"> {</span>
<a href="#l13.34"></a><span id="l13.34">   mNextPrefetched = PR_FALSE;</span>
<a href="#l13.35"></a><span id="l13.35">   mTable = table;</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+  mRowPos = 0;</span>
<a href="#l13.37"></a><span id="l13.37">   mDB-&gt;m_enumerators.AppendElement(this);</span>
<a href="#l13.38"></a><span id="l13.38"> }</span>
<a href="#l13.39"></a><span id="l13.39"> </span>
<a href="#l13.40"></a><span id="l13.40"> nsMsgDBEnumerator::~nsMsgDBEnumerator()</span>
<a href="#l13.41"></a><span id="l13.41"> {</span>
<a href="#l13.42"></a><span id="l13.42">   Clear();</span>
<a href="#l13.43"></a><span id="l13.43"> }</span>
<a href="#l13.44"></a><span id="l13.44"> </span>
<a href="#l13.45"></a><span id="l13.45" class="difflineat">@@ -2550,28 +2553,27 @@ NS_IMPL_ISUPPORTS1(nsMsgDBEnumerator, ns</span>
<a href="#l13.46"></a><span id="l13.46"> </span>
<a href="#l13.47"></a><span id="l13.47"> nsresult nsMsgDBEnumerator::GetRowCursor()</span>
<a href="#l13.48"></a><span id="l13.48"> {</span>
<a href="#l13.49"></a><span id="l13.49">   mDone = PR_FALSE;</span>
<a href="#l13.50"></a><span id="l13.50"> </span>
<a href="#l13.51"></a><span id="l13.51">   if (!mDB || !mTable)</span>
<a href="#l13.52"></a><span id="l13.52">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l13.53"></a><span id="l13.53"> </span>
<a href="#l13.54"></a><span id="l13.54" class="difflineminus">-  mdb_pos startPos;</span>
<a href="#l13.55"></a><span id="l13.55">   if (mIterateForwards)</span>
<a href="#l13.56"></a><span id="l13.56">   {</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineminus">-    startPos = -1;</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+    mRowPos = -1;</span>
<a href="#l13.59"></a><span id="l13.59">   }</span>
<a href="#l13.60"></a><span id="l13.60">   else</span>
<a href="#l13.61"></a><span id="l13.61">   {</span>
<a href="#l13.62"></a><span id="l13.62">     mdb_count numRows;</span>
<a href="#l13.63"></a><span id="l13.63">     mTable-&gt;GetCount(mDB-&gt;GetEnv(), &amp;numRows);</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineminus">-    startPos = numRows; // startPos is 0 relative.</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineplus">+    mRowPos = numRows; // startPos is 0 relative.</span>
<a href="#l13.66"></a><span id="l13.66">   }</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineminus">-  return mTable-&gt;GetTableRowCursor(mDB-&gt;GetEnv(), startPos, getter_AddRefs(mRowCursor));</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineplus">+  return mTable-&gt;GetTableRowCursor(mDB-&gt;GetEnv(), mRowPos, getter_AddRefs(mRowCursor));</span>
<a href="#l13.69"></a><span id="l13.69"> }</span>
<a href="#l13.70"></a><span id="l13.70"> </span>
<a href="#l13.71"></a><span id="l13.71"> NS_IMETHODIMP nsMsgDBEnumerator::GetNext(nsISupports **aItem)</span>
<a href="#l13.72"></a><span id="l13.72"> {</span>
<a href="#l13.73"></a><span id="l13.73">   if (!aItem)</span>
<a href="#l13.74"></a><span id="l13.74">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l13.75"></a><span id="l13.75">   nsresult rv = NS_OK;</span>
<a href="#l13.76"></a><span id="l13.76">   if (!mNextPrefetched)</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineat">@@ -2587,33 +2589,32 @@ NS_IMETHODIMP nsMsgDBEnumerator::GetNext</span>
<a href="#l13.78"></a><span id="l13.78">   }</span>
<a href="#l13.79"></a><span id="l13.79">   return rv;</span>
<a href="#l13.80"></a><span id="l13.80"> }</span>
<a href="#l13.81"></a><span id="l13.81"> </span>
<a href="#l13.82"></a><span id="l13.82"> nsresult nsMsgDBEnumerator::PrefetchNext()</span>
<a href="#l13.83"></a><span id="l13.83"> {</span>
<a href="#l13.84"></a><span id="l13.84">   nsresult rv = NS_OK;</span>
<a href="#l13.85"></a><span id="l13.85">   nsIMdbRow* hdrRow;</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineminus">-  mdb_pos rowPos;</span>
<a href="#l13.87"></a><span id="l13.87">   PRUint32 flags;</span>
<a href="#l13.88"></a><span id="l13.88"> </span>
<a href="#l13.89"></a><span id="l13.89">   if (!mRowCursor)</span>
<a href="#l13.90"></a><span id="l13.90">   {</span>
<a href="#l13.91"></a><span id="l13.91">     rv = GetRowCursor();</span>
<a href="#l13.92"></a><span id="l13.92">     if (NS_FAILED(rv))</span>
<a href="#l13.93"></a><span id="l13.93">       return rv;</span>
<a href="#l13.94"></a><span id="l13.94">   }</span>
<a href="#l13.95"></a><span id="l13.95"> </span>
<a href="#l13.96"></a><span id="l13.96">   do</span>
<a href="#l13.97"></a><span id="l13.97">   {</span>
<a href="#l13.98"></a><span id="l13.98">     mResultHdr = nsnull;</span>
<a href="#l13.99"></a><span id="l13.99">     if (mIterateForwards)</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineminus">-      rv = mRowCursor-&gt;NextRow(mDB-&gt;GetEnv(), &amp;hdrRow, &amp;rowPos);</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineplus">+      rv = mRowCursor-&gt;NextRow(mDB-&gt;GetEnv(), &amp;hdrRow, &amp;mRowPos);</span>
<a href="#l13.102"></a><span id="l13.102">     else</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineminus">-      rv = mRowCursor-&gt;PrevRow(mDB-&gt;GetEnv(), &amp;hdrRow, &amp;rowPos);</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineplus">+      rv = mRowCursor-&gt;PrevRow(mDB-&gt;GetEnv(), &amp;hdrRow, &amp;mRowPos);</span>
<a href="#l13.105"></a><span id="l13.105">     if (!hdrRow)</span>
<a href="#l13.106"></a><span id="l13.106">     {</span>
<a href="#l13.107"></a><span id="l13.107">       mDone = PR_TRUE;</span>
<a href="#l13.108"></a><span id="l13.108">       return NS_ERROR_FAILURE;</span>
<a href="#l13.109"></a><span id="l13.109">     }</span>
<a href="#l13.110"></a><span id="l13.110">     if (NS_FAILED(rv))</span>
<a href="#l13.111"></a><span id="l13.111">     {</span>
<a href="#l13.112"></a><span id="l13.112">       mDone = PR_TRUE;</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineat">@@ -2640,30 +2641,94 @@ nsresult nsMsgDBEnumerator::PrefetchNext</span>
<a href="#l13.114"></a><span id="l13.114">   }</span>
<a href="#l13.115"></a><span id="l13.115">   while (mFilter &amp;&amp; NS_FAILED(mFilter(mResultHdr, mClosure)) &amp;&amp; !(flags &amp; nsMsgMessageFlags::Expunged));</span>
<a href="#l13.116"></a><span id="l13.116"> </span>
<a href="#l13.117"></a><span id="l13.117">   if (mResultHdr)</span>
<a href="#l13.118"></a><span id="l13.118">   {</span>
<a href="#l13.119"></a><span id="l13.119">     mNextPrefetched = PR_TRUE;</span>
<a href="#l13.120"></a><span id="l13.120">     return NS_OK;</span>
<a href="#l13.121"></a><span id="l13.121">   }</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineplus">+  else</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineplus">+    mNextPrefetched = PR_FALSE;</span>
<a href="#l13.124"></a><span id="l13.124">   return NS_ERROR_FAILURE;</span>
<a href="#l13.125"></a><span id="l13.125"> }</span>
<a href="#l13.126"></a><span id="l13.126"> </span>
<a href="#l13.127"></a><span id="l13.127"> NS_IMETHODIMP nsMsgDBEnumerator::HasMoreElements(PRBool *aResult)</span>
<a href="#l13.128"></a><span id="l13.128"> {</span>
<a href="#l13.129"></a><span id="l13.129">   if (!aResult)</span>
<a href="#l13.130"></a><span id="l13.130">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l13.131"></a><span id="l13.131"> </span>
<a href="#l13.132"></a><span id="l13.132">   if (!mNextPrefetched &amp;&amp; (NS_FAILED(PrefetchNext())))</span>
<a href="#l13.133"></a><span id="l13.133">     mDone = PR_TRUE;</span>
<a href="#l13.134"></a><span id="l13.134">   *aResult = !mDone;</span>
<a href="#l13.135"></a><span id="l13.135">   return NS_OK;</span>
<a href="#l13.136"></a><span id="l13.136"> }</span>
<a href="#l13.137"></a><span id="l13.137"> </span>
<a href="#l13.138"></a><span id="l13.138" class="difflineplus">+nsMsgFilteredDBEnumerator::nsMsgFilteredDBEnumerator(nsMsgDatabase* db,</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineplus">+                                                     nsIMdbTable *table,</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineplus">+                                                     PRBool reverse,</span>
<a href="#l13.141"></a><span id="l13.141" class="difflineplus">+                                                     nsIArray *searchTerms)</span>
<a href="#l13.142"></a><span id="l13.142" class="difflineplus">+   : nsMsgDBEnumerator(db, table, nsnull, nsnull, !reverse)</span>
<a href="#l13.143"></a><span id="l13.143" class="difflineplus">+{</span>
<a href="#l13.144"></a><span id="l13.144" class="difflineplus">+}</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineplus">+</span>
<a href="#l13.146"></a><span id="l13.146" class="difflineplus">+nsMsgFilteredDBEnumerator::~nsMsgFilteredDBEnumerator()</span>
<a href="#l13.147"></a><span id="l13.147" class="difflineplus">+{</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineplus">+}</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineplus">+</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineplus">+/**</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineplus">+ * Create the search session for the enumerator,</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineplus">+ * add the scope term for &quot;folder&quot; to the search session, and add the search</span>
<a href="#l13.153"></a><span id="l13.153" class="difflineplus">+ * terms in the array to the search session.</span>
<a href="#l13.154"></a><span id="l13.154" class="difflineplus">+ */</span>
<a href="#l13.155"></a><span id="l13.155" class="difflineplus">+nsresult nsMsgFilteredDBEnumerator::InitSearchSession(nsIArray *searchTerms, nsIMsgFolder *folder)</span>
<a href="#l13.156"></a><span id="l13.156" class="difflineplus">+{</span>
<a href="#l13.157"></a><span id="l13.157" class="difflineplus">+  nsresult rv;</span>
<a href="#l13.158"></a><span id="l13.158" class="difflineplus">+  m_searchSession = do_CreateInstance(NS_MSGSEARCHSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l13.159"></a><span id="l13.159" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.160"></a><span id="l13.160" class="difflineplus">+</span>
<a href="#l13.161"></a><span id="l13.161" class="difflineplus">+  m_searchSession-&gt;AddScopeTerm(nsMsgSearchScope::offlineMail, folder);</span>
<a href="#l13.162"></a><span id="l13.162" class="difflineplus">+  // add each item in termsArray to the search session</span>
<a href="#l13.163"></a><span id="l13.163" class="difflineplus">+  PRUint32 numTerms;</span>
<a href="#l13.164"></a><span id="l13.164" class="difflineplus">+  rv = searchTerms-&gt;GetLength(&amp;numTerms);</span>
<a href="#l13.165"></a><span id="l13.165" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.166"></a><span id="l13.166" class="difflineplus">+  for (PRUint32 i = 0; i &lt; numTerms; i++)</span>
<a href="#l13.167"></a><span id="l13.167" class="difflineplus">+  {</span>
<a href="#l13.168"></a><span id="l13.168" class="difflineplus">+    nsCOMPtr &lt;nsIMsgSearchTerm&gt; searchTerm;</span>
<a href="#l13.169"></a><span id="l13.169" class="difflineplus">+    searchTerms-&gt;QueryElementAt(i, NS_GET_IID(nsIMsgSearchTerm), getter_AddRefs(searchTerm));</span>
<a href="#l13.170"></a><span id="l13.170" class="difflineplus">+    m_searchSession-&gt;AppendTerm(searchTerm);</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineplus">+  }</span>
<a href="#l13.172"></a><span id="l13.172" class="difflineplus">+  return NS_OK;</span>
<a href="#l13.173"></a><span id="l13.173" class="difflineplus">+}</span>
<a href="#l13.174"></a><span id="l13.174" class="difflineplus">+</span>
<a href="#l13.175"></a><span id="l13.175" class="difflineplus">+nsresult nsMsgFilteredDBEnumerator::PrefetchNext()</span>
<a href="#l13.176"></a><span id="l13.176" class="difflineplus">+{</span>
<a href="#l13.177"></a><span id="l13.177" class="difflineplus">+  nsresult rv;</span>
<a href="#l13.178"></a><span id="l13.178" class="difflineplus">+  do</span>
<a href="#l13.179"></a><span id="l13.179" class="difflineplus">+  {</span>
<a href="#l13.180"></a><span id="l13.180" class="difflineplus">+    rv = nsMsgDBEnumerator::PrefetchNext();</span>
<a href="#l13.181"></a><span id="l13.181" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; mResultHdr)</span>
<a href="#l13.182"></a><span id="l13.182" class="difflineplus">+    {</span>
<a href="#l13.183"></a><span id="l13.183" class="difflineplus">+      PRBool matches;</span>
<a href="#l13.184"></a><span id="l13.184" class="difflineplus">+      rv  = m_searchSession-&gt;MatchHdr(mResultHdr, mDB, &amp;matches);</span>
<a href="#l13.185"></a><span id="l13.185" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; matches)</span>
<a href="#l13.186"></a><span id="l13.186" class="difflineplus">+        break;</span>
<a href="#l13.187"></a><span id="l13.187" class="difflineplus">+      mResultHdr = nsnull;</span>
<a href="#l13.188"></a><span id="l13.188" class="difflineplus">+    }</span>
<a href="#l13.189"></a><span id="l13.189" class="difflineplus">+    else</span>
<a href="#l13.190"></a><span id="l13.190" class="difflineplus">+      break;</span>
<a href="#l13.191"></a><span id="l13.191" class="difflineplus">+  } while (mStopPos == -1 || mRowPos != mStopPos);</span>
<a href="#l13.192"></a><span id="l13.192" class="difflineplus">+</span>
<a href="#l13.193"></a><span id="l13.193" class="difflineplus">+  if (!mResultHdr)</span>
<a href="#l13.194"></a><span id="l13.194" class="difflineplus">+    mNextPrefetched = PR_FALSE;</span>
<a href="#l13.195"></a><span id="l13.195" class="difflineplus">+</span>
<a href="#l13.196"></a><span id="l13.196" class="difflineplus">+  return rv;</span>
<a href="#l13.197"></a><span id="l13.197" class="difflineplus">+}</span>
<a href="#l13.198"></a><span id="l13.198" class="difflineplus">+</span>
<a href="#l13.199"></a><span id="l13.199" class="difflineplus">+</span>
<a href="#l13.200"></a><span id="l13.200"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l13.201"></a><span id="l13.201"> </span>
<a href="#l13.202"></a><span id="l13.202"> NS_IMETHODIMP</span>
<a href="#l13.203"></a><span id="l13.203"> nsMsgDatabase::EnumerateMessages(nsISimpleEnumerator* *result)</span>
<a href="#l13.204"></a><span id="l13.204"> {</span>
<a href="#l13.205"></a><span id="l13.205">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l13.206"></a><span id="l13.206">   nsMsgDBEnumerator* e = new nsMsgDBEnumerator(this, m_mdbAllMsgHeadersTable,</span>
<a href="#l13.207"></a><span id="l13.207">                                                nsnull, nsnull);</span>
<a href="#l13.208"></a><span id="l13.208" class="difflineat">@@ -2681,16 +2746,80 @@ nsMsgDatabase::ReverseEnumerateMessages(</span>
<a href="#l13.209"></a><span id="l13.209">                                                nsnull, nsnull, PR_FALSE);</span>
<a href="#l13.210"></a><span id="l13.210">   if (!e)</span>
<a href="#l13.211"></a><span id="l13.211">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l13.212"></a><span id="l13.212">   NS_ADDREF(*result = e);</span>
<a href="#l13.213"></a><span id="l13.213">   return NS_OK;</span>
<a href="#l13.214"></a><span id="l13.214"> }</span>
<a href="#l13.215"></a><span id="l13.215"> </span>
<a href="#l13.216"></a><span id="l13.216"> NS_IMETHODIMP</span>
<a href="#l13.217"></a><span id="l13.217" class="difflineplus">+nsMsgDatabase::GetFilterEnumerator(nsIArray *searchTerms, PRBool aReverse,</span>
<a href="#l13.218"></a><span id="l13.218" class="difflineplus">+                                   nsISimpleEnumerator **aResult)</span>
<a href="#l13.219"></a><span id="l13.219" class="difflineplus">+{</span>
<a href="#l13.220"></a><span id="l13.220" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l13.221"></a><span id="l13.221" class="difflineplus">+  nsRefPtr&lt;nsMsgFilteredDBEnumerator&gt; e = </span>
<a href="#l13.222"></a><span id="l13.222" class="difflineplus">+    new nsMsgFilteredDBEnumerator(this, m_mdbAllMsgHeadersTable, aReverse,</span>
<a href="#l13.223"></a><span id="l13.223" class="difflineplus">+                                  searchTerms);</span>
<a href="#l13.224"></a><span id="l13.224" class="difflineplus">+</span>
<a href="#l13.225"></a><span id="l13.225" class="difflineplus">+  NS_ENSURE_TRUE(e, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l13.226"></a><span id="l13.226" class="difflineplus">+  nsresult rv = e-&gt;InitSearchSession(searchTerms, m_folder);</span>
<a href="#l13.227"></a><span id="l13.227" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.228"></a><span id="l13.228" class="difflineplus">+  return CallQueryInterface(e.get(), aResult);</span>
<a href="#l13.229"></a><span id="l13.229" class="difflineplus">+}</span>
<a href="#l13.230"></a><span id="l13.230" class="difflineplus">+</span>
<a href="#l13.231"></a><span id="l13.231" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l13.232"></a><span id="l13.232" class="difflineplus">+nsMsgDatabase::NextMatchingHdrs(nsISimpleEnumerator *aEnumerator,</span>
<a href="#l13.233"></a><span id="l13.233" class="difflineplus">+                                PRInt32 aNumHdrsToLookAt, PRInt32 aMaxResults,</span>
<a href="#l13.234"></a><span id="l13.234" class="difflineplus">+                                nsIMutableArray *aMatchingHdrs,</span>
<a href="#l13.235"></a><span id="l13.235" class="difflineplus">+                                PRInt32 *aNumMatches, PRBool *aResult)</span>
<a href="#l13.236"></a><span id="l13.236" class="difflineplus">+{</span>
<a href="#l13.237"></a><span id="l13.237" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aEnumerator);</span>
<a href="#l13.238"></a><span id="l13.238" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l13.239"></a><span id="l13.239" class="difflineplus">+  nsMsgFilteredDBEnumerator *enumerator =</span>
<a href="#l13.240"></a><span id="l13.240" class="difflineplus">+    static_cast&lt;nsMsgFilteredDBEnumerator *&gt; (aEnumerator);</span>
<a href="#l13.241"></a><span id="l13.241" class="difflineplus">+</span>
<a href="#l13.242"></a><span id="l13.242" class="difflineplus">+  // Force mRowPos to be initialized.</span>
<a href="#l13.243"></a><span id="l13.243" class="difflineplus">+  if (!enumerator-&gt;mRowCursor)</span>
<a href="#l13.244"></a><span id="l13.244" class="difflineplus">+    enumerator-&gt;GetRowCursor();</span>
<a href="#l13.245"></a><span id="l13.245" class="difflineplus">+</span>
<a href="#l13.246"></a><span id="l13.246" class="difflineplus">+  if (aNumHdrsToLookAt)</span>
<a href="#l13.247"></a><span id="l13.247" class="difflineplus">+  {</span>
<a href="#l13.248"></a><span id="l13.248" class="difflineplus">+    enumerator-&gt;mStopPos = enumerator-&gt;mIterateForwards ?</span>
<a href="#l13.249"></a><span id="l13.249" class="difflineplus">+      enumerator-&gt;mRowPos + aNumHdrsToLookAt :</span>
<a href="#l13.250"></a><span id="l13.250" class="difflineplus">+      enumerator-&gt;mRowPos - aNumHdrsToLookAt;</span>
<a href="#l13.251"></a><span id="l13.251" class="difflineplus">+    if (enumerator-&gt;mStopPos &lt; 0)</span>
<a href="#l13.252"></a><span id="l13.252" class="difflineplus">+      enumerator-&gt;mStopPos = 0;</span>
<a href="#l13.253"></a><span id="l13.253" class="difflineplus">+  }</span>
<a href="#l13.254"></a><span id="l13.254" class="difflineplus">+  PRInt32 numMatches = 0;</span>
<a href="#l13.255"></a><span id="l13.255" class="difflineplus">+  nsresult rv;</span>
<a href="#l13.256"></a><span id="l13.256" class="difflineplus">+  do</span>
<a href="#l13.257"></a><span id="l13.257" class="difflineplus">+  {</span>
<a href="#l13.258"></a><span id="l13.258" class="difflineplus">+    nsCOMPtr &lt;nsIMsgDBHdr&gt; nextMessage;</span>
<a href="#l13.259"></a><span id="l13.259" class="difflineplus">+    rv = enumerator-&gt;GetNext(getter_AddRefs(nextMessage));</span>
<a href="#l13.260"></a><span id="l13.260" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; nextMessage)</span>
<a href="#l13.261"></a><span id="l13.261" class="difflineplus">+    {</span>
<a href="#l13.262"></a><span id="l13.262" class="difflineplus">+      if (aMatchingHdrs)</span>
<a href="#l13.263"></a><span id="l13.263" class="difflineplus">+        aMatchingHdrs-&gt;AppendElement(nextMessage, PR_FALSE);</span>
<a href="#l13.264"></a><span id="l13.264" class="difflineplus">+      ++numMatches;</span>
<a href="#l13.265"></a><span id="l13.265" class="difflineplus">+      if (aMaxResults &amp;&amp; numMatches == aMaxResults)</span>
<a href="#l13.266"></a><span id="l13.266" class="difflineplus">+        break;</span>
<a href="#l13.267"></a><span id="l13.267" class="difflineplus">+    }</span>
<a href="#l13.268"></a><span id="l13.268" class="difflineplus">+    else</span>
<a href="#l13.269"></a><span id="l13.269" class="difflineplus">+      break;</span>
<a href="#l13.270"></a><span id="l13.270" class="difflineplus">+  }</span>
<a href="#l13.271"></a><span id="l13.271" class="difflineplus">+  while (PR_TRUE);</span>
<a href="#l13.272"></a><span id="l13.272" class="difflineplus">+</span>
<a href="#l13.273"></a><span id="l13.273" class="difflineplus">+  if (aNumMatches)</span>
<a href="#l13.274"></a><span id="l13.274" class="difflineplus">+    *aNumMatches = numMatches;</span>
<a href="#l13.275"></a><span id="l13.275" class="difflineplus">+</span>
<a href="#l13.276"></a><span id="l13.276" class="difflineplus">+  *aResult = !enumerator-&gt;mDone;</span>
<a href="#l13.277"></a><span id="l13.277" class="difflineplus">+  return NS_OK;</span>
<a href="#l13.278"></a><span id="l13.278" class="difflineplus">+}</span>
<a href="#l13.279"></a><span id="l13.279" class="difflineplus">+</span>
<a href="#l13.280"></a><span id="l13.280" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l13.281"></a><span id="l13.281"> nsMsgDatabase::SyncCounts()</span>
<a href="#l13.282"></a><span id="l13.282"> {</span>
<a href="#l13.283"></a><span id="l13.283">   nsCOMPtr &lt;nsIMsgDBHdr&gt; pHeader;</span>
<a href="#l13.284"></a><span id="l13.284">   nsCOMPtr &lt;nsISimpleEnumerator&gt; hdrs;</span>
<a href="#l13.285"></a><span id="l13.285">   nsresult rv = EnumerateMessages(getter_AddRefs(hdrs));</span>
<a href="#l13.286"></a><span id="l13.286">   if (NS_FAILED(rv))</span>
<a href="#l13.287"></a><span id="l13.287">     return rv;</span>
<a href="#l13.288"></a><span id="l13.288">   PRBool hasMore = PR_FALSE;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">new file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- /dev/null</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ b/mailnews/db/msgdb/test/unit/test_filter_enumerator.js</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -0,0 +1,117 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineplus">+load(&quot;../../mailnews/resources/messageGenerator.js&quot;);</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineplus">+</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineplus">+var gMessages = [];</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineplus">+const nsMsgSearchScope  = Ci.nsMsgSearchScope;</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineplus">+const nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineplus">+const nsMsgSearchOp     = Ci.nsMsgSearchOp;</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineplus">+const nsMsgMessageFlags = Ci.nsMsgMessageFlags;</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+const nsMsgFolderFlags = Ci.nsMsgFolderFlags;</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+const kSetCount = 13;</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+const kNumExpectedMatches = 10;</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+function setupGlobals()</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+{</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+  loadLocalMailAccount();</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+  // Create a message generator</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+  gMessageGenerator = new MessageGenerator();</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineplus">+  let localInbox = gLocalInboxFolder.QueryInterface(Ci.nsIMsgLocalMailFolder);</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+  for (let i = 0; i &lt; kSetCount; i++) {</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+    let message = gMessageGenerator.makeMessage();</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+    gMessages.push(message);</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+    localInbox.addMessage(message.toMboxString());</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+  }</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+}</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+function run_test() {</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+  setupGlobals();</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+  do_test_pending();</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+  let inboxDB = gLocalInboxFolder.msgDatabase;</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+  // give messages 1,3,5 gloda-ids. These won't end up in our search hits.</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+  let msgHdr1 = inboxDB.getMsgHdrForMessageID(gMessages[0].messageId);</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+  msgHdr1.setUint32Property(&quot;gloda-id&quot;, 11111);</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+  let msgHdr3 = inboxDB.getMsgHdrForMessageID(gMessages[2].messageId);</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+  msgHdr3.setUint32Property(&quot;gloda-id&quot;, 33333);</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+  let msgHdr5 = inboxDB.getMsgHdrForMessageID(gMessages[4].messageId);</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+  msgHdr5.setUint32Property(&quot;gloda-id&quot;, 5555);</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+  // set up a search term array that will give us the array of messages</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+  // that gloda should index, as defined by this function:</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+  let searchSession = Cc[&quot;@mozilla.org/messenger/searchSession;1&quot;]</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+                        .createInstance(Ci.nsIMsgSearchSession);</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+  let searchTerms = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+  searchSession.addScopeTerm(Ci.nsMsgSearchScope.offlineMail, gLocalInboxFolder);</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+  let searchTerm = searchSession.createTerm();</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+  // Create the following search term:</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+  // (folderFlag &amp; Mail &amp;&amp; folderFlag != ImapBox) &amp;&amp;</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+  //    msg property.gloda-id isEmpty</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+  searchTerm.beginsGrouping = true;</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+  searchTerm.booleanAnd = true;</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+  searchTerm.attrib = nsMsgSearchAttrib.FolderFlag;</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+  searchTerm.op = nsMsgSearchOp.Is;</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+  let value = searchTerm.value;</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+  value.status = nsMsgFolderFlags.Mail;</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+  value.attrib = nsMsgSearchAttrib.FolderFlag;</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+  searchTerm.value = value;</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+  searchTerms.appendElement(searchTerm, false);</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+  searchTerm = searchSession.createTerm();</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+  searchTerm.booleanAnd = true;</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+  searchTerm.attrib = nsMsgSearchAttrib.FolderFlag;</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+  searchTerm.op = nsMsgSearchOp.Isnt;</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+  value = searchTerm.value;</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+  value.status = nsMsgFolderFlags.ImapBox;</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+  value.attrib = nsMsgSearchAttrib.FolderFlag;</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+  searchTerm.value = value;</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+  searchTerm.endsGrouping = true;</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+  searchTerms.appendElement(searchTerm, false);</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineplus">+</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineplus">+  searchTerm = searchSession.createTerm();</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineplus">+  searchTerm.booleanAnd = true;</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineplus">+  searchTerm.attrib = nsMsgSearchAttrib.HdrProperty;</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+  searchTerm.hdrProperty = &quot;gloda-id&quot;;</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineplus">+  searchTerm.op = nsMsgSearchOp.IsEmpty;</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineplus">+  value = searchTerm.value;</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineplus">+  value.str = &quot;gloda-id&quot;;</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+  value.attrib = nsMsgSearchAttrib.HdrProperty;</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineplus">+  searchTerm.value = value;</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineplus">+  searchTerms.appendElement(searchTerm, false);</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineplus">+</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineplus">+  let filterEnumerator = inboxDB.getFilterEnumerator(searchTerms);</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineplus">+  let numMatches = {};</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineplus">+  let keepGoing = inboxDB.nextMatchingHdrs(filterEnumerator, 100, 100, null, numMatches);</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineplus">+  do_check_eq(kNumExpectedMatches, numMatches.value);</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineplus">+  do_check_false(keepGoing);</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineplus">+  filterEnumerator = inboxDB.getFilterEnumerator(searchTerms);</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineplus">+  let matchingHdrs = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineplus">+  do {</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineplus">+    keepGoing = inboxDB.nextMatchingHdrs(filterEnumerator, 5, 5, matchingHdrs, numMatches);</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineplus">+  }</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineplus">+  while (keepGoing);</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineplus">+  do_check_eq(kNumExpectedMatches, matchingHdrs.length);</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineplus">+  let firstMatch = matchingHdrs.queryElementAt(0, Ci.nsIMsgDBHdr);</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineplus">+  do_check_eq(firstMatch.messageId, gMessages[1].messageId);</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineplus">+  let secondMatch = matchingHdrs.queryElementAt(1, Ci.nsIMsgDBHdr);</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineplus">+  do_check_eq(secondMatch.messageId, gMessages[3].messageId);</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineplus">+</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineplus">+  // try it backwards, with roller skates:</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineplus">+  filterEnumerator = inboxDB.getFilterEnumerator(searchTerms, true);</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineplus">+  matchingHdrs.clear();</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineplus">+  do {</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineplus">+    keepGoing = inboxDB.nextMatchingHdrs(filterEnumerator, 5, 5, matchingHdrs, numMatches);</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineplus">+  }</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineplus">+  while (keepGoing);</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineplus">+  do_check_eq(kNumExpectedMatches, matchingHdrs.length);</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineplus">+  let firstMatch = matchingHdrs.queryElementAt(0, Ci.nsIMsgDBHdr);</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineplus">+  do_check_eq(firstMatch.messageId, gMessages[12].messageId);</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineplus">+  let secondMatch = matchingHdrs.queryElementAt(1, Ci.nsIMsgDBHdr);</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineplus">+  do_check_eq(secondMatch.messageId, gMessages[11].messageId);</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineplus">+  let tenthMatch = matchingHdrs.queryElementAt(9, Ci.nsIMsgDBHdr);</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineplus">+  do_check_eq(tenthMatch.messageId, gMessages[1].messageId);</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineplus">+</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineplus">+  do_test_finished();</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/suite/mailnews/commandglue.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/suite/mailnews/commandglue.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -1110,16 +1110,17 @@ function CreateGroupedSearchTerms(search</span>
<a href="#l15.4"></a><span id="l15.4">   for (var i = 0; i &lt; numEntries; i++) {</span>
<a href="#l15.5"></a><span id="l15.5">     var searchTerm = searchTermsArray.GetElementAt(i).QueryInterface(Components.interfaces.nsIMsgSearchTerm); </span>
<a href="#l15.6"></a><span id="l15.6"> </span>
<a href="#l15.7"></a><span id="l15.7">     // clone the term, since we might be modifying it</span>
<a href="#l15.8"></a><span id="l15.8">     var searchTermForQS = searchSession.createTerm();</span>
<a href="#l15.9"></a><span id="l15.9">     searchTermForQS.value = searchTerm.value;</span>
<a href="#l15.10"></a><span id="l15.10">     searchTermForQS.attrib = searchTerm.attrib;</span>
<a href="#l15.11"></a><span id="l15.11">     searchTermForQS.arbitraryHeader = searchTerm.arbitraryHeader</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+    searchTermForQS.hdrProperty = searchTerm.hdrProperty;</span>
<a href="#l15.13"></a><span id="l15.13">     searchTermForQS.customId = searchTerm.customId</span>
<a href="#l15.14"></a><span id="l15.14">     searchTermForQS.op = searchTerm.op;</span>
<a href="#l15.15"></a><span id="l15.15"> </span>
<a href="#l15.16"></a><span id="l15.16">     // mark the first node as a group</span>
<a href="#l15.17"></a><span id="l15.17">     if (i == 0)</span>
<a href="#l15.18"></a><span id="l15.18">       searchTermForQS.beginsGrouping = true;</span>
<a href="#l15.19"></a><span id="l15.19">     else if (i == numEntries - 1)</span>
<a href="#l15.20"></a><span id="l15.20">       searchTermForQS.endsGrouping = true;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

