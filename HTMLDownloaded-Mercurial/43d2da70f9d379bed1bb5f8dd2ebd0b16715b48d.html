<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 29578:43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d" />
<meta property="og:url" content="/comm-central/rev/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d" />
<meta property="og:description" content="Bug 1637918 - Remove dead LDAP address book code. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d">shortlog</a> |
<a href="/comm-central/log/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d">files</a> |
changeset |
<a href="/comm-central/raw-rev/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d">raw</a>  | <a href="/comm-central/archive/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1637918">Bug 1637918</a> - Remove dead LDAP address book code. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 07 May 2020 21:25:00 +1200</td></tr>

<tr>
 <td>changeset 29578</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d">43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d</a></td>
</tr>



<tr>
<td>parent 29577</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b49e6cda4e016e78743e2a50ec5293a60433484e">b49e6cda4e016e78743e2a50ec5293a60433484e</a>
</td>
</tr>

<tr>
<td>child 29579</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/ced94145e95c92495ccab66e4d5ac45517bcf009">ced94145e95c92495ccab66e4d5ac45517bcf009</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d">17441</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Fri, 15 May 2020 00:41:59 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@34122197a6a4 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=34122197a6a4cfdc121496238d6f23c859ca6dc7">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=34122197a6a4cfdc121496238d6f23c859ca6dc7&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=34122197a6a4cfdc121496238d6f23c859ca6dc7&newProject=comm-central&newRevision=c2aeb710f2113c569ad196aae868330a00198b7b&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=34122197a6a4cfdc121496238d6f23c859ca6dc7&newProject=comm-central&newRevision=c2aeb710f2113c569ad196aae868330a00198b7b&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=34122197a6a4cfdc121496238d6f23c859ca6dc7&newProject=comm-central&newRevision=c2aeb710f2113c569ad196aae868330a00198b7b&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1637918">1637918</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1637918">Bug 1637918</a> - Remove dead LDAP address book code. r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/public/moz.build">mailnews/addrbook/public/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/public/moz.build">file</a> |
<a href="/comm-central/annotate/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/public/moz.build">annotate</a> |
<a href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/public/moz.build">diff</a> |
<a href="/comm-central/comparison/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/public/moz.build">comparison</a> |
<a href="/comm-central/log/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/public/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/public/nsAbBaseCID.h">mailnews/addrbook/public/nsAbBaseCID.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/public/nsAbBaseCID.h">file</a> |
<a href="/comm-central/annotate/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/public/nsAbBaseCID.h">annotate</a> |
<a href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/public/nsAbBaseCID.h">diff</a> |
<a href="/comm-central/comparison/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/public/nsAbBaseCID.h">comparison</a> |
<a href="/comm-central/log/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/public/nsAbBaseCID.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/public/nsIAbLDAPCard.idl">mailnews/addrbook/public/nsIAbLDAPCard.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/public/nsIAbLDAPCard.idl">diff</a> |
<a href="/comm-central/comparison/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/public/nsIAbLDAPCard.idl">comparison</a> |
<a href="/comm-central/log/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/public/nsIAbLDAPCard.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/public/nsIAbLDAPDirectory.idl">mailnews/addrbook/public/nsIAbLDAPDirectory.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/public/nsIAbLDAPDirectory.idl">file</a> |
<a href="/comm-central/annotate/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/public/nsIAbLDAPDirectory.idl">annotate</a> |
<a href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/public/nsIAbLDAPDirectory.idl">diff</a> |
<a href="/comm-central/comparison/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/public/nsIAbLDAPDirectory.idl">comparison</a> |
<a href="/comm-central/log/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/public/nsIAbLDAPDirectory.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/public/nsIAbLDAPReplicationData.idl">mailnews/addrbook/public/nsIAbLDAPReplicationData.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/public/nsIAbLDAPReplicationData.idl">file</a> |
<a href="/comm-central/annotate/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/public/nsIAbLDAPReplicationData.idl">annotate</a> |
<a href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/public/nsIAbLDAPReplicationData.idl">diff</a> |
<a href="/comm-central/comparison/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/public/nsIAbLDAPReplicationData.idl">comparison</a> |
<a href="/comm-central/log/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/public/nsIAbLDAPReplicationData.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/moz.build">mailnews/addrbook/src/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/moz.build">file</a> |
<a href="/comm-central/annotate/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/moz.build">annotate</a> |
<a href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/moz.build">diff</a> |
<a href="/comm-central/comparison/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/moz.build">comparison</a> |
<a href="/comm-central/log/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPCard.cpp">mailnews/addrbook/src/nsAbLDAPCard.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPCard.cpp">diff</a> |
<a href="/comm-central/comparison/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPCard.cpp">comparison</a> |
<a href="/comm-central/log/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPCard.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPCard.h">mailnews/addrbook/src/nsAbLDAPCard.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPCard.h">diff</a> |
<a href="/comm-central/comparison/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPCard.h">comparison</a> |
<a href="/comm-central/log/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPCard.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp">mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp">diff</a> |
<a href="/comm-central/comparison/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp">comparison</a> |
<a href="/comm-central/log/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPChangeLogData.h">mailnews/addrbook/src/nsAbLDAPChangeLogData.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPChangeLogData.h">diff</a> |
<a href="/comm-central/comparison/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPChangeLogData.h">comparison</a> |
<a href="/comm-central/log/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPChangeLogData.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPChangeLogQuery.cpp">mailnews/addrbook/src/nsAbLDAPChangeLogQuery.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPChangeLogQuery.cpp">diff</a> |
<a href="/comm-central/comparison/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPChangeLogQuery.cpp">comparison</a> |
<a href="/comm-central/log/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPChangeLogQuery.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPChangeLogQuery.h">mailnews/addrbook/src/nsAbLDAPChangeLogQuery.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPChangeLogQuery.h">diff</a> |
<a href="/comm-central/comparison/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPChangeLogQuery.h">comparison</a> |
<a href="/comm-central/log/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPChangeLogQuery.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">mailnews/addrbook/src/nsAbLDAPDirectory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">file</a> |
<a href="/comm-central/annotate/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">annotate</a> |
<a href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">diff</a> |
<a href="/comm-central/comparison/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">comparison</a> |
<a href="/comm-central/log/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPDirectory.h">mailnews/addrbook/src/nsAbLDAPDirectory.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPDirectory.h">file</a> |
<a href="/comm-central/annotate/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPDirectory.h">annotate</a> |
<a href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPDirectory.h">diff</a> |
<a href="/comm-central/comparison/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPDirectory.h">comparison</a> |
<a href="/comm-central/log/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPDirectory.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPDirectoryModify.cpp">mailnews/addrbook/src/nsAbLDAPDirectoryModify.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPDirectoryModify.cpp">diff</a> |
<a href="/comm-central/comparison/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPDirectoryModify.cpp">comparison</a> |
<a href="/comm-central/log/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPDirectoryModify.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPDirectoryModify.h">mailnews/addrbook/src/nsAbLDAPDirectoryModify.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPDirectoryModify.h">diff</a> |
<a href="/comm-central/comparison/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPDirectoryModify.h">comparison</a> |
<a href="/comm-central/log/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPDirectoryModify.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">file</a> |
<a href="/comm-central/annotate/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">annotate</a> |
<a href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">diff</a> |
<a href="/comm-central/comparison/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">comparison</a> |
<a href="/comm-central/log/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp">mailnews/addrbook/src/nsAbLDAPReplicationData.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp">file</a> |
<a href="/comm-central/annotate/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp">annotate</a> |
<a href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp">diff</a> |
<a href="/comm-central/comparison/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp">comparison</a> |
<a href="/comm-central/log/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPReplicationData.h">mailnews/addrbook/src/nsAbLDAPReplicationData.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPReplicationData.h">file</a> |
<a href="/comm-central/annotate/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPReplicationData.h">annotate</a> |
<a href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPReplicationData.h">diff</a> |
<a href="/comm-central/comparison/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPReplicationData.h">comparison</a> |
<a href="/comm-central/log/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPReplicationData.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPReplicationService.cpp">mailnews/addrbook/src/nsAbLDAPReplicationService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPReplicationService.cpp">file</a> |
<a href="/comm-central/annotate/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPReplicationService.cpp">annotate</a> |
<a href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPReplicationService.cpp">diff</a> |
<a href="/comm-central/comparison/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPReplicationService.cpp">comparison</a> |
<a href="/comm-central/log/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPReplicationService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPReplicationService.h">mailnews/addrbook/src/nsAbLDAPReplicationService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPReplicationService.h">file</a> |
<a href="/comm-central/annotate/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPReplicationService.h">annotate</a> |
<a href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPReplicationService.h">diff</a> |
<a href="/comm-central/comparison/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPReplicationService.h">comparison</a> |
<a href="/comm-central/log/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/addrbook/src/nsAbLDAPReplicationService.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/build/nsMailModule.cpp">mailnews/build/nsMailModule.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/build/nsMailModule.cpp">file</a> |
<a href="/comm-central/annotate/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/build/nsMailModule.cpp">annotate</a> |
<a href="/comm-central/diff/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/build/nsMailModule.cpp">diff</a> |
<a href="/comm-central/comparison/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/build/nsMailModule.cpp">comparison</a> |
<a href="/comm-central/log/43d2da70f9d379bed1bb5f8dd2ebd0b16715b48d/mailnews/build/nsMailModule.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/addrbook/public/moz.build</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/addrbook/public/moz.build</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -18,17 +18,16 @@ XPIDL_SOURCES += [</span>
<a href="#l1.4"></a><span id="l1.4">     'nsIAbManager.idl',</span>
<a href="#l1.5"></a><span id="l1.5">     'nsIAddbookUrl.idl',</span>
<a href="#l1.6"></a><span id="l1.6">     'nsIAddrDatabase.idl',</span>
<a href="#l1.7"></a><span id="l1.7">     'nsIMsgVCardService.idl',</span>
<a href="#l1.8"></a><span id="l1.8"> ]</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> if CONFIG['MOZ_LDAP_XPCOM']:</span>
<a href="#l1.11"></a><span id="l1.11">     XPIDL_SOURCES += [</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-        'nsIAbLDAPCard.idl',</span>
<a href="#l1.13"></a><span id="l1.13">         'nsIAbLDAPDirectory.idl',</span>
<a href="#l1.14"></a><span id="l1.14">         'nsIAbLDAPReplicationData.idl',</span>
<a href="#l1.15"></a><span id="l1.15">         'nsIAbLDAPReplicationQuery.idl',</span>
<a href="#l1.16"></a><span id="l1.16">         'nsIAbLDAPReplicationService.idl',</span>
<a href="#l1.17"></a><span id="l1.17">     ]</span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19"> if CONFIG['OS_ARCH'] == 'WINNT' and CONFIG['MOZ_MAPI_SUPPORT']:</span>
<a href="#l1.20"></a><span id="l1.20">     XPIDL_SOURCES += [</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/addrbook/public/nsAbBaseCID.h</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/addrbook/public/nsAbBaseCID.h</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -229,28 +229,16 @@</span>
<a href="#l2.4"></a><span id="l2.4"> #define NS_ABLDAPDIRECTORYQUERY_CID                  \</span>
<a href="#l2.5"></a><span id="l2.5">   {                                                  \</span>
<a href="#l2.6"></a><span id="l2.6">     0x783E2777, 0x66D7, 0x4826, {                    \</span>
<a href="#l2.7"></a><span id="l2.7">       0x9E, 0x4B, 0x8A, 0xB5, 0x8C, 0x22, 0x8A, 0x53 \</span>
<a href="#l2.8"></a><span id="l2.8">     }                                                \</span>
<a href="#l2.9"></a><span id="l2.9">   }</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11"> //</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-// nsAbLDAPCard</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-//</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-#define NS_ABLDAPCARD_CONTRACTID &quot;@mozilla.org/addressbook/moz-abldapcard&quot;</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-#define NS_ABLDAPCARD_CID                            \</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-  {                                                  \</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-    0x10307B01, 0xEBD6, 0x465F, {                    \</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-      0xB9, 0x72, 0x16, 0x30, 0x41, 0x0F, 0x70, 0xE6 \</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-    }                                                \</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-  }</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-//</span>
<a href="#l2.24"></a><span id="l2.24"> // LDAP directory factory</span>
<a href="#l2.25"></a><span id="l2.25"> //</span>
<a href="#l2.26"></a><span id="l2.26"> #define NS_ABLDAPDIRFACTORY_CONTRACTID \</span>
<a href="#l2.27"></a><span id="l2.27">   NS_AB_DIRECTORY_FACTORY_CONTRACTID_PREFIX &quot;moz-abldapdirectory&quot;</span>
<a href="#l2.28"></a><span id="l2.28"> </span>
<a href="#l2.29"></a><span id="l2.29"> #define NS_ABLDAPDIRFACTORY_CID                      \</span>
<a href="#l2.30"></a><span id="l2.30">   {                                                  \</span>
<a href="#l2.31"></a><span id="l2.31">     0x8e3701af, 0x8828, 0x426c, {                    \</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">deleted file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- a/mailnews/addrbook/public/nsIAbLDAPCard.idl</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ /dev/null</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -1,53 +0,0 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineminus">-</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineminus">-#include &quot;nsISupports.idl&quot;</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineminus">-</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-interface nsIAbLDAPAttributeMap;</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-interface nsILDAPModification;</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-interface nsILDAPMessage;</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-interface nsIArray;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-[scriptable, uuid(2831b3b0-30ef-4070-8ad3-90ae04980e11)]</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-interface nsIAbLDAPCard : nsISupports</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-{</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-  /**</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-   * Returns the required information for an LDAP update message.</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-   *</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-   * @param  aAttrMap    The map between LDAP attributes and card properties</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-   * @param  aClasses    The objectClass values that the card needs to have</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-   * @param  updateType  This should be one of:</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-   *                         nsILDAPModification::MOD_ADD</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-   *                         nsILDAPModification::MOD_REPLACE</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-   *</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-   * @return             Returns an array of modifications required to</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-   *                     add or replace the card in the ldap directory.</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-   */</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-  nsIArray getLDAPMessageInfo(in nsIAbLDAPAttributeMap aAttrMap,</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-                              in Array&lt;ACString&gt; aClasses,</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-                              in long updateType);</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-  /**</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">-   * Builds a relative distinguished name (RDN) with the given set of</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-   * attributes.</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-   *</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-   * @param  aAttrMap    The map between LDAP attributes and card properties</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-   * @param  aAttributes The attributes to use for the RDN</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-   *</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-   * @return             The resulting RDN.</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">-   */</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-  ACString buildRdn(in nsIAbLDAPAttributeMap aAttrMap,</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-                    in Array&lt;ACString&gt; aAttributes);</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-  /**</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-   * Stores meta-properties from a raw LDAP search result.</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-   *</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-   * @param aMessage     The LDAP search result message.</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-   *</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-   */</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-  void setMetaProperties(in nsILDAPMessage aMessage);</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-  attribute ACString dn;</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/addrbook/public/nsIAbLDAPDirectory.idl</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/addrbook/public/nsIAbLDAPDirectory.idl</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,16 +1,15 @@</span>
<a href="#l4.4"></a><span id="l4.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l4.5"></a><span id="l4.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.6"></a><span id="l4.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.7"></a><span id="l4.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11" class="difflineminus">-interface nsIMutableArray;</span>
<a href="#l4.12"></a><span id="l4.12"> interface nsIFile;</span>
<a href="#l4.13"></a><span id="l4.13"> interface nsIAddrDatabase;</span>
<a href="#l4.14"></a><span id="l4.14"> interface nsIAbLDAPAttributeMap;</span>
<a href="#l4.15"></a><span id="l4.15"> interface nsILDAPURL;</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17"> %{C++</span>
<a href="#l4.18"></a><span id="l4.18"> #define kLDAPDirectoryRoot         &quot;moz-abldapdirectory://&quot;</span>
<a href="#l4.19"></a><span id="l4.19"> #define kLDAPDirectoryRootLen      22</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineat">@@ -19,23 +18,16 @@ interface nsILDAPURL;</span>
<a href="#l4.21"></a><span id="l4.21"> /**</span>
<a href="#l4.22"></a><span id="l4.22">  * XXX This should really inherit from nsIAbDirectory, and some day it will.</span>
<a href="#l4.23"></a><span id="l4.23">  * But for now, doing that complicates implementation.</span>
<a href="#l4.24"></a><span id="l4.24">  */</span>
<a href="#l4.25"></a><span id="l4.25"> [scriptable, uuid(90dde295-e354-4d58-Add8-f9b29a95942d)]</span>
<a href="#l4.26"></a><span id="l4.26"> interface nsIAbLDAPDirectory : nsISupports</span>
<a href="#l4.27"></a><span id="l4.27"> {</span>
<a href="#l4.28"></a><span id="l4.28">   /**</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineminus">-   * If set, these arrays of nsILDAPControls are passed through to the</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-   * nsILDAPOperation that searchExt is called on.</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-   */</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-  attribute nsIMutableArray searchServerControls;</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-  attribute nsIMutableArray searchClientControls;</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-  /**</span>
<a href="#l4.36"></a><span id="l4.36">    * The Replication File Name to use.</span>
<a href="#l4.37"></a><span id="l4.37">    */</span>
<a href="#l4.38"></a><span id="l4.38">   attribute ACString replicationFileName;</span>
<a href="#l4.39"></a><span id="l4.39"> </span>
<a href="#l4.40"></a><span id="l4.40">   /**</span>
<a href="#l4.41"></a><span id="l4.41">    * The version of LDAP protocol in use.</span>
<a href="#l4.42"></a><span id="l4.42">    */</span>
<a href="#l4.43"></a><span id="l4.43">   attribute unsigned long protocolVersion;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/addrbook/public/nsIAbLDAPReplicationData.idl</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/addrbook/public/nsIAbLDAPReplicationData.idl</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -34,29 +34,16 @@ interface nsIAbLDAPProcessReplicationDat</span>
<a href="#l5.4"></a><span id="l5.4">     const long kAuthenticating        = 6;</span>
<a href="#l5.5"></a><span id="l5.5">     const long kReplicatingAll        = 7;</span>
<a href="#l5.6"></a><span id="l5.6">     const long kSearchingRootDSE      = 8;</span>
<a href="#l5.7"></a><span id="l5.7">     const long kFindingChanges        = 9;</span>
<a href="#l5.8"></a><span id="l5.8">     const long kReplicatingChanges    = 10;</span>
<a href="#l5.9"></a><span id="l5.9">     const long kReplicationDone       = 11;</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11">    /**</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-     * readonly attribute giving the current protocol used</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-     */</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-    readonly attribute int32_t protocolUsed ;</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-   /**</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-     * replication protocols</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-     */</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-    const long kDefaultDownloadAll         = 0;</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineminus">-    const long kChangeLogProtocol          = 1;</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineminus">-    const long kLCUPProtocol               = 2;</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineminus">-    const long kLastUpdatedTimeStampMethod = 3;</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">-</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-   /**</span>
<a href="#l5.25"></a><span id="l5.25">      * this method initializes the implementation</span>
<a href="#l5.26"></a><span id="l5.26">      */</span>
<a href="#l5.27"></a><span id="l5.27">     void init(in nsIAbLDAPDirectory directory,</span>
<a href="#l5.28"></a><span id="l5.28">               in nsILDAPConnection connection,</span>
<a href="#l5.29"></a><span id="l5.29">               in nsILDAPURL url,</span>
<a href="#l5.30"></a><span id="l5.30">               in nsIAbLDAPReplicationQuery query,</span>
<a href="#l5.31"></a><span id="l5.31">               in nsIWebProgressListener progressListener);</span>
<a href="#l5.32"></a><span id="l5.32"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/addrbook/src/moz.build</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/addrbook/src/moz.build</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -41,29 +41,23 @@ if CONFIG['OS_ARCH'] == 'Darwin':</span>
<a href="#l6.4"></a><span id="l6.4">         'nsAbOSXCard.mm',</span>
<a href="#l6.5"></a><span id="l6.5">         'nsAbOSXDirectory.mm',</span>
<a href="#l6.6"></a><span id="l6.6">         'nsAbOSXUtils.mm',</span>
<a href="#l6.7"></a><span id="l6.7">     ]</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9"> if CONFIG['MOZ_LDAP_XPCOM']:</span>
<a href="#l6.10"></a><span id="l6.10">     SOURCES += [</span>
<a href="#l6.11"></a><span id="l6.11">         'nsAbBoolExprToLDAPFilter.cpp',</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-        'nsAbLDAPCard.cpp',</span>
<a href="#l6.13"></a><span id="l6.13">         'nsAbLDAPDirectory.cpp',</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-        'nsAbLDAPDirectoryModify.cpp',</span>
<a href="#l6.15"></a><span id="l6.15">         'nsAbLDAPDirectoryQuery.cpp',</span>
<a href="#l6.16"></a><span id="l6.16">         'nsAbLDAPListenerBase.cpp',</span>
<a href="#l6.17"></a><span id="l6.17">         'nsAbLDAPReplicationData.cpp',</span>
<a href="#l6.18"></a><span id="l6.18">         'nsAbLDAPReplicationQuery.cpp',</span>
<a href="#l6.19"></a><span id="l6.19">         'nsAbLDAPReplicationService.cpp',</span>
<a href="#l6.20"></a><span id="l6.20">     ]</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-    # XXX These files are not being built as they don't work. Bug 311632 should</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">-    # fix them.</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-    # nsAbLDAPChangeLogQuery.cpp</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-    # nsAbLDAPChangeLogData.cpp</span>
<a href="#l6.25"></a><span id="l6.25"> </span>
<a href="#l6.26"></a><span id="l6.26">     EXTRA_JS_MODULES += [</span>
<a href="#l6.27"></a><span id="l6.27">         'AbLDAPAutoCompleteSearch.jsm',</span>
<a href="#l6.28"></a><span id="l6.28">     ]</span>
<a href="#l6.29"></a><span id="l6.29"> </span>
<a href="#l6.30"></a><span id="l6.30">     DEFINES['MOZ_LDAP_XPCOM'] = True</span>
<a href="#l6.31"></a><span id="l6.31"> </span>
<a href="#l6.32"></a><span id="l6.32"> EXTRA_JS_MODULES += [</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">deleted file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPCard.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ /dev/null</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -1,252 +0,0 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineminus">-</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineminus">-#include &quot;nsAbLDAPCard.h&quot;</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineminus">-#include &quot;nsIMutableArray.h&quot;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-#include &quot;nsILDAPModification.h&quot;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-#include &quot;nsILDAPBERValue.h&quot;</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-#include &quot;nsILDAPMessage.h&quot;</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-#include &quot;nsIAbLDAPAttributeMap.h&quot;</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-#include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-#include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-#include &quot;nsAbUtils.h&quot;</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-#include &quot;nsILDAPErrors.h&quot;</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-#include &lt;stdio.h&gt;</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-#define kDNColumn &quot;DN&quot;</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-nsAbLDAPCard::nsAbLDAPCard() {}</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-nsAbLDAPCard::~nsAbLDAPCard() {}</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-NS_IMPL_ISUPPORTS_INHERITED(nsAbLDAPCard, nsAbCardProperty, nsIAbLDAPCard)</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-/* Retrieves the changes to the LDAP card and stores them in an LDAP</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">- * update message.</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">- *</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">- * Calling this method changes the LDAP card, it updates the</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">- * meta-properties (m_*) to reflect what the LDAP contents will be once</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">- * the update has been performed. This allows you to do multiple (successful)</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">- * consecutive edits on a card in a search result. If the meta-properties</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">- * were not updated, incorrect assumptions would be made about what object</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">- * classes to add, or  what attributes to clear.</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">- *</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">- * XXX: We need to take care when integrating this code with the asynchronous</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">- * update dialogs, as the current code in nsAbLDAPDirectory has a problem</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">- * when an update fails: the modified card still gets stored and shown to</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineminus">- * the user instead of being discarded. There is one especially tricky case:</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineminus">- * when you do an update on a card which changes its DN, you have two</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">- * operations (rename, then update the other attributes). If the rename</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">- * operation succeeds and not the update of the attributes, you are</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">- * &quot;somewhere in between&quot; the original card and the updated card.</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">- */</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-NS_IMETHODIMP nsAbLDAPCard::GetLDAPMessageInfo(</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-    nsIAbLDAPAttributeMap *aAttributeMap, nsTArray&lt;nsCString&gt; const &amp;aClasses,</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-    int32_t aType, nsIArray **aLDAPAddMessageInfo) {</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aAttributeMap);</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aLDAPAddMessageInfo);</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-  nsresult rv;</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; modArray =</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineminus">-      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-  // Add any missing object classes. We never remove any object</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-  // classes: if an entry has additional object classes, it's probably</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineminus">-  // for a good reason.</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-  nsAutoCString oclass;</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-  for (uint32_t i = 0; i &lt; aClasses.Length(); ++i) {</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineminus">-    oclass.Assign(aClasses[i]);</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-    ToLowerCase(oclass);</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineminus">-</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineminus">-    if (!m_objectClass.Contains(oclass)) {</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-      m_objectClass.AppendElement(oclass);</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineminus">-    }</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineminus">-  }</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineminus">-  nsCOMPtr&lt;nsILDAPModification&gt; mod =</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineminus">-      do_CreateInstance(&quot;@mozilla.org/network/ldap-modification;1&quot;, &amp;rv);</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; values =</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineminus">-      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineminus">-  for (uint32_t i = 0; i &lt; m_objectClass.Length(); ++i) {</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineminus">-    nsCOMPtr&lt;nsILDAPBERValue&gt; value =</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineminus">-        do_CreateInstance(&quot;@mozilla.org/network/ldap-ber-value;1&quot;, &amp;rv);</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineminus">-</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineminus">-    rv = value-&gt;SetFromUTF8(m_objectClass.ElementAt(i));</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineminus">-</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineminus">-    rv = values-&gt;AppendElement(value);</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineminus">-  }</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineminus">-</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineminus">-  rv = mod-&gt;SetUpModification(aType, NS_LITERAL_CSTRING(&quot;objectClass&quot;), values);</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineminus">-</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineminus">-  modArray-&gt;AppendElement(mod);</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineminus">-</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineminus">-  // Add card properties</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineminus">-  nsTArray&lt;nsCString&gt; props;</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineminus">-  rv = aAttributeMap-&gt;GetAllCardProperties(props);</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineminus">-</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineminus">-  nsAutoCString attr;</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineminus">-  nsCString propvalue;</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineminus">-  for (const nsCString &amp;prop : props) {</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineminus">-    // Skip some attributes that don't map to LDAP.</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineminus">-    //</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineminus">-    // BirthYear : by default this is mapped to 'birthyear',</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineminus">-    // which is not part of mozillaAbPersonAlpha</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineminus">-    //</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineminus">-    // LastModifiedDate : by default this is mapped to 'modifytimestamp',</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineminus">-    // which cannot be modified</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineminus">-    //</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineminus">-    // PreferMailFormat : by default this is mapped to 'mozillaUseHtmlMail',</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineminus">-    // which is a boolean, not plaintext/html/unknown</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineminus">-    if (prop.EqualsLiteral(kBirthYearProperty) ||</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineminus">-        prop.EqualsLiteral(kLastModifiedDateProperty) ||</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineminus">-        prop.EqualsLiteral(kPreferMailFormatProperty))</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineminus">-      continue;</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineminus">-</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineminus">-    rv = aAttributeMap-&gt;GetFirstAttribute(prop, attr);</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineminus">-    ToLowerCase(attr);</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineminus">-</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineminus">-    // If the property is not mapped to an attribute, skip it.</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineminus">-    if (attr.IsEmpty()) continue;</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineminus">-</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineminus">-    nsCOMPtr&lt;nsILDAPModification&gt; mod =</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineminus">-        do_CreateInstance(&quot;@mozilla.org/network/ldap-modification;1&quot;, &amp;rv);</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineminus">-</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineminus">-    size_t index = m_attributes.IndexOf(attr);</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineminus">-</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineminus">-    rv = GetPropertyAsAUTF8String(prop.get(), propvalue);</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineminus">-</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; !propvalue.IsEmpty()) {</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineminus">-      // If the new value is not empty, add/update it</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineminus">-      nsCOMPtr&lt;nsILDAPBERValue&gt; value =</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineminus">-          do_CreateInstance(&quot;@mozilla.org/network/ldap-ber-value;1&quot;, &amp;rv);</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineminus">-</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineminus">-      rv = value-&gt;SetFromUTF8(propvalue);</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineminus">-</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineminus">-      rv = mod-&gt;SetUpModificationOneValue(aType, attr, value);</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineminus">-      modArray-&gt;AppendElement(mod);</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineminus">-      if (index != m_attributes.NoIndex) m_attributes.AppendElement(attr);</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineminus">-</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineminus">-    } else if (aType == nsILDAPModification::MOD_REPLACE &amp;&amp;</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineminus">-               index != m_attributes.NoIndex) {</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineminus">-      // If the new value is empty, we are performing an update</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineminus">-      // and the attribute was previously set, clear it</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineminus">-      nsCOMPtr&lt;nsIMutableArray&gt; novalues =</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineminus">-          do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineminus">-</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineminus">-      rv = mod-&gt;SetUpModification(aType, attr, novalues);</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineminus">-</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineminus">-      modArray-&gt;AppendElement(mod);</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineminus">-      m_attributes.RemoveElementAt(index);</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineminus">-    }</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineminus">-  }</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineminus">-</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineminus">-  modArray.forget(aLDAPAddMessageInfo);</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineminus">-</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineminus">-  return NS_OK;</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineminus">-}</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineminus">-</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineminus">-NS_IMETHODIMP nsAbLDAPCard::BuildRdn(nsIAbLDAPAttributeMap *aAttributeMap,</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineminus">-                                     nsTArray&lt;nsCString&gt; const &amp;aAttributes,</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineminus">-                                     nsACString &amp;aRdn) {</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aAttributeMap);</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineminus">-</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineminus">-  nsresult rv;</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineminus">-  nsAutoCString prop;</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineminus">-  nsCString propvalue;</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineminus">-</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineminus">-  aRdn.Truncate();</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineminus">-  for (uint32_t i = 0; i &lt; aAttributes.Length(); ++i) {</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineminus">-    // Lookup the property corresponding to the attribute</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineminus">-    rv = aAttributeMap-&gt;GetProperty(aAttributes[i], prop);</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineminus">-</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineminus">-    // Get the property value</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineminus">-    rv = GetPropertyAsAUTF8String(prop.get(), propvalue);</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineminus">-</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineminus">-    // XXX The case where an attribute needed to build the Relative</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineminus">-    // Distinguished Name is not set needs to be handled by the caller,</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineminus">-    // so as to let the user know what is missing.</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineminus">-    if (NS_FAILED(rv) || propvalue.IsEmpty()) {</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineminus">-      NS_ERROR(&quot;nsAbLDAPCard::BuildRdn: a required attribute is not set&quot;);</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineminus">-      return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineminus">-    }</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineminus">-</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineminus">-    aRdn.Append(aAttributes[i]);</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineminus">-    aRdn.Append('=');</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineminus">-    aRdn.Append(propvalue);</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineminus">-    if (i &lt; aAttributes.Length() - 1) aRdn.Append('+');</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineminus">-  }</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineminus">-  return NS_OK;</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineminus">-}</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineminus">-</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineminus">-NS_IMETHODIMP nsAbLDAPCard::GetDn(nsACString &amp;aDN) {</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineminus">-  return GetPropertyAsAUTF8String(kDNColumn, aDN);</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineminus">-}</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineminus">-</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineminus">-NS_IMETHODIMP nsAbLDAPCard::SetDn(const nsACString &amp;aDN) {</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineminus">-  SetLocalId(aDN);</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineminus">-  return SetPropertyAsAUTF8String(kDNColumn, aDN);</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineminus">-}</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineminus">-</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineminus">-NS_IMETHODIMP nsAbLDAPCard::SetMetaProperties(nsILDAPMessage *aMessage) {</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineminus">-</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineminus">-  // Get DN</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineminus">-  nsAutoCString dn;</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineminus">-  nsresult rv = aMessage-&gt;GetDn(dn);</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineminus">-</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineminus">-  SetDn(dn);</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineminus">-</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineminus">-  // Get the list of set attributes</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineminus">-  rv = aMessage-&gt;GetAttributes(m_attributes);</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineminus">-</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineminus">-  for (uint32_t i = 0; i &lt; m_attributes.Length(); ++i) {</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineminus">-    ToLowerCase(m_attributes[i]);</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineminus">-  }</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineminus">-</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineminus">-  // Get the objectClass values</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineminus">-  m_objectClass.Clear();</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineminus">-  nsTArray&lt;nsString&gt; vals;</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineminus">-  rv = aMessage-&gt;GetValues(&quot;objectClass&quot;, vals);</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineminus">-</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineminus">-  // objectClass is not always included in search result entries and</span>
<a href="#l7.242"></a><span id="l7.242" class="difflineminus">-  // nsILDAPMessage::GetValues returns NS_ERROR_LDAP_DECODING_ERROR if the</span>
<a href="#l7.243"></a><span id="l7.243" class="difflineminus">-  // requested attribute doesn't exist.</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineminus">-  if (rv == NS_ERROR_LDAP_DECODING_ERROR) return NS_OK;</span>
<a href="#l7.245"></a><span id="l7.245" class="difflineminus">-</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineminus">-</span>
<a href="#l7.248"></a><span id="l7.248" class="difflineminus">-  nsAutoCString oclass;</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineminus">-  for (uint32_t i = 0; i &lt; vals.Length(); ++i) {</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineminus">-    oclass.Assign(NS_LossyConvertUTF16toASCII(vals[i]));</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineminus">-    ToLowerCase(oclass);</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineminus">-    m_objectClass.AppendElement(oclass);</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineminus">-  }</span>
<a href="#l7.254"></a><span id="l7.254" class="difflineminus">-</span>
<a href="#l7.255"></a><span id="l7.255" class="difflineminus">-  return NS_OK;</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">deleted file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPCard.h</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ /dev/null</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -1,26 +0,0 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineminus">-</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineminus">-#ifndef nsAbLDAPCard_h__</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineminus">-#define nsAbLDAPCard_h__</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-#include &quot;nsAbCardProperty.h&quot;</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-#include &quot;nsIAbLDAPCard.h&quot;</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-#include &quot;nsTArray.h&quot;</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-class nsAbLDAPCard : public nsAbCardProperty, public nsIAbLDAPCard {</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">- public:</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">-  NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">-  NS_DECL_NSIABLDAPCARD</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineminus">-</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineminus">-  nsAbLDAPCard();</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">-</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineminus">- protected:</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineminus">-  virtual ~nsAbLDAPCard();</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineminus">-  nsTArray&lt;nsCString&gt; m_attributes;</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-  nsTArray&lt;nsCString&gt; m_objectClass;</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-};</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineminus">-</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-#endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">deleted file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ /dev/null</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -1,498 +0,0 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineminus">- *</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineminus">-</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineminus">-#include &quot;nsAbLDAPChangeLogData.h&quot;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-#include &quot;nsAbLDAPChangeLogQuery.h&quot;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-#include &quot;nsILDAPMessage.h&quot;</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-#include &quot;nsIAddrBookSession.h&quot;</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-#include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-#include &quot;nsAbUtils.h&quot;</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-#include &quot;nsAbLDAPCard.h&quot;</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-#include &quot;nsIAuthPrompt.h&quot;</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">-#include &quot;nsIStringBundle.h&quot;</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-#include &quot;nsIWindowWatcher.h&quot;</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-#include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-#include &quot;plstr.h&quot;</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">-#include &quot;nsILDAPErrors.h&quot;</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">-#include &quot;prmem.h&quot;</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-#include &quot;mozilla/Services.h&quot;</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-// Defined here since to be used</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-// only locally to this file.</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-enum UpdateOp { NO_OP, ENTRY_ADD, ENTRY_DELETE, ENTRY_MODIFY };</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-nsAbLDAPProcessChangeLogData::nsAbLDAPProcessChangeLogData()</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">-    : mUseChangeLog(false),</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-      mChangeLogEntriesCount(0),</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-      mEntriesAddedQueryCount(0) {</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-  mRootDSEEntry.firstChangeNumber = 0;</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-  mRootDSEEntry.lastChangeNumber = 0;</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-}</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">-</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-nsAbLDAPProcessChangeLogData::~nsAbLDAPProcessChangeLogData() {}</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">-NS_IMETHODIMP nsAbLDAPProcessChangeLogData::Init(</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineminus">-    nsIAbLDAPReplicationQuery *query,</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineminus">-    nsIWebProgressListener *progressListener) {</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-  NS_ENSURE_ARG_POINTER(query);</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineminus">-  // Here we are assuming that the caller will pass a nsAbLDAPChangeLogQuery</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-  // object, an implementation derived from the implementation of</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineminus">-  // nsIAbLDAPReplicationQuery.</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-  mChangeLogQuery = do_QueryInterface(query, &amp;rv);</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineminus">-</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineminus">-  // Call the parent's Init now.</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineminus">-  return nsAbLDAPProcessReplicationData::Init(query, progressListener);</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineminus">-}</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineminus">-</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineminus">-nsresult nsAbLDAPProcessChangeLogData::OnLDAPBind(nsILDAPMessage *aMessage) {</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineminus">-  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">-</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineminus">-  int32_t errCode;</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-  nsresult rv = aMessage-&gt;GetErrorCode(&amp;errCode);</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-  if (NS_FAILED(rv)) {</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineminus">-    Done(false);</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineminus">-    return rv;</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineminus">-  }</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineminus">-</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineminus">-  if (errCode != nsILDAPErrors::SUCCESS) {</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineminus">-    Done(false);</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineminus">-  }</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineminus">-</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineminus">-  switch (mState) {</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineminus">-    case kAnonymousBinding:</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-      rv = GetAuthData();</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineminus">-      if (NS_SUCCEEDED(rv)) rv = mChangeLogQuery-&gt;QueryAuthDN(mAuthUserID);</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineminus">-      if (NS_SUCCEEDED(rv)) mState = kSearchingAuthDN;</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineminus">-      break;</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineminus">-    case kAuthenticatedBinding:</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineminus">-      rv = mChangeLogQuery-&gt;QueryRootDSE();</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineminus">-      if (NS_SUCCEEDED(rv)) mState = kSearchingRootDSE;</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineminus">-      break;</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineminus">-  }  // end of switch</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineminus">-</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineminus">-  if (NS_FAILED(rv)) Abort();</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineminus">-</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineminus">-  return rv;</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineminus">-}</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineminus">-</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineminus">-nsresult nsAbLDAPProcessChangeLogData::OnLDAPSearchEntry(</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineminus">-    nsILDAPMessage *aMessage) {</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineminus">-  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">-</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineminus">-</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineminus">-  switch (mState) {</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineminus">-    case kSearchingAuthDN: {</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineminus">-      nsAutoCString authDN;</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineminus">-      rv = aMessage-&gt;GetDn(authDN);</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; !authDN.IsEmpty()) mAuthDN = authDN.get();</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineminus">-    } break;</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineminus">-    case kSearchingRootDSE:</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineminus">-      rv = ParseRootDSEEntry(aMessage);</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineminus">-      break;</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineminus">-    case kFindingChanges:</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineminus">-      rv = ParseChangeLogEntries(aMessage);</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineminus">-      break;</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineminus">-    // Fall through since we only add (for updates we delete and add)</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineminus">-    case kReplicatingChanges:</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineminus">-    case kReplicatingAll:</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineminus">-      return nsAbLDAPProcessReplicationData::OnLDAPSearchEntry(aMessage);</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineminus">-  }</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineminus">-</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineminus">-  if (NS_FAILED(rv)) Abort();</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineminus">-</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineminus">-  return rv;</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineminus">-}</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineminus">-</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineminus">-nsresult nsAbLDAPProcessChangeLogData::OnLDAPSearchResult(</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineminus">-    nsILDAPMessage *aMessage) {</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineminus">-  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineminus">-</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineminus">-  int32_t errorCode;</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineminus">-</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineminus">-  nsresult rv = aMessage-&gt;GetErrorCode(&amp;errorCode);</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineminus">-</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineminus">-  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineminus">-    if (errorCode == nsILDAPErrors::SUCCESS ||</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineminus">-        errorCode == nsILDAPErrors::SIZELIMIT_EXCEEDED) {</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineminus">-      switch (mState) {</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineminus">-        case kSearchingAuthDN:</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineminus">-          rv = OnSearchAuthDNDone();</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineminus">-          break;</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineminus">-        case kSearchingRootDSE: {</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineminus">-          // Before starting the changeLog check the DB file, if its not there</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineminus">-          // or bogus we need to create a new one and set to all.</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineminus">-          nsCOMPtr&lt;nsIAddrBookSession&gt; abSession =</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineminus">-              do_GetService(NS_ADDRBOOKSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineminus">-          if (NS_FAILED(rv)) break;</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineminus">-          nsCOMPtr&lt;nsIFile&gt; dbPath;</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineminus">-          rv = abSession-&gt;GetUserProfileDirectory(getter_AddRefs(dbPath));</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineminus">-          if (NS_FAILED(rv)) break;</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineminus">-</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineminus">-          nsAutoCString fileName;</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineminus">-          rv = mDirectory-&gt;GetReplicationFileName(fileName);</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineminus">-          if (NS_FAILED(rv)) break;</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineminus">-</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineminus">-          rv = dbPath-&gt;AppendNative(fileName);</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineminus">-          if (NS_FAILED(rv)) break;</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineminus">-</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineminus">-          bool fileExists;</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineminus">-          rv = dbPath-&gt;Exists(&amp;fileExists);</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineminus">-          if (NS_FAILED(rv)) break;</span>
<a href="#l9.157"></a><span id="l9.157" class="difflineminus">-</span>
<a href="#l9.158"></a><span id="l9.158" class="difflineminus">-          int64_t fileSize;</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineminus">-          rv = dbPath-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineminus">-          if (NS_FAILED(rv)) break;</span>
<a href="#l9.161"></a><span id="l9.161" class="difflineminus">-</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineminus">-          if (!fileExists || !fileSize) mUseChangeLog = false;</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineminus">-</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineminus">-          // Open / create the AB here since it calls Done,</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineminus">-          // just return from here.</span>
<a href="#l9.166"></a><span id="l9.166" class="difflineminus">-          if (mUseChangeLog)</span>
<a href="#l9.167"></a><span id="l9.167" class="difflineminus">-            rv = OpenABForReplicatedDir(false);</span>
<a href="#l9.168"></a><span id="l9.168" class="difflineminus">-          else</span>
<a href="#l9.169"></a><span id="l9.169" class="difflineminus">-            rv = OpenABForReplicatedDir(true);</span>
<a href="#l9.170"></a><span id="l9.170" class="difflineminus">-          if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.171"></a><span id="l9.171" class="difflineminus">-</span>
<a href="#l9.172"></a><span id="l9.172" class="difflineminus">-          // Now start the appropriate query</span>
<a href="#l9.173"></a><span id="l9.173" class="difflineminus">-          rv = OnSearchRootDSEDone();</span>
<a href="#l9.174"></a><span id="l9.174" class="difflineminus">-          break;</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineminus">-        }</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineminus">-        case kFindingChanges:</span>
<a href="#l9.177"></a><span id="l9.177" class="difflineminus">-          rv = OnFindingChangesDone();</span>
<a href="#l9.178"></a><span id="l9.178" class="difflineminus">-          // If success we return from here since</span>
<a href="#l9.179"></a><span id="l9.179" class="difflineminus">-          // this changes state to kReplicatingChanges</span>
<a href="#l9.180"></a><span id="l9.180" class="difflineminus">-          // and it falls through into the if clause below.</span>
<a href="#l9.181"></a><span id="l9.181" class="difflineminus">-          if (NS_SUCCEEDED(rv)) return rv;</span>
<a href="#l9.182"></a><span id="l9.182" class="difflineminus">-          break;</span>
<a href="#l9.183"></a><span id="l9.183" class="difflineminus">-        case kReplicatingAll:</span>
<a href="#l9.184"></a><span id="l9.184" class="difflineminus">-          return nsAbLDAPProcessReplicationData::OnLDAPSearchResult(aMessage);</span>
<a href="#l9.185"></a><span id="l9.185" class="difflineminus">-      }  // end of switch</span>
<a href="#l9.186"></a><span id="l9.186" class="difflineminus">-    } else</span>
<a href="#l9.187"></a><span id="l9.187" class="difflineminus">-      rv = NS_ERROR_FAILURE;</span>
<a href="#l9.188"></a><span id="l9.188" class="difflineminus">-    // If one of the changed entry in changelog is not found,</span>
<a href="#l9.189"></a><span id="l9.189" class="difflineminus">-    // continue with replicating the next one.</span>
<a href="#l9.190"></a><span id="l9.190" class="difflineminus">-    if (mState == kReplicatingChanges) rv = OnReplicatingChangeDone();</span>
<a href="#l9.191"></a><span id="l9.191" class="difflineminus">-  }  // end of outer if</span>
<a href="#l9.192"></a><span id="l9.192" class="difflineminus">-</span>
<a href="#l9.193"></a><span id="l9.193" class="difflineminus">-  if (NS_FAILED(rv)) Abort();</span>
<a href="#l9.194"></a><span id="l9.194" class="difflineminus">-</span>
<a href="#l9.195"></a><span id="l9.195" class="difflineminus">-  return rv;</span>
<a href="#l9.196"></a><span id="l9.196" class="difflineminus">-}</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineminus">-</span>
<a href="#l9.198"></a><span id="l9.198" class="difflineminus">-nsresult nsAbLDAPProcessChangeLogData::GetAuthData() {</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineminus">-  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l9.200"></a><span id="l9.200" class="difflineminus">-</span>
<a href="#l9.201"></a><span id="l9.201" class="difflineminus">-  nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(do_GetService(NS_WINDOWWATCHER_CONTRACTID));</span>
<a href="#l9.202"></a><span id="l9.202" class="difflineminus">-  if (!wwatch) return NS_ERROR_FAILURE;</span>
<a href="#l9.203"></a><span id="l9.203" class="difflineminus">-</span>
<a href="#l9.204"></a><span id="l9.204" class="difflineminus">-  nsCOMPtr&lt;nsIAuthPrompt&gt; dialog;</span>
<a href="#l9.205"></a><span id="l9.205" class="difflineminus">-  nsresult rv = wwatch-&gt;GetNewAuthPrompter(0, getter_AddRefs(dialog));</span>
<a href="#l9.206"></a><span id="l9.206" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.207"></a><span id="l9.207" class="difflineminus">-  if (!dialog) return NS_ERROR_FAILURE;</span>
<a href="#l9.208"></a><span id="l9.208" class="difflineminus">-</span>
<a href="#l9.209"></a><span id="l9.209" class="difflineminus">-  nsCOMPtr&lt;nsILDAPURL&gt; url;</span>
<a href="#l9.210"></a><span id="l9.210" class="difflineminus">-  rv = mQuery-&gt;GetReplicationURL(getter_AddRefs(url));</span>
<a href="#l9.211"></a><span id="l9.211" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.212"></a><span id="l9.212" class="difflineminus">-</span>
<a href="#l9.213"></a><span id="l9.213" class="difflineminus">-  nsAutoCString serverUri;</span>
<a href="#l9.214"></a><span id="l9.214" class="difflineminus">-  rv = url-&gt;GetSpec(serverUri);</span>
<a href="#l9.215"></a><span id="l9.215" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.216"></a><span id="l9.216" class="difflineminus">-</span>
<a href="#l9.217"></a><span id="l9.217" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l9.218"></a><span id="l9.218" class="difflineminus">-      mozilla::services::GetStringBundleService();</span>
<a href="#l9.219"></a><span id="l9.219" class="difflineminus">-  NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l9.220"></a><span id="l9.220" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l9.221"></a><span id="l9.221" class="difflineminus">-  rv = bundleService-&gt;CreateBundle(</span>
<a href="#l9.222"></a><span id="l9.222" class="difflineminus">-      &quot;chrome://messenger/locale/addressbook/addressBook.properties&quot;,</span>
<a href="#l9.223"></a><span id="l9.223" class="difflineminus">-      getter_AddRefs(bundle));</span>
<a href="#l9.224"></a><span id="l9.224" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.225"></a><span id="l9.225" class="difflineminus">-</span>
<a href="#l9.226"></a><span id="l9.226" class="difflineminus">-  nsString title;</span>
<a href="#l9.227"></a><span id="l9.227" class="difflineminus">-  rv = bundle-&gt;GetStringFromName(&quot;AuthDlgTitle&quot;, title);</span>
<a href="#l9.228"></a><span id="l9.228" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.229"></a><span id="l9.229" class="difflineminus">-</span>
<a href="#l9.230"></a><span id="l9.230" class="difflineminus">-  nsString desc;</span>
<a href="#l9.231"></a><span id="l9.231" class="difflineminus">-  rv = bundle-&gt;GetStringFromName(&quot;AuthDlgDesc&quot;, desc);</span>
<a href="#l9.232"></a><span id="l9.232" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.233"></a><span id="l9.233" class="difflineminus">-</span>
<a href="#l9.234"></a><span id="l9.234" class="difflineminus">-  nsString username;</span>
<a href="#l9.235"></a><span id="l9.235" class="difflineminus">-  nsString password;</span>
<a href="#l9.236"></a><span id="l9.236" class="difflineminus">-  bool btnResult = false;</span>
<a href="#l9.237"></a><span id="l9.237" class="difflineminus">-  rv = dialog-&gt;PromptUsernameAndPassword(</span>
<a href="#l9.238"></a><span id="l9.238" class="difflineminus">-      title, desc, NS_ConvertUTF8toUTF16(serverUri).get(),</span>
<a href="#l9.239"></a><span id="l9.239" class="difflineminus">-      nsIAuthPrompt::SAVE_PASSWORD_PERMANENTLY, getter_Copies(username),</span>
<a href="#l9.240"></a><span id="l9.240" class="difflineminus">-      getter_Copies(password), &amp;btnResult);</span>
<a href="#l9.241"></a><span id="l9.241" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; btnResult) {</span>
<a href="#l9.242"></a><span id="l9.242" class="difflineminus">-    CopyUTF16toUTF8(username, mAuthUserID);</span>
<a href="#l9.243"></a><span id="l9.243" class="difflineminus">-    CopyUTF16toUTF8(password, mAuthPswd);</span>
<a href="#l9.244"></a><span id="l9.244" class="difflineminus">-  } else</span>
<a href="#l9.245"></a><span id="l9.245" class="difflineminus">-    rv = NS_ERROR_FAILURE;</span>
<a href="#l9.246"></a><span id="l9.246" class="difflineminus">-</span>
<a href="#l9.247"></a><span id="l9.247" class="difflineminus">-  return rv;</span>
<a href="#l9.248"></a><span id="l9.248" class="difflineminus">-}</span>
<a href="#l9.249"></a><span id="l9.249" class="difflineminus">-</span>
<a href="#l9.250"></a><span id="l9.250" class="difflineminus">-nsresult nsAbLDAPProcessChangeLogData::OnSearchAuthDNDone() {</span>
<a href="#l9.251"></a><span id="l9.251" class="difflineminus">-  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l9.252"></a><span id="l9.252" class="difflineminus">-</span>
<a href="#l9.253"></a><span id="l9.253" class="difflineminus">-  nsCOMPtr&lt;nsILDAPURL&gt; url;</span>
<a href="#l9.254"></a><span id="l9.254" class="difflineminus">-  nsresult rv = mQuery-&gt;GetReplicationURL(getter_AddRefs(url));</span>
<a href="#l9.255"></a><span id="l9.255" class="difflineminus">-  if (NS_SUCCEEDED(rv)) rv = mQuery-&gt;ConnectToLDAPServer(url, mAuthDN);</span>
<a href="#l9.256"></a><span id="l9.256" class="difflineminus">-  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l9.257"></a><span id="l9.257" class="difflineminus">-    mState = kAuthenticatedBinding;</span>
<a href="#l9.258"></a><span id="l9.258" class="difflineminus">-    rv = mDirectory-&gt;SetAuthDn(mAuthDN);</span>
<a href="#l9.259"></a><span id="l9.259" class="difflineminus">-  }</span>
<a href="#l9.260"></a><span id="l9.260" class="difflineminus">-</span>
<a href="#l9.261"></a><span id="l9.261" class="difflineminus">-  return rv;</span>
<a href="#l9.262"></a><span id="l9.262" class="difflineminus">-}</span>
<a href="#l9.263"></a><span id="l9.263" class="difflineminus">-</span>
<a href="#l9.264"></a><span id="l9.264" class="difflineminus">-nsresult nsAbLDAPProcessChangeLogData::ParseRootDSEEntry(</span>
<a href="#l9.265"></a><span id="l9.265" class="difflineminus">-    nsILDAPMessage *aMessage) {</span>
<a href="#l9.266"></a><span id="l9.266" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l9.267"></a><span id="l9.267" class="difflineminus">-  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l9.268"></a><span id="l9.268" class="difflineminus">-</span>
<a href="#l9.269"></a><span id="l9.269" class="difflineminus">-  // Populate the RootDSEChangeLogEntry</span>
<a href="#l9.270"></a><span id="l9.270" class="difflineminus">-  CharPtrArrayGuard attrs;</span>
<a href="#l9.271"></a><span id="l9.271" class="difflineminus">-  nsresult rv =</span>
<a href="#l9.272"></a><span id="l9.272" class="difflineminus">-      aMessage-&gt;GetAttributes(attrs.GetSizeAddr(), attrs.GetArrayAddr());</span>
<a href="#l9.273"></a><span id="l9.273" class="difflineminus">-  // No attributes</span>
<a href="#l9.274"></a><span id="l9.274" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.275"></a><span id="l9.275" class="difflineminus">-</span>
<a href="#l9.276"></a><span id="l9.276" class="difflineminus">-  for (int32_t i = attrs.GetSize() - 1; i &gt;= 0; i--) {</span>
<a href="#l9.277"></a><span id="l9.277" class="difflineminus">-    PRUnicharPtrArrayGuard vals;</span>
<a href="#l9.278"></a><span id="l9.278" class="difflineminus">-    rv = aMessage-&gt;GetValues(attrs.GetArray()[i], vals.GetSizeAddr(),</span>
<a href="#l9.279"></a><span id="l9.279" class="difflineminus">-                             vals.GetArrayAddr());</span>
<a href="#l9.280"></a><span id="l9.280" class="difflineminus">-    if (NS_FAILED(rv)) continue;</span>
<a href="#l9.281"></a><span id="l9.281" class="difflineminus">-    if (vals.GetSize()) {</span>
<a href="#l9.282"></a><span id="l9.282" class="difflineminus">-      if (!PL_strcasecmp(attrs[i], &quot;changelog&quot;))</span>
<a href="#l9.283"></a><span id="l9.283" class="difflineminus">-        CopyUTF16toUTF8(vals[0], mRootDSEEntry.changeLogDN);</span>
<a href="#l9.284"></a><span id="l9.284" class="difflineminus">-      if (!PL_strcasecmp(attrs[i], &quot;firstChangeNumber&quot;))</span>
<a href="#l9.285"></a><span id="l9.285" class="difflineminus">-        mRootDSEEntry.firstChangeNumber =</span>
<a href="#l9.286"></a><span id="l9.286" class="difflineminus">-            atol(NS_LossyConvertUTF16toASCII(vals[0]).get());</span>
<a href="#l9.287"></a><span id="l9.287" class="difflineminus">-      if (!PL_strcasecmp(attrs[i], &quot;lastChangeNumber&quot;))</span>
<a href="#l9.288"></a><span id="l9.288" class="difflineminus">-        mRootDSEEntry.lastChangeNumber =</span>
<a href="#l9.289"></a><span id="l9.289" class="difflineminus">-            atol(NS_LossyConvertUTF16toASCII(vals[0]).get());</span>
<a href="#l9.290"></a><span id="l9.290" class="difflineminus">-      if (!PL_strcasecmp(attrs[i], &quot;dataVersion&quot;))</span>
<a href="#l9.291"></a><span id="l9.291" class="difflineminus">-        CopyUTF16toUTF8(vals[0], mRootDSEEntry.dataVersion);</span>
<a href="#l9.292"></a><span id="l9.292" class="difflineminus">-    }</span>
<a href="#l9.293"></a><span id="l9.293" class="difflineminus">-  }</span>
<a href="#l9.294"></a><span id="l9.294" class="difflineminus">-</span>
<a href="#l9.295"></a><span id="l9.295" class="difflineminus">-  int32_t lastChangeNumber;</span>
<a href="#l9.296"></a><span id="l9.296" class="difflineminus">-  mDirectory-&gt;GetLastChangeNumber(&amp;lastChangeNumber);</span>
<a href="#l9.297"></a><span id="l9.297" class="difflineminus">-</span>
<a href="#l9.298"></a><span id="l9.298" class="difflineminus">-  if ((mRootDSEEntry.lastChangeNumber &gt; 0) &amp;&amp;</span>
<a href="#l9.299"></a><span id="l9.299" class="difflineminus">-      (lastChangeNumber &lt; mRootDSEEntry.lastChangeNumber) &amp;&amp;</span>
<a href="#l9.300"></a><span id="l9.300" class="difflineminus">-      (lastChangeNumber &gt; mRootDSEEntry.firstChangeNumber))</span>
<a href="#l9.301"></a><span id="l9.301" class="difflineminus">-    mUseChangeLog = true;</span>
<a href="#l9.302"></a><span id="l9.302" class="difflineminus">-</span>
<a href="#l9.303"></a><span id="l9.303" class="difflineminus">-  if (mRootDSEEntry.lastChangeNumber &amp;&amp;</span>
<a href="#l9.304"></a><span id="l9.304" class="difflineminus">-      (lastChangeNumber == mRootDSEEntry.lastChangeNumber)) {</span>
<a href="#l9.305"></a><span id="l9.305" class="difflineminus">-    Done(true);  // We are up to date no need to replicate, db not open yet so</span>
<a href="#l9.306"></a><span id="l9.306" class="difflineminus">-                 // call Done</span>
<a href="#l9.307"></a><span id="l9.307" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.308"></a><span id="l9.308" class="difflineminus">-  }</span>
<a href="#l9.309"></a><span id="l9.309" class="difflineminus">-</span>
<a href="#l9.310"></a><span id="l9.310" class="difflineminus">-  return rv;</span>
<a href="#l9.311"></a><span id="l9.311" class="difflineminus">-}</span>
<a href="#l9.312"></a><span id="l9.312" class="difflineminus">-</span>
<a href="#l9.313"></a><span id="l9.313" class="difflineminus">-nsresult nsAbLDAPProcessChangeLogData::OnSearchRootDSEDone() {</span>
<a href="#l9.314"></a><span id="l9.314" class="difflineminus">-  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l9.315"></a><span id="l9.315" class="difflineminus">-</span>
<a href="#l9.316"></a><span id="l9.316" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l9.317"></a><span id="l9.317" class="difflineminus">-</span>
<a href="#l9.318"></a><span id="l9.318" class="difflineminus">-  if (mUseChangeLog) {</span>
<a href="#l9.319"></a><span id="l9.319" class="difflineminus">-    rv = mChangeLogQuery-&gt;QueryChangeLog(mRootDSEEntry.changeLogDN,</span>
<a href="#l9.320"></a><span id="l9.320" class="difflineminus">-                                         mRootDSEEntry.lastChangeNumber);</span>
<a href="#l9.321"></a><span id="l9.321" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.322"></a><span id="l9.322" class="difflineminus">-    mState = kFindingChanges;</span>
<a href="#l9.323"></a><span id="l9.323" class="difflineminus">-    if (mListener)</span>
<a href="#l9.324"></a><span id="l9.324" class="difflineminus">-      mListener-&gt;OnStateChange(nullptr, nullptr,</span>
<a href="#l9.325"></a><span id="l9.325" class="difflineminus">-                               nsIWebProgressListener::STATE_START, false);</span>
<a href="#l9.326"></a><span id="l9.326" class="difflineminus">-  } else {</span>
<a href="#l9.327"></a><span id="l9.327" class="difflineminus">-    rv = mQuery-&gt;QueryAllEntries();</span>
<a href="#l9.328"></a><span id="l9.328" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.329"></a><span id="l9.329" class="difflineminus">-    mState = kReplicatingAll;</span>
<a href="#l9.330"></a><span id="l9.330" class="difflineminus">-    if (mListener)</span>
<a href="#l9.331"></a><span id="l9.331" class="difflineminus">-      mListener-&gt;OnStateChange(nullptr, nullptr,</span>
<a href="#l9.332"></a><span id="l9.332" class="difflineminus">-                               nsIWebProgressListener::STATE_START, true);</span>
<a href="#l9.333"></a><span id="l9.333" class="difflineminus">-  }</span>
<a href="#l9.334"></a><span id="l9.334" class="difflineminus">-</span>
<a href="#l9.335"></a><span id="l9.335" class="difflineminus">-  rv = mDirectory-&gt;SetLastChangeNumber(mRootDSEEntry.lastChangeNumber);</span>
<a href="#l9.336"></a><span id="l9.336" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.337"></a><span id="l9.337" class="difflineminus">-</span>
<a href="#l9.338"></a><span id="l9.338" class="difflineminus">-  rv = mDirectory-&gt;SetDataVersion(mRootDSEEntry.dataVersion);</span>
<a href="#l9.339"></a><span id="l9.339" class="difflineminus">-</span>
<a href="#l9.340"></a><span id="l9.340" class="difflineminus">-  return rv;</span>
<a href="#l9.341"></a><span id="l9.341" class="difflineminus">-}</span>
<a href="#l9.342"></a><span id="l9.342" class="difflineminus">-</span>
<a href="#l9.343"></a><span id="l9.343" class="difflineminus">-nsresult nsAbLDAPProcessChangeLogData::ParseChangeLogEntries(</span>
<a href="#l9.344"></a><span id="l9.344" class="difflineminus">-    nsILDAPMessage *aMessage) {</span>
<a href="#l9.345"></a><span id="l9.345" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l9.346"></a><span id="l9.346" class="difflineminus">-  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l9.347"></a><span id="l9.347" class="difflineminus">-</span>
<a href="#l9.348"></a><span id="l9.348" class="difflineminus">-  // Populate the RootDSEChangeLogEntry</span>
<a href="#l9.349"></a><span id="l9.349" class="difflineminus">-  CharPtrArrayGuard attrs;</span>
<a href="#l9.350"></a><span id="l9.350" class="difflineminus">-  nsresult rv =</span>
<a href="#l9.351"></a><span id="l9.351" class="difflineminus">-      aMessage-&gt;GetAttributes(attrs.GetSizeAddr(), attrs.GetArrayAddr());</span>
<a href="#l9.352"></a><span id="l9.352" class="difflineminus">-  // No attributes</span>
<a href="#l9.353"></a><span id="l9.353" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.354"></a><span id="l9.354" class="difflineminus">-</span>
<a href="#l9.355"></a><span id="l9.355" class="difflineminus">-  nsAutoString targetDN;</span>
<a href="#l9.356"></a><span id="l9.356" class="difflineminus">-  UpdateOp operation = NO_OP;</span>
<a href="#l9.357"></a><span id="l9.357" class="difflineminus">-  for (int32_t i = attrs.GetSize() - 1; i &gt;= 0; i--) {</span>
<a href="#l9.358"></a><span id="l9.358" class="difflineminus">-    PRUnicharPtrArrayGuard vals;</span>
<a href="#l9.359"></a><span id="l9.359" class="difflineminus">-    rv = aMessage-&gt;GetValues(attrs.GetArray()[i], vals.GetSizeAddr(),</span>
<a href="#l9.360"></a><span id="l9.360" class="difflineminus">-                             vals.GetArrayAddr());</span>
<a href="#l9.361"></a><span id="l9.361" class="difflineminus">-    if (NS_FAILED(rv)) continue;</span>
<a href="#l9.362"></a><span id="l9.362" class="difflineminus">-    if (vals.GetSize()) {</span>
<a href="#l9.363"></a><span id="l9.363" class="difflineminus">-      if (!PL_strcasecmp(attrs[i], &quot;targetdn&quot;)) targetDN = vals[0];</span>
<a href="#l9.364"></a><span id="l9.364" class="difflineminus">-      if (!PL_strcasecmp(attrs[i], &quot;changetype&quot;)) {</span>
<a href="#l9.365"></a><span id="l9.365" class="difflineminus">-        if (!Compare(nsDependentString(vals[0]), NS_LITERAL_STRING(&quot;add&quot;),</span>
<a href="#l9.366"></a><span id="l9.366" class="difflineminus">-                     nsCaseInsensitiveStringComparator()))</span>
<a href="#l9.367"></a><span id="l9.367" class="difflineminus">-          operation = ENTRY_ADD;</span>
<a href="#l9.368"></a><span id="l9.368" class="difflineminus">-        if (!Compare(nsDependentString(vals[0]), NS_LITERAL_STRING(&quot;modify&quot;),</span>
<a href="#l9.369"></a><span id="l9.369" class="difflineminus">-                     nsCaseInsensitiveStringComparator()))</span>
<a href="#l9.370"></a><span id="l9.370" class="difflineminus">-          operation = ENTRY_MODIFY;</span>
<a href="#l9.371"></a><span id="l9.371" class="difflineminus">-        if (!Compare(nsDependentString(vals[0]), NS_LITERAL_STRING(&quot;delete&quot;),</span>
<a href="#l9.372"></a><span id="l9.372" class="difflineminus">-                     nsCaseInsensitiveStringComparator()))</span>
<a href="#l9.373"></a><span id="l9.373" class="difflineminus">-          operation = ENTRY_DELETE;</span>
<a href="#l9.374"></a><span id="l9.374" class="difflineminus">-      }</span>
<a href="#l9.375"></a><span id="l9.375" class="difflineminus">-    }</span>
<a href="#l9.376"></a><span id="l9.376" class="difflineminus">-  }</span>
<a href="#l9.377"></a><span id="l9.377" class="difflineminus">-</span>
<a href="#l9.378"></a><span id="l9.378" class="difflineminus">-  mChangeLogEntriesCount++;</span>
<a href="#l9.379"></a><span id="l9.379" class="difflineminus">-  if (!(mChangeLogEntriesCount % 10)) {  // Inform the listener every 10 entries</span>
<a href="#l9.380"></a><span id="l9.380" class="difflineminus">-    mListener-&gt;OnProgressChange(nullptr, nullptr, mChangeLogEntriesCount, -1,</span>
<a href="#l9.381"></a><span id="l9.381" class="difflineminus">-                                mChangeLogEntriesCount, -1);</span>
<a href="#l9.382"></a><span id="l9.382" class="difflineminus">-    // In case if the LDAP Connection thread is starved and causes problem</span>
<a href="#l9.383"></a><span id="l9.383" class="difflineminus">-    // uncomment this one and try.</span>
<a href="#l9.384"></a><span id="l9.384" class="difflineminus">-    // PR_Sleep(PR_INTERVAL_NO_WAIT); // give others a chance</span>
<a href="#l9.385"></a><span id="l9.385" class="difflineminus">-  }</span>
<a href="#l9.386"></a><span id="l9.386" class="difflineminus">-</span>
<a href="#l9.387"></a><span id="l9.387" class="difflineminus">-#ifdef DEBUG_rdayal</span>
<a href="#l9.388"></a><span id="l9.388" class="difflineminus">-  printf(&quot;ChangeLog Replication : Updated Entry : %s for OpType : %u\n&quot;,</span>
<a href="#l9.389"></a><span id="l9.389" class="difflineminus">-         NS_ConvertUTF16toUTF8(targetDN).get(), operation);</span>
<a href="#l9.390"></a><span id="l9.390" class="difflineminus">-#endif</span>
<a href="#l9.391"></a><span id="l9.391" class="difflineminus">-</span>
<a href="#l9.392"></a><span id="l9.392" class="difflineminus">-  switch (operation) {</span>
<a href="#l9.393"></a><span id="l9.393" class="difflineminus">-    case ENTRY_ADD:</span>
<a href="#l9.394"></a><span id="l9.394" class="difflineminus">-      // Add the DN to the add list if not already in the list</span>
<a href="#l9.395"></a><span id="l9.395" class="difflineminus">-      if (!(mEntriesToAdd.IndexOf(targetDN) &gt;= 0))</span>
<a href="#l9.396"></a><span id="l9.396" class="difflineminus">-        mEntriesToAdd.AppendString(targetDN);</span>
<a href="#l9.397"></a><span id="l9.397" class="difflineminus">-      break;</span>
<a href="#l9.398"></a><span id="l9.398" class="difflineminus">-    case ENTRY_DELETE:</span>
<a href="#l9.399"></a><span id="l9.399" class="difflineminus">-      // Do not check the return here since delete may fail if</span>
<a href="#l9.400"></a><span id="l9.400" class="difflineminus">-      // entry deleted in changelog does not exist in DB</span>
<a href="#l9.401"></a><span id="l9.401" class="difflineminus">-      // for e.g if the user specifies a filter, so go next entry</span>
<a href="#l9.402"></a><span id="l9.402" class="difflineminus">-      DeleteCard(targetDN);</span>
<a href="#l9.403"></a><span id="l9.403" class="difflineminus">-      break;</span>
<a href="#l9.404"></a><span id="l9.404" class="difflineminus">-    case ENTRY_MODIFY:</span>
<a href="#l9.405"></a><span id="l9.405" class="difflineminus">-      // For modify, delete the entry from DB and add updated entry</span>
<a href="#l9.406"></a><span id="l9.406" class="difflineminus">-      // we do this since we cannot access the changes attribs of changelog</span>
<a href="#l9.407"></a><span id="l9.407" class="difflineminus">-      rv = DeleteCard(targetDN);</span>
<a href="#l9.408"></a><span id="l9.408" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l9.409"></a><span id="l9.409" class="difflineminus">-        if (!(mEntriesToAdd.IndexOf(targetDN) &gt;= 0))</span>
<a href="#l9.410"></a><span id="l9.410" class="difflineminus">-          mEntriesToAdd.AppendString(targetDN);</span>
<a href="#l9.411"></a><span id="l9.411" class="difflineminus">-      break;</span>
<a href="#l9.412"></a><span id="l9.412" class="difflineminus">-    default:</span>
<a href="#l9.413"></a><span id="l9.413" class="difflineminus">-      // Should not come here, would come here only</span>
<a href="#l9.414"></a><span id="l9.414" class="difflineminus">-      // if the entry is not a changeLog entry</span>
<a href="#l9.415"></a><span id="l9.415" class="difflineminus">-      NS_WARNING(</span>
<a href="#l9.416"></a><span id="l9.416" class="difflineminus">-          &quot;nsAbLDAPProcessChangeLogData::ParseChangeLogEntries&quot;</span>
<a href="#l9.417"></a><span id="l9.417" class="difflineminus">-          &quot;Not an changelog entry&quot;);</span>
<a href="#l9.418"></a><span id="l9.418" class="difflineminus">-  }</span>
<a href="#l9.419"></a><span id="l9.419" class="difflineminus">-</span>
<a href="#l9.420"></a><span id="l9.420" class="difflineminus">-  // Go ahead processing the next entry, a modify or delete DB operation</span>
<a href="#l9.421"></a><span id="l9.421" class="difflineminus">-  // can 'correctly' fail if the entry is not present in the DB,</span>
<a href="#l9.422"></a><span id="l9.422" class="difflineminus">-  // e.g. in case a filter is specified.</span>
<a href="#l9.423"></a><span id="l9.423" class="difflineminus">-  return NS_OK;</span>
<a href="#l9.424"></a><span id="l9.424" class="difflineminus">-}</span>
<a href="#l9.425"></a><span id="l9.425" class="difflineminus">-</span>
<a href="#l9.426"></a><span id="l9.426" class="difflineminus">-nsresult nsAbLDAPProcessChangeLogData::OnFindingChangesDone() {</span>
<a href="#l9.427"></a><span id="l9.427" class="difflineminus">-  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l9.428"></a><span id="l9.428" class="difflineminus">-</span>
<a href="#l9.429"></a><span id="l9.429" class="difflineminus">-#ifdef DEBUG_rdayal</span>
<a href="#l9.430"></a><span id="l9.430" class="difflineminus">-  printf(&quot;ChangeLog Replication : Finding Changes Done \n&quot;);</span>
<a href="#l9.431"></a><span id="l9.431" class="difflineminus">-#endif</span>
<a href="#l9.432"></a><span id="l9.432" class="difflineminus">-</span>
<a href="#l9.433"></a><span id="l9.433" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l9.434"></a><span id="l9.434" class="difflineminus">-</span>
<a href="#l9.435"></a><span id="l9.435" class="difflineminus">-  // No entries to add/update (for updates too we delete and add) entries,</span>
<a href="#l9.436"></a><span id="l9.436" class="difflineminus">-  // we took care of deletes in ParseChangeLogEntries, all Done!</span>
<a href="#l9.437"></a><span id="l9.437" class="difflineminus">-  mEntriesAddedQueryCount = mEntriesToAdd.Count();</span>
<a href="#l9.438"></a><span id="l9.438" class="difflineminus">-  if (mEntriesAddedQueryCount &lt;= 0) {</span>
<a href="#l9.439"></a><span id="l9.439" class="difflineminus">-    if (mReplicationDB &amp;&amp; mDBOpen) {</span>
<a href="#l9.440"></a><span id="l9.440" class="difflineminus">-      // Close the DB, no need to commit since we have not made</span>
<a href="#l9.441"></a><span id="l9.441" class="difflineminus">-      // any changes yet to the DB.</span>
<a href="#l9.442"></a><span id="l9.442" class="difflineminus">-      rv = mReplicationDB-&gt;Close(false);</span>
<a href="#l9.443"></a><span id="l9.443" class="difflineminus">-      NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l9.444"></a><span id="l9.444" class="difflineminus">-                   &quot;Replication DB Close(no commit) on Success failed&quot;);</span>
<a href="#l9.445"></a><span id="l9.445" class="difflineminus">-      mDBOpen = false;</span>
<a href="#l9.446"></a><span id="l9.446" class="difflineminus">-      // Once are done with the replication file, delete the backup file</span>
<a href="#l9.447"></a><span id="l9.447" class="difflineminus">-      if (mBackupReplicationFile) {</span>
<a href="#l9.448"></a><span id="l9.448" class="difflineminus">-        rv = mBackupReplicationFile-&gt;Remove(false);</span>
<a href="#l9.449"></a><span id="l9.449" class="difflineminus">-        NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l9.450"></a><span id="l9.450" class="difflineminus">-                     &quot;Replication BackupFile Remove on Success failed&quot;);</span>
<a href="#l9.451"></a><span id="l9.451" class="difflineminus">-      }</span>
<a href="#l9.452"></a><span id="l9.452" class="difflineminus">-    }</span>
<a href="#l9.453"></a><span id="l9.453" class="difflineminus">-    Done(true);</span>
<a href="#l9.454"></a><span id="l9.454" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.455"></a><span id="l9.455" class="difflineminus">-  }</span>
<a href="#l9.456"></a><span id="l9.456" class="difflineminus">-</span>
<a href="#l9.457"></a><span id="l9.457" class="difflineminus">-  // Decrement the count first to get the correct array element</span>
<a href="#l9.458"></a><span id="l9.458" class="difflineminus">-  mEntriesAddedQueryCount--;</span>
<a href="#l9.459"></a><span id="l9.459" class="difflineminus">-  rv = mChangeLogQuery-&gt;QueryChangedEntries(</span>
<a href="#l9.460"></a><span id="l9.460" class="difflineminus">-      NS_ConvertUTF16toUTF8(*(mEntriesToAdd[mEntriesAddedQueryCount])));</span>
<a href="#l9.461"></a><span id="l9.461" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.462"></a><span id="l9.462" class="difflineminus">-</span>
<a href="#l9.463"></a><span id="l9.463" class="difflineminus">-  if (mListener &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l9.464"></a><span id="l9.464" class="difflineminus">-    mListener-&gt;OnStateChange(nullptr, nullptr,</span>
<a href="#l9.465"></a><span id="l9.465" class="difflineminus">-                             nsIWebProgressListener::STATE_START, true);</span>
<a href="#l9.466"></a><span id="l9.466" class="difflineminus">-</span>
<a href="#l9.467"></a><span id="l9.467" class="difflineminus">-  mState = kReplicatingChanges;</span>
<a href="#l9.468"></a><span id="l9.468" class="difflineminus">-  return rv;</span>
<a href="#l9.469"></a><span id="l9.469" class="difflineminus">-}</span>
<a href="#l9.470"></a><span id="l9.470" class="difflineminus">-</span>
<a href="#l9.471"></a><span id="l9.471" class="difflineminus">-nsresult nsAbLDAPProcessChangeLogData::OnReplicatingChangeDone() {</span>
<a href="#l9.472"></a><span id="l9.472" class="difflineminus">-  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l9.473"></a><span id="l9.473" class="difflineminus">-</span>
<a href="#l9.474"></a><span id="l9.474" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l9.475"></a><span id="l9.475" class="difflineminus">-</span>
<a href="#l9.476"></a><span id="l9.476" class="difflineminus">-  if (!mEntriesAddedQueryCount) {</span>
<a href="#l9.477"></a><span id="l9.477" class="difflineminus">-    if (mReplicationDB &amp;&amp; mDBOpen) {</span>
<a href="#l9.478"></a><span id="l9.478" class="difflineminus">-      rv = mReplicationDB-&gt;Close(true);  // Commit and close the DB</span>
<a href="#l9.479"></a><span id="l9.479" class="difflineminus">-      NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l9.480"></a><span id="l9.480" class="difflineminus">-                   &quot;Replication DB Close (commit) on Success failed&quot;);</span>
<a href="#l9.481"></a><span id="l9.481" class="difflineminus">-      mDBOpen = false;</span>
<a href="#l9.482"></a><span id="l9.482" class="difflineminus">-    }</span>
<a href="#l9.483"></a><span id="l9.483" class="difflineminus">-    // Once we done with the replication file, delete the backup file.</span>
<a href="#l9.484"></a><span id="l9.484" class="difflineminus">-    if (mBackupReplicationFile) {</span>
<a href="#l9.485"></a><span id="l9.485" class="difflineminus">-      rv = mBackupReplicationFile-&gt;Remove(false);</span>
<a href="#l9.486"></a><span id="l9.486" class="difflineminus">-      NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l9.487"></a><span id="l9.487" class="difflineminus">-                   &quot;Replication BackupFile Remove on Success failed&quot;);</span>
<a href="#l9.488"></a><span id="l9.488" class="difflineminus">-    }</span>
<a href="#l9.489"></a><span id="l9.489" class="difflineminus">-    Done(true);  // All data is received</span>
<a href="#l9.490"></a><span id="l9.490" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.491"></a><span id="l9.491" class="difflineminus">-  }</span>
<a href="#l9.492"></a><span id="l9.492" class="difflineminus">-</span>
<a href="#l9.493"></a><span id="l9.493" class="difflineminus">-  // Remove the entry already added from the list and query the next one.</span>
<a href="#l9.494"></a><span id="l9.494" class="difflineminus">-  if (mEntriesAddedQueryCount &lt; mEntriesToAdd.Count() &amp;&amp;</span>
<a href="#l9.495"></a><span id="l9.495" class="difflineminus">-      mEntriesAddedQueryCount &gt;= 0)</span>
<a href="#l9.496"></a><span id="l9.496" class="difflineminus">-    mEntriesToAdd.RemoveStringAt(mEntriesAddedQueryCount);</span>
<a href="#l9.497"></a><span id="l9.497" class="difflineminus">-  mEntriesAddedQueryCount--;</span>
<a href="#l9.498"></a><span id="l9.498" class="difflineminus">-  rv = mChangeLogQuery-&gt;QueryChangedEntries(</span>
<a href="#l9.499"></a><span id="l9.499" class="difflineminus">-      NS_ConvertUTF16toUTF8(*(mEntriesToAdd[mEntriesAddedQueryCount])));</span>
<a href="#l9.500"></a><span id="l9.500" class="difflineminus">-</span>
<a href="#l9.501"></a><span id="l9.501" class="difflineminus">-  return rv;</span>
<a href="#l9.502"></a><span id="l9.502" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">deleted file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPChangeLogData.h</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ /dev/null</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -1,54 +0,0 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineminus">-</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineminus">-#ifndef nsAbLDAPChangeLogData_h__</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineminus">-#define nsAbLDAPChangeLogData_h__</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineminus">-</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-#include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-#include &quot;nsAbLDAPReplicationData.h&quot;</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-#include &quot;nsAbLDAPChangeLogQuery.h&quot;</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-typedef struct {</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-  nsCString changeLogDN;</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">-  int32_t firstChangeNumber;</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-  int32_t lastChangeNumber;</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-  nsCString dataVersion;</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-} RootDSEChangeLogEntry;</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineminus">-class nsAbLDAPProcessChangeLogData : public nsAbLDAPProcessReplicationData {</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineminus">- public:</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineminus">-  nsAbLDAPProcessChangeLogData();</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineminus">-  NS_IMETHOD Init(nsIAbLDAPReplicationQuery *query,</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-                  nsIWebProgressListener *progressListener);</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">- protected:</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-  ~nsAbLDAPProcessChangeLogData();</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineminus">-  nsCOMPtr&lt;nsIAbLDAPChangeLogQuery&gt; mChangeLogQuery;</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-  nsresult OnLDAPBind(nsILDAPMessage *aMessage);</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">-  nsresult OnLDAPSearchEntry(nsILDAPMessage *aMessage) override;</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-  nsresult OnLDAPSearchResult(nsILDAPMessage *aMessage) override;</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">-</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-  nsresult ParseChangeLogEntries(nsILDAPMessage *aMessage);</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineminus">-  nsresult ParseRootDSEEntry(nsILDAPMessage *aMessage);</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineminus">-</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineminus">-  nsresult GetAuthData();  // displays username and password prompt</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineminus">-  nsCString mAuthUserID;   // user id of the user making the connection</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">-</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineminus">-  nsresult OnSearchAuthDNDone();</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineminus">-  nsresult OnSearchRootDSEDone();</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-  nsresult OnFindingChangesDone();</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-  nsresult OnReplicatingChangeDone();</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineminus">-</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-  RootDSEChangeLogEntry mRootDSEEntry;</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-  bool mUseChangeLog;</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-  int32_t mChangeLogEntriesCount;</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineminus">-</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineminus">-  int32_t mEntriesAddedQueryCount;</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineminus">-  nsStringArray mEntriesToAdd;</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineminus">-};</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineminus">-</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineminus">-#endif  // nsAbLDAPChangeLogData_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">deleted file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPChangeLogQuery.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ /dev/null</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -1,148 +0,0 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineminus">- *</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineminus">-</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-#include &quot;nsAbLDAPChangeLogQuery.h&quot;</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-#include &quot;nsAbLDAPReplicationService.h&quot;</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-#include &quot;nsAbLDAPChangeLogData.h&quot;</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-#include &quot;nsAbUtils.h&quot;</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-#include &quot;prprf.h&quot;</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-#include &quot;nsDirPrefs.h&quot;</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-#include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-// The tables below were originally in nsAbLDAPProperties.cpp, which has since</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-// gone away.</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-static const char *sChangeLogRootDSEAttribs[] = {</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-    &quot;changelog&quot;, &quot;firstChangeNumber&quot;, &quot;lastChangeNumber&quot;, &quot;dataVersion&quot;};</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-static const char *sChangeLogEntryAttribs[] = {&quot;targetdn&quot;, &quot;changetype&quot;};</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-NS_IMPL_ISUPPORTS_INHERITED(nsAbLDAPChangeLogQuery, nsAbLDAPReplicationQuery,</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-                            nsIAbLDAPChangeLogQuery)</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-nsAbLDAPChangeLogQuery::nsAbLDAPChangeLogQuery() {}</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-nsAbLDAPChangeLogQuery::~nsAbLDAPChangeLogQuery() {}</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-// this is to be defined only till this is not hooked to SSL to get authDN and</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-// authPswd</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">-#define USE_AUTHDLG</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-NS_IMETHODIMP nsAbLDAPChangeLogQuery::Init(</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">-    const nsACString &amp;aPrefName, nsIWebProgressListener *aProgressListener) {</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-  if (aPrefName.IsEmpty()) return NS_ERROR_UNEXPECTED;</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">-</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineminus">-  mDirPrefName = aPrefName;</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">-</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineminus">-  nsresult rv = InitLDAPData();</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineminus">-  // create the ChangeLog Data Processor</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineminus">-  mDataProcessor =</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineminus">-      do_CreateInstance(NS_ABLDAP_PROCESSCHANGELOGDATA_CONTRACTID, &amp;rv);</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineminus">-  // 'this' initialized</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">-  mInitialized = true;</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineminus">-</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-  return mDataProcessor-&gt;Init(this, aProgressListener);</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineminus">-}</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineminus">-NS_IMETHODIMP nsAbLDAPChangeLogQuery::DoReplicationQuery() {</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineminus">-</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineminus">-#ifdef USE_AUTHDLG</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-  return ConnectToLDAPServer(mURL, EmptyCString());</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-#else</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-  mDataProcessor-&gt;PopulateAuthData();</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineminus">-  return ConnectToLDAPServer(mURL, mAuthDN);</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineminus">-#endif</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineminus">-}</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineminus">-</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineminus">-NS_IMETHODIMP nsAbLDAPChangeLogQuery::QueryAuthDN(</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineminus">-    const nsACString &amp;aValueUsedToFindDn) {</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineminus">-  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineminus">-</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineminus">-  nsCOMPtr&lt;nsIAbLDAPAttributeMap&gt; attrMap;</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineminus">-  nsresult rv = mDirectory-&gt;GetAttributeMap(getter_AddRefs(attrMap));</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineminus">-</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineminus">-  nsAutoCString filter;</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineminus">-  rv = attrMap-&gt;GetFirstAttribute(NS_LITERAL_CSTRING(&quot;PrimaryEmail&quot;), filter);</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineminus">-</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineminus">-  filter += '=';</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineminus">-  filter += aValueUsedToFindDn;</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineminus">-</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineminus">-  nsAutoCString dn;</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineminus">-  rv = mURL-&gt;GetDn(dn);</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineminus">-</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineminus">-  rv = CreateNewLDAPOperation();</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineminus">-</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineminus">-  // XXX We really should be using LDAP_NO_ATTRS here once its exposed via</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineminus">-  // the XPCOM layer of the directory code.</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineminus">-  return mOperation-&gt;SearchExt(dn, nsILDAPURL::SCOPE_SUBTREE, filter, 0,</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineminus">-                               nullptr, 0, 0);</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineminus">-}</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineminus">-</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineminus">-NS_IMETHODIMP nsAbLDAPChangeLogQuery::QueryRootDSE() {</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineminus">-  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineminus">-</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineminus">-  nsresult rv = CreateNewLDAPOperation();</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineminus">-  return mOperation-&gt;SearchExt(EmptyCString(), nsILDAPURL::SCOPE_BASE,</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineminus">-                               NS_LITERAL_CSTRING(&quot;objectclass=*&quot;),</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineminus">-                               sizeof(sChangeLogRootDSEAttribs),</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineminus">-                               sChangeLogRootDSEAttribs, 0, 0);</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineminus">-}</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineminus">-</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineminus">-NS_IMETHODIMP nsAbLDAPChangeLogQuery::QueryChangeLog(</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineminus">-    const nsACString &amp;aChangeLogDN, int32_t aLastChangeNo) {</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineminus">-  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineminus">-  if (aChangeLogDN.IsEmpty()) return NS_ERROR_UNEXPECTED;</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineminus">-</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineminus">-  int32_t lastChangeNumber;</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineminus">-  nsresult rv = mDirectory-&gt;GetLastChangeNumber(&amp;lastChangeNumber);</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineminus">-</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineminus">-  // make sure that the filter here just have one condition</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineminus">-  // and should not be enclosed in enclosing brackets.</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineminus">-  // also condition '&gt;' does not work, it should be '&gt;='/</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineminus">-  nsAutoCString filter(NS_LITERAL_CSTRING(&quot;changenumber&gt;=&quot;));</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineminus">-  filter.AppendInt(lastChangeNumber + 1);</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineminus">-</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineminus">-  rv = CreateNewLDAPOperation();</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineminus">-</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineminus">-  return mOperation-&gt;SearchExt(aChangeLogDN, nsILDAPURL::SCOPE_ONELEVEL, filter,</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineminus">-                               sizeof(sChangeLogEntryAttribs),</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineminus">-                               sChangeLogEntryAttribs, 0, 0);</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineminus">-}</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineminus">-</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineminus">-NS_IMETHODIMP nsAbLDAPChangeLogQuery::QueryChangedEntries(</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineminus">-    const nsACString &amp;aChangedEntryDN) {</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineminus">-  if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineminus">-  if (aChangedEntryDN.IsEmpty()) return NS_ERROR_UNEXPECTED;</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineminus">-</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineminus">-  nsAutoCString urlFilter;</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineminus">-  nsresult rv = mURL-&gt;GetFilter(urlFilter);</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineminus">-</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineminus">-  int32_t scope;</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineminus">-  rv = mURL-&gt;GetScope(&amp;scope);</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineminus">-</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineminus">-  CharPtrArrayGuard attributes;</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineminus">-  rv = mURL-&gt;GetAttributes(attributes.GetSizeAddr(), attributes.GetArrayAddr());</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineminus">-</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineminus">-  rv = CreateNewLDAPOperation();</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineminus">-  return mOperation-&gt;SearchExt(aChangedEntryDN, scope, urlFilter,</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineminus">-                               attributes.GetSize(), attributes.GetArray(), 0,</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineminus">-                               0);</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">deleted file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPChangeLogQuery.h</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ /dev/null</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -1,28 +0,0 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineminus">- *</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineminus">-</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineminus">-#ifndef nsAbLDAPChangeLogQuery_h__</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-#define nsAbLDAPChangeLogQuery_h__</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-#include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">-#include &quot;nsAbLDAPReplicationQuery.h&quot;</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-class nsAbLDAPChangeLogQuery : public nsIAbLDAPChangeLogQuery,</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-                               public nsAbLDAPReplicationQuery {</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineminus">- public:</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineminus">-  NS_DECL_ISUPPORTS</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineminus">-  NS_DECL_NSIABLDAPCHANGELOGQUERY</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineminus">-</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineminus">-  nsAbLDAPChangeLogQuery();</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineminus">-  virtual ~nsAbLDAPChangeLogQuery();</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineminus">-</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineminus">-  NS_IMETHOD DoReplicationQuery() override;</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineminus">-  NS_IMETHOD Init(const nsACString &amp;aPrefName,</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineminus">-                  nsIWebProgressListener *aProgressListener);</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">-};</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineminus">-#endif  // nsAbLDAPChangeLogQuery_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPDirectory.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPDirectory.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -20,17 +20,16 @@</span>
<a href="#l13.4"></a><span id="l13.4"> #include &quot;nsIAddrDatabase.h&quot;</span>
<a href="#l13.5"></a><span id="l13.5"> #include &quot;nsILDAPURL.h&quot;</span>
<a href="#l13.6"></a><span id="l13.6"> #include &quot;nsILDAPConnection.h&quot;</span>
<a href="#l13.7"></a><span id="l13.7"> #include &quot;nsAppDirectoryServiceDefs.h&quot;</span>
<a href="#l13.8"></a><span id="l13.8"> #include &quot;nsDirectoryServiceUtils.h&quot;</span>
<a href="#l13.9"></a><span id="l13.9"> #include &quot;nsIFile.h&quot;</span>
<a href="#l13.10"></a><span id="l13.10"> #include &quot;nsILDAPModification.h&quot;</span>
<a href="#l13.11"></a><span id="l13.11"> #include &quot;nsILDAPService.h&quot;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-#include &quot;nsIAbLDAPCard.h&quot;</span>
<a href="#l13.13"></a><span id="l13.13"> #include &quot;nsAbUtils.h&quot;</span>
<a href="#l13.14"></a><span id="l13.14"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l13.15"></a><span id="l13.15"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l13.16"></a><span id="l13.16"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l13.17"></a><span id="l13.17"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l13.18"></a><span id="l13.18"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l13.19"></a><span id="l13.19"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l13.20"></a><span id="l13.20"> #include &quot;nsIWeakReference.h&quot;</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineat">@@ -377,37 +376,17 @@ NS_IMETHODIMP nsAbLDAPDirectory::GetSupp</span>
<a href="#l13.22"></a><span id="l13.22">     bool *aSupportsMailingsLists) {</span>
<a href="#l13.23"></a><span id="l13.23">   NS_ENSURE_ARG_POINTER(aSupportsMailingsLists);</span>
<a href="#l13.24"></a><span id="l13.24">   *aSupportsMailingsLists = false;</span>
<a href="#l13.25"></a><span id="l13.25">   return NS_OK;</span>
<a href="#l13.26"></a><span id="l13.26"> }</span>
<a href="#l13.27"></a><span id="l13.27"> </span>
<a href="#l13.28"></a><span id="l13.28"> NS_IMETHODIMP nsAbLDAPDirectory::GetReadOnly(bool *aReadOnly) {</span>
<a href="#l13.29"></a><span id="l13.29">   NS_ENSURE_ARG_POINTER(aReadOnly);</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">-</span>
<a href="#l13.31"></a><span id="l13.31">   *aReadOnly = true;</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-#ifdef MOZ_EXPERIMENTAL_WRITEABLE_LDAP</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineminus">-  bool readOnly;</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineminus">-  nsresult rv = GetBoolValue(&quot;readonly&quot;, false, &amp;readOnly);</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineminus">-</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineminus">-  if (readOnly) return NS_OK;</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineminus">-</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineminus">-  // when online, we'll allow writing as well</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineminus">-  bool offline;</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineminus">-  nsCOMPtr&lt;nsIIOService&gt; ioService = mozilla::services::GetIOService();</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineminus">-  NS_ENSURE_TRUE(ioService, NS_ERROR_UNEXPECTED);</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineminus">-</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineminus">-  rv = ioService-&gt;GetOffline(&amp;offline);</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineminus">-</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineminus">-  if (!offline) *aReadOnly = false;</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineminus">-#endif</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineminus">-</span>
<a href="#l13.51"></a><span id="l13.51">   return NS_OK;</span>
<a href="#l13.52"></a><span id="l13.52"> }</span>
<a href="#l13.53"></a><span id="l13.53"> </span>
<a href="#l13.54"></a><span id="l13.54"> NS_IMETHODIMP nsAbLDAPDirectory::GetIsRemote(bool *aIsRemote) {</span>
<a href="#l13.55"></a><span id="l13.55">   NS_ENSURE_ARG_POINTER(aIsRemote);</span>
<a href="#l13.56"></a><span id="l13.56">   *aIsRemote = true;</span>
<a href="#l13.57"></a><span id="l13.57">   return NS_OK;</span>
<a href="#l13.58"></a><span id="l13.58"> }</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineat">@@ -500,40 +479,16 @@ NS_IMETHODIMP nsAbLDAPDirectory::UseForA</span>
<a href="#l13.60"></a><span id="l13.60">     rv = databaseFile-&gt;Exists(&amp;exists);</span>
<a href="#l13.61"></a><span id="l13.61">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.62"></a><span id="l13.62"> </span>
<a href="#l13.63"></a><span id="l13.63">     *aResult = exists;</span>
<a href="#l13.64"></a><span id="l13.64">   }</span>
<a href="#l13.65"></a><span id="l13.65">   return NS_OK;</span>
<a href="#l13.66"></a><span id="l13.66"> }</span>
<a href="#l13.67"></a><span id="l13.67"> </span>
<a href="#l13.68"></a><span id="l13.68" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::GetSearchClientControls(</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineminus">-    nsIMutableArray **aControls) {</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineminus">-  NS_IF_ADDREF(*aControls = mSearchClientControls);</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineminus">-}</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineminus">-</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::SetSearchClientControls(</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineminus">-    nsIMutableArray *aControls) {</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineminus">-  mSearchClientControls = aControls;</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineminus">-}</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineminus">-</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::GetSearchServerControls(</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineminus">-    nsIMutableArray **aControls) {</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineminus">-  NS_IF_ADDREF(*aControls = mSearchServerControls);</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineminus">-}</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineminus">-</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::SetSearchServerControls(</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineminus">-    nsIMutableArray *aControls) {</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineminus">-  mSearchServerControls = aControls;</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineminus">-}</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineminus">-</span>
<a href="#l13.92"></a><span id="l13.92"> NS_IMETHODIMP nsAbLDAPDirectory::GetProtocolVersion(</span>
<a href="#l13.93"></a><span id="l13.93">     uint32_t *aProtocolVersion) {</span>
<a href="#l13.94"></a><span id="l13.94">   nsAutoCString versionString;</span>
<a href="#l13.95"></a><span id="l13.95"> </span>
<a href="#l13.96"></a><span id="l13.96">   nsresult rv =</span>
<a href="#l13.97"></a><span id="l13.97">       GetStringValue(&quot;protocolVersion&quot;, NS_LITERAL_CSTRING(&quot;3&quot;), versionString);</span>
<a href="#l13.98"></a><span id="l13.98">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.99"></a><span id="l13.99"> </span>
<a href="#l13.100"></a><span id="l13.100" class="difflineat">@@ -640,190 +595,26 @@ NS_IMETHODIMP nsAbLDAPDirectory::GetRepl</span>
<a href="#l13.101"></a><span id="l13.101"> </span>
<a href="#l13.102"></a><span id="l13.102">   profileDir.forget(aResult);</span>
<a href="#l13.103"></a><span id="l13.103"> </span>
<a href="#l13.104"></a><span id="l13.104">   return NS_OK;</span>
<a href="#l13.105"></a><span id="l13.105"> }</span>
<a href="#l13.106"></a><span id="l13.106"> </span>
<a href="#l13.107"></a><span id="l13.107"> NS_IMETHODIMP nsAbLDAPDirectory::AddCard(nsIAbCard *aUpdatedCard,</span>
<a href="#l13.108"></a><span id="l13.108">                                          nsIAbCard **aAddedCard) {</span>
<a href="#l13.109"></a><span id="l13.109" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aUpdatedCard);</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aAddedCard);</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineminus">-</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineminus">-  nsCOMPtr&lt;nsIAbLDAPAttributeMap&gt; attrMap;</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineminus">-  nsresult rv = GetAttributeMap(getter_AddRefs(attrMap));</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineminus">-</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineminus">-  // Create a new LDAP card</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineminus">-  nsCOMPtr&lt;nsIAbLDAPCard&gt; card =</span>
<a href="#l13.118"></a><span id="l13.118" class="difflineminus">-      do_CreateInstance(NS_ABLDAPCARD_CONTRACTID, &amp;rv);</span>
<a href="#l13.119"></a><span id="l13.119" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineminus">-</span>
<a href="#l13.121"></a><span id="l13.121" class="difflineminus">-  rv = Initiate();</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineminus">-</span>
<a href="#l13.124"></a><span id="l13.124" class="difflineminus">-  // Copy over the card data</span>
<a href="#l13.125"></a><span id="l13.125" class="difflineminus">-  nsCOMPtr&lt;nsIAbCard&gt; copyToCard = do_QueryInterface(card, &amp;rv);</span>
<a href="#l13.126"></a><span id="l13.126" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.127"></a><span id="l13.127" class="difflineminus">-</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineminus">-  rv = copyToCard-&gt;Copy(aUpdatedCard);</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.130"></a><span id="l13.130" class="difflineminus">-</span>
<a href="#l13.131"></a><span id="l13.131" class="difflineminus">-  // Retrieve preferences</span>
<a href="#l13.132"></a><span id="l13.132" class="difflineminus">-  nsAutoCString prefString;</span>
<a href="#l13.133"></a><span id="l13.133" class="difflineminus">-  rv = GetRdnAttributes(prefString);</span>
<a href="#l13.134"></a><span id="l13.134" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.135"></a><span id="l13.135" class="difflineminus">-</span>
<a href="#l13.136"></a><span id="l13.136" class="difflineminus">-  nsTArray&lt;nsCString&gt; rdnAttrs;</span>
<a href="#l13.137"></a><span id="l13.137" class="difflineminus">-  ParseString(prefString, ',', rdnAttrs);</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineminus">-</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineminus">-  rv = GetObjectClasses(prefString);</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.141"></a><span id="l13.141" class="difflineminus">-</span>
<a href="#l13.142"></a><span id="l13.142" class="difflineminus">-  nsTArray&lt;nsCString&gt; objClass;</span>
<a href="#l13.143"></a><span id="l13.143" class="difflineminus">-  ParseString(prefString, ',', objClass);</span>
<a href="#l13.144"></a><span id="l13.144" class="difflineminus">-</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineminus">-  // Process updates</span>
<a href="#l13.146"></a><span id="l13.146" class="difflineminus">-  nsCOMPtr&lt;nsIArray&gt; modArray;</span>
<a href="#l13.147"></a><span id="l13.147" class="difflineminus">-  rv = card-&gt;GetLDAPMessageInfo(attrMap, objClass, nsILDAPModification::MOD_ADD,</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineminus">-                                getter_AddRefs(modArray));</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineminus">-</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineminus">-  // For new cards, the base DN is the search base DN</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineminus">-  nsCOMPtr&lt;nsILDAPURL&gt; currentUrl;</span>
<a href="#l13.153"></a><span id="l13.153" class="difflineminus">-  rv = GetLDAPURL(getter_AddRefs(currentUrl));</span>
<a href="#l13.154"></a><span id="l13.154" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.155"></a><span id="l13.155" class="difflineminus">-</span>
<a href="#l13.156"></a><span id="l13.156" class="difflineminus">-  nsAutoCString baseDN;</span>
<a href="#l13.157"></a><span id="l13.157" class="difflineminus">-  rv = currentUrl-&gt;GetDn(baseDN);</span>
<a href="#l13.158"></a><span id="l13.158" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.159"></a><span id="l13.159" class="difflineminus">-</span>
<a href="#l13.160"></a><span id="l13.160" class="difflineminus">-  // Calculate DN</span>
<a href="#l13.161"></a><span id="l13.161" class="difflineminus">-  nsAutoCString cardDN;</span>
<a href="#l13.162"></a><span id="l13.162" class="difflineminus">-  rv = card-&gt;BuildRdn(attrMap, rdnAttrs, cardDN);</span>
<a href="#l13.163"></a><span id="l13.163" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.164"></a><span id="l13.164" class="difflineminus">-  cardDN.Append(',');</span>
<a href="#l13.165"></a><span id="l13.165" class="difflineminus">-  cardDN.Append(baseDN);</span>
<a href="#l13.166"></a><span id="l13.166" class="difflineminus">-</span>
<a href="#l13.167"></a><span id="l13.167" class="difflineminus">-  rv = card-&gt;SetDn(cardDN);</span>
<a href="#l13.168"></a><span id="l13.168" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.169"></a><span id="l13.169" class="difflineminus">-</span>
<a href="#l13.170"></a><span id="l13.170" class="difflineminus">-  nsAutoCString ourUuid;</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineminus">-  GetUuid(ourUuid);</span>
<a href="#l13.172"></a><span id="l13.172" class="difflineminus">-  copyToCard-&gt;SetDirectoryId(ourUuid);</span>
<a href="#l13.173"></a><span id="l13.173" class="difflineminus">-</span>
<a href="#l13.174"></a><span id="l13.174" class="difflineminus">-  // Launch query</span>
<a href="#l13.175"></a><span id="l13.175" class="difflineminus">-  rv = DoModify(this, nsILDAPModification::MOD_ADD, cardDN, modArray,</span>
<a href="#l13.176"></a><span id="l13.176" class="difflineminus">-                EmptyCString(), EmptyCString());</span>
<a href="#l13.177"></a><span id="l13.177" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.178"></a><span id="l13.178" class="difflineminus">-</span>
<a href="#l13.179"></a><span id="l13.179" class="difflineminus">-  copyToCard.forget(aAddedCard);</span>
<a href="#l13.180"></a><span id="l13.180" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.181"></a><span id="l13.181" class="difflineplus">+  return NS_ERROR_UNEXPECTED;</span>
<a href="#l13.182"></a><span id="l13.182"> }</span>
<a href="#l13.183"></a><span id="l13.183"> </span>
<a href="#l13.184"></a><span id="l13.184"> NS_IMETHODIMP nsAbLDAPDirectory::DeleteCards(</span>
<a href="#l13.185"></a><span id="l13.185">     const nsTArray&lt;RefPtr&lt;nsIAbCard&gt;&gt; &amp;aCards) {</span>
<a href="#l13.186"></a><span id="l13.186" class="difflineminus">-  uint32_t cardCount = aCards.Length();</span>
<a href="#l13.187"></a><span id="l13.187" class="difflineminus">-  uint32_t i;</span>
<a href="#l13.188"></a><span id="l13.188" class="difflineminus">-  nsAutoCString cardDN;</span>
<a href="#l13.189"></a><span id="l13.189" class="difflineminus">-</span>
<a href="#l13.190"></a><span id="l13.190" class="difflineminus">-  for (i = 0; i &lt; cardCount; ++i) {</span>
<a href="#l13.191"></a><span id="l13.191" class="difflineminus">-    nsresult rv;</span>
<a href="#l13.192"></a><span id="l13.192" class="difflineminus">-    nsCOMPtr&lt;nsIAbLDAPCard&gt; card(do_QueryInterface(aCards[i], &amp;rv));</span>
<a href="#l13.193"></a><span id="l13.193" class="difflineminus">-    if (NS_FAILED(rv)) {</span>
<a href="#l13.194"></a><span id="l13.194" class="difflineminus">-      NS_WARNING(&quot;Wrong type of card passed to nsAbLDAPDirectory::DeleteCards&quot;);</span>
<a href="#l13.195"></a><span id="l13.195" class="difflineminus">-      break;</span>
<a href="#l13.196"></a><span id="l13.196" class="difflineminus">-    }</span>
<a href="#l13.197"></a><span id="l13.197" class="difflineminus">-</span>
<a href="#l13.198"></a><span id="l13.198" class="difflineminus">-    // Set up the search ldap url - this is mURL</span>
<a href="#l13.199"></a><span id="l13.199" class="difflineminus">-    rv = Initiate();</span>
<a href="#l13.200"></a><span id="l13.200" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.201"></a><span id="l13.201" class="difflineminus">-</span>
<a href="#l13.202"></a><span id="l13.202" class="difflineminus">-    rv = card-&gt;GetDn(cardDN);</span>
<a href="#l13.203"></a><span id="l13.203" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.204"></a><span id="l13.204" class="difflineminus">-</span>
<a href="#l13.205"></a><span id="l13.205" class="difflineminus">-    aCards[i]-&gt;SetDirectoryId(EmptyCString());</span>
<a href="#l13.206"></a><span id="l13.206" class="difflineminus">-</span>
<a href="#l13.207"></a><span id="l13.207" class="difflineminus">-    // Launch query</span>
<a href="#l13.208"></a><span id="l13.208" class="difflineminus">-    rv = DoModify(this, nsILDAPModification::MOD_DELETE, cardDN, nullptr,</span>
<a href="#l13.209"></a><span id="l13.209" class="difflineminus">-                  EmptyCString(), EmptyCString());</span>
<a href="#l13.210"></a><span id="l13.210" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.211"></a><span id="l13.211" class="difflineminus">-  }</span>
<a href="#l13.212"></a><span id="l13.212" class="difflineminus">-</span>
<a href="#l13.213"></a><span id="l13.213" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.214"></a><span id="l13.214" class="difflineplus">+  return NS_ERROR_UNEXPECTED;</span>
<a href="#l13.215"></a><span id="l13.215"> }</span>
<a href="#l13.216"></a><span id="l13.216"> </span>
<a href="#l13.217"></a><span id="l13.217"> NS_IMETHODIMP nsAbLDAPDirectory::ModifyCard(nsIAbCard *aUpdatedCard) {</span>
<a href="#l13.218"></a><span id="l13.218" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aUpdatedCard);</span>
<a href="#l13.219"></a><span id="l13.219" class="difflineminus">-</span>
<a href="#l13.220"></a><span id="l13.220" class="difflineminus">-  nsCOMPtr&lt;nsIAbLDAPAttributeMap&gt; attrMap;</span>
<a href="#l13.221"></a><span id="l13.221" class="difflineminus">-  nsresult rv = GetAttributeMap(getter_AddRefs(attrMap));</span>
<a href="#l13.222"></a><span id="l13.222" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.223"></a><span id="l13.223" class="difflineminus">-</span>
<a href="#l13.224"></a><span id="l13.224" class="difflineminus">-  // Get the LDAP card</span>
<a href="#l13.225"></a><span id="l13.225" class="difflineminus">-  nsCOMPtr&lt;nsIAbLDAPCard&gt; card = do_QueryInterface(aUpdatedCard, &amp;rv);</span>
<a href="#l13.226"></a><span id="l13.226" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.227"></a><span id="l13.227" class="difflineminus">-</span>
<a href="#l13.228"></a><span id="l13.228" class="difflineminus">-  rv = Initiate();</span>
<a href="#l13.229"></a><span id="l13.229" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.230"></a><span id="l13.230" class="difflineminus">-</span>
<a href="#l13.231"></a><span id="l13.231" class="difflineminus">-  // Retrieve preferences</span>
<a href="#l13.232"></a><span id="l13.232" class="difflineminus">-  nsAutoCString prefString;</span>
<a href="#l13.233"></a><span id="l13.233" class="difflineminus">-  rv = GetObjectClasses(prefString);</span>
<a href="#l13.234"></a><span id="l13.234" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.235"></a><span id="l13.235" class="difflineminus">-</span>
<a href="#l13.236"></a><span id="l13.236" class="difflineminus">-  nsTArray&lt;nsCString&gt; objClass;</span>
<a href="#l13.237"></a><span id="l13.237" class="difflineminus">-  ParseString(prefString, ',', objClass);</span>
<a href="#l13.238"></a><span id="l13.238" class="difflineminus">-</span>
<a href="#l13.239"></a><span id="l13.239" class="difflineminus">-  // Process updates</span>
<a href="#l13.240"></a><span id="l13.240" class="difflineminus">-  nsCOMPtr&lt;nsIArray&gt; modArray;</span>
<a href="#l13.241"></a><span id="l13.241" class="difflineminus">-  rv = card-&gt;GetLDAPMessageInfo(attrMap, objClass,</span>
<a href="#l13.242"></a><span id="l13.242" class="difflineminus">-                                nsILDAPModification::MOD_REPLACE,</span>
<a href="#l13.243"></a><span id="l13.243" class="difflineminus">-                                getter_AddRefs(modArray));</span>
<a href="#l13.244"></a><span id="l13.244" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.245"></a><span id="l13.245" class="difflineminus">-</span>
<a href="#l13.246"></a><span id="l13.246" class="difflineminus">-  // Get current DN</span>
<a href="#l13.247"></a><span id="l13.247" class="difflineminus">-  nsAutoCString oldDN;</span>
<a href="#l13.248"></a><span id="l13.248" class="difflineminus">-  rv = card-&gt;GetDn(oldDN);</span>
<a href="#l13.249"></a><span id="l13.249" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.250"></a><span id="l13.250" class="difflineminus">-</span>
<a href="#l13.251"></a><span id="l13.251" class="difflineminus">-  nsCOMPtr&lt;nsILDAPService&gt; ldapSvc =</span>
<a href="#l13.252"></a><span id="l13.252" class="difflineminus">-      do_GetService(&quot;@mozilla.org/network/ldap-service;1&quot;, &amp;rv);</span>
<a href="#l13.253"></a><span id="l13.253" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.254"></a><span id="l13.254" class="difflineminus">-</span>
<a href="#l13.255"></a><span id="l13.255" class="difflineminus">-  // Retrieve base DN and RDN attributes</span>
<a href="#l13.256"></a><span id="l13.256" class="difflineminus">-  nsAutoCString baseDN;</span>
<a href="#l13.257"></a><span id="l13.257" class="difflineminus">-  nsAutoCString oldRDN;</span>
<a href="#l13.258"></a><span id="l13.258" class="difflineminus">-  nsTArray&lt;nsCString&gt; rdnAttrs;</span>
<a href="#l13.259"></a><span id="l13.259" class="difflineminus">-  rv = ldapSvc-&gt;ParseDn(oldDN.get(), oldRDN, baseDN, rdnAttrs);</span>
<a href="#l13.260"></a><span id="l13.260" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.261"></a><span id="l13.261" class="difflineminus">-</span>
<a href="#l13.262"></a><span id="l13.262" class="difflineminus">-  // Calculate new RDN and check whether it has changed</span>
<a href="#l13.263"></a><span id="l13.263" class="difflineminus">-  nsAutoCString newRDN;</span>
<a href="#l13.264"></a><span id="l13.264" class="difflineminus">-  rv = card-&gt;BuildRdn(attrMap, rdnAttrs, newRDN);</span>
<a href="#l13.265"></a><span id="l13.265" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.266"></a><span id="l13.266" class="difflineminus">-</span>
<a href="#l13.267"></a><span id="l13.267" class="difflineminus">-  if (newRDN.Equals(oldRDN)) {</span>
<a href="#l13.268"></a><span id="l13.268" class="difflineminus">-    // Launch query</span>
<a href="#l13.269"></a><span id="l13.269" class="difflineminus">-    rv = DoModify(this, nsILDAPModification::MOD_REPLACE, oldDN, modArray,</span>
<a href="#l13.270"></a><span id="l13.270" class="difflineminus">-                  EmptyCString(), EmptyCString());</span>
<a href="#l13.271"></a><span id="l13.271" class="difflineminus">-  } else {</span>
<a href="#l13.272"></a><span id="l13.272" class="difflineminus">-    // Build and store the new DN</span>
<a href="#l13.273"></a><span id="l13.273" class="difflineminus">-    nsAutoCString newDN(newRDN);</span>
<a href="#l13.274"></a><span id="l13.274" class="difflineminus">-    newDN.Append(',');</span>
<a href="#l13.275"></a><span id="l13.275" class="difflineminus">-    newDN.Append(baseDN);</span>
<a href="#l13.276"></a><span id="l13.276" class="difflineminus">-</span>
<a href="#l13.277"></a><span id="l13.277" class="difflineminus">-    rv = card-&gt;SetDn(newDN);</span>
<a href="#l13.278"></a><span id="l13.278" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.279"></a><span id="l13.279" class="difflineminus">-</span>
<a href="#l13.280"></a><span id="l13.280" class="difflineminus">-    // Launch query</span>
<a href="#l13.281"></a><span id="l13.281" class="difflineminus">-    rv = DoModify(this, nsILDAPModification::MOD_REPLACE, oldDN, modArray,</span>
<a href="#l13.282"></a><span id="l13.282" class="difflineminus">-                  newRDN, baseDN);</span>
<a href="#l13.283"></a><span id="l13.283" class="difflineminus">-  }</span>
<a href="#l13.284"></a><span id="l13.284" class="difflineminus">-  return rv;</span>
<a href="#l13.285"></a><span id="l13.285" class="difflineplus">+  return NS_ERROR_UNEXPECTED;</span>
<a href="#l13.286"></a><span id="l13.286"> }</span>
<a href="#l13.287"></a><span id="l13.287"> </span>
<a href="#l13.288"></a><span id="l13.288"> NS_IMETHODIMP nsAbLDAPDirectory::GetRdnAttributes(nsACString &amp;aRdnAttributes) {</span>
<a href="#l13.289"></a><span id="l13.289">   return GetStringValue(&quot;rdnAttributes&quot;, NS_LITERAL_CSTRING(&quot;cn&quot;),</span>
<a href="#l13.290"></a><span id="l13.290">                         aRdnAttributes);</span>
<a href="#l13.291"></a><span id="l13.291"> }</span>
<a href="#l13.292"></a><span id="l13.292"> </span>
<a href="#l13.293"></a><span id="l13.293"> NS_IMETHODIMP nsAbLDAPDirectory::SetRdnAttributes(</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPDirectory.h</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPDirectory.h</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -3,26 +3,24 @@</span>
<a href="#l14.4"></a><span id="l14.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.5"></a><span id="l14.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.6"></a><span id="l14.6"> </span>
<a href="#l14.7"></a><span id="l14.7"> #ifndef nsAbLDAPDirectory_h__</span>
<a href="#l14.8"></a><span id="l14.8"> #define nsAbLDAPDirectory_h__</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l14.11"></a><span id="l14.11"> #include &quot;nsAbDirProperty.h&quot;</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-#include &quot;nsAbLDAPDirectoryModify.h&quot;</span>
<a href="#l14.13"></a><span id="l14.13"> #include &quot;nsIAbDirectoryQuery.h&quot;</span>
<a href="#l14.14"></a><span id="l14.14"> #include &quot;nsIAbDirSearchListener.h&quot;</span>
<a href="#l14.15"></a><span id="l14.15"> #include &quot;nsIAbLDAPDirectory.h&quot;</span>
<a href="#l14.16"></a><span id="l14.16"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l14.17"></a><span id="l14.17"> #include &quot;nsInterfaceHashtable.h&quot;</span>
<a href="#l14.18"></a><span id="l14.18"> #include &quot;mozilla/Mutex.h&quot;</span>
<a href="#l14.19"></a><span id="l14.19"> </span>
<a href="#l14.20"></a><span id="l14.20"> class nsAbLDAPDirectory : public nsAbDirProperty,  // nsIAbDirectory</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">-                          public nsAbLDAPDirectoryModify,</span>
<a href="#l14.22"></a><span id="l14.22">                           public nsIAbLDAPDirectory,</span>
<a href="#l14.23"></a><span id="l14.23">                           public nsIAbDirSearchListener {</span>
<a href="#l14.24"></a><span id="l14.24">  public:</span>
<a href="#l14.25"></a><span id="l14.25">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l14.26"></a><span id="l14.26"> </span>
<a href="#l14.27"></a><span id="l14.27">   nsAbLDAPDirectory();</span>
<a href="#l14.28"></a><span id="l14.28"> </span>
<a href="#l14.29"></a><span id="l14.29">   NS_IMETHOD Init(const char *aUri) override;</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineat">@@ -58,13 +56,11 @@ class nsAbLDAPDirectory : public nsAbDir</span>
<a href="#l14.31"></a><span id="l14.31">   bool mPerformingQuery;</span>
<a href="#l14.32"></a><span id="l14.32">   int32_t mContext;</span>
<a href="#l14.33"></a><span id="l14.33">   int32_t mMaxHits;</span>
<a href="#l14.34"></a><span id="l14.34"> </span>
<a href="#l14.35"></a><span id="l14.35">   nsInterfaceHashtable&lt;nsISupportsHashKey, nsIAbCard&gt; mCache;</span>
<a href="#l14.36"></a><span id="l14.36"> </span>
<a href="#l14.37"></a><span id="l14.37">   mozilla::Mutex mLock;</span>
<a href="#l14.38"></a><span id="l14.38">   nsCOMPtr&lt;nsIAbDirectoryQuery&gt; mDirectoryQuery;</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; mSearchServerControls;</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; mSearchClientControls;</span>
<a href="#l14.41"></a><span id="l14.41"> };</span>
<a href="#l14.42"></a><span id="l14.42"> </span>
<a href="#l14.43"></a><span id="l14.43"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">deleted file mode 100644</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPDirectoryModify.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineplus">+++ /dev/null</span>
<a href="#l15.4"></a><span id="l15.4" class="difflineat">@@ -1,332 +0,0 @@</span>
<a href="#l15.5"></a><span id="l15.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l15.6"></a><span id="l15.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.7"></a><span id="l15.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.8"></a><span id="l15.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineminus">-</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineminus">-#include &quot;nsAbLDAPDirectoryModify.h&quot;</span>
<a href="#l15.11"></a><span id="l15.11" class="difflineminus">-#include &quot;nsAbLDAPListenerBase.h&quot;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-#include &quot;nsILDAPMessage.h&quot;</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-#include &quot;nsILDAPConnection.h&quot;</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">-#include &quot;nsILDAPErrors.h&quot;</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineminus">-#include &quot;nsILDAPModification.h&quot;</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineminus">-#include &quot;nsIAbLDAPDirectory.h&quot;</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">-#include &quot;nsIMutableArray.h&quot;</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">-#include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineminus">-#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineminus">-</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineminus">-#include &lt;stdio.h&gt;</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineminus">-</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineminus">-using namespace mozilla;</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineminus">-</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineminus">-class nsAbModifyLDAPMessageListener : public nsAbLDAPListenerBase {</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineminus">- public:</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineminus">-  NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineminus">-</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineminus">-  nsAbModifyLDAPMessageListener(const int32_t type, const nsACString &amp;cardDN,</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineminus">-                                nsIArray *modArray, const nsACString &amp;newRDN,</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-                                const nsACString &amp;newBaseDN,</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineminus">-                                nsILDAPURL *directoryUrl,</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineminus">-                                nsILDAPConnection *connection,</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineminus">-                                nsIMutableArray *serverSearchControls,</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineminus">-                                nsIMutableArray *clientSearchControls,</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineminus">-                                const nsACString &amp;login,</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineminus">-                                const int32_t timeOut = 0);</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineminus">-  // nsILDAPMessageListener</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineminus">-  NS_IMETHOD OnLDAPMessage(nsILDAPMessage *aMessage) override;</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineminus">-</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineminus">- protected:</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineminus">-  virtual ~nsAbModifyLDAPMessageListener();</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineminus">-</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineminus">-  nsresult Cancel();</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineminus">-  virtual void InitFailed(bool aCancelled = false) override;</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineminus">-  virtual nsresult DoTask() override;</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineminus">-  nsresult DoMainTask();</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineminus">-  nsresult OnLDAPMessageModifyResult(nsILDAPMessage *aMessage);</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineminus">-  nsresult OnLDAPMessageRenameResult(nsILDAPMessage *aMessage);</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineminus">-</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineminus">-  int32_t mType;</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineminus">-  nsCString mCardDN;</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineminus">-  nsCOMPtr&lt;nsIArray&gt; mModification;</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineminus">-  nsCString mNewRDN;</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineminus">-  nsCString mNewBaseDN;</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineminus">-</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineminus">-  bool mFinished;</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineminus">-  bool mCanceled;</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineminus">-  bool mFlagRename;</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineminus">-</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineminus">-  nsCOMPtr&lt;nsILDAPOperation&gt; mModifyOperation;</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; mServerSearchControls;</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; mClientSearchControls;</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineminus">-};</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineminus">-</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineminus">-NS_IMPL_ISUPPORTS(nsAbModifyLDAPMessageListener, nsILDAPMessageListener)</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineminus">-</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineminus">-nsAbModifyLDAPMessageListener::nsAbModifyLDAPMessageListener(</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineminus">-    const int32_t type, const nsACString &amp;cardDN, nsIArray *modArray,</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineminus">-    const nsACString &amp;newRDN, const nsACString &amp;newBaseDN,</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineminus">-    nsILDAPURL *directoryUrl, nsILDAPConnection *connection,</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineminus">-    nsIMutableArray *serverSearchControls,</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineminus">-    nsIMutableArray *clientSearchControls, const nsACString &amp;login,</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineminus">-    const int32_t timeOut)</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineminus">-    : nsAbLDAPListenerBase(directoryUrl, connection, login, timeOut),</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineminus">-      mType(type),</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineminus">-      mCardDN(cardDN),</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineminus">-      mModification(modArray),</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineminus">-      mNewRDN(newRDN),</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineminus">-      mNewBaseDN(newBaseDN),</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineminus">-      mFinished(false),</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineminus">-      mCanceled(false),</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineminus">-      mFlagRename(false),</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineminus">-      mServerSearchControls(serverSearchControls),</span>
<a href="#l15.85"></a><span id="l15.85" class="difflineminus">-      mClientSearchControls(clientSearchControls) {</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineminus">-  if (mType == nsILDAPModification::MOD_REPLACE &amp;&amp; !mNewRDN.IsEmpty() &amp;&amp;</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineminus">-      !mNewBaseDN.IsEmpty())</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineminus">-    mFlagRename = true;</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineminus">-}</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineminus">-</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineminus">-nsAbModifyLDAPMessageListener::~nsAbModifyLDAPMessageListener() {}</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineminus">-</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineminus">-nsresult nsAbModifyLDAPMessageListener::Cancel() {</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineminus">-  nsresult rv = Initiate();</span>
<a href="#l15.95"></a><span id="l15.95" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineminus">-</span>
<a href="#l15.97"></a><span id="l15.97" class="difflineminus">-  MutexAutoLock lock(mLock);</span>
<a href="#l15.98"></a><span id="l15.98" class="difflineminus">-</span>
<a href="#l15.99"></a><span id="l15.99" class="difflineminus">-  if (mFinished || mCanceled) return NS_OK;</span>
<a href="#l15.100"></a><span id="l15.100" class="difflineminus">-</span>
<a href="#l15.101"></a><span id="l15.101" class="difflineminus">-  mCanceled = true;</span>
<a href="#l15.102"></a><span id="l15.102" class="difflineminus">-</span>
<a href="#l15.103"></a><span id="l15.103" class="difflineminus">-  return NS_OK;</span>
<a href="#l15.104"></a><span id="l15.104" class="difflineminus">-}</span>
<a href="#l15.105"></a><span id="l15.105" class="difflineminus">-</span>
<a href="#l15.106"></a><span id="l15.106" class="difflineminus">-NS_IMETHODIMP nsAbModifyLDAPMessageListener::OnLDAPMessage(</span>
<a href="#l15.107"></a><span id="l15.107" class="difflineminus">-    nsILDAPMessage *aMessage) {</span>
<a href="#l15.108"></a><span id="l15.108" class="difflineminus">-  nsresult rv = Initiate();</span>
<a href="#l15.109"></a><span id="l15.109" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.110"></a><span id="l15.110" class="difflineminus">-</span>
<a href="#l15.111"></a><span id="l15.111" class="difflineminus">-  int32_t messageType;</span>
<a href="#l15.112"></a><span id="l15.112" class="difflineminus">-  rv = aMessage-&gt;GetType(&amp;messageType);</span>
<a href="#l15.113"></a><span id="l15.113" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.114"></a><span id="l15.114" class="difflineminus">-</span>
<a href="#l15.115"></a><span id="l15.115" class="difflineminus">-  bool cancelOperation = false;</span>
<a href="#l15.116"></a><span id="l15.116" class="difflineminus">-</span>
<a href="#l15.117"></a><span id="l15.117" class="difflineminus">-  // Enter lock</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineminus">-  {</span>
<a href="#l15.119"></a><span id="l15.119" class="difflineminus">-    MutexAutoLock lock(mLock);</span>
<a href="#l15.120"></a><span id="l15.120" class="difflineminus">-</span>
<a href="#l15.121"></a><span id="l15.121" class="difflineminus">-    if (mFinished) return NS_OK;</span>
<a href="#l15.122"></a><span id="l15.122" class="difflineminus">-</span>
<a href="#l15.123"></a><span id="l15.123" class="difflineminus">-    // for these messages, no matter the outcome, we're done</span>
<a href="#l15.124"></a><span id="l15.124" class="difflineminus">-    if ((messageType == nsILDAPMessage::RES_ADD) ||</span>
<a href="#l15.125"></a><span id="l15.125" class="difflineminus">-        (messageType == nsILDAPMessage::RES_DELETE) ||</span>
<a href="#l15.126"></a><span id="l15.126" class="difflineminus">-        (messageType == nsILDAPMessage::RES_MODIFY))</span>
<a href="#l15.127"></a><span id="l15.127" class="difflineminus">-      mFinished = true;</span>
<a href="#l15.128"></a><span id="l15.128" class="difflineminus">-    else if (mCanceled) {</span>
<a href="#l15.129"></a><span id="l15.129" class="difflineminus">-      mFinished = true;</span>
<a href="#l15.130"></a><span id="l15.130" class="difflineminus">-      cancelOperation = true;</span>
<a href="#l15.131"></a><span id="l15.131" class="difflineminus">-    }</span>
<a href="#l15.132"></a><span id="l15.132" class="difflineminus">-  }</span>
<a href="#l15.133"></a><span id="l15.133" class="difflineminus">-  // Leave lock</span>
<a href="#l15.134"></a><span id="l15.134" class="difflineminus">-</span>
<a href="#l15.135"></a><span id="l15.135" class="difflineminus">-  //    nsCOMPtr&lt;nsIAbDirectoryQueryResult&gt; queryResult;</span>
<a href="#l15.136"></a><span id="l15.136" class="difflineminus">-  if (!cancelOperation) {</span>
<a href="#l15.137"></a><span id="l15.137" class="difflineminus">-    switch (messageType) {</span>
<a href="#l15.138"></a><span id="l15.138" class="difflineminus">-      case nsILDAPMessage::RES_BIND:</span>
<a href="#l15.139"></a><span id="l15.139" class="difflineminus">-        rv = OnLDAPMessageBind(aMessage);</span>
<a href="#l15.140"></a><span id="l15.140" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l15.141"></a><span id="l15.141" class="difflineminus">-          // We know the bind failed and hence the message has an error, so we</span>
<a href="#l15.142"></a><span id="l15.142" class="difflineminus">-          // can just call ModifyResult with the message and that'll sort it out</span>
<a href="#l15.143"></a><span id="l15.143" class="difflineminus">-          // for us.</span>
<a href="#l15.144"></a><span id="l15.144" class="difflineminus">-          rv = OnLDAPMessageModifyResult(aMessage);</span>
<a href="#l15.145"></a><span id="l15.145" class="difflineminus">-        break;</span>
<a href="#l15.146"></a><span id="l15.146" class="difflineminus">-      case nsILDAPMessage::RES_ADD:</span>
<a href="#l15.147"></a><span id="l15.147" class="difflineminus">-      case nsILDAPMessage::RES_MODIFY:</span>
<a href="#l15.148"></a><span id="l15.148" class="difflineminus">-      case nsILDAPMessage::RES_DELETE:</span>
<a href="#l15.149"></a><span id="l15.149" class="difflineminus">-        rv = OnLDAPMessageModifyResult(aMessage);</span>
<a href="#l15.150"></a><span id="l15.150" class="difflineminus">-        break;</span>
<a href="#l15.151"></a><span id="l15.151" class="difflineminus">-      case nsILDAPMessage::RES_MODDN:</span>
<a href="#l15.152"></a><span id="l15.152" class="difflineminus">-        mFlagRename = false;</span>
<a href="#l15.153"></a><span id="l15.153" class="difflineminus">-        rv = OnLDAPMessageRenameResult(aMessage);</span>
<a href="#l15.154"></a><span id="l15.154" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l15.155"></a><span id="l15.155" class="difflineminus">-          // Rename failed, so we stop here</span>
<a href="#l15.156"></a><span id="l15.156" class="difflineminus">-          mFinished = true;</span>
<a href="#l15.157"></a><span id="l15.157" class="difflineminus">-        break;</span>
<a href="#l15.158"></a><span id="l15.158" class="difflineminus">-      default:</span>
<a href="#l15.159"></a><span id="l15.159" class="difflineminus">-        break;</span>
<a href="#l15.160"></a><span id="l15.160" class="difflineminus">-    }</span>
<a href="#l15.161"></a><span id="l15.161" class="difflineminus">-  } else {</span>
<a href="#l15.162"></a><span id="l15.162" class="difflineminus">-    if (mModifyOperation) rv = mModifyOperation-&gt;AbandonExt();</span>
<a href="#l15.163"></a><span id="l15.163" class="difflineminus">-</span>
<a href="#l15.164"></a><span id="l15.164" class="difflineminus">-    // reset because we might re-use this listener...except don't do this</span>
<a href="#l15.165"></a><span id="l15.165" class="difflineminus">-    // until the search is done, so we'll ignore results from a previous</span>
<a href="#l15.166"></a><span id="l15.166" class="difflineminus">-    // search.</span>
<a href="#l15.167"></a><span id="l15.167" class="difflineminus">-    mCanceled = mFinished = false;</span>
<a href="#l15.168"></a><span id="l15.168" class="difflineminus">-  }</span>
<a href="#l15.169"></a><span id="l15.169" class="difflineminus">-</span>
<a href="#l15.170"></a><span id="l15.170" class="difflineminus">-  return rv;</span>
<a href="#l15.171"></a><span id="l15.171" class="difflineminus">-}</span>
<a href="#l15.172"></a><span id="l15.172" class="difflineminus">-</span>
<a href="#l15.173"></a><span id="l15.173" class="difflineminus">-void nsAbModifyLDAPMessageListener::InitFailed(bool aCancelled) {</span>
<a href="#l15.174"></a><span id="l15.174" class="difflineminus">-  // XXX Just cancel the operation for now</span>
<a href="#l15.175"></a><span id="l15.175" class="difflineminus">-  // we'll need to review this when we've got the proper listeners in place.</span>
<a href="#l15.176"></a><span id="l15.176" class="difflineminus">-  Cancel();</span>
<a href="#l15.177"></a><span id="l15.177" class="difflineminus">-}</span>
<a href="#l15.178"></a><span id="l15.178" class="difflineminus">-</span>
<a href="#l15.179"></a><span id="l15.179" class="difflineminus">-nsresult nsAbModifyLDAPMessageListener::DoTask() {</span>
<a href="#l15.180"></a><span id="l15.180" class="difflineminus">-  nsresult rv;</span>
<a href="#l15.181"></a><span id="l15.181" class="difflineminus">-  mCanceled = mFinished = false;</span>
<a href="#l15.182"></a><span id="l15.182" class="difflineminus">-</span>
<a href="#l15.183"></a><span id="l15.183" class="difflineminus">-  mModifyOperation = do_CreateInstance(NS_LDAPOPERATION_CONTRACTID, &amp;rv);</span>
<a href="#l15.184"></a><span id="l15.184" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.185"></a><span id="l15.185" class="difflineminus">-</span>
<a href="#l15.186"></a><span id="l15.186" class="difflineminus">-  rv = mModifyOperation-&gt;Init(mConnection, this, nullptr);</span>
<a href="#l15.187"></a><span id="l15.187" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.188"></a><span id="l15.188" class="difflineminus">-</span>
<a href="#l15.189"></a><span id="l15.189" class="difflineminus">-  // XXX do we need the search controls?</span>
<a href="#l15.190"></a><span id="l15.190" class="difflineminus">-  rv = mModifyOperation-&gt;SetServerControls(mServerSearchControls);</span>
<a href="#l15.191"></a><span id="l15.191" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.192"></a><span id="l15.192" class="difflineminus">-</span>
<a href="#l15.193"></a><span id="l15.193" class="difflineminus">-  rv = mModifyOperation-&gt;SetClientControls(mClientSearchControls);</span>
<a href="#l15.194"></a><span id="l15.194" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.195"></a><span id="l15.195" class="difflineminus">-</span>
<a href="#l15.196"></a><span id="l15.196" class="difflineminus">-  if (mFlagRename)</span>
<a href="#l15.197"></a><span id="l15.197" class="difflineminus">-    return mModifyOperation-&gt;Rename(mCardDN, mNewRDN, mNewBaseDN, true);</span>
<a href="#l15.198"></a><span id="l15.198" class="difflineminus">-</span>
<a href="#l15.199"></a><span id="l15.199" class="difflineminus">-  switch (mType) {</span>
<a href="#l15.200"></a><span id="l15.200" class="difflineminus">-    case nsILDAPModification::MOD_ADD:</span>
<a href="#l15.201"></a><span id="l15.201" class="difflineminus">-      return mModifyOperation-&gt;AddExt(mCardDN, mModification);</span>
<a href="#l15.202"></a><span id="l15.202" class="difflineminus">-    case nsILDAPModification::MOD_DELETE:</span>
<a href="#l15.203"></a><span id="l15.203" class="difflineminus">-      return mModifyOperation-&gt;DeleteExt(mCardDN);</span>
<a href="#l15.204"></a><span id="l15.204" class="difflineminus">-    case nsILDAPModification::MOD_REPLACE:</span>
<a href="#l15.205"></a><span id="l15.205" class="difflineminus">-      return mModifyOperation-&gt;ModifyExt(mCardDN, mModification);</span>
<a href="#l15.206"></a><span id="l15.206" class="difflineminus">-    default:</span>
<a href="#l15.207"></a><span id="l15.207" class="difflineminus">-      NS_ERROR(&quot;Bad LDAP modification requested&quot;);</span>
<a href="#l15.208"></a><span id="l15.208" class="difflineminus">-      return NS_ERROR_UNEXPECTED;</span>
<a href="#l15.209"></a><span id="l15.209" class="difflineminus">-  }</span>
<a href="#l15.210"></a><span id="l15.210" class="difflineminus">-}</span>
<a href="#l15.211"></a><span id="l15.211" class="difflineminus">-</span>
<a href="#l15.212"></a><span id="l15.212" class="difflineminus">-nsresult nsAbModifyLDAPMessageListener::OnLDAPMessageModifyResult(</span>
<a href="#l15.213"></a><span id="l15.213" class="difflineminus">-    nsILDAPMessage *aMessage) {</span>
<a href="#l15.214"></a><span id="l15.214" class="difflineminus">-  nsresult rv;</span>
<a href="#l15.215"></a><span id="l15.215" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l15.216"></a><span id="l15.216" class="difflineminus">-</span>
<a href="#l15.217"></a><span id="l15.217" class="difflineminus">-  int32_t errCode;</span>
<a href="#l15.218"></a><span id="l15.218" class="difflineminus">-  rv = aMessage-&gt;GetErrorCode(&amp;errCode);</span>
<a href="#l15.219"></a><span id="l15.219" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.220"></a><span id="l15.220" class="difflineminus">-</span>
<a href="#l15.221"></a><span id="l15.221" class="difflineminus">-  if (errCode != nsILDAPErrors::SUCCESS) {</span>
<a href="#l15.222"></a><span id="l15.222" class="difflineminus">-    nsAutoCString errMessage;</span>
<a href="#l15.223"></a><span id="l15.223" class="difflineminus">-    rv = aMessage-&gt;GetErrorMessage(errMessage);</span>
<a href="#l15.224"></a><span id="l15.224" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.225"></a><span id="l15.225" class="difflineminus">-</span>
<a href="#l15.226"></a><span id="l15.226" class="difflineminus">-    printf(&quot;LDAP modification failed (code: %i, message: %s)\n&quot;, errCode,</span>
<a href="#l15.227"></a><span id="l15.227" class="difflineminus">-           errMessage.get());</span>
<a href="#l15.228"></a><span id="l15.228" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l15.229"></a><span id="l15.229" class="difflineminus">-  }</span>
<a href="#l15.230"></a><span id="l15.230" class="difflineminus">-</span>
<a href="#l15.231"></a><span id="l15.231" class="difflineminus">-  printf(&quot;LDAP modification succeeded\n&quot;);</span>
<a href="#l15.232"></a><span id="l15.232" class="difflineminus">-  return NS_OK;</span>
<a href="#l15.233"></a><span id="l15.233" class="difflineminus">-}</span>
<a href="#l15.234"></a><span id="l15.234" class="difflineminus">-</span>
<a href="#l15.235"></a><span id="l15.235" class="difflineminus">-nsresult nsAbModifyLDAPMessageListener::OnLDAPMessageRenameResult(</span>
<a href="#l15.236"></a><span id="l15.236" class="difflineminus">-    nsILDAPMessage *aMessage) {</span>
<a href="#l15.237"></a><span id="l15.237" class="difflineminus">-  nsresult rv;</span>
<a href="#l15.238"></a><span id="l15.238" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l15.239"></a><span id="l15.239" class="difflineminus">-</span>
<a href="#l15.240"></a><span id="l15.240" class="difflineminus">-  int32_t errCode;</span>
<a href="#l15.241"></a><span id="l15.241" class="difflineminus">-  rv = aMessage-&gt;GetErrorCode(&amp;errCode);</span>
<a href="#l15.242"></a><span id="l15.242" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.243"></a><span id="l15.243" class="difflineminus">-</span>
<a href="#l15.244"></a><span id="l15.244" class="difflineminus">-  if (errCode != nsILDAPErrors::SUCCESS) {</span>
<a href="#l15.245"></a><span id="l15.245" class="difflineminus">-    nsAutoCString errMessage;</span>
<a href="#l15.246"></a><span id="l15.246" class="difflineminus">-    rv = aMessage-&gt;GetErrorMessage(errMessage);</span>
<a href="#l15.247"></a><span id="l15.247" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.248"></a><span id="l15.248" class="difflineminus">-</span>
<a href="#l15.249"></a><span id="l15.249" class="difflineminus">-    printf(&quot;LDAP rename failed (code: %i, message: %s)\n&quot;, errCode,</span>
<a href="#l15.250"></a><span id="l15.250" class="difflineminus">-           errMessage.get());</span>
<a href="#l15.251"></a><span id="l15.251" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l15.252"></a><span id="l15.252" class="difflineminus">-  }</span>
<a href="#l15.253"></a><span id="l15.253" class="difflineminus">-</span>
<a href="#l15.254"></a><span id="l15.254" class="difflineminus">-  // Rename succeeded, now update the card DN and</span>
<a href="#l15.255"></a><span id="l15.255" class="difflineminus">-  // process the main task</span>
<a href="#l15.256"></a><span id="l15.256" class="difflineminus">-  mCardDN.Assign(mNewRDN);</span>
<a href="#l15.257"></a><span id="l15.257" class="difflineminus">-  mCardDN.Append(',');</span>
<a href="#l15.258"></a><span id="l15.258" class="difflineminus">-  mCardDN.Append(mNewBaseDN);</span>
<a href="#l15.259"></a><span id="l15.259" class="difflineminus">-</span>
<a href="#l15.260"></a><span id="l15.260" class="difflineminus">-  printf(&quot;LDAP rename succeeded\n&quot;);</span>
<a href="#l15.261"></a><span id="l15.261" class="difflineminus">-  return DoTask();</span>
<a href="#l15.262"></a><span id="l15.262" class="difflineminus">-}</span>
<a href="#l15.263"></a><span id="l15.263" class="difflineminus">-</span>
<a href="#l15.264"></a><span id="l15.264" class="difflineminus">-nsAbLDAPDirectoryModify::nsAbLDAPDirectoryModify() {}</span>
<a href="#l15.265"></a><span id="l15.265" class="difflineminus">-</span>
<a href="#l15.266"></a><span id="l15.266" class="difflineminus">-nsAbLDAPDirectoryModify::~nsAbLDAPDirectoryModify() {}</span>
<a href="#l15.267"></a><span id="l15.267" class="difflineminus">-</span>
<a href="#l15.268"></a><span id="l15.268" class="difflineminus">-nsresult nsAbLDAPDirectoryModify::DoModify(nsIAbLDAPDirectory *directory,</span>
<a href="#l15.269"></a><span id="l15.269" class="difflineminus">-                                           const int32_t &amp;updateType,</span>
<a href="#l15.270"></a><span id="l15.270" class="difflineminus">-                                           const nsACString &amp;cardDN,</span>
<a href="#l15.271"></a><span id="l15.271" class="difflineminus">-                                           nsIArray *modArray,</span>
<a href="#l15.272"></a><span id="l15.272" class="difflineminus">-                                           const nsACString &amp;newRDN,</span>
<a href="#l15.273"></a><span id="l15.273" class="difflineminus">-                                           const nsACString &amp;newBaseDN) {</span>
<a href="#l15.274"></a><span id="l15.274" class="difflineminus">-  NS_ENSURE_ARG_POINTER(directory);</span>
<a href="#l15.275"></a><span id="l15.275" class="difflineminus">-  // modArray may be null in the delete operation case.</span>
<a href="#l15.276"></a><span id="l15.276" class="difflineminus">-  if (!modArray &amp;&amp; (updateType == nsILDAPModification::MOD_ADD ||</span>
<a href="#l15.277"></a><span id="l15.277" class="difflineminus">-                    updateType == nsILDAPModification::MOD_REPLACE))</span>
<a href="#l15.278"></a><span id="l15.278" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l15.279"></a><span id="l15.279" class="difflineminus">-</span>
<a href="#l15.280"></a><span id="l15.280" class="difflineminus">-  nsresult rv;</span>
<a href="#l15.281"></a><span id="l15.281" class="difflineminus">-</span>
<a href="#l15.282"></a><span id="l15.282" class="difflineminus">-  // it's an error if we don't have a dn</span>
<a href="#l15.283"></a><span id="l15.283" class="difflineminus">-  if (cardDN.IsEmpty()) return NS_ERROR_INVALID_ARG;</span>
<a href="#l15.284"></a><span id="l15.284" class="difflineminus">-</span>
<a href="#l15.285"></a><span id="l15.285" class="difflineminus">-  nsCOMPtr&lt;nsILDAPURL&gt; currentUrl;</span>
<a href="#l15.286"></a><span id="l15.286" class="difflineminus">-  rv = directory-&gt;GetLDAPURL(getter_AddRefs(currentUrl));</span>
<a href="#l15.287"></a><span id="l15.287" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.288"></a><span id="l15.288" class="difflineminus">-</span>
<a href="#l15.289"></a><span id="l15.289" class="difflineminus">-  // Get the ldap connection</span>
<a href="#l15.290"></a><span id="l15.290" class="difflineminus">-  nsCOMPtr&lt;nsILDAPConnection&gt; ldapConnection =</span>
<a href="#l15.291"></a><span id="l15.291" class="difflineminus">-      do_CreateInstance(NS_LDAPCONNECTION_CONTRACTID, &amp;rv);</span>
<a href="#l15.292"></a><span id="l15.292" class="difflineminus">-</span>
<a href="#l15.293"></a><span id="l15.293" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; serverSearchControls;</span>
<a href="#l15.294"></a><span id="l15.294" class="difflineminus">-  rv = directory-&gt;GetSearchServerControls(getter_AddRefs(serverSearchControls));</span>
<a href="#l15.295"></a><span id="l15.295" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.296"></a><span id="l15.296" class="difflineminus">-</span>
<a href="#l15.297"></a><span id="l15.297" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; clientSearchControls;</span>
<a href="#l15.298"></a><span id="l15.298" class="difflineminus">-  rv = directory-&gt;GetSearchClientControls(getter_AddRefs(clientSearchControls));</span>
<a href="#l15.299"></a><span id="l15.299" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.300"></a><span id="l15.300" class="difflineminus">-</span>
<a href="#l15.301"></a><span id="l15.301" class="difflineminus">-  /*</span>
<a href="#l15.302"></a><span id="l15.302" class="difflineminus">-  // XXX we need to fix how this all works - specifically, see the first patch</span>
<a href="#l15.303"></a><span id="l15.303" class="difflineminus">-  // on bug 124553 for how the query equivalent did this</span>
<a href="#l15.304"></a><span id="l15.304" class="difflineminus">-  // too soon? Do we need a new listener?</span>
<a href="#l15.305"></a><span id="l15.305" class="difflineminus">-  if (alreadyInitialized)</span>
<a href="#l15.306"></a><span id="l15.306" class="difflineminus">-  {</span>
<a href="#l15.307"></a><span id="l15.307" class="difflineminus">-    nsAbQueryLDAPMessageListener *msgListener =</span>
<a href="#l15.308"></a><span id="l15.308" class="difflineminus">-      NS_STATIC_CAST(nsAbQueryLDAPMessageListener *,</span>
<a href="#l15.309"></a><span id="l15.309" class="difflineminus">-                     NS_STATIC_CAST(nsILDAPMessageListener *, mListener.get()));</span>
<a href="#l15.310"></a><span id="l15.310" class="difflineminus">-    if (msgListener)</span>
<a href="#l15.311"></a><span id="l15.311" class="difflineminus">-      {</span>
<a href="#l15.312"></a><span id="l15.312" class="difflineminus">-        msgListener-&gt;mUrl = url;</span>
<a href="#l15.313"></a><span id="l15.313" class="difflineminus">-        return msgListener-&gt;DoSearch();</span>
<a href="#l15.314"></a><span id="l15.314" class="difflineminus">-      }</span>
<a href="#l15.315"></a><span id="l15.315" class="difflineminus">-  }*/</span>
<a href="#l15.316"></a><span id="l15.316" class="difflineminus">-</span>
<a href="#l15.317"></a><span id="l15.317" class="difflineminus">-  nsCString login;</span>
<a href="#l15.318"></a><span id="l15.318" class="difflineminus">-  rv = directory-&gt;GetAuthDn(login);</span>
<a href="#l15.319"></a><span id="l15.319" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.320"></a><span id="l15.320" class="difflineminus">-</span>
<a href="#l15.321"></a><span id="l15.321" class="difflineminus">-  uint32_t protocolVersion;</span>
<a href="#l15.322"></a><span id="l15.322" class="difflineminus">-  rv = directory-&gt;GetProtocolVersion(&amp;protocolVersion);</span>
<a href="#l15.323"></a><span id="l15.323" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.324"></a><span id="l15.324" class="difflineminus">-</span>
<a href="#l15.325"></a><span id="l15.325" class="difflineminus">-  // Initiate LDAP message listener</span>
<a href="#l15.326"></a><span id="l15.326" class="difflineminus">-  nsAbModifyLDAPMessageListener *_messageListener =</span>
<a href="#l15.327"></a><span id="l15.327" class="difflineminus">-      new nsAbModifyLDAPMessageListener(</span>
<a href="#l15.328"></a><span id="l15.328" class="difflineminus">-          updateType, cardDN, modArray, newRDN, newBaseDN, currentUrl,</span>
<a href="#l15.329"></a><span id="l15.329" class="difflineminus">-          ldapConnection, serverSearchControls, clientSearchControls, login, 0);</span>
<a href="#l15.330"></a><span id="l15.330" class="difflineminus">-  if (_messageListener == NULL) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l15.331"></a><span id="l15.331" class="difflineminus">-</span>
<a href="#l15.332"></a><span id="l15.332" class="difflineminus">-  // Now lets initialize the LDAP connection properly. We'll kick</span>
<a href="#l15.333"></a><span id="l15.333" class="difflineminus">-  // off the bind operation in the callback function, |OnLDAPInit()|.</span>
<a href="#l15.334"></a><span id="l15.334" class="difflineminus">-  return ldapConnection-&gt;Init(currentUrl, login, _messageListener, nullptr,</span>
<a href="#l15.335"></a><span id="l15.335" class="difflineminus">-                              protocolVersion);</span>
<a href="#l15.336"></a><span id="l15.336" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">deleted file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPDirectoryModify.h</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineplus">+++ /dev/null</span>
<a href="#l16.4"></a><span id="l16.4" class="difflineat">@@ -1,23 +0,0 @@</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineminus">-</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineminus">-#ifndef nsAbLDAPDirectoryModify_h__</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineminus">-#define nsAbLDAPDirectoryModify_h__</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-#include &quot;nsIAbLDAPDirectory.h&quot;</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-#include &quot;nsIArray.h&quot;</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineminus">-</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineminus">-class nsAbLDAPDirectoryModify {</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineminus">- public:</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineminus">-  nsAbLDAPDirectoryModify();</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineminus">-  virtual ~nsAbLDAPDirectoryModify();</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineminus">-</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineminus">- protected:</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineminus">-  nsresult DoModify(nsIAbLDAPDirectory *directory, const int32_t &amp;aUpdateType,</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineminus">-                    const nsACString &amp;aCardDN, nsIArray *modArray,</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineminus">-                    const nsACString &amp;aNewRDN, const nsACString &amp;aNewBaseDN);</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineminus">-};</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineminus">-</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineminus">-#endif  // nsAbLDAPDirectoryModify_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -4,17 +4,16 @@</span>
<a href="#l17.4"></a><span id="l17.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l17.5"></a><span id="l17.5"> </span>
<a href="#l17.6"></a><span id="l17.6"> #include &quot;nsIAbCard.h&quot;</span>
<a href="#l17.7"></a><span id="l17.7"> #include &quot;nsAbLDAPDirectoryQuery.h&quot;</span>
<a href="#l17.8"></a><span id="l17.8"> #include &quot;nsAbBoolExprToLDAPFilter.h&quot;</span>
<a href="#l17.9"></a><span id="l17.9"> #include &quot;nsILDAPMessage.h&quot;</span>
<a href="#l17.10"></a><span id="l17.10"> #include &quot;nsILDAPErrors.h&quot;</span>
<a href="#l17.11"></a><span id="l17.11"> #include &quot;nsIAbLDAPAttributeMap.h&quot;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-#include &quot;nsIAbLDAPCard.h&quot;</span>
<a href="#l17.13"></a><span id="l17.13"> #include &quot;nsAbUtils.h&quot;</span>
<a href="#l17.14"></a><span id="l17.14"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l17.15"></a><span id="l17.15"> #include &quot;nsString.h&quot;</span>
<a href="#l17.16"></a><span id="l17.16"> #include &quot;prprf.h&quot;</span>
<a href="#l17.17"></a><span id="l17.17"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l17.18"></a><span id="l17.18"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l17.19"></a><span id="l17.19"> #include &quot;nsCategoryManagerUtils.h&quot;</span>
<a href="#l17.20"></a><span id="l17.20"> #include &quot;nsAbLDAPDirectory.h&quot;</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineat">@@ -34,19 +33,17 @@ class nsAbQueryLDAPMessageListener : pub</span>
<a href="#l17.22"></a><span id="l17.22">   // Note that the directoryUrl is the details of the ldap directory</span>
<a href="#l17.23"></a><span id="l17.23">   // without any search params or return attributes specified. The searchUrl</span>
<a href="#l17.24"></a><span id="l17.24">   // therefore has the search params and return attributes specified.</span>
<a href="#l17.25"></a><span id="l17.25">   //  nsAbQueryLDAPMessageListener(nsIAbDirectoryQuery* directoryQuery,</span>
<a href="#l17.26"></a><span id="l17.26">   nsAbQueryLDAPMessageListener(</span>
<a href="#l17.27"></a><span id="l17.27">       nsIAbDirectoryQueryResultListener *resultListener,</span>
<a href="#l17.28"></a><span id="l17.28">       nsILDAPURL *directoryUrl, nsILDAPURL *searchUrl,</span>
<a href="#l17.29"></a><span id="l17.29">       nsILDAPConnection *connection,</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineminus">-      nsIAbDirectoryQueryArguments *queryArguments,</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">-      nsIMutableArray *serverSearchControls,</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineminus">-      nsIMutableArray *clientSearchControls, const nsACString &amp;login,</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+      nsIAbDirectoryQueryArguments *queryArguments, const nsACString &amp;login,</span>
<a href="#l17.34"></a><span id="l17.34">       const nsACString &amp;mechanism, const int32_t resultLimit = -1,</span>
<a href="#l17.35"></a><span id="l17.35">       const int32_t timeOut = 0);</span>
<a href="#l17.36"></a><span id="l17.36"> </span>
<a href="#l17.37"></a><span id="l17.37">   // nsILDAPMessageListener</span>
<a href="#l17.38"></a><span id="l17.38">   NS_IMETHOD OnLDAPMessage(nsILDAPMessage *aMessage) override;</span>
<a href="#l17.39"></a><span id="l17.39"> </span>
<a href="#l17.40"></a><span id="l17.40">  protected:</span>
<a href="#l17.41"></a><span id="l17.41">   virtual ~nsAbQueryLDAPMessageListener();</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineat">@@ -62,40 +59,33 @@ class nsAbQueryLDAPMessageListener : pub</span>
<a href="#l17.43"></a><span id="l17.43">   nsCOMPtr&lt;nsILDAPURL&gt; mSearchUrl;</span>
<a href="#l17.44"></a><span id="l17.44">   nsIAbDirectoryQueryResultListener *mResultListener;</span>
<a href="#l17.45"></a><span id="l17.45">   int32_t mContextID;</span>
<a href="#l17.46"></a><span id="l17.46">   nsCOMPtr&lt;nsIAbDirectoryQueryArguments&gt; mQueryArguments;</span>
<a href="#l17.47"></a><span id="l17.47">   int32_t mResultLimit;</span>
<a href="#l17.48"></a><span id="l17.48"> </span>
<a href="#l17.49"></a><span id="l17.49">   bool mFinished;</span>
<a href="#l17.50"></a><span id="l17.50">   bool mCanceled;</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineminus">-</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; mServerSearchControls;</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; mClientSearchControls;</span>
<a href="#l17.54"></a><span id="l17.54"> };</span>
<a href="#l17.55"></a><span id="l17.55"> </span>
<a href="#l17.56"></a><span id="l17.56"> NS_IMPL_ISUPPORTS(nsAbQueryLDAPMessageListener, nsILDAPMessageListener)</span>
<a href="#l17.57"></a><span id="l17.57"> </span>
<a href="#l17.58"></a><span id="l17.58"> nsAbQueryLDAPMessageListener::nsAbQueryLDAPMessageListener(</span>
<a href="#l17.59"></a><span id="l17.59">     nsIAbDirectoryQueryResultListener *resultListener, nsILDAPURL *directoryUrl,</span>
<a href="#l17.60"></a><span id="l17.60">     nsILDAPURL *searchUrl, nsILDAPConnection *connection,</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineminus">-    nsIAbDirectoryQueryArguments *queryArguments,</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineminus">-    nsIMutableArray *serverSearchControls,</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineminus">-    nsIMutableArray *clientSearchControls, const nsACString &amp;login,</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineplus">+    nsIAbDirectoryQueryArguments *queryArguments, const nsACString &amp;login,</span>
<a href="#l17.65"></a><span id="l17.65">     const nsACString &amp;mechanism, const int32_t resultLimit,</span>
<a href="#l17.66"></a><span id="l17.66">     const int32_t timeOut)</span>
<a href="#l17.67"></a><span id="l17.67">     : nsAbLDAPListenerBase(directoryUrl, connection, login, timeOut),</span>
<a href="#l17.68"></a><span id="l17.68">       mSearchUrl(searchUrl),</span>
<a href="#l17.69"></a><span id="l17.69">       mResultListener(resultListener),</span>
<a href="#l17.70"></a><span id="l17.70">       mQueryArguments(queryArguments),</span>
<a href="#l17.71"></a><span id="l17.71">       mResultLimit(resultLimit),</span>
<a href="#l17.72"></a><span id="l17.72">       mFinished(false),</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineminus">-      mCanceled(false),</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineminus">-      mServerSearchControls(serverSearchControls),</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineminus">-      mClientSearchControls(clientSearchControls) {</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineplus">+      mCanceled(false) {</span>
<a href="#l17.77"></a><span id="l17.77">   mSaslMechanism.Assign(mechanism);</span>
<a href="#l17.78"></a><span id="l17.78"> }</span>
<a href="#l17.79"></a><span id="l17.79"> </span>
<a href="#l17.80"></a><span id="l17.80"> nsAbQueryLDAPMessageListener::~nsAbQueryLDAPMessageListener() {}</span>
<a href="#l17.81"></a><span id="l17.81"> </span>
<a href="#l17.82"></a><span id="l17.82"> nsresult nsAbQueryLDAPMessageListener::Cancel() {</span>
<a href="#l17.83"></a><span id="l17.83">   nsresult rv = Initiate();</span>
<a href="#l17.84"></a><span id="l17.84">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.85"></a><span id="l17.85" class="difflineat">@@ -206,22 +196,16 @@ nsresult nsAbQueryLDAPMessageListener::D</span>
<a href="#l17.86"></a><span id="l17.86">   nsAutoCString filter;</span>
<a href="#l17.87"></a><span id="l17.87">   rv = mSearchUrl-&gt;GetFilter(filter);</span>
<a href="#l17.88"></a><span id="l17.88">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.89"></a><span id="l17.89"> </span>
<a href="#l17.90"></a><span id="l17.90">   nsAutoCString attributes;</span>
<a href="#l17.91"></a><span id="l17.91">   rv = mSearchUrl-&gt;GetAttributes(attributes);</span>
<a href="#l17.92"></a><span id="l17.92">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.93"></a><span id="l17.93"> </span>
<a href="#l17.94"></a><span id="l17.94" class="difflineminus">-  rv = mOperation-&gt;SetServerControls(mServerSearchControls);</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineminus">-</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineminus">-  rv = mOperation-&gt;SetClientControls(mClientSearchControls);</span>
<a href="#l17.98"></a><span id="l17.98" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.99"></a><span id="l17.99" class="difflineminus">-</span>
<a href="#l17.100"></a><span id="l17.100">   return mOperation-&gt;SearchExt(dn, scope, filter, attributes, mTimeOut,</span>
<a href="#l17.101"></a><span id="l17.101">                                mResultLimit);</span>
<a href="#l17.102"></a><span id="l17.102"> }</span>
<a href="#l17.103"></a><span id="l17.103"> </span>
<a href="#l17.104"></a><span id="l17.104"> void nsAbQueryLDAPMessageListener::InitFailed(bool aCancelled) {</span>
<a href="#l17.105"></a><span id="l17.105">   if (!mResultListener) return;</span>
<a href="#l17.106"></a><span id="l17.106"> </span>
<a href="#l17.107"></a><span id="l17.107">   // In the !aCancelled case we know there was an error, but we won't be</span>
<a href="#l17.108"></a><span id="l17.108" class="difflineat">@@ -241,28 +225,23 @@ nsresult nsAbQueryLDAPMessageListener::O</span>
<a href="#l17.109"></a><span id="l17.109">   // the map for translating between LDAP attrs &lt;-&gt; addrbook fields</span>
<a href="#l17.110"></a><span id="l17.110">   nsCOMPtr&lt;nsISupports&gt; iSupportsMap;</span>
<a href="#l17.111"></a><span id="l17.111">   rv = mQueryArguments-&gt;GetTypeSpecificArg(getter_AddRefs(iSupportsMap));</span>
<a href="#l17.112"></a><span id="l17.112">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.113"></a><span id="l17.113"> </span>
<a href="#l17.114"></a><span id="l17.114">   nsCOMPtr&lt;nsIAbLDAPAttributeMap&gt; map = do_QueryInterface(iSupportsMap, &amp;rv);</span>
<a href="#l17.115"></a><span id="l17.115">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.116"></a><span id="l17.116"> </span>
<a href="#l17.117"></a><span id="l17.117" class="difflineminus">-  nsCOMPtr&lt;nsIAbCard&gt; card = do_CreateInstance(NS_ABLDAPCARD_CONTRACTID, &amp;rv);</span>
<a href="#l17.118"></a><span id="l17.118" class="difflineplus">+  nsCOMPtr&lt;nsIAbCard&gt; card =</span>
<a href="#l17.119"></a><span id="l17.119" class="difflineplus">+      do_CreateInstance(NS_ABCARDPROPERTY_CONTRACTID, &amp;rv);</span>
<a href="#l17.120"></a><span id="l17.120">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.121"></a><span id="l17.121"> </span>
<a href="#l17.122"></a><span id="l17.122">   rv = map-&gt;SetCardPropertiesFromLDAPMessage(aMessage, card);</span>
<a href="#l17.123"></a><span id="l17.123">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.124"></a><span id="l17.124"> </span>
<a href="#l17.125"></a><span id="l17.125" class="difflineminus">-  nsCOMPtr&lt;nsIAbLDAPCard&gt; ldapCard = do_QueryInterface(card, &amp;rv);</span>
<a href="#l17.126"></a><span id="l17.126" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.127"></a><span id="l17.127" class="difflineminus">-</span>
<a href="#l17.128"></a><span id="l17.128" class="difflineminus">-  rv = ldapCard-&gt;SetMetaProperties(aMessage);</span>
<a href="#l17.129"></a><span id="l17.129" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.130"></a><span id="l17.130" class="difflineminus">-</span>
<a href="#l17.131"></a><span id="l17.131">   return mResultListener-&gt;OnQueryFoundCard(card);</span>
<a href="#l17.132"></a><span id="l17.132"> }</span>
<a href="#l17.133"></a><span id="l17.133"> </span>
<a href="#l17.134"></a><span id="l17.134"> nsresult nsAbQueryLDAPMessageListener::OnLDAPMessageSearchResult(</span>
<a href="#l17.135"></a><span id="l17.135">     nsILDAPMessage *aMessage) {</span>
<a href="#l17.136"></a><span id="l17.136">   int32_t errorCode;</span>
<a href="#l17.137"></a><span id="l17.137">   nsresult rv = aMessage-&gt;GetErrorCode(&amp;errorCode);</span>
<a href="#l17.138"></a><span id="l17.138">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.139"></a><span id="l17.139" class="difflineat">@@ -480,42 +459,30 @@ NS_IMETHODIMP nsAbLDAPDirectoryQuery::Do</span>
<a href="#l17.140"></a><span id="l17.140">       msgListener-&gt;mDirectoryUrl = mDirectoryUrl;</span>
<a href="#l17.141"></a><span id="l17.141">       msgListener-&gt;mSearchUrl = url;</span>
<a href="#l17.142"></a><span id="l17.142">       // Also ensure we set the correct result limit</span>
<a href="#l17.143"></a><span id="l17.143">       msgListener-&gt;mResultLimit = aResultLimit;</span>
<a href="#l17.144"></a><span id="l17.144">       return msgListener-&gt;DoTask();</span>
<a href="#l17.145"></a><span id="l17.145">     }</span>
<a href="#l17.146"></a><span id="l17.146">   }</span>
<a href="#l17.147"></a><span id="l17.147"> </span>
<a href="#l17.148"></a><span id="l17.148" class="difflineminus">-  nsCOMPtr&lt;nsIAbLDAPDirectory&gt; abLDAPDir = do_QueryInterface(aDirectory, &amp;rv);</span>
<a href="#l17.149"></a><span id="l17.149" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.150"></a><span id="l17.150" class="difflineminus">-</span>
<a href="#l17.151"></a><span id="l17.151" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; serverSearchControls;</span>
<a href="#l17.152"></a><span id="l17.152" class="difflineminus">-  rv = abLDAPDir-&gt;GetSearchServerControls(getter_AddRefs(serverSearchControls));</span>
<a href="#l17.153"></a><span id="l17.153" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.154"></a><span id="l17.154" class="difflineminus">-</span>
<a href="#l17.155"></a><span id="l17.155" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; clientSearchControls;</span>
<a href="#l17.156"></a><span id="l17.156" class="difflineminus">-  rv = abLDAPDir-&gt;GetSearchClientControls(getter_AddRefs(clientSearchControls));</span>
<a href="#l17.157"></a><span id="l17.157" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.158"></a><span id="l17.158" class="difflineminus">-</span>
<a href="#l17.159"></a><span id="l17.159">   // Create the new connection (which cause the old one to be dropped if</span>
<a href="#l17.160"></a><span id="l17.160">   // necessary)</span>
<a href="#l17.161"></a><span id="l17.161">   mConnection = do_CreateInstance(NS_LDAPCONNECTION_CONTRACTID, &amp;rv);</span>
<a href="#l17.162"></a><span id="l17.162">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.163"></a><span id="l17.163"> </span>
<a href="#l17.164"></a><span id="l17.164">   nsCOMPtr&lt;nsIAbDirectoryQueryResultListener&gt; resultListener =</span>
<a href="#l17.165"></a><span id="l17.165">       do_QueryInterface((nsIAbDirectoryQuery *)this, &amp;rv);</span>
<a href="#l17.166"></a><span id="l17.166">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.167"></a><span id="l17.167"> </span>
<a href="#l17.168"></a><span id="l17.168">   // Initiate LDAP message listener</span>
<a href="#l17.169"></a><span id="l17.169">   nsAbQueryLDAPMessageListener *_messageListener =</span>
<a href="#l17.170"></a><span id="l17.170">       new nsAbQueryLDAPMessageListener(</span>
<a href="#l17.171"></a><span id="l17.171">           resultListener, mDirectoryUrl, url, mConnection, aArguments,</span>
<a href="#l17.172"></a><span id="l17.172" class="difflineminus">-          serverSearchControls, clientSearchControls, mCurrentLogin,</span>
<a href="#l17.173"></a><span id="l17.173" class="difflineminus">-          mCurrentMechanism, aResultLimit, aTimeOut);</span>
<a href="#l17.174"></a><span id="l17.174" class="difflineplus">+          mCurrentLogin, mCurrentMechanism, aResultLimit, aTimeOut);</span>
<a href="#l17.175"></a><span id="l17.175">   if (_messageListener == NULL) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l17.176"></a><span id="l17.176"> </span>
<a href="#l17.177"></a><span id="l17.177">   mListener = _messageListener;</span>
<a href="#l17.178"></a><span id="l17.178">   *_retval = 1;</span>
<a href="#l17.179"></a><span id="l17.179"> </span>
<a href="#l17.180"></a><span id="l17.180">   // Now lets initialize the LDAP connection properly. We'll kick</span>
<a href="#l17.181"></a><span id="l17.181">   // off the bind operation in the callback function, |OnLDAPInit()|.</span>
<a href="#l17.182"></a><span id="l17.182">   rv = mConnection-&gt;Init(mDirectoryUrl, mCurrentLogin, mListener, nullptr,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -22,21 +22,17 @@ using namespace mozilla;</span>
<a href="#l18.4"></a><span id="l18.4"> // threadsafe implementation is not really thread safe since each object should</span>
<a href="#l18.5"></a><span id="l18.5"> // exist independently along with its related independent</span>
<a href="#l18.6"></a><span id="l18.6"> // nsAbLDAPReplicationQuery object.</span>
<a href="#l18.7"></a><span id="l18.7"> NS_IMPL_ISUPPORTS(nsAbLDAPProcessReplicationData,</span>
<a href="#l18.8"></a><span id="l18.8">                   nsIAbLDAPProcessReplicationData, nsILDAPMessageListener,</span>
<a href="#l18.9"></a><span id="l18.9">                   nsIObserver)</span>
<a href="#l18.10"></a><span id="l18.10"> </span>
<a href="#l18.11"></a><span id="l18.11"> nsAbLDAPProcessReplicationData::nsAbLDAPProcessReplicationData()</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-    : nsAbLDAPListenerBase(),</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-      mState(kIdle),</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">-      mProtocol(-1),</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineminus">-      mCount(0),</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineminus">-      mInitialized(false) {}</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineplus">+    : nsAbLDAPListenerBase(), mState(kIdle), mCount(0), mInitialized(false) {}</span>
<a href="#l18.18"></a><span id="l18.18"> </span>
<a href="#l18.19"></a><span id="l18.19"> nsAbLDAPProcessReplicationData::~nsAbLDAPProcessReplicationData() {}</span>
<a href="#l18.20"></a><span id="l18.20"> </span>
<a href="#l18.21"></a><span id="l18.21"> NS_IMETHODIMP nsAbLDAPProcessReplicationData::Init(</span>
<a href="#l18.22"></a><span id="l18.22">     nsIAbLDAPDirectory *aDirectory, nsILDAPConnection *aConnection,</span>
<a href="#l18.23"></a><span id="l18.23">     nsILDAPURL *aURL, nsIAbLDAPReplicationQuery *aQuery,</span>
<a href="#l18.24"></a><span id="l18.24">     nsIWebProgressListener *aProgressListener) {</span>
<a href="#l18.25"></a><span id="l18.25">   NS_ENSURE_ARG_POINTER(aDirectory);</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineat">@@ -76,23 +72,16 @@ NS_IMETHODIMP nsAbLDAPProcessReplication</span>
<a href="#l18.27"></a><span id="l18.27"> </span>
<a href="#l18.28"></a><span id="l18.28"> NS_IMETHODIMP nsAbLDAPProcessReplicationData::GetReplicationState(</span>
<a href="#l18.29"></a><span id="l18.29">     int32_t *aReplicationState) {</span>
<a href="#l18.30"></a><span id="l18.30">   NS_ENSURE_ARG_POINTER(aReplicationState);</span>
<a href="#l18.31"></a><span id="l18.31">   *aReplicationState = mState;</span>
<a href="#l18.32"></a><span id="l18.32">   return NS_OK;</span>
<a href="#l18.33"></a><span id="l18.33"> }</span>
<a href="#l18.34"></a><span id="l18.34"> </span>
<a href="#l18.35"></a><span id="l18.35" class="difflineminus">-NS_IMETHODIMP nsAbLDAPProcessReplicationData::GetProtocolUsed(</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineminus">-    int32_t *aProtocolUsed) {</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aProtocolUsed);</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineminus">-  *aProtocolUsed = mProtocol;</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineminus">-  return NS_OK;</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineminus">-}</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineminus">-</span>
<a href="#l18.42"></a><span id="l18.42"> NS_IMETHODIMP nsAbLDAPProcessReplicationData::OnLDAPMessage(</span>
<a href="#l18.43"></a><span id="l18.43">     nsILDAPMessage *aMessage) {</span>
<a href="#l18.44"></a><span id="l18.44">   NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l18.45"></a><span id="l18.45"> </span>
<a href="#l18.46"></a><span id="l18.46">   if (!mInitialized) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l18.47"></a><span id="l18.47"> </span>
<a href="#l18.48"></a><span id="l18.48">   int32_t messageType;</span>
<a href="#l18.49"></a><span id="l18.49">   nsresult rv = aMessage-&gt;GetType(&amp;messageType);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPReplicationData.h</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPReplicationData.h</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -43,17 +43,16 @@ class nsAbLDAPProcessReplicationData : p</span>
<a href="#l19.4"></a><span id="l19.4"> </span>
<a href="#l19.5"></a><span id="l19.5">   nsCOMPtr&lt;nsIAbDirectory&gt; mReplicationDB;</span>
<a href="#l19.6"></a><span id="l19.6">   nsCOMPtr&lt;nsIFile&gt; mReplicationFile;</span>
<a href="#l19.7"></a><span id="l19.7">   nsCOMPtr&lt;nsIFile&gt; mOldReplicationFile;</span>
<a href="#l19.8"></a><span id="l19.8">   nsCString mReplicationFileName;</span>
<a href="#l19.9"></a><span id="l19.9"> </span>
<a href="#l19.10"></a><span id="l19.10">   // state of processing, protocol used and count of results</span>
<a href="#l19.11"></a><span id="l19.11">   int32_t mState;</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-  int32_t mProtocol;</span>
<a href="#l19.13"></a><span id="l19.13">   int32_t mCount;</span>
<a href="#l19.14"></a><span id="l19.14">   bool mInitialized;</span>
<a href="#l19.15"></a><span id="l19.15"> </span>
<a href="#l19.16"></a><span id="l19.16">   nsCOMPtr&lt;nsIAbLDAPDirectory&gt; mDirectory;</span>
<a href="#l19.17"></a><span id="l19.17">   nsCOMPtr&lt;nsIAbLDAPAttributeMap&gt; mAttrMap;  // maps ab properties to ldap attrs</span>
<a href="#l19.18"></a><span id="l19.18"> </span>
<a href="#l19.19"></a><span id="l19.19">   virtual nsresult OnLDAPSearchEntry(nsILDAPMessage *aMessage);</span>
<a href="#l19.20"></a><span id="l19.20">   virtual nsresult OnLDAPSearchResult(nsILDAPMessage *aMessage);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPReplicationService.cpp</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPReplicationService.cpp</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -5,18 +5,16 @@</span>
<a href="#l20.4"></a><span id="l20.4"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l20.5"></a><span id="l20.5"> #include &quot;nsAbLDAPReplicationService.h&quot;</span>
<a href="#l20.6"></a><span id="l20.6"> #include &quot;nsAbLDAPReplicationQuery.h&quot;</span>
<a href="#l20.7"></a><span id="l20.7"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l20.8"></a><span id="l20.8"> #include &quot;nsIWebProgressListener.h&quot;</span>
<a href="#l20.9"></a><span id="l20.9"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l20.10"></a><span id="l20.10"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-// XXX Change log replication doesn't work. Bug 311632 should fix it.</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-//#include &quot;nsAbLDAPChangeLogQuery.h&quot;</span>
<a href="#l20.14"></a><span id="l20.14"> #include &quot;nsIAbLDAPReplicationData.h&quot;</span>
<a href="#l20.15"></a><span id="l20.15"> </span>
<a href="#l20.16"></a><span id="l20.16"> /*** implementation of the service ******/</span>
<a href="#l20.17"></a><span id="l20.17"> </span>
<a href="#l20.18"></a><span id="l20.18"> NS_IMPL_ISUPPORTS(nsAbLDAPReplicationService, nsIAbLDAPReplicationService)</span>
<a href="#l20.19"></a><span id="l20.19"> </span>
<a href="#l20.20"></a><span id="l20.20"> nsAbLDAPReplicationService::nsAbLDAPReplicationService()</span>
<a href="#l20.21"></a><span id="l20.21">     : mReplicating(false) {}</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineat">@@ -24,38 +22,24 @@ nsAbLDAPReplicationService::nsAbLDAPRepl</span>
<a href="#l20.23"></a><span id="l20.23"> nsAbLDAPReplicationService::~nsAbLDAPReplicationService() {}</span>
<a href="#l20.24"></a><span id="l20.24"> </span>
<a href="#l20.25"></a><span id="l20.25"> /* void startReplication(in string aURI, in nsIWebProgressListener</span>
<a href="#l20.26"></a><span id="l20.26">  * progressListener); */</span>
<a href="#l20.27"></a><span id="l20.27"> NS_IMETHODIMP nsAbLDAPReplicationService::StartReplication(</span>
<a href="#l20.28"></a><span id="l20.28">     nsIAbLDAPDirectory *aDirectory, nsIWebProgressListener *progressListener) {</span>
<a href="#l20.29"></a><span id="l20.29">   NS_ENSURE_ARG_POINTER(aDirectory);</span>
<a href="#l20.30"></a><span id="l20.30"> </span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-#ifdef DEBUG_rdayal</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineminus">-  printf(&quot;Start Replication called&quot;);</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineminus">-#endif</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineminus">-</span>
<a href="#l20.35"></a><span id="l20.35">   // Makes sure to allow only one replication at a time.</span>
<a href="#l20.36"></a><span id="l20.36">   if (mReplicating) return NS_ERROR_FAILURE;</span>
<a href="#l20.37"></a><span id="l20.37"> </span>
<a href="#l20.38"></a><span id="l20.38">   mDirectory = aDirectory;</span>
<a href="#l20.39"></a><span id="l20.39"> </span>
<a href="#l20.40"></a><span id="l20.40">   nsresult rv = NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l20.41"></a><span id="l20.41"> </span>
<a href="#l20.42"></a><span id="l20.42" class="difflineminus">-  switch (DecideProtocol()) {</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineminus">-    case nsIAbLDAPProcessReplicationData::kDefaultDownloadAll:</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineminus">-      mQuery = do_CreateInstance(NS_ABLDAP_REPLICATIONQUERY_CONTRACTID, &amp;rv);</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineminus">-      break;</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineminus">-      // XXX Change log replication doesn't work. Bug 311632 should fix it.</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineminus">-      // case nsIAbLDAPProcessReplicationData::kChangeLogProtocol:</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineminus">-      //  mQuery = do_CreateInstance (NS_ABLDAP_CHANGELOGQUERY_CONTRACTID, &amp;rv);</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineminus">-      //  break;</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineminus">-    default:</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineminus">-      break;</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineminus">-  }</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineplus">+  mQuery = do_CreateInstance(NS_ABLDAP_REPLICATIONQUERY_CONTRACTID, &amp;rv);</span>
<a href="#l20.54"></a><span id="l20.54"> </span>
<a href="#l20.55"></a><span id="l20.55">   if (NS_SUCCEEDED(rv) &amp;&amp; mQuery) {</span>
<a href="#l20.56"></a><span id="l20.56">     rv = mQuery-&gt;Init(mDirectory, progressListener);</span>
<a href="#l20.57"></a><span id="l20.57">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l20.58"></a><span id="l20.58">       rv = mQuery-&gt;DoReplicationQuery();</span>
<a href="#l20.59"></a><span id="l20.59">       if (NS_SUCCEEDED(rv)) {</span>
<a href="#l20.60"></a><span id="l20.60">         mReplicating = true;</span>
<a href="#l20.61"></a><span id="l20.61">         return rv;</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineat">@@ -96,20 +80,8 @@ NS_IMETHODIMP nsAbLDAPReplicationService</span>
<a href="#l20.63"></a><span id="l20.63">   mReplicating = false;</span>
<a href="#l20.64"></a><span id="l20.64">   if (mQuery) {</span>
<a href="#l20.65"></a><span id="l20.65">     mQuery = nullptr;      // Release query obj</span>
<a href="#l20.66"></a><span id="l20.66">     mDirectory = nullptr;  // Release directory</span>
<a href="#l20.67"></a><span id="l20.67">   }</span>
<a href="#l20.68"></a><span id="l20.68"> </span>
<a href="#l20.69"></a><span id="l20.69">   return NS_OK;</span>
<a href="#l20.70"></a><span id="l20.70"> }</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineminus">-</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineminus">-// XXX: This method should query the RootDSE for the changeLog attribute,</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineminus">-// if it exists ChangeLog protocol is supported.</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineminus">-int32_t nsAbLDAPReplicationService::DecideProtocol() {</span>
<a href="#l20.75"></a><span id="l20.75" class="difflineminus">-  // Do the changeLog, it will decide if there is a need to replicate all</span>
<a href="#l20.76"></a><span id="l20.76" class="difflineminus">-  // entries or only update existing DB and will do the appropriate thing.</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineminus">-  //</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineminus">-  // XXX: Bug 231965 changed this from kChangeLogProtocol to</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineminus">-  // kDefaultDownloadAll because of a problem with ldap replication not</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineminus">-  // working correctly. We need to change this back at some stage (bug 311632).</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineminus">-  return nsIAbLDAPProcessReplicationData::kDefaultDownloadAll;</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPReplicationService.h</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPReplicationService.h</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -11,18 +11,16 @@</span>
<a href="#l21.4"></a><span id="l21.4"> </span>
<a href="#l21.5"></a><span id="l21.5"> class nsAbLDAPReplicationService : public nsIAbLDAPReplicationService {</span>
<a href="#l21.6"></a><span id="l21.6">  public:</span>
<a href="#l21.7"></a><span id="l21.7">   NS_DECL_ISUPPORTS</span>
<a href="#l21.8"></a><span id="l21.8">   NS_DECL_NSIABLDAPREPLICATIONSERVICE</span>
<a href="#l21.9"></a><span id="l21.9"> </span>
<a href="#l21.10"></a><span id="l21.10">   nsAbLDAPReplicationService();</span>
<a href="#l21.11"></a><span id="l21.11"> </span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-  int32_t DecideProtocol();</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-</span>
<a href="#l21.14"></a><span id="l21.14">  protected:</span>
<a href="#l21.15"></a><span id="l21.15">   virtual ~nsAbLDAPReplicationService();</span>
<a href="#l21.16"></a><span id="l21.16">   nsCOMPtr&lt;nsIAbLDAPReplicationQuery&gt; mQuery;</span>
<a href="#l21.17"></a><span id="l21.17">   bool mReplicating;</span>
<a href="#l21.18"></a><span id="l21.18">   nsCOMPtr&lt;nsIAbLDAPDirectory&gt; mDirectory;</span>
<a href="#l21.19"></a><span id="l21.19"> };</span>
<a href="#l21.20"></a><span id="l21.20"> </span>
<a href="#l21.21"></a><span id="l21.21"> #endif /* nsAbLDAPReplicationService_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/build/nsMailModule.cpp</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/build/nsMailModule.cpp</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -107,39 +107,35 @@</span>
<a href="#l22.4"></a><span id="l22.4"> #include &quot;nsStopwatch.h&quot;</span>
<a href="#l22.5"></a><span id="l22.5"> #include &quot;MailNewsDLF.h&quot;</span>
<a href="#l22.6"></a><span id="l22.6"> </span>
<a href="#l22.7"></a><span id="l22.7"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l22.8"></a><span id="l22.8"> // addrbook includes</span>
<a href="#l22.9"></a><span id="l22.9"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l22.10"></a><span id="l22.10"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l22.11"></a><span id="l22.11"> #include &quot;nsAddrDatabase.h&quot;</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineplus">+#include &quot;nsAbCardProperty.h&quot;</span>
<a href="#l22.13"></a><span id="l22.13"> #include &quot;nsAbContentHandler.h&quot;</span>
<a href="#l22.14"></a><span id="l22.14"> #include &quot;nsAbDirProperty.h&quot;</span>
<a href="#l22.15"></a><span id="l22.15"> #include &quot;nsAbAddressCollector.h&quot;</span>
<a href="#l22.16"></a><span id="l22.16"> #include &quot;nsAddbookProtocolHandler.h&quot;</span>
<a href="#l22.17"></a><span id="l22.17"> #include &quot;nsAddbookUrl.h&quot;</span>
<a href="#l22.18"></a><span id="l22.18"> </span>
<a href="#l22.19"></a><span id="l22.19"> #include &quot;nsAbDirectoryQuery.h&quot;</span>
<a href="#l22.20"></a><span id="l22.20"> #include &quot;nsAbBooleanExpression.h&quot;</span>
<a href="#l22.21"></a><span id="l22.21"> #include &quot;nsAbDirectoryQueryProxy.h&quot;</span>
<a href="#l22.22"></a><span id="l22.22"> #include &quot;nsMsgVCardService.h&quot;</span>
<a href="#l22.23"></a><span id="l22.23"> #include &quot;nsAbLDIFService.h&quot;</span>
<a href="#l22.24"></a><span id="l22.24"> </span>
<a href="#l22.25"></a><span id="l22.25"> #if defined(MOZ_LDAP_XPCOM)</span>
<a href="#l22.26"></a><span id="l22.26"> #  include &quot;nsAbLDAPDirectory.h&quot;</span>
<a href="#l22.27"></a><span id="l22.27"> #  include &quot;nsAbLDAPDirectoryQuery.h&quot;</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineminus">-#  include &quot;nsAbLDAPCard.h&quot;</span>
<a href="#l22.29"></a><span id="l22.29"> #  include &quot;nsAbLDAPReplicationService.h&quot;</span>
<a href="#l22.30"></a><span id="l22.30"> #  include &quot;nsAbLDAPReplicationQuery.h&quot;</span>
<a href="#l22.31"></a><span id="l22.31"> #  include &quot;nsAbLDAPReplicationData.h&quot;</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineminus">-// XXX These files are not being built as they don't work. Bug 311632 should</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineminus">-// fix them.</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineminus">-//#include &quot;nsAbLDAPChangeLogQuery.h&quot;</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineminus">-//#include &quot;nsAbLDAPChangeLogData.h&quot;</span>
<a href="#l22.36"></a><span id="l22.36"> #endif</span>
<a href="#l22.37"></a><span id="l22.37"> </span>
<a href="#l22.38"></a><span id="l22.38"> #if defined(MOZ_MAPI_SUPPORT)</span>
<a href="#l22.39"></a><span id="l22.39"> #  include &quot;nsAbOutlookInterface.h&quot;</span>
<a href="#l22.40"></a><span id="l22.40"> #  include &quot;nsAbOutlookDirectory.h&quot;</span>
<a href="#l22.41"></a><span id="l22.41"> #endif</span>
<a href="#l22.42"></a><span id="l22.42"> </span>
<a href="#l22.43"></a><span id="l22.43"> #ifdef XP_MACOSX</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineat">@@ -443,24 +439,19 @@ NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbOutlo</span>
<a href="#l22.45"></a><span id="l22.45"> </span>
<a href="#l22.46"></a><span id="l22.46"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbDirectoryQueryArguments)</span>
<a href="#l22.47"></a><span id="l22.47"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbBooleanConditionString)</span>
<a href="#l22.48"></a><span id="l22.48"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbBooleanExpression)</span>
<a href="#l22.49"></a><span id="l22.49"> </span>
<a href="#l22.50"></a><span id="l22.50"> #if defined(MOZ_LDAP_XPCOM)</span>
<a href="#l22.51"></a><span id="l22.51"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbLDAPDirectory)</span>
<a href="#l22.52"></a><span id="l22.52"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbLDAPDirectoryQuery)</span>
<a href="#l22.53"></a><span id="l22.53" class="difflineminus">-NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbLDAPCard)</span>
<a href="#l22.54"></a><span id="l22.54"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbLDAPReplicationService)</span>
<a href="#l22.55"></a><span id="l22.55"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbLDAPReplicationQuery)</span>
<a href="#l22.56"></a><span id="l22.56"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbLDAPProcessReplicationData)</span>
<a href="#l22.57"></a><span id="l22.57" class="difflineminus">-// XXX These files are not being built as they don't work. Bug 311632 should</span>
<a href="#l22.58"></a><span id="l22.58" class="difflineminus">-// fix them.</span>
<a href="#l22.59"></a><span id="l22.59" class="difflineminus">-// NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbLDAPChangeLogQuery)</span>
<a href="#l22.60"></a><span id="l22.60" class="difflineminus">-// NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbLDAPProcessChangeLogData)</span>
<a href="#l22.61"></a><span id="l22.61"> #endif</span>
<a href="#l22.62"></a><span id="l22.62"> </span>
<a href="#l22.63"></a><span id="l22.63"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbDirectoryQueryProxy)</span>
<a href="#l22.64"></a><span id="l22.64"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgVCardService)</span>
<a href="#l22.65"></a><span id="l22.65"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbLDIFService)</span>
<a href="#l22.66"></a><span id="l22.66"> </span>
<a href="#l22.67"></a><span id="l22.67"> #ifdef XP_MACOSX</span>
<a href="#l22.68"></a><span id="l22.68"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbOSXDirectory)</span>
<a href="#l22.69"></a><span id="l22.69" class="difflineat">@@ -480,17 +471,16 @@ NS_DEFINE_NAMED_CID(NS_BOOLEANEXPRESSION</span>
<a href="#l22.70"></a><span id="l22.70"> #if defined(MOZ_MAPI_SUPPORT)</span>
<a href="#l22.71"></a><span id="l22.71"> NS_DEFINE_NAMED_CID(NS_ABOUTLOOKDIRECTORY_CID);</span>
<a href="#l22.72"></a><span id="l22.72"> NS_DEFINE_NAMED_CID(NS_ABOUTLOOKINTERFACE_CID);</span>
<a href="#l22.73"></a><span id="l22.73"> #endif</span>
<a href="#l22.74"></a><span id="l22.74"> </span>
<a href="#l22.75"></a><span id="l22.75"> #if defined(MOZ_LDAP_XPCOM)</span>
<a href="#l22.76"></a><span id="l22.76"> NS_DEFINE_NAMED_CID(NS_ABLDAPDIRECTORY_CID);</span>
<a href="#l22.77"></a><span id="l22.77"> NS_DEFINE_NAMED_CID(NS_ABLDAPDIRECTORYQUERY_CID);</span>
<a href="#l22.78"></a><span id="l22.78" class="difflineminus">-NS_DEFINE_NAMED_CID(NS_ABLDAPCARD_CID);</span>
<a href="#l22.79"></a><span id="l22.79"> NS_DEFINE_NAMED_CID(NS_ABLDAP_REPLICATIONSERVICE_CID);</span>
<a href="#l22.80"></a><span id="l22.80"> NS_DEFINE_NAMED_CID(NS_ABLDAP_REPLICATIONQUERY_CID);</span>
<a href="#l22.81"></a><span id="l22.81"> NS_DEFINE_NAMED_CID(NS_ABLDAP_PROCESSREPLICATIONDATA_CID);</span>
<a href="#l22.82"></a><span id="l22.82"> #endif</span>
<a href="#l22.83"></a><span id="l22.83"> NS_DEFINE_NAMED_CID(NS_ABDIRECTORYQUERYPROXY_CID);</span>
<a href="#l22.84"></a><span id="l22.84"> #ifdef XP_MACOSX</span>
<a href="#l22.85"></a><span id="l22.85"> NS_DEFINE_NAMED_CID(NS_ABOSXDIRECTORY_CID);</span>
<a href="#l22.86"></a><span id="l22.86"> NS_DEFINE_NAMED_CID(NS_ABOSXCARD_CID);</span>
<a href="#l22.87"></a><span id="l22.87" class="difflineat">@@ -896,17 +886,16 @@ const mozilla::Module::CIDEntry kMailNew</span>
<a href="#l22.88"></a><span id="l22.88">     {&amp;kNS_BOOLEANCONDITIONSTRING_CID, false, NULL,</span>
<a href="#l22.89"></a><span id="l22.89">      nsAbBooleanConditionStringConstructor},</span>
<a href="#l22.90"></a><span id="l22.90">     {&amp;kNS_BOOLEANEXPRESSION_CID, false, NULL, nsAbBooleanExpressionConstructor},</span>
<a href="#l22.91"></a><span id="l22.91"> </span>
<a href="#l22.92"></a><span id="l22.92"> #if defined(MOZ_LDAP_XPCOM)</span>
<a href="#l22.93"></a><span id="l22.93">     {&amp;kNS_ABLDAPDIRECTORY_CID, false, NULL, nsAbLDAPDirectoryConstructor},</span>
<a href="#l22.94"></a><span id="l22.94">     {&amp;kNS_ABLDAPDIRECTORYQUERY_CID, false, NULL,</span>
<a href="#l22.95"></a><span id="l22.95">      nsAbLDAPDirectoryQueryConstructor},</span>
<a href="#l22.96"></a><span id="l22.96" class="difflineminus">-    {&amp;kNS_ABLDAPCARD_CID, false, NULL, nsAbLDAPCardConstructor},</span>
<a href="#l22.97"></a><span id="l22.97">     {&amp;kNS_ABLDAP_REPLICATIONSERVICE_CID, false, NULL,</span>
<a href="#l22.98"></a><span id="l22.98">      nsAbLDAPReplicationServiceConstructor},</span>
<a href="#l22.99"></a><span id="l22.99">     {&amp;kNS_ABLDAP_REPLICATIONQUERY_CID, false, NULL,</span>
<a href="#l22.100"></a><span id="l22.100">      nsAbLDAPReplicationQueryConstructor},</span>
<a href="#l22.101"></a><span id="l22.101">     {&amp;kNS_ABLDAP_PROCESSREPLICATIONDATA_CID, false, NULL,</span>
<a href="#l22.102"></a><span id="l22.102">      nsAbLDAPProcessReplicationDataConstructor},</span>
<a href="#l22.103"></a><span id="l22.103"> #endif</span>
<a href="#l22.104"></a><span id="l22.104">     {&amp;kNS_ABDIRECTORYQUERYPROXY_CID, false, NULL,</span>
<a href="#l22.105"></a><span id="l22.105" class="difflineat">@@ -1129,17 +1118,16 @@ const mozilla::Module::ContractIDEntry k</span>
<a href="#l22.106"></a><span id="l22.106">     {NS_ABDIRECTORYQUERYARGUMENTS_CONTRACTID,</span>
<a href="#l22.107"></a><span id="l22.107">      &amp;kNS_ABDIRECTORYQUERYARGUMENTS_CID},</span>
<a href="#l22.108"></a><span id="l22.108">     {NS_BOOLEANCONDITIONSTRING_CONTRACTID, &amp;kNS_BOOLEANCONDITIONSTRING_CID},</span>
<a href="#l22.109"></a><span id="l22.109">     {NS_BOOLEANEXPRESSION_CONTRACTID, &amp;kNS_BOOLEANEXPRESSION_CID},</span>
<a href="#l22.110"></a><span id="l22.110"> </span>
<a href="#l22.111"></a><span id="l22.111"> #if defined(MOZ_LDAP_XPCOM)</span>
<a href="#l22.112"></a><span id="l22.112">     {NS_ABLDAPDIRECTORY_CONTRACTID, &amp;kNS_ABLDAPDIRECTORY_CID},</span>
<a href="#l22.113"></a><span id="l22.113">     {NS_ABLDAPDIRECTORYQUERY_CONTRACTID, &amp;kNS_ABLDAPDIRECTORYQUERY_CID},</span>
<a href="#l22.114"></a><span id="l22.114" class="difflineminus">-    {NS_ABLDAPCARD_CONTRACTID, &amp;kNS_ABLDAPCARD_CID},</span>
<a href="#l22.115"></a><span id="l22.115">     {NS_ABLDAP_REPLICATIONSERVICE_CONTRACTID,</span>
<a href="#l22.116"></a><span id="l22.116">      &amp;kNS_ABLDAP_REPLICATIONSERVICE_CID},</span>
<a href="#l22.117"></a><span id="l22.117">     {NS_ABLDAP_REPLICATIONQUERY_CONTRACTID, &amp;kNS_ABLDAP_REPLICATIONQUERY_CID},</span>
<a href="#l22.118"></a><span id="l22.118">     {NS_ABLDAP_PROCESSREPLICATIONDATA_CONTRACTID,</span>
<a href="#l22.119"></a><span id="l22.119">      &amp;kNS_ABLDAP_PROCESSREPLICATIONDATA_CID},</span>
<a href="#l22.120"></a><span id="l22.120"> #endif</span>
<a href="#l22.121"></a><span id="l22.121"> </span>
<a href="#l22.122"></a><span id="l22.122">     {NS_ABDIRECTORYQUERYPROXY_CONTRACTID, &amp;kNS_ABDIRECTORYQUERYPROXY_CID},</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

