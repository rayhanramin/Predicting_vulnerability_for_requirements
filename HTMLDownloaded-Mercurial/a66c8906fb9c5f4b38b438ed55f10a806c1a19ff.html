<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 18264:a66c8906fb9c5f4b38b438ed55f10a806c1a19ff</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ a66c8906fb9c5f4b38b438ed55f10a806c1a19ff" />
<meta property="og:url" content="/comm-central/rev/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff" />
<meta property="og:description" content="Bug 1151473 - Part 1: Remove use of expression closure in chat/components/, chat/content/, and chat/modules/. r=aleth" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / a66c8906fb9c5f4b38b438ed55f10a806c1a19ff 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff">shortlog</a> |
<a href="/comm-central/log/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff">files</a> |
changeset |
<a href="/comm-central/raw-rev/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff">raw</a>  | <a href="/comm-central/archive/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1151473">Bug 1151473</a> - Part 1: Remove use of expression closure in chat/components/, chat/content/, and chat/modules/. r=aleth
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#84;&#111;&#111;&#114;&#117;&#32;&#70;&#117;&#106;&#105;&#115;&#97;&#119;&#97;&#32;&#60;&#97;&#114;&#97;&#105;&#95;&#97;&#64;&#109;&#97;&#99;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 14 Aug 2015 05:43:41 +0900</td></tr>

<tr>
 <td>changeset 18264</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff">a66c8906fb9c5f4b38b438ed55f10a806c1a19ff</a></td>
</tr>



<tr>
<td>parent 18263</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2e390373ca65b260c892ef423df37a55f76d76d1">2e390373ca65b260c892ef423df37a55f76d76d1</a>
</td>
</tr>

<tr>
<td>child 18265</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/19a8584b53b82ca6cf553dbc97ab003263a1c6b2">19a8584b53b82ca6cf553dbc97ab003263a1c6b2</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=a66c8906fb9c5f4b38b438ed55f10a806c1a19ff">11213</a></td></tr>
<tr><td>push user</td><td>arai_a@mac.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 13 Aug 2015 20:46:27 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@19a8584b53b8 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=19a8584b53b82ca6cf553dbc97ab003263a1c6b2">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=19a8584b53b82ca6cf553dbc97ab003263a1c6b2&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=19a8584b53b82ca6cf553dbc97ab003263a1c6b2&newProject=comm-central&newRevision=a66c8906fb9c5f4b38b438ed55f10a806c1a19ff&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=19a8584b53b82ca6cf553dbc97ab003263a1c6b2&newProject=comm-central&newRevision=a66c8906fb9c5f4b38b438ed55f10a806c1a19ff&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=19a8584b53b82ca6cf553dbc97ab003263a1c6b2&newProject=comm-central&newRevision=a66c8906fb9c5f4b38b438ed55f10a806c1a19ff&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28aleth%29&revcount=50">aleth</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1151473">1151473</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1151473">Bug 1151473</a> - Part 1: Remove use of expression closure in chat/components/, chat/content/, and chat/modules/. r=aleth</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/imAccounts.js">chat/components/src/imAccounts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/imAccounts.js">file</a> |
<a href="/comm-central/annotate/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/imAccounts.js">annotate</a> |
<a href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/imAccounts.js">diff</a> |
<a href="/comm-central/comparison/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/imAccounts.js">comparison</a> |
<a href="/comm-central/log/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/imAccounts.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/imCommands.js">chat/components/src/imCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/imCommands.js">file</a> |
<a href="/comm-central/annotate/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/imCommands.js">annotate</a> |
<a href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/imCommands.js">diff</a> |
<a href="/comm-central/comparison/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/imCommands.js">comparison</a> |
<a href="/comm-central/log/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/imCommands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/imContacts.js">chat/components/src/imContacts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/imContacts.js">file</a> |
<a href="/comm-central/annotate/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/imContacts.js">annotate</a> |
<a href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/imContacts.js">diff</a> |
<a href="/comm-central/comparison/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/imContacts.js">comparison</a> |
<a href="/comm-central/log/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/imContacts.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/imConversations.js">chat/components/src/imConversations.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/imConversations.js">file</a> |
<a href="/comm-central/annotate/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/imConversations.js">annotate</a> |
<a href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/imConversations.js">diff</a> |
<a href="/comm-central/comparison/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/imConversations.js">comparison</a> |
<a href="/comm-central/log/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/imConversations.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/imCore.js">chat/components/src/imCore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/imCore.js">file</a> |
<a href="/comm-central/annotate/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/imCore.js">annotate</a> |
<a href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/imCore.js">diff</a> |
<a href="/comm-central/comparison/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/imCore.js">comparison</a> |
<a href="/comm-central/log/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/imCore.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/logger.js">chat/components/src/logger.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/logger.js">file</a> |
<a href="/comm-central/annotate/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/logger.js">annotate</a> |
<a href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/logger.js">diff</a> |
<a href="/comm-central/comparison/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/logger.js">comparison</a> |
<a href="/comm-central/log/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/logger.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/smileProtocolHandler.js">chat/components/src/smileProtocolHandler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/smileProtocolHandler.js">file</a> |
<a href="/comm-central/annotate/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/smileProtocolHandler.js">annotate</a> |
<a href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/smileProtocolHandler.js">diff</a> |
<a href="/comm-central/comparison/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/smileProtocolHandler.js">comparison</a> |
<a href="/comm-central/log/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/smileProtocolHandler.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/test/test_commands.js">chat/components/src/test/test_commands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/test/test_commands.js">file</a> |
<a href="/comm-central/annotate/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/test/test_commands.js">annotate</a> |
<a href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/test/test_commands.js">diff</a> |
<a href="/comm-central/comparison/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/test/test_commands.js">comparison</a> |
<a href="/comm-central/log/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/test/test_commands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/test/test_logger.js">chat/components/src/test/test_logger.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/test/test_logger.js">file</a> |
<a href="/comm-central/annotate/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/test/test_logger.js">annotate</a> |
<a href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/test/test_logger.js">diff</a> |
<a href="/comm-central/comparison/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/test/test_logger.js">comparison</a> |
<a href="/comm-central/log/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/components/src/test/test_logger.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/content/convbrowser.xml">chat/content/convbrowser.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/content/convbrowser.xml">file</a> |
<a href="/comm-central/annotate/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/content/convbrowser.xml">annotate</a> |
<a href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/content/convbrowser.xml">diff</a> |
<a href="/comm-central/comparison/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/content/convbrowser.xml">comparison</a> |
<a href="/comm-central/log/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/content/convbrowser.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/ArrayBufferUtils.jsm">chat/modules/ArrayBufferUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/ArrayBufferUtils.jsm">file</a> |
<a href="/comm-central/annotate/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/ArrayBufferUtils.jsm">annotate</a> |
<a href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/ArrayBufferUtils.jsm">diff</a> |
<a href="/comm-central/comparison/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/ArrayBufferUtils.jsm">comparison</a> |
<a href="/comm-central/log/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/ArrayBufferUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/hiddenWindow.jsm">chat/modules/hiddenWindow.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/hiddenWindow.jsm">file</a> |
<a href="/comm-central/annotate/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/hiddenWindow.jsm">annotate</a> |
<a href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/hiddenWindow.jsm">diff</a> |
<a href="/comm-central/comparison/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/hiddenWindow.jsm">comparison</a> |
<a href="/comm-central/log/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/hiddenWindow.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/imContentSink.jsm">chat/modules/imContentSink.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/imContentSink.jsm">file</a> |
<a href="/comm-central/annotate/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/imContentSink.jsm">annotate</a> |
<a href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/imContentSink.jsm">diff</a> |
<a href="/comm-central/comparison/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/imContentSink.jsm">comparison</a> |
<a href="/comm-central/log/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/imContentSink.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/imSmileys.jsm">chat/modules/imSmileys.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/imSmileys.jsm">file</a> |
<a href="/comm-central/annotate/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/imSmileys.jsm">annotate</a> |
<a href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/imSmileys.jsm">diff</a> |
<a href="/comm-central/comparison/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/imSmileys.jsm">comparison</a> |
<a href="/comm-central/log/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/imSmileys.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/imStatusUtils.jsm">chat/modules/imStatusUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/imStatusUtils.jsm">file</a> |
<a href="/comm-central/annotate/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/imStatusUtils.jsm">annotate</a> |
<a href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/imStatusUtils.jsm">diff</a> |
<a href="/comm-central/comparison/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/imStatusUtils.jsm">comparison</a> |
<a href="/comm-central/log/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/imStatusUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/imThemes.jsm">chat/modules/imThemes.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/imThemes.jsm">file</a> |
<a href="/comm-central/annotate/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/imThemes.jsm">annotate</a> |
<a href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/imThemes.jsm">diff</a> |
<a href="/comm-central/comparison/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/imThemes.jsm">comparison</a> |
<a href="/comm-central/log/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/imThemes.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/imXPCOMUtils.jsm">chat/modules/imXPCOMUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/imXPCOMUtils.jsm">file</a> |
<a href="/comm-central/annotate/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/imXPCOMUtils.jsm">annotate</a> |
<a href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/imXPCOMUtils.jsm">diff</a> |
<a href="/comm-central/comparison/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/imXPCOMUtils.jsm">comparison</a> |
<a href="/comm-central/log/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/imXPCOMUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/jsProtoHelper.jsm">chat/modules/jsProtoHelper.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/jsProtoHelper.jsm">file</a> |
<a href="/comm-central/annotate/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/jsProtoHelper.jsm">annotate</a> |
<a href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/jsProtoHelper.jsm">diff</a> |
<a href="/comm-central/comparison/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/jsProtoHelper.jsm">comparison</a> |
<a href="/comm-central/log/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/jsProtoHelper.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/socket.jsm">chat/modules/socket.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/socket.jsm">file</a> |
<a href="/comm-central/annotate/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/socket.jsm">annotate</a> |
<a href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/socket.jsm">diff</a> |
<a href="/comm-central/comparison/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/socket.jsm">comparison</a> |
<a href="/comm-central/log/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/socket.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/test/test_filtering.js">chat/modules/test/test_filtering.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/test/test_filtering.js">file</a> |
<a href="/comm-central/annotate/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/test/test_filtering.js">annotate</a> |
<a href="/comm-central/diff/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/test/test_filtering.js">diff</a> |
<a href="/comm-central/comparison/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/test/test_filtering.js">comparison</a> |
<a href="/comm-central/log/a66c8906fb9c5f4b38b438ed55f10a806c1a19ff/chat/modules/test/test_filtering.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/chat/components/src/imAccounts.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/chat/components/src/imAccounts.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -17,21 +17,21 @@ const kPrefAccountPrpl = &quot;prpl&quot;;</span>
<a href="#l1.4"></a><span id="l1.4"> const kPrefAccountAutoLogin = &quot;autoLogin&quot;;</span>
<a href="#l1.5"></a><span id="l1.5"> const kPrefAccountAutoJoin = &quot;autoJoin&quot;;</span>
<a href="#l1.6"></a><span id="l1.6"> const kPrefAccountAlias = &quot;alias&quot;;</span>
<a href="#l1.7"></a><span id="l1.7"> const kPrefAccountFirstConnectionState = &quot;firstConnectionState&quot;;</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> const kPrefConvertOldPasswords = &quot;messenger.accounts.convertOldPasswords&quot;;</span>
<a href="#l1.10"></a><span id="l1.10"> const kPrefAccountPassword = &quot;password&quot;;</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, function()</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l1.14"></a><span id="l1.14">   l10nHelper(&quot;chrome://chat/locale/accounts.properties&quot;)</span>
<a href="#l1.15"></a><span id="l1.15"> );</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_maxDebugMessages&quot;, function()</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_maxDebugMessages&quot;, () =&gt;</span>
<a href="#l1.19"></a><span id="l1.19">   Services.prefs.getIntPref(&quot;messenger.accounts.maxDebugMessages&quot;)</span>
<a href="#l1.20"></a><span id="l1.20"> );</span>
<a href="#l1.21"></a><span id="l1.21"> </span>
<a href="#l1.22"></a><span id="l1.22"> XPCOMUtils.defineLazyServiceGetter(this, &quot;HttpProtocolHandler&quot;,</span>
<a href="#l1.23"></a><span id="l1.23">   &quot;@mozilla.org/network/protocol;1?name=http&quot;, &quot;nsIHttpProtocolHandler&quot;);</span>
<a href="#l1.24"></a><span id="l1.24"> </span>
<a href="#l1.25"></a><span id="l1.25"> var gUserCanceledMasterPasswordPrompt = false;</span>
<a href="#l1.26"></a><span id="l1.26"> var gConvertingOldPasswords = false;</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineat">@@ -74,38 +74,38 @@ var AutoLoginCounter = {</span>
<a href="#l1.28"></a><span id="l1.28"> };</span>
<a href="#l1.29"></a><span id="l1.29"> </span>
<a href="#l1.30"></a><span id="l1.30"> function UnknownProtocol(aPrplId)</span>
<a href="#l1.31"></a><span id="l1.31"> {</span>
<a href="#l1.32"></a><span id="l1.32">   this.id = aPrplId;</span>
<a href="#l1.33"></a><span id="l1.33"> }</span>
<a href="#l1.34"></a><span id="l1.34"> UnknownProtocol.prototype = {</span>
<a href="#l1.35"></a><span id="l1.35">   __proto__: ClassInfo(&quot;prplIProtocol&quot;, &quot;Unknown protocol&quot;),</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-  get name() &quot;&quot;,</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-  get normalizedName() this.name,</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-  get iconBaseURI() &quot;chrome://chat/skin/prpl-unknown/&quot;,</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-  getOptions: function() EmptyEnumerator,</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-  getUsernameSplit: function() EmptyEnumerator,</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-  get usernameEmptyText() &quot;&quot;,</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+  get name() { return &quot;&quot;; },</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+  get normalizedName() { return this.name; },</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+  get iconBaseURI() { return &quot;chrome://chat/skin/prpl-unknown/&quot;; },</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+  getOptions: function() { return EmptyEnumerator; },</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+  getUsernameSplit: function() { return EmptyEnumerator; },</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+  get usernameEmptyText() { return &quot;&quot;; },</span>
<a href="#l1.48"></a><span id="l1.48"> </span>
<a href="#l1.49"></a><span id="l1.49">   getAccount: function(aKey, aName) { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l1.50"></a><span id="l1.50">   accountExists: function() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l1.51"></a><span id="l1.51"> </span>
<a href="#l1.52"></a><span id="l1.52">   // false seems an acceptable default for all options</span>
<a href="#l1.53"></a><span id="l1.53">   // (they should never be called anyway).</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-  get uniqueChatName() false,</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineminus">-  get chatHasTopic() false,</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineminus">-  get noPassword() false,</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-  get newMailNotification() false,</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineminus">-  get imagesInIM() false,</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-  get passwordOptional() true,</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-  get usePointSize() true,</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineminus">-  get registerNoScreenName() false,</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-  get slashCommandsNative() false,</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-  get usePurpleProxy() false</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+  get uniqueChatName() { return false; },</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+  get chatHasTopic() { return false; },</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+  get noPassword() { return false; },</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+  get newMailNotification() { return false; },</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+  get imagesInIM() { return false; },</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+  get passwordOptional() { return true; },</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+  get usePointSize() { return true; },</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+  get registerNoScreenName() { return false; },</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+  get slashCommandsNative() { return false; },</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineplus">+  get usePurpleProxy() { return false; }</span>
<a href="#l1.74"></a><span id="l1.74"> };</span>
<a href="#l1.75"></a><span id="l1.75"> </span>
<a href="#l1.76"></a><span id="l1.76"> // An unknown prplIAccount.</span>
<a href="#l1.77"></a><span id="l1.77"> function UnknownAccount(aAccount) {</span>
<a href="#l1.78"></a><span id="l1.78">   this._init(aAccount.protocol, aAccount);</span>
<a href="#l1.79"></a><span id="l1.79"> }</span>
<a href="#l1.80"></a><span id="l1.80"> UnknownAccount.prototype = GenericAccountPrototype;</span>
<a href="#l1.81"></a><span id="l1.81"> </span>
<a href="#l1.82"></a><span id="l1.82" class="difflineat">@@ -347,34 +347,34 @@ imAccount.prototype = {</span>
<a href="#l1.83"></a><span id="l1.83">     }</span>
<a href="#l1.84"></a><span id="l1.84"> </span>
<a href="#l1.85"></a><span id="l1.85">     if (aCount)</span>
<a href="#l1.86"></a><span id="l1.86">       aCount.value = messages.length;</span>
<a href="#l1.87"></a><span id="l1.87">     return messages;</span>
<a href="#l1.88"></a><span id="l1.88">   },</span>
<a href="#l1.89"></a><span id="l1.89"> </span>
<a href="#l1.90"></a><span id="l1.90">   _observedStatusInfo: null,</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineminus">-  get observedStatusInfo() this._observedStatusInfo,</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineplus">+  get observedStatusInfo() { return this._observedStatusInfo; },</span>
<a href="#l1.93"></a><span id="l1.93">   _statusObserver: null,</span>
<a href="#l1.94"></a><span id="l1.94">   set observedStatusInfo(aUserStatusInfo) {</span>
<a href="#l1.95"></a><span id="l1.95">     if (!this.prplAccount)</span>
<a href="#l1.96"></a><span id="l1.96">       return;</span>
<a href="#l1.97"></a><span id="l1.97">     if (this._statusObserver)</span>
<a href="#l1.98"></a><span id="l1.98">       this.statusInfo.removeObserver(this._statusObserver);</span>
<a href="#l1.99"></a><span id="l1.99">     this._observedStatusInfo = aUserStatusInfo;</span>
<a href="#l1.100"></a><span id="l1.100">     if (this._statusObserver)</span>
<a href="#l1.101"></a><span id="l1.101">       this.statusInfo.addObserver(this._statusObserver);</span>
<a href="#l1.102"></a><span id="l1.102">   },</span>
<a href="#l1.103"></a><span id="l1.103">   _removeStatusObserver: function() {</span>
<a href="#l1.104"></a><span id="l1.104">     if (this._statusObserver) {</span>
<a href="#l1.105"></a><span id="l1.105">       this.statusInfo.removeObserver(this._statusObserver);</span>
<a href="#l1.106"></a><span id="l1.106">       delete this._statusObserver;</span>
<a href="#l1.107"></a><span id="l1.107">     }</span>
<a href="#l1.108"></a><span id="l1.108">   },</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineminus">-  get statusInfo() this._observedStatusInfo || Services.core.globalUserStatus,</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineplus">+  get statusInfo() { return this._observedStatusInfo || Services.core.globalUserStatus; },</span>
<a href="#l1.111"></a><span id="l1.111"> </span>
<a href="#l1.112"></a><span id="l1.112">   reconnectAttempt: 0,</span>
<a href="#l1.113"></a><span id="l1.113">   timeOfLastConnect: 0,</span>
<a href="#l1.114"></a><span id="l1.114">   timeOfNextReconnect: 0,</span>
<a href="#l1.115"></a><span id="l1.115">   _reconnectTimer: null,</span>
<a href="#l1.116"></a><span id="l1.116">   _startReconnectTimer: function() {</span>
<a href="#l1.117"></a><span id="l1.117">     if (Services.io.offline) {</span>
<a href="#l1.118"></a><span id="l1.118">       Cu.reportError(&quot;_startReconnectTimer called while offline&quot;);</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineat">@@ -462,20 +462,22 @@ imAccount.prototype = {</span>
<a href="#l1.120"></a><span id="l1.120">           errorReason != Ci.imIAccount.ERROR_UNKNOWN_PRPL) {</span>
<a href="#l1.121"></a><span id="l1.121">         this.connect();</span>
<a href="#l1.122"></a><span id="l1.122">       }</span>
<a href="#l1.123"></a><span id="l1.123">     }.bind(this));</span>
<a href="#l1.124"></a><span id="l1.124">   },</span>
<a href="#l1.125"></a><span id="l1.125"> </span>
<a href="#l1.126"></a><span id="l1.126">   // If the protocol plugin is missing, we can't access the normalizedName,</span>
<a href="#l1.127"></a><span id="l1.127">   // but in lots of cases this.name is equivalent.</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineminus">-  get normalizedName()</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineminus">-    this.prplAccount ? this.prplAccount.normalizedName : this.name,</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineminus">-  normalize: function(aName)</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineminus">-    this.prplAccount ? this.prplAccount.normalize(aName) : aName,</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineplus">+  get normalizedName() {</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineplus">+    return this.prplAccount ? this.prplAccount.normalizedName : this.name;</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineplus">+  },</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineplus">+  normalize: function(aName) {</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineplus">+    return this.prplAccount ? this.prplAccount.normalize(aName) : aName;</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineplus">+  },</span>
<a href="#l1.138"></a><span id="l1.138"> </span>
<a href="#l1.139"></a><span id="l1.139">   _sendUpdateNotification: function() {</span>
<a href="#l1.140"></a><span id="l1.140">     this._sendNotification(&quot;account-updated&quot;);</span>
<a href="#l1.141"></a><span id="l1.141">   },</span>
<a href="#l1.142"></a><span id="l1.142"> </span>
<a href="#l1.143"></a><span id="l1.143">   set alias(val) {</span>
<a href="#l1.144"></a><span id="l1.144">     if (val) {</span>
<a href="#l1.145"></a><span id="l1.145">       let str = Cc[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineat">@@ -533,18 +535,19 @@ imAccount.prototype = {</span>
<a href="#l1.147"></a><span id="l1.147">   _checkIfPasswordStillMissing: function() {</span>
<a href="#l1.148"></a><span id="l1.148">     if (this._connectionErrorReason != Ci.imIAccount.ERROR_MISSING_PASSWORD ||</span>
<a href="#l1.149"></a><span id="l1.149">         !this.password)</span>
<a href="#l1.150"></a><span id="l1.150">       return;</span>
<a href="#l1.151"></a><span id="l1.151"> </span>
<a href="#l1.152"></a><span id="l1.152">     delete this._connectionErrorReason;</span>
<a href="#l1.153"></a><span id="l1.153">     this._sendUpdateNotification();</span>
<a href="#l1.154"></a><span id="l1.154">   },</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineminus">-  get _passwordRequired()</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineminus">-    !this.protocol.noPassword &amp;&amp; !this.protocol.passwordOptional,</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineplus">+  get _passwordRequired() {</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineplus">+    return !this.protocol.noPassword &amp;&amp; !this.protocol.passwordOptional;</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineplus">+  },</span>
<a href="#l1.160"></a><span id="l1.160">   set password(aPassword) {</span>
<a href="#l1.161"></a><span id="l1.161">     this._password = aPassword;</span>
<a href="#l1.162"></a><span id="l1.162">     if (gUserCanceledMasterPasswordPrompt)</span>
<a href="#l1.163"></a><span id="l1.163">       return;</span>
<a href="#l1.164"></a><span id="l1.164">     let newLogin = Cc[&quot;@mozilla.org/login-manager/loginInfo;1&quot;]</span>
<a href="#l1.165"></a><span id="l1.165">                    .createInstance(Ci.nsILoginInfo);</span>
<a href="#l1.166"></a><span id="l1.166">     let passwordURI = &quot;im://&quot; + this.protocol.id;</span>
<a href="#l1.167"></a><span id="l1.167">     newLogin.init(passwordURI, null, passwordURI, this.normalizedName,</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineat">@@ -734,20 +737,20 @@ imAccount.prototype = {</span>
<a href="#l1.169"></a><span id="l1.169">       this.prplAccount.connect();</span>
<a href="#l1.170"></a><span id="l1.170">   },</span>
<a href="#l1.171"></a><span id="l1.171">   disconnect: function() {</span>
<a href="#l1.172"></a><span id="l1.172">     this._removeStatusObserver();</span>
<a href="#l1.173"></a><span id="l1.173">     if (!this.disconnected)</span>
<a href="#l1.174"></a><span id="l1.174">       this._ensurePrplAccount.disconnect();</span>
<a href="#l1.175"></a><span id="l1.175">   },</span>
<a href="#l1.176"></a><span id="l1.176"> </span>
<a href="#l1.177"></a><span id="l1.177" class="difflineminus">-  get disconnected() this.connectionState == Ci.imIAccount.STATE_DISCONNECTED,</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineminus">-  get connected() this.connectionState == Ci.imIAccount.STATE_CONNECTED,</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineminus">-  get connecting() this.connectionState == Ci.imIAccount.STATE_CONNECTING,</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineminus">-  get disconnecting() this.connectionState == Ci.imIAccount.STATE_DISCONNECTING,</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineplus">+  get disconnected() { return this.connectionState == Ci.imIAccount.STATE_DISCONNECTED; },</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineplus">+  get connected() { return this.connectionState == Ci.imIAccount.STATE_CONNECTED; },</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineplus">+  get connecting() { return this.connectionState == Ci.imIAccount.STATE_CONNECTING; },</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineplus">+  get disconnecting() { return this.connectionState == Ci.imIAccount.STATE_DISCONNECTING; },</span>
<a href="#l1.185"></a><span id="l1.185"> </span>
<a href="#l1.186"></a><span id="l1.186">   _cancelReconnection: function() {</span>
<a href="#l1.187"></a><span id="l1.187">     if (this._reconnectTimer) {</span>
<a href="#l1.188"></a><span id="l1.188">       clearTimeout(this._reconnectTimer);</span>
<a href="#l1.189"></a><span id="l1.189">       delete this._reconnectTimer;</span>
<a href="#l1.190"></a><span id="l1.190">     }</span>
<a href="#l1.191"></a><span id="l1.191">     delete this.reconnectAttempt;</span>
<a href="#l1.192"></a><span id="l1.192">     delete this.timeOfNextReconnect;</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineat">@@ -757,34 +760,36 @@ imAccount.prototype = {</span>
<a href="#l1.194"></a><span id="l1.194">       throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l1.195"></a><span id="l1.195"> </span>
<a href="#l1.196"></a><span id="l1.196">     // Ensure we don't keep a status observer that could re-enable the</span>
<a href="#l1.197"></a><span id="l1.197">     // auto-reconnect timers.</span>
<a href="#l1.198"></a><span id="l1.198">     this.disconnect();</span>
<a href="#l1.199"></a><span id="l1.199"> </span>
<a href="#l1.200"></a><span id="l1.200">     this._cancelReconnection();</span>
<a href="#l1.201"></a><span id="l1.201">   },</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineminus">-  createConversation: function(aName)</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineminus">-    this._ensurePrplAccount.createConversation(aName),</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineplus">+  createConversation: function(aName) {</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineplus">+    return this._ensurePrplAccount.createConversation(aName);</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineplus">+  },</span>
<a href="#l1.207"></a><span id="l1.207">   addBuddy: function(aTag, aName) {</span>
<a href="#l1.208"></a><span id="l1.208">     this._ensurePrplAccount.addBuddy(aTag, aName);</span>
<a href="#l1.209"></a><span id="l1.209">   },</span>
<a href="#l1.210"></a><span id="l1.210">   loadBuddy: function(aBuddy, aTag) {</span>
<a href="#l1.211"></a><span id="l1.211">     if (this.prplAccount)</span>
<a href="#l1.212"></a><span id="l1.212">       return this.prplAccount.loadBuddy(aBuddy, aTag);</span>
<a href="#l1.213"></a><span id="l1.213">     // Generate dummy account buddies for unknown protocols.</span>
<a href="#l1.214"></a><span id="l1.214">     return new UnknownAccountBuddy(this, aBuddy, aTag);</span>
<a href="#l1.215"></a><span id="l1.215">   },</span>
<a href="#l1.216"></a><span id="l1.216">   requestBuddyInfo: function(aBuddyName) {</span>
<a href="#l1.217"></a><span id="l1.217">     this._ensurePrplAccount.requestBuddyInfo(aBuddyName);</span>
<a href="#l1.218"></a><span id="l1.218">   },</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineminus">-  getChatRoomFields: function() this._ensurePrplAccount.getChatRoomFields(),</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineminus">-  getChatRoomDefaultFieldValues: function(aDefaultChatName)</span>
<a href="#l1.221"></a><span id="l1.221" class="difflineminus">-    this._ensurePrplAccount.getChatRoomDefaultFieldValues(aDefaultChatName),</span>
<a href="#l1.222"></a><span id="l1.222" class="difflineminus">-  get canJoinChat() this.prplAccount ? this.prplAccount.canJoinChat : false,</span>
<a href="#l1.223"></a><span id="l1.223" class="difflineplus">+  getChatRoomFields: function() { return this._ensurePrplAccount.getChatRoomFields(); },</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineplus">+  getChatRoomDefaultFieldValues: function(aDefaultChatName) {</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineplus">+    return this._ensurePrplAccount.getChatRoomDefaultFieldValues(aDefaultChatName);</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineplus">+  },</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineplus">+  get canJoinChat() { return this.prplAccount ? this.prplAccount.canJoinChat : false; },</span>
<a href="#l1.228"></a><span id="l1.228">   joinChat: function(aComponents) {</span>
<a href="#l1.229"></a><span id="l1.229">     this._ensurePrplAccount.joinChat(aComponents);</span>
<a href="#l1.230"></a><span id="l1.230">   },</span>
<a href="#l1.231"></a><span id="l1.231">   setBool: function(aName, aVal) {</span>
<a href="#l1.232"></a><span id="l1.232">     this.prefBranch.setBoolPref(kAccountOptionPrefPrefix + aName, aVal);</span>
<a href="#l1.233"></a><span id="l1.233">     this._connectionInfoChanged();</span>
<a href="#l1.234"></a><span id="l1.234">     if (this.prplAccount)</span>
<a href="#l1.235"></a><span id="l1.235">       this.prplAccount.setBool(aName, aVal);</span>
<a href="#l1.236"></a><span id="l1.236" class="difflineat">@@ -805,26 +810,26 @@ imAccount.prototype = {</span>
<a href="#l1.237"></a><span id="l1.237">                                     Ci.nsISupportsString, str);</span>
<a href="#l1.238"></a><span id="l1.238">     this._connectionInfoChanged();</span>
<a href="#l1.239"></a><span id="l1.239">     if (this.prplAccount)</span>
<a href="#l1.240"></a><span id="l1.240">       this.prplAccount.setString(aName, aVal);</span>
<a href="#l1.241"></a><span id="l1.241">     SavePrefTimer.initTimer();</span>
<a href="#l1.242"></a><span id="l1.242">   },</span>
<a href="#l1.243"></a><span id="l1.243">   save: function() { SavePrefTimer.saveNow(); },</span>
<a href="#l1.244"></a><span id="l1.244"> </span>
<a href="#l1.245"></a><span id="l1.245" class="difflineminus">-  get HTMLEnabled() this._ensurePrplAccount.HTMLEnabled,</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineminus">-  get HTMLEscapePlainText() this._ensurePrplAccount.HTMLEscapePlainText,</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineminus">-  get noBackgroundColors() this._ensurePrplAccount.noBackgroundColors,</span>
<a href="#l1.248"></a><span id="l1.248" class="difflineminus">-  get autoResponses() this._ensurePrplAccount.autoResponses,</span>
<a href="#l1.249"></a><span id="l1.249" class="difflineminus">-  get singleFormatting() this._ensurePrplAccount.singleFormatting,</span>
<a href="#l1.250"></a><span id="l1.250" class="difflineminus">-  get noFontSizes() this._ensurePrplAccount.noFontSizes,</span>
<a href="#l1.251"></a><span id="l1.251" class="difflineminus">-  get noUrlDesc() this._ensurePrplAccount.noUrlDesc,</span>
<a href="#l1.252"></a><span id="l1.252" class="difflineminus">-  get noImages() this._ensurePrplAccount.noImages,</span>
<a href="#l1.253"></a><span id="l1.253" class="difflineplus">+  get HTMLEnabled() { return this._ensurePrplAccount.HTMLEnabled; },</span>
<a href="#l1.254"></a><span id="l1.254" class="difflineplus">+  get HTMLEscapePlainText() { return this._ensurePrplAccount.HTMLEscapePlainText; },</span>
<a href="#l1.255"></a><span id="l1.255" class="difflineplus">+  get noBackgroundColors() { return this._ensurePrplAccount.noBackgroundColors; },</span>
<a href="#l1.256"></a><span id="l1.256" class="difflineplus">+  get autoResponses() { return this._ensurePrplAccount.autoResponses; },</span>
<a href="#l1.257"></a><span id="l1.257" class="difflineplus">+  get singleFormatting() { return this._ensurePrplAccount.singleFormatting; },</span>
<a href="#l1.258"></a><span id="l1.258" class="difflineplus">+  get noFontSizes() { return this._ensurePrplAccount.noFontSizes; },</span>
<a href="#l1.259"></a><span id="l1.259" class="difflineplus">+  get noUrlDesc() { return this._ensurePrplAccount.noUrlDesc; },</span>
<a href="#l1.260"></a><span id="l1.260" class="difflineplus">+  get noImages() { return this._ensurePrplAccount.noImages; },</span>
<a href="#l1.261"></a><span id="l1.261"> </span>
<a href="#l1.262"></a><span id="l1.262" class="difflineminus">-  get proxyInfo() this._ensurePrplAccount.proxyInfo,</span>
<a href="#l1.263"></a><span id="l1.263" class="difflineplus">+  get proxyInfo() { return this._ensurePrplAccount.proxyInfo; },</span>
<a href="#l1.264"></a><span id="l1.264">   set proxyInfo(val) {</span>
<a href="#l1.265"></a><span id="l1.265">     this._ensurePrplAccount.proxyInfo = val;</span>
<a href="#l1.266"></a><span id="l1.266">     this._connectionInfoChanged();</span>
<a href="#l1.267"></a><span id="l1.267">   }</span>
<a href="#l1.268"></a><span id="l1.268"> };</span>
<a href="#l1.269"></a><span id="l1.269"> </span>
<a href="#l1.270"></a><span id="l1.270"> var gAccountsService = null;</span>
<a href="#l1.271"></a><span id="l1.271"> </span>
<a href="#l1.272"></a><span id="l1.272" class="difflineat">@@ -863,25 +868,25 @@ AccountsService.prototype = {</span>
<a href="#l1.273"></a><span id="l1.273">   _prefObserver: null,</span>
<a href="#l1.274"></a><span id="l1.274">   observe: function(aSubject, aTopic, aData) {</span>
<a href="#l1.275"></a><span id="l1.275">     if (aTopic != &quot;nsPref:changed&quot; || aData != kPrefMessengerAccounts ||</span>
<a href="#l1.276"></a><span id="l1.276">        !this._observingAccountListChange)</span>
<a href="#l1.277"></a><span id="l1.277">       return;</span>
<a href="#l1.278"></a><span id="l1.278"> </span>
<a href="#l1.279"></a><span id="l1.279">     this._accounts =</span>
<a href="#l1.280"></a><span id="l1.280">       this._accountList.split(&quot;,&quot;).map(String.trim)</span>
<a href="#l1.281"></a><span id="l1.281" class="difflineminus">-          .filter(function (k) k.startsWith(kAccountKeyPrefix))</span>
<a href="#l1.282"></a><span id="l1.282" class="difflineminus">-          .map(function (k) parseInt(k.substr(kAccountKeyPrefix.length)))</span>
<a href="#l1.283"></a><span id="l1.283" class="difflineplus">+          .filter(k =&gt; k.startsWith(kAccountKeyPrefix))</span>
<a href="#l1.284"></a><span id="l1.284" class="difflineplus">+          .map(k =&gt; parseInt(k.substr(kAccountKeyPrefix.length)))</span>
<a href="#l1.285"></a><span id="l1.285">           .map(this.getAccountByNumericId, this)</span>
<a href="#l1.286"></a><span id="l1.286" class="difflineminus">-          .filter(function (a) a);</span>
<a href="#l1.287"></a><span id="l1.287" class="difflineplus">+          .filter(a =&gt; a);</span>
<a href="#l1.288"></a><span id="l1.288"> </span>
<a href="#l1.289"></a><span id="l1.289">     Services.obs.notifyObservers(this, &quot;account-list-updated&quot;, null);</span>
<a href="#l1.290"></a><span id="l1.290">   },</span>
<a href="#l1.291"></a><span id="l1.291"> </span>
<a href="#l1.292"></a><span id="l1.292" class="difflineminus">-  get _accountList() Services.prefs.getCharPref(kPrefMessengerAccounts),</span>
<a href="#l1.293"></a><span id="l1.293" class="difflineplus">+  get _accountList() { return Services.prefs.getCharPref(kPrefMessengerAccounts); },</span>
<a href="#l1.294"></a><span id="l1.294">   set _accountList(aNewList) {</span>
<a href="#l1.295"></a><span id="l1.295">     this._observingAccountListChange = false;</span>
<a href="#l1.296"></a><span id="l1.296">     Services.prefs.setCharPref(kPrefMessengerAccounts, aNewList);</span>
<a href="#l1.297"></a><span id="l1.297">     delete this._observingAccountListChange;</span>
<a href="#l1.298"></a><span id="l1.298">   },</span>
<a href="#l1.299"></a><span id="l1.299"> </span>
<a href="#l1.300"></a><span id="l1.300">   unInitAccounts: function() {</span>
<a href="#l1.301"></a><span id="l1.301">     for each (let account in this._accounts)</span>
<a href="#l1.302"></a><span id="l1.302" class="difflineat">@@ -1015,18 +1020,18 @@ AccountsService.prototype = {</span>
<a href="#l1.303"></a><span id="l1.303">     let id = parseInt(aAccountId.substr(kAccountKeyPrefix.length));</span>
<a href="#l1.304"></a><span id="l1.304">     return this.getAccountByNumericId(id);</span>
<a href="#l1.305"></a><span id="l1.305">   },</span>
<a href="#l1.306"></a><span id="l1.306"> </span>
<a href="#l1.307"></a><span id="l1.307">   _keepAccount: function(aAccount) {</span>
<a href="#l1.308"></a><span id="l1.308">     this._accounts.push(aAccount);</span>
<a href="#l1.309"></a><span id="l1.309">     this._accountsById[aAccount.numericId] = aAccount;</span>
<a href="#l1.310"></a><span id="l1.310">   },</span>
<a href="#l1.311"></a><span id="l1.311" class="difflineminus">-  getAccountByNumericId: function(aAccountId) this._accountsById[aAccountId],</span>
<a href="#l1.312"></a><span id="l1.312" class="difflineminus">-  getAccounts: function() new nsSimpleEnumerator(this._accounts),</span>
<a href="#l1.313"></a><span id="l1.313" class="difflineplus">+  getAccountByNumericId: function(aAccountId) { return this._accountsById[aAccountId]; },</span>
<a href="#l1.314"></a><span id="l1.314" class="difflineplus">+  getAccounts: function() { return new nsSimpleEnumerator(this._accounts); },</span>
<a href="#l1.315"></a><span id="l1.315"> </span>
<a href="#l1.316"></a><span id="l1.316">   createAccount: function(aName, aPrpl) {</span>
<a href="#l1.317"></a><span id="l1.317">     // Ensure an account with the same name and protocol doesn't already exist.</span>
<a href="#l1.318"></a><span id="l1.318">     let prpl = Services.core.getProtocolById(aPrpl);</span>
<a href="#l1.319"></a><span id="l1.319">     if (!prpl)</span>
<a href="#l1.320"></a><span id="l1.320">       throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l1.321"></a><span id="l1.321">     if (prpl.accountExists(aName)) {</span>
<a href="#l1.322"></a><span id="l1.322">       Cu.reportError(&quot;Attempted to create a duplicate account!&quot;);</span>
<a href="#l1.323"></a><span id="l1.323" class="difflineat">@@ -1072,17 +1077,17 @@ AccountsService.prototype = {</span>
<a href="#l1.324"></a><span id="l1.324">     account.remove();</span>
<a href="#l1.325"></a><span id="l1.325">     this._accounts.splice(index, 1);</span>
<a href="#l1.326"></a><span id="l1.326">     delete this._accountsById[id];</span>
<a href="#l1.327"></a><span id="l1.327">     Services.obs.notifyObservers(account, &quot;account-removed&quot;, null);</span>
<a href="#l1.328"></a><span id="l1.328"> </span>
<a href="#l1.329"></a><span id="l1.329">     /* Update the account list pref. */</span>
<a href="#l1.330"></a><span id="l1.330">     let list = this._accountList;</span>
<a href="#l1.331"></a><span id="l1.331">     this._accountList =</span>
<a href="#l1.332"></a><span id="l1.332" class="difflineminus">-      list.split(&quot;,&quot;).filter(function (k) k.trim() != aAccountId).join(&quot;,&quot;);</span>
<a href="#l1.333"></a><span id="l1.333" class="difflineplus">+      list.split(&quot;,&quot;).filter(k =&gt; k.trim() != aAccountId).join(&quot;,&quot;);</span>
<a href="#l1.334"></a><span id="l1.334">   },</span>
<a href="#l1.335"></a><span id="l1.335"> </span>
<a href="#l1.336"></a><span id="l1.336">   QueryInterface: XPCOMUtils.generateQI([Ci.imIAccountsService]),</span>
<a href="#l1.337"></a><span id="l1.337">   classDescription: &quot;Accounts&quot;,</span>
<a href="#l1.338"></a><span id="l1.338">   classID: Components.ID(&quot;{a94b5427-cd8d-40cf-b47e-b67671953e70}&quot;),</span>
<a href="#l1.339"></a><span id="l1.339">   contractID: &quot;@mozilla.org/chat/accounts-service;1&quot;</span>
<a href="#l1.340"></a><span id="l1.340"> };</span>
<a href="#l1.341"></a><span id="l1.341"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/chat/components/src/imCommands.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/chat/components/src/imCommands.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -2,40 +2,40 @@</span>
<a href="#l2.4"></a><span id="l2.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.5"></a><span id="l2.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> const {classes: Cc, interfaces: Ci, results: Cr, utils: Cu} = Components;</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9"> Cu.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l2.10"></a><span id="l2.10"> Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, function()</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l2.14"></a><span id="l2.14">   l10nHelper(&quot;chrome://chat/locale/commands.properties&quot;)</span>
<a href="#l2.15"></a><span id="l2.15"> );</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17"> function CommandsService() { }</span>
<a href="#l2.18"></a><span id="l2.18"> CommandsService.prototype = {</span>
<a href="#l2.19"></a><span id="l2.19">   initCommands: function() {</span>
<a href="#l2.20"></a><span id="l2.20">     this._commands = {};</span>
<a href="#l2.21"></a><span id="l2.21">     // The say command is directly implemented in the UI layer, but has a</span>
<a href="#l2.22"></a><span id="l2.22">     // dummy command registered here so it shows up as a command (e.g. when</span>
<a href="#l2.23"></a><span id="l2.23">     // using the /help command).</span>
<a href="#l2.24"></a><span id="l2.24">     this.registerCommand({</span>
<a href="#l2.25"></a><span id="l2.25">       name: &quot;say&quot;,</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-      get helpString() _(&quot;sayHelpString&quot;),</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+      get helpString() { return _(&quot;sayHelpString&quot;); },</span>
<a href="#l2.28"></a><span id="l2.28">       usageContext: Ci.imICommand.CMD_CONTEXT_ALL,</span>
<a href="#l2.29"></a><span id="l2.29">       priority: Ci.imICommand.CMD_PRIORITY_HIGH,</span>
<a href="#l2.30"></a><span id="l2.30">       run: function(aMsg, aConv) {</span>
<a href="#l2.31"></a><span id="l2.31">         throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l2.32"></a><span id="l2.32">       }</span>
<a href="#l2.33"></a><span id="l2.33">     });</span>
<a href="#l2.34"></a><span id="l2.34"> </span>
<a href="#l2.35"></a><span id="l2.35">     this.registerCommand({</span>
<a href="#l2.36"></a><span id="l2.36">       name: &quot;raw&quot;,</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-      get helpString() _(&quot;rawHelpString&quot;),</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+      get helpString() { return _(&quot;rawHelpString&quot;); },</span>
<a href="#l2.39"></a><span id="l2.39">       usageContext: Ci.imICommand.CMD_CONTEXT_ALL,</span>
<a href="#l2.40"></a><span id="l2.40">       priority: Ci.imICommand.CMD_PRIORITY_DEFAULT,</span>
<a href="#l2.41"></a><span id="l2.41">       run: function(aMsg, aConv) {</span>
<a href="#l2.42"></a><span id="l2.42">         let conv = Services.conversations.getUIConversation(aConv);</span>
<a href="#l2.43"></a><span id="l2.43">         if (!conv)</span>
<a href="#l2.44"></a><span id="l2.44">           return false;</span>
<a href="#l2.45"></a><span id="l2.45">         conv.sendMsg(aMsg);</span>
<a href="#l2.46"></a><span id="l2.46">         return true;</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineat">@@ -43,33 +43,33 @@ CommandsService.prototype = {</span>
<a href="#l2.48"></a><span id="l2.48">     });</span>
<a href="#l2.49"></a><span id="l2.49"> </span>
<a href="#l2.50"></a><span id="l2.50">     this.registerCommand({</span>
<a href="#l2.51"></a><span id="l2.51">       // Reference the command service so we can use the internal properties</span>
<a href="#l2.52"></a><span id="l2.52">       // directly.</span>
<a href="#l2.53"></a><span id="l2.53">       cmdSrv: this,</span>
<a href="#l2.54"></a><span id="l2.54"> </span>
<a href="#l2.55"></a><span id="l2.55">       name: &quot;help&quot;,</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-      get helpString() _(&quot;helpHelpString&quot;),</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+      get helpString() { return _(&quot;helpHelpString&quot;); },</span>
<a href="#l2.58"></a><span id="l2.58">       usageContext: Ci.imICommand.CMD_CONTEXT_ALL,</span>
<a href="#l2.59"></a><span id="l2.59">       priority: Ci.imICommand.CMD_PRIORITY_DEFAULT,</span>
<a href="#l2.60"></a><span id="l2.60">       run: function(aMsg, aConv) {</span>
<a href="#l2.61"></a><span id="l2.61">         let conv = Services.conversations.getUIConversation(aConv);</span>
<a href="#l2.62"></a><span id="l2.62">         if (!conv)</span>
<a href="#l2.63"></a><span id="l2.63">           return false;</span>
<a href="#l2.64"></a><span id="l2.64"> </span>
<a href="#l2.65"></a><span id="l2.65">         // Handle when no command is given, list all possible commands that are</span>
<a href="#l2.66"></a><span id="l2.66">         // available for this conversation (alphabetically).</span>
<a href="#l2.67"></a><span id="l2.67">         if (!aMsg) {</span>
<a href="#l2.68"></a><span id="l2.68">           let commands = this.cmdSrv.listCommandsForConversation(aConv, {});</span>
<a href="#l2.69"></a><span id="l2.69">           if (!commands.length)</span>
<a href="#l2.70"></a><span id="l2.70">             return false;</span>
<a href="#l2.71"></a><span id="l2.71"> </span>
<a href="#l2.72"></a><span id="l2.72">           // Concatenate the command names (separated by a comma and space).</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineminus">-          let cmds = commands.map(function(aCmd) aCmd.name).sort().join(&quot;, &quot;);</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+          let cmds = commands.map(aCmd =&gt; aCmd.name).sort().join(&quot;, &quot;);</span>
<a href="#l2.75"></a><span id="l2.75">           let message = _(&quot;commands&quot;, cmds);</span>
<a href="#l2.76"></a><span id="l2.76"> </span>
<a href="#l2.77"></a><span id="l2.77">           // Display the message</span>
<a href="#l2.78"></a><span id="l2.78">           conv.systemMessage(message);</span>
<a href="#l2.79"></a><span id="l2.79">           return true;</span>
<a href="#l2.80"></a><span id="l2.80">         }</span>
<a href="#l2.81"></a><span id="l2.81"> </span>
<a href="#l2.82"></a><span id="l2.82">         // A command name was given, find the commands that match.</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineat">@@ -102,17 +102,17 @@ CommandsService.prototype = {</span>
<a href="#l2.84"></a><span id="l2.84">       busy: &quot;UNAVAILABLE&quot;,</span>
<a href="#l2.85"></a><span id="l2.85">       dnd: &quot;UNAVAILABLE&quot;,</span>
<a href="#l2.86"></a><span id="l2.86">       offline: &quot;OFFLINE&quot;</span>
<a href="#l2.87"></a><span id="l2.87">     };</span>
<a href="#l2.88"></a><span id="l2.88">     for (let cmd in status) {</span>
<a href="#l2.89"></a><span id="l2.89">       let statusValue = Ci.imIStatusInfo[&quot;STATUS_&quot; + status[cmd]];</span>
<a href="#l2.90"></a><span id="l2.90">       this.registerCommand({</span>
<a href="#l2.91"></a><span id="l2.91">         name: cmd,</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineminus">-        get helpString() _(&quot;statusCommand&quot;, this.name, _(this.name)),</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+        get helpString() { return _(&quot;statusCommand&quot;, this.name, _(this.name)); },</span>
<a href="#l2.94"></a><span id="l2.94">         usageContext: Ci.imICommand.CMD_CONTEXT_ALL,</span>
<a href="#l2.95"></a><span id="l2.95">         priority: Ci.imICommand.CMD_PRIORITY_HIGH,</span>
<a href="#l2.96"></a><span id="l2.96">         run: function(aMsg) {</span>
<a href="#l2.97"></a><span id="l2.97">           Services.core.globalUserStatus.setStatus(statusValue, aMsg);</span>
<a href="#l2.98"></a><span id="l2.98">           return true;</span>
<a href="#l2.99"></a><span id="l2.99">         }</span>
<a href="#l2.100"></a><span id="l2.100">       });</span>
<a href="#l2.101"></a><span id="l2.101">     }</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineat">@@ -167,17 +167,17 @@ CommandsService.prototype = {</span>
<a href="#l2.103"></a><span id="l2.103">         result.push(commands[aPrplId]);</span>
<a href="#l2.104"></a><span id="l2.104">     }</span>
<a href="#l2.105"></a><span id="l2.105">     commandCount.value = result.length;</span>
<a href="#l2.106"></a><span id="l2.106">     return result;</span>
<a href="#l2.107"></a><span id="l2.107">   },</span>
<a href="#l2.108"></a><span id="l2.108">   _usageContextFilter: function(aConversation) {</span>
<a href="#l2.109"></a><span id="l2.109">     let usageContext =</span>
<a href="#l2.110"></a><span id="l2.110">       Ci.imICommand[&quot;CMD_CONTEXT_&quot; + (aConversation.isChat ? &quot;CHAT&quot; : &quot;IM&quot;)];</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineminus">-    return function(c) c.usageContext &amp; usageContext;</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineplus">+    return c =&gt; c.usageContext &amp; usageContext;</span>
<a href="#l2.113"></a><span id="l2.113">   },</span>
<a href="#l2.114"></a><span id="l2.114">   _findCommands: function(aConversation, aName) {</span>
<a href="#l2.115"></a><span id="l2.115">     let prplId = null;</span>
<a href="#l2.116"></a><span id="l2.116">     if (aConversation) {</span>
<a href="#l2.117"></a><span id="l2.117">       let account = aConversation.account;</span>
<a href="#l2.118"></a><span id="l2.118">       if (account.connected)</span>
<a href="#l2.119"></a><span id="l2.119">         prplId = account.protocol.id;</span>
<a href="#l2.120"></a><span id="l2.120">     }</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineat">@@ -217,17 +217,17 @@ CommandsService.prototype = {</span>
<a href="#l2.122"></a><span id="l2.122">       // If we have found a second matching command name, return the empty array.</span>
<a href="#l2.123"></a><span id="l2.123">       if (cmdArray.length)</span>
<a href="#l2.124"></a><span id="l2.124">         return [];</span>
<a href="#l2.125"></a><span id="l2.125"> </span>
<a href="#l2.126"></a><span id="l2.126">       cmdArray = matches;</span>
<a href="#l2.127"></a><span id="l2.127">     }</span>
<a href="#l2.128"></a><span id="l2.128"> </span>
<a href="#l2.129"></a><span id="l2.129">     // Sort the matching commands by priority before returning the array.</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineminus">-    return cmdArray.sort(function(a, b) b.priority - a.priority);</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineplus">+    return cmdArray.sort((a, b) =&gt; b.priority - a.priority);</span>
<a href="#l2.132"></a><span id="l2.132">   },</span>
<a href="#l2.133"></a><span id="l2.133">   executeCommand: function(aMessage, aConversation, aReturnedConv) {</span>
<a href="#l2.134"></a><span id="l2.134">     if (!aMessage)</span>
<a href="#l2.135"></a><span id="l2.135">       throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l2.136"></a><span id="l2.136"> </span>
<a href="#l2.137"></a><span id="l2.137">     let matchResult;</span>
<a href="#l2.138"></a><span id="l2.138">     if (aMessage[0] != &quot;/&quot; ||</span>
<a href="#l2.139"></a><span id="l2.139">         !(matchResult = /^\/([a-z]+)(?: |$)([\s\S]*)/.exec(aMessage)))</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/chat/components/src/imContacts.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/chat/components/src/imContacts.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,17 +1,17 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.5"></a><span id="l3.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.6"></a><span id="l3.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> const {classes: Cc, interfaces: Ci, utils: Cu, results: Cr} = Components;</span>
<a href="#l3.9"></a><span id="l3.9"> Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l3.10"></a><span id="l3.10"> Cu.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, function()</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l3.14"></a><span id="l3.14">   l10nHelper(&quot;chrome://chat/locale/contacts.properties&quot;)</span>
<a href="#l3.15"></a><span id="l3.15"> );</span>
<a href="#l3.16"></a><span id="l3.16"> </span>
<a href="#l3.17"></a><span id="l3.17"> var gDBConnection = null;</span>
<a href="#l3.18"></a><span id="l3.18"> </span>
<a href="#l3.19"></a><span id="l3.19"> function executeAsyncThenFinalize(statement)</span>
<a href="#l3.20"></a><span id="l3.20"> {</span>
<a href="#l3.21"></a><span id="l3.21">   statement.executeAsync();</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -112,18 +112,18 @@ this.__defineGetter__(&quot;DBConn&quot;, function</span>
<a href="#l3.23"></a><span id="l3.23">     gDBConnWithPendingTransaction.commitTransaction();</span>
<a href="#l3.24"></a><span id="l3.24">     gDBConnWithPendingTransaction = null;</span>
<a href="#l3.25"></a><span id="l3.25">   });</span>
<a href="#l3.26"></a><span id="l3.26">   return gDBConnection;</span>
<a href="#l3.27"></a><span id="l3.27"> });</span>
<a href="#l3.28"></a><span id="l3.28"> </span>
<a href="#l3.29"></a><span id="l3.29"> function TagsService() { }</span>
<a href="#l3.30"></a><span id="l3.30"> TagsService.prototype = {</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-  get wrappedJSObject() this,</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-  get defaultTag() this.createTag(_(&quot;defaultGroup&quot;)),</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+  get wrappedJSObject() { return this; },</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+  get defaultTag() { return this.createTag(_(&quot;defaultGroup&quot;)); },</span>
<a href="#l3.35"></a><span id="l3.35">   createTag: function(aName) {</span>
<a href="#l3.36"></a><span id="l3.36">     // If the tag already exists, we don't want to create a duplicate.</span>
<a href="#l3.37"></a><span id="l3.37">     let tag = this.getTagByName(aName);</span>
<a href="#l3.38"></a><span id="l3.38">     if (tag)</span>
<a href="#l3.39"></a><span id="l3.39">       return tag;</span>
<a href="#l3.40"></a><span id="l3.40"> </span>
<a href="#l3.41"></a><span id="l3.41">     let statement = DBConn.createStatement(&quot;INSERT INTO tags (name, position) VALUES(:name, 0)&quot;);</span>
<a href="#l3.42"></a><span id="l3.42">     try {</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineat">@@ -133,43 +133,43 @@ TagsService.prototype = {</span>
<a href="#l3.44"></a><span id="l3.44">       statement.finalize();</span>
<a href="#l3.45"></a><span id="l3.45">     }</span>
<a href="#l3.46"></a><span id="l3.46"> </span>
<a href="#l3.47"></a><span id="l3.47">     tag = new Tag(DBConn.lastInsertRowID, aName);</span>
<a href="#l3.48"></a><span id="l3.48">     Tags.push(tag);</span>
<a href="#l3.49"></a><span id="l3.49">     return tag;</span>
<a href="#l3.50"></a><span id="l3.50">   },</span>
<a href="#l3.51"></a><span id="l3.51">   // Get an existing tag by (numeric) id. Returns null if not found.</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-  getTagById: function(aId) TagsById[aId],</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+  getTagById: aId =&gt; TagsById[aId],</span>
<a href="#l3.54"></a><span id="l3.54">   // Get an existing tag by name (will do an SQL query). Returns null</span>
<a href="#l3.55"></a><span id="l3.55">   // if not found.</span>
<a href="#l3.56"></a><span id="l3.56">   getTagByName: function(aName) {</span>
<a href="#l3.57"></a><span id="l3.57">     let statement = DBConn.createStatement(&quot;SELECT id FROM tags where name = :name&quot;);</span>
<a href="#l3.58"></a><span id="l3.58">     statement.params.name = aName;</span>
<a href="#l3.59"></a><span id="l3.59">     try {</span>
<a href="#l3.60"></a><span id="l3.60">       if (!statement.executeStep())</span>
<a href="#l3.61"></a><span id="l3.61">         return null;</span>
<a href="#l3.62"></a><span id="l3.62">       return this.getTagById(statement.row.id);</span>
<a href="#l3.63"></a><span id="l3.63">     } finally {</span>
<a href="#l3.64"></a><span id="l3.64">       statement.finalize();</span>
<a href="#l3.65"></a><span id="l3.65">     }</span>
<a href="#l3.66"></a><span id="l3.66">   },</span>
<a href="#l3.67"></a><span id="l3.67">   // Get an array of all existing tags.</span>
<a href="#l3.68"></a><span id="l3.68">   getTags: function(aTagCount) {</span>
<a href="#l3.69"></a><span id="l3.69">     if (Tags.length)</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-      Tags.sort(function(a, b) a.name.toLowerCase().localeCompare(b.name.toLowerCase()));</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+      Tags.sort((a, b) =&gt; a.name.toLowerCase().localeCompare(b.name.toLowerCase()));</span>
<a href="#l3.72"></a><span id="l3.72">     else</span>
<a href="#l3.73"></a><span id="l3.73">       this.defaultTag;</span>
<a href="#l3.74"></a><span id="l3.74"> </span>
<a href="#l3.75"></a><span id="l3.75">     if (aTagCount)</span>
<a href="#l3.76"></a><span id="l3.76">       aTagCount.value = Tags.length;</span>
<a href="#l3.77"></a><span id="l3.77">     return Tags;</span>
<a href="#l3.78"></a><span id="l3.78">   },</span>
<a href="#l3.79"></a><span id="l3.79"> </span>
<a href="#l3.80"></a><span id="l3.80" class="difflineminus">-  isTagHidden: function(aTag) aTag.id in otherContactsTag._hiddenTags,</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+  isTagHidden: aTag =&gt; aTag.id in otherContactsTag._hiddenTags,</span>
<a href="#l3.82"></a><span id="l3.82">   hideTag: function(aTag) { otherContactsTag.hideTag(aTag); },</span>
<a href="#l3.83"></a><span id="l3.83">   showTag: function(aTag) { otherContactsTag.showTag(aTag); },</span>
<a href="#l3.84"></a><span id="l3.84">   get otherContactsTag() {</span>
<a href="#l3.85"></a><span id="l3.85">     otherContactsTag._initContacts();</span>
<a href="#l3.86"></a><span id="l3.86">     return otherContactsTag;</span>
<a href="#l3.87"></a><span id="l3.87">   },</span>
<a href="#l3.88"></a><span id="l3.88"> </span>
<a href="#l3.89"></a><span id="l3.89">   QueryInterface: XPCOMUtils.generateQI([Ci.imITagsService]),</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineat">@@ -186,33 +186,33 @@ function Tag(aId, aName) {</span>
<a href="#l3.91"></a><span id="l3.91">   this._id = aId;</span>
<a href="#l3.92"></a><span id="l3.92">   this._name = aName;</span>
<a href="#l3.93"></a><span id="l3.93">   this._contacts = [];</span>
<a href="#l3.94"></a><span id="l3.94">   this._observers = [];</span>
<a href="#l3.95"></a><span id="l3.95"> </span>
<a href="#l3.96"></a><span id="l3.96">   TagsById[this.id] = this;</span>
<a href="#l3.97"></a><span id="l3.97"> }</span>
<a href="#l3.98"></a><span id="l3.98"> Tag.prototype = {</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineminus">-  get id() this._id,</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineminus">-  get name() this._name,</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+  get id() { return this._id; },</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+  get name() { return this._name; },</span>
<a href="#l3.103"></a><span id="l3.103">   set name(aNewName) {</span>
<a href="#l3.104"></a><span id="l3.104">     let statement = DBConn.createStatement(&quot;UPDATE tags SET name = :name WHERE id = :id&quot;);</span>
<a href="#l3.105"></a><span id="l3.105">     try {</span>
<a href="#l3.106"></a><span id="l3.106">       statement.params.name = aNewName;</span>
<a href="#l3.107"></a><span id="l3.107">       statement.params.id = this._id;</span>
<a href="#l3.108"></a><span id="l3.108">       statement.execute();</span>
<a href="#l3.109"></a><span id="l3.109">     } finally {</span>
<a href="#l3.110"></a><span id="l3.110">       statement.finalize();</span>
<a href="#l3.111"></a><span id="l3.111">     }</span>
<a href="#l3.112"></a><span id="l3.112"> </span>
<a href="#l3.113"></a><span id="l3.113">     //FIXME move the account buddies if some use this tag as their group</span>
<a href="#l3.114"></a><span id="l3.114">     return aNewName;</span>
<a href="#l3.115"></a><span id="l3.115">   },</span>
<a href="#l3.116"></a><span id="l3.116">   getContacts: function(aContactCount) {</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineminus">-    let contacts = this._contacts.filter(function(c) !c._empty);</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+    let contacts = this._contacts.filter(c =&gt; !c._empty);</span>
<a href="#l3.119"></a><span id="l3.119">     if (aContactCount)</span>
<a href="#l3.120"></a><span id="l3.120">       aContactCount.value = contacts.length;</span>
<a href="#l3.121"></a><span id="l3.121">     return contacts;</span>
<a href="#l3.122"></a><span id="l3.122">   },</span>
<a href="#l3.123"></a><span id="l3.123">   _addContact: function (aContact) {</span>
<a href="#l3.124"></a><span id="l3.124">     this._contacts.push(aContact);</span>
<a href="#l3.125"></a><span id="l3.125">   },</span>
<a href="#l3.126"></a><span id="l3.126">   _removeContact: function (aContact) {</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineat">@@ -221,29 +221,29 @@ Tag.prototype = {</span>
<a href="#l3.128"></a><span id="l3.128">       this._contacts.splice(index, 1);</span>
<a href="#l3.129"></a><span id="l3.129">   },</span>
<a href="#l3.130"></a><span id="l3.130"> </span>
<a href="#l3.131"></a><span id="l3.131">   addObserver: function(aObserver) {</span>
<a href="#l3.132"></a><span id="l3.132">     if (this._observers.indexOf(aObserver) == -1)</span>
<a href="#l3.133"></a><span id="l3.133">       this._observers.push(aObserver);</span>
<a href="#l3.134"></a><span id="l3.134">   },</span>
<a href="#l3.135"></a><span id="l3.135">   removeObserver: function(aObserver) {</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineminus">-    this._observers = this._observers.filter(function(o) o !== aObserver);</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineplus">+    this._observers = this._observers.filter(o =&gt; o !== aObserver);</span>
<a href="#l3.138"></a><span id="l3.138">   },</span>
<a href="#l3.139"></a><span id="l3.139">   notifyObservers: function(aSubject, aTopic, aData) {</span>
<a href="#l3.140"></a><span id="l3.140">     for each (let observer in this._observers)</span>
<a href="#l3.141"></a><span id="l3.141">       observer.observe(aSubject, aTopic, aData);</span>
<a href="#l3.142"></a><span id="l3.142">   },</span>
<a href="#l3.143"></a><span id="l3.143"> </span>
<a href="#l3.144"></a><span id="l3.144">   getInterfaces: function(countRef) {</span>
<a href="#l3.145"></a><span id="l3.145">     let interfaces = [Ci.nsIClassInfo, Ci.nsISupports, Ci.imITag];</span>
<a href="#l3.146"></a><span id="l3.146">     countRef.value = interfaces.length;</span>
<a href="#l3.147"></a><span id="l3.147">     return interfaces;</span>
<a href="#l3.148"></a><span id="l3.148">   },</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineminus">-  getHelperForLanguage: function(language) null,</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineplus">+  getHelperForLanguage: language =&gt; null,</span>
<a href="#l3.151"></a><span id="l3.151">   implementationLanguage: Ci.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l3.152"></a><span id="l3.152">   flags: 0,</span>
<a href="#l3.153"></a><span id="l3.153">   QueryInterface: XPCOMUtils.generateQI([Ci.imITag, Ci.nsIClassInfo])</span>
<a href="#l3.154"></a><span id="l3.154"> };</span>
<a href="#l3.155"></a><span id="l3.155"> </span>
<a href="#l3.156"></a><span id="l3.156"> </span>
<a href="#l3.157"></a><span id="l3.157"> var otherContactsTag = {</span>
<a href="#l3.158"></a><span id="l3.158">   hiddenTagsPref: &quot;messenger.buddies.hiddenTags&quot;,</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineat">@@ -252,17 +252,17 @@ var otherContactsTag = {</span>
<a href="#l3.160"></a><span id="l3.160">   _saveHiddenTagsPref: function() {</span>
<a href="#l3.161"></a><span id="l3.161">     Services.prefs.setCharPref(this.hiddenTagsPref,</span>
<a href="#l3.162"></a><span id="l3.162">                                [id for (id in this._hiddenTags)].join(&quot;,&quot;));</span>
<a href="#l3.163"></a><span id="l3.163">   },</span>
<a href="#l3.164"></a><span id="l3.164">   showTag: function(aTag) {</span>
<a href="#l3.165"></a><span id="l3.165">     let id = aTag.id;</span>
<a href="#l3.166"></a><span id="l3.166">     delete this._hiddenTags[id];</span>
<a href="#l3.167"></a><span id="l3.167">     for each (let contact in this._contacts)</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineminus">-      if (contact.getTags().some(function(t) t.id == id))</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineplus">+      if (contact.getTags().some(t =&gt; t.id == id))</span>
<a href="#l3.170"></a><span id="l3.170">         this._removeContact(contact);</span>
<a href="#l3.171"></a><span id="l3.171"> </span>
<a href="#l3.172"></a><span id="l3.172">     aTag.notifyObservers(aTag, &quot;tag-shown&quot;, null);</span>
<a href="#l3.173"></a><span id="l3.173">     Services.obs.notifyObservers(aTag, &quot;tag-shown&quot;, null);</span>
<a href="#l3.174"></a><span id="l3.174">     this._saveHiddenTagsPref();</span>
<a href="#l3.175"></a><span id="l3.175">   },</span>
<a href="#l3.176"></a><span id="l3.176">   hideTag: function(aTag) {</span>
<a href="#l3.177"></a><span id="l3.177">     if (aTag.id &lt; 0 || aTag.id in otherContactsTag._hiddenTags)</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineat">@@ -274,25 +274,25 @@ var otherContactsTag = {</span>
<a href="#l3.179"></a><span id="l3.179"> </span>
<a href="#l3.180"></a><span id="l3.180">     aTag.notifyObservers(aTag, &quot;tag-hidden&quot;, null);</span>
<a href="#l3.181"></a><span id="l3.181">     Services.obs.notifyObservers(aTag, &quot;tag-hidden&quot;, null);</span>
<a href="#l3.182"></a><span id="l3.182">     this._saveHiddenTagsPref();</span>
<a href="#l3.183"></a><span id="l3.183">   },</span>
<a href="#l3.184"></a><span id="l3.184">   _hideTag: function(aTag) {</span>
<a href="#l3.185"></a><span id="l3.185">     for each (let contact in aTag.getContacts())</span>
<a href="#l3.186"></a><span id="l3.186">       if (!(contact.id in this._contacts) &amp;&amp;</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineminus">-          contact.getTags().every(function(t) t.id in this._hiddenTags, this))</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineplus">+          contact.getTags().every(t =&gt; t.id in this._hiddenTags))</span>
<a href="#l3.189"></a><span id="l3.189">         this._addContact(contact);</span>
<a href="#l3.190"></a><span id="l3.190">   },</span>
<a href="#l3.191"></a><span id="l3.191">   observe: function(aSubject, aTopic, aData) {</span>
<a href="#l3.192"></a><span id="l3.192">     aSubject.QueryInterface(Ci.imIContact);</span>
<a href="#l3.193"></a><span id="l3.193">     if (aTopic == &quot;contact-tag-removed&quot; || aTopic == &quot;contact-added&quot;) {</span>
<a href="#l3.194"></a><span id="l3.194">       if (!(aSubject.id in this._contacts) &amp;&amp;</span>
<a href="#l3.195"></a><span id="l3.195">           !(parseInt(aData) in this._hiddenTags) &amp;&amp;</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineminus">-          aSubject.getTags().every(function(t) t.id in this._hiddenTags, this))</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineplus">+          aSubject.getTags().every(t =&gt; t.id in this._hiddenTags))</span>
<a href="#l3.198"></a><span id="l3.198">         this._addContact(aSubject);</span>
<a href="#l3.199"></a><span id="l3.199">     }</span>
<a href="#l3.200"></a><span id="l3.200">     else if (aSubject.id in this._contacts &amp;&amp;</span>
<a href="#l3.201"></a><span id="l3.201">              (aTopic == &quot;contact-removed&quot; ||</span>
<a href="#l3.202"></a><span id="l3.202">               (aTopic == &quot;contact-tag-added&quot; &amp;&amp;</span>
<a href="#l3.203"></a><span id="l3.203">               !(parseInt(aData) in this._hiddenTags))))</span>
<a href="#l3.204"></a><span id="l3.204">       this._removeContact(aSubject);</span>
<a href="#l3.205"></a><span id="l3.205">   },</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineat">@@ -323,18 +323,18 @@ var otherContactsTag = {</span>
<a href="#l3.207"></a><span id="l3.207">       this._hideTag(tag);</span>
<a href="#l3.208"></a><span id="l3.208">     Services.obs.addObserver(this, &quot;contact-tag-added&quot;, false);</span>
<a href="#l3.209"></a><span id="l3.209">     Services.obs.addObserver(this, &quot;contact-tag-removed&quot;, false);</span>
<a href="#l3.210"></a><span id="l3.210">     Services.obs.addObserver(this, &quot;contact-added&quot;, false);</span>
<a href="#l3.211"></a><span id="l3.211">     Services.obs.addObserver(this, &quot;contact-removed&quot;, false);</span>
<a href="#l3.212"></a><span id="l3.212">   },</span>
<a href="#l3.213"></a><span id="l3.213"> </span>
<a href="#l3.214"></a><span id="l3.214">   // imITag implementation</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineminus">-  get id() -1,</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineminus">-  get name() &quot;__others__&quot;,</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineplus">+  get id() { return -1; },</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineplus">+  get name() { return &quot;__others__&quot;; },</span>
<a href="#l3.219"></a><span id="l3.219">   set name(aNewName) { throw Cr.NS_ERROR_NOT_AVAILABLE; },</span>
<a href="#l3.220"></a><span id="l3.220">   getContacts: function(aContactCount) {</span>
<a href="#l3.221"></a><span id="l3.221">     let contacts = [contact for each (contact in this._contacts)];</span>
<a href="#l3.222"></a><span id="l3.222">     if (aContactCount)</span>
<a href="#l3.223"></a><span id="l3.223">       aContactCount.value = contacts.length;</span>
<a href="#l3.224"></a><span id="l3.224">     return contacts;</span>
<a href="#l3.225"></a><span id="l3.225">   },</span>
<a href="#l3.226"></a><span id="l3.226">   _addContact: function(aContact) {</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineat">@@ -352,29 +352,29 @@ var otherContactsTag = {</span>
<a href="#l3.228"></a><span id="l3.228">       observer.observe(this, &quot;contact-moved-out&quot;, null);</span>
<a href="#l3.229"></a><span id="l3.229">   },</span>
<a href="#l3.230"></a><span id="l3.230"> </span>
<a href="#l3.231"></a><span id="l3.231">   addObserver: function(aObserver) {</span>
<a href="#l3.232"></a><span id="l3.232">     if (this._observers.indexOf(aObserver) == -1)</span>
<a href="#l3.233"></a><span id="l3.233">       this._observers.push(aObserver);</span>
<a href="#l3.234"></a><span id="l3.234">   },</span>
<a href="#l3.235"></a><span id="l3.235">   removeObserver: function(aObserver) {</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineminus">-    this._observers = this._observers.filter(function(o) o !== aObserver);</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineplus">+    this._observers = this._observers.filter(o =&gt; o !== aObserver);</span>
<a href="#l3.238"></a><span id="l3.238">   },</span>
<a href="#l3.239"></a><span id="l3.239">   notifyObservers: function(aSubject, aTopic, aData) {</span>
<a href="#l3.240"></a><span id="l3.240">     for each (let observer in this._observers)</span>
<a href="#l3.241"></a><span id="l3.241">       observer.observe(aSubject, aTopic, aData);</span>
<a href="#l3.242"></a><span id="l3.242">   },</span>
<a href="#l3.243"></a><span id="l3.243"> </span>
<a href="#l3.244"></a><span id="l3.244">   getInterfaces: function(countRef) {</span>
<a href="#l3.245"></a><span id="l3.245">     let interfaces = [Ci.nsIClassInfo, Ci.nsISupports, Ci.nsIObserver, Ci.imITag];</span>
<a href="#l3.246"></a><span id="l3.246">     countRef.value = interfaces.length;</span>
<a href="#l3.247"></a><span id="l3.247">     return interfaces;</span>
<a href="#l3.248"></a><span id="l3.248">   },</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineminus">-  getHelperForLanguage: function(language) null,</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineplus">+  getHelperForLanguage: language =&gt; null,</span>
<a href="#l3.251"></a><span id="l3.251">   implementationLanguage: Ci.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l3.252"></a><span id="l3.252">   flags: 0,</span>
<a href="#l3.253"></a><span id="l3.253">   QueryInterface: XPCOMUtils.generateQI([Ci.imITag, Ci.nsIObserver, Ci.nsIClassInfo])</span>
<a href="#l3.254"></a><span id="l3.254"> };</span>
<a href="#l3.255"></a><span id="l3.255"> </span>
<a href="#l3.256"></a><span id="l3.256"> </span>
<a href="#l3.257"></a><span id="l3.257"> var ContactsById = { };</span>
<a href="#l3.258"></a><span id="l3.258"> var LastDummyContactId = 0;</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineat">@@ -385,18 +385,18 @@ function Contact(aId, aAlias) {</span>
<a href="#l3.260"></a><span id="l3.260">   this._tags = [];</span>
<a href="#l3.261"></a><span id="l3.261">   this._buddies = [];</span>
<a href="#l3.262"></a><span id="l3.262">   this._observers = [];</span>
<a href="#l3.263"></a><span id="l3.263"> </span>
<a href="#l3.264"></a><span id="l3.264">   ContactsById[this._id] = this;</span>
<a href="#l3.265"></a><span id="l3.265"> }</span>
<a href="#l3.266"></a><span id="l3.266"> Contact.prototype = {</span>
<a href="#l3.267"></a><span id="l3.267">   _id: 0,</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineminus">-  get id() this._id,</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineminus">-  get alias() this._alias,</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineplus">+  get id() { return this._id; },</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineplus">+  get alias() { return this._alias; },</span>
<a href="#l3.272"></a><span id="l3.272">   set alias(aNewAlias) {</span>
<a href="#l3.273"></a><span id="l3.273">     this._ensureNotDummy();</span>
<a href="#l3.274"></a><span id="l3.274"> </span>
<a href="#l3.275"></a><span id="l3.275">     let statement = DBConn.createStatement(&quot;UPDATE contacts SET alias = :alias WHERE id = :id&quot;);</span>
<a href="#l3.276"></a><span id="l3.276">     statement.params.alias = aNewAlias;</span>
<a href="#l3.277"></a><span id="l3.277">     statement.params.id = this._id;</span>
<a href="#l3.278"></a><span id="l3.278">     executeAsyncThenFinalize(statement);</span>
<a href="#l3.279"></a><span id="l3.279"> </span>
<a href="#l3.280"></a><span id="l3.280" class="difflineat">@@ -461,49 +461,49 @@ Contact.prototype = {</span>
<a href="#l3.281"></a><span id="l3.281">   },</span>
<a href="#l3.282"></a><span id="l3.282">   /* Remove a tag from the local tags of the contact. */</span>
<a href="#l3.283"></a><span id="l3.283">   _removeTag: function(aTag) {</span>
<a href="#l3.284"></a><span id="l3.284">     if (!this.hasTag(aTag) || this._isTagInherited(aTag))</span>
<a href="#l3.285"></a><span id="l3.285">       return;</span>
<a href="#l3.286"></a><span id="l3.286"> </span>
<a href="#l3.287"></a><span id="l3.287">     this._removeContactTagRow(aTag);</span>
<a href="#l3.288"></a><span id="l3.288"> </span>
<a href="#l3.289"></a><span id="l3.289" class="difflineminus">-    this._tags = this._tags.filter(function(tag) tag.id != aTag.id);</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineplus">+    this._tags = this._tags.filter(tag =&gt; tag.id != aTag.id);</span>
<a href="#l3.291"></a><span id="l3.291">     aTag = TagsById[aTag.id];</span>
<a href="#l3.292"></a><span id="l3.292">     aTag._removeContact(this);</span>
<a href="#l3.293"></a><span id="l3.293"> </span>
<a href="#l3.294"></a><span id="l3.294">     aTag.notifyObservers(this, &quot;contact-moved-out&quot;);</span>
<a href="#l3.295"></a><span id="l3.295">     for each (let observer in this._observers)</span>
<a href="#l3.296"></a><span id="l3.296">       observer.observe(aTag, &quot;contact-moved-out&quot;, null);</span>
<a href="#l3.297"></a><span id="l3.297">     Services.obs.notifyObservers(this, &quot;contact-tag-removed&quot;, aTag.id);</span>
<a href="#l3.298"></a><span id="l3.298">   },</span>
<a href="#l3.299"></a><span id="l3.299">   _removeContactTagRow: function(aTag) {</span>
<a href="#l3.300"></a><span id="l3.300">     let statement = DBConn.createStatement(&quot;DELETE FROM contact_tag &quot; +</span>
<a href="#l3.301"></a><span id="l3.301">                                            &quot;WHERE contact_id = :contactId &quot; +</span>
<a href="#l3.302"></a><span id="l3.302">                                            &quot;AND tag_id = :tagId&quot;);</span>
<a href="#l3.303"></a><span id="l3.303">     statement.params.contactId = this.id;</span>
<a href="#l3.304"></a><span id="l3.304">     statement.params.tagId = aTag.id;</span>
<a href="#l3.305"></a><span id="l3.305">     executeAsyncThenFinalize(statement);</span>
<a href="#l3.306"></a><span id="l3.306">   },</span>
<a href="#l3.307"></a><span id="l3.307" class="difflineminus">-  hasTag: function(aTag) this._tags.some(function (t) t.id == aTag.id),</span>
<a href="#l3.308"></a><span id="l3.308" class="difflineplus">+  hasTag: function(aTag) { return this._tags.some((t =&gt; t.id == aTag.id)); },</span>
<a href="#l3.309"></a><span id="l3.309">   _massMove: false,</span>
<a href="#l3.310"></a><span id="l3.310">   removeTag: function(aTag) {</span>
<a href="#l3.311"></a><span id="l3.311">     if (!this.hasTag(aTag))</span>
<a href="#l3.312"></a><span id="l3.312">       throw &quot;Attempting to remove a tag that the contact doesn't have&quot;;</span>
<a href="#l3.313"></a><span id="l3.313">     if (this._tags.length == 1)</span>
<a href="#l3.314"></a><span id="l3.314">       throw &quot;Attempting to remove the last tag of a contact&quot;;</span>
<a href="#l3.315"></a><span id="l3.315"> </span>
<a href="#l3.316"></a><span id="l3.316">     this._massMove = true;</span>
<a href="#l3.317"></a><span id="l3.317">     let hasTag = this.hasTag.bind(this);</span>
<a href="#l3.318"></a><span id="l3.318">     let newTag = this._tags[this._tags[0].id != aTag.id ? 0 : 1];</span>
<a href="#l3.319"></a><span id="l3.319">     let moved = false;</span>
<a href="#l3.320"></a><span id="l3.320">     this._buddies.forEach(function (aBuddy) {</span>
<a href="#l3.321"></a><span id="l3.321">       aBuddy._accounts.forEach(function (aAccountBuddy) {</span>
<a href="#l3.322"></a><span id="l3.322">         if (aAccountBuddy.tag.id == aTag.id) {</span>
<a href="#l3.323"></a><span id="l3.323" class="difflineminus">-          if (aBuddy._accounts.some(function(ab)</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineplus">+          if (aBuddy._accounts.some(ab =&gt;</span>
<a href="#l3.325"></a><span id="l3.325">                ab.account.numericId == aAccountBuddy.account.numericId &amp;&amp;</span>
<a href="#l3.326"></a><span id="l3.326">                ab.tag.id != aTag.id &amp;&amp; hasTag(ab.tag))) {</span>
<a href="#l3.327"></a><span id="l3.327">             // A buddy that already has an accountBuddy of the same</span>
<a href="#l3.328"></a><span id="l3.328">             // account with another tag of the contact shouldn't be</span>
<a href="#l3.329"></a><span id="l3.329">             // moved to newTag, just remove the accountBuddy</span>
<a href="#l3.330"></a><span id="l3.330">             // associated to the tag we are removing.</span>
<a href="#l3.331"></a><span id="l3.331">             aAccountBuddy.remove();</span>
<a href="#l3.332"></a><span id="l3.332">             moved = true;</span>
<a href="#l3.333"></a><span id="l3.333" class="difflineat">@@ -549,17 +549,17 @@ Contact.prototype = {</span>
<a href="#l3.334"></a><span id="l3.334">     let shouldAdd =</span>
<a href="#l3.335"></a><span id="l3.335">       aNewTag &amp;&amp; !this.hasTag(aNewTag) &amp;&amp; this._isTagInherited(aNewTag);</span>
<a href="#l3.336"></a><span id="l3.336">     if (!shouldRemove &amp;&amp; !shouldAdd)</span>
<a href="#l3.337"></a><span id="l3.337">       return;</span>
<a href="#l3.338"></a><span id="l3.338"> </span>
<a href="#l3.339"></a><span id="l3.339">     // Apply the changes.</span>
<a href="#l3.340"></a><span id="l3.340">     let tags = this._tags;</span>
<a href="#l3.341"></a><span id="l3.341">     if (shouldRemove) {</span>
<a href="#l3.342"></a><span id="l3.342" class="difflineminus">-      tags = tags.filter(function(aTag) aTag.id != aOldTag.id);</span>
<a href="#l3.343"></a><span id="l3.343" class="difflineplus">+      tags = tags.filter(aTag =&gt; aTag.id != aOldTag.id);</span>
<a href="#l3.344"></a><span id="l3.344">       aOldTag._removeContact(this);</span>
<a href="#l3.345"></a><span id="l3.345">     }</span>
<a href="#l3.346"></a><span id="l3.346">     if (shouldAdd) {</span>
<a href="#l3.347"></a><span id="l3.347">       tags.push(aNewTag);</span>
<a href="#l3.348"></a><span id="l3.348">       aNewTag._addContact(this);</span>
<a href="#l3.349"></a><span id="l3.349">     }</span>
<a href="#l3.350"></a><span id="l3.350">     this._tags = tags;</span>
<a href="#l3.351"></a><span id="l3.351"> </span>
<a href="#l3.352"></a><span id="l3.352" class="difflineat">@@ -579,18 +579,20 @@ Contact.prototype = {</span>
<a href="#l3.353"></a><span id="l3.353">     Services.obs.notifyObservers(this, &quot;contact-moved&quot;, null);</span>
<a href="#l3.354"></a><span id="l3.354">   },</span>
<a href="#l3.355"></a><span id="l3.355"> </span>
<a href="#l3.356"></a><span id="l3.356">   getBuddies: function(aBuddyCount) {</span>
<a href="#l3.357"></a><span id="l3.357">     if (aBuddyCount)</span>
<a href="#l3.358"></a><span id="l3.358">       aBuddyCount.value = this._buddies.length;</span>
<a href="#l3.359"></a><span id="l3.359">     return this._buddies;</span>
<a href="#l3.360"></a><span id="l3.360">   },</span>
<a href="#l3.361"></a><span id="l3.361" class="difflineminus">-  get _empty() this._buddies.length == 0 ||</span>
<a href="#l3.362"></a><span id="l3.362" class="difflineminus">-               this._buddies.every(function(b) b._empty),</span>
<a href="#l3.363"></a><span id="l3.363" class="difflineplus">+  get _empty() {</span>
<a href="#l3.364"></a><span id="l3.364" class="difflineplus">+    return this._buddies.length == 0 ||</span>
<a href="#l3.365"></a><span id="l3.365" class="difflineplus">+           this._buddies.every(b =&gt; b._empty);</span>
<a href="#l3.366"></a><span id="l3.366" class="difflineplus">+  },</span>
<a href="#l3.367"></a><span id="l3.367"> </span>
<a href="#l3.368"></a><span id="l3.368">   mergeContact: function(aContact) {</span>
<a href="#l3.369"></a><span id="l3.369">     // Avoid merging the contact with itself or merging into an</span>
<a href="#l3.370"></a><span id="l3.370">     // already removed contact.</span>
<a href="#l3.371"></a><span id="l3.371">     if (aContact.id == this.id || !(this.id in ContactsById))</span>
<a href="#l3.372"></a><span id="l3.372">       throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l3.373"></a><span id="l3.373"> </span>
<a href="#l3.374"></a><span id="l3.374">     this._ensureNotDummy();</span>
<a href="#l3.375"></a><span id="l3.375" class="difflineat">@@ -659,17 +661,17 @@ Contact.prototype = {</span>
<a href="#l3.376"></a><span id="l3.376">       delete this._buddies;</span>
<a href="#l3.377"></a><span id="l3.377">       delete this._observers;</span>
<a href="#l3.378"></a><span id="l3.378">     }</span>
<a href="#l3.379"></a><span id="l3.379">     else {</span>
<a href="#l3.380"></a><span id="l3.380">       let index = this._buddies.indexOf(aBuddy);</span>
<a href="#l3.381"></a><span id="l3.381">       if (index == -1)</span>
<a href="#l3.382"></a><span id="l3.382">         throw &quot;Removing an unknown buddy from contact &quot; + this._id;</span>
<a href="#l3.383"></a><span id="l3.383"> </span>
<a href="#l3.384"></a><span id="l3.384" class="difflineminus">-      this._buddies = this._buddies.filter(function(b) b !== aBuddy);</span>
<a href="#l3.385"></a><span id="l3.385" class="difflineplus">+      this._buddies = this._buddies.filter(b =&gt; b !== aBuddy);</span>
<a href="#l3.386"></a><span id="l3.386"> </span>
<a href="#l3.387"></a><span id="l3.387">       // If we are actually removing the whole contact, don't bother updating</span>
<a href="#l3.388"></a><span id="l3.388">       // the positions or the preferred buddy.</span>
<a href="#l3.389"></a><span id="l3.389">       if (this._massRemove)</span>
<a href="#l3.390"></a><span id="l3.390">         return;</span>
<a href="#l3.391"></a><span id="l3.391"> </span>
<a href="#l3.392"></a><span id="l3.392">       // No position to update if the removed buddy is at the last position.</span>
<a href="#l3.393"></a><span id="l3.393">       if (index &lt; this._buddies.length)</span>
<a href="#l3.394"></a><span id="l3.394" class="difflineat">@@ -812,47 +814,47 @@ Contact.prototype = {</span>
<a href="#l3.395"></a><span id="l3.395">     [this._statusType, this._statusText, this._availabilityDetails] =</span>
<a href="#l3.396"></a><span id="l3.396">       [buddy.statusType, buddy.statusText, buddy.availabilityDetails];</span>
<a href="#l3.397"></a><span id="l3.397"> </span>
<a href="#l3.398"></a><span id="l3.398">     // Fire the notifications.</span>
<a href="#l3.399"></a><span id="l3.399">     notifications.forEach(function(aTopic) {</span>
<a href="#l3.400"></a><span id="l3.400">       this._notifyObservers(aTopic);</span>
<a href="#l3.401"></a><span id="l3.401">     }, this);</span>
<a href="#l3.402"></a><span id="l3.402">   },</span>
<a href="#l3.403"></a><span id="l3.403" class="difflineminus">-  get displayName() this._alias || this.preferredBuddy.displayName,</span>
<a href="#l3.404"></a><span id="l3.404" class="difflineminus">-  get buddyIconFilename() this.preferredBuddy.buddyIconFilename,</span>
<a href="#l3.405"></a><span id="l3.405" class="difflineplus">+  get displayName() { return this._alias || this.preferredBuddy.displayName; },</span>
<a href="#l3.406"></a><span id="l3.406" class="difflineplus">+  get buddyIconFilename() { return this.preferredBuddy.buddyIconFilename; },</span>
<a href="#l3.407"></a><span id="l3.407">   _statusType: 0,</span>
<a href="#l3.408"></a><span id="l3.408" class="difflineminus">-  get statusType() this._statusType,</span>
<a href="#l3.409"></a><span id="l3.409" class="difflineminus">-  get online() this.statusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE,</span>
<a href="#l3.410"></a><span id="l3.410" class="difflineminus">-  get available() this.statusType == Ci.imIStatusInfo.STATUS_AVAILABLE,</span>
<a href="#l3.411"></a><span id="l3.411" class="difflineminus">-  get idle() this.statusType == Ci.imIStatusInfo.STATUS_IDLE,</span>
<a href="#l3.412"></a><span id="l3.412" class="difflineminus">-  get mobile() this.statusType == Ci.imIStatusInfo.STATUS_MOBILE,</span>
<a href="#l3.413"></a><span id="l3.413" class="difflineplus">+  get statusType() { return this._statusType; },</span>
<a href="#l3.414"></a><span id="l3.414" class="difflineplus">+  get online() { return this.statusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE; },</span>
<a href="#l3.415"></a><span id="l3.415" class="difflineplus">+  get available() { return this.statusType == Ci.imIStatusInfo.STATUS_AVAILABLE; },</span>
<a href="#l3.416"></a><span id="l3.416" class="difflineplus">+  get idle() { return this.statusType == Ci.imIStatusInfo.STATUS_IDLE; },</span>
<a href="#l3.417"></a><span id="l3.417" class="difflineplus">+  get mobile() { return this.statusType == Ci.imIStatusInfo.STATUS_MOBILE; },</span>
<a href="#l3.418"></a><span id="l3.418">   _statusText: &quot;&quot;,</span>
<a href="#l3.419"></a><span id="l3.419" class="difflineminus">-  get statusText() this._statusText,</span>
<a href="#l3.420"></a><span id="l3.420" class="difflineplus">+  get statusText() { return this._statusText; },</span>
<a href="#l3.421"></a><span id="l3.421">   _availabilityDetails: 0,</span>
<a href="#l3.422"></a><span id="l3.422" class="difflineminus">-  get availabilityDetails() this._availabilityDetails,</span>
<a href="#l3.423"></a><span id="l3.423" class="difflineminus">-  get canSendMessage() this.preferredBuddy.canSendMessage,</span>
<a href="#l3.424"></a><span id="l3.424" class="difflineplus">+  get availabilityDetails() { return this._availabilityDetails; },</span>
<a href="#l3.425"></a><span id="l3.425" class="difflineplus">+  get canSendMessage() { return this.preferredBuddy.canSendMessage; },</span>
<a href="#l3.426"></a><span id="l3.426">   //XXX should we list the buddies in the tooltip?</span>
<a href="#l3.427"></a><span id="l3.427" class="difflineminus">-  getTooltipInfo: function() this.preferredBuddy.getTooltipInfo(),</span>
<a href="#l3.428"></a><span id="l3.428" class="difflineplus">+  getTooltipInfo: function() { return this.preferredBuddy.getTooltipInfo(); },</span>
<a href="#l3.429"></a><span id="l3.429">   createConversation: function() {</span>
<a href="#l3.430"></a><span id="l3.430">     let uiConv = Services.conversations.getUIConversationByContactId(this.id);</span>
<a href="#l3.431"></a><span id="l3.431">     if (uiConv)</span>
<a href="#l3.432"></a><span id="l3.432">       return uiConv.target;</span>
<a href="#l3.433"></a><span id="l3.433">     return this.preferredBuddy.createConversation();</span>
<a href="#l3.434"></a><span id="l3.434">   },</span>
<a href="#l3.435"></a><span id="l3.435"> </span>
<a href="#l3.436"></a><span id="l3.436">   addObserver: function(aObserver) {</span>
<a href="#l3.437"></a><span id="l3.437">     if (this._observers.indexOf(aObserver) == -1)</span>
<a href="#l3.438"></a><span id="l3.438">       this._observers.push(aObserver);</span>
<a href="#l3.439"></a><span id="l3.439">   },</span>
<a href="#l3.440"></a><span id="l3.440">   removeObserver: function(aObserver) {</span>
<a href="#l3.441"></a><span id="l3.441">     if (!this.hasOwnProperty(&quot;_observers&quot;))</span>
<a href="#l3.442"></a><span id="l3.442">       return;</span>
<a href="#l3.443"></a><span id="l3.443"> </span>
<a href="#l3.444"></a><span id="l3.444" class="difflineminus">-    this._observers = this._observers.filter(function(o) o !== aObserver);</span>
<a href="#l3.445"></a><span id="l3.445" class="difflineplus">+    this._observers = this._observers.filter(o =&gt; o !== aObserver);</span>
<a href="#l3.446"></a><span id="l3.446">   },</span>
<a href="#l3.447"></a><span id="l3.447">   // internal calls + calls from add-ons</span>
<a href="#l3.448"></a><span id="l3.448">   notifyObservers: function(aSubject, aTopic, aData) {</span>
<a href="#l3.449"></a><span id="l3.449">     for each (let observer in this._observers)</span>
<a href="#l3.450"></a><span id="l3.450">       if (&quot;observe&quot; in observer) // avoid failing on destructed XBL bindings...</span>
<a href="#l3.451"></a><span id="l3.451">         observer.observe(aSubject, aTopic, aData);</span>
<a href="#l3.452"></a><span id="l3.452">     for each (let tag in this._tags)</span>
<a href="#l3.453"></a><span id="l3.453">       tag.notifyObservers(aSubject, aTopic, aData);</span>
<a href="#l3.454"></a><span id="l3.454" class="difflineat">@@ -895,17 +897,17 @@ Contact.prototype = {</span>
<a href="#l3.455"></a><span id="l3.455">     }</span>
<a href="#l3.456"></a><span id="l3.456">   },</span>
<a href="#l3.457"></a><span id="l3.457"> </span>
<a href="#l3.458"></a><span id="l3.458">   getInterfaces: function(countRef) {</span>
<a href="#l3.459"></a><span id="l3.459">     let interfaces = [Ci.nsIClassInfo, Ci.nsISupports, Ci.imIContact];</span>
<a href="#l3.460"></a><span id="l3.460">     countRef.value = interfaces.length;</span>
<a href="#l3.461"></a><span id="l3.461">     return interfaces;</span>
<a href="#l3.462"></a><span id="l3.462">   },</span>
<a href="#l3.463"></a><span id="l3.463" class="difflineminus">-  getHelperForLanguage: function(language) null,</span>
<a href="#l3.464"></a><span id="l3.464" class="difflineplus">+  getHelperForLanguage: language =&gt; null,</span>
<a href="#l3.465"></a><span id="l3.465">   implementationLanguage: Ci.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l3.466"></a><span id="l3.466">   flags: 0,</span>
<a href="#l3.467"></a><span id="l3.467">   QueryInterface: XPCOMUtils.generateQI([Ci.imIContact, Ci.nsIClassInfo])</span>
<a href="#l3.468"></a><span id="l3.468"> };</span>
<a href="#l3.469"></a><span id="l3.469"> </span>
<a href="#l3.470"></a><span id="l3.470"> var BuddiesById = { };</span>
<a href="#l3.471"></a><span id="l3.471"> function Buddy(aId, aKey, aName, aSrvAlias, aContactId) {</span>
<a href="#l3.472"></a><span id="l3.472">   this._id = aId;</span>
<a href="#l3.473"></a><span id="l3.473" class="difflineat">@@ -922,30 +924,30 @@ function Buddy(aId, aKey, aName, aSrvAli</span>
<a href="#l3.474"></a><span id="l3.474">   if (!this._contact)</span>
<a href="#l3.475"></a><span id="l3.475">     this._contact = new Contact(null, null);</span>
<a href="#l3.476"></a><span id="l3.476"> </span>
<a href="#l3.477"></a><span id="l3.477">   this._contact._buddies.push(this);</span>
<a href="#l3.478"></a><span id="l3.478"> </span>
<a href="#l3.479"></a><span id="l3.479">   BuddiesById[this._id] = this;</span>
<a href="#l3.480"></a><span id="l3.480"> }</span>
<a href="#l3.481"></a><span id="l3.481"> Buddy.prototype = {</span>
<a href="#l3.482"></a><span id="l3.482" class="difflineminus">-  get id() this._id,</span>
<a href="#l3.483"></a><span id="l3.483" class="difflineplus">+  get id() { return this._id; },</span>
<a href="#l3.484"></a><span id="l3.484">   destroy: function() {</span>
<a href="#l3.485"></a><span id="l3.485">     for each (let ab in this._accounts)</span>
<a href="#l3.486"></a><span id="l3.486">       ab.unInit();</span>
<a href="#l3.487"></a><span id="l3.487">     delete this._accounts;</span>
<a href="#l3.488"></a><span id="l3.488">     delete this._observers;</span>
<a href="#l3.489"></a><span id="l3.489">     delete this._preferredAccount;</span>
<a href="#l3.490"></a><span id="l3.490">   },</span>
<a href="#l3.491"></a><span id="l3.491" class="difflineminus">-  get protocol() this._accounts[0].account.protocol,</span>
<a href="#l3.492"></a><span id="l3.492" class="difflineminus">-  get userName() this._name,</span>
<a href="#l3.493"></a><span id="l3.493" class="difflineminus">-  get normalizedName() this._key,</span>
<a href="#l3.494"></a><span id="l3.494" class="difflineplus">+  get protocol() { return this._accounts[0].account.protocol; },</span>
<a href="#l3.495"></a><span id="l3.495" class="difflineplus">+  get userName() { return this._name; },</span>
<a href="#l3.496"></a><span id="l3.496" class="difflineplus">+  get normalizedName() { return this._key; },</span>
<a href="#l3.497"></a><span id="l3.497">   _srvAlias: &quot;&quot;,</span>
<a href="#l3.498"></a><span id="l3.498">   _contact: null,</span>
<a href="#l3.499"></a><span id="l3.499" class="difflineminus">-  get contact() this._contact,</span>
<a href="#l3.500"></a><span id="l3.500" class="difflineplus">+  get contact() { return this._contact; },</span>
<a href="#l3.501"></a><span id="l3.501">   set contact(aContact) /* not in imIBuddy */ {</span>
<a href="#l3.502"></a><span id="l3.502">     if (aContact.id == this._contact.id)</span>
<a href="#l3.503"></a><span id="l3.503">       throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l3.504"></a><span id="l3.504"> </span>
<a href="#l3.505"></a><span id="l3.505">     this._notifyObservers(&quot;moved-out-of-contact&quot;);</span>
<a href="#l3.506"></a><span id="l3.506">     this._contact._removeBuddy(this);</span>
<a href="#l3.507"></a><span id="l3.507"> </span>
<a href="#l3.508"></a><span id="l3.508">     this._contact = aContact;</span>
<a href="#l3.509"></a><span id="l3.509" class="difflineat">@@ -986,26 +988,26 @@ Buddy.prototype = {</span>
<a href="#l3.510"></a><span id="l3.510">     if (this._contact._tags.indexOf(aTag) == -1) {</span>
<a href="#l3.511"></a><span id="l3.511">       this._contact._tags.push(aTag);</span>
<a href="#l3.512"></a><span id="l3.512">       aTag._addContact(contact);</span>
<a href="#l3.513"></a><span id="l3.513">     }</span>
<a href="#l3.514"></a><span id="l3.514"> </span>
<a href="#l3.515"></a><span id="l3.515">     if (!this._preferredAccount)</span>
<a href="#l3.516"></a><span id="l3.516">       this._preferredAccount = aAccountBuddy;</span>
<a href="#l3.517"></a><span id="l3.517">   },</span>
<a href="#l3.518"></a><span id="l3.518" class="difflineminus">-  get _empty() this._accounts.length == 0,</span>
<a href="#l3.519"></a><span id="l3.519" class="difflineplus">+  get _empty() { return this._accounts.length == 0; },</span>
<a href="#l3.520"></a><span id="l3.520"> </span>
<a href="#l3.521"></a><span id="l3.521">   remove: function() {</span>
<a href="#l3.522"></a><span id="l3.522">     for each (let account in this._accounts)</span>
<a href="#l3.523"></a><span id="l3.523">       account.remove();</span>
<a href="#l3.524"></a><span id="l3.524">   },</span>
<a href="#l3.525"></a><span id="l3.525"> </span>
<a href="#l3.526"></a><span id="l3.526">   // imIStatusInfo implementation</span>
<a href="#l3.527"></a><span id="l3.527">   _preferredAccount: null,</span>
<a href="#l3.528"></a><span id="l3.528" class="difflineminus">-  get preferredAccountBuddy() this._preferredAccount,</span>
<a href="#l3.529"></a><span id="l3.529" class="difflineplus">+  get preferredAccountBuddy() { return this._preferredAccount; },</span>
<a href="#l3.530"></a><span id="l3.530">   _isPreferredAccount: function(aAccountBuddy) {</span>
<a href="#l3.531"></a><span id="l3.531">     if (aAccountBuddy.account.numericId != this._preferredAccount.account.numericId)</span>
<a href="#l3.532"></a><span id="l3.532">       return false;</span>
<a href="#l3.533"></a><span id="l3.533"> </span>
<a href="#l3.534"></a><span id="l3.534">     // In case we have more than one accountBuddy for the same buddy</span>
<a href="#l3.535"></a><span id="l3.535">     // and account (possible if the buddy is in several groups on the</span>
<a href="#l3.536"></a><span id="l3.536">     // server), the protocol plugin may be broken and not update all</span>
<a href="#l3.537"></a><span id="l3.537">     // instances, so ensure we handle the notifications on the instance</span>
<a href="#l3.538"></a><span id="l3.538" class="difflineat">@@ -1089,42 +1091,44 @@ Buddy.prototype = {</span>
<a href="#l3.539"></a><span id="l3.539">     [this._statusType, this._statusText, this._availabilityDetails] =</span>
<a href="#l3.540"></a><span id="l3.540">       [account.statusType, account.statusText, account.availabilityDetails];</span>
<a href="#l3.541"></a><span id="l3.541"> </span>
<a href="#l3.542"></a><span id="l3.542">     // Fire the notifications.</span>
<a href="#l3.543"></a><span id="l3.543">     notifications.forEach(function(aTopic) {</span>
<a href="#l3.544"></a><span id="l3.544">       this._notifyObservers(aTopic);</span>
<a href="#l3.545"></a><span id="l3.545">     }, this);</span>
<a href="#l3.546"></a><span id="l3.546">   },</span>
<a href="#l3.547"></a><span id="l3.547" class="difflineminus">-  get displayName() this._preferredAccount &amp;&amp; this._preferredAccount.displayName ||</span>
<a href="#l3.548"></a><span id="l3.548" class="difflineminus">-                    this._srvAlias || this._name,</span>
<a href="#l3.549"></a><span id="l3.549" class="difflineminus">-  get buddyIconFilename() this._preferredAccount.buddyIconFilename,</span>
<a href="#l3.550"></a><span id="l3.550" class="difflineplus">+  get displayName() {</span>
<a href="#l3.551"></a><span id="l3.551" class="difflineplus">+    return this._preferredAccount &amp;&amp; this._preferredAccount.displayName ||</span>
<a href="#l3.552"></a><span id="l3.552" class="difflineplus">+           this._srvAlias || this._name;</span>
<a href="#l3.553"></a><span id="l3.553" class="difflineplus">+  },</span>
<a href="#l3.554"></a><span id="l3.554" class="difflineplus">+  get buddyIconFilename() { return this._preferredAccount.buddyIconFilename; },</span>
<a href="#l3.555"></a><span id="l3.555">   _statusType: 0,</span>
<a href="#l3.556"></a><span id="l3.556" class="difflineminus">-  get statusType() this._statusType,</span>
<a href="#l3.557"></a><span id="l3.557" class="difflineminus">-  get online() this.statusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE,</span>
<a href="#l3.558"></a><span id="l3.558" class="difflineminus">-  get available() this.statusType == Ci.imIStatusInfo.STATUS_AVAILABLE,</span>
<a href="#l3.559"></a><span id="l3.559" class="difflineminus">-  get idle() this.statusType == Ci.imIStatusInfo.STATUS_IDLE,</span>
<a href="#l3.560"></a><span id="l3.560" class="difflineminus">-  get mobile() this.statusType == Ci.imIStatusInfo.STATUS_MOBILE,</span>
<a href="#l3.561"></a><span id="l3.561" class="difflineplus">+  get statusType() { return this._statusType; },</span>
<a href="#l3.562"></a><span id="l3.562" class="difflineplus">+  get online() { return this.statusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE; },</span>
<a href="#l3.563"></a><span id="l3.563" class="difflineplus">+  get available() { return this.statusType == Ci.imIStatusInfo.STATUS_AVAILABLE; },</span>
<a href="#l3.564"></a><span id="l3.564" class="difflineplus">+  get idle() { return this.statusType == Ci.imIStatusInfo.STATUS_IDLE; },</span>
<a href="#l3.565"></a><span id="l3.565" class="difflineplus">+  get mobile() { return this.statusType == Ci.imIStatusInfo.STATUS_MOBILE; },</span>
<a href="#l3.566"></a><span id="l3.566">   _statusText: &quot;&quot;,</span>
<a href="#l3.567"></a><span id="l3.567" class="difflineminus">-  get statusText() this._statusText,</span>
<a href="#l3.568"></a><span id="l3.568" class="difflineplus">+  get statusText() { return this._statusText; },</span>
<a href="#l3.569"></a><span id="l3.569">   _availabilityDetails: 0,</span>
<a href="#l3.570"></a><span id="l3.570" class="difflineminus">-  get availabilityDetails() this._availabilityDetails,</span>
<a href="#l3.571"></a><span id="l3.571" class="difflineminus">-  get canSendMessage() this._preferredAccount.canSendMessage,</span>
<a href="#l3.572"></a><span id="l3.572" class="difflineplus">+  get availabilityDetails() { return this._availabilityDetails; },</span>
<a href="#l3.573"></a><span id="l3.573" class="difflineplus">+  get canSendMessage() { return this._preferredAccount.canSendMessage; },</span>
<a href="#l3.574"></a><span id="l3.574">   //XXX should we list the accounts in the tooltip?</span>
<a href="#l3.575"></a><span id="l3.575" class="difflineminus">-  getTooltipInfo: function() this._preferredAccount.getTooltipInfo(),</span>
<a href="#l3.576"></a><span id="l3.576" class="difflineminus">-  createConversation: function() this._preferredAccount.createConversation(),</span>
<a href="#l3.577"></a><span id="l3.577" class="difflineplus">+  getTooltipInfo: function() { return this._preferredAccount.getTooltipInfo(); },</span>
<a href="#l3.578"></a><span id="l3.578" class="difflineplus">+  createConversation: function() { return this._preferredAccount.createConversation(); },</span>
<a href="#l3.579"></a><span id="l3.579"> </span>
<a href="#l3.580"></a><span id="l3.580">   addObserver: function(aObserver) {</span>
<a href="#l3.581"></a><span id="l3.581">     if (this._observers.indexOf(aObserver) == -1)</span>
<a href="#l3.582"></a><span id="l3.582">       this._observers.push(aObserver);</span>
<a href="#l3.583"></a><span id="l3.583">   },</span>
<a href="#l3.584"></a><span id="l3.584">   removeObserver: function(aObserver) {</span>
<a href="#l3.585"></a><span id="l3.585">     if (!this._observers)</span>
<a href="#l3.586"></a><span id="l3.586">       return;</span>
<a href="#l3.587"></a><span id="l3.587" class="difflineminus">-    this._observers = this._observers.filter(function(o) o !== aObserver);</span>
<a href="#l3.588"></a><span id="l3.588" class="difflineplus">+    this._observers = this._observers.filter(o =&gt; o !== aObserver);</span>
<a href="#l3.589"></a><span id="l3.589">   },</span>
<a href="#l3.590"></a><span id="l3.590">   // internal calls + calls from add-ons</span>
<a href="#l3.591"></a><span id="l3.591">   notifyObservers: function(aSubject, aTopic, aData) {</span>
<a href="#l3.592"></a><span id="l3.592">     try {</span>
<a href="#l3.593"></a><span id="l3.593">       for each (let observer in this._observers)</span>
<a href="#l3.594"></a><span id="l3.594">         observer.observe(aSubject, aTopic, aData);</span>
<a href="#l3.595"></a><span id="l3.595">       this._contact._observe(aSubject, aTopic, aData);</span>
<a href="#l3.596"></a><span id="l3.596">     } catch (e) {</span>
<a href="#l3.597"></a><span id="l3.597" class="difflineat">@@ -1210,17 +1214,17 @@ Buddy.prototype = {</span>
<a href="#l3.598"></a><span id="l3.598">     }</span>
<a href="#l3.599"></a><span id="l3.599">   },</span>
<a href="#l3.600"></a><span id="l3.600"> </span>
<a href="#l3.601"></a><span id="l3.601">   getInterfaces: function(countRef) {</span>
<a href="#l3.602"></a><span id="l3.602">     let interfaces = [Ci.nsIClassInfo, Ci.nsISupports, Ci.imIBuddy];</span>
<a href="#l3.603"></a><span id="l3.603">     countRef.value = interfaces.length;</span>
<a href="#l3.604"></a><span id="l3.604">     return interfaces;</span>
<a href="#l3.605"></a><span id="l3.605">   },</span>
<a href="#l3.606"></a><span id="l3.606" class="difflineminus">-  getHelperForLanguage: function(language) null,</span>
<a href="#l3.607"></a><span id="l3.607" class="difflineplus">+  getHelperForLanguage: language =&gt; null,</span>
<a href="#l3.608"></a><span id="l3.608">   implementationLanguage: Ci.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l3.609"></a><span id="l3.609">   flags: 0,</span>
<a href="#l3.610"></a><span id="l3.610">   QueryInterface: XPCOMUtils.generateQI([Ci.imIBuddy, Ci.nsIClassInfo])</span>
<a href="#l3.611"></a><span id="l3.611"> };</span>
<a href="#l3.612"></a><span id="l3.612"> </span>
<a href="#l3.613"></a><span id="l3.613"> </span>
<a href="#l3.614"></a><span id="l3.614"> function ContactsService() { }</span>
<a href="#l3.615"></a><span id="l3.615"> ContactsService.prototype = {</span>
<a href="#l3.616"></a><span id="l3.616" class="difflineat">@@ -1308,25 +1312,25 @@ ContactsService.prototype = {</span>
<a href="#l3.617"></a><span id="l3.617">     // Avoid shutdown leaks caused by references to native components</span>
<a href="#l3.618"></a><span id="l3.618">     // implementing prplIAccountBuddy.</span>
<a href="#l3.619"></a><span id="l3.619">     for each (let buddy in BuddiesById)</span>
<a href="#l3.620"></a><span id="l3.620">       buddy.destroy();</span>
<a href="#l3.621"></a><span id="l3.621">     BuddiesById = { };</span>
<a href="#l3.622"></a><span id="l3.622">     ContactsById = { };</span>
<a href="#l3.623"></a><span id="l3.623">   },</span>
<a href="#l3.624"></a><span id="l3.624"> </span>
<a href="#l3.625"></a><span id="l3.625" class="difflineminus">-  getContactById: function(aId) ContactsById[aId],</span>
<a href="#l3.626"></a><span id="l3.626" class="difflineplus">+  getContactById: aId =&gt; ContactsById[aId],</span>
<a href="#l3.627"></a><span id="l3.627">   // Get an array of all existing contacts.</span>
<a href="#l3.628"></a><span id="l3.628">   getContacts: function(aContactCount) {</span>
<a href="#l3.629"></a><span id="l3.629">     let contacts = [ContactsById[id] for (id in ContactsById) if (!ContactsById[id]._empty)];</span>
<a href="#l3.630"></a><span id="l3.630">     if (aContactCount)</span>
<a href="#l3.631"></a><span id="l3.631">       aContactCount.value = contacts.length;</span>
<a href="#l3.632"></a><span id="l3.632">     return contacts;</span>
<a href="#l3.633"></a><span id="l3.633">   },</span>
<a href="#l3.634"></a><span id="l3.634" class="difflineminus">-  getBuddyById: function(aId) BuddiesById[aId],</span>
<a href="#l3.635"></a><span id="l3.635" class="difflineplus">+  getBuddyById: aId =&gt; BuddiesById[aId],</span>
<a href="#l3.636"></a><span id="l3.636">   getBuddyByNameAndProtocol: function(aNormalizedName, aPrpl) {</span>
<a href="#l3.637"></a><span id="l3.637">     let statement =</span>
<a href="#l3.638"></a><span id="l3.638">       DBConn.createStatement(&quot;SELECT b.id FROM buddies b &quot; +</span>
<a href="#l3.639"></a><span id="l3.639">                              &quot;JOIN account_buddy ab ON buddy_id = b.id &quot; +</span>
<a href="#l3.640"></a><span id="l3.640">                              &quot;JOIN accounts a ON account_id = a.id &quot; +</span>
<a href="#l3.641"></a><span id="l3.641">                              &quot;WHERE b.key = :buddyName and a.prpl = :prplId&quot;);</span>
<a href="#l3.642"></a><span id="l3.642">     statement.params.buddyName = aNormalizedName;</span>
<a href="#l3.643"></a><span id="l3.643">     statement.params.prplId = aPrpl.id;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/chat/components/src/imConversations.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/chat/components/src/imConversations.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -6,17 +6,17 @@ const {classes: Cc, interfaces: Ci, util</span>
<a href="#l4.4"></a><span id="l4.4"> Cu.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l4.5"></a><span id="l4.5"> Cu.import(&quot;resource:///modules/imStatusUtils.jsm&quot;);</span>
<a href="#l4.6"></a><span id="l4.6"> Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l4.7"></a><span id="l4.7"> Cu.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> var gLastUIConvId = 0;</span>
<a href="#l4.10"></a><span id="l4.10"> var gLastPrplConvId = 0;</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;bundle&quot;, function()</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;bundle&quot;, () =&gt;</span>
<a href="#l4.14"></a><span id="l4.14">   Services.strings.createBundle(&quot;chrome://chat/locale/conversations.properties&quot;)</span>
<a href="#l4.15"></a><span id="l4.15"> );</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17"> function OutgoingMessage(aMsg, aConversation) {</span>
<a href="#l4.18"></a><span id="l4.18">   this.message = aMsg;</span>
<a href="#l4.19"></a><span id="l4.19">   this.conversation = aConversation;</span>
<a href="#l4.20"></a><span id="l4.20"> }</span>
<a href="#l4.21"></a><span id="l4.21"> OutgoingMessage.prototype = {</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -37,41 +37,41 @@ imMessage.prototype = {</span>
<a href="#l4.23"></a><span id="l4.23">   get displayMessage() {</span>
<a href="#l4.24"></a><span id="l4.24">     // Explicitly test for null so that blank messages don't fall back to</span>
<a href="#l4.25"></a><span id="l4.25">     // the original. Especially problematic in encryption extensions like OTR.</span>
<a href="#l4.26"></a><span id="l4.26">     return this._displayMessage !== null ?</span>
<a href="#l4.27"></a><span id="l4.27">       this._displayMessage : this.prplMessage.originalMessage;</span>
<a href="#l4.28"></a><span id="l4.28">   },</span>
<a href="#l4.29"></a><span id="l4.29">   set displayMessage(aMsg) { this._displayMessage = aMsg; },</span>
<a href="#l4.30"></a><span id="l4.30"> </span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-  get message() this.prplMessage.message,</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+  get message() { return this.prplMessage.message; },</span>
<a href="#l4.33"></a><span id="l4.33">   set message(aMsg) { this.prplMessage.message = aMsg; },</span>
<a href="#l4.34"></a><span id="l4.34"> </span>
<a href="#l4.35"></a><span id="l4.35">   // from prplIMessage</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-  get who() this.prplMessage.who,</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-  get time() this.prplMessage.time,</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-  get id() this.prplMessage.id,</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-  get alias() this.prplMessage.alias,</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-  get iconURL() this.prplMessage.iconURL,</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-  get conversation() this.prplMessage.conversation,</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+  get who() { return this.prplMessage.who; },</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+  get time() { return this.prplMessage.time; },</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+  get id() { return this.prplMessage.id; },</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+  get alias() { return this.prplMessage.alias; },</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+  get iconURL() { return this.prplMessage.iconURL; },</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+  get conversation() { return this.prplMessage.conversation; },</span>
<a href="#l4.48"></a><span id="l4.48">   set conversation(aConv) { this.prplMessage.conversation = aConv; },</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-  get outgoing() this.prplMessage.outgoing,</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-  get incoming() this.prplMessage.incoming,</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-  get system() this.prplMessage.system,</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-  get autoResponse() this.prplMessage.autoResponse,</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineminus">-  get containsNick() this.prplMessage.containsNick,</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineminus">-  get noLog() this.prplMessage.noLog,</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-  get error() this.prplMessage.error,</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineminus">-  get delayed() this.prplMessage.delayed,</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineminus">-  get noFormat() this.prplMessage.noFormat,</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineminus">-  get containsImages() this.prplMessage.containsImages,</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineminus">-  get notification() this.prplMessage.notification,</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineminus">-  get noLinkification() this.prplMessage.noLinkification,</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineminus">-  get originalMessage() this.prplMessage.originalMessage,</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineminus">-  getActions: function(aCount) this.prplMessage.getActions(aCount || {})</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+  get outgoing() { return this.prplMessage.outgoing; },</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+  get incoming() { return this.prplMessage.incoming; },</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+  get system() { return this.prplMessage.system; },</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+  get autoResponse() { return this.prplMessage.autoResponse; },</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+  get containsNick() { return this.prplMessage.containsNick; },</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+  get noLog() { return this.prplMessage.noLog; },</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+  get error() { return this.prplMessage.error; },</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+  get delayed() { return this.prplMessage.delayed; },</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+  get noFormat() { return this.prplMessage.noFormat; },</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+  get containsImages() { return this.prplMessage.containsImages; },</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+  get notification() { return this.prplMessage.notification; },</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+  get noLinkification() { return this.prplMessage.noLinkification; },</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+  get originalMessage() { return this.prplMessage.originalMessage; },</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+  getActions: function(aCount) { return this.prplMessage.getActions(aCount || {}); }</span>
<a href="#l4.77"></a><span id="l4.77"> };</span>
<a href="#l4.78"></a><span id="l4.78"> </span>
<a href="#l4.79"></a><span id="l4.79"> function UIConversation(aPrplConversation)</span>
<a href="#l4.80"></a><span id="l4.80"> {</span>
<a href="#l4.81"></a><span id="l4.81">   this._prplConv = {};</span>
<a href="#l4.82"></a><span id="l4.82">   this.id = ++gLastUIConvId;</span>
<a href="#l4.83"></a><span id="l4.83">   this._observers = [];</span>
<a href="#l4.84"></a><span id="l4.84">   this._messages = [];</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineat">@@ -100,21 +100,21 @@ UIConversation.prototype = {</span>
<a href="#l4.86"></a><span id="l4.86">       contact.addObserver(this);</span>
<a href="#l4.87"></a><span id="l4.87">       this._observedContact = contact;</span>
<a href="#l4.88"></a><span id="l4.88">     }</span>
<a href="#l4.89"></a><span id="l4.89">     else if (!contact &amp;&amp; this.observedContact) {</span>
<a href="#l4.90"></a><span id="l4.90">       this._observedContact.removeObserver(this);</span>
<a href="#l4.91"></a><span id="l4.91">       delete this._observedContact;</span>
<a href="#l4.92"></a><span id="l4.92">     }</span>
<a href="#l4.93"></a><span id="l4.93">   },</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineminus">-  get target() this._prplConv[this._currentTargetId],</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+  get target() { return this._prplConv[this._currentTargetId]; },</span>
<a href="#l4.96"></a><span id="l4.96">   set target(aPrplConversation) {</span>
<a href="#l4.97"></a><span id="l4.97">     this.changeTargetTo(aPrplConversation);</span>
<a href="#l4.98"></a><span id="l4.98">   },</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineminus">-  get hasMultipleTargets() Object.keys(this._prplConv).length &gt; 1,</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+  get hasMultipleTargets() { return Object.keys(this._prplConv).length &gt; 1; },</span>
<a href="#l4.101"></a><span id="l4.101">   getTargetByAccount: function(aAccount) {</span>
<a href="#l4.102"></a><span id="l4.102">     let accountId = aAccount.id;</span>
<a href="#l4.103"></a><span id="l4.103">     for (let id in this._prplConv) {</span>
<a href="#l4.104"></a><span id="l4.104">       let prplConv = this._prplConv[id];</span>
<a href="#l4.105"></a><span id="l4.105">       if (prplConv.account.id == accountId)</span>
<a href="#l4.106"></a><span id="l4.106">         return prplConv;</span>
<a href="#l4.107"></a><span id="l4.107">     }</span>
<a href="#l4.108"></a><span id="l4.108">     return null;</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineat">@@ -171,21 +171,21 @@ UIConversation.prototype = {</span>
<a href="#l4.110"></a><span id="l4.110">       aContactId.value = 0;</span>
<a href="#l4.111"></a><span id="l4.111"> </span>
<a href="#l4.112"></a><span id="l4.112">     delete this._currentTargetId;</span>
<a href="#l4.113"></a><span id="l4.113">     this.notifyObservers(this, &quot;ui-conversation-closed&quot;);</span>
<a href="#l4.114"></a><span id="l4.114">     return true;</span>
<a href="#l4.115"></a><span id="l4.115">   },</span>
<a href="#l4.116"></a><span id="l4.116"> </span>
<a href="#l4.117"></a><span id="l4.117">   _unreadMessageCount: 0,</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineminus">-  get unreadMessageCount() this._unreadMessageCount,</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+  get unreadMessageCount() { return this._unreadMessageCount; },</span>
<a href="#l4.120"></a><span id="l4.120">   _unreadTargetedMessageCount: 0,</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineminus">-  get unreadTargetedMessageCount() this._unreadTargetedMessageCount,</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+  get unreadTargetedMessageCount() { return this._unreadTargetedMessageCount; },</span>
<a href="#l4.123"></a><span id="l4.123">   _unreadIncomingMessageCount: 0,</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineminus">-  get unreadIncomingMessageCount() this._unreadIncomingMessageCount,</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+  get unreadIncomingMessageCount() { return this._unreadIncomingMessageCount; },</span>
<a href="#l4.126"></a><span id="l4.126">   markAsRead: function() {</span>
<a href="#l4.127"></a><span id="l4.127">     delete this._unreadMessageCount;</span>
<a href="#l4.128"></a><span id="l4.128">     delete this._unreadTargetedMessageCount;</span>
<a href="#l4.129"></a><span id="l4.129">     delete this._unreadIncomingMessageCount;</span>
<a href="#l4.130"></a><span id="l4.130">     this._notifyUnreadCountChanged();</span>
<a href="#l4.131"></a><span id="l4.131">   },</span>
<a href="#l4.132"></a><span id="l4.132">   _lastNotifiedUnreadCount: 0,</span>
<a href="#l4.133"></a><span id="l4.133">   _notifyUnreadCountChanged: function() {</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineat">@@ -340,22 +340,22 @@ UIConversation.prototype = {</span>
<a href="#l4.135"></a><span id="l4.135">   },</span>
<a href="#l4.136"></a><span id="l4.136"> </span>
<a href="#l4.137"></a><span id="l4.137">   systemMessage: function(aText, aIsError) {</span>
<a href="#l4.138"></a><span id="l4.138">     let flags = {system: true, noLog: true, error: !!aIsError};</span>
<a href="#l4.139"></a><span id="l4.139">     (new Message(&quot;system&quot;, aText, flags)).conversation = this;</span>
<a href="#l4.140"></a><span id="l4.140">   },</span>
<a href="#l4.141"></a><span id="l4.141"> </span>
<a href="#l4.142"></a><span id="l4.142">   // prplIConversation</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineminus">-  get isChat() this.target.isChat,</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineminus">-  get account() this.target.account,</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineminus">-  get name() this.target.name,</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineminus">-  get normalizedName() this.target.normalizedName,</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineminus">-  get title() this.target.title,</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineminus">-  get startDate() this.target.startDate,</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineplus">+  get isChat() { return this.target.isChat; },</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineplus">+  get account() { return this.target.account; },</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineplus">+  get name() { return this.target.name; },</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineplus">+  get normalizedName() { return this.target.normalizedName; },</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineplus">+  get title() { return this.target.title; },</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineplus">+  get startDate() { return this.target.startDate; },</span>
<a href="#l4.155"></a><span id="l4.155">   sendMsg: function(aMsg) {</span>
<a href="#l4.156"></a><span id="l4.156">     // Add-ons (eg. pastebin) have an opportunity to cancel the message at this</span>
<a href="#l4.157"></a><span id="l4.157">     // point, or change the text content of the message.</span>
<a href="#l4.158"></a><span id="l4.158">     // If an add-on wants to split a message, it should truncate the first</span>
<a href="#l4.159"></a><span id="l4.159">     // message, and insert new messages using the conversation's sendMsg method.</span>
<a href="#l4.160"></a><span id="l4.160">     let om = new OutgoingMessage(aMsg, this);</span>
<a href="#l4.161"></a><span id="l4.161">     this.notifyObservers(om, &quot;preparing-message&quot;);</span>
<a href="#l4.162"></a><span id="l4.162">     if (om.cancelled)</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineat">@@ -401,17 +401,17 @@ UIConversation.prototype = {</span>
<a href="#l4.164"></a><span id="l4.164">     this.notifyObservers(this, &quot;ui-conversation-closed&quot;);</span>
<a href="#l4.165"></a><span id="l4.165">     Services.obs.notifyObservers(this, &quot;ui-conversation-closed&quot;, null);</span>
<a href="#l4.166"></a><span id="l4.166">   },</span>
<a href="#l4.167"></a><span id="l4.167">   addObserver: function(aObserver) {</span>
<a href="#l4.168"></a><span id="l4.168">     if (this._observers.indexOf(aObserver) == -1)</span>
<a href="#l4.169"></a><span id="l4.169">       this._observers.push(aObserver);</span>
<a href="#l4.170"></a><span id="l4.170">   },</span>
<a href="#l4.171"></a><span id="l4.171">   removeObserver: function(aObserver) {</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineminus">-    this._observers = this._observers.filter(function(o) o !== aObserver);</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineplus">+    this._observers = this._observers.filter(o =&gt; o !== aObserver);</span>
<a href="#l4.174"></a><span id="l4.174">   },</span>
<a href="#l4.175"></a><span id="l4.175">   notifyObservers: function(aSubject, aTopic, aData) {</span>
<a href="#l4.176"></a><span id="l4.176">     if (aTopic == &quot;new-text&quot;) {</span>
<a href="#l4.177"></a><span id="l4.177">       aSubject = new imMessage(aSubject);</span>
<a href="#l4.178"></a><span id="l4.178">       this.notifyObservers(aSubject, &quot;received-message&quot;);</span>
<a href="#l4.179"></a><span id="l4.179">       if (aSubject.cancelled)</span>
<a href="#l4.180"></a><span id="l4.180">         return;</span>
<a href="#l4.181"></a><span id="l4.181">       aSubject.conversation.prepareForDisplaying(aSubject);</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineat">@@ -443,36 +443,36 @@ UIConversation.prototype = {</span>
<a href="#l4.183"></a><span id="l4.183">   },</span>
<a href="#l4.184"></a><span id="l4.184"> </span>
<a href="#l4.185"></a><span id="l4.185">   // Used above when notifying of new-texts originating in the</span>
<a href="#l4.186"></a><span id="l4.186">   // UIConversation. This happens when this.systemMessage() is called. The</span>
<a href="#l4.187"></a><span id="l4.187">   // conversation for the message is set as the UIConversation.</span>
<a href="#l4.188"></a><span id="l4.188">   prepareForDisplaying: function(aMsg) {},</span>
<a href="#l4.189"></a><span id="l4.189"> </span>
<a href="#l4.190"></a><span id="l4.190">   // prplIConvIM</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineminus">-  get buddy() this.target.buddy,</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineminus">-  get typingState() this.target.typingState,</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineminus">-  sendTyping: function(aString) this.target.sendTyping(aString),</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineplus">+  get buddy() { return this.target.buddy; },</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineplus">+  get typingState() { return this.target.typingState; },</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineplus">+  sendTyping: function(aString) { return this.target.sendTyping(aString); },</span>
<a href="#l4.197"></a><span id="l4.197"> </span>
<a href="#l4.198"></a><span id="l4.198">   // Chat only</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineminus">-  getParticipants: function() this.target.getParticipants(),</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineminus">-  get topic() this.target.topic,</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineplus">+  getParticipants: function() { return this.target.getParticipants(); },</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineplus">+  get topic() { return this.target.topic; },</span>
<a href="#l4.203"></a><span id="l4.203">   set topic(aTopic) { this.target.topic = aTopic; },</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineminus">-  get topicSetter() this.target.topicSetter,</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineminus">-  get topicSettable() this.target.topicSettable,</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineminus">-  get noTopicString() bundle.GetStringFromName(&quot;noTopic&quot;),</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineminus">-  get nick() this.target.nick,</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineminus">-  get left() this.target.left,</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineminus">-  get joining() this.target.joining</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineplus">+  get topicSetter() { return this.target.topicSetter; },</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineplus">+  get topicSettable() { return this.target.topicSettable; },</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineplus">+  get noTopicString() { return bundle.GetStringFromName(&quot;noTopic&quot;); },</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineplus">+  get nick() { return this.target.nick; },</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineplus">+  get left() { return this.target.left; },</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineplus">+  get joining() { return this.target.joining; }</span>
<a href="#l4.216"></a><span id="l4.216"> };</span>
<a href="#l4.217"></a><span id="l4.217"> </span>
<a href="#l4.218"></a><span id="l4.218"> var gConversationsService;</span>
<a href="#l4.219"></a><span id="l4.219"> function ConversationsService() { gConversationsService = this; }</span>
<a href="#l4.220"></a><span id="l4.220"> ConversationsService.prototype = {</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineminus">-  get wrappedJSObject() this,</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineplus">+  get wrappedJSObject() { return this; },</span>
<a href="#l4.223"></a><span id="l4.223"> </span>
<a href="#l4.224"></a><span id="l4.224">   initConversations: function() {</span>
<a href="#l4.225"></a><span id="l4.225">     this._uiConv = {};</span>
<a href="#l4.226"></a><span id="l4.226">     this._uiConvByContactId = {};</span>
<a href="#l4.227"></a><span id="l4.227">     this._prplConversations = [];</span>
<a href="#l4.228"></a><span id="l4.228">     Services.obs.addObserver(this, &quot;account-disconnecting&quot;, false);</span>
<a href="#l4.229"></a><span id="l4.229">     Services.obs.addObserver(this, &quot;account-connected&quot;, false);</span>
<a href="#l4.230"></a><span id="l4.230">     Services.obs.addObserver(this, &quot;account-buddy-added&quot;, false);</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineat">@@ -598,17 +598,17 @@ ConversationsService.prototype = {</span>
<a href="#l4.232"></a><span id="l4.232">       Services.obs.notifyObservers(uiConv, &quot;ui-conversation-closed&quot;, null);</span>
<a href="#l4.233"></a><span id="l4.233">     }</span>
<a href="#l4.234"></a><span id="l4.234">     this.forgetConversation(aPrplConversation);</span>
<a href="#l4.235"></a><span id="l4.235">   },</span>
<a href="#l4.236"></a><span id="l4.236">   forgetConversation: function(aPrplConversation) {</span>
<a href="#l4.237"></a><span id="l4.237">     aPrplConversation.unInit();</span>
<a href="#l4.238"></a><span id="l4.238"> </span>
<a href="#l4.239"></a><span id="l4.239">     this._prplConversations =</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineminus">-      this._prplConversations.filter(function(c) c !== aPrplConversation);</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineplus">+      this._prplConversations.filter(c =&gt; c !== aPrplConversation);</span>
<a href="#l4.242"></a><span id="l4.242">   },</span>
<a href="#l4.243"></a><span id="l4.243"> </span>
<a href="#l4.244"></a><span id="l4.244">   getUIConversations: function(aConvCount) {</span>
<a href="#l4.245"></a><span id="l4.245">     let rv = [];</span>
<a href="#l4.246"></a><span id="l4.246">     if (this._uiConv) {</span>
<a href="#l4.247"></a><span id="l4.247">       for (let prplConvId in this._uiConv) {</span>
<a href="#l4.248"></a><span id="l4.248">         // Since an UIConversation may be linked to multiple prplConversations,</span>
<a href="#l4.249"></a><span id="l4.249">         // we must ensure we don't return the same UIConversation twice,</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineat">@@ -623,20 +623,21 @@ ConversationsService.prototype = {</span>
<a href="#l4.251"></a><span id="l4.251">     return rv;</span>
<a href="#l4.252"></a><span id="l4.252">   },</span>
<a href="#l4.253"></a><span id="l4.253">   getUIConversation: function(aPrplConversation) {</span>
<a href="#l4.254"></a><span id="l4.254">     let id = aPrplConversation.id;</span>
<a href="#l4.255"></a><span id="l4.255">     if (this._uiConv &amp;&amp; id in this._uiConv)</span>
<a href="#l4.256"></a><span id="l4.256">       return this._uiConv[id];</span>
<a href="#l4.257"></a><span id="l4.257">     throw &quot;Unknown conversation&quot;;</span>
<a href="#l4.258"></a><span id="l4.258">   },</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineminus">-  getUIConversationByContactId: function(aId)</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineminus">-    (aId in this._uiConvByContactId) ? this._uiConvByContactId[aId] : null,</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineplus">+  getUIConversationByContactId: function(aId) {</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineplus">+    return (aId in this._uiConvByContactId) ? this._uiConvByContactId[aId] : null;</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineplus">+  },</span>
<a href="#l4.264"></a><span id="l4.264"> </span>
<a href="#l4.265"></a><span id="l4.265" class="difflineminus">-  getConversations: function() new nsSimpleEnumerator(this._prplConversations),</span>
<a href="#l4.266"></a><span id="l4.266" class="difflineplus">+  getConversations: function() { return new nsSimpleEnumerator(this._prplConversations); },</span>
<a href="#l4.267"></a><span id="l4.267">   getConversationById: function(aId) {</span>
<a href="#l4.268"></a><span id="l4.268">     for each (let conv in this._prplConversations)</span>
<a href="#l4.269"></a><span id="l4.269">       if (conv.id == aId)</span>
<a href="#l4.270"></a><span id="l4.270">         return conv;</span>
<a href="#l4.271"></a><span id="l4.271">     return null;</span>
<a href="#l4.272"></a><span id="l4.272">   },</span>
<a href="#l4.273"></a><span id="l4.273">   getConversationByNameAndAccount: function(aName, aAccount, aIsChat) {</span>
<a href="#l4.274"></a><span id="l4.274">     let normalizedName = aAccount.normalize(aName);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/chat/components/src/imCore.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/chat/components/src/imCore.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -111,17 +111,17 @@ UserStatus.prototype = {</span>
<a href="#l5.4"></a><span id="l5.4">       this._offlineStatusType = Ci.imIStatusInfo.STATUS_OFFLINE;</span>
<a href="#l5.5"></a><span id="l5.5">     else</span>
<a href="#l5.6"></a><span id="l5.6">       delete this._offlineStatusType;</span>
<a href="#l5.7"></a><span id="l5.7">     if (this.statusType != statusType || this.statusText != statusText)</span>
<a href="#l5.8"></a><span id="l5.8">       this._notifyObservers(&quot;status-changed&quot;, this.statusText);</span>
<a href="#l5.9"></a><span id="l5.9">   },</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11">   _idleTime: 0,</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  get idleTime() this._idleTime,</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  get idleTime() { return this._idleTime; },</span>
<a href="#l5.14"></a><span id="l5.14">   set idleTime(aIdleTime) {</span>
<a href="#l5.15"></a><span id="l5.15">     this._idleTime = aIdleTime;</span>
<a href="#l5.16"></a><span id="l5.16">     this._notifyObservers(&quot;idle-time-changed&quot;, aIdleTime);</span>
<a href="#l5.17"></a><span id="l5.17">   },</span>
<a href="#l5.18"></a><span id="l5.18">   _idle: false,</span>
<a href="#l5.19"></a><span id="l5.19">   _idleStatusText: &quot;&quot;,</span>
<a href="#l5.20"></a><span id="l5.20">   _idleStatusType: Ci.imIStatusInfo.STATUS_AVAILABLE,</span>
<a href="#l5.21"></a><span id="l5.21">   _checkIdle: function() {</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineat">@@ -147,29 +147,28 @@ UserStatus.prototype = {</span>
<a href="#l5.23"></a><span id="l5.23">       delete this._idleStatusType;</span>
<a href="#l5.24"></a><span id="l5.24">       delete this._idleStatusText;</span>
<a href="#l5.25"></a><span id="l5.25">     }</span>
<a href="#l5.26"></a><span id="l5.26">     if (this.statusType != statusType || this.statusText != statusText)</span>
<a href="#l5.27"></a><span id="l5.27">       this._notifyObservers(&quot;status-changed&quot;, this.statusText);</span>
<a href="#l5.28"></a><span id="l5.28">   },</span>
<a href="#l5.29"></a><span id="l5.29"> </span>
<a href="#l5.30"></a><span id="l5.30">   _statusText: &quot;&quot;,</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-  get statusText() this._statusText || this._idleStatusText,</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+  get statusText() { return this._statusText || this._idleStatusText; },</span>
<a href="#l5.33"></a><span id="l5.33">   _statusType: Ci.imIStatusInfo.STATUS_AVAILABLE,</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-  get statusType() Math.min(this._statusType, this._idleStatusType, this._offlineStatusType),</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+  get statusType() { return Math.min(this._statusType, this._idleStatusType, this._offlineStatusType); },</span>
<a href="#l5.36"></a><span id="l5.36">   setStatus: function(aStatus, aMessage) {</span>
<a href="#l5.37"></a><span id="l5.37">     if (aStatus != Ci.imIStatusInfo.STATUS_UNKNOWN)</span>
<a href="#l5.38"></a><span id="l5.38">       this._statusType = aStatus;</span>
<a href="#l5.39"></a><span id="l5.39">     if (aStatus != Ci.imIStatusInfo.STATUS_OFFLINE)</span>
<a href="#l5.40"></a><span id="l5.40">       this._statusText = aMessage;</span>
<a href="#l5.41"></a><span id="l5.41">     this._notifyObservers(&quot;status-changed&quot;, aMessage);</span>
<a href="#l5.42"></a><span id="l5.42">   },</span>
<a href="#l5.43"></a><span id="l5.43"> </span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-  _getProfileDir: function()</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-    Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsIFile),</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+  _getProfileDir: () =&gt; Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsIFile),</span>
<a href="#l5.47"></a><span id="l5.47">   setUserIcon: function(aIconFile) {</span>
<a href="#l5.48"></a><span id="l5.48">     let folder = this._getProfileDir();</span>
<a href="#l5.49"></a><span id="l5.49"> </span>
<a href="#l5.50"></a><span id="l5.50">     let newName = &quot;&quot;;</span>
<a href="#l5.51"></a><span id="l5.51">     if (aIconFile) {</span>
<a href="#l5.52"></a><span id="l5.52">       // Get the extension (remove trailing dots - invalid Windows extension).</span>
<a href="#l5.53"></a><span id="l5.53">       let ext = aIconFile.leafName.replace(/.*(\.[a-z0-9]+)\.*/i, &quot;$1&quot;);</span>
<a href="#l5.54"></a><span id="l5.54">       // newName = userIcon-&lt;timestamp(now)&gt;.&lt;aIconFile.extension&gt;</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineat">@@ -209,47 +208,49 @@ UserStatus.prototype = {</span>
<a href="#l5.56"></a><span id="l5.56">     if (!file.exists()) {</span>
<a href="#l5.57"></a><span id="l5.57">       Services.console.logStringMessage(&quot;Invalid userIconFileName preference&quot;);</span>
<a href="#l5.58"></a><span id="l5.58">       return null;</span>
<a href="#l5.59"></a><span id="l5.59">     }</span>
<a href="#l5.60"></a><span id="l5.60"> </span>
<a href="#l5.61"></a><span id="l5.61">     return Services.io.newFileURI(file);</span>
<a href="#l5.62"></a><span id="l5.62">   },</span>
<a href="#l5.63"></a><span id="l5.63"> </span>
<a href="#l5.64"></a><span id="l5.64" class="difflineminus">-  get displayName() Services.prefs.getComplexValue(kPrefUserDisplayname,</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineminus">-                                                   Ci.nsISupportsString).data,</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+  get displayName() {</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+    return Services.prefs.getComplexValue(kPrefUserDisplayname,</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+                                          Ci.nsISupportsString).data;</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+  },</span>
<a href="#l5.70"></a><span id="l5.70">   set displayName(aDisplayName) {</span>
<a href="#l5.71"></a><span id="l5.71">     let str = Cc[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l5.72"></a><span id="l5.72">               .createInstance(Ci.nsISupportsString);</span>
<a href="#l5.73"></a><span id="l5.73">     str.data = aDisplayName;</span>
<a href="#l5.74"></a><span id="l5.74">     Services.prefs.setComplexValue(kPrefUserDisplayname, Ci.nsISupportsString,</span>
<a href="#l5.75"></a><span id="l5.75">                                    str);</span>
<a href="#l5.76"></a><span id="l5.76">     this._notifyObservers(&quot;user-display-name-changed&quot;, aDisplayName);</span>
<a href="#l5.77"></a><span id="l5.77">   },</span>
<a href="#l5.78"></a><span id="l5.78"> </span>
<a href="#l5.79"></a><span id="l5.79">   addObserver: function(aObserver) {</span>
<a href="#l5.80"></a><span id="l5.80">     if (this._observers.indexOf(aObserver) == -1)</span>
<a href="#l5.81"></a><span id="l5.81">       this._observers.push(aObserver);</span>
<a href="#l5.82"></a><span id="l5.82">   },</span>
<a href="#l5.83"></a><span id="l5.83">   removeObserver: function(aObserver) {</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineminus">-    this._observers = this._observers.filter(function(o) o !== aObserver);</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+    this._observers = this._observers.filter(o =&gt; o !== aObserver);</span>
<a href="#l5.86"></a><span id="l5.86">   },</span>
<a href="#l5.87"></a><span id="l5.87">   _notifyObservers: function(aTopic, aData) {</span>
<a href="#l5.88"></a><span id="l5.88">     for each (let observer in this._observers)</span>
<a href="#l5.89"></a><span id="l5.89">       observer.observe(this, aTopic, aData);</span>
<a href="#l5.90"></a><span id="l5.90">   }</span>
<a href="#l5.91"></a><span id="l5.91"> };</span>
<a href="#l5.92"></a><span id="l5.92"> </span>
<a href="#l5.93"></a><span id="l5.93"> var gCoreService;</span>
<a href="#l5.94"></a><span id="l5.94"> function CoreService() { gCoreService = this; }</span>
<a href="#l5.95"></a><span id="l5.95"> CoreService.prototype = {</span>
<a href="#l5.96"></a><span id="l5.96">   globalUserStatus: null,</span>
<a href="#l5.97"></a><span id="l5.97"> </span>
<a href="#l5.98"></a><span id="l5.98">   _initialized: false,</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineminus">-  get initialized() this._initialized,</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+  get initialized() { return this._initialized; },</span>
<a href="#l5.101"></a><span id="l5.101">   init: function() {</span>
<a href="#l5.102"></a><span id="l5.102">     if (this._initialized)</span>
<a href="#l5.103"></a><span id="l5.103">       return;</span>
<a href="#l5.104"></a><span id="l5.104"> </span>
<a href="#l5.105"></a><span id="l5.105">     initLogModule(&quot;core&quot;, this);</span>
<a href="#l5.106"></a><span id="l5.106"> </span>
<a href="#l5.107"></a><span id="l5.107">     Services.obs.addObserver(this, kQuitApplicationGranted, false);</span>
<a href="#l5.108"></a><span id="l5.108">     this._initialized = true;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/chat/components/src/logger.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/chat/components/src/logger.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -7,17 +7,17 @@ const {classes: Cc, interfaces: Ci, util</span>
<a href="#l6.4"></a><span id="l6.4"> Cu.import(&quot;resource:///modules/hiddenWindow.jsm&quot;);</span>
<a href="#l6.5"></a><span id="l6.5"> Cu.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l6.6"></a><span id="l6.6"> Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l6.7"></a><span id="l6.7"> Cu.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9"> Cu.import(&quot;resource://gre/modules/Task.jsm&quot;)</span>
<a href="#l6.10"></a><span id="l6.10"> XPCOMUtils.defineLazyModuleGetter(this, &quot;OS&quot;, &quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, function()</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l6.14"></a><span id="l6.14">   l10nHelper(&quot;chrome://chat/locale/logger.properties&quot;)</span>
<a href="#l6.15"></a><span id="l6.15"> );</span>
<a href="#l6.16"></a><span id="l6.16"> </span>
<a href="#l6.17"></a><span id="l6.17"> const kLineBreak = &quot;@mozilla.org/windows-registry-key;1&quot; in Cc ? &quot;\r\n&quot; : &quot;\n&quot;;</span>
<a href="#l6.18"></a><span id="l6.18"> </span>
<a href="#l6.19"></a><span id="l6.19"> /*</span>
<a href="#l6.20"></a><span id="l6.20">  * Maps file paths to promises returned by ongoing OS.File operations on them.</span>
<a href="#l6.21"></a><span id="l6.21">  * This is so that a file can be read after a pending write operation completes</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -99,17 +99,17 @@ function encodeName(aName) {</span>
<a href="#l6.23"></a><span id="l6.23">     return &quot;%&quot; + aName;</span>
<a href="#l6.24"></a><span id="l6.24"> </span>
<a href="#l6.25"></a><span id="l6.25">   // &quot;.&quot; and &quot; &quot; must not be at the end of a file or folder name (appending &quot;_&quot;).</span>
<a href="#l6.26"></a><span id="l6.26">   if (/[\. _]/.test(aName.slice(-1)))</span>
<a href="#l6.27"></a><span id="l6.27">     aName += &quot;_&quot;;</span>
<a href="#l6.28"></a><span id="l6.28"> </span>
<a href="#l6.29"></a><span id="l6.29">   // Reserved characters are replaced by %[hex value]. encodeURIComponent() is</span>
<a href="#l6.30"></a><span id="l6.30">   // not sufficient, nevertheless decodeURIComponent() can be used to decode.</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-  function encodeReservedChars(match) &quot;%&quot; + match.charCodeAt(0).toString(16);</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+  function encodeReservedChars(match) { return &quot;%&quot; + match.charCodeAt(0).toString(16); }</span>
<a href="#l6.33"></a><span id="l6.33">   return aName.replace(/[&lt;&gt;:&quot;\/\\|?*&amp;%]/g, encodeReservedChars);</span>
<a href="#l6.34"></a><span id="l6.34"> }</span>
<a href="#l6.35"></a><span id="l6.35"> </span>
<a href="#l6.36"></a><span id="l6.36"> function getLogFolderPathForAccount(aAccount) {</span>
<a href="#l6.37"></a><span id="l6.37">   return OS.Path.join(OS.Constants.Path.profileDir,</span>
<a href="#l6.38"></a><span id="l6.38">                       &quot;logs&quot;, aAccount.protocol.normalizedName,</span>
<a href="#l6.39"></a><span id="l6.39">                       encodeName(aAccount.normalizedName));</span>
<a href="#l6.40"></a><span id="l6.40"> }</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineat">@@ -132,18 +132,19 @@ function getNewLogFileName(aFormat, aSta</span>
<a href="#l6.42"></a><span id="l6.42">   if (offset &lt; 0) {</span>
<a href="#l6.43"></a><span id="l6.43">     dateTime += &quot;+&quot;;</span>
<a href="#l6.44"></a><span id="l6.44">     offset *= -1;</span>
<a href="#l6.45"></a><span id="l6.45">   }</span>
<a href="#l6.46"></a><span id="l6.46">   else</span>
<a href="#l6.47"></a><span id="l6.47">     dateTime += &quot;-&quot;;</span>
<a href="#l6.48"></a><span id="l6.48">   let minutes = offset % 60;</span>
<a href="#l6.49"></a><span id="l6.49">   offset = (offset - minutes) / 60;</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineminus">-  function twoDigits(aNumber)</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-    aNumber == 0 ? &quot;00&quot; : aNumber &lt; 10 ? &quot;0&quot; + aNumber : aNumber;</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+  function twoDigits(aNumber) {</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+    return aNumber == 0 ? &quot;00&quot; : aNumber &lt; 10 ? &quot;0&quot; + aNumber : aNumber;</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+  }</span>
<a href="#l6.55"></a><span id="l6.55">   if (!aFormat)</span>
<a href="#l6.56"></a><span id="l6.56">     aFormat = &quot;txt&quot;;</span>
<a href="#l6.57"></a><span id="l6.57">   return dateTime + twoDigits(offset) + twoDigits(minutes) + &quot;.&quot; + aFormat;</span>
<a href="#l6.58"></a><span id="l6.58"> }</span>
<a href="#l6.59"></a><span id="l6.59"> </span>
<a href="#l6.60"></a><span id="l6.60"> </span>
<a href="#l6.61"></a><span id="l6.61"> // One of these is maintained for every conversation being logged. It initializes</span>
<a href="#l6.62"></a><span id="l6.62"> // a log file and appends to it as required.</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineat">@@ -260,17 +261,17 @@ LogWriter.prototype = {</span>
<a href="#l6.64"></a><span id="l6.64">     if (this.format == &quot;json&quot;) {</span>
<a href="#l6.65"></a><span id="l6.65">       let msg = {</span>
<a href="#l6.66"></a><span id="l6.66">         date: new Date(messageTime),</span>
<a href="#l6.67"></a><span id="l6.67">         who: aMessage.who,</span>
<a href="#l6.68"></a><span id="l6.68">         text: aMessage.displayMessage,</span>
<a href="#l6.69"></a><span id="l6.69">         flags: [&quot;outgoing&quot;, &quot;incoming&quot;, &quot;system&quot;, &quot;autoResponse&quot;,</span>
<a href="#l6.70"></a><span id="l6.70">                 &quot;containsNick&quot;, &quot;error&quot;, &quot;delayed&quot;,</span>
<a href="#l6.71"></a><span id="l6.71">                 &quot;noFormat&quot;, &quot;containsImages&quot;, &quot;notification&quot;,</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineminus">-                &quot;noLinkification&quot;].filter(function(f) aMessage[f])</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+                &quot;noLinkification&quot;].filter(f =&gt; aMessage[f])</span>
<a href="#l6.74"></a><span id="l6.74">       };</span>
<a href="#l6.75"></a><span id="l6.75">       let alias = aMessage.alias;</span>
<a href="#l6.76"></a><span id="l6.76">       if (alias &amp;&amp; alias != msg.who)</span>
<a href="#l6.77"></a><span id="l6.77">         msg.alias = alias;</span>
<a href="#l6.78"></a><span id="l6.78">       lineToWrite = JSON.stringify(msg) + &quot;\n&quot;;</span>
<a href="#l6.79"></a><span id="l6.79">     }</span>
<a href="#l6.80"></a><span id="l6.80">     else {</span>
<a href="#l6.81"></a><span id="l6.81">       // Text log.</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineat">@@ -423,50 +424,50 @@ function LogMessage(aData, aConversation</span>
<a href="#l6.83"></a><span id="l6.83">   if (&quot;alias&quot; in aData)</span>
<a href="#l6.84"></a><span id="l6.84">     this._alias = aData.alias;</span>
<a href="#l6.85"></a><span id="l6.85">   for (let flag of aData.flags)</span>
<a href="#l6.86"></a><span id="l6.86">     this[flag] = true;</span>
<a href="#l6.87"></a><span id="l6.87"> }</span>
<a href="#l6.88"></a><span id="l6.88"> LogMessage.prototype = {</span>
<a href="#l6.89"></a><span id="l6.89">   __proto__: GenericMessagePrototype,</span>
<a href="#l6.90"></a><span id="l6.90">   _interfaces: [Ci.imIMessage, Ci.prplIMessage],</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">-  get displayMessage() this.originalMessage</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+  get displayMessage() { return this.originalMessage; }</span>
<a href="#l6.93"></a><span id="l6.93"> };</span>
<a href="#l6.94"></a><span id="l6.94"> </span>
<a href="#l6.95"></a><span id="l6.95"> </span>
<a href="#l6.96"></a><span id="l6.96"> function LogConversation(aMessages, aProperties) {</span>
<a href="#l6.97"></a><span id="l6.97">   this._messages = aMessages;</span>
<a href="#l6.98"></a><span id="l6.98">   for (let property in aProperties)</span>
<a href="#l6.99"></a><span id="l6.99">     this[property] = aProperties[property];</span>
<a href="#l6.100"></a><span id="l6.100"> }</span>
<a href="#l6.101"></a><span id="l6.101"> LogConversation.prototype = {</span>
<a href="#l6.102"></a><span id="l6.102">   __proto__: ClassInfo(&quot;imILogConversation&quot;, &quot;Log conversation object&quot;),</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineminus">-  get isChat() this._isChat,</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineminus">-  get buddy() null,</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineminus">-  get account() ({</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineplus">+  get isChat() { return this._isChat; },</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineplus">+  get buddy() { return null; },</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineplus">+  get account() { return {</span>
<a href="#l6.109"></a><span id="l6.109">     alias: &quot;&quot;,</span>
<a href="#l6.110"></a><span id="l6.110">     name: this._accountName,</span>
<a href="#l6.111"></a><span id="l6.111">     normalizedName: this._accountName,</span>
<a href="#l6.112"></a><span id="l6.112">     protocol: {name: this._protocolName},</span>
<a href="#l6.113"></a><span id="l6.113">     statusInfo: Services.core.globalUserStatus</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineminus">-  }),</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineplus">+  }; },</span>
<a href="#l6.116"></a><span id="l6.116">   getMessages: function(aMessageCount) {</span>
<a href="#l6.117"></a><span id="l6.117">     if (aMessageCount)</span>
<a href="#l6.118"></a><span id="l6.118">       aMessageCount.value = this._messages.length;</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineminus">-    return this._messages.map(function(m) new LogMessage(m, this), this);</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineplus">+    return this._messages.map(m =&gt; new LogMessage(m, this));</span>
<a href="#l6.121"></a><span id="l6.121">   },</span>
<a href="#l6.122"></a><span id="l6.122">   getMessagesEnumerator: function(aMessageCount) {</span>
<a href="#l6.123"></a><span id="l6.123">     if (aMessageCount)</span>
<a href="#l6.124"></a><span id="l6.124">       aMessageCount.value = this._messages.length;</span>
<a href="#l6.125"></a><span id="l6.125">     let enumerator = {</span>
<a href="#l6.126"></a><span id="l6.126">       _index: 0,</span>
<a href="#l6.127"></a><span id="l6.127">       _conv: this,</span>
<a href="#l6.128"></a><span id="l6.128">       _messages: this._messages,</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineminus">-      hasMoreElements: function() this._index &lt; this._messages.length,</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineminus">-      getNext: function() new LogMessage(this._messages[this._index++], this._conv),</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineplus">+      hasMoreElements: function() { return this._index &lt; this._messages.length; },</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineplus">+      getNext: function() { return new LogMessage(this._messages[this._index++], this._conv); },</span>
<a href="#l6.133"></a><span id="l6.133">       QueryInterface: XPCOMUtils.generateQI([Ci.nsISimpleEnumerator])</span>
<a href="#l6.134"></a><span id="l6.134">     };</span>
<a href="#l6.135"></a><span id="l6.135">     return enumerator;</span>
<a href="#l6.136"></a><span id="l6.136">   }</span>
<a href="#l6.137"></a><span id="l6.137"> };</span>
<a href="#l6.138"></a><span id="l6.138"> </span>
<a href="#l6.139"></a><span id="l6.139"> </span>
<a href="#l6.140"></a><span id="l6.140"> /**</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineat">@@ -500,17 +501,17 @@ function Log(aEntries) {</span>
<a href="#l6.142"></a><span id="l6.142"> </span>
<a href="#l6.143"></a><span id="l6.143">   if (!aEntries.length) {</span>
<a href="#l6.144"></a><span id="l6.144">     throw new Error(&quot;Log was passed an invalid argument, &quot; +</span>
<a href="#l6.145"></a><span id="l6.145">                     &quot;expected a non-empty array or a string.&quot;);</span>
<a href="#l6.146"></a><span id="l6.146">   }</span>
<a href="#l6.147"></a><span id="l6.147"> </span>
<a href="#l6.148"></a><span id="l6.148">   // Assume aEntries is an array of objects.</span>
<a href="#l6.149"></a><span id="l6.149">   // Sort our list of entries for this day in increasing order.</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineminus">-  aEntries.sort(function(aLeft, aRight) aLeft.time - aRight.time);</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineplus">+  aEntries.sort((aLeft, aRight) =&gt; aLeft.time - aRight.time);</span>
<a href="#l6.152"></a><span id="l6.152"> </span>
<a href="#l6.153"></a><span id="l6.153">   this._entryPaths = [entry.path for (entry of aEntries)];</span>
<a href="#l6.154"></a><span id="l6.154">   // Calculate the timestamp for the first entry down to the day.</span>
<a href="#l6.155"></a><span id="l6.155">   let timestamp = new Date(aEntries[0].time);</span>
<a href="#l6.156"></a><span id="l6.156">   timestamp.setHours(0);</span>
<a href="#l6.157"></a><span id="l6.157">   timestamp.setMinutes(0);</span>
<a href="#l6.158"></a><span id="l6.158">   timestamp.setSeconds(0);</span>
<a href="#l6.159"></a><span id="l6.159">   this.time = timestamp.valueOf() / 1000;</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineat">@@ -653,17 +654,17 @@ function DailyLogEnumerator(aEntries) {</span>
<a href="#l6.161"></a><span id="l6.161"> </span>
<a href="#l6.162"></a><span id="l6.162">   this._days = Object.keys(this._entries).sort();</span>
<a href="#l6.163"></a><span id="l6.163">   this._index = 0;</span>
<a href="#l6.164"></a><span id="l6.164"> }</span>
<a href="#l6.165"></a><span id="l6.165"> DailyLogEnumerator.prototype = {</span>
<a href="#l6.166"></a><span id="l6.166">   _entries: {},</span>
<a href="#l6.167"></a><span id="l6.167">   _days: [],</span>
<a href="#l6.168"></a><span id="l6.168">   _index: 0,</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineminus">-  hasMoreElements: function() this._index &lt; this._days.length,</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineplus">+  hasMoreElements: function() { return this._index &lt; this._days.length; },</span>
<a href="#l6.171"></a><span id="l6.171">   getNext: function() {</span>
<a href="#l6.172"></a><span id="l6.172">     let dayID = this._days[this._index++];</span>
<a href="#l6.173"></a><span id="l6.173">     return new Log(this._entries[dayID]);</span>
<a href="#l6.174"></a><span id="l6.174">   },</span>
<a href="#l6.175"></a><span id="l6.175">   QueryInterface: XPCOMUtils.generateQI([Ci.nsISimpleEnumerator])</span>
<a href="#l6.176"></a><span id="l6.176"> };</span>
<a href="#l6.177"></a><span id="l6.177"> </span>
<a href="#l6.178"></a><span id="l6.178"> function LogEnumerator(aEntries) {</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineat">@@ -788,18 +789,19 @@ Logger.prototype = {</span>
<a href="#l6.180"></a><span id="l6.180">   }),</span>
<a href="#l6.181"></a><span id="l6.181">   getLogsForConversation: function logger_getLogsForConversation(aConversation,</span>
<a href="#l6.182"></a><span id="l6.182">                                                                  aGroupByDay) {</span>
<a href="#l6.183"></a><span id="l6.183">     let name = aConversation.normalizedName;</span>
<a href="#l6.184"></a><span id="l6.184">     if (convIsRealMUC(aConversation))</span>
<a href="#l6.185"></a><span id="l6.185">       name += &quot;.chat&quot;;</span>
<a href="#l6.186"></a><span id="l6.186">     return this.getLogsForAccountAndName(aConversation.account, name, aGroupByDay);</span>
<a href="#l6.187"></a><span id="l6.187">   },</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineminus">-  getSystemLogsForAccount: function logger_getSystemLogsForAccount(aAccount)</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineminus">-    this.getLogsForAccountAndName(aAccount, &quot;.system&quot;),</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineplus">+  getSystemLogsForAccount: function logger_getSystemLogsForAccount(aAccount) {</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineplus">+    return this.getLogsForAccountAndName(aAccount, &quot;.system&quot;);</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineplus">+  },</span>
<a href="#l6.193"></a><span id="l6.193">   getSimilarLogs: Task.async(function* (aLog, aGroupByDay) {</span>
<a href="#l6.194"></a><span id="l6.194">     let iterator = new OS.File.DirectoryIterator(OS.Path.dirname(aLog.path));</span>
<a href="#l6.195"></a><span id="l6.195">     let entries;</span>
<a href="#l6.196"></a><span id="l6.196">     try {</span>
<a href="#l6.197"></a><span id="l6.197">       entries = yield iterator.nextBatch();</span>
<a href="#l6.198"></a><span id="l6.198">     } catch (aError) {</span>
<a href="#l6.199"></a><span id="l6.199">       Cu.reportError(&quot;Error getting similar logs for \&quot;&quot; +</span>
<a href="#l6.200"></a><span id="l6.200">                      aLog.path + &quot;\&quot;:\n&quot; + aError);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/chat/components/src/smileProtocolHandler.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/chat/components/src/smileProtocolHandler.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -31,17 +31,17 @@ smileProtocolHandler.prototype = {</span>
<a href="#l7.4"></a><span id="l7.4">   },</span>
<a href="#l7.5"></a><span id="l7.5">   newChannel2: function SPH_newChannel2(aURI, aLoadInfo) {</span>
<a href="#l7.6"></a><span id="l7.6">     let smile = aURI.spec.replace(kSmileRegexp, &quot;&quot;);</span>
<a href="#l7.7"></a><span id="l7.7">     let uri = Services.io.newURI(getSmileRealURI(smile), null, null);</span>
<a href="#l7.8"></a><span id="l7.8">     let channel = Services.io.newChannelFromURIWithLoadInfo(uri, aLoadInfo);</span>
<a href="#l7.9"></a><span id="l7.9">     channel.originalURI = aURI;</span>
<a href="#l7.10"></a><span id="l7.10">     return channel;</span>
<a href="#l7.11"></a><span id="l7.11">   },</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  allowPort: function  SPH_allowPort(aPort, aScheme) false,</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+  allowPort: function SPH_allowPort(aPort, aScheme) { return false; },</span>
<a href="#l7.14"></a><span id="l7.14"> </span>
<a href="#l7.15"></a><span id="l7.15">   classDescription: &quot;Smile Protocol Handler&quot;,</span>
<a href="#l7.16"></a><span id="l7.16">   classID: Components.ID(&quot;{04e58eae-dfbc-4c9e-8130-6d9ef19cbff4}&quot;),</span>
<a href="#l7.17"></a><span id="l7.17">   contractID: &quot;@mozilla.org/network/protocol;1?name=smile&quot;,</span>
<a href="#l7.18"></a><span id="l7.18">   QueryInterface: XPCOMUtils.generateQI([Ci.nsIProtocolHandler])</span>
<a href="#l7.19"></a><span id="l7.19"> };</span>
<a href="#l7.20"></a><span id="l7.20"> </span>
<a href="#l7.21"></a><span id="l7.21"> const NSGetFactory = XPCOMUtils.generateNSGetFactory([smileProtocolHandler]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/chat/components/src/test/test_commands.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/chat/components/src/test/test_commands.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -27,17 +27,17 @@ const fakeAccount2 = {</span>
<a href="#l8.4"></a><span id="l8.4"> };</span>
<a href="#l8.5"></a><span id="l8.5"> </span>
<a href="#l8.6"></a><span id="l8.6"> function fakeCommand(aName, aUsageContext) {</span>
<a href="#l8.7"></a><span id="l8.7">   this.name = aName;</span>
<a href="#l8.8"></a><span id="l8.8">   if (aUsageContext)</span>
<a href="#l8.9"></a><span id="l8.9">     this.usageContext = aUsageContext;</span>
<a href="#l8.10"></a><span id="l8.10"> }</span>
<a href="#l8.11"></a><span id="l8.11"> fakeCommand.prototype = {</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  get helpString() &quot;&quot;,</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+  get helpString() { return &quot;&quot;; },</span>
<a href="#l8.14"></a><span id="l8.14">   usageContext: Ci.imICommand.CMD_CONTEXT_ALL,</span>
<a href="#l8.15"></a><span id="l8.15">   priority: Ci.imICommand.CMD_PRIORITY_PRPL,</span>
<a href="#l8.16"></a><span id="l8.16">   run: (aMsg, aConv) =&gt; true</span>
<a href="#l8.17"></a><span id="l8.17"> }</span>
<a href="#l8.18"></a><span id="l8.18"> </span>
<a href="#l8.19"></a><span id="l8.19"> function run_test() {</span>
<a href="#l8.20"></a><span id="l8.20">   let cmdserv = new imCommands.CommandsService();</span>
<a href="#l8.21"></a><span id="l8.21">   cmdserv.initCommands();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/chat/components/src/test/test_logger.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/chat/components/src/test/test_logger.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -36,48 +36,48 @@ let dummyTwitterAccount = {</span>
<a href="#l9.4"></a><span id="l9.4"> </span>
<a href="#l9.5"></a><span id="l9.5"> let test_accounts = [dummyAccount, dummyTwitterAccount];</span>
<a href="#l9.6"></a><span id="l9.6"> </span>
<a href="#l9.7"></a><span id="l9.7"> let dummyConv = {</span>
<a href="#l9.8"></a><span id="l9.8">   account: dummyAccount,</span>
<a href="#l9.9"></a><span id="l9.9">   id: 0,</span>
<a href="#l9.10"></a><span id="l9.10">   title: &quot;dummy conv&quot;,</span>
<a href="#l9.11"></a><span id="l9.11">   normalizedName: &quot;dummyconv&quot;,</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  get name() this.normalizedName,</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-  get startDate() new Date(2011, 5, 28).valueOf() * 1000,</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+  get name() { return this.normalizedName; },</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+  get startDate() { return new Date(2011, 5, 28).valueOf() * 1000; },</span>
<a href="#l9.16"></a><span id="l9.16">   isChat: false</span>
<a href="#l9.17"></a><span id="l9.17"> };</span>
<a href="#l9.18"></a><span id="l9.18"> </span>
<a href="#l9.19"></a><span id="l9.19"> // A day after the first one.</span>
<a href="#l9.20"></a><span id="l9.20"> let dummyConv2 = {</span>
<a href="#l9.21"></a><span id="l9.21">   account: dummyAccount,</span>
<a href="#l9.22"></a><span id="l9.22">   id: 0,</span>
<a href="#l9.23"></a><span id="l9.23">   title: &quot;dummy conv&quot;,</span>
<a href="#l9.24"></a><span id="l9.24">   normalizedName: &quot;dummyconv&quot;,</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-  get name() this.normalizedName,</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-  get startDate() new Date(2011, 5, 29).valueOf() * 1000,</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+  get name() { return this.normalizedName; },</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+  get startDate() { return new Date(2011, 5, 29).valueOf() * 1000; },</span>
<a href="#l9.29"></a><span id="l9.29">   isChat: false</span>
<a href="#l9.30"></a><span id="l9.30"> };</span>
<a href="#l9.31"></a><span id="l9.31"> </span>
<a href="#l9.32"></a><span id="l9.32"> let dummyMUC = {</span>
<a href="#l9.33"></a><span id="l9.33">   account: dummyAccount,</span>
<a href="#l9.34"></a><span id="l9.34">   id: 1,</span>
<a href="#l9.35"></a><span id="l9.35">   title: &quot;Dummy MUC&quot;,</span>
<a href="#l9.36"></a><span id="l9.36">   normalizedName: &quot;dummymuc&quot;,</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-  get name() this.normalizedName,</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+  get name() { return this.normalizedName; },</span>
<a href="#l9.39"></a><span id="l9.39">   startDate: new Date(2011, 5, 28).valueOf() * 1000,</span>
<a href="#l9.40"></a><span id="l9.40">   isChat: true</span>
<a href="#l9.41"></a><span id="l9.41"> };</span>
<a href="#l9.42"></a><span id="l9.42"> </span>
<a href="#l9.43"></a><span id="l9.43"> let dummyTwitterConv = {</span>
<a href="#l9.44"></a><span id="l9.44">   account: dummyTwitterAccount,</span>
<a href="#l9.45"></a><span id="l9.45">   id: 2,</span>
<a href="#l9.46"></a><span id="l9.46">   title: &quot;Dummy Twitter Conv&quot;,</span>
<a href="#l9.47"></a><span id="l9.47">   normalizedName: &quot;dummytwitterconv&quot;,</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineminus">-  get name() this.normalizedName,</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+  get name() { return this.normalizedName; },</span>
<a href="#l9.50"></a><span id="l9.50">   startDate: new Date(2011, 5, 28).valueOf() * 1000,</span>
<a href="#l9.51"></a><span id="l9.51">   isChat: true</span>
<a href="#l9.52"></a><span id="l9.52"> };</span>
<a href="#l9.53"></a><span id="l9.53"> </span>
<a href="#l9.54"></a><span id="l9.54"> let test_convs = [dummyConv, dummyMUC, dummyTwitterConv];</span>
<a href="#l9.55"></a><span id="l9.55"> </span>
<a href="#l9.56"></a><span id="l9.56"> let encodeName_input = [</span>
<a href="#l9.57"></a><span id="l9.57">   &quot;CON&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/chat/content/convbrowser.xml</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/chat/content/convbrowser.xml</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -687,17 +687,17 @@</span>
<a href="#l10.4"></a><span id="l10.4">           let maxY = this.contentWindow.scrollMaxY;</span>
<a href="#l10.5"></a><span id="l10.5">           for (let i = 0; i &lt; sectionElements.length; ++i) {</span>
<a href="#l10.6"></a><span id="l10.6">             let y = sectionElements[i].offsetTop;</span>
<a href="#l10.7"></a><span id="l10.7">             // The section is unnecessary if close to top/bottom of conversation.</span>
<a href="#l10.8"></a><span id="l10.8">             if (y &lt; this._maximalSectionOffset || maxY &lt; y)</span>
<a href="#l10.9"></a><span id="l10.9">               continue;</span>
<a href="#l10.10"></a><span id="l10.10">             sections.push([y, y - Math.round(this.clientHeight / 2)]);</span>
<a href="#l10.11"></a><span id="l10.11">           }</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-          sections.sort(function(a, b) a[0] - b[0]);</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+          sections.sort((a, b) =&gt; a[0] - b[0]);</span>
<a href="#l10.14"></a><span id="l10.14">           return sections;</span>
<a href="#l10.15"></a><span id="l10.15">         ]]&gt;</span>
<a href="#l10.16"></a><span id="l10.16">         &lt;/body&gt;</span>
<a href="#l10.17"></a><span id="l10.17">       &lt;/method&gt;</span>
<a href="#l10.18"></a><span id="l10.18"> </span>
<a href="#l10.19"></a><span id="l10.19">       &lt;method name=&quot;scrollToPreviousSection&quot;&gt;</span>
<a href="#l10.20"></a><span id="l10.20">         &lt;body&gt;</span>
<a href="#l10.21"></a><span id="l10.21">         &lt;![CDATA[</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/chat/modules/ArrayBufferUtils.jsm</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/chat/modules/ArrayBufferUtils.jsm</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -19,26 +19,34 @@ const EXPORTED_SYMBOLS = [&quot;copyBytes&quot;, &quot;</span>
<a href="#l11.4"></a><span id="l11.4">  */</span>
<a href="#l11.5"></a><span id="l11.5"> function copyBytes(aTarget, aSource, aTargetOffset = 0, aSourceOffset = 0,</span>
<a href="#l11.6"></a><span id="l11.6">                    aLength = aSource.byteLength) {</span>
<a href="#l11.7"></a><span id="l11.7">   // The rest just gets the data copied into it.</span>
<a href="#l11.8"></a><span id="l11.8">   let view = new Uint8Array(aTarget, aTargetOffset);</span>
<a href="#l11.9"></a><span id="l11.9">   view.set(new Uint8Array(aSource, aSourceOffset, aLength));</span>
<a href="#l11.10"></a><span id="l11.10"> }</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-function ArrayBufferToBytes(aBuf) [b for (b of new Uint8Array(aBuf))];</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+function ArrayBufferToBytes(aBuf) {</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+  return [...new Uint8Array(aBuf)];</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+}</span>
<a href="#l11.16"></a><span id="l11.16"> </span>
<a href="#l11.17"></a><span id="l11.17"> function BytesToArrayBuffer(aBytes = []) {</span>
<a href="#l11.18"></a><span id="l11.18">   let buf = new ArrayBuffer(aBytes.length);</span>
<a href="#l11.19"></a><span id="l11.19">   let view = new Uint8Array(buf);</span>
<a href="#l11.20"></a><span id="l11.20">   view.set(aBytes);</span>
<a href="#l11.21"></a><span id="l11.21">   return buf;</span>
<a href="#l11.22"></a><span id="l11.22"> }</span>
<a href="#l11.23"></a><span id="l11.23"> </span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-function StringToBytes(aString) [aString.charCodeAt(i) for (i in aString)];</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+function StringToBytes(aString) {</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+  return [aString.charCodeAt(i) for (i in aString)];</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+}</span>
<a href="#l11.28"></a><span id="l11.28"> </span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-function StringToArrayBuffer(aString) BytesToArrayBuffer(StringToBytes(aString))</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+function StringToArrayBuffer(aString) {</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+  return BytesToArrayBuffer(StringToBytes(aString));</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+}</span>
<a href="#l11.33"></a><span id="l11.33"> </span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-function ArrayBufferToString(aData)</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">-  [String.fromCharCode(b) for (b of new Uint8Array(aData))].join(&quot;&quot;);</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+function ArrayBufferToString(aData) {</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+  return [for (b of new Uint8Array(aData)) String.fromCharCode(b)].join(&quot;&quot;);</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+}</span>
<a href="#l11.39"></a><span id="l11.39"> </span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">-function ArrayBufferToHexString(aData)</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineminus">-  &quot;0x&quot; + [(&quot;0&quot; + b.toString(16)).slice(-2) for (b of new Uint8Array(aData))].join(&quot; &quot;);</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+function ArrayBufferToHexString(aData) {</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+  return &quot;0x&quot; + [for (b of new Uint8Array(aData)) (&quot;0&quot; + b.toString(16)).slice(-2)].join(&quot; &quot;);</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/chat/modules/hiddenWindow.jsm</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/chat/modules/hiddenWindow.jsm</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -2,19 +2,19 @@</span>
<a href="#l12.4"></a><span id="l12.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.5"></a><span id="l12.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.6"></a><span id="l12.6"> </span>
<a href="#l12.7"></a><span id="l12.7"> const EXPORTED_SYMBOLS = [&quot;getHiddenHTMLWindow&quot;];</span>
<a href="#l12.8"></a><span id="l12.8"> </span>
<a href="#l12.9"></a><span id="l12.9"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l12.10"></a><span id="l12.10"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;hiddenWindow&quot;, function()</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;hiddenWindow&quot;, () =&gt;</span>
<a href="#l12.14"></a><span id="l12.14">   Services.appShell.hiddenDOMWindow</span>
<a href="#l12.15"></a><span id="l12.15"> );</span>
<a href="#l12.16"></a><span id="l12.16"> #ifndef XP_MACOSX</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-function getHiddenHTMLWindow() hiddenWindow</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+function getHiddenHTMLWindow() { return hiddenWindow; }</span>
<a href="#l12.19"></a><span id="l12.19"> #else</span>
<a href="#l12.20"></a><span id="l12.20"> function getHiddenHTMLWindow() {</span>
<a href="#l12.21"></a><span id="l12.21">   let browser = hiddenWindow.document.getElementById(&quot;hiddenBrowser&quot;);</span>
<a href="#l12.22"></a><span id="l12.22">   return browser.docShell ? browser.contentWindow : hiddenWindow;</span>
<a href="#l12.23"></a><span id="l12.23"> }</span>
<a href="#l12.24"></a><span id="l12.24"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/chat/modules/imContentSink.jsm</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/chat/modules/imContentSink.jsm</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -28,29 +28,29 @@ const EXPORTED_SYMBOLS = [</span>
<a href="#l13.4"></a><span id="l13.4">  *  - attrs: an object containing a list of attributes allowed for all tags.</span>
<a href="#l13.5"></a><span id="l13.5">  *      example: attrs: { 'style': true }</span>
<a href="#l13.6"></a><span id="l13.6">  *</span>
<a href="#l13.7"></a><span id="l13.7">  *  - tags: an object with the allowed tags. each tag can allow specific attributes.</span>
<a href="#l13.8"></a><span id="l13.8">  *      example: 'a': {'href': true}</span>
<a href="#l13.9"></a><span id="l13.9">  *</span>
<a href="#l13.10"></a><span id="l13.10">  *    each attribute can have a function returning a boolean indicating if</span>
<a href="#l13.11"></a><span id="l13.11">  *    the attribute is accepted.</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">- *      example: 'href': function(aValue) aValue == 'about:blank'</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+ *      example: 'href': aValue =&gt; aValue == 'about:blank'</span>
<a href="#l13.14"></a><span id="l13.14">  *</span>
<a href="#l13.15"></a><span id="l13.15">  *  - styles: an object with the allowed CSS style rule.</span>
<a href="#l13.16"></a><span id="l13.16">  *      example: 'font-size': true</span>
<a href="#l13.17"></a><span id="l13.17">  *    FIXME: make this accept functions to filter the CSS values too.</span>
<a href="#l13.18"></a><span id="l13.18">  *</span>
<a href="#l13.19"></a><span id="l13.19">  *  See the 3 examples of rulesets below.</span>
<a href="#l13.20"></a><span id="l13.20">  */</span>
<a href="#l13.21"></a><span id="l13.21"> </span>
<a href="#l13.22"></a><span id="l13.22" class="difflineminus">-const kAllowedURLs = function(aValue) /^(https?|ftp|mailto):/.test(aValue);</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+const kAllowedURLs = aValue =&gt; /^(https?|ftp|mailto):/.test(aValue);</span>
<a href="#l13.24"></a><span id="l13.24"> const kAllowedMozClasses =</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineminus">-  function(aClassName) aClassName == &quot;moz-txt-underscore&quot; ||</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineminus">-                       aClassName == &quot;moz-txt-tag&quot;;</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+  aClassName =&gt; aClassName == &quot;moz-txt-underscore&quot; ||</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+                aClassName == &quot;moz-txt-tag&quot;;</span>
<a href="#l13.29"></a><span id="l13.29"> </span>
<a href="#l13.30"></a><span id="l13.30"> /* Tags whose content should be fully removed, and reported in the Error Console. */</span>
<a href="#l13.31"></a><span id="l13.31"> const kForbiddenTags = {</span>
<a href="#l13.32"></a><span id="l13.32">   script: true,</span>
<a href="#l13.33"></a><span id="l13.33">   style: true</span>
<a href="#l13.34"></a><span id="l13.34"> };</span>
<a href="#l13.35"></a><span id="l13.35"> </span>
<a href="#l13.36"></a><span id="l13.36"> // in strict mode, remove all formatings. Keep only links and line breaks.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/chat/modules/imSmileys.jsm</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/chat/modules/imSmileys.jsm</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -119,17 +119,17 @@ function getRegexp()</span>
<a href="#l14.4"></a><span id="l14.4"> </span>
<a href="#l14.5"></a><span id="l14.5">   let emoticonList = [];</span>
<a href="#l14.6"></a><span id="l14.6">   for (let emoticon in gTheme.iconsHash)</span>
<a href="#l14.7"></a><span id="l14.7">     emoticonList.push(emoticon);</span>
<a href="#l14.8"></a><span id="l14.8"> </span>
<a href="#l14.9"></a><span id="l14.9">   let exp = /[[\]{}()*+?.\\^$|]/g;</span>
<a href="#l14.10"></a><span id="l14.10">   emoticonList = emoticonList.sort()</span>
<a href="#l14.11"></a><span id="l14.11">                              .reverse()</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-                             .map(function(x) x.replace(exp, &quot;\\$&amp;&quot;));</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+                             .map(x =&gt; x.replace(exp, &quot;\\$&amp;&quot;));</span>
<a href="#l14.14"></a><span id="l14.14"> </span>
<a href="#l14.15"></a><span id="l14.15">   if (!emoticonList.length) {</span>
<a href="#l14.16"></a><span id="l14.16">     // the theme contains no valid emoticon, make sure we will return</span>
<a href="#l14.17"></a><span id="l14.17">     // early next time</span>
<a href="#l14.18"></a><span id="l14.18">     gTheme.iconsHash = null;</span>
<a href="#l14.19"></a><span id="l14.19">     return null;</span>
<a href="#l14.20"></a><span id="l14.20">   }</span>
<a href="#l14.21"></a><span id="l14.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/chat/modules/imStatusUtils.jsm</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/chat/modules/imStatusUtils.jsm</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -4,33 +4,33 @@</span>
<a href="#l15.4"></a><span id="l15.4"> </span>
<a href="#l15.5"></a><span id="l15.5"> const EXPORTED_SYMBOLS = [&quot;Status&quot;];</span>
<a href="#l15.6"></a><span id="l15.6"> </span>
<a href="#l15.7"></a><span id="l15.7"> const {interfaces: Ci, utils: Cu} = Components;</span>
<a href="#l15.8"></a><span id="l15.8"> </span>
<a href="#l15.9"></a><span id="l15.9"> Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l15.10"></a><span id="l15.10"> Cu.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, function()</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l15.14"></a><span id="l15.14">   l10nHelper(&quot;chrome://chat/locale/status.properties&quot;)</span>
<a href="#l15.15"></a><span id="l15.15"> );</span>
<a href="#l15.16"></a><span id="l15.16"> </span>
<a href="#l15.17"></a><span id="l15.17"> const imIStatusInfo = Ci.imIStatusInfo;</span>
<a href="#l15.18"></a><span id="l15.18"> let statusAttributes = {};</span>
<a href="#l15.19"></a><span id="l15.19"> statusAttributes[imIStatusInfo.STATUS_UNKNOWN] = &quot;unknown&quot;;</span>
<a href="#l15.20"></a><span id="l15.20"> statusAttributes[imIStatusInfo.STATUS_OFFLINE] = &quot;offline&quot;;</span>
<a href="#l15.21"></a><span id="l15.21"> statusAttributes[imIStatusInfo.STATUS_INVISIBLE] = &quot;invisible&quot;;</span>
<a href="#l15.22"></a><span id="l15.22"> statusAttributes[imIStatusInfo.STATUS_MOBILE] = &quot;mobile&quot;;</span>
<a href="#l15.23"></a><span id="l15.23"> statusAttributes[imIStatusInfo.STATUS_IDLE] = &quot;idle&quot;;</span>
<a href="#l15.24"></a><span id="l15.24"> statusAttributes[imIStatusInfo.STATUS_AWAY] = &quot;away&quot;;</span>
<a href="#l15.25"></a><span id="l15.25"> statusAttributes[imIStatusInfo.STATUS_UNAVAILABLE] = &quot;unavailable&quot;;</span>
<a href="#l15.26"></a><span id="l15.26"> statusAttributes[imIStatusInfo.STATUS_AVAILABLE] = &quot;available&quot;;</span>
<a href="#l15.27"></a><span id="l15.27"> </span>
<a href="#l15.28"></a><span id="l15.28"> const Status = {</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineminus">-  toAttribute: function(aStatusType)</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+  toAttribute: aStatusType =&gt;</span>
<a href="#l15.31"></a><span id="l15.31">     aStatusType in statusAttributes ? statusAttributes[aStatusType] : &quot;unknown&quot;,</span>
<a href="#l15.32"></a><span id="l15.32"> </span>
<a href="#l15.33"></a><span id="l15.33">   _labels: {},</span>
<a href="#l15.34"></a><span id="l15.34">   toLabel: function(aStatusType, aStatusText) {</span>
<a href="#l15.35"></a><span id="l15.35">     // aStatusType may be either one of the (integral) imIStatusInfo status</span>
<a href="#l15.36"></a><span id="l15.36">     // constants, or one of the statusAttributes.</span>
<a href="#l15.37"></a><span id="l15.37">     if (!(typeof aStatusType == &quot;string&quot;))</span>
<a href="#l15.38"></a><span id="l15.38">       aStatusType = this.toAttribute(aStatusType);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/chat/modules/imThemes.jsm</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/chat/modules/imThemes.jsm</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -27,23 +27,23 @@ const kShowHeaderPref = &quot;showHeader&quot;;</span>
<a href="#l16.4"></a><span id="l16.4"> const kCombineConsecutivePref = &quot;combineConsecutive&quot;;</span>
<a href="#l16.5"></a><span id="l16.5"> const kCombineConsecutiveIntervalPref = &quot;combineConsecutiveInterval&quot;;</span>
<a href="#l16.6"></a><span id="l16.6"> </span>
<a href="#l16.7"></a><span id="l16.7"> const DEFAULT_THEME = &quot;bubbles&quot;;</span>
<a href="#l16.8"></a><span id="l16.8"> const DEFAULT_THEMES = [&quot;bubbles&quot;, &quot;dark&quot;, &quot;papersheets&quot;, &quot;simple&quot;];</span>
<a href="#l16.9"></a><span id="l16.9"> </span>
<a href="#l16.10"></a><span id="l16.10"> const kLineBreak = &quot;@mozilla.org/windows-registry-key;1&quot; in Cc ? &quot;\r\n&quot; : &quot;\n&quot;;</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;gPrefBranch&quot;, function()</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;gPrefBranch&quot;, () =&gt;</span>
<a href="#l16.14"></a><span id="l16.14">   Services.prefs.getBranch(kMessagesStylePrefBranch)</span>
<a href="#l16.15"></a><span id="l16.15"> );</span>
<a href="#l16.16"></a><span id="l16.16"> </span>
<a href="#l16.17"></a><span id="l16.17"> XPCOMUtils.defineLazyGetter(this, &quot;TXTToHTML&quot;, function() {</span>
<a href="#l16.18"></a><span id="l16.18">   let cs = Cc[&quot;@mozilla.org/txttohtmlconv;1&quot;].getService(Ci.mozITXTToHTMLConv);</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineminus">-  return function(aTXT) cs.scanTXT(aTXT, cs.kEntities);</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineplus">+  return aTXT =&gt; cs.scanTXT(aTXT, cs.kEntities);</span>
<a href="#l16.21"></a><span id="l16.21"> });</span>
<a href="#l16.22"></a><span id="l16.22"> </span>
<a href="#l16.23"></a><span id="l16.23"> var gCurrentTheme = null;</span>
<a href="#l16.24"></a><span id="l16.24"> </span>
<a href="#l16.25"></a><span id="l16.25"> function getChromeFile(aURI)</span>
<a href="#l16.26"></a><span id="l16.26"> {</span>
<a href="#l16.27"></a><span id="l16.27">   try {</span>
<a href="#l16.28"></a><span id="l16.28">     let channel = Services.io.newChannel2(aURI, null, null, null,</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineat">@@ -88,30 +88,30 @@ function HTMLTheme(aBaseURI)</span>
<a href="#l16.30"></a><span id="l16.30">       Object.defineProperty(this, id, {value: html});</span>
<a href="#l16.31"></a><span id="l16.31">   }</span>
<a href="#l16.32"></a><span id="l16.32"> </span>
<a href="#l16.33"></a><span id="l16.33">   if (!(&quot;incomingContent&quot; in files))</span>
<a href="#l16.34"></a><span id="l16.34">     throw &quot;Invalid theme: Incoming/Content.html is missing!&quot;;</span>
<a href="#l16.35"></a><span id="l16.35"> }</span>
<a href="#l16.36"></a><span id="l16.36"> </span>
<a href="#l16.37"></a><span id="l16.37"> HTMLTheme.prototype = {</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineminus">-  get footer() &quot;&quot;,</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineminus">-  get header() &quot;&quot;,</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineminus">-  get status() this.incomingContent,</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineminus">-  get statusNext() this.status,</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+  get footer() { return &quot;&quot;; },</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineplus">+  get header() { return &quot;&quot;; },</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineplus">+  get status() { return this.incomingContent; },</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineplus">+  get statusNext() { return this.status; },</span>
<a href="#l16.46"></a><span id="l16.46">   get incomingContent() {</span>
<a href="#l16.47"></a><span id="l16.47">     throw &quot;Incoming/Content.html is a required file&quot;;</span>
<a href="#l16.48"></a><span id="l16.48">   },</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineminus">-  get incomingNextContent() this.incomingContent,</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineminus">-  get outgoingContent() this.incomingContent,</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineminus">-  get outgoingNextContent() this.incomingNextContent,</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineminus">-  get incomingContext() this.incomingContent,</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineminus">-  get incomingNextContext() this.incomingNextContent,</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineminus">-  get outgoingContext() this.hasOwnProperty(&quot;outgoingContent&quot;) ? this.outgoingContent : this.incomingContext,</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineminus">-  get outgoingNextContext() this.hasOwnProperty(&quot;outgoingNextContent&quot;) ? this.outgoingNextContent : this.incomingNextContext</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineplus">+  get incomingNextContent() { return this.incomingContent; },</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineplus">+  get outgoingContent() { return this.incomingContent; },</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineplus">+  get outgoingNextContent() { return this.incomingNextContent; },</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineplus">+  get incomingContext() { return this.incomingContent; },</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+  get incomingNextContext() { return this.incomingNextContent; },</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineplus">+  get outgoingContext() { return this.hasOwnProperty(&quot;outgoingContent&quot;) ? this.outgoingContent : this.incomingContext; },</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineplus">+  get outgoingNextContext() { return this.hasOwnProperty(&quot;outgoingNextContent&quot;) ? this.outgoingNextContent : this.incomingNextContext; }</span>
<a href="#l16.63"></a><span id="l16.63"> };</span>
<a href="#l16.64"></a><span id="l16.64"> </span>
<a href="#l16.65"></a><span id="l16.65"> function plistToJSON(aElt)</span>
<a href="#l16.66"></a><span id="l16.66"> {</span>
<a href="#l16.67"></a><span id="l16.67">   switch (aElt.localName) {</span>
<a href="#l16.68"></a><span id="l16.68">     case 'true':</span>
<a href="#l16.69"></a><span id="l16.69">       return true;</span>
<a href="#l16.70"></a><span id="l16.70">     case 'false':</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineat">@@ -286,18 +286,18 @@ function getDirectoryEntries(aDir)</span>
<a href="#l16.72"></a><span id="l16.72">   }</span>
<a href="#l16.73"></a><span id="l16.73"> </span>
<a href="#l16.74"></a><span id="l16.74">   return results;</span>
<a href="#l16.75"></a><span id="l16.75"> }</span>
<a href="#l16.76"></a><span id="l16.76"> </span>
<a href="#l16.77"></a><span id="l16.77"> function getThemeVariants(aTheme)</span>
<a href="#l16.78"></a><span id="l16.78"> {</span>
<a href="#l16.79"></a><span id="l16.79">   let variants = getDirectoryEntries(aTheme.baseURI + &quot;Variants/&quot;);</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineminus">-  return variants.filter(function(v) v.endsWith(&quot;.css&quot;))</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineminus">-                 .map(function(v) v.substring(0, v.length - 4));</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineplus">+  return variants.filter(v =&gt; v.endsWith(&quot;.css&quot;))</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineplus">+                 .map(v =&gt; v.substring(0, v.length - 4));</span>
<a href="#l16.84"></a><span id="l16.84"> }</span>
<a href="#l16.85"></a><span id="l16.85"> </span>
<a href="#l16.86"></a><span id="l16.86"> /* helper function for replacements in messages */</span>
<a href="#l16.87"></a><span id="l16.87"> function getBuddyFromMessage(aMsg)</span>
<a href="#l16.88"></a><span id="l16.88"> {</span>
<a href="#l16.89"></a><span id="l16.89">   if (aMsg.incoming) {</span>
<a href="#l16.90"></a><span id="l16.90">     let conv = aMsg.conversation;</span>
<a href="#l16.91"></a><span id="l16.91">     if (!conv.isChat)</span>
<a href="#l16.92"></a><span id="l16.92" class="difflineat">@@ -320,52 +320,53 @@ function getStatusIconFromBuddy(aBuddy)</span>
<a href="#l16.93"></a><span id="l16.93">     else</span>
<a href="#l16.94"></a><span id="l16.94">       status = &quot;available&quot;;</span>
<a href="#l16.95"></a><span id="l16.95">   }</span>
<a href="#l16.96"></a><span id="l16.96"> </span>
<a href="#l16.97"></a><span id="l16.97">   return &quot;chrome://chat/skin/&quot; + status + &quot;-16.png&quot;;</span>
<a href="#l16.98"></a><span id="l16.98"> }</span>
<a href="#l16.99"></a><span id="l16.99"> </span>
<a href="#l16.100"></a><span id="l16.100"> const headerFooterReplacements = {</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineminus">-  chatName: function(aConv) TXTToHTML(aConv.title),</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineminus">-  sourceName: function(aConv) TXTToHTML(aConv.account.alias || aConv.account.name),</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineminus">-  destinationName: function(aConv) TXTToHTML(aConv.name),</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineminus">-  destinationDisplayName: function(aConv) TXTToHTML(aConv.title),</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineplus">+  chatName: aConv =&gt; TXTToHTML(aConv.title),</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineplus">+  sourceName: aConv =&gt; TXTToHTML(aConv.account.alias || aConv.account.name),</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineplus">+  destinationName: aConv =&gt; TXTToHTML(aConv.name),</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineplus">+  destinationDisplayName: aConv =&gt; TXTToHTML(aConv.title),</span>
<a href="#l16.109"></a><span id="l16.109">   incomingIconPath: function(aConv) {</span>
<a href="#l16.110"></a><span id="l16.110">     let buddy;</span>
<a href="#l16.111"></a><span id="l16.111">     return (!aConv.isChat &amp;&amp; (buddy = aConv.buddy) &amp;&amp;</span>
<a href="#l16.112"></a><span id="l16.112">             buddy.buddyIconFilename) || &quot;incoming_icon.png&quot;;</span>
<a href="#l16.113"></a><span id="l16.113">   },</span>
<a href="#l16.114"></a><span id="l16.114" class="difflineminus">-  outgoingIconPath: function(aConv) &quot;outgoing_icon.png&quot;,</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineplus">+  outgoingIconPath: aConv =&gt; &quot;outgoing_icon.png&quot;,</span>
<a href="#l16.116"></a><span id="l16.116">   timeOpened: function(aConv, aFormat) {</span>
<a href="#l16.117"></a><span id="l16.117">     let date = new Date(aConv.startDate / 1000);</span>
<a href="#l16.118"></a><span id="l16.118">     if (aFormat)</span>
<a href="#l16.119"></a><span id="l16.119">       return date.toLocaleFormat(aFormat);</span>
<a href="#l16.120"></a><span id="l16.120">     else</span>
<a href="#l16.121"></a><span id="l16.121">       return date.toLocaleTimeString();</span>
<a href="#l16.122"></a><span id="l16.122">   }</span>
<a href="#l16.123"></a><span id="l16.123"> };</span>
<a href="#l16.124"></a><span id="l16.124"> </span>
<a href="#l16.125"></a><span id="l16.125" class="difflineminus">-function formatAutoResponce(aTxt)</span>
<a href="#l16.126"></a><span id="l16.126" class="difflineminus">-  Services.strings</span>
<a href="#l16.127"></a><span id="l16.127" class="difflineminus">-          .createBundle(&quot;chrome://chat/locale/conversations.properties&quot;)</span>
<a href="#l16.128"></a><span id="l16.128" class="difflineminus">-          .formatStringFromName(&quot;autoReply&quot;, [aTxt], 1)</span>
<a href="#l16.129"></a><span id="l16.129" class="difflineplus">+function formatAutoResponce(aTxt) {</span>
<a href="#l16.130"></a><span id="l16.130" class="difflineplus">+  return Services.strings</span>
<a href="#l16.131"></a><span id="l16.131" class="difflineplus">+                 .createBundle(&quot;chrome://chat/locale/conversations.properties&quot;)</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineplus">+                 .formatStringFromName(&quot;autoReply&quot;, [aTxt], 1);</span>
<a href="#l16.133"></a><span id="l16.133" class="difflineplus">+}</span>
<a href="#l16.134"></a><span id="l16.134"> </span>
<a href="#l16.135"></a><span id="l16.135"> const statusMessageReplacements = {</span>
<a href="#l16.136"></a><span id="l16.136" class="difflineminus">-  message: function(aMsg) &quot;&lt;span class=\&quot;ib-msg-txt\&quot;&gt;&quot; +</span>
<a href="#l16.137"></a><span id="l16.137" class="difflineminus">-                          (aMsg.autoResponse ? formatAutoResponce(aMsg.message) : aMsg.message) +</span>
<a href="#l16.138"></a><span id="l16.138" class="difflineminus">-                          &quot;&lt;/span&gt;&quot;,</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineplus">+  message: aMsg =&gt; &quot;&lt;span class=\&quot;ib-msg-txt\&quot;&gt;&quot; +</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineplus">+                   (aMsg.autoResponse ? formatAutoResponce(aMsg.message) : aMsg.message) +</span>
<a href="#l16.141"></a><span id="l16.141" class="difflineplus">+                   &quot;&lt;/span&gt;&quot;,</span>
<a href="#l16.142"></a><span id="l16.142">   time: function(aMsg, aFormat) {</span>
<a href="#l16.143"></a><span id="l16.143">     let date = new Date(aMsg.time * 1000);</span>
<a href="#l16.144"></a><span id="l16.144">     if (aFormat)</span>
<a href="#l16.145"></a><span id="l16.145">       return date.toLocaleFormat(aFormat);</span>
<a href="#l16.146"></a><span id="l16.146">     return date.toLocaleTimeString();</span>
<a href="#l16.147"></a><span id="l16.147">   },</span>
<a href="#l16.148"></a><span id="l16.148" class="difflineminus">-  timestamp: function(aMsg) aMsg.time,</span>
<a href="#l16.149"></a><span id="l16.149" class="difflineminus">-  shortTime: function(aMsg) (new Date(aMsg.time * 1000)).toLocaleTimeString(),</span>
<a href="#l16.150"></a><span id="l16.150" class="difflineplus">+  timestamp: aMsg =&gt; aMsg.time,</span>
<a href="#l16.151"></a><span id="l16.151" class="difflineplus">+  shortTime: aMsg =&gt; (new Date(aMsg.time * 1000)).toLocaleTimeString(),</span>
<a href="#l16.152"></a><span id="l16.152">   messageClasses: function(aMsg) {</span>
<a href="#l16.153"></a><span id="l16.153">     let msgClass = [];</span>
<a href="#l16.154"></a><span id="l16.154"> </span>
<a href="#l16.155"></a><span id="l16.155">     if (aMsg.system)</span>
<a href="#l16.156"></a><span id="l16.156">       msgClass.push(&quot;event&quot;);</span>
<a href="#l16.157"></a><span id="l16.157">     else {</span>
<a href="#l16.158"></a><span id="l16.158">       msgClass.push(&quot;message&quot;);</span>
<a href="#l16.159"></a><span id="l16.159"> </span>
<a href="#l16.160"></a><span id="l16.160" class="difflineat">@@ -391,18 +392,19 @@ const statusMessageReplacements = {</span>
<a href="#l16.161"></a><span id="l16.161">       msgClass.push(&quot;notification&quot;);</span>
<a href="#l16.162"></a><span id="l16.162">     if (aMsg.noFormat)</span>
<a href="#l16.163"></a><span id="l16.163">       msgClass.push(&quot;monospaced&quot;);</span>
<a href="#l16.164"></a><span id="l16.164"> </span>
<a href="#l16.165"></a><span id="l16.165">     return msgClass.join(&quot; &quot;);</span>
<a href="#l16.166"></a><span id="l16.166">   }</span>
<a href="#l16.167"></a><span id="l16.167"> };</span>
<a href="#l16.168"></a><span id="l16.168"> </span>
<a href="#l16.169"></a><span id="l16.169" class="difflineminus">-function formatSender(aName)</span>
<a href="#l16.170"></a><span id="l16.170" class="difflineminus">-  &quot;&lt;span class=\&quot;ib-sender\&quot;&gt;&quot; + TXTToHTML(aName) + &quot;&lt;/span&gt;&quot;;</span>
<a href="#l16.171"></a><span id="l16.171" class="difflineplus">+function formatSender(aName) {</span>
<a href="#l16.172"></a><span id="l16.172" class="difflineplus">+  return &quot;&lt;span class=\&quot;ib-sender\&quot;&gt;&quot; + TXTToHTML(aName) + &quot;&lt;/span&gt;&quot;;</span>
<a href="#l16.173"></a><span id="l16.173" class="difflineplus">+}</span>
<a href="#l16.174"></a><span id="l16.174"> const messageReplacements = {</span>
<a href="#l16.175"></a><span id="l16.175">   userIconPath: function (aMsg) {</span>
<a href="#l16.176"></a><span id="l16.176">     // If the protocol plugin provides an icon for the message, use it.</span>
<a href="#l16.177"></a><span id="l16.177">     let iconURL = aMsg.iconURL;</span>
<a href="#l16.178"></a><span id="l16.178">     if (iconURL)</span>
<a href="#l16.179"></a><span id="l16.179">       return iconURL;</span>
<a href="#l16.180"></a><span id="l16.180"> </span>
<a href="#l16.181"></a><span id="l16.181">     // For outgoing messages, use the current user icon.</span>
<a href="#l16.182"></a><span id="l16.182" class="difflineat">@@ -410,32 +412,31 @@ const messageReplacements = {</span>
<a href="#l16.183"></a><span id="l16.183">       iconURL = aMsg.conversation.account.statusInfo.getUserIcon();</span>
<a href="#l16.184"></a><span id="l16.184">       if (iconURL)</span>
<a href="#l16.185"></a><span id="l16.185">         return iconURL.spec;</span>
<a href="#l16.186"></a><span id="l16.186">     }</span>
<a href="#l16.187"></a><span id="l16.187"> </span>
<a href="#l16.188"></a><span id="l16.188">     // Fallback to the theme's default icons.</span>
<a href="#l16.189"></a><span id="l16.189">     return (aMsg.incoming ? &quot;Incoming&quot; : &quot;Outgoing&quot;) + &quot;/buddy_icon.png&quot;;</span>
<a href="#l16.190"></a><span id="l16.190">   },</span>
<a href="#l16.191"></a><span id="l16.191" class="difflineminus">-  senderScreenName: function(aMsg) formatSender(aMsg.who),</span>
<a href="#l16.192"></a><span id="l16.192" class="difflineminus">-  sender: function(aMsg) formatSender(aMsg.alias || aMsg.who),</span>
<a href="#l16.193"></a><span id="l16.193" class="difflineminus">-  senderColor: function(aMsg) aMsg.color,</span>
<a href="#l16.194"></a><span id="l16.194" class="difflineminus">-  senderStatusIcon: function(aMsg)</span>
<a href="#l16.195"></a><span id="l16.195" class="difflineminus">-    getStatusIconFromBuddy(getBuddyFromMessage(aMsg)),</span>
<a href="#l16.196"></a><span id="l16.196" class="difflineminus">-  messageDirection: function(aMsg) &quot;ltr&quot;,</span>
<a href="#l16.197"></a><span id="l16.197" class="difflineplus">+  senderScreenName: aMsg =&gt; formatSender(aMsg.who),</span>
<a href="#l16.198"></a><span id="l16.198" class="difflineplus">+  sender: aMsg =&gt; formatSender(aMsg.alias || aMsg.who),</span>
<a href="#l16.199"></a><span id="l16.199" class="difflineplus">+  senderColor: aMsg =&gt; aMsg.color,</span>
<a href="#l16.200"></a><span id="l16.200" class="difflineplus">+  senderStatusIcon: aMsg =&gt; getStatusIconFromBuddy(getBuddyFromMessage(aMsg)),</span>
<a href="#l16.201"></a><span id="l16.201" class="difflineplus">+  messageDirection: aMsg =&gt; &quot;ltr&quot;,</span>
<a href="#l16.202"></a><span id="l16.202">   // no theme actually use this, don't bother making sure this is the real</span>
<a href="#l16.203"></a><span id="l16.203">   // serverside alias</span>
<a href="#l16.204"></a><span id="l16.204" class="difflineminus">-  senderDisplayName: function(aMsg) formatSender(aMsg.alias || aMsg.who),</span>
<a href="#l16.205"></a><span id="l16.205" class="difflineminus">-  service: function(aMsg) aMsg.conversation.account.protocol.name,</span>
<a href="#l16.206"></a><span id="l16.206" class="difflineminus">-  textbackgroundcolor: function(aMsg, aFormat) &quot;transparent&quot;, // FIXME?</span>
<a href="#l16.207"></a><span id="l16.207" class="difflineplus">+  senderDisplayName: aMsg =&gt; formatSender(aMsg.alias || aMsg.who),</span>
<a href="#l16.208"></a><span id="l16.208" class="difflineplus">+  service: aMsg =&gt; aMsg.conversation.account.protocol.name,</span>
<a href="#l16.209"></a><span id="l16.209" class="difflineplus">+  textbackgroundcolor: (aMsg, aFormat) =&gt; &quot;transparent&quot;, // FIXME?</span>
<a href="#l16.210"></a><span id="l16.210">   __proto__: statusMessageReplacements</span>
<a href="#l16.211"></a><span id="l16.211"> };</span>
<a href="#l16.212"></a><span id="l16.212"> </span>
<a href="#l16.213"></a><span id="l16.213"> const statusReplacements = {</span>
<a href="#l16.214"></a><span id="l16.214" class="difflineminus">-  status: function(aMsg) &quot;&quot;, //FIXME</span>
<a href="#l16.215"></a><span id="l16.215" class="difflineplus">+  status: aMsg =&gt; &quot;&quot;, //FIXME</span>
<a href="#l16.216"></a><span id="l16.216">   statusIcon: function(aMsg) {</span>
<a href="#l16.217"></a><span id="l16.217">     let conv = aMsg.conversation;</span>
<a href="#l16.218"></a><span id="l16.218">     let buddy = null;</span>
<a href="#l16.219"></a><span id="l16.219">     if (!conv.isChat)</span>
<a href="#l16.220"></a><span id="l16.220">       buddy = conv.buddy;</span>
<a href="#l16.221"></a><span id="l16.221">     return getStatusIconFromBuddy(buddy);</span>
<a href="#l16.222"></a><span id="l16.222">   },</span>
<a href="#l16.223"></a><span id="l16.223">   __proto__: statusMessageReplacements</span>
<a href="#l16.224"></a><span id="l16.224" class="difflineat">@@ -690,17 +691,17 @@ function serializeSelection(aSelection)</span>
<a href="#l16.225"></a><span id="l16.225"> </span>
<a href="#l16.226"></a><span id="l16.226">   for (let i = 0; i &lt; aSelection.rangeCount; ++i) {</span>
<a href="#l16.227"></a><span id="l16.227">     let range = aSelection.getRangeAt(i);</span>
<a href="#l16.228"></a><span id="l16.228">     let messages = getMessagesForRange(range);</span>
<a href="#l16.229"></a><span id="l16.229"> </span>
<a href="#l16.230"></a><span id="l16.230">     // If at least one selected message has some of its text selected,</span>
<a href="#l16.231"></a><span id="l16.231">     // remove from the selection all the messages that have no text</span>
<a href="#l16.232"></a><span id="l16.232">     // selected</span>
<a href="#l16.233"></a><span id="l16.233" class="difflineminus">-    let testFunction = function(msg) msg.isTextSelected();</span>
<a href="#l16.234"></a><span id="l16.234" class="difflineplus">+    let testFunction = msg =&gt; msg.isTextSelected();</span>
<a href="#l16.235"></a><span id="l16.235">     if (messages.some(testFunction))</span>
<a href="#l16.236"></a><span id="l16.236">       messages = messages.filter(testFunction);</span>
<a href="#l16.237"></a><span id="l16.237"> </span>
<a href="#l16.238"></a><span id="l16.238">     if (!messages.length) {</span>
<a href="#l16.239"></a><span id="l16.239">       // Do it only if it wouldn't override a better already found selection</span>
<a href="#l16.240"></a><span id="l16.240">       if (!shortSelection)</span>
<a href="#l16.241"></a><span id="l16.241">         shortSelection = serializeRange(range);</span>
<a href="#l16.242"></a><span id="l16.242">       continue;</span>
<a href="#l16.243"></a><span id="l16.243" class="difflineat">@@ -748,17 +749,17 @@ function serializeSelection(aSelection)</span>
<a href="#l16.244"></a><span id="l16.244"> </span>
<a href="#l16.245"></a><span id="l16.245"> function SelectedMessage(aRootNode, aRange)</span>
<a href="#l16.246"></a><span id="l16.246"> {</span>
<a href="#l16.247"></a><span id="l16.247">   this._rootNodes = [aRootNode];</span>
<a href="#l16.248"></a><span id="l16.248">   this._range = aRange;</span>
<a href="#l16.249"></a><span id="l16.249"> }</span>
<a href="#l16.250"></a><span id="l16.250"> </span>
<a href="#l16.251"></a><span id="l16.251"> SelectedMessage.prototype = {</span>
<a href="#l16.252"></a><span id="l16.252" class="difflineminus">-  get msg() this._rootNodes[0]._originalMsg,</span>
<a href="#l16.253"></a><span id="l16.253" class="difflineplus">+  get msg() { return this._rootNodes[0]._originalMsg; },</span>
<a href="#l16.254"></a><span id="l16.254">   addRoot: function(aRootNode) {</span>
<a href="#l16.255"></a><span id="l16.255">     this._rootNodes.push(aRootNode);</span>
<a href="#l16.256"></a><span id="l16.256">   },</span>
<a href="#l16.257"></a><span id="l16.257"> </span>
<a href="#l16.258"></a><span id="l16.258">   // Helper function that returns the first span node of class</span>
<a href="#l16.259"></a><span id="l16.259">   // ib-msg-text under the rootNodes of the selected message.</span>
<a href="#l16.260"></a><span id="l16.260">   _getSpanNode: function() {</span>
<a href="#l16.261"></a><span id="l16.261">     // first use the cached value if any</span>
<a href="#l16.262"></a><span id="l16.262" class="difflineat">@@ -915,18 +916,18 @@ SelectedMessage.prototype = {</span>
<a href="#l16.263"></a><span id="l16.263">       }</span>
<a href="#l16.264"></a><span id="l16.264">     }</span>
<a href="#l16.265"></a><span id="l16.265"> </span>
<a href="#l16.266"></a><span id="l16.266">     // Overrides default replacements so that they don't add a span node.</span>
<a href="#l16.267"></a><span id="l16.267">     // Also, this uses directly the text variable so that we don't</span>
<a href="#l16.268"></a><span id="l16.268">     // have to change the content of msg.message and revert it</span>
<a href="#l16.269"></a><span id="l16.269">     // afterwards.</span>
<a href="#l16.270"></a><span id="l16.270">     replacements = {</span>
<a href="#l16.271"></a><span id="l16.271" class="difflineminus">-      message: function(aMsg) text,</span>
<a href="#l16.272"></a><span id="l16.272" class="difflineminus">-      sender: function(aMsg) aMsg.alias || aMsg.who,</span>
<a href="#l16.273"></a><span id="l16.273" class="difflineplus">+      message: aMsg =&gt; text,</span>
<a href="#l16.274"></a><span id="l16.274" class="difflineplus">+      sender: aMsg =&gt; aMsg.alias || aMsg.who,</span>
<a href="#l16.275"></a><span id="l16.275">       __proto__: replacements</span>
<a href="#l16.276"></a><span id="l16.276">     };</span>
<a href="#l16.277"></a><span id="l16.277"> </span>
<a href="#l16.278"></a><span id="l16.278">     // Finally, let the theme system do the magic!</span>
<a href="#l16.279"></a><span id="l16.279">     return replaceKeywordsInHTML(html, replacements, msg);</span>
<a href="#l16.280"></a><span id="l16.280">   }</span>
<a href="#l16.281"></a><span id="l16.281"> };</span>
<a href="#l16.282"></a><span id="l16.282"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/chat/modules/imXPCOMUtils.jsm</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/chat/modules/imXPCOMUtils.jsm</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -123,17 +123,17 @@ XPCOMUtils.defineLazyGetter(Cu.getGlobal</span>
<a href="#l17.4"></a><span id="l17.4">       logLevels[&quot;level&quot; + pref.substr(kLogLevelPref.length)] = Services.prefs.getIntPref(pref);</span>
<a href="#l17.5"></a><span id="l17.5">   }</span>
<a href="#l17.6"></a><span id="l17.6"> </span>
<a href="#l17.7"></a><span id="l17.7">   // Let environment variables override prefs.</span>
<a href="#l17.8"></a><span id="l17.8">   Cc[&quot;@mozilla.org/process/environment;1&quot;]</span>
<a href="#l17.9"></a><span id="l17.9">     .getService(Ci.nsIEnvironment)</span>
<a href="#l17.10"></a><span id="l17.10">     .get(&quot;PRPL_LOG&quot;)</span>
<a href="#l17.11"></a><span id="l17.11">     .split(/[;,]/)</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-    .filter(function(n) n != &quot;&quot;)</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+    .filter(n =&gt; n != &quot;&quot;)</span>
<a href="#l17.14"></a><span id="l17.14">     .forEach(function(env) {</span>
<a href="#l17.15"></a><span id="l17.15">       let [, module, level] = env.match(/(?:(.*?)[:=])?(\d+)/);</span>
<a href="#l17.16"></a><span id="l17.16">       logLevels[&quot;level&quot; + (module ? &quot;.&quot; + module : &quot;&quot;)] = parseInt(level, 10);</span>
<a href="#l17.17"></a><span id="l17.17">     });</span>
<a href="#l17.18"></a><span id="l17.18"> </span>
<a href="#l17.19"></a><span id="l17.19">   return logLevels;</span>
<a href="#l17.20"></a><span id="l17.20"> });</span>
<a href="#l17.21"></a><span id="l17.21"> </span>
<a href="#l17.22"></a><span id="l17.22" class="difflineat">@@ -171,35 +171,35 @@ function ClassInfo(aInterfaces, aDescrip</span>
<a href="#l17.23"></a><span id="l17.23">   if (!Array.isArray(aInterfaces))</span>
<a href="#l17.24"></a><span id="l17.24">     aInterfaces = [aInterfaces];</span>
<a href="#l17.25"></a><span id="l17.25"> </span>
<a href="#l17.26"></a><span id="l17.26">   for each (let i in aInterfaces)</span>
<a href="#l17.27"></a><span id="l17.27">     if (typeof i == &quot;string&quot; &amp;&amp; !(i in Ci))</span>
<a href="#l17.28"></a><span id="l17.28">       Services.console.logStringMessage(&quot;ClassInfo: unknown interface &quot; + i);</span>
<a href="#l17.29"></a><span id="l17.29"> </span>
<a href="#l17.30"></a><span id="l17.30">   this._interfaces =</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">-    aInterfaces.map(function (i) typeof i == &quot;string&quot; ? Ci[i] : i);</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+    aInterfaces.map(i =&gt; typeof i == &quot;string&quot; ? Ci[i] : i);</span>
<a href="#l17.33"></a><span id="l17.33"> </span>
<a href="#l17.34"></a><span id="l17.34">   this.classDescription = aDescription;</span>
<a href="#l17.35"></a><span id="l17.35"> }</span>
<a href="#l17.36"></a><span id="l17.36"> ClassInfo.prototype = {</span>
<a href="#l17.37"></a><span id="l17.37">   QueryInterface: function ClassInfo_QueryInterface(iid) {</span>
<a href="#l17.38"></a><span id="l17.38">     if (iid.equals(Ci.nsISupports) || iid.equals(Ci.nsIClassInfo) ||</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineminus">-        this._interfaces.some(function(i) i.equals(iid)))</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+        this._interfaces.some(i =&gt; i.equals(iid)))</span>
<a href="#l17.41"></a><span id="l17.41">       return this;</span>
<a href="#l17.42"></a><span id="l17.42"> </span>
<a href="#l17.43"></a><span id="l17.43">     throw Cr.NS_ERROR_NO_INTERFACE;</span>
<a href="#l17.44"></a><span id="l17.44">   },</span>
<a href="#l17.45"></a><span id="l17.45">   getInterfaces: function(countRef) {</span>
<a href="#l17.46"></a><span id="l17.46">     let interfaces =</span>
<a href="#l17.47"></a><span id="l17.47">       [Ci.nsIClassInfo, Ci.nsISupports].concat(this._interfaces);</span>
<a href="#l17.48"></a><span id="l17.48">     countRef.value = interfaces.length;</span>
<a href="#l17.49"></a><span id="l17.49">     return interfaces;</span>
<a href="#l17.50"></a><span id="l17.50">   },</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineminus">-  getHelperForLanguage: function(language) null,</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineplus">+  getHelperForLanguage: language =&gt; null,</span>
<a href="#l17.53"></a><span id="l17.53">   contractID: null,</span>
<a href="#l17.54"></a><span id="l17.54">   classID: null,</span>
<a href="#l17.55"></a><span id="l17.55">   implementationLanguage: Ci.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l17.56"></a><span id="l17.56">   flags: 0</span>
<a href="#l17.57"></a><span id="l17.57"> };</span>
<a href="#l17.58"></a><span id="l17.58"> </span>
<a href="#l17.59"></a><span id="l17.59"> function l10nHelper(aChromeURL)</span>
<a href="#l17.60"></a><span id="l17.60"> {</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineat">@@ -227,23 +227,23 @@ function l10nHelper(aChromeURL)</span>
<a href="#l17.62"></a><span id="l17.62">  *   the items, which must all implement nsISupports</span>
<a href="#l17.63"></a><span id="l17.63">  */</span>
<a href="#l17.64"></a><span id="l17.64"> function nsSimpleEnumerator(items)</span>
<a href="#l17.65"></a><span id="l17.65"> {</span>
<a href="#l17.66"></a><span id="l17.66">   this._items = items;</span>
<a href="#l17.67"></a><span id="l17.67">   this._nextIndex = 0;</span>
<a href="#l17.68"></a><span id="l17.68"> }</span>
<a href="#l17.69"></a><span id="l17.69"> nsSimpleEnumerator.prototype = {</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineminus">-  hasMoreElements: function() this._nextIndex &lt; this._items.length,</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineplus">+  hasMoreElements: function() { return this._nextIndex &lt; this._items.length; },</span>
<a href="#l17.72"></a><span id="l17.72">   getNext: function() {</span>
<a href="#l17.73"></a><span id="l17.73">     if (!this.hasMoreElements())</span>
<a href="#l17.74"></a><span id="l17.74">       throw Cr.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l17.75"></a><span id="l17.75"> </span>
<a href="#l17.76"></a><span id="l17.76">     return this._items[this._nextIndex++];</span>
<a href="#l17.77"></a><span id="l17.77">   },</span>
<a href="#l17.78"></a><span id="l17.78">   QueryInterface: XPCOMUtils.generateQI([Ci.nsISimpleEnumerator])</span>
<a href="#l17.79"></a><span id="l17.79"> };</span>
<a href="#l17.80"></a><span id="l17.80"> </span>
<a href="#l17.81"></a><span id="l17.81"> const EmptyEnumerator = {</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineminus">-  hasMoreElements: function() false,</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineplus">+  hasMoreElements: () =&gt; false,</span>
<a href="#l17.84"></a><span id="l17.84">   getNext: function() { throw Cr.NS_ERROR_NOT_AVAILABLE; },</span>
<a href="#l17.85"></a><span id="l17.85">   QueryInterface: XPCOMUtils.generateQI([Ci.nsISimpleEnumerator])</span>
<a href="#l17.86"></a><span id="l17.86"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/chat/modules/jsProtoHelper.jsm</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/chat/modules/jsProtoHelper.jsm</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -15,46 +15,46 @@ const EXPORTED_SYMBOLS = [</span>
<a href="#l18.4"></a><span id="l18.4">   &quot;TooltipInfo&quot;</span>
<a href="#l18.5"></a><span id="l18.5"> ];</span>
<a href="#l18.6"></a><span id="l18.6"> </span>
<a href="#l18.7"></a><span id="l18.7"> const {classes: Cc, interfaces: Ci, results: Cr, utils: Cu} = Components;</span>
<a href="#l18.8"></a><span id="l18.8"> </span>
<a href="#l18.9"></a><span id="l18.9"> Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l18.10"></a><span id="l18.10"> Cu.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, function()</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l18.14"></a><span id="l18.14">   l10nHelper(&quot;chrome://chat/locale/conversations.properties&quot;)</span>
<a href="#l18.15"></a><span id="l18.15"> );</span>
<a href="#l18.16"></a><span id="l18.16"> </span>
<a href="#l18.17"></a><span id="l18.17"> const GenericAccountPrototype = {</span>
<a href="#l18.18"></a><span id="l18.18">   __proto__: ClassInfo(&quot;prplIAccount&quot;, &quot;generic account object&quot;),</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineminus">-  get wrappedJSObject() this,</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineplus">+  get wrappedJSObject() { return this; },</span>
<a href="#l18.21"></a><span id="l18.21">   _init: function _init(aProtocol, aImAccount) {</span>
<a href="#l18.22"></a><span id="l18.22">     this.protocol = aProtocol;</span>
<a href="#l18.23"></a><span id="l18.23">     this.imAccount = aImAccount;</span>
<a href="#l18.24"></a><span id="l18.24">     initLogModule(aProtocol.id, this);</span>
<a href="#l18.25"></a><span id="l18.25">   },</span>
<a href="#l18.26"></a><span id="l18.26">   observe: function(aSubject, aTopic, aData) {},</span>
<a href="#l18.27"></a><span id="l18.27">   remove: function() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l18.28"></a><span id="l18.28">   unInit: function() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l18.29"></a><span id="l18.29">   connect: function() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l18.30"></a><span id="l18.30">   disconnect: function() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l18.31"></a><span id="l18.31">   createConversation: function(aName) { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l18.32"></a><span id="l18.32">   joinChat: function(aComponents) { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l18.33"></a><span id="l18.33">   setBool: function(aName, aVal) {},</span>
<a href="#l18.34"></a><span id="l18.34">   setInt: function(aName, aVal) {},</span>
<a href="#l18.35"></a><span id="l18.35">   setString: function(aName, aVal) {},</span>
<a href="#l18.36"></a><span id="l18.36"> </span>
<a href="#l18.37"></a><span id="l18.37" class="difflineminus">-  get name() this.imAccount.name,</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineminus">-  get connected() this.imAccount.connected,</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineminus">-  get connecting() this.imAccount.connecting,</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineminus">-  get disconnected() this.imAccount.disconnected,</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineminus">-  get disconnecting() this.imAccount.disconnecting,</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineplus">+  get name() { return this.imAccount.name; },</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineplus">+  get connected() { return this.imAccount.connected; },</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineplus">+  get connecting() { return this.imAccount.connecting; },</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineplus">+  get disconnected() { return this.imAccount.disconnected; },</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineplus">+  get disconnecting() { return this.imAccount.disconnecting; },</span>
<a href="#l18.47"></a><span id="l18.47">   _connectionErrorReason: Ci.prplIAccount.NO_ERROR,</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineminus">-  get connectionErrorReason() this._connectionErrorReason,</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineplus">+  get connectionErrorReason() { return this._connectionErrorReason; },</span>
<a href="#l18.50"></a><span id="l18.50"> </span>
<a href="#l18.51"></a><span id="l18.51">   /*</span>
<a href="#l18.52"></a><span id="l18.52">    * Convert a socket's nsISSLStatus into a prplIAccount connection error. Store</span>
<a href="#l18.53"></a><span id="l18.53">    * the nsISSLStatus and the connection location on the account so the</span>
<a href="#l18.54"></a><span id="l18.54">    * certificate exception dialog can access the information.</span>
<a href="#l18.55"></a><span id="l18.55">    */</span>
<a href="#l18.56"></a><span id="l18.56">   handleBadCertificate: function(aSocket, aIsSslError) {</span>
<a href="#l18.57"></a><span id="l18.57">     this._connectionTarget = aSocket.host + &quot;:&quot; + aSocket.port;</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineat">@@ -83,19 +83,19 @@ const GenericAccountPrototype = {</span>
<a href="#l18.59"></a><span id="l18.59">     if (sslStatus.isDomainMismatch)</span>
<a href="#l18.60"></a><span id="l18.60">       return Ci.prplIAccount.ERROR_CERT_HOSTNAME_MISMATCH;</span>
<a href="#l18.61"></a><span id="l18.61"> </span>
<a href="#l18.62"></a><span id="l18.62">     // XXX ERROR_CERT_FINGERPRINT_MISMATCH</span>
<a href="#l18.63"></a><span id="l18.63"> </span>
<a href="#l18.64"></a><span id="l18.64">     return Ci.prplIAccount.ERROR_CERT_OTHER_ERROR;</span>
<a href="#l18.65"></a><span id="l18.65">   },</span>
<a href="#l18.66"></a><span id="l18.66">   _connectionTarget: &quot;&quot;,</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineminus">-  get connectionTarget() this._connectionTarget,</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineplus">+  get connectionTarget() { return this._connectionTarget; },</span>
<a href="#l18.69"></a><span id="l18.69">   _sslStatus: null,</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineminus">-  get sslStatus() this._sslStatus,</span>
<a href="#l18.71"></a><span id="l18.71" class="difflineplus">+  get sslStatus() { return this._sslStatus; },</span>
<a href="#l18.72"></a><span id="l18.72"> </span>
<a href="#l18.73"></a><span id="l18.73">   reportConnected: function() {</span>
<a href="#l18.74"></a><span id="l18.74">     this.imAccount.observe(this, &quot;account-connected&quot;, null);</span>
<a href="#l18.75"></a><span id="l18.75">   },</span>
<a href="#l18.76"></a><span id="l18.76">   reportConnecting: function(aConnectionStateMsg) {</span>
<a href="#l18.77"></a><span id="l18.77">     // Delete any leftover errors from the previous connection.</span>
<a href="#l18.78"></a><span id="l18.78">     delete this._connectionTarget;</span>
<a href="#l18.79"></a><span id="l18.79">     delete this._sslStatus;</span>
<a href="#l18.80"></a><span id="l18.80" class="difflineat">@@ -129,18 +129,18 @@ const GenericAccountPrototype = {</span>
<a href="#l18.81"></a><span id="l18.81">    }</span>
<a href="#l18.82"></a><span id="l18.82">   },</span>
<a href="#l18.83"></a><span id="l18.83"> </span>
<a href="#l18.84"></a><span id="l18.84">   _pendingBuddyRequests: null,</span>
<a href="#l18.85"></a><span id="l18.85">   addBuddyRequest: function(aUserName, aGrantCallback, aDenyCallback) {</span>
<a href="#l18.86"></a><span id="l18.86">     if (!this._pendingBuddyRequests)</span>
<a href="#l18.87"></a><span id="l18.87">       this._pendingBuddyRequests = [];</span>
<a href="#l18.88"></a><span id="l18.88">     let buddyRequest = {</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineminus">-      get account() this._account.imAccount,</span>
<a href="#l18.90"></a><span id="l18.90" class="difflineminus">-      get userName() aUserName,</span>
<a href="#l18.91"></a><span id="l18.91" class="difflineplus">+      get account() { return this._account.imAccount; },</span>
<a href="#l18.92"></a><span id="l18.92" class="difflineplus">+      get userName() { return aUserName; },</span>
<a href="#l18.93"></a><span id="l18.93">       _account: this,</span>
<a href="#l18.94"></a><span id="l18.94">       // Grant and deny callbacks both receive the auth request object as an</span>
<a href="#l18.95"></a><span id="l18.95">       // argument for further use.</span>
<a href="#l18.96"></a><span id="l18.96">       grant: function() {</span>
<a href="#l18.97"></a><span id="l18.97">         aGrantCallback(this);</span>
<a href="#l18.98"></a><span id="l18.98">         this._remove();</span>
<a href="#l18.99"></a><span id="l18.99">       },</span>
<a href="#l18.100"></a><span id="l18.100">       deny: function() {</span>
<a href="#l18.101"></a><span id="l18.101" class="difflineat">@@ -162,30 +162,30 @@ const GenericAccountPrototype = {</span>
<a href="#l18.102"></a><span id="l18.102">     Services.obs.notifyObservers(buddyRequest, &quot;buddy-authorization-request&quot;,</span>
<a href="#l18.103"></a><span id="l18.103">                                  null);</span>
<a href="#l18.104"></a><span id="l18.104">   },</span>
<a href="#l18.105"></a><span id="l18.105">   removeBuddyRequest: function(aRequest) {</span>
<a href="#l18.106"></a><span id="l18.106">     if (!this._pendingBuddyRequests)</span>
<a href="#l18.107"></a><span id="l18.107">       return;</span>
<a href="#l18.108"></a><span id="l18.108"> </span>
<a href="#l18.109"></a><span id="l18.109">     this._pendingBuddyRequests =</span>
<a href="#l18.110"></a><span id="l18.110" class="difflineminus">-      this._pendingBuddyRequests.filter(function(r) r !== aRequest);</span>
<a href="#l18.111"></a><span id="l18.111" class="difflineplus">+      this._pendingBuddyRequests.filter(r =&gt; r !== aRequest);</span>
<a href="#l18.112"></a><span id="l18.112">   },</span>
<a href="#l18.113"></a><span id="l18.113">   cancelPendingBuddyRequests: function() {</span>
<a href="#l18.114"></a><span id="l18.114">     if (!this._pendingBuddyRequests)</span>
<a href="#l18.115"></a><span id="l18.115">       return;</span>
<a href="#l18.116"></a><span id="l18.116"> </span>
<a href="#l18.117"></a><span id="l18.117">     for each (let request in this._pendingBuddyRequests)</span>
<a href="#l18.118"></a><span id="l18.118">       request.cancel();</span>
<a href="#l18.119"></a><span id="l18.119">     delete this._pendingBuddyRequests;</span>
<a href="#l18.120"></a><span id="l18.120">   },</span>
<a href="#l18.121"></a><span id="l18.121"> </span>
<a href="#l18.122"></a><span id="l18.122">   requestBuddyInfo: function(aBuddyName) {},</span>
<a href="#l18.123"></a><span id="l18.123"> </span>
<a href="#l18.124"></a><span id="l18.124" class="difflineminus">-  get canJoinChat() false,</span>
<a href="#l18.125"></a><span id="l18.125" class="difflineplus">+  get canJoinChat() { return false; },</span>
<a href="#l18.126"></a><span id="l18.126">   getChatRoomFields: function() {</span>
<a href="#l18.127"></a><span id="l18.127">     if (!this.chatRoomFields)</span>
<a href="#l18.128"></a><span id="l18.128">       return EmptyEnumerator;</span>
<a href="#l18.129"></a><span id="l18.129"> </span>
<a href="#l18.130"></a><span id="l18.130">     let fields = [];</span>
<a href="#l18.131"></a><span id="l18.131">     for (let fieldName in this.chatRoomFields)</span>
<a href="#l18.132"></a><span id="l18.132">       fields.push(new ChatRoomField(fieldName, this.chatRoomFields[fieldName]));</span>
<a href="#l18.133"></a><span id="l18.133">     return new nsSimpleEnumerator(fields);</span>
<a href="#l18.134"></a><span id="l18.134" class="difflineat">@@ -202,57 +202,60 @@ const GenericAccountPrototype = {</span>
<a href="#l18.135"></a><span id="l18.135">       let parsedDefaultChatName = this.parseDefaultChatName(aDefaultChatName);</span>
<a href="#l18.136"></a><span id="l18.136">       for (let field in parsedDefaultChatName)</span>
<a href="#l18.137"></a><span id="l18.137">         defaultFieldValues[field] = parsedDefaultChatName[field];</span>
<a href="#l18.138"></a><span id="l18.138">     }</span>
<a href="#l18.139"></a><span id="l18.139"> </span>
<a href="#l18.140"></a><span id="l18.140">     return new ChatRoomFieldValues(defaultFieldValues);</span>
<a href="#l18.141"></a><span id="l18.141">   },</span>
<a href="#l18.142"></a><span id="l18.142">   requestRoomInfo: function(aCallback) { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l18.143"></a><span id="l18.143" class="difflineminus">-  get isRoomInfoStale() false,</span>
<a href="#l18.144"></a><span id="l18.144" class="difflineplus">+  get isRoomInfoStale() { return false; },</span>
<a href="#l18.145"></a><span id="l18.145"> </span>
<a href="#l18.146"></a><span id="l18.146" class="difflineminus">-  getPref: function (aName, aType)</span>
<a href="#l18.147"></a><span id="l18.147" class="difflineminus">-    this.prefs.prefHasUserValue(aName) ?</span>
<a href="#l18.148"></a><span id="l18.148" class="difflineminus">-      this.prefs[&quot;get&quot; + aType + &quot;Pref&quot;](aName) :</span>
<a href="#l18.149"></a><span id="l18.149" class="difflineminus">-      this.protocol._getOptionDefault(aName),</span>
<a href="#l18.150"></a><span id="l18.150" class="difflineminus">-  getInt: function(aName) this.getPref(aName, &quot;Int&quot;),</span>
<a href="#l18.151"></a><span id="l18.151" class="difflineminus">-  getBool: function(aName) this.getPref(aName, &quot;Bool&quot;),</span>
<a href="#l18.152"></a><span id="l18.152" class="difflineplus">+  getPref: function (aName, aType) {</span>
<a href="#l18.153"></a><span id="l18.153" class="difflineplus">+    return this.prefs.prefHasUserValue(aName) ?</span>
<a href="#l18.154"></a><span id="l18.154" class="difflineplus">+           this.prefs[&quot;get&quot; + aType + &quot;Pref&quot;](aName) :</span>
<a href="#l18.155"></a><span id="l18.155" class="difflineplus">+           this.protocol._getOptionDefault(aName);</span>
<a href="#l18.156"></a><span id="l18.156" class="difflineplus">+  },</span>
<a href="#l18.157"></a><span id="l18.157" class="difflineplus">+  getInt: function(aName) { return this.getPref(aName, &quot;Int&quot;); },</span>
<a href="#l18.158"></a><span id="l18.158" class="difflineplus">+  getBool: function(aName) { return this.getPref(aName, &quot;Bool&quot;); },</span>
<a href="#l18.159"></a><span id="l18.159">   getString: function(aName) {</span>
<a href="#l18.160"></a><span id="l18.160">     return this.prefs.prefHasUserValue(aName) ?</span>
<a href="#l18.161"></a><span id="l18.161">              this.prefs.getComplexValue(aName, Ci.nsISupportsString).data :</span>
<a href="#l18.162"></a><span id="l18.162">              this.protocol._getOptionDefault(aName);</span>
<a href="#l18.163"></a><span id="l18.163">   },</span>
<a href="#l18.164"></a><span id="l18.164"> </span>
<a href="#l18.165"></a><span id="l18.165" class="difflineminus">-  get prefs() this._prefs ||</span>
<a href="#l18.166"></a><span id="l18.166" class="difflineminus">-    (this._prefs = Services.prefs.getBranch(&quot;messenger.account.&quot; +</span>
<a href="#l18.167"></a><span id="l18.167" class="difflineminus">-                                            this.imAccount.id + &quot;.options.&quot;)),</span>
<a href="#l18.168"></a><span id="l18.168" class="difflineplus">+  get prefs() {</span>
<a href="#l18.169"></a><span id="l18.169" class="difflineplus">+    return this._prefs ||</span>
<a href="#l18.170"></a><span id="l18.170" class="difflineplus">+           (this._prefs = Services.prefs.getBranch(&quot;messenger.account.&quot; +</span>
<a href="#l18.171"></a><span id="l18.171" class="difflineplus">+                                                   this.imAccount.id + &quot;.options.&quot;));</span>
<a href="#l18.172"></a><span id="l18.172" class="difflineplus">+  },</span>
<a href="#l18.173"></a><span id="l18.173"> </span>
<a href="#l18.174"></a><span id="l18.174" class="difflineminus">-  get normalizedName() this.normalize(this.name),</span>
<a href="#l18.175"></a><span id="l18.175" class="difflineminus">-  normalize: function(aName) aName.toLowerCase(),</span>
<a href="#l18.176"></a><span id="l18.176" class="difflineplus">+  get normalizedName() { return this.normalize(this.name); },</span>
<a href="#l18.177"></a><span id="l18.177" class="difflineplus">+  normalize: function(aName) { return aName.toLowerCase(); },</span>
<a href="#l18.178"></a><span id="l18.178"> </span>
<a href="#l18.179"></a><span id="l18.179">   get proxyInfo() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l18.180"></a><span id="l18.180">   set proxyInfo(val) { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l18.181"></a><span id="l18.181"> </span>
<a href="#l18.182"></a><span id="l18.182" class="difflineminus">-  get HTMLEnabled() false,</span>
<a href="#l18.183"></a><span id="l18.183" class="difflineminus">-  get HTMLEscapePlainText() false,</span>
<a href="#l18.184"></a><span id="l18.184" class="difflineminus">-  get noBackgroundColors() true,</span>
<a href="#l18.185"></a><span id="l18.185" class="difflineminus">-  get autoResponses() false,</span>
<a href="#l18.186"></a><span id="l18.186" class="difflineminus">-  get singleFormatting() false,</span>
<a href="#l18.187"></a><span id="l18.187" class="difflineminus">-  get noFontSizes() false,</span>
<a href="#l18.188"></a><span id="l18.188" class="difflineminus">-  get noUrlDesc() false,</span>
<a href="#l18.189"></a><span id="l18.189" class="difflineminus">-  get noImages() true</span>
<a href="#l18.190"></a><span id="l18.190" class="difflineplus">+  get HTMLEnabled() { return false; },</span>
<a href="#l18.191"></a><span id="l18.191" class="difflineplus">+  get HTMLEscapePlainText() { return false; },</span>
<a href="#l18.192"></a><span id="l18.192" class="difflineplus">+  get noBackgroundColors() { return true; },</span>
<a href="#l18.193"></a><span id="l18.193" class="difflineplus">+  get autoResponses() { return false; },</span>
<a href="#l18.194"></a><span id="l18.194" class="difflineplus">+  get singleFormatting() { return false; },</span>
<a href="#l18.195"></a><span id="l18.195" class="difflineplus">+  get noFontSizes() { return false; },</span>
<a href="#l18.196"></a><span id="l18.196" class="difflineplus">+  get noUrlDesc() { return false; },</span>
<a href="#l18.197"></a><span id="l18.197" class="difflineplus">+  get noImages() { return true; }</span>
<a href="#l18.198"></a><span id="l18.198"> };</span>
<a href="#l18.199"></a><span id="l18.199"> </span>
<a href="#l18.200"></a><span id="l18.200"> </span>
<a href="#l18.201"></a><span id="l18.201"> const GenericAccountBuddyPrototype = {</span>
<a href="#l18.202"></a><span id="l18.202">   __proto__: ClassInfo(&quot;prplIAccountBuddy&quot;, &quot;generic account buddy object&quot;),</span>
<a href="#l18.203"></a><span id="l18.203" class="difflineminus">-  get DEBUG() this._account.DEBUG,</span>
<a href="#l18.204"></a><span id="l18.204" class="difflineminus">-  get LOG() this._account.LOG,</span>
<a href="#l18.205"></a><span id="l18.205" class="difflineminus">-  get WARN() this._account.WARN,</span>
<a href="#l18.206"></a><span id="l18.206" class="difflineminus">-  get ERROR() this._account.ERROR,</span>
<a href="#l18.207"></a><span id="l18.207" class="difflineplus">+  get DEBUG() { return this._account.DEBUG; },</span>
<a href="#l18.208"></a><span id="l18.208" class="difflineplus">+  get LOG() { return this._account.LOG; },</span>
<a href="#l18.209"></a><span id="l18.209" class="difflineplus">+  get WARN() { return this._account.WARN; },</span>
<a href="#l18.210"></a><span id="l18.210" class="difflineplus">+  get ERROR() { return this._account.ERROR; },</span>
<a href="#l18.211"></a><span id="l18.211"> </span>
<a href="#l18.212"></a><span id="l18.212">   _init: function(aAccount, aBuddy, aTag, aUserName) {</span>
<a href="#l18.213"></a><span id="l18.213">     if (!aBuddy &amp;&amp; !aUserName)</span>
<a href="#l18.214"></a><span id="l18.214">       throw &quot;aUserName is required when aBuddy is null&quot;;</span>
<a href="#l18.215"></a><span id="l18.215"> </span>
<a href="#l18.216"></a><span id="l18.216">     this._tag = aTag;</span>
<a href="#l18.217"></a><span id="l18.217">     this._account = aAccount;</span>
<a href="#l18.218"></a><span id="l18.218">     this._buddy = aBuddy;</span>
<a href="#l18.219"></a><span id="l18.219" class="difflineat">@@ -264,70 +267,70 @@ const GenericAccountBuddyPrototype = {</span>
<a href="#l18.220"></a><span id="l18.220">     this._userName = aUserName;</span>
<a href="#l18.221"></a><span id="l18.221">   },</span>
<a href="#l18.222"></a><span id="l18.222">   unInit: function() {</span>
<a href="#l18.223"></a><span id="l18.223">     delete this._tag;</span>
<a href="#l18.224"></a><span id="l18.224">     delete this._account;</span>
<a href="#l18.225"></a><span id="l18.225">     delete this._buddy;</span>
<a href="#l18.226"></a><span id="l18.226">   },</span>
<a href="#l18.227"></a><span id="l18.227"> </span>
<a href="#l18.228"></a><span id="l18.228" class="difflineminus">-  get account() this._account.imAccount,</span>
<a href="#l18.229"></a><span id="l18.229" class="difflineplus">+  get account() { return this._account.imAccount; },</span>
<a href="#l18.230"></a><span id="l18.230">   set buddy(aBuddy) {</span>
<a href="#l18.231"></a><span id="l18.231">     if (this._buddy)</span>
<a href="#l18.232"></a><span id="l18.232">       throw Cr.NS_ERROR_ALREADY_INITIALIZED;</span>
<a href="#l18.233"></a><span id="l18.233">     this._buddy = aBuddy;</span>
<a href="#l18.234"></a><span id="l18.234">   },</span>
<a href="#l18.235"></a><span id="l18.235" class="difflineminus">-  get buddy() this._buddy,</span>
<a href="#l18.236"></a><span id="l18.236" class="difflineminus">-  get tag() this._tag,</span>
<a href="#l18.237"></a><span id="l18.237" class="difflineplus">+  get buddy() { return this._buddy; },</span>
<a href="#l18.238"></a><span id="l18.238" class="difflineplus">+  get tag() { return this._tag; },</span>
<a href="#l18.239"></a><span id="l18.239">   set tag(aNewTag) {</span>
<a href="#l18.240"></a><span id="l18.240">     let oldTag = this._tag;</span>
<a href="#l18.241"></a><span id="l18.241">     this._tag = aNewTag;</span>
<a href="#l18.242"></a><span id="l18.242">     Services.contacts.accountBuddyMoved(this, oldTag, aNewTag);</span>
<a href="#l18.243"></a><span id="l18.243">   },</span>
<a href="#l18.244"></a><span id="l18.244"> </span>
<a href="#l18.245"></a><span id="l18.245">   _notifyObservers: function(aTopic, aData) {</span>
<a href="#l18.246"></a><span id="l18.246">     try {</span>
<a href="#l18.247"></a><span id="l18.247">       this._buddy.observe(this, &quot;account-buddy-&quot; + aTopic, aData);</span>
<a href="#l18.248"></a><span id="l18.248">     } catch(e) {</span>
<a href="#l18.249"></a><span id="l18.249">       this.ERROR(e);</span>
<a href="#l18.250"></a><span id="l18.250">     }</span>
<a href="#l18.251"></a><span id="l18.251">   },</span>
<a href="#l18.252"></a><span id="l18.252"> </span>
<a href="#l18.253"></a><span id="l18.253">   _userName: &quot;&quot;,</span>
<a href="#l18.254"></a><span id="l18.254" class="difflineminus">-  get userName() this._userName || this._buddy.userName,</span>
<a href="#l18.255"></a><span id="l18.255" class="difflineminus">-  get normalizedName() this._account.normalize(this.userName),</span>
<a href="#l18.256"></a><span id="l18.256" class="difflineplus">+  get userName() { return this._userName || this._buddy.userName; },</span>
<a href="#l18.257"></a><span id="l18.257" class="difflineplus">+  get normalizedName() { return this._account.normalize(this.userName); },</span>
<a href="#l18.258"></a><span id="l18.258">   _serverAlias: &quot;&quot;,</span>
<a href="#l18.259"></a><span id="l18.259" class="difflineminus">-  get serverAlias() this._serverAlias,</span>
<a href="#l18.260"></a><span id="l18.260" class="difflineplus">+  get serverAlias() { return this._serverAlias; },</span>
<a href="#l18.261"></a><span id="l18.261">   set serverAlias(aNewAlias) {</span>
<a href="#l18.262"></a><span id="l18.262">     let old = this.displayName;</span>
<a href="#l18.263"></a><span id="l18.263">     this._serverAlias = aNewAlias;</span>
<a href="#l18.264"></a><span id="l18.264">     if (old != this.displayName)</span>
<a href="#l18.265"></a><span id="l18.265">       this._notifyObservers(&quot;display-name-changed&quot;, old);</span>
<a href="#l18.266"></a><span id="l18.266">   },</span>
<a href="#l18.267"></a><span id="l18.267"> </span>
<a href="#l18.268"></a><span id="l18.268">   remove: function() {</span>
<a href="#l18.269"></a><span id="l18.269">     Services.contacts.accountBuddyRemoved(this);</span>
<a href="#l18.270"></a><span id="l18.270">   },</span>
<a href="#l18.271"></a><span id="l18.271"> </span>
<a href="#l18.272"></a><span id="l18.272">   // imIStatusInfo implementation</span>
<a href="#l18.273"></a><span id="l18.273" class="difflineminus">-  get displayName() this.serverAlias || this.userName,</span>
<a href="#l18.274"></a><span id="l18.274" class="difflineplus">+  get displayName() { return this.serverAlias || this.userName; },</span>
<a href="#l18.275"></a><span id="l18.275">   _buddyIconFileName: &quot;&quot;,</span>
<a href="#l18.276"></a><span id="l18.276" class="difflineminus">-  get buddyIconFilename() this._buddyIconFileName,</span>
<a href="#l18.277"></a><span id="l18.277" class="difflineplus">+  get buddyIconFilename() { return this._buddyIconFileName; },</span>
<a href="#l18.278"></a><span id="l18.278">   set buddyIconFilename(aNewFileName) {</span>
<a href="#l18.279"></a><span id="l18.279">     this._buddyIconFileName = aNewFileName;</span>
<a href="#l18.280"></a><span id="l18.280">     this._notifyObservers(&quot;icon-changed&quot;);</span>
<a href="#l18.281"></a><span id="l18.281">   },</span>
<a href="#l18.282"></a><span id="l18.282">   _statusType: 0,</span>
<a href="#l18.283"></a><span id="l18.283" class="difflineminus">-  get statusType() this._statusType,</span>
<a href="#l18.284"></a><span id="l18.284" class="difflineminus">-  get online() this._statusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE,</span>
<a href="#l18.285"></a><span id="l18.285" class="difflineminus">-  get available() this._statusType == Ci.imIStatusInfo.STATUS_AVAILABLE,</span>
<a href="#l18.286"></a><span id="l18.286" class="difflineminus">-  get idle() this._statusType == Ci.imIStatusInfo.STATUS_IDLE,</span>
<a href="#l18.287"></a><span id="l18.287" class="difflineminus">-  get mobile() this._statusType == Ci.imIStatusInfo.STATUS_MOBILE,</span>
<a href="#l18.288"></a><span id="l18.288" class="difflineplus">+  get statusType() { return this._statusType; },</span>
<a href="#l18.289"></a><span id="l18.289" class="difflineplus">+  get online() { return this._statusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE; },</span>
<a href="#l18.290"></a><span id="l18.290" class="difflineplus">+  get available() { return this._statusType == Ci.imIStatusInfo.STATUS_AVAILABLE; },</span>
<a href="#l18.291"></a><span id="l18.291" class="difflineplus">+  get idle() { return this._statusType == Ci.imIStatusInfo.STATUS_IDLE; },</span>
<a href="#l18.292"></a><span id="l18.292" class="difflineplus">+  get mobile() { return this._statusType == Ci.imIStatusInfo.STATUS_MOBILE; },</span>
<a href="#l18.293"></a><span id="l18.293">   _statusText: &quot;&quot;,</span>
<a href="#l18.294"></a><span id="l18.294" class="difflineminus">-  get statusText() this._statusText,</span>
<a href="#l18.295"></a><span id="l18.295" class="difflineplus">+  get statusText() { return this._statusText; },</span>
<a href="#l18.296"></a><span id="l18.296"> </span>
<a href="#l18.297"></a><span id="l18.297">   // This is for use by the protocol plugin, it's not exposed in the</span>
<a href="#l18.298"></a><span id="l18.298">   // imIStatusInfo interface.</span>
<a href="#l18.299"></a><span id="l18.299">   // All parameters are optional and will be ignored if they are null</span>
<a href="#l18.300"></a><span id="l18.300">   // or undefined.</span>
<a href="#l18.301"></a><span id="l18.301">   setStatus: function(aStatusType, aStatusText, aAvailabilityDetails) {</span>
<a href="#l18.302"></a><span id="l18.302">     // Ignore omitted parameters.</span>
<a href="#l18.303"></a><span id="l18.303">     if (aStatusType === undefined || aStatusType === null)</span>
<a href="#l18.304"></a><span id="l18.304" class="difflineat">@@ -357,21 +360,21 @@ const GenericAccountBuddyPrototype = {</span>
<a href="#l18.305"></a><span id="l18.305"> </span>
<a href="#l18.306"></a><span id="l18.306">     // Fire the notifications.</span>
<a href="#l18.307"></a><span id="l18.307">     notifications.forEach(function(aTopic) {</span>
<a href="#l18.308"></a><span id="l18.308">       this._notifyObservers(aTopic);</span>
<a href="#l18.309"></a><span id="l18.309">     }, this);</span>
<a href="#l18.310"></a><span id="l18.310">   },</span>
<a href="#l18.311"></a><span id="l18.311"> </span>
<a href="#l18.312"></a><span id="l18.312">   _availabilityDetails: 0,</span>
<a href="#l18.313"></a><span id="l18.313" class="difflineminus">-  get availabilityDetails() this._availabilityDetails,</span>
<a href="#l18.314"></a><span id="l18.314" class="difflineplus">+  get availabilityDetails() { return this._availabilityDetails; },</span>
<a href="#l18.315"></a><span id="l18.315"> </span>
<a href="#l18.316"></a><span id="l18.316" class="difflineminus">-  get canSendMessage() this.online /*|| this.account.canSendOfflineMessage(this) */,</span>
<a href="#l18.317"></a><span id="l18.317" class="difflineplus">+  get canSendMessage() { return this.online /*|| this.account.canSendOfflineMessage(this) */; },</span>
<a href="#l18.318"></a><span id="l18.318"> </span>
<a href="#l18.319"></a><span id="l18.319" class="difflineminus">-  getTooltipInfo: function() EmptyEnumerator,</span>
<a href="#l18.320"></a><span id="l18.320" class="difflineplus">+  getTooltipInfo: () =&gt; EmptyEnumerator,</span>
<a href="#l18.321"></a><span id="l18.321">   createConversation: function() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l18.322"></a><span id="l18.322"> };</span>
<a href="#l18.323"></a><span id="l18.323"> </span>
<a href="#l18.324"></a><span id="l18.324"> // aUserName is required only if aBuddy is null, i.e., we are adding a buddy.</span>
<a href="#l18.325"></a><span id="l18.325"> function AccountBuddy(aAccount, aBuddy, aTag, aUserName) {</span>
<a href="#l18.326"></a><span id="l18.326">   this._init(aAccount, aBuddy, aTag, aUserName);</span>
<a href="#l18.327"></a><span id="l18.327"> }</span>
<a href="#l18.328"></a><span id="l18.328"> AccountBuddy.prototype = GenericAccountBuddyPrototype;</span>
<a href="#l18.329"></a><span id="l18.329" class="difflineat">@@ -387,33 +390,33 @@ const GenericMessagePrototype = {</span>
<a href="#l18.330"></a><span id="l18.330">     this.message = aMessage;</span>
<a href="#l18.331"></a><span id="l18.331">     this.originalMessage = aMessage;</span>
<a href="#l18.332"></a><span id="l18.332"> </span>
<a href="#l18.333"></a><span id="l18.333">     if (aObject)</span>
<a href="#l18.334"></a><span id="l18.334">       for (let i in aObject)</span>
<a href="#l18.335"></a><span id="l18.335">         this[i] = aObject[i];</span>
<a href="#l18.336"></a><span id="l18.336">   },</span>
<a href="#l18.337"></a><span id="l18.337">   _alias: &quot;&quot;,</span>
<a href="#l18.338"></a><span id="l18.338" class="difflineminus">-  get alias() this._alias || this.who,</span>
<a href="#l18.339"></a><span id="l18.339" class="difflineplus">+  get alias() { return this._alias || this.who; },</span>
<a href="#l18.340"></a><span id="l18.340">   _iconURL: &quot;&quot;,</span>
<a href="#l18.341"></a><span id="l18.341">   get iconURL() {</span>
<a href="#l18.342"></a><span id="l18.342">     // If the protocol plugin has explicitly set an icon for the message, use it.</span>
<a href="#l18.343"></a><span id="l18.343">     if (this._iconURL)</span>
<a href="#l18.344"></a><span id="l18.344">       return this._iconURL;</span>
<a href="#l18.345"></a><span id="l18.345"> </span>
<a href="#l18.346"></a><span id="l18.346">     // Otherwise, attempt to find a buddy for incoming messages, and forward the call.</span>
<a href="#l18.347"></a><span id="l18.347">     if (this.incoming &amp;&amp; this._conversation &amp;&amp; !this._conversation.isChat) {</span>
<a href="#l18.348"></a><span id="l18.348">       let buddy = this._conversation.buddy;</span>
<a href="#l18.349"></a><span id="l18.349">       if (buddy)</span>
<a href="#l18.350"></a><span id="l18.350">         return buddy.buddyIconFilename;</span>
<a href="#l18.351"></a><span id="l18.351">     }</span>
<a href="#l18.352"></a><span id="l18.352">     return &quot;&quot;;</span>
<a href="#l18.353"></a><span id="l18.353">   },</span>
<a href="#l18.354"></a><span id="l18.354">   _conversation: null,</span>
<a href="#l18.355"></a><span id="l18.355" class="difflineminus">-  get conversation() this._conversation,</span>
<a href="#l18.356"></a><span id="l18.356" class="difflineplus">+  get conversation() { return this._conversation; },</span>
<a href="#l18.357"></a><span id="l18.357">   set conversation(aConv) {</span>
<a href="#l18.358"></a><span id="l18.358">     this._conversation = aConv;</span>
<a href="#l18.359"></a><span id="l18.359">     aConv.notifyObservers(this, &quot;new-text&quot;, null);</span>
<a href="#l18.360"></a><span id="l18.360">   },</span>
<a href="#l18.361"></a><span id="l18.361"> </span>
<a href="#l18.362"></a><span id="l18.362">   outgoing: false,</span>
<a href="#l18.363"></a><span id="l18.363">   incoming: false,</span>
<a href="#l18.364"></a><span id="l18.364">   system: false,</span>
<a href="#l18.365"></a><span id="l18.365" class="difflineat">@@ -437,86 +440,86 @@ const GenericMessagePrototype = {</span>
<a href="#l18.366"></a><span id="l18.366"> function Message(aWho, aMessage, aObject) {</span>
<a href="#l18.367"></a><span id="l18.367">   this._init(aWho, aMessage, aObject);</span>
<a href="#l18.368"></a><span id="l18.368"> }</span>
<a href="#l18.369"></a><span id="l18.369"> Message.prototype = GenericMessagePrototype;</span>
<a href="#l18.370"></a><span id="l18.370"> </span>
<a href="#l18.371"></a><span id="l18.371"> </span>
<a href="#l18.372"></a><span id="l18.372"> const GenericConversationPrototype = {</span>
<a href="#l18.373"></a><span id="l18.373">   __proto__: ClassInfo(&quot;prplIConversation&quot;, &quot;generic conversation object&quot;),</span>
<a href="#l18.374"></a><span id="l18.374" class="difflineminus">-  get wrappedJSObject() this,</span>
<a href="#l18.375"></a><span id="l18.375" class="difflineplus">+  get wrappedJSObject() { return this; },</span>
<a href="#l18.376"></a><span id="l18.376"> </span>
<a href="#l18.377"></a><span id="l18.377" class="difflineminus">-  get DEBUG() this._account.DEBUG,</span>
<a href="#l18.378"></a><span id="l18.378" class="difflineminus">-  get LOG() this._account.LOG,</span>
<a href="#l18.379"></a><span id="l18.379" class="difflineminus">-  get WARN() this._account.WARN,</span>
<a href="#l18.380"></a><span id="l18.380" class="difflineminus">-  get ERROR() this._account.ERROR,</span>
<a href="#l18.381"></a><span id="l18.381" class="difflineplus">+  get DEBUG() { return this._account.DEBUG; },</span>
<a href="#l18.382"></a><span id="l18.382" class="difflineplus">+  get LOG() { return this._account.LOG; },</span>
<a href="#l18.383"></a><span id="l18.383" class="difflineplus">+  get WARN() { return this._account.WARN; },</span>
<a href="#l18.384"></a><span id="l18.384" class="difflineplus">+  get ERROR() { return this._account.ERROR; },</span>
<a href="#l18.385"></a><span id="l18.385"> </span>
<a href="#l18.386"></a><span id="l18.386">   _init: function(aAccount, aName) {</span>
<a href="#l18.387"></a><span id="l18.387">     this._account = aAccount;</span>
<a href="#l18.388"></a><span id="l18.388">     this._name = aName;</span>
<a href="#l18.389"></a><span id="l18.389">     this._observers = [];</span>
<a href="#l18.390"></a><span id="l18.390">     this._date = new Date() * 1000;</span>
<a href="#l18.391"></a><span id="l18.391">     Services.conversations.addConversation(this);</span>
<a href="#l18.392"></a><span id="l18.392">   },</span>
<a href="#l18.393"></a><span id="l18.393"> </span>
<a href="#l18.394"></a><span id="l18.394">   _id: 0,</span>
<a href="#l18.395"></a><span id="l18.395" class="difflineminus">-  get id() this._id,</span>
<a href="#l18.396"></a><span id="l18.396" class="difflineplus">+  get id() { return this._id; },</span>
<a href="#l18.397"></a><span id="l18.397">   set id(aId) {</span>
<a href="#l18.398"></a><span id="l18.398">     if (this._id)</span>
<a href="#l18.399"></a><span id="l18.399">       throw Cr.NS_ERROR_ALREADY_INITIALIZED;</span>
<a href="#l18.400"></a><span id="l18.400">     this._id = aId;</span>
<a href="#l18.401"></a><span id="l18.401">   },</span>
<a href="#l18.402"></a><span id="l18.402"> </span>
<a href="#l18.403"></a><span id="l18.403">   addObserver: function(aObserver) {</span>
<a href="#l18.404"></a><span id="l18.404">     if (this._observers.indexOf(aObserver) == -1)</span>
<a href="#l18.405"></a><span id="l18.405">       this._observers.push(aObserver);</span>
<a href="#l18.406"></a><span id="l18.406">   },</span>
<a href="#l18.407"></a><span id="l18.407">   removeObserver: function(aObserver) {</span>
<a href="#l18.408"></a><span id="l18.408" class="difflineminus">-    this._observers = this._observers.filter(function(o) o !== aObserver);</span>
<a href="#l18.409"></a><span id="l18.409" class="difflineplus">+    this._observers = this._observers.filter(o =&gt; o !== aObserver);</span>
<a href="#l18.410"></a><span id="l18.410">   },</span>
<a href="#l18.411"></a><span id="l18.411">   notifyObservers: function(aSubject, aTopic, aData) {</span>
<a href="#l18.412"></a><span id="l18.412">     for each (let observer in this._observers) {</span>
<a href="#l18.413"></a><span id="l18.413">       try {</span>
<a href="#l18.414"></a><span id="l18.414">         observer.observe(aSubject, aTopic, aData);</span>
<a href="#l18.415"></a><span id="l18.415">       } catch(e) {</span>
<a href="#l18.416"></a><span id="l18.416">         this.ERROR(e);</span>
<a href="#l18.417"></a><span id="l18.417">       }</span>
<a href="#l18.418"></a><span id="l18.418">     }</span>
<a href="#l18.419"></a><span id="l18.419">   },</span>
<a href="#l18.420"></a><span id="l18.420"> </span>
<a href="#l18.421"></a><span id="l18.421" class="difflineminus">-  prepareForSending: function(aOutgoingMessage, aCount) null,</span>
<a href="#l18.422"></a><span id="l18.422" class="difflineplus">+  prepareForSending: (aOutgoingMessage, aCount) =&gt; null,</span>
<a href="#l18.423"></a><span id="l18.423">   prepareForDisplaying: function(aImMessage) {</span>
<a href="#l18.424"></a><span id="l18.424">     if (aImMessage.displayMessage !== aImMessage.message) {</span>
<a href="#l18.425"></a><span id="l18.425">       this.DEBUG(&quot;Preparing:\n&quot; + aImMessage.message + &quot;\nDisplaying:\n&quot; +</span>
<a href="#l18.426"></a><span id="l18.426">                  aImMessage.displayMessage);</span>
<a href="#l18.427"></a><span id="l18.427">     }</span>
<a href="#l18.428"></a><span id="l18.428">   },</span>
<a href="#l18.429"></a><span id="l18.429">   sendMsg: function(aMsg) {</span>
<a href="#l18.430"></a><span id="l18.430">     throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l18.431"></a><span id="l18.431">   },</span>
<a href="#l18.432"></a><span id="l18.432" class="difflineminus">-  sendTyping: function(aString) Ci.prplIConversation.NO_TYPING_LIMIT,</span>
<a href="#l18.433"></a><span id="l18.433" class="difflineplus">+  sendTyping: aString =&gt; Ci.prplIConversation.NO_TYPING_LIMIT,</span>
<a href="#l18.434"></a><span id="l18.434"> </span>
<a href="#l18.435"></a><span id="l18.435">   close: function() {</span>
<a href="#l18.436"></a><span id="l18.436">     Services.obs.notifyObservers(this, &quot;closing-conversation&quot;, null);</span>
<a href="#l18.437"></a><span id="l18.437">     Services.conversations.removeConversation(this);</span>
<a href="#l18.438"></a><span id="l18.438">   },</span>
<a href="#l18.439"></a><span id="l18.439">   unInit: function() {</span>
<a href="#l18.440"></a><span id="l18.440">     delete this._account;</span>
<a href="#l18.441"></a><span id="l18.441">     delete this._observers;</span>
<a href="#l18.442"></a><span id="l18.442">   },</span>
<a href="#l18.443"></a><span id="l18.443"> </span>
<a href="#l18.444"></a><span id="l18.444">   writeMessage: function(aWho, aText, aProperties) {</span>
<a href="#l18.445"></a><span id="l18.445">     (new Message(aWho, aText, aProperties)).conversation = this;</span>
<a href="#l18.446"></a><span id="l18.446">   },</span>
<a href="#l18.447"></a><span id="l18.447"> </span>
<a href="#l18.448"></a><span id="l18.448" class="difflineminus">-  get account() this._account.imAccount,</span>
<a href="#l18.449"></a><span id="l18.449" class="difflineminus">-  get name() this._name,</span>
<a href="#l18.450"></a><span id="l18.450" class="difflineminus">-  get normalizedName() this._account.normalize(this.name),</span>
<a href="#l18.451"></a><span id="l18.451" class="difflineminus">-  get title() this.name,</span>
<a href="#l18.452"></a><span id="l18.452" class="difflineminus">-  get startDate() this._date</span>
<a href="#l18.453"></a><span id="l18.453" class="difflineplus">+  get account() { return this._account.imAccount; },</span>
<a href="#l18.454"></a><span id="l18.454" class="difflineplus">+  get name() { return this._name; },</span>
<a href="#l18.455"></a><span id="l18.455" class="difflineplus">+  get normalizedName() { return this._account.normalize(this.name); },</span>
<a href="#l18.456"></a><span id="l18.456" class="difflineplus">+  get title() { return this.name; },</span>
<a href="#l18.457"></a><span id="l18.457" class="difflineplus">+  get startDate() { return this._date; }</span>
<a href="#l18.458"></a><span id="l18.458"> };</span>
<a href="#l18.459"></a><span id="l18.459"> </span>
<a href="#l18.460"></a><span id="l18.460"> const GenericConvIMPrototype = {</span>
<a href="#l18.461"></a><span id="l18.461">   __proto__: GenericConversationPrototype,</span>
<a href="#l18.462"></a><span id="l18.462">   _interfaces: [Ci.prplIConversation, Ci.prplIConvIM],</span>
<a href="#l18.463"></a><span id="l18.463">   classDescription: &quot;generic ConvIM object&quot;,</span>
<a href="#l18.464"></a><span id="l18.464"> </span>
<a href="#l18.465"></a><span id="l18.465">   updateTyping: function(aState, aName) {</span>
<a href="#l18.466"></a><span id="l18.466" class="difflineat">@@ -525,44 +528,44 @@ const GenericConvIMPrototype = {</span>
<a href="#l18.467"></a><span id="l18.467"> </span>
<a href="#l18.468"></a><span id="l18.468">     if (aState == Ci.prplIConvIM.NOT_TYPING)</span>
<a href="#l18.469"></a><span id="l18.469">       delete this.typingState;</span>
<a href="#l18.470"></a><span id="l18.470">     else</span>
<a href="#l18.471"></a><span id="l18.471">       this.typingState = aState;</span>
<a href="#l18.472"></a><span id="l18.472">     this.notifyObservers(null, &quot;update-typing&quot;, aName);</span>
<a href="#l18.473"></a><span id="l18.473">   },</span>
<a href="#l18.474"></a><span id="l18.474"> </span>
<a href="#l18.475"></a><span id="l18.475" class="difflineminus">-  get isChat() false,</span>
<a href="#l18.476"></a><span id="l18.476" class="difflineplus">+  get isChat() { return false; },</span>
<a href="#l18.477"></a><span id="l18.477">   buddy: null,</span>
<a href="#l18.478"></a><span id="l18.478">   typingState: Ci.prplIConvIM.NOT_TYPING</span>
<a href="#l18.479"></a><span id="l18.479"> };</span>
<a href="#l18.480"></a><span id="l18.480"> </span>
<a href="#l18.481"></a><span id="l18.481"> const GenericConvChatPrototype = {</span>
<a href="#l18.482"></a><span id="l18.482">   __proto__: GenericConversationPrototype,</span>
<a href="#l18.483"></a><span id="l18.483">   _interfaces: [Ci.prplIConversation, Ci.prplIConvChat],</span>
<a href="#l18.484"></a><span id="l18.484">   classDescription: &quot;generic ConvChat object&quot;,</span>
<a href="#l18.485"></a><span id="l18.485"> </span>
<a href="#l18.486"></a><span id="l18.486">   _init: function(aAccount, aName, aNick) {</span>
<a href="#l18.487"></a><span id="l18.487">     this._participants = new Map();</span>
<a href="#l18.488"></a><span id="l18.488">     this.nick = aNick;</span>
<a href="#l18.489"></a><span id="l18.489">     GenericConversationPrototype._init.call(this, aAccount, aName);</span>
<a href="#l18.490"></a><span id="l18.490">   },</span>
<a href="#l18.491"></a><span id="l18.491"> </span>
<a href="#l18.492"></a><span id="l18.492" class="difflineminus">-  get isChat() true,</span>
<a href="#l18.493"></a><span id="l18.493" class="difflineplus">+  get isChat() { return true; },</span>
<a href="#l18.494"></a><span id="l18.494"> </span>
<a href="#l18.495"></a><span id="l18.495">   // Stores the prplIChatRoomFieldValues required to join this channel</span>
<a href="#l18.496"></a><span id="l18.496">   // to enable later reconnections. If null, the MUC will not be reconnected</span>
<a href="#l18.497"></a><span id="l18.497">   // automatically after disconnections.</span>
<a href="#l18.498"></a><span id="l18.498">   chatRoomFields: null,</span>
<a href="#l18.499"></a><span id="l18.499"> </span>
<a href="#l18.500"></a><span id="l18.500">   _topic: &quot;&quot;,</span>
<a href="#l18.501"></a><span id="l18.501">   _topicSetter: null,</span>
<a href="#l18.502"></a><span id="l18.502" class="difflineminus">-  get topic() this._topic,</span>
<a href="#l18.503"></a><span id="l18.503" class="difflineminus">-  get topicSettable() false,</span>
<a href="#l18.504"></a><span id="l18.504" class="difflineminus">-  get topicSetter() this._topicSetter,</span>
<a href="#l18.505"></a><span id="l18.505" class="difflineplus">+  get topic() { return this._topic; },</span>
<a href="#l18.506"></a><span id="l18.506" class="difflineplus">+  get topicSettable() { return false; },</span>
<a href="#l18.507"></a><span id="l18.507" class="difflineplus">+  get topicSetter() { return this._topicSetter; },</span>
<a href="#l18.508"></a><span id="l18.508">   setTopic: function(aTopic, aTopicSetter, aQuiet) {</span>
<a href="#l18.509"></a><span id="l18.509">     // Only change the topic if the topic and/or topic setter has changed.</span>
<a href="#l18.510"></a><span id="l18.510">     if (this._topic == aTopic &amp;&amp;</span>
<a href="#l18.511"></a><span id="l18.511">         (!this._topicSetter || this._topicSetter == aTopicSetter))</span>
<a href="#l18.512"></a><span id="l18.512">       return;</span>
<a href="#l18.513"></a><span id="l18.513"> </span>
<a href="#l18.514"></a><span id="l18.514">     this._topic = aTopic;</span>
<a href="#l18.515"></a><span id="l18.515">     this._topicSetter = aTopicSetter;</span>
<a href="#l18.516"></a><span id="l18.516" class="difflineat">@@ -585,66 +588,68 @@ const GenericConvChatPrototype = {</span>
<a href="#l18.517"></a><span id="l18.517">       if (aTopic)</span>
<a href="#l18.518"></a><span id="l18.518">         message = _(&quot;topicSet&quot;, this.name, aTopic);</span>
<a href="#l18.519"></a><span id="l18.519">       else</span>
<a href="#l18.520"></a><span id="l18.520">         message = _(&quot;topicNotSet&quot;, this.name);</span>
<a href="#l18.521"></a><span id="l18.521">     }</span>
<a href="#l18.522"></a><span id="l18.522">     this.writeMessage(aTopicSetter, message, {system: true});</span>
<a href="#l18.523"></a><span id="l18.523">   },</span>
<a href="#l18.524"></a><span id="l18.524"> </span>
<a href="#l18.525"></a><span id="l18.525" class="difflineminus">-  get nick() this._nick,</span>
<a href="#l18.526"></a><span id="l18.526" class="difflineplus">+  get nick() { return this._nick; },</span>
<a href="#l18.527"></a><span id="l18.527">   set nick(aNick) {</span>
<a href="#l18.528"></a><span id="l18.528">     this._nick = aNick;</span>
<a href="#l18.529"></a><span id="l18.529">     let escapedNick = this._nick.replace(/[[\]{}()*+?.\\^$|]/g, &quot;\\$&amp;&quot;);</span>
<a href="#l18.530"></a><span id="l18.530">     this._pingRegexp = new RegExp(&quot;(?:^|\\W)&quot; + escapedNick + &quot;(?:\\W|$)&quot;, &quot;i&quot;);</span>
<a href="#l18.531"></a><span id="l18.531">   },</span>
<a href="#l18.532"></a><span id="l18.532"> </span>
<a href="#l18.533"></a><span id="l18.533">   _left: false,</span>
<a href="#l18.534"></a><span id="l18.534" class="difflineminus">-  get left() this._left,</span>
<a href="#l18.535"></a><span id="l18.535" class="difflineplus">+  get left() { return this._left; },</span>
<a href="#l18.536"></a><span id="l18.536">   set left(aLeft) {</span>
<a href="#l18.537"></a><span id="l18.537">     if (aLeft == this._left)</span>
<a href="#l18.538"></a><span id="l18.538">       return;</span>
<a href="#l18.539"></a><span id="l18.539">     this._left = aLeft;</span>
<a href="#l18.540"></a><span id="l18.540">     this.notifyObservers(null, &quot;update-conv-chatleft&quot;);</span>
<a href="#l18.541"></a><span id="l18.541">   },</span>
<a href="#l18.542"></a><span id="l18.542"> </span>
<a href="#l18.543"></a><span id="l18.543">   _joining: false,</span>
<a href="#l18.544"></a><span id="l18.544" class="difflineminus">-  get joining() this._joining,</span>
<a href="#l18.545"></a><span id="l18.545" class="difflineplus">+  get joining() { return this._joining; },</span>
<a href="#l18.546"></a><span id="l18.546">   set joining(aJoining) {</span>
<a href="#l18.547"></a><span id="l18.547">     if (aJoining == this._joining)</span>
<a href="#l18.548"></a><span id="l18.548">       return;</span>
<a href="#l18.549"></a><span id="l18.549">     this._joining = aJoining;</span>
<a href="#l18.550"></a><span id="l18.550">     this.notifyObservers(null, &quot;update-conv-chatjoining&quot;);</span>
<a href="#l18.551"></a><span id="l18.551">   },</span>
<a href="#l18.552"></a><span id="l18.552"> </span>
<a href="#l18.553"></a><span id="l18.553">   getParticipants: function() {</span>
<a href="#l18.554"></a><span id="l18.554">     // Convert the values of the Map into a nsSimpleEnumerator.</span>
<a href="#l18.555"></a><span id="l18.555">     return new nsSimpleEnumerator(</span>
<a href="#l18.556"></a><span id="l18.556">       [participant for (participant of this._participants.values())]</span>
<a href="#l18.557"></a><span id="l18.557">     );</span>
<a href="#l18.558"></a><span id="l18.558">   },</span>
<a href="#l18.559"></a><span id="l18.559" class="difflineminus">-  getNormalizedChatBuddyName: function(aChatBuddyName) aChatBuddyName,</span>
<a href="#l18.560"></a><span id="l18.560" class="difflineplus">+  getNormalizedChatBuddyName: aChatBuddyName =&gt; aChatBuddyName,</span>
<a href="#l18.561"></a><span id="l18.561"> </span>
<a href="#l18.562"></a><span id="l18.562">   writeMessage: function (aWho, aText, aProperties) {</span>
<a href="#l18.563"></a><span id="l18.563">     aProperties.containsNick =</span>
<a href="#l18.564"></a><span id="l18.564">       &quot;incoming&quot; in aProperties &amp;&amp; this._pingRegexp.test(aText);</span>
<a href="#l18.565"></a><span id="l18.565">     GenericConversationPrototype.writeMessage.apply(this, arguments);</span>
<a href="#l18.566"></a><span id="l18.566">   }</span>
<a href="#l18.567"></a><span id="l18.567"> };</span>
<a href="#l18.568"></a><span id="l18.568"> </span>
<a href="#l18.569"></a><span id="l18.569"> const GenericConvChatBuddyPrototype = {</span>
<a href="#l18.570"></a><span id="l18.570">   __proto__: ClassInfo(&quot;prplIConvChatBuddy&quot;, &quot;generic ConvChatBuddy object&quot;),</span>
<a href="#l18.571"></a><span id="l18.571"> </span>
<a href="#l18.572"></a><span id="l18.572">   _name: &quot;&quot;,</span>
<a href="#l18.573"></a><span id="l18.573" class="difflineminus">-  get name() this._name,</span>
<a href="#l18.574"></a><span id="l18.574" class="difflineplus">+  get name() { return this._name; },</span>
<a href="#l18.575"></a><span id="l18.575">   alias: &quot;&quot;,</span>
<a href="#l18.576"></a><span id="l18.576">   buddy: false,</span>
<a href="#l18.577"></a><span id="l18.577"> </span>
<a href="#l18.578"></a><span id="l18.578" class="difflineminus">-  get noFlags() !(this.voiced || this.halfOp || this.op ||</span>
<a href="#l18.579"></a><span id="l18.579" class="difflineminus">-                  this.founder || this.typing),</span>
<a href="#l18.580"></a><span id="l18.580" class="difflineplus">+  get noFlags() {</span>
<a href="#l18.581"></a><span id="l18.581" class="difflineplus">+    return !(this.voiced || this.halfOp || this.op ||</span>
<a href="#l18.582"></a><span id="l18.582" class="difflineplus">+             this.founder || this.typing);</span>
<a href="#l18.583"></a><span id="l18.583" class="difflineplus">+  },</span>
<a href="#l18.584"></a><span id="l18.584">   voiced: false,</span>
<a href="#l18.585"></a><span id="l18.585">   halfOp: false,</span>
<a href="#l18.586"></a><span id="l18.586">   op: false,</span>
<a href="#l18.587"></a><span id="l18.587">   founder: false,</span>
<a href="#l18.588"></a><span id="l18.588">   typing: false</span>
<a href="#l18.589"></a><span id="l18.589"> };</span>
<a href="#l18.590"></a><span id="l18.590"> </span>
<a href="#l18.591"></a><span id="l18.591"> function TooltipInfo(aLabel, aValue, aIsStatus)</span>
<a href="#l18.592"></a><span id="l18.592" class="difflineat">@@ -705,50 +710,49 @@ function purplePref(aName, aOption) {</span>
<a href="#l18.593"></a><span id="l18.593">     this.masked = true;</span>
<a href="#l18.594"></a><span id="l18.594"> }</span>
<a href="#l18.595"></a><span id="l18.595"> purplePref.prototype = {</span>
<a href="#l18.596"></a><span id="l18.596">   __proto__: ClassInfo(&quot;prplIPref&quot;, &quot;generic account option preference&quot;),</span>
<a href="#l18.597"></a><span id="l18.597"> </span>
<a href="#l18.598"></a><span id="l18.598">   masked: false,</span>
<a href="#l18.599"></a><span id="l18.599"> </span>
<a href="#l18.600"></a><span id="l18.600">   // Default value</span>
<a href="#l18.601"></a><span id="l18.601" class="difflineminus">-  getBool: function() this._defaultValue,</span>
<a href="#l18.602"></a><span id="l18.602" class="difflineminus">-  getInt: function() this._defaultValue,</span>
<a href="#l18.603"></a><span id="l18.603" class="difflineminus">-  getString: function() this._defaultValue,</span>
<a href="#l18.604"></a><span id="l18.604" class="difflineplus">+  getBool: function() { return this._defaultValue; },</span>
<a href="#l18.605"></a><span id="l18.605" class="difflineplus">+  getInt: function() { return this._defaultValue; },</span>
<a href="#l18.606"></a><span id="l18.606" class="difflineplus">+  getString: function() { return this._defaultValue; },</span>
<a href="#l18.607"></a><span id="l18.607">   getList: function() {</span>
<a href="#l18.608"></a><span id="l18.608">     // Convert a JavaScript object map {&quot;value 1&quot;: &quot;label 1&quot;, ...}</span>
<a href="#l18.609"></a><span id="l18.609">     let keys = Object.keys(this._listValues);</span>
<a href="#l18.610"></a><span id="l18.610">     if (!keys.length)</span>
<a href="#l18.611"></a><span id="l18.611">       return EmptyEnumerator;</span>
<a href="#l18.612"></a><span id="l18.612"> </span>
<a href="#l18.613"></a><span id="l18.613">     return new nsSimpleEnumerator(</span>
<a href="#l18.614"></a><span id="l18.614" class="difflineminus">-      keys.map(function(key) new purpleKeyValuePair(this[key], key),</span>
<a href="#l18.615"></a><span id="l18.615" class="difflineminus">-               this._listValues)</span>
<a href="#l18.616"></a><span id="l18.616" class="difflineplus">+      keys.map(key =&gt; new purpleKeyValuePair(this._listValues[key], key))</span>
<a href="#l18.617"></a><span id="l18.617">     );</span>
<a href="#l18.618"></a><span id="l18.618">   },</span>
<a href="#l18.619"></a><span id="l18.619" class="difflineminus">-  getListDefault: function() this._defaultValue</span>
<a href="#l18.620"></a><span id="l18.620" class="difflineplus">+  getListDefault: function() { return this._defaultValue; }</span>
<a href="#l18.621"></a><span id="l18.621"> };</span>
<a href="#l18.622"></a><span id="l18.622"> </span>
<a href="#l18.623"></a><span id="l18.623"> function purpleKeyValuePair(aName, aValue) {</span>
<a href="#l18.624"></a><span id="l18.624">   this.name = aName;</span>
<a href="#l18.625"></a><span id="l18.625">   this.value = aValue;</span>
<a href="#l18.626"></a><span id="l18.626"> }</span>
<a href="#l18.627"></a><span id="l18.627"> purpleKeyValuePair.prototype =</span>
<a href="#l18.628"></a><span id="l18.628">   ClassInfo(&quot;prplIKeyValuePair&quot;, &quot;generic Key Value Pair&quot;);</span>
<a href="#l18.629"></a><span id="l18.629"> </span>
<a href="#l18.630"></a><span id="l18.630"> function UsernameSplit(aValues) {</span>
<a href="#l18.631"></a><span id="l18.631">   this._values = aValues;</span>
<a href="#l18.632"></a><span id="l18.632"> }</span>
<a href="#l18.633"></a><span id="l18.633"> UsernameSplit.prototype = {</span>
<a href="#l18.634"></a><span id="l18.634">   __proto__: ClassInfo(&quot;prplIUsernameSplit&quot;, &quot;username split object&quot;),</span>
<a href="#l18.635"></a><span id="l18.635"> </span>
<a href="#l18.636"></a><span id="l18.636" class="difflineminus">-  get label() this._values.label,</span>
<a href="#l18.637"></a><span id="l18.637" class="difflineminus">-  get separator() this._values.separator,</span>
<a href="#l18.638"></a><span id="l18.638" class="difflineminus">-  get defaultValue() this._values.defaultValue,</span>
<a href="#l18.639"></a><span id="l18.639" class="difflineminus">-  get reverse() !!this._values.reverse // Ensure boolean</span>
<a href="#l18.640"></a><span id="l18.640" class="difflineplus">+  get label() { return this._values.label; },</span>
<a href="#l18.641"></a><span id="l18.641" class="difflineplus">+  get separator() { return this._values.separator; },</span>
<a href="#l18.642"></a><span id="l18.642" class="difflineplus">+  get defaultValue() { return this._values.defaultValue; },</span>
<a href="#l18.643"></a><span id="l18.643" class="difflineplus">+  get reverse() { return !!this._values.reverse; } // Ensure boolean</span>
<a href="#l18.644"></a><span id="l18.644"> };</span>
<a href="#l18.645"></a><span id="l18.645"> </span>
<a href="#l18.646"></a><span id="l18.646"> function ChatRoomField(aIdentifier, aField) {</span>
<a href="#l18.647"></a><span id="l18.647">   this.identifier = aIdentifier;</span>
<a href="#l18.648"></a><span id="l18.648">   this.label = aField.label;</span>
<a href="#l18.649"></a><span id="l18.649">   this.required = !!aField.required;</span>
<a href="#l18.650"></a><span id="l18.650"> </span>
<a href="#l18.651"></a><span id="l18.651">   let type = &quot;TEXT&quot;;</span>
<a href="#l18.652"></a><span id="l18.652" class="difflineat">@@ -765,37 +769,38 @@ ChatRoomField.prototype =</span>
<a href="#l18.653"></a><span id="l18.653">   ClassInfo(&quot;prplIChatRoomField&quot;, &quot;ChatRoomField object&quot;);</span>
<a href="#l18.654"></a><span id="l18.654"> </span>
<a href="#l18.655"></a><span id="l18.655"> function ChatRoomFieldValues(aMap) {</span>
<a href="#l18.656"></a><span id="l18.656">   this.values = aMap;</span>
<a href="#l18.657"></a><span id="l18.657"> }</span>
<a href="#l18.658"></a><span id="l18.658"> ChatRoomFieldValues.prototype = {</span>
<a href="#l18.659"></a><span id="l18.659">   __proto__: ClassInfo(&quot;prplIChatRoomFieldValues&quot;, &quot;ChatRoomFieldValues&quot;),</span>
<a href="#l18.660"></a><span id="l18.660"> </span>
<a href="#l18.661"></a><span id="l18.661" class="difflineminus">-  getValue: function(aIdentifier)</span>
<a href="#l18.662"></a><span id="l18.662" class="difflineminus">-    this.values.hasOwnProperty(aIdentifier) ? this.values[aIdentifier] : null,</span>
<a href="#l18.663"></a><span id="l18.663" class="difflineplus">+  getValue: function(aIdentifier) {</span>
<a href="#l18.664"></a><span id="l18.664" class="difflineplus">+    return this.values.hasOwnProperty(aIdentifier) ? this.values[aIdentifier] : null;</span>
<a href="#l18.665"></a><span id="l18.665" class="difflineplus">+  },</span>
<a href="#l18.666"></a><span id="l18.666">   setValue: function(aIdentifier, aValue) {</span>
<a href="#l18.667"></a><span id="l18.667">     this.values[aIdentifier] = aValue;</span>
<a href="#l18.668"></a><span id="l18.668">   }</span>
<a href="#l18.669"></a><span id="l18.669"> };</span>
<a href="#l18.670"></a><span id="l18.670"> </span>
<a href="#l18.671"></a><span id="l18.671"> // the name getter and the getAccount method need to be implemented by</span>
<a href="#l18.672"></a><span id="l18.672"> // protocol plugins.</span>
<a href="#l18.673"></a><span id="l18.673"> const GenericProtocolPrototype = {</span>
<a href="#l18.674"></a><span id="l18.674">   __proto__: ClassInfo(&quot;prplIProtocol&quot;, &quot;Generic protocol object&quot;),</span>
<a href="#l18.675"></a><span id="l18.675"> </span>
<a href="#l18.676"></a><span id="l18.676">   init: function(aId) {</span>
<a href="#l18.677"></a><span id="l18.677">     if (aId != this.id)</span>
<a href="#l18.678"></a><span id="l18.678">       throw &quot;Creating an instance of &quot; + aId + &quot; but this object implements &quot; + this.id;</span>
<a href="#l18.679"></a><span id="l18.679">   },</span>
<a href="#l18.680"></a><span id="l18.680" class="difflineminus">-  get id() &quot;prpl-&quot; + this.normalizedName,</span>
<a href="#l18.681"></a><span id="l18.681" class="difflineplus">+  get id() { return &quot;prpl-&quot; + this.normalizedName; },</span>
<a href="#l18.682"></a><span id="l18.682">   // This is more aggressive than the account normalization of just</span>
<a href="#l18.683"></a><span id="l18.683">   // toLowerCase() since prpl names must be only letters/numbers.</span>
<a href="#l18.684"></a><span id="l18.684" class="difflineminus">-  get normalizedName() this.name.replace(/[^a-z0-9]/gi, &quot;&quot;).toLowerCase(),</span>
<a href="#l18.685"></a><span id="l18.685" class="difflineminus">-  get iconBaseURI() &quot;chrome://chat/skin/prpl-generic/&quot;,</span>
<a href="#l18.686"></a><span id="l18.686" class="difflineplus">+  get normalizedName() { return this.name.replace(/[^a-z0-9]/gi, &quot;&quot;).toLowerCase(); },</span>
<a href="#l18.687"></a><span id="l18.687" class="difflineplus">+  get iconBaseURI() { return &quot;chrome://chat/skin/prpl-generic/&quot;; },</span>
<a href="#l18.688"></a><span id="l18.688"> </span>
<a href="#l18.689"></a><span id="l18.689">   getAccount: function(aImAccount) { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l18.690"></a><span id="l18.690"> </span>
<a href="#l18.691"></a><span id="l18.691">   _getOptionDefault: function(aName) {</span>
<a href="#l18.692"></a><span id="l18.692">     if (this.options &amp;&amp; this.options.hasOwnProperty(aName))</span>
<a href="#l18.693"></a><span id="l18.693">       return this.options[aName].default;</span>
<a href="#l18.694"></a><span id="l18.694">     throw aName + &quot; has no default value in &quot; + this.id + &quot;.&quot;;</span>
<a href="#l18.695"></a><span id="l18.695">   },</span>
<a href="#l18.696"></a><span id="l18.696" class="difflineat">@@ -808,17 +813,17 @@ const GenericProtocolPrototype = {</span>
<a href="#l18.697"></a><span id="l18.697">       purplePrefs.push(new purplePref(name, option));</span>
<a href="#l18.698"></a><span id="l18.698">     return new nsSimpleEnumerator(purplePrefs);</span>
<a href="#l18.699"></a><span id="l18.699">   },</span>
<a href="#l18.700"></a><span id="l18.700">   getUsernameSplit: function() {</span>
<a href="#l18.701"></a><span id="l18.701">     if (!this.usernameSplits || !this.usernameSplits.length)</span>
<a href="#l18.702"></a><span id="l18.702">       return EmptyEnumerator;</span>
<a href="#l18.703"></a><span id="l18.703"> </span>
<a href="#l18.704"></a><span id="l18.704">     return new nsSimpleEnumerator(</span>
<a href="#l18.705"></a><span id="l18.705" class="difflineminus">-      this.usernameSplits.map(function(split) new UsernameSplit(split)));</span>
<a href="#l18.706"></a><span id="l18.706" class="difflineplus">+      this.usernameSplits.map(split =&gt; new UsernameSplit(split)));</span>
<a href="#l18.707"></a><span id="l18.707">   },</span>
<a href="#l18.708"></a><span id="l18.708"> </span>
<a href="#l18.709"></a><span id="l18.709">   registerCommands: function() {</span>
<a href="#l18.710"></a><span id="l18.710">     if (!this.commands)</span>
<a href="#l18.711"></a><span id="l18.711">       return;</span>
<a href="#l18.712"></a><span id="l18.712"> </span>
<a href="#l18.713"></a><span id="l18.713">     this.commands.forEach(function(command) {</span>
<a href="#l18.714"></a><span id="l18.714">       if (!command.hasOwnProperty(&quot;name&quot;) || !command.hasOwnProperty(&quot;run&quot;))</span>
<a href="#l18.715"></a><span id="l18.715" class="difflineat">@@ -829,25 +834,25 @@ const GenericProtocolPrototype = {</span>
<a href="#l18.716"></a><span id="l18.716">         command.usageContext = Ci.imICommand.CMD_CONTEXT_ALL;</span>
<a href="#l18.717"></a><span id="l18.717">       if (!command.hasOwnProperty(&quot;priority&quot;))</span>
<a href="#l18.718"></a><span id="l18.718">         command.priority = Ci.imICommand.CMD_PRIORITY_PRPL;</span>
<a href="#l18.719"></a><span id="l18.719">       Services.cmd.registerCommand(command, this.id);</span>
<a href="#l18.720"></a><span id="l18.720">     }, this);</span>
<a href="#l18.721"></a><span id="l18.721">   },</span>
<a href="#l18.722"></a><span id="l18.722"> </span>
<a href="#l18.723"></a><span id="l18.723">   // NS_ERROR_XPC_JSOBJECT_HAS_NO_FUNCTION_NAMED errors are too noisy</span>
<a href="#l18.724"></a><span id="l18.724" class="difflineminus">-  get usernameEmptyText() &quot;&quot;,</span>
<a href="#l18.725"></a><span id="l18.725" class="difflineminus">-  accountExists: function() false, //FIXME</span>
<a href="#l18.726"></a><span id="l18.726" class="difflineplus">+  get usernameEmptyText() { return &quot;&quot;; },</span>
<a href="#l18.727"></a><span id="l18.727" class="difflineplus">+  accountExists: () =&gt; false, //FIXME</span>
<a href="#l18.728"></a><span id="l18.728"> </span>
<a href="#l18.729"></a><span id="l18.729" class="difflineminus">-  get uniqueChatName() false,</span>
<a href="#l18.730"></a><span id="l18.730" class="difflineminus">-  get chatHasTopic() false,</span>
<a href="#l18.731"></a><span id="l18.731" class="difflineminus">-  get noPassword() false,</span>
<a href="#l18.732"></a><span id="l18.732" class="difflineminus">-  get newMailNotification() false,</span>
<a href="#l18.733"></a><span id="l18.733" class="difflineminus">-  get imagesInIM() false,</span>
<a href="#l18.734"></a><span id="l18.734" class="difflineminus">-  get passwordOptional() false,</span>
<a href="#l18.735"></a><span id="l18.735" class="difflineminus">-  get usePointSize() true,</span>
<a href="#l18.736"></a><span id="l18.736" class="difflineminus">-  get registerNoScreenName() false,</span>
<a href="#l18.737"></a><span id="l18.737" class="difflineminus">-  get slashCommandsNative() false,</span>
<a href="#l18.738"></a><span id="l18.738" class="difflineminus">-  get usePurpleProxy() false,</span>
<a href="#l18.739"></a><span id="l18.739" class="difflineplus">+  get uniqueChatName() { return false; },</span>
<a href="#l18.740"></a><span id="l18.740" class="difflineplus">+  get chatHasTopic() { return false; },</span>
<a href="#l18.741"></a><span id="l18.741" class="difflineplus">+  get noPassword() { return false; },</span>
<a href="#l18.742"></a><span id="l18.742" class="difflineplus">+  get newMailNotification() { return false; },</span>
<a href="#l18.743"></a><span id="l18.743" class="difflineplus">+  get imagesInIM() { return false; },</span>
<a href="#l18.744"></a><span id="l18.744" class="difflineplus">+  get passwordOptional() { return false; },</span>
<a href="#l18.745"></a><span id="l18.745" class="difflineplus">+  get usePointSize() { return true; },</span>
<a href="#l18.746"></a><span id="l18.746" class="difflineplus">+  get registerNoScreenName() { return false; },</span>
<a href="#l18.747"></a><span id="l18.747" class="difflineplus">+  get slashCommandsNative() { return false; },</span>
<a href="#l18.748"></a><span id="l18.748" class="difflineplus">+  get usePurpleProxy() { return false; },</span>
<a href="#l18.749"></a><span id="l18.749"> </span>
<a href="#l18.750"></a><span id="l18.750" class="difflineminus">-  get classDescription() this.name + &quot; Protocol&quot;,</span>
<a href="#l18.751"></a><span id="l18.751" class="difflineminus">-  get contractID() &quot;@mozilla.org/chat/&quot; + this.normalizedName + &quot;;1&quot;</span>
<a href="#l18.752"></a><span id="l18.752" class="difflineplus">+  get classDescription() { return this.name + &quot; Protocol&quot;; },</span>
<a href="#l18.753"></a><span id="l18.753" class="difflineplus">+  get contractID() { return &quot;@mozilla.org/chat/&quot; + this.normalizedName + &quot;;1&quot;; }</span>
<a href="#l18.754"></a><span id="l18.754"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/chat/modules/socket.jsm</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/chat/modules/socket.jsm</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -670,15 +670,15 @@ const Socket = {</span>
<a href="#l19.4"></a><span id="l19.4">   sendPing: function() { },</span>
<a href="#l19.5"></a><span id="l19.5"> </span>
<a href="#l19.6"></a><span id="l19.6">   /* QueryInterface and nsIInterfaceRequestor implementations */</span>
<a href="#l19.7"></a><span id="l19.7">   _interfaces: [Ci.nsIServerSocketListener, Ci.nsIStreamListener,</span>
<a href="#l19.8"></a><span id="l19.8">                 Ci.nsIRequestObserver, Ci.nsITransportEventSink,</span>
<a href="#l19.9"></a><span id="l19.9">                 Ci.nsIBadCertListener2, Ci.nsIProtocolProxyCallback],</span>
<a href="#l19.10"></a><span id="l19.10">   QueryInterface: function(iid) {</span>
<a href="#l19.11"></a><span id="l19.11">     if (iid.equals(Ci.nsISupports) ||</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-        this._interfaces.some(function(i) i.equals(iid)))</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+        this._interfaces.some(i =&gt; i.equals(iid)))</span>
<a href="#l19.14"></a><span id="l19.14">       return this;</span>
<a href="#l19.15"></a><span id="l19.15"> </span>
<a href="#l19.16"></a><span id="l19.16">     throw Cr.NS_ERROR_NO_INTERFACE;</span>
<a href="#l19.17"></a><span id="l19.17">   },</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineminus">-  getInterface: function(iid) this.QueryInterface(iid)</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+  getInterface: function(iid) { return this.QueryInterface(iid); }</span>
<a href="#l19.20"></a><span id="l19.20"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/chat/modules/test/test_filtering.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/chat/modules/test/test_filtering.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -256,17 +256,17 @@ function test_addGlobalAllowedTag() {</span>
<a href="#l20.4"></a><span id="l20.4">   do_check_eq(&quot;&lt;hr&gt;&quot;, cleanupImMarkup(&quot;&lt;hr alt=\&quot;foo\&quot;&gt;&quot;));</span>
<a href="#l20.5"></a><span id="l20.5">   do_check_eq(&quot;&lt;hr src=\&quot;http://example.com/\&quot;&gt;&quot;,</span>
<a href="#l20.6"></a><span id="l20.6">               cleanupImMarkup(&quot;&lt;hr src=\&quot;http://example.com/\&quot;&gt;&quot;));</span>
<a href="#l20.7"></a><span id="l20.7">   do_check_eq(&quot;&lt;hr src=\&quot;chrome://global/skin/img.png\&quot;&gt;&quot;,</span>
<a href="#l20.8"></a><span id="l20.8">               cleanupImMarkup(&quot;&lt;hr src=\&quot;chrome://global/skin/img.png\&quot;&gt;&quot;));</span>
<a href="#l20.9"></a><span id="l20.9">   removeGlobalAllowedTag(&quot;hr&quot;);</span>
<a href="#l20.10"></a><span id="l20.10"> </span>
<a href="#l20.11"></a><span id="l20.11">   // Allow &lt;hr&gt; with an src attribute taking only http(s) urls.</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-  addGlobalAllowedTag(&quot;hr&quot;, {src: function(aValue) /^https?:/.test(aValue)});</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+  addGlobalAllowedTag(&quot;hr&quot;, {src: aValue =&gt; /^https?:/.test(aValue)});</span>
<a href="#l20.14"></a><span id="l20.14">   do_check_eq(&quot;&lt;hr src=\&quot;http://example.com/\&quot;&gt;&quot;,</span>
<a href="#l20.15"></a><span id="l20.15">               cleanupImMarkup(&quot;&lt;hr src=\&quot;http://example.com/\&quot;&gt;&quot;));</span>
<a href="#l20.16"></a><span id="l20.16">   do_check_eq(&quot;&lt;hr&gt;&quot;,</span>
<a href="#l20.17"></a><span id="l20.17">               cleanupImMarkup(&quot;&lt;hr src=\&quot;chrome://global/skin/img.png\&quot;&gt;&quot;));</span>
<a href="#l20.18"></a><span id="l20.18">   removeGlobalAllowedTag(&quot;hr&quot;);</span>
<a href="#l20.19"></a><span id="l20.19"> </span>
<a href="#l20.20"></a><span id="l20.20">   run_next_test();</span>
<a href="#l20.21"></a><span id="l20.21"> }</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineat">@@ -278,17 +278,17 @@ function test_addGlobalAllowedAttribute(</span>
<a href="#l20.23"></a><span id="l20.23">   do_check_eq(&quot;&lt;br&gt;&quot;, cleanupImMarkup(&quot;&lt;br id=\&quot;foo\&quot;&gt;&quot;));</span>
<a href="#l20.24"></a><span id="l20.24"> </span>
<a href="#l20.25"></a><span id="l20.25">   // Allow id unconditionally.</span>
<a href="#l20.26"></a><span id="l20.26">   addGlobalAllowedAttribute(&quot;id&quot;);</span>
<a href="#l20.27"></a><span id="l20.27">   do_check_eq(&quot;&lt;br id=\&quot;foo\&quot;&gt;&quot;, cleanupImMarkup(&quot;&lt;br id=\&quot;foo\&quot;&gt;&quot;));</span>
<a href="#l20.28"></a><span id="l20.28">   removeGlobalAllowedAttribute(&quot;id&quot;);</span>
<a href="#l20.29"></a><span id="l20.29"> </span>
<a href="#l20.30"></a><span id="l20.30">   // Allow id only with numbers.</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-  addGlobalAllowedAttribute(&quot;id&quot;, function(aId) /^\d+$/.test(aId));</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+  addGlobalAllowedAttribute(&quot;id&quot;, aId =&gt; /^\d+$/.test(aId));</span>
<a href="#l20.33"></a><span id="l20.33">   do_check_eq(&quot;&lt;br id=\&quot;123\&quot;&gt;&quot;, cleanupImMarkup(&quot;&lt;br id=\&quot;123\&quot;&gt;&quot;));</span>
<a href="#l20.34"></a><span id="l20.34">   do_check_eq(&quot;&lt;br&gt;&quot;, cleanupImMarkup(&quot;&lt;br id=\&quot;foo\&quot;&gt;&quot;));</span>
<a href="#l20.35"></a><span id="l20.35">   removeGlobalAllowedAttribute(&quot;id&quot;);</span>
<a href="#l20.36"></a><span id="l20.36"> </span>
<a href="#l20.37"></a><span id="l20.37">   run_next_test();</span>
<a href="#l20.38"></a><span id="l20.38"> }</span>
<a href="#l20.39"></a><span id="l20.39"> </span>
<a href="#l20.40"></a><span id="l20.40"> function test_addGlobalAllowedStyleRule() {</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

