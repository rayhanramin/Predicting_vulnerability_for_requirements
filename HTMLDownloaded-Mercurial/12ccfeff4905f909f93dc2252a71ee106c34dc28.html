<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 28464:12ccfeff4905f909f93dc2252a71ee106c34dc28</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 12ccfeff4905f909f93dc2252a71ee106c34dc28" />
<meta property="og:url" content="/comm-central/rev/12ccfeff4905f909f93dc2252a71ee106c34dc28" />
<meta property="og:description" content="Bug 1605603 - xpidl [array] removal from nsIMsgImapMailFolder. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 12ccfeff4905f909f93dc2252a71ee106c34dc28 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/12ccfeff4905f909f93dc2252a71ee106c34dc28">shortlog</a> |
<a href="/comm-central/log/12ccfeff4905f909f93dc2252a71ee106c34dc28">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/12ccfeff4905f909f93dc2252a71ee106c34dc28">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/12ccfeff4905f909f93dc2252a71ee106c34dc28">files</a> |
changeset |
<a href="/comm-central/raw-rev/12ccfeff4905f909f93dc2252a71ee106c34dc28">raw</a>  | <a href="/comm-central/archive/12ccfeff4905f909f93dc2252a71ee106c34dc28.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1605603">Bug 1605603</a> - xpidl [array] removal from nsIMsgImapMailFolder. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#66;&#101;&#110;&#32;&#67;&#97;&#109;&#112;&#98;&#101;&#108;&#108;&#32;&#60;&#98;&#101;&#110;&#99;&#64;&#116;&#104;&#117;&#110;&#100;&#101;&#114;&#98;&#105;&#114;&#100;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 31 Dec 2019 12:21:48 +0200</td></tr>

<tr>
 <td>changeset 28464</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/12ccfeff4905f909f93dc2252a71ee106c34dc28">12ccfeff4905f909f93dc2252a71ee106c34dc28</a></td>
</tr>



<tr>
<td>parent 28463</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/97cfef598a7607d3c722d91f46ec5d1db924f84b">97cfef598a7607d3c722d91f46ec5d1db924f84b</a>
</td>
</tr>

<tr>
<td>child 28465</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/4893499305615273d93717274762db7801ea733b">4893499305615273d93717274762db7801ea733b</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=12ccfeff4905f909f93dc2252a71ee106c34dc28">16858</a></td></tr>
<tr><td>push user</td><td>mkmelin@iki.fi</td></tr>
<tr><td>push date</td><td class="date age">Tue, 31 Dec 2019 10:22:37 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@12ccfeff4905 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=12ccfeff4905f909f93dc2252a71ee106c34dc28">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=12ccfeff4905f909f93dc2252a71ee106c34dc28&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=12ccfeff4905f909f93dc2252a71ee106c34dc28&newProject=comm-central&newRevision=97cfef598a7607d3c722d91f46ec5d1db924f84b&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=12ccfeff4905f909f93dc2252a71ee106c34dc28&newProject=comm-central&newRevision=97cfef598a7607d3c722d91f46ec5d1db924f84b&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=12ccfeff4905f909f93dc2252a71ee106c34dc28&newProject=comm-central&newRevision=97cfef598a7607d3c722d91f46ec5d1db924f84b&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1605603">1605603</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1605603">Bug 1605603</a> - xpidl [array] removal from nsIMsgImapMailFolder. r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/12ccfeff4905f909f93dc2252a71ee106c34dc28/mail/components/compose/content/MsgComposeCommands.js">mail/components/compose/content/MsgComposeCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/12ccfeff4905f909f93dc2252a71ee106c34dc28/mail/components/compose/content/MsgComposeCommands.js">file</a> |
<a href="/comm-central/annotate/12ccfeff4905f909f93dc2252a71ee106c34dc28/mail/components/compose/content/MsgComposeCommands.js">annotate</a> |
<a href="/comm-central/diff/12ccfeff4905f909f93dc2252a71ee106c34dc28/mail/components/compose/content/MsgComposeCommands.js">diff</a> |
<a href="/comm-central/comparison/12ccfeff4905f909f93dc2252a71ee106c34dc28/mail/components/compose/content/MsgComposeCommands.js">comparison</a> |
<a href="/comm-central/log/12ccfeff4905f909f93dc2252a71ee106c34dc28/mail/components/compose/content/MsgComposeCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/base/content/junkCommands.js">mailnews/base/content/junkCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/base/content/junkCommands.js">file</a> |
<a href="/comm-central/annotate/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/base/content/junkCommands.js">annotate</a> |
<a href="/comm-central/diff/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/base/content/junkCommands.js">diff</a> |
<a href="/comm-central/comparison/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/base/content/junkCommands.js">comparison</a> |
<a href="/comm-central/log/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/base/content/junkCommands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/base/src/nsMsgDBView.cpp">mailnews/base/src/nsMsgDBView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/base/src/nsMsgDBView.cpp">file</a> |
<a href="/comm-central/annotate/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/base/src/nsMsgDBView.cpp">annotate</a> |
<a href="/comm-central/diff/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/base/src/nsMsgDBView.cpp">diff</a> |
<a href="/comm-central/comparison/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/base/src/nsMsgDBView.cpp">comparison</a> |
<a href="/comm-central/log/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/base/src/nsMsgDBView.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/base/src/nsMsgQuickSearchDBView.cpp">mailnews/base/src/nsMsgQuickSearchDBView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/base/src/nsMsgQuickSearchDBView.cpp">file</a> |
<a href="/comm-central/annotate/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/base/src/nsMsgQuickSearchDBView.cpp">annotate</a> |
<a href="/comm-central/diff/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/base/src/nsMsgQuickSearchDBView.cpp">diff</a> |
<a href="/comm-central/comparison/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/base/src/nsMsgQuickSearchDBView.cpp">comparison</a> |
<a href="/comm-central/log/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/base/src/nsMsgQuickSearchDBView.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/base/util/nsMsgDBFolder.cpp">mailnews/base/util/nsMsgDBFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/base/util/nsMsgDBFolder.cpp">file</a> |
<a href="/comm-central/annotate/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/base/util/nsMsgDBFolder.cpp">annotate</a> |
<a href="/comm-central/diff/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/base/util/nsMsgDBFolder.cpp">diff</a> |
<a href="/comm-central/comparison/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/base/util/nsMsgDBFolder.cpp">comparison</a> |
<a href="/comm-central/log/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/base/util/nsMsgDBFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/base/util/nsMsgDBFolder.h">mailnews/base/util/nsMsgDBFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/base/util/nsMsgDBFolder.h">file</a> |
<a href="/comm-central/annotate/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/base/util/nsMsgDBFolder.h">annotate</a> |
<a href="/comm-central/diff/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/base/util/nsMsgDBFolder.h">diff</a> |
<a href="/comm-central/comparison/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/base/util/nsMsgDBFolder.h">comparison</a> |
<a href="/comm-central/log/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/base/util/nsMsgDBFolder.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/compose/src/nsMsgCompose.cpp">mailnews/compose/src/nsMsgCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/compose/src/nsMsgCompose.cpp">file</a> |
<a href="/comm-central/annotate/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/compose/src/nsMsgCompose.cpp">annotate</a> |
<a href="/comm-central/diff/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/compose/src/nsMsgCompose.cpp">diff</a> |
<a href="/comm-central/comparison/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/compose/src/nsMsgCompose.cpp">comparison</a> |
<a href="/comm-central/log/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/compose/src/nsMsgCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp">mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp">file</a> |
<a href="/comm-central/annotate/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp">annotate</a> |
<a href="/comm-central/diff/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp">diff</a> |
<a href="/comm-central/comparison/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp">comparison</a> |
<a href="/comm-central/log/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/imap/public/nsIMsgImapMailFolder.idl">mailnews/imap/public/nsIMsgImapMailFolder.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/imap/public/nsIMsgImapMailFolder.idl">file</a> |
<a href="/comm-central/annotate/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/imap/public/nsIMsgImapMailFolder.idl">annotate</a> |
<a href="/comm-central/diff/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/imap/public/nsIMsgImapMailFolder.idl">diff</a> |
<a href="/comm-central/comparison/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/imap/public/nsIMsgImapMailFolder.idl">comparison</a> |
<a href="/comm-central/log/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/imap/public/nsIMsgImapMailFolder.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/imap/src/nsImapMailFolder.h">mailnews/imap/src/nsImapMailFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/imap/src/nsImapMailFolder.h">file</a> |
<a href="/comm-central/annotate/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/imap/src/nsImapMailFolder.h">annotate</a> |
<a href="/comm-central/diff/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/imap/src/nsImapMailFolder.h">diff</a> |
<a href="/comm-central/comparison/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/imap/src/nsImapMailFolder.h">comparison</a> |
<a href="/comm-central/log/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/imap/src/nsImapMailFolder.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/imap/src/nsImapOfflineSync.cpp">mailnews/imap/src/nsImapOfflineSync.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/imap/src/nsImapOfflineSync.cpp">file</a> |
<a href="/comm-central/annotate/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/imap/src/nsImapOfflineSync.cpp">annotate</a> |
<a href="/comm-central/diff/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/imap/src/nsImapOfflineSync.cpp">diff</a> |
<a href="/comm-central/comparison/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/imap/src/nsImapOfflineSync.cpp">comparison</a> |
<a href="/comm-central/log/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/imap/src/nsImapOfflineSync.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/imap/src/nsImapUndoTxn.cpp">mailnews/imap/src/nsImapUndoTxn.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/imap/src/nsImapUndoTxn.cpp">file</a> |
<a href="/comm-central/annotate/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/imap/src/nsImapUndoTxn.cpp">annotate</a> |
<a href="/comm-central/diff/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/imap/src/nsImapUndoTxn.cpp">diff</a> |
<a href="/comm-central/comparison/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/imap/src/nsImapUndoTxn.cpp">comparison</a> |
<a href="/comm-central/log/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/imap/src/nsImapUndoTxn.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/imap/test/unit/test_compactOfflineStore.js">mailnews/imap/test/unit/test_compactOfflineStore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/imap/test/unit/test_compactOfflineStore.js">file</a> |
<a href="/comm-central/annotate/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/imap/test/unit/test_compactOfflineStore.js">annotate</a> |
<a href="/comm-central/diff/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/imap/test/unit/test_compactOfflineStore.js">diff</a> |
<a href="/comm-central/comparison/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/imap/test/unit/test_compactOfflineStore.js">comparison</a> |
<a href="/comm-central/log/12ccfeff4905f909f93dc2252a71ee106c34dc28/mailnews/imap/test/unit/test_compactOfflineStore.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/12ccfeff4905f909f93dc2252a71ee106c34dc28/suite/mailnews/components/compose/content/MsgComposeCommands.js">suite/mailnews/components/compose/content/MsgComposeCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/12ccfeff4905f909f93dc2252a71ee106c34dc28/suite/mailnews/components/compose/content/MsgComposeCommands.js">file</a> |
<a href="/comm-central/annotate/12ccfeff4905f909f93dc2252a71ee106c34dc28/suite/mailnews/components/compose/content/MsgComposeCommands.js">annotate</a> |
<a href="/comm-central/diff/12ccfeff4905f909f93dc2252a71ee106c34dc28/suite/mailnews/components/compose/content/MsgComposeCommands.js">diff</a> |
<a href="/comm-central/comparison/12ccfeff4905f909f93dc2252a71ee106c34dc28/suite/mailnews/components/compose/content/MsgComposeCommands.js">comparison</a> |
<a href="/comm-central/log/12ccfeff4905f909f93dc2252a71ee106c34dc28/suite/mailnews/components/compose/content/MsgComposeCommands.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -4961,23 +4961,20 @@ function RemoveDraft() {</span>
<a href="#l1.4"></a><span id="l1.4">         );</span>
<a href="#l1.5"></a><span id="l1.5">         msgs.appendElement(folder.GetMessageHeader(msgKey));</span>
<a href="#l1.6"></a><span id="l1.6">         folder.deleteMessages(msgs, null, true, false, null, false);</span>
<a href="#l1.7"></a><span id="l1.7">       }</span>
<a href="#l1.8"></a><span id="l1.8">     } catch (ex) {</span>
<a href="#l1.9"></a><span id="l1.9">       // couldn't find header - perhaps an imap folder.</span>
<a href="#l1.10"></a><span id="l1.10">       var imapFolder = folder.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l1.11"></a><span id="l1.11">       if (imapFolder) {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-        let keyArray = [];</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-        keyArray[0] = msgKey;</span>
<a href="#l1.14"></a><span id="l1.14">         imapFolder.storeImapFlags(</span>
<a href="#l1.15"></a><span id="l1.15">           Ci.nsMsgFolderFlags.Expunged,</span>
<a href="#l1.16"></a><span id="l1.16">           true,</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-          keyArray,</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-          1,</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+          [msgKey],</span>
<a href="#l1.20"></a><span id="l1.20">           null</span>
<a href="#l1.21"></a><span id="l1.21">         );</span>
<a href="#l1.22"></a><span id="l1.22">       }</span>
<a href="#l1.23"></a><span id="l1.23">     }</span>
<a href="#l1.24"></a><span id="l1.24">   } catch (ex) {}</span>
<a href="#l1.25"></a><span id="l1.25"> }</span>
<a href="#l1.26"></a><span id="l1.26"> </span>
<a href="#l1.27"></a><span id="l1.27"> function SetContentAndBodyAsUnmodified() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/content/junkCommands.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/content/junkCommands.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -92,40 +92,28 @@ function performActionsOnJunkMsgs(aFolde</span>
<a href="#l2.4"></a><span id="l2.4">     if (aJunkMsgHdrs.length) {</span>
<a href="#l2.5"></a><span id="l2.5">       var junkMsgKeys = [];</span>
<a href="#l2.6"></a><span id="l2.6">       for (let i = 0; i &lt; aJunkMsgHdrs.length; i++) {</span>
<a href="#l2.7"></a><span id="l2.7">         junkMsgKeys[i] = aJunkMsgHdrs.queryElementAt(</span>
<a href="#l2.8"></a><span id="l2.8">           i,</span>
<a href="#l2.9"></a><span id="l2.9">           Ci.nsIMsgDBHdr</span>
<a href="#l2.10"></a><span id="l2.10">         ).messageKey;</span>
<a href="#l2.11"></a><span id="l2.11">       }</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-      aFolder.storeCustomKeywords(</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-        null,</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-        &quot;Junk&quot;,</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-        &quot;NonJunk&quot;,</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-        junkMsgKeys,</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-        junkMsgKeys.length</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-      );</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+      aFolder.storeCustomKeywords(null, &quot;Junk&quot;, &quot;NonJunk&quot;, junkMsgKeys);</span>
<a href="#l2.20"></a><span id="l2.20">     }</span>
<a href="#l2.21"></a><span id="l2.21"> </span>
<a href="#l2.22"></a><span id="l2.22">     if (aGoodMsgHdrs.length) {</span>
<a href="#l2.23"></a><span id="l2.23">       let goodMsgKeys = [];</span>
<a href="#l2.24"></a><span id="l2.24">       for (let i = 0; i &lt; aGoodMsgHdrs.length; i++) {</span>
<a href="#l2.25"></a><span id="l2.25">         goodMsgKeys[i] = aGoodMsgHdrs.queryElementAt(</span>
<a href="#l2.26"></a><span id="l2.26">           i,</span>
<a href="#l2.27"></a><span id="l2.27">           Ci.nsIMsgDBHdr</span>
<a href="#l2.28"></a><span id="l2.28">         ).messageKey;</span>
<a href="#l2.29"></a><span id="l2.29">       }</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-      aFolder.storeCustomKeywords(</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-        null,</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-        &quot;NonJunk&quot;,</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-        &quot;Junk&quot;,</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-        goodMsgKeys,</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-        goodMsgKeys.length</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-      );</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+      aFolder.storeCustomKeywords(null, &quot;NonJunk&quot;, &quot;Junk&quot;, goodMsgKeys);</span>
<a href="#l2.38"></a><span id="l2.38">     }</span>
<a href="#l2.39"></a><span id="l2.39">   }</span>
<a href="#l2.40"></a><span id="l2.40"> </span>
<a href="#l2.41"></a><span id="l2.41">   if (aJunkMsgHdrs.length) {</span>
<a href="#l2.42"></a><span id="l2.42">     var actionParams = determineActionsForJunkMsgs(aFolder);</span>
<a href="#l2.43"></a><span id="l2.43">     if (actionParams.markRead) {</span>
<a href="#l2.44"></a><span id="l2.44">       aFolder.markMessagesRead(aJunkMsgHdrs, true);</span>
<a href="#l2.45"></a><span id="l2.45">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/src/nsMsgDBView.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgDBView.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -2961,42 +2961,38 @@ nsresult nsMsgDBView::ApplyCommandToIndi</span>
<a href="#l3.4"></a><span id="l3.4">         break;</span>
<a href="#l3.5"></a><span id="l3.5">       case nsMsgViewCommandType::undeleteMsg:</span>
<a href="#l3.6"></a><span id="l3.6">         flags = kImapMsgDeletedFlag;</span>
<a href="#l3.7"></a><span id="l3.7">         addFlags = false;</span>
<a href="#l3.8"></a><span id="l3.8">         break;</span>
<a href="#l3.9"></a><span id="l3.9">       case nsMsgViewCommandType::junk:</span>
<a href="#l3.10"></a><span id="l3.10">         return imapFolder-&gt;StoreCustomKeywords(</span>
<a href="#l3.11"></a><span id="l3.11">             msgWindow, NS_LITERAL_CSTRING(&quot;Junk&quot;),</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-            NS_LITERAL_CSTRING(&quot;NonJunk&quot;), imapUids.Elements(),</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-            imapUids.Length(), nullptr);</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+            NS_LITERAL_CSTRING(&quot;NonJunk&quot;), imapUids, nullptr);</span>
<a href="#l3.15"></a><span id="l3.15">       case nsMsgViewCommandType::unjunk: {</span>
<a href="#l3.16"></a><span id="l3.16">         nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l3.17"></a><span id="l3.17">         GetHdrForFirstSelectedMessage(getter_AddRefs(msgHdr));</span>
<a href="#l3.18"></a><span id="l3.18">         uint32_t msgFlags = 0;</span>
<a href="#l3.19"></a><span id="l3.19">         if (msgHdr) msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l3.20"></a><span id="l3.20"> </span>
<a href="#l3.21"></a><span id="l3.21">         if (msgFlags &amp; nsMsgMessageFlags::IMAPDeleted)</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-          imapFolder-&gt;StoreImapFlags(kImapMsgDeletedFlag, false,</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-                                     imapUids.Elements(), imapUids.Length(),</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+          imapFolder-&gt;StoreImapFlags(kImapMsgDeletedFlag, false, imapUids,</span>
<a href="#l3.25"></a><span id="l3.25">                                      nullptr);</span>
<a href="#l3.26"></a><span id="l3.26"> </span>
<a href="#l3.27"></a><span id="l3.27">         return imapFolder-&gt;StoreCustomKeywords(</span>
<a href="#l3.28"></a><span id="l3.28">             msgWindow, NS_LITERAL_CSTRING(&quot;NonJunk&quot;),</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-            NS_LITERAL_CSTRING(&quot;Junk&quot;), imapUids.Elements(), imapUids.Length(),</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-            nullptr);</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+            NS_LITERAL_CSTRING(&quot;Junk&quot;), imapUids, nullptr);</span>
<a href="#l3.32"></a><span id="l3.32">       }</span>
<a href="#l3.33"></a><span id="l3.33">       default:</span>
<a href="#l3.34"></a><span id="l3.34">         break;</span>
<a href="#l3.35"></a><span id="l3.35">     }</span>
<a href="#l3.36"></a><span id="l3.36"> </span>
<a href="#l3.37"></a><span id="l3.37">     // Can't get here without thisIsImapThreadPane == TRUE.</span>
<a href="#l3.38"></a><span id="l3.38">     if (flags != kNoImapMsgFlag) {</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-      imapFolder-&gt;StoreImapFlags(flags, addFlags, imapUids.Elements(),</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-                                 imapUids.Length(), nullptr);</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+      imapFolder-&gt;StoreImapFlags(flags, addFlags, imapUids, nullptr);</span>
<a href="#l3.42"></a><span id="l3.42">     }</span>
<a href="#l3.43"></a><span id="l3.43">   }</span>
<a href="#l3.44"></a><span id="l3.44"> </span>
<a href="#l3.45"></a><span id="l3.45">   return rv;</span>
<a href="#l3.46"></a><span id="l3.46"> }</span>
<a href="#l3.47"></a><span id="l3.47"> </span>
<a href="#l3.48"></a><span id="l3.48"> /**</span>
<a href="#l3.49"></a><span id="l3.49">  * View modifications methods by index.</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineat">@@ -3464,19 +3460,17 @@ nsresult nsMsgDBView::PerformActionsOnJu</span>
<a href="#l3.51"></a><span id="l3.51">       nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder(do_QueryInterface(srcFolder));</span>
<a href="#l3.52"></a><span id="l3.52">       nsTArray&lt;nsMsgKey&gt; imapUids;</span>
<a href="#l3.53"></a><span id="l3.53">       imapUids.SetLength(numJunkHdrs);</span>
<a href="#l3.54"></a><span id="l3.54">       for (uint32_t i = 0; i &lt; numJunkHdrs; i++) {</span>
<a href="#l3.55"></a><span id="l3.55">         nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryElementAt(mJunkHdrs, i);</span>
<a href="#l3.56"></a><span id="l3.56">         msgHdr-&gt;GetMessageKey(&amp;imapUids[i]);</span>
<a href="#l3.57"></a><span id="l3.57">       }</span>
<a href="#l3.58"></a><span id="l3.58"> </span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">-      imapFolder-&gt;StoreImapFlags(kImapMsgDeletedFlag, false,</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">-                                 imapUids.Elements(), imapUids.Length(),</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-                                 nullptr);</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+      imapFolder-&gt;StoreImapFlags(kImapMsgDeletedFlag, false, imapUids, nullptr);</span>
<a href="#l3.63"></a><span id="l3.63">     }</span>
<a href="#l3.64"></a><span id="l3.64"> </span>
<a href="#l3.65"></a><span id="l3.65">     NoteEndChange(nsMsgViewNotificationCode::none, 0, 0);</span>
<a href="#l3.66"></a><span id="l3.66"> </span>
<a href="#l3.67"></a><span id="l3.67">     NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l3.68"></a><span id="l3.68">                  &quot;move or deletion of message marked-as-junk/non junk failed&quot;);</span>
<a href="#l3.69"></a><span id="l3.69">   }</span>
<a href="#l3.70"></a><span id="l3.70"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/src/nsMsgQuickSearchDBView.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgQuickSearchDBView.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -98,18 +98,17 @@ NS_IMETHODIMP nsMsgQuickSearchDBView::Do</span>
<a href="#l4.4"></a><span id="l4.4">       rv = m_db-&gt;MarkHdrRead(msgHdr, true, nullptr);</span>
<a href="#l4.5"></a><span id="l4.5">     }</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7">     m_folder-&gt;EnableNotifications(nsIMsgFolder::allMessageCountNotifications,</span>
<a href="#l4.8"></a><span id="l4.8">                                   true);</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10">     nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(m_folder);</span>
<a href="#l4.11"></a><span id="l4.11">     if (NS_SUCCEEDED(rv) &amp;&amp; imapFolder)</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-      rv = imapFolder-&gt;StoreImapFlags(kImapMsgSeenFlag, true, m_keys.Elements(),</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-                                      m_keys.Length(), nullptr);</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+      rv = imapFolder-&gt;StoreImapFlags(kImapMsgSeenFlag, true, m_keys, nullptr);</span>
<a href="#l4.15"></a><span id="l4.15"> </span>
<a href="#l4.16"></a><span id="l4.16">     m_db-&gt;SetSummaryValid(true);</span>
<a href="#l4.17"></a><span id="l4.17">     return rv;</span>
<a href="#l4.18"></a><span id="l4.18">   } else</span>
<a href="#l4.19"></a><span id="l4.19">     return nsMsgDBView::DoCommand(aCommand);</span>
<a href="#l4.20"></a><span id="l4.20"> }</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22"> NS_IMETHODIMP nsMsgQuickSearchDBView::GetViewType(</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -5413,17 +5413,17 @@ NS_IMETHODIMP nsMsgDBFolder::GetIncoming</span>
<a href="#l5.4"></a><span id="l5.4"> void nsMsgDBFolder::ClearProcessingFlags() {</span>
<a href="#l5.5"></a><span id="l5.5">   for (uint32_t i = 0; i &lt; nsMsgProcessingFlags::NumberOfFlags; i++) {</span>
<a href="#l5.6"></a><span id="l5.6">     // There is no clear method so we need to delete and re-create.</span>
<a href="#l5.7"></a><span id="l5.7">     delete mProcessingFlag[i].keys;</span>
<a href="#l5.8"></a><span id="l5.8">     mProcessingFlag[i].keys = nsMsgKeySetU::Create();</span>
<a href="#l5.9"></a><span id="l5.9">   }</span>
<a href="#l5.10"></a><span id="l5.10"> }</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-nsresult nsMsgDBFolder::MessagesInKeyOrder(nsTArray&lt;nsMsgKey&gt; &amp;aKeyArray,</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+nsresult nsMsgDBFolder::MessagesInKeyOrder(const nsTArray&lt;nsMsgKey&gt; &amp;aKeyArray,</span>
<a href="#l5.14"></a><span id="l5.14">                                            nsIMsgFolder *srcFolder,</span>
<a href="#l5.15"></a><span id="l5.15">                                            nsIMutableArray *messages) {</span>
<a href="#l5.16"></a><span id="l5.16">   // XXX: the output messages - should really be and nsCOMArray&lt;nsIMsgDBHdr&gt;</span>
<a href="#l5.17"></a><span id="l5.17"> </span>
<a href="#l5.18"></a><span id="l5.18">   nsresult rv = NS_OK;</span>
<a href="#l5.19"></a><span id="l5.19">   uint32_t numMessages = aKeyArray.Length();</span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -196,17 +196,17 @@ class NS_MSG_BASE nsMsgDBFolder : public</span>
<a href="#l6.4"></a><span id="l6.4">   void ClearProcessingFlags();</span>
<a href="#l6.5"></a><span id="l6.5"> </span>
<a href="#l6.6"></a><span id="l6.6">   nsresult NotifyHdrsNotBeingClassified();</span>
<a href="#l6.7"></a><span id="l6.7">   static nsresult BuildFolderSortKey(nsIMsgFolder *aFolder,</span>
<a href="#l6.8"></a><span id="l6.8">                                      nsTArray&lt;uint8_t&gt; &amp;aKey);</span>
<a href="#l6.9"></a><span id="l6.9">   /**</span>
<a href="#l6.10"></a><span id="l6.10">    * Produce an array of messages ordered like the input keys.</span>
<a href="#l6.11"></a><span id="l6.11">    */</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  nsresult MessagesInKeyOrder(nsTArray&lt;nsMsgKey&gt; &amp;aKeyArray,</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  nsresult MessagesInKeyOrder(const nsTArray&lt;nsMsgKey&gt; &amp;aKeyArray,</span>
<a href="#l6.14"></a><span id="l6.14">                               nsIMsgFolder *srcFolder,</span>
<a href="#l6.15"></a><span id="l6.15">                               nsIMutableArray *messages);</span>
<a href="#l6.16"></a><span id="l6.16">   nsCString mURI;</span>
<a href="#l6.17"></a><span id="l6.17"> </span>
<a href="#l6.18"></a><span id="l6.18">   nsCOMPtr&lt;nsIMsgDatabase&gt; mDatabase;</span>
<a href="#l6.19"></a><span id="l6.19">   nsCOMPtr&lt;nsIMsgDatabase&gt; mBackupDatabase;</span>
<a href="#l6.20"></a><span id="l6.20">   nsCString mCharset;</span>
<a href="#l6.21"></a><span id="l6.21">   bool mCharsetOverride;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -3608,17 +3608,17 @@ nsresult nsMsgComposeSendListener::Remov</span>
<a href="#l7.4"></a><span id="l7.4">         const char *str = PL_strchr(msgURI.get(), '#');</span>
<a href="#l7.5"></a><span id="l7.5">         NS_ASSERTION(str, &quot;Failed to get current draft id url&quot;);</span>
<a href="#l7.6"></a><span id="l7.6">         if (str) {</span>
<a href="#l7.7"></a><span id="l7.7">           nsAutoCString srcStr(str + 1);</span>
<a href="#l7.8"></a><span id="l7.8">           nsresult err;</span>
<a href="#l7.9"></a><span id="l7.9">           nsMsgKey messageID = srcStr.ToInteger(&amp;err);</span>
<a href="#l7.10"></a><span id="l7.10">           if (messageID != nsMsgKey_None) {</span>
<a href="#l7.11"></a><span id="l7.11">             rv = imapFolder-&gt;StoreImapFlags(kImapMsgDeletedFlag, true,</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-                                            &amp;messageID, 1, nullptr);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+                                            {messageID}, nullptr);</span>
<a href="#l7.14"></a><span id="l7.14">           }</span>
<a href="#l7.15"></a><span id="l7.15">         }</span>
<a href="#l7.16"></a><span id="l7.16">       }</span>
<a href="#l7.17"></a><span id="l7.17">     }</span>
<a href="#l7.18"></a><span id="l7.18">   }</span>
<a href="#l7.19"></a><span id="l7.19"> </span>
<a href="#l7.20"></a><span id="l7.20">   return rv;</span>
<a href="#l7.21"></a><span id="l7.21"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -141,17 +141,17 @@ nsresult nsMsgMdnGenerator::StoreMDNSent</span>
<a href="#l8.4"></a><span id="l8.4">   nsCOMPtr&lt;nsIMsgDatabase&gt; msgDB;</span>
<a href="#l8.5"></a><span id="l8.5">   nsresult rv = folder-&gt;GetMsgDatabase(getter_AddRefs(msgDB));</span>
<a href="#l8.6"></a><span id="l8.6">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.7"></a><span id="l8.7">   rv = msgDB-&gt;MarkMDNSent(key, true, nullptr);</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9">   nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(folder);</span>
<a href="#l8.10"></a><span id="l8.10">   // Store the $MDNSent flag if the folder is an Imap Mail Folder</span>
<a href="#l8.11"></a><span id="l8.11">   if (imapFolder)</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-    return imapFolder-&gt;StoreImapFlags(kImapMsgMDNSentFlag, true, &amp;key, 1,</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+    return imapFolder-&gt;StoreImapFlags(kImapMsgMDNSentFlag, true, {key},</span>
<a href="#l8.14"></a><span id="l8.14">                                       nullptr);</span>
<a href="#l8.15"></a><span id="l8.15">   return rv;</span>
<a href="#l8.16"></a><span id="l8.16"> }</span>
<a href="#l8.17"></a><span id="l8.17"> </span>
<a href="#l8.18"></a><span id="l8.18"> nsresult nsMsgMdnGenerator::ClearMDNNeededFlag(nsIMsgFolder *folder,</span>
<a href="#l8.19"></a><span id="l8.19">                                                nsMsgKey key) {</span>
<a href="#l8.20"></a><span id="l8.20">   DEBUG_MDN(&quot;nsMsgMdnGenerator::ClearMDNNeededFlag&quot;);</span>
<a href="#l8.21"></a><span id="l8.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/imap/public/nsIMsgImapMailFolder.idl</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/imap/public/nsIMsgImapMailFolder.idl</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -58,21 +58,22 @@ interface nsIMsgImapMailFolder : nsISupp</span>
<a href="#l9.4"></a><span id="l9.4">   void list();</span>
<a href="#l9.5"></a><span id="l9.5">   void renameLocal(in ACString newname, in nsIMsgFolder parent);</span>
<a href="#l9.6"></a><span id="l9.6">   void prepareToRename();</span>
<a href="#l9.7"></a><span id="l9.7">   void performExpand(in nsIMsgWindow aMsgWindow);</span>
<a href="#l9.8"></a><span id="l9.8">   void recursiveCloseActiveConnections(in nsIImapIncomingServer aImapServer);</span>
<a href="#l9.9"></a><span id="l9.9">   void renameClient(in nsIMsgWindow msgWindow, in nsIMsgFolder msgFolder, in ACString oldName, in ACString newName);</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11">   // these are used for offline synchronization</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  void storeImapFlags(in long aFlags, in boolean aAddFlags, [array, size_is (aNumKeys)]</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-      in nsMsgKey aKeysToFlag, in unsigned long aNumKeys, in nsIUrlListener aUrlListener);</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+  void storeImapFlags(in long aFlags, in boolean aAddFlags,</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+      in Array&lt;nsMsgKey&gt; aKeysToFlag, in nsIUrlListener aUrlListener);</span>
<a href="#l9.16"></a><span id="l9.16">   nsIURI setImapFlags(in string uids, in long flags);</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-  void replayOfflineMoveCopy([array, size_is (numKeys)] in nsMsgKey keys, in unsigned long numKeys, in boolean isMove, in nsIMsgFolder aDstFolder,</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-                         in nsIUrlListener aUrlListener, in nsIMsgWindow aWindow);</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+  void replayOfflineMoveCopy(in Array&lt;nsMsgKey&gt; keys, in boolean isMove,</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+      in nsIMsgFolder aDstFolder, in nsIUrlListener aUrlListener,</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+      in nsIMsgWindow aWindow);</span>
<a href="#l9.22"></a><span id="l9.22">   nsIURI playbackOfflineFolderCreate(in AString folderName, in nsIMsgWindow aWindow);</span>
<a href="#l9.23"></a><span id="l9.23">   /**</span>
<a href="#l9.24"></a><span id="l9.24">    * This is called by the offline sync code to tell the imap folder to</span>
<a href="#l9.25"></a><span id="l9.25">    * remember info about the header with this key (messageId and key) because</span>
<a href="#l9.26"></a><span id="l9.26">    * it's an offline move result header, and we need to generate an</span>
<a href="#l9.27"></a><span id="l9.27">    * nsIMsgFolderListener.msgKeyChanged notification when we download the</span>
<a href="#l9.28"></a><span id="l9.28">    * real header from the imap server.</span>
<a href="#l9.29"></a><span id="l9.29">    *</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineat">@@ -121,18 +122,17 @@ interface nsIMsgImapMailFolder : nsISupp</span>
<a href="#l9.31"></a><span id="l9.31">   void updateFolderWithListener(in nsIMsgWindow aMsgWindow, in nsIUrlListener aListener);</span>
<a href="#l9.32"></a><span id="l9.32">   // this is used to issue an arbitrary imap command on the passed in msgs.</span>
<a href="#l9.33"></a><span id="l9.33">   // It assumes the command needs to be run in the selected state.</span>
<a href="#l9.34"></a><span id="l9.34">   nsIURI issueCommandOnMsgs(in ACString command, in string uids, in nsIMsgWindow aWindow);</span>
<a href="#l9.35"></a><span id="l9.35">   nsIURI fetchCustomMsgAttribute(in ACString msgAttribute, in string uids, in nsIMsgWindow aWindow);</span>
<a href="#l9.36"></a><span id="l9.36">   nsIURI storeCustomKeywords(in nsIMsgWindow aMsgWindow,</span>
<a href="#l9.37"></a><span id="l9.37">                       in ACString aFlagsToAdd,</span>
<a href="#l9.38"></a><span id="l9.38">                       in ACString aFlagsToSubtract,</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-                      [array, size_is (aNumKeys)] in nsMsgKey aKeysToStore,</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-                      in unsigned long aNumKeys);</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+                      in Array&lt;nsMsgKey&gt; aKeysToStore);</span>
<a href="#l9.42"></a><span id="l9.42"> </span>
<a href="#l9.43"></a><span id="l9.43">   void notifyIfNewMail();</span>
<a href="#l9.44"></a><span id="l9.44"> </span>
<a href="#l9.45"></a><span id="l9.45">   void initiateAutoSync(in nsIUrlListener aUrlListener);</span>
<a href="#l9.46"></a><span id="l9.46"> </span>
<a href="#l9.47"></a><span id="l9.47">   attribute boolean verifiedAsOnlineFolder;</span>
<a href="#l9.48"></a><span id="l9.48">   attribute boolean explicitlyVerify;</span>
<a href="#l9.49"></a><span id="l9.49">   attribute char hierarchyDelimiter;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1652,35 +1652,34 @@ nsImapMailFolder::AddMessageDispositionS</span>
<a href="#l10.4"></a><span id="l10.4">   nsMsgDBFolder::AddMessageDispositionState(aMessage, aDispositionFlag);</span>
<a href="#l10.5"></a><span id="l10.5"> </span>
<a href="#l10.6"></a><span id="l10.6">   // set the mark message answered flag on the server for this message...</span>
<a href="#l10.7"></a><span id="l10.7">   if (aMessage) {</span>
<a href="#l10.8"></a><span id="l10.8">     nsMsgKey msgKey;</span>
<a href="#l10.9"></a><span id="l10.9">     aMessage-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11">     if (aDispositionFlag == nsIMsgFolder::nsMsgDispositionState_Replied)</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-      StoreImapFlags(kImapMsgAnsweredFlag, true, &amp;msgKey, 1, nullptr);</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+      StoreImapFlags(kImapMsgAnsweredFlag, true, {msgKey}, nullptr);</span>
<a href="#l10.14"></a><span id="l10.14">     else if (aDispositionFlag == nsIMsgFolder::nsMsgDispositionState_Forwarded)</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-      StoreImapFlags(kImapMsgForwardedFlag, true, &amp;msgKey, 1, nullptr);</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+      StoreImapFlags(kImapMsgForwardedFlag, true, {msgKey}, nullptr);</span>
<a href="#l10.17"></a><span id="l10.17">   }</span>
<a href="#l10.18"></a><span id="l10.18">   return NS_OK;</span>
<a href="#l10.19"></a><span id="l10.19"> }</span>
<a href="#l10.20"></a><span id="l10.20"> </span>
<a href="#l10.21"></a><span id="l10.21"> NS_IMETHODIMP</span>
<a href="#l10.22"></a><span id="l10.22"> nsImapMailFolder::MarkMessagesRead(nsIArray *messages, bool markRead) {</span>
<a href="#l10.23"></a><span id="l10.23">   // tell the folder to do it, which will mark them read in the db.</span>
<a href="#l10.24"></a><span id="l10.24">   nsresult rv = nsMsgDBFolder::MarkMessagesRead(messages, markRead);</span>
<a href="#l10.25"></a><span id="l10.25">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l10.26"></a><span id="l10.26">     nsAutoCString messageIds;</span>
<a href="#l10.27"></a><span id="l10.27">     nsTArray&lt;nsMsgKey&gt; keysToMarkRead;</span>
<a href="#l10.28"></a><span id="l10.28">     rv = BuildIdsAndKeyArray(messages, messageIds, keysToMarkRead);</span>
<a href="#l10.29"></a><span id="l10.29">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.30"></a><span id="l10.30"> </span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-    StoreImapFlags(kImapMsgSeenFlag, markRead, keysToMarkRead.Elements(),</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-                   keysToMarkRead.Length(), nullptr);</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+    StoreImapFlags(kImapMsgSeenFlag, markRead, keysToMarkRead, nullptr);</span>
<a href="#l10.34"></a><span id="l10.34">     rv = GetDatabase();</span>
<a href="#l10.35"></a><span id="l10.35">     if (NS_SUCCEEDED(rv)) mDatabase-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l10.36"></a><span id="l10.36">   }</span>
<a href="#l10.37"></a><span id="l10.37">   return rv;</span>
<a href="#l10.38"></a><span id="l10.38"> }</span>
<a href="#l10.39"></a><span id="l10.39"> </span>
<a href="#l10.40"></a><span id="l10.40"> NS_IMETHODIMP</span>
<a href="#l10.41"></a><span id="l10.41"> nsImapMailFolder::SetLabelForMessages(nsIArray *aMessages,</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineat">@@ -1688,35 +1687,33 @@ nsImapMailFolder::SetLabelForMessages(ns</span>
<a href="#l10.43"></a><span id="l10.43">   NS_ENSURE_ARG(aMessages);</span>
<a href="#l10.44"></a><span id="l10.44"> </span>
<a href="#l10.45"></a><span id="l10.45">   nsresult rv = nsMsgDBFolder::SetLabelForMessages(aMessages, aLabel);</span>
<a href="#l10.46"></a><span id="l10.46">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l10.47"></a><span id="l10.47">     nsAutoCString messageIds;</span>
<a href="#l10.48"></a><span id="l10.48">     nsTArray&lt;nsMsgKey&gt; keysToLabel;</span>
<a href="#l10.49"></a><span id="l10.49">     nsresult rv = BuildIdsAndKeyArray(aMessages, messageIds, keysToLabel);</span>
<a href="#l10.50"></a><span id="l10.50">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-    StoreImapFlags((aLabel &lt;&lt; 9), true, keysToLabel.Elements(),</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-                   keysToLabel.Length(), nullptr);</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+    StoreImapFlags((aLabel &lt;&lt; 9), true, keysToLabel, nullptr);</span>
<a href="#l10.54"></a><span id="l10.54">     rv = GetDatabase();</span>
<a href="#l10.55"></a><span id="l10.55">     if (NS_SUCCEEDED(rv)) mDatabase-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l10.56"></a><span id="l10.56">   }</span>
<a href="#l10.57"></a><span id="l10.57">   return rv;</span>
<a href="#l10.58"></a><span id="l10.58"> }</span>
<a href="#l10.59"></a><span id="l10.59"> </span>
<a href="#l10.60"></a><span id="l10.60"> NS_IMETHODIMP</span>
<a href="#l10.61"></a><span id="l10.61"> nsImapMailFolder::MarkAllMessagesRead(nsIMsgWindow *aMsgWindow) {</span>
<a href="#l10.62"></a><span id="l10.62">   nsresult rv = GetDatabase();</span>
<a href="#l10.63"></a><span id="l10.63">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l10.64"></a><span id="l10.64">     nsTArray&lt;nsMsgKey&gt; thoseMarked;</span>
<a href="#l10.65"></a><span id="l10.65">     EnableNotifications(allMessageCountNotifications, false);</span>
<a href="#l10.66"></a><span id="l10.66">     rv = mDatabase-&gt;MarkAllRead(thoseMarked);</span>
<a href="#l10.67"></a><span id="l10.67">     EnableNotifications(allMessageCountNotifications, true);</span>
<a href="#l10.68"></a><span id="l10.68">     if (NS_SUCCEEDED(rv) &amp;&amp; thoseMarked.Length() &gt; 0) {</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineminus">-      rv = StoreImapFlags(kImapMsgSeenFlag, true, thoseMarked.Elements(),</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineminus">-                          thoseMarked.Length(), nullptr);</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineplus">+      rv = StoreImapFlags(kImapMsgSeenFlag, true, thoseMarked, nullptr);</span>
<a href="#l10.72"></a><span id="l10.72">       mDatabase-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l10.73"></a><span id="l10.73"> </span>
<a href="#l10.74"></a><span id="l10.74">       // Setup a undo-state</span>
<a href="#l10.75"></a><span id="l10.75">       if (aMsgWindow)</span>
<a href="#l10.76"></a><span id="l10.76">         rv = AddMarkAllReadUndoAction(aMsgWindow, thoseMarked.Elements(),</span>
<a href="#l10.77"></a><span id="l10.77">                                       thoseMarked.Length());</span>
<a href="#l10.78"></a><span id="l10.78">     }</span>
<a href="#l10.79"></a><span id="l10.79">   }</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineat">@@ -1724,18 +1721,17 @@ nsImapMailFolder::MarkAllMessagesRead(ns</span>
<a href="#l10.81"></a><span id="l10.81"> }</span>
<a href="#l10.82"></a><span id="l10.82"> </span>
<a href="#l10.83"></a><span id="l10.83"> NS_IMETHODIMP nsImapMailFolder::MarkThreadRead(nsIMsgThread *thread) {</span>
<a href="#l10.84"></a><span id="l10.84">   nsresult rv = GetDatabase();</span>
<a href="#l10.85"></a><span id="l10.85">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l10.86"></a><span id="l10.86">     nsTArray&lt;nsMsgKey&gt; keys;</span>
<a href="#l10.87"></a><span id="l10.87">     rv = mDatabase-&gt;MarkThreadRead(thread, nullptr, keys);</span>
<a href="#l10.88"></a><span id="l10.88">     if (NS_SUCCEEDED(rv) &amp;&amp; keys.Length() &gt; 0) {</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineminus">-      rv = StoreImapFlags(kImapMsgSeenFlag, true, keys.Elements(),</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineminus">-                          keys.Length(), nullptr);</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+      rv = StoreImapFlags(kImapMsgSeenFlag, true, keys, nullptr);</span>
<a href="#l10.92"></a><span id="l10.92">       mDatabase-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l10.93"></a><span id="l10.93">     }</span>
<a href="#l10.94"></a><span id="l10.94">   }</span>
<a href="#l10.95"></a><span id="l10.95">   return rv;</span>
<a href="#l10.96"></a><span id="l10.96"> }</span>
<a href="#l10.97"></a><span id="l10.97"> </span>
<a href="#l10.98"></a><span id="l10.98"> NS_IMETHODIMP nsImapMailFolder::ReadFromFolderCacheElem(</span>
<a href="#l10.99"></a><span id="l10.99">     nsIMsgFolderCacheElement *element) {</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineat">@@ -1800,19 +1796,18 @@ nsImapMailFolder::MarkMessagesFlagged(ns</span>
<a href="#l10.101"></a><span id="l10.101">   nsresult rv;</span>
<a href="#l10.102"></a><span id="l10.102">   // tell the folder to do it, which will mark them read in the db.</span>
<a href="#l10.103"></a><span id="l10.103">   rv = nsMsgDBFolder::MarkMessagesFlagged(messages, markFlagged);</span>
<a href="#l10.104"></a><span id="l10.104">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l10.105"></a><span id="l10.105">     nsAutoCString messageIds;</span>
<a href="#l10.106"></a><span id="l10.106">     nsTArray&lt;nsMsgKey&gt; keysToMarkFlagged;</span>
<a href="#l10.107"></a><span id="l10.107">     rv = BuildIdsAndKeyArray(messages, messageIds, keysToMarkFlagged);</span>
<a href="#l10.108"></a><span id="l10.108">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineminus">-    rv = StoreImapFlags(kImapMsgFlaggedFlag, markFlagged,</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineminus">-                        keysToMarkFlagged.Elements(),</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineminus">-                        keysToMarkFlagged.Length(), nullptr);</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineplus">+    rv = StoreImapFlags(kImapMsgFlaggedFlag, markFlagged, keysToMarkFlagged,</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineplus">+                        nullptr);</span>
<a href="#l10.114"></a><span id="l10.114">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.115"></a><span id="l10.115">     rv = GetDatabase();</span>
<a href="#l10.116"></a><span id="l10.116">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.117"></a><span id="l10.117">     mDatabase-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l10.118"></a><span id="l10.118">   }</span>
<a href="#l10.119"></a><span id="l10.119">   return rv;</span>
<a href="#l10.120"></a><span id="l10.120"> }</span>
<a href="#l10.121"></a><span id="l10.121"> </span>
<a href="#l10.122"></a><span id="l10.122" class="difflineat">@@ -1901,40 +1896,34 @@ nsImapMailFolder::GetDBFolderInfoAndDB(n</span>
<a href="#l10.123"></a><span id="l10.123"> </span>
<a href="#l10.124"></a><span id="l10.124">   // build up message keys.</span>
<a href="#l10.125"></a><span id="l10.125">   for (i = 0; i &lt; count; i++) {</span>
<a href="#l10.126"></a><span id="l10.126">     nsMsgKey key;</span>
<a href="#l10.127"></a><span id="l10.127">     nsCOMPtr&lt;nsIMsgDBHdr&gt; msgDBHdr = do_QueryElementAt(messages, i, &amp;rv);</span>
<a href="#l10.128"></a><span id="l10.128">     if (msgDBHdr) rv = msgDBHdr-&gt;GetMessageKey(&amp;key);</span>
<a href="#l10.129"></a><span id="l10.129">     if (NS_SUCCEEDED(rv)) keyArray.AppendElement(key);</span>
<a href="#l10.130"></a><span id="l10.130">   }</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineminus">-  return AllocateUidStringFromKeys(keyArray.Elements(), keyArray.Length(),</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineminus">-                                   msgIds);</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineminus">-}</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineminus">-</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineminus">-static int CompareKey(const void *v1, const void *v2, void *) {</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineminus">-  // QuickSort callback to compare array values</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineminus">-  nsMsgKey i1 = *(nsMsgKey *)v1;</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineminus">-  nsMsgKey i2 = *(nsMsgKey *)v2;</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineminus">-  return i1 - i2;</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineplus">+  return AllocateUidStringFromKeys(keyArray, msgIds);</span>
<a href="#l10.141"></a><span id="l10.141"> }</span>
<a href="#l10.142"></a><span id="l10.142"> </span>
<a href="#l10.143"></a><span id="l10.143"> /* static */ nsresult nsImapMailFolder::AllocateUidStringFromKeys(</span>
<a href="#l10.144"></a><span id="l10.144" class="difflineminus">-    nsMsgKey *keys, uint32_t numKeys, nsCString &amp;msgIds) {</span>
<a href="#l10.145"></a><span id="l10.145" class="difflineminus">-  if (!numKeys) return NS_ERROR_INVALID_ARG;</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineplus">+    const nsTArray&lt;nsMsgKey&gt; &amp;keys, nsCString &amp;msgIds) {</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineplus">+  if (keys.IsEmpty()) return NS_ERROR_INVALID_ARG;</span>
<a href="#l10.148"></a><span id="l10.148">   nsresult rv = NS_OK;</span>
<a href="#l10.149"></a><span id="l10.149">   uint32_t startSequence;</span>
<a href="#l10.150"></a><span id="l10.150">   startSequence = keys[0];</span>
<a href="#l10.151"></a><span id="l10.151">   uint32_t curSequenceEnd = startSequence;</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineminus">-  uint32_t total = numKeys;</span>
<a href="#l10.153"></a><span id="l10.153" class="difflineplus">+  uint32_t total = keys.Length();</span>
<a href="#l10.154"></a><span id="l10.154">   // sort keys and then generate ranges instead of singletons!</span>
<a href="#l10.155"></a><span id="l10.155" class="difflineminus">-  NS_QuickSort(keys, numKeys, sizeof(nsMsgKey), CompareKey, nullptr);</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineplus">+  nsTArray&lt;nsMsgKey&gt; sorted(keys);</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineplus">+  sorted.Sort();</span>
<a href="#l10.158"></a><span id="l10.158">   for (uint32_t keyIndex = 0; keyIndex &lt; total; keyIndex++) {</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineminus">-    uint32_t curKey = keys[keyIndex];</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineminus">-    uint32_t nextKey = (keyIndex + 1 &lt; total) ? keys[keyIndex + 1] : 0xFFFFFFFF;</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineplus">+    uint32_t curKey = sorted[keyIndex];</span>
<a href="#l10.162"></a><span id="l10.162" class="difflineplus">+    uint32_t nextKey =</span>
<a href="#l10.163"></a><span id="l10.163" class="difflineplus">+        (keyIndex + 1 &lt; total) ? sorted[keyIndex + 1] : 0xFFFFFFFF;</span>
<a href="#l10.164"></a><span id="l10.164">     bool lastKey = (nextKey == 0xFFFFFFFF);</span>
<a href="#l10.165"></a><span id="l10.165"> </span>
<a href="#l10.166"></a><span id="l10.166">     if (lastKey) curSequenceEnd = curKey;</span>
<a href="#l10.167"></a><span id="l10.167">     if (nextKey == (uint32_t)curSequenceEnd + 1 &amp;&amp; !lastKey) {</span>
<a href="#l10.168"></a><span id="l10.168">       curSequenceEnd = nextKey;</span>
<a href="#l10.169"></a><span id="l10.169">       continue;</span>
<a href="#l10.170"></a><span id="l10.170">     }</span>
<a href="#l10.171"></a><span id="l10.171">     if (curSequenceEnd &gt; startSequence) {</span>
<a href="#l10.172"></a><span id="l10.172" class="difflineat">@@ -1942,17 +1931,17 @@ static int CompareKey(const void *v1, co</span>
<a href="#l10.173"></a><span id="l10.173">       msgIds += ':';</span>
<a href="#l10.174"></a><span id="l10.174">       AppendUid(msgIds, curSequenceEnd);</span>
<a href="#l10.175"></a><span id="l10.175">       if (!lastKey) msgIds += ',';</span>
<a href="#l10.176"></a><span id="l10.176">       startSequence = nextKey;</span>
<a href="#l10.177"></a><span id="l10.177">       curSequenceEnd = startSequence;</span>
<a href="#l10.178"></a><span id="l10.178">     } else {</span>
<a href="#l10.179"></a><span id="l10.179">       startSequence = nextKey;</span>
<a href="#l10.180"></a><span id="l10.180">       curSequenceEnd = startSequence;</span>
<a href="#l10.181"></a><span id="l10.181" class="difflineminus">-      AppendUid(msgIds, keys[keyIndex]);</span>
<a href="#l10.182"></a><span id="l10.182" class="difflineplus">+      AppendUid(msgIds, sorted[keyIndex]);</span>
<a href="#l10.183"></a><span id="l10.183">       if (!lastKey) msgIds += ',';</span>
<a href="#l10.184"></a><span id="l10.184">     }</span>
<a href="#l10.185"></a><span id="l10.185">   }</span>
<a href="#l10.186"></a><span id="l10.186">   return rv;</span>
<a href="#l10.187"></a><span id="l10.187"> }</span>
<a href="#l10.188"></a><span id="l10.188"> </span>
<a href="#l10.189"></a><span id="l10.189"> nsresult nsImapMailFolder::MarkMessagesImapDeleted(nsTArray&lt;nsMsgKey&gt; *keyArray,</span>
<a href="#l10.190"></a><span id="l10.190">                                                    bool deleted,</span>
<a href="#l10.191"></a><span id="l10.191" class="difflineat">@@ -2041,18 +2030,17 @@ NS_IMETHODIMP nsImapMailFolder::DeleteMe</span>
<a href="#l10.192"></a><span id="l10.192">           }</span>
<a href="#l10.193"></a><span id="l10.193">         }</span>
<a href="#l10.194"></a><span id="l10.194">       }</span>
<a href="#l10.195"></a><span id="l10.195">     }</span>
<a href="#l10.196"></a><span id="l10.196">     // if copy service listener is also a url listener, pass that</span>
<a href="#l10.197"></a><span id="l10.197">     // url listener into StoreImapFlags.</span>
<a href="#l10.198"></a><span id="l10.198">     nsCOMPtr&lt;nsIUrlListener&gt; urlListener = do_QueryInterface(listener);</span>
<a href="#l10.199"></a><span id="l10.199">     if (deleteMsgs) messageFlags |= kImapMsgSeenFlag;</span>
<a href="#l10.200"></a><span id="l10.200" class="difflineminus">-    rv = StoreImapFlags(messageFlags, deleteMsgs, srcKeyArray.Elements(),</span>
<a href="#l10.201"></a><span id="l10.201" class="difflineminus">-                        srcKeyArray.Length(), urlListener);</span>
<a href="#l10.202"></a><span id="l10.202" class="difflineplus">+    rv = StoreImapFlags(messageFlags, deleteMsgs, srcKeyArray, urlListener);</span>
<a href="#l10.203"></a><span id="l10.203"> </span>
<a href="#l10.204"></a><span id="l10.204">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l10.205"></a><span id="l10.205">       if (mDatabase) {</span>
<a href="#l10.206"></a><span id="l10.206">         nsCOMPtr&lt;nsIMsgDatabase&gt; database(mDatabase);</span>
<a href="#l10.207"></a><span id="l10.207">         if (deleteModel == nsMsgImapDeleteModels::IMAPDelete)</span>
<a href="#l10.208"></a><span id="l10.208">           MarkMessagesImapDeleted(&amp;srcKeyArray, deleteMsgs, database);</span>
<a href="#l10.209"></a><span id="l10.209">         else {</span>
<a href="#l10.210"></a><span id="l10.210">           EnableNotifications(allMessageCountNotifications,</span>
<a href="#l10.211"></a><span id="l10.211" class="difflineat">@@ -2834,34 +2822,34 @@ nsresult nsImapMailFolder::NormalEndHead</span>
<a href="#l10.212"></a><span id="l10.212">           // Same for deleting it or moving it to trash.</span>
<a href="#l10.213"></a><span id="l10.213">           switch (duplicateAction) {</span>
<a href="#l10.214"></a><span id="l10.214">             case nsIMsgIncomingServer::deleteDups: {</span>
<a href="#l10.215"></a><span id="l10.215">               uint32_t newFlags;</span>
<a href="#l10.216"></a><span id="l10.216">               newMsgHdr-&gt;OrFlags(</span>
<a href="#l10.217"></a><span id="l10.217">                   nsMsgMessageFlags::Read | nsMsgMessageFlags::IMAPDeleted,</span>
<a href="#l10.218"></a><span id="l10.218">                   &amp;newFlags);</span>
<a href="#l10.219"></a><span id="l10.219">               StoreImapFlags(kImapMsgSeenFlag | kImapMsgDeletedFlag, true,</span>
<a href="#l10.220"></a><span id="l10.220" class="difflineminus">-                             &amp;m_curMsgUid, 1, nullptr);</span>
<a href="#l10.221"></a><span id="l10.221" class="difflineplus">+                             {m_curMsgUid}, nullptr);</span>
<a href="#l10.222"></a><span id="l10.222">               m_msgMovedByFilter = true;</span>
<a href="#l10.223"></a><span id="l10.223">             } break;</span>
<a href="#l10.224"></a><span id="l10.224">             case nsIMsgIncomingServer::moveDupsToTrash: {</span>
<a href="#l10.225"></a><span id="l10.225">               nsCOMPtr&lt;nsIMsgFolder&gt; trash;</span>
<a href="#l10.226"></a><span id="l10.226">               GetTrashFolder(getter_AddRefs(trash));</span>
<a href="#l10.227"></a><span id="l10.227">               if (trash) {</span>
<a href="#l10.228"></a><span id="l10.228">                 nsCString trashUri;</span>
<a href="#l10.229"></a><span id="l10.229">                 trash-&gt;GetURI(trashUri);</span>
<a href="#l10.230"></a><span id="l10.230">                 nsresult err = MoveIncorporatedMessage(</span>
<a href="#l10.231"></a><span id="l10.231">                     newMsgHdr, mDatabase, trashUri, nullptr, msgWindow);</span>
<a href="#l10.232"></a><span id="l10.232">                 if (NS_SUCCEEDED(err)) m_msgMovedByFilter = true;</span>
<a href="#l10.233"></a><span id="l10.233">               }</span>
<a href="#l10.234"></a><span id="l10.234">             } break;</span>
<a href="#l10.235"></a><span id="l10.235">             case nsIMsgIncomingServer::markDupsRead: {</span>
<a href="#l10.236"></a><span id="l10.236">               uint32_t newFlags;</span>
<a href="#l10.237"></a><span id="l10.237">               newMsgHdr-&gt;OrFlags(nsMsgMessageFlags::Read, &amp;newFlags);</span>
<a href="#l10.238"></a><span id="l10.238" class="difflineminus">-              StoreImapFlags(kImapMsgSeenFlag, true, &amp;m_curMsgUid, 1, nullptr);</span>
<a href="#l10.239"></a><span id="l10.239" class="difflineplus">+              StoreImapFlags(kImapMsgSeenFlag, true, {m_curMsgUid}, nullptr);</span>
<a href="#l10.240"></a><span id="l10.240">             } break;</span>
<a href="#l10.241"></a><span id="l10.241">           }</span>
<a href="#l10.242"></a><span id="l10.242">           int32_t numNewMessages;</span>
<a href="#l10.243"></a><span id="l10.243">           GetNumNewMessages(false, &amp;numNewMessages);</span>
<a href="#l10.244"></a><span id="l10.244">           SetNumNewMessages(numNewMessages - 1);</span>
<a href="#l10.245"></a><span id="l10.245">         }</span>
<a href="#l10.246"></a><span id="l10.246">       }</span>
<a href="#l10.247"></a><span id="l10.247">       rv = m_msgParser-&gt;GetAllHeaders(&amp;headers, &amp;headersSize);</span>
<a href="#l10.248"></a><span id="l10.248" class="difflineat">@@ -3242,17 +3230,17 @@ NS_IMETHODIMP nsImapMailFolder::ApplyFil</span>
<a href="#l10.249"></a><span id="l10.249">               if (NS_FAILED(rv)) break;</span>
<a href="#l10.250"></a><span id="l10.250">             }</span>
<a href="#l10.251"></a><span id="l10.251">             // msgHdr-&gt;OrFlags(nsMsgMessageFlags::Read, &amp;newFlags);  // mark</span>
<a href="#l10.252"></a><span id="l10.252">             // read in trash.</span>
<a href="#l10.253"></a><span id="l10.253">           } else {</span>
<a href="#l10.254"></a><span id="l10.254">             mDatabase-&gt;MarkHdrRead(msgHdr, true, nullptr);</span>
<a href="#l10.255"></a><span id="l10.255">             mDatabase-&gt;MarkImapDeleted(msgKey, true, nullptr);</span>
<a href="#l10.256"></a><span id="l10.256">             rv = StoreImapFlags(kImapMsgSeenFlag | kImapMsgDeletedFlag, true,</span>
<a href="#l10.257"></a><span id="l10.257" class="difflineminus">-                                &amp;msgKey, 1, nullptr);</span>
<a href="#l10.258"></a><span id="l10.258" class="difflineplus">+                                {msgKey}, nullptr);</span>
<a href="#l10.259"></a><span id="l10.259">             if (NS_FAILED(rv)) break;</span>
<a href="#l10.260"></a><span id="l10.260">             // this will prevent us from adding the header to the db.</span>
<a href="#l10.261"></a><span id="l10.261">             m_msgMovedByFilter = true;</span>
<a href="#l10.262"></a><span id="l10.262">           }</span>
<a href="#l10.263"></a><span id="l10.263">           msgIsNew = false;</span>
<a href="#l10.264"></a><span id="l10.264">         }</span>
<a href="#l10.265"></a><span id="l10.265">           // note that delete falls through to move.</span>
<a href="#l10.266"></a><span id="l10.266">           [[fallthrough]];</span>
<a href="#l10.267"></a><span id="l10.267" class="difflineat">@@ -3320,27 +3308,27 @@ NS_IMETHODIMP nsImapMailFolder::ApplyFil</span>
<a href="#l10.268"></a><span id="l10.268">                     filterAction, msgHdr, rv,</span>
<a href="#l10.269"></a><span id="l10.269">                     NS_LITERAL_CSTRING(&quot;filterFailureCopyFailed&quot;));</span>
<a href="#l10.270"></a><span id="l10.270">               }</span>
<a href="#l10.271"></a><span id="l10.271">             }</span>
<a href="#l10.272"></a><span id="l10.272">           }</span>
<a href="#l10.273"></a><span id="l10.273">         } break;</span>
<a href="#l10.274"></a><span id="l10.274">         case nsMsgFilterAction::MarkRead: {</span>
<a href="#l10.275"></a><span id="l10.275">           mDatabase-&gt;MarkHdrRead(msgHdr, true, nullptr);</span>
<a href="#l10.276"></a><span id="l10.276" class="difflineminus">-          rv = StoreImapFlags(kImapMsgSeenFlag, true, &amp;msgKey, 1, nullptr);</span>
<a href="#l10.277"></a><span id="l10.277" class="difflineplus">+          rv = StoreImapFlags(kImapMsgSeenFlag, true, {msgKey}, nullptr);</span>
<a href="#l10.278"></a><span id="l10.278">           msgIsNew = false;</span>
<a href="#l10.279"></a><span id="l10.279">         } break;</span>
<a href="#l10.280"></a><span id="l10.280">         case nsMsgFilterAction::MarkUnread: {</span>
<a href="#l10.281"></a><span id="l10.281">           mDatabase-&gt;MarkHdrRead(msgHdr, false, nullptr);</span>
<a href="#l10.282"></a><span id="l10.282" class="difflineminus">-          rv = StoreImapFlags(kImapMsgSeenFlag, false, &amp;msgKey, 1, nullptr);</span>
<a href="#l10.283"></a><span id="l10.283" class="difflineplus">+          rv = StoreImapFlags(kImapMsgSeenFlag, false, {msgKey}, nullptr);</span>
<a href="#l10.284"></a><span id="l10.284">           msgIsNew = true;</span>
<a href="#l10.285"></a><span id="l10.285">         } break;</span>
<a href="#l10.286"></a><span id="l10.286">         case nsMsgFilterAction::MarkFlagged: {</span>
<a href="#l10.287"></a><span id="l10.287">           mDatabase-&gt;MarkHdrMarked(msgHdr, true, nullptr);</span>
<a href="#l10.288"></a><span id="l10.288" class="difflineminus">-          rv = StoreImapFlags(kImapMsgFlaggedFlag, true, &amp;msgKey, 1, nullptr);</span>
<a href="#l10.289"></a><span id="l10.289" class="difflineplus">+          rv = StoreImapFlags(kImapMsgFlaggedFlag, true, {msgKey}, nullptr);</span>
<a href="#l10.290"></a><span id="l10.290">         } break;</span>
<a href="#l10.291"></a><span id="l10.291">         case nsMsgFilterAction::KillThread:</span>
<a href="#l10.292"></a><span id="l10.292">         case nsMsgFilterAction::WatchThread: {</span>
<a href="#l10.293"></a><span id="l10.293">           nsCOMPtr&lt;nsIMsgThread&gt; msgThread;</span>
<a href="#l10.294"></a><span id="l10.294">           nsMsgKey threadKey;</span>
<a href="#l10.295"></a><span id="l10.295">           mDatabase-&gt;GetThreadContainingMsgHdr(msgHdr,</span>
<a href="#l10.296"></a><span id="l10.296">                                                getter_AddRefs(msgThread));</span>
<a href="#l10.297"></a><span id="l10.297">           if (msgThread) {</span>
<a href="#l10.298"></a><span id="l10.298" class="difflineat">@@ -3356,38 +3344,38 @@ NS_IMETHODIMP nsImapMailFolder::ApplyFil</span>
<a href="#l10.299"></a><span id="l10.299">               rv = msgHdr-&gt;SetUint32Property(&quot;ProtoThreadFlags&quot;,</span>
<a href="#l10.300"></a><span id="l10.300">                                              nsMsgMessageFlags::Ignored);</span>
<a href="#l10.301"></a><span id="l10.301">             else</span>
<a href="#l10.302"></a><span id="l10.302">               rv = msgHdr-&gt;SetUint32Property(&quot;ProtoThreadFlags&quot;,</span>
<a href="#l10.303"></a><span id="l10.303">                                              nsMsgMessageFlags::Watched);</span>
<a href="#l10.304"></a><span id="l10.304">           }</span>
<a href="#l10.305"></a><span id="l10.305">           if (actionType == nsMsgFilterAction::KillThread) {</span>
<a href="#l10.306"></a><span id="l10.306">             mDatabase-&gt;MarkHdrRead(msgHdr, true, nullptr);</span>
<a href="#l10.307"></a><span id="l10.307" class="difflineminus">-            rv = StoreImapFlags(kImapMsgSeenFlag, true, &amp;msgKey, 1, nullptr);</span>
<a href="#l10.308"></a><span id="l10.308" class="difflineplus">+            rv = StoreImapFlags(kImapMsgSeenFlag, true, {msgKey}, nullptr);</span>
<a href="#l10.309"></a><span id="l10.309">             msgIsNew = false;</span>
<a href="#l10.310"></a><span id="l10.310">           }</span>
<a href="#l10.311"></a><span id="l10.311">         } break;</span>
<a href="#l10.312"></a><span id="l10.312">         case nsMsgFilterAction::KillSubthread: {</span>
<a href="#l10.313"></a><span id="l10.313">           mDatabase-&gt;MarkHeaderKilled(msgHdr, true, nullptr);</span>
<a href="#l10.314"></a><span id="l10.314">           mDatabase-&gt;MarkHdrRead(msgHdr, true, nullptr);</span>
<a href="#l10.315"></a><span id="l10.315" class="difflineminus">-          rv = StoreImapFlags(kImapMsgSeenFlag, true, &amp;msgKey, 1, nullptr);</span>
<a href="#l10.316"></a><span id="l10.316" class="difflineplus">+          rv = StoreImapFlags(kImapMsgSeenFlag, true, {msgKey}, nullptr);</span>
<a href="#l10.317"></a><span id="l10.317">           msgIsNew = false;</span>
<a href="#l10.318"></a><span id="l10.318">         } break;</span>
<a href="#l10.319"></a><span id="l10.319">         case nsMsgFilterAction::ChangePriority: {</span>
<a href="#l10.320"></a><span id="l10.320">           nsMsgPriorityValue filterPriority;  // a int32_t</span>
<a href="#l10.321"></a><span id="l10.321">           filterAction-&gt;GetPriority(&amp;filterPriority);</span>
<a href="#l10.322"></a><span id="l10.322">           rv = mDatabase-&gt;SetUint32PropertyByHdr(</span>
<a href="#l10.323"></a><span id="l10.323">               msgHdr, &quot;priority&quot;, static_cast&lt;uint32_t&gt;(filterPriority));</span>
<a href="#l10.324"></a><span id="l10.324">         } break;</span>
<a href="#l10.325"></a><span id="l10.325">         case nsMsgFilterAction::Label: {</span>
<a href="#l10.326"></a><span id="l10.326">           nsMsgLabelValue filterLabel;</span>
<a href="#l10.327"></a><span id="l10.327">           filterAction-&gt;GetLabel(&amp;filterLabel);</span>
<a href="#l10.328"></a><span id="l10.328">           mDatabase-&gt;SetUint32PropertyByHdr(msgHdr, &quot;label&quot;,</span>
<a href="#l10.329"></a><span id="l10.329">                                             static_cast&lt;uint32_t&gt;(filterLabel));</span>
<a href="#l10.330"></a><span id="l10.330" class="difflineminus">-          rv = StoreImapFlags((filterLabel &lt;&lt; 9), true, &amp;msgKey, 1, nullptr);</span>
<a href="#l10.331"></a><span id="l10.331" class="difflineplus">+          rv = StoreImapFlags((filterLabel &lt;&lt; 9), true, {msgKey}, nullptr);</span>
<a href="#l10.332"></a><span id="l10.332">         } break;</span>
<a href="#l10.333"></a><span id="l10.333">         case nsMsgFilterAction::AddTag: {</span>
<a href="#l10.334"></a><span id="l10.334">           nsCString keyword;</span>
<a href="#l10.335"></a><span id="l10.335">           filterAction-&gt;GetStrValue(keyword);</span>
<a href="#l10.336"></a><span id="l10.336">           nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l10.337"></a><span id="l10.337">               do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l10.338"></a><span id="l10.338">           if (NS_FAILED(rv) || !messageArray) break;</span>
<a href="#l10.339"></a><span id="l10.339">           messageArray-&gt;AppendElement(msgHdr);</span>
<a href="#l10.340"></a><span id="l10.340" class="difflineat">@@ -3555,17 +3543,17 @@ NS_IMETHODIMP nsImapMailFolder::Playback</span>
<a href="#l10.341"></a><span id="l10.341">   nsresult rv;</span>
<a href="#l10.342"></a><span id="l10.342">   nsCOMPtr&lt;nsIImapService&gt; imapService =</span>
<a href="#l10.343"></a><span id="l10.343">       do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l10.344"></a><span id="l10.344">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.345"></a><span id="l10.345">   return imapService-&gt;CreateFolder(this, aFolderName, this, url);</span>
<a href="#l10.346"></a><span id="l10.346"> }</span>
<a href="#l10.347"></a><span id="l10.347"> </span>
<a href="#l10.348"></a><span id="l10.348"> NS_IMETHODIMP</span>
<a href="#l10.349"></a><span id="l10.349" class="difflineminus">-nsImapMailFolder::ReplayOfflineMoveCopy(nsMsgKey *aMsgKeys, uint32_t aNumKeys,</span>
<a href="#l10.350"></a><span id="l10.350" class="difflineplus">+nsImapMailFolder::ReplayOfflineMoveCopy(const nsTArray&lt;nsMsgKey&gt; &amp;aMsgKeys,</span>
<a href="#l10.351"></a><span id="l10.351">                                         bool isMove, nsIMsgFolder *aDstFolder,</span>
<a href="#l10.352"></a><span id="l10.352">                                         nsIUrlListener *aUrlListener,</span>
<a href="#l10.353"></a><span id="l10.353">                                         nsIMsgWindow *aWindow) {</span>
<a href="#l10.354"></a><span id="l10.354">   nsresult rv;</span>
<a href="#l10.355"></a><span id="l10.355"> </span>
<a href="#l10.356"></a><span id="l10.356">   nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(aDstFolder);</span>
<a href="#l10.357"></a><span id="l10.357">   if (imapFolder) {</span>
<a href="#l10.358"></a><span id="l10.358">     nsImapMailFolder *destImapFolder =</span>
<a href="#l10.359"></a><span id="l10.359" class="difflineat">@@ -3590,18 +3578,18 @@ nsImapMailFolder::ReplayOfflineMoveCopy(</span>
<a href="#l10.360"></a><span id="l10.360">           dstFolderDB-&gt;GetOfflineOpForKey(offlineOps[opIndex], false,</span>
<a href="#l10.361"></a><span id="l10.361">                                           getter_AddRefs(currentOp));</span>
<a href="#l10.362"></a><span id="l10.362">           if (currentOp) {</span>
<a href="#l10.363"></a><span id="l10.363">             nsCString opSrcUri;</span>
<a href="#l10.364"></a><span id="l10.364">             currentOp-&gt;GetSourceFolderURI(getter_Copies(opSrcUri));</span>
<a href="#l10.365"></a><span id="l10.365">             if (opSrcUri.Equals(srcFolderUri)) {</span>
<a href="#l10.366"></a><span id="l10.366">               nsMsgKey srcMessageKey;</span>
<a href="#l10.367"></a><span id="l10.367">               currentOp-&gt;GetSrcMessageKey(&amp;srcMessageKey);</span>
<a href="#l10.368"></a><span id="l10.368" class="difflineminus">-              for (uint32_t msgIndex = 0; msgIndex &lt; aNumKeys; msgIndex++) {</span>
<a href="#l10.369"></a><span id="l10.369" class="difflineminus">-                if (srcMessageKey == aMsgKeys[msgIndex]) {</span>
<a href="#l10.370"></a><span id="l10.370" class="difflineplus">+              for (auto key : aMsgKeys) {</span>
<a href="#l10.371"></a><span id="l10.371" class="difflineplus">+                if (srcMessageKey == key) {</span>
<a href="#l10.372"></a><span id="l10.372">                   nsCOMPtr&lt;nsIMsgDBHdr&gt; fakeDestHdr;</span>
<a href="#l10.373"></a><span id="l10.373">                   dstFolderDB-&gt;GetMsgHdrForKey(offlineOps[opIndex],</span>
<a href="#l10.374"></a><span id="l10.374">                                                getter_AddRefs(fakeDestHdr));</span>
<a href="#l10.375"></a><span id="l10.375">                   if (fakeDestHdr) messages-&gt;AppendElement(fakeDestHdr);</span>
<a href="#l10.376"></a><span id="l10.376">                   break;</span>
<a href="#l10.377"></a><span id="l10.377">                 }</span>
<a href="#l10.378"></a><span id="l10.378">               }</span>
<a href="#l10.379"></a><span id="l10.379">             }</span>
<a href="#l10.380"></a><span id="l10.380" class="difflineat">@@ -3615,17 +3603,17 @@ nsImapMailFolder::ReplayOfflineMoveCopy(</span>
<a href="#l10.381"></a><span id="l10.381">     // the offline move/copy.</span>
<a href="#l10.382"></a><span id="l10.382">   }</span>
<a href="#l10.383"></a><span id="l10.383"> </span>
<a href="#l10.384"></a><span id="l10.384">   nsCOMPtr&lt;nsIImapService&gt; imapService =</span>
<a href="#l10.385"></a><span id="l10.385">       do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l10.386"></a><span id="l10.386">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.387"></a><span id="l10.387">   nsCOMPtr&lt;nsIURI&gt; resultUrl;</span>
<a href="#l10.388"></a><span id="l10.388">   nsAutoCString uids;</span>
<a href="#l10.389"></a><span id="l10.389" class="difflineminus">-  AllocateUidStringFromKeys(aMsgKeys, aNumKeys, uids);</span>
<a href="#l10.390"></a><span id="l10.390" class="difflineplus">+  AllocateUidStringFromKeys(aMsgKeys, uids);</span>
<a href="#l10.391"></a><span id="l10.391">   rv = imapService-&gt;OnlineMessageCopy(this, uids, aDstFolder, true, isMove,</span>
<a href="#l10.392"></a><span id="l10.392">                                       aUrlListener, getter_AddRefs(resultUrl),</span>
<a href="#l10.393"></a><span id="l10.393">                                       nullptr, aWindow);</span>
<a href="#l10.394"></a><span id="l10.394">   if (resultUrl) {</span>
<a href="#l10.395"></a><span id="l10.395">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(resultUrl, &amp;rv);</span>
<a href="#l10.396"></a><span id="l10.396">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.397"></a><span id="l10.397">     nsCOMPtr&lt;nsIUrlListener&gt; folderListener = do_QueryInterface(aDstFolder);</span>
<a href="#l10.398"></a><span id="l10.398">     if (folderListener) mailnewsUrl-&gt;RegisterListener(folderListener);</span>
<a href="#l10.399"></a><span id="l10.399" class="difflineat">@@ -3644,40 +3632,38 @@ NS_IMETHODIMP nsImapMailFolder::AddMoveR</span>
<a href="#l10.400"></a><span id="l10.400">   pseudoHdr-&gt;GetMessageId(getter_Copies(messageId));</span>
<a href="#l10.401"></a><span id="l10.401">   // err on the side of caution and ignore messages w/o messageid.</span>
<a href="#l10.402"></a><span id="l10.402">   if (messageId.IsEmpty()) return NS_OK;</span>
<a href="#l10.403"></a><span id="l10.403">   m_pseudoHdrs.Put(messageId, aMsgKey);</span>
<a href="#l10.404"></a><span id="l10.404">   return NS_OK;</span>
<a href="#l10.405"></a><span id="l10.405"> }</span>
<a href="#l10.406"></a><span id="l10.406"> </span>
<a href="#l10.407"></a><span id="l10.407"> NS_IMETHODIMP nsImapMailFolder::StoreImapFlags(int32_t flags, bool addFlags,</span>
<a href="#l10.408"></a><span id="l10.408" class="difflineminus">-                                               nsMsgKey *keys, uint32_t numKeys,</span>
<a href="#l10.409"></a><span id="l10.409" class="difflineplus">+                                               const nsTArray&lt;nsMsgKey&gt; &amp;keys,</span>
<a href="#l10.410"></a><span id="l10.410">                                                nsIUrlListener *aUrlListener) {</span>
<a href="#l10.411"></a><span id="l10.411">   nsresult rv;</span>
<a href="#l10.412"></a><span id="l10.412">   if (!WeAreOffline()) {</span>
<a href="#l10.413"></a><span id="l10.413">     nsCOMPtr&lt;nsIImapService&gt; imapService =</span>
<a href="#l10.414"></a><span id="l10.414">         do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l10.415"></a><span id="l10.415">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.416"></a><span id="l10.416">     nsAutoCString msgIds;</span>
<a href="#l10.417"></a><span id="l10.417" class="difflineminus">-    AllocateUidStringFromKeys(keys, numKeys, msgIds);</span>
<a href="#l10.418"></a><span id="l10.418" class="difflineplus">+    AllocateUidStringFromKeys(keys, msgIds);</span>
<a href="#l10.419"></a><span id="l10.419">     if (addFlags)</span>
<a href="#l10.420"></a><span id="l10.420">       imapService-&gt;AddMessageFlags(this, aUrlListener ? aUrlListener : this,</span>
<a href="#l10.421"></a><span id="l10.421">                                    nullptr, msgIds, flags, true);</span>
<a href="#l10.422"></a><span id="l10.422">     else</span>
<a href="#l10.423"></a><span id="l10.423">       imapService-&gt;SubtractMessageFlags(this,</span>
<a href="#l10.424"></a><span id="l10.424">                                         aUrlListener ? aUrlListener : this,</span>
<a href="#l10.425"></a><span id="l10.425">                                         nullptr, msgIds, flags, true);</span>
<a href="#l10.426"></a><span id="l10.426">   } else {</span>
<a href="#l10.427"></a><span id="l10.427">     rv = GetDatabase();</span>
<a href="#l10.428"></a><span id="l10.428">     if (NS_SUCCEEDED(rv) &amp;&amp; mDatabase) {</span>
<a href="#l10.429"></a><span id="l10.429" class="difflineminus">-      uint32_t total = numKeys;</span>
<a href="#l10.430"></a><span id="l10.430" class="difflineminus">-      for (uint32_t keyIndex = 0; keyIndex &lt; total; keyIndex++) {</span>
<a href="#l10.431"></a><span id="l10.431" class="difflineplus">+      for (auto key : keys) {</span>
<a href="#l10.432"></a><span id="l10.432">         nsCOMPtr&lt;nsIMsgOfflineImapOperation&gt; op;</span>
<a href="#l10.433"></a><span id="l10.433" class="difflineminus">-        rv = mDatabase-&gt;GetOfflineOpForKey(keys[keyIndex], true,</span>
<a href="#l10.434"></a><span id="l10.434" class="difflineminus">-                                           getter_AddRefs(op));</span>
<a href="#l10.435"></a><span id="l10.435" class="difflineplus">+        rv = mDatabase-&gt;GetOfflineOpForKey(key, true, getter_AddRefs(op));</span>
<a href="#l10.436"></a><span id="l10.436">         SetFlag(nsMsgFolderFlags::OfflineEvents);</span>
<a href="#l10.437"></a><span id="l10.437">         if (NS_SUCCEEDED(rv) &amp;&amp; op) {</span>
<a href="#l10.438"></a><span id="l10.438">           imapMessageFlagsType newFlags;</span>
<a href="#l10.439"></a><span id="l10.439">           op-&gt;GetNewFlags(&amp;newFlags);</span>
<a href="#l10.440"></a><span id="l10.440">           op-&gt;SetFlagOperation(addFlags ? newFlags | flags : newFlags &amp; ~flags);</span>
<a href="#l10.441"></a><span id="l10.441">         }</span>
<a href="#l10.442"></a><span id="l10.442">       }</span>
<a href="#l10.443"></a><span id="l10.443">       mDatabase-&gt;Commit(</span>
<a href="#l10.444"></a><span id="l10.444" class="difflineat">@@ -7013,17 +6999,17 @@ nsImapMailFolder::CopyMessages(</span>
<a href="#l10.445"></a><span id="l10.445">     // if the folders aren't on the same server, do a stream base copy</span>
<a href="#l10.446"></a><span id="l10.446">     if (!sameServer) {</span>
<a href="#l10.447"></a><span id="l10.447">       rv = CopyMessagesWithStream(srcFolder, sortedMsgs, isMove, true,</span>
<a href="#l10.448"></a><span id="l10.448">                                   msgWindow, listener, allowUndo);</span>
<a href="#l10.449"></a><span id="l10.449">       goto done;</span>
<a href="#l10.450"></a><span id="l10.450">     }</span>
<a href="#l10.451"></a><span id="l10.451"> </span>
<a href="#l10.452"></a><span id="l10.452">     nsAutoCString messageIds;</span>
<a href="#l10.453"></a><span id="l10.453" class="difflineminus">-    rv = AllocateUidStringFromKeys(keyArray.Elements(), numMsgs, messageIds);</span>
<a href="#l10.454"></a><span id="l10.454" class="difflineplus">+    rv = AllocateUidStringFromKeys(keyArray, messageIds);</span>
<a href="#l10.455"></a><span id="l10.455">     if (NS_FAILED(rv)) goto done;</span>
<a href="#l10.456"></a><span id="l10.456"> </span>
<a href="#l10.457"></a><span id="l10.457">     nsCOMPtr&lt;nsIUrlListener&gt; urlListener;</span>
<a href="#l10.458"></a><span id="l10.458">     rv =</span>
<a href="#l10.459"></a><span id="l10.459">         QueryInterface(NS_GET_IID(nsIUrlListener), getter_AddRefs(urlListener));</span>
<a href="#l10.460"></a><span id="l10.460">     rv = InitCopyState(srcSupport, sortedMsgs, isMove, true, false, 0,</span>
<a href="#l10.461"></a><span id="l10.461">                        EmptyCString(), listener, msgWindow, allowUndo);</span>
<a href="#l10.462"></a><span id="l10.462">     if (NS_FAILED(rv)) goto done;</span>
<a href="#l10.463"></a><span id="l10.463" class="difflineat">@@ -8248,27 +8234,27 @@ nsresult nsImapMailFolder::GetMoveCoales</span>
<a href="#l10.464"></a><span id="l10.464">     m_moveCoalescer = new nsImapMoveCoalescer(this, nullptr /* msgWindow */);</span>
<a href="#l10.465"></a><span id="l10.465">   return NS_OK;</span>
<a href="#l10.466"></a><span id="l10.466"> }</span>
<a href="#l10.467"></a><span id="l10.467"> </span>
<a href="#l10.468"></a><span id="l10.468"> NS_IMETHODIMP</span>
<a href="#l10.469"></a><span id="l10.469"> nsImapMailFolder::StoreCustomKeywords(nsIMsgWindow *aMsgWindow,</span>
<a href="#l10.470"></a><span id="l10.470">                                       const nsACString &amp;aFlagsToAdd,</span>
<a href="#l10.471"></a><span id="l10.471">                                       const nsACString &amp;aFlagsToSubtract,</span>
<a href="#l10.472"></a><span id="l10.472" class="difflineminus">-                                      nsMsgKey *aKeysToStore, uint32_t aNumKeys,</span>
<a href="#l10.473"></a><span id="l10.473" class="difflineplus">+                                      const nsTArray&lt;nsMsgKey&gt; &amp;aKeysToStore,</span>
<a href="#l10.474"></a><span id="l10.474">                                       nsIURI **_retval) {</span>
<a href="#l10.475"></a><span id="l10.475" class="difflineminus">-  if (aNumKeys == 0) return NS_OK;</span>
<a href="#l10.476"></a><span id="l10.476" class="difflineplus">+  if (aKeysToStore.IsEmpty()) return NS_OK;</span>
<a href="#l10.477"></a><span id="l10.477">   nsresult rv = NS_OK;</span>
<a href="#l10.478"></a><span id="l10.478">   if (WeAreOffline()) {</span>
<a href="#l10.479"></a><span id="l10.479">     GetDatabase();</span>
<a href="#l10.480"></a><span id="l10.480">     if (!mDatabase) return NS_ERROR_UNEXPECTED;</span>
<a href="#l10.481"></a><span id="l10.481" class="difflineminus">-    for (uint32_t keyIndex = 0; keyIndex &lt; aNumKeys; keyIndex++) {</span>
<a href="#l10.482"></a><span id="l10.482" class="difflineplus">+    for (auto key : aKeysToStore) {</span>
<a href="#l10.483"></a><span id="l10.483">       nsCOMPtr&lt;nsIMsgOfflineImapOperation&gt; op;</span>
<a href="#l10.484"></a><span id="l10.484" class="difflineminus">-      nsresult rv2 = mDatabase-&gt;GetOfflineOpForKey(aKeysToStore[keyIndex], true,</span>
<a href="#l10.485"></a><span id="l10.485" class="difflineminus">-                                                   getter_AddRefs(op));</span>
<a href="#l10.486"></a><span id="l10.486" class="difflineplus">+      nsresult rv2 =</span>
<a href="#l10.487"></a><span id="l10.487" class="difflineplus">+          mDatabase-&gt;GetOfflineOpForKey(key, true, getter_AddRefs(op));</span>
<a href="#l10.488"></a><span id="l10.488">       if (NS_FAILED(rv2)) rv = rv2;</span>
<a href="#l10.489"></a><span id="l10.489">       SetFlag(nsMsgFolderFlags::OfflineEvents);</span>
<a href="#l10.490"></a><span id="l10.490">       if (NS_SUCCEEDED(rv2) &amp;&amp; op) {</span>
<a href="#l10.491"></a><span id="l10.491">         if (!aFlagsToAdd.IsEmpty())</span>
<a href="#l10.492"></a><span id="l10.492">           op-&gt;AddKeywordToAdd(PromiseFlatCString(aFlagsToAdd).get());</span>
<a href="#l10.493"></a><span id="l10.493">         if (!aFlagsToSubtract.IsEmpty())</span>
<a href="#l10.494"></a><span id="l10.494">           op-&gt;AddKeywordToRemove(PromiseFlatCString(aFlagsToSubtract).get());</span>
<a href="#l10.495"></a><span id="l10.495">       }</span>
<a href="#l10.496"></a><span id="l10.496" class="difflineat">@@ -8276,17 +8262,17 @@ nsImapMailFolder::StoreCustomKeywords(ns</span>
<a href="#l10.497"></a><span id="l10.497">     mDatabase-&gt;Commit(nsMsgDBCommitType::kLargeCommit);  // flush offline ops</span>
<a href="#l10.498"></a><span id="l10.498">     return rv;</span>
<a href="#l10.499"></a><span id="l10.499">   }</span>
<a href="#l10.500"></a><span id="l10.500"> </span>
<a href="#l10.501"></a><span id="l10.501">   nsCOMPtr&lt;nsIImapService&gt; imapService(</span>
<a href="#l10.502"></a><span id="l10.502">       do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l10.503"></a><span id="l10.503">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.504"></a><span id="l10.504">   nsAutoCString msgIds;</span>
<a href="#l10.505"></a><span id="l10.505" class="difflineminus">-  AllocateUidStringFromKeys(aKeysToStore, aNumKeys, msgIds);</span>
<a href="#l10.506"></a><span id="l10.506" class="difflineplus">+  AllocateUidStringFromKeys(aKeysToStore, msgIds);</span>
<a href="#l10.507"></a><span id="l10.507">   return imapService-&gt;StoreCustomKeywords(this, aMsgWindow, aFlagsToAdd,</span>
<a href="#l10.508"></a><span id="l10.508">                                           aFlagsToSubtract, msgIds, _retval);</span>
<a href="#l10.509"></a><span id="l10.509"> }</span>
<a href="#l10.510"></a><span id="l10.510"> </span>
<a href="#l10.511"></a><span id="l10.511"> NS_IMETHODIMP nsImapMailFolder::NotifyIfNewMail() {</span>
<a href="#l10.512"></a><span id="l10.512">   return PerformBiffNotifications();</span>
<a href="#l10.513"></a><span id="l10.513"> }</span>
<a href="#l10.514"></a><span id="l10.514"> </span>
<a href="#l10.515"></a><span id="l10.515" class="difflineat">@@ -8299,26 +8285,24 @@ bool nsImapMailFolder::ShowPreviewText()</span>
<a href="#l10.516"></a><span id="l10.516"> }</span>
<a href="#l10.517"></a><span id="l10.517"> </span>
<a href="#l10.518"></a><span id="l10.518"> nsresult nsImapMailFolder::PlaybackCoalescedOperations() {</span>
<a href="#l10.519"></a><span id="l10.519">   if (m_moveCoalescer) {</span>
<a href="#l10.520"></a><span id="l10.520">     nsTArray&lt;nsMsgKey&gt; *junkKeysToClassify = m_moveCoalescer-&gt;GetKeyBucket(0);</span>
<a href="#l10.521"></a><span id="l10.521">     if (junkKeysToClassify &amp;&amp; !junkKeysToClassify-&gt;IsEmpty())</span>
<a href="#l10.522"></a><span id="l10.522">       StoreCustomKeywords(m_moveCoalescer-&gt;GetMsgWindow(),</span>
<a href="#l10.523"></a><span id="l10.523">                           NS_LITERAL_CSTRING(&quot;Junk&quot;), EmptyCString(),</span>
<a href="#l10.524"></a><span id="l10.524" class="difflineminus">-                          junkKeysToClassify-&gt;Elements(),</span>
<a href="#l10.525"></a><span id="l10.525" class="difflineminus">-                          junkKeysToClassify-&gt;Length(), nullptr);</span>
<a href="#l10.526"></a><span id="l10.526" class="difflineplus">+                          *junkKeysToClassify, nullptr);</span>
<a href="#l10.527"></a><span id="l10.527">     junkKeysToClassify-&gt;Clear();</span>
<a href="#l10.528"></a><span id="l10.528">     nsTArray&lt;nsMsgKey&gt; *nonJunkKeysToClassify =</span>
<a href="#l10.529"></a><span id="l10.529">         m_moveCoalescer-&gt;GetKeyBucket(1);</span>
<a href="#l10.530"></a><span id="l10.530">     if (nonJunkKeysToClassify &amp;&amp; !nonJunkKeysToClassify-&gt;IsEmpty())</span>
<a href="#l10.531"></a><span id="l10.531">       StoreCustomKeywords(m_moveCoalescer-&gt;GetMsgWindow(),</span>
<a href="#l10.532"></a><span id="l10.532">                           NS_LITERAL_CSTRING(&quot;NonJunk&quot;), EmptyCString(),</span>
<a href="#l10.533"></a><span id="l10.533" class="difflineminus">-                          nonJunkKeysToClassify-&gt;Elements(),</span>
<a href="#l10.534"></a><span id="l10.534" class="difflineminus">-                          nonJunkKeysToClassify-&gt;Length(), nullptr);</span>
<a href="#l10.535"></a><span id="l10.535" class="difflineplus">+                          *nonJunkKeysToClassify, nullptr);</span>
<a href="#l10.536"></a><span id="l10.536">     nonJunkKeysToClassify-&gt;Clear();</span>
<a href="#l10.537"></a><span id="l10.537">     return m_moveCoalescer-&gt;PlaybackMoves(ShowPreviewText());</span>
<a href="#l10.538"></a><span id="l10.538">   }</span>
<a href="#l10.539"></a><span id="l10.539">   return NS_OK;  // must not be any coalesced operations</span>
<a href="#l10.540"></a><span id="l10.540"> }</span>
<a href="#l10.541"></a><span id="l10.541"> </span>
<a href="#l10.542"></a><span id="l10.542"> NS_IMETHODIMP</span>
<a href="#l10.543"></a><span id="l10.543"> nsImapMailFolder::SetJunkScoreForMessages(nsIArray *aMessages,</span>
<a href="#l10.544"></a><span id="l10.544" class="difflineat">@@ -8332,17 +8316,17 @@ nsImapMailFolder::SetJunkScoreForMessage</span>
<a href="#l10.545"></a><span id="l10.545">     nsresult rv = BuildIdsAndKeyArray(aMessages, messageIds, keys);</span>
<a href="#l10.546"></a><span id="l10.546">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.547"></a><span id="l10.547">     StoreCustomKeywords(</span>
<a href="#l10.548"></a><span id="l10.548">         nullptr,</span>
<a href="#l10.549"></a><span id="l10.549">         aJunkScore.EqualsLiteral(&quot;0&quot;) ? NS_LITERAL_CSTRING(&quot;NonJunk&quot;)</span>
<a href="#l10.550"></a><span id="l10.550">                                       : NS_LITERAL_CSTRING(&quot;Junk&quot;),</span>
<a href="#l10.551"></a><span id="l10.551">         aJunkScore.EqualsLiteral(&quot;0&quot;) ? NS_LITERAL_CSTRING(&quot;Junk&quot;)</span>
<a href="#l10.552"></a><span id="l10.552">                                       : NS_LITERAL_CSTRING(&quot;NonJunk&quot;),</span>
<a href="#l10.553"></a><span id="l10.553" class="difflineminus">-        keys.Elements(), keys.Length(), nullptr);</span>
<a href="#l10.554"></a><span id="l10.554" class="difflineplus">+        keys, nullptr);</span>
<a href="#l10.555"></a><span id="l10.555">     if (mDatabase) mDatabase-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l10.556"></a><span id="l10.556">   }</span>
<a href="#l10.557"></a><span id="l10.557">   return rv;</span>
<a href="#l10.558"></a><span id="l10.558"> }</span>
<a href="#l10.559"></a><span id="l10.559"> </span>
<a href="#l10.560"></a><span id="l10.560"> NS_IMETHODIMP</span>
<a href="#l10.561"></a><span id="l10.561"> nsImapMailFolder::OnMessageClassified(const char *aMsgURI,</span>
<a href="#l10.562"></a><span id="l10.562">                                       nsMsgJunkStatus aClassification,</span>
<a href="#l10.563"></a><span id="l10.563" class="difflineat">@@ -8590,33 +8574,31 @@ NS_IMETHODIMP nsImapMailFolder::FetchMsg</span>
<a href="#l10.564"></a><span id="l10.564"> NS_IMETHODIMP nsImapMailFolder::AddKeywordsToMessages(</span>
<a href="#l10.565"></a><span id="l10.565">     nsIArray *aMessages, const nsACString &amp;aKeywords) {</span>
<a href="#l10.566"></a><span id="l10.566">   nsresult rv = nsMsgDBFolder::AddKeywordsToMessages(aMessages, aKeywords);</span>
<a href="#l10.567"></a><span id="l10.567">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l10.568"></a><span id="l10.568">     nsAutoCString messageIds;</span>
<a href="#l10.569"></a><span id="l10.569">     nsTArray&lt;nsMsgKey&gt; keys;</span>
<a href="#l10.570"></a><span id="l10.570">     rv = BuildIdsAndKeyArray(aMessages, messageIds, keys);</span>
<a href="#l10.571"></a><span id="l10.571">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.572"></a><span id="l10.572" class="difflineminus">-    rv = StoreCustomKeywords(nullptr, aKeywords, EmptyCString(),</span>
<a href="#l10.573"></a><span id="l10.573" class="difflineminus">-                             keys.Elements(), keys.Length(), nullptr);</span>
<a href="#l10.574"></a><span id="l10.574" class="difflineplus">+    rv = StoreCustomKeywords(nullptr, aKeywords, EmptyCString(), keys, nullptr);</span>
<a href="#l10.575"></a><span id="l10.575">     if (mDatabase) mDatabase-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l10.576"></a><span id="l10.576">   }</span>
<a href="#l10.577"></a><span id="l10.577">   return rv;</span>
<a href="#l10.578"></a><span id="l10.578"> }</span>
<a href="#l10.579"></a><span id="l10.579"> </span>
<a href="#l10.580"></a><span id="l10.580"> NS_IMETHODIMP nsImapMailFolder::RemoveKeywordsFromMessages(</span>
<a href="#l10.581"></a><span id="l10.581">     nsIArray *aMessages, const nsACString &amp;aKeywords) {</span>
<a href="#l10.582"></a><span id="l10.582">   nsresult rv = nsMsgDBFolder::RemoveKeywordsFromMessages(aMessages, aKeywords);</span>
<a href="#l10.583"></a><span id="l10.583">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l10.584"></a><span id="l10.584">     nsAutoCString messageIds;</span>
<a href="#l10.585"></a><span id="l10.585">     nsTArray&lt;nsMsgKey&gt; keys;</span>
<a href="#l10.586"></a><span id="l10.586">     nsresult rv = BuildIdsAndKeyArray(aMessages, messageIds, keys);</span>
<a href="#l10.587"></a><span id="l10.587">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.588"></a><span id="l10.588" class="difflineminus">-    rv = StoreCustomKeywords(nullptr, EmptyCString(), aKeywords,</span>
<a href="#l10.589"></a><span id="l10.589" class="difflineminus">-                             keys.Elements(), keys.Length(), nullptr);</span>
<a href="#l10.590"></a><span id="l10.590" class="difflineplus">+    rv = StoreCustomKeywords(nullptr, EmptyCString(), aKeywords, keys, nullptr);</span>
<a href="#l10.591"></a><span id="l10.591">     if (mDatabase) mDatabase-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l10.592"></a><span id="l10.592">   }</span>
<a href="#l10.593"></a><span id="l10.593">   return rv;</span>
<a href="#l10.594"></a><span id="l10.594"> }</span>
<a href="#l10.595"></a><span id="l10.595"> </span>
<a href="#l10.596"></a><span id="l10.596"> NS_IMETHODIMP nsImapMailFolder::GetCustomIdentity(nsIMsgIdentity **aIdentity) {</span>
<a href="#l10.597"></a><span id="l10.597">   NS_ENSURE_ARG_POINTER(aIdentity);</span>
<a href="#l10.598"></a><span id="l10.598">   if (mFlags &amp; nsMsgFolderFlags::ImapOtherUser) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.h</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.h</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -355,17 +355,17 @@ class nsImapMailFolder : public nsMsgDBF</span>
<a href="#l11.4"></a><span id="l11.4">                                    nsIMsgDatabase *sourceDB,</span>
<a href="#l11.5"></a><span id="l11.5">                                    const nsACString &amp;destFolder,</span>
<a href="#l11.6"></a><span id="l11.6">                                    nsIMsgFilter *filter,</span>
<a href="#l11.7"></a><span id="l11.7">                                    nsIMsgWindow *msgWindow);</span>
<a href="#l11.8"></a><span id="l11.8"> </span>
<a href="#l11.9"></a><span id="l11.9">   // send notification to copy service listener.</span>
<a href="#l11.10"></a><span id="l11.10">   nsresult OnCopyCompleted(nsISupports *srcSupport, nsresult exitCode);</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-  static nsresult AllocateUidStringFromKeys(nsMsgKey *keys, uint32_t numKeys,</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+  static nsresult AllocateUidStringFromKeys(const nsTArray&lt;nsMsgKey&gt; &amp;keys,</span>
<a href="#l11.14"></a><span id="l11.14">                                             nsCString &amp;msgIds);</span>
<a href="#l11.15"></a><span id="l11.15">   static nsresult BuildIdsAndKeyArray(nsIArray *messages, nsCString &amp;msgIds,</span>
<a href="#l11.16"></a><span id="l11.16">                                       nsTArray&lt;nsMsgKey&gt; &amp;keyArray);</span>
<a href="#l11.17"></a><span id="l11.17"> </span>
<a href="#l11.18"></a><span id="l11.18">   // these might end up as an nsIImapMailFolder attribute.</span>
<a href="#l11.19"></a><span id="l11.19">   nsresult SetSupportedUserFlags(uint32_t userFlags);</span>
<a href="#l11.20"></a><span id="l11.20">   nsresult GetSupportedUserFlags(uint32_t *userFlags);</span>
<a href="#l11.21"></a><span id="l11.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/imap/src/nsImapOfflineSync.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapOfflineSync.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -226,18 +226,17 @@ void nsImapOfflineSync::ProcessFlagOpera</span>
<a href="#l12.4"></a><span id="l12.4">       currentOp-&gt;GetNewFlags(&amp;newFlags);</span>
<a href="#l12.5"></a><span id="l12.5">     }</span>
<a href="#l12.6"></a><span id="l12.6">     flagsMatch = (flagOperation &amp; nsIMsgOfflineImapOperation::kFlagsChanged) &amp;&amp;</span>
<a href="#l12.7"></a><span id="l12.7">                  (newFlags == matchingFlags);</span>
<a href="#l12.8"></a><span id="l12.8">   } while (currentOp);</span>
<a href="#l12.9"></a><span id="l12.9"> </span>
<a href="#l12.10"></a><span id="l12.10">   if (!matchingFlagKeys.IsEmpty()) {</span>
<a href="#l12.11"></a><span id="l12.11">     nsAutoCString uids;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-    nsImapMailFolder::AllocateUidStringFromKeys(</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-        matchingFlagKeys.Elements(), matchingFlagKeys.Length(), uids);</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+    nsImapMailFolder::AllocateUidStringFromKeys(matchingFlagKeys, uids);</span>
<a href="#l12.15"></a><span id="l12.15">     uint32_t curFolderFlags;</span>
<a href="#l12.16"></a><span id="l12.16">     m_currentFolder-&gt;GetFlags(&amp;curFolderFlags);</span>
<a href="#l12.17"></a><span id="l12.17"> </span>
<a href="#l12.18"></a><span id="l12.18">     if (uids.get() &amp;&amp; (curFolderFlags &amp; nsMsgFolderFlags::ImapBox)) {</span>
<a href="#l12.19"></a><span id="l12.19">       nsresult rv = NS_OK;</span>
<a href="#l12.20"></a><span id="l12.20">       nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder =</span>
<a href="#l12.21"></a><span id="l12.21">           do_QueryInterface(m_currentFolder);</span>
<a href="#l12.22"></a><span id="l12.22">       nsCOMPtr&lt;nsIURI&gt; uriToSetFlags;</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineat">@@ -306,18 +305,17 @@ void nsImapOfflineSync::ProcessKeywordOp</span>
<a href="#l12.24"></a><span id="l12.24">             m_window,</span>
<a href="#l12.25"></a><span id="l12.25">             (mCurrentPlaybackOpType == nsIMsgOfflineImapOperation::kAddKeywords)</span>
<a href="#l12.26"></a><span id="l12.26">                 ? keywords</span>
<a href="#l12.27"></a><span id="l12.27">                 : EmptyCString(),</span>
<a href="#l12.28"></a><span id="l12.28">             (mCurrentPlaybackOpType ==</span>
<a href="#l12.29"></a><span id="l12.29">              nsIMsgOfflineImapOperation::kRemoveKeywords)</span>
<a href="#l12.30"></a><span id="l12.30">                 ? keywords</span>
<a href="#l12.31"></a><span id="l12.31">                 : EmptyCString(),</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineminus">-            matchingKeywordKeys.Elements(), matchingKeywordKeys.Length(),</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-            getter_AddRefs(uriToStoreCustomKeywords));</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+            matchingKeywordKeys, getter_AddRefs(uriToStoreCustomKeywords));</span>
<a href="#l12.35"></a><span id="l12.35">         if (NS_SUCCEEDED(rv) &amp;&amp; uriToStoreCustomKeywords) {</span>
<a href="#l12.36"></a><span id="l12.36">           nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl =</span>
<a href="#l12.37"></a><span id="l12.37">               do_QueryInterface(uriToStoreCustomKeywords);</span>
<a href="#l12.38"></a><span id="l12.38">           if (mailnewsUrl) mailnewsUrl-&gt;RegisterListener(this);</span>
<a href="#l12.39"></a><span id="l12.39">         }</span>
<a href="#l12.40"></a><span id="l12.40">       }</span>
<a href="#l12.41"></a><span id="l12.41">     }</span>
<a href="#l12.42"></a><span id="l12.42">   } else</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineat">@@ -498,19 +496,18 @@ void nsImapOfflineSync::ProcessMoveOpera</span>
<a href="#l12.44"></a><span id="l12.44">     NS_WARNING(&quot;trying to playing back move to non-existent folder&quot;);</span>
<a href="#l12.45"></a><span id="l12.45">     ClearCurrentOps();</span>
<a href="#l12.46"></a><span id="l12.46">     ProcessNextOperation();</span>
<a href="#l12.47"></a><span id="l12.47">     return;</span>
<a href="#l12.48"></a><span id="l12.48">   }</span>
<a href="#l12.49"></a><span id="l12.49">   nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder =</span>
<a href="#l12.50"></a><span id="l12.50">       do_QueryInterface(m_currentFolder);</span>
<a href="#l12.51"></a><span id="l12.51">   if (imapFolder &amp;&amp; DestFolderOnSameServer(destFolder)) {</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineminus">-    imapFolder-&gt;ReplayOfflineMoveCopy(matchingFlagKeys.Elements(),</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineminus">-                                      matchingFlagKeys.Length(), true,</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineminus">-                                      destFolder, this, m_window);</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+    imapFolder-&gt;ReplayOfflineMoveCopy(matchingFlagKeys, true, destFolder, this,</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+                                      m_window);</span>
<a href="#l12.57"></a><span id="l12.57">   } else {</span>
<a href="#l12.58"></a><span id="l12.58">     nsresult rv;</span>
<a href="#l12.59"></a><span id="l12.59">     nsCOMPtr&lt;nsIMutableArray&gt; messages(</span>
<a href="#l12.60"></a><span id="l12.60">         do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l12.61"></a><span id="l12.61">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l12.62"></a><span id="l12.62">       for (uint32_t keyIndex = 0; keyIndex &lt; matchingFlagKeys.Length();</span>
<a href="#l12.63"></a><span id="l12.63">            keyIndex++) {</span>
<a href="#l12.64"></a><span id="l12.64">         nsCOMPtr&lt;nsIMsgDBHdr&gt; mailHdr = nullptr;</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineat">@@ -606,19 +603,18 @@ void nsImapOfflineSync::ProcessCopyOpera</span>
<a href="#l12.66"></a><span id="l12.66">     NS_ERROR(&quot;trying to playing back copy to non-existent folder&quot;);</span>
<a href="#l12.67"></a><span id="l12.67">     ClearCurrentOps();</span>
<a href="#l12.68"></a><span id="l12.68">     ProcessNextOperation();</span>
<a href="#l12.69"></a><span id="l12.69">     return;</span>
<a href="#l12.70"></a><span id="l12.70">   }</span>
<a href="#l12.71"></a><span id="l12.71">   nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder =</span>
<a href="#l12.72"></a><span id="l12.72">       do_QueryInterface(m_currentFolder);</span>
<a href="#l12.73"></a><span id="l12.73">   if (imapFolder &amp;&amp; DestFolderOnSameServer(destFolder)) {</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineminus">-    rv = imapFolder-&gt;ReplayOfflineMoveCopy(matchingFlagKeys.Elements(),</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineminus">-                                           matchingFlagKeys.Length(), false,</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineminus">-                                           destFolder, this, m_window);</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineplus">+    rv = imapFolder-&gt;ReplayOfflineMoveCopy(matchingFlagKeys, false, destFolder,</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+                                           this, m_window);</span>
<a href="#l12.79"></a><span id="l12.79">   } else {</span>
<a href="#l12.80"></a><span id="l12.80">     nsCOMPtr&lt;nsIMutableArray&gt; messages(</span>
<a href="#l12.81"></a><span id="l12.81">         do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l12.82"></a><span id="l12.82">     if (messages &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l12.83"></a><span id="l12.83">       for (uint32_t keyIndex = 0; keyIndex &lt; matchingFlagKeys.Length();</span>
<a href="#l12.84"></a><span id="l12.84">            keyIndex++) {</span>
<a href="#l12.85"></a><span id="l12.85">         nsCOMPtr&lt;nsIMsgDBHdr&gt; mailHdr = nullptr;</span>
<a href="#l12.86"></a><span id="l12.86">         rv = m_currentFolder-&gt;GetMessageHeader(</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/imap/src/nsImapUndoTxn.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapUndoTxn.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -385,18 +385,17 @@ NS_IMETHODIMP nsImapMoveCopyMsgTxn::OnSt</span>
<a href="#l13.4"></a><span id="l13.4">         if (NS_SUCCEEDED(rv) &amp;&amp; dstHdr) {</span>
<a href="#l13.5"></a><span id="l13.5">           nsMsgKey dstKey;</span>
<a href="#l13.6"></a><span id="l13.6">           dstHdr-&gt;GetMessageKey(&amp;dstKey);</span>
<a href="#l13.7"></a><span id="l13.7">           dstKeys.AppendElement(dstKey);</span>
<a href="#l13.8"></a><span id="l13.8">         }</span>
<a href="#l13.9"></a><span id="l13.9">       }</span>
<a href="#l13.10"></a><span id="l13.10">       if (dstKeys.Length()) {</span>
<a href="#l13.11"></a><span id="l13.11">         nsAutoCString uids;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-        nsImapMailFolder::AllocateUidStringFromKeys(dstKeys.Elements(),</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-                                                    dstKeys.Length(), uids);</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+        nsImapMailFolder::AllocateUidStringFromKeys(dstKeys, uids);</span>
<a href="#l13.15"></a><span id="l13.15">         rv = imapService-&gt;OnlineMessageCopy(dstFolder, uids, srcFolder, true,</span>
<a href="#l13.16"></a><span id="l13.16">                                             true, nullptr, nullptr, nullptr,</span>
<a href="#l13.17"></a><span id="l13.17">                                             nullptr);</span>
<a href="#l13.18"></a><span id="l13.18">       }</span>
<a href="#l13.19"></a><span id="l13.19">     }</span>
<a href="#l13.20"></a><span id="l13.20">   }</span>
<a href="#l13.21"></a><span id="l13.21">   return NS_OK;</span>
<a href="#l13.22"></a><span id="l13.22"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_compactOfflineStore.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_compactOfflineStore.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -96,17 +96,16 @@ var tests = [</span>
<a href="#l14.4"></a><span id="l14.4">     let msgHdr = IMAPPump.inbox.msgDatabase.getMsgHdrForMessageID(gMsgId5);</span>
<a href="#l14.5"></a><span id="l14.5">     let array = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l14.6"></a><span id="l14.6">     array.appendElement(msgHdr);</span>
<a href="#l14.7"></a><span id="l14.7">     // store the deleted flag</span>
<a href="#l14.8"></a><span id="l14.8">     IMAPPump.inbox.storeImapFlags(</span>
<a href="#l14.9"></a><span id="l14.9">       0x0008,</span>
<a href="#l14.10"></a><span id="l14.10">       true,</span>
<a href="#l14.11"></a><span id="l14.11">       [msgHdr.messageKey],</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-      1,</span>
<a href="#l14.13"></a><span id="l14.13">       asyncUrlListener</span>
<a href="#l14.14"></a><span id="l14.14">     );</span>
<a href="#l14.15"></a><span id="l14.15">     yield false;</span>
<a href="#l14.16"></a><span id="l14.16">   },</span>
<a href="#l14.17"></a><span id="l14.17">   function* compactOneFolder() {</span>
<a href="#l14.18"></a><span id="l14.18">     IMAPPump.incomingServer.deleteModel = Ci.nsMsgImapDeleteModels.IMAPDelete;</span>
<a href="#l14.19"></a><span id="l14.19">     // asyncUrlListener will get called when both expunge and offline store</span>
<a href="#l14.20"></a><span id="l14.20">     // compaction are finished. dummyMsgWindow is required to make the backend</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/suite/mailnews/components/compose/content/MsgComposeCommands.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/suite/mailnews/components/compose/content/MsgComposeCommands.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -2381,17 +2381,17 @@ function RemoveDraft()</span>
<a href="#l15.4"></a><span id="l15.4">         folder.deleteMessages(msgs, null, true, false, null, false);</span>
<a href="#l15.5"></a><span id="l15.5">       }</span>
<a href="#l15.6"></a><span id="l15.6">     }</span>
<a href="#l15.7"></a><span id="l15.7">     catch (ex) // couldn't find header - perhaps an imap folder.</span>
<a href="#l15.8"></a><span id="l15.8">     {</span>
<a href="#l15.9"></a><span id="l15.9">       if (folder instanceof Ci.nsIMsgImapMailFolder)</span>
<a href="#l15.10"></a><span id="l15.10">       {</span>
<a href="#l15.11"></a><span id="l15.11">         const kImapMsgDeletedFlag = 0x0008;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-        folder.storeImapFlags(kImapMsgDeletedFlag, true, [msgKey], 1, null);</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+        folder.storeImapFlags(kImapMsgDeletedFlag, true, [msgKey], null);</span>
<a href="#l15.14"></a><span id="l15.14">       }</span>
<a href="#l15.15"></a><span id="l15.15">     }</span>
<a href="#l15.16"></a><span id="l15.16">   } catch (ex) {}</span>
<a href="#l15.17"></a><span id="l15.17"> }</span>
<a href="#l15.18"></a><span id="l15.18"> </span>
<a href="#l15.19"></a><span id="l15.19"> function SetContentAndBodyAsUnmodified()</span>
<a href="#l15.20"></a><span id="l15.20"> {</span>
<a href="#l15.21"></a><span id="l15.21">   gMsgCompose.bodyModified = false;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

