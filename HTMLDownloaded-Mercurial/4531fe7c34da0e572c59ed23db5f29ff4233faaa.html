<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 18005:4531fe7c34da0e572c59ed23db5f29ff4233faaa</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 4531fe7c34da0e572c59ed23db5f29ff4233faaa" />
<meta property="og:url" content="/comm-central/rev/4531fe7c34da0e572c59ed23db5f29ff4233faaa" />
<meta property="og:description" content="Bug 1171663 - Change PR_LOG to MOZ_LOG in mailnews/, r=rkent" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 4531fe7c34da0e572c59ed23db5f29ff4233faaa 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/4531fe7c34da0e572c59ed23db5f29ff4233faaa">shortlog</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/4531fe7c34da0e572c59ed23db5f29ff4233faaa">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa">files</a> |
changeset |
<a href="/comm-central/raw-rev/4531fe7c34da0e572c59ed23db5f29ff4233faaa">raw</a>  | <a href="/comm-central/archive/4531fe7c34da0e572c59ed23db5f29ff4233faaa.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1171663">Bug 1171663</a> - Change PR_LOG to MOZ_LOG in mailnews/, r=rkent
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#69;&#100;&#109;&#117;&#110;&#100;&#32;&#87;&#111;&#110;&#103;&#32;&#60;&#101;&#119;&#111;&#110;&#103;&#64;&#112;&#119;&#45;&#119;&#115;&#112;&#120;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 05 Jun 2015 11:44:02 -0700</td></tr>

<tr>
 <td>changeset 18005</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/4531fe7c34da0e572c59ed23db5f29ff4233faaa">4531fe7c34da0e572c59ed23db5f29ff4233faaa</a></td>
</tr>



<tr>
<td>parent 18004</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/a2ca69d3bcce00f253431b65850d12291f1e07f7">a2ca69d3bcce00f253431b65850d12291f1e07f7</a>
</td>
</tr>

<tr>
<td>child 18006</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/724e8467d630c007ed9cc73513d4fb714bc07fa6">724e8467d630c007ed9cc73513d4fb714bc07fa6</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=4531fe7c34da0e572c59ed23db5f29ff4233faaa">11068</a></td></tr>
<tr><td>push user</td><td>kent@caspia.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 05 Jun 2015 18:46:41 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@724e8467d630 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=724e8467d630c007ed9cc73513d4fb714bc07fa6">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=724e8467d630c007ed9cc73513d4fb714bc07fa6&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=724e8467d630c007ed9cc73513d4fb714bc07fa6&newProject=comm-central&newRevision=4531fe7c34da0e572c59ed23db5f29ff4233faaa&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=724e8467d630c007ed9cc73513d4fb714bc07fa6&newProject=comm-central&newRevision=4531fe7c34da0e572c59ed23db5f29ff4233faaa&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=724e8467d630c007ed9cc73513d4fb714bc07fa6&newProject=comm-central&newRevision=4531fe7c34da0e572c59ed23db5f29ff4233faaa&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28rkent%29&revcount=50">rkent</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1171663">1171663</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1171663">Bug 1171663</a> - Change PR_LOG to MOZ_LOG in mailnews/, r=rkent
* * *
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1171663">Bug 1171663</a> - RKJ revs to merge</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/ldap/xpcom/src/nsLDAPConnection.cpp">ldap/xpcom/src/nsLDAPConnection.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/ldap/xpcom/src/nsLDAPConnection.cpp">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/ldap/xpcom/src/nsLDAPConnection.cpp">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/ldap/xpcom/src/nsLDAPConnection.cpp">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/ldap/xpcom/src/nsLDAPConnection.cpp">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/ldap/xpcom/src/nsLDAPConnection.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/ldap/xpcom/src/nsLDAPMessage.cpp">ldap/xpcom/src/nsLDAPMessage.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/ldap/xpcom/src/nsLDAPMessage.cpp">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/ldap/xpcom/src/nsLDAPMessage.cpp">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/ldap/xpcom/src/nsLDAPMessage.cpp">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/ldap/xpcom/src/nsLDAPMessage.cpp">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/ldap/xpcom/src/nsLDAPMessage.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/ldap/xpcom/src/nsLDAPOperation.cpp">ldap/xpcom/src/nsLDAPOperation.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/ldap/xpcom/src/nsLDAPOperation.cpp">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/ldap/xpcom/src/nsLDAPOperation.cpp">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/ldap/xpcom/src/nsLDAPOperation.cpp">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/ldap/xpcom/src/nsLDAPOperation.cpp">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/ldap/xpcom/src/nsLDAPOperation.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/ldap/xpcom/src/nsLDAPProtocolModule.cpp">ldap/xpcom/src/nsLDAPProtocolModule.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/ldap/xpcom/src/nsLDAPProtocolModule.cpp">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/ldap/xpcom/src/nsLDAPProtocolModule.cpp">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/ldap/xpcom/src/nsLDAPProtocolModule.cpp">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/ldap/xpcom/src/nsLDAPProtocolModule.cpp">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/ldap/xpcom/src/nsLDAPProtocolModule.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/ldap/xpcom/src/nsLDAPService.cpp">ldap/xpcom/src/nsLDAPService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/ldap/xpcom/src/nsLDAPService.cpp">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/ldap/xpcom/src/nsLDAPService.cpp">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/ldap/xpcom/src/nsLDAPService.cpp">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/ldap/xpcom/src/nsLDAPService.cpp">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/ldap/xpcom/src/nsLDAPService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/addrbook/src/nsAbOutlookDirFactory.cpp">mailnews/addrbook/src/nsAbOutlookDirFactory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/addrbook/src/nsAbOutlookDirFactory.cpp">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/addrbook/src/nsAbOutlookDirFactory.cpp">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/addrbook/src/nsAbOutlookDirFactory.cpp">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/addrbook/src/nsAbOutlookDirFactory.cpp">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/addrbook/src/nsAbOutlookDirFactory.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/addrbook/src/nsAbOutlookDirectory.cpp">mailnews/addrbook/src/nsAbOutlookDirectory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/addrbook/src/nsAbOutlookDirectory.cpp">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/addrbook/src/nsAbOutlookDirectory.cpp">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/addrbook/src/nsAbOutlookDirectory.cpp">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/addrbook/src/nsAbOutlookDirectory.cpp">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/addrbook/src/nsAbOutlookDirectory.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/addrbook/src/nsAbWinHelper.cpp">mailnews/addrbook/src/nsAbWinHelper.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/addrbook/src/nsAbWinHelper.cpp">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/addrbook/src/nsAbWinHelper.cpp">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/addrbook/src/nsAbWinHelper.cpp">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/addrbook/src/nsAbWinHelper.cpp">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/addrbook/src/nsAbWinHelper.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/addrbook/src/nsMapiAddressBook.cpp">mailnews/addrbook/src/nsMapiAddressBook.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/addrbook/src/nsMapiAddressBook.cpp">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/addrbook/src/nsMapiAddressBook.cpp">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/addrbook/src/nsMapiAddressBook.cpp">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/addrbook/src/nsMapiAddressBook.cpp">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/addrbook/src/nsMapiAddressBook.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/addrbook/src/nsWabAddressBook.cpp">mailnews/addrbook/src/nsWabAddressBook.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/addrbook/src/nsWabAddressBook.cpp">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/addrbook/src/nsWabAddressBook.cpp">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/addrbook/src/nsWabAddressBook.cpp">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/addrbook/src/nsWabAddressBook.cpp">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/addrbook/src/nsWabAddressBook.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/base/src/nsMsgBiffManager.cpp">mailnews/base/src/nsMsgBiffManager.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/base/src/nsMsgBiffManager.cpp">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/base/src/nsMsgBiffManager.cpp">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/base/src/nsMsgBiffManager.cpp">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/base/src/nsMsgBiffManager.cpp">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/base/src/nsMsgBiffManager.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/base/src/nsMsgCopyService.cpp">mailnews/base/src/nsMsgCopyService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/base/src/nsMsgCopyService.cpp">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/base/src/nsMsgCopyService.cpp">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/base/src/nsMsgCopyService.cpp">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/base/src/nsMsgCopyService.cpp">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/base/src/nsMsgCopyService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/base/src/nsMsgPurgeService.cpp">mailnews/base/src/nsMsgPurgeService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/base/src/nsMsgPurgeService.cpp">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/base/src/nsMsgPurgeService.cpp">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/base/src/nsMsgPurgeService.cpp">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/base/src/nsMsgPurgeService.cpp">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/base/src/nsMsgPurgeService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/compose/src/nsMsgComposeService.cpp">mailnews/compose/src/nsMsgComposeService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/compose/src/nsMsgComposeService.cpp">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/compose/src/nsMsgComposeService.cpp">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/compose/src/nsMsgComposeService.cpp">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/compose/src/nsMsgComposeService.cpp">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/compose/src/nsMsgComposeService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/compose/src/nsSmtpProtocol.cpp">mailnews/compose/src/nsSmtpProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/compose/src/nsSmtpProtocol.cpp">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/compose/src/nsSmtpProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/compose/src/nsSmtpProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/compose/src/nsSmtpProtocol.cpp">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/compose/src/nsSmtpProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/db/msgdb/src/nsMailDatabase.cpp">mailnews/db/msgdb/src/nsMailDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/db/msgdb/src/nsMailDatabase.cpp">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/db/msgdb/src/nsMailDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/db/msgdb/src/nsMailDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/db/msgdb/src/nsMailDatabase.cpp">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/db/msgdb/src/nsMailDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/db/msgdb/src/nsMsgDatabase.cpp">mailnews/db/msgdb/src/nsMsgDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/db/msgdb/src/nsMsgDatabase.cpp">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/db/msgdb/src/nsMsgDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/db/msgdb/src/nsMsgDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/db/msgdb/src/nsMsgDatabase.cpp">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/db/msgdb/src/nsMsgDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/db/msgdb/src/nsMsgOfflineImapOperation.cpp">mailnews/db/msgdb/src/nsMsgOfflineImapOperation.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/db/msgdb/src/nsMsgOfflineImapOperation.cpp">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/db/msgdb/src/nsMsgOfflineImapOperation.cpp">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/db/msgdb/src/nsMsgOfflineImapOperation.cpp">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/db/msgdb/src/nsMsgOfflineImapOperation.cpp">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/db/msgdb/src/nsMsgOfflineImapOperation.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/imap/src/nsAutoSyncManager.cpp">mailnews/imap/src/nsAutoSyncManager.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/imap/src/nsAutoSyncManager.cpp">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/imap/src/nsAutoSyncManager.cpp">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/imap/src/nsAutoSyncManager.cpp">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/imap/src/nsAutoSyncManager.cpp">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/imap/src/nsAutoSyncManager.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/imap/src/nsAutoSyncState.cpp">mailnews/imap/src/nsAutoSyncState.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/imap/src/nsAutoSyncState.cpp">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/imap/src/nsAutoSyncState.cpp">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/imap/src/nsAutoSyncState.cpp">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/imap/src/nsAutoSyncState.cpp">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/imap/src/nsAutoSyncState.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/imap/src/nsIMAPBodyShell.cpp">mailnews/imap/src/nsIMAPBodyShell.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/imap/src/nsIMAPBodyShell.cpp">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/imap/src/nsIMAPBodyShell.cpp">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/imap/src/nsIMAPBodyShell.cpp">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/imap/src/nsIMAPBodyShell.cpp">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/imap/src/nsIMAPBodyShell.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/imap/src/nsImapProtocol.cpp">mailnews/imap/src/nsImapProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/imap/src/nsImapProtocol.cpp">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/imap/src/nsImapProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/imap/src/nsImapProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/imap/src/nsImapProtocol.cpp">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/imap/src/nsImapProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/imap/src/nsImapServerResponseParser.cpp">mailnews/imap/src/nsImapServerResponseParser.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/imap/src/nsImapServerResponseParser.cpp">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/imap/src/nsImapServerResponseParser.cpp">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/imap/src/nsImapServerResponseParser.cpp">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/imap/src/nsImapServerResponseParser.cpp">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/imap/src/nsImapServerResponseParser.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/applemail/src/nsAppleMailImport.h">mailnews/import/applemail/src/nsAppleMailImport.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/applemail/src/nsAppleMailImport.h">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/applemail/src/nsAppleMailImport.h">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/applemail/src/nsAppleMailImport.h">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/applemail/src/nsAppleMailImport.h">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/applemail/src/nsAppleMailImport.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/eudora/src/EudoraDebugLog.h">mailnews/import/eudora/src/EudoraDebugLog.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/eudora/src/EudoraDebugLog.h">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/eudora/src/EudoraDebugLog.h">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/eudora/src/EudoraDebugLog.h">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/eudora/src/EudoraDebugLog.h">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/eudora/src/EudoraDebugLog.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/oexpress/OEDebugLog.h">mailnews/import/oexpress/OEDebugLog.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/oexpress/OEDebugLog.h">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/oexpress/OEDebugLog.h">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/oexpress/OEDebugLog.h">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/oexpress/OEDebugLog.h">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/oexpress/OEDebugLog.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/outlook/src/OutlookDebugLog.h">mailnews/import/outlook/src/OutlookDebugLog.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/outlook/src/OutlookDebugLog.h">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/outlook/src/OutlookDebugLog.h">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/outlook/src/OutlookDebugLog.h">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/outlook/src/OutlookDebugLog.h">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/outlook/src/OutlookDebugLog.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/src/ImportDebug.h">mailnews/import/src/ImportDebug.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/src/ImportDebug.h">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/src/ImportDebug.h">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/src/ImportDebug.h">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/src/ImportDebug.h">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/src/ImportDebug.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/text/src/TextDebugLog.h">mailnews/import/text/src/TextDebugLog.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/text/src/TextDebugLog.h">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/text/src/TextDebugLog.h">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/text/src/TextDebugLog.h">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/text/src/TextDebugLog.h">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/text/src/TextDebugLog.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/vcard/src/nsVCardAddress.h">mailnews/import/vcard/src/nsVCardAddress.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/vcard/src/nsVCardAddress.h">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/vcard/src/nsVCardAddress.h">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/vcard/src/nsVCardAddress.h">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/vcard/src/nsVCardAddress.h">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/vcard/src/nsVCardAddress.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/winlivemail/WMDebugLog.h">mailnews/import/winlivemail/WMDebugLog.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/winlivemail/WMDebugLog.h">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/winlivemail/WMDebugLog.h">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/winlivemail/WMDebugLog.h">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/winlivemail/WMDebugLog.h">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/import/winlivemail/WMDebugLog.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/local/src/nsMailboxProtocol.cpp">mailnews/local/src/nsMailboxProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/local/src/nsMailboxProtocol.cpp">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/local/src/nsMailboxProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/local/src/nsMailboxProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/local/src/nsMailboxProtocol.cpp">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/local/src/nsMailboxProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/local/src/nsMovemailService.cpp">mailnews/local/src/nsMovemailService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/local/src/nsMovemailService.cpp">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/local/src/nsMovemailService.cpp">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/local/src/nsMovemailService.cpp">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/local/src/nsMovemailService.cpp">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/local/src/nsMovemailService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/local/src/nsMsgMaildirStore.cpp">mailnews/local/src/nsMsgMaildirStore.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/local/src/nsMsgMaildirStore.cpp">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/local/src/nsMsgMaildirStore.cpp">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/local/src/nsMsgMaildirStore.cpp">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/local/src/nsMsgMaildirStore.cpp">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/local/src/nsMsgMaildirStore.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/local/src/nsPop3Protocol.cpp">mailnews/local/src/nsPop3Protocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/local/src/nsPop3Protocol.cpp">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/local/src/nsPop3Protocol.cpp">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/local/src/nsPop3Protocol.cpp">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/local/src/nsPop3Protocol.cpp">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/local/src/nsPop3Protocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/local/src/nsPop3Sink.cpp">mailnews/local/src/nsPop3Sink.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/local/src/nsPop3Sink.cpp">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/local/src/nsPop3Sink.cpp">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/local/src/nsPop3Sink.cpp">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/local/src/nsPop3Sink.cpp">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/local/src/nsPop3Sink.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/mapi/mapihook/src/msgMapiHook.cpp">mailnews/mapi/mapihook/src/msgMapiHook.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/mapi/mapihook/src/msgMapiHook.cpp">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/mapi/mapihook/src/msgMapiHook.cpp">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/mapi/mapihook/src/msgMapiHook.cpp">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/mapi/mapihook/src/msgMapiHook.cpp">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/mapi/mapihook/src/msgMapiHook.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/mapi/mapihook/src/msgMapiImp.cpp">mailnews/mapi/mapihook/src/msgMapiImp.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/mapi/mapihook/src/msgMapiImp.cpp">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/mapi/mapihook/src/msgMapiImp.cpp">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/mapi/mapihook/src/msgMapiImp.cpp">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/mapi/mapihook/src/msgMapiImp.cpp">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/mapi/mapihook/src/msgMapiImp.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/mime/emitters/nsMimeBaseEmitter.cpp">mailnews/mime/emitters/nsMimeBaseEmitter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/mime/emitters/nsMimeBaseEmitter.cpp">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/mime/emitters/nsMimeBaseEmitter.cpp">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/mime/emitters/nsMimeBaseEmitter.cpp">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/mime/emitters/nsMimeBaseEmitter.cpp">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/mime/emitters/nsMimeBaseEmitter.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/mime/src/nsCMS.cpp">mailnews/mime/src/nsCMS.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/mime/src/nsCMS.cpp">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/mime/src/nsCMS.cpp">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/mime/src/nsCMS.cpp">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/mime/src/nsCMS.cpp">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/mime/src/nsCMS.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/mime/src/nsCMSSecureMessage.cpp">mailnews/mime/src/nsCMSSecureMessage.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/mime/src/nsCMSSecureMessage.cpp">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/mime/src/nsCMSSecureMessage.cpp">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/mime/src/nsCMSSecureMessage.cpp">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/mime/src/nsCMSSecureMessage.cpp">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/mime/src/nsCMSSecureMessage.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/news/src/nsNNTPProtocol.cpp">mailnews/news/src/nsNNTPProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/news/src/nsNNTPProtocol.cpp">file</a> |
<a href="/comm-central/annotate/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/news/src/nsNNTPProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/news/src/nsNNTPProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/news/src/nsNNTPProtocol.cpp">comparison</a> |
<a href="/comm-central/log/4531fe7c34da0e572c59ed23db5f29ff4233faaa/mailnews/news/src/nsNNTPProtocol.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPConnection.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPConnection.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -21,16 +21,17 @@</span>
<a href="#l1.4"></a><span id="l1.4"> #include &quot;nsILDAPErrors.h&quot;</span>
<a href="#l1.5"></a><span id="l1.5"> #include &quot;nsIClassInfoImpl.h&quot;</span>
<a href="#l1.6"></a><span id="l1.6"> #include &quot;nsILDAPURL.h&quot;</span>
<a href="#l1.7"></a><span id="l1.7"> #include &quot;nsIObserverService.h&quot;</span>
<a href="#l1.8"></a><span id="l1.8"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l1.9"></a><span id="l1.9"> #include &quot;nsMemory.h&quot;</span>
<a href="#l1.10"></a><span id="l1.10"> #include &quot;nsLDAPUtils.h&quot;</span>
<a href="#l1.11"></a><span id="l1.11"> #include &quot;nsProxyRelease.h&quot;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l1.13"></a><span id="l1.13"> </span>
<a href="#l1.14"></a><span id="l1.14"> using namespace mozilla;</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16"> const char kConsoleServiceContractId[] = &quot;@mozilla.org/consoleservice;1&quot;;</span>
<a href="#l1.17"></a><span id="l1.17"> const char kDNSServiceContractId[] = &quot;@mozilla.org/network/dns-service;1&quot;;</span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19"> // constructor</span>
<a href="#l1.20"></a><span id="l1.20"> //</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineat">@@ -171,35 +172,35 @@ nsLDAPConnection::Init(nsILDAPURL *aUrl,</span>
<a href="#l1.22"></a><span id="l1.22"> }</span>
<a href="#l1.23"></a><span id="l1.23"> </span>
<a href="#l1.24"></a><span id="l1.24"> // this might get exposed to clients, so we've broken it</span>
<a href="#l1.25"></a><span id="l1.25"> // out of the destructor.</span>
<a href="#l1.26"></a><span id="l1.26"> void</span>
<a href="#l1.27"></a><span id="l1.27"> nsLDAPConnection::Close()</span>
<a href="#l1.28"></a><span id="l1.28"> {</span>
<a href="#l1.29"></a><span id="l1.29">   int rc;</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-  PR_LOG(gLDAPLogModule, PR_LOG_DEBUG, (&quot;unbinding\n&quot;));</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+  MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Debug, (&quot;unbinding\n&quot;));</span>
<a href="#l1.32"></a><span id="l1.32"> </span>
<a href="#l1.33"></a><span id="l1.33">   if (mConnectionHandle) {</span>
<a href="#l1.34"></a><span id="l1.34">       // note that the ldap_unbind() call in the 5.0 version of the LDAP C SDK</span>
<a href="#l1.35"></a><span id="l1.35">       // appears to be exactly identical to ldap_unbind_s(), so it may in fact</span>
<a href="#l1.36"></a><span id="l1.36">       // still be synchronous</span>
<a href="#l1.37"></a><span id="l1.37">       //</span>
<a href="#l1.38"></a><span id="l1.38">       rc = ldap_unbind(mConnectionHandle);</span>
<a href="#l1.39"></a><span id="l1.39"> #ifdef PR_LOGGING</span>
<a href="#l1.40"></a><span id="l1.40">       if (rc != LDAP_SUCCESS) {</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-          PR_LOG(gLDAPLogModule, PR_LOG_WARNING,</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+          MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Warning,</span>
<a href="#l1.43"></a><span id="l1.43">                  (&quot;nsLDAPConnection::Close(): %s\n&quot;,</span>
<a href="#l1.44"></a><span id="l1.44">                   ldap_err2string(rc)));</span>
<a href="#l1.45"></a><span id="l1.45">       }</span>
<a href="#l1.46"></a><span id="l1.46"> #endif</span>
<a href="#l1.47"></a><span id="l1.47">       mConnectionHandle = nullptr;</span>
<a href="#l1.48"></a><span id="l1.48">   }</span>
<a href="#l1.49"></a><span id="l1.49"> </span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-  PR_LOG(gLDAPLogModule, PR_LOG_DEBUG, (&quot;unbound\n&quot;));</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+  MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Debug, (&quot;unbound\n&quot;));</span>
<a href="#l1.52"></a><span id="l1.52"> </span>
<a href="#l1.53"></a><span id="l1.53">   NS_ASSERTION(!mThread || NS_SUCCEEDED(mThread-&gt;Shutdown()),</span>
<a href="#l1.54"></a><span id="l1.54">                &quot;Failed to shutdown thread cleanly&quot;);</span>
<a href="#l1.55"></a><span id="l1.55"> </span>
<a href="#l1.56"></a><span id="l1.56">   // Cancel the DNS lookup if needed, and also drop the reference to the</span>
<a href="#l1.57"></a><span id="l1.57">   // Init listener (if still there).</span>
<a href="#l1.58"></a><span id="l1.58">   //</span>
<a href="#l1.59"></a><span id="l1.59">   if (mDNSRequest) {</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineat">@@ -328,17 +329,17 @@ nsLDAPConnection::AddPendingOperation(ui</span>
<a href="#l1.61"></a><span id="l1.61"> {</span>
<a href="#l1.62"></a><span id="l1.62">   NS_ENSURE_ARG_POINTER(aOperation);</span>
<a href="#l1.63"></a><span id="l1.63"> </span>
<a href="#l1.64"></a><span id="l1.64">   nsIRunnable* runnable = new nsLDAPConnectionRunnable(aOperationID, aOperation,</span>
<a href="#l1.65"></a><span id="l1.65">                                                        this);</span>
<a href="#l1.66"></a><span id="l1.66">   {</span>
<a href="#l1.67"></a><span id="l1.67">     MutexAutoLock lock(mPendingOperationsMutex);</span>
<a href="#l1.68"></a><span id="l1.68">     mPendingOperations.Put((uint32_t)aOperationID, aOperation);</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineminus">-    PR_LOG(gLDAPLogModule, PR_LOG_DEBUG,</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+    MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l1.71"></a><span id="l1.71">            (&quot;pending operation added; total pending operations now = %d\n&quot;,</span>
<a href="#l1.72"></a><span id="l1.72">             mPendingOperations.Count()));</span>
<a href="#l1.73"></a><span id="l1.73">   }</span>
<a href="#l1.74"></a><span id="l1.74"> </span>
<a href="#l1.75"></a><span id="l1.75">   nsresult rv;</span>
<a href="#l1.76"></a><span id="l1.76">   if (!mThread)</span>
<a href="#l1.77"></a><span id="l1.77">   {</span>
<a href="#l1.78"></a><span id="l1.78">     rv = NS_NewThread(getter_AddRefs(mThread), runnable);</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineat">@@ -364,23 +365,23 @@ nsLDAPConnection::AddPendingOperation(ui</span>
<a href="#l1.80"></a><span id="l1.80">  *</span>
<a href="#l1.81"></a><span id="l1.81">  * void removePendingOperation(in nsILDAPOperation aOperation);</span>
<a href="#l1.82"></a><span id="l1.82">  */</span>
<a href="#l1.83"></a><span id="l1.83"> nsresult</span>
<a href="#l1.84"></a><span id="l1.84"> nsLDAPConnection::RemovePendingOperation(uint32_t aOperationID)</span>
<a href="#l1.85"></a><span id="l1.85"> {</span>
<a href="#l1.86"></a><span id="l1.86">   NS_ENSURE_TRUE(aOperationID &gt; 0, NS_ERROR_UNEXPECTED);</span>
<a href="#l1.87"></a><span id="l1.87"> </span>
<a href="#l1.88"></a><span id="l1.88" class="difflineminus">-  PR_LOG(gLDAPLogModule, PR_LOG_DEBUG,</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+  MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l1.90"></a><span id="l1.90">          (&quot;nsLDAPConnection::RemovePendingOperation(): operation removed\n&quot;));</span>
<a href="#l1.91"></a><span id="l1.91"> </span>
<a href="#l1.92"></a><span id="l1.92">   {</span>
<a href="#l1.93"></a><span id="l1.93">     MutexAutoLock lock(mPendingOperationsMutex);</span>
<a href="#l1.94"></a><span id="l1.94">     mPendingOperations.Remove(aOperationID);</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineminus">-    PR_LOG(gLDAPLogModule, PR_LOG_DEBUG,</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineplus">+    MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l1.97"></a><span id="l1.97">            (&quot;nsLDAPConnection::RemovePendingOperation(): operation &quot;</span>
<a href="#l1.98"></a><span id="l1.98">             &quot;removed; total pending operations now = %d\n&quot;,</span>
<a href="#l1.99"></a><span id="l1.99">             mPendingOperations.Count()));</span>
<a href="#l1.100"></a><span id="l1.100">   }</span>
<a href="#l1.101"></a><span id="l1.101"> </span>
<a href="#l1.102"></a><span id="l1.102">   return NS_OK;</span>
<a href="#l1.103"></a><span id="l1.103"> }</span>
<a href="#l1.104"></a><span id="l1.104"> </span>
<a href="#l1.105"></a><span id="l1.105" class="difflineat">@@ -423,17 +424,17 @@ NS_IMETHODIMP nsOnLDAPMessageRunnable::R</span>
<a href="#l1.106"></a><span id="l1.106"> nsresult</span>
<a href="#l1.107"></a><span id="l1.107"> nsLDAPConnection::InvokeMessageCallback(LDAPMessage *aMsgHandle,</span>
<a href="#l1.108"></a><span id="l1.108">                                         nsILDAPMessage *aMsg,</span>
<a href="#l1.109"></a><span id="l1.109">                                         int32_t aOperation,</span>
<a href="#l1.110"></a><span id="l1.110">                                         bool aRemoveOpFromConnQ)</span>
<a href="#l1.111"></a><span id="l1.111"> {</span>
<a href="#l1.112"></a><span id="l1.112"> #if defined(DEBUG)</span>
<a href="#l1.113"></a><span id="l1.113">   // We only want this being logged for debug builds so as not to affect performance too much.</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineminus">-  PR_LOG(gLDAPLogModule, PR_LOG_DEBUG, (&quot;InvokeMessageCallback entered\n&quot;));</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineplus">+  MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Debug, (&quot;InvokeMessageCallback entered\n&quot;));</span>
<a href="#l1.116"></a><span id="l1.116"> #endif</span>
<a href="#l1.117"></a><span id="l1.117"> </span>
<a href="#l1.118"></a><span id="l1.118">   // Get the operation.</span>
<a href="#l1.119"></a><span id="l1.119">   nsCOMPtr&lt;nsILDAPOperation&gt; operation;</span>
<a href="#l1.120"></a><span id="l1.120">   {</span>
<a href="#l1.121"></a><span id="l1.121">     MutexAutoLock lock(mPendingOperationsMutex);</span>
<a href="#l1.122"></a><span id="l1.122">     mPendingOperations.Get((uint32_t)aOperation, getter_AddRefs(operation));</span>
<a href="#l1.123"></a><span id="l1.123">   }</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineat">@@ -451,17 +452,17 @@ nsLDAPConnection::InvokeMessageCallback(</span>
<a href="#l1.125"></a><span id="l1.125"> </span>
<a href="#l1.126"></a><span id="l1.126">   // if requested (ie the operation is done), remove the operation</span>
<a href="#l1.127"></a><span id="l1.127">   // from the connection queue.</span>
<a href="#l1.128"></a><span id="l1.128">   if (aRemoveOpFromConnQ)</span>
<a href="#l1.129"></a><span id="l1.129">   {</span>
<a href="#l1.130"></a><span id="l1.130">     MutexAutoLock lock(mPendingOperationsMutex);</span>
<a href="#l1.131"></a><span id="l1.131">     mPendingOperations.Remove(aOperation);</span>
<a href="#l1.132"></a><span id="l1.132"> </span>
<a href="#l1.133"></a><span id="l1.133" class="difflineminus">-    PR_LOG(gLDAPLogModule, PR_LOG_DEBUG,</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineplus">+    MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l1.135"></a><span id="l1.135">            (&quot;pending operation removed; total pending operations now =&quot;</span>
<a href="#l1.136"></a><span id="l1.136">             &quot; %d\n&quot;, mPendingOperations.Count()));</span>
<a href="#l1.137"></a><span id="l1.137">   }</span>
<a href="#l1.138"></a><span id="l1.138"> </span>
<a href="#l1.139"></a><span id="l1.139">   return NS_OK;</span>
<a href="#l1.140"></a><span id="l1.140"> }</span>
<a href="#l1.141"></a><span id="l1.141"> </span>
<a href="#l1.142"></a><span id="l1.142"> NS_IMETHODIMP</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPMessage.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPMessage.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -10,16 +10,17 @@</span>
<a href="#l2.4"></a><span id="l2.4"> #include &quot;nsDebug.h&quot;</span>
<a href="#l2.5"></a><span id="l2.5"> #include &quot;nsMemory.h&quot;</span>
<a href="#l2.6"></a><span id="l2.6"> #include &quot;nsLDAPConnection.h&quot;</span>
<a href="#l2.7"></a><span id="l2.7"> #include &quot;nsISupportsUtils.h&quot;</span>
<a href="#l2.8"></a><span id="l2.8"> #include &quot;nsLDAPBERValue.h&quot;</span>
<a href="#l2.9"></a><span id="l2.9"> #include &quot;nsILDAPErrors.h&quot;</span>
<a href="#l2.10"></a><span id="l2.10"> #include &quot;nsIClassInfoImpl.h&quot;</span>
<a href="#l2.11"></a><span id="l2.11"> #include &quot;nsLDAPUtils.h&quot;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l2.13"></a><span id="l2.13"> </span>
<a href="#l2.14"></a><span id="l2.14"> NS_IMPL_CLASSINFO(nsLDAPMessage, NULL, nsIClassInfo::THREADSAFE,</span>
<a href="#l2.15"></a><span id="l2.15">                   NS_LDAPMESSAGE_CID)</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17"> NS_IMPL_ADDREF(nsLDAPMessage)</span>
<a href="#l2.18"></a><span id="l2.18"> NS_IMPL_RELEASE(nsLDAPMessage)</span>
<a href="#l2.19"></a><span id="l2.19"> NS_INTERFACE_MAP_BEGIN(nsLDAPMessage)</span>
<a href="#l2.20"></a><span id="l2.20">   NS_INTERFACE_MAP_ENTRY(nsILDAPMessage)</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineat">@@ -65,24 +66,24 @@ nsLDAPMessage::~nsLDAPMessage(void)</span>
<a href="#l2.22"></a><span id="l2.22">         case LDAP_RES_SEARCH_REFERENCE:</span>
<a href="#l2.23"></a><span id="l2.23">         case LDAP_RES_EXTENDED:</span>
<a href="#l2.24"></a><span id="l2.24">         case LDAP_RES_ANY:</span>
<a href="#l2.25"></a><span id="l2.25">             // success</span>
<a href="#l2.26"></a><span id="l2.26">             break;</span>
<a href="#l2.27"></a><span id="l2.27"> </span>
<a href="#l2.28"></a><span id="l2.28">         case LDAP_SUCCESS:</span>
<a href="#l2.29"></a><span id="l2.29">             // timed out (dunno why LDAP_SUCCESS is used to indicate this) </span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-            PR_LOG(gLDAPLogModule, PR_LOG_WARNING, </span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+            MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Warning, </span>
<a href="#l2.32"></a><span id="l2.32">                    (&quot;nsLDAPMessage::~nsLDAPMessage: ldap_msgfree() &quot;</span>
<a href="#l2.33"></a><span id="l2.33">                     &quot;timed out\n&quot;));</span>
<a href="#l2.34"></a><span id="l2.34">             break;</span>
<a href="#l2.35"></a><span id="l2.35"> </span>
<a href="#l2.36"></a><span id="l2.36">         default:</span>
<a href="#l2.37"></a><span id="l2.37">             // other failure</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-            PR_LOG(gLDAPLogModule, PR_LOG_WARNING, </span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+            MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Warning, </span>
<a href="#l2.40"></a><span id="l2.40">                    (&quot;nsLDAPMessage::~nsLDAPMessage: ldap_msgfree() &quot;</span>
<a href="#l2.41"></a><span id="l2.41">                     &quot;failed: %s\n&quot;, ldap_err2string(rc)));</span>
<a href="#l2.42"></a><span id="l2.42">             break;</span>
<a href="#l2.43"></a><span id="l2.43">         }</span>
<a href="#l2.44"></a><span id="l2.44">     }</span>
<a href="#l2.45"></a><span id="l2.45"> </span>
<a href="#l2.46"></a><span id="l2.46">     if (mMatchedDn) {</span>
<a href="#l2.47"></a><span id="l2.47">         ldap_memfree(mMatchedDn);</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineat">@@ -431,17 +432,17 @@ NS_IMETHODIMP nsLDAPMessage::GetDn(nsACS</span>
<a href="#l2.49"></a><span id="l2.49"> </span>
<a href="#l2.50"></a><span id="l2.50">         case LDAP_PARAM_ERROR:</span>
<a href="#l2.51"></a><span id="l2.51">         default:</span>
<a href="#l2.52"></a><span id="l2.52">             NS_ERROR(&quot;nsLDAPMessage::GetDn(): internal error&quot;);</span>
<a href="#l2.53"></a><span id="l2.53">             return NS_ERROR_UNEXPECTED;</span>
<a href="#l2.54"></a><span id="l2.54">         }</span>
<a href="#l2.55"></a><span id="l2.55">     }</span>
<a href="#l2.56"></a><span id="l2.56"> </span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-    PR_LOG(gLDAPLogModule, PR_LOG_DEBUG,</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+    MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l2.59"></a><span id="l2.59">            (&quot;nsLDAPMessage::GetDn(): dn = '%s'&quot;, rawDn));</span>
<a href="#l2.60"></a><span id="l2.60"> </span>
<a href="#l2.61"></a><span id="l2.61">     aDn.Assign(rawDn);</span>
<a href="#l2.62"></a><span id="l2.62">     ldap_memfree(rawDn);</span>
<a href="#l2.63"></a><span id="l2.63"> </span>
<a href="#l2.64"></a><span id="l2.64">     return NS_OK;</span>
<a href="#l2.65"></a><span id="l2.65"> }</span>
<a href="#l2.66"></a><span id="l2.66"> </span>
<a href="#l2.67"></a><span id="l2.67" class="difflineat">@@ -450,32 +451,32 @@ NS_IMETHODIMP nsLDAPMessage::GetDn(nsACS</span>
<a href="#l2.68"></a><span id="l2.68"> NS_IMETHODIMP</span>
<a href="#l2.69"></a><span id="l2.69"> nsLDAPMessage::GetValues(const char *aAttr, uint32_t *aCount, </span>
<a href="#l2.70"></a><span id="l2.70">                          char16_t ***aValues)</span>
<a href="#l2.71"></a><span id="l2.71"> {</span>
<a href="#l2.72"></a><span id="l2.72">     char **values;</span>
<a href="#l2.73"></a><span id="l2.73">     </span>
<a href="#l2.74"></a><span id="l2.74"> #if defined(DEBUG)</span>
<a href="#l2.75"></a><span id="l2.75">     // We only want this being logged for debug builds so as not to affect performance too much.</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-    PR_LOG(gLDAPLogModule, PR_LOG_DEBUG,</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+    MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l2.78"></a><span id="l2.78">            (&quot;nsLDAPMessage::GetValues(): called with aAttr = '%s'&quot;, aAttr));</span>
<a href="#l2.79"></a><span id="l2.79"> #endif</span>
<a href="#l2.80"></a><span id="l2.80"> </span>
<a href="#l2.81"></a><span id="l2.81">     values = ldap_get_values(mConnectionHandle, mMsgHandle, aAttr);</span>
<a href="#l2.82"></a><span id="l2.82"> </span>
<a href="#l2.83"></a><span id="l2.83">     // bail out if there was a problem</span>
<a href="#l2.84"></a><span id="l2.84">     //</span>
<a href="#l2.85"></a><span id="l2.85">     if (!values) {</span>
<a href="#l2.86"></a><span id="l2.86">         int32_t lderrno = ldap_get_lderrno(mConnectionHandle, 0, 0);</span>
<a href="#l2.87"></a><span id="l2.87"> </span>
<a href="#l2.88"></a><span id="l2.88">         if ( lderrno == LDAP_DECODING_ERROR ) {</span>
<a href="#l2.89"></a><span id="l2.89">             // this may not be an error; it could just be that the </span>
<a href="#l2.90"></a><span id="l2.90">             // caller has asked for an attribute that doesn't exist.</span>
<a href="#l2.91"></a><span id="l2.91">             //</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineminus">-            PR_LOG(gLDAPLogModule, PR_LOG_WARNING, </span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+            MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Warning, </span>
<a href="#l2.94"></a><span id="l2.94">                    (&quot;nsLDAPMessage::GetValues(): ldap_get_values returned &quot;</span>
<a href="#l2.95"></a><span id="l2.95">                     &quot;LDAP_DECODING_ERROR&quot;));</span>
<a href="#l2.96"></a><span id="l2.96">             return NS_ERROR_LDAP_DECODING_ERROR;</span>
<a href="#l2.97"></a><span id="l2.97"> </span>
<a href="#l2.98"></a><span id="l2.98">         } else if ( lderrno == LDAP_PARAM_ERROR ) {</span>
<a href="#l2.99"></a><span id="l2.99">             NS_ERROR(&quot;nsLDAPMessage::GetValues(): internal error: 1&quot;);</span>
<a href="#l2.100"></a><span id="l2.100">             return NS_ERROR_UNEXPECTED;</span>
<a href="#l2.101"></a><span id="l2.101"> </span>
<a href="#l2.102"></a><span id="l2.102" class="difflineat">@@ -527,33 +528,33 @@ nsLDAPMessage::GetValues(const char *aAt</span>
<a href="#l2.103"></a><span id="l2.103"> NS_IMETHODIMP </span>
<a href="#l2.104"></a><span id="l2.104"> nsLDAPMessage::GetBinaryValues(const char *aAttr, uint32_t *aCount,</span>
<a href="#l2.105"></a><span id="l2.105">                                nsILDAPBERValue ***aValues)</span>
<a href="#l2.106"></a><span id="l2.106"> {</span>
<a href="#l2.107"></a><span id="l2.107">     struct berval **values;</span>
<a href="#l2.108"></a><span id="l2.108"> </span>
<a href="#l2.109"></a><span id="l2.109"> #if defined(DEBUG)</span>
<a href="#l2.110"></a><span id="l2.110">     // We only want this being logged for debug builds so as not to affect performance too much.</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineminus">-    PR_LOG(gLDAPLogModule, PR_LOG_DEBUG,</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineplus">+    MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l2.113"></a><span id="l2.113">            (&quot;nsLDAPMessage::GetBinaryValues(): called with aAttr = '%s'&quot;, </span>
<a href="#l2.114"></a><span id="l2.114">             aAttr));</span>
<a href="#l2.115"></a><span id="l2.115"> #endif</span>
<a href="#l2.116"></a><span id="l2.116"> </span>
<a href="#l2.117"></a><span id="l2.117">     values = ldap_get_values_len(mConnectionHandle, mMsgHandle, aAttr);</span>
<a href="#l2.118"></a><span id="l2.118"> </span>
<a href="#l2.119"></a><span id="l2.119">     // bail out if there was a problem</span>
<a href="#l2.120"></a><span id="l2.120">     //</span>
<a href="#l2.121"></a><span id="l2.121">     if (!values) {</span>
<a href="#l2.122"></a><span id="l2.122">         int32_t lderrno = ldap_get_lderrno(mConnectionHandle, 0, 0);</span>
<a href="#l2.123"></a><span id="l2.123"> </span>
<a href="#l2.124"></a><span id="l2.124">         if ( lderrno == LDAP_DECODING_ERROR ) {</span>
<a href="#l2.125"></a><span id="l2.125">             // this may not be an error; it could just be that the </span>
<a href="#l2.126"></a><span id="l2.126">             // caller has asked for an attribute that doesn't exist.</span>
<a href="#l2.127"></a><span id="l2.127">             //</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineminus">-            PR_LOG(gLDAPLogModule, PR_LOG_WARNING, </span>
<a href="#l2.129"></a><span id="l2.129" class="difflineplus">+            MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Warning, </span>
<a href="#l2.130"></a><span id="l2.130">                    (&quot;nsLDAPMessage::GetBinaryValues(): ldap_get_values &quot;</span>
<a href="#l2.131"></a><span id="l2.131">                     &quot;returned LDAP_DECODING_ERROR&quot;));</span>
<a href="#l2.132"></a><span id="l2.132">             return NS_ERROR_LDAP_DECODING_ERROR;</span>
<a href="#l2.133"></a><span id="l2.133"> </span>
<a href="#l2.134"></a><span id="l2.134">         } else if ( lderrno == LDAP_PARAM_ERROR ) {</span>
<a href="#l2.135"></a><span id="l2.135">             NS_ERROR(&quot;nsLDAPMessage::GetBinaryValues(): internal error: 1&quot;);</span>
<a href="#l2.136"></a><span id="l2.136">             return NS_ERROR_UNEXPECTED;</span>
<a href="#l2.137"></a><span id="l2.137"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPOperation.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPOperation.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -13,16 +13,17 @@</span>
<a href="#l3.4"></a><span id="l3.4"> #include &quot;nspr.h&quot;</span>
<a href="#l3.5"></a><span id="l3.5"> #include &quot;nsISimpleEnumerator.h&quot;</span>
<a href="#l3.6"></a><span id="l3.6"> #include &quot;nsLDAPControl.h&quot;</span>
<a href="#l3.7"></a><span id="l3.7"> #include &quot;nsILDAPErrors.h&quot;</span>
<a href="#l3.8"></a><span id="l3.8"> #include &quot;nsIClassInfoImpl.h&quot;</span>
<a href="#l3.9"></a><span id="l3.9"> #include &quot;nsIAuthModule.h&quot;</span>
<a href="#l3.10"></a><span id="l3.10"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l3.11"></a><span id="l3.11"> #include &quot;nsMemory.h&quot;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l3.13"></a><span id="l3.13"> </span>
<a href="#l3.14"></a><span id="l3.14"> // Helper function</span>
<a href="#l3.15"></a><span id="l3.15"> static nsresult TranslateLDAPErrorToNSError(const int ldapError)</span>
<a href="#l3.16"></a><span id="l3.16"> {</span>
<a href="#l3.17"></a><span id="l3.17">   switch (ldapError) {</span>
<a href="#l3.18"></a><span id="l3.18">   case LDAP_SUCCESS:</span>
<a href="#l3.19"></a><span id="l3.19">     return NS_OK;</span>
<a href="#l3.20"></a><span id="l3.20"> </span>
<a href="#l3.21"></a><span id="l3.21" class="difflineat">@@ -43,17 +44,17 @@ static nsresult TranslateLDAPErrorToNSEr</span>
<a href="#l3.22"></a><span id="l3.22"> </span>
<a href="#l3.23"></a><span id="l3.23">   case LDAP_PARAM_ERROR:</span>
<a href="#l3.24"></a><span id="l3.24">     return NS_ERROR_INVALID_ARG;</span>
<a href="#l3.25"></a><span id="l3.25"> </span>
<a href="#l3.26"></a><span id="l3.26">   case LDAP_FILTER_ERROR:</span>
<a href="#l3.27"></a><span id="l3.27">     return NS_ERROR_LDAP_FILTER_ERROR;</span>
<a href="#l3.28"></a><span id="l3.28"> </span>
<a href="#l3.29"></a><span id="l3.29">   default:</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-    PR_LOG(gLDAPLogModule, PR_LOG_ERROR,</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+    MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Error,</span>
<a href="#l3.32"></a><span id="l3.32">            (&quot;TranslateLDAPErrorToNSError: &quot;</span>
<a href="#l3.33"></a><span id="l3.33">             &quot;Do not know how to translate LDAP error: 0x%x&quot;, ldapError));</span>
<a href="#l3.34"></a><span id="l3.34">     return NS_ERROR_UNEXPECTED;</span>
<a href="#l3.35"></a><span id="l3.35">   }</span>
<a href="#l3.36"></a><span id="l3.36"> }</span>
<a href="#l3.37"></a><span id="l3.37"> </span>
<a href="#l3.38"></a><span id="l3.38"> </span>
<a href="#l3.39"></a><span id="l3.39"> // constructor</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineat">@@ -274,17 +275,17 @@ nsLDAPOperation::SimpleBind(const nsACSt</span>
<a href="#l3.41"></a><span id="l3.41">       mSavePassword = passwd;</span>
<a href="#l3.42"></a><span id="l3.42"> </span>
<a href="#l3.43"></a><span id="l3.43">     NS_PRECONDITION(mMessageListener != 0, &quot;MessageListener not set&quot;);</span>
<a href="#l3.44"></a><span id="l3.44"> </span>
<a href="#l3.45"></a><span id="l3.45">     rv = connection-&gt;GetBindName(bindName);</span>
<a href="#l3.46"></a><span id="l3.46">     if (NS_FAILED(rv))</span>
<a href="#l3.47"></a><span id="l3.47">         return rv;</span>
<a href="#l3.48"></a><span id="l3.48"> </span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-    PR_LOG(gLDAPLogModule, PR_LOG_DEBUG,</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+    MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l3.51"></a><span id="l3.51">            (&quot;nsLDAPOperation::SimpleBind(): called; bindName = '%s'; &quot;,</span>
<a href="#l3.52"></a><span id="l3.52">             bindName.get()));</span>
<a href="#l3.53"></a><span id="l3.53"> </span>
<a href="#l3.54"></a><span id="l3.54">     // this (nsLDAPOperation) may be released by RemovePendingOperation()</span>
<a href="#l3.55"></a><span id="l3.55">     // See https://bugzilla.mozilla.org/show_bug.cgi?id=1063829.</span>
<a href="#l3.56"></a><span id="l3.56">     nsRefPtr&lt;nsLDAPOperation&gt; kungFuDeathGrip = this;</span>
<a href="#l3.57"></a><span id="l3.57"> </span>
<a href="#l3.58"></a><span id="l3.58">     // If this is a second try at binding, remove the operation from pending ops</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineat">@@ -407,40 +408,40 @@ nsLDAPOperation::SearchExt(const nsACStr</span>
<a href="#l3.60"></a><span id="l3.60">                            PRIntervalTime aTimeOut, int32_t aSizeLimit)</span>
<a href="#l3.61"></a><span id="l3.61"> {</span>
<a href="#l3.62"></a><span id="l3.62">     if (!mMessageListener) {</span>
<a href="#l3.63"></a><span id="l3.63">         NS_ERROR(&quot;nsLDAPOperation::SearchExt(): mMessageListener not set&quot;);</span>
<a href="#l3.64"></a><span id="l3.64">         return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l3.65"></a><span id="l3.65">     }</span>
<a href="#l3.66"></a><span id="l3.66"> </span>
<a href="#l3.67"></a><span id="l3.67">     // XXX add control logging</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineminus">-    PR_LOG(gLDAPLogModule, PR_LOG_DEBUG,</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+    MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l3.70"></a><span id="l3.70">            (&quot;nsLDAPOperation::SearchExt(): called with aBaseDn = '%s'; &quot;</span>
<a href="#l3.71"></a><span id="l3.71">             &quot;aFilter = '%s'; aAttributes = %s; aSizeLimit = %d&quot;,</span>
<a href="#l3.72"></a><span id="l3.72">             PromiseFlatCString(aBaseDn).get(),</span>
<a href="#l3.73"></a><span id="l3.73">             PromiseFlatCString(aFilter).get(),</span>
<a href="#l3.74"></a><span id="l3.74">             PromiseFlatCString(aAttributes).get(), aSizeLimit));</span>
<a href="#l3.75"></a><span id="l3.75"> </span>
<a href="#l3.76"></a><span id="l3.76">     LDAPControl **serverctls = 0;</span>
<a href="#l3.77"></a><span id="l3.77">     nsresult rv;</span>
<a href="#l3.78"></a><span id="l3.78">     if (mServerControls) {</span>
<a href="#l3.79"></a><span id="l3.79">         rv = convertControlArray(mServerControls, &amp;serverctls);</span>
<a href="#l3.80"></a><span id="l3.80">         if (NS_FAILED(rv)) {</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-            PR_LOG(gLDAPLogModule, PR_LOG_ERROR,</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+            MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Error,</span>
<a href="#l3.83"></a><span id="l3.83">                    (&quot;nsLDAPOperation::SearchExt(): error converting server &quot;</span>
<a href="#l3.84"></a><span id="l3.84">                     &quot;control array: %x&quot;, rv));</span>
<a href="#l3.85"></a><span id="l3.85">             return rv;</span>
<a href="#l3.86"></a><span id="l3.86">         }</span>
<a href="#l3.87"></a><span id="l3.87">     }</span>
<a href="#l3.88"></a><span id="l3.88"> </span>
<a href="#l3.89"></a><span id="l3.89">     LDAPControl **clientctls = 0;</span>
<a href="#l3.90"></a><span id="l3.90">     if (mClientControls) {</span>
<a href="#l3.91"></a><span id="l3.91">         rv = convertControlArray(mClientControls, &amp;clientctls);</span>
<a href="#l3.92"></a><span id="l3.92">         if (NS_FAILED(rv)) {</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineminus">-            PR_LOG(gLDAPLogModule, PR_LOG_ERROR,</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+            MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Error,</span>
<a href="#l3.95"></a><span id="l3.95">                    (&quot;nsLDAPOperation::SearchExt(): error converting client &quot;</span>
<a href="#l3.96"></a><span id="l3.96">                     &quot;control array: %x&quot;, rv));</span>
<a href="#l3.97"></a><span id="l3.97">             ldap_controls_free(serverctls);</span>
<a href="#l3.98"></a><span id="l3.98">             return rv;</span>
<a href="#l3.99"></a><span id="l3.99">         }</span>
<a href="#l3.100"></a><span id="l3.100">     }</span>
<a href="#l3.101"></a><span id="l3.101"> </span>
<a href="#l3.102"></a><span id="l3.102">     // Convert our comma separated string to one that the C-SDK will like, i.e.</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineat">@@ -676,31 +677,31 @@ nsLDAPOperation::AddExt(const char *base</span>
<a href="#l3.104"></a><span id="l3.104">  *</span>
<a href="#l3.105"></a><span id="l3.105">  * void addExt (in AUTF8String aBaseDn, in unsigned long aModCount,</span>
<a href="#l3.106"></a><span id="l3.106">  *              [array, size_is (aModCount)] in nsILDAPModification aMods);</span>
<a href="#l3.107"></a><span id="l3.107">  */</span>
<a href="#l3.108"></a><span id="l3.108"> NS_IMETHODIMP</span>
<a href="#l3.109"></a><span id="l3.109"> nsLDAPOperation::AddExt(const nsACString&amp; aBaseDn,</span>
<a href="#l3.110"></a><span id="l3.110">                         nsIArray *aMods)</span>
<a href="#l3.111"></a><span id="l3.111"> {</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineminus">-  PR_LOG(gLDAPLogModule, PR_LOG_DEBUG,</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+  MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l3.114"></a><span id="l3.114">          (&quot;nsLDAPOperation::AddExt(): called with aBaseDn = '%s'&quot;,</span>
<a href="#l3.115"></a><span id="l3.115">           PromiseFlatCString(aBaseDn).get()));</span>
<a href="#l3.116"></a><span id="l3.116"> </span>
<a href="#l3.117"></a><span id="l3.117">   nsresult rv = AddExt(PromiseFlatCString(aBaseDn).get(), aMods, 0, 0);</span>
<a href="#l3.118"></a><span id="l3.118">   if (NS_FAILED(rv))</span>
<a href="#l3.119"></a><span id="l3.119">     return rv;</span>
<a href="#l3.120"></a><span id="l3.120"> </span>
<a href="#l3.121"></a><span id="l3.121">   // make sure the connection knows where to call back once the messages</span>
<a href="#l3.122"></a><span id="l3.122">   // for this operation start coming in</span>
<a href="#l3.123"></a><span id="l3.123">   rv = mConnection-&gt;AddPendingOperation(mMsgID, this);</span>
<a href="#l3.124"></a><span id="l3.124"> </span>
<a href="#l3.125"></a><span id="l3.125">   if (NS_FAILED(rv)) {</span>
<a href="#l3.126"></a><span id="l3.126">     (void)ldap_abandon_ext(mConnectionHandle, mMsgID, 0, 0);</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineminus">-    PR_LOG(gLDAPLogModule, PR_LOG_DEBUG,</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineplus">+    MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l3.129"></a><span id="l3.129">            (&quot;nsLDAPOperation::AddExt(): abandoned due to rv %x&quot;,</span>
<a href="#l3.130"></a><span id="l3.130">             rv));</span>
<a href="#l3.131"></a><span id="l3.131">   }</span>
<a href="#l3.132"></a><span id="l3.132">   return rv;</span>
<a href="#l3.133"></a><span id="l3.133"> }</span>
<a href="#l3.134"></a><span id="l3.134"> </span>
<a href="#l3.135"></a><span id="l3.135"> // wrappers for ldap_delete_ext</span>
<a href="#l3.136"></a><span id="l3.136"> //</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineat">@@ -726,31 +727,31 @@ nsLDAPOperation::DeleteExt(const char *b</span>
<a href="#l3.138"></a><span id="l3.138">  *</span>
<a href="#l3.139"></a><span id="l3.139">  * XXX doesn't currently handle LDAPControl params</span>
<a href="#l3.140"></a><span id="l3.140">  *</span>
<a href="#l3.141"></a><span id="l3.141">  * void deleteExt(in AUTF8String aBaseDn);</span>
<a href="#l3.142"></a><span id="l3.142">  */</span>
<a href="#l3.143"></a><span id="l3.143"> NS_IMETHODIMP</span>
<a href="#l3.144"></a><span id="l3.144"> nsLDAPOperation::DeleteExt(const nsACString&amp; aBaseDn)</span>
<a href="#l3.145"></a><span id="l3.145"> {</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineminus">-  PR_LOG(gLDAPLogModule, PR_LOG_DEBUG,</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineplus">+  MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l3.148"></a><span id="l3.148">          (&quot;nsLDAPOperation::DeleteExt(): called with aBaseDn = '%s'&quot;,</span>
<a href="#l3.149"></a><span id="l3.149">           PromiseFlatCString(aBaseDn).get()));</span>
<a href="#l3.150"></a><span id="l3.150"> </span>
<a href="#l3.151"></a><span id="l3.151">   nsresult rv = DeleteExt(PromiseFlatCString(aBaseDn).get(), 0, 0);</span>
<a href="#l3.152"></a><span id="l3.152">   if (NS_FAILED(rv))</span>
<a href="#l3.153"></a><span id="l3.153">     return rv;</span>
<a href="#l3.154"></a><span id="l3.154"> </span>
<a href="#l3.155"></a><span id="l3.155">   // make sure the connection knows where to call back once the messages</span>
<a href="#l3.156"></a><span id="l3.156">   // for this operation start coming in</span>
<a href="#l3.157"></a><span id="l3.157">   rv = mConnection-&gt;AddPendingOperation(mMsgID, this);</span>
<a href="#l3.158"></a><span id="l3.158"> </span>
<a href="#l3.159"></a><span id="l3.159">   if (NS_FAILED(rv)) {</span>
<a href="#l3.160"></a><span id="l3.160">     (void)ldap_abandon_ext(mConnectionHandle, mMsgID, 0, 0);</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineminus">-    PR_LOG(gLDAPLogModule, PR_LOG_DEBUG,</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineplus">+    MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l3.163"></a><span id="l3.163">            (&quot;nsLDAPOperation::AddExt(): abandoned due to rv %x&quot;,</span>
<a href="#l3.164"></a><span id="l3.164">             rv));</span>
<a href="#l3.165"></a><span id="l3.165">   }</span>
<a href="#l3.166"></a><span id="l3.166">   return rv;</span>
<a href="#l3.167"></a><span id="l3.167"> }</span>
<a href="#l3.168"></a><span id="l3.168"> </span>
<a href="#l3.169"></a><span id="l3.169"> // wrappers for ldap_modify_ext</span>
<a href="#l3.170"></a><span id="l3.170"> //</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineat">@@ -838,32 +839,32 @@ nsLDAPOperation::ModifyExt(const char *b</span>
<a href="#l3.172"></a><span id="l3.172">  *</span>
<a href="#l3.173"></a><span id="l3.173">  * void modifyExt (in AUTF8String aBaseDn, in unsigned long aModCount,</span>
<a href="#l3.174"></a><span id="l3.174">  *                 [array, size_is (aModCount)] in nsILDAPModification aMods);</span>
<a href="#l3.175"></a><span id="l3.175">  */</span>
<a href="#l3.176"></a><span id="l3.176"> NS_IMETHODIMP</span>
<a href="#l3.177"></a><span id="l3.177"> nsLDAPOperation::ModifyExt(const nsACString&amp; aBaseDn,</span>
<a href="#l3.178"></a><span id="l3.178">                            nsIArray *aMods)</span>
<a href="#l3.179"></a><span id="l3.179"> {</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineminus">-  PR_LOG(gLDAPLogModule, PR_LOG_DEBUG,</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineplus">+  MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l3.182"></a><span id="l3.182">          (&quot;nsLDAPOperation::ModifyExt(): called with aBaseDn = '%s'&quot;,</span>
<a href="#l3.183"></a><span id="l3.183">           PromiseFlatCString(aBaseDn).get()));</span>
<a href="#l3.184"></a><span id="l3.184"> </span>
<a href="#l3.185"></a><span id="l3.185">   nsresult rv = ModifyExt(PromiseFlatCString(aBaseDn).get(),</span>
<a href="#l3.186"></a><span id="l3.186">                           aMods, 0, 0);</span>
<a href="#l3.187"></a><span id="l3.187">   if (NS_FAILED(rv))</span>
<a href="#l3.188"></a><span id="l3.188">     return rv;</span>
<a href="#l3.189"></a><span id="l3.189"> </span>
<a href="#l3.190"></a><span id="l3.190">   // make sure the connection knows where to call back once the messages</span>
<a href="#l3.191"></a><span id="l3.191">   // for this operation start coming in</span>
<a href="#l3.192"></a><span id="l3.192">   rv = mConnection-&gt;AddPendingOperation(mMsgID, this);</span>
<a href="#l3.193"></a><span id="l3.193"> </span>
<a href="#l3.194"></a><span id="l3.194">   if (NS_FAILED(rv)) {</span>
<a href="#l3.195"></a><span id="l3.195">     (void)ldap_abandon_ext(mConnectionHandle, mMsgID, 0, 0);</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineminus">-    PR_LOG(gLDAPLogModule, PR_LOG_DEBUG,</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineplus">+    MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l3.198"></a><span id="l3.198">            (&quot;nsLDAPOperation::AddExt(): abandoned due to rv %x&quot;,</span>
<a href="#l3.199"></a><span id="l3.199">             rv));</span>
<a href="#l3.200"></a><span id="l3.200">   }</span>
<a href="#l3.201"></a><span id="l3.201">   return rv;</span>
<a href="#l3.202"></a><span id="l3.202"> }</span>
<a href="#l3.203"></a><span id="l3.203"> </span>
<a href="#l3.204"></a><span id="l3.204"> // wrappers for ldap_rename</span>
<a href="#l3.205"></a><span id="l3.205"> //</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineat">@@ -899,34 +900,34 @@ nsLDAPOperation::Rename(const char *base</span>
<a href="#l3.207"></a><span id="l3.207">  *             in AUTF8String aNewParent, in boolean aDeleteOldRDn);</span>
<a href="#l3.208"></a><span id="l3.208">  */</span>
<a href="#l3.209"></a><span id="l3.209"> NS_IMETHODIMP</span>
<a href="#l3.210"></a><span id="l3.210"> nsLDAPOperation::Rename(const nsACString&amp; aBaseDn,</span>
<a href="#l3.211"></a><span id="l3.211">                         const nsACString&amp; aNewRDn,</span>
<a href="#l3.212"></a><span id="l3.212">                         const nsACString&amp; aNewParent,</span>
<a href="#l3.213"></a><span id="l3.213">                         bool aDeleteOldRDn)</span>
<a href="#l3.214"></a><span id="l3.214"> {</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineminus">-  PR_LOG(gLDAPLogModule, PR_LOG_DEBUG,</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineplus">+  MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l3.217"></a><span id="l3.217">          (&quot;nsLDAPOperation::Rename(): called with aBaseDn = '%s'&quot;,</span>
<a href="#l3.218"></a><span id="l3.218">           PromiseFlatCString(aBaseDn).get()));</span>
<a href="#l3.219"></a><span id="l3.219"> </span>
<a href="#l3.220"></a><span id="l3.220">   nsresult rv = Rename(PromiseFlatCString(aBaseDn).get(),</span>
<a href="#l3.221"></a><span id="l3.221">                        PromiseFlatCString(aNewRDn).get(),</span>
<a href="#l3.222"></a><span id="l3.222">                        PromiseFlatCString(aNewParent).get(),</span>
<a href="#l3.223"></a><span id="l3.223">                        aDeleteOldRDn, 0, 0);</span>
<a href="#l3.224"></a><span id="l3.224">   if (NS_FAILED(rv))</span>
<a href="#l3.225"></a><span id="l3.225">     return rv;</span>
<a href="#l3.226"></a><span id="l3.226"> </span>
<a href="#l3.227"></a><span id="l3.227">   // make sure the connection knows where to call back once the messages</span>
<a href="#l3.228"></a><span id="l3.228">   // for this operation start coming in</span>
<a href="#l3.229"></a><span id="l3.229">   rv = mConnection-&gt;AddPendingOperation(mMsgID, this);</span>
<a href="#l3.230"></a><span id="l3.230"> </span>
<a href="#l3.231"></a><span id="l3.231">   if (NS_FAILED(rv)) {</span>
<a href="#l3.232"></a><span id="l3.232">     (void)ldap_abandon_ext(mConnectionHandle, mMsgID, 0, 0);</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineminus">-    PR_LOG(gLDAPLogModule, PR_LOG_DEBUG,</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineplus">+    MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l3.235"></a><span id="l3.235">            (&quot;nsLDAPOperation::AddExt(): abandoned due to rv %x&quot;,</span>
<a href="#l3.236"></a><span id="l3.236">             rv));</span>
<a href="#l3.237"></a><span id="l3.237">   }</span>
<a href="#l3.238"></a><span id="l3.238">   return rv;</span>
<a href="#l3.239"></a><span id="l3.239"> }</span>
<a href="#l3.240"></a><span id="l3.240"> </span>
<a href="#l3.241"></a><span id="l3.241"> // wrappers for ldap_search_ext</span>
<a href="#l3.242"></a><span id="l3.242"> //</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPProtocolModule.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPProtocolModule.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -17,16 +17,17 @@</span>
<a href="#l4.4"></a><span id="l4.4"> #include &quot;nsLDAPService.h&quot;</span>
<a href="#l4.5"></a><span id="l4.5"> #include &quot;nsLDAPBERValue.h&quot;</span>
<a href="#l4.6"></a><span id="l4.6"> #include &quot;nsLDAPBERElement.h&quot;</span>
<a href="#l4.7"></a><span id="l4.7"> #include &quot;nsLDAPControl.h&quot;</span>
<a href="#l4.8"></a><span id="l4.8"> #ifdef MOZ_PREF_EXTENSIONS</span>
<a href="#l4.9"></a><span id="l4.9"> #include &quot;nsLDAPSyncQuery.h&quot;</span>
<a href="#l4.10"></a><span id="l4.10"> #endif</span>
<a href="#l4.11"></a><span id="l4.11"> #include &quot;ldappr.h&quot;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l4.13"></a><span id="l4.13"> </span>
<a href="#l4.14"></a><span id="l4.14"> // use the default constructor</span>
<a href="#l4.15"></a><span id="l4.15"> //</span>
<a href="#l4.16"></a><span id="l4.16"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsLDAPConnection)</span>
<a href="#l4.17"></a><span id="l4.17"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsLDAPOperation)</span>
<a href="#l4.18"></a><span id="l4.18"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsLDAPMessage)</span>
<a href="#l4.19"></a><span id="l4.19"> NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsLDAPModification, Init)</span>
<a href="#l4.20"></a><span id="l4.20"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsLDAPServer)</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineat">@@ -103,29 +104,29 @@ nsLDAPInitialize()</span>
<a href="#l4.22"></a><span id="l4.22">     }</span>
<a href="#l4.23"></a><span id="l4.23"> #endif</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25">     // use NSPR under the hood for all networking</span>
<a href="#l4.26"></a><span id="l4.26">     //</span>
<a href="#l4.27"></a><span id="l4.27">     int rv = prldap_install_routines( NULL, 1 /* shared */ );</span>
<a href="#l4.28"></a><span id="l4.28"> </span>
<a href="#l4.29"></a><span id="l4.29">     if (rv != LDAP_SUCCESS) {</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-        PR_LOG(gLDAPLogModule, PR_LOG_ERROR,</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+        MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Error,</span>
<a href="#l4.32"></a><span id="l4.32">                (&quot;nsLDAPInitialize(): pr_ldap_install_routines() failed: %s\n&quot;,</span>
<a href="#l4.33"></a><span id="l4.33">                ldap_err2string(rv)));</span>
<a href="#l4.34"></a><span id="l4.34">         return NS_ERROR_FAILURE;</span>
<a href="#l4.35"></a><span id="l4.35">     }</span>
<a href="#l4.36"></a><span id="l4.36"> </span>
<a href="#l4.37"></a><span id="l4.37">     // Never block for more than 10000 milliseconds (ie 10 seconds) doing any </span>
<a href="#l4.38"></a><span id="l4.38">     // sort of I/O operation.</span>
<a href="#l4.39"></a><span id="l4.39">     //</span>
<a href="#l4.40"></a><span id="l4.40">     rv = prldap_set_session_option(0, 0, PRLDAP_OPT_IO_MAX_TIMEOUT, </span>
<a href="#l4.41"></a><span id="l4.41">                                    10000);</span>
<a href="#l4.42"></a><span id="l4.42">     if (rv != LDAP_SUCCESS) {</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineminus">-        PR_LOG(gLDAPLogModule, PR_LOG_ERROR,</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+        MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Error,</span>
<a href="#l4.45"></a><span id="l4.45">                (&quot;nsLDAPInitialize(): error setting PRLDAP_OPT_IO_MAX_TIMEOUT:&quot;</span>
<a href="#l4.46"></a><span id="l4.46">                 &quot; %s\n&quot;, ldap_err2string(rv)));</span>
<a href="#l4.47"></a><span id="l4.47">         return NS_ERROR_FAILURE;</span>
<a href="#l4.48"></a><span id="l4.48">     }</span>
<a href="#l4.49"></a><span id="l4.49"> </span>
<a href="#l4.50"></a><span id="l4.50">     return NS_OK;</span>
<a href="#l4.51"></a><span id="l4.51"> }</span>
<a href="#l4.52"></a><span id="l4.52"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPService.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPService.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -10,16 +10,17 @@</span>
<a href="#l5.4"></a><span id="l5.4"> #include &quot;nsLDAPOperation.h&quot;</span>
<a href="#l5.5"></a><span id="l5.5"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l5.6"></a><span id="l5.6"> #include &quot;nsIConsoleService.h&quot;</span>
<a href="#l5.7"></a><span id="l5.7"> #include &quot;nsILDAPURL.h&quot;</span>
<a href="#l5.8"></a><span id="l5.8"> #include &quot;nsMemory.h&quot;</span>
<a href="#l5.9"></a><span id="l5.9"> #include &quot;nsILDAPErrors.h&quot;</span>
<a href="#l5.10"></a><span id="l5.10"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l5.11"></a><span id="l5.11"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l5.13"></a><span id="l5.13"> </span>
<a href="#l5.14"></a><span id="l5.14"> using namespace mozilla;</span>
<a href="#l5.15"></a><span id="l5.15"> </span>
<a href="#l5.16"></a><span id="l5.16"> // Constants for CIDs used here.</span>
<a href="#l5.17"></a><span id="l5.17"> //</span>
<a href="#l5.18"></a><span id="l5.18"> static NS_DEFINE_CID(kLDAPConnectionCID, NS_LDAPCONNECTION_CID);</span>
<a href="#l5.19"></a><span id="l5.19"> static NS_DEFINE_CID(kLDAPOperationCID, NS_LDAPOPERATION_CID);</span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21" class="difflineat">@@ -793,17 +794,17 @@ NS_IMETHODIMP nsLDAPService::CreateFilte</span>
<a href="#l5.22"></a><span id="l5.22">                    const_cast&lt;char *&gt;(PromiseFlatCString(aValue).get()),</span>
<a href="#l5.23"></a><span id="l5.23">                    valueWords);</span>
<a href="#l5.24"></a><span id="l5.24">     switch (result) {</span>
<a href="#l5.25"></a><span id="l5.25">     case LDAP_SUCCESS:</span>
<a href="#l5.26"></a><span id="l5.26">         rv = NS_OK;</span>
<a href="#l5.27"></a><span id="l5.27">         break;</span>
<a href="#l5.28"></a><span id="l5.28"> </span>
<a href="#l5.29"></a><span id="l5.29">     case LDAP_SIZELIMIT_EXCEEDED:</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-        PR_LOG(gLDAPLogModule, PR_LOG_DEBUG, </span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+        MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Debug, </span>
<a href="#l5.32"></a><span id="l5.32">                    (&quot;nsLDAPService::CreateFilter(): &quot;</span>
<a href="#l5.33"></a><span id="l5.33">                     &quot;filter longer than max size of %d generated&quot;, </span>
<a href="#l5.34"></a><span id="l5.34">                     aMaxSize));</span>
<a href="#l5.35"></a><span id="l5.35">         rv = NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l5.36"></a><span id="l5.36">         break;</span>
<a href="#l5.37"></a><span id="l5.37"> </span>
<a href="#l5.38"></a><span id="l5.38">     case LDAP_PARAM_ERROR:</span>
<a href="#l5.39"></a><span id="l5.39">         rv = NS_ERROR_INVALID_ARG;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOutlookDirFactory.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOutlookDirFactory.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -7,25 +7,24 @@</span>
<a href="#l6.4"></a><span id="l6.4"> #include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l6.5"></a><span id="l6.5"> #include &quot;nsIAbManager.h&quot;</span>
<a href="#l6.6"></a><span id="l6.6"> #include &quot;nsEnumeratorUtils.h&quot;</span>
<a href="#l6.7"></a><span id="l6.7"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l6.8"></a><span id="l6.8"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l6.9"></a><span id="l6.9"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l6.10"></a><span id="l6.10"> #include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l6.11"></a><span id="l6.11"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-#include &quot;prlog.h&quot;</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l6.15"></a><span id="l6.15"> </span>
<a href="#l6.16"></a><span id="l6.16"> #ifdef PR_LOGGING</span>
<a href="#l6.17"></a><span id="l6.17"> static PRLogModuleInfo* gAbOutlookDirFactoryLog</span>
<a href="#l6.18"></a><span id="l6.18">     = PR_NewLogModule(&quot;nsAbOutlookDirFactoryLog&quot;);</span>
<a href="#l6.19"></a><span id="l6.19"> #endif</span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-#define PRINTF(args) PR_LOG(nsAbOutlookDirFactoryLog, PR_LOG_DEBUG, args)</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+#define PRINTF(args) MOZ_LOG(nsAbOutlookDirFactoryLog, mozilla::LogLevel::Debug, args)</span>
<a href="#l6.23"></a><span id="l6.23"> </span>
<a href="#l6.24"></a><span id="l6.24"> </span>
<a href="#l6.25"></a><span id="l6.25"> NS_IMPL_ISUPPORTS(nsAbOutlookDirFactory, nsIAbDirFactory)</span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27"> nsAbOutlookDirFactory::nsAbOutlookDirFactory(void)</span>
<a href="#l6.28"></a><span id="l6.28"> {</span>
<a href="#l6.29"></a><span id="l6.29"> }</span>
<a href="#l6.30"></a><span id="l6.30"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOutlookDirectory.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOutlookDirectory.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -12,31 +12,31 @@</span>
<a href="#l7.4"></a><span id="l7.4"> #include &quot;nsIAbBooleanExpression.h&quot;</span>
<a href="#l7.5"></a><span id="l7.5"> #include &quot;nsIAbManager.h&quot;</span>
<a href="#l7.6"></a><span id="l7.6"> #include &quot;nsIAbMDBDirectory.h&quot;</span>
<a href="#l7.7"></a><span id="l7.7"> #include &quot;nsAbQueryStringToExpression.h&quot;</span>
<a href="#l7.8"></a><span id="l7.8"> #include &quot;nsAbUtils.h&quot;</span>
<a href="#l7.9"></a><span id="l7.9"> #include &quot;nsEnumeratorUtils.h&quot;</span>
<a href="#l7.10"></a><span id="l7.10"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l7.11"></a><span id="l7.11"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-#include &quot;prlog.h&quot;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l7.14"></a><span id="l7.14"> #include &quot;prthread.h&quot;</span>
<a href="#l7.15"></a><span id="l7.15"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l7.16"></a><span id="l7.16"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l7.17"></a><span id="l7.17"> #include &quot;nsCRTGlue.h&quot;</span>
<a href="#l7.18"></a><span id="l7.18"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l7.19"></a><span id="l7.19"> #include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l7.20"></a><span id="l7.20"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l7.21"></a><span id="l7.21"> </span>
<a href="#l7.22"></a><span id="l7.22"> #ifdef PR_LOGGING</span>
<a href="#l7.23"></a><span id="l7.23"> static PRLogModuleInfo* gAbOutlookDirectoryLog</span>
<a href="#l7.24"></a><span id="l7.24">     = PR_NewLogModule(&quot;nsAbOutlookDirectoryLog&quot;);</span>
<a href="#l7.25"></a><span id="l7.25"> #endif</span>
<a href="#l7.26"></a><span id="l7.26"> </span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-#define PRINTF(args) PR_LOG(gAbOutlookDirectoryLog, PR_LOG_DEBUG, args)</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+#define PRINTF(args) MOZ_LOG(gAbOutlookDirectoryLog, mozilla::LogLevel::Debug, args)</span>
<a href="#l7.29"></a><span id="l7.29"> </span>
<a href="#l7.30"></a><span id="l7.30"> nsAbOutlookDirectory::nsAbOutlookDirectory(void)</span>
<a href="#l7.31"></a><span id="l7.31">   : nsAbDirProperty(),</span>
<a href="#l7.32"></a><span id="l7.32">   mCurrentQueryId(0), mSearchContext(-1),</span>
<a href="#l7.33"></a><span id="l7.33">   mAbWinType(nsAbWinType_Unknown), mMapiData(nullptr)</span>
<a href="#l7.34"></a><span id="l7.34"> {</span>
<a href="#l7.35"></a><span id="l7.35">     mMapiData = new nsMapiEntry ;</span>
<a href="#l7.36"></a><span id="l7.36">     mProtector = PR_NewLock() ;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbWinHelper.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbWinHelper.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -10,24 +10,24 @@</span>
<a href="#l8.4"></a><span id="l8.4"> #define USES_IID_IDistList</span>
<a href="#l8.5"></a><span id="l8.5"> </span>
<a href="#l8.6"></a><span id="l8.6"> #include &quot;nsAbWinHelper.h&quot;</span>
<a href="#l8.7"></a><span id="l8.7"> #include &quot;nsMapiAddressBook.h&quot;</span>
<a href="#l8.8"></a><span id="l8.8"> #include &quot;nsWabAddressBook.h&quot;</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10"> #include &lt;mapiguid.h&gt;</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-#include &quot;prlog.h&quot;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l8.14"></a><span id="l8.14"> </span>
<a href="#l8.15"></a><span id="l8.15"> #ifdef PR_LOGGING</span>
<a href="#l8.16"></a><span id="l8.16"> static PRLogModuleInfo* gAbWinHelperLog</span>
<a href="#l8.17"></a><span id="l8.17">     = PR_NewLogModule(&quot;nsAbWinHelperLog&quot;);</span>
<a href="#l8.18"></a><span id="l8.18"> #endif</span>
<a href="#l8.19"></a><span id="l8.19"> </span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">-#define PRINTF(args) PR_LOG(gAbWinHelperLog, PR_LOG_DEBUG, args)</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+#define PRINTF(args) MOZ_LOG(gAbWinHelperLog, mozilla::LogLevel::Debug, args)</span>
<a href="#l8.22"></a><span id="l8.22"> </span>
<a href="#l8.23"></a><span id="l8.23"> // Small utility to ensure release of all MAPI interfaces</span>
<a href="#l8.24"></a><span id="l8.24"> template &lt;class tInterface&gt; struct nsMapiInterfaceWrapper</span>
<a href="#l8.25"></a><span id="l8.25"> {</span>
<a href="#l8.26"></a><span id="l8.26">     tInterface mInterface ;</span>
<a href="#l8.27"></a><span id="l8.27"> </span>
<a href="#l8.28"></a><span id="l8.28">     nsMapiInterfaceWrapper(void) : mInterface(NULL) {}</span>
<a href="#l8.29"></a><span id="l8.29">     ~nsMapiInterfaceWrapper(void) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/addrbook/src/nsMapiAddressBook.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsMapiAddressBook.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,22 +1,22 @@</span>
<a href="#l9.4"></a><span id="l9.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l9.5"></a><span id="l9.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.6"></a><span id="l9.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.7"></a><span id="l9.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.8"></a><span id="l9.8"> #include &quot;nsMapiAddressBook.h&quot;</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10" class="difflineminus">-#include &quot;prlog.h&quot;</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l9.12"></a><span id="l9.12"> </span>
<a href="#l9.13"></a><span id="l9.13"> #ifdef PR_LOGGING</span>
<a href="#l9.14"></a><span id="l9.14"> static PRLogModuleInfo* gMapiAddressBookLog</span>
<a href="#l9.15"></a><span id="l9.15">     = PR_NewLogModule(&quot;nsMapiAddressBookLog&quot;);</span>
<a href="#l9.16"></a><span id="l9.16"> #endif</span>
<a href="#l9.17"></a><span id="l9.17"> </span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-#define PRINTF(args) PR_LOG(gMapiAddressBookLog, PR_LOG_DEBUG, args)</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+#define PRINTF(args) MOZ_LOG(gMapiAddressBookLog, mozilla::LogLevel::Debug, args)</span>
<a href="#l9.20"></a><span id="l9.20"> </span>
<a href="#l9.21"></a><span id="l9.21"> using namespace mozilla;</span>
<a href="#l9.22"></a><span id="l9.22"> </span>
<a href="#l9.23"></a><span id="l9.23"> HMODULE nsMapiAddressBook::mLibrary = NULL ;</span>
<a href="#l9.24"></a><span id="l9.24"> int32_t nsMapiAddressBook::mLibUsage = 0 ;</span>
<a href="#l9.25"></a><span id="l9.25"> LPMAPIINITIALIZE nsMapiAddressBook::mMAPIInitialize = NULL ;</span>
<a href="#l9.26"></a><span id="l9.26"> LPMAPIUNINITIALIZE nsMapiAddressBook::mMAPIUninitialize = NULL ;</span>
<a href="#l9.27"></a><span id="l9.27"> LPMAPIALLOCATEBUFFER nsMapiAddressBook::mMAPIAllocateBuffer = NULL ;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/addrbook/src/nsWabAddressBook.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsWabAddressBook.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1,24 +1,24 @@</span>
<a href="#l10.4"></a><span id="l10.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l10.5"></a><span id="l10.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.6"></a><span id="l10.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l10.7"></a><span id="l10.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.8"></a><span id="l10.8"> </span>
<a href="#l10.9"></a><span id="l10.9"> #include &lt;tchar.h&gt;</span>
<a href="#l10.10"></a><span id="l10.10"> #include &quot;nsWabAddressBook.h&quot;</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineminus">-#include &quot;prlog.h&quot;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l10.13"></a><span id="l10.13"> #include &lt;algorithm&gt;</span>
<a href="#l10.14"></a><span id="l10.14"> </span>
<a href="#l10.15"></a><span id="l10.15"> #ifdef PR_LOGGING</span>
<a href="#l10.16"></a><span id="l10.16"> static PRLogModuleInfo* gWabAddressBookLog</span>
<a href="#l10.17"></a><span id="l10.17">     = PR_NewLogModule(&quot;nsWabAddressBookLog&quot;);</span>
<a href="#l10.18"></a><span id="l10.18"> #endif</span>
<a href="#l10.19"></a><span id="l10.19"> </span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-#define PRINTF(args) PR_LOG(gWabAddressBookLog, PR_LOG_DEBUG, args)</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+#define PRINTF(args) MOZ_LOG(gWabAddressBookLog, mozilla::LogLevel::Debug, args)</span>
<a href="#l10.22"></a><span id="l10.22"> </span>
<a href="#l10.23"></a><span id="l10.23"> using namespace mozilla;</span>
<a href="#l10.24"></a><span id="l10.24"> </span>
<a href="#l10.25"></a><span id="l10.25"> HMODULE nsWabAddressBook::mLibrary = NULL ;</span>
<a href="#l10.26"></a><span id="l10.26"> int32_t nsWabAddressBook::mLibUsage = 0 ;</span>
<a href="#l10.27"></a><span id="l10.27"> LPWABOPEN nsWabAddressBook::mWABOpen = NULL ;</span>
<a href="#l10.28"></a><span id="l10.28"> LPWABOBJECT nsWabAddressBook::mRootSession = NULL ;</span>
<a href="#l10.29"></a><span id="l10.29"> LPADRBOOK nsWabAddressBook::mRootBook = NULL ;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/base/src/nsMsgBiffManager.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgBiffManager.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -3,17 +3,17 @@</span>
<a href="#l11.4"></a><span id="l11.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.5"></a><span id="l11.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.6"></a><span id="l11.6"> </span>
<a href="#l11.7"></a><span id="l11.7"> #include &quot;nsMsgBiffManager.h&quot;</span>
<a href="#l11.8"></a><span id="l11.8"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l11.9"></a><span id="l11.9"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l11.10"></a><span id="l11.10"> #include &quot;nsStatusBarBiffManager.h&quot;</span>
<a href="#l11.11"></a><span id="l11.11"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-#include &quot;prlog.h&quot;</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l11.14"></a><span id="l11.14"> #include &quot;nspr.h&quot;</span>
<a href="#l11.15"></a><span id="l11.15"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l11.16"></a><span id="l11.16"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l11.17"></a><span id="l11.17"> #include &quot;nsIObserverService.h&quot;</span>
<a href="#l11.18"></a><span id="l11.18"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l11.19"></a><span id="l11.19"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l11.20"></a><span id="l11.20"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l11.21"></a><span id="l11.21"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineat">@@ -221,17 +221,17 @@ nsresult nsMsgBiffManager::AddBiffEntry(</span>
<a href="#l11.23"></a><span id="l11.23"> {</span>
<a href="#l11.24"></a><span id="l11.24">   uint32_t i;</span>
<a href="#l11.25"></a><span id="l11.25">   uint32_t count = mBiffArray.Length();</span>
<a href="#l11.26"></a><span id="l11.26">   for (i = 0; i &lt; count; i++)</span>
<a href="#l11.27"></a><span id="l11.27">   {</span>
<a href="#l11.28"></a><span id="l11.28">     if (biffEntry.nextBiffTime &lt; mBiffArray[i].nextBiffTime)</span>
<a href="#l11.29"></a><span id="l11.29">       break;</span>
<a href="#l11.30"></a><span id="l11.30">   }</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-  PR_LOG(MsgBiffLogModule, PR_LOG_ALWAYS, (&quot;inserting biff entry at %d\n&quot;, i));</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+  MOZ_LOG(MsgBiffLogModule, mozilla::LogLevel::Info, (&quot;inserting biff entry at %d\n&quot;, i));</span>
<a href="#l11.33"></a><span id="l11.33">   mBiffArray.InsertElementAt(i, biffEntry);</span>
<a href="#l11.34"></a><span id="l11.34">   return NS_OK;</span>
<a href="#l11.35"></a><span id="l11.35"> }</span>
<a href="#l11.36"></a><span id="l11.36"> </span>
<a href="#l11.37"></a><span id="l11.37"> nsresult nsMsgBiffManager::SetNextBiffTime(nsBiffEntry &amp;biffEntry, PRTime currentTime)</span>
<a href="#l11.38"></a><span id="l11.38"> {</span>
<a href="#l11.39"></a><span id="l11.39">   nsIMsgIncomingServer *server = biffEntry.server;</span>
<a href="#l11.40"></a><span id="l11.40">   NS_ENSURE_TRUE(server, NS_ERROR_FAILURE);</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineat">@@ -289,31 +289,31 @@ nsresult nsMsgBiffManager::SetupNextBiff</span>
<a href="#l11.42"></a><span id="l11.42">     int64_t timeInMS = biffDelay / ms;</span>
<a href="#l11.43"></a><span id="l11.43">     uint32_t timeInMSUint32 = (uint32_t)timeInMS;</span>
<a href="#l11.44"></a><span id="l11.44"> </span>
<a href="#l11.45"></a><span id="l11.45">     // Can't currently reset a timer when it's in the process of</span>
<a href="#l11.46"></a><span id="l11.46">     // calling Notify. So, just release the timer here and create a new one.</span>
<a href="#l11.47"></a><span id="l11.47">     if (mBiffTimer)</span>
<a href="#l11.48"></a><span id="l11.48">       mBiffTimer-&gt;Cancel();</span>
<a href="#l11.49"></a><span id="l11.49"> </span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-    PR_LOG(MsgBiffLogModule, PR_LOG_ALWAYS, (&quot;setting %d timer\n&quot;, timeInMSUint32));</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+    MOZ_LOG(MsgBiffLogModule, mozilla::LogLevel::Info, (&quot;setting %d timer\n&quot;, timeInMSUint32));</span>
<a href="#l11.52"></a><span id="l11.52">     mBiffTimer = do_CreateInstance(&quot;@mozilla.org/timer;1&quot;);</span>
<a href="#l11.53"></a><span id="l11.53">     mBiffTimer-&gt;InitWithFuncCallback(OnBiffTimer, (void*)this, timeInMSUint32, </span>
<a href="#l11.54"></a><span id="l11.54">                                      nsITimer::TYPE_ONE_SHOT);</span>
<a href="#l11.55"></a><span id="l11.55"> </span>
<a href="#l11.56"></a><span id="l11.56">   }</span>
<a href="#l11.57"></a><span id="l11.57">   return NS_OK;</span>
<a href="#l11.58"></a><span id="l11.58"> }</span>
<a href="#l11.59"></a><span id="l11.59"> </span>
<a href="#l11.60"></a><span id="l11.60"> //This is the function that does a biff on all of the servers whose time it is to biff.</span>
<a href="#l11.61"></a><span id="l11.61"> nsresult nsMsgBiffManager::PerformBiff()</span>
<a href="#l11.62"></a><span id="l11.62"> {</span>
<a href="#l11.63"></a><span id="l11.63">   PRTime currentTime = PR_Now();</span>
<a href="#l11.64"></a><span id="l11.64">   nsCOMArray&lt;nsIMsgFolder&gt; targetFolders;</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineminus">-  PR_LOG(MsgBiffLogModule, PR_LOG_ALWAYS, (&quot;performing biffs\n&quot;));</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+  MOZ_LOG(MsgBiffLogModule, mozilla::LogLevel::Info, (&quot;performing biffs\n&quot;));</span>
<a href="#l11.67"></a><span id="l11.67"> </span>
<a href="#l11.68"></a><span id="l11.68">   uint32_t count = mBiffArray.Length();</span>
<a href="#l11.69"></a><span id="l11.69">   for (uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l11.70"></a><span id="l11.70">   {</span>
<a href="#l11.71"></a><span id="l11.71">     // Take a copy of the entry rather than the a reference so that we can</span>
<a href="#l11.72"></a><span id="l11.72">     // remove and add if necessary, but keep the references and memory alive.</span>
<a href="#l11.73"></a><span id="l11.73">     nsBiffEntry current = mBiffArray[i];</span>
<a href="#l11.74"></a><span id="l11.74">     if (current.nextBiffTime &lt; currentTime)</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineat">@@ -338,21 +338,21 @@ nsresult nsMsgBiffManager::PerformBiff()</span>
<a href="#l11.76"></a><span id="l11.76">       // new messages</span>
<a href="#l11.77"></a><span id="l11.77">       if (!serverBusy &amp;&amp;</span>
<a href="#l11.78"></a><span id="l11.78">           (!serverRequiresPassword || !passwordPromptRequired) &amp;&amp;</span>
<a href="#l11.79"></a><span id="l11.79">           targetFolderIndex == kNotFound)</span>
<a href="#l11.80"></a><span id="l11.80">       {</span>
<a href="#l11.81"></a><span id="l11.81">         nsCString serverKey;</span>
<a href="#l11.82"></a><span id="l11.82">         current.server-&gt;GetKey(serverKey);</span>
<a href="#l11.83"></a><span id="l11.83">         nsresult rv = current.server-&gt;PerformBiff(nullptr);</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineminus">-        PR_LOG(MsgBiffLogModule, PR_LOG_ALWAYS, (&quot;biffing server %s rv = %x\n&quot;, serverKey.get(), rv));</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineplus">+        MOZ_LOG(MsgBiffLogModule, mozilla::LogLevel::Info, (&quot;biffing server %s rv = %x\n&quot;, serverKey.get(), rv));</span>
<a href="#l11.86"></a><span id="l11.86">       }</span>
<a href="#l11.87"></a><span id="l11.87">       else</span>
<a href="#l11.88"></a><span id="l11.88">       {</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineminus">-        PR_LOG(MsgBiffLogModule, PR_LOG_ALWAYS, (&quot;not biffing server serverBusy = %d requirespassword = %d password prompt required = %d targetFolderIndex = %d\n&quot;,</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+        MOZ_LOG(MsgBiffLogModule, mozilla::LogLevel::Info, (&quot;not biffing server serverBusy = %d requirespassword = %d password prompt required = %d targetFolderIndex = %d\n&quot;,</span>
<a href="#l11.91"></a><span id="l11.91">           serverBusy, serverRequiresPassword, passwordPromptRequired, targetFolderIndex));</span>
<a href="#l11.92"></a><span id="l11.92">       }</span>
<a href="#l11.93"></a><span id="l11.93">       // if we didn't do this server because the destination server was already being</span>
<a href="#l11.94"></a><span id="l11.94">       // biffed into, leave this server in the biff array so it will fire next.</span>
<a href="#l11.95"></a><span id="l11.95">       if (targetFolderIndex == kNotFound)</span>
<a href="#l11.96"></a><span id="l11.96">       {</span>
<a href="#l11.97"></a><span id="l11.97">         mBiffArray.RemoveElementAt(i);</span>
<a href="#l11.98"></a><span id="l11.98">         i--; //Because we removed it we need to look at the one that just moved up.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/base/src/nsMsgCopyService.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgCopyService.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -9,16 +9,17 @@</span>
<a href="#l12.4"></a><span id="l12.4"> #include &quot;nsIFile.h&quot;</span>
<a href="#l12.5"></a><span id="l12.5"> #include &quot;nsIMsgFolderNotificationService.h&quot;</span>
<a href="#l12.6"></a><span id="l12.6"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l12.7"></a><span id="l12.7"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l12.8"></a><span id="l12.8"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l12.9"></a><span id="l12.9"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l12.10"></a><span id="l12.10"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l12.11"></a><span id="l12.11"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l12.13"></a><span id="l12.13"> </span>
<a href="#l12.14"></a><span id="l12.14"> static PRLogModuleInfo *gCopyServiceLog;</span>
<a href="#l12.15"></a><span id="l12.15"> </span>
<a href="#l12.16"></a><span id="l12.16"> // ******************** nsCopySource ******************</span>
<a href="#l12.17"></a><span id="l12.17"> //</span>
<a href="#l12.18"></a><span id="l12.18"> </span>
<a href="#l12.19"></a><span id="l12.19"> nsCopySource::nsCopySource() : m_processed(false)</span>
<a href="#l12.20"></a><span id="l12.20"> {</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineat">@@ -138,45 +139,45 @@ nsMsgCopyService::~nsMsgCopyService()</span>
<a href="#l12.22"></a><span id="l12.22"> </span>
<a href="#l12.23"></a><span id="l12.23"> void nsMsgCopyService::LogCopyCompletion(nsISupports *aSrc, nsIMsgFolder *aDest)</span>
<a href="#l12.24"></a><span id="l12.24"> {</span>
<a href="#l12.25"></a><span id="l12.25">   nsCString srcFolderUri, destFolderUri;</span>
<a href="#l12.26"></a><span id="l12.26">   nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder(do_QueryInterface(aSrc));</span>
<a href="#l12.27"></a><span id="l12.27">   if (srcFolder)</span>
<a href="#l12.28"></a><span id="l12.28">     srcFolder-&gt;GetURI(srcFolderUri);</span>
<a href="#l12.29"></a><span id="l12.29">   aDest-&gt;GetURI(destFolderUri);</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">-  PR_LOG(gCopyServiceLog, PR_LOG_ALWAYS,</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+  MOZ_LOG(gCopyServiceLog, mozilla::LogLevel::Info,</span>
<a href="#l12.32"></a><span id="l12.32">          (&quot;NotifyCompletion - src %s dest %s\n&quot;,</span>
<a href="#l12.33"></a><span id="l12.33">           srcFolderUri.get(), destFolderUri.get()));</span>
<a href="#l12.34"></a><span id="l12.34"> }</span>
<a href="#l12.35"></a><span id="l12.35"> </span>
<a href="#l12.36"></a><span id="l12.36"> void nsMsgCopyService::LogCopyRequest(const char *logMsg, nsCopyRequest* aRequest)</span>
<a href="#l12.37"></a><span id="l12.37"> {</span>
<a href="#l12.38"></a><span id="l12.38">   nsCString srcFolderUri, destFolderUri;</span>
<a href="#l12.39"></a><span id="l12.39">   nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder(do_QueryInterface(aRequest-&gt;m_srcSupport));</span>
<a href="#l12.40"></a><span id="l12.40">   if (srcFolder)</span>
<a href="#l12.41"></a><span id="l12.41">     srcFolder-&gt;GetURI(srcFolderUri);</span>
<a href="#l12.42"></a><span id="l12.42">   aRequest-&gt;m_dstFolder-&gt;GetURI(destFolderUri);</span>
<a href="#l12.43"></a><span id="l12.43">   uint32_t numMsgs = 0;</span>
<a href="#l12.44"></a><span id="l12.44">   if (aRequest-&gt;m_requestType == nsCopyMessagesType &amp;&amp;</span>
<a href="#l12.45"></a><span id="l12.45">       aRequest-&gt;m_copySourceArray.Length() &gt; 0 &amp;&amp;</span>
<a href="#l12.46"></a><span id="l12.46">       aRequest-&gt;m_copySourceArray[0]-&gt;m_messageArray)</span>
<a href="#l12.47"></a><span id="l12.47">     aRequest-&gt;m_copySourceArray[0]-&gt;m_messageArray-&gt;GetLength(&amp;numMsgs);</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineminus">-  PR_LOG(gCopyServiceLog, PR_LOG_ALWAYS,</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+  MOZ_LOG(gCopyServiceLog, mozilla::LogLevel::Info,</span>
<a href="#l12.50"></a><span id="l12.50">          (&quot;request %lx %s - src %s dest %s numItems %d type=%d&quot;,</span>
<a href="#l12.51"></a><span id="l12.51">          aRequest, logMsg, srcFolderUri.get(),</span>
<a href="#l12.52"></a><span id="l12.52">          destFolderUri.get(), numMsgs, aRequest-&gt;m_requestType));</span>
<a href="#l12.53"></a><span id="l12.53"> }</span>
<a href="#l12.54"></a><span id="l12.54"> </span>
<a href="#l12.55"></a><span id="l12.55"> nsresult</span>
<a href="#l12.56"></a><span id="l12.56"> nsMsgCopyService::ClearRequest(nsCopyRequest* aRequest, nsresult rv)</span>
<a href="#l12.57"></a><span id="l12.57"> {</span>
<a href="#l12.58"></a><span id="l12.58">   if (aRequest)</span>
<a href="#l12.59"></a><span id="l12.59">   {</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineminus">-    if (PR_LOG_TEST(gCopyServiceLog, PR_LOG_ALWAYS))</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+    if (MOZ_LOG_TEST(gCopyServiceLog, mozilla::LogLevel::Info))</span>
<a href="#l12.62"></a><span id="l12.62">       LogCopyRequest(NS_SUCCEEDED(rv) ? &quot;Clearing OK request&quot; </span>
<a href="#l12.63"></a><span id="l12.63">                                       : &quot;Clearing failed request&quot;, aRequest);</span>
<a href="#l12.64"></a><span id="l12.64"> </span>
<a href="#l12.65"></a><span id="l12.65">     // Send notifications to nsIMsgFolderListeners</span>
<a href="#l12.66"></a><span id="l12.66">     if (NS_SUCCEEDED(rv) &amp;&amp; aRequest-&gt;m_requestType == nsCopyFoldersType)</span>
<a href="#l12.67"></a><span id="l12.67">     {</span>
<a href="#l12.68"></a><span id="l12.68">       nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l12.69"></a><span id="l12.69">       if (notifier)</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineat">@@ -247,17 +248,17 @@ nsMsgCopyService::QueueRequest(nsCopyReq</span>
<a href="#l12.71"></a><span id="l12.71"> </span>
<a href="#l12.72"></a><span id="l12.72"> nsresult</span>
<a href="#l12.73"></a><span id="l12.73"> nsMsgCopyService::DoCopy(nsCopyRequest* aRequest)</span>
<a href="#l12.74"></a><span id="l12.74"> {</span>
<a href="#l12.75"></a><span id="l12.75">   NS_ENSURE_ARG(aRequest);</span>
<a href="#l12.76"></a><span id="l12.76">   bool copyImmediately;</span>
<a href="#l12.77"></a><span id="l12.77">   QueueRequest(aRequest, &amp;copyImmediately);</span>
<a href="#l12.78"></a><span id="l12.78">   m_copyRequests.AppendElement(aRequest);</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineminus">-  if (PR_LOG_TEST(gCopyServiceLog, PR_LOG_ALWAYS))</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+  if (MOZ_LOG_TEST(gCopyServiceLog, mozilla::LogLevel::Info))</span>
<a href="#l12.81"></a><span id="l12.81">     LogCopyRequest(copyImmediately ? &quot;DoCopy&quot; : &quot;QueueRequest&quot;, aRequest);</span>
<a href="#l12.82"></a><span id="l12.82"> </span>
<a href="#l12.83"></a><span id="l12.83">   // if no active request for this dest folder then we can copy immediately</span>
<a href="#l12.84"></a><span id="l12.84">   if (copyImmediately)</span>
<a href="#l12.85"></a><span id="l12.85">     return DoNextCopy();</span>
<a href="#l12.86"></a><span id="l12.86"> </span>
<a href="#l12.87"></a><span id="l12.87">   return NS_OK;</span>
<a href="#l12.88"></a><span id="l12.88"> }</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineat">@@ -434,17 +435,17 @@ nsMsgCopyService::CopyMessages(nsIMsgFol</span>
<a href="#l12.90"></a><span id="l12.90">                                nsIMsgCopyServiceListener* listener,</span>
<a href="#l12.91"></a><span id="l12.91">                                nsIMsgWindow* window,</span>
<a href="#l12.92"></a><span id="l12.92">                                bool allowUndo)</span>
<a href="#l12.93"></a><span id="l12.93"> {</span>
<a href="#l12.94"></a><span id="l12.94">   NS_ENSURE_ARG_POINTER(srcFolder);</span>
<a href="#l12.95"></a><span id="l12.95">   NS_ENSURE_ARG_POINTER(messages);</span>
<a href="#l12.96"></a><span id="l12.96">   NS_ENSURE_ARG_POINTER(dstFolder);</span>
<a href="#l12.97"></a><span id="l12.97"> </span>
<a href="#l12.98"></a><span id="l12.98" class="difflineminus">-  PR_LOG(gCopyServiceLog, PR_LOG_DEBUG, (&quot;CopyMessages&quot;));</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineplus">+  MOZ_LOG(gCopyServiceLog, mozilla::LogLevel::Debug, (&quot;CopyMessages&quot;));</span>
<a href="#l12.100"></a><span id="l12.100"> </span>
<a href="#l12.101"></a><span id="l12.101">   if (srcFolder == dstFolder)</span>
<a href="#l12.102"></a><span id="l12.102">   {</span>
<a href="#l12.103"></a><span id="l12.103">     NS_ERROR(&quot;src and dest folders for msg copy can't be the same&quot;);</span>
<a href="#l12.104"></a><span id="l12.104">     return NS_ERROR_FAILURE;</span>
<a href="#l12.105"></a><span id="l12.105">   }</span>
<a href="#l12.106"></a><span id="l12.106">   nsCopyRequest* copyRequest;</span>
<a href="#l12.107"></a><span id="l12.107">   nsCopySource* copySource = nullptr;</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineat">@@ -479,17 +480,17 @@ nsMsgCopyService::CopyMessages(nsIMsgFol</span>
<a href="#l12.109"></a><span id="l12.109">   aSupport = do_QueryInterface(srcFolder, &amp;rv);</span>
<a href="#l12.110"></a><span id="l12.110"> </span>
<a href="#l12.111"></a><span id="l12.111">   rv = copyRequest-&gt;Init(nsCopyMessagesType, aSupport, dstFolder, isMove,</span>
<a href="#l12.112"></a><span id="l12.112">                         0 /* new msg flags, not used */, EmptyCString(), </span>
<a href="#l12.113"></a><span id="l12.113">                         listener, window, allowUndo);</span>
<a href="#l12.114"></a><span id="l12.114">   if (NS_FAILED(rv))</span>
<a href="#l12.115"></a><span id="l12.115">     goto done;</span>
<a href="#l12.116"></a><span id="l12.116"> </span>
<a href="#l12.117"></a><span id="l12.117" class="difflineminus">-  if (PR_LOG_TEST(gCopyServiceLog, PR_LOG_ALWAYS))</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineplus">+  if (MOZ_LOG_TEST(gCopyServiceLog, mozilla::LogLevel::Info))</span>
<a href="#l12.119"></a><span id="l12.119">     LogCopyRequest(&quot;CopyMessages request&quot;, copyRequest);</span>
<a href="#l12.120"></a><span id="l12.120"> </span>
<a href="#l12.121"></a><span id="l12.121">   // duplicate the message array so we could sort the messages by it's</span>
<a href="#l12.122"></a><span id="l12.122">   // folder easily</span>
<a href="#l12.123"></a><span id="l12.123">   for (uint32_t i = 0; i &lt; cnt; i++)</span>
<a href="#l12.124"></a><span id="l12.124">   {</span>
<a href="#l12.125"></a><span id="l12.125">     nsCOMPtr&lt;nsIMsgDBHdr&gt; currMsg = do_QueryElementAt(messages, i);</span>
<a href="#l12.126"></a><span id="l12.126">     msgArray.AppendObject(currMsg);</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineat">@@ -648,17 +649,17 @@ done:</span>
<a href="#l12.128"></a><span id="l12.128">     return rv;</span>
<a href="#l12.129"></a><span id="l12.129"> }</span>
<a href="#l12.130"></a><span id="l12.130"> </span>
<a href="#l12.131"></a><span id="l12.131"> NS_IMETHODIMP</span>
<a href="#l12.132"></a><span id="l12.132"> nsMsgCopyService::NotifyCompletion(nsISupports* aSupport,</span>
<a href="#l12.133"></a><span id="l12.133">                                    nsIMsgFolder* dstFolder,</span>
<a href="#l12.134"></a><span id="l12.134">                                    nsresult result)</span>
<a href="#l12.135"></a><span id="l12.135"> {</span>
<a href="#l12.136"></a><span id="l12.136" class="difflineminus">-  if (PR_LOG_TEST(gCopyServiceLog, PR_LOG_ALWAYS))</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineplus">+  if (MOZ_LOG_TEST(gCopyServiceLog, mozilla::LogLevel::Info))</span>
<a href="#l12.138"></a><span id="l12.138">     LogCopyCompletion(aSupport, dstFolder);</span>
<a href="#l12.139"></a><span id="l12.139">   nsCopyRequest* copyRequest = nullptr;</span>
<a href="#l12.140"></a><span id="l12.140">   uint32_t numOrigRequests = m_copyRequests.Length();</span>
<a href="#l12.141"></a><span id="l12.141">   do</span>
<a href="#l12.142"></a><span id="l12.142">   {</span>
<a href="#l12.143"></a><span id="l12.143">     // loop for copy requests, because if we do a cross server folder copy,</span>
<a href="#l12.144"></a><span id="l12.144">     // we'll have a copy request for the folder copy, which will in turn</span>
<a href="#l12.145"></a><span id="l12.145">     // generate a copy request for the messages in the folder, which</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/base/src/nsMsgPurgeService.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgPurgeService.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -11,17 +11,17 @@</span>
<a href="#l13.4"></a><span id="l13.4"> #include &quot;msgCore.h&quot;</span>
<a href="#l13.5"></a><span id="l13.5"> #include &quot;nsISpamSettings.h&quot;</span>
<a href="#l13.6"></a><span id="l13.6"> #include &quot;nsIMsgSearchTerm.h&quot;</span>
<a href="#l13.7"></a><span id="l13.7"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l13.8"></a><span id="l13.8"> #include &quot;nsIMsgProtocolInfo.h&quot;</span>
<a href="#l13.9"></a><span id="l13.9"> #include &quot;nsIMsgFilterPlugin.h&quot;</span>
<a href="#l13.10"></a><span id="l13.10"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l13.11"></a><span id="l13.11"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-#include &quot;prlog.h&quot;</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l13.14"></a><span id="l13.14"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l13.15"></a><span id="l13.15"> #include &lt;stdlib.h&gt;</span>
<a href="#l13.16"></a><span id="l13.16"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l13.17"></a><span id="l13.17"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l13.18"></a><span id="l13.18"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l13.19"></a><span id="l13.19"> </span>
<a href="#l13.20"></a><span id="l13.20"> static PRLogModuleInfo *MsgPurgeLogModule = nullptr;</span>
<a href="#l13.21"></a><span id="l13.21"> </span>
<a href="#l13.22"></a><span id="l13.22" class="difflineat">@@ -66,18 +66,18 @@ NS_IMETHODIMP nsMsgPurgeService::Init()</span>
<a href="#l13.23"></a><span id="l13.23">       mMinDelayBetweenPurges = min_delay;</span>
<a href="#l13.24"></a><span id="l13.24"> </span>
<a href="#l13.25"></a><span id="l13.25">     int32_t purge_timer_interval;</span>
<a href="#l13.26"></a><span id="l13.26">     rv = prefBranch-&gt;GetIntPref(&quot;mail.purge.timer_interval&quot;, &amp;purge_timer_interval);</span>
<a href="#l13.27"></a><span id="l13.27">     if (NS_SUCCEEDED(rv) &amp;&amp;  purge_timer_interval)</span>
<a href="#l13.28"></a><span id="l13.28">       mPurgeTimerInterval = purge_timer_interval;</span>
<a href="#l13.29"></a><span id="l13.29">   }</span>
<a href="#l13.30"></a><span id="l13.30"> </span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-  PR_LOG(MsgPurgeLogModule, PR_LOG_ALWAYS, (&quot;mail.purge.min_delay=%d minutes&quot;,mMinDelayBetweenPurges));</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-  PR_LOG(MsgPurgeLogModule, PR_LOG_ALWAYS, (&quot;mail.purge.timer_interval=%d minutes&quot;,mPurgeTimerInterval));</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+  MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;mail.purge.min_delay=%d minutes&quot;,mMinDelayBetweenPurges));</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+  MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;mail.purge.timer_interval=%d minutes&quot;,mPurgeTimerInterval));</span>
<a href="#l13.35"></a><span id="l13.35"> </span>
<a href="#l13.36"></a><span id="l13.36">   // don't start purging right away.</span>
<a href="#l13.37"></a><span id="l13.37">   // because the accounts aren't loaded and because the user might be trying to sign in</span>
<a href="#l13.38"></a><span id="l13.38">   // or startup, etc.</span>
<a href="#l13.39"></a><span id="l13.39">   SetupNextPurge();</span>
<a href="#l13.40"></a><span id="l13.40"> </span>
<a href="#l13.41"></a><span id="l13.41">   mHaveShutdown = false;</span>
<a href="#l13.42"></a><span id="l13.42">   return NS_OK;</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineat">@@ -92,17 +92,17 @@ NS_IMETHODIMP nsMsgPurgeService::Shutdow</span>
<a href="#l13.44"></a><span id="l13.44">   }</span>
<a href="#l13.45"></a><span id="l13.45"> </span>
<a href="#l13.46"></a><span id="l13.46">   mHaveShutdown = true;</span>
<a href="#l13.47"></a><span id="l13.47">   return NS_OK;</span>
<a href="#l13.48"></a><span id="l13.48"> }</span>
<a href="#l13.49"></a><span id="l13.49"> </span>
<a href="#l13.50"></a><span id="l13.50"> nsresult nsMsgPurgeService::SetupNextPurge()</span>
<a href="#l13.51"></a><span id="l13.51"> {</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineminus">-  PR_LOG(MsgPurgeLogModule, PR_LOG_ALWAYS, (&quot;setting to check again in %d minutes&quot;,mPurgeTimerInterval));</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+  MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;setting to check again in %d minutes&quot;,mPurgeTimerInterval));</span>
<a href="#l13.54"></a><span id="l13.54"> </span>
<a href="#l13.55"></a><span id="l13.55">   // Convert mPurgeTimerInterval into milliseconds</span>
<a href="#l13.56"></a><span id="l13.56">   uint32_t timeInMSUint32 = mPurgeTimerInterval * 60000;</span>
<a href="#l13.57"></a><span id="l13.57"> </span>
<a href="#l13.58"></a><span id="l13.58">   // Can't currently reset a timer when it's in the process of</span>
<a href="#l13.59"></a><span id="l13.59">   // calling Notify. So, just release the timer here and create a new one.</span>
<a href="#l13.60"></a><span id="l13.60">   if(mPurgeTimer)</span>
<a href="#l13.61"></a><span id="l13.61">     mPurgeTimer-&gt;Cancel();</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineat">@@ -120,31 +120,31 @@ nsresult nsMsgPurgeService::SetupNextPur</span>
<a href="#l13.63"></a><span id="l13.63"> // However, if we've spent more than .5 seconds in this loop, don't</span>
<a href="#l13.64"></a><span id="l13.64"> // apply any more retention settings because it might lock up the UI.</span>
<a href="#l13.65"></a><span id="l13.65"> // This might starve folders later on in the hierarchy, since we always</span>
<a href="#l13.66"></a><span id="l13.66"> // start at the top, but since we also apply retention settings when you</span>
<a href="#l13.67"></a><span id="l13.67"> // open a folder, or when you compact all folders, I think this will do</span>
<a href="#l13.68"></a><span id="l13.68"> // for now, until we have a cleanup on shutdown architecture.</span>
<a href="#l13.69"></a><span id="l13.69"> nsresult nsMsgPurgeService::PerformPurge()</span>
<a href="#l13.70"></a><span id="l13.70"> {</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineminus">-  PR_LOG(MsgPurgeLogModule, PR_LOG_ALWAYS, (&quot;performing purge&quot;));</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineplus">+  MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;performing purge&quot;));</span>
<a href="#l13.73"></a><span id="l13.73"> </span>
<a href="#l13.74"></a><span id="l13.74">   nsresult rv;</span>
<a href="#l13.75"></a><span id="l13.75"> </span>
<a href="#l13.76"></a><span id="l13.76">   nsCOMPtr &lt;nsIMsgAccountManager&gt; accountManager = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l13.77"></a><span id="l13.77">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l13.78"></a><span id="l13.78">   bool keepApplyingRetentionSettings = true;</span>
<a href="#l13.79"></a><span id="l13.79"> </span>
<a href="#l13.80"></a><span id="l13.80">   nsCOMPtr&lt;nsIArray&gt; allServers;</span>
<a href="#l13.81"></a><span id="l13.81">   rv = accountManager-&gt;GetAllServers(getter_AddRefs(allServers));</span>
<a href="#l13.82"></a><span id="l13.82">   if (NS_SUCCEEDED(rv) &amp;&amp; allServers)</span>
<a href="#l13.83"></a><span id="l13.83">   {</span>
<a href="#l13.84"></a><span id="l13.84">     uint32_t numServers;</span>
<a href="#l13.85"></a><span id="l13.85">     rv = allServers-&gt;GetLength(&amp;numServers);</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineminus">-    PR_LOG(MsgPurgeLogModule, PR_LOG_ALWAYS, (&quot;%d servers&quot;, numServers));</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineplus">+    MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;%d servers&quot;, numServers));</span>
<a href="#l13.88"></a><span id="l13.88">     nsCOMPtr&lt;nsIMsgFolder&gt; folderToPurge;</span>
<a href="#l13.89"></a><span id="l13.89">     PRIntervalTime startTime = PR_IntervalNow();</span>
<a href="#l13.90"></a><span id="l13.90">     int32_t purgeIntervalToUse;</span>
<a href="#l13.91"></a><span id="l13.91">     PRTime oldestPurgeTime = 0; // we're going to pick the least-recently purged folder</span>
<a href="#l13.92"></a><span id="l13.92"> </span>
<a href="#l13.93"></a><span id="l13.93">     // apply retention settings to folders that haven't had retention settings</span>
<a href="#l13.94"></a><span id="l13.94">     // applied in mMinDelayBetweenPurges minutes (default 8 hours)</span>
<a href="#l13.95"></a><span id="l13.95">     // Because we get last purge time from the folder cache,</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineat">@@ -192,27 +192,27 @@ nsresult nsMsgPurgeService::PerformPurge</span>
<a href="#l13.97"></a><span id="l13.97">               if (!curFolderLastPurgeTimeString.IsEmpty())</span>
<a href="#l13.98"></a><span id="l13.98">               {</span>
<a href="#l13.99"></a><span id="l13.99">                 PRTime theTime;</span>
<a href="#l13.100"></a><span id="l13.100">                 PR_ParseTimeString(curFolderLastPurgeTimeString.get(), false, &amp;theTime);</span>
<a href="#l13.101"></a><span id="l13.101">                 curFolderLastPurgeTime = theTime;</span>
<a href="#l13.102"></a><span id="l13.102">               }</span>
<a href="#l13.103"></a><span id="l13.103"> </span>
<a href="#l13.104"></a><span id="l13.104">               childFolder-&gt;GetURI(curFolderUri);</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineminus">-              PR_LOG(MsgPurgeLogModule, PR_LOG_ALWAYS, (&quot;%s curFolderLastPurgeTime=%s (if blank, then never)&quot;, curFolderUri.get(), curFolderLastPurgeTimeString.get()));</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineplus">+              MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;%s curFolderLastPurgeTime=%s (if blank, then never)&quot;, curFolderUri.get(), curFolderLastPurgeTimeString.get()));</span>
<a href="#l13.107"></a><span id="l13.107"> </span>
<a href="#l13.108"></a><span id="l13.108">               // check if this folder is due to purge</span>
<a href="#l13.109"></a><span id="l13.109">               // has to have been purged at least mMinDelayBetweenPurges minutes ago</span>
<a href="#l13.110"></a><span id="l13.110">               // we don't want to purge the folders all the time - once a day is good enough</span>
<a href="#l13.111"></a><span id="l13.111">               int64_t minDelayBetweenPurges(mMinDelayBetweenPurges);</span>
<a href="#l13.112"></a><span id="l13.112">               int64_t microSecondsPerMinute(60000000);</span>
<a href="#l13.113"></a><span id="l13.113">               PRTime nextPurgeTime = curFolderLastPurgeTime + (minDelayBetweenPurges * microSecondsPerMinute);</span>
<a href="#l13.114"></a><span id="l13.114">               if (nextPurgeTime &lt; PR_Now())</span>
<a href="#l13.115"></a><span id="l13.115">               {</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineminus">-                PR_LOG(MsgPurgeLogModule, PR_LOG_ALWAYS, (&quot;purging %s&quot;, curFolderUri.get()));</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineplus">+                MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;purging %s&quot;, curFolderUri.get()));</span>
<a href="#l13.118"></a><span id="l13.118">                 childFolder-&gt;ApplyRetentionSettings();</span>
<a href="#l13.119"></a><span id="l13.119">               }</span>
<a href="#l13.120"></a><span id="l13.120">               PRIntervalTime elapsedTime = PR_IntervalNow() - startTime;</span>
<a href="#l13.121"></a><span id="l13.121">               // check if more than 500 milliseconds have elapsed in this purge process</span>
<a href="#l13.122"></a><span id="l13.122">               if (PR_IntervalToMilliseconds(elapsedTime) &gt; 500)</span>
<a href="#l13.123"></a><span id="l13.123">               {</span>
<a href="#l13.124"></a><span id="l13.124">                 keepApplyingRetentionSettings = false;</span>
<a href="#l13.125"></a><span id="l13.125">                 break;</span>
<a href="#l13.126"></a><span id="l13.126" class="difflineat">@@ -221,122 +221,122 @@ nsresult nsMsgPurgeService::PerformPurge</span>
<a href="#l13.127"></a><span id="l13.127">           }</span>
<a href="#l13.128"></a><span id="l13.128">         }</span>
<a href="#l13.129"></a><span id="l13.129">         nsCString type;</span>
<a href="#l13.130"></a><span id="l13.130">         nsresult rv = server-&gt;GetType(type);</span>
<a href="#l13.131"></a><span id="l13.131">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.132"></a><span id="l13.132"> </span>
<a href="#l13.133"></a><span id="l13.133">         nsCString realHostName;</span>
<a href="#l13.134"></a><span id="l13.134">         server-&gt;GetRealHostName(realHostName);</span>
<a href="#l13.135"></a><span id="l13.135" class="difflineminus">-        PR_LOG(MsgPurgeLogModule, PR_LOG_ALWAYS, (&quot;[%d] %s (%s)&quot;, serverIndex, realHostName.get(), type.get()));</span>
<a href="#l13.136"></a><span id="l13.136" class="difflineplus">+        MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;[%d] %s (%s)&quot;, serverIndex, realHostName.get(), type.get()));</span>
<a href="#l13.137"></a><span id="l13.137"> </span>
<a href="#l13.138"></a><span id="l13.138">         nsCOMPtr &lt;nsISpamSettings&gt; spamSettings;</span>
<a href="#l13.139"></a><span id="l13.139">         rv = server-&gt;GetSpamSettings(getter_AddRefs(spamSettings));</span>
<a href="#l13.140"></a><span id="l13.140">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.141"></a><span id="l13.141"> </span>
<a href="#l13.142"></a><span id="l13.142">         int32_t spamLevel;</span>
<a href="#l13.143"></a><span id="l13.143">         spamSettings-&gt;GetLevel(&amp;spamLevel);</span>
<a href="#l13.144"></a><span id="l13.144" class="difflineminus">-        PR_LOG(MsgPurgeLogModule, PR_LOG_ALWAYS, (&quot;[%d] spamLevel=%d (if 0, don't purge)&quot;, serverIndex, spamLevel));</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineplus">+        MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;[%d] spamLevel=%d (if 0, don't purge)&quot;, serverIndex, spamLevel));</span>
<a href="#l13.146"></a><span id="l13.146">         if (!spamLevel)</span>
<a href="#l13.147"></a><span id="l13.147">           continue;</span>
<a href="#l13.148"></a><span id="l13.148"> </span>
<a href="#l13.149"></a><span id="l13.149">         // check if we are set up to purge for this server</span>
<a href="#l13.150"></a><span id="l13.150">         // if not, skip it.</span>
<a href="#l13.151"></a><span id="l13.151">         bool purgeSpam;</span>
<a href="#l13.152"></a><span id="l13.152">         spamSettings-&gt;GetPurge(&amp;purgeSpam);</span>
<a href="#l13.153"></a><span id="l13.153"> </span>
<a href="#l13.154"></a><span id="l13.154" class="difflineminus">-        PR_LOG(MsgPurgeLogModule, PR_LOG_ALWAYS, (&quot;[%d] purgeSpam=%s (if false, don't purge)&quot;, serverIndex, purgeSpam ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l13.155"></a><span id="l13.155" class="difflineplus">+        MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;[%d] purgeSpam=%s (if false, don't purge)&quot;, serverIndex, purgeSpam ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l13.156"></a><span id="l13.156">         if (!purgeSpam)</span>
<a href="#l13.157"></a><span id="l13.157">           continue;</span>
<a href="#l13.158"></a><span id="l13.158"> </span>
<a href="#l13.159"></a><span id="l13.159">         // check if the spam folder uri is set for this server</span>
<a href="#l13.160"></a><span id="l13.160">         // if not skip it.</span>
<a href="#l13.161"></a><span id="l13.161">         nsCString junkFolderURI;</span>
<a href="#l13.162"></a><span id="l13.162">         rv = spamSettings-&gt;GetSpamFolderURI(getter_Copies(junkFolderURI));</span>
<a href="#l13.163"></a><span id="l13.163">         NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l13.164"></a><span id="l13.164"> </span>
<a href="#l13.165"></a><span id="l13.165" class="difflineminus">-        PR_LOG(MsgPurgeLogModule, PR_LOG_ALWAYS, (&quot;[%d] junkFolderURI=%s (if empty, don't purge)&quot;, serverIndex, junkFolderURI.get()));</span>
<a href="#l13.166"></a><span id="l13.166" class="difflineplus">+        MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;[%d] junkFolderURI=%s (if empty, don't purge)&quot;, serverIndex, junkFolderURI.get()));</span>
<a href="#l13.167"></a><span id="l13.167">         if (junkFolderURI.IsEmpty())</span>
<a href="#l13.168"></a><span id="l13.168">           continue;</span>
<a href="#l13.169"></a><span id="l13.169"> </span>
<a href="#l13.170"></a><span id="l13.170">         // if the junk folder doesn't exist</span>
<a href="#l13.171"></a><span id="l13.171">         // because the folder pane isn't built yet, for example</span>
<a href="#l13.172"></a><span id="l13.172">         // skip this account</span>
<a href="#l13.173"></a><span id="l13.173">         nsCOMPtr&lt;nsIMsgFolder&gt; junkFolder;</span>
<a href="#l13.174"></a><span id="l13.174">         GetExistingFolder(junkFolderURI, getter_AddRefs(junkFolder));</span>
<a href="#l13.175"></a><span id="l13.175"> </span>
<a href="#l13.176"></a><span id="l13.176" class="difflineminus">-        PR_LOG(MsgPurgeLogModule, PR_LOG_ALWAYS, (&quot;[%d] %s exists? %s (if doesn't exist, don't purge)&quot;, serverIndex, junkFolderURI.get(), junkFolder ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l13.177"></a><span id="l13.177" class="difflineplus">+        MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;[%d] %s exists? %s (if doesn't exist, don't purge)&quot;, serverIndex, junkFolderURI.get(), junkFolder ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l13.178"></a><span id="l13.178">         if (!junkFolder)</span>
<a href="#l13.179"></a><span id="l13.179">           continue;</span>
<a href="#l13.180"></a><span id="l13.180"> </span>
<a href="#l13.181"></a><span id="l13.181">         PRTime curJunkFolderLastPurgeTime = 0;</span>
<a href="#l13.182"></a><span id="l13.182">         nsCString curJunkFolderLastPurgeTimeString;</span>
<a href="#l13.183"></a><span id="l13.183">         rv = junkFolder-&gt;GetStringProperty(&quot;curJunkFolderLastPurgeTime&quot;, curJunkFolderLastPurgeTimeString);</span>
<a href="#l13.184"></a><span id="l13.184">         if (NS_FAILED(rv))</span>
<a href="#l13.185"></a><span id="l13.185">           continue; // it is ok to fail, junk folder may not exist</span>
<a href="#l13.186"></a><span id="l13.186"> </span>
<a href="#l13.187"></a><span id="l13.187">         if (!curJunkFolderLastPurgeTimeString.IsEmpty())</span>
<a href="#l13.188"></a><span id="l13.188">         {</span>
<a href="#l13.189"></a><span id="l13.189">           PRTime theTime;</span>
<a href="#l13.190"></a><span id="l13.190">           PR_ParseTimeString(curJunkFolderLastPurgeTimeString.get(), false, &amp;theTime);</span>
<a href="#l13.191"></a><span id="l13.191">           curJunkFolderLastPurgeTime = theTime;</span>
<a href="#l13.192"></a><span id="l13.192">         }</span>
<a href="#l13.193"></a><span id="l13.193"> </span>
<a href="#l13.194"></a><span id="l13.194" class="difflineminus">-        PR_LOG(MsgPurgeLogModule, PR_LOG_ALWAYS, (&quot;[%d] %s curJunkFolderLastPurgeTime=%s (if blank, then never)&quot;, serverIndex, junkFolderURI.get(), curJunkFolderLastPurgeTimeString.get()));</span>
<a href="#l13.195"></a><span id="l13.195" class="difflineplus">+        MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;[%d] %s curJunkFolderLastPurgeTime=%s (if blank, then never)&quot;, serverIndex, junkFolderURI.get(), curJunkFolderLastPurgeTimeString.get()));</span>
<a href="#l13.196"></a><span id="l13.196"> </span>
<a href="#l13.197"></a><span id="l13.197">         // check if this account is due to purge</span>
<a href="#l13.198"></a><span id="l13.198">         // has to have been purged at least mMinDelayBetweenPurges minutes ago</span>
<a href="#l13.199"></a><span id="l13.199">         // we don't want to purge the folders all the time</span>
<a href="#l13.200"></a><span id="l13.200">         PRTime nextPurgeTime = curJunkFolderLastPurgeTime + mMinDelayBetweenPurges * 60000000 /* convert mMinDelayBetweenPurges to into microseconds */;</span>
<a href="#l13.201"></a><span id="l13.201">         if (nextPurgeTime &lt; PR_Now())</span>
<a href="#l13.202"></a><span id="l13.202">         {</span>
<a href="#l13.203"></a><span id="l13.203" class="difflineminus">-          PR_LOG(MsgPurgeLogModule, PR_LOG_ALWAYS, (&quot;[%d] last purge greater than min delay&quot;, serverIndex));</span>
<a href="#l13.204"></a><span id="l13.204" class="difflineplus">+          MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;[%d] last purge greater than min delay&quot;, serverIndex));</span>
<a href="#l13.205"></a><span id="l13.205"> </span>
<a href="#l13.206"></a><span id="l13.206">           nsCOMPtr &lt;nsIMsgIncomingServer&gt; junkFolderServer;</span>
<a href="#l13.207"></a><span id="l13.207">           rv = junkFolder-&gt;GetServer(getter_AddRefs(junkFolderServer));</span>
<a href="#l13.208"></a><span id="l13.208">           NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l13.209"></a><span id="l13.209"> </span>
<a href="#l13.210"></a><span id="l13.210">           bool serverBusy = false;</span>
<a href="#l13.211"></a><span id="l13.211">           bool serverRequiresPassword = true;</span>
<a href="#l13.212"></a><span id="l13.212">           bool passwordPromptRequired;</span>
<a href="#l13.213"></a><span id="l13.213">           bool canSearchMessages = false;</span>
<a href="#l13.214"></a><span id="l13.214">           junkFolderServer-&gt;GetPasswordPromptRequired(&amp;passwordPromptRequired);</span>
<a href="#l13.215"></a><span id="l13.215">           junkFolderServer-&gt;GetServerBusy(&amp;serverBusy);</span>
<a href="#l13.216"></a><span id="l13.216">           junkFolderServer-&gt;GetServerRequiresPasswordForBiff(&amp;serverRequiresPassword);</span>
<a href="#l13.217"></a><span id="l13.217">           junkFolderServer-&gt;GetCanSearchMessages(&amp;canSearchMessages);</span>
<a href="#l13.218"></a><span id="l13.218">           // Make sure we're logged on before doing the search (assuming we need to be)</span>
<a href="#l13.219"></a><span id="l13.219">           // and make sure the server isn't already in the middle of downloading new messages</span>
<a href="#l13.220"></a><span id="l13.220">           // and make sure a search isn't already going on</span>
<a href="#l13.221"></a><span id="l13.221" class="difflineminus">-          PR_LOG(MsgPurgeLogModule, PR_LOG_ALWAYS, (&quot;[%d] (search in progress? %s)&quot;, serverIndex, mSearchSession ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l13.222"></a><span id="l13.222" class="difflineminus">-          PR_LOG(MsgPurgeLogModule, PR_LOG_ALWAYS, (&quot;[%d] (server busy? %s)&quot;, serverIndex, serverBusy ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l13.223"></a><span id="l13.223" class="difflineminus">-          PR_LOG(MsgPurgeLogModule, PR_LOG_ALWAYS, (&quot;[%d] (serverRequiresPassword? %s)&quot;, serverIndex, serverRequiresPassword ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l13.224"></a><span id="l13.224" class="difflineminus">-          PR_LOG(MsgPurgeLogModule, PR_LOG_ALWAYS, (&quot;[%d] (passwordPromptRequired? %s)&quot;, serverIndex, passwordPromptRequired ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l13.225"></a><span id="l13.225" class="difflineplus">+          MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;[%d] (search in progress? %s)&quot;, serverIndex, mSearchSession ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l13.226"></a><span id="l13.226" class="difflineplus">+          MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;[%d] (server busy? %s)&quot;, serverIndex, serverBusy ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l13.227"></a><span id="l13.227" class="difflineplus">+          MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;[%d] (serverRequiresPassword? %s)&quot;, serverIndex, serverRequiresPassword ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l13.228"></a><span id="l13.228" class="difflineplus">+          MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;[%d] (passwordPromptRequired? %s)&quot;, serverIndex, passwordPromptRequired ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l13.229"></a><span id="l13.229">           if (canSearchMessages &amp;&amp; !mSearchSession &amp;&amp; !serverBusy &amp;&amp; (!serverRequiresPassword || !passwordPromptRequired))</span>
<a href="#l13.230"></a><span id="l13.230">           {</span>
<a href="#l13.231"></a><span id="l13.231">             int32_t purgeInterval;</span>
<a href="#l13.232"></a><span id="l13.232">             spamSettings-&gt;GetPurgeInterval(&amp;purgeInterval);</span>
<a href="#l13.233"></a><span id="l13.233"> </span>
<a href="#l13.234"></a><span id="l13.234">             if ((oldestPurgeTime == 0) || (curJunkFolderLastPurgeTime &lt; oldestPurgeTime))</span>
<a href="#l13.235"></a><span id="l13.235">             {</span>
<a href="#l13.236"></a><span id="l13.236" class="difflineminus">-              PR_LOG(MsgPurgeLogModule, PR_LOG_ALWAYS, (&quot;[%d] purging! searching for messages older than %d days&quot;, serverIndex, purgeInterval));</span>
<a href="#l13.237"></a><span id="l13.237" class="difflineplus">+              MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;[%d] purging! searching for messages older than %d days&quot;, serverIndex, purgeInterval));</span>
<a href="#l13.238"></a><span id="l13.238">               oldestPurgeTime = curJunkFolderLastPurgeTime;</span>
<a href="#l13.239"></a><span id="l13.239">               purgeIntervalToUse = purgeInterval;</span>
<a href="#l13.240"></a><span id="l13.240">               folderToPurge = junkFolder;</span>
<a href="#l13.241"></a><span id="l13.241">               // if we've never purged this folder, do it...</span>
<a href="#l13.242"></a><span id="l13.242">               if (curJunkFolderLastPurgeTime == 0)</span>
<a href="#l13.243"></a><span id="l13.243">                 break;</span>
<a href="#l13.244"></a><span id="l13.244">             }</span>
<a href="#l13.245"></a><span id="l13.245">           }</span>
<a href="#l13.246"></a><span id="l13.246">           else {</span>
<a href="#l13.247"></a><span id="l13.247">             NS_ASSERTION(canSearchMessages, &quot;unexpected, you should be able to search&quot;);</span>
<a href="#l13.248"></a><span id="l13.248" class="difflineminus">-            PR_LOG(MsgPurgeLogModule, PR_LOG_ALWAYS, (&quot;[%d] not a good time for this server, try again later&quot;, serverIndex));</span>
<a href="#l13.249"></a><span id="l13.249" class="difflineplus">+            MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;[%d] not a good time for this server, try again later&quot;, serverIndex));</span>
<a href="#l13.250"></a><span id="l13.250">           }</span>
<a href="#l13.251"></a><span id="l13.251">         }</span>
<a href="#l13.252"></a><span id="l13.252">         else {</span>
<a href="#l13.253"></a><span id="l13.253" class="difflineminus">-          PR_LOG(MsgPurgeLogModule, PR_LOG_ALWAYS, (&quot;[%d] last purge too recent&quot;, serverIndex));</span>
<a href="#l13.254"></a><span id="l13.254" class="difflineplus">+          MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;[%d] last purge too recent&quot;, serverIndex));</span>
<a href="#l13.255"></a><span id="l13.255">         }</span>
<a href="#l13.256"></a><span id="l13.256">       }</span>
<a href="#l13.257"></a><span id="l13.257">     }</span>
<a href="#l13.258"></a><span id="l13.258">     if (folderToPurge)</span>
<a href="#l13.259"></a><span id="l13.259">       rv = SearchFolderToPurge(folderToPurge, purgeIntervalToUse);</span>
<a href="#l13.260"></a><span id="l13.260">   }</span>
<a href="#l13.261"></a><span id="l13.261"> </span>
<a href="#l13.262"></a><span id="l13.262">   // set up timer to check accounts again</span>
<a href="#l13.263"></a><span id="l13.263" class="difflineat">@@ -354,17 +354,17 @@ nsresult nsMsgPurgeService::SearchFolder</span>
<a href="#l13.264"></a><span id="l13.264"> </span>
<a href="#l13.265"></a><span id="l13.265">   // update the time we attempted to purge this folder</span>
<a href="#l13.266"></a><span id="l13.266">   char dateBuf[100];</span>
<a href="#l13.267"></a><span id="l13.267">   dateBuf[0] = '\0';</span>
<a href="#l13.268"></a><span id="l13.268">   PRExplodedTime exploded;</span>
<a href="#l13.269"></a><span id="l13.269">   PR_ExplodeTime(PR_Now(), PR_LocalTimeParameters, &amp;exploded);</span>
<a href="#l13.270"></a><span id="l13.270">   PR_FormatTimeUSEnglish(dateBuf, sizeof(dateBuf), &quot;%a %b %d %H:%M:%S %Y&quot;, &amp;exploded);</span>
<a href="#l13.271"></a><span id="l13.271">   folder-&gt;SetStringProperty(&quot;curJunkFolderLastPurgeTime&quot;, nsDependentCString(dateBuf));</span>
<a href="#l13.272"></a><span id="l13.272" class="difflineminus">-  PR_LOG(MsgPurgeLogModule, PR_LOG_ALWAYS, (&quot;curJunkFolderLastPurgeTime is now %s&quot;, dateBuf));</span>
<a href="#l13.273"></a><span id="l13.273" class="difflineplus">+  MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;curJunkFolderLastPurgeTime is now %s&quot;, dateBuf));</span>
<a href="#l13.274"></a><span id="l13.274"> </span>
<a href="#l13.275"></a><span id="l13.275">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l13.276"></a><span id="l13.276">   rv = folder-&gt;GetServer(getter_AddRefs(server)); //we need to get the folder's server scope because imap can have local junk folder</span>
<a href="#l13.277"></a><span id="l13.277">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.278"></a><span id="l13.278"> </span>
<a href="#l13.279"></a><span id="l13.279">   nsMsgSearchScopeValue searchScope;</span>
<a href="#l13.280"></a><span id="l13.280">   server-&gt;GetSearchScope(&amp;searchScope);</span>
<a href="#l13.281"></a><span id="l13.281"> </span>
<a href="#l13.282"></a><span id="l13.282" class="difflineat">@@ -408,72 +408,72 @@ nsresult nsMsgPurgeService::SearchFolder</span>
<a href="#l13.283"></a><span id="l13.283">   }</span>
<a href="#l13.284"></a><span id="l13.284"> </span>
<a href="#l13.285"></a><span id="l13.285">   mSearchFolder = folder;</span>
<a href="#l13.286"></a><span id="l13.286">   return mSearchSession-&gt;Search(nullptr);</span>
<a href="#l13.287"></a><span id="l13.287"> }</span>
<a href="#l13.288"></a><span id="l13.288"> </span>
<a href="#l13.289"></a><span id="l13.289"> NS_IMETHODIMP nsMsgPurgeService::OnNewSearch()</span>
<a href="#l13.290"></a><span id="l13.290"> {</span>
<a href="#l13.291"></a><span id="l13.291" class="difflineminus">-  PR_LOG(MsgPurgeLogModule, PR_LOG_ALWAYS, (&quot;on new search&quot;));</span>
<a href="#l13.292"></a><span id="l13.292" class="difflineplus">+  MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;on new search&quot;));</span>
<a href="#l13.293"></a><span id="l13.293">   return NS_OK;</span>
<a href="#l13.294"></a><span id="l13.294"> }</span>
<a href="#l13.295"></a><span id="l13.295"> </span>
<a href="#l13.296"></a><span id="l13.296"> NS_IMETHODIMP nsMsgPurgeService::OnSearchHit(nsIMsgDBHdr* aMsgHdr, nsIMsgFolder *aFolder)</span>
<a href="#l13.297"></a><span id="l13.297"> {</span>
<a href="#l13.298"></a><span id="l13.298">   NS_ENSURE_ARG_POINTER(aMsgHdr);</span>
<a href="#l13.299"></a><span id="l13.299"> </span>
<a href="#l13.300"></a><span id="l13.300">   nsCString messageId;</span>
<a href="#l13.301"></a><span id="l13.301">   nsCString author;</span>
<a href="#l13.302"></a><span id="l13.302">   nsCString subject;</span>
<a href="#l13.303"></a><span id="l13.303"> </span>
<a href="#l13.304"></a><span id="l13.304">   aMsgHdr-&gt;GetMessageId(getter_Copies(messageId));</span>
<a href="#l13.305"></a><span id="l13.305" class="difflineminus">-  PR_LOG(MsgPurgeLogModule, PR_LOG_ALWAYS, (&quot;messageId=%s&quot;, messageId.get()));</span>
<a href="#l13.306"></a><span id="l13.306" class="difflineplus">+  MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;messageId=%s&quot;, messageId.get()));</span>
<a href="#l13.307"></a><span id="l13.307">   aMsgHdr-&gt;GetSubject(getter_Copies(subject));</span>
<a href="#l13.308"></a><span id="l13.308" class="difflineminus">-  PR_LOG(MsgPurgeLogModule, PR_LOG_ALWAYS, (&quot;subject=%s&quot;,subject.get()));</span>
<a href="#l13.309"></a><span id="l13.309" class="difflineplus">+  MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;subject=%s&quot;,subject.get()));</span>
<a href="#l13.310"></a><span id="l13.310">   aMsgHdr-&gt;GetAuthor(getter_Copies(author));</span>
<a href="#l13.311"></a><span id="l13.311" class="difflineminus">-  PR_LOG(MsgPurgeLogModule, PR_LOG_ALWAYS, (&quot;author=%s&quot;,author.get()));</span>
<a href="#l13.312"></a><span id="l13.312" class="difflineplus">+  MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;author=%s&quot;,author.get()));</span>
<a href="#l13.313"></a><span id="l13.313"> </span>
<a href="#l13.314"></a><span id="l13.314">   // double check that the message is junk before adding to</span>
<a href="#l13.315"></a><span id="l13.315">   // the list of messages to delete</span>
<a href="#l13.316"></a><span id="l13.316">   //</span>
<a href="#l13.317"></a><span id="l13.317">   // note, we can't just search for messages that are junk</span>
<a href="#l13.318"></a><span id="l13.318">   // because not all imap server support keywords</span>
<a href="#l13.319"></a><span id="l13.319">   // (which we use for the junk score)</span>
<a href="#l13.320"></a><span id="l13.320">   // so the junk status would be in the message db.</span>
<a href="#l13.321"></a><span id="l13.321">   //</span>
<a href="#l13.322"></a><span id="l13.322">   // see bug #194090</span>
<a href="#l13.323"></a><span id="l13.323">   nsCString junkScoreStr;</span>
<a href="#l13.324"></a><span id="l13.324">   nsresult rv = aMsgHdr-&gt;GetStringProperty(&quot;junkscore&quot;, getter_Copies(junkScoreStr));</span>
<a href="#l13.325"></a><span id="l13.325">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l13.326"></a><span id="l13.326"> </span>
<a href="#l13.327"></a><span id="l13.327" class="difflineminus">-  PR_LOG(MsgPurgeLogModule, PR_LOG_ALWAYS, (&quot;junkScore=%s (if empty or != nsIJunkMailPlugin::IS_SPAM_SCORE, don't add to list delete)&quot;, junkScoreStr.get()));</span>
<a href="#l13.328"></a><span id="l13.328" class="difflineplus">+  MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;junkScore=%s (if empty or != nsIJunkMailPlugin::IS_SPAM_SCORE, don't add to list delete)&quot;, junkScoreStr.get()));</span>
<a href="#l13.329"></a><span id="l13.329"> </span>
<a href="#l13.330"></a><span id="l13.330">   // if &quot;junkscore&quot; is not set, don't delete the message</span>
<a href="#l13.331"></a><span id="l13.331">   if (junkScoreStr.IsEmpty())</span>
<a href="#l13.332"></a><span id="l13.332">     return NS_OK;</span>
<a href="#l13.333"></a><span id="l13.333"> </span>
<a href="#l13.334"></a><span id="l13.334">   if (atoi(junkScoreStr.get()) == nsIJunkMailPlugin::IS_SPAM_SCORE) {</span>
<a href="#l13.335"></a><span id="l13.335" class="difflineminus">-    PR_LOG(MsgPurgeLogModule, PR_LOG_ALWAYS, (&quot;added message to delete&quot;));</span>
<a href="#l13.336"></a><span id="l13.336" class="difflineplus">+    MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;added message to delete&quot;));</span>
<a href="#l13.337"></a><span id="l13.337">     return mHdrsToDelete-&gt;AppendElement(aMsgHdr, false);</span>
<a href="#l13.338"></a><span id="l13.338">   }</span>
<a href="#l13.339"></a><span id="l13.339">   return NS_OK;</span>
<a href="#l13.340"></a><span id="l13.340"> }</span>
<a href="#l13.341"></a><span id="l13.341"> </span>
<a href="#l13.342"></a><span id="l13.342"> NS_IMETHODIMP nsMsgPurgeService::OnSearchDone(nsresult status)</span>
<a href="#l13.343"></a><span id="l13.343"> {</span>
<a href="#l13.344"></a><span id="l13.344">   if (NS_SUCCEEDED(status))</span>
<a href="#l13.345"></a><span id="l13.345">   {</span>
<a href="#l13.346"></a><span id="l13.346">     uint32_t count;</span>
<a href="#l13.347"></a><span id="l13.347">     if (mHdrsToDelete)</span>
<a href="#l13.348"></a><span id="l13.348">       mHdrsToDelete-&gt;GetLength(&amp;count);</span>
<a href="#l13.349"></a><span id="l13.349" class="difflineminus">-    PR_LOG(MsgPurgeLogModule, PR_LOG_ALWAYS, (&quot;%d messages to delete&quot;, count));</span>
<a href="#l13.350"></a><span id="l13.350" class="difflineplus">+    MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;%d messages to delete&quot;, count));</span>
<a href="#l13.351"></a><span id="l13.351"> </span>
<a href="#l13.352"></a><span id="l13.352">     if (count &gt; 0) {</span>
<a href="#l13.353"></a><span id="l13.353" class="difflineminus">-      PR_LOG(MsgPurgeLogModule, PR_LOG_ALWAYS, (&quot;delete messages&quot;));</span>
<a href="#l13.354"></a><span id="l13.354" class="difflineplus">+      MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info, (&quot;delete messages&quot;));</span>
<a href="#l13.355"></a><span id="l13.355">       if (mSearchFolder)</span>
<a href="#l13.356"></a><span id="l13.356">         mSearchFolder-&gt;DeleteMessages(mHdrsToDelete, nullptr, false /*delete storage*/, false /*isMove*/, nullptr, false /*allowUndo*/);</span>
<a href="#l13.357"></a><span id="l13.357">     }</span>
<a href="#l13.358"></a><span id="l13.358">   }</span>
<a href="#l13.359"></a><span id="l13.359">   if (mHdrsToDelete)</span>
<a href="#l13.360"></a><span id="l13.360">     mHdrsToDelete-&gt;Clear();</span>
<a href="#l13.361"></a><span id="l13.361">   if (mSearchSession)</span>
<a href="#l13.362"></a><span id="l13.362">     mSearchSession-&gt;UnregisterListener(this);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgComposeService.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgComposeService.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -46,17 +46,17 @@</span>
<a href="#l14.4"></a><span id="l14.4"> #include &quot;nsISelection.h&quot;</span>
<a href="#l14.5"></a><span id="l14.5"> #include &quot;nsUTF8Utils.h&quot;</span>
<a href="#l14.6"></a><span id="l14.6"> #include &quot;nsILineBreaker.h&quot;</span>
<a href="#l14.7"></a><span id="l14.7"> #include &quot;nsLWBrkCIID.h&quot;</span>
<a href="#l14.8"></a><span id="l14.8"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l14.9"></a><span id="l14.9"> #include &quot;mimemoz2.h&quot;</span>
<a href="#l14.10"></a><span id="l14.10"> </span>
<a href="#l14.11"></a><span id="l14.11"> #ifdef MSGCOMP_TRACE_PERFORMANCE</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-#include &quot;prlog.h&quot;</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l14.14"></a><span id="l14.14"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l14.15"></a><span id="l14.15"> #include &quot;nsIMsgMessageService.h&quot;</span>
<a href="#l14.16"></a><span id="l14.16"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l14.17"></a><span id="l14.17"> #endif</span>
<a href="#l14.18"></a><span id="l14.18"> </span>
<a href="#l14.19"></a><span id="l14.19"> #include &quot;nsICommandLine.h&quot;</span>
<a href="#l14.20"></a><span id="l14.20"> #include &quot;nsIAppStartup.h&quot;</span>
<a href="#l14.21"></a><span id="l14.21"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineat">@@ -763,29 +763,29 @@ NS_IMETHODIMP nsMsgComposeService::TimeS</span>
<a href="#l14.23"></a><span id="l14.23">     return NS_OK;</span>
<a href="#l14.24"></a><span id="l14.24"> </span>
<a href="#l14.25"></a><span id="l14.25"> #ifdef MSGCOMP_TRACE_PERFORMANCE</span>
<a href="#l14.26"></a><span id="l14.26"> </span>
<a href="#l14.27"></a><span id="l14.27">   PRIntervalTime now;</span>
<a href="#l14.28"></a><span id="l14.28"> </span>
<a href="#l14.29"></a><span id="l14.29">   if (resetTime)</span>
<a href="#l14.30"></a><span id="l14.30">   {</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-    PR_LOG(MsgComposeLogModule, PR_LOG_ALWAYS, (&quot;\n[process]: [totalTime][deltaTime]\n--------------------\n&quot;));</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+    MOZ_LOG(MsgComposeLogModule, mozilla::LogLevel::Info, (&quot;\n[process]: [totalTime][deltaTime]\n--------------------\n&quot;));</span>
<a href="#l14.33"></a><span id="l14.33"> </span>
<a href="#l14.34"></a><span id="l14.34">     mStartTime = PR_IntervalNow();</span>
<a href="#l14.35"></a><span id="l14.35">     mPreviousTime = mStartTime;</span>
<a href="#l14.36"></a><span id="l14.36">     now = mStartTime;</span>
<a href="#l14.37"></a><span id="l14.37">   }</span>
<a href="#l14.38"></a><span id="l14.38">   else</span>
<a href="#l14.39"></a><span id="l14.39">     now = PR_IntervalNow();</span>
<a href="#l14.40"></a><span id="l14.40"> </span>
<a href="#l14.41"></a><span id="l14.41">   PRIntervalTime totalTime = PR_IntervalToMilliseconds(now - mStartTime);</span>
<a href="#l14.42"></a><span id="l14.42">   PRIntervalTime deltaTime = PR_IntervalToMilliseconds(now - mPreviousTime);</span>
<a href="#l14.43"></a><span id="l14.43"> </span>
<a href="#l14.44"></a><span id="l14.44" class="difflineminus">-  PR_LOG(MsgComposeLogModule, PR_LOG_ALWAYS, (&quot;[%3.2f][%3.2f] - %s\n&quot;,</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+  MOZ_LOG(MsgComposeLogModule, mozilla::LogLevel::Info, (&quot;[%3.2f][%3.2f] - %s\n&quot;,</span>
<a href="#l14.46"></a><span id="l14.46"> ((double)totalTime/1000.0) + 0.005, ((double)deltaTime/1000.0) + 0.005, label));</span>
<a href="#l14.47"></a><span id="l14.47"> </span>
<a href="#l14.48"></a><span id="l14.48">   mPreviousTime = now;</span>
<a href="#l14.49"></a><span id="l14.49"> #endif</span>
<a href="#l14.50"></a><span id="l14.50">   return NS_OK;</span>
<a href="#l14.51"></a><span id="l14.51"> }</span>
<a href="#l14.52"></a><span id="l14.52"> </span>
<a href="#l14.53"></a><span id="l14.53"> NS_IMETHODIMP</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpProtocol.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpProtocol.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -15,17 +15,17 @@</span>
<a href="#l15.4"></a><span id="l15.4"> #include &quot;nsMsgCompCID.h&quot;</span>
<a href="#l15.5"></a><span id="l15.5"> #include &quot;nsIPrompt.h&quot;</span>
<a href="#l15.6"></a><span id="l15.6"> #include &quot;nsIAuthPrompt.h&quot;</span>
<a href="#l15.7"></a><span id="l15.7"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l15.8"></a><span id="l15.8"> #include &quot;nsTextFormatter.h&quot;</span>
<a href="#l15.9"></a><span id="l15.9"> #include &quot;nsIMsgIdentity.h&quot;</span>
<a href="#l15.10"></a><span id="l15.10"> #include &quot;nsISmtpServer.h&quot;</span>
<a href="#l15.11"></a><span id="l15.11"> #include &quot;prtime.h&quot;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-#include &quot;prlog.h&quot;</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l15.14"></a><span id="l15.14"> #include &quot;prerror.h&quot;</span>
<a href="#l15.15"></a><span id="l15.15"> #include &quot;prprf.h&quot;</span>
<a href="#l15.16"></a><span id="l15.16"> #include &quot;prmem.h&quot;</span>
<a href="#l15.17"></a><span id="l15.17"> #include &quot;plbase64.h&quot;</span>
<a href="#l15.18"></a><span id="l15.18"> #include &quot;prnetdb.h&quot;</span>
<a href="#l15.19"></a><span id="l15.19"> #include &quot;prsystem.h&quot;</span>
<a href="#l15.20"></a><span id="l15.20"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l15.21"></a><span id="l15.21"> #include &quot;nsIPipe.h&quot;</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineat">@@ -296,17 +296,17 @@ void nsSmtpProtocol::Initialize(nsIURI *</span>
<a href="#l15.23"></a><span id="l15.23">     InitPrefAuthMethods(authMethod);</span>
<a href="#l15.24"></a><span id="l15.24"> </span>
<a href="#l15.25"></a><span id="l15.25">     nsAutoCString hostName;</span>
<a href="#l15.26"></a><span id="l15.26">     int32_t port = 0;</span>
<a href="#l15.27"></a><span id="l15.27"> </span>
<a href="#l15.28"></a><span id="l15.28">     aURL-&gt;GetPort(&amp;port);</span>
<a href="#l15.29"></a><span id="l15.29">     aURL-&gt;GetAsciiHost(hostName);</span>
<a href="#l15.30"></a><span id="l15.30"> </span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-    PR_LOG(SMTPLogModule, PR_LOG_ALWAYS, (&quot;SMTP Connecting to: %s&quot;, hostName.get()));</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+    MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Info, (&quot;SMTP Connecting to: %s&quot;, hostName.get()));</span>
<a href="#l15.33"></a><span id="l15.33"> </span>
<a href="#l15.34"></a><span id="l15.34">     // When we are making a secure connection, we need to make sure that we</span>
<a href="#l15.35"></a><span id="l15.35">     // pass an interface requestor down to the socket transport so that PSM can</span>
<a href="#l15.36"></a><span id="l15.36">     // retrieve a nsIPrompt instance if needed.</span>
<a href="#l15.37"></a><span id="l15.37">     nsCOMPtr&lt;nsIInterfaceRequestor&gt; callbacks;</span>
<a href="#l15.38"></a><span id="l15.38">     nsCOMPtr&lt;nsISmtpUrl&gt; smtpUrl(do_QueryInterface(aURL));</span>
<a href="#l15.39"></a><span id="l15.39">     if (smtpUrl)</span>
<a href="#l15.40"></a><span id="l15.40">         smtpUrl-&gt;GetNotificationCallbacks(getter_AddRefs(callbacks));</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineat">@@ -404,26 +404,26 @@ NS_IMETHODIMP nsSmtpProtocol::OnStopRequ</span>
<a href="#l15.42"></a><span id="l15.42">                                             nsresult aStatus)</span>
<a href="#l15.43"></a><span id="l15.43"> {</span>
<a href="#l15.44"></a><span id="l15.44">   bool connDroppedDuringAuth = NS_SUCCEEDED(aStatus) &amp;&amp; !m_sendDone &amp;&amp;</span>
<a href="#l15.45"></a><span id="l15.45">       (m_nextStateAfterResponse == SMTP_AUTH_LOGIN_STEP0_RESPONSE ||</span>
<a href="#l15.46"></a><span id="l15.46">        m_nextStateAfterResponse == SMTP_AUTH_LOGIN_RESPONSE);</span>
<a href="#l15.47"></a><span id="l15.47">   // ignore errors handling the QUIT command so fcc can continue.</span>
<a href="#l15.48"></a><span id="l15.48">   if (m_sendDone &amp;&amp; NS_FAILED(aStatus))</span>
<a href="#l15.49"></a><span id="l15.49">   {</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineminus">-    PR_LOG(SMTPLogModule, PR_LOG_ALWAYS,</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+    MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Info,</span>
<a href="#l15.52"></a><span id="l15.52">      (&quot;SMTP connection error quitting %lx, ignoring &quot;, aStatus));</span>
<a href="#l15.53"></a><span id="l15.53">     aStatus = NS_OK;</span>
<a href="#l15.54"></a><span id="l15.54">   }</span>
<a href="#l15.55"></a><span id="l15.55">   if (NS_SUCCEEDED(aStatus) &amp;&amp; !m_sendDone) {</span>
<a href="#l15.56"></a><span id="l15.56">     // if we are getting OnStopRequest() with NS_OK,</span>
<a href="#l15.57"></a><span id="l15.57">     // but we haven't finished clean, that's spells trouble.</span>
<a href="#l15.58"></a><span id="l15.58">     // it means that the server has dropped us before we could send the whole mail</span>
<a href="#l15.59"></a><span id="l15.59">     // for example, see bug #200647</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineminus">-    PR_LOG(SMTPLogModule, PR_LOG_ALWAYS,</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineplus">+    MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Info,</span>
<a href="#l15.62"></a><span id="l15.62">  (&quot;SMTP connection dropped after %ld total bytes read&quot;, m_totalAmountRead));</span>
<a href="#l15.63"></a><span id="l15.63">     if (!connDroppedDuringAuth)</span>
<a href="#l15.64"></a><span id="l15.64">       nsMsgAsyncWriteProtocol::OnStopRequest(nullptr, ctxt, NS_ERROR_NET_INTERRUPT);</span>
<a href="#l15.65"></a><span id="l15.65">   }</span>
<a href="#l15.66"></a><span id="l15.66">   else</span>
<a href="#l15.67"></a><span id="l15.67">     nsMsgAsyncWriteProtocol::OnStopRequest(nullptr, ctxt, aStatus);</span>
<a href="#l15.68"></a><span id="l15.68"> </span>
<a href="#l15.69"></a><span id="l15.69">   // okay, we've been told that the send is done and the connection is going away. So</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineat">@@ -495,17 +495,17 @@ nsresult nsSmtpProtocol::SmtpResponse(ns</span>
<a href="#l15.71"></a><span id="l15.71">   {</span>
<a href="#l15.72"></a><span id="l15.72">     SetFlag(SMTP_PAUSE_FOR_READ); /* pause */</span>
<a href="#l15.73"></a><span id="l15.73">     PR_Free(line);</span>
<a href="#l15.74"></a><span id="l15.74">     return NS_OK;</span>
<a href="#l15.75"></a><span id="l15.75">   }</span>
<a href="#l15.76"></a><span id="l15.76"> </span>
<a href="#l15.77"></a><span id="l15.77">   m_totalAmountRead += ln;</span>
<a href="#l15.78"></a><span id="l15.78"> </span>
<a href="#l15.79"></a><span id="l15.79" class="difflineminus">-  PR_LOG(SMTPLogModule, PR_LOG_ALWAYS, (&quot;SMTP Response: %s&quot;, line));</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineplus">+  MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Info, (&quot;SMTP Response: %s&quot;, line));</span>
<a href="#l15.81"></a><span id="l15.81">   cont_char = ' '; /* default */</span>
<a href="#l15.82"></a><span id="l15.82">   // sscanf() doesn't update m_responseCode if line doesn't start</span>
<a href="#l15.83"></a><span id="l15.83">   // with a number. That can be dangerous. So be sure to set</span>
<a href="#l15.84"></a><span id="l15.84">   // m_responseCode to 0 if no items read.</span>
<a href="#l15.85"></a><span id="l15.85">   if (PR_sscanf(line, &quot;%d%c&quot;, &amp;m_responseCode, &amp;cont_char) &lt;= 0)</span>
<a href="#l15.86"></a><span id="l15.86">     m_responseCode = 0;</span>
<a href="#l15.87"></a><span id="l15.87"> </span>
<a href="#l15.88"></a><span id="l15.88">   if (m_continuationResponse == -1)</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineat">@@ -875,17 +875,17 @@ void nsSmtpProtocol::InitPrefAuthMethods</span>
<a href="#l15.90"></a><span id="l15.90">       m_prefAuthMethods = SMTP_AUTH_CRAM_MD5_ENABLED |</span>
<a href="#l15.91"></a><span id="l15.91">           SMTP_AUTH_GSSAPI_ENABLED |</span>
<a href="#l15.92"></a><span id="l15.92">           SMTP_AUTH_NTLM_ENABLED | SMTP_AUTH_MSN_ENABLED |</span>
<a href="#l15.93"></a><span id="l15.93">           SMTP_AUTH_EXTERNAL_ENABLED; // TODO: Expose EXTERNAL? How?</span>
<a href="#l15.94"></a><span id="l15.94">       break;</span>
<a href="#l15.95"></a><span id="l15.95">     default:</span>
<a href="#l15.96"></a><span id="l15.96">       NS_ASSERTION(false, &quot;SMTP: authMethod pref invalid&quot;);</span>
<a href="#l15.97"></a><span id="l15.97">       // TODO log to error console</span>
<a href="#l15.98"></a><span id="l15.98" class="difflineminus">-      PR_LOG(SMTPLogModule, PR_LOG_ERROR,</span>
<a href="#l15.99"></a><span id="l15.99" class="difflineplus">+      MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Error,</span>
<a href="#l15.100"></a><span id="l15.100">           (&quot;SMTP: bad pref authMethod = %d\n&quot;, authMethodPrefValue));</span>
<a href="#l15.101"></a><span id="l15.101">       // fall to any</span>
<a href="#l15.102"></a><span id="l15.102">     case nsMsgAuthMethod::anything:</span>
<a href="#l15.103"></a><span id="l15.103">       m_prefAuthMethods =</span>
<a href="#l15.104"></a><span id="l15.104">           SMTP_AUTH_LOGIN_ENABLED | SMTP_AUTH_PLAIN_ENABLED |</span>
<a href="#l15.105"></a><span id="l15.105">           SMTP_AUTH_CRAM_MD5_ENABLED | SMTP_AUTH_GSSAPI_ENABLED |</span>
<a href="#l15.106"></a><span id="l15.106">           SMTP_AUTH_NTLM_ENABLED | SMTP_AUTH_MSN_ENABLED |</span>
<a href="#l15.107"></a><span id="l15.107">           SMTP_AUTH_OAUTH2_ENABLED |</span>
<a href="#l15.108"></a><span id="l15.108" class="difflineat">@@ -905,20 +905,20 @@ void nsSmtpProtocol::InitPrefAuthMethods</span>
<a href="#l15.109"></a><span id="l15.109">  * which is allowed by server and prefs and not marked failed.</span>
<a href="#l15.110"></a><span id="l15.110">  * The order of preference and trying of auth methods is encoded here.</span>
<a href="#l15.111"></a><span id="l15.111">  */</span>
<a href="#l15.112"></a><span id="l15.112"> nsresult nsSmtpProtocol::ChooseAuthMethod()</span>
<a href="#l15.113"></a><span id="l15.113"> {</span>
<a href="#l15.114"></a><span id="l15.114">   int32_t serverCaps = m_flags; // from nsMsgProtocol::TestFlag()</span>
<a href="#l15.115"></a><span id="l15.115">   int32_t availCaps = serverCaps &amp; m_prefAuthMethods &amp; ~m_failedAuthMethods;</span>
<a href="#l15.116"></a><span id="l15.116"> </span>
<a href="#l15.117"></a><span id="l15.117" class="difflineminus">-  PR_LOG(SMTPLogModule, PR_LOG_DEBUG,</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineplus">+  MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l15.119"></a><span id="l15.119">         (&quot;SMTP auth: server caps 0x%X, pref 0x%X, failed 0x%X, avail caps 0x%X&quot;,</span>
<a href="#l15.120"></a><span id="l15.120">         serverCaps, m_prefAuthMethods, m_failedAuthMethods, availCaps));</span>
<a href="#l15.121"></a><span id="l15.121" class="difflineminus">-  PR_LOG(SMTPLogModule, PR_LOG_DEBUG,</span>
<a href="#l15.122"></a><span id="l15.122" class="difflineplus">+  MOZ_LOG(SMTPLogModule, mozilla::LogLevel:: Debug,</span>
<a href="#l15.123"></a><span id="l15.123">         (&quot;(GSSAPI = 0x%X, CRAM = 0x%X, NTLM = 0x%X, &quot;</span>
<a href="#l15.124"></a><span id="l15.124">         &quot;MSN =  0x%X, PLAIN = 0x%X, LOGIN = 0x%X, EXTERNAL = 0x%X)&quot;,</span>
<a href="#l15.125"></a><span id="l15.125">         SMTP_AUTH_GSSAPI_ENABLED, SMTP_AUTH_CRAM_MD5_ENABLED,</span>
<a href="#l15.126"></a><span id="l15.126">         SMTP_AUTH_NTLM_ENABLED, SMTP_AUTH_MSN_ENABLED, SMTP_AUTH_PLAIN_ENABLED,</span>
<a href="#l15.127"></a><span id="l15.127">         SMTP_AUTH_LOGIN_ENABLED, SMTP_AUTH_EXTERNAL_ENABLED));</span>
<a href="#l15.128"></a><span id="l15.128"> </span>
<a href="#l15.129"></a><span id="l15.129">   if (SMTP_AUTH_GSSAPI_ENABLED &amp; availCaps)</span>
<a href="#l15.130"></a><span id="l15.130">     m_currentAuthMethod = SMTP_AUTH_GSSAPI_ENABLED;</span>
<a href="#l15.131"></a><span id="l15.131" class="difflineat">@@ -933,27 +933,27 @@ nsresult nsSmtpProtocol::ChooseAuthMetho</span>
<a href="#l15.132"></a><span id="l15.132">   else if (SMTP_AUTH_PLAIN_ENABLED &amp; availCaps)</span>
<a href="#l15.133"></a><span id="l15.133">     m_currentAuthMethod = SMTP_AUTH_PLAIN_ENABLED;</span>
<a href="#l15.134"></a><span id="l15.134">   else if (SMTP_AUTH_LOGIN_ENABLED &amp; availCaps)</span>
<a href="#l15.135"></a><span id="l15.135">     m_currentAuthMethod = SMTP_AUTH_LOGIN_ENABLED;</span>
<a href="#l15.136"></a><span id="l15.136">   else if (SMTP_AUTH_EXTERNAL_ENABLED &amp; availCaps)</span>
<a href="#l15.137"></a><span id="l15.137">     m_currentAuthMethod = SMTP_AUTH_EXTERNAL_ENABLED;</span>
<a href="#l15.138"></a><span id="l15.138">   else</span>
<a href="#l15.139"></a><span id="l15.139">   {</span>
<a href="#l15.140"></a><span id="l15.140" class="difflineminus">-    PR_LOG(SMTPLogModule, PR_LOG_ERROR, (&quot;no auth method remaining&quot;));</span>
<a href="#l15.141"></a><span id="l15.141" class="difflineplus">+    MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Error, (&quot;no auth method remaining&quot;));</span>
<a href="#l15.142"></a><span id="l15.142">     m_currentAuthMethod = 0;</span>
<a href="#l15.143"></a><span id="l15.143">     return NS_ERROR_SMTP_AUTH_FAILURE;</span>
<a href="#l15.144"></a><span id="l15.144">   }</span>
<a href="#l15.145"></a><span id="l15.145" class="difflineminus">-  PR_LOG(SMTPLogModule, PR_LOG_DEBUG, (&quot;trying auth method 0x%X&quot;, m_currentAuthMethod));</span>
<a href="#l15.146"></a><span id="l15.146" class="difflineplus">+  MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug, (&quot;trying auth method 0x%X&quot;, m_currentAuthMethod));</span>
<a href="#l15.147"></a><span id="l15.147">   return NS_OK;</span>
<a href="#l15.148"></a><span id="l15.148"> }</span>
<a href="#l15.149"></a><span id="l15.149"> </span>
<a href="#l15.150"></a><span id="l15.150"> void nsSmtpProtocol::MarkAuthMethodAsFailed(int32_t failedAuthMethod)</span>
<a href="#l15.151"></a><span id="l15.151"> {</span>
<a href="#l15.152"></a><span id="l15.152" class="difflineminus">-  PR_LOG(SMTPLogModule, PR_LOG_DEBUG,</span>
<a href="#l15.153"></a><span id="l15.153" class="difflineplus">+  MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l15.154"></a><span id="l15.154">       (&quot;marking auth method 0x%X failed&quot;, failedAuthMethod));</span>
<a href="#l15.155"></a><span id="l15.155">   m_failedAuthMethods |= failedAuthMethod;</span>
<a href="#l15.156"></a><span id="l15.156"> }</span>
<a href="#l15.157"></a><span id="l15.157"> </span>
<a href="#l15.158"></a><span id="l15.158"> /**</span>
<a href="#l15.159"></a><span id="l15.159">  * Start over, trying all auth methods again</span>
<a href="#l15.160"></a><span id="l15.160">  */</span>
<a href="#l15.161"></a><span id="l15.161"> void nsSmtpProtocol::ResetAuthMethods()</span>
<a href="#l15.162"></a><span id="l15.162" class="difflineat">@@ -1042,17 +1042,17 @@ nsresult nsSmtpProtocol::ProcessAuth()</span>
<a href="#l15.163"></a><span id="l15.163">   }</span>
<a href="#l15.164"></a><span id="l15.164">   else // All auth methods failed</span>
<a href="#l15.165"></a><span id="l15.165">   {</span>
<a href="#l15.166"></a><span id="l15.166">     // show an appropriate error msg</span>
<a href="#l15.167"></a><span id="l15.167">     if (m_failedAuthMethods == 0)</span>
<a href="#l15.168"></a><span id="l15.168">     {</span>
<a href="#l15.169"></a><span id="l15.169">       // we didn't even try anything, so we had a non-working config:</span>
<a href="#l15.170"></a><span id="l15.170">       // pref doesn't match server</span>
<a href="#l15.171"></a><span id="l15.171" class="difflineminus">-      PR_LOG(SMTPLogModule, PR_LOG_ERROR,</span>
<a href="#l15.172"></a><span id="l15.172" class="difflineplus">+      MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Error,</span>
<a href="#l15.173"></a><span id="l15.173">           (&quot;no working auth mech - pref doesn't match server capas&quot;));</span>
<a href="#l15.174"></a><span id="l15.174"> </span>
<a href="#l15.175"></a><span id="l15.175">       // pref has encrypted pw &amp; server claims to support plaintext pw</span>
<a href="#l15.176"></a><span id="l15.176">       if (m_prefAuthMethods == SMTP_AUTH_CRAM_MD5_ENABLED &amp;&amp;</span>
<a href="#l15.177"></a><span id="l15.177">           m_flags &amp; (SMTP_AUTH_LOGIN_ENABLED | SMTP_AUTH_PLAIN_ENABLED))</span>
<a href="#l15.178"></a><span id="l15.178">       {</span>
<a href="#l15.179"></a><span id="l15.179">         // have SSL</span>
<a href="#l15.180"></a><span id="l15.180">         if (m_prefSocketType == nsMsgSocketType::SSL ||</span>
<a href="#l15.181"></a><span id="l15.181" class="difflineat">@@ -1073,37 +1073,37 @@ nsresult nsSmtpProtocol::ProcessAuth()</span>
<a href="#l15.182"></a><span id="l15.182">       {</span>
<a href="#l15.183"></a><span id="l15.183">         // just &quot;change auth method&quot;</span>
<a href="#l15.184"></a><span id="l15.184">         m_urlErrorState = NS_ERROR_SMTP_AUTH_MECH_NOT_SUPPORTED;</span>
<a href="#l15.185"></a><span id="l15.185">       }</span>
<a href="#l15.186"></a><span id="l15.186">     }</span>
<a href="#l15.187"></a><span id="l15.187">     else if (m_failedAuthMethods == SMTP_AUTH_GSSAPI_ENABLED)</span>
<a href="#l15.188"></a><span id="l15.188">     {</span>
<a href="#l15.189"></a><span id="l15.189">       // We have only GSSAPI, and it failed, so nothing left to do.</span>
<a href="#l15.190"></a><span id="l15.190" class="difflineminus">-      PR_LOG(SMTPLogModule, PR_LOG_ERROR, (&quot;GSSAPI only and it failed&quot;));</span>
<a href="#l15.191"></a><span id="l15.191" class="difflineplus">+      MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Error, (&quot;GSSAPI only and it failed&quot;));</span>
<a href="#l15.192"></a><span id="l15.192">       m_urlErrorState = NS_ERROR_SMTP_AUTH_GSSAPI;</span>
<a href="#l15.193"></a><span id="l15.193">     }</span>
<a href="#l15.194"></a><span id="l15.194">     else</span>
<a href="#l15.195"></a><span id="l15.195">     {</span>
<a href="#l15.196"></a><span id="l15.196">       // we tried to login, but it all failed</span>
<a href="#l15.197"></a><span id="l15.197" class="difflineminus">-      PR_LOG(SMTPLogModule, PR_LOG_ERROR, (&quot;All auth attempts failed&quot;));</span>
<a href="#l15.198"></a><span id="l15.198" class="difflineplus">+      MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Error, (&quot;All auth attempts failed&quot;));</span>
<a href="#l15.199"></a><span id="l15.199">       m_urlErrorState = NS_ERROR_SMTP_AUTH_FAILURE;</span>
<a href="#l15.200"></a><span id="l15.200">     }</span>
<a href="#l15.201"></a><span id="l15.201">     m_nextState = SMTP_ERROR_DONE;</span>
<a href="#l15.202"></a><span id="l15.202">     return NS_ERROR_SMTP_AUTH_FAILURE;</span>
<a href="#l15.203"></a><span id="l15.203">   }</span>
<a href="#l15.204"></a><span id="l15.204"> </span>
<a href="#l15.205"></a><span id="l15.205">   return NS_OK;</span>
<a href="#l15.206"></a><span id="l15.206"> }</span>
<a href="#l15.207"></a><span id="l15.207"> </span>
<a href="#l15.208"></a><span id="l15.208"> </span>
<a href="#l15.209"></a><span id="l15.209"> </span>
<a href="#l15.210"></a><span id="l15.210"> nsresult nsSmtpProtocol::AuthLoginResponse(nsIInputStream * stream, uint32_t length)</span>
<a href="#l15.211"></a><span id="l15.211"> {</span>
<a href="#l15.212"></a><span id="l15.212" class="difflineminus">-  PR_LOG(SMTPLogModule, PR_LOG_DEBUG, (&quot;SMTP Login response, code %d&quot;, m_responseCode));</span>
<a href="#l15.213"></a><span id="l15.213" class="difflineplus">+  MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug, (&quot;SMTP Login response, code %d&quot;, m_responseCode));</span>
<a href="#l15.214"></a><span id="l15.214">   nsresult status = NS_OK;</span>
<a href="#l15.215"></a><span id="l15.215"> </span>
<a href="#l15.216"></a><span id="l15.216">   switch (m_responseCode/100)</span>
<a href="#l15.217"></a><span id="l15.217">   {</span>
<a href="#l15.218"></a><span id="l15.218">     case 2:</span>
<a href="#l15.219"></a><span id="l15.219">       m_nextState = SMTP_SEND_HELO_RESPONSE;</span>
<a href="#l15.220"></a><span id="l15.220">       // fake to 250 because SendHeloResponse() tests for this</span>
<a href="#l15.221"></a><span id="l15.221">       m_responseCode = 250;</span>
<a href="#l15.222"></a><span id="l15.222" class="difflineat">@@ -1123,63 +1123,63 @@ nsresult nsSmtpProtocol::AuthLoginRespon</span>
<a href="#l15.223"></a><span id="l15.223"> </span>
<a href="#l15.224"></a><span id="l15.224">         bool allFailed = NS_FAILED(ChooseAuthMethod());</span>
<a href="#l15.225"></a><span id="l15.225">         if (allFailed &amp;&amp; m_failedAuthMethods &gt; 0 &amp;&amp;</span>
<a href="#l15.226"></a><span id="l15.226">             m_failedAuthMethods != SMTP_AUTH_GSSAPI_ENABLED &amp;&amp;</span>
<a href="#l15.227"></a><span id="l15.227">             m_failedAuthMethods != SMTP_AUTH_EXTERNAL_ENABLED)</span>
<a href="#l15.228"></a><span id="l15.228">         {</span>
<a href="#l15.229"></a><span id="l15.229">           // We've tried all avail. methods, and they all failed, and we have no mechanism left.</span>
<a href="#l15.230"></a><span id="l15.230">           // Ask user to try with a new password.</span>
<a href="#l15.231"></a><span id="l15.231" class="difflineminus">-          PR_LOG(SMTPLogModule, PR_LOG_WARN,</span>
<a href="#l15.232"></a><span id="l15.232" class="difflineplus">+          MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Warning,</span>
<a href="#l15.233"></a><span id="l15.233">               (&quot;SMTP: ask user what to do (after login failed): new password, retry or cancel&quot;));</span>
<a href="#l15.234"></a><span id="l15.234"> </span>
<a href="#l15.235"></a><span id="l15.235">           nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l15.236"></a><span id="l15.236">           nsresult rv = m_runningURL-&gt;GetSmtpServer(getter_AddRefs(smtpServer));</span>
<a href="#l15.237"></a><span id="l15.237">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.238"></a><span id="l15.238"> </span>
<a href="#l15.239"></a><span id="l15.239">           nsCString hostname;</span>
<a href="#l15.240"></a><span id="l15.240">           rv = smtpServer-&gt;GetHostname(hostname);</span>
<a href="#l15.241"></a><span id="l15.241">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.242"></a><span id="l15.242"> </span>
<a href="#l15.243"></a><span id="l15.243">           int32_t buttonPressed = 1;</span>
<a href="#l15.244"></a><span id="l15.244">           if (NS_SUCCEEDED(MsgPromptLoginFailed(nullptr, hostname,</span>
<a href="#l15.245"></a><span id="l15.245">                                                 &amp;buttonPressed)))</span>
<a href="#l15.246"></a><span id="l15.246">           {</span>
<a href="#l15.247"></a><span id="l15.247">             if (buttonPressed == 1) // Cancel button</span>
<a href="#l15.248"></a><span id="l15.248">             {</span>
<a href="#l15.249"></a><span id="l15.249" class="difflineminus">-              PR_LOG(SMTPLogModule, PR_LOG_WARN, (&quot;cancel button pressed&quot;));</span>
<a href="#l15.250"></a><span id="l15.250" class="difflineplus">+              MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Warning, (&quot;cancel button pressed&quot;));</span>
<a href="#l15.251"></a><span id="l15.251">               // abort and get out of here</span>
<a href="#l15.252"></a><span id="l15.252">               status = NS_ERROR_ABORT;</span>
<a href="#l15.253"></a><span id="l15.253">               break;</span>
<a href="#l15.254"></a><span id="l15.254">             }</span>
<a href="#l15.255"></a><span id="l15.255">             else if (buttonPressed == 2) // 'New password' button</span>
<a href="#l15.256"></a><span id="l15.256">             {</span>
<a href="#l15.257"></a><span id="l15.257" class="difflineminus">-              PR_LOG(SMTPLogModule, PR_LOG_WARN, (&quot;new password button pressed&quot;));</span>
<a href="#l15.258"></a><span id="l15.258" class="difflineplus">+              MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Warning, (&quot;new password button pressed&quot;));</span>
<a href="#l15.259"></a><span id="l15.259">               // Change password was pressed. For now, forget the stored</span>
<a href="#l15.260"></a><span id="l15.260">               // password and we'll prompt for a new one next time around.</span>
<a href="#l15.261"></a><span id="l15.261">               smtpServer-&gt;ForgetPassword();</span>
<a href="#l15.262"></a><span id="l15.262">               if (m_usernamePrompted)</span>
<a href="#l15.263"></a><span id="l15.263">                 smtpServer-&gt;SetUsername(EmptyCString());</span>
<a href="#l15.264"></a><span id="l15.264"> </span>
<a href="#l15.265"></a><span id="l15.265">               // Let's restore the original auth flags from SendEhloResponse</span>
<a href="#l15.266"></a><span id="l15.266">               // so we can try them again with new password and username</span>
<a href="#l15.267"></a><span id="l15.267">               ResetAuthMethods();</span>
<a href="#l15.268"></a><span id="l15.268">               // except for GSSAPI and EXTERNAL, which don't care about passwords.</span>
<a href="#l15.269"></a><span id="l15.269">               MarkAuthMethodAsFailed(SMTP_AUTH_GSSAPI_ENABLED);</span>
<a href="#l15.270"></a><span id="l15.270">               MarkAuthMethodAsFailed(SMTP_AUTH_EXTERNAL_ENABLED);</span>
<a href="#l15.271"></a><span id="l15.271">             }</span>
<a href="#l15.272"></a><span id="l15.272">             else if (buttonPressed == 0) // Retry button</span>
<a href="#l15.273"></a><span id="l15.273">             {</span>
<a href="#l15.274"></a><span id="l15.274" class="difflineminus">-              PR_LOG(SMTPLogModule, PR_LOG_WARN, (&quot;retry button pressed&quot;));</span>
<a href="#l15.275"></a><span id="l15.275" class="difflineplus">+              MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Warning, (&quot;retry button pressed&quot;));</span>
<a href="#l15.276"></a><span id="l15.276">               // try all again, including GSSAPI</span>
<a href="#l15.277"></a><span id="l15.277">               ResetAuthMethods();</span>
<a href="#l15.278"></a><span id="l15.278">             }</span>
<a href="#l15.279"></a><span id="l15.279">           }</span>
<a href="#l15.280"></a><span id="l15.280">         }</span>
<a href="#l15.281"></a><span id="l15.281" class="difflineminus">-        PR_LOG(SMTPLogModule, PR_LOG_ERROR,</span>
<a href="#l15.282"></a><span id="l15.282" class="difflineplus">+        MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Error,</span>
<a href="#l15.283"></a><span id="l15.283">             (&quot;SMTP: login failed: failed %X, current %X&quot;, m_failedAuthMethods, m_currentAuthMethod));</span>
<a href="#l15.284"></a><span id="l15.284"> </span>
<a href="#l15.285"></a><span id="l15.285">         m_nextState = SMTP_AUTH_PROCESS_STATE; // try auth (ProcessAuth()) again, with other method</span>
<a href="#l15.286"></a><span id="l15.286">       }</span>
<a href="#l15.287"></a><span id="l15.287">       else</span>
<a href="#l15.288"></a><span id="l15.288">           status = NS_ERROR_SMTP_PASSWORD_UNDEFINED;</span>
<a href="#l15.289"></a><span id="l15.289">       break;</span>
<a href="#l15.290"></a><span id="l15.290">   }</span>
<a href="#l15.291"></a><span id="l15.291" class="difflineat">@@ -1204,23 +1204,23 @@ nsresult nsSmtpProtocol::AuthGSSAPIFirst</span>
<a href="#l15.292"></a><span id="l15.292">   rv = smtpServer-&gt;GetUsername(userName);</span>
<a href="#l15.293"></a><span id="l15.293">   if (NS_FAILED(rv))</span>
<a href="#l15.294"></a><span id="l15.294">     return NS_ERROR_FAILURE;</span>
<a href="#l15.295"></a><span id="l15.295"> </span>
<a href="#l15.296"></a><span id="l15.296">   rv = smtpServer-&gt;GetHostname(hostName);</span>
<a href="#l15.297"></a><span id="l15.297">   if (NS_FAILED(rv))</span>
<a href="#l15.298"></a><span id="l15.298">     return NS_ERROR_FAILURE;</span>
<a href="#l15.299"></a><span id="l15.299">   service.Append(hostName);</span>
<a href="#l15.300"></a><span id="l15.300" class="difflineminus">-  PR_LOG(SMTPLogModule, PR_LOG_DEBUG, (&quot;SMTP: GSSAPI step 1 for user %s at server %s, service %s&quot;,</span>
<a href="#l15.301"></a><span id="l15.301" class="difflineplus">+  MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug, (&quot;SMTP: GSSAPI step 1 for user %s at server %s, service %s&quot;,</span>
<a href="#l15.302"></a><span id="l15.302">       userName.get(), hostName.get(), service.get()));</span>
<a href="#l15.303"></a><span id="l15.303"> </span>
<a href="#l15.304"></a><span id="l15.304">   rv = DoGSSAPIStep1(service.get(), userName.get(), resp);</span>
<a href="#l15.305"></a><span id="l15.305">   if (NS_FAILED(rv))</span>
<a href="#l15.306"></a><span id="l15.306">   {</span>
<a href="#l15.307"></a><span id="l15.307" class="difflineminus">-    PR_LOG(SMTPLogModule, PR_LOG_ERROR, (&quot;SMTP: GSSAPI step 1 failed early&quot;));</span>
<a href="#l15.308"></a><span id="l15.308" class="difflineplus">+    MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Error, (&quot;SMTP: GSSAPI step 1 failed early&quot;));</span>
<a href="#l15.309"></a><span id="l15.309">     MarkAuthMethodAsFailed(SMTP_AUTH_GSSAPI_ENABLED);</span>
<a href="#l15.310"></a><span id="l15.310">     m_nextState = SMTP_AUTH_PROCESS_STATE;</span>
<a href="#l15.311"></a><span id="l15.311">     return NS_OK;</span>
<a href="#l15.312"></a><span id="l15.312">   }</span>
<a href="#l15.313"></a><span id="l15.313">   else</span>
<a href="#l15.314"></a><span id="l15.314">     command.Append(resp);</span>
<a href="#l15.315"></a><span id="l15.315">   command.Append(CRLF);</span>
<a href="#l15.316"></a><span id="l15.316">   m_nextState = SMTP_RESPONSE;</span>
<a href="#l15.317"></a><span id="l15.317" class="difflineat">@@ -1228,17 +1228,17 @@ nsresult nsSmtpProtocol::AuthGSSAPIFirst</span>
<a href="#l15.318"></a><span id="l15.318">   SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l15.319"></a><span id="l15.319">   return SendData(command.get());</span>
<a href="#l15.320"></a><span id="l15.320"> }</span>
<a href="#l15.321"></a><span id="l15.321"> </span>
<a href="#l15.322"></a><span id="l15.322"> // GSSAPI may consist of multiple round trips</span>
<a href="#l15.323"></a><span id="l15.323"> </span>
<a href="#l15.324"></a><span id="l15.324"> nsresult nsSmtpProtocol::AuthGSSAPIStep()</span>
<a href="#l15.325"></a><span id="l15.325"> {</span>
<a href="#l15.326"></a><span id="l15.326" class="difflineminus">-  PR_LOG(SMTPLogModule, PR_LOG_DEBUG, (&quot;SMTP: GSSAPI auth step 2&quot;));</span>
<a href="#l15.327"></a><span id="l15.327" class="difflineplus">+  MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug, (&quot;SMTP: GSSAPI auth step 2&quot;));</span>
<a href="#l15.328"></a><span id="l15.328">   NS_ASSERTION(m_currentAuthMethod == SMTP_AUTH_GSSAPI_ENABLED, &quot;called in invalid state&quot;);</span>
<a href="#l15.329"></a><span id="l15.329">   nsresult rv;</span>
<a href="#l15.330"></a><span id="l15.330">   nsAutoCString cmd;</span>
<a href="#l15.331"></a><span id="l15.331"> </span>
<a href="#l15.332"></a><span id="l15.332">   // Check to see what the server said</span>
<a href="#l15.333"></a><span id="l15.333">   if (m_responseCode / 100 != 3) {</span>
<a href="#l15.334"></a><span id="l15.334">     m_nextState = SMTP_AUTH_LOGIN_RESPONSE;</span>
<a href="#l15.335"></a><span id="l15.335">     return NS_OK;</span>
<a href="#l15.336"></a><span id="l15.336" class="difflineat">@@ -1261,17 +1261,17 @@ nsresult nsSmtpProtocol::AuthGSSAPIStep(</span>
<a href="#l15.337"></a><span id="l15.337"> // but by non-RFC2821 compliant implementation in MS servers) not two as</span>
<a href="#l15.338"></a><span id="l15.338"> // PLAIN or CRAM-MD5, so we've to start here and continue with AuthStep1</span>
<a href="#l15.339"></a><span id="l15.339"> // if the server responds with with a 3xx code to &quot;AUTH LOGIN&quot; or &quot;AUTH MSN&quot;</span>
<a href="#l15.340"></a><span id="l15.340"> nsresult nsSmtpProtocol::AuthLoginStep0()</span>
<a href="#l15.341"></a><span id="l15.341"> {</span>
<a href="#l15.342"></a><span id="l15.342">     NS_ASSERTION(m_currentAuthMethod == SMTP_AUTH_MSN_ENABLED ||</span>
<a href="#l15.343"></a><span id="l15.343">         m_currentAuthMethod == SMTP_AUTH_LOGIN_ENABLED,</span>
<a href="#l15.344"></a><span id="l15.344">         &quot;called in invalid state&quot;);</span>
<a href="#l15.345"></a><span id="l15.345" class="difflineminus">-    PR_LOG(SMTPLogModule, PR_LOG_DEBUG, (&quot;SMTP: MSN or LOGIN auth, step 0&quot;));</span>
<a href="#l15.346"></a><span id="l15.346" class="difflineplus">+    MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug, (&quot;SMTP: MSN or LOGIN auth, step 0&quot;));</span>
<a href="#l15.347"></a><span id="l15.347">     nsAutoCString command(m_currentAuthMethod == SMTP_AUTH_MSN_ENABLED</span>
<a href="#l15.348"></a><span id="l15.348">         ? &quot;AUTH MSN&quot; CRLF : &quot;AUTH LOGIN&quot; CRLF);</span>
<a href="#l15.349"></a><span id="l15.349">     m_nextState = SMTP_RESPONSE;</span>
<a href="#l15.350"></a><span id="l15.350">     m_nextStateAfterResponse = SMTP_AUTH_LOGIN_STEP0_RESPONSE;</span>
<a href="#l15.351"></a><span id="l15.351">     SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l15.352"></a><span id="l15.352"> </span>
<a href="#l15.353"></a><span id="l15.353">     return SendData(command.get());</span>
<a href="#l15.354"></a><span id="l15.354"> }</span>
<a href="#l15.355"></a><span id="l15.355" class="difflineat">@@ -1302,61 +1302,61 @@ nsresult nsSmtpProtocol::AuthLoginStep1(</span>
<a href="#l15.356"></a><span id="l15.356">   rv = smtpServer-&gt;GetUsername(username);</span>
<a href="#l15.357"></a><span id="l15.357">   if (username.IsEmpty())</span>
<a href="#l15.358"></a><span id="l15.358">   {</span>
<a href="#l15.359"></a><span id="l15.359">     rv = GetUsernamePassword(username, password);</span>
<a href="#l15.360"></a><span id="l15.360">     m_usernamePrompted = true;</span>
<a href="#l15.361"></a><span id="l15.361">     if (username.IsEmpty() || password.IsEmpty())</span>
<a href="#l15.362"></a><span id="l15.362">       return NS_ERROR_SMTP_PASSWORD_UNDEFINED;</span>
<a href="#l15.363"></a><span id="l15.363">   }</span>
<a href="#l15.364"></a><span id="l15.364" class="difflineminus">-  PR_LOG(SMTPLogModule, PR_LOG_DEBUG, (&quot;SMTP AuthLoginStep1() for %s@%s&quot;,</span>
<a href="#l15.365"></a><span id="l15.365" class="difflineplus">+  MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug, (&quot;SMTP AuthLoginStep1() for %s@%s&quot;,</span>
<a href="#l15.366"></a><span id="l15.366">       username.get(), smtpServer.get()));</span>
<a href="#l15.367"></a><span id="l15.367"> </span>
<a href="#l15.368"></a><span id="l15.368">   GetPassword(password);</span>
<a href="#l15.369"></a><span id="l15.369">   if (password.IsEmpty())</span>
<a href="#l15.370"></a><span id="l15.370">   {</span>
<a href="#l15.371"></a><span id="l15.371" class="difflineminus">-    PR_LOG(SMTPLogModule, PR_LOG_ERROR, (&quot;SMTP: password undefined&quot;));</span>
<a href="#l15.372"></a><span id="l15.372" class="difflineplus">+    MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Error, (&quot;SMTP: password undefined&quot;));</span>
<a href="#l15.373"></a><span id="l15.373">     m_urlErrorState = NS_ERROR_SMTP_PASSWORD_UNDEFINED;</span>
<a href="#l15.374"></a><span id="l15.374">     return NS_ERROR_SMTP_PASSWORD_UNDEFINED;</span>
<a href="#l15.375"></a><span id="l15.375">   }</span>
<a href="#l15.376"></a><span id="l15.376"> </span>
<a href="#l15.377"></a><span id="l15.377">   if (m_currentAuthMethod == SMTP_AUTH_CRAM_MD5_ENABLED)</span>
<a href="#l15.378"></a><span id="l15.378">   {</span>
<a href="#l15.379"></a><span id="l15.379" class="difflineminus">-    PR_LOG(SMTPLogModule, PR_LOG_ERROR, (&quot;CRAM auth, step 1&quot;));</span>
<a href="#l15.380"></a><span id="l15.380" class="difflineplus">+    MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Error, (&quot;CRAM auth, step 1&quot;));</span>
<a href="#l15.381"></a><span id="l15.381">     PR_snprintf(buffer, sizeof(buffer), &quot;AUTH CRAM-MD5&quot; CRLF);</span>
<a href="#l15.382"></a><span id="l15.382">   }</span>
<a href="#l15.383"></a><span id="l15.383">   else if (m_currentAuthMethod == SMTP_AUTH_NTLM_ENABLED ||</span>
<a href="#l15.384"></a><span id="l15.384">            m_currentAuthMethod == SMTP_AUTH_MSN_ENABLED)</span>
<a href="#l15.385"></a><span id="l15.385">   {</span>
<a href="#l15.386"></a><span id="l15.386" class="difflineminus">-    PR_LOG(SMTPLogModule, PR_LOG_DEBUG, (&quot;NTLM/MSN auth, step 1&quot;));</span>
<a href="#l15.387"></a><span id="l15.387" class="difflineplus">+    MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug, (&quot;NTLM/MSN auth, step 1&quot;));</span>
<a href="#l15.388"></a><span id="l15.388">     nsAutoCString response;</span>
<a href="#l15.389"></a><span id="l15.389">     rv = DoNtlmStep1(username.get(), password.get(), response);</span>
<a href="#l15.390"></a><span id="l15.390">     PR_snprintf(buffer, sizeof(buffer), TestFlag(SMTP_AUTH_NTLM_ENABLED) ?</span>
<a href="#l15.391"></a><span id="l15.391">                                         &quot;AUTH NTLM %.256s&quot; CRLF :</span>
<a href="#l15.392"></a><span id="l15.392">                                         &quot;%.256s&quot; CRLF, response.get());</span>
<a href="#l15.393"></a><span id="l15.393">   }</span>
<a href="#l15.394"></a><span id="l15.394">   else if (m_currentAuthMethod == SMTP_AUTH_PLAIN_ENABLED)</span>
<a href="#l15.395"></a><span id="l15.395">   {</span>
<a href="#l15.396"></a><span id="l15.396" class="difflineminus">-    PR_LOG(SMTPLogModule, PR_LOG_DEBUG, (&quot;PLAIN auth&quot;));</span>
<a href="#l15.397"></a><span id="l15.397" class="difflineplus">+    MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug, (&quot;PLAIN auth&quot;));</span>
<a href="#l15.398"></a><span id="l15.398">     char plain_string[512];</span>
<a href="#l15.399"></a><span id="l15.399">     int len = 1; /* first &lt;NUL&gt; char */</span>
<a href="#l15.400"></a><span id="l15.400"> </span>
<a href="#l15.401"></a><span id="l15.401">     memset(plain_string, 0, 512);</span>
<a href="#l15.402"></a><span id="l15.402">     PR_snprintf(&amp;plain_string[1], 510, &quot;%s&quot;, username.get());</span>
<a href="#l15.403"></a><span id="l15.403">     len += username.Length();</span>
<a href="#l15.404"></a><span id="l15.404">     len++; /* second &lt;NUL&gt; char */</span>
<a href="#l15.405"></a><span id="l15.405">     PR_snprintf(&amp;plain_string[len], 511-len, &quot;%s&quot;, password.get());</span>
<a href="#l15.406"></a><span id="l15.406">     len += password.Length();</span>
<a href="#l15.407"></a><span id="l15.407"> </span>
<a href="#l15.408"></a><span id="l15.408">     base64Str = PL_Base64Encode(plain_string, len, nullptr);</span>
<a href="#l15.409"></a><span id="l15.409">     PR_snprintf(buffer, sizeof(buffer), &quot;AUTH PLAIN %.256s&quot; CRLF, base64Str);</span>
<a href="#l15.410"></a><span id="l15.410">   }</span>
<a href="#l15.411"></a><span id="l15.411">   else if (m_currentAuthMethod == SMTP_AUTH_LOGIN_ENABLED)</span>
<a href="#l15.412"></a><span id="l15.412">   {</span>
<a href="#l15.413"></a><span id="l15.413" class="difflineminus">-    PR_LOG(SMTPLogModule, PR_LOG_DEBUG, (&quot;LOGIN auth&quot;));</span>
<a href="#l15.414"></a><span id="l15.414" class="difflineplus">+    MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug, (&quot;LOGIN auth&quot;));</span>
<a href="#l15.415"></a><span id="l15.415">     base64Str = PL_Base64Encode(username.get(),</span>
<a href="#l15.416"></a><span id="l15.416">         username.Length(), nullptr);</span>
<a href="#l15.417"></a><span id="l15.417">     PR_snprintf(buffer, sizeof(buffer), &quot;%.256s&quot; CRLF, base64Str);</span>
<a href="#l15.418"></a><span id="l15.418">   }</span>
<a href="#l15.419"></a><span id="l15.419">   else</span>
<a href="#l15.420"></a><span id="l15.420">     return (NS_ERROR_COMMUNICATIONS_ERROR);</span>
<a href="#l15.421"></a><span id="l15.421"> </span>
<a href="#l15.422"></a><span id="l15.422">   status = SendData(buffer, true);</span>
<a href="#l15.423"></a><span id="l15.423" class="difflineat">@@ -1380,24 +1380,24 @@ nsresult nsSmtpProtocol::AuthLoginStep2(</span>
<a href="#l15.424"></a><span id="l15.424">   nsAutoCString password;</span>
<a href="#l15.425"></a><span id="l15.425"> </span>
<a href="#l15.426"></a><span id="l15.426">   GetPassword(password);</span>
<a href="#l15.427"></a><span id="l15.427">   if (password.IsEmpty())</span>
<a href="#l15.428"></a><span id="l15.428">   {</span>
<a href="#l15.429"></a><span id="l15.429">     m_urlErrorState = NS_ERROR_SMTP_PASSWORD_UNDEFINED;</span>
<a href="#l15.430"></a><span id="l15.430">     return NS_ERROR_SMTP_PASSWORD_UNDEFINED;</span>
<a href="#l15.431"></a><span id="l15.431">   }</span>
<a href="#l15.432"></a><span id="l15.432" class="difflineminus">-  PR_LOG(SMTPLogModule, PR_LOG_MAX, (&quot;SMTP AuthLoginStep2&quot;));</span>
<a href="#l15.433"></a><span id="l15.433" class="difflineplus">+  MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug, (&quot;SMTP AuthLoginStep2&quot;));</span>
<a href="#l15.434"></a><span id="l15.434"> </span>
<a href="#l15.435"></a><span id="l15.435">   if (!password.IsEmpty())</span>
<a href="#l15.436"></a><span id="l15.436">   {</span>
<a href="#l15.437"></a><span id="l15.437">     char buffer[512];</span>
<a href="#l15.438"></a><span id="l15.438">     if (m_currentAuthMethod == SMTP_AUTH_CRAM_MD5_ENABLED)</span>
<a href="#l15.439"></a><span id="l15.439">     {</span>
<a href="#l15.440"></a><span id="l15.440" class="difflineminus">-      PR_LOG(SMTPLogModule, PR_LOG_DEBUG, (&quot;CRAM auth, step 2&quot;));</span>
<a href="#l15.441"></a><span id="l15.441" class="difflineplus">+      MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug, (&quot;CRAM auth, step 2&quot;));</span>
<a href="#l15.442"></a><span id="l15.442">       unsigned char digest[DIGEST_LENGTH];</span>
<a href="#l15.443"></a><span id="l15.443">       char * decodedChallenge = PL_Base64Decode(m_responseText.get(),</span>
<a href="#l15.444"></a><span id="l15.444">         m_responseText.Length(), nullptr);</span>
<a href="#l15.445"></a><span id="l15.445"> </span>
<a href="#l15.446"></a><span id="l15.446">       if (decodedChallenge)</span>
<a href="#l15.447"></a><span id="l15.447">         rv = MSGCramMD5(decodedChallenge, strlen(decodedChallenge), password.get(), password.Length(), digest);</span>
<a href="#l15.448"></a><span id="l15.448">       else</span>
<a href="#l15.449"></a><span id="l15.449">         rv = NS_ERROR_FAILURE;</span>
<a href="#l15.450"></a><span id="l15.450" class="difflineat">@@ -1427,25 +1427,25 @@ nsresult nsSmtpProtocol::AuthLoginStep2(</span>
<a href="#l15.451"></a><span id="l15.451">         NS_Free(base64Str);</span>
<a href="#l15.452"></a><span id="l15.452">       }</span>
<a href="#l15.453"></a><span id="l15.453">       if (NS_FAILED(rv))</span>
<a href="#l15.454"></a><span id="l15.454">         PR_snprintf(buffer, sizeof(buffer), &quot;*&quot; CRLF);</span>
<a href="#l15.455"></a><span id="l15.455">     }</span>
<a href="#l15.456"></a><span id="l15.456">     else if (m_currentAuthMethod == SMTP_AUTH_NTLM_ENABLED ||</span>
<a href="#l15.457"></a><span id="l15.457">              m_currentAuthMethod == SMTP_AUTH_MSN_ENABLED)</span>
<a href="#l15.458"></a><span id="l15.458">     {</span>
<a href="#l15.459"></a><span id="l15.459" class="difflineminus">-      PR_LOG(SMTPLogModule, PR_LOG_DEBUG, (&quot;NTLM/MSN auth, step 2&quot;));</span>
<a href="#l15.460"></a><span id="l15.460" class="difflineplus">+      MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug, (&quot;NTLM/MSN auth, step 2&quot;));</span>
<a href="#l15.461"></a><span id="l15.461">       nsAutoCString response;</span>
<a href="#l15.462"></a><span id="l15.462">       rv = DoNtlmStep2(m_responseText, response);</span>
<a href="#l15.463"></a><span id="l15.463">       PR_snprintf(buffer, sizeof(buffer), &quot;%.256s&quot; CRLF, response.get());</span>
<a href="#l15.464"></a><span id="l15.464">     }</span>
<a href="#l15.465"></a><span id="l15.465">     else if (m_currentAuthMethod == SMTP_AUTH_PLAIN_ENABLED ||</span>
<a href="#l15.466"></a><span id="l15.466">              m_currentAuthMethod == SMTP_AUTH_LOGIN_ENABLED)</span>
<a href="#l15.467"></a><span id="l15.467">     {</span>
<a href="#l15.468"></a><span id="l15.468" class="difflineminus">-      PR_LOG(SMTPLogModule, PR_LOG_DEBUG, (&quot;PLAIN/LOGIN auth, step 2&quot;));</span>
<a href="#l15.469"></a><span id="l15.469" class="difflineplus">+      MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug, (&quot;PLAIN/LOGIN auth, step 2&quot;));</span>
<a href="#l15.470"></a><span id="l15.470">       char *base64Str = PL_Base64Encode(password.get(), password.Length(), nullptr);</span>
<a href="#l15.471"></a><span id="l15.471">       PR_snprintf(buffer, sizeof(buffer), &quot;%.256s&quot; CRLF, base64Str);</span>
<a href="#l15.472"></a><span id="l15.472">       NS_Free(base64Str);</span>
<a href="#l15.473"></a><span id="l15.473">     }</span>
<a href="#l15.474"></a><span id="l15.474">     else</span>
<a href="#l15.475"></a><span id="l15.475">       return NS_ERROR_COMMUNICATIONS_ERROR;</span>
<a href="#l15.476"></a><span id="l15.476"> </span>
<a href="#l15.477"></a><span id="l15.477">     status = SendData(buffer, true);</span>
<a href="#l15.478"></a><span id="l15.478" class="difflineat">@@ -1497,17 +1497,17 @@ nsresult nsSmtpProtocol::OnSuccess(const</span>
<a href="#l15.479"></a><span id="l15.479">   SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l15.480"></a><span id="l15.480"> </span>
<a href="#l15.481"></a><span id="l15.481">   ProcessProtocolState(nullptr, nullptr, 0, 0);</span>
<a href="#l15.482"></a><span id="l15.482">   return NS_OK;</span>
<a href="#l15.483"></a><span id="l15.483"> }</span>
<a href="#l15.484"></a><span id="l15.484"> </span>
<a href="#l15.485"></a><span id="l15.485"> nsresult nsSmtpProtocol::OnFailure(nsresult aError)</span>
<a href="#l15.486"></a><span id="l15.486"> {</span>
<a href="#l15.487"></a><span id="l15.487" class="difflineminus">-  PR_LOG(SMTPLogModule, PR_LOG_DEBUG, (&quot;OAuth2 login error %08x&quot;,</span>
<a href="#l15.488"></a><span id="l15.488" class="difflineplus">+  MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug, (&quot;OAuth2 login error %08x&quot;,</span>
<a href="#l15.489"></a><span id="l15.489">     (uint32_t)aError));</span>
<a href="#l15.490"></a><span id="l15.490">   m_urlErrorState = aError;</span>
<a href="#l15.491"></a><span id="l15.491">   m_nextState = SMTP_ERROR_DONE;</span>
<a href="#l15.492"></a><span id="l15.492">   return ProcessProtocolState(nullptr, nullptr, 0, 0);</span>
<a href="#l15.493"></a><span id="l15.493"> }</span>
<a href="#l15.494"></a><span id="l15.494"> </span>
<a href="#l15.495"></a><span id="l15.495"> </span>
<a href="#l15.496"></a><span id="l15.496"> nsresult nsSmtpProtocol::SendMailResponse()</span>
<a href="#l15.497"></a><span id="l15.497" class="difflineat">@@ -1665,19 +1665,19 @@ nsresult nsSmtpProtocol::SendRecipientRe</span>
<a href="#l15.498"></a><span id="l15.498"> </span>
<a href="#l15.499"></a><span id="l15.499"> </span>
<a href="#l15.500"></a><span id="l15.500"> nsresult nsSmtpProtocol::SendData(const char *dataBuffer, bool aSuppressLogging)</span>
<a href="#l15.501"></a><span id="l15.501"> {</span>
<a href="#l15.502"></a><span id="l15.502">   // XXX -1 is not a valid nsresult</span>
<a href="#l15.503"></a><span id="l15.503">   if (!dataBuffer) return static_cast&lt;nsresult&gt;(-1);</span>
<a href="#l15.504"></a><span id="l15.504"> </span>
<a href="#l15.505"></a><span id="l15.505">   if (!aSuppressLogging) {</span>
<a href="#l15.506"></a><span id="l15.506" class="difflineminus">-      PR_LOG(SMTPLogModule, PR_LOG_ALWAYS, (&quot;SMTP Send: %s&quot;, dataBuffer));</span>
<a href="#l15.507"></a><span id="l15.507" class="difflineplus">+      MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Info, (&quot;SMTP Send: %s&quot;, dataBuffer));</span>
<a href="#l15.508"></a><span id="l15.508">   } else {</span>
<a href="#l15.509"></a><span id="l15.509" class="difflineminus">-      PR_LOG(SMTPLogModule, PR_LOG_ALWAYS, (&quot;Logging suppressed for this command (it probably contained authentication information)&quot;));</span>
<a href="#l15.510"></a><span id="l15.510" class="difflineplus">+      MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Info, (&quot;Logging suppressed for this command (it probably contained authentication information)&quot;));</span>
<a href="#l15.511"></a><span id="l15.511">   }</span>
<a href="#l15.512"></a><span id="l15.512">   return nsMsgAsyncWriteProtocol::SendData(dataBuffer);</span>
<a href="#l15.513"></a><span id="l15.513"> }</span>
<a href="#l15.514"></a><span id="l15.514"> </span>
<a href="#l15.515"></a><span id="l15.515"> </span>
<a href="#l15.516"></a><span id="l15.516"> nsresult nsSmtpProtocol::SendDataResponse()</span>
<a href="#l15.517"></a><span id="l15.517"> {</span>
<a href="#l15.518"></a><span id="l15.518">   nsresult status = NS_OK;</span>
<a href="#l15.519"></a><span id="l15.519" class="difflineat">@@ -1913,17 +1913,17 @@ nsresult nsSmtpProtocol::LoadUrl(nsIURI </span>
<a href="#l15.520"></a><span id="l15.520"> nsresult nsSmtpProtocol::ProcessProtocolState(nsIURI * url, nsIInputStream * inputStream,</span>
<a href="#l15.521"></a><span id="l15.521">                                               uint64_t sourceOffset, uint32_t length)</span>
<a href="#l15.522"></a><span id="l15.522">  {</span>
<a href="#l15.523"></a><span id="l15.523">    nsresult status = NS_OK;</span>
<a href="#l15.524"></a><span id="l15.524">    ClearFlag(SMTP_PAUSE_FOR_READ); /* already paused; reset */</span>
<a href="#l15.525"></a><span id="l15.525"> </span>
<a href="#l15.526"></a><span id="l15.526">    while(!TestFlag(SMTP_PAUSE_FOR_READ))</span>
<a href="#l15.527"></a><span id="l15.527">    {</span>
<a href="#l15.528"></a><span id="l15.528" class="difflineminus">-     PR_LOG(SMTPLogModule, PR_LOG_ALWAYS, (&quot;SMTP entering state: %d&quot;,</span>
<a href="#l15.529"></a><span id="l15.529" class="difflineplus">+     MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Info, (&quot;SMTP entering state: %d&quot;,</span>
<a href="#l15.530"></a><span id="l15.530">        m_nextState));</span>
<a href="#l15.531"></a><span id="l15.531">      switch(m_nextState)</span>
<a href="#l15.532"></a><span id="l15.532">      {</span>
<a href="#l15.533"></a><span id="l15.533">      case SMTP_RESPONSE:</span>
<a href="#l15.534"></a><span id="l15.534">        if (inputStream == nullptr)</span>
<a href="#l15.535"></a><span id="l15.535">          SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l15.536"></a><span id="l15.536">        else</span>
<a href="#l15.537"></a><span id="l15.537">          status = SmtpResponse(inputStream, length);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMailDatabase.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMailDatabase.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -6,23 +6,25 @@</span>
<a href="#l16.4"></a><span id="l16.4"> #include &quot;msgCore.h&quot;</span>
<a href="#l16.5"></a><span id="l16.5"> #include &quot;nsMailDatabase.h&quot;</span>
<a href="#l16.6"></a><span id="l16.6"> #include &quot;nsDBFolderInfo.h&quot;</span>
<a href="#l16.7"></a><span id="l16.7"> #include &quot;nsMsgLocalFolderHdrs.h&quot;</span>
<a href="#l16.8"></a><span id="l16.8"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l16.9"></a><span id="l16.9"> #include &quot;nsISeekableStream.h&quot;</span>
<a href="#l16.10"></a><span id="l16.10"> #include &quot;nsMsgOfflineImapOperation.h&quot;</span>
<a href="#l16.11"></a><span id="l16.11"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-#include &quot;prlog.h&quot;</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l16.14"></a><span id="l16.14"> #include &quot;prprf.h&quot;</span>
<a href="#l16.15"></a><span id="l16.15"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l16.16"></a><span id="l16.16"> #include &quot;nsIMsgPluggableStore.h&quot;</span>
<a href="#l16.17"></a><span id="l16.17"> </span>
<a href="#l16.18"></a><span id="l16.18"> extern PRLogModuleInfo *IMAPOffline;</span>
<a href="#l16.19"></a><span id="l16.19"> </span>
<a href="#l16.20"></a><span id="l16.20" class="difflineplus">+using namespace mozilla;</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineplus">+</span>
<a href="#l16.22"></a><span id="l16.22"> // scope for all offine ops table</span>
<a href="#l16.23"></a><span id="l16.23"> const char *kOfflineOpsScope = &quot;ns:msg:db:row:scope:ops:all&quot;;</span>
<a href="#l16.24"></a><span id="l16.24"> const char *kOfflineOpsTableKind = &quot;ns:msg:db:table:kind:ops&quot;;</span>
<a href="#l16.25"></a><span id="l16.25"> struct mdbOid gAllOfflineOpsTableOID;</span>
<a href="#l16.26"></a><span id="l16.26"> </span>
<a href="#l16.27"></a><span id="l16.27"> nsMailDatabase::nsMailDatabase() : m_reparse(false)</span>
<a href="#l16.28"></a><span id="l16.28"> {</span>
<a href="#l16.29"></a><span id="l16.29">   m_mdbAllOfflineOpsTable = nullptr;</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineat">@@ -235,17 +237,17 @@ NS_IMETHODIMP nsMailDatabase::ListAllOff</span>
<a href="#l16.31"></a><span id="l16.31">       </span>
<a href="#l16.32"></a><span id="l16.32">       err = rowCursor-&gt;NextRowOid(GetEnv(), &amp;outOid, &amp;outPos);</span>
<a href="#l16.33"></a><span id="l16.33">       // is this right? Mork is returning a 0 id, but that should valid.</span>
<a href="#l16.34"></a><span id="l16.34">       if (outPos &lt; 0 || outOid.mOid_Id == (mdb_id) -1)</span>
<a href="#l16.35"></a><span id="l16.35">         break;</span>
<a href="#l16.36"></a><span id="l16.36">       if (NS_SUCCEEDED(err))</span>
<a href="#l16.37"></a><span id="l16.37">       {</span>
<a href="#l16.38"></a><span id="l16.38">         offlineOpIds-&gt;AppendElement(outOid.mOid_Id);</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineminus">-        if (PR_LOG_TEST(IMAPOffline, PR_LOG_ALWAYS))</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+        if (MOZ_LOG_TEST(IMAPOffline, LogLevel::Info))</span>
<a href="#l16.41"></a><span id="l16.41">         {</span>
<a href="#l16.42"></a><span id="l16.42">           nsCOMPtr &lt;nsIMsgOfflineImapOperation&gt; offlineOp;</span>
<a href="#l16.43"></a><span id="l16.43">           GetOfflineOpForKey(outOid.mOid_Id, false, getter_AddRefs(offlineOp));</span>
<a href="#l16.44"></a><span id="l16.44">           if (offlineOp)</span>
<a href="#l16.45"></a><span id="l16.45">           {</span>
<a href="#l16.46"></a><span id="l16.46">             nsMsgOfflineImapOperation *logOp = static_cast&lt;nsMsgOfflineImapOperation *&gt;(static_cast&lt;nsIMsgOfflineImapOperation *&gt;(offlineOp.get()));</span>
<a href="#l16.47"></a><span id="l16.47">             if (logOp)</span>
<a href="#l16.48"></a><span id="l16.48">               logOp-&gt;Log(IMAPOffline);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -10,17 +10,17 @@</span>
<a href="#l17.4"></a><span id="l17.4"> #include &quot;nsMailDatabase.h&quot;</span>
<a href="#l17.5"></a><span id="l17.5"> #include &quot;nsDBFolderInfo.h&quot;</span>
<a href="#l17.6"></a><span id="l17.6"> #include &quot;nsMsgKeySet.h&quot;</span>
<a href="#l17.7"></a><span id="l17.7"> #include &quot;nsMsgThread.h&quot;</span>
<a href="#l17.8"></a><span id="l17.8"> #include &quot;nsIMsgSearchTerm.h&quot;</span>
<a href="#l17.9"></a><span id="l17.9"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l17.10"></a><span id="l17.10"> #include &quot;nsMorkCID.h&quot;</span>
<a href="#l17.11"></a><span id="l17.11"> #include &quot;nsIMdbFactoryFactory.h&quot;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-#include &quot;prlog.h&quot;</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l17.14"></a><span id="l17.14"> #include &quot;prprf.h&quot;</span>
<a href="#l17.15"></a><span id="l17.15"> #include &quot;nsMsgDBCID.h&quot;</span>
<a href="#l17.16"></a><span id="l17.16"> #include &quot;nsILocale.h&quot;</span>
<a href="#l17.17"></a><span id="l17.17"> #include &quot;nsMsgMimeCID.h&quot;</span>
<a href="#l17.18"></a><span id="l17.18"> #include &quot;nsILocaleService.h&quot;</span>
<a href="#l17.19"></a><span id="l17.19"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l17.20"></a><span id="l17.20"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l17.21"></a><span id="l17.21"> #include &quot;nsIMsgDBView.h&quot;</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineat">@@ -41,16 +41,17 @@</span>
<a href="#l17.23"></a><span id="l17.23"> #include &quot;nsAlgorithm.h&quot;</span>
<a href="#l17.24"></a><span id="l17.24"> #include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l17.25"></a><span id="l17.25"> #include &quot;nsIMemoryReporter.h&quot;</span>
<a href="#l17.26"></a><span id="l17.26"> #include &quot;mozilla/mailnews/MimeHeaderParser.h&quot;</span>
<a href="#l17.27"></a><span id="l17.27"> #include &quot;mozilla/mailnews/Services.h&quot;</span>
<a href="#l17.28"></a><span id="l17.28"> #include &lt;algorithm&gt;</span>
<a href="#l17.29"></a><span id="l17.29"> </span>
<a href="#l17.30"></a><span id="l17.30"> using namespace mozilla::mailnews;</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+using namespace mozilla;</span>
<a href="#l17.32"></a><span id="l17.32"> </span>
<a href="#l17.33"></a><span id="l17.33"> #if defined(DEBUG_sspitzer_) || defined(DEBUG_seth_)</span>
<a href="#l17.34"></a><span id="l17.34"> #define DEBUG_MSGKEYSET 1</span>
<a href="#l17.35"></a><span id="l17.35"> #endif</span>
<a href="#l17.36"></a><span id="l17.36"> </span>
<a href="#l17.37"></a><span id="l17.37"> #define MSG_HASH_SIZE 512</span>
<a href="#l17.38"></a><span id="l17.38"> </span>
<a href="#l17.39"></a><span id="l17.39"> // This will be used on discovery, since we don't know total.</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineat">@@ -964,21 +965,21 @@ void nsMsgDBService::AddToCache(nsMsgDat</span>
<a href="#l17.41"></a><span id="l17.41"> }</span>
<a href="#l17.42"></a><span id="l17.42"> </span>
<a href="#l17.43"></a><span id="l17.43"> /**</span>
<a href="#l17.44"></a><span id="l17.44">  * Log the open db's, and how many headers are in memory.</span>
<a href="#l17.45"></a><span id="l17.45">  */</span>
<a href="#l17.46"></a><span id="l17.46"> void nsMsgDBService::DumpCache()</span>
<a href="#l17.47"></a><span id="l17.47"> {</span>
<a href="#l17.48"></a><span id="l17.48">   nsMsgDatabase* db = nullptr;</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineminus">-  PR_LOG(DBLog, PR_LOG_ALWAYS, (&quot;%d open DB's\n&quot;, m_dbCache.Length()));</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineplus">+  MOZ_LOG(DBLog, LogLevel::Info, (&quot;%d open DB's\n&quot;, m_dbCache.Length()));</span>
<a href="#l17.51"></a><span id="l17.51">   for (uint32_t i = 0; i &lt; m_dbCache.Length(); i++)</span>
<a href="#l17.52"></a><span id="l17.52">   {</span>
<a href="#l17.53"></a><span id="l17.53">     db = m_dbCache.ElementAt(i);</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineminus">-    PR_LOG(DBLog, PR_LOG_ALWAYS, (&quot;%s - %ld hdrs in use\n&quot;,</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineplus">+    MOZ_LOG(DBLog, LogLevel::Info, (&quot;%s - %ld hdrs in use\n&quot;,</span>
<a href="#l17.56"></a><span id="l17.56">       (const char*)db-&gt;m_dbName.get(),</span>
<a href="#l17.57"></a><span id="l17.57">       db-&gt;m_headersInUse ? db-&gt;m_headersInUse-&gt;EntryCount() : 0));</span>
<a href="#l17.58"></a><span id="l17.58">   }</span>
<a href="#l17.59"></a><span id="l17.59"> }</span>
<a href="#l17.60"></a><span id="l17.60"> </span>
<a href="#l17.61"></a><span id="l17.61"> // Memory Reporting implementations</span>
<a href="#l17.62"></a><span id="l17.62"> </span>
<a href="#l17.63"></a><span id="l17.63"> size_t nsMsgDatabase::HeaderHashSizeOf(PLDHashEntryHdr *hdr,</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineat">@@ -1144,17 +1145,17 @@ nsMsgDatabase::~nsMsgDatabase()</span>
<a href="#l17.65"></a><span id="l17.65">   delete m_headersInUse;</span>
<a href="#l17.66"></a><span id="l17.66"> </span>
<a href="#l17.67"></a><span id="l17.67">   if (m_msgReferences)</span>
<a href="#l17.68"></a><span id="l17.68">   {</span>
<a href="#l17.69"></a><span id="l17.69">     delete m_msgReferences;</span>
<a href="#l17.70"></a><span id="l17.70">     m_msgReferences = nullptr;</span>
<a href="#l17.71"></a><span id="l17.71">   }</span>
<a href="#l17.72"></a><span id="l17.72"> </span>
<a href="#l17.73"></a><span id="l17.73" class="difflineminus">-  PR_LOG(DBLog, PR_LOG_ALWAYS, (&quot;closing database    %s\n&quot;,</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineplus">+  MOZ_LOG(DBLog, LogLevel::Info, (&quot;closing database    %s\n&quot;,</span>
<a href="#l17.75"></a><span id="l17.75">     (const char*)m_dbName.get()));</span>
<a href="#l17.76"></a><span id="l17.76"> </span>
<a href="#l17.77"></a><span id="l17.77">   nsCOMPtr&lt;nsIMsgDBService&gt; serv(do_GetService(NS_MSGDB_SERVICE_CONTRACTID));</span>
<a href="#l17.78"></a><span id="l17.78">   if (serv)</span>
<a href="#l17.79"></a><span id="l17.79">     static_cast&lt;nsMsgDBService*&gt;(serv.get())-&gt;RemoveFromCache(this);</span>
<a href="#l17.80"></a><span id="l17.80"> </span>
<a href="#l17.81"></a><span id="l17.81">   // if the db folder info refers to the mdb db, we must clear it because</span>
<a href="#l17.82"></a><span id="l17.82">   // the reference will be a dangling one soon.</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineat">@@ -1205,26 +1206,26 @@ nsresult nsMsgDatabase::Open(nsMsgDBServ</span>
<a href="#l17.84"></a><span id="l17.84"> </span>
<a href="#l17.85"></a><span id="l17.85"> nsresult nsMsgDatabase::OpenInternal(nsMsgDBService *aDBService,</span>
<a href="#l17.86"></a><span id="l17.86">                                      nsIFile *summaryFile, bool aCreate,</span>
<a href="#l17.87"></a><span id="l17.87">                                      bool aLeaveInvalidDB, bool sync)</span>
<a href="#l17.88"></a><span id="l17.88"> {</span>
<a href="#l17.89"></a><span id="l17.89">   nsAutoCString summaryFilePath;</span>
<a href="#l17.90"></a><span id="l17.90">   summaryFile-&gt;GetNativePath(summaryFilePath);</span>
<a href="#l17.91"></a><span id="l17.91"> </span>
<a href="#l17.92"></a><span id="l17.92" class="difflineminus">-  PR_LOG(DBLog, PR_LOG_ALWAYS, (&quot;nsMsgDatabase::Open(%s, %s, %p, %s)\n&quot;,</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineplus">+  MOZ_LOG(DBLog, LogLevel::Info, (&quot;nsMsgDatabase::Open(%s, %s, %p, %s)\n&quot;,</span>
<a href="#l17.94"></a><span id="l17.94">     (const char*)summaryFilePath.get(), aCreate ? &quot;TRUE&quot;:&quot;FALSE&quot;,</span>
<a href="#l17.95"></a><span id="l17.95">     this, aLeaveInvalidDB ? &quot;TRUE&quot;:&quot;FALSE&quot;));</span>
<a href="#l17.96"></a><span id="l17.96"> </span>
<a href="#l17.97"></a><span id="l17.97"> </span>
<a href="#l17.98"></a><span id="l17.98">   nsresult rv = OpenMDB(summaryFilePath.get(), aCreate, sync);</span>
<a href="#l17.99"></a><span id="l17.99">   if (NS_FAILED(rv))</span>
<a href="#l17.100"></a><span id="l17.100" class="difflineminus">-    PR_LOG(DBLog, PR_LOG_ALWAYS, (&quot;error opening db %lx&quot;, rv));</span>
<a href="#l17.101"></a><span id="l17.101" class="difflineminus">-</span>
<a href="#l17.102"></a><span id="l17.102" class="difflineminus">-  if (PR_LOG_TEST(DBLog, PR_LOG_DEBUG))</span>
<a href="#l17.103"></a><span id="l17.103" class="difflineplus">+    MOZ_LOG(DBLog, LogLevel::Info, (&quot;error opening db %lx&quot;, rv));</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineplus">+</span>
<a href="#l17.105"></a><span id="l17.105" class="difflineplus">+  if (MOZ_LOG_TEST(DBLog, LogLevel::Debug))</span>
<a href="#l17.106"></a><span id="l17.106">     aDBService-&gt;DumpCache();</span>
<a href="#l17.107"></a><span id="l17.107"> </span>
<a href="#l17.108"></a><span id="l17.108">   if (rv == NS_ERROR_FILE_TARGET_DOES_NOT_EXIST)</span>
<a href="#l17.109"></a><span id="l17.109">     return rv;</span>
<a href="#l17.110"></a><span id="l17.110"> </span>
<a href="#l17.111"></a><span id="l17.111">   m_create = aCreate;</span>
<a href="#l17.112"></a><span id="l17.112">   m_leaveInvalidDB = aLeaveInvalidDB;</span>
<a href="#l17.113"></a><span id="l17.113">   if (!sync &amp;&amp; NS_SUCCEEDED(rv))</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMsgOfflineImapOperation.cpp</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMsgOfflineImapOperation.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -1,16 +1,19 @@</span>
<a href="#l18.4"></a><span id="l18.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l18.5"></a><span id="l18.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l18.6"></a><span id="l18.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l18.7"></a><span id="l18.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l18.8"></a><span id="l18.8"> </span>
<a href="#l18.9"></a><span id="l18.9"> #include &quot;msgCore.h&quot;</span>
<a href="#l18.10"></a><span id="l18.10"> #include &quot;nsMsgOfflineImapOperation.h&quot;</span>
<a href="#l18.11"></a><span id="l18.11"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+using namespace mozilla;</span>
<a href="#l18.15"></a><span id="l18.15"> </span>
<a href="#l18.16"></a><span id="l18.16"> PRLogModuleInfo *IMAPOffline;</span>
<a href="#l18.17"></a><span id="l18.17"> </span>
<a href="#l18.18"></a><span id="l18.18"> /* Implementation file */</span>
<a href="#l18.19"></a><span id="l18.19"> NS_IMPL_ISUPPORTS(nsMsgOfflineImapOperation, nsIMsgOfflineImapOperation)</span>
<a href="#l18.20"></a><span id="l18.20"> </span>
<a href="#l18.21"></a><span id="l18.21"> // property names for offine imap operation fields.</span>
<a href="#l18.22"></a><span id="l18.22"> #define PROP_OPERATION &quot;op&quot;</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineat">@@ -59,28 +62,28 @@ NS_IMETHODIMP nsMsgOfflineImapOperation:</span>
<a href="#l18.24"></a><span id="l18.24"> {</span>
<a href="#l18.25"></a><span id="l18.25">   NS_ENSURE_ARG(aOperation);</span>
<a href="#l18.26"></a><span id="l18.26">   *aOperation = m_operation;</span>
<a href="#l18.27"></a><span id="l18.27">   return NS_OK;</span>
<a href="#l18.28"></a><span id="l18.28"> }</span>
<a href="#l18.29"></a><span id="l18.29"> </span>
<a href="#l18.30"></a><span id="l18.30"> NS_IMETHODIMP nsMsgOfflineImapOperation::SetOperation(nsOfflineImapOperationType aOperation)</span>
<a href="#l18.31"></a><span id="l18.31"> {</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineminus">-  if (PR_LOG_TEST(IMAPOffline, PR_LOG_ALWAYS))</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineminus">-    PR_LOG(IMAPOffline, PR_LOG_ALWAYS, (&quot;msg id %x setOperation was %x add %x&quot;, m_messageKey, m_operation, aOperation));</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+  if (MOZ_LOG_TEST(IMAPOffline, LogLevel::Info))</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineplus">+    MOZ_LOG(IMAPOffline, LogLevel::Info, (&quot;msg id %x setOperation was %x add %x&quot;, m_messageKey, m_operation, aOperation));</span>
<a href="#l18.36"></a><span id="l18.36"> </span>
<a href="#l18.37"></a><span id="l18.37">   m_operation |= aOperation;</span>
<a href="#l18.38"></a><span id="l18.38">   return m_mdb-&gt;SetUint32Property(m_mdbRow, PROP_OPERATION, m_operation);</span>
<a href="#l18.39"></a><span id="l18.39"> }</span>
<a href="#l18.40"></a><span id="l18.40"> </span>
<a href="#l18.41"></a><span id="l18.41"> /* void clearOperation (in nsOfflineImapOperationType operation); */</span>
<a href="#l18.42"></a><span id="l18.42"> NS_IMETHODIMP nsMsgOfflineImapOperation::ClearOperation(nsOfflineImapOperationType aOperation)</span>
<a href="#l18.43"></a><span id="l18.43"> {</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineminus">-  if (PR_LOG_TEST(IMAPOffline, PR_LOG_ALWAYS))</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineminus">-    PR_LOG(IMAPOffline, PR_LOG_ALWAYS, (&quot;msg id %x clearOperation was %x clear %x&quot;, m_messageKey, m_operation, aOperation));</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineplus">+  if (MOZ_LOG_TEST(IMAPOffline, LogLevel::Info))</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineplus">+    MOZ_LOG(IMAPOffline, LogLevel::Info, (&quot;msg id %x clearOperation was %x clear %x&quot;, m_messageKey, m_operation, aOperation));</span>
<a href="#l18.48"></a><span id="l18.48">   m_operation &amp;= ~aOperation;</span>
<a href="#l18.49"></a><span id="l18.49">   switch (aOperation)</span>
<a href="#l18.50"></a><span id="l18.50">   {</span>
<a href="#l18.51"></a><span id="l18.51">   case kMsgMoved:</span>
<a href="#l18.52"></a><span id="l18.52">   case kAppendTemplate:</span>
<a href="#l18.53"></a><span id="l18.53">   case kAppendDraft:</span>
<a href="#l18.54"></a><span id="l18.54">     m_moveDestination.Truncate();</span>
<a href="#l18.55"></a><span id="l18.55">     break;</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineat">@@ -123,18 +126,18 @@ NS_IMETHODIMP nsMsgOfflineImapOperation:</span>
<a href="#l18.57"></a><span id="l18.57"> {</span>
<a href="#l18.58"></a><span id="l18.58">   NS_ENSURE_ARG(aFlagOperation);</span>
<a href="#l18.59"></a><span id="l18.59">   *aFlagOperation = m_operationFlags;</span>
<a href="#l18.60"></a><span id="l18.60">   return NS_OK;</span>
<a href="#l18.61"></a><span id="l18.61"> }</span>
<a href="#l18.62"></a><span id="l18.62"> </span>
<a href="#l18.63"></a><span id="l18.63"> NS_IMETHODIMP nsMsgOfflineImapOperation::SetFlagOperation(imapMessageFlagsType aFlagOperation)</span>
<a href="#l18.64"></a><span id="l18.64"> {</span>
<a href="#l18.65"></a><span id="l18.65" class="difflineminus">-  if (PR_LOG_TEST(IMAPOffline, PR_LOG_ALWAYS))</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineminus">-    PR_LOG(IMAPOffline, PR_LOG_ALWAYS, (&quot;msg id %x setFlagOperation was %x add %x&quot;, m_messageKey, m_operationFlags, aFlagOperation));</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineplus">+  if (MOZ_LOG_TEST(IMAPOffline, LogLevel::Info))</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineplus">+    MOZ_LOG(IMAPOffline, LogLevel::Info, (&quot;msg id %x setFlagOperation was %x add %x&quot;, m_messageKey, m_operationFlags, aFlagOperation));</span>
<a href="#l18.69"></a><span id="l18.69">   SetOperation(kFlagsChanged);</span>
<a href="#l18.70"></a><span id="l18.70">   nsresult rv = SetNewFlags(aFlagOperation);</span>
<a href="#l18.71"></a><span id="l18.71">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.72"></a><span id="l18.72">   m_operationFlags |= aFlagOperation;</span>
<a href="#l18.73"></a><span id="l18.73">   return m_mdb-&gt;SetUint32Property(m_mdbRow, PROP_OPERATION_FLAGS, m_operationFlags);</span>
<a href="#l18.74"></a><span id="l18.74"> }</span>
<a href="#l18.75"></a><span id="l18.75"> </span>
<a href="#l18.76"></a><span id="l18.76"> /* attribute imapMessageFlagsType flagOperation; */</span>
<a href="#l18.77"></a><span id="l18.77" class="difflineat">@@ -144,36 +147,36 @@ NS_IMETHODIMP nsMsgOfflineImapOperation:</span>
<a href="#l18.78"></a><span id="l18.78">   uint32_t flags;</span>
<a href="#l18.79"></a><span id="l18.79">   nsresult rv = m_mdb-&gt;GetUint32Property(m_mdbRow, PROP_NEW_FLAGS, &amp;flags, 0);</span>
<a href="#l18.80"></a><span id="l18.80">   *aNewFlags = m_newFlags = (imapMessageFlagsType) flags;</span>
<a href="#l18.81"></a><span id="l18.81">   return rv;</span>
<a href="#l18.82"></a><span id="l18.82"> }</span>
<a href="#l18.83"></a><span id="l18.83"> </span>
<a href="#l18.84"></a><span id="l18.84"> NS_IMETHODIMP nsMsgOfflineImapOperation::SetNewFlags(imapMessageFlagsType aNewFlags)</span>
<a href="#l18.85"></a><span id="l18.85"> {</span>
<a href="#l18.86"></a><span id="l18.86" class="difflineminus">-  if (PR_LOG_TEST(IMAPOffline, PR_LOG_ALWAYS) &amp;&amp; m_newFlags != aNewFlags)</span>
<a href="#l18.87"></a><span id="l18.87" class="difflineminus">-    PR_LOG(IMAPOffline, PR_LOG_ALWAYS, (&quot;msg id %x SetNewFlags was %x to %x&quot;, m_messageKey, m_newFlags, aNewFlags));</span>
<a href="#l18.88"></a><span id="l18.88" class="difflineplus">+  if (MOZ_LOG_TEST(IMAPOffline, LogLevel::Info) &amp;&amp; m_newFlags != aNewFlags)</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineplus">+    MOZ_LOG(IMAPOffline, LogLevel::Info, (&quot;msg id %x SetNewFlags was %x to %x&quot;, m_messageKey, m_newFlags, aNewFlags));</span>
<a href="#l18.90"></a><span id="l18.90">   m_newFlags = aNewFlags;</span>
<a href="#l18.91"></a><span id="l18.91">   return m_mdb-&gt;SetUint32Property(m_mdbRow, PROP_NEW_FLAGS, m_newFlags);</span>
<a href="#l18.92"></a><span id="l18.92"> }</span>
<a href="#l18.93"></a><span id="l18.93"> </span>
<a href="#l18.94"></a><span id="l18.94"> </span>
<a href="#l18.95"></a><span id="l18.95"> /* attribute string destinationFolderURI; */</span>
<a href="#l18.96"></a><span id="l18.96"> NS_IMETHODIMP nsMsgOfflineImapOperation::GetDestinationFolderURI(char * *aDestinationFolderURI)</span>
<a href="#l18.97"></a><span id="l18.97"> {</span>
<a href="#l18.98"></a><span id="l18.98">   NS_ENSURE_ARG(aDestinationFolderURI);</span>
<a href="#l18.99"></a><span id="l18.99">   (void) m_mdb-&gt;GetProperty(m_mdbRow, PROP_MOVE_DEST_FOLDER_URI, getter_Copies(m_moveDestination));</span>
<a href="#l18.100"></a><span id="l18.100">   *aDestinationFolderURI = ToNewCString(m_moveDestination);</span>
<a href="#l18.101"></a><span id="l18.101">   return (*aDestinationFolderURI) ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l18.102"></a><span id="l18.102"> }</span>
<a href="#l18.103"></a><span id="l18.103"> </span>
<a href="#l18.104"></a><span id="l18.104"> NS_IMETHODIMP nsMsgOfflineImapOperation::SetDestinationFolderURI(const char * aDestinationFolderURI)</span>
<a href="#l18.105"></a><span id="l18.105"> {</span>
<a href="#l18.106"></a><span id="l18.106" class="difflineminus">-  if (PR_LOG_TEST(IMAPOffline, PR_LOG_ALWAYS))</span>
<a href="#l18.107"></a><span id="l18.107" class="difflineminus">-    PR_LOG(IMAPOffline, PR_LOG_ALWAYS, (&quot;msg id %x SetDestinationFolderURI to %s&quot;, m_messageKey, aDestinationFolderURI));</span>
<a href="#l18.108"></a><span id="l18.108" class="difflineplus">+  if (MOZ_LOG_TEST(IMAPOffline, LogLevel::Info))</span>
<a href="#l18.109"></a><span id="l18.109" class="difflineplus">+    MOZ_LOG(IMAPOffline, LogLevel::Info, (&quot;msg id %x SetDestinationFolderURI to %s&quot;, m_messageKey, aDestinationFolderURI));</span>
<a href="#l18.110"></a><span id="l18.110">   m_moveDestination = aDestinationFolderURI ? aDestinationFolderURI : 0;</span>
<a href="#l18.111"></a><span id="l18.111">   return m_mdb-&gt;SetProperty(m_mdbRow, PROP_MOVE_DEST_FOLDER_URI, aDestinationFolderURI);</span>
<a href="#l18.112"></a><span id="l18.112"> }</span>
<a href="#l18.113"></a><span id="l18.113"> </span>
<a href="#l18.114"></a><span id="l18.114"> /* attribute string sourceFolderURI; */</span>
<a href="#l18.115"></a><span id="l18.115"> NS_IMETHODIMP nsMsgOfflineImapOperation::GetSourceFolderURI(char * *aSourceFolderURI)</span>
<a href="#l18.116"></a><span id="l18.116"> {</span>
<a href="#l18.117"></a><span id="l18.117">   NS_ENSURE_ARG(aSourceFolderURI);</span>
<a href="#l18.118"></a><span id="l18.118" class="difflineat">@@ -338,38 +341,38 @@ NS_IMETHODIMP nsMsgOfflineImapOperation:</span>
<a href="#l18.119"></a><span id="l18.119">   return m_mdb-&gt;GetBooleanProperty(m_mdbRow, PROP_PLAYINGBACK, aPlayingBack);</span>
<a href="#l18.120"></a><span id="l18.120"> }</span>
<a href="#l18.121"></a><span id="l18.121"> </span>
<a href="#l18.122"></a><span id="l18.122"> </span>
<a href="#l18.123"></a><span id="l18.123"> void nsMsgOfflineImapOperation::Log(PRLogModuleInfo *logFile)</span>
<a href="#l18.124"></a><span id="l18.124"> {</span>
<a href="#l18.125"></a><span id="l18.125">   if (!IMAPOffline)</span>
<a href="#l18.126"></a><span id="l18.126">     IMAPOffline = PR_NewLogModule(&quot;IMAPOFFLINE&quot;);</span>
<a href="#l18.127"></a><span id="l18.127" class="difflineminus">-  if (!PR_LOG_TEST(IMAPOffline, PR_LOG_ALWAYS))</span>
<a href="#l18.128"></a><span id="l18.128" class="difflineplus">+  if (!MOZ_LOG_TEST(IMAPOffline, LogLevel::Info))</span>
<a href="#l18.129"></a><span id="l18.129">     return;</span>
<a href="#l18.130"></a><span id="l18.130">   //  const long kMoveResult              = 0x8;</span>
<a href="#l18.131"></a><span id="l18.131">   //  const long kAppendDraft           = 0x10;</span>
<a href="#l18.132"></a><span id="l18.132">   //  const long kAddedHeader           = 0x20;</span>
<a href="#l18.133"></a><span id="l18.133">   //  const long kDeletedMsg              = 0x40;</span>
<a href="#l18.134"></a><span id="l18.134">   //  const long kMsgMarkedDeleted = 0x80;</span>
<a href="#l18.135"></a><span id="l18.135">   //  const long kAppendTemplate      = 0x100;</span>
<a href="#l18.136"></a><span id="l18.136">   //  const long kDeleteAllMsgs          = 0x200;</span>
<a href="#l18.137"></a><span id="l18.137">   if (m_operation &amp; nsIMsgOfflineImapOperation::kFlagsChanged)</span>
<a href="#l18.138"></a><span id="l18.138" class="difflineminus">-    PR_LOG(IMAPOffline, PR_LOG_ALWAYS, (&quot;msg id %x changeFlag:%x&quot;, m_messageKey, m_newFlags));</span>
<a href="#l18.139"></a><span id="l18.139" class="difflineplus">+    MOZ_LOG(IMAPOffline, LogLevel::Info, (&quot;msg id %x changeFlag:%x&quot;, m_messageKey, m_newFlags));</span>
<a href="#l18.140"></a><span id="l18.140">   if (m_operation &amp; nsIMsgOfflineImapOperation::kMsgMoved)</span>
<a href="#l18.141"></a><span id="l18.141">   {</span>
<a href="#l18.142"></a><span id="l18.142">     nsCString moveDestFolder;</span>
<a href="#l18.143"></a><span id="l18.143">     GetDestinationFolderURI(getter_Copies(moveDestFolder));</span>
<a href="#l18.144"></a><span id="l18.144" class="difflineminus">-    PR_LOG(IMAPOffline, PR_LOG_ALWAYS, (&quot;msg id %x moveTo:%s&quot;, m_messageKey, moveDestFolder.get()));</span>
<a href="#l18.145"></a><span id="l18.145" class="difflineplus">+    MOZ_LOG(IMAPOffline, LogLevel::Info, (&quot;msg id %x moveTo:%s&quot;, m_messageKey, moveDestFolder.get()));</span>
<a href="#l18.146"></a><span id="l18.146">   }</span>
<a href="#l18.147"></a><span id="l18.147">   if (m_operation &amp; nsIMsgOfflineImapOperation::kMsgCopy)</span>
<a href="#l18.148"></a><span id="l18.148">   {</span>
<a href="#l18.149"></a><span id="l18.149">     nsCString copyDests;</span>
<a href="#l18.150"></a><span id="l18.150">     m_mdb-&gt;GetProperty(m_mdbRow, PROP_COPY_DESTS, getter_Copies(copyDests));</span>
<a href="#l18.151"></a><span id="l18.151" class="difflineminus">-    PR_LOG(IMAPOffline, PR_LOG_ALWAYS, (&quot;msg id %x moveTo:%s&quot;, m_messageKey, copyDests.get()));</span>
<a href="#l18.152"></a><span id="l18.152" class="difflineplus">+    MOZ_LOG(IMAPOffline, LogLevel::Info, (&quot;msg id %x moveTo:%s&quot;, m_messageKey, copyDests.get()));</span>
<a href="#l18.153"></a><span id="l18.153">   }</span>
<a href="#l18.154"></a><span id="l18.154">   if (m_operation &amp; nsIMsgOfflineImapOperation::kAppendDraft)</span>
<a href="#l18.155"></a><span id="l18.155" class="difflineminus">-    PR_LOG(IMAPOffline, PR_LOG_ALWAYS, (&quot;msg id %x append draft&quot;, m_messageKey));</span>
<a href="#l18.156"></a><span id="l18.156" class="difflineplus">+    MOZ_LOG(IMAPOffline, LogLevel::Info, (&quot;msg id %x append draft&quot;, m_messageKey));</span>
<a href="#l18.157"></a><span id="l18.157">   if (m_operation &amp; nsIMsgOfflineImapOperation::kAddKeywords)</span>
<a href="#l18.158"></a><span id="l18.158" class="difflineminus">-    PR_LOG(IMAPOffline, PR_LOG_ALWAYS, (&quot;msg id %x add keyword:%s&quot;, m_messageKey, m_keywordsToAdd.get()));</span>
<a href="#l18.159"></a><span id="l18.159" class="difflineplus">+    MOZ_LOG(IMAPOffline, LogLevel::Info, (&quot;msg id %x add keyword:%s&quot;, m_messageKey, m_keywordsToAdd.get()));</span>
<a href="#l18.160"></a><span id="l18.160">   if (m_operation &amp; nsIMsgOfflineImapOperation::kRemoveKeywords)</span>
<a href="#l18.161"></a><span id="l18.161" class="difflineminus">-    PR_LOG(IMAPOffline, PR_LOG_ALWAYS, (&quot;msg id %x remove keyword:%s&quot;, m_messageKey, m_keywordsToRemove.get()));</span>
<a href="#l18.162"></a><span id="l18.162" class="difflineplus">+    MOZ_LOG(IMAPOffline, LogLevel::Info, (&quot;msg id %x remove keyword:%s&quot;, m_messageKey, m_keywordsToRemove.get()));</span>
<a href="#l18.163"></a><span id="l18.163"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -7,31 +7,33 @@</span>
<a href="#l19.4"></a><span id="l19.4"> #include &quot;nsIInputStream.h&quot;</span>
<a href="#l19.5"></a><span id="l19.5"> #include &quot;nsIStreamListener.h&quot;</span>
<a href="#l19.6"></a><span id="l19.6"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l19.7"></a><span id="l19.7"> #include &quot;nsQuickSort.h&quot;</span>
<a href="#l19.8"></a><span id="l19.8"> #include &quot;nsIMsgMessageService.h&quot;</span>
<a href="#l19.9"></a><span id="l19.9"> #include &quot;nsMsgUtils.h&quot; // for GetMessageServiceFromURI</span>
<a href="#l19.10"></a><span id="l19.10"> #include &quot;prnetdb.h&quot;</span>
<a href="#l19.11"></a><span id="l19.11"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-#include &quot;prlog.h&quot;</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l19.14"></a><span id="l19.14"> #include &quot;nsAppDirectoryServiceDefs.h&quot;</span>
<a href="#l19.15"></a><span id="l19.15"> #include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l19.16"></a><span id="l19.16"> #include &quot;nsDirectoryServiceUtils.h&quot;</span>
<a href="#l19.17"></a><span id="l19.17"> #include &quot;nsIMIMEHeaderParam.h&quot;</span>
<a href="#l19.18"></a><span id="l19.18"> #include &quot;nsNetCID.h&quot;</span>
<a href="#l19.19"></a><span id="l19.19"> #include &quot;nsIMimeHeaders.h&quot;</span>
<a href="#l19.20"></a><span id="l19.20"> #include &quot;nsMsgMimeCID.h&quot;</span>
<a href="#l19.21"></a><span id="l19.21"> #include &quot;nsIMsgMailNewsUrl.h&quot;</span>
<a href="#l19.22"></a><span id="l19.22"> #include &quot;nsIMimeMiscStatus.h&quot;</span>
<a href="#l19.23"></a><span id="l19.23"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l19.24"></a><span id="l19.24"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l19.25"></a><span id="l19.25"> #include &quot;nsIStringEnumerator.h&quot;</span>
<a href="#l19.26"></a><span id="l19.26"> #include &quot;nsIObserverService.h&quot;</span>
<a href="#l19.27"></a><span id="l19.27"> </span>
<a href="#l19.28"></a><span id="l19.28" class="difflineplus">+using namespace mozilla;</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineplus">+</span>
<a href="#l19.30"></a><span id="l19.30"> // needed to mark attachment flag on the db hdr</span>
<a href="#l19.31"></a><span id="l19.31"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l19.32"></a><span id="l19.32"> </span>
<a href="#l19.33"></a><span id="l19.33"> // needed to strip html out of the body</span>
<a href="#l19.34"></a><span id="l19.34"> #include &quot;nsIContentSerializer.h&quot;</span>
<a href="#l19.35"></a><span id="l19.35"> #include &quot;nsLayoutCID.h&quot;</span>
<a href="#l19.36"></a><span id="l19.36"> #include &quot;nsIParserUtils.h&quot;</span>
<a href="#l19.37"></a><span id="l19.37"> #include &quot;nsIDocumentEncoder.h&quot;</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineat">@@ -190,45 +192,45 @@ inline BaseToken* TokenHash::get(const c</span>
<a href="#l19.39"></a><span id="l19.39"> BaseToken* TokenHash::add(const char* word)</span>
<a href="#l19.40"></a><span id="l19.40"> {</span>
<a href="#l19.41"></a><span id="l19.41">     if (!word || !*word)</span>
<a href="#l19.42"></a><span id="l19.42">     {</span>
<a href="#l19.43"></a><span id="l19.43">       NS_ERROR(&quot;Trying to add a null word&quot;);</span>
<a href="#l19.44"></a><span id="l19.44">       return nullptr;</span>
<a href="#l19.45"></a><span id="l19.45">     }</span>
<a href="#l19.46"></a><span id="l19.46"> </span>
<a href="#l19.47"></a><span id="l19.47" class="difflineminus">-    PR_LOG(BayesianFilterLogModule, PR_LOG_DEBUG, (&quot;add word: %s&quot;, word));</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineplus">+    MOZ_LOG(BayesianFilterLogModule, LogLevel::Debug, (&quot;add word: %s&quot;, word));</span>
<a href="#l19.49"></a><span id="l19.49"> </span>
<a href="#l19.50"></a><span id="l19.50">     PLDHashEntryHdr* entry = PL_DHashTableAdd(&amp;mTokenTable, word, mozilla::fallible);</span>
<a href="#l19.51"></a><span id="l19.51">     BaseToken* token = static_cast&lt;BaseToken*&gt;(entry);</span>
<a href="#l19.52"></a><span id="l19.52">     if (token) {</span>
<a href="#l19.53"></a><span id="l19.53">         if (token-&gt;mWord == NULL) {</span>
<a href="#l19.54"></a><span id="l19.54">             uint32_t len = strlen(word);</span>
<a href="#l19.55"></a><span id="l19.55">             NS_ASSERTION(len != 0, &quot;adding zero length word to tokenizer&quot;);</span>
<a href="#l19.56"></a><span id="l19.56">             if (!len)</span>
<a href="#l19.57"></a><span id="l19.57" class="difflineminus">-              PR_LOG(BayesianFilterLogModule, PR_LOG_DEBUG, (&quot;adding zero length word to tokenizer&quot;));</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineplus">+              MOZ_LOG(BayesianFilterLogModule, LogLevel::Debug, (&quot;adding zero length word to tokenizer&quot;));</span>
<a href="#l19.59"></a><span id="l19.59">             token-&gt;mWord = copyWord(word, len);</span>
<a href="#l19.60"></a><span id="l19.60">             NS_ASSERTION(token-&gt;mWord, &quot;copyWord failed&quot;);</span>
<a href="#l19.61"></a><span id="l19.61">             if (!token-&gt;mWord) {</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineminus">-                PR_LOG(BayesianFilterLogModule, PR_LOG_ERROR, (&quot;copyWord failed: %s (%d)&quot;, word, len));</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineplus">+                MOZ_LOG(BayesianFilterLogModule, LogLevel::Error, (&quot;copyWord failed: %s (%d)&quot;, word, len));</span>
<a href="#l19.64"></a><span id="l19.64">                 PL_DHashTableRawRemove(&amp;mTokenTable, entry);</span>
<a href="#l19.65"></a><span id="l19.65">                 return NULL;</span>
<a href="#l19.66"></a><span id="l19.66">             }</span>
<a href="#l19.67"></a><span id="l19.67">         }</span>
<a href="#l19.68"></a><span id="l19.68">     }</span>
<a href="#l19.69"></a><span id="l19.69">     return token;</span>
<a href="#l19.70"></a><span id="l19.70"> }</span>
<a href="#l19.71"></a><span id="l19.71"> </span>
<a href="#l19.72"></a><span id="l19.72"> void TokenHash::visit(bool (*f) (BaseToken*, void*), void* data)</span>
<a href="#l19.73"></a><span id="l19.73"> {</span>
<a href="#l19.74"></a><span id="l19.74">     VisitClosure closure = { f, data };</span>
<a href="#l19.75"></a><span id="l19.75">     uint32_t visitCount = PL_DHashTableEnumerate(&amp;mTokenTable, VisitEntry, &amp;closure);</span>
<a href="#l19.76"></a><span id="l19.76">     NS_ASSERTION(visitCount == mTokenTable.EntryCount(), &quot;visitCount != entryCount!&quot;);</span>
<a href="#l19.77"></a><span id="l19.77">     if (visitCount != mTokenTable.EntryCount()) {</span>
<a href="#l19.78"></a><span id="l19.78" class="difflineminus">-      PR_LOG(BayesianFilterLogModule, PR_LOG_ERROR, (&quot;visitCount != entryCount!: %d vs %d&quot;, visitCount, mTokenTable.EntryCount()));</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineplus">+      MOZ_LOG(BayesianFilterLogModule, LogLevel::Error, (&quot;visitCount != entryCount!: %d vs %d&quot;, visitCount, mTokenTable.EntryCount()));</span>
<a href="#l19.80"></a><span id="l19.80">     }</span>
<a href="#l19.81"></a><span id="l19.81"> }</span>
<a href="#l19.82"></a><span id="l19.82"> </span>
<a href="#l19.83"></a><span id="l19.83"> inline uint32_t TokenHash::countTokens()</span>
<a href="#l19.84"></a><span id="l19.84"> {</span>
<a href="#l19.85"></a><span id="l19.85">   return mTokenTable.EntryCount();</span>
<a href="#l19.86"></a><span id="l19.86"> }</span>
<a href="#l19.87"></a><span id="l19.87"> </span>
<a href="#l19.88"></a><span id="l19.88" class="difflineat">@@ -357,24 +359,24 @@ Tokenizer::~Tokenizer()</span>
<a href="#l19.89"></a><span id="l19.89"> </span>
<a href="#l19.90"></a><span id="l19.90"> inline Token* Tokenizer::get(const char* word)</span>
<a href="#l19.91"></a><span id="l19.91"> {</span>
<a href="#l19.92"></a><span id="l19.92">   return static_cast&lt;Token*&gt;(TokenHash::get(word));</span>
<a href="#l19.93"></a><span id="l19.93"> }</span>
<a href="#l19.94"></a><span id="l19.94"> </span>
<a href="#l19.95"></a><span id="l19.95"> Token* Tokenizer::add(const char* word, uint32_t count)</span>
<a href="#l19.96"></a><span id="l19.96"> {</span>
<a href="#l19.97"></a><span id="l19.97" class="difflineminus">-  PR_LOG(BayesianFilterLogModule, PR_LOG_DEBUG, (&quot;add word: %s (count=%d)&quot;,</span>
<a href="#l19.98"></a><span id="l19.98" class="difflineplus">+  MOZ_LOG(BayesianFilterLogModule, LogLevel::Debug, (&quot;add word: %s (count=%d)&quot;,</span>
<a href="#l19.99"></a><span id="l19.99">          word, count));</span>
<a href="#l19.100"></a><span id="l19.100"> </span>
<a href="#l19.101"></a><span id="l19.101">   Token* token = static_cast&lt;Token*&gt;(TokenHash::add(word));</span>
<a href="#l19.102"></a><span id="l19.102">   if (token)</span>
<a href="#l19.103"></a><span id="l19.103">   {</span>
<a href="#l19.104"></a><span id="l19.104">     token-&gt;mCount += count; // hash code initializes this to zero</span>
<a href="#l19.105"></a><span id="l19.105" class="difflineminus">-    PR_LOG(BayesianFilterLogModule, PR_LOG_DEBUG,</span>
<a href="#l19.106"></a><span id="l19.106" class="difflineplus">+    MOZ_LOG(BayesianFilterLogModule, LogLevel::Debug,</span>
<a href="#l19.107"></a><span id="l19.107">            (&quot;adding word to tokenizer: %s (count=%d) (mCount=%d)&quot;,</span>
<a href="#l19.108"></a><span id="l19.108">            word, count, token-&gt;mCount));</span>
<a href="#l19.109"></a><span id="l19.109">   }</span>
<a href="#l19.110"></a><span id="l19.110">   return token;</span>
<a href="#l19.111"></a><span id="l19.111"> }</span>
<a href="#l19.112"></a><span id="l19.112"> </span>
<a href="#l19.113"></a><span id="l19.113"> static bool isDecimalNumber(const char* word)</span>
<a href="#l19.114"></a><span id="l19.114"> {</span>
<a href="#l19.115"></a><span id="l19.115" class="difflineat">@@ -688,17 +690,17 @@ static bool isFWNumeral(const char16_t* </span>
<a href="#l19.116"></a><span id="l19.116">       return false;</span>
<a href="#l19.117"></a><span id="l19.117"> </span>
<a href="#l19.118"></a><span id="l19.118">   return true;</span>
<a href="#l19.119"></a><span id="l19.119"> }</span>
<a href="#l19.120"></a><span id="l19.120"> </span>
<a href="#l19.121"></a><span id="l19.121"> // The japanese tokenizer was added as part of Bug #277354</span>
<a href="#l19.122"></a><span id="l19.122"> void Tokenizer::tokenize_japanese_word(char* chunk)</span>
<a href="#l19.123"></a><span id="l19.123"> {</span>
<a href="#l19.124"></a><span id="l19.124" class="difflineminus">-  PR_LOG(BayesianFilterLogModule, PR_LOG_DEBUG, (&quot;entering tokenize_japanese_word(%s)&quot;, chunk));</span>
<a href="#l19.125"></a><span id="l19.125" class="difflineplus">+  MOZ_LOG(BayesianFilterLogModule, LogLevel::Debug, (&quot;entering tokenize_japanese_word(%s)&quot;, chunk));</span>
<a href="#l19.126"></a><span id="l19.126"> </span>
<a href="#l19.127"></a><span id="l19.127">   nsString srcStr = NS_ConvertUTF8toUTF16(chunk);</span>
<a href="#l19.128"></a><span id="l19.128">   const char16_t* p1 = srcStr.get();</span>
<a href="#l19.129"></a><span id="l19.129">   const char16_t* p2 = p1;</span>
<a href="#l19.130"></a><span id="l19.130">   if(!*p2) return;</span>
<a href="#l19.131"></a><span id="l19.131"> </span>
<a href="#l19.132"></a><span id="l19.132">   char_class cc = getCharClass(*p2);</span>
<a href="#l19.133"></a><span id="l19.133">   while(*(++p2))</span>
<a href="#l19.134"></a><span id="l19.134" class="difflineat">@@ -728,17 +730,17 @@ nsresult Tokenizer::stripHTML(const nsAS</span>
<a href="#l19.135"></a><span id="l19.135">                  | nsIDocumentEncoder::OutputBodyOnly;</span>
<a href="#l19.136"></a><span id="l19.136">   nsCOMPtr&lt;nsIParserUtils&gt; utils =</span>
<a href="#l19.137"></a><span id="l19.137">     do_GetService(NS_PARSERUTILS_CONTRACTID);</span>
<a href="#l19.138"></a><span id="l19.138">   return utils-&gt;ConvertToPlainText(inString, flags, 80, outString);</span>
<a href="#l19.139"></a><span id="l19.139"> }</span>
<a href="#l19.140"></a><span id="l19.140"> </span>
<a href="#l19.141"></a><span id="l19.141"> void Tokenizer::tokenize(const char* aText)</span>
<a href="#l19.142"></a><span id="l19.142"> {</span>
<a href="#l19.143"></a><span id="l19.143" class="difflineminus">-  PR_LOG(BayesianFilterLogModule, PR_LOG_DEBUG, (&quot;tokenize: %s&quot;, aText));</span>
<a href="#l19.144"></a><span id="l19.144" class="difflineplus">+  MOZ_LOG(BayesianFilterLogModule, LogLevel::Debug, (&quot;tokenize: %s&quot;, aText));</span>
<a href="#l19.145"></a><span id="l19.145"> </span>
<a href="#l19.146"></a><span id="l19.146">   // strip out HTML tags before we begin processing</span>
<a href="#l19.147"></a><span id="l19.147">   // uggh but first we have to blow up our string into UCS2</span>
<a href="#l19.148"></a><span id="l19.148">   // since that's what the document encoder wants. UTF8/UCS2, I wish we all</span>
<a href="#l19.149"></a><span id="l19.149">   // spoke the same language here..</span>
<a href="#l19.150"></a><span id="l19.150">   nsString text = NS_ConvertUTF8toUTF16(aText);</span>
<a href="#l19.151"></a><span id="l19.151">   nsString strippedUCS2;</span>
<a href="#l19.152"></a><span id="l19.152"> </span>
<a href="#l19.153"></a><span id="l19.153" class="difflineat">@@ -764,17 +766,17 @@ void Tokenizer::tokenize(const char* aTe</span>
<a href="#l19.154"></a><span id="l19.154">   while (substr_start != substr_end) {</span>
<a href="#l19.155"></a><span id="l19.155">     if (*substr_start == 0x3000)</span>
<a href="#l19.156"></a><span id="l19.156">         *substr_start = 0x0020;</span>
<a href="#l19.157"></a><span id="l19.157">     ++substr_start;</span>
<a href="#l19.158"></a><span id="l19.158">   }</span>
<a href="#l19.159"></a><span id="l19.159"> </span>
<a href="#l19.160"></a><span id="l19.160">   nsCString strippedStr = NS_ConvertUTF16toUTF8(strippedUCS2);</span>
<a href="#l19.161"></a><span id="l19.161">   char * strippedText = strippedStr.BeginWriting();</span>
<a href="#l19.162"></a><span id="l19.162" class="difflineminus">-  PR_LOG(BayesianFilterLogModule, PR_LOG_DEBUG, (&quot;tokenize stripped html: %s&quot;, strippedText));</span>
<a href="#l19.163"></a><span id="l19.163" class="difflineplus">+  MOZ_LOG(BayesianFilterLogModule, LogLevel::Debug, (&quot;tokenize stripped html: %s&quot;, strippedText));</span>
<a href="#l19.164"></a><span id="l19.164"> </span>
<a href="#l19.165"></a><span id="l19.165">   char* word;</span>
<a href="#l19.166"></a><span id="l19.166">   char* next = strippedText;</span>
<a href="#l19.167"></a><span id="l19.167">   while ((word = NS_strtok(mBodyDelimiters.get(), &amp;next)) != NULL) {</span>
<a href="#l19.168"></a><span id="l19.168">     if (!*word) continue;</span>
<a href="#l19.169"></a><span id="l19.169">     if (isDecimalNumber(word)) continue;</span>
<a href="#l19.170"></a><span id="l19.170">     if (isASCII(word))</span>
<a href="#l19.171"></a><span id="l19.171">         tokenize_ascii_word(word);</span>
<a href="#l19.172"></a><span id="l19.172" class="difflineat">@@ -1108,17 +1110,17 @@ NS_IMETHODIMP TokenStreamListener::OnSto</span>
<a href="#l19.173"></a><span id="l19.173"> {</span>
<a href="#l19.174"></a><span id="l19.174">     if (mLeftOverCount) {</span>
<a href="#l19.175"></a><span id="l19.175">         /* assume final buffer is complete. */</span>
<a href="#l19.176"></a><span id="l19.176">         mBuffer[mLeftOverCount] = '\0';</span>
<a href="#l19.177"></a><span id="l19.177">         mTokenizer.tokenize(mBuffer);</span>
<a href="#l19.178"></a><span id="l19.178">     }</span>
<a href="#l19.179"></a><span id="l19.179"> </span>
<a href="#l19.180"></a><span id="l19.180">     /* finally, analyze the tokenized message. */</span>
<a href="#l19.181"></a><span id="l19.181" class="difflineminus">-    PR_LOG(BayesianFilterLogModule, PR_LOG_DEBUG, (&quot;analyze the tokenized message&quot;));</span>
<a href="#l19.182"></a><span id="l19.182" class="difflineplus">+    MOZ_LOG(BayesianFilterLogModule, LogLevel::Debug, (&quot;analyze the tokenized message&quot;));</span>
<a href="#l19.183"></a><span id="l19.183">     if (mAnalyzer)</span>
<a href="#l19.184"></a><span id="l19.184">         mAnalyzer-&gt;analyzeTokens(mTokenizer);</span>
<a href="#l19.185"></a><span id="l19.185"> </span>
<a href="#l19.186"></a><span id="l19.186">     return NS_OK;</span>
<a href="#l19.187"></a><span id="l19.187"> }</span>
<a href="#l19.188"></a><span id="l19.188"> </span>
<a href="#l19.189"></a><span id="l19.189"> /* Implementation file */</span>
<a href="#l19.190"></a><span id="l19.190"> </span>
<a href="#l19.191"></a><span id="l19.191" class="difflineat">@@ -1137,17 +1139,17 @@ nsBayesianFilter::nsBayesianFilter()</span>
<a href="#l19.192"></a><span id="l19.192">     nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l19.193"></a><span id="l19.193">     if (pPrefBranch)</span>
<a href="#l19.194"></a><span id="l19.194">       pPrefBranch-&gt;GetIntPref(&quot;mail.adaptivefilters.junk_threshold&quot;, &amp;junkThreshold);</span>
<a href="#l19.195"></a><span id="l19.195"> </span>
<a href="#l19.196"></a><span id="l19.196">     mJunkProbabilityThreshold = (static_cast&lt;double&gt;(junkThreshold)) / 100.0;</span>
<a href="#l19.197"></a><span id="l19.197">     if (mJunkProbabilityThreshold == 0 || mJunkProbabilityThreshold &gt;= 1)</span>
<a href="#l19.198"></a><span id="l19.198">       mJunkProbabilityThreshold = kDefaultJunkThreshold;</span>
<a href="#l19.199"></a><span id="l19.199"> </span>
<a href="#l19.200"></a><span id="l19.200" class="difflineminus">-    PR_LOG(BayesianFilterLogModule, PR_LOG_WARNING, (&quot;junk probability threshold: %f&quot;, mJunkProbabilityThreshold));</span>
<a href="#l19.201"></a><span id="l19.201" class="difflineplus">+    MOZ_LOG(BayesianFilterLogModule, LogLevel::Warning, (&quot;junk probability threshold: %f&quot;, mJunkProbabilityThreshold));</span>
<a href="#l19.202"></a><span id="l19.202"> </span>
<a href="#l19.203"></a><span id="l19.203">     mCorpus.readTrainingData();</span>
<a href="#l19.204"></a><span id="l19.204"> </span>
<a href="#l19.205"></a><span id="l19.205">     // get parameters for training data flushing, from the prefs</span>
<a href="#l19.206"></a><span id="l19.206"> </span>
<a href="#l19.207"></a><span id="l19.207">     nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch;</span>
<a href="#l19.208"></a><span id="l19.208"> </span>
<a href="#l19.209"></a><span id="l19.209">     nsCOMPtr&lt;nsIPrefService&gt; prefs = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l19.210"></a><span id="l19.210" class="difflineat">@@ -1158,17 +1160,17 @@ nsBayesianFilter::nsBayesianFilter()</span>
<a href="#l19.211"></a><span id="l19.211">     rv = prefBranch-&gt;GetIntPref(&quot;mailnews.bayesian_spam_filter.flush.minimum_interval&quot;,&amp;mMinFlushInterval);</span>
<a href="#l19.212"></a><span id="l19.212">     // it is not a good idea to allow a minimum interval of under 1 second</span>
<a href="#l19.213"></a><span id="l19.213">     if (NS_FAILED(rv) || (mMinFlushInterval &lt;= 1000) )</span>
<a href="#l19.214"></a><span id="l19.214">         mMinFlushInterval = DEFAULT_MIN_INTERVAL_BETWEEN_WRITES;</span>
<a href="#l19.215"></a><span id="l19.215"> </span>
<a href="#l19.216"></a><span id="l19.216">     rv = prefBranch-&gt;GetIntPref(&quot;mailnews.bayesian_spam_filter.junk_maxtokens&quot;, &amp;mMaximumTokenCount);</span>
<a href="#l19.217"></a><span id="l19.217">     if (NS_FAILED(rv))</span>
<a href="#l19.218"></a><span id="l19.218">       mMaximumTokenCount = 0; // which means do not limit token counts</span>
<a href="#l19.219"></a><span id="l19.219" class="difflineminus">-    PR_LOG(BayesianFilterLogModule, PR_LOG_WARNING, (&quot;maximum junk tokens: %d&quot;, mMaximumTokenCount));</span>
<a href="#l19.220"></a><span id="l19.220" class="difflineplus">+    MOZ_LOG(BayesianFilterLogModule, LogLevel::Warning, (&quot;maximum junk tokens: %d&quot;, mMaximumTokenCount));</span>
<a href="#l19.221"></a><span id="l19.221"> </span>
<a href="#l19.222"></a><span id="l19.222">     mTimer = do_CreateInstance(NS_TIMER_CONTRACTID, &amp;rv);</span>
<a href="#l19.223"></a><span id="l19.223">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;unable to create a timer; training data will only be written on exit&quot;);</span>
<a href="#l19.224"></a><span id="l19.224"> </span>
<a href="#l19.225"></a><span id="l19.225">     // the timer is not used on object construction, since for</span>
<a href="#l19.226"></a><span id="l19.226">     // the time being there are no dirying messages</span>
<a href="#l19.227"></a><span id="l19.227"> </span>
<a href="#l19.228"></a><span id="l19.228">     // give a default capacity to the memory structure used to store</span>
<a href="#l19.229"></a><span id="l19.229" class="difflineat">@@ -1288,17 +1290,17 @@ public:</span>
<a href="#l19.230"></a><span id="l19.230">         tokenizer.clearTokens();</span>
<a href="#l19.231"></a><span id="l19.231">         classifyNextMessage();</span>
<a href="#l19.232"></a><span id="l19.232">     }</span>
<a href="#l19.233"></a><span id="l19.233"> </span>
<a href="#l19.234"></a><span id="l19.234">     virtual void classifyNextMessage()</span>
<a href="#l19.235"></a><span id="l19.235">     {</span>
<a href="#l19.236"></a><span id="l19.236"> </span>
<a href="#l19.237"></a><span id="l19.237">       if (++mCurMessageToClassify &lt; mNumMessagesToClassify &amp;&amp; mMessageURIs[mCurMessageToClassify]) {</span>
<a href="#l19.238"></a><span id="l19.238" class="difflineminus">-        PR_LOG(BayesianFilterLogModule, PR_LOG_WARNING, (&quot;classifyNextMessage(%s)&quot;, mMessageURIs[mCurMessageToClassify]));</span>
<a href="#l19.239"></a><span id="l19.239" class="difflineplus">+        MOZ_LOG(BayesianFilterLogModule, LogLevel::Warning, (&quot;classifyNextMessage(%s)&quot;, mMessageURIs[mCurMessageToClassify]));</span>
<a href="#l19.240"></a><span id="l19.240">         mFilter-&gt;tokenizeMessage(mMessageURIs[mCurMessageToClassify], mMsgWindow, this);</span>
<a href="#l19.241"></a><span id="l19.241">       }</span>
<a href="#l19.242"></a><span id="l19.242">       else</span>
<a href="#l19.243"></a><span id="l19.243">       {</span>
<a href="#l19.244"></a><span id="l19.244">         // call all listeners with null parameters to signify end of batch</span>
<a href="#l19.245"></a><span id="l19.245">         if (mJunkListener)</span>
<a href="#l19.246"></a><span id="l19.246">           mJunkListener-&gt;OnMessageClassified(nullptr, nsIJunkMailPlugin::UNCLASSIFIED, 0);</span>
<a href="#l19.247"></a><span id="l19.247">         if (mTraitListener)</span>
<a href="#l19.248"></a><span id="l19.248" class="difflineat">@@ -1446,17 +1448,17 @@ void nsBayesianFilter::classifyMessage(</span>
<a href="#l19.249"></a><span id="l19.249">       antiAliasArrays.SetCapacity(traitCount);</span>
<a href="#l19.250"></a><span id="l19.250">     }</span>
<a href="#l19.251"></a><span id="l19.251"> </span>
<a href="#l19.252"></a><span id="l19.252">     nsresult rv;</span>
<a href="#l19.253"></a><span id="l19.253">     nsCOMPtr&lt;nsIMsgTraitService&gt; traitService(do_GetService(&quot;@mozilla.org/msg-trait-service;1&quot;, &amp;rv));</span>
<a href="#l19.254"></a><span id="l19.254">     if (NS_FAILED(rv))</span>
<a href="#l19.255"></a><span id="l19.255">     {</span>
<a href="#l19.256"></a><span id="l19.256">       NS_ERROR(&quot;Failed to get trait service&quot;);</span>
<a href="#l19.257"></a><span id="l19.257" class="difflineminus">-      PR_LOG(BayesianFilterLogModule, PR_LOG_ERROR, (&quot;Failed to get trait service&quot;));</span>
<a href="#l19.258"></a><span id="l19.258" class="difflineplus">+      MOZ_LOG(BayesianFilterLogModule, LogLevel::Error, (&quot;Failed to get trait service&quot;));</span>
<a href="#l19.259"></a><span id="l19.259">     }</span>
<a href="#l19.260"></a><span id="l19.260"> </span>
<a href="#l19.261"></a><span id="l19.261">     // get aliases and message counts for the pro and anti traits</span>
<a href="#l19.262"></a><span id="l19.262">     for (uint32_t traitIndex = 0; traitIndex &lt; traitCount; traitIndex++)</span>
<a href="#l19.263"></a><span id="l19.263">     {</span>
<a href="#l19.264"></a><span id="l19.264">       nsresult rv;</span>
<a href="#l19.265"></a><span id="l19.265"> </span>
<a href="#l19.266"></a><span id="l19.266">       // pro trait</span>
<a href="#l19.267"></a><span id="l19.267" class="difflineat">@@ -1464,17 +1466,17 @@ void nsBayesianFilter::classifyMessage(</span>
<a href="#l19.268"></a><span id="l19.268">       uint32_t* proAliases = nullptr;</span>
<a href="#l19.269"></a><span id="l19.269">       uint32_t proTrait = aProTraits[traitIndex];</span>
<a href="#l19.270"></a><span id="l19.270">       if (traitService)</span>
<a href="#l19.271"></a><span id="l19.271">       {</span>
<a href="#l19.272"></a><span id="l19.272">         rv = traitService-&gt;GetAliases(proTrait, &amp;proAliasesLength, &amp;proAliases);</span>
<a href="#l19.273"></a><span id="l19.273">         if (NS_FAILED(rv))</span>
<a href="#l19.274"></a><span id="l19.274">         {</span>
<a href="#l19.275"></a><span id="l19.275">           NS_ERROR(&quot;trait service failed to get aliases&quot;);</span>
<a href="#l19.276"></a><span id="l19.276" class="difflineminus">-          PR_LOG(BayesianFilterLogModule, PR_LOG_ERROR, (&quot;trait service failed to get aliases&quot;));</span>
<a href="#l19.277"></a><span id="l19.277" class="difflineplus">+          MOZ_LOG(BayesianFilterLogModule, LogLevel::Error, (&quot;trait service failed to get aliases&quot;));</span>
<a href="#l19.278"></a><span id="l19.278">         }</span>
<a href="#l19.279"></a><span id="l19.279">       }</span>
<a href="#l19.280"></a><span id="l19.280">       proAliasesLengths.AppendElement(proAliasesLength);</span>
<a href="#l19.281"></a><span id="l19.281">       proAliasArrays.AppendElement(proAliases);</span>
<a href="#l19.282"></a><span id="l19.282">       uint32_t proMessageCount = mCorpus.getMessageCount(proTrait);</span>
<a href="#l19.283"></a><span id="l19.283">       for (uint32_t aliasIndex = 0; aliasIndex &lt; proAliasesLength; aliasIndex++)</span>
<a href="#l19.284"></a><span id="l19.284">         proMessageCount += mCorpus.getMessageCount(proAliases[aliasIndex]);</span>
<a href="#l19.285"></a><span id="l19.285">       numProMessages.AppendElement(proMessageCount);</span>
<a href="#l19.286"></a><span id="l19.286" class="difflineat">@@ -1484,17 +1486,17 @@ void nsBayesianFilter::classifyMessage(</span>
<a href="#l19.287"></a><span id="l19.287">       uint32_t* antiAliases = nullptr;</span>
<a href="#l19.288"></a><span id="l19.288">       uint32_t antiTrait = aAntiTraits[traitIndex];</span>
<a href="#l19.289"></a><span id="l19.289">       if (traitService)</span>
<a href="#l19.290"></a><span id="l19.290">       {</span>
<a href="#l19.291"></a><span id="l19.291">         rv = traitService-&gt;GetAliases(antiTrait, &amp;antiAliasesLength, &amp;antiAliases);</span>
<a href="#l19.292"></a><span id="l19.292">         if (NS_FAILED(rv))</span>
<a href="#l19.293"></a><span id="l19.293">         {</span>
<a href="#l19.294"></a><span id="l19.294">           NS_ERROR(&quot;trait service failed to get aliases&quot;);</span>
<a href="#l19.295"></a><span id="l19.295" class="difflineminus">-          PR_LOG(BayesianFilterLogModule, PR_LOG_ERROR, (&quot;trait service failed to get aliases&quot;));</span>
<a href="#l19.296"></a><span id="l19.296" class="difflineplus">+          MOZ_LOG(BayesianFilterLogModule, LogLevel::Error, (&quot;trait service failed to get aliases&quot;));</span>
<a href="#l19.297"></a><span id="l19.297">         }</span>
<a href="#l19.298"></a><span id="l19.298">       }</span>
<a href="#l19.299"></a><span id="l19.299">       antiAliasesLengths.AppendElement(antiAliasesLength);</span>
<a href="#l19.300"></a><span id="l19.300">       antiAliasArrays.AppendElement(antiAliases);</span>
<a href="#l19.301"></a><span id="l19.301">       uint32_t antiMessageCount = mCorpus.getMessageCount(antiTrait);</span>
<a href="#l19.302"></a><span id="l19.302">       for (uint32_t aliasIndex = 0; aliasIndex &lt; antiAliasesLength; aliasIndex++)</span>
<a href="#l19.303"></a><span id="l19.303">         antiMessageCount += mCorpus.getMessageCount(antiAliases[aliasIndex]);</span>
<a href="#l19.304"></a><span id="l19.304">       numAntiMessages.AppendElement(antiMessageCount);</span>
<a href="#l19.305"></a><span id="l19.305" class="difflineat">@@ -1604,17 +1606,17 @@ void nsBayesianFilter::classifyMessage(</span>
<a href="#l19.306"></a><span id="l19.306">             S = frexp(S, &amp;e);</span>
<a href="#l19.307"></a><span id="l19.307">             Sexp += e;</span>
<a href="#l19.308"></a><span id="l19.308">           }</span>
<a href="#l19.309"></a><span id="l19.309">           if ( H &lt; 1e-200 )</span>
<a href="#l19.310"></a><span id="l19.310">           {</span>
<a href="#l19.311"></a><span id="l19.311">             H = frexp(H, &amp;e);</span>
<a href="#l19.312"></a><span id="l19.312">             Hexp += e;</span>
<a href="#l19.313"></a><span id="l19.313">           }</span>
<a href="#l19.314"></a><span id="l19.314" class="difflineminus">-          PR_LOG(BayesianFilterLogModule, PR_LOG_WARNING,</span>
<a href="#l19.315"></a><span id="l19.315" class="difflineplus">+          MOZ_LOG(BayesianFilterLogModule, LogLevel::Warning,</span>
<a href="#l19.316"></a><span id="l19.316">                  (&quot;token probability (%s) is %f&quot;,</span>
<a href="#l19.317"></a><span id="l19.317">                   tokens[ta.mTokenIndex].mWord, ta.mProbability));</span>
<a href="#l19.318"></a><span id="l19.318">         }</span>
<a href="#l19.319"></a><span id="l19.319">         if (aDetailListener)</span>
<a href="#l19.320"></a><span id="l19.320">         {</span>
<a href="#l19.321"></a><span id="l19.321">           sArray.AppendElement(log(S) + Sexp * M_LN2);</span>
<a href="#l19.322"></a><span id="l19.322">           hArray.AppendElement(log(H) + Hexp * M_LN2);</span>
<a href="#l19.323"></a><span id="l19.323">         }</span>
<a href="#l19.324"></a><span id="l19.324" class="difflineat">@@ -1677,17 +1679,17 @@ void nsBayesianFilter::classifyMessage(</span>
<a href="#l19.325"></a><span id="l19.325">       }</span>
<a href="#l19.326"></a><span id="l19.326"> </span>
<a href="#l19.327"></a><span id="l19.327">       uint32_t proPercent = static_cast&lt;uint32_t&gt;(prob*100. + .5);</span>
<a href="#l19.328"></a><span id="l19.328"> </span>
<a href="#l19.329"></a><span id="l19.329">       // directly classify junk to maintain backwards compatibility</span>
<a href="#l19.330"></a><span id="l19.330">       if (aProTraits[traitIndex] == kJunkTrait)</span>
<a href="#l19.331"></a><span id="l19.331">       {</span>
<a href="#l19.332"></a><span id="l19.332">         bool isJunk = (prob &gt;= mJunkProbabilityThreshold);</span>
<a href="#l19.333"></a><span id="l19.333" class="difflineminus">-        PR_LOG(BayesianFilterLogModule, PR_LOG_ALWAYS,</span>
<a href="#l19.334"></a><span id="l19.334" class="difflineplus">+        MOZ_LOG(BayesianFilterLogModule, LogLevel::Info,</span>
<a href="#l19.335"></a><span id="l19.335">                (&quot;%s is junk probability = (%f)  HAM SCORE:%f SPAM SCORE:%f&quot;,</span>
<a href="#l19.336"></a><span id="l19.336">                 messageURI, prob,H,S));</span>
<a href="#l19.337"></a><span id="l19.337"> </span>
<a href="#l19.338"></a><span id="l19.338">         // the algorithm in &quot;A Plan For Spam&quot; assumes that you have a large good</span>
<a href="#l19.339"></a><span id="l19.339">         // corpus and a large junk corpus.</span>
<a href="#l19.340"></a><span id="l19.340">         // that won't be the case with users who first use the junk mail trait</span>
<a href="#l19.341"></a><span id="l19.341">         // so, we do certain things to encourage them to train.</span>
<a href="#l19.342"></a><span id="l19.342">         //</span>
<a href="#l19.343"></a><span id="l19.343" class="difflineat">@@ -2048,18 +2050,18 @@ void nsBayesianFilter::observeMessage(</span>
<a href="#l19.344"></a><span id="l19.344">       aTraitListener-&gt;OnMessageTraitsClassified(messageURL,</span>
<a href="#l19.345"></a><span id="l19.345">           traits.Length(), traits.Elements(), percents.Elements());</span>
<a href="#l19.346"></a><span id="l19.346">     }</span>
<a href="#l19.347"></a><span id="l19.347"> </span>
<a href="#l19.348"></a><span id="l19.348">     if (mTrainingDataDirty &amp;&amp; !trainingDataWasDirty &amp;&amp; ( mTimer != nullptr ))</span>
<a href="#l19.349"></a><span id="l19.349">     {</span>
<a href="#l19.350"></a><span id="l19.350">         // if training data became dirty just now, schedule flush</span>
<a href="#l19.351"></a><span id="l19.351">         // mMinFlushInterval msec from now</span>
<a href="#l19.352"></a><span id="l19.352" class="difflineminus">-        PR_LOG(</span>
<a href="#l19.353"></a><span id="l19.353" class="difflineminus">-            BayesianFilterLogModule, PR_LOG_DEBUG,</span>
<a href="#l19.354"></a><span id="l19.354" class="difflineplus">+        MOZ_LOG(</span>
<a href="#l19.355"></a><span id="l19.355" class="difflineplus">+            BayesianFilterLogModule, LogLevel::Debug,</span>
<a href="#l19.356"></a><span id="l19.356">             (&quot;starting training data flush timer %i msec&quot;, mMinFlushInterval));</span>
<a href="#l19.357"></a><span id="l19.357">         mTimer-&gt;InitWithFuncCallback(nsBayesianFilter::TimerCallback, this, mMinFlushInterval, nsITimer::TYPE_ONE_SHOT);</span>
<a href="#l19.358"></a><span id="l19.358">     }</span>
<a href="#l19.359"></a><span id="l19.359"> }</span>
<a href="#l19.360"></a><span id="l19.360"> </span>
<a href="#l19.361"></a><span id="l19.361"> NS_IMETHODIMP nsBayesianFilter::GetUserHasClassified(bool *aResult)</span>
<a href="#l19.362"></a><span id="l19.362"> {</span>
<a href="#l19.363"></a><span id="l19.363">   *aResult = (  (mCorpus.getMessageCount(kGoodTrait) +</span>
<a href="#l19.364"></a><span id="l19.364" class="difflineat">@@ -2371,17 +2373,17 @@ nsresult CorpusStore::getTraitFile(nsIFi</span>
<a href="#l19.365"></a><span id="l19.365"> </span>
<a href="#l19.366"></a><span id="l19.366"> static const char kMagicCookie[] = { '\xFE', '\xED', '\xFA', '\xCE' };</span>
<a href="#l19.367"></a><span id="l19.367"> </span>
<a href="#l19.368"></a><span id="l19.368"> // random string used to identify trait file and version (last byte is version)</span>
<a href="#l19.369"></a><span id="l19.369"> static const char kTraitCookie[] = { '\xFC', '\xA9', '\x36', '\x01' };</span>
<a href="#l19.370"></a><span id="l19.370"> </span>
<a href="#l19.371"></a><span id="l19.371"> void CorpusStore::writeTrainingData(uint32_t aMaximumTokenCount)</span>
<a href="#l19.372"></a><span id="l19.372"> {</span>
<a href="#l19.373"></a><span id="l19.373" class="difflineminus">-  PR_LOG(BayesianFilterLogModule, PR_LOG_DEBUG, (&quot;writeTrainingData() entered&quot;));</span>
<a href="#l19.374"></a><span id="l19.374" class="difflineplus">+  MOZ_LOG(BayesianFilterLogModule, LogLevel::Debug, (&quot;writeTrainingData() entered&quot;));</span>
<a href="#l19.375"></a><span id="l19.375">   if (!mTrainingFile)</span>
<a href="#l19.376"></a><span id="l19.376">     return;</span>
<a href="#l19.377"></a><span id="l19.377"> </span>
<a href="#l19.378"></a><span id="l19.378">   /*</span>
<a href="#l19.379"></a><span id="l19.379">    * For backwards compatibility, write the good and junk tokens to</span>
<a href="#l19.380"></a><span id="l19.380">    * training.dat; additional traits are added to a different file</span>
<a href="#l19.381"></a><span id="l19.381">    */</span>
<a href="#l19.382"></a><span id="l19.382"> </span>
<a href="#l19.383"></a><span id="l19.383" class="difflineat">@@ -2392,17 +2394,17 @@ void CorpusStore::writeTrainingData(uint</span>
<a href="#l19.384"></a><span id="l19.384">     return;</span>
<a href="#l19.385"></a><span id="l19.385"> </span>
<a href="#l19.386"></a><span id="l19.386">   // If the number of tokens exceeds our limit, set the shrink flag</span>
<a href="#l19.387"></a><span id="l19.387">   bool shrink = false;</span>
<a href="#l19.388"></a><span id="l19.388">   if ((aMaximumTokenCount &gt; 0) &amp;&amp; // if 0, do not limit tokens</span>
<a href="#l19.389"></a><span id="l19.389">       (countTokens() &gt; aMaximumTokenCount))</span>
<a href="#l19.390"></a><span id="l19.390">   {</span>
<a href="#l19.391"></a><span id="l19.391">     shrink = true;</span>
<a href="#l19.392"></a><span id="l19.392" class="difflineminus">-    PR_LOG(BayesianFilterLogModule, PR_LOG_WARNING, (&quot;shrinking token data file&quot;));</span>
<a href="#l19.393"></a><span id="l19.393" class="difflineplus">+    MOZ_LOG(BayesianFilterLogModule, LogLevel::Warning, (&quot;shrinking token data file&quot;));</span>
<a href="#l19.394"></a><span id="l19.394">   }</span>
<a href="#l19.395"></a><span id="l19.395"> </span>
<a href="#l19.396"></a><span id="l19.396">   // We implement shrink by dividing counts by two</span>
<a href="#l19.397"></a><span id="l19.397">   uint32_t shrinkFactor = shrink ? 2 : 1;</span>
<a href="#l19.398"></a><span id="l19.398"> </span>
<a href="#l19.399"></a><span id="l19.399">   if (!((fwrite(kMagicCookie, sizeof(kMagicCookie), 1, stream) == 1) &amp;&amp;</span>
<a href="#l19.400"></a><span id="l19.400">       (writeUInt32(stream, getMessageCount(kGoodTrait) / shrinkFactor)) &amp;&amp;</span>
<a href="#l19.401"></a><span id="l19.401">       (writeUInt32(stream, getMessageCount(kJunkTrait) / shrinkFactor)) &amp;&amp;</span>
<a href="#l19.402"></a><span id="l19.402" class="difflineat">@@ -2513,17 +2515,17 @@ void CorpusStore::readTrainingData()</span>
<a href="#l19.403"></a><span id="l19.403">   uint32_t goodMessageCount, junkMessageCount;</span>
<a href="#l19.404"></a><span id="l19.404">   if (!((fread(cookie, sizeof(cookie), 1, stream) == 1) &amp;&amp;</span>
<a href="#l19.405"></a><span id="l19.405">         (memcmp(cookie, kMagicCookie, sizeof(cookie)) == 0) &amp;&amp;</span>
<a href="#l19.406"></a><span id="l19.406">         (readUInt32(stream, &amp;goodMessageCount) == 1) &amp;&amp;</span>
<a href="#l19.407"></a><span id="l19.407">         (readUInt32(stream, &amp;junkMessageCount) == 1) &amp;&amp;</span>
<a href="#l19.408"></a><span id="l19.408">          readTokens(stream, fileSize, kGoodTrait, true) &amp;&amp;</span>
<a href="#l19.409"></a><span id="l19.409">          readTokens(stream, fileSize, kJunkTrait, true))) {</span>
<a href="#l19.410"></a><span id="l19.410">       NS_WARNING(&quot;failed to read training data.&quot;);</span>
<a href="#l19.411"></a><span id="l19.411" class="difflineminus">-      PR_LOG(BayesianFilterLogModule, PR_LOG_ERROR, (&quot;failed to read training data.&quot;));</span>
<a href="#l19.412"></a><span id="l19.412" class="difflineplus">+      MOZ_LOG(BayesianFilterLogModule, LogLevel::Error, (&quot;failed to read training data.&quot;));</span>
<a href="#l19.413"></a><span id="l19.413">   }</span>
<a href="#l19.414"></a><span id="l19.414">   setMessageCount(kGoodTrait, goodMessageCount);</span>
<a href="#l19.415"></a><span id="l19.415">   setMessageCount(kJunkTrait, junkMessageCount);</span>
<a href="#l19.416"></a><span id="l19.416"> </span>
<a href="#l19.417"></a><span id="l19.417">   fclose(stream);</span>
<a href="#l19.418"></a><span id="l19.418"> </span>
<a href="#l19.419"></a><span id="l19.419">   /*</span>
<a href="#l19.420"></a><span id="l19.420">    * Additional traits are stored in traits.dat</span>
<a href="#l19.421"></a><span id="l19.421" class="difflineat">@@ -2540,17 +2542,17 @@ void CorpusStore::readTrainingData()</span>
<a href="#l19.422"></a><span id="l19.422">   if (NS_FAILED(rv) || !exists)</span>
<a href="#l19.423"></a><span id="l19.423">     return;</span>
<a href="#l19.424"></a><span id="l19.424"> </span>
<a href="#l19.425"></a><span id="l19.425">   rv = UpdateData(mTraitFile, true, 0, nullptr, nullptr);</span>
<a href="#l19.426"></a><span id="l19.426"> </span>
<a href="#l19.427"></a><span id="l19.427">   if (NS_FAILED(rv))</span>
<a href="#l19.428"></a><span id="l19.428">   {</span>
<a href="#l19.429"></a><span id="l19.429">     NS_WARNING(&quot;failed to read training data.&quot;);</span>
<a href="#l19.430"></a><span id="l19.430" class="difflineminus">-    PR_LOG(BayesianFilterLogModule, PR_LOG_ERROR, (&quot;failed to read training data.&quot;));</span>
<a href="#l19.431"></a><span id="l19.431" class="difflineplus">+    MOZ_LOG(BayesianFilterLogModule, LogLevel::Error, (&quot;failed to read training data.&quot;));</span>
<a href="#l19.432"></a><span id="l19.432">   }</span>
<a href="#l19.433"></a><span id="l19.433">   return;</span>
<a href="#l19.434"></a><span id="l19.434"> }</span>
<a href="#l19.435"></a><span id="l19.435"> </span>
<a href="#l19.436"></a><span id="l19.436"> nsresult CorpusStore::resetTrainingData()</span>
<a href="#l19.437"></a><span id="l19.437"> {</span>
<a href="#l19.438"></a><span id="l19.438">   // clear out our in memory training tokens...</span>
<a href="#l19.439"></a><span id="l19.439">   if (countTokens())</span>
<a href="#l19.440"></a><span id="l19.440" class="difflineat">@@ -2640,27 +2642,27 @@ uint32_t CorpusStore::getTraitCount(Corp</span>
<a href="#l19.441"></a><span id="l19.441">   // trait not found (or error), so count is zero</span>
<a href="#l19.442"></a><span id="l19.442">   return 0;</span>
<a href="#l19.443"></a><span id="l19.443"> }</span>
<a href="#l19.444"></a><span id="l19.444"> </span>
<a href="#l19.445"></a><span id="l19.445"> CorpusToken* CorpusStore::add(const char* word, uint32_t aTraitId, uint32_t aCount)</span>
<a href="#l19.446"></a><span id="l19.446"> {</span>
<a href="#l19.447"></a><span id="l19.447">   CorpusToken* token = static_cast&lt;CorpusToken*&gt;(TokenHash::add(word));</span>
<a href="#l19.448"></a><span id="l19.448">   if (token) {</span>
<a href="#l19.449"></a><span id="l19.449" class="difflineminus">-    PR_LOG(BayesianFilterLogModule, PR_LOG_DEBUG,</span>
<a href="#l19.450"></a><span id="l19.450" class="difflineplus">+    MOZ_LOG(BayesianFilterLogModule, LogLevel::Debug,</span>
<a href="#l19.451"></a><span id="l19.451">            (&quot;adding word to corpus store: %s (Trait=%d) (deltaCount=%d)&quot;,</span>
<a href="#l19.452"></a><span id="l19.452">             word, aTraitId, aCount));</span>
<a href="#l19.453"></a><span id="l19.453">     updateTrait(token, aTraitId, aCount);</span>
<a href="#l19.454"></a><span id="l19.454">   }</span>
<a href="#l19.455"></a><span id="l19.455">   return token;</span>
<a href="#l19.456"></a><span id="l19.456">  }</span>
<a href="#l19.457"></a><span id="l19.457"> </span>
<a href="#l19.458"></a><span id="l19.458"> void CorpusStore::remove(const char* word, uint32_t aTraitId, uint32_t aCount)</span>
<a href="#l19.459"></a><span id="l19.459"> {</span>
<a href="#l19.460"></a><span id="l19.460" class="difflineminus">-  PR_LOG(BayesianFilterLogModule, PR_LOG_DEBUG,</span>
<a href="#l19.461"></a><span id="l19.461" class="difflineplus">+  MOZ_LOG(BayesianFilterLogModule, LogLevel::Debug,</span>
<a href="#l19.462"></a><span id="l19.462">          (&quot;remove word: %s (TraitId=%d) (Count=%d)&quot;,</span>
<a href="#l19.463"></a><span id="l19.463">          word, aTraitId, aCount));</span>
<a href="#l19.464"></a><span id="l19.464">   CorpusToken* token = get(word);</span>
<a href="#l19.465"></a><span id="l19.465">   if (token)</span>
<a href="#l19.466"></a><span id="l19.466">     updateTrait(token, aTraitId, -static_cast&lt;int32_t&gt;(aCount));</span>
<a href="#l19.467"></a><span id="l19.467"> }</span>
<a href="#l19.468"></a><span id="l19.468"> </span>
<a href="#l19.469"></a><span id="l19.469"> uint32_t CorpusStore::getMessageCount(uint32_t aTraitId)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/imap/src/nsAutoSyncManager.cpp</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/imap/src/nsAutoSyncManager.cpp</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -15,16 +15,19 @@</span>
<a href="#l20.4"></a><span id="l20.4"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l20.5"></a><span id="l20.5"> #include &quot;nsImapIncomingServer.h&quot;</span>
<a href="#l20.6"></a><span id="l20.6"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l20.7"></a><span id="l20.7"> #include &quot;nsIIOService.h&quot;</span>
<a href="#l20.8"></a><span id="l20.8"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l20.9"></a><span id="l20.9"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l20.10"></a><span id="l20.10"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l20.11"></a><span id="l20.11"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+using namespace mozilla;</span>
<a href="#l20.15"></a><span id="l20.15"> </span>
<a href="#l20.16"></a><span id="l20.16"> NS_IMPL_ISUPPORTS(nsDefaultAutoSyncMsgStrategy, nsIAutoSyncMsgStrategy)</span>
<a href="#l20.17"></a><span id="l20.17"> </span>
<a href="#l20.18"></a><span id="l20.18"> const char* kAppIdleNotification = &quot;mail:appIdle&quot;;</span>
<a href="#l20.19"></a><span id="l20.19"> const char* kStartupDoneNotification = &quot;mail-startup-done&quot;;</span>
<a href="#l20.20"></a><span id="l20.20"> PRLogModuleInfo *gAutoSyncLog;</span>
<a href="#l20.21"></a><span id="l20.21"> </span>
<a href="#l20.22"></a><span id="l20.22"> // recommended size of each group of messages per download</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineat">@@ -531,25 +534,25 @@ NS_IMETHODIMP nsAutoSyncManager::OnStopR</span>
<a href="#l20.24"></a><span id="l20.24"> </span>
<a href="#l20.25"></a><span id="l20.25">   return aExitCode;</span>
<a href="#l20.26"></a><span id="l20.26"> }</span>
<a href="#l20.27"></a><span id="l20.27"> </span>
<a href="#l20.28"></a><span id="l20.28"> NS_IMETHODIMP nsAutoSyncManager::Pause()</span>
<a href="#l20.29"></a><span id="l20.29"> {</span>
<a href="#l20.30"></a><span id="l20.30">   StopTimer();</span>
<a href="#l20.31"></a><span id="l20.31">   mPaused = true;</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineminus">-  PR_LOG(gAutoSyncLog, PR_LOG_DEBUG, (&quot;autosync paused\n&quot;));</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineplus">+  MOZ_LOG(gAutoSyncLog, LogLevel::Debug, (&quot;autosync paused\n&quot;));</span>
<a href="#l20.34"></a><span id="l20.34">   return NS_OK;</span>
<a href="#l20.35"></a><span id="l20.35"> }</span>
<a href="#l20.36"></a><span id="l20.36"> </span>
<a href="#l20.37"></a><span id="l20.37"> NS_IMETHODIMP nsAutoSyncManager::Resume()</span>
<a href="#l20.38"></a><span id="l20.38"> {</span>
<a href="#l20.39"></a><span id="l20.39">   mPaused = false;</span>
<a href="#l20.40"></a><span id="l20.40">   StartTimerIfNeeded();</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineminus">-  PR_LOG(gAutoSyncLog, PR_LOG_DEBUG, (&quot;autosync resumed\n&quot;));</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineplus">+  MOZ_LOG(gAutoSyncLog, LogLevel::Debug, (&quot;autosync resumed\n&quot;));</span>
<a href="#l20.43"></a><span id="l20.43">   return NS_OK;</span>
<a href="#l20.44"></a><span id="l20.44"> }</span>
<a href="#l20.45"></a><span id="l20.45"> </span>
<a href="#l20.46"></a><span id="l20.46"> NS_IMETHODIMP nsAutoSyncManager::Observe(nsISupports*, const char *aTopic, const char16_t *aSomeData)</span>
<a href="#l20.47"></a><span id="l20.47"> {</span>
<a href="#l20.48"></a><span id="l20.48">   if (!PL_strcmp(aTopic, NS_XPCOM_SHUTDOWN_OBSERVER_ID))</span>
<a href="#l20.49"></a><span id="l20.49">   {</span>
<a href="#l20.50"></a><span id="l20.50">     nsCOMPtr&lt;nsIObserverService&gt; observerService =</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/imap/src/nsAutoSyncState.cpp</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/imap/src/nsAutoSyncState.cpp</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -9,16 +9,19 @@</span>
<a href="#l21.4"></a><span id="l21.4"> #include &quot;nsMsgKeyArray.h&quot;</span>
<a href="#l21.5"></a><span id="l21.5"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l21.6"></a><span id="l21.6"> #include &quot;nsIMsgMailSession.h&quot;</span>
<a href="#l21.7"></a><span id="l21.7"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l21.8"></a><span id="l21.8"> #include &quot;nsIAutoSyncManager.h&quot;</span>
<a href="#l21.9"></a><span id="l21.9"> #include &quot;nsIAutoSyncMsgStrategy.h&quot;</span>
<a href="#l21.10"></a><span id="l21.10"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l21.11"></a><span id="l21.11"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+using namespace mozilla;</span>
<a href="#l21.15"></a><span id="l21.15"> </span>
<a href="#l21.16"></a><span id="l21.16"> extern PRLogModuleInfo *gAutoSyncLog;</span>
<a href="#l21.17"></a><span id="l21.17"> </span>
<a href="#l21.18"></a><span id="l21.18"> MsgStrategyComparatorAdaptor::MsgStrategyComparatorAdaptor(nsIAutoSyncMsgStrategy* aStrategy, </span>
<a href="#l21.19"></a><span id="l21.19">   nsIMsgFolder *aFolder, nsIMsgDatabase *aDatabase) : mStrategy(aStrategy), mFolder(aFolder), </span>
<a href="#l21.20"></a><span id="l21.20">     mDatabase(aDatabase)</span>
<a href="#l21.21"></a><span id="l21.21"> {</span>
<a href="#l21.22"></a><span id="l21.22"> }</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineat">@@ -357,17 +360,17 @@ NS_IMETHODIMP nsAutoSyncState::ProcessEx</span>
<a href="#l21.24"></a><span id="l21.24">     folder-&gt;HasMsgOffline(mExistingHeadersQ[mProcessPointer], &amp;hasMessageOffline);</span>
<a href="#l21.25"></a><span id="l21.25">     if (!hasMessageOffline)</span>
<a href="#l21.26"></a><span id="l21.26">       msgKeys.AppendElement(mExistingHeadersQ[mProcessPointer]);</span>
<a href="#l21.27"></a><span id="l21.27">   }</span>
<a href="#l21.28"></a><span id="l21.28">   if (!msgKeys.IsEmpty())</span>
<a href="#l21.29"></a><span id="l21.29">   {</span>
<a href="#l21.30"></a><span id="l21.30">     nsCString folderName;</span>
<a href="#l21.31"></a><span id="l21.31">     folder-&gt;GetURI(folderName);</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineminus">-    PR_LOG(gAutoSyncLog, PR_LOG_DEBUG,</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineplus">+    MOZ_LOG(gAutoSyncLog, LogLevel::Debug,</span>
<a href="#l21.34"></a><span id="l21.34">           (&quot;%d messages will be added into the download q of folder %s\n&quot;,</span>
<a href="#l21.35"></a><span id="l21.35">             msgKeys.Length(), folderName.get()));</span>
<a href="#l21.36"></a><span id="l21.36"> </span>
<a href="#l21.37"></a><span id="l21.37">     rv = PlaceIntoDownloadQ(msgKeys);</span>
<a href="#l21.38"></a><span id="l21.38">     if (NS_FAILED(rv))</span>
<a href="#l21.39"></a><span id="l21.39">       mProcessPointer = lastIdx;</span>
<a href="#l21.40"></a><span id="l21.40">   }</span>
<a href="#l21.41"></a><span id="l21.41"> </span>
<a href="#l21.42"></a><span id="l21.42" class="difflineat">@@ -441,20 +444,20 @@ NS_IMETHODIMP nsAutoSyncState::OnStopRun</span>
<a href="#l21.43"></a><span id="l21.43">     imapFolder-&gt;GetServerUnseen(&amp;serverUnseen);</span>
<a href="#l21.44"></a><span id="l21.44">     imapFolder-&gt;GetServerRecent(&amp;serverRecent);</span>
<a href="#l21.45"></a><span id="l21.45">     imapFolder-&gt;GetServerNextUID(&amp;serverNextUID);</span>
<a href="#l21.46"></a><span id="l21.46">     if (serverNextUID != mLastNextUID || serverTotal != mLastServerTotal ||</span>
<a href="#l21.47"></a><span id="l21.47">         serverUnseen != mLastServerUnseen || serverRecent != mLastServerRecent)</span>
<a href="#l21.48"></a><span id="l21.48">     {</span>
<a href="#l21.49"></a><span id="l21.49">       nsCString folderName;</span>
<a href="#l21.50"></a><span id="l21.50">       ownerFolder-&gt;GetURI(folderName);</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineminus">-      PR_LOG(gAutoSyncLog, PR_LOG_DEBUG,</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineplus">+      MOZ_LOG(gAutoSyncLog, LogLevel::Debug,</span>
<a href="#l21.53"></a><span id="l21.53">              (&quot;folder %s status changed serverNextUID = %lx lastNextUID = %lx\n&quot;, folderName.get(),</span>
<a href="#l21.54"></a><span id="l21.54">               serverNextUID, mLastNextUID));</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineminus">-      PR_LOG(gAutoSyncLog, PR_LOG_DEBUG,</span>
<a href="#l21.56"></a><span id="l21.56" class="difflineplus">+      MOZ_LOG(gAutoSyncLog, LogLevel::Debug,</span>
<a href="#l21.57"></a><span id="l21.57">              (&quot;serverTotal = %lx lastServerTotal = %lx serverRecent = %lx lastServerRecent = %lx\n&quot;,</span>
<a href="#l21.58"></a><span id="l21.58">               serverTotal, mLastServerTotal, serverRecent, mLastServerRecent));</span>
<a href="#l21.59"></a><span id="l21.59">       SetServerCounts(serverTotal, serverRecent, serverUnseen, serverNextUID);</span>
<a href="#l21.60"></a><span id="l21.60">       SetState(nsAutoSyncState::stUpdateIssued);</span>
<a href="#l21.61"></a><span id="l21.61">       return imapFolder-&gt;UpdateFolderWithListener(nullptr, autoSyncMgrListener);</span>
<a href="#l21.62"></a><span id="l21.62">     }</span>
<a href="#l21.63"></a><span id="l21.63">     else</span>
<a href="#l21.64"></a><span id="l21.64">     {</span>
<a href="#l21.65"></a><span id="l21.65" class="difflineat">@@ -637,17 +640,17 @@ NS_IMETHODIMP nsAutoSyncState::DownloadM</span>
<a href="#l21.66"></a><span id="l21.66">   nsCOMPtr &lt;nsIMsgFolder&gt; folder = do_QueryReferent(mOwnerFolder, &amp;rv);</span>
<a href="#l21.67"></a><span id="l21.67">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.68"></a><span id="l21.68">   </span>
<a href="#l21.69"></a><span id="l21.69">   rv = folder-&gt;AcquireSemaphore(folder);</span>
<a href="#l21.70"></a><span id="l21.70">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.71"></a><span id="l21.71"> </span>
<a href="#l21.72"></a><span id="l21.72">   nsCString folderName;</span>
<a href="#l21.73"></a><span id="l21.73">   folder-&gt;GetURI(folderName);</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineminus">-  PR_LOG(gAutoSyncLog, PR_LOG_DEBUG, (&quot;downloading %s for %s&quot;, messageIds.get(),</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineplus">+  MOZ_LOG(gAutoSyncLog, LogLevel::Debug, (&quot;downloading %s for %s&quot;, messageIds.get(),</span>
<a href="#l21.76"></a><span id="l21.76">            folderName.get()));</span>
<a href="#l21.77"></a><span id="l21.77">   // start downloading</span>
<a href="#l21.78"></a><span id="l21.78">   rv = imapService-&gt;DownloadMessagesForOffline(messageIds, </span>
<a href="#l21.79"></a><span id="l21.79">                                                folder, </span>
<a href="#l21.80"></a><span id="l21.80">                                                this, </span>
<a href="#l21.81"></a><span id="l21.81">                                                nullptr);</span>
<a href="#l21.82"></a><span id="l21.82">   if (NS_SUCCEEDED(rv))</span>
<a href="#l21.83"></a><span id="l21.83">     SetState(stDownloadInProgress);                                              </span>
<a href="#l21.84"></a><span id="l21.84" class="difflineat">@@ -706,21 +709,21 @@ void nsAutoSyncState::LogQWithSize(nsTAr</span>
<a href="#l21.85"></a><span id="l21.85">     {</span>
<a href="#l21.86"></a><span id="l21.86">       x--;</span>
<a href="#l21.87"></a><span id="l21.87">       nsCOMPtr&lt;nsIMsgDBHdr&gt; h;</span>
<a href="#l21.88"></a><span id="l21.88">       database-&gt;GetMsgHdrForKey(q[x], getter_AddRefs(h));</span>
<a href="#l21.89"></a><span id="l21.89">       uint32_t s;</span>
<a href="#l21.90"></a><span id="l21.90">       if (h)</span>
<a href="#l21.91"></a><span id="l21.91">       {</span>
<a href="#l21.92"></a><span id="l21.92">         h-&gt;GetMessageSize(&amp;s);</span>
<a href="#l21.93"></a><span id="l21.93" class="difflineminus">-        PR_LOG(gAutoSyncLog, PR_LOG_DEBUG,</span>
<a href="#l21.94"></a><span id="l21.94" class="difflineplus">+        MOZ_LOG(gAutoSyncLog, LogLevel::Debug,</span>
<a href="#l21.95"></a><span id="l21.95">               (&quot;Elem #%d, size: %u bytes\n&quot;, x+1, s));</span>
<a href="#l21.96"></a><span id="l21.96">       }</span>
<a href="#l21.97"></a><span id="l21.97">       else</span>
<a href="#l21.98"></a><span id="l21.98" class="difflineminus">-        PR_LOG(gAutoSyncLog, PR_LOG_DEBUG, (&quot;unable to get header for key %ul&quot;, q[x]));</span>
<a href="#l21.99"></a><span id="l21.99" class="difflineplus">+        MOZ_LOG(gAutoSyncLog, LogLevel::Debug, (&quot;unable to get header for key %ul&quot;, q[x]));</span>
<a href="#l21.100"></a><span id="l21.100">     }</span>
<a href="#l21.101"></a><span id="l21.101">   }</span>
<a href="#l21.102"></a><span id="l21.102"> }</span>
<a href="#l21.103"></a><span id="l21.103"> </span>
<a href="#l21.104"></a><span id="l21.104"> void nsAutoSyncState::LogQWithSize(nsIMutableArray *q, uint32_t toOffset)</span>
<a href="#l21.105"></a><span id="l21.105"> {</span>
<a href="#l21.106"></a><span id="l21.106">   nsCOMPtr &lt;nsIMsgFolder&gt; ownerFolder = do_QueryReferent(mOwnerFolder);</span>
<a href="#l21.107"></a><span id="l21.107">   if (ownerFolder)</span>
<a href="#l21.108"></a><span id="l21.108" class="difflineat">@@ -735,28 +738,28 @@ void nsAutoSyncState::LogQWithSize(nsIMu</span>
<a href="#l21.109"></a><span id="l21.109">       x--;</span>
<a href="#l21.110"></a><span id="l21.110">       nsCOMPtr&lt;nsIMsgDBHdr&gt; h;</span>
<a href="#l21.111"></a><span id="l21.111">       q-&gt;QueryElementAt(x, NS_GET_IID(nsIMsgDBHdr),</span>
<a href="#l21.112"></a><span id="l21.112">                         getter_AddRefs(h));</span>
<a href="#l21.113"></a><span id="l21.113">       uint32_t s;</span>
<a href="#l21.114"></a><span id="l21.114">       if (h)</span>
<a href="#l21.115"></a><span id="l21.115">       {</span>
<a href="#l21.116"></a><span id="l21.116">         h-&gt;GetMessageSize(&amp;s);</span>
<a href="#l21.117"></a><span id="l21.117" class="difflineminus">-        PR_LOG(gAutoSyncLog, PR_LOG_DEBUG,</span>
<a href="#l21.118"></a><span id="l21.118" class="difflineplus">+        MOZ_LOG(gAutoSyncLog, LogLevel::Debug,</span>
<a href="#l21.119"></a><span id="l21.119">               (&quot;Elem #%d, size: %u bytes\n&quot;, x+1, s));</span>
<a href="#l21.120"></a><span id="l21.120">       }</span>
<a href="#l21.121"></a><span id="l21.121">       else</span>
<a href="#l21.122"></a><span id="l21.122" class="difflineminus">-        PR_LOG(gAutoSyncLog, PR_LOG_DEBUG, (&quot;null header in q at index %ul&quot;, x));</span>
<a href="#l21.123"></a><span id="l21.123" class="difflineplus">+        MOZ_LOG(gAutoSyncLog, LogLevel::Debug, (&quot;null header in q at index %ul&quot;, x));</span>
<a href="#l21.124"></a><span id="l21.124">     }</span>
<a href="#l21.125"></a><span id="l21.125">   }</span>
<a href="#l21.126"></a><span id="l21.126"> }</span>
<a href="#l21.127"></a><span id="l21.127"> </span>
<a href="#l21.128"></a><span id="l21.128"> void nsAutoSyncState::LogOwnerFolderName(const char *s)</span>
<a href="#l21.129"></a><span id="l21.129"> {</span>
<a href="#l21.130"></a><span id="l21.130">   nsCOMPtr &lt;nsIMsgFolder&gt; ownerFolder = do_QueryReferent(mOwnerFolder);</span>
<a href="#l21.131"></a><span id="l21.131">   if (ownerFolder)</span>
<a href="#l21.132"></a><span id="l21.132">   {</span>
<a href="#l21.133"></a><span id="l21.133">     nsCString folderName;</span>
<a href="#l21.134"></a><span id="l21.134">     ownerFolder-&gt;GetURI(folderName);</span>
<a href="#l21.135"></a><span id="l21.135" class="difflineminus">-    PR_LOG(gAutoSyncLog, PR_LOG_DEBUG,</span>
<a href="#l21.136"></a><span id="l21.136" class="difflineplus">+    MOZ_LOG(gAutoSyncLog, LogLevel::Debug,</span>
<a href="#l21.137"></a><span id="l21.137">            (&quot;*** %s Folder: %s ***\n&quot;, s, folderName.get()));</span>
<a href="#l21.138"></a><span id="l21.138">   }</span>
<a href="#l21.139"></a><span id="l21.139"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/imap/src/nsIMAPBodyShell.cpp</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/imap/src/nsIMAPBodyShell.cpp</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -179,17 +179,17 @@ void nsIMAPBodyShell::FlushPrefetchQueue</span>
<a href="#l22.4"></a><span id="l22.4"> </span>
<a href="#l22.5"></a><span id="l22.5"> // Requires that the shell is valid when called</span>
<a href="#l22.6"></a><span id="l22.6"> // Performs a preflight check on all message parts to see if they are all</span>
<a href="#l22.7"></a><span id="l22.7"> // inline.  Returns true if all parts are inline, false otherwise.</span>
<a href="#l22.8"></a><span id="l22.8"> bool nsIMAPBodyShell::PreflightCheckAllInline()</span>
<a href="#l22.9"></a><span id="l22.9"> {</span>
<a href="#l22.10"></a><span id="l22.10">   bool rv = m_message-&gt;PreflightCheckAllInline(this);</span>
<a href="#l22.11"></a><span id="l22.11">   //	if (rv)</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-  //		PR_LOG(IMAP, out, (&quot;BODYSHELL: All parts inline.  Reverting to whole message download.&quot;));</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+  //		MOZ_LOG(IMAP, out, (&quot;BODYSHELL: All parts inline.  Reverting to whole message download.&quot;));</span>
<a href="#l22.14"></a><span id="l22.14">   return rv;</span>
<a href="#l22.15"></a><span id="l22.15"> }</span>
<a href="#l22.16"></a><span id="l22.16"> </span>
<a href="#l22.17"></a><span id="l22.17"> // When partNum is NULL, Generates a whole message and intelligently</span>
<a href="#l22.18"></a><span id="l22.18"> // leaves out parts that are not inline.</span>
<a href="#l22.19"></a><span id="l22.19"> </span>
<a href="#l22.20"></a><span id="l22.20"> // When partNum is not NULL, Generates a MIME part that hasn't been downloaded yet</span>
<a href="#l22.21"></a><span id="l22.21"> // Ok, here's how we're going to do this.  Essentially, this</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineat">@@ -327,17 +327,17 @@ nsIMAPBodypart::~nsIMAPBodypart()</span>
<a href="#l22.23"></a><span id="l22.23">   PR_FREEIF(m_boundaryData);</span>
<a href="#l22.24"></a><span id="l22.24"> }</span>
<a href="#l22.25"></a><span id="l22.25"> </span>
<a href="#l22.26"></a><span id="l22.26"> void nsIMAPBodypart::SetIsValid(bool valid)</span>
<a href="#l22.27"></a><span id="l22.27"> {</span>
<a href="#l22.28"></a><span id="l22.28">   m_isValid = valid;</span>
<a href="#l22.29"></a><span id="l22.29">   if (!m_isValid)</span>
<a href="#l22.30"></a><span id="l22.30">   {</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineminus">-    //PR_LOG(IMAP, out, (&quot;BODYSHELL: Part is invalid.  Part Number: %s Content-Type: %s&quot;, m_partNumberString, m_contentType));</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineplus">+    //MOZ_LOG(IMAP, out, (&quot;BODYSHELL: Part is invalid.  Part Number: %s Content-Type: %s&quot;, m_partNumberString, m_contentType));</span>
<a href="#l22.33"></a><span id="l22.33">   }</span>
<a href="#l22.34"></a><span id="l22.34"> }</span>
<a href="#l22.35"></a><span id="l22.35"> </span>
<a href="#l22.36"></a><span id="l22.36"> // Adopts storage for part data buffer.  If NULL, sets isValid to false.</span>
<a href="#l22.37"></a><span id="l22.37"> void nsIMAPBodypart::AdoptPartDataBuffer(char *buf)</span>
<a href="#l22.38"></a><span id="l22.38"> {</span>
<a href="#l22.39"></a><span id="l22.39">   m_partData = buf;</span>
<a href="#l22.40"></a><span id="l22.40">   if (!m_partData)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -88,16 +88,17 @@</span>
<a href="#l23.4"></a><span id="l23.4"> #include &quot;nsAutoSyncManager.h&quot;</span>
<a href="#l23.5"></a><span id="l23.5"> #include &quot;nsIMsgFilterCustomAction.h&quot;</span>
<a href="#l23.6"></a><span id="l23.6"> #include &quot;nsMsgReadStateTxn.h&quot;</span>
<a href="#l23.7"></a><span id="l23.7"> #include &quot;nsIStringEnumerator.h&quot;</span>
<a href="#l23.8"></a><span id="l23.8"> #include &quot;nsIMsgStatusFeedback.h&quot;</span>
<a href="#l23.9"></a><span id="l23.9"> #include &quot;nsAlgorithm.h&quot;</span>
<a href="#l23.10"></a><span id="l23.10"> #include &quot;nsMsgLineBuffer.h&quot;</span>
<a href="#l23.11"></a><span id="l23.11"> #include &lt;algorithm&gt;</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l23.13"></a><span id="l23.13"> </span>
<a href="#l23.14"></a><span id="l23.14"> static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l23.15"></a><span id="l23.15"> static NS_DEFINE_CID(kParseMailMsgStateCID, NS_PARSEMAILMSGSTATE_CID);</span>
<a href="#l23.16"></a><span id="l23.16"> static NS_DEFINE_CID(kCImapHostSessionList, NS_IIMAPHOSTSESSIONLIST_CID);</span>
<a href="#l23.17"></a><span id="l23.17"> </span>
<a href="#l23.18"></a><span id="l23.18"> extern PRLogModuleInfo *gAutoSyncLog;</span>
<a href="#l23.19"></a><span id="l23.19"> extern PRLogModuleInfo* IMAP;</span>
<a href="#l23.20"></a><span id="l23.20"> </span>
<a href="#l23.21"></a><span id="l23.21" class="difflineat">@@ -3208,61 +3209,61 @@ NS_IMETHODIMP nsImapMailFolder::BeginCop</span>
<a href="#l23.22"></a><span id="l23.22">   nsresult rv;</span>
<a href="#l23.23"></a><span id="l23.23">   if (m_copyState-&gt;m_tmpFile) // leftover file spec nuke it</span>
<a href="#l23.24"></a><span id="l23.24">   {</span>
<a href="#l23.25"></a><span id="l23.25">     rv = m_copyState-&gt;m_tmpFile-&gt;Remove(false);</span>
<a href="#l23.26"></a><span id="l23.26">     if (NS_FAILED(rv))</span>
<a href="#l23.27"></a><span id="l23.27">     {</span>
<a href="#l23.28"></a><span id="l23.28">       nsCString nativePath;</span>
<a href="#l23.29"></a><span id="l23.29">       m_copyState-&gt;m_tmpFile-&gt;GetNativePath(nativePath);</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineminus">-      PR_LOG(IMAP, PR_LOG_ALWAYS, (&quot;couldn't remove prev temp file %s: %lx\n&quot;, nativePath.get(), rv));</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineplus">+      MOZ_LOG(IMAP, mozilla::LogLevel::Info, (&quot;couldn't remove prev temp file %s: %lx\n&quot;, nativePath.get(), rv));</span>
<a href="#l23.32"></a><span id="l23.32">     }</span>
<a href="#l23.33"></a><span id="l23.33">     m_copyState-&gt;m_tmpFile = nullptr;</span>
<a href="#l23.34"></a><span id="l23.34">   }</span>
<a href="#l23.35"></a><span id="l23.35">   if (message)</span>
<a href="#l23.36"></a><span id="l23.36">     m_copyState-&gt;m_message = do_QueryInterface(message, &amp;rv);</span>
<a href="#l23.37"></a><span id="l23.37"> </span>
<a href="#l23.38"></a><span id="l23.38">   rv = GetSpecialDirectoryWithFileName(NS_OS_TEMP_DIR,</span>
<a href="#l23.39"></a><span id="l23.39">                                        &quot;nscpmsg.txt&quot;,</span>
<a href="#l23.40"></a><span id="l23.40">                                         getter_AddRefs(m_copyState-&gt;m_tmpFile));</span>
<a href="#l23.41"></a><span id="l23.41">   if (NS_FAILED(rv))</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineminus">-    PR_LOG(IMAP, PR_LOG_ALWAYS, (&quot;couldn't find nscpmsg.txt:%lx\n&quot;, rv));</span>
<a href="#l23.43"></a><span id="l23.43" class="difflineplus">+    MOZ_LOG(IMAP, mozilla::LogLevel::Info, (&quot;couldn't find nscpmsg.txt:%lx\n&quot;, rv));</span>
<a href="#l23.44"></a><span id="l23.44">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.45"></a><span id="l23.45"> </span>
<a href="#l23.46"></a><span id="l23.46">   // create a unique file, since multiple copies may be open on multiple folders</span>
<a href="#l23.47"></a><span id="l23.47">   rv = m_copyState-&gt;m_tmpFile-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 00600);</span>
<a href="#l23.48"></a><span id="l23.48">   if (NS_FAILED(rv))</span>
<a href="#l23.49"></a><span id="l23.49">   {</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineminus">-    PR_LOG(IMAP, PR_LOG_ALWAYS, (&quot;couldn't create temp nscpmsg.txt:%lx\n&quot;, rv));</span>
<a href="#l23.51"></a><span id="l23.51" class="difflineplus">+    MOZ_LOG(IMAP, mozilla::LogLevel::Info, (&quot;couldn't create temp nscpmsg.txt:%lx\n&quot;, rv));</span>
<a href="#l23.52"></a><span id="l23.52">     // Last ditch attempt to create a temp file, because virus checker might</span>
<a href="#l23.53"></a><span id="l23.53">     // be locking the previous temp file, and CreateUnique fails if the file</span>
<a href="#l23.54"></a><span id="l23.54">     // is locked. Use the message key to make a unique name.</span>
<a href="#l23.55"></a><span id="l23.55">     if (message)</span>
<a href="#l23.56"></a><span id="l23.56">     {</span>
<a href="#l23.57"></a><span id="l23.57">       nsCString tmpFileName(&quot;nscpmsg-&quot;);</span>
<a href="#l23.58"></a><span id="l23.58">       nsMsgKey msgKey;</span>
<a href="#l23.59"></a><span id="l23.59">       message-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l23.60"></a><span id="l23.60">       tmpFileName.AppendInt(msgKey);</span>
<a href="#l23.61"></a><span id="l23.61">       tmpFileName.Append(&quot;.txt&quot;);</span>
<a href="#l23.62"></a><span id="l23.62">       m_copyState-&gt;m_tmpFile-&gt;SetNativeLeafName(tmpFileName);</span>
<a href="#l23.63"></a><span id="l23.63">       rv = m_copyState-&gt;m_tmpFile-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 00600);</span>
<a href="#l23.64"></a><span id="l23.64">       if (NS_FAILED(rv))</span>
<a href="#l23.65"></a><span id="l23.65">       {</span>
<a href="#l23.66"></a><span id="l23.66" class="difflineminus">-        PR_LOG(IMAP, PR_LOG_ALWAYS, (&quot;couldn't create temp nscpmsg.txt:%lx\n&quot;, rv));</span>
<a href="#l23.67"></a><span id="l23.67" class="difflineplus">+        MOZ_LOG(IMAP, mozilla::LogLevel::Info, (&quot;couldn't create temp nscpmsg.txt:%lx\n&quot;, rv));</span>
<a href="#l23.68"></a><span id="l23.68">         OnCopyCompleted(m_copyState-&gt;m_srcSupport, rv);</span>
<a href="#l23.69"></a><span id="l23.69">         return rv;</span>
<a href="#l23.70"></a><span id="l23.70">       }</span>
<a href="#l23.71"></a><span id="l23.71">     }</span>
<a href="#l23.72"></a><span id="l23.72">   }</span>
<a href="#l23.73"></a><span id="l23.73"> </span>
<a href="#l23.74"></a><span id="l23.74">   nsCOMPtr&lt;nsIOutputStream&gt; fileOutputStream;</span>
<a href="#l23.75"></a><span id="l23.75">   rv = MsgNewBufferedFileOutputStream(getter_AddRefs(m_copyState-&gt;m_msgFileStream),</span>
<a href="#l23.76"></a><span id="l23.76">                                       m_copyState-&gt;m_tmpFile, -1, 00600);</span>
<a href="#l23.77"></a><span id="l23.77">   if (NS_FAILED(rv))</span>
<a href="#l23.78"></a><span id="l23.78" class="difflineminus">-    PR_LOG(IMAP, PR_LOG_ALWAYS, (&quot;couldn't create output file stream:%lx\n&quot;, rv));</span>
<a href="#l23.79"></a><span id="l23.79" class="difflineplus">+    MOZ_LOG(IMAP, mozilla::LogLevel::Info, (&quot;couldn't create output file stream:%lx\n&quot;, rv));</span>
<a href="#l23.80"></a><span id="l23.80"> </span>
<a href="#l23.81"></a><span id="l23.81">   if (!m_copyState-&gt;m_dataBuffer)</span>
<a href="#l23.82"></a><span id="l23.82">     m_copyState-&gt;m_dataBuffer = (char*) PR_CALLOC(COPY_BUFFER_SIZE+1);</span>
<a href="#l23.83"></a><span id="l23.83">   NS_ENSURE_TRUE(m_copyState-&gt;m_dataBuffer, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l23.84"></a><span id="l23.84">   m_copyState-&gt;m_dataBufferSize = COPY_BUFFER_SIZE;</span>
<a href="#l23.85"></a><span id="l23.85">   return NS_OK;</span>
<a href="#l23.86"></a><span id="l23.86"> }</span>
<a href="#l23.87"></a><span id="l23.87"> </span>
<a href="#l23.88"></a><span id="l23.88" class="difflineat">@@ -3350,17 +3351,17 @@ NS_IMETHODIMP nsImapMailFolder::CopyData</span>
<a href="#l23.89"></a><span id="l23.89"> // sICopyMessageListener methods, BeginCopy, CopyData, EndCopy, EndMove, StartMessage, EndMessage</span>
<a href="#l23.90"></a><span id="l23.90"> NS_IMETHODIMP nsImapMailFolder::CopyData(nsIInputStream *aIStream, int32_t aLength)</span>
<a href="#l23.91"></a><span id="l23.91"> {</span>
<a href="#l23.92"></a><span id="l23.92">   NS_ENSURE_TRUE(m_copyState &amp;&amp; m_copyState-&gt;m_msgFileStream &amp;&amp; m_copyState-&gt;m_dataBuffer, NS_ERROR_NULL_POINTER);</span>
<a href="#l23.93"></a><span id="l23.93">   nsresult rv = CopyDataToOutputStreamForAppend(aIStream, aLength,</span>
<a href="#l23.94"></a><span id="l23.94">                                                 m_copyState-&gt;m_msgFileStream);</span>
<a href="#l23.95"></a><span id="l23.95">   if (NS_FAILED(rv))</span>
<a href="#l23.96"></a><span id="l23.96">   {</span>
<a href="#l23.97"></a><span id="l23.97" class="difflineminus">-    PR_LOG(IMAP, PR_LOG_ALWAYS, (&quot;CopyData failed:%lx\n&quot;, rv));</span>
<a href="#l23.98"></a><span id="l23.98" class="difflineplus">+    MOZ_LOG(IMAP, mozilla::LogLevel::Info, (&quot;CopyData failed:%lx\n&quot;, rv));</span>
<a href="#l23.99"></a><span id="l23.99">     OnCopyCompleted(m_copyState-&gt;m_srcSupport, rv);</span>
<a href="#l23.100"></a><span id="l23.100">   }</span>
<a href="#l23.101"></a><span id="l23.101">   return rv;</span>
<a href="#l23.102"></a><span id="l23.102"> }</span>
<a href="#l23.103"></a><span id="l23.103"> </span>
<a href="#l23.104"></a><span id="l23.104"> NS_IMETHODIMP nsImapMailFolder::EndCopy(bool copySucceeded)</span>
<a href="#l23.105"></a><span id="l23.105"> {</span>
<a href="#l23.106"></a><span id="l23.106">   nsresult rv = copySucceeded ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l23.107"></a><span id="l23.107" class="difflineat">@@ -3382,17 +3383,17 @@ NS_IMETHODIMP nsImapMailFolder::EndCopy(</span>
<a href="#l23.108"></a><span id="l23.108">     rv = imapService-&gt;AppendMessageFromFile(m_copyState-&gt;m_tmpFile,</span>
<a href="#l23.109"></a><span id="l23.109">                                             this, EmptyCString(), true,</span>
<a href="#l23.110"></a><span id="l23.110">                                             m_copyState-&gt;m_selectedState,</span>
<a href="#l23.111"></a><span id="l23.111">                                             urlListener, nullptr,</span>
<a href="#l23.112"></a><span id="l23.112">                                             copySupport,</span>
<a href="#l23.113"></a><span id="l23.113">                                             m_copyState-&gt;m_msgWindow);</span>
<a href="#l23.114"></a><span id="l23.114">   }</span>
<a href="#l23.115"></a><span id="l23.115">   if (NS_FAILED(rv) || !copySucceeded)</span>
<a href="#l23.116"></a><span id="l23.116" class="difflineminus">-    PR_LOG(IMAP, PR_LOG_ALWAYS, (&quot;EndCopy failed:%lx\n&quot;, rv));</span>
<a href="#l23.117"></a><span id="l23.117" class="difflineplus">+    MOZ_LOG(IMAP, mozilla::LogLevel::Info, (&quot;EndCopy failed:%lx\n&quot;, rv));</span>
<a href="#l23.118"></a><span id="l23.118">   return rv;</span>
<a href="#l23.119"></a><span id="l23.119"> }</span>
<a href="#l23.120"></a><span id="l23.120"> </span>
<a href="#l23.121"></a><span id="l23.121"> NS_IMETHODIMP nsImapMailFolder::EndMove(bool moveSucceeded)</span>
<a href="#l23.122"></a><span id="l23.122"> {</span>
<a href="#l23.123"></a><span id="l23.123">   return NS_OK;</span>
<a href="#l23.124"></a><span id="l23.124"> }</span>
<a href="#l23.125"></a><span id="l23.125"> // this is the beginning of the next message copied</span>
<a href="#l23.126"></a><span id="l23.126" class="difflineat">@@ -4620,17 +4621,17 @@ nsImapMailFolder::NormalEndMsgWriteStrea</span>
<a href="#l23.127"></a><span id="l23.127">   if (updatedMessageSize != -1) {</span>
<a href="#l23.128"></a><span id="l23.128">     // retrieve the message header to update size, if we don't already have it</span>
<a href="#l23.129"></a><span id="l23.129">     nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHeader = m_offlineHeader;</span>
<a href="#l23.130"></a><span id="l23.130">     if (!msgHeader)</span>
<a href="#l23.131"></a><span id="l23.131">       GetMessageHeader(uidOfMessage, getter_AddRefs(msgHeader));</span>
<a href="#l23.132"></a><span id="l23.132">     if (msgHeader) {</span>
<a href="#l23.133"></a><span id="l23.133">       uint32_t msgSize;</span>
<a href="#l23.134"></a><span id="l23.134">       msgHeader-&gt;GetMessageSize(&amp;msgSize);</span>
<a href="#l23.135"></a><span id="l23.135" class="difflineminus">-      PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;Updating stored message size from %u, new size %d&quot;,</span>
<a href="#l23.136"></a><span id="l23.136" class="difflineplus">+      MOZ_LOG(IMAP, mozilla::LogLevel::Debug, (&quot;Updating stored message size from %u, new size %d&quot;,</span>
<a href="#l23.137"></a><span id="l23.137">                                   msgSize, updatedMessageSize));</span>
<a href="#l23.138"></a><span id="l23.138">       msgHeader-&gt;SetMessageSize(updatedMessageSize);</span>
<a href="#l23.139"></a><span id="l23.139">       // only commit here if this isn't an offline message</span>
<a href="#l23.140"></a><span id="l23.140">       // offline header gets committed in EndNewOfflineMessage() called below</span>
<a href="#l23.141"></a><span id="l23.141">       if (mDatabase &amp;&amp; !m_offlineHeader)</span>
<a href="#l23.142"></a><span id="l23.142">         mDatabase-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l23.143"></a><span id="l23.143">     }</span>
<a href="#l23.144"></a><span id="l23.144">     else</span>
<a href="#l23.145"></a><span id="l23.145" class="difflineat">@@ -6770,40 +6771,40 @@ nsImapMailFolder::CopyNextStreamMessage(</span>
<a href="#l23.146"></a><span id="l23.146">   //if copy has failed it could be either user interrupted it or for some other reason</span>
<a href="#l23.147"></a><span id="l23.147">   //don't do any subsequent copies or delete src messages if it is move</span>
<a href="#l23.148"></a><span id="l23.148">   if (!copySucceeded)</span>
<a href="#l23.149"></a><span id="l23.149">     return NS_OK;</span>
<a href="#l23.150"></a><span id="l23.150">   nsresult rv;</span>
<a href="#l23.151"></a><span id="l23.151">   nsCOMPtr&lt;nsImapMailCopyState&gt; mailCopyState = do_QueryInterface(copyState, &amp;rv);</span>
<a href="#l23.152"></a><span id="l23.152">   if (NS_FAILED(rv))</span>
<a href="#l23.153"></a><span id="l23.153">   {</span>
<a href="#l23.154"></a><span id="l23.154" class="difflineminus">-    PR_LOG(IMAP, PR_LOG_ALWAYS, (&quot;QI copyState failed:%lx\n&quot;, rv));</span>
<a href="#l23.155"></a><span id="l23.155" class="difflineplus">+    MOZ_LOG(IMAP, mozilla::LogLevel::Info, (&quot;QI copyState failed:%lx\n&quot;, rv));</span>
<a href="#l23.156"></a><span id="l23.156">     return rv; // this can fail...</span>
<a href="#l23.157"></a><span id="l23.157">   }</span>
<a href="#l23.158"></a><span id="l23.158"> </span>
<a href="#l23.159"></a><span id="l23.159">   if (!mailCopyState-&gt;m_streamCopy)</span>
<a href="#l23.160"></a><span id="l23.160">     return NS_OK;</span>
<a href="#l23.161"></a><span id="l23.161"> </span>
<a href="#l23.162"></a><span id="l23.162" class="difflineminus">-  PR_LOG(IMAP, PR_LOG_ALWAYS, (&quot;CopyNextStreamMessage: Copying %ld of %ld\n&quot;, mailCopyState-&gt;m_curIndex, mailCopyState-&gt;m_totalCount));</span>
<a href="#l23.163"></a><span id="l23.163" class="difflineplus">+  MOZ_LOG(IMAP, mozilla::LogLevel::Info, (&quot;CopyNextStreamMessage: Copying %ld of %ld\n&quot;, mailCopyState-&gt;m_curIndex, mailCopyState-&gt;m_totalCount));</span>
<a href="#l23.164"></a><span id="l23.164">   if (mailCopyState-&gt;m_curIndex &lt; mailCopyState-&gt;m_totalCount)</span>
<a href="#l23.165"></a><span id="l23.165">   {</span>
<a href="#l23.166"></a><span id="l23.166">     mailCopyState-&gt;m_message = do_QueryElementAt(mailCopyState-&gt;m_messages,</span>
<a href="#l23.167"></a><span id="l23.167">                                                  mailCopyState-&gt;m_curIndex,</span>
<a href="#l23.168"></a><span id="l23.168">                                                  &amp;rv);</span>
<a href="#l23.169"></a><span id="l23.169">     if (NS_SUCCEEDED(rv))</span>
<a href="#l23.170"></a><span id="l23.170">     {</span>
<a href="#l23.171"></a><span id="l23.171">       bool isRead;</span>
<a href="#l23.172"></a><span id="l23.172">       mailCopyState-&gt;m_message-&gt;GetIsRead(&amp;isRead);</span>
<a href="#l23.173"></a><span id="l23.173">       mailCopyState-&gt;m_unreadCount = (isRead) ? 0 : 1;</span>
<a href="#l23.174"></a><span id="l23.174">       rv = CopyStreamMessage(mailCopyState-&gt;m_message,</span>
<a href="#l23.175"></a><span id="l23.175">                              this, mailCopyState-&gt;m_msgWindow, mailCopyState-&gt;m_isMove);</span>
<a href="#l23.176"></a><span id="l23.176">     }</span>
<a href="#l23.177"></a><span id="l23.177">     else</span>
<a href="#l23.178"></a><span id="l23.178">     {</span>
<a href="#l23.179"></a><span id="l23.179" class="difflineminus">-      PR_LOG(IMAP, PR_LOG_ALWAYS, (&quot;QueryElementAt %ld failed:%lx\n&quot;, mailCopyState-&gt;m_curIndex, rv));</span>
<a href="#l23.180"></a><span id="l23.180" class="difflineplus">+      MOZ_LOG(IMAP, mozilla::LogLevel::Info, (&quot;QueryElementAt %ld failed:%lx\n&quot;, mailCopyState-&gt;m_curIndex, rv));</span>
<a href="#l23.181"></a><span id="l23.181">     }</span>
<a href="#l23.182"></a><span id="l23.182">   }</span>
<a href="#l23.183"></a><span id="l23.183">   else</span>
<a href="#l23.184"></a><span id="l23.184">   {</span>
<a href="#l23.185"></a><span id="l23.185">     // Notify of move/copy completion in case we have some source headers</span>
<a href="#l23.186"></a><span id="l23.186">     nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l23.187"></a><span id="l23.187">     if (notifier)</span>
<a href="#l23.188"></a><span id="l23.188">     {</span>
<a href="#l23.189"></a><span id="l23.189" class="difflineat">@@ -8145,32 +8146,32 @@ nsImapMailFolder::CopyFileMessage(nsIFil</span>
<a href="#l23.190"></a><span id="l23.190"> </span>
<a href="#l23.191"></a><span id="l23.191"> nsresult</span>
<a href="#l23.192"></a><span id="l23.192"> nsImapMailFolder::CopyStreamMessage(nsIMsgDBHdr* message,</span>
<a href="#l23.193"></a><span id="l23.193">                                     nsIMsgFolder* dstFolder, // should be this</span>
<a href="#l23.194"></a><span id="l23.194">                                     nsIMsgWindow *aMsgWindow,</span>
<a href="#l23.195"></a><span id="l23.195">                                     bool isMove)</span>
<a href="#l23.196"></a><span id="l23.196"> {</span>
<a href="#l23.197"></a><span id="l23.197">   if (!m_copyState)</span>
<a href="#l23.198"></a><span id="l23.198" class="difflineminus">-    PR_LOG(IMAP, PR_LOG_ALWAYS, (&quot;CopyStreamMessage failed with null m_copyState&quot;));</span>
<a href="#l23.199"></a><span id="l23.199" class="difflineplus">+    MOZ_LOG(IMAP, mozilla::LogLevel::Info, (&quot;CopyStreamMessage failed with null m_copyState&quot;));</span>
<a href="#l23.200"></a><span id="l23.200">   NS_ENSURE_TRUE(m_copyState, NS_ERROR_NULL_POINTER);</span>
<a href="#l23.201"></a><span id="l23.201">   nsresult rv;</span>
<a href="#l23.202"></a><span id="l23.202">   nsCOMPtr&lt;nsICopyMessageStreamListener&gt; copyStreamListener = do_CreateInstance(NS_COPYMESSAGESTREAMLISTENER_CONTRACTID, &amp;rv);</span>
<a href="#l23.203"></a><span id="l23.203">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.204"></a><span id="l23.204"> </span>
<a href="#l23.205"></a><span id="l23.205">   nsCOMPtr&lt;nsICopyMessageListener&gt; copyListener(do_QueryInterface(dstFolder, &amp;rv));</span>
<a href="#l23.206"></a><span id="l23.206">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.207"></a><span id="l23.207"> </span>
<a href="#l23.208"></a><span id="l23.208">   nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder(do_QueryInterface(m_copyState-&gt;m_srcSupport, &amp;rv));</span>
<a href="#l23.209"></a><span id="l23.209">   if (NS_FAILED(rv))</span>
<a href="#l23.210"></a><span id="l23.210" class="difflineminus">-    PR_LOG(IMAP, PR_LOG_ALWAYS, (&quot;CopyStreaMessage failed with null m_copyState-&gt;m_srcSupport&quot;));</span>
<a href="#l23.211"></a><span id="l23.211" class="difflineplus">+    MOZ_LOG(IMAP, mozilla::LogLevel::Info, (&quot;CopyStreaMessage failed with null m_copyState-&gt;m_srcSupport&quot;));</span>
<a href="#l23.212"></a><span id="l23.212">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l23.213"></a><span id="l23.213">   rv = copyStreamListener-&gt;Init(srcFolder, copyListener, nullptr);</span>
<a href="#l23.214"></a><span id="l23.214">   if (NS_FAILED(rv))</span>
<a href="#l23.215"></a><span id="l23.215" class="difflineminus">-    PR_LOG(IMAP, PR_LOG_ALWAYS, (&quot;CopyStreaMessage failed in copyStreamListener-&gt;Init&quot;));</span>
<a href="#l23.216"></a><span id="l23.216" class="difflineplus">+    MOZ_LOG(IMAP, mozilla::LogLevel::Info, (&quot;CopyStreaMessage failed in copyStreamListener-&gt;Init&quot;));</span>
<a href="#l23.217"></a><span id="l23.217">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l23.218"></a><span id="l23.218"> </span>
<a href="#l23.219"></a><span id="l23.219">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr(do_QueryInterface(message, &amp;rv));</span>
<a href="#l23.220"></a><span id="l23.220">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l23.221"></a><span id="l23.221"> </span>
<a href="#l23.222"></a><span id="l23.222">   nsCString uri;</span>
<a href="#l23.223"></a><span id="l23.223">   srcFolder-&gt;GetUriForMsg(msgHdr, uri);</span>
<a href="#l23.224"></a><span id="l23.224"> </span>
<a href="#l23.225"></a><span id="l23.225" class="difflineat">@@ -8212,17 +8213,17 @@ nsImapMailFolder::CopyStreamMessage(nsIM</span>
<a href="#l23.226"></a><span id="l23.226">         int32_t percent;</span>
<a href="#l23.227"></a><span id="l23.227">         percent = (100 * m_copyState-&gt;m_curIndex) / (int32_t) m_copyState-&gt;m_totalCount;</span>
<a href="#l23.228"></a><span id="l23.228">           statusFeedback-&gt;ShowProgress(percent);</span>
<a href="#l23.229"></a><span id="l23.229">       }</span>
<a href="#l23.230"></a><span id="l23.230">     }</span>
<a href="#l23.231"></a><span id="l23.231">     rv = m_copyState-&gt;m_msgService-&gt;CopyMessage(uri.get(), streamListener,</span>
<a href="#l23.232"></a><span id="l23.232">                                                 isMove &amp;&amp; !m_copyState-&gt;m_isCrossServerOp, nullptr, aMsgWindow, nullptr);</span>
<a href="#l23.233"></a><span id="l23.233">     if (NS_FAILED(rv))</span>
<a href="#l23.234"></a><span id="l23.234" class="difflineminus">-      PR_LOG(IMAP, PR_LOG_ALWAYS, (&quot;CopyMessage failed: uri %s\n&quot;, uri.get()));</span>
<a href="#l23.235"></a><span id="l23.235" class="difflineplus">+      MOZ_LOG(IMAP, mozilla::LogLevel::Info, (&quot;CopyMessage failed: uri %s\n&quot;, uri.get()));</span>
<a href="#l23.236"></a><span id="l23.236">   } </span>
<a href="#l23.237"></a><span id="l23.237">   return rv;</span>
<a href="#l23.238"></a><span id="l23.238"> }</span>
<a href="#l23.239"></a><span id="l23.239"> </span>
<a href="#l23.240"></a><span id="l23.240"> nsImapMailCopyState::nsImapMailCopyState() :</span>
<a href="#l23.241"></a><span id="l23.241">     m_isMove(false), m_selectedState(false),</span>
<a href="#l23.242"></a><span id="l23.242">     m_isCrossServerOp(false), m_curIndex(0),</span>
<a href="#l23.243"></a><span id="l23.243">     m_totalCount(0), m_streamCopy(false), m_dataBuffer(nullptr),</span>
<a href="#l23.244"></a><span id="l23.244" class="difflineat">@@ -9566,28 +9567,28 @@ NS_IMETHODIMP nsImapMailFolder::GetAutoS</span>
<a href="#l23.245"></a><span id="l23.245">   NS_IF_ADDREF(*autoSyncStateObj = m_autoSyncStateObj);</span>
<a href="#l23.246"></a><span id="l23.246">   return NS_OK;</span>
<a href="#l23.247"></a><span id="l23.247"> }</span>
<a href="#l23.248"></a><span id="l23.248"> </span>
<a href="#l23.249"></a><span id="l23.249"> NS_IMETHODIMP nsImapMailFolder::InitiateAutoSync(nsIUrlListener *aUrlListener)</span>
<a href="#l23.250"></a><span id="l23.250"> {</span>
<a href="#l23.251"></a><span id="l23.251">   nsCString folderName;</span>
<a href="#l23.252"></a><span id="l23.252">   GetURI(folderName);</span>
<a href="#l23.253"></a><span id="l23.253" class="difflineminus">-  PR_LOG(gAutoSyncLog, PR_LOG_DEBUG, (&quot;Updating folder: %s\n&quot;, folderName.get()));</span>
<a href="#l23.254"></a><span id="l23.254" class="difflineplus">+  MOZ_LOG(gAutoSyncLog, mozilla::LogLevel::Debug, (&quot;Updating folder: %s\n&quot;, folderName.get()));</span>
<a href="#l23.255"></a><span id="l23.255"> </span>
<a href="#l23.256"></a><span id="l23.256">   // HACK: if UpdateFolder finds out that it can't open </span>
<a href="#l23.257"></a><span id="l23.257">   // the folder, it doesn't set the url listener and returns </span>
<a href="#l23.258"></a><span id="l23.258">   // no error. In this case, we return success from this call </span>
<a href="#l23.259"></a><span id="l23.259">   // but the caller never gets a notification on its url listener.</span>
<a href="#l23.260"></a><span id="l23.260">   bool canOpenThisFolder = true;</span>
<a href="#l23.261"></a><span id="l23.261">   GetCanOpenFolder(&amp;canOpenThisFolder);</span>
<a href="#l23.262"></a><span id="l23.262">   </span>
<a href="#l23.263"></a><span id="l23.263">   if (!canOpenThisFolder)</span>
<a href="#l23.264"></a><span id="l23.264">   {</span>
<a href="#l23.265"></a><span id="l23.265" class="difflineminus">-    PR_LOG(gAutoSyncLog, PR_LOG_DEBUG, (&quot;Cannot update folder: %s\n&quot;, folderName.get()));</span>
<a href="#l23.266"></a><span id="l23.266" class="difflineplus">+    MOZ_LOG(gAutoSyncLog, mozilla::LogLevel::Debug, (&quot;Cannot update folder: %s\n&quot;, folderName.get()));</span>
<a href="#l23.267"></a><span id="l23.267">     return NS_ERROR_FAILURE;</span>
<a href="#l23.268"></a><span id="l23.268">   }</span>
<a href="#l23.269"></a><span id="l23.269"> </span>
<a href="#l23.270"></a><span id="l23.270">   // create auto-sync state object lazily</span>
<a href="#l23.271"></a><span id="l23.271">   InitAutoSyncState();</span>
<a href="#l23.272"></a><span id="l23.272"> </span>
<a href="#l23.273"></a><span id="l23.273">   // make sure we get the counts from the folder cache.</span>
<a href="#l23.274"></a><span id="l23.274">   ReadDBFolderInfo(false);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -69,16 +69,18 @@ PRLogModuleInfo *IMAP;</span>
<a href="#l24.4"></a><span id="l24.4"> #include &quot;nsIStreamConverterService.h&quot;</span>
<a href="#l24.5"></a><span id="l24.5"> #include &quot;nsIProxyInfo.h&quot;</span>
<a href="#l24.6"></a><span id="l24.6"> #include &quot;nsISSLSocketControl.h&quot;</span>
<a href="#l24.7"></a><span id="l24.7"> #include &quot;nsProxyRelease.h&quot;</span>
<a href="#l24.8"></a><span id="l24.8"> #include &quot;nsDebug.h&quot;</span>
<a href="#l24.9"></a><span id="l24.9"> #include &quot;nsMsgCompressIStream.h&quot;</span>
<a href="#l24.10"></a><span id="l24.10"> #include &quot;nsMsgCompressOStream.h&quot;</span>
<a href="#l24.11"></a><span id="l24.11"> #include &quot;nsAlgorithm.h&quot;</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+</span>
<a href="#l24.14"></a><span id="l24.14"> using namespace mozilla;</span>
<a href="#l24.15"></a><span id="l24.15"> </span>
<a href="#l24.16"></a><span id="l24.16"> #define ONE_SECOND ((uint32_t)1000)    // one second</span>
<a href="#l24.17"></a><span id="l24.17"> </span>
<a href="#l24.18"></a><span id="l24.18"> #define OUTPUT_BUFFER_SIZE (4096*2) // mscott - i should be able to remove this if I can use nsMsgLineBuffer???</span>
<a href="#l24.19"></a><span id="l24.19"> </span>
<a href="#l24.20"></a><span id="l24.20"> #define IMAP_ENV_HEADERS &quot;From To Cc Bcc Subject Date Message-ID &quot;</span>
<a href="#l24.21"></a><span id="l24.21"> #define IMAP_DB_HEADERS &quot;Priority X-Priority References Newsgroups In-Reply-To Content-Type Reply-To&quot;</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineat">@@ -1325,17 +1327,17 @@ nsImapProtocol::PseudoInterruptMsgLoad(n</span>
<a href="#l24.23"></a><span id="l24.23">   printf(&quot;interrupt msg load : %s\n&quot;, (*interrupted) ? &quot;TRUE&quot; : &quot;FALSE&quot;);</span>
<a href="#l24.24"></a><span id="l24.24"> #endif</span>
<a href="#l24.25"></a><span id="l24.25">   return NS_OK;</span>
<a href="#l24.26"></a><span id="l24.26"> }</span>
<a href="#l24.27"></a><span id="l24.27"> </span>
<a href="#l24.28"></a><span id="l24.28"> void</span>
<a href="#l24.29"></a><span id="l24.29"> nsImapProtocol::ImapThreadMainLoop()</span>
<a href="#l24.30"></a><span id="l24.30"> {</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineminus">-  PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;ImapThreadMainLoop entering [this=%x]\n&quot;, this));</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineplus">+  MOZ_LOG(IMAP, LogLevel::Debug, (&quot;ImapThreadMainLoop entering [this=%x]\n&quot;, this));</span>
<a href="#l24.33"></a><span id="l24.33"> </span>
<a href="#l24.34"></a><span id="l24.34">   PRIntervalTime sleepTime = kImapSleepTime;</span>
<a href="#l24.35"></a><span id="l24.35">   while (!DeathSignalReceived())</span>
<a href="#l24.36"></a><span id="l24.36">   {</span>
<a href="#l24.37"></a><span id="l24.37">     nsresult rv = NS_OK;</span>
<a href="#l24.38"></a><span id="l24.38">     bool readyToRun;</span>
<a href="#l24.39"></a><span id="l24.39"> </span>
<a href="#l24.40"></a><span id="l24.40">     // wait for an URL to process...</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineat">@@ -1413,17 +1415,17 @@ nsImapProtocol::ImapThreadMainLoop()</span>
<a href="#l24.42"></a><span id="l24.42"> #endif</span>
<a href="#l24.43"></a><span id="l24.43">     // This can happen if the UI thread closes cached connections in the</span>
<a href="#l24.44"></a><span id="l24.44">     // OnStopRunningUrl notification.</span>
<a href="#l24.45"></a><span id="l24.45">     if (m_threadShouldDie)</span>
<a href="#l24.46"></a><span id="l24.46">       TellThreadToDie();</span>
<a href="#l24.47"></a><span id="l24.47">   }</span>
<a href="#l24.48"></a><span id="l24.48">   m_imapThreadIsRunning = false;</span>
<a href="#l24.49"></a><span id="l24.49"> </span>
<a href="#l24.50"></a><span id="l24.50" class="difflineminus">-  PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;ImapThreadMainLoop leaving [this=%x]\n&quot;, this));</span>
<a href="#l24.51"></a><span id="l24.51" class="difflineplus">+  MOZ_LOG(IMAP, LogLevel::Debug, (&quot;ImapThreadMainLoop leaving [this=%x]\n&quot;, this));</span>
<a href="#l24.52"></a><span id="l24.52"> }</span>
<a href="#l24.53"></a><span id="l24.53"> </span>
<a href="#l24.54"></a><span id="l24.54"> void nsImapProtocol::HandleIdleResponses()</span>
<a href="#l24.55"></a><span id="l24.55"> {</span>
<a href="#l24.56"></a><span id="l24.56">   // int32_t oldRecent = GetServerStateParser().NumberOfRecentMessages();</span>
<a href="#l24.57"></a><span id="l24.57">   nsAutoCString commandBuffer(GetServerCommandTag());</span>
<a href="#l24.58"></a><span id="l24.58">   commandBuffer.Append(&quot; IDLE&quot; CRLF);</span>
<a href="#l24.59"></a><span id="l24.59"> </span>
<a href="#l24.60"></a><span id="l24.60" class="difflineat">@@ -1837,29 +1839,29 @@ bool nsImapProtocol::ProcessCurrentURL()</span>
<a href="#l24.61"></a><span id="l24.61">   if (imapMailFolderSink)</span>
<a href="#l24.62"></a><span id="l24.62">   {</span>
<a href="#l24.63"></a><span id="l24.63">     if (copyState)</span>
<a href="#l24.64"></a><span id="l24.64">     {</span>
<a href="#l24.65"></a><span id="l24.65">       rv = imapMailFolderSink-&gt;CopyNextStreamMessage(GetServerStateParser().LastCommandSuccessful() &amp;&amp;</span>
<a href="#l24.66"></a><span id="l24.66">                                                 NS_SUCCEEDED(GetConnectionStatus()),</span>
<a href="#l24.67"></a><span id="l24.67">                                                 copyState);</span>
<a href="#l24.68"></a><span id="l24.68">       if (NS_FAILED(rv))</span>
<a href="#l24.69"></a><span id="l24.69" class="difflineminus">-        PR_LOG(IMAP, PR_LOG_ALWAYS, (&quot;CopyNextStreamMessage failed:%lx\n&quot;, rv));</span>
<a href="#l24.70"></a><span id="l24.70" class="difflineplus">+        MOZ_LOG(IMAP, LogLevel::Info, (&quot;CopyNextStreamMessage failed:%lx\n&quot;, rv));</span>
<a href="#l24.71"></a><span id="l24.71"> </span>
<a href="#l24.72"></a><span id="l24.72">       nsCOMPtr&lt;nsIThread&gt; thread = do_GetMainThread();</span>
<a href="#l24.73"></a><span id="l24.73">       nsISupports *doomed = nullptr;</span>
<a href="#l24.74"></a><span id="l24.74">       copyState.swap(doomed);</span>
<a href="#l24.75"></a><span id="l24.75">       NS_ProxyRelease(thread, doomed);</span>
<a href="#l24.76"></a><span id="l24.76">     }</span>
<a href="#l24.77"></a><span id="l24.77">     // we might need this to stick around for IDLE support</span>
<a href="#l24.78"></a><span id="l24.78">     m_imapMailFolderSink = imapMailFolderSink;</span>
<a href="#l24.79"></a><span id="l24.79">     imapMailFolderSink = nullptr;</span>
<a href="#l24.80"></a><span id="l24.80">   }</span>
<a href="#l24.81"></a><span id="l24.81">   else</span>
<a href="#l24.82"></a><span id="l24.82" class="difflineminus">-    PR_LOG(IMAP, PR_LOG_ALWAYS, (&quot;null imapMailFolderSink\n&quot;));</span>
<a href="#l24.83"></a><span id="l24.83" class="difflineplus">+    MOZ_LOG(IMAP, LogLevel::Info, (&quot;null imapMailFolderSink\n&quot;));</span>
<a href="#l24.84"></a><span id="l24.84"> </span>
<a href="#l24.85"></a><span id="l24.85">   // now try queued urls, now that we've released this connection.</span>
<a href="#l24.86"></a><span id="l24.86">   if (m_imapServerSink)</span>
<a href="#l24.87"></a><span id="l24.87">   {</span>
<a href="#l24.88"></a><span id="l24.88">     if (NS_SUCCEEDED(GetConnectionStatus()))</span>
<a href="#l24.89"></a><span id="l24.89">       rv = m_imapServerSink-&gt;LoadNextQueuedUrl(this, &amp;anotherUrlRun);</span>
<a href="#l24.90"></a><span id="l24.90">     else // if we don't do this, they'll just sit and spin until</span>
<a href="#l24.91"></a><span id="l24.91">           // we run some other url on this server.</span>
<a href="#l24.92"></a><span id="l24.92" class="difflineat">@@ -2334,17 +2336,17 @@ NS_IMETHODIMP nsImapProtocol::CanHandleU</span>
<a href="#l24.93"></a><span id="l24.93">               {</span>
<a href="#l24.94"></a><span id="l24.94">                 if (isBusy)</span>
<a href="#l24.95"></a><span id="l24.95">                   *hasToWait = true;</span>
<a href="#l24.96"></a><span id="l24.96">                 else</span>
<a href="#l24.97"></a><span id="l24.97">                   *aCanRunUrl = true;</span>
<a href="#l24.98"></a><span id="l24.98">               }</span>
<a href="#l24.99"></a><span id="l24.99">             }</span>
<a href="#l24.100"></a><span id="l24.100">           }</span>
<a href="#l24.101"></a><span id="l24.101" class="difflineminus">-          PR_LOG(IMAP, PR_LOG_DEBUG,</span>
<a href="#l24.102"></a><span id="l24.102" class="difflineplus">+          MOZ_LOG(IMAP, LogLevel::Debug,</span>
<a href="#l24.103"></a><span id="l24.103">                  (&quot;proposed url = %s folder for connection %s has To Wait = %s can run = %s&quot;,</span>
<a href="#l24.104"></a><span id="l24.104">                   folderNameForProposedUrl, curSelectedUrlFolderName.get(),</span>
<a href="#l24.105"></a><span id="l24.105">                   (*hasToWait) ? &quot;TRUE&quot; : &quot;FALSE&quot;, (*aCanRunUrl) ? &quot;TRUE&quot; : &quot;FALSE&quot;));</span>
<a href="#l24.106"></a><span id="l24.106">           PR_FREEIF(folderNameForProposedUrl);</span>
<a href="#l24.107"></a><span id="l24.107">         }</span>
<a href="#l24.108"></a><span id="l24.108">       }</span>
<a href="#l24.109"></a><span id="l24.109">       else // *** jt - an authenticated state url can be run in either</span>
<a href="#l24.110"></a><span id="l24.110">         // authenticated or selected state</span>
<a href="#l24.111"></a><span id="l24.111" class="difflineat">@@ -2578,25 +2580,25 @@ void nsImapProtocol::ProcessSelectedStat</span>
<a href="#l24.112"></a><span id="l24.112">                 nsRefPtr&lt;nsIMAPBodyShell&gt; foundShell;</span>
<a href="#l24.113"></a><span id="l24.113">                 res = m_hostSessionList-&gt;FindShellInCacheForHost(GetImapServerKey(),</span>
<a href="#l24.114"></a><span id="l24.114">                   GetServerStateParser().GetSelectedMailboxName(),</span>
<a href="#l24.115"></a><span id="l24.115">                   messageIdString.get(), modType, getter_AddRefs(foundShell));</span>
<a href="#l24.116"></a><span id="l24.116">                 if (!foundShell)</span>
<a href="#l24.117"></a><span id="l24.117">                 {</span>
<a href="#l24.118"></a><span id="l24.118">                   // The shell wasn't in the cache.  Deal with this case later.</span>
<a href="#l24.119"></a><span id="l24.119">                   Log(&quot;SHELL&quot;,NULL,&quot;Loading part, shell not found in cache!&quot;);</span>
<a href="#l24.120"></a><span id="l24.120" class="difflineminus">-                  //PR_LOG(IMAP, out, (&quot;BODYSHELL: Loading part, shell not found in cache!&quot;));</span>
<a href="#l24.121"></a><span id="l24.121" class="difflineplus">+                  //MOZ_LOG(IMAP, out, (&quot;BODYSHELL: Loading part, shell not found in cache!&quot;));</span>
<a href="#l24.122"></a><span id="l24.122">                   // The parser will extract the part number from the current URL.</span>
<a href="#l24.123"></a><span id="l24.123">                   SetContentModified(modType);</span>
<a href="#l24.124"></a><span id="l24.124">                   Bodystructure(messageIdString, bMessageIdsAreUids);</span>
<a href="#l24.125"></a><span id="l24.125">                 }</span>
<a href="#l24.126"></a><span id="l24.126">                 else</span>
<a href="#l24.127"></a><span id="l24.127">                 {</span>
<a href="#l24.128"></a><span id="l24.128">                   Log(&quot;SHELL&quot;, NULL, &quot;Loading Part, using cached shell.&quot;);</span>
<a href="#l24.129"></a><span id="l24.129" class="difflineminus">-                  //PR_LOG(IMAP, out, (&quot;BODYSHELL: Loading part, using cached shell.&quot;));</span>
<a href="#l24.130"></a><span id="l24.130" class="difflineplus">+                  //MOZ_LOG(IMAP, out, (&quot;BODYSHELL: Loading part, using cached shell.&quot;));</span>
<a href="#l24.131"></a><span id="l24.131">                   SetContentModified(modType);</span>
<a href="#l24.132"></a><span id="l24.132">                   foundShell-&gt;SetConnection(this);</span>
<a href="#l24.133"></a><span id="l24.133">                   GetServerStateParser().UseCachedShell(foundShell);</span>
<a href="#l24.134"></a><span id="l24.134">                   //Set the current uid in server state parser (in case it was used for new mail msgs earlier).</span>
<a href="#l24.135"></a><span id="l24.135">                   GetServerStateParser().SetCurrentResponseUID((uint32_t)atoi(messageIdString.get()));</span>
<a href="#l24.136"></a><span id="l24.136">                   foundShell-&gt;Generate(imappart);</span>
<a href="#l24.137"></a><span id="l24.137">                   GetServerStateParser().UseCachedShell(NULL);</span>
<a href="#l24.138"></a><span id="l24.138">                 }</span>
<a href="#l24.139"></a><span id="l24.139" class="difflineat">@@ -2624,17 +2626,17 @@ void nsImapProtocol::ProcessSelectedStat</span>
<a href="#l24.140"></a><span id="l24.140">               m_runningUrl-&gt;GetFetchPartsOnDemand(&amp;urlOKToFetchByParts);</span>
<a href="#l24.141"></a><span id="l24.141"> </span>
<a href="#l24.142"></a><span id="l24.142"> #ifdef PR_LOGGING</span>
<a href="#l24.143"></a><span id="l24.143">               {</span>
<a href="#l24.144"></a><span id="l24.144">                 nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(m_runningUrl);</span>
<a href="#l24.145"></a><span id="l24.145">                 nsAutoCString urlSpec;</span>
<a href="#l24.146"></a><span id="l24.146">                 if (mailnewsurl)</span>
<a href="#l24.147"></a><span id="l24.147">                   mailnewsurl-&gt;GetSpec(urlSpec);</span>
<a href="#l24.148"></a><span id="l24.148" class="difflineminus">-                PR_LOG(IMAP, PR_LOG_DEBUG,</span>
<a href="#l24.149"></a><span id="l24.149" class="difflineplus">+                MOZ_LOG(IMAP, LogLevel::Debug,</span>
<a href="#l24.150"></a><span id="l24.150">                        (&quot;SHELL: URL %s, OKToFetchByParts %d, allowedToBreakApart %d, ShouldFetchAllParts %d&quot;,</span>
<a href="#l24.151"></a><span id="l24.151">                         urlSpec.get(), urlOKToFetchByParts, allowedToBreakApart,</span>
<a href="#l24.152"></a><span id="l24.152">                         GetShouldFetchAllParts()));</span>
<a href="#l24.153"></a><span id="l24.153">               }</span>
<a href="#l24.154"></a><span id="l24.154"> #endif</span>
<a href="#l24.155"></a><span id="l24.155"> </span>
<a href="#l24.156"></a><span id="l24.156">               if (urlOKToFetchByParts &amp;&amp;</span>
<a href="#l24.157"></a><span id="l24.157">                   allowedToBreakApart &amp;&amp;</span>
<a href="#l24.158"></a><span id="l24.158" class="difflineat">@@ -2668,17 +2670,17 @@ void nsImapProtocol::ProcessSelectedStat</span>
<a href="#l24.159"></a><span id="l24.159">                 if (bMessageIdsAreUids)</span>
<a href="#l24.160"></a><span id="l24.160">                 {</span>
<a href="#l24.161"></a><span id="l24.161">                   res = m_hostSessionList-&gt;FindShellInCacheForHost(GetImapServerKey(),</span>
<a href="#l24.162"></a><span id="l24.162">                     GetServerStateParser().GetSelectedMailboxName(),</span>
<a href="#l24.163"></a><span id="l24.163">                     messageIdString.get(), modType, getter_AddRefs(foundShell));</span>
<a href="#l24.164"></a><span id="l24.164">                   if (foundShell)</span>
<a href="#l24.165"></a><span id="l24.165">                   {</span>
<a href="#l24.166"></a><span id="l24.166">                     Log(&quot;SHELL&quot;,NULL,&quot;Loading message, using cached shell.&quot;);</span>
<a href="#l24.167"></a><span id="l24.167" class="difflineminus">-                    //PR_LOG(IMAP, out, (&quot;BODYSHELL: Loading message, using cached shell.&quot;));</span>
<a href="#l24.168"></a><span id="l24.168" class="difflineplus">+                    //MOZ_LOG(IMAP, out, (&quot;BODYSHELL: Loading message, using cached shell.&quot;));</span>
<a href="#l24.169"></a><span id="l24.169">                     foundShell-&gt;SetConnection(this);</span>
<a href="#l24.170"></a><span id="l24.170">                     GetServerStateParser().UseCachedShell(foundShell);</span>
<a href="#l24.171"></a><span id="l24.171">                     //Set the current uid in server state parser (in case it was used for new mail msgs earlier).</span>
<a href="#l24.172"></a><span id="l24.172">                     GetServerStateParser().SetCurrentResponseUID((uint32_t)atoi(messageIdString.get()));</span>
<a href="#l24.173"></a><span id="l24.173">                     foundShell-&gt;Generate(NULL);</span>
<a href="#l24.174"></a><span id="l24.174">                     GetServerStateParser().UseCachedShell(NULL);</span>
<a href="#l24.175"></a><span id="l24.175">                   }</span>
<a href="#l24.176"></a><span id="l24.176">                 }</span>
<a href="#l24.177"></a><span id="l24.177" class="difflineat">@@ -3319,17 +3321,17 @@ nsImapProtocol::FetchMessage(const nsCSt</span>
<a href="#l24.178"></a><span id="l24.178">   switch (whatToFetch) {</span>
<a href="#l24.179"></a><span id="l24.179">   case kEveryThingRFC822:</span>
<a href="#l24.180"></a><span id="l24.180">     m_flagChangeCount++;</span>
<a href="#l24.181"></a><span id="l24.181">     m_fetchingWholeMessage = true;</span>
<a href="#l24.182"></a><span id="l24.182">     if (m_trackingTime)</span>
<a href="#l24.183"></a><span id="l24.183">       AdjustChunkSize();      // we started another segment</span>
<a href="#l24.184"></a><span id="l24.184">     m_startTime = PR_Now();     // save start of download time</span>
<a href="#l24.185"></a><span id="l24.185">     m_trackingTime = true;</span>
<a href="#l24.186"></a><span id="l24.186" class="difflineminus">-    PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;FetchMessage everything: curFetchSize %u numBytes %u&quot;,</span>
<a href="#l24.187"></a><span id="l24.187" class="difflineplus">+    MOZ_LOG(IMAP, LogLevel::Debug, (&quot;FetchMessage everything: curFetchSize %u numBytes %u&quot;,</span>
<a href="#l24.188"></a><span id="l24.188">                                 m_curFetchSize, numBytes));</span>
<a href="#l24.189"></a><span id="l24.189">     if (numBytes &gt; 0)</span>
<a href="#l24.190"></a><span id="l24.190">       m_curFetchSize = numBytes;</span>
<a href="#l24.191"></a><span id="l24.191"> </span>
<a href="#l24.192"></a><span id="l24.192">     if (GetServerStateParser().ServerHasIMAP4Rev1Capability())</span>
<a href="#l24.193"></a><span id="l24.193">     {</span>
<a href="#l24.194"></a><span id="l24.194">       if (GetServerStateParser().GetCapabilityFlag() &amp; kHasXSenderCapability)</span>
<a href="#l24.195"></a><span id="l24.195">         commandString.Append(&quot; %s (XSENDER UID RFC822.SIZE BODY[]&quot;);</span>
<a href="#l24.196"></a><span id="l24.196" class="difflineat">@@ -3354,17 +3356,17 @@ nsImapProtocol::FetchMessage(const nsCSt</span>
<a href="#l24.197"></a><span id="l24.197">       }</span>
<a href="#l24.198"></a><span id="l24.198">     }</span>
<a href="#l24.199"></a><span id="l24.199">     commandString.Append(&quot;)&quot;);</span>
<a href="#l24.200"></a><span id="l24.200"> </span>
<a href="#l24.201"></a><span id="l24.201">     break;</span>
<a href="#l24.202"></a><span id="l24.202"> </span>
<a href="#l24.203"></a><span id="l24.203">   case kEveryThingRFC822Peek:</span>
<a href="#l24.204"></a><span id="l24.204">     {</span>
<a href="#l24.205"></a><span id="l24.205" class="difflineminus">-      PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;FetchMessage peek: curFetchSize %u numBytes %u&quot;,</span>
<a href="#l24.206"></a><span id="l24.206" class="difflineplus">+      MOZ_LOG(IMAP, LogLevel::Debug, (&quot;FetchMessage peek: curFetchSize %u numBytes %u&quot;,</span>
<a href="#l24.207"></a><span id="l24.207">                                   m_curFetchSize, numBytes));</span>
<a href="#l24.208"></a><span id="l24.208">       if (numBytes &gt; 0)</span>
<a href="#l24.209"></a><span id="l24.209">         m_curFetchSize = numBytes;</span>
<a href="#l24.210"></a><span id="l24.210">       const char *formatString = &quot;&quot;;</span>
<a href="#l24.211"></a><span id="l24.211">       eIMAPCapabilityFlags server_capabilityFlags = GetServerStateParser().GetCapabilityFlag();</span>
<a href="#l24.212"></a><span id="l24.212"> </span>
<a href="#l24.213"></a><span id="l24.213">       m_fetchingWholeMessage = true;</span>
<a href="#l24.214"></a><span id="l24.214">       if (server_capabilityFlags &amp; kIMAP4rev1Capability)</span>
<a href="#l24.215"></a><span id="l24.215" class="difflineat">@@ -3580,17 +3582,17 @@ nsImapProtocol::FetchMessage(const nsCSt</span>
<a href="#l24.216"></a><span id="l24.216"> void nsImapProtocol::FetchTryChunking(const nsCString &amp;messageIds,</span>
<a href="#l24.217"></a><span id="l24.217">                                       nsIMAPeFetchFields whatToFetch,</span>
<a href="#l24.218"></a><span id="l24.218">                                       bool idIsUid,</span>
<a href="#l24.219"></a><span id="l24.219">                                       char *part,</span>
<a href="#l24.220"></a><span id="l24.220">                                       uint32_t downloadSize,</span>
<a href="#l24.221"></a><span id="l24.221">                                       bool tryChunking)</span>
<a href="#l24.222"></a><span id="l24.222"> {</span>
<a href="#l24.223"></a><span id="l24.223">   GetServerStateParser().SetTotalDownloadSize(downloadSize);</span>
<a href="#l24.224"></a><span id="l24.224" class="difflineminus">-  PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;FetchTryChunking: curFetchSize %u&quot;, downloadSize));</span>
<a href="#l24.225"></a><span id="l24.225" class="difflineplus">+  MOZ_LOG(IMAP, LogLevel::Debug, (&quot;FetchTryChunking: curFetchSize %u&quot;, downloadSize));</span>
<a href="#l24.226"></a><span id="l24.226">   m_curFetchSize = downloadSize; // we'll change this if chunking.</span>
<a href="#l24.227"></a><span id="l24.227">   if (m_fetchByChunks &amp;&amp; tryChunking &amp;&amp;</span>
<a href="#l24.228"></a><span id="l24.228">         GetServerStateParser().ServerHasIMAP4Rev1Capability() &amp;&amp;</span>
<a href="#l24.229"></a><span id="l24.229">     (downloadSize &gt; (uint32_t) m_chunkThreshold))</span>
<a href="#l24.230"></a><span id="l24.230">   {</span>
<a href="#l24.231"></a><span id="l24.231">     uint32_t startByte = 0;</span>
<a href="#l24.232"></a><span id="l24.232">     GetServerStateParser().ClearLastFetchChunkReceived();</span>
<a href="#l24.233"></a><span id="l24.233">     while (!DeathSignalReceived() &amp;&amp; !GetPseudoInterrupted() &amp;&amp;</span>
<a href="#l24.234"></a><span id="l24.234" class="difflineat">@@ -3941,17 +3943,17 @@ void nsImapProtocol::NormalMessageEndDow</span>
<a href="#l24.235"></a><span id="l24.235">   if (!GetServerStateParser().GetDownloadingHeaders())</span>
<a href="#l24.236"></a><span id="l24.236">   {</span>
<a href="#l24.237"></a><span id="l24.237">     int32_t updatedMessageSize = -1;</span>
<a href="#l24.238"></a><span id="l24.238">     if (m_fetchingWholeMessage)</span>
<a href="#l24.239"></a><span id="l24.239">     {</span>
<a href="#l24.240"></a><span id="l24.240">       updatedMessageSize = m_bytesToChannel;</span>
<a href="#l24.241"></a><span id="l24.241"> #ifdef PR_LOGGING</span>
<a href="#l24.242"></a><span id="l24.242">       if (m_bytesToChannel != GetServerStateParser().SizeOfMostRecentMessage()) {</span>
<a href="#l24.243"></a><span id="l24.243" class="difflineminus">-        PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;STREAM:CLOSE Server's RFC822.SIZE %u, actual size %u&quot;,</span>
<a href="#l24.244"></a><span id="l24.244" class="difflineplus">+        MOZ_LOG(IMAP, LogLevel::Debug, (&quot;STREAM:CLOSE Server's RFC822.SIZE %u, actual size %u&quot;,</span>
<a href="#l24.245"></a><span id="l24.245">                                     GetServerStateParser().SizeOfMostRecentMessage(),</span>
<a href="#l24.246"></a><span id="l24.246">                                     m_bytesToChannel));</span>
<a href="#l24.247"></a><span id="l24.247">       }</span>
<a href="#l24.248"></a><span id="l24.248"> #endif</span>
<a href="#l24.249"></a><span id="l24.249">     }</span>
<a href="#l24.250"></a><span id="l24.250">     // need to know if we're downloading for display or not. We'll use action == nsImapMsgFetch for now</span>
<a href="#l24.251"></a><span id="l24.251">     nsImapAction imapAction = nsIImapUrl::nsImapSelectFolder; // just set it to some legal value</span>
<a href="#l24.252"></a><span id="l24.252">     if (m_runningUrl)</span>
<a href="#l24.253"></a><span id="l24.253" class="difflineat">@@ -4362,33 +4364,33 @@ bool nsImapProtocol::CheckNewMail()</span>
<a href="#l24.254"></a><span id="l24.254"> }</span>
<a href="#l24.255"></a><span id="l24.255"> </span>
<a href="#l24.256"></a><span id="l24.256"> /* static */ void nsImapProtocol::LogImapUrl(const char *logMsg, nsIImapUrl *imapUrl)</span>
<a href="#l24.257"></a><span id="l24.257"> {</span>
<a href="#l24.258"></a><span id="l24.258">   // nsImapProtocol is not always constructed before this static method is called</span>
<a href="#l24.259"></a><span id="l24.259">   if (!IMAP)</span>
<a href="#l24.260"></a><span id="l24.260">     IMAP = PR_NewLogModule(&quot;IMAP&quot;);</span>
<a href="#l24.261"></a><span id="l24.261"> </span>
<a href="#l24.262"></a><span id="l24.262" class="difflineminus">-  if (PR_LOG_TEST(IMAP, PR_LOG_ALWAYS))</span>
<a href="#l24.263"></a><span id="l24.263" class="difflineplus">+  if (MOZ_LOG_TEST(IMAP, LogLevel::Info))</span>
<a href="#l24.264"></a><span id="l24.264">   {</span>
<a href="#l24.265"></a><span id="l24.265">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(imapUrl);</span>
<a href="#l24.266"></a><span id="l24.266">     if (mailnewsUrl)</span>
<a href="#l24.267"></a><span id="l24.267">     {</span>
<a href="#l24.268"></a><span id="l24.268">       nsAutoCString urlSpec, unescapedUrlSpec;</span>
<a href="#l24.269"></a><span id="l24.269">       mailnewsUrl-&gt;GetSpec(urlSpec);</span>
<a href="#l24.270"></a><span id="l24.270">       MsgUnescapeString(urlSpec, 0, unescapedUrlSpec);</span>
<a href="#l24.271"></a><span id="l24.271" class="difflineminus">-      PR_LOG(IMAP, PR_LOG_ALWAYS, (&quot;%s:%s&quot;, logMsg, unescapedUrlSpec.get()));</span>
<a href="#l24.272"></a><span id="l24.272" class="difflineplus">+      MOZ_LOG(IMAP, LogLevel::Info, (&quot;%s:%s&quot;, logMsg, unescapedUrlSpec.get()));</span>
<a href="#l24.273"></a><span id="l24.273">     }</span>
<a href="#l24.274"></a><span id="l24.274">   }</span>
<a href="#l24.275"></a><span id="l24.275"> }</span>
<a href="#l24.276"></a><span id="l24.276"> </span>
<a href="#l24.277"></a><span id="l24.277"> // log info including current state...</span>
<a href="#l24.278"></a><span id="l24.278"> void nsImapProtocol::Log(const char *logSubName, const char *extraInfo, const char *logData)</span>
<a href="#l24.279"></a><span id="l24.279"> {</span>
<a href="#l24.280"></a><span id="l24.280" class="difflineminus">-  if (PR_LOG_TEST(IMAP, PR_LOG_ALWAYS))</span>
<a href="#l24.281"></a><span id="l24.281" class="difflineplus">+  if (MOZ_LOG_TEST(IMAP, LogLevel::Info))</span>
<a href="#l24.282"></a><span id="l24.282">   {</span>
<a href="#l24.283"></a><span id="l24.283">     static const char nonAuthStateName[] = &quot;NA&quot;;</span>
<a href="#l24.284"></a><span id="l24.284">     static const char authStateName[] = &quot;A&quot;;</span>
<a href="#l24.285"></a><span id="l24.285">     static const char selectedStateName[] = &quot;S&quot;;</span>
<a href="#l24.286"></a><span id="l24.286">     const nsCString&amp; hostName = GetImapHostName();  // initilize to empty string</span>
<a href="#l24.287"></a><span id="l24.287"> </span>
<a href="#l24.288"></a><span id="l24.288">     int32_t logDataLen = PL_strlen(logData); // PL_strlen checks for null</span>
<a href="#l24.289"></a><span id="l24.289">     nsCString logDataLines;</span>
<a href="#l24.290"></a><span id="l24.290" class="difflineat">@@ -4414,51 +4416,51 @@ void nsImapProtocol::Log(const char *log</span>
<a href="#l24.291"></a><span id="l24.291">     {</span>
<a href="#l24.292"></a><span id="l24.292">       logDataToLog = logData;</span>
<a href="#l24.293"></a><span id="l24.293">       lastLineEnd = logDataLen;</span>
<a href="#l24.294"></a><span id="l24.294">     }</span>
<a href="#l24.295"></a><span id="l24.295">     switch (GetServerStateParser().GetIMAPstate())</span>
<a href="#l24.296"></a><span id="l24.296">     {</span>
<a href="#l24.297"></a><span id="l24.297">     case nsImapServerResponseParser::kFolderSelected:</span>
<a href="#l24.298"></a><span id="l24.298">       if (extraInfo)</span>
<a href="#l24.299"></a><span id="l24.299" class="difflineminus">-        PR_LOG(IMAP, PR_LOG_ALWAYS, (&quot;%x:%s:%s-%s:%s:%s: %.400s&quot;, this, hostName.get(),</span>
<a href="#l24.300"></a><span id="l24.300" class="difflineplus">+        MOZ_LOG(IMAP, LogLevel::Info, (&quot;%x:%s:%s-%s:%s:%s: %.400s&quot;, this, hostName.get(),</span>
<a href="#l24.301"></a><span id="l24.301">                selectedStateName, GetServerStateParser().GetSelectedMailboxName(),</span>
<a href="#l24.302"></a><span id="l24.302">                logSubName, extraInfo, logDataToLog));</span>
<a href="#l24.303"></a><span id="l24.303">       else</span>
<a href="#l24.304"></a><span id="l24.304" class="difflineminus">-        PR_LOG(IMAP, PR_LOG_ALWAYS, (&quot;%x:%s:%s-%s:%s: %.400s&quot;, this, hostName.get(),</span>
<a href="#l24.305"></a><span id="l24.305" class="difflineplus">+        MOZ_LOG(IMAP, LogLevel::Info, (&quot;%x:%s:%s-%s:%s: %.400s&quot;, this, hostName.get(),</span>
<a href="#l24.306"></a><span id="l24.306">                selectedStateName, GetServerStateParser().GetSelectedMailboxName(),</span>
<a href="#l24.307"></a><span id="l24.307">                logSubName, logDataToLog));</span>
<a href="#l24.308"></a><span id="l24.308">       break;</span>
<a href="#l24.309"></a><span id="l24.309">     case nsImapServerResponseParser::kNonAuthenticated:</span>
<a href="#l24.310"></a><span id="l24.310">     case nsImapServerResponseParser::kAuthenticated:</span>
<a href="#l24.311"></a><span id="l24.311">     {</span>
<a href="#l24.312"></a><span id="l24.312">       const char *stateName = (GetServerStateParser().GetIMAPstate() ==</span>
<a href="#l24.313"></a><span id="l24.313">                                nsImapServerResponseParser::kNonAuthenticated)</span>
<a href="#l24.314"></a><span id="l24.314">                                ? nonAuthStateName : authStateName;</span>
<a href="#l24.315"></a><span id="l24.315">       if (extraInfo)</span>
<a href="#l24.316"></a><span id="l24.316" class="difflineminus">-        PR_LOG(IMAP, PR_LOG_ALWAYS, (&quot;%x:%s:%s:%s:%s: %.400s&quot;, this,</span>
<a href="#l24.317"></a><span id="l24.317" class="difflineplus">+        MOZ_LOG(IMAP, LogLevel::Info, (&quot;%x:%s:%s:%s:%s: %.400s&quot;, this,</span>
<a href="#l24.318"></a><span id="l24.318">                hostName.get(),stateName,logSubName,extraInfo,logDataToLog));</span>
<a href="#l24.319"></a><span id="l24.319">       else</span>
<a href="#l24.320"></a><span id="l24.320" class="difflineminus">-        PR_LOG(IMAP, PR_LOG_ALWAYS, (&quot;%x:%s:%s:%s: %.400s&quot;,this,</span>
<a href="#l24.321"></a><span id="l24.321" class="difflineplus">+        MOZ_LOG(IMAP, LogLevel::Info, (&quot;%x:%s:%s:%s: %.400s&quot;,this,</span>
<a href="#l24.322"></a><span id="l24.322">                hostName.get(),stateName,logSubName,logDataToLog));</span>
<a href="#l24.323"></a><span id="l24.323">     }</span>
<a href="#l24.324"></a><span id="l24.324">     }</span>
<a href="#l24.325"></a><span id="l24.325"> </span>
<a href="#l24.326"></a><span id="l24.326">     // dump the rest of the string in &lt; 400 byte chunks</span>
<a href="#l24.327"></a><span id="l24.327">     while (logDataLen &gt; kLogDataChunkSize)</span>
<a href="#l24.328"></a><span id="l24.328">     {</span>
<a href="#l24.329"></a><span id="l24.329">       logDataLines.Cut(0, lastLineEnd + 2); // + 2 to account for the LF and the '\0' we added</span>
<a href="#l24.330"></a><span id="l24.330">       logDataLen = logDataLines.Length();</span>
<a href="#l24.331"></a><span id="l24.331">       lastLineEnd = (logDataLen &gt; kLogDataChunkSize) ? MsgRFindChar(logDataLines, '\n', kLogDataChunkSize) : kNotFound;</span>
<a href="#l24.332"></a><span id="l24.332">       // null terminate the last line</span>
<a href="#l24.333"></a><span id="l24.333">       if (lastLineEnd == kNotFound)</span>
<a href="#l24.334"></a><span id="l24.334">         lastLineEnd = kLogDataChunkSize - 1;</span>
<a href="#l24.335"></a><span id="l24.335">       logDataLines.Insert( '\0', lastLineEnd + 1);</span>
<a href="#l24.336"></a><span id="l24.336">       logDataToLog = logDataLines.get();</span>
<a href="#l24.337"></a><span id="l24.337" class="difflineminus">-      PR_LOG(IMAP, PR_LOG_ALWAYS, (&quot;%.400s&quot;, logDataToLog));</span>
<a href="#l24.338"></a><span id="l24.338" class="difflineplus">+      MOZ_LOG(IMAP, LogLevel::Info, (&quot;%.400s&quot;, logDataToLog));</span>
<a href="#l24.339"></a><span id="l24.339">     }</span>
<a href="#l24.340"></a><span id="l24.340">   }</span>
<a href="#l24.341"></a><span id="l24.341"> }</span>
<a href="#l24.342"></a><span id="l24.342"> </span>
<a href="#l24.343"></a><span id="l24.343"> // In 4.5, this posted an event back to libmsg and blocked until it got a response.</span>
<a href="#l24.344"></a><span id="l24.344"> // We may still have to do this.It would be nice if we could preflight this value,</span>
<a href="#l24.345"></a><span id="l24.345"> // but we may not always know when we'll need it.</span>
<a href="#l24.346"></a><span id="l24.346"> uint32_t nsImapProtocol::GetMessageSize(const char * messageId,</span>
<a href="#l24.347"></a><span id="l24.347" class="difflineat">@@ -4693,17 +4695,17 @@ char* nsImapProtocol::CreateNewLineFromS</span>
<a href="#l24.348"></a><span id="l24.348">   // ui thread, which releases our ref to the input stream, and can</span>
<a href="#l24.349"></a><span id="l24.349">   // cause the pipe to get deleted before the monitor the read is</span>
<a href="#l24.350"></a><span id="l24.350">   // blocked on gets notified. When that happens, the imap thread</span>
<a href="#l24.351"></a><span id="l24.351">   // will stay blocked.</span>
<a href="#l24.352"></a><span id="l24.352">   nsCOMPtr &lt;nsIInputStream&gt; kungFuGrip = m_inputStream;</span>
<a href="#l24.353"></a><span id="l24.353">   do</span>
<a href="#l24.354"></a><span id="l24.354">   {</span>
<a href="#l24.355"></a><span id="l24.355">     newLine = m_inputStreamBuffer-&gt;ReadNextLine(m_inputStream, numBytesInLine, needMoreData, &amp;rv);</span>
<a href="#l24.356"></a><span id="l24.356" class="difflineminus">-    PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;ReadNextLine [stream=%x nb=%u needmore=%u]\n&quot;,</span>
<a href="#l24.357"></a><span id="l24.357" class="difflineplus">+    MOZ_LOG(IMAP, LogLevel::Debug, (&quot;ReadNextLine [stream=%x nb=%u needmore=%u]\n&quot;,</span>
<a href="#l24.358"></a><span id="l24.358">         m_inputStream.get(), numBytesInLine, needMoreData));</span>
<a href="#l24.359"></a><span id="l24.359"> </span>
<a href="#l24.360"></a><span id="l24.360">   } while (!newLine &amp;&amp; NS_SUCCEEDED(rv) &amp;&amp; !DeathSignalReceived()); // until we get the next line and haven't been interrupted</span>
<a href="#l24.361"></a><span id="l24.361"> </span>
<a href="#l24.362"></a><span id="l24.362">   kungFuGrip = nullptr;</span>
<a href="#l24.363"></a><span id="l24.363"> </span>
<a href="#l24.364"></a><span id="l24.364">   if (NS_FAILED(rv))</span>
<a href="#l24.365"></a><span id="l24.365">   {</span>
<a href="#l24.366"></a><span id="l24.366" class="difflineat">@@ -5532,17 +5534,17 @@ void nsImapProtocol::InitPrefAuthMethods</span>
<a href="#l24.367"></a><span id="l24.367">       case nsMsgAuthMethod::secure:</span>
<a href="#l24.368"></a><span id="l24.368">         m_prefAuthMethods = kHasCRAMCapability |</span>
<a href="#l24.369"></a><span id="l24.369">             kHasAuthGssApiCapability |</span>
<a href="#l24.370"></a><span id="l24.370">             kHasAuthNTLMCapability | kHasAuthMSNCapability;</span>
<a href="#l24.371"></a><span id="l24.371">         break;</span>
<a href="#l24.372"></a><span id="l24.372">       default:</span>
<a href="#l24.373"></a><span id="l24.373">         NS_ASSERTION(false, &quot;IMAP: authMethod pref invalid&quot;);</span>
<a href="#l24.374"></a><span id="l24.374">         // TODO log to error console</span>
<a href="#l24.375"></a><span id="l24.375" class="difflineminus">-        PR_LOG(IMAP, PR_LOG_ERROR,</span>
<a href="#l24.376"></a><span id="l24.376" class="difflineplus">+        MOZ_LOG(IMAP, LogLevel::Error,</span>
<a href="#l24.377"></a><span id="l24.377">             (&quot;IMAP: bad pref authMethod = %d\n&quot;, authMethodPrefValue));</span>
<a href="#l24.378"></a><span id="l24.378">         // fall to any</span>
<a href="#l24.379"></a><span id="l24.379">       case nsMsgAuthMethod::anything:</span>
<a href="#l24.380"></a><span id="l24.380">         m_prefAuthMethods = kHasAuthOldLoginCapability |</span>
<a href="#l24.381"></a><span id="l24.381">             kHasAuthLoginCapability | kHasAuthPlainCapability |</span>
<a href="#l24.382"></a><span id="l24.382">             kHasCRAMCapability | kHasAuthGssApiCapability |</span>
<a href="#l24.383"></a><span id="l24.383">             kHasAuthNTLMCapability | kHasAuthMSNCapability |</span>
<a href="#l24.384"></a><span id="l24.384">             kHasAuthExternalCapability | kHasXOAuth2Capability;</span>
<a href="#l24.385"></a><span id="l24.385" class="difflineat">@@ -5569,19 +5571,19 @@ void nsImapProtocol::InitPrefAuthMethods</span>
<a href="#l24.386"></a><span id="l24.386">  * which is allowed by server and prefs and not marked failed.</span>
<a href="#l24.387"></a><span id="l24.387">  * The order of preference and trying of auth methods is encoded here.</span>
<a href="#l24.388"></a><span id="l24.388">  */</span>
<a href="#l24.389"></a><span id="l24.389"> nsresult nsImapProtocol::ChooseAuthMethod()</span>
<a href="#l24.390"></a><span id="l24.390"> {</span>
<a href="#l24.391"></a><span id="l24.391">   eIMAPCapabilityFlags serverCaps = GetServerStateParser().GetCapabilityFlag();</span>
<a href="#l24.392"></a><span id="l24.392">   eIMAPCapabilityFlags availCaps = serverCaps &amp; m_prefAuthMethods &amp; ~m_failedAuthMethods;</span>
<a href="#l24.393"></a><span id="l24.393"> </span>
<a href="#l24.394"></a><span id="l24.394" class="difflineminus">-  PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;IMAP auth: server caps 0x%llx, pref 0x%llx, failed 0x%llx, avail caps 0x%llx&quot;,</span>
<a href="#l24.395"></a><span id="l24.395" class="difflineplus">+  MOZ_LOG(IMAP, LogLevel::Debug, (&quot;IMAP auth: server caps 0x%llx, pref 0x%llx, failed 0x%llx, avail caps 0x%llx&quot;,</span>
<a href="#l24.396"></a><span id="l24.396">         serverCaps, m_prefAuthMethods, m_failedAuthMethods, availCaps));</span>
<a href="#l24.397"></a><span id="l24.397" class="difflineminus">-  PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;(GSSAPI = 0x%llx, CRAM = 0x%llx, NTLM = 0x%llx, &quot;</span>
<a href="#l24.398"></a><span id="l24.398" class="difflineplus">+  MOZ_LOG(IMAP, LogLevel::Debug, (&quot;(GSSAPI = 0x%llx, CRAM = 0x%llx, NTLM = 0x%llx, &quot;</span>
<a href="#l24.399"></a><span id="l24.399">         &quot;MSN = 0x%llx, PLAIN = 0x%llx,\n  LOGIN = 0x%llx, old-style IMAP login = 0x%llx&quot;</span>
<a href="#l24.400"></a><span id="l24.400">         &quot;, auth external IMAP login = 0x%llx, OAUTH2 = 0x%llx)&quot;,</span>
<a href="#l24.401"></a><span id="l24.401">         kHasAuthGssApiCapability, kHasCRAMCapability, kHasAuthNTLMCapability,</span>
<a href="#l24.402"></a><span id="l24.402">         kHasAuthMSNCapability, kHasAuthPlainCapability, kHasAuthLoginCapability,</span>
<a href="#l24.403"></a><span id="l24.403">         kHasAuthOldLoginCapability, kHasAuthExternalCapability, kHasXOAuth2Capability));</span>
<a href="#l24.404"></a><span id="l24.404"> </span>
<a href="#l24.405"></a><span id="l24.405">   if (kHasAuthExternalCapability &amp; availCaps)</span>
<a href="#l24.406"></a><span id="l24.406">     m_currentAuthMethod = kHasAuthExternalCapability;</span>
<a href="#l24.407"></a><span id="l24.407" class="difflineat">@@ -5598,49 +5600,49 @@ nsresult nsImapProtocol::ChooseAuthMetho</span>
<a href="#l24.408"></a><span id="l24.408">   else if (kHasAuthPlainCapability &amp; availCaps)</span>
<a href="#l24.409"></a><span id="l24.409">     m_currentAuthMethod = kHasAuthPlainCapability;</span>
<a href="#l24.410"></a><span id="l24.410">   else if (kHasAuthLoginCapability &amp; availCaps)</span>
<a href="#l24.411"></a><span id="l24.411">     m_currentAuthMethod = kHasAuthLoginCapability;</span>
<a href="#l24.412"></a><span id="l24.412">   else if (kHasAuthOldLoginCapability &amp; availCaps)</span>
<a href="#l24.413"></a><span id="l24.413">     m_currentAuthMethod = kHasAuthOldLoginCapability;</span>
<a href="#l24.414"></a><span id="l24.414">   else</span>
<a href="#l24.415"></a><span id="l24.415">   {</span>
<a href="#l24.416"></a><span id="l24.416" class="difflineminus">-    PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;no remaining auth method&quot;));</span>
<a href="#l24.417"></a><span id="l24.417" class="difflineplus">+    MOZ_LOG(IMAP, LogLevel::Debug, (&quot;no remaining auth method&quot;));</span>
<a href="#l24.418"></a><span id="l24.418">     m_currentAuthMethod = kCapabilityUndefined;</span>
<a href="#l24.419"></a><span id="l24.419">     return NS_ERROR_FAILURE;</span>
<a href="#l24.420"></a><span id="l24.420">   }</span>
<a href="#l24.421"></a><span id="l24.421" class="difflineminus">-  PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;trying auth method 0x%llx&quot;, m_currentAuthMethod));</span>
<a href="#l24.422"></a><span id="l24.422" class="difflineplus">+  MOZ_LOG(IMAP, LogLevel::Debug, (&quot;trying auth method 0x%llx&quot;, m_currentAuthMethod));</span>
<a href="#l24.423"></a><span id="l24.423">   return NS_OK;</span>
<a href="#l24.424"></a><span id="l24.424"> }</span>
<a href="#l24.425"></a><span id="l24.425"> </span>
<a href="#l24.426"></a><span id="l24.426"> void nsImapProtocol::MarkAuthMethodAsFailed(eIMAPCapabilityFlags failedAuthMethod)</span>
<a href="#l24.427"></a><span id="l24.427"> {</span>
<a href="#l24.428"></a><span id="l24.428" class="difflineminus">-  PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;marking auth method 0x%llx failed&quot;, failedAuthMethod));</span>
<a href="#l24.429"></a><span id="l24.429" class="difflineplus">+  MOZ_LOG(IMAP, LogLevel::Debug, (&quot;marking auth method 0x%llx failed&quot;, failedAuthMethod));</span>
<a href="#l24.430"></a><span id="l24.430">   m_failedAuthMethods |= failedAuthMethod;</span>
<a href="#l24.431"></a><span id="l24.431"> }</span>
<a href="#l24.432"></a><span id="l24.432"> </span>
<a href="#l24.433"></a><span id="l24.433"> /**</span>
<a href="#l24.434"></a><span id="l24.434">  * Start over, trying all auth methods again</span>
<a href="#l24.435"></a><span id="l24.435">  */</span>
<a href="#l24.436"></a><span id="l24.436"> void nsImapProtocol::ResetAuthMethods()</span>
<a href="#l24.437"></a><span id="l24.437"> {</span>
<a href="#l24.438"></a><span id="l24.438" class="difflineminus">-  PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;resetting (failed) auth methods&quot;));</span>
<a href="#l24.439"></a><span id="l24.439" class="difflineplus">+  MOZ_LOG(IMAP, LogLevel::Debug, (&quot;resetting (failed) auth methods&quot;));</span>
<a href="#l24.440"></a><span id="l24.440">   m_currentAuthMethod = kCapabilityUndefined;</span>
<a href="#l24.441"></a><span id="l24.441">   m_failedAuthMethods = 0;</span>
<a href="#l24.442"></a><span id="l24.442"> }</span>
<a href="#l24.443"></a><span id="l24.443"> </span>
<a href="#l24.444"></a><span id="l24.444"> nsresult nsImapProtocol::AuthLogin(const char *userName, const nsCString &amp;password, eIMAPCapabilityFlag flag)</span>
<a href="#l24.445"></a><span id="l24.445"> {</span>
<a href="#l24.446"></a><span id="l24.446">   ProgressEventFunctionUsingName(&quot;imapStatusSendingAuthLogin&quot;);</span>
<a href="#l24.447"></a><span id="l24.447">   IncrementCommandTagNumber();</span>
<a href="#l24.448"></a><span id="l24.448"> </span>
<a href="#l24.449"></a><span id="l24.449">   char * currentCommand=nullptr;</span>
<a href="#l24.450"></a><span id="l24.450">   nsresult rv;</span>
<a href="#l24.451"></a><span id="l24.451"> </span>
<a href="#l24.452"></a><span id="l24.452" class="difflineminus">-  PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;IMAP: trying auth method 0x%llx&quot;, m_currentAuthMethod));</span>
<a href="#l24.453"></a><span id="l24.453" class="difflineplus">+  MOZ_LOG(IMAP, LogLevel::Debug, (&quot;IMAP: trying auth method 0x%llx&quot;, m_currentAuthMethod));</span>
<a href="#l24.454"></a><span id="l24.454"> </span>
<a href="#l24.455"></a><span id="l24.455">   if (flag &amp; kHasAuthExternalCapability)</span>
<a href="#l24.456"></a><span id="l24.456">   {</span>
<a href="#l24.457"></a><span id="l24.457">       char *base64UserName = PL_Base64Encode(userName, strlen(userName), nullptr);</span>
<a href="#l24.458"></a><span id="l24.458">       nsAutoCString command (GetServerCommandTag());</span>
<a href="#l24.459"></a><span id="l24.459">       command.Append(&quot; authenticate EXTERNAL &quot; );</span>
<a href="#l24.460"></a><span id="l24.460">       command.Append(base64UserName);</span>
<a href="#l24.461"></a><span id="l24.461">       command.Append(CRLF);</span>
<a href="#l24.462"></a><span id="l24.462" class="difflineat">@@ -5650,17 +5652,17 @@ nsresult nsImapProtocol::AuthLogin(const</span>
<a href="#l24.463"></a><span id="l24.463">       nsImapServerResponseParser &amp;parser = GetServerStateParser();</span>
<a href="#l24.464"></a><span id="l24.464">       if (parser.LastCommandSuccessful())</span>
<a href="#l24.465"></a><span id="l24.465">         return NS_OK;</span>
<a href="#l24.466"></a><span id="l24.466">       parser.SetCapabilityFlag(parser.GetCapabilityFlag() &amp; ~kHasAuthExternalCapability);</span>
<a href="#l24.467"></a><span id="l24.467">   }</span>
<a href="#l24.468"></a><span id="l24.468">   else if (flag &amp; kHasCRAMCapability)</span>
<a href="#l24.469"></a><span id="l24.469">   {</span>
<a href="#l24.470"></a><span id="l24.470">     NS_ENSURE_TRUE(m_imapServerSink, NS_ERROR_NULL_POINTER);</span>
<a href="#l24.471"></a><span id="l24.471" class="difflineminus">-    PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;MD5 auth&quot;));</span>
<a href="#l24.472"></a><span id="l24.472" class="difflineplus">+    MOZ_LOG(IMAP, LogLevel::Debug, (&quot;MD5 auth&quot;));</span>
<a href="#l24.473"></a><span id="l24.473">     // inform the server that we want to begin a CRAM authentication procedure...</span>
<a href="#l24.474"></a><span id="l24.474">     nsAutoCString command (GetServerCommandTag());</span>
<a href="#l24.475"></a><span id="l24.475">     command.Append(&quot; authenticate CRAM-MD5&quot; CRLF);</span>
<a href="#l24.476"></a><span id="l24.476">     rv = SendData(command.get());</span>
<a href="#l24.477"></a><span id="l24.477">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.478"></a><span id="l24.478">     ParseIMAPandCheckForNewMail();</span>
<a href="#l24.479"></a><span id="l24.479">     if (GetServerStateParser().LastCommandSuccessful())</span>
<a href="#l24.480"></a><span id="l24.480">     {</span>
<a href="#l24.481"></a><span id="l24.481" class="difflineat">@@ -5688,17 +5690,17 @@ nsresult nsImapProtocol::AuthLogin(const</span>
<a href="#l24.482"></a><span id="l24.482">       PR_Free(digest);</span>
<a href="#l24.483"></a><span id="l24.483">       rv = SendData(m_dataOutputBuf);</span>
<a href="#l24.484"></a><span id="l24.484">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.485"></a><span id="l24.485">       ParseIMAPandCheckForNewMail(command.get());</span>
<a href="#l24.486"></a><span id="l24.486">     }</span>
<a href="#l24.487"></a><span id="l24.487">   } // if CRAM response was received</span>
<a href="#l24.488"></a><span id="l24.488">   else if (flag &amp; kHasAuthGssApiCapability)</span>
<a href="#l24.489"></a><span id="l24.489">   {</span>
<a href="#l24.490"></a><span id="l24.490" class="difflineminus">-    PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;MD5 auth&quot;));</span>
<a href="#l24.491"></a><span id="l24.491" class="difflineplus">+    MOZ_LOG(IMAP, LogLevel::Debug, (&quot;MD5 auth&quot;));</span>
<a href="#l24.492"></a><span id="l24.492"> </span>
<a href="#l24.493"></a><span id="l24.493">     // Only try GSSAPI once - if it fails, its going to be because we don't</span>
<a href="#l24.494"></a><span id="l24.494">     // have valid credentials</span>
<a href="#l24.495"></a><span id="l24.495">     //MarkAuthMethodAsFailed(kHasAuthGssApiCapability);</span>
<a href="#l24.496"></a><span id="l24.496"> </span>
<a href="#l24.497"></a><span id="l24.497">     // We do step1 first, so we don't try GSSAPI against a server which</span>
<a href="#l24.498"></a><span id="l24.498">     // we can't get credentials for.</span>
<a href="#l24.499"></a><span id="l24.499">     nsAutoCString response;</span>
<a href="#l24.500"></a><span id="l24.500" class="difflineat">@@ -5738,17 +5740,17 @@ nsresult nsImapProtocol::AuthLogin(const</span>
<a href="#l24.501"></a><span id="l24.501">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.502"></a><span id="l24.502">         ParseIMAPandCheckForNewMail(command.get());</span>
<a href="#l24.503"></a><span id="l24.503">       }</span>
<a href="#l24.504"></a><span id="l24.504">       // TODO: whether it worked or not is shown by LastCommandSuccessful(), not gssrv, right?</span>
<a href="#l24.505"></a><span id="l24.505">     }</span>
<a href="#l24.506"></a><span id="l24.506">   }</span>
<a href="#l24.507"></a><span id="l24.507">   else if (flag &amp; (kHasAuthNTLMCapability | kHasAuthMSNCapability))</span>
<a href="#l24.508"></a><span id="l24.508">   {</span>
<a href="#l24.509"></a><span id="l24.509" class="difflineminus">-    PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;NTLM auth&quot;));</span>
<a href="#l24.510"></a><span id="l24.510" class="difflineplus">+    MOZ_LOG(IMAP, LogLevel::Debug, (&quot;NTLM auth&quot;));</span>
<a href="#l24.511"></a><span id="l24.511">     nsAutoCString command (GetServerCommandTag());</span>
<a href="#l24.512"></a><span id="l24.512">     command.Append((flag &amp; kHasAuthNTLMCapability) ? &quot; authenticate NTLM&quot; CRLF</span>
<a href="#l24.513"></a><span id="l24.513">                                                    : &quot; authenticate MSN&quot; CRLF);</span>
<a href="#l24.514"></a><span id="l24.514">     rv = SendData(command.get());</span>
<a href="#l24.515"></a><span id="l24.515">     ParseIMAPandCheckForNewMail(&quot;AUTH NTLM&quot;); // this just waits for ntlm step 1</span>
<a href="#l24.516"></a><span id="l24.516">     if (GetServerStateParser().LastCommandSuccessful())</span>
<a href="#l24.517"></a><span id="l24.517">     {</span>
<a href="#l24.518"></a><span id="l24.518">       nsAutoCString cmd;</span>
<a href="#l24.519"></a><span id="l24.519" class="difflineat">@@ -5767,17 +5769,17 @@ nsresult nsImapProtocol::AuthLogin(const</span>
<a href="#l24.520"></a><span id="l24.520">         response += CRLF;</span>
<a href="#l24.521"></a><span id="l24.521">         rv = SendData(response.get());</span>
<a href="#l24.522"></a><span id="l24.522">         ParseIMAPandCheckForNewMail(command.get());</span>
<a href="#l24.523"></a><span id="l24.523">       }</span>
<a href="#l24.524"></a><span id="l24.524">     }</span>
<a href="#l24.525"></a><span id="l24.525">   }</span>
<a href="#l24.526"></a><span id="l24.526">   else if (flag &amp; kHasAuthPlainCapability)</span>
<a href="#l24.527"></a><span id="l24.527">   {</span>
<a href="#l24.528"></a><span id="l24.528" class="difflineminus">-    PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;PLAIN auth&quot;));</span>
<a href="#l24.529"></a><span id="l24.529" class="difflineplus">+    MOZ_LOG(IMAP, LogLevel::Debug, (&quot;PLAIN auth&quot;));</span>
<a href="#l24.530"></a><span id="l24.530">     PR_snprintf(m_dataOutputBuf, OUTPUT_BUFFER_SIZE, &quot;%s authenticate plain&quot; CRLF, GetServerCommandTag());</span>
<a href="#l24.531"></a><span id="l24.531">     rv = SendData(m_dataOutputBuf);</span>
<a href="#l24.532"></a><span id="l24.532">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.533"></a><span id="l24.533">     currentCommand = PL_strdup(m_dataOutputBuf); /* StrAllocCopy(currentCommand, GetOutputBuffer()); */</span>
<a href="#l24.534"></a><span id="l24.534">     ParseIMAPandCheckForNewMail();</span>
<a href="#l24.535"></a><span id="l24.535">     if (GetServerStateParser().LastCommandSuccessful())</span>
<a href="#l24.536"></a><span id="l24.536">     {</span>
<a href="#l24.537"></a><span id="l24.537">       // RFC 4616</span>
<a href="#l24.538"></a><span id="l24.538" class="difflineat">@@ -5794,17 +5796,17 @@ nsresult nsImapProtocol::AuthLogin(const</span>
<a href="#l24.539"></a><span id="l24.539">       PR_Free(base64Str);</span>
<a href="#l24.540"></a><span id="l24.540">       rv = SendData(m_dataOutputBuf, true /* suppress logging */);</span>
<a href="#l24.541"></a><span id="l24.541">       if (NS_SUCCEEDED(rv))</span>
<a href="#l24.542"></a><span id="l24.542">         ParseIMAPandCheckForNewMail(currentCommand);</span>
<a href="#l24.543"></a><span id="l24.543">     } // if the last command succeeded</span>
<a href="#l24.544"></a><span id="l24.544">   } // if auth plain capability</span>
<a href="#l24.545"></a><span id="l24.545">   else if (flag &amp; kHasAuthLoginCapability)</span>
<a href="#l24.546"></a><span id="l24.546">   {</span>
<a href="#l24.547"></a><span id="l24.547" class="difflineminus">-    PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;LOGIN auth&quot;));</span>
<a href="#l24.548"></a><span id="l24.548" class="difflineplus">+    MOZ_LOG(IMAP, LogLevel::Debug, (&quot;LOGIN auth&quot;));</span>
<a href="#l24.549"></a><span id="l24.549">     PR_snprintf(m_dataOutputBuf, OUTPUT_BUFFER_SIZE, &quot;%s authenticate login&quot; CRLF, GetServerCommandTag());</span>
<a href="#l24.550"></a><span id="l24.550">     rv = SendData(m_dataOutputBuf);</span>
<a href="#l24.551"></a><span id="l24.551">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.552"></a><span id="l24.552">     currentCommand = PL_strdup(m_dataOutputBuf);</span>
<a href="#l24.553"></a><span id="l24.553">     ParseIMAPandCheckForNewMail();</span>
<a href="#l24.554"></a><span id="l24.554"> </span>
<a href="#l24.555"></a><span id="l24.555">     if (GetServerStateParser().LastCommandSuccessful())</span>
<a href="#l24.556"></a><span id="l24.556">     {</span>
<a href="#l24.557"></a><span id="l24.557" class="difflineat">@@ -5824,17 +5826,17 @@ nsresult nsImapProtocol::AuthLogin(const</span>
<a href="#l24.558"></a><span id="l24.558">           if (NS_SUCCEEDED(rv))</span>
<a href="#l24.559"></a><span id="l24.559">             ParseIMAPandCheckForNewMail(currentCommand);</span>
<a href="#l24.560"></a><span id="l24.560">         } // if last command successful</span>
<a href="#l24.561"></a><span id="l24.561">       } // if last command successful</span>
<a href="#l24.562"></a><span id="l24.562">     } // if last command successful</span>
<a href="#l24.563"></a><span id="l24.563">   } // if has auth login capability</span>
<a href="#l24.564"></a><span id="l24.564">   else if (flag &amp; kHasAuthOldLoginCapability)</span>
<a href="#l24.565"></a><span id="l24.565">   {</span>
<a href="#l24.566"></a><span id="l24.566" class="difflineminus">-    PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;old-style auth&quot;));</span>
<a href="#l24.567"></a><span id="l24.567" class="difflineplus">+    MOZ_LOG(IMAP, LogLevel::Debug, (&quot;old-style auth&quot;));</span>
<a href="#l24.568"></a><span id="l24.568">     ProgressEventFunctionUsingName(&quot;imapStatusSendingLogin&quot;);</span>
<a href="#l24.569"></a><span id="l24.569">     IncrementCommandTagNumber();</span>
<a href="#l24.570"></a><span id="l24.570">     nsCString command (GetServerCommandTag());</span>
<a href="#l24.571"></a><span id="l24.571">     nsAutoCString escapedUserName;</span>
<a href="#l24.572"></a><span id="l24.572">     command.Append(&quot; login \&quot;&quot;);</span>
<a href="#l24.573"></a><span id="l24.573">     EscapeUserNamePasswordString(userName, &amp;escapedUserName);</span>
<a href="#l24.574"></a><span id="l24.574">     command.Append(escapedUserName);</span>
<a href="#l24.575"></a><span id="l24.575">     command.Append(&quot;\&quot; \&quot;&quot;);</span>
<a href="#l24.576"></a><span id="l24.576" class="difflineat">@@ -5846,29 +5848,29 @@ nsresult nsImapProtocol::AuthLogin(const</span>
<a href="#l24.577"></a><span id="l24.577">     command.Append(correctedPassword);</span>
<a href="#l24.578"></a><span id="l24.578">     command.Append(&quot;\&quot;&quot; CRLF);</span>
<a href="#l24.579"></a><span id="l24.579">     rv = SendData(command.get(), true /* suppress logging */);</span>
<a href="#l24.580"></a><span id="l24.580">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.581"></a><span id="l24.581">     ParseIMAPandCheckForNewMail();</span>
<a href="#l24.582"></a><span id="l24.582">   }</span>
<a href="#l24.583"></a><span id="l24.583">   else if (flag &amp; kHasXOAuth2Capability)</span>
<a href="#l24.584"></a><span id="l24.584">   {</span>
<a href="#l24.585"></a><span id="l24.585" class="difflineminus">-    PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;XOAUTH2 auth&quot;));</span>
<a href="#l24.586"></a><span id="l24.586" class="difflineplus">+    MOZ_LOG(IMAP, LogLevel::Debug, (&quot;XOAUTH2 auth&quot;));</span>
<a href="#l24.587"></a><span id="l24.587"> </span>
<a href="#l24.588"></a><span id="l24.588">     // Get the XOAuth2 base64 string.</span>
<a href="#l24.589"></a><span id="l24.589">     NS_ASSERTION(mOAuth2Support,</span>
<a href="#l24.590"></a><span id="l24.590">       &quot;What are we doing here without OAuth2 helper?&quot;);</span>
<a href="#l24.591"></a><span id="l24.591">     if (!mOAuth2Support)</span>
<a href="#l24.592"></a><span id="l24.592">       return NS_ERROR_UNEXPECTED;</span>
<a href="#l24.593"></a><span id="l24.593">     nsAutoCString base64Str;</span>
<a href="#l24.594"></a><span id="l24.594">     mOAuth2Support-&gt;GetXOAuth2String(base64Str);</span>
<a href="#l24.595"></a><span id="l24.595">     mOAuth2Support = nullptr; // Its purpose has been served.</span>
<a href="#l24.596"></a><span id="l24.596">     if (base64Str.IsEmpty())</span>
<a href="#l24.597"></a><span id="l24.597">     {</span>
<a href="#l24.598"></a><span id="l24.598" class="difflineminus">-      PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;OAuth2 failed&quot;));</span>
<a href="#l24.599"></a><span id="l24.599" class="difflineplus">+      MOZ_LOG(IMAP, LogLevel::Debug, (&quot;OAuth2 failed&quot;));</span>
<a href="#l24.600"></a><span id="l24.600">       return NS_ERROR_FAILURE;</span>
<a href="#l24.601"></a><span id="l24.601">     }</span>
<a href="#l24.602"></a><span id="l24.602"> </span>
<a href="#l24.603"></a><span id="l24.603">     // Send the data on the network.</span>
<a href="#l24.604"></a><span id="l24.604">     nsAutoCString command (GetServerCommandTag());</span>
<a href="#l24.605"></a><span id="l24.605">     command += &quot; AUTHENTICATE XOAUTH2 &quot;;</span>
<a href="#l24.606"></a><span id="l24.606">     command += base64Str;</span>
<a href="#l24.607"></a><span id="l24.607">     command += CRLF;</span>
<a href="#l24.608"></a><span id="l24.608" class="difflineat">@@ -5878,17 +5880,17 @@ nsresult nsImapProtocol::AuthLogin(const</span>
<a href="#l24.609"></a><span id="l24.609">   }</span>
<a href="#l24.610"></a><span id="l24.610">   else if (flag &amp; kHasAuthNoneCapability)</span>
<a href="#l24.611"></a><span id="l24.611">   {</span>
<a href="#l24.612"></a><span id="l24.612">     // TODO What to do? &quot;login &lt;username&gt;&quot; like POP?</span>
<a href="#l24.613"></a><span id="l24.613">     return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l24.614"></a><span id="l24.614">   }</span>
<a href="#l24.615"></a><span id="l24.615">   else</span>
<a href="#l24.616"></a><span id="l24.616">   {</span>
<a href="#l24.617"></a><span id="l24.617" class="difflineminus">-    PR_LOG(IMAP, PR_LOG_ERROR, (&quot;flags param has no auth scheme selected&quot;));</span>
<a href="#l24.618"></a><span id="l24.618" class="difflineplus">+    MOZ_LOG(IMAP, LogLevel::Error, (&quot;flags param has no auth scheme selected&quot;));</span>
<a href="#l24.619"></a><span id="l24.619">     return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l24.620"></a><span id="l24.620">   }</span>
<a href="#l24.621"></a><span id="l24.621"> </span>
<a href="#l24.622"></a><span id="l24.622">   PR_Free(currentCommand);</span>
<a href="#l24.623"></a><span id="l24.623">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.624"></a><span id="l24.624">   return GetServerStateParser().LastCommandSuccessful() ?</span>
<a href="#l24.625"></a><span id="l24.625">         NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l24.626"></a><span id="l24.626"> }</span>
<a href="#l24.627"></a><span id="l24.627" class="difflineat">@@ -8321,17 +8323,17 @@ nsImapProtocol::OnPromptCanceled()</span>
<a href="#l24.628"></a><span id="l24.628">   m_passwordStatus = NS_MSG_PASSWORD_PROMPT_CANCELLED;</span>
<a href="#l24.629"></a><span id="l24.629">   ReentrantMonitorAutoEnter passwordMon(m_passwordReadyMonitor);</span>
<a href="#l24.630"></a><span id="l24.630">   passwordMon.Notify();</span>
<a href="#l24.631"></a><span id="l24.631">   return NS_OK;</span>
<a href="#l24.632"></a><span id="l24.632"> }</span>
<a href="#l24.633"></a><span id="l24.633"> </span>
<a href="#l24.634"></a><span id="l24.634"> bool nsImapProtocol::TryToLogon()</span>
<a href="#l24.635"></a><span id="l24.635"> {</span>
<a href="#l24.636"></a><span id="l24.636" class="difflineminus">-  PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;try to log in&quot;));</span>
<a href="#l24.637"></a><span id="l24.637" class="difflineplus">+  MOZ_LOG(IMAP, LogLevel::Debug, (&quot;try to log in&quot;));</span>
<a href="#l24.638"></a><span id="l24.638">   NS_ENSURE_TRUE(m_imapServerSink, false);</span>
<a href="#l24.639"></a><span id="l24.639">   bool loginSucceeded = false;</span>
<a href="#l24.640"></a><span id="l24.640">   bool skipLoop = false;</span>
<a href="#l24.641"></a><span id="l24.641">   nsAutoCString password;</span>
<a href="#l24.642"></a><span id="l24.642">   nsAutoCString userName;</span>
<a href="#l24.643"></a><span id="l24.643"> </span>
<a href="#l24.644"></a><span id="l24.644">   nsresult rv = ChooseAuthMethod();</span>
<a href="#l24.645"></a><span id="l24.645">   if (NS_FAILED(rv)) // all methods failed</span>
<a href="#l24.646"></a><span id="l24.646" class="difflineat">@@ -8370,17 +8372,17 @@ bool nsImapProtocol::TryToLogon()</span>
<a href="#l24.647"></a><span id="l24.647">     }</span>
<a href="#l24.648"></a><span id="l24.648">     else</span>
<a href="#l24.649"></a><span id="l24.649">     {</span>
<a href="#l24.650"></a><span id="l24.650">       // try to reset failed methods and try them again</span>
<a href="#l24.651"></a><span id="l24.651">       ResetAuthMethods();</span>
<a href="#l24.652"></a><span id="l24.652">       rv = ChooseAuthMethod();</span>
<a href="#l24.653"></a><span id="l24.653">       if (NS_FAILED(rv)) // all methods failed</span>
<a href="#l24.654"></a><span id="l24.654">       {</span>
<a href="#l24.655"></a><span id="l24.655" class="difflineminus">-        PR_LOG(IMAP, PR_LOG_ERROR, (&quot;huch? there are auth methods, and we resetted failed ones, but ChooseAuthMethod still fails.&quot;));</span>
<a href="#l24.656"></a><span id="l24.656" class="difflineplus">+        MOZ_LOG(IMAP, LogLevel::Error, (&quot;huch? there are auth methods, and we resetted failed ones, but ChooseAuthMethod still fails.&quot;));</span>
<a href="#l24.657"></a><span id="l24.657">         return false;</span>
<a href="#l24.658"></a><span id="l24.658">       }</span>
<a href="#l24.659"></a><span id="l24.659">     }</span>
<a href="#l24.660"></a><span id="l24.660">   }</span>
<a href="#l24.661"></a><span id="l24.661"> </span>
<a href="#l24.662"></a><span id="l24.662">   // Get username, either the stored one or from user</span>
<a href="#l24.663"></a><span id="l24.663">   rv = m_imapServerSink-&gt;GetLoginUsername(userName);</span>
<a href="#l24.664"></a><span id="l24.664">   if (NS_FAILED(rv) || userName.IsEmpty())</span>
<a href="#l24.665"></a><span id="l24.665" class="difflineat">@@ -8424,33 +8426,33 @@ bool nsImapProtocol::TryToLogon()</span>
<a href="#l24.666"></a><span id="l24.666">           m_currentAuthMethod != kHasAuthExternalCapability &amp;&amp;</span>
<a href="#l24.667"></a><span id="l24.667">           m_currentAuthMethod != kHasXOAuth2Capability &amp;&amp;</span>
<a href="#l24.668"></a><span id="l24.668">           m_currentAuthMethod != kHasAuthNoneCapability)</span>
<a href="#l24.669"></a><span id="l24.669">       {</span>
<a href="#l24.670"></a><span id="l24.670">           rv = GetPassword(password, newPasswordRequested);</span>
<a href="#l24.671"></a><span id="l24.671">           newPasswordRequested = false;</span>
<a href="#l24.672"></a><span id="l24.672">           if (rv == NS_MSG_PASSWORD_PROMPT_CANCELLED || NS_FAILED(rv))</span>
<a href="#l24.673"></a><span id="l24.673">           {</span>
<a href="#l24.674"></a><span id="l24.674" class="difflineminus">-            PR_LOG(IMAP, PR_LOG_ERROR, (&quot;IMAP: password prompt failed or user canceled it&quot;));</span>
<a href="#l24.675"></a><span id="l24.675" class="difflineplus">+            MOZ_LOG(IMAP, LogLevel::Error, (&quot;IMAP: password prompt failed or user canceled it&quot;));</span>
<a href="#l24.676"></a><span id="l24.676">             break;</span>
<a href="#l24.677"></a><span id="l24.677">           }</span>
<a href="#l24.678"></a><span id="l24.678" class="difflineminus">-          PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;got new password&quot;));</span>
<a href="#l24.679"></a><span id="l24.679" class="difflineplus">+          MOZ_LOG(IMAP, LogLevel::Debug, (&quot;got new password&quot;));</span>
<a href="#l24.680"></a><span id="l24.680">       }</span>
<a href="#l24.681"></a><span id="l24.681"> </span>
<a href="#l24.682"></a><span id="l24.682">       bool lastReportingErrors = GetServerStateParser().GetReportingErrors();</span>
<a href="#l24.683"></a><span id="l24.683">       GetServerStateParser().SetReportingErrors(false); // turn off errors - we'll put up our own.</span>
<a href="#l24.684"></a><span id="l24.684"> </span>
<a href="#l24.685"></a><span id="l24.685">       rv = AuthLogin(userName.get(), password, m_currentAuthMethod);</span>
<a href="#l24.686"></a><span id="l24.686"> </span>
<a href="#l24.687"></a><span id="l24.687">       GetServerStateParser().SetReportingErrors(lastReportingErrors); // restore error reports</span>
<a href="#l24.688"></a><span id="l24.688">       loginSucceeded = NS_SUCCEEDED(rv);</span>
<a href="#l24.689"></a><span id="l24.689"> </span>
<a href="#l24.690"></a><span id="l24.690">       if (!loginSucceeded)</span>
<a href="#l24.691"></a><span id="l24.691">       {</span>
<a href="#l24.692"></a><span id="l24.692" class="difflineminus">-        PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;authlogin failed&quot;));</span>
<a href="#l24.693"></a><span id="l24.693" class="difflineplus">+        MOZ_LOG(IMAP, LogLevel::Debug, (&quot;authlogin failed&quot;));</span>
<a href="#l24.694"></a><span id="l24.694">         MarkAuthMethodAsFailed(m_currentAuthMethod);</span>
<a href="#l24.695"></a><span id="l24.695">         rv = ChooseAuthMethod(); // change m_currentAuthMethod to try other one next round</span>
<a href="#l24.696"></a><span id="l24.696"> </span>
<a href="#l24.697"></a><span id="l24.697">         if (NS_FAILED(rv)) // all methods failed</span>
<a href="#l24.698"></a><span id="l24.698">         {</span>
<a href="#l24.699"></a><span id="l24.699">           if (m_prefAuthMethods == kHasAuthGssApiCapability)</span>
<a href="#l24.700"></a><span id="l24.700">           {</span>
<a href="#l24.701"></a><span id="l24.701">             // GSSAPI failed, and it's the only available method,</span>
<a href="#l24.702"></a><span id="l24.702" class="difflineat">@@ -8465,64 +8467,64 @@ bool nsImapProtocol::TryToLogon()</span>
<a href="#l24.703"></a><span id="l24.703">             // in a string freeze, so use a generic error message. Entering</span>
<a href="#l24.704"></a><span id="l24.704">             // a password does not help.</span>
<a href="#l24.705"></a><span id="l24.705">             AlertUserEventUsingName(&quot;imapUnknownHostError&quot;);</span>
<a href="#l24.706"></a><span id="l24.706">             break;</span>
<a href="#l24.707"></a><span id="l24.707">           }</span>
<a href="#l24.708"></a><span id="l24.708"> </span>
<a href="#l24.709"></a><span id="l24.709">           // The reason that we failed might be a wrong password, so</span>
<a href="#l24.710"></a><span id="l24.710">           // ask user what to do</span>
<a href="#l24.711"></a><span id="l24.711" class="difflineminus">-          PR_LOG(IMAP, PR_LOG_WARN, (&quot;IMAP: ask user what to do (after login failed): new passwort, retry, cancel&quot;));</span>
<a href="#l24.712"></a><span id="l24.712" class="difflineplus">+          MOZ_LOG(IMAP, LogLevel::Warning, (&quot;IMAP: ask user what to do (after login failed): new passwort, retry, cancel&quot;));</span>
<a href="#l24.713"></a><span id="l24.713">           if (!m_imapServerSink)</span>
<a href="#l24.714"></a><span id="l24.714">             break;</span>
<a href="#l24.715"></a><span id="l24.715">           // if there's no msg window, don't forget the password</span>
<a href="#l24.716"></a><span id="l24.716">           if (!msgWindow)</span>
<a href="#l24.717"></a><span id="l24.717">             break;</span>
<a href="#l24.718"></a><span id="l24.718">           int32_t buttonPressed = 1;</span>
<a href="#l24.719"></a><span id="l24.719">           rv = m_imapServerSink-&gt;PromptLoginFailed(msgWindow,</span>
<a href="#l24.720"></a><span id="l24.720">                                                     &amp;buttonPressed);</span>
<a href="#l24.721"></a><span id="l24.721">           if (NS_FAILED(rv))</span>
<a href="#l24.722"></a><span id="l24.722">             break;</span>
<a href="#l24.723"></a><span id="l24.723">           if (buttonPressed == 2) // 'New password' button</span>
<a href="#l24.724"></a><span id="l24.724">           {</span>
<a href="#l24.725"></a><span id="l24.725" class="difflineminus">-            PR_LOG(IMAP, PR_LOG_WARN, (&quot;new password button pressed.&quot;));</span>
<a href="#l24.726"></a><span id="l24.726" class="difflineplus">+            MOZ_LOG(IMAP, LogLevel::Warning, (&quot;new password button pressed.&quot;));</span>
<a href="#l24.727"></a><span id="l24.727">             // Forget the current password</span>
<a href="#l24.728"></a><span id="l24.728">             password.Truncate();</span>
<a href="#l24.729"></a><span id="l24.729">             m_hostSessionList-&gt;SetPasswordForHost(GetImapServerKey(), nullptr);</span>
<a href="#l24.730"></a><span id="l24.730">             m_imapServerSink-&gt;ForgetPassword();</span>
<a href="#l24.731"></a><span id="l24.731">             m_password.Truncate();</span>
<a href="#l24.732"></a><span id="l24.732" class="difflineminus">-            PR_LOG(IMAP, PR_LOG_WARN, (&quot;password resetted (nulled)&quot;));</span>
<a href="#l24.733"></a><span id="l24.733" class="difflineplus">+            MOZ_LOG(IMAP, LogLevel::Warning, (&quot;password resetted (nulled)&quot;));</span>
<a href="#l24.734"></a><span id="l24.734">             newPasswordRequested = true;</span>
<a href="#l24.735"></a><span id="l24.735">             // Will call GetPassword() in beginning of next loop</span>
<a href="#l24.736"></a><span id="l24.736"> </span>
<a href="#l24.737"></a><span id="l24.737">             // Try all possible auth methods again with the new password.</span>
<a href="#l24.738"></a><span id="l24.738">             ResetAuthMethods();</span>
<a href="#l24.739"></a><span id="l24.739">           }</span>
<a href="#l24.740"></a><span id="l24.740">           else if (buttonPressed == 0) // Retry button</span>
<a href="#l24.741"></a><span id="l24.741">           {</span>
<a href="#l24.742"></a><span id="l24.742" class="difflineminus">-            PR_LOG(IMAP, PR_LOG_WARN, (&quot;retry button pressed&quot;));</span>
<a href="#l24.743"></a><span id="l24.743" class="difflineplus">+            MOZ_LOG(IMAP, LogLevel::Warning, (&quot;retry button pressed&quot;));</span>
<a href="#l24.744"></a><span id="l24.744">             // Try all possible auth methods again</span>
<a href="#l24.745"></a><span id="l24.745">             ResetAuthMethods();</span>
<a href="#l24.746"></a><span id="l24.746">           }</span>
<a href="#l24.747"></a><span id="l24.747">           else if (buttonPressed == 1) // Cancel button</span>
<a href="#l24.748"></a><span id="l24.748">           {</span>
<a href="#l24.749"></a><span id="l24.749" class="difflineminus">-            PR_LOG(IMAP, PR_LOG_WARN, (&quot;cancel button pressed&quot;));</span>
<a href="#l24.750"></a><span id="l24.750" class="difflineplus">+            MOZ_LOG(IMAP, LogLevel::Warning, (&quot;cancel button pressed&quot;));</span>
<a href="#l24.751"></a><span id="l24.751">             break; // Abort quickly</span>
<a href="#l24.752"></a><span id="l24.752">           }</span>
<a href="#l24.753"></a><span id="l24.753"> </span>
<a href="#l24.754"></a><span id="l24.754">           // TODO what is this for? When does it get set to != unknown again?</span>
<a href="#l24.755"></a><span id="l24.755">           m_currentBiffState = nsIMsgFolder::nsMsgBiffState_Unknown;</span>
<a href="#l24.756"></a><span id="l24.756">           SendSetBiffIndicatorEvent(m_currentBiffState);</span>
<a href="#l24.757"></a><span id="l24.757">         } // all methods failed</span>
<a href="#l24.758"></a><span id="l24.758">       } // login failed</span>
<a href="#l24.759"></a><span id="l24.759">   } // while</span>
<a href="#l24.760"></a><span id="l24.760"> </span>
<a href="#l24.761"></a><span id="l24.761">   if (loginSucceeded)</span>
<a href="#l24.762"></a><span id="l24.762">   {</span>
<a href="#l24.763"></a><span id="l24.763" class="difflineminus">-    PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;login succeeded&quot;));</span>
<a href="#l24.764"></a><span id="l24.764" class="difflineplus">+    MOZ_LOG(IMAP, LogLevel::Debug, (&quot;login succeeded&quot;));</span>
<a href="#l24.765"></a><span id="l24.765">     bool passwordAlreadyVerified;</span>
<a href="#l24.766"></a><span id="l24.766">     m_hostSessionList-&gt;SetPasswordForHost(GetImapServerKey(), password.get());</span>
<a href="#l24.767"></a><span id="l24.767">     rv = m_hostSessionList-&gt;GetPasswordVerifiedOnline(GetImapServerKey(), passwordAlreadyVerified);</span>
<a href="#l24.768"></a><span id="l24.768">     if (NS_SUCCEEDED(rv) &amp;&amp; !passwordAlreadyVerified)</span>
<a href="#l24.769"></a><span id="l24.769">       m_hostSessionList-&gt;SetPasswordVerifiedOnline(GetImapServerKey());</span>
<a href="#l24.770"></a><span id="l24.770">     bool imapPasswordIsNew = !passwordAlreadyVerified;</span>
<a href="#l24.771"></a><span id="l24.771">     if (imapPasswordIsNew)</span>
<a href="#l24.772"></a><span id="l24.772">     {</span>
<a href="#l24.773"></a><span id="l24.773" class="difflineat">@@ -8539,17 +8541,17 @@ bool nsImapProtocol::TryToLogon()</span>
<a href="#l24.774"></a><span id="l24.774">     // We don't want to do any more processing if we're just</span>
<a href="#l24.775"></a><span id="l24.775">     // verifying the ability to logon because it can leave us in</span>
<a href="#l24.776"></a><span id="l24.776">     // a half-constructed state.</span>
<a href="#l24.777"></a><span id="l24.777">     if (imapAction != nsIImapUrl::nsImapVerifylogon)</span>
<a href="#l24.778"></a><span id="l24.778">       ProcessAfterAuthenticated();</span>
<a href="#l24.779"></a><span id="l24.779">   }</span>
<a href="#l24.780"></a><span id="l24.780">   else // login failed</span>
<a href="#l24.781"></a><span id="l24.781">   {</span>
<a href="#l24.782"></a><span id="l24.782" class="difflineminus">-    PR_LOG(IMAP, PR_LOG_ERROR, (&quot;login failed entirely&quot;));</span>
<a href="#l24.783"></a><span id="l24.783" class="difflineplus">+    MOZ_LOG(IMAP, LogLevel::Error, (&quot;login failed entirely&quot;));</span>
<a href="#l24.784"></a><span id="l24.784">     m_currentBiffState = nsIMsgFolder::nsMsgBiffState_Unknown;</span>
<a href="#l24.785"></a><span id="l24.785">     SendSetBiffIndicatorEvent(m_currentBiffState);</span>
<a href="#l24.786"></a><span id="l24.786">     HandleCurrentUrlError();</span>
<a href="#l24.787"></a><span id="l24.787">     SetConnectionStatus(NS_ERROR_FAILURE); // stop netlib</span>
<a href="#l24.788"></a><span id="l24.788">   }</span>
<a href="#l24.789"></a><span id="l24.789"> </span>
<a href="#l24.790"></a><span id="l24.790">   return loginSucceeded;</span>
<a href="#l24.791"></a><span id="l24.791"> }</span>
<a href="#l24.792"></a><span id="l24.792" class="difflineat">@@ -9160,17 +9162,17 @@ nsresult nsImapMockChannel::ReadFromMemC</span>
<a href="#l24.793"></a><span id="l24.793">         // A failure to get a message header isn't an error</span>
<a href="#l24.794"></a><span id="l24.794">         msgUrl-&gt;GetMessageHeader(getter_AddRefs(msgHdr));</span>
<a href="#l24.795"></a><span id="l24.795">         if (msgHdr)</span>
<a href="#l24.796"></a><span id="l24.796">         {</span>
<a href="#l24.797"></a><span id="l24.797">           uint32_t messageSize;</span>
<a href="#l24.798"></a><span id="l24.798">           if (NS_SUCCEEDED(msgHdr-&gt;GetMessageSize(&amp;messageSize)) &amp;&amp;</span>
<a href="#l24.799"></a><span id="l24.799">               messageSize != entrySize)</span>
<a href="#l24.800"></a><span id="l24.800">           {</span>
<a href="#l24.801"></a><span id="l24.801" class="difflineminus">-            PR_LOG(IMAP, PR_LOG_WARN,</span>
<a href="#l24.802"></a><span id="l24.802" class="difflineplus">+            MOZ_LOG(IMAP, LogLevel::Warning,</span>
<a href="#l24.803"></a><span id="l24.803">                 (&quot;ReadFromMemCache size mismatch for %s: message %d, cache %d\n&quot;,</span>
<a href="#l24.804"></a><span id="l24.804">                  entryKey.get(), messageSize, entrySize));</span>
<a href="#l24.805"></a><span id="l24.805">             shouldUseCacheEntry = false;</span>
<a href="#l24.806"></a><span id="l24.806">           }</span>
<a href="#l24.807"></a><span id="l24.807">         }</span>
<a href="#l24.808"></a><span id="l24.808">       }</span>
<a href="#l24.809"></a><span id="l24.809">     }</span>
<a href="#l24.810"></a><span id="l24.810">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/imap/src/nsImapServerResponseParser.cpp</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapServerResponseParser.cpp</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -10,16 +10,17 @@</span>
<a href="#l25.4"></a><span id="l25.4"> #include &quot;nsImapServerResponseParser.h&quot;</span>
<a href="#l25.5"></a><span id="l25.5"> #include &quot;nsIMAPBodyShell.h&quot;</span>
<a href="#l25.6"></a><span id="l25.6"> #include &quot;nsImapFlagAndUidState.h&quot;</span>
<a href="#l25.7"></a><span id="l25.7"> #include &quot;nsIMAPNamespace.h&quot;</span>
<a href="#l25.8"></a><span id="l25.8"> #include &quot;nsImapStringBundle.h&quot;</span>
<a href="#l25.9"></a><span id="l25.9"> #include &quot;nsImapUtils.h&quot;</span>
<a href="#l25.10"></a><span id="l25.10"> #include &quot;nsCRT.h&quot;</span>
<a href="#l25.11"></a><span id="l25.11"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l25.13"></a><span id="l25.13"> </span>
<a href="#l25.14"></a><span id="l25.14"> ////////////////// nsImapServerResponseParser /////////////////////////</span>
<a href="#l25.15"></a><span id="l25.15"> </span>
<a href="#l25.16"></a><span id="l25.16"> extern PRLogModuleInfo* IMAP;</span>
<a href="#l25.17"></a><span id="l25.17"> </span>
<a href="#l25.18"></a><span id="l25.18"> nsImapServerResponseParser::nsImapServerResponseParser(nsImapProtocol &amp;imapProtocolConnection)</span>
<a href="#l25.19"></a><span id="l25.19">                             : nsIMAPGenericParser(),</span>
<a href="#l25.20"></a><span id="l25.20">     fReportingErrors(true),</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineat">@@ -433,17 +434,17 @@ void nsImapServerResponseParser::Process</span>
<a href="#l25.22"></a><span id="l25.22">           m_shell = nullptr;</span>
<a href="#l25.23"></a><span id="l25.23">         navCon-&gt;PseudoInterrupt(false);</span>
<a href="#l25.24"></a><span id="l25.24">       }</span>
<a href="#l25.25"></a><span id="l25.25">       else if (m_shell-&gt;GetIsValid())</span>
<a href="#l25.26"></a><span id="l25.26">       {</span>
<a href="#l25.27"></a><span id="l25.27">         // If we have a valid shell that has not already been cached, then cache it.</span>
<a href="#l25.28"></a><span id="l25.28">         if (!m_shell-&gt;IsShellCached() &amp;&amp; fHostSessionList)	// cache is responsible for destroying it</span>
<a href="#l25.29"></a><span id="l25.29">         {</span>
<a href="#l25.30"></a><span id="l25.30" class="difflineminus">-          PR_LOG(IMAP, PR_LOG_ALWAYS,</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineplus">+          MOZ_LOG(IMAP, mozilla::LogLevel::Info,</span>
<a href="#l25.32"></a><span id="l25.32">             (&quot;BODYSHELL:  Adding shell to cache.&quot;));</span>
<a href="#l25.33"></a><span id="l25.33">           const char *serverKey = fServerConnection.GetImapServerKey();</span>
<a href="#l25.34"></a><span id="l25.34">           fHostSessionList-&gt;AddShellToCacheForHost(</span>
<a href="#l25.35"></a><span id="l25.35">             serverKey, m_shell);</span>
<a href="#l25.36"></a><span id="l25.36">         }</span>
<a href="#l25.37"></a><span id="l25.37">       }</span>
<a href="#l25.38"></a><span id="l25.38">       m_shell = nullptr;</span>
<a href="#l25.39"></a><span id="l25.39">     }</span>
<a href="#l25.40"></a><span id="l25.40" class="difflineat">@@ -3066,23 +3067,23 @@ bool nsImapServerResponseParser::GetFill</span>
<a href="#l25.41"></a><span id="l25.41"> bool nsImapServerResponseParser::GetDownloadingHeaders()</span>
<a href="#l25.42"></a><span id="l25.42"> {</span>
<a href="#l25.43"></a><span id="l25.43">   return fDownloadingHeaders;</span>
<a href="#l25.44"></a><span id="l25.44"> }</span>
<a href="#l25.45"></a><span id="l25.45"> </span>
<a href="#l25.46"></a><span id="l25.46"> // Tells the server state parser to use a previously cached shell.</span>
<a href="#l25.47"></a><span id="l25.47"> void	nsImapServerResponseParser::UseCachedShell(nsIMAPBodyShell *cachedShell)</span>
<a href="#l25.48"></a><span id="l25.48"> {</span>
<a href="#l25.49"></a><span id="l25.49" class="difflineminus">-	// We shouldn't already have another shell we're dealing with.</span>
<a href="#l25.50"></a><span id="l25.50" class="difflineminus">-	if (m_shell &amp;&amp; cachedShell)</span>
<a href="#l25.51"></a><span id="l25.51" class="difflineminus">-	{</span>
<a href="#l25.52"></a><span id="l25.52" class="difflineminus">-		PR_LOG(IMAP, PR_LOG_ALWAYS, (&quot;PARSER: Shell Collision&quot;));</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineminus">-		NS_ASSERTION(false, &quot;shell collision&quot;);</span>
<a href="#l25.54"></a><span id="l25.54" class="difflineminus">-	}</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineminus">-	m_shell = cachedShell;</span>
<a href="#l25.56"></a><span id="l25.56" class="difflineplus">+  // We shouldn't already have another shell we're dealing with.</span>
<a href="#l25.57"></a><span id="l25.57" class="difflineplus">+  if (m_shell &amp;&amp; cachedShell)</span>
<a href="#l25.58"></a><span id="l25.58" class="difflineplus">+  {</span>
<a href="#l25.59"></a><span id="l25.59" class="difflineplus">+    MOZ_LOG(IMAP, mozilla::LogLevel::Info, (&quot;PARSER: Shell Collision&quot;));</span>
<a href="#l25.60"></a><span id="l25.60" class="difflineplus">+    NS_ASSERTION(false, &quot;shell collision&quot;);</span>
<a href="#l25.61"></a><span id="l25.61" class="difflineplus">+  }</span>
<a href="#l25.62"></a><span id="l25.62" class="difflineplus">+  m_shell = cachedShell;</span>
<a href="#l25.63"></a><span id="l25.63"> }</span>
<a href="#l25.64"></a><span id="l25.64"> </span>
<a href="#l25.65"></a><span id="l25.65"> </span>
<a href="#l25.66"></a><span id="l25.66"> void nsImapServerResponseParser::ResetCapabilityFlag()</span>
<a href="#l25.67"></a><span id="l25.67"> {</span>
<a href="#l25.68"></a><span id="l25.68"> }</span>
<a href="#l25.69"></a><span id="l25.69"> </span>
<a href="#l25.70"></a><span id="l25.70"> /*</span>
<a href="#l25.71"></a><span id="l25.71" class="difflineat">@@ -3095,19 +3096,20 @@ bool nsImapServerResponseParser::msg_fet</span>
<a href="#l25.72"></a><span id="l25.72">   numberOfCharsInThisChunk = atoi(fNextToken + 1);</span>
<a href="#l25.73"></a><span id="l25.73">   // If we didn't request a specific size, or the server isn't returning exactly</span>
<a href="#l25.74"></a><span id="l25.74">   // as many octets as we requested, this must be the last or only chunk</span>
<a href="#l25.75"></a><span id="l25.75">   bool lastChunk = (!chunk ||</span>
<a href="#l25.76"></a><span id="l25.76">                     (numberOfCharsInThisChunk != fServerConnection.GetCurFetchSize()));</span>
<a href="#l25.77"></a><span id="l25.77"> </span>
<a href="#l25.78"></a><span id="l25.78"> #ifdef DEBUG</span>
<a href="#l25.79"></a><span id="l25.79">   if (lastChunk)</span>
<a href="#l25.80"></a><span id="l25.80" class="difflineminus">-    PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;PARSER: fetch_literal chunk = %d, requested %d, receiving %d&quot;,</span>
<a href="#l25.81"></a><span id="l25.81" class="difflineminus">-                                chunk, fServerConnection.GetCurFetchSize(),</span>
<a href="#l25.82"></a><span id="l25.82" class="difflineminus">-                                numberOfCharsInThisChunk));</span>
<a href="#l25.83"></a><span id="l25.83" class="difflineplus">+    MOZ_LOG(IMAP, mozilla::LogLevel::Debug,</span>
<a href="#l25.84"></a><span id="l25.84" class="difflineplus">+                  (&quot;PARSER: fetch_literal chunk = %d, requested %d, receiving %d&quot;,</span>
<a href="#l25.85"></a><span id="l25.85" class="difflineplus">+                    chunk, fServerConnection.GetCurFetchSize(),</span>
<a href="#l25.86"></a><span id="l25.86" class="difflineplus">+                    numberOfCharsInThisChunk));</span>
<a href="#l25.87"></a><span id="l25.87"> #endif</span>
<a href="#l25.88"></a><span id="l25.88"> </span>
<a href="#l25.89"></a><span id="l25.89">   charsReadSoFar = 0;</span>
<a href="#l25.90"></a><span id="l25.90">   static bool lastCRLFwasCRCRLF = false;</span>
<a href="#l25.91"></a><span id="l25.91"> </span>
<a href="#l25.92"></a><span id="l25.92">   while (ContinueParse() &amp;&amp; !fServerConnection.DeathSignalReceived() &amp;&amp; (charsReadSoFar &lt; numberOfCharsInThisChunk))</span>
<a href="#l25.93"></a><span id="l25.93">   {</span>
<a href="#l25.94"></a><span id="l25.94">     AdvanceToNextLine();</span>
<a href="#l25.95"></a><span id="l25.95" class="difflineat">@@ -3153,17 +3155,17 @@ bool nsImapServerResponseParser::msg_fet</span>
<a href="#l25.96"></a><span id="l25.96">             specialLineEnding || (!lastChunk &amp;&amp; (charsReadSoFar == numberOfCharsInThisChunk)),</span>
<a href="#l25.97"></a><span id="l25.97">             fCurrentLine);</span>
<a href="#l25.98"></a><span id="l25.98">       }</span>
<a href="#l25.99"></a><span id="l25.99">     }</span>
<a href="#l25.100"></a><span id="l25.100">   }</span>
<a href="#l25.101"></a><span id="l25.101"> </span>
<a href="#l25.102"></a><span id="l25.102">   // This would be a good thing to log.</span>
<a href="#l25.103"></a><span id="l25.103">   if (lastCRLFwasCRCRLF)</span>
<a href="#l25.104"></a><span id="l25.104" class="difflineminus">-    PR_LOG(IMAP, PR_LOG_ALWAYS, (&quot;PARSER: CR/LF fell on chunk boundary.&quot;));</span>
<a href="#l25.105"></a><span id="l25.105" class="difflineplus">+    MOZ_LOG(IMAP, mozilla::LogLevel::Info, (&quot;PARSER: CR/LF fell on chunk boundary.&quot;));</span>
<a href="#l25.106"></a><span id="l25.106"> </span>
<a href="#l25.107"></a><span id="l25.107">   if (ContinueParse())</span>
<a href="#l25.108"></a><span id="l25.108">   {</span>
<a href="#l25.109"></a><span id="l25.109">     if (charsReadSoFar &gt; numberOfCharsInThisChunk)</span>
<a href="#l25.110"></a><span id="l25.110">     {</span>
<a href="#l25.111"></a><span id="l25.111">       // move the lexical analyzer state to the end of this message because this message</span>
<a href="#l25.112"></a><span id="l25.112">       // fetch ends in the middle of this line.</span>
<a href="#l25.113"></a><span id="l25.113">       AdvanceTokenizerStartingPoint(strlen(fCurrentLine) - (charsReadSoFar - numberOfCharsInThisChunk));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/import/applemail/src/nsAppleMailImport.h</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/import/applemail/src/nsAppleMailImport.h</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -1,29 +1,29 @@</span>
<a href="#l26.4"></a><span id="l26.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l26.5"></a><span id="l26.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l26.6"></a><span id="l26.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l26.7"></a><span id="l26.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l26.8"></a><span id="l26.8"> </span>
<a href="#l26.9"></a><span id="l26.9"> #ifndef nsAppleMailImport_h___</span>
<a href="#l26.10"></a><span id="l26.10"> #define nsAppleMailImport_h___</span>
<a href="#l26.11"></a><span id="l26.11"> </span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-#include &quot;prlog.h&quot;</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l26.14"></a><span id="l26.14"> #include &quot;nsIImportModule.h&quot;</span>
<a href="#l26.15"></a><span id="l26.15"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l26.16"></a><span id="l26.16"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l26.17"></a><span id="l26.17"> #include &quot;nsIImportMail.h&quot;</span>
<a href="#l26.18"></a><span id="l26.18"> </span>
<a href="#l26.19"></a><span id="l26.19"> // logging facilities</span>
<a href="#l26.20"></a><span id="l26.20"> extern PRLogModuleInfo *APPLEMAILLOGMODULE;</span>
<a href="#l26.21"></a><span id="l26.21"> </span>
<a href="#l26.22"></a><span id="l26.22" class="difflineminus">-#define IMPORT_LOG0(x)          PR_LOG(APPLEMAILLOGMODULE, PR_LOG_DEBUG, (x))</span>
<a href="#l26.23"></a><span id="l26.23" class="difflineminus">-#define IMPORT_LOG1(x, y)       PR_LOG(APPLEMAILLOGMODULE, PR_LOG_DEBUG, (x, y))</span>
<a href="#l26.24"></a><span id="l26.24" class="difflineminus">-#define IMPORT_LOG2(x, y, z)    PR_LOG(APPLEMAILLOGMODULE, PR_LOG_DEBUG, (x, y, z))</span>
<a href="#l26.25"></a><span id="l26.25" class="difflineminus">-#define IMPORT_LOG3(a, b, c, d) PR_LOG(APPLEMAILLOGMODULE, PR_LOG_DEBUG, (a, b, c, d))</span>
<a href="#l26.26"></a><span id="l26.26" class="difflineplus">+#define IMPORT_LOG0(x)          MOZ_LOG(APPLEMAILLOGMODULE, mozilla::LogLevel::Debug, (x))</span>
<a href="#l26.27"></a><span id="l26.27" class="difflineplus">+#define IMPORT_LOG1(x, y)       MOZ_LOG(APPLEMAILLOGMODULE, mozilla::LogLevel::Debug, (x, y))</span>
<a href="#l26.28"></a><span id="l26.28" class="difflineplus">+#define IMPORT_LOG2(x, y, z)    MOZ_LOG(APPLEMAILLOGMODULE, mozilla::LogLevel::Debug, (x, y, z))</span>
<a href="#l26.29"></a><span id="l26.29" class="difflineplus">+#define IMPORT_LOG3(a, b, c, d) MOZ_LOG(APPLEMAILLOGMODULE, mozilla::LogLevel::Debug, (a, b, c, d))</span>
<a href="#l26.30"></a><span id="l26.30"> </span>
<a href="#l26.31"></a><span id="l26.31"> #define NS_APPLEMAILIMPL_CID \</span>
<a href="#l26.32"></a><span id="l26.32"> { 0x9117a1ea, 0xe012, 0x43b5, { 0xa0, 0x20, 0xcb, 0x8a, 0x66, 0xcc, 0x09, 0xe1 } }</span>
<a href="#l26.33"></a><span id="l26.33"> </span>
<a href="#l26.34"></a><span id="l26.34"> #define NS_APPLEMAILIMPORT_CID \</span>
<a href="#l26.35"></a><span id="l26.35"> { 0x6d3f101c, 0x70ec, 0x4e04, { 0xb6, 0x8d, 0x99, 0x08, 0xd1, 0xae, 0xdd, 0xf3 } }</span>
<a href="#l26.36"></a><span id="l26.36"> </span>
<a href="#l26.37"></a><span id="l26.37"> #define NS_APPLEMAILIMPL_CONTRACTID &quot;@mozilla.org/import/import-appleMailImpl;1&quot; </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/import/eudora/src/EudoraDebugLog.h</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/import/eudora/src/EudoraDebugLog.h</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -7,19 +7,19 @@</span>
<a href="#l27.4"></a><span id="l27.4"> #ifndef EudoraDebugLog_h___</span>
<a href="#l27.5"></a><span id="l27.5"> #define EudoraDebugLog_h___</span>
<a href="#l27.6"></a><span id="l27.6"> </span>
<a href="#l27.7"></a><span id="l27.7"> #ifdef NS_DEBUG</span>
<a href="#l27.8"></a><span id="l27.8"> #define IMPORT_DEBUG  1</span>
<a href="#l27.9"></a><span id="l27.9"> #endif</span>
<a href="#l27.10"></a><span id="l27.10"> </span>
<a href="#l27.11"></a><span id="l27.11"> // Use PR_LOG for logging.</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-#include &quot;prlog.h&quot;</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l27.14"></a><span id="l27.14"> extern PRLogModuleInfo *EUDORALOGMODULE;  // Logging module</span>
<a href="#l27.15"></a><span id="l27.15"> </span>
<a href="#l27.16"></a><span id="l27.16" class="difflineminus">-#define IMPORT_LOG0(x)          PR_LOG(EUDORALOGMODULE, PR_LOG_DEBUG, (x))</span>
<a href="#l27.17"></a><span id="l27.17" class="difflineminus">-#define IMPORT_LOG1(x, y)       PR_LOG(EUDORALOGMODULE, PR_LOG_DEBUG, (x, y))</span>
<a href="#l27.18"></a><span id="l27.18" class="difflineminus">-#define IMPORT_LOG2(x, y, z)    PR_LOG(EUDORALOGMODULE, PR_LOG_DEBUG, (x, y, z))</span>
<a href="#l27.19"></a><span id="l27.19" class="difflineminus">-#define IMPORT_LOG3(a, b, c, d) PR_LOG(EUDORALOGMODULE, PR_LOG_DEBUG, (a, b, c, d))</span>
<a href="#l27.20"></a><span id="l27.20" class="difflineplus">+#define IMPORT_LOG0(x)          MOZ_LOG(EUDORALOGMODULE, mozilla::LogLevel::Debug, (x))</span>
<a href="#l27.21"></a><span id="l27.21" class="difflineplus">+#define IMPORT_LOG1(x, y)       MOZ_LOG(EUDORALOGMODULE, mozilla::LogLevel::Debug, (x, y))</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineplus">+#define IMPORT_LOG2(x, y, z)    MOZ_LOG(EUDORALOGMODULE, mozilla::LogLevel::Debug, (x, y, z))</span>
<a href="#l27.23"></a><span id="l27.23" class="difflineplus">+#define IMPORT_LOG3(a, b, c, d) MOZ_LOG(EUDORALOGMODULE, mozilla::LogLevel::Debug, (a, b, c, d))</span>
<a href="#l27.24"></a><span id="l27.24"> </span>
<a href="#l27.25"></a><span id="l27.25"> </span>
<a href="#l27.26"></a><span id="l27.26"> </span>
<a href="#l27.27"></a><span id="l27.27"> #endif /* EudoraDebugLog_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/import/oexpress/OEDebugLog.h</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/import/oexpress/OEDebugLog.h</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -1,20 +1,20 @@</span>
<a href="#l28.4"></a><span id="l28.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l28.5"></a><span id="l28.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l28.6"></a><span id="l28.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l28.7"></a><span id="l28.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l28.8"></a><span id="l28.8"> </span>
<a href="#l28.9"></a><span id="l28.9"> #ifndef OEDebugLog_h___</span>
<a href="#l28.10"></a><span id="l28.10"> #define OEDebugLog_h___</span>
<a href="#l28.11"></a><span id="l28.11"> </span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-// Use PR_LOG for logging.</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineminus">-#include &quot;prlog.h&quot;</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineplus">+// Use MOZ_LOG for logging.</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l28.16"></a><span id="l28.16"> extern PRLogModuleInfo *OELOGMODULE;  // Logging module</span>
<a href="#l28.17"></a><span id="l28.17"> </span>
<a href="#l28.18"></a><span id="l28.18" class="difflineminus">-#define IMPORT_LOG0(x)          PR_LOG(OELOGMODULE, PR_LOG_DEBUG, (x))</span>
<a href="#l28.19"></a><span id="l28.19" class="difflineminus">-#define IMPORT_LOG1(x, y)       PR_LOG(OELOGMODULE, PR_LOG_DEBUG, (x, y))</span>
<a href="#l28.20"></a><span id="l28.20" class="difflineminus">-#define IMPORT_LOG2(x, y, z)    PR_LOG(OELOGMODULE, PR_LOG_DEBUG, (x, y, z))</span>
<a href="#l28.21"></a><span id="l28.21" class="difflineminus">-#define IMPORT_LOG3(a, b, c, d) PR_LOG(OELOGMODULE, PR_LOG_DEBUG, (a, b, c, d))</span>
<a href="#l28.22"></a><span id="l28.22" class="difflineplus">+#define IMPORT_LOG0(x)          MOZ_LOG(OELOGMODULE, mozilla::LogLevel::Debug, (x))</span>
<a href="#l28.23"></a><span id="l28.23" class="difflineplus">+#define IMPORT_LOG1(x, y)       MOZ_LOG(OELOGMODULE, mozilla::LogLevel::Debug, (x, y))</span>
<a href="#l28.24"></a><span id="l28.24" class="difflineplus">+#define IMPORT_LOG2(x, y, z)    MOZ_LOG(OELOGMODULE, mozilla::LogLevel::Debug, (x, y, z))</span>
<a href="#l28.25"></a><span id="l28.25" class="difflineplus">+#define IMPORT_LOG3(a, b, c, d) MOZ_LOG(OELOGMODULE, mozilla::LogLevel::Debug, (a, b, c, d))</span>
<a href="#l28.26"></a><span id="l28.26"> </span>
<a href="#l28.27"></a><span id="l28.27"> </span>
<a href="#l28.28"></a><span id="l28.28"> </span>
<a href="#l28.29"></a><span id="l28.29"> #endif /* OEDebugLog_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/import/outlook/src/OutlookDebugLog.h</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/import/outlook/src/OutlookDebugLog.h</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -6,19 +6,19 @@</span>
<a href="#l29.4"></a><span id="l29.4"> #ifndef OutlookDebugLog_h___</span>
<a href="#l29.5"></a><span id="l29.5"> #define OutlookDebugLog_h___</span>
<a href="#l29.6"></a><span id="l29.6"> </span>
<a href="#l29.7"></a><span id="l29.7"> #ifdef NS_DEBUG</span>
<a href="#l29.8"></a><span id="l29.8"> #define IMPORT_DEBUG  1</span>
<a href="#l29.9"></a><span id="l29.9"> #endif</span>
<a href="#l29.10"></a><span id="l29.10"> </span>
<a href="#l29.11"></a><span id="l29.11"> // Use PR_LOG for logging.</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-#include &quot;prlog.h&quot;</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l29.14"></a><span id="l29.14"> extern PRLogModuleInfo *OUTLOOKLOGMODULE;  // Logging module</span>
<a href="#l29.15"></a><span id="l29.15"> </span>
<a href="#l29.16"></a><span id="l29.16" class="difflineminus">-#define IMPORT_LOG0(x)          PR_LOG(OUTLOOKLOGMODULE, PR_LOG_DEBUG, (x))</span>
<a href="#l29.17"></a><span id="l29.17" class="difflineminus">-#define IMPORT_LOG1(x, y)       PR_LOG(OUTLOOKLOGMODULE, PR_LOG_DEBUG, (x, y))</span>
<a href="#l29.18"></a><span id="l29.18" class="difflineminus">-#define IMPORT_LOG2(x, y, z)    PR_LOG(OUTLOOKLOGMODULE, PR_LOG_DEBUG, (x, y, z))</span>
<a href="#l29.19"></a><span id="l29.19" class="difflineminus">-#define IMPORT_LOG3(a, b, c, d) PR_LOG(OUTLOOKLOGMODULE, PR_LOG_DEBUG, (a, b, c, d))</span>
<a href="#l29.20"></a><span id="l29.20" class="difflineplus">+#define IMPORT_LOG0(x)          MOZ_LOG(OUTLOOKLOGMODULE, mozilla::LogLevel::Debug, (x))</span>
<a href="#l29.21"></a><span id="l29.21" class="difflineplus">+#define IMPORT_LOG1(x, y)       MOZ_LOG(OUTLOOKLOGMODULE, mozilla::LogLevel::Debug, (x, y))</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineplus">+#define IMPORT_LOG2(x, y, z)    MOZ_LOG(OUTLOOKLOGMODULE, mozilla::LogLevel::Debug, (x, y, z))</span>
<a href="#l29.23"></a><span id="l29.23" class="difflineplus">+#define IMPORT_LOG3(a, b, c, d) MOZ_LOG(OUTLOOKLOGMODULE, mozilla::LogLevel::Debug, (a, b, c, d))</span>
<a href="#l29.24"></a><span id="l29.24"> </span>
<a href="#l29.25"></a><span id="l29.25"> </span>
<a href="#l29.26"></a><span id="l29.26"> </span>
<a href="#l29.27"></a><span id="l29.27"> #endif /* OutlookDebugLog_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/import/src/ImportDebug.h</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/import/src/ImportDebug.h</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -5,18 +5,18 @@</span>
<a href="#l30.4"></a><span id="l30.4"> </span>
<a href="#l30.5"></a><span id="l30.5"> #ifndef ImportDebug_h___</span>
<a href="#l30.6"></a><span id="l30.6"> #define ImportDebug_h___</span>
<a href="#l30.7"></a><span id="l30.7"> </span>
<a href="#l30.8"></a><span id="l30.8"> #ifdef NS_DEBUG</span>
<a href="#l30.9"></a><span id="l30.9"> #define IMPORT_DEBUG  1</span>
<a href="#l30.10"></a><span id="l30.10"> #endif</span>
<a href="#l30.11"></a><span id="l30.11"> </span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-// Use PR_LOG for logging.</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineminus">-#include &quot;prlog.h&quot;</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineplus">+// Use MOZ_LOG for logging.</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l30.16"></a><span id="l30.16"> extern PRLogModuleInfo *IMPORTLOGMODULE;  // Logging module</span>
<a href="#l30.17"></a><span id="l30.17"> </span>
<a href="#l30.18"></a><span id="l30.18" class="difflineminus">-#define IMPORT_LOG0(x)          PR_LOG(IMPORTLOGMODULE, PR_LOG_DEBUG, (x))</span>
<a href="#l30.19"></a><span id="l30.19" class="difflineminus">-#define IMPORT_LOG1(x, y)       PR_LOG(IMPORTLOGMODULE, PR_LOG_DEBUG, (x, y))</span>
<a href="#l30.20"></a><span id="l30.20" class="difflineminus">-#define IMPORT_LOG2(x, y, z)    PR_LOG(IMPORTLOGMODULE, PR_LOG_DEBUG, (x, y, z))</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineminus">-#define IMPORT_LOG3(a, b, c, d) PR_LOG(IMPORTLOGMODULE, PR_LOG_DEBUG, (a, b, c, d))</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineplus">+#define IMPORT_LOG0(x)          MOZ_LOG(IMPORTLOGMODULE, mozilla::LogLevel::Debug, (x))</span>
<a href="#l30.23"></a><span id="l30.23" class="difflineplus">+#define IMPORT_LOG1(x, y)       MOZ_LOG(IMPORTLOGMODULE, mozilla::LogLevel::Debug, (x, y))</span>
<a href="#l30.24"></a><span id="l30.24" class="difflineplus">+#define IMPORT_LOG2(x, y, z)    MOZ_LOG(IMPORTLOGMODULE, mozilla::LogLevel::Debug, (x, y, z))</span>
<a href="#l30.25"></a><span id="l30.25" class="difflineplus">+#define IMPORT_LOG3(a, b, c, d) MOZ_LOG(IMPORTLOGMODULE, mozilla::LogLevel::Debug, (a, b, c, d))</span>
<a href="#l30.26"></a><span id="l30.26"> </span>
<a href="#l30.27"></a><span id="l30.27"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/import/text/src/TextDebugLog.h</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/import/text/src/TextDebugLog.h</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -3,19 +3,19 @@</span>
<a href="#l31.4"></a><span id="l31.4">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l31.5"></a><span id="l31.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l31.6"></a><span id="l31.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l31.7"></a><span id="l31.7"> </span>
<a href="#l31.8"></a><span id="l31.8"> #ifndef TextDebugLog_h___</span>
<a href="#l31.9"></a><span id="l31.9"> #define TextDebugLog_h___</span>
<a href="#l31.10"></a><span id="l31.10"> </span>
<a href="#l31.11"></a><span id="l31.11"> // Use PR_LOG for logging.</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-#include &quot;prlog.h&quot;</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l31.14"></a><span id="l31.14"> extern PRLogModuleInfo *TEXTIMPORTLOGMODULE;  // Logging module</span>
<a href="#l31.15"></a><span id="l31.15"> </span>
<a href="#l31.16"></a><span id="l31.16" class="difflineminus">-#define IMPORT_LOG0(x)          PR_LOG(TEXTIMPORTLOGMODULE, PR_LOG_DEBUG, (x))</span>
<a href="#l31.17"></a><span id="l31.17" class="difflineminus">-#define IMPORT_LOG1(x, y)       PR_LOG(TEXTIMPORTLOGMODULE, PR_LOG_DEBUG, (x, y))</span>
<a href="#l31.18"></a><span id="l31.18" class="difflineminus">-#define IMPORT_LOG2(x, y, z)    PR_LOG(TEXTIMPORTLOGMODULE, PR_LOG_DEBUG, (x, y, z))</span>
<a href="#l31.19"></a><span id="l31.19" class="difflineminus">-#define IMPORT_LOG3(a, b, c, d) PR_LOG(TEXTIMPORTLOGMODULE, PR_LOG_DEBUG, (a, b, c, d))</span>
<a href="#l31.20"></a><span id="l31.20" class="difflineplus">+#define IMPORT_LOG0(x)          MOZ_LOG(TEXTIMPORTLOGMODULE, mozilla::LogLevel::Debug, (x))</span>
<a href="#l31.21"></a><span id="l31.21" class="difflineplus">+#define IMPORT_LOG1(x, y)       MOZ_LOG(TEXTIMPORTLOGMODULE, mozilla::LogLevel::Debug, (x, y))</span>
<a href="#l31.22"></a><span id="l31.22" class="difflineplus">+#define IMPORT_LOG2(x, y, z)    MOZ_LOG(TEXTIMPORTLOGMODULE, mozilla::LogLevel::Debug, (x, y, z))</span>
<a href="#l31.23"></a><span id="l31.23" class="difflineplus">+#define IMPORT_LOG3(a, b, c, d) MOZ_LOG(TEXTIMPORTLOGMODULE, mozilla::LogLevel::Debug, (a, b, c, d))</span>
<a href="#l31.24"></a><span id="l31.24"> </span>
<a href="#l31.25"></a><span id="l31.25"> </span>
<a href="#l31.26"></a><span id="l31.26"> </span>
<a href="#l31.27"></a><span id="l31.27"> #endif /* TextDebugLog_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/import/vcard/src/nsVCardAddress.h</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/import/vcard/src/nsVCardAddress.h</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -1,23 +1,23 @@</span>
<a href="#l32.4"></a><span id="l32.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l32.5"></a><span id="l32.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l32.6"></a><span id="l32.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l32.7"></a><span id="l32.7"> </span>
<a href="#l32.8"></a><span id="l32.8"> #ifndef nsVCardAddress_h__</span>
<a href="#l32.9"></a><span id="l32.9"> #define nsVCardAddress_h__</span>
<a href="#l32.10"></a><span id="l32.10"> </span>
<a href="#l32.11"></a><span id="l32.11" class="difflineminus">-#include &quot;prlog.h&quot;</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l32.13"></a><span id="l32.13"> </span>
<a href="#l32.14"></a><span id="l32.14"> extern PRLogModuleInfo *VCARDLOGMODULE;  // Logging module</span>
<a href="#l32.15"></a><span id="l32.15"> </span>
<a href="#l32.16"></a><span id="l32.16" class="difflineminus">-#define IMPORT_LOG0(x)          PR_LOG(VCARDLOGMODULE, PR_LOG_DEBUG, (x))</span>
<a href="#l32.17"></a><span id="l32.17" class="difflineminus">-#define IMPORT_LOG1(x, y)       PR_LOG(VCARDLOGMODULE, PR_LOG_DEBUG, (x, y))</span>
<a href="#l32.18"></a><span id="l32.18" class="difflineminus">-#define IMPORT_LOG2(x, y, z)    PR_LOG(VCARDLOGMODULE, PR_LOG_DEBUG, (x, y, z))</span>
<a href="#l32.19"></a><span id="l32.19" class="difflineminus">-#define IMPORT_LOG3(a, b, c, d) PR_LOG(VCARDLOGMODULE, PR_LOG_DEBUG, (a, b, c, d))</span>
<a href="#l32.20"></a><span id="l32.20" class="difflineplus">+#define IMPORT_LOG0(x)          MOZ_LOG(VCARDLOGMODULE, mozilla::LogLevel::Debug, (x))</span>
<a href="#l32.21"></a><span id="l32.21" class="difflineplus">+#define IMPORT_LOG1(x, y)       MOZ_LOG(VCARDLOGMODULE, mozilla::LogLevel::Debug, (x, y))</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineplus">+#define IMPORT_LOG2(x, y, z)    MOZ_LOG(VCARDLOGMODULE, mozilla::LogLevel::Debug, (x, y, z))</span>
<a href="#l32.23"></a><span id="l32.23" class="difflineplus">+#define IMPORT_LOG3(a, b, c, d) MOZ_LOG(VCARDLOGMODULE, mozilla::LogLevel::Debug, (a, b, c, d))</span>
<a href="#l32.24"></a><span id="l32.24"> </span>
<a href="#l32.25"></a><span id="l32.25"> class nsIAddrDatabase;</span>
<a href="#l32.26"></a><span id="l32.26"> class nsIFile;</span>
<a href="#l32.27"></a><span id="l32.27"> class nsILineInputStream;</span>
<a href="#l32.28"></a><span id="l32.28"> </span>
<a href="#l32.29"></a><span id="l32.29"> class nsVCardAddress {</span>
<a href="#l32.30"></a><span id="l32.30"> public:</span>
<a href="#l32.31"></a><span id="l32.31">   nsVCardAddress();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mailnews/import/winlivemail/WMDebugLog.h</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mailnews/import/winlivemail/WMDebugLog.h</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -2,19 +2,19 @@</span>
<a href="#l33.4"></a><span id="l33.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l33.5"></a><span id="l33.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l33.6"></a><span id="l33.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l33.7"></a><span id="l33.7"> </span>
<a href="#l33.8"></a><span id="l33.8"> #ifndef WMDebugLog_h___</span>
<a href="#l33.9"></a><span id="l33.9"> #define WMDebugLog_h___</span>
<a href="#l33.10"></a><span id="l33.10"> </span>
<a href="#l33.11"></a><span id="l33.11"> // Use PR_LOG for logging.</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-#include &quot;prlog.h&quot;</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l33.14"></a><span id="l33.14"> extern PRLogModuleInfo *WMLOGMODULE;  // Logging module</span>
<a href="#l33.15"></a><span id="l33.15"> </span>
<a href="#l33.16"></a><span id="l33.16" class="difflineminus">-#define IMPORT_LOG0(x)          PR_LOG(WMLOGMODULE, PR_LOG_DEBUG, (x))</span>
<a href="#l33.17"></a><span id="l33.17" class="difflineminus">-#define IMPORT_LOG1(x, y)       PR_LOG(WMLOGMODULE, PR_LOG_DEBUG, (x, y))</span>
<a href="#l33.18"></a><span id="l33.18" class="difflineminus">-#define IMPORT_LOG2(x, y, z)    PR_LOG(WMLOGMODULE, PR_LOG_DEBUG, (x, y, z))</span>
<a href="#l33.19"></a><span id="l33.19" class="difflineminus">-#define IMPORT_LOG3(a, b, c, d) PR_LOG(WMLOGMODULE, PR_LOG_DEBUG, (a, b, c, d))</span>
<a href="#l33.20"></a><span id="l33.20" class="difflineplus">+#define IMPORT_LOG0(x)          MOZ_LOG(WMLOGMODULE, mozilla::LogLevel::Debug, (x))</span>
<a href="#l33.21"></a><span id="l33.21" class="difflineplus">+#define IMPORT_LOG1(x, y)       MOZ_LOG(WMLOGMODULE, mozilla::LogLevel::Debug, (x, y))</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineplus">+#define IMPORT_LOG2(x, y, z)    MOZ_LOG(WMLOGMODULE, mozilla::LogLevel::Debug, (x, y, z))</span>
<a href="#l33.23"></a><span id="l33.23" class="difflineplus">+#define IMPORT_LOG3(a, b, c, d) MOZ_LOG(WMLOGMODULE, mozilla::LogLevel::Debug, (a, b, c, d))</span>
<a href="#l33.24"></a><span id="l33.24"> </span>
<a href="#l33.25"></a><span id="l33.25"> </span>
<a href="#l33.26"></a><span id="l33.26"> </span>
<a href="#l33.27"></a><span id="l33.27"> #endif /* WMDebugLog_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mailnews/local/src/nsMailboxProtocol.cpp</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mailnews/local/src/nsMailboxProtocol.cpp</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -11,17 +11,17 @@</span>
<a href="#l34.4"></a><span id="l34.4"> #include &quot;nsIMsgDatabase.h&quot;</span>
<a href="#l34.5"></a><span id="l34.5"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l34.6"></a><span id="l34.6"> #include &quot;nsMsgLineBuffer.h&quot;</span>
<a href="#l34.7"></a><span id="l34.7"> #include &quot;nsMsgDBCID.h&quot;</span>
<a href="#l34.8"></a><span id="l34.8"> #include &quot;nsIMsgMailNewsUrl.h&quot;</span>
<a href="#l34.9"></a><span id="l34.9"> #include &quot;nsICopyMsgStreamListener.h&quot;</span>
<a href="#l34.10"></a><span id="l34.10"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l34.11"></a><span id="l34.11"> #include &quot;prtime.h&quot;</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-#include &quot;prlog.h&quot;</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l34.14"></a><span id="l34.14"> #include &quot;prerror.h&quot;</span>
<a href="#l34.15"></a><span id="l34.15"> #include &quot;prprf.h&quot;</span>
<a href="#l34.16"></a><span id="l34.16"> #include &quot;nspr.h&quot;</span>
<a href="#l34.17"></a><span id="l34.17"> </span>
<a href="#l34.18"></a><span id="l34.18"> PRLogModuleInfo *MAILBOX;</span>
<a href="#l34.19"></a><span id="l34.19"> #include &quot;nsIFileStreams.h&quot;</span>
<a href="#l34.20"></a><span id="l34.20"> #include &quot;nsIStreamTransportService.h&quot;</span>
<a href="#l34.21"></a><span id="l34.21"> #include &quot;nsIStreamConverterService.h&quot;</span>
<a href="#l34.22"></a><span id="l34.22" class="difflineat">@@ -367,17 +367,17 @@ NS_IMETHODIMP nsMailboxProtocol::OnStopR</span>
<a href="#l34.23"></a><span id="l34.23">   // protocol connection....</span>
<a href="#l34.24"></a><span id="l34.24">   m_nextState = MAILBOX_DONE;</span>
<a href="#l34.25"></a><span id="l34.25">   </span>
<a href="#l34.26"></a><span id="l34.26">   // the following is for smoke test purposes. QA is looking at this &quot;Mailbox Done&quot; string which</span>
<a href="#l34.27"></a><span id="l34.27">   // is printed out to the console and determining if the mail app loaded up correctly...obviously</span>
<a href="#l34.28"></a><span id="l34.28">   // this solution is not very good so we should look at something better, but don't remove this</span>
<a href="#l34.29"></a><span id="l34.29">   // line before talking to me (mscott) and mailnews QA....</span>
<a href="#l34.30"></a><span id="l34.30">   </span>
<a href="#l34.31"></a><span id="l34.31" class="difflineminus">-  PR_LOG(MAILBOX, PR_LOG_ALWAYS, (&quot;Mailbox Done\n&quot;));</span>
<a href="#l34.32"></a><span id="l34.32" class="difflineplus">+  MOZ_LOG(MAILBOX, mozilla::LogLevel::Info, (&quot;Mailbox Done\n&quot;));</span>
<a href="#l34.33"></a><span id="l34.33">   </span>
<a href="#l34.34"></a><span id="l34.34">   // when on stop binding is called, we as the protocol are done...let's close down the connection</span>
<a href="#l34.35"></a><span id="l34.35">   // releasing all of our interfaces. It's important to remember that this on stop binding call</span>
<a href="#l34.36"></a><span id="l34.36">   // is coming from netlib so they are never going to ping us again with on data available. This means</span>
<a href="#l34.37"></a><span id="l34.37">   // we'll never be going through the Process loop...</span>
<a href="#l34.38"></a><span id="l34.38">   </span>
<a href="#l34.39"></a><span id="l34.39">   if (m_multipleMsgMoveCopyStream)</span>
<a href="#l34.40"></a><span id="l34.40">   {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mailnews/local/src/nsMovemailService.cpp</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mailnews/local/src/nsMovemailService.cpp</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -30,23 +30,23 @@</span>
<a href="#l35.4"></a><span id="l35.4"> #include &quot;nsILineInputStream.h&quot;</span>
<a href="#l35.5"></a><span id="l35.5"> #include &quot;nsISeekableStream.h&quot;</span>
<a href="#l35.6"></a><span id="l35.6"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l35.7"></a><span id="l35.7"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l35.8"></a><span id="l35.8"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l35.9"></a><span id="l35.9"> #include &quot;nsIMsgPluggableStore.h&quot;</span>
<a href="#l35.10"></a><span id="l35.10"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l35.11"></a><span id="l35.11"> </span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-#include &quot;prlog.h&quot;</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l35.14"></a><span id="l35.14"> #if defined(PR_LOGGING)</span>
<a href="#l35.15"></a><span id="l35.15"> //</span>
<a href="#l35.16"></a><span id="l35.16"> // export NSPR_LOG_MODULES=Movemail:5</span>
<a href="#l35.17"></a><span id="l35.17"> //</span>
<a href="#l35.18"></a><span id="l35.18"> static PRLogModuleInfo *gMovemailLog = nullptr;</span>
<a href="#l35.19"></a><span id="l35.19" class="difflineminus">-#define LOG(args) PR_LOG(gMovemailLog, PR_LOG_DEBUG, args)</span>
<a href="#l35.20"></a><span id="l35.20" class="difflineplus">+#define LOG(args) MOZ_LOG(gMovemailLog, mozilla::LogLevel::Debug, args)</span>
<a href="#l35.21"></a><span id="l35.21"> #else</span>
<a href="#l35.22"></a><span id="l35.22"> #define LOG(args)</span>
<a href="#l35.23"></a><span id="l35.23"> #endif</span>
<a href="#l35.24"></a><span id="l35.24"> </span>
<a href="#l35.25"></a><span id="l35.25"> #define PREF_MAIL_ROOT_MOVEMAIL &quot;mail.root.movemail&quot;            // old - for backward compatibility only</span>
<a href="#l35.26"></a><span id="l35.26"> #define PREF_MAIL_ROOT_MOVEMAIL_REL &quot;mail.root.movemail-rel&quot;</span>
<a href="#l35.27"></a><span id="l35.27"> </span>
<a href="#l35.28"></a><span id="l35.28"> #define LOCK_SUFFIX &quot;.lock&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mailnews/local/src/nsMsgMaildirStore.cpp</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mailnews/local/src/nsMsgMaildirStore.cpp</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -3,17 +3,17 @@</span>
<a href="#l36.4"></a><span id="l36.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l36.5"></a><span id="l36.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l36.6"></a><span id="l36.6"> </span>
<a href="#l36.7"></a><span id="l36.7"> /**</span>
<a href="#l36.8"></a><span id="l36.8">    Class for handling Maildir stores.</span>
<a href="#l36.9"></a><span id="l36.9"> */</span>
<a href="#l36.10"></a><span id="l36.10"> </span>
<a href="#l36.11"></a><span id="l36.11"> #include &quot;prprf.h&quot;</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-#include &quot;prlog.h&quot;</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l36.14"></a><span id="l36.14"> #include &quot;msgCore.h&quot;</span>
<a href="#l36.15"></a><span id="l36.15"> #include &quot;nsMsgMaildirStore.h&quot;</span>
<a href="#l36.16"></a><span id="l36.16"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l36.17"></a><span id="l36.17"> #include &quot;nsISimpleEnumerator.h&quot;</span>
<a href="#l36.18"></a><span id="l36.18"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l36.19"></a><span id="l36.19"> #include &quot;nsILocalMailIncomingServer.h&quot;</span>
<a href="#l36.20"></a><span id="l36.20"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l36.21"></a><span id="l36.21"> #include &quot;nsIFile.h&quot;</span>
<a href="#l36.22"></a><span id="l36.22" class="difflineat">@@ -237,17 +237,17 @@ NS_IMETHODIMP nsMsgMaildirStore::CreateF</span>
<a href="#l36.23"></a><span id="l36.23">         folderInfo-&gt;SetMailboxName(safeFolderName);</span>
<a href="#l36.24"></a><span id="l36.24"> </span>
<a href="#l36.25"></a><span id="l36.25">       unusedDB-&gt;SetSummaryValid(true);</span>
<a href="#l36.26"></a><span id="l36.26">       unusedDB-&gt;Close(true);</span>
<a href="#l36.27"></a><span id="l36.27">       aParent-&gt;UpdateSummaryTotals(true);</span>
<a href="#l36.28"></a><span id="l36.28">     }</span>
<a href="#l36.29"></a><span id="l36.29">     else</span>
<a href="#l36.30"></a><span id="l36.30">     {</span>
<a href="#l36.31"></a><span id="l36.31" class="difflineminus">-      PR_LOG(MailDirLog, PR_LOG_ALWAYS,</span>
<a href="#l36.32"></a><span id="l36.32" class="difflineplus">+      MOZ_LOG(MailDirLog, mozilla::LogLevel::Info,</span>
<a href="#l36.33"></a><span id="l36.33">             (&quot;CreateFolder - failed creating db for new folder\n&quot;));</span>
<a href="#l36.34"></a><span id="l36.34">       path-&gt;Remove(true); // recursive</span>
<a href="#l36.35"></a><span id="l36.35">       rv = NS_MSG_CANT_CREATE_FOLDER;</span>
<a href="#l36.36"></a><span id="l36.36">     }</span>
<a href="#l36.37"></a><span id="l36.37">   }</span>
<a href="#l36.38"></a><span id="l36.38">   child.swap(*aResult);</span>
<a href="#l36.39"></a><span id="l36.39">   return rv;</span>
<a href="#l36.40"></a><span id="l36.40"> }</span>
<a href="#l36.41"></a><span id="l36.41" class="difflineat">@@ -611,17 +611,17 @@ nsMsgMaildirStore::GetNewMsgOutputStream</span>
<a href="#l36.42"></a><span id="l36.42">   rv = aFolder-&gt;GetFilePath(getter_AddRefs(newFile));</span>
<a href="#l36.43"></a><span id="l36.43">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.44"></a><span id="l36.44">   newFile-&gt;Append(NS_LITERAL_STRING(&quot;tmp&quot;));</span>
<a href="#l36.45"></a><span id="l36.45"> </span>
<a href="#l36.46"></a><span id="l36.46">   // let's check if the folder exists</span>
<a href="#l36.47"></a><span id="l36.47">   bool exists;</span>
<a href="#l36.48"></a><span id="l36.48">   newFile-&gt;Exists(&amp;exists);</span>
<a href="#l36.49"></a><span id="l36.49">   if (!exists) {</span>
<a href="#l36.50"></a><span id="l36.50" class="difflineminus">-    PR_LOG(MailDirLog, PR_LOG_ALWAYS,</span>
<a href="#l36.51"></a><span id="l36.51" class="difflineplus">+    MOZ_LOG(MailDirLog, mozilla::LogLevel::Info,</span>
<a href="#l36.52"></a><span id="l36.52">            (&quot;GetNewMsgOutputStream - tmp subfolder does not exist!!\n&quot;));</span>
<a href="#l36.53"></a><span id="l36.53">     rv = newFile-&gt;Create(nsIFile::DIRECTORY_TYPE, 0755);</span>
<a href="#l36.54"></a><span id="l36.54">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.55"></a><span id="l36.55">   }</span>
<a href="#l36.56"></a><span id="l36.56"> </span>
<a href="#l36.57"></a><span id="l36.57">   // generate new file name</span>
<a href="#l36.58"></a><span id="l36.58">   nsAutoCString newName;</span>
<a href="#l36.59"></a><span id="l36.59">   newName.AppendInt(static_cast&lt;int64_t&gt;(PR_Now()));</span>
<a href="#l36.60"></a><span id="l36.60" class="difflineat">@@ -884,28 +884,28 @@ nsMsgMaildirStore::GetMsgInputStream(nsI</span>
<a href="#l36.61"></a><span id="l36.61"> </span>
<a href="#l36.62"></a><span id="l36.62">   // construct path to file</span>
<a href="#l36.63"></a><span id="l36.63">   nsCOMPtr&lt;nsIFile&gt; path;</span>
<a href="#l36.64"></a><span id="l36.64">   nsresult rv = aMsgFolder-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l36.65"></a><span id="l36.65">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.66"></a><span id="l36.66"> </span>
<a href="#l36.67"></a><span id="l36.67">   if (aMsgToken.IsEmpty())</span>
<a href="#l36.68"></a><span id="l36.68">   {</span>
<a href="#l36.69"></a><span id="l36.69" class="difflineminus">-    PR_LOG(MailDirLog, PR_LOG_ALWAYS,</span>
<a href="#l36.70"></a><span id="l36.70" class="difflineplus">+    MOZ_LOG(MailDirLog, mozilla::LogLevel::Info,</span>
<a href="#l36.71"></a><span id="l36.71">            (&quot;GetMsgInputStream - empty storeToken!!\n&quot;));</span>
<a href="#l36.72"></a><span id="l36.72">     return NS_ERROR_FAILURE;</span>
<a href="#l36.73"></a><span id="l36.73">   }</span>
<a href="#l36.74"></a><span id="l36.74"> </span>
<a href="#l36.75"></a><span id="l36.75">   path-&gt;Append(NS_LITERAL_STRING(&quot;cur&quot;));</span>
<a href="#l36.76"></a><span id="l36.76"> </span>
<a href="#l36.77"></a><span id="l36.77">   // let's check if the folder exists</span>
<a href="#l36.78"></a><span id="l36.78">   bool exists;</span>
<a href="#l36.79"></a><span id="l36.79">   path-&gt;Exists(&amp;exists);</span>
<a href="#l36.80"></a><span id="l36.80">   if (!exists) {</span>
<a href="#l36.81"></a><span id="l36.81" class="difflineminus">-    PR_LOG(MailDirLog, PR_LOG_ALWAYS,</span>
<a href="#l36.82"></a><span id="l36.82" class="difflineplus">+    MOZ_LOG(MailDirLog, mozilla::LogLevel::Info,</span>
<a href="#l36.83"></a><span id="l36.83">            (&quot;GetMsgInputStream - oops! cur subfolder does not exist!\n&quot;));</span>
<a href="#l36.84"></a><span id="l36.84">     rv = path-&gt;Create(nsIFile::DIRECTORY_TYPE, 0755);</span>
<a href="#l36.85"></a><span id="l36.85">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.86"></a><span id="l36.86">   }</span>
<a href="#l36.87"></a><span id="l36.87"> </span>
<a href="#l36.88"></a><span id="l36.88">   path-&gt;AppendNative(aMsgToken);</span>
<a href="#l36.89"></a><span id="l36.89">   return NS_NewLocalFileInputStream(aResult, path);</span>
<a href="#l36.90"></a><span id="l36.90"> }</span>
<a href="#l36.91"></a><span id="l36.91" class="difflineat">@@ -926,31 +926,31 @@ NS_IMETHODIMP nsMsgMaildirStore::DeleteM</span>
<a href="#l36.92"></a><span id="l36.92">     nsCOMPtr&lt;nsIFile&gt; path;</span>
<a href="#l36.93"></a><span id="l36.93">     rv = folder-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l36.94"></a><span id="l36.94">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.95"></a><span id="l36.95">     nsAutoCString fileName;</span>
<a href="#l36.96"></a><span id="l36.96">     msgHdr-&gt;GetStringProperty(&quot;storeToken&quot;, getter_Copies(fileName));</span>
<a href="#l36.97"></a><span id="l36.97"> </span>
<a href="#l36.98"></a><span id="l36.98">     if (fileName.IsEmpty())</span>
<a href="#l36.99"></a><span id="l36.99">     {</span>
<a href="#l36.100"></a><span id="l36.100" class="difflineminus">-      PR_LOG(MailDirLog, PR_LOG_ALWAYS,</span>
<a href="#l36.101"></a><span id="l36.101" class="difflineplus">+      MOZ_LOG(MailDirLog, mozilla::LogLevel::Info,</span>
<a href="#l36.102"></a><span id="l36.102">              (&quot;DeleteMessages - empty storeToken!!\n&quot;));</span>
<a href="#l36.103"></a><span id="l36.103">       // Perhaps an offline store has not downloaded this particular message.</span>
<a href="#l36.104"></a><span id="l36.104">       continue;</span>
<a href="#l36.105"></a><span id="l36.105">     }</span>
<a href="#l36.106"></a><span id="l36.106"> </span>
<a href="#l36.107"></a><span id="l36.107">     path-&gt;Append(NS_LITERAL_STRING(&quot;cur&quot;));</span>
<a href="#l36.108"></a><span id="l36.108">     path-&gt;AppendNative(fileName);</span>
<a href="#l36.109"></a><span id="l36.109"> </span>
<a href="#l36.110"></a><span id="l36.110">     // Let's check if the message exists.</span>
<a href="#l36.111"></a><span id="l36.111">     bool exists;</span>
<a href="#l36.112"></a><span id="l36.112">     path-&gt;Exists(&amp;exists);</span>
<a href="#l36.113"></a><span id="l36.113">     if (!exists)</span>
<a href="#l36.114"></a><span id="l36.114">     {</span>
<a href="#l36.115"></a><span id="l36.115" class="difflineminus">-      PR_LOG(MailDirLog, PR_LOG_ALWAYS,</span>
<a href="#l36.116"></a><span id="l36.116" class="difflineplus">+      MOZ_LOG(MailDirLog, mozilla::LogLevel::Info,</span>
<a href="#l36.117"></a><span id="l36.117">              (&quot;DeleteMessages - file does not exist !!\n&quot;));</span>
<a href="#l36.118"></a><span id="l36.118">       // Perhaps an offline store has not downloaded this particular message.</span>
<a href="#l36.119"></a><span id="l36.119">       continue;</span>
<a href="#l36.120"></a><span id="l36.120">     }</span>
<a href="#l36.121"></a><span id="l36.121">     path-&gt;Remove(false);</span>
<a href="#l36.122"></a><span id="l36.122">   }</span>
<a href="#l36.123"></a><span id="l36.123">   return NS_OK;</span>
<a href="#l36.124"></a><span id="l36.124"> }</span>
<a href="#l36.125"></a><span id="l36.125" class="difflineat">@@ -1036,28 +1036,28 @@ nsMsgMaildirStore::CopyMessages(bool aIs</span>
<a href="#l36.126"></a><span id="l36.126">   rv = aHdrArray-&gt;GetLength(&amp;messageCount);</span>
<a href="#l36.127"></a><span id="l36.127">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.128"></a><span id="l36.128"> </span>
<a href="#l36.129"></a><span id="l36.129">   for (uint32_t i = 0; i &lt; messageCount; i++)</span>
<a href="#l36.130"></a><span id="l36.130">   {</span>
<a href="#l36.131"></a><span id="l36.131">     nsCOMPtr&lt;nsIMsgDBHdr&gt; srcHdr = do_QueryElementAt(aHdrArray, i, &amp;rv);</span>
<a href="#l36.132"></a><span id="l36.132">     if (NS_FAILED(rv))</span>
<a href="#l36.133"></a><span id="l36.133">     {</span>
<a href="#l36.134"></a><span id="l36.134" class="difflineminus">-      PR_LOG(MailDirLog, PR_LOG_ALWAYS,</span>
<a href="#l36.135"></a><span id="l36.135" class="difflineplus">+      MOZ_LOG(MailDirLog, mozilla::LogLevel::Info,</span>
<a href="#l36.136"></a><span id="l36.136">              (&quot;srcHdr null\n&quot;));</span>
<a href="#l36.137"></a><span id="l36.137">       continue;</span>
<a href="#l36.138"></a><span id="l36.138">     }</span>
<a href="#l36.139"></a><span id="l36.139">     nsMsgKey srcKey;</span>
<a href="#l36.140"></a><span id="l36.140">     srcHdr-&gt;GetMessageKey(&amp;srcKey);</span>
<a href="#l36.141"></a><span id="l36.141">     msgTxn-&gt;AddSrcKey(srcKey);</span>
<a href="#l36.142"></a><span id="l36.142">     nsAutoCString fileName;</span>
<a href="#l36.143"></a><span id="l36.143">     msgHdr-&gt;GetStringProperty(&quot;storeToken&quot;, getter_Copies(fileName));</span>
<a href="#l36.144"></a><span id="l36.144">     if (fileName.IsEmpty())</span>
<a href="#l36.145"></a><span id="l36.145">     {</span>
<a href="#l36.146"></a><span id="l36.146" class="difflineminus">-      PR_LOG(MailDirLog, PR_LOG_ALWAYS,</span>
<a href="#l36.147"></a><span id="l36.147" class="difflineplus">+      MOZ_LOG(MailDirLog, mozilla::LogLevel::Info,</span>
<a href="#l36.148"></a><span id="l36.148">              (&quot;GetMsgInputStream - empty storeToken!!\n&quot;));</span>
<a href="#l36.149"></a><span id="l36.149">       return NS_ERROR_FAILURE;</span>
<a href="#l36.150"></a><span id="l36.150">     }</span>
<a href="#l36.151"></a><span id="l36.151"> </span>
<a href="#l36.152"></a><span id="l36.152">     nsCOMPtr&lt;nsIFile&gt; srcFile;</span>
<a href="#l36.153"></a><span id="l36.153">     rv = srcFolderPath-&gt;Clone(getter_AddRefs(srcFile));</span>
<a href="#l36.154"></a><span id="l36.154">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.155"></a><span id="l36.155">     srcFile-&gt;AppendNative(fileName);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mailnews/local/src/nsPop3Protocol.cpp</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3Protocol.cpp</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -36,16 +36,19 @@</span>
<a href="#l37.4"></a><span id="l37.4"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l37.5"></a><span id="l37.5"> #include &quot;nsISocketTransport.h&quot;</span>
<a href="#l37.6"></a><span id="l37.6"> #include &quot;nsISSLSocketControl.h&quot;</span>
<a href="#l37.7"></a><span id="l37.7"> #include &quot;nsILineInputStream.h&quot;</span>
<a href="#l37.8"></a><span id="l37.8"> #include &quot;nsIInterfaceRequestor.h&quot;</span>
<a href="#l37.9"></a><span id="l37.9"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l37.10"></a><span id="l37.10"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l37.11"></a><span id="l37.11"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineplus">+</span>
<a href="#l37.14"></a><span id="l37.14" class="difflineplus">+using namespace mozilla;</span>
<a href="#l37.15"></a><span id="l37.15"> </span>
<a href="#l37.16"></a><span id="l37.16"> PRLogModuleInfo *POP3LOGMODULE = nullptr;</span>
<a href="#l37.17"></a><span id="l37.17"> </span>
<a href="#l37.18"></a><span id="l37.18"> </span>
<a href="#l37.19"></a><span id="l37.19"> static int</span>
<a href="#l37.20"></a><span id="l37.20"> net_pop3_remove_messages_marked_delete(PLHashEntry* he,</span>
<a href="#l37.21"></a><span id="l37.21">                                        int msgindex,</span>
<a href="#l37.22"></a><span id="l37.22">                                        void *arg)</span>
<a href="#l37.23"></a><span id="l37.23" class="difflineat">@@ -560,17 +563,17 @@ nsresult nsPop3Protocol::Initialize(nsIU</span>
<a href="#l37.24"></a><span id="l37.24">     mozilla::services::GetStringBundleService();</span>
<a href="#l37.25"></a><span id="l37.25">   NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l37.26"></a><span id="l37.26">   return bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/localMsgs.properties&quot;, getter_AddRefs(mLocalBundle));</span>
<a href="#l37.27"></a><span id="l37.27"> }</span>
<a href="#l37.28"></a><span id="l37.28"> </span>
<a href="#l37.29"></a><span id="l37.29"> nsPop3Protocol::~nsPop3Protocol()</span>
<a href="#l37.30"></a><span id="l37.30"> {</span>
<a href="#l37.31"></a><span id="l37.31">   Cleanup();</span>
<a href="#l37.32"></a><span id="l37.32" class="difflineminus">-  PR_LOG(POP3LOGMODULE, PR_LOG_MAX, (&quot;~nsPop3Protocol()&quot;));</span>
<a href="#l37.33"></a><span id="l37.33" class="difflineplus">+  MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (&quot;~nsPop3Protocol()&quot;));</span>
<a href="#l37.34"></a><span id="l37.34"> }</span>
<a href="#l37.35"></a><span id="l37.35"> </span>
<a href="#l37.36"></a><span id="l37.36"> void nsPop3Protocol::Cleanup()</span>
<a href="#l37.37"></a><span id="l37.37"> {</span>
<a href="#l37.38"></a><span id="l37.38">   if (m_pop3ConData-&gt;newuidl)</span>
<a href="#l37.39"></a><span id="l37.39">   {</span>
<a href="#l37.40"></a><span id="l37.40">     PL_HashTableDestroy(m_pop3ConData-&gt;newuidl);</span>
<a href="#l37.41"></a><span id="l37.41">     m_pop3ConData-&gt;newuidl = nullptr;</span>
<a href="#l37.42"></a><span id="l37.42" class="difflineat">@@ -732,17 +735,17 @@ nsresult nsPop3Protocol::StartGetAsyncPa</span>
<a href="#l37.43"></a><span id="l37.43">   // Explict NS_ENSURE_SUCCESS for debug purposes as errors tend to get</span>
<a href="#l37.44"></a><span id="l37.44">   // hidden.</span>
<a href="#l37.45"></a><span id="l37.45">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l37.46"></a><span id="l37.46">   return rv;</span>
<a href="#l37.47"></a><span id="l37.47"> }</span>
<a href="#l37.48"></a><span id="l37.48"> </span>
<a href="#l37.49"></a><span id="l37.49"> NS_IMETHODIMP nsPop3Protocol::OnPromptStart(bool *aResult)</span>
<a href="#l37.50"></a><span id="l37.50"> {</span>
<a href="#l37.51"></a><span id="l37.51" class="difflineminus">-  PR_LOG(POP3LOGMODULE, PR_LOG_MAX, (&quot;OnPromptStart()&quot;));</span>
<a href="#l37.52"></a><span id="l37.52" class="difflineplus">+  MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (&quot;OnPromptStart()&quot;));</span>
<a href="#l37.53"></a><span id="l37.53"> </span>
<a href="#l37.54"></a><span id="l37.54">   *aResult = false;</span>
<a href="#l37.55"></a><span id="l37.55"> </span>
<a href="#l37.56"></a><span id="l37.56">   nsresult rv;</span>
<a href="#l37.57"></a><span id="l37.57">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_pop3Server, &amp;rv);</span>
<a href="#l37.58"></a><span id="l37.58">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l37.59"></a><span id="l37.59"> </span>
<a href="#l37.60"></a><span id="l37.60">   nsAutoCString passwordResult;</span>
<a href="#l37.61"></a><span id="l37.61" class="difflineat">@@ -773,26 +776,26 @@ NS_IMETHODIMP nsPop3Protocol::OnPromptSt</span>
<a href="#l37.62"></a><span id="l37.62"> </span>
<a href="#l37.63"></a><span id="l37.63">   // if the last prompt got us a bad password then show a special dialog</span>
<a href="#l37.64"></a><span id="l37.64">   if (TestFlag(POP3_PASSWORD_FAILED))</span>
<a href="#l37.65"></a><span id="l37.65">   {</span>
<a href="#l37.66"></a><span id="l37.66">     // Biff case (no msgWindow) shouldn't cause prompts or passwords to get forgotten at all</span>
<a href="#l37.67"></a><span id="l37.67">     // TODO shouldn't we skip the new password prompt below as well for biff? Just exit here?</span>
<a href="#l37.68"></a><span id="l37.68">     if (msgWindow)</span>
<a href="#l37.69"></a><span id="l37.69">     {</span>
<a href="#l37.70"></a><span id="l37.70" class="difflineminus">-      PR_LOG(POP3LOGMODULE, PR_LOG_WARN,</span>
<a href="#l37.71"></a><span id="l37.71" class="difflineplus">+      MOZ_LOG(POP3LOGMODULE, LogLevel::Warning,</span>
<a href="#l37.72"></a><span id="l37.72">           (&quot;POP: ask user what to do (after password failed): new password, retry or cancel&quot;));</span>
<a href="#l37.73"></a><span id="l37.73"> </span>
<a href="#l37.74"></a><span id="l37.74">       int32_t buttonPressed = 0;</span>
<a href="#l37.75"></a><span id="l37.75">       if (NS_SUCCEEDED(MsgPromptLoginFailed(msgWindow, hostName,</span>
<a href="#l37.76"></a><span id="l37.76">                                             &amp;buttonPressed)))</span>
<a href="#l37.77"></a><span id="l37.77">       {</span>
<a href="#l37.78"></a><span id="l37.78">         if (buttonPressed == 1) // Cancel button</span>
<a href="#l37.79"></a><span id="l37.79">         {</span>
<a href="#l37.80"></a><span id="l37.80" class="difflineminus">-          PR_LOG(POP3LOGMODULE, PR_LOG_WARN, (&quot;cancel button pressed&quot;));</span>
<a href="#l37.81"></a><span id="l37.81" class="difflineplus">+          MOZ_LOG(POP3LOGMODULE, LogLevel::Warning, (&quot;cancel button pressed&quot;));</span>
<a href="#l37.82"></a><span id="l37.82">           // Abort quickly and stop trying for now.</span>
<a href="#l37.83"></a><span id="l37.83"> </span>
<a href="#l37.84"></a><span id="l37.84">           // If we haven't actually connected yet (i.e. we're doing an early</span>
<a href="#l37.85"></a><span id="l37.85">           // attempt to get the username/password but we've previously failed</span>
<a href="#l37.86"></a><span id="l37.86">           // for some reason), then skip straight to POP3_FREE as it isn't an</span>
<a href="#l37.87"></a><span id="l37.87">           // error in this connection, and just ends up with us closing the</span>
<a href="#l37.88"></a><span id="l37.88">           // socket and saying we've aborted the bind. Otherwise, pretend this</span>
<a href="#l37.89"></a><span id="l37.89">           // is an error and move on.</span>
<a href="#l37.90"></a><span id="l37.90" class="difflineat">@@ -810,32 +813,32 @@ NS_IMETHODIMP nsPop3Protocol::OnPromptSt</span>
<a href="#l37.91"></a><span id="l37.91"> </span>
<a href="#l37.92"></a><span id="l37.92">           // As we're async, calling ProcessProtocolState gets things going</span>
<a href="#l37.93"></a><span id="l37.93">           // again.</span>
<a href="#l37.94"></a><span id="l37.94">           ProcessProtocolState(nullptr, nullptr, 0, 0);</span>
<a href="#l37.95"></a><span id="l37.95">           return NS_OK;</span>
<a href="#l37.96"></a><span id="l37.96">         }</span>
<a href="#l37.97"></a><span id="l37.97">         else if (buttonPressed == 2) // &quot;New password&quot; button</span>
<a href="#l37.98"></a><span id="l37.98">         {</span>
<a href="#l37.99"></a><span id="l37.99" class="difflineminus">-          PR_LOG(POP3LOGMODULE, PR_LOG_WARN, (&quot;new password button pressed&quot;));</span>
<a href="#l37.100"></a><span id="l37.100" class="difflineplus">+          MOZ_LOG(POP3LOGMODULE, LogLevel::Warning, (&quot;new password button pressed&quot;));</span>
<a href="#l37.101"></a><span id="l37.101">           // Forget the stored password</span>
<a href="#l37.102"></a><span id="l37.102">           // and we'll prompt for a new one next time around.</span>
<a href="#l37.103"></a><span id="l37.103">           rv = server-&gt;ForgetPassword();</span>
<a href="#l37.104"></a><span id="l37.104">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l37.105"></a><span id="l37.105"> </span>
<a href="#l37.106"></a><span id="l37.106">           // try all methods again with new password</span>
<a href="#l37.107"></a><span id="l37.107">           ResetAuthMethods();</span>
<a href="#l37.108"></a><span id="l37.108">           // ... apart from GSSAPI, which doesn't care about passwords</span>
<a href="#l37.109"></a><span id="l37.109">           MarkAuthMethodAsFailed(POP3_HAS_AUTH_GSSAPI);</span>
<a href="#l37.110"></a><span id="l37.110">           if (m_needToRerunUrl)</span>
<a href="#l37.111"></a><span id="l37.111">             return RerunUrl();</span>
<a href="#l37.112"></a><span id="l37.112">         }</span>
<a href="#l37.113"></a><span id="l37.113">         else if (buttonPressed == 0) // &quot;Retry&quot; button</span>
<a href="#l37.114"></a><span id="l37.114">         {</span>
<a href="#l37.115"></a><span id="l37.115" class="difflineminus">-          PR_LOG(POP3LOGMODULE, PR_LOG_WARN, (&quot;retry button pressed&quot;));</span>
<a href="#l37.116"></a><span id="l37.116" class="difflineplus">+          MOZ_LOG(POP3LOGMODULE, LogLevel::Warning, (&quot;retry button pressed&quot;));</span>
<a href="#l37.117"></a><span id="l37.117">           // try all methods again, including GSSAPI</span>
<a href="#l37.118"></a><span id="l37.118">           ResetAuthMethods();</span>
<a href="#l37.119"></a><span id="l37.119">           ClearFlag(POP3_PASSWORD_FAILED|POP3_AUTH_FAILURE);</span>
<a href="#l37.120"></a><span id="l37.120"> </span>
<a href="#l37.121"></a><span id="l37.121">           if (m_needToRerunUrl)</span>
<a href="#l37.122"></a><span id="l37.122">             return RerunUrl();</span>
<a href="#l37.123"></a><span id="l37.123"> </span>
<a href="#l37.124"></a><span id="l37.124">           // It is a bit strange that we're going onto the next state that </span>
<a href="#l37.125"></a><span id="l37.125" class="difflineat">@@ -926,17 +929,17 @@ NS_IMETHODIMP nsPop3Protocol::OnStopRequ</span>
<a href="#l37.126"></a><span id="l37.126">   {</span>
<a href="#l37.127"></a><span id="l37.127">     // Check if the connection was dropped before getting back an auth error.</span>
<a href="#l37.128"></a><span id="l37.128">     // If we got the auth error, the next state would be</span>
<a href="#l37.129"></a><span id="l37.129">     // POP3_OBTAIN_PASSWORD_EARLY.</span>
<a href="#l37.130"></a><span id="l37.130">     if ((m_pop3ConData-&gt;next_state_after_response == POP3_NEXT_AUTH_STEP ||</span>
<a href="#l37.131"></a><span id="l37.131">          m_pop3ConData-&gt;next_state_after_response == POP3_AUTH_LOGIN_RESPONSE) &amp;&amp;</span>
<a href="#l37.132"></a><span id="l37.132">         m_pop3ConData-&gt;next_state != POP3_OBTAIN_PASSWORD_EARLY)</span>
<a href="#l37.133"></a><span id="l37.133">     {</span>
<a href="#l37.134"></a><span id="l37.134" class="difflineminus">-      PR_LOG(POP3LOGMODULE, PR_LOG_MAX, (&quot;dropped connection before auth error&quot;));</span>
<a href="#l37.135"></a><span id="l37.135" class="difflineplus">+      MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (&quot;dropped connection before auth error&quot;));</span>
<a href="#l37.136"></a><span id="l37.136">       SetFlag(POP3_AUTH_FAILURE);</span>
<a href="#l37.137"></a><span id="l37.137">       m_pop3ConData-&gt;command_succeeded = false;</span>
<a href="#l37.138"></a><span id="l37.138">       m_needToRerunUrl = true;</span>
<a href="#l37.139"></a><span id="l37.139">       m_pop3ConData-&gt;next_state = POP3_NEXT_AUTH_STEP;</span>
<a href="#l37.140"></a><span id="l37.140">       ProcessProtocolState(nullptr, nullptr, 0, 0);</span>
<a href="#l37.141"></a><span id="l37.141">     }</span>
<a href="#l37.142"></a><span id="l37.142">     // We can't call nsMsgProtocol::OnStopRequest because it calls SetUrlState,</span>
<a href="#l37.143"></a><span id="l37.143">     // which notifies the URLListeners, but we need to do a bit of cleanup</span>
<a href="#l37.144"></a><span id="l37.144" class="difflineat">@@ -949,17 +952,17 @@ NS_IMETHODIMP nsPop3Protocol::OnStopRequ</span>
<a href="#l37.145"></a><span id="l37.145">     return NS_OK;</span>
<a href="#l37.146"></a><span id="l37.146">   }</span>
<a href="#l37.147"></a><span id="l37.147">   nsresult rv = nsMsgProtocol::OnStopRequest(aRequest, aContext, aStatus);</span>
<a href="#l37.148"></a><span id="l37.148"> </span>
<a href="#l37.149"></a><span id="l37.149">   // turn off the server busy flag on stop request - we know we're done, right?</span>
<a href="#l37.150"></a><span id="l37.150">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_pop3Server);</span>
<a href="#l37.151"></a><span id="l37.151">   if (server)</span>
<a href="#l37.152"></a><span id="l37.152">   {</span>
<a href="#l37.153"></a><span id="l37.153" class="difflineminus">-    PR_LOG(POP3LOGMODULE, PR_LOG_MAX, (&quot;Clearing server busy in OnStopRequest&quot;));</span>
<a href="#l37.154"></a><span id="l37.154" class="difflineplus">+    MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (&quot;Clearing server busy in OnStopRequest&quot;));</span>
<a href="#l37.155"></a><span id="l37.155">     server-&gt;SetServerBusy(false); // the server is not busy</span>
<a href="#l37.156"></a><span id="l37.156">   }</span>
<a href="#l37.157"></a><span id="l37.157">   if(m_pop3ConData-&gt;list_done)</span>
<a href="#l37.158"></a><span id="l37.158">     CommitState(true);</span>
<a href="#l37.159"></a><span id="l37.159">   if (NS_FAILED(aStatus) &amp;&amp; aStatus != NS_BINDING_ABORTED)</span>
<a href="#l37.160"></a><span id="l37.160">     Abort();</span>
<a href="#l37.161"></a><span id="l37.161">   return rv;</span>
<a href="#l37.162"></a><span id="l37.162"> }</span>
<a href="#l37.163"></a><span id="l37.163" class="difflineat">@@ -968,17 +971,17 @@ void nsPop3Protocol::Abort()</span>
<a href="#l37.164"></a><span id="l37.164"> {</span>
<a href="#l37.165"></a><span id="l37.165">   if(m_pop3ConData-&gt;msg_closure)</span>
<a href="#l37.166"></a><span id="l37.166">   {</span>
<a href="#l37.167"></a><span id="l37.167">       m_nsIPop3Sink-&gt;IncorporateAbort(m_pop3ConData-&gt;only_uidl != nullptr);</span>
<a href="#l37.168"></a><span id="l37.168">       m_pop3ConData-&gt;msg_closure = nullptr;</span>
<a href="#l37.169"></a><span id="l37.169">   }</span>
<a href="#l37.170"></a><span id="l37.170">   // need this to close the stream on the inbox.</span>
<a href="#l37.171"></a><span id="l37.171">   m_nsIPop3Sink-&gt;AbortMailDelivery(this);</span>
<a href="#l37.172"></a><span id="l37.172" class="difflineminus">-  PR_LOG(POP3LOGMODULE, PR_LOG_MAX, (&quot;Clearing running protocol in nsPop3Protocol::Abort&quot;));</span>
<a href="#l37.173"></a><span id="l37.173" class="difflineplus">+  MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (&quot;Clearing running protocol in nsPop3Protocol::Abort&quot;));</span>
<a href="#l37.174"></a><span id="l37.174">   m_pop3Server-&gt;SetRunningProtocol(nullptr);</span>
<a href="#l37.175"></a><span id="l37.175"> }</span>
<a href="#l37.176"></a><span id="l37.176"> </span>
<a href="#l37.177"></a><span id="l37.177"> NS_IMETHODIMP nsPop3Protocol::Cancel(nsresult status)  // handle stop button</span>
<a href="#l37.178"></a><span id="l37.178"> {</span>
<a href="#l37.179"></a><span id="l37.179">   Abort();</span>
<a href="#l37.180"></a><span id="l37.180">   return nsMsgProtocol::Cancel(NS_BINDING_ABORTED);</span>
<a href="#l37.181"></a><span id="l37.181"> }</span>
<a href="#l37.182"></a><span id="l37.182" class="difflineat">@@ -1051,17 +1054,17 @@ nsresult nsPop3Protocol::LoadUrl(nsIURI*</span>
<a href="#l37.183"></a><span id="l37.183">   nsCString hostName;</span>
<a href="#l37.184"></a><span id="l37.184">   nsCString userName;</span>
<a href="#l37.185"></a><span id="l37.185"> </span>
<a href="#l37.186"></a><span id="l37.186">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_pop3Server);</span>
<a href="#l37.187"></a><span id="l37.187">   if (server)</span>
<a href="#l37.188"></a><span id="l37.188">   {</span>
<a href="#l37.189"></a><span id="l37.189">     rv = server-&gt;GetLocalPath(getter_AddRefs(mailDirectory));</span>
<a href="#l37.190"></a><span id="l37.190">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l37.191"></a><span id="l37.191" class="difflineminus">-    PR_LOG(POP3LOGMODULE, PR_LOG_MAX, (&quot;Setting server busy in nsPop3Protocol::LoadUrl&quot;));</span>
<a href="#l37.192"></a><span id="l37.192" class="difflineplus">+    MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (&quot;Setting server busy in nsPop3Protocol::LoadUrl&quot;));</span>
<a href="#l37.193"></a><span id="l37.193">     server-&gt;SetServerBusy(true); // the server is now busy</span>
<a href="#l37.194"></a><span id="l37.194">     server-&gt;GetHostName(hostName);</span>
<a href="#l37.195"></a><span id="l37.195">     server-&gt;GetUsername(userName);</span>
<a href="#l37.196"></a><span id="l37.196">   }</span>
<a href="#l37.197"></a><span id="l37.197"> </span>
<a href="#l37.198"></a><span id="l37.198">   if (!m_pop3ConData-&gt;verify_logon)</span>
<a href="#l37.199"></a><span id="l37.199">     m_pop3ConData-&gt;uidlinfo = net_pop3_load_state(hostName.get(), userName.get(), mailDirectory);</span>
<a href="#l37.200"></a><span id="l37.200"> </span>
<a href="#l37.201"></a><span id="l37.201" class="difflineat">@@ -1120,17 +1123,17 @@ nsPop3Protocol::WaitForStartOfConnection</span>
<a href="#l37.202"></a><span id="l37.202">                                                  uint32_t length)</span>
<a href="#l37.203"></a><span id="l37.203"> {</span>
<a href="#l37.204"></a><span id="l37.204">   char * line = nullptr;</span>
<a href="#l37.205"></a><span id="l37.205">   uint32_t line_length = 0;</span>
<a href="#l37.206"></a><span id="l37.206">   bool pauseForMoreData = false;</span>
<a href="#l37.207"></a><span id="l37.207">   nsresult rv;</span>
<a href="#l37.208"></a><span id="l37.208">   line = m_lineStreamBuffer-&gt;ReadNextLine(aInputStream, line_length, pauseForMoreData, &amp;rv);</span>
<a href="#l37.209"></a><span id="l37.209"> </span>
<a href="#l37.210"></a><span id="l37.210" class="difflineminus">-  PR_LOG(POP3LOGMODULE, PR_LOG_ALWAYS,(&quot;RECV: %s&quot;, line));</span>
<a href="#l37.211"></a><span id="l37.211" class="difflineplus">+  MOZ_LOG(POP3LOGMODULE, LogLevel::Info,(&quot;RECV: %s&quot;, line));</span>
<a href="#l37.212"></a><span id="l37.212">   if (NS_FAILED(rv))</span>
<a href="#l37.213"></a><span id="l37.213">     return -1;</span>
<a href="#l37.214"></a><span id="l37.214"> </span>
<a href="#l37.215"></a><span id="l37.215">   if(pauseForMoreData || !line)</span>
<a href="#l37.216"></a><span id="l37.216">   {</span>
<a href="#l37.217"></a><span id="l37.217">     m_pop3ConData-&gt;pause_for_read = true; /* pause */</span>
<a href="#l37.218"></a><span id="l37.218">     PR_Free(line);</span>
<a href="#l37.219"></a><span id="l37.219">     return(line_length);</span>
<a href="#l37.220"></a><span id="l37.220" class="difflineat">@@ -1176,17 +1179,17 @@ nsPop3Protocol::WaitForResponse(nsIInput</span>
<a href="#l37.221"></a><span id="l37.221">   if(pauseForMoreData || !line)</span>
<a href="#l37.222"></a><span id="l37.222">   {</span>
<a href="#l37.223"></a><span id="l37.223">     m_pop3ConData-&gt;pause_for_read = true; /* pause */</span>
<a href="#l37.224"></a><span id="l37.224"> </span>
<a href="#l37.225"></a><span id="l37.225">     PR_Free(line);</span>
<a href="#l37.226"></a><span id="l37.226">     return(ln);</span>
<a href="#l37.227"></a><span id="l37.227">   }</span>
<a href="#l37.228"></a><span id="l37.228"> </span>
<a href="#l37.229"></a><span id="l37.229" class="difflineminus">-  PR_LOG(POP3LOGMODULE, PR_LOG_ALWAYS,(&quot;RECV: %s&quot;, line));</span>
<a href="#l37.230"></a><span id="l37.230" class="difflineplus">+  MOZ_LOG(POP3LOGMODULE, LogLevel::Info,(&quot;RECV: %s&quot;, line));</span>
<a href="#l37.231"></a><span id="l37.231"> </span>
<a href="#l37.232"></a><span id="l37.232">   if(*line == '+')</span>
<a href="#l37.233"></a><span id="l37.233">   {</span>
<a href="#l37.234"></a><span id="l37.234">     m_pop3ConData-&gt;command_succeeded = true;</span>
<a href="#l37.235"></a><span id="l37.235">     if(PL_strlen(line) &gt; 4)</span>
<a href="#l37.236"></a><span id="l37.236">     {</span>
<a href="#l37.237"></a><span id="l37.237">       if(!PL_strncasecmp(line, &quot;+OK&quot;, 3))</span>
<a href="#l37.238"></a><span id="l37.238">         m_commandResponse = line + 4;</span>
<a href="#l37.239"></a><span id="l37.239" class="difflineat">@@ -1205,17 +1208,17 @@ nsPop3Protocol::WaitForResponse(nsIInput</span>
<a href="#l37.240"></a><span id="l37.240">       m_commandResponse  = line;</span>
<a href="#l37.241"></a><span id="l37.241"> </span>
<a href="#l37.242"></a><span id="l37.242">     // search for the response codes (RFC 2449, chapter 8 and RFC 3206)</span>
<a href="#l37.243"></a><span id="l37.243">     if(TestCapFlag(POP3_HAS_RESP_CODES | POP3_HAS_AUTH_RESP_CODE))</span>
<a href="#l37.244"></a><span id="l37.244">     {</span>
<a href="#l37.245"></a><span id="l37.245">         // code for authentication failure due to the user's credentials</span>
<a href="#l37.246"></a><span id="l37.246">         if(m_commandResponse.Find(&quot;[AUTH&quot;, true) &gt;= 0)</span>
<a href="#l37.247"></a><span id="l37.247">         {</span>
<a href="#l37.248"></a><span id="l37.248" class="difflineminus">-          PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;setting auth failure&quot;));</span>
<a href="#l37.249"></a><span id="l37.249" class="difflineplus">+          MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (&quot;setting auth failure&quot;));</span>
<a href="#l37.250"></a><span id="l37.250">           SetFlag(POP3_AUTH_FAILURE);</span>
<a href="#l37.251"></a><span id="l37.251">         }</span>
<a href="#l37.252"></a><span id="l37.252"> </span>
<a href="#l37.253"></a><span id="l37.253">         // codes for failures due to other reasons</span>
<a href="#l37.254"></a><span id="l37.254">         if(m_commandResponse.Find(&quot;[LOGIN-DELAY&quot;, true) &gt;= 0 ||</span>
<a href="#l37.255"></a><span id="l37.255">            m_commandResponse.Find(&quot;[IN-USE&quot;, true) &gt;= 0 ||</span>
<a href="#l37.256"></a><span id="l37.256">            m_commandResponse.Find(&quot;[SYS&quot;, true) &gt;= 0)</span>
<a href="#l37.257"></a><span id="l37.257">       SetFlag(POP3_STOPLOGIN);</span>
<a href="#l37.258"></a><span id="l37.258" class="difflineat">@@ -1235,17 +1238,17 @@ nsPop3Protocol::WaitForResponse(nsIInput</span>
<a href="#l37.259"></a><span id="l37.259"> }</span>
<a href="#l37.260"></a><span id="l37.260"> </span>
<a href="#l37.261"></a><span id="l37.261"> int32_t</span>
<a href="#l37.262"></a><span id="l37.262"> nsPop3Protocol::Error(const char* err_code,</span>
<a href="#l37.263"></a><span id="l37.263">                       const char16_t **params,</span>
<a href="#l37.264"></a><span id="l37.264">                       uint32_t length)</span>
<a href="#l37.265"></a><span id="l37.265"> {</span>
<a href="#l37.266"></a><span id="l37.266">     </span>
<a href="#l37.267"></a><span id="l37.267" class="difflineminus">-    PR_LOG(POP3LOGMODULE, PR_LOG_ALWAYS, (&quot;ERROR: %s&quot;, err_code));</span>
<a href="#l37.268"></a><span id="l37.268" class="difflineplus">+    MOZ_LOG(POP3LOGMODULE, LogLevel::Info, (&quot;ERROR: %s&quot;, err_code));</span>
<a href="#l37.269"></a><span id="l37.269"> </span>
<a href="#l37.270"></a><span id="l37.270">     // the error code is just the resource name for the error string...</span>
<a href="#l37.271"></a><span id="l37.271">     // so print out that error message!</span>
<a href="#l37.272"></a><span id="l37.272">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_pop3Server);</span>
<a href="#l37.273"></a><span id="l37.273">     nsString accountName;</span>
<a href="#l37.274"></a><span id="l37.274">     nsresult rv = server-&gt;GetPrettyName(accountName);</span>
<a href="#l37.275"></a><span id="l37.275">     NS_ENSURE_SUCCESS(rv, -1);</span>
<a href="#l37.276"></a><span id="l37.276">     const char16_t *titleParams[] = { accountName.get() };</span>
<a href="#l37.277"></a><span id="l37.277" class="difflineat">@@ -1313,29 +1316,29 @@ int32_t nsPop3Protocol::Pop3SendData(con</span>
<a href="#l37.278"></a><span id="l37.278">   // remove any leftover bytes in the line buffer</span>
<a href="#l37.279"></a><span id="l37.279">   // this can happen if the last message line doesn't end with a (CR)LF</span>
<a href="#l37.280"></a><span id="l37.280">   // or a server sent two reply lines</span>
<a href="#l37.281"></a><span id="l37.281">   m_lineStreamBuffer-&gt;ClearBuffer();</span>
<a href="#l37.282"></a><span id="l37.282"> </span>
<a href="#l37.283"></a><span id="l37.283">   nsresult result = nsMsgProtocol::SendData(dataBuffer);</span>
<a href="#l37.284"></a><span id="l37.284"> </span>
<a href="#l37.285"></a><span id="l37.285">   if (!aSuppressLogging)</span>
<a href="#l37.286"></a><span id="l37.286" class="difflineminus">-      PR_LOG(POP3LOGMODULE, PR_LOG_ALWAYS, (&quot;SEND: %s&quot;, dataBuffer));</span>
<a href="#l37.287"></a><span id="l37.287" class="difflineplus">+      MOZ_LOG(POP3LOGMODULE, LogLevel::Info, (&quot;SEND: %s&quot;, dataBuffer));</span>
<a href="#l37.288"></a><span id="l37.288">   else</span>
<a href="#l37.289"></a><span id="l37.289" class="difflineminus">-      PR_LOG(POP3LOGMODULE, PR_LOG_ALWAYS, (&quot;Logging suppressed for this command (it probably contained authentication information)&quot;));</span>
<a href="#l37.290"></a><span id="l37.290" class="difflineplus">+      MOZ_LOG(POP3LOGMODULE, LogLevel::Info, (&quot;Logging suppressed for this command (it probably contained authentication information)&quot;));</span>
<a href="#l37.291"></a><span id="l37.291"> </span>
<a href="#l37.292"></a><span id="l37.292">   if (NS_SUCCEEDED(result))</span>
<a href="#l37.293"></a><span id="l37.293">   {</span>
<a href="#l37.294"></a><span id="l37.294">     m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l37.295"></a><span id="l37.295">     m_pop3ConData-&gt;next_state = POP3_WAIT_FOR_RESPONSE;</span>
<a href="#l37.296"></a><span id="l37.296">     return 0;</span>
<a href="#l37.297"></a><span id="l37.297">   }</span>
<a href="#l37.298"></a><span id="l37.298"> </span>
<a href="#l37.299"></a><span id="l37.299">   m_pop3ConData-&gt;next_state = POP3_ERROR_DONE;</span>
<a href="#l37.300"></a><span id="l37.300" class="difflineminus">-  PR_LOG(POP3LOGMODULE, PR_LOG_ALWAYS, (&quot;Pop3SendData failed: %lx&quot;, result));</span>
<a href="#l37.301"></a><span id="l37.301" class="difflineplus">+  MOZ_LOG(POP3LOGMODULE, LogLevel::Info, (&quot;Pop3SendData failed: %lx&quot;, result));</span>
<a href="#l37.302"></a><span id="l37.302">   return -1;</span>
<a href="#l37.303"></a><span id="l37.303"> }</span>
<a href="#l37.304"></a><span id="l37.304"> </span>
<a href="#l37.305"></a><span id="l37.305"> /*</span>
<a href="#l37.306"></a><span id="l37.306">  * POP3 AUTH extension</span>
<a href="#l37.307"></a><span id="l37.307">  */</span>
<a href="#l37.308"></a><span id="l37.308"> </span>
<a href="#l37.309"></a><span id="l37.309"> int32_t nsPop3Protocol::SendAuth()</span>
<a href="#l37.310"></a><span id="l37.310" class="difflineat">@@ -1380,17 +1383,17 @@ int32_t nsPop3Protocol::AuthResponse(nsI</span>
<a href="#l37.311"></a><span id="l37.311"> </span>
<a href="#l37.312"></a><span id="l37.312">     if(pauseForMoreData || !line)</span>
<a href="#l37.313"></a><span id="l37.313">     {</span>
<a href="#l37.314"></a><span id="l37.314">         m_pop3ConData-&gt;pause_for_read = true; /* pause */</span>
<a href="#l37.315"></a><span id="l37.315">         PR_Free(line);</span>
<a href="#l37.316"></a><span id="l37.316">         return(0);</span>
<a href="#l37.317"></a><span id="l37.317">     }</span>
<a href="#l37.318"></a><span id="l37.318"> </span>
<a href="#l37.319"></a><span id="l37.319" class="difflineminus">-    PR_LOG(POP3LOGMODULE, PR_LOG_ALWAYS,(&quot;RECV: %s&quot;, line));</span>
<a href="#l37.320"></a><span id="l37.320" class="difflineplus">+    MOZ_LOG(POP3LOGMODULE, LogLevel::Info,(&quot;RECV: %s&quot;, line));</span>
<a href="#l37.321"></a><span id="l37.321"> </span>
<a href="#l37.322"></a><span id="l37.322">     if (!PL_strcmp(line, &quot;.&quot;))</span>
<a href="#l37.323"></a><span id="l37.323">     {</span>
<a href="#l37.324"></a><span id="l37.324">         m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l37.325"></a><span id="l37.325"> </span>
<a href="#l37.326"></a><span id="l37.326">         // now that we've read all the AUTH responses, go for it</span>
<a href="#l37.327"></a><span id="l37.327">         m_pop3ConData-&gt;next_state = POP3_SEND_CAPA;</span>
<a href="#l37.328"></a><span id="l37.328">         m_pop3ConData-&gt;pause_for_read = false; /* don't pause */</span>
<a href="#l37.329"></a><span id="l37.329" class="difflineat">@@ -1413,17 +1416,17 @@ int32_t nsPop3Protocol::AuthResponse(nsI</span>
<a href="#l37.330"></a><span id="l37.330"> }</span>
<a href="#l37.331"></a><span id="l37.331"> </span>
<a href="#l37.332"></a><span id="l37.332"> /*</span>
<a href="#l37.333"></a><span id="l37.333">  * POP3 CAPA extension, see RFC 2449, chapter 5</span>
<a href="#l37.334"></a><span id="l37.334">  */</span>
<a href="#l37.335"></a><span id="l37.335"> </span>
<a href="#l37.336"></a><span id="l37.336"> int32_t nsPop3Protocol::SendCapa()</span>
<a href="#l37.337"></a><span id="l37.337"> {</span>
<a href="#l37.338"></a><span id="l37.338" class="difflineminus">-    PR_LOG(POP3LOGMODULE, PR_LOG_MAX, (&quot;SendCapa()&quot;));</span>
<a href="#l37.339"></a><span id="l37.339" class="difflineplus">+    MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (&quot;SendCapa()&quot;));</span>
<a href="#l37.340"></a><span id="l37.340">     if(!m_pop3ConData-&gt;command_succeeded)</span>
<a href="#l37.341"></a><span id="l37.341">         return Error(&quot;pop3ServerError&quot;);</span>
<a href="#l37.342"></a><span id="l37.342"> </span>
<a href="#l37.343"></a><span id="l37.343">     nsAutoCString command(&quot;CAPA&quot; CRLF);</span>
<a href="#l37.344"></a><span id="l37.344"> </span>
<a href="#l37.345"></a><span id="l37.345">     m_pop3ConData-&gt;next_state_after_response = POP3_CAPA_RESPONSE;</span>
<a href="#l37.346"></a><span id="l37.346">     return Pop3SendData(command.get());</span>
<a href="#l37.347"></a><span id="l37.347"> }</span>
<a href="#l37.348"></a><span id="l37.348" class="difflineat">@@ -1451,17 +1454,17 @@ int32_t nsPop3Protocol::CapaResponse(nsI</span>
<a href="#l37.349"></a><span id="l37.349"> </span>
<a href="#l37.350"></a><span id="l37.350">     if(pauseForMoreData || !line)</span>
<a href="#l37.351"></a><span id="l37.351">     {</span>
<a href="#l37.352"></a><span id="l37.352">         m_pop3ConData-&gt;pause_for_read = true; /* pause */</span>
<a href="#l37.353"></a><span id="l37.353">         PR_Free(line);</span>
<a href="#l37.354"></a><span id="l37.354">         return(0);</span>
<a href="#l37.355"></a><span id="l37.355">     }</span>
<a href="#l37.356"></a><span id="l37.356"> </span>
<a href="#l37.357"></a><span id="l37.357" class="difflineminus">-    PR_LOG(POP3LOGMODULE, PR_LOG_ALWAYS,(&quot;RECV: %s&quot;, line));</span>
<a href="#l37.358"></a><span id="l37.358" class="difflineplus">+    MOZ_LOG(POP3LOGMODULE, LogLevel::Info,(&quot;RECV: %s&quot;, line));</span>
<a href="#l37.359"></a><span id="l37.359"> </span>
<a href="#l37.360"></a><span id="l37.360">     if (!PL_strcmp(line, &quot;.&quot;))</span>
<a href="#l37.361"></a><span id="l37.361">     {</span>
<a href="#l37.362"></a><span id="l37.362">         // now that we've read all the CAPA responses, go for it</span>
<a href="#l37.363"></a><span id="l37.363">         m_pop3ConData-&gt;next_state = POP3_PROCESS_AUTH;</span>
<a href="#l37.364"></a><span id="l37.364">         m_pop3ConData-&gt;pause_for_read = false; /* don't pause */</span>
<a href="#l37.365"></a><span id="l37.365">     }</span>
<a href="#l37.366"></a><span id="l37.366">     else</span>
<a href="#l37.367"></a><span id="l37.367" class="difflineat">@@ -1515,17 +1518,17 @@ int32_t nsPop3Protocol::CapaResponse(nsI</span>
<a href="#l37.368"></a><span id="l37.368"> </span>
<a href="#l37.369"></a><span id="l37.369">         if (responseLine.Find(&quot;MSN&quot;, CaseInsensitiveCompare) &gt;= 0)</span>
<a href="#l37.370"></a><span id="l37.370">           SetCapFlag(POP3_HAS_AUTH_NTLM|POP3_HAS_AUTH_MSN);</span>
<a href="#l37.371"></a><span id="l37.371"> </span>
<a href="#l37.372"></a><span id="l37.372">         m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l37.373"></a><span id="l37.373">     }</span>
<a href="#l37.374"></a><span id="l37.374"> </span>
<a href="#l37.375"></a><span id="l37.375">     PR_Free(line);</span>
<a href="#l37.376"></a><span id="l37.376" class="difflineminus">-    PR_LOG(POP3LOGMODULE, PR_LOG_MAX, (&quot;capa processed&quot;));</span>
<a href="#l37.377"></a><span id="l37.377" class="difflineplus">+    MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (&quot;capa processed&quot;));</span>
<a href="#l37.378"></a><span id="l37.378">     return 0;</span>
<a href="#l37.379"></a><span id="l37.379"> }</span>
<a href="#l37.380"></a><span id="l37.380"> </span>
<a href="#l37.381"></a><span id="l37.381"> int32_t nsPop3Protocol::SendTLSResponse()</span>
<a href="#l37.382"></a><span id="l37.382"> {</span>
<a href="#l37.383"></a><span id="l37.383">   // only tear down our existing connection and open a new one if we received</span>
<a href="#l37.384"></a><span id="l37.384">   // a +OK response from the pop server after we issued the STLS command</span>
<a href="#l37.385"></a><span id="l37.385">   nsresult rv = NS_OK;</span>
<a href="#l37.386"></a><span id="l37.386" class="difflineat">@@ -1601,17 +1604,17 @@ void nsPop3Protocol::InitPrefAuthMethods</span>
<a href="#l37.387"></a><span id="l37.387">     case nsMsgAuthMethod::secure:</span>
<a href="#l37.388"></a><span id="l37.388">       m_prefAuthMethods = POP3_HAS_AUTH_APOP |</span>
<a href="#l37.389"></a><span id="l37.389">           POP3_HAS_AUTH_CRAM_MD5 | POP3_HAS_AUTH_GSSAPI |</span>
<a href="#l37.390"></a><span id="l37.390">           POP3_HAS_AUTH_NTLM | POP3_HAS_AUTH_MSN;</span>
<a href="#l37.391"></a><span id="l37.391">       break;</span>
<a href="#l37.392"></a><span id="l37.392">     default:</span>
<a href="#l37.393"></a><span id="l37.393">       NS_ASSERTION(false, &quot;POP: authMethod pref invalid&quot;);</span>
<a href="#l37.394"></a><span id="l37.394">       // TODO log to error console</span>
<a href="#l37.395"></a><span id="l37.395" class="difflineminus">-      PR_LOG(POP3LOGMODULE, PR_LOG_ERROR,</span>
<a href="#l37.396"></a><span id="l37.396" class="difflineplus">+      MOZ_LOG(POP3LOGMODULE, LogLevel::Error,</span>
<a href="#l37.397"></a><span id="l37.397">           (&quot;POP: bad pref authMethod = %d\n&quot;, authMethodPrefValue));</span>
<a href="#l37.398"></a><span id="l37.398">       // fall to any</span>
<a href="#l37.399"></a><span id="l37.399">     case nsMsgAuthMethod::anything:</span>
<a href="#l37.400"></a><span id="l37.400">       m_prefAuthMethods = POP3_HAS_AUTH_USER |</span>
<a href="#l37.401"></a><span id="l37.401">           POP3_HAS_AUTH_LOGIN | POP3_HAS_AUTH_PLAIN |</span>
<a href="#l37.402"></a><span id="l37.402">           POP3_HAS_AUTH_CRAM_MD5 | POP3_HAS_AUTH_APOP |</span>
<a href="#l37.403"></a><span id="l37.403">           POP3_HAS_AUTH_GSSAPI |</span>
<a href="#l37.404"></a><span id="l37.404">           POP3_HAS_AUTH_NTLM | POP3_HAS_AUTH_MSN;</span>
<a href="#l37.405"></a><span id="l37.405" class="difflineat">@@ -1626,20 +1629,20 @@ void nsPop3Protocol::InitPrefAuthMethods</span>
<a href="#l37.406"></a><span id="l37.406">  * Changes m_currentAuthMethod to pick the best one</span>
<a href="#l37.407"></a><span id="l37.407">  * which is allowed by server and prefs and not marked failed.</span>
<a href="#l37.408"></a><span id="l37.408">  * The order of preference and trying of auth methods is encoded here.</span>
<a href="#l37.409"></a><span id="l37.409">  */</span>
<a href="#l37.410"></a><span id="l37.410"> nsresult nsPop3Protocol::ChooseAuthMethod()</span>
<a href="#l37.411"></a><span id="l37.411"> {</span>
<a href="#l37.412"></a><span id="l37.412">   int32_t availCaps = GetCapFlags() &amp; m_prefAuthMethods &amp; ~m_failedAuthMethods;</span>
<a href="#l37.413"></a><span id="l37.413"> </span>
<a href="#l37.414"></a><span id="l37.414" class="difflineminus">-  PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG,</span>
<a href="#l37.415"></a><span id="l37.415" class="difflineplus">+  MOZ_LOG(POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l37.416"></a><span id="l37.416">         (&quot;POP auth: server caps 0x%X, pref 0x%X, failed 0x%X, avail caps 0x%X&quot;,</span>
<a href="#l37.417"></a><span id="l37.417">         GetCapFlags(), m_prefAuthMethods, m_failedAuthMethods, availCaps));</span>
<a href="#l37.418"></a><span id="l37.418" class="difflineminus">-  PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG,</span>
<a href="#l37.419"></a><span id="l37.419" class="difflineplus">+  MOZ_LOG(POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l37.420"></a><span id="l37.420">         (&quot;(GSSAPI = 0x%X, CRAM = 0x%X, APOP = 0x%X, NTLM = 0x%X, &quot;</span>
<a href="#l37.421"></a><span id="l37.421">         &quot;MSN =  0x%X, PLAIN = 0x%X, LOGIN = 0x%X, USER/PASS = 0x%X)&quot;,</span>
<a href="#l37.422"></a><span id="l37.422">         POP3_HAS_AUTH_GSSAPI, POP3_HAS_AUTH_CRAM_MD5, POP3_HAS_AUTH_APOP,</span>
<a href="#l37.423"></a><span id="l37.423">         POP3_HAS_AUTH_NTLM, POP3_HAS_AUTH_MSN, POP3_HAS_AUTH_PLAIN,</span>
<a href="#l37.424"></a><span id="l37.424">         POP3_HAS_AUTH_LOGIN, POP3_HAS_AUTH_USER));</span>
<a href="#l37.425"></a><span id="l37.425"> </span>
<a href="#l37.426"></a><span id="l37.426">   if (POP3_HAS_AUTH_GSSAPI &amp; availCaps)</span>
<a href="#l37.427"></a><span id="l37.427">     m_currentAuthMethod = POP3_HAS_AUTH_GSSAPI;</span>
<a href="#l37.428"></a><span id="l37.428" class="difflineat">@@ -1656,49 +1659,49 @@ nsresult nsPop3Protocol::ChooseAuthMetho</span>
<a href="#l37.429"></a><span id="l37.429">   else if (POP3_HAS_AUTH_LOGIN &amp; availCaps)</span>
<a href="#l37.430"></a><span id="l37.430">     m_currentAuthMethod = POP3_HAS_AUTH_LOGIN;</span>
<a href="#l37.431"></a><span id="l37.431">   else if (POP3_HAS_AUTH_USER &amp; availCaps)</span>
<a href="#l37.432"></a><span id="l37.432">     m_currentAuthMethod = POP3_HAS_AUTH_USER;</span>
<a href="#l37.433"></a><span id="l37.433">   else</span>
<a href="#l37.434"></a><span id="l37.434">   {</span>
<a href="#l37.435"></a><span id="l37.435">     // there are no matching login schemes at all, per server and prefs</span>
<a href="#l37.436"></a><span id="l37.436">     m_currentAuthMethod = POP3_AUTH_MECH_UNDEFINED;</span>
<a href="#l37.437"></a><span id="l37.437" class="difflineminus">-    PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;no auth method remaining&quot;));</span>
<a href="#l37.438"></a><span id="l37.438" class="difflineplus">+    MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (&quot;no auth method remaining&quot;));</span>
<a href="#l37.439"></a><span id="l37.439">     return NS_ERROR_FAILURE;</span>
<a href="#l37.440"></a><span id="l37.440">   }</span>
<a href="#l37.441"></a><span id="l37.441" class="difflineminus">-  PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;trying auth method 0x%X&quot;, m_currentAuthMethod));</span>
<a href="#l37.442"></a><span id="l37.442" class="difflineplus">+  MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (&quot;trying auth method 0x%X&quot;, m_currentAuthMethod));</span>
<a href="#l37.443"></a><span id="l37.443">   return NS_OK;</span>
<a href="#l37.444"></a><span id="l37.444"> }</span>
<a href="#l37.445"></a><span id="l37.445"> </span>
<a href="#l37.446"></a><span id="l37.446"> void nsPop3Protocol::MarkAuthMethodAsFailed(int32_t failedAuthMethod)</span>
<a href="#l37.447"></a><span id="l37.447"> {</span>
<a href="#l37.448"></a><span id="l37.448" class="difflineminus">-  PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG,</span>
<a href="#l37.449"></a><span id="l37.449" class="difflineplus">+  MOZ_LOG(POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l37.450"></a><span id="l37.450">       (&quot;marking auth method 0x%X failed&quot;, failedAuthMethod));</span>
<a href="#l37.451"></a><span id="l37.451">   m_failedAuthMethods |= failedAuthMethod;</span>
<a href="#l37.452"></a><span id="l37.452"> }</span>
<a href="#l37.453"></a><span id="l37.453"> </span>
<a href="#l37.454"></a><span id="l37.454"> /**</span>
<a href="#l37.455"></a><span id="l37.455">  * Start over, trying all auth methods again</span>
<a href="#l37.456"></a><span id="l37.456">  */</span>
<a href="#l37.457"></a><span id="l37.457"> void nsPop3Protocol::ResetAuthMethods()</span>
<a href="#l37.458"></a><span id="l37.458"> {</span>
<a href="#l37.459"></a><span id="l37.459" class="difflineminus">-  PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;resetting (failed) auth methods&quot;));</span>
<a href="#l37.460"></a><span id="l37.460" class="difflineplus">+  MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (&quot;resetting (failed) auth methods&quot;));</span>
<a href="#l37.461"></a><span id="l37.461">   m_currentAuthMethod = POP3_AUTH_MECH_UNDEFINED;</span>
<a href="#l37.462"></a><span id="l37.462">   m_failedAuthMethods = 0;</span>
<a href="#l37.463"></a><span id="l37.463"> }</span>
<a href="#l37.464"></a><span id="l37.464"> </span>
<a href="#l37.465"></a><span id="l37.465"> /**</span>
<a href="#l37.466"></a><span id="l37.466">  * state POP3_PROCESS_AUTH</span>
<a href="#l37.467"></a><span id="l37.467">  * Called when we should try to authenticate to the server.</span>
<a href="#l37.468"></a><span id="l37.468">  * Also called when one auth method fails and we want to try and start</span>
<a href="#l37.469"></a><span id="l37.469">  * the next best auth method.</span>
<a href="#l37.470"></a><span id="l37.470">  */</span>
<a href="#l37.471"></a><span id="l37.471"> int32_t nsPop3Protocol::ProcessAuth()</span>
<a href="#l37.472"></a><span id="l37.472"> {</span>
<a href="#l37.473"></a><span id="l37.473" class="difflineminus">-    PR_LOG(POP3LOGMODULE, PR_LOG_MAX, (&quot;ProcessAuth()&quot;));</span>
<a href="#l37.474"></a><span id="l37.474" class="difflineplus">+    MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (&quot;ProcessAuth()&quot;));</span>
<a href="#l37.475"></a><span id="l37.475"> </span>
<a href="#l37.476"></a><span id="l37.476">     // Try to upgrade to STARTTLS -- TODO move into its own function</span>
<a href="#l37.477"></a><span id="l37.477">     if (!m_tlsEnabled)</span>
<a href="#l37.478"></a><span id="l37.478">     {</span>
<a href="#l37.479"></a><span id="l37.479">       if(TestCapFlag(POP3_HAS_STLS))</span>
<a href="#l37.480"></a><span id="l37.480">       {</span>
<a href="#l37.481"></a><span id="l37.481">         if (m_socketType == nsMsgSocketType::trySTARTTLS ||</span>
<a href="#l37.482"></a><span id="l37.482">             m_socketType == nsMsgSocketType::alwaysSTARTTLS)</span>
<a href="#l37.483"></a><span id="l37.483" class="difflineat">@@ -1717,17 +1720,17 @@ int32_t nsPop3Protocol::ProcessAuth()</span>
<a href="#l37.484"></a><span id="l37.484">     }</span>
<a href="#l37.485"></a><span id="l37.485"> </span>
<a href="#l37.486"></a><span id="l37.486">     m_password_already_sent = false;</span>
<a href="#l37.487"></a><span id="l37.487"> </span>
<a href="#l37.488"></a><span id="l37.488">     nsresult rv = ChooseAuthMethod();</span>
<a href="#l37.489"></a><span id="l37.489">     if (NS_FAILED(rv))</span>
<a href="#l37.490"></a><span id="l37.490">     {</span>
<a href="#l37.491"></a><span id="l37.491">       // Pref doesn't match server. Now, find an appropriate error msg.</span>
<a href="#l37.492"></a><span id="l37.492" class="difflineminus">-      PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG,</span>
<a href="#l37.493"></a><span id="l37.493" class="difflineplus">+      MOZ_LOG(POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l37.494"></a><span id="l37.494">            (&quot;ProcessAuth() early exit because no auth methods&quot;));</span>
<a href="#l37.495"></a><span id="l37.495"> </span>
<a href="#l37.496"></a><span id="l37.496">       // AuthGSSAPI* falls in here in case of an auth failure.</span>
<a href="#l37.497"></a><span id="l37.497">       // If Kerberos was the only method, assume that</span>
<a href="#l37.498"></a><span id="l37.498">       // the user is just not logged in yet, and show an appropriate error.</span>
<a href="#l37.499"></a><span id="l37.499">       if (m_prefAuthMethods == POP3_HAS_AUTH_GSSAPI &amp;&amp;</span>
<a href="#l37.500"></a><span id="l37.500">           m_failedAuthMethods == POP3_HAS_AUTH_GSSAPI)</span>
<a href="#l37.501"></a><span id="l37.501">         return Error(&quot;pop3GssapiFailure&quot;);</span>
<a href="#l37.502"></a><span id="l37.502" class="difflineat">@@ -1756,45 +1759,45 @@ int32_t nsPop3Protocol::ProcessAuth()</span>
<a href="#l37.503"></a><span id="l37.503">       else</span>
<a href="#l37.504"></a><span id="l37.504">         // just &quot;change auth method&quot;</span>
<a href="#l37.505"></a><span id="l37.505">         return Error(&quot;pop3AuthMechNotSupported&quot;);</span>
<a href="#l37.506"></a><span id="l37.506">     }</span>
<a href="#l37.507"></a><span id="l37.507"> </span>
<a href="#l37.508"></a><span id="l37.508">     switch (m_currentAuthMethod)</span>
<a href="#l37.509"></a><span id="l37.509">     {</span>
<a href="#l37.510"></a><span id="l37.510">       case POP3_HAS_AUTH_GSSAPI:</span>
<a href="#l37.511"></a><span id="l37.511" class="difflineminus">-        PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;POP GSSAPI&quot;));</span>
<a href="#l37.512"></a><span id="l37.512" class="difflineplus">+        MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (&quot;POP GSSAPI&quot;));</span>
<a href="#l37.513"></a><span id="l37.513">         m_pop3ConData-&gt;next_state = POP3_AUTH_GSSAPI;</span>
<a href="#l37.514"></a><span id="l37.514">         break;</span>
<a href="#l37.515"></a><span id="l37.515">       case POP3_HAS_AUTH_APOP:</span>
<a href="#l37.516"></a><span id="l37.516" class="difflineminus">-        PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;POP APOP&quot;));</span>
<a href="#l37.517"></a><span id="l37.517" class="difflineplus">+        MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (&quot;POP APOP&quot;));</span>
<a href="#l37.518"></a><span id="l37.518">         m_pop3ConData-&gt;next_state = POP3_SEND_PASSWORD;</span>
<a href="#l37.519"></a><span id="l37.519">         break;</span>
<a href="#l37.520"></a><span id="l37.520">       case POP3_HAS_AUTH_CRAM_MD5:</span>
<a href="#l37.521"></a><span id="l37.521" class="difflineminus">-        PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;POP CRAM&quot;));</span>
<a href="#l37.522"></a><span id="l37.522" class="difflineplus">+        MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (&quot;POP CRAM&quot;));</span>
<a href="#l37.523"></a><span id="l37.523">       case POP3_HAS_AUTH_PLAIN:</span>
<a href="#l37.524"></a><span id="l37.524">       case POP3_HAS_AUTH_USER:</span>
<a href="#l37.525"></a><span id="l37.525" class="difflineminus">-        PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;POP username&quot;));</span>
<a href="#l37.526"></a><span id="l37.526" class="difflineplus">+        MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (&quot;POP username&quot;));</span>
<a href="#l37.527"></a><span id="l37.527">         m_pop3ConData-&gt;next_state = POP3_SEND_USERNAME;</span>
<a href="#l37.528"></a><span id="l37.528">         break;</span>
<a href="#l37.529"></a><span id="l37.529">       case POP3_HAS_AUTH_LOGIN:</span>
<a href="#l37.530"></a><span id="l37.530" class="difflineminus">-        PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;POP AUTH=LOGIN&quot;));</span>
<a href="#l37.531"></a><span id="l37.531" class="difflineplus">+        MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (&quot;POP AUTH=LOGIN&quot;));</span>
<a href="#l37.532"></a><span id="l37.532">         m_pop3ConData-&gt;next_state = POP3_AUTH_LOGIN;</span>
<a href="#l37.533"></a><span id="l37.533">         break;</span>
<a href="#l37.534"></a><span id="l37.534">       case POP3_HAS_AUTH_NTLM:</span>
<a href="#l37.535"></a><span id="l37.535" class="difflineminus">-        PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;POP NTLM&quot;));</span>
<a href="#l37.536"></a><span id="l37.536" class="difflineplus">+        MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (&quot;POP NTLM&quot;));</span>
<a href="#l37.537"></a><span id="l37.537">         m_pop3ConData-&gt;next_state = POP3_AUTH_NTLM;</span>
<a href="#l37.538"></a><span id="l37.538">         break;</span>
<a href="#l37.539"></a><span id="l37.539">       case POP3_HAS_AUTH_NONE:</span>
<a href="#l37.540"></a><span id="l37.540" class="difflineminus">-        PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;POP no auth&quot;));</span>
<a href="#l37.541"></a><span id="l37.541" class="difflineplus">+        MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (&quot;POP no auth&quot;));</span>
<a href="#l37.542"></a><span id="l37.542">         m_pop3ConData-&gt;command_succeeded = true;</span>
<a href="#l37.543"></a><span id="l37.543">         m_pop3ConData-&gt;next_state = POP3_NEXT_AUTH_STEP;</span>
<a href="#l37.544"></a><span id="l37.544">         break;</span>
<a href="#l37.545"></a><span id="l37.545">       default:</span>
<a href="#l37.546"></a><span id="l37.546" class="difflineminus">-        PR_LOG(POP3LOGMODULE, PR_LOG_ERROR,</span>
<a href="#l37.547"></a><span id="l37.547" class="difflineplus">+        MOZ_LOG(POP3LOGMODULE, LogLevel::Error,</span>
<a href="#l37.548"></a><span id="l37.548">              (&quot;POP: m_currentAuthMethod has unknown value&quot;));</span>
<a href="#l37.549"></a><span id="l37.549">         return Error(&quot;pop3AuthMechNotSupported&quot;);</span>
<a href="#l37.550"></a><span id="l37.550">     }</span>
<a href="#l37.551"></a><span id="l37.551"> </span>
<a href="#l37.552"></a><span id="l37.552">     m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l37.553"></a><span id="l37.553"> </span>
<a href="#l37.554"></a><span id="l37.554">     return 0;</span>
<a href="#l37.555"></a><span id="l37.555"> }</span>
<a href="#l37.556"></a><span id="l37.556" class="difflineat">@@ -1802,37 +1805,37 @@ int32_t nsPop3Protocol::ProcessAuth()</span>
<a href="#l37.557"></a><span id="l37.557"> /**</span>
<a href="#l37.558"></a><span id="l37.558">  * state POP3_NEXT_AUTH_STEP</span>
<a href="#l37.559"></a><span id="l37.559">  * This is called when we finished one auth step (e.g. sending username</span>
<a href="#l37.560"></a><span id="l37.560">  * or password are separate steps, similarly for AUTH LOGIN, NTLM etc.)</span>
<a href="#l37.561"></a><span id="l37.561">  * and want to proceed to the next one.</span>
<a href="#l37.562"></a><span id="l37.562">  */</span>
<a href="#l37.563"></a><span id="l37.563"> int32_t nsPop3Protocol::NextAuthStep()</span>
<a href="#l37.564"></a><span id="l37.564"> {</span>
<a href="#l37.565"></a><span id="l37.565" class="difflineminus">-    PR_LOG(POP3LOGMODULE, PR_LOG_MAX, (&quot;NextAuthStep()&quot;));</span>
<a href="#l37.566"></a><span id="l37.566" class="difflineplus">+    MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (&quot;NextAuthStep()&quot;));</span>
<a href="#l37.567"></a><span id="l37.567">     if (m_pop3ConData-&gt;command_succeeded)</span>
<a href="#l37.568"></a><span id="l37.568">     {</span>
<a href="#l37.569"></a><span id="l37.569">         if (m_password_already_sent || // (also true for GSSAPI)</span>
<a href="#l37.570"></a><span id="l37.570">             m_currentAuthMethod == POP3_HAS_AUTH_NONE)</span>
<a href="#l37.571"></a><span id="l37.571">         {</span>
<a href="#l37.572"></a><span id="l37.572" class="difflineminus">-            PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;login succeeded&quot;));</span>
<a href="#l37.573"></a><span id="l37.573" class="difflineplus">+            MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (&quot;login succeeded&quot;));</span>
<a href="#l37.574"></a><span id="l37.574">             m_nsIPop3Sink-&gt;SetUserAuthenticated(true);</span>
<a href="#l37.575"></a><span id="l37.575">             ClearFlag(POP3_PASSWORD_FAILED);</span>
<a href="#l37.576"></a><span id="l37.576">             if (m_pop3ConData-&gt;verify_logon)</span>
<a href="#l37.577"></a><span id="l37.577">               m_pop3ConData-&gt;next_state = POP3_SEND_QUIT;</span>
<a href="#l37.578"></a><span id="l37.578">             else</span>
<a href="#l37.579"></a><span id="l37.579">               m_pop3ConData-&gt;next_state = (m_pop3ConData-&gt;get_url)</span>
<a href="#l37.580"></a><span id="l37.580">                                           ? POP3_SEND_GURL : POP3_SEND_STAT;</span>
<a href="#l37.581"></a><span id="l37.581">         }</span>
<a href="#l37.582"></a><span id="l37.582">         else</span>
<a href="#l37.583"></a><span id="l37.583">             m_pop3ConData-&gt;next_state = POP3_SEND_PASSWORD;</span>
<a href="#l37.584"></a><span id="l37.584">     }</span>
<a href="#l37.585"></a><span id="l37.585">     else</span>
<a href="#l37.586"></a><span id="l37.586">     {</span>
<a href="#l37.587"></a><span id="l37.587" class="difflineminus">-        PR_LOG(POP3LOGMODULE, PR_LOG_MAX, (&quot;command did not succeed&quot;));</span>
<a href="#l37.588"></a><span id="l37.588" class="difflineplus">+        MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (&quot;command did not succeed&quot;));</span>
<a href="#l37.589"></a><span id="l37.589">         // response code received shows that login failed not because of</span>
<a href="#l37.590"></a><span id="l37.590">         // wrong credential -&gt; stop login without retry or pw dialog, only alert</span>
<a href="#l37.591"></a><span id="l37.591">         // parameter list -&gt; user</span>
<a href="#l37.592"></a><span id="l37.592">         nsCString userName;</span>
<a href="#l37.593"></a><span id="l37.593">         nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_pop3Server);</span>
<a href="#l37.594"></a><span id="l37.594">         nsresult rv = server-&gt;GetRealUsername(userName);</span>
<a href="#l37.595"></a><span id="l37.595">         NS_ENSURE_SUCCESS(rv, -1);</span>
<a href="#l37.596"></a><span id="l37.596">         NS_ConvertUTF8toUTF16 userNameUTF16(userName);</span>
<a href="#l37.597"></a><span id="l37.597" class="difflineat">@@ -1843,17 +1846,17 @@ int32_t nsPop3Protocol::NextAuthStep()</span>
<a href="#l37.598"></a><span id="l37.598">             return Error(&quot;pop3PasswordFailed&quot;, params, 1);</span>
<a href="#l37.599"></a><span id="l37.599"> </span>
<a href="#l37.600"></a><span id="l37.600">           return Error(&quot;pop3UsernameFailure&quot;);</span>
<a href="#l37.601"></a><span id="l37.601">         }</span>
<a href="#l37.602"></a><span id="l37.602">         // response code received shows that server is certain about the</span>
<a href="#l37.603"></a><span id="l37.603">         // credential was wrong -&gt; no fallback, show alert and pw dialog</span>
<a href="#l37.604"></a><span id="l37.604">         if (TestFlag(POP3_AUTH_FAILURE))</span>
<a href="#l37.605"></a><span id="l37.605">         {</span>
<a href="#l37.606"></a><span id="l37.606" class="difflineminus">-            PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG,</span>
<a href="#l37.607"></a><span id="l37.607" class="difflineplus">+            MOZ_LOG(POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l37.608"></a><span id="l37.608">                (&quot;auth failure, setting password failed&quot;));</span>
<a href="#l37.609"></a><span id="l37.609">             if (m_password_already_sent)</span>
<a href="#l37.610"></a><span id="l37.610">               Error(&quot;pop3PasswordFailed&quot;, params, 1);</span>
<a href="#l37.611"></a><span id="l37.611">             else</span>
<a href="#l37.612"></a><span id="l37.612">               Error(&quot;pop3UsernameFailure&quot;);</span>
<a href="#l37.613"></a><span id="l37.613">             SetFlag(POP3_PASSWORD_FAILED);</span>
<a href="#l37.614"></a><span id="l37.614">             ClearFlag(POP3_AUTH_FAILURE);</span>
<a href="#l37.615"></a><span id="l37.615">             return 0;</span>
<a href="#l37.616"></a><span id="l37.616" class="difflineat">@@ -1861,42 +1864,42 @@ int32_t nsPop3Protocol::NextAuthStep()</span>
<a href="#l37.617"></a><span id="l37.617"> </span>
<a href="#l37.618"></a><span id="l37.618">         // We have no certain response code -&gt; fallback and try again.</span>
<a href="#l37.619"></a><span id="l37.619">         // Mark the auth method failed, to use a different method next round.</span>
<a href="#l37.620"></a><span id="l37.620">         MarkAuthMethodAsFailed(m_currentAuthMethod);</span>
<a href="#l37.621"></a><span id="l37.621"> </span>
<a href="#l37.622"></a><span id="l37.622">         if (m_currentAuthMethod == POP3_HAS_AUTH_USER &amp;&amp;</span>
<a href="#l37.623"></a><span id="l37.623">             !m_password_already_sent)</span>
<a href="#l37.624"></a><span id="l37.624">         {</span>
<a href="#l37.625"></a><span id="l37.625" class="difflineminus">-            PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;USER username failed&quot;));</span>
<a href="#l37.626"></a><span id="l37.626" class="difflineplus">+            MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (&quot;USER username failed&quot;));</span>
<a href="#l37.627"></a><span id="l37.627">             // if USER auth method failed before sending the password,</span>
<a href="#l37.628"></a><span id="l37.628">             // the username was wrong.</span>
<a href="#l37.629"></a><span id="l37.629">             // no fallback but return error</span>
<a href="#l37.630"></a><span id="l37.630">             return Error(&quot;pop3UsernameFailure&quot;);</span>
<a href="#l37.631"></a><span id="l37.631">         }</span>
<a href="#l37.632"></a><span id="l37.632"> </span>
<a href="#l37.633"></a><span id="l37.633">         // If we have no auth method left, ask user to try with new password</span>
<a href="#l37.634"></a><span id="l37.634">         rv = ChooseAuthMethod();</span>
<a href="#l37.635"></a><span id="l37.635">         if (NS_FAILED(rv))</span>
<a href="#l37.636"></a><span id="l37.636">         {</span>
<a href="#l37.637"></a><span id="l37.637" class="difflineminus">-            PR_LOG(POP3LOGMODULE, PR_LOG_ERROR,</span>
<a href="#l37.638"></a><span id="l37.638" class="difflineplus">+            MOZ_LOG(POP3LOGMODULE, LogLevel::Error,</span>
<a href="#l37.639"></a><span id="l37.639">                 (&quot;POP: no auth methods remaining, setting password failure&quot;));</span>
<a href="#l37.640"></a><span id="l37.640">             /* Sever the connection and go back to the `read password' state,</span>
<a href="#l37.641"></a><span id="l37.641">                which, upon success, will re-open the connection.  Set a flag</span>
<a href="#l37.642"></a><span id="l37.642">                which causes the prompt to be different that time (to indicate</span>
<a href="#l37.643"></a><span id="l37.643">                that the old password was bogus.)</span>
<a href="#l37.644"></a><span id="l37.644"> </span>
<a href="#l37.645"></a><span id="l37.645">                But if we're just checking for new mail (biff) then don't bother</span>
<a href="#l37.646"></a><span id="l37.646">                prompting the user for a password: just fail silently.</span>
<a href="#l37.647"></a><span id="l37.647">             */</span>
<a href="#l37.648"></a><span id="l37.648">             SetFlag(POP3_PASSWORD_FAILED);</span>
<a href="#l37.649"></a><span id="l37.649">             Error(&quot;pop3PasswordFailed&quot;, params, 1);</span>
<a href="#l37.650"></a><span id="l37.650">             return 0;</span>
<a href="#l37.651"></a><span id="l37.651">         }</span>
<a href="#l37.652"></a><span id="l37.652" class="difflineminus">-        PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG,</span>
<a href="#l37.653"></a><span id="l37.653" class="difflineplus">+        MOZ_LOG(POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l37.654"></a><span id="l37.654">            (&quot;still have some auth methods to try&quot;));</span>
<a href="#l37.655"></a><span id="l37.655"> </span>
<a href="#l37.656"></a><span id="l37.656">         // TODO needed?</span>
<a href="#l37.657"></a><span id="l37.657">         //m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l37.658"></a><span id="l37.658"> </span>
<a href="#l37.659"></a><span id="l37.659">         m_pop3ConData-&gt;command_succeeded = true;</span>
<a href="#l37.660"></a><span id="l37.660"> </span>
<a href="#l37.661"></a><span id="l37.661">         m_pop3ConData-&gt;next_state = POP3_PROCESS_AUTH;</span>
<a href="#l37.662"></a><span id="l37.662" class="difflineat">@@ -1973,17 +1976,17 @@ int32_t nsPop3Protocol::AuthNtlmResponse</span>
<a href="#l37.663"></a><span id="l37.663"> </span>
<a href="#l37.664"></a><span id="l37.664">     m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l37.665"></a><span id="l37.665"> </span>
<a href="#l37.666"></a><span id="l37.666">     return 0;</span>
<a href="#l37.667"></a><span id="l37.667"> }</span>
<a href="#l37.668"></a><span id="l37.668"> </span>
<a href="#l37.669"></a><span id="l37.669"> int32_t nsPop3Protocol::AuthGSSAPI()</span>
<a href="#l37.670"></a><span id="l37.670"> {</span>
<a href="#l37.671"></a><span id="l37.671" class="difflineminus">-    PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;AuthGSSAPI()&quot;));</span>
<a href="#l37.672"></a><span id="l37.672" class="difflineplus">+    MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (&quot;AuthGSSAPI()&quot;));</span>
<a href="#l37.673"></a><span id="l37.673">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_pop3Server);</span>
<a href="#l37.674"></a><span id="l37.674">     if (server) {</span>
<a href="#l37.675"></a><span id="l37.675">         nsAutoCString cmd;</span>
<a href="#l37.676"></a><span id="l37.676">         nsAutoCString service(&quot;pop@&quot;);</span>
<a href="#l37.677"></a><span id="l37.677">         nsCString hostName;</span>
<a href="#l37.678"></a><span id="l37.678">         nsresult rv;</span>
<a href="#l37.679"></a><span id="l37.679">         server-&gt;GetRealHostName(hostName);</span>
<a href="#l37.680"></a><span id="l37.680">         service.Append(hostName);</span>
<a href="#l37.681"></a><span id="l37.681" class="difflineat">@@ -2021,34 +2024,34 @@ int32_t nsPop3Protocol::AuthGSSAPIRespon</span>
<a href="#l37.682"></a><span id="l37.682"> </span>
<a href="#l37.683"></a><span id="l37.683">     if (first) {</span>
<a href="#l37.684"></a><span id="l37.684">         m_GSSAPICache += CRLF;</span>
<a href="#l37.685"></a><span id="l37.685">         result = Pop3SendData(m_GSSAPICache.get());</span>
<a href="#l37.686"></a><span id="l37.686">         m_GSSAPICache.Truncate();</span>
<a href="#l37.687"></a><span id="l37.687">     }</span>
<a href="#l37.688"></a><span id="l37.688">     else {</span>
<a href="#l37.689"></a><span id="l37.689">         nsAutoCString cmd;</span>
<a href="#l37.690"></a><span id="l37.690" class="difflineminus">-        PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;GSSAPI step 2&quot;));</span>
<a href="#l37.691"></a><span id="l37.691" class="difflineplus">+        MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (&quot;GSSAPI step 2&quot;));</span>
<a href="#l37.692"></a><span id="l37.692">         nsresult rv = DoGSSAPIStep2(m_commandResponse, cmd);</span>
<a href="#l37.693"></a><span id="l37.693">         if (NS_FAILED(rv))</span>
<a href="#l37.694"></a><span id="l37.694">             cmd = &quot;*&quot;;</span>
<a href="#l37.695"></a><span id="l37.695">         if (rv == NS_SUCCESS_AUTH_FINISHED) {</span>
<a href="#l37.696"></a><span id="l37.696">             m_pop3ConData-&gt;next_state_after_response = POP3_NEXT_AUTH_STEP;</span>
<a href="#l37.697"></a><span id="l37.697">             m_password_already_sent = true;</span>
<a href="#l37.698"></a><span id="l37.698">         }</span>
<a href="#l37.699"></a><span id="l37.699">         cmd += CRLF;</span>
<a href="#l37.700"></a><span id="l37.700">         result = Pop3SendData(cmd.get());</span>
<a href="#l37.701"></a><span id="l37.701">     }</span>
<a href="#l37.702"></a><span id="l37.702"> </span>
<a href="#l37.703"></a><span id="l37.703">     return result;</span>
<a href="#l37.704"></a><span id="l37.704"> }</span>
<a href="#l37.705"></a><span id="l37.705"> </span>
<a href="#l37.706"></a><span id="l37.706"> int32_t nsPop3Protocol::SendUsername()</span>
<a href="#l37.707"></a><span id="l37.707"> {</span>
<a href="#l37.708"></a><span id="l37.708" class="difflineminus">-    PR_LOG(POP3LOGMODULE, PR_LOG_MAX, (&quot;SendUsername()&quot;));</span>
<a href="#l37.709"></a><span id="l37.709" class="difflineplus">+    MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (&quot;SendUsername()&quot;));</span>
<a href="#l37.710"></a><span id="l37.710">     if(m_username.IsEmpty())</span>
<a href="#l37.711"></a><span id="l37.711">       return Error(&quot;pop3UsernameUndefined&quot;);</span>
<a href="#l37.712"></a><span id="l37.712"> </span>
<a href="#l37.713"></a><span id="l37.713">     // &lt;copied from=&quot;SendPassword()&quot;&gt;</span>
<a href="#l37.714"></a><span id="l37.714">     // Needed for NTLM</span>
<a href="#l37.715"></a><span id="l37.715"> </span>
<a href="#l37.716"></a><span id="l37.716">     // The POP3_SEND_PASSWORD/POP3_WAIT_SEND_PASSWORD states have already</span>
<a href="#l37.717"></a><span id="l37.717">     // got the password - they will have cancelled if necessary.</span>
<a href="#l37.718"></a><span id="l37.718" class="difflineat">@@ -2071,40 +2074,40 @@ int32_t nsPop3Protocol::SendUsername()</span>
<a href="#l37.719"></a><span id="l37.719">     else if (m_currentAuthMethod == POP3_HAS_AUTH_LOGIN)</span>
<a href="#l37.720"></a><span id="l37.720">     {</span>
<a href="#l37.721"></a><span id="l37.721">         char *base64Str = PL_Base64Encode(m_username.get(), m_username.Length(), nullptr);</span>
<a href="#l37.722"></a><span id="l37.722">         cmd = base64Str;</span>
<a href="#l37.723"></a><span id="l37.723">         PR_Free(base64Str);</span>
<a href="#l37.724"></a><span id="l37.724">     }</span>
<a href="#l37.725"></a><span id="l37.725">     else if (m_currentAuthMethod == POP3_HAS_AUTH_USER)</span>
<a href="#l37.726"></a><span id="l37.726">     {</span>
<a href="#l37.727"></a><span id="l37.727" class="difflineminus">-        PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;USER login&quot;));</span>
<a href="#l37.728"></a><span id="l37.728" class="difflineplus">+        MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (&quot;USER login&quot;));</span>
<a href="#l37.729"></a><span id="l37.729">         cmd = &quot;USER &quot;;</span>
<a href="#l37.730"></a><span id="l37.730">         cmd += m_username;</span>
<a href="#l37.731"></a><span id="l37.731">     }</span>
<a href="#l37.732"></a><span id="l37.732">     else</span>
<a href="#l37.733"></a><span id="l37.733">     {</span>
<a href="#l37.734"></a><span id="l37.734" class="difflineminus">-      PR_LOG(POP3LOGMODULE, PR_LOG_ERROR,</span>
<a href="#l37.735"></a><span id="l37.735" class="difflineplus">+      MOZ_LOG(POP3LOGMODULE, LogLevel::Error,</span>
<a href="#l37.736"></a><span id="l37.736">           (&quot;In nsPop3Protocol::SendUsername(), m_currentAuthMethod is 0x%X, &quot;</span>
<a href="#l37.737"></a><span id="l37.737">           &quot;but that is unexpected&quot;, m_currentAuthMethod));</span>
<a href="#l37.738"></a><span id="l37.738">       return Error(&quot;pop3AuthInternalError&quot;);</span>
<a href="#l37.739"></a><span id="l37.739">     }</span>
<a href="#l37.740"></a><span id="l37.740"> </span>
<a href="#l37.741"></a><span id="l37.741">     cmd += CRLF;</span>
<a href="#l37.742"></a><span id="l37.742"> </span>
<a href="#l37.743"></a><span id="l37.743">     m_pop3ConData-&gt;next_state_after_response = POP3_NEXT_AUTH_STEP;</span>
<a href="#l37.744"></a><span id="l37.744"> </span>
<a href="#l37.745"></a><span id="l37.745">     m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l37.746"></a><span id="l37.746"> </span>
<a href="#l37.747"></a><span id="l37.747">     return Pop3SendData(cmd.get());</span>
<a href="#l37.748"></a><span id="l37.748"> }</span>
<a href="#l37.749"></a><span id="l37.749"> </span>
<a href="#l37.750"></a><span id="l37.750"> int32_t nsPop3Protocol::SendPassword()</span>
<a href="#l37.751"></a><span id="l37.751"> {</span>
<a href="#l37.752"></a><span id="l37.752" class="difflineminus">-  PR_LOG(POP3LOGMODULE, PR_LOG_MAX, (&quot;SendPassword()&quot;));</span>
<a href="#l37.753"></a><span id="l37.753" class="difflineplus">+  MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (&quot;SendPassword()&quot;));</span>
<a href="#l37.754"></a><span id="l37.754">   if (m_username.IsEmpty())</span>
<a href="#l37.755"></a><span id="l37.755">     return Error(&quot;pop3UsernameUndefined&quot;);</span>
<a href="#l37.756"></a><span id="l37.756"> </span>
<a href="#l37.757"></a><span id="l37.757">   // &lt;copied to=&quot;SendUsername()&quot;&gt;</span>
<a href="#l37.758"></a><span id="l37.758">   // Needed here, too, because APOP skips SendUsername()</span>
<a href="#l37.759"></a><span id="l37.759">   // The POP3_SEND_PASSWORD/POP3_WAIT_SEND_PASSWORD states have already</span>
<a href="#l37.760"></a><span id="l37.760">   // got the password - they will have cancelled if necessary.</span>
<a href="#l37.761"></a><span id="l37.761">   // If the password is still empty here, don't try to go on.</span>
<a href="#l37.762"></a><span id="l37.762" class="difflineat">@@ -2117,17 +2120,17 @@ int32_t nsPop3Protocol::SendPassword()</span>
<a href="#l37.763"></a><span id="l37.763"> </span>
<a href="#l37.764"></a><span id="l37.764">   nsAutoCString cmd;</span>
<a href="#l37.765"></a><span id="l37.765">   nsresult rv;</span>
<a href="#l37.766"></a><span id="l37.766"> </span>
<a href="#l37.767"></a><span id="l37.767">   if (m_currentAuthMethod == POP3_HAS_AUTH_NTLM)</span>
<a href="#l37.768"></a><span id="l37.768">     rv = DoNtlmStep2(m_commandResponse, cmd);</span>
<a href="#l37.769"></a><span id="l37.769">   else if (m_currentAuthMethod == POP3_HAS_AUTH_CRAM_MD5)</span>
<a href="#l37.770"></a><span id="l37.770">   {</span>
<a href="#l37.771"></a><span id="l37.771" class="difflineminus">-    PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;CRAM login&quot;));</span>
<a href="#l37.772"></a><span id="l37.772" class="difflineplus">+    MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (&quot;CRAM login&quot;));</span>
<a href="#l37.773"></a><span id="l37.773">     char buffer[512]; // TODO nsAutoCString</span>
<a href="#l37.774"></a><span id="l37.774">     unsigned char digest[DIGEST_LENGTH];</span>
<a href="#l37.775"></a><span id="l37.775"> </span>
<a href="#l37.776"></a><span id="l37.776">     char *decodedChallenge = PL_Base64Decode(m_commandResponse.get(),</span>
<a href="#l37.777"></a><span id="l37.777">     m_commandResponse.Length(), nullptr);</span>
<a href="#l37.778"></a><span id="l37.778"> </span>
<a href="#l37.779"></a><span id="l37.779">     if (decodedChallenge)</span>
<a href="#l37.780"></a><span id="l37.780">       rv = MSGCramMD5(decodedChallenge, strlen(decodedChallenge),</span>
<a href="#l37.781"></a><span id="l37.781" class="difflineat">@@ -2153,17 +2156,17 @@ int32_t nsPop3Protocol::SendPassword()</span>
<a href="#l37.782"></a><span id="l37.782">       PR_Free(base64Str);</span>
<a href="#l37.783"></a><span id="l37.783">     }</span>
<a href="#l37.784"></a><span id="l37.784"> </span>
<a href="#l37.785"></a><span id="l37.785">     if (NS_FAILED(rv))</span>
<a href="#l37.786"></a><span id="l37.786">       cmd = &quot;*&quot;;</span>
<a href="#l37.787"></a><span id="l37.787">   }</span>
<a href="#l37.788"></a><span id="l37.788">   else if (m_currentAuthMethod == POP3_HAS_AUTH_APOP)</span>
<a href="#l37.789"></a><span id="l37.789">   {</span>
<a href="#l37.790"></a><span id="l37.790" class="difflineminus">-    PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;APOP login&quot;));</span>
<a href="#l37.791"></a><span id="l37.791" class="difflineplus">+    MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (&quot;APOP login&quot;));</span>
<a href="#l37.792"></a><span id="l37.792">     char buffer[512];</span>
<a href="#l37.793"></a><span id="l37.793">     unsigned char digest[DIGEST_LENGTH];</span>
<a href="#l37.794"></a><span id="l37.794"> </span>
<a href="#l37.795"></a><span id="l37.795">     rv = MSGApopMD5(m_ApopTimestamp.get(), m_ApopTimestamp.Length(),</span>
<a href="#l37.796"></a><span id="l37.796">                     m_passwordResult.get(), m_passwordResult.Length(), digest);</span>
<a href="#l37.797"></a><span id="l37.797"> </span>
<a href="#l37.798"></a><span id="l37.798">     if (NS_SUCCEEDED(rv))</span>
<a href="#l37.799"></a><span id="l37.799">     {</span>
<a href="#l37.800"></a><span id="l37.800" class="difflineat">@@ -2181,17 +2184,17 @@ int32_t nsPop3Protocol::SendPassword()</span>
<a href="#l37.801"></a><span id="l37.801">       cmd = buffer;</span>
<a href="#l37.802"></a><span id="l37.802">     }</span>
<a href="#l37.803"></a><span id="l37.803"> </span>
<a href="#l37.804"></a><span id="l37.804">     if (NS_FAILED(rv))</span>
<a href="#l37.805"></a><span id="l37.805">       cmd = &quot;*&quot;;</span>
<a href="#l37.806"></a><span id="l37.806">   }</span>
<a href="#l37.807"></a><span id="l37.807">   else if (m_currentAuthMethod == POP3_HAS_AUTH_PLAIN)</span>
<a href="#l37.808"></a><span id="l37.808">   {</span>
<a href="#l37.809"></a><span id="l37.809" class="difflineminus">-    PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;PLAIN login&quot;));</span>
<a href="#l37.810"></a><span id="l37.810" class="difflineplus">+    MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (&quot;PLAIN login&quot;));</span>
<a href="#l37.811"></a><span id="l37.811">     // workaround for IPswitch's IMail server software</span>
<a href="#l37.812"></a><span id="l37.812">     // this server goes into LOGIN mode even if we send &quot;AUTH PLAIN&quot;</span>
<a href="#l37.813"></a><span id="l37.813">     // &quot;VXNlc&quot; is the beginning of the base64 encoded prompt (&quot;Username:&quot;) for LOGIN</span>
<a href="#l37.814"></a><span id="l37.814">     if (StringBeginsWith(m_commandResponse, NS_LITERAL_CSTRING(&quot;VXNlc&quot;)))</span>
<a href="#l37.815"></a><span id="l37.815">     {</span>
<a href="#l37.816"></a><span id="l37.816">       // disable PLAIN and enable LOGIN (in case it's not already enabled)</span>
<a href="#l37.817"></a><span id="l37.817">       ClearCapFlag(POP3_HAS_AUTH_PLAIN);</span>
<a href="#l37.818"></a><span id="l37.818">       SetCapFlag(POP3_HAS_AUTH_LOGIN);</span>
<a href="#l37.819"></a><span id="l37.819" class="difflineat">@@ -2213,32 +2216,32 @@ int32_t nsPop3Protocol::SendPassword()</span>
<a href="#l37.820"></a><span id="l37.820">     len += m_passwordResult.Length();</span>
<a href="#l37.821"></a><span id="l37.821"> </span>
<a href="#l37.822"></a><span id="l37.822">     char *base64Str = PL_Base64Encode(plain_string, len, nullptr);</span>
<a href="#l37.823"></a><span id="l37.823">     cmd = base64Str;</span>
<a href="#l37.824"></a><span id="l37.824">     PR_Free(base64Str);</span>
<a href="#l37.825"></a><span id="l37.825">   }</span>
<a href="#l37.826"></a><span id="l37.826">   else if (m_currentAuthMethod == POP3_HAS_AUTH_LOGIN)</span>
<a href="#l37.827"></a><span id="l37.827">   {</span>
<a href="#l37.828"></a><span id="l37.828" class="difflineminus">-    PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;LOGIN password&quot;));</span>
<a href="#l37.829"></a><span id="l37.829" class="difflineplus">+    MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (&quot;LOGIN password&quot;));</span>
<a href="#l37.830"></a><span id="l37.830">     char * base64Str =</span>
<a href="#l37.831"></a><span id="l37.831">         PL_Base64Encode(m_passwordResult.get(), m_passwordResult.Length(),</span>
<a href="#l37.832"></a><span id="l37.832">                         nullptr);</span>
<a href="#l37.833"></a><span id="l37.833">     cmd = base64Str;</span>
<a href="#l37.834"></a><span id="l37.834">     PR_Free(base64Str);</span>
<a href="#l37.835"></a><span id="l37.835">   }</span>
<a href="#l37.836"></a><span id="l37.836">   else if (m_currentAuthMethod == POP3_HAS_AUTH_USER)</span>
<a href="#l37.837"></a><span id="l37.837">   {</span>
<a href="#l37.838"></a><span id="l37.838" class="difflineminus">-    PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;PASS password&quot;));</span>
<a href="#l37.839"></a><span id="l37.839" class="difflineplus">+    MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (&quot;PASS password&quot;));</span>
<a href="#l37.840"></a><span id="l37.840">     cmd = &quot;PASS &quot;;</span>
<a href="#l37.841"></a><span id="l37.841">     cmd += m_passwordResult;</span>
<a href="#l37.842"></a><span id="l37.842">   }</span>
<a href="#l37.843"></a><span id="l37.843">   else</span>
<a href="#l37.844"></a><span id="l37.844">   {</span>
<a href="#l37.845"></a><span id="l37.845" class="difflineminus">-    PR_LOG(POP3LOGMODULE, PR_LOG_ERROR,</span>
<a href="#l37.846"></a><span id="l37.846" class="difflineplus">+    MOZ_LOG(POP3LOGMODULE, LogLevel::Error,</span>
<a href="#l37.847"></a><span id="l37.847">         (&quot;In nsPop3Protocol::SendPassword(), m_currentAuthMethod is %X, &quot;</span>
<a href="#l37.848"></a><span id="l37.848">         &quot;but that is unexpected&quot;, m_currentAuthMethod));</span>
<a href="#l37.849"></a><span id="l37.849">     return Error(&quot;pop3AuthInternalError&quot;);</span>
<a href="#l37.850"></a><span id="l37.850">   }</span>
<a href="#l37.851"></a><span id="l37.851"> </span>
<a href="#l37.852"></a><span id="l37.852">   cmd += CRLF;</span>
<a href="#l37.853"></a><span id="l37.853"> </span>
<a href="#l37.854"></a><span id="l37.854">   // TODO needed?</span>
<a href="#l37.855"></a><span id="l37.855" class="difflineat">@@ -2454,17 +2457,17 @@ nsPop3Protocol::GetList(nsIInputStream* </span>
<a href="#l37.856"></a><span id="l37.856"> </span>
<a href="#l37.857"></a><span id="l37.857">   if (pauseForMoreData || !line)</span>
<a href="#l37.858"></a><span id="l37.858">   {</span>
<a href="#l37.859"></a><span id="l37.859">     m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l37.860"></a><span id="l37.860">     PR_Free(line);</span>
<a href="#l37.861"></a><span id="l37.861">     return(ln);</span>
<a href="#l37.862"></a><span id="l37.862">   }</span>
<a href="#l37.863"></a><span id="l37.863"> </span>
<a href="#l37.864"></a><span id="l37.864" class="difflineminus">-  PR_LOG(POP3LOGMODULE, PR_LOG_ALWAYS,(&quot;RECV: %s&quot;, line));</span>
<a href="#l37.865"></a><span id="l37.865" class="difflineplus">+  MOZ_LOG(POP3LOGMODULE, LogLevel::Info,(&quot;RECV: %s&quot;, line));</span>
<a href="#l37.866"></a><span id="l37.866"> </span>
<a href="#l37.867"></a><span id="l37.867">   /* parse the line returned from the list command</span>
<a href="#l37.868"></a><span id="l37.868">   * it looks like</span>
<a href="#l37.869"></a><span id="l37.869">   * #msg_number #bytes</span>
<a href="#l37.870"></a><span id="l37.870">   *</span>
<a href="#l37.871"></a><span id="l37.871">   * list data is terminated by a &quot;.CRLF&quot; line</span>
<a href="#l37.872"></a><span id="l37.872">   */</span>
<a href="#l37.873"></a><span id="l37.873">   if (!PL_strcmp(line, &quot;.&quot;))</span>
<a href="#l37.874"></a><span id="l37.874" class="difflineat">@@ -2624,17 +2627,17 @@ nsPop3Protocol::GetXtndXlstMsgid(nsIInpu</span>
<a href="#l37.875"></a><span id="l37.875"> </span>
<a href="#l37.876"></a><span id="l37.876">   if (pauseForMoreData || !line)</span>
<a href="#l37.877"></a><span id="l37.877">   {</span>
<a href="#l37.878"></a><span id="l37.878">     m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l37.879"></a><span id="l37.879">     PR_Free(line);</span>
<a href="#l37.880"></a><span id="l37.880">     return ln;</span>
<a href="#l37.881"></a><span id="l37.881">   }</span>
<a href="#l37.882"></a><span id="l37.882"> </span>
<a href="#l37.883"></a><span id="l37.883" class="difflineminus">-  PR_LOG(POP3LOGMODULE, PR_LOG_ALWAYS,(&quot;RECV: %s&quot;, line));</span>
<a href="#l37.884"></a><span id="l37.884" class="difflineplus">+  MOZ_LOG(POP3LOGMODULE, LogLevel::Info,(&quot;RECV: %s&quot;, line));</span>
<a href="#l37.885"></a><span id="l37.885"> </span>
<a href="#l37.886"></a><span id="l37.886">   /* parse the line returned from the list command</span>
<a href="#l37.887"></a><span id="l37.887">   * it looks like</span>
<a href="#l37.888"></a><span id="l37.888">   * 1 Message-ID: &lt;3117E4DC.2699@example.com&gt;</span>
<a href="#l37.889"></a><span id="l37.889">   *</span>
<a href="#l37.890"></a><span id="l37.890">   * list data is terminated by a &quot;.CRLF&quot; line</span>
<a href="#l37.891"></a><span id="l37.891">   */</span>
<a href="#l37.892"></a><span id="l37.892">   if (!PL_strcmp(line, &quot;.&quot;))</span>
<a href="#l37.893"></a><span id="l37.893" class="difflineat">@@ -2740,17 +2743,17 @@ int32_t nsPop3Protocol::GetUidlList(nsII</span>
<a href="#l37.894"></a><span id="l37.894"> </span>
<a href="#l37.895"></a><span id="l37.895">     if (pauseForMoreData || !line)</span>
<a href="#l37.896"></a><span id="l37.896">     {</span>
<a href="#l37.897"></a><span id="l37.897">       PR_Free(line);</span>
<a href="#l37.898"></a><span id="l37.898">       m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l37.899"></a><span id="l37.899">       return ln;</span>
<a href="#l37.900"></a><span id="l37.900">     }</span>
<a href="#l37.901"></a><span id="l37.901"> </span>
<a href="#l37.902"></a><span id="l37.902" class="difflineminus">-    PR_LOG(POP3LOGMODULE, PR_LOG_ALWAYS,(&quot;RECV: %s&quot;, line));</span>
<a href="#l37.903"></a><span id="l37.903" class="difflineplus">+    MOZ_LOG(POP3LOGMODULE, LogLevel::Info,(&quot;RECV: %s&quot;, line));</span>
<a href="#l37.904"></a><span id="l37.904"> </span>
<a href="#l37.905"></a><span id="l37.905">     /* parse the line returned from the list command</span>
<a href="#l37.906"></a><span id="l37.906">      * it looks like</span>
<a href="#l37.907"></a><span id="l37.907">      * #msg_number uidl</span>
<a href="#l37.908"></a><span id="l37.908">      *</span>
<a href="#l37.909"></a><span id="l37.909">      * list data is terminated by a &quot;.CRLF&quot; line</span>
<a href="#l37.910"></a><span id="l37.910">      */</span>
<a href="#l37.911"></a><span id="l37.911">     if (!PL_strcmp(line, &quot;.&quot;))</span>
<a href="#l37.912"></a><span id="l37.912" class="difflineat">@@ -3235,38 +3238,38 @@ nsPop3Protocol::RetrResponse(nsIInputStr</span>
<a href="#l37.913"></a><span id="l37.913">             uidl = m_pop3ConData-&gt;msg_info[m_pop3ConData-&gt;last_accessed_msg].uidl;</span>
<a href="#l37.914"></a><span id="l37.914"> </span>
<a href="#l37.915"></a><span id="l37.915">         m_pop3ConData-&gt;parsed_bytes = 0;</span>
<a href="#l37.916"></a><span id="l37.916">         m_pop3ConData-&gt;pop3_size = m_pop3ConData-&gt;cur_msg_size;</span>
<a href="#l37.917"></a><span id="l37.917">         m_pop3ConData-&gt;assumed_end = false;</span>
<a href="#l37.918"></a><span id="l37.918"> </span>
<a href="#l37.919"></a><span id="l37.919">         m_pop3Server-&gt;GetDotFix(&amp;m_pop3ConData-&gt;dot_fix);</span>
<a href="#l37.920"></a><span id="l37.920"> </span>
<a href="#l37.921"></a><span id="l37.921" class="difflineminus">-        PR_LOG(POP3LOGMODULE,PR_LOG_ALWAYS,</span>
<a href="#l37.922"></a><span id="l37.922" class="difflineplus">+        MOZ_LOG(POP3LOGMODULE,LogLevel::Info,</span>
<a href="#l37.923"></a><span id="l37.923">                (&quot;Opening message stream: MSG_IncorporateBegin&quot;));</span>
<a href="#l37.924"></a><span id="l37.924"> </span>
<a href="#l37.925"></a><span id="l37.925">         /* open the message stream so we have someplace</span>
<a href="#l37.926"></a><span id="l37.926">          * to put the data</span>
<a href="#l37.927"></a><span id="l37.927">          */</span>
<a href="#l37.928"></a><span id="l37.928">         m_pop3ConData-&gt;real_new_counter++;</span>
<a href="#l37.929"></a><span id="l37.929">         /* (rb) count only real messages being downloaded */</span>
<a href="#l37.930"></a><span id="l37.930">         rv = m_nsIPop3Sink-&gt;IncorporateBegin(uidl, m_url, flags,</span>
<a href="#l37.931"></a><span id="l37.931">                                         &amp;m_pop3ConData-&gt;msg_closure);</span>
<a href="#l37.932"></a><span id="l37.932"> </span>
<a href="#l37.933"></a><span id="l37.933" class="difflineminus">-        PR_LOG(POP3LOGMODULE, PR_LOG_ALWAYS, (&quot;Done opening message stream!&quot;));</span>
<a href="#l37.934"></a><span id="l37.934" class="difflineplus">+        MOZ_LOG(POP3LOGMODULE, LogLevel::Info, (&quot;Done opening message stream!&quot;));</span>
<a href="#l37.935"></a><span id="l37.935"> </span>
<a href="#l37.936"></a><span id="l37.936">         if(!m_pop3ConData-&gt;msg_closure || NS_FAILED(rv))</span>
<a href="#l37.937"></a><span id="l37.937">             return Error(&quot;pop3MessageWriteError&quot;);</span>
<a href="#l37.938"></a><span id="l37.938">     }</span>
<a href="#l37.939"></a><span id="l37.939"> </span>
<a href="#l37.940"></a><span id="l37.940">     m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l37.941"></a><span id="l37.941"> </span>
<a href="#l37.942"></a><span id="l37.942">     bool pauseForMoreData = false;</span>
<a href="#l37.943"></a><span id="l37.943">     char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData, &amp;rv, true);</span>
<a href="#l37.944"></a><span id="l37.944" class="difflineminus">-    PR_LOG(POP3LOGMODULE, PR_LOG_ALWAYS,(&quot;RECV: %s&quot;, line));</span>
<a href="#l37.945"></a><span id="l37.945" class="difflineplus">+    MOZ_LOG(POP3LOGMODULE, LogLevel::Info,(&quot;RECV: %s&quot;, line));</span>
<a href="#l37.946"></a><span id="l37.946">     if (NS_FAILED(rv))</span>
<a href="#l37.947"></a><span id="l37.947">       return -1;</span>
<a href="#l37.948"></a><span id="l37.948"> </span>
<a href="#l37.949"></a><span id="l37.949">     buffer_size = status;</span>
<a href="#l37.950"></a><span id="l37.950"> </span>
<a href="#l37.951"></a><span id="l37.951">     if (status == 0 &amp;&amp; !line)  // no bytes read in...</span>
<a href="#l37.952"></a><span id="l37.952">       return (0);</span>
<a href="#l37.953"></a><span id="l37.953"> </span>
<a href="#l37.954"></a><span id="l37.954" class="difflineat">@@ -3291,17 +3294,17 @@ nsPop3Protocol::RetrResponse(nsIInputStr</span>
<a href="#l37.955"></a><span id="l37.955"> </span>
<a href="#l37.956"></a><span id="l37.956">         // now read in the next line</span>
<a href="#l37.957"></a><span id="l37.957">         PR_Free(line);</span>
<a href="#l37.958"></a><span id="l37.958">         line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, buffer_size,</span>
<a href="#l37.959"></a><span id="l37.959">                                                 pauseForMoreData, &amp;rv, true);</span>
<a href="#l37.960"></a><span id="l37.960">         if (NS_FAILED(rv))</span>
<a href="#l37.961"></a><span id="l37.961">           return -1;</span>
<a href="#l37.962"></a><span id="l37.962"> </span>
<a href="#l37.963"></a><span id="l37.963" class="difflineminus">-        PR_LOG(POP3LOGMODULE, PR_LOG_ALWAYS,(&quot;RECV: %s&quot;, line));</span>
<a href="#l37.964"></a><span id="l37.964" class="difflineplus">+        MOZ_LOG(POP3LOGMODULE, LogLevel::Info,(&quot;RECV: %s&quot;, line));</span>
<a href="#l37.965"></a><span id="l37.965">         // buffer_size already includes MSG_LINEBREAK_LEN so</span>
<a href="#l37.966"></a><span id="l37.966">         // subtract and add CRLF</span>
<a href="#l37.967"></a><span id="l37.967">         // but not really sure we always had CRLF in input since</span>
<a href="#l37.968"></a><span id="l37.968">         // we also treat a single LF as line ending!</span>
<a href="#l37.969"></a><span id="l37.969">         status += buffer_size - MSG_LINEBREAK_LEN + 2;</span>
<a href="#l37.970"></a><span id="l37.970">       } while (line);</span>
<a href="#l37.971"></a><span id="l37.971">     }</span>
<a href="#l37.972"></a><span id="l37.972"> </span>
<a href="#l37.973"></a><span id="l37.973" class="difflineat">@@ -3658,31 +3661,31 @@ nsPop3Protocol::CommitState(bool remove_</span>
<a href="#l37.974"></a><span id="l37.974">  */</span>
<a href="#l37.975"></a><span id="l37.975"> nsresult nsPop3Protocol::ProcessProtocolState(nsIURI * url, nsIInputStream * aInputStream,</span>
<a href="#l37.976"></a><span id="l37.976">                                               uint64_t sourceOffset, uint32_t aLength)</span>
<a href="#l37.977"></a><span id="l37.977"> {</span>
<a href="#l37.978"></a><span id="l37.978">   int32_t status = 0;</span>
<a href="#l37.979"></a><span id="l37.979">   bool urlStatusSet = false;</span>
<a href="#l37.980"></a><span id="l37.980">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(m_url);</span>
<a href="#l37.981"></a><span id="l37.981"> </span>
<a href="#l37.982"></a><span id="l37.982" class="difflineminus">-  PR_LOG(POP3LOGMODULE, PR_LOG_ALWAYS, (&quot;Entering NET_ProcessPop3 %d&quot;,</span>
<a href="#l37.983"></a><span id="l37.983" class="difflineplus">+  MOZ_LOG(POP3LOGMODULE, LogLevel::Info, (&quot;Entering NET_ProcessPop3 %d&quot;,</span>
<a href="#l37.984"></a><span id="l37.984">     aLength));</span>
<a href="#l37.985"></a><span id="l37.985"> </span>
<a href="#l37.986"></a><span id="l37.986">   m_pop3ConData-&gt;pause_for_read = false; /* already paused; reset */</span>
<a href="#l37.987"></a><span id="l37.987"> </span>
<a href="#l37.988"></a><span id="l37.988">   if(m_username.IsEmpty())</span>
<a href="#l37.989"></a><span id="l37.989">   {</span>
<a href="#l37.990"></a><span id="l37.990">     // net_pop3_block = false;</span>
<a href="#l37.991"></a><span id="l37.991">     Error(&quot;pop3UsernameUndefined&quot;);</span>
<a href="#l37.992"></a><span id="l37.992">     return NS_MSG_SERVER_USERNAME_MISSING;</span>
<a href="#l37.993"></a><span id="l37.993">   }</span>
<a href="#l37.994"></a><span id="l37.994"> </span>
<a href="#l37.995"></a><span id="l37.995">   while(!m_pop3ConData-&gt;pause_for_read)</span>
<a href="#l37.996"></a><span id="l37.996">   {</span>
<a href="#l37.997"></a><span id="l37.997" class="difflineminus">-    PR_LOG(POP3LOGMODULE, PR_LOG_ALWAYS,</span>
<a href="#l37.998"></a><span id="l37.998" class="difflineplus">+    MOZ_LOG(POP3LOGMODULE, LogLevel::Info,</span>
<a href="#l37.999"></a><span id="l37.999">       (&quot;POP3: Entering state: %d&quot;, m_pop3ConData-&gt;next_state));</span>
<a href="#l37.1000"></a><span id="l37.1000"> </span>
<a href="#l37.1001"></a><span id="l37.1001">     switch(m_pop3ConData-&gt;next_state)</span>
<a href="#l37.1002"></a><span id="l37.1002">     {</span>
<a href="#l37.1003"></a><span id="l37.1003">     case POP3_READ_PASSWORD:</span>
<a href="#l37.1004"></a><span id="l37.1004">       // This is a separate state so that we're waiting for the user to type</span>
<a href="#l37.1005"></a><span id="l37.1005">       // in a password while we don't actually have a connection to the pop</span>
<a href="#l37.1006"></a><span id="l37.1006">       // server open; this saves us from having to worry about the server</span>
<a href="#l37.1007"></a><span id="l37.1007" class="difflineat">@@ -4020,17 +4023,17 @@ nsresult nsPop3Protocol::ProcessProtocol</span>
<a href="#l37.1008"></a><span id="l37.1008">         // no msgWindow means no re-prompt, so treat as error.</span>
<a href="#l37.1009"></a><span id="l37.1009">         if (TestFlag(POP3_PASSWORD_FAILED) &amp;&amp; msgWindow)</span>
<a href="#l37.1010"></a><span id="l37.1010">         {</span>
<a href="#l37.1011"></a><span id="l37.1011">           // We get here because the password was wrong.</span>
<a href="#l37.1012"></a><span id="l37.1012">           if (!m_socketIsOpen &amp;&amp; mailnewsurl)</span>
<a href="#l37.1013"></a><span id="l37.1013">           {</span>
<a href="#l37.1014"></a><span id="l37.1014">             // The server dropped the connection, so we're going</span>
<a href="#l37.1015"></a><span id="l37.1015">             // to re-run the url.</span>
<a href="#l37.1016"></a><span id="l37.1016" class="difflineminus">-            PR_LOG(POP3LOGMODULE, PR_LOG_MAX, (&quot;need to rerun url because connection dropped during auth&quot;));</span>
<a href="#l37.1017"></a><span id="l37.1017" class="difflineplus">+            MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (&quot;need to rerun url because connection dropped during auth&quot;));</span>
<a href="#l37.1018"></a><span id="l37.1018">             m_needToRerunUrl = true;</span>
<a href="#l37.1019"></a><span id="l37.1019">             return NS_OK;</span>
<a href="#l37.1020"></a><span id="l37.1020">           }</span>
<a href="#l37.1021"></a><span id="l37.1021">           m_pop3ConData-&gt;next_state = POP3_READ_PASSWORD;</span>
<a href="#l37.1022"></a><span id="l37.1022">           m_pop3ConData-&gt;command_succeeded = true;</span>
<a href="#l37.1023"></a><span id="l37.1023">           status = 0;</span>
<a href="#l37.1024"></a><span id="l37.1024">           break;</span>
<a href="#l37.1025"></a><span id="l37.1025">         }</span>
<a href="#l37.1026"></a><span id="l37.1026" class="difflineat">@@ -4044,20 +4047,20 @@ nsresult nsPop3Protocol::ProcessProtocol</span>
<a href="#l37.1027"></a><span id="l37.1027">       break;</span>
<a href="#l37.1028"></a><span id="l37.1028"> </span>
<a href="#l37.1029"></a><span id="l37.1029">     case POP3_FREE:</span>
<a href="#l37.1030"></a><span id="l37.1030">       {</span>
<a href="#l37.1031"></a><span id="l37.1031">         UpdateProgressPercent(0,0); // clear out the progress meter</span>
<a href="#l37.1032"></a><span id="l37.1032">         nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_pop3Server);</span>
<a href="#l37.1033"></a><span id="l37.1033">         if (server)</span>
<a href="#l37.1034"></a><span id="l37.1034">         {</span>
<a href="#l37.1035"></a><span id="l37.1035" class="difflineminus">-          PR_LOG(POP3LOGMODULE, PR_LOG_MAX, (&quot;Clearing server busy in POP3_FREE&quot;));</span>
<a href="#l37.1036"></a><span id="l37.1036" class="difflineplus">+          MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (&quot;Clearing server busy in POP3_FREE&quot;));</span>
<a href="#l37.1037"></a><span id="l37.1037">           server-&gt;SetServerBusy(false); // the server is now not busy</span>
<a href="#l37.1038"></a><span id="l37.1038">         }</span>
<a href="#l37.1039"></a><span id="l37.1039" class="difflineminus">-        PR_LOG(POP3LOGMODULE, PR_LOG_MAX, (&quot;Clearing running protocol in POP3_FREE&quot;));</span>
<a href="#l37.1040"></a><span id="l37.1040" class="difflineplus">+        MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (&quot;Clearing running protocol in POP3_FREE&quot;));</span>
<a href="#l37.1041"></a><span id="l37.1041">         CloseSocket();</span>
<a href="#l37.1042"></a><span id="l37.1042">         m_pop3Server-&gt;SetRunningProtocol(nullptr);</span>
<a href="#l37.1043"></a><span id="l37.1043">         if (mailnewsurl &amp;&amp; urlStatusSet)</span>
<a href="#l37.1044"></a><span id="l37.1044">           mailnewsurl-&gt;SetUrlState(false, m_pop3ConData-&gt;urlStatus);</span>
<a href="#l37.1045"></a><span id="l37.1045"> </span>
<a href="#l37.1046"></a><span id="l37.1046">         m_url = nullptr;</span>
<a href="#l37.1047"></a><span id="l37.1047">         return NS_OK;</span>
<a href="#l37.1048"></a><span id="l37.1048">       }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/mailnews/local/src/nsPop3Sink.cpp</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3Sink.cpp</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -55,17 +55,17 @@ nsPop3Sink::nsPop3Sink()</span>
<a href="#l38.4"></a><span id="l38.4">     m_uidlDownload = false;</span>
<a href="#l38.5"></a><span id="l38.5">     m_buildMessageUri = false;</span>
<a href="#l38.6"></a><span id="l38.6">     if (!POP3LOGMODULE)</span>
<a href="#l38.7"></a><span id="l38.7">       POP3LOGMODULE = PR_NewLogModule(&quot;POP3&quot;);</span>
<a href="#l38.8"></a><span id="l38.8"> }</span>
<a href="#l38.9"></a><span id="l38.9"> </span>
<a href="#l38.10"></a><span id="l38.10"> nsPop3Sink::~nsPop3Sink()</span>
<a href="#l38.11"></a><span id="l38.11"> {</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-    PR_LOG(POP3LOGMODULE, PR_LOG_MAX, (&quot;Calling ReleaseFolderLock from ~nsPop3Sink&quot;));</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineplus">+    MOZ_LOG(POP3LOGMODULE, mozilla::LogLevel::Debug, (&quot;Calling ReleaseFolderLock from ~nsPop3Sink&quot;));</span>
<a href="#l38.14"></a><span id="l38.14">     ReleaseFolderLock();</span>
<a href="#l38.15"></a><span id="l38.15"> }</span>
<a href="#l38.16"></a><span id="l38.16"> </span>
<a href="#l38.17"></a><span id="l38.17"> nsresult</span>
<a href="#l38.18"></a><span id="l38.18"> nsPop3Sink::SetUserAuthenticated(bool authed)</span>
<a href="#l38.19"></a><span id="l38.19"> {</span>
<a href="#l38.20"></a><span id="l38.20">   m_authed = authed;</span>
<a href="#l38.21"></a><span id="l38.21">   m_popServer-&gt;SetAuthenticated(authed);</span>
<a href="#l38.22"></a><span id="l38.22" class="difflineat">@@ -223,22 +223,22 @@ nsPop3Sink::BeginMailDelivery(bool uidlD</span>
<a href="#l38.23"></a><span id="l38.23">   if (account)</span>
<a href="#l38.24"></a><span id="l38.24">     account-&gt;GetKey(m_accountKey);</span>
<a href="#l38.25"></a><span id="l38.25"> </span>
<a href="#l38.26"></a><span id="l38.26">   bool isLocked;</span>
<a href="#l38.27"></a><span id="l38.27">   nsCOMPtr &lt;nsISupports&gt; supports = do_QueryInterface(static_cast&lt;nsIPop3Sink*&gt;(this));</span>
<a href="#l38.28"></a><span id="l38.28">   m_folder-&gt;GetLocked(&amp;isLocked);</span>
<a href="#l38.29"></a><span id="l38.29">   if(!isLocked)</span>
<a href="#l38.30"></a><span id="l38.30">   {</span>
<a href="#l38.31"></a><span id="l38.31" class="difflineminus">-    PR_LOG(POP3LOGMODULE, PR_LOG_MAX, (&quot;BeginMailDelivery acquiring semaphore&quot;));</span>
<a href="#l38.32"></a><span id="l38.32" class="difflineplus">+    MOZ_LOG(POP3LOGMODULE, mozilla::LogLevel::Debug, (&quot;BeginMailDelivery acquiring semaphore&quot;));</span>
<a href="#l38.33"></a><span id="l38.33">     m_folder-&gt;AcquireSemaphore(supports);</span>
<a href="#l38.34"></a><span id="l38.34">   }</span>
<a href="#l38.35"></a><span id="l38.35">   else</span>
<a href="#l38.36"></a><span id="l38.36">   {</span>
<a href="#l38.37"></a><span id="l38.37" class="difflineminus">-    PR_LOG(POP3LOGMODULE, PR_LOG_MAX, (&quot;BeginMailDelivery folder locked&quot;));</span>
<a href="#l38.38"></a><span id="l38.38" class="difflineplus">+    MOZ_LOG(POP3LOGMODULE, mozilla::LogLevel::Debug, (&quot;BeginMailDelivery folder locked&quot;));</span>
<a href="#l38.39"></a><span id="l38.39">     return NS_MSG_FOLDER_BUSY;</span>
<a href="#l38.40"></a><span id="l38.40">   }</span>
<a href="#l38.41"></a><span id="l38.41">   m_uidlDownload = uidlDownload;</span>
<a href="#l38.42"></a><span id="l38.42">   if (!uidlDownload)</span>
<a href="#l38.43"></a><span id="l38.43">     FindPartialMessages();</span>
<a href="#l38.44"></a><span id="l38.44"> </span>
<a href="#l38.45"></a><span id="l38.45">   m_folder-&gt;GetNumNewMessages(false, &amp;m_numNewMessagesInFolder);</span>
<a href="#l38.46"></a><span id="l38.46"> </span>
<a href="#l38.47"></a><span id="l38.47" class="difflineat">@@ -273,17 +273,17 @@ nsPop3Sink::EndMailDelivery(nsIPop3Proto</span>
<a href="#l38.48"></a><span id="l38.48"> </span>
<a href="#l38.49"></a><span id="l38.49">   if (m_downloadingToTempFile)</span>
<a href="#l38.50"></a><span id="l38.50">     m_tmpDownloadFile-&gt;Remove(false);</span>
<a href="#l38.51"></a><span id="l38.51"> </span>
<a href="#l38.52"></a><span id="l38.52">   // tell the parser to mark the db valid *after* closing the mailbox.</span>
<a href="#l38.53"></a><span id="l38.53">   if (m_newMailParser)</span>
<a href="#l38.54"></a><span id="l38.54">     m_newMailParser-&gt;UpdateDBFolderInfo();</span>
<a href="#l38.55"></a><span id="l38.55"> </span>
<a href="#l38.56"></a><span id="l38.56" class="difflineminus">-  PR_LOG(POP3LOGMODULE, PR_LOG_MAX, (&quot;Calling ReleaseFolderLock from EndMailDelivery&quot;));</span>
<a href="#l38.57"></a><span id="l38.57" class="difflineplus">+  MOZ_LOG(POP3LOGMODULE, mozilla::LogLevel::Debug, (&quot;Calling ReleaseFolderLock from EndMailDelivery&quot;));</span>
<a href="#l38.58"></a><span id="l38.58">   nsresult rv = ReleaseFolderLock();</span>
<a href="#l38.59"></a><span id="l38.59">   NS_ASSERTION(NS_SUCCEEDED(rv),&quot;folder lock not released successfully&quot;);</span>
<a href="#l38.60"></a><span id="l38.60"> </span>
<a href="#l38.61"></a><span id="l38.61">   bool filtersRun;</span>
<a href="#l38.62"></a><span id="l38.62">   m_folder-&gt;CallFilterPlugins(nullptr, &amp;filtersRun); // ??? do we need msgWindow?</span>
<a href="#l38.63"></a><span id="l38.63">   int32_t numNewMessagesInFolder;</span>
<a href="#l38.64"></a><span id="l38.64">   // if filters have marked msgs read or deleted, the num new messages count</span>
<a href="#l38.65"></a><span id="l38.65">   // will go negative by the number of messages marked read or deleted,</span>
<a href="#l38.66"></a><span id="l38.66" class="difflineat">@@ -372,17 +372,17 @@ nsresult</span>
<a href="#l38.67"></a><span id="l38.67"> nsPop3Sink::ReleaseFolderLock()</span>
<a href="#l38.68"></a><span id="l38.68"> {</span>
<a href="#l38.69"></a><span id="l38.69">   nsresult result = NS_OK;</span>
<a href="#l38.70"></a><span id="l38.70">   if (!m_folder)</span>
<a href="#l38.71"></a><span id="l38.71">     return result;</span>
<a href="#l38.72"></a><span id="l38.72">   bool haveSemaphore;</span>
<a href="#l38.73"></a><span id="l38.73">   nsCOMPtr &lt;nsISupports&gt; supports = do_QueryInterface(static_cast&lt;nsIPop3Sink*&gt;(this));</span>
<a href="#l38.74"></a><span id="l38.74">   result = m_folder-&gt;TestSemaphore(supports, &amp;haveSemaphore);</span>
<a href="#l38.75"></a><span id="l38.75" class="difflineminus">-  PR_LOG(POP3LOGMODULE, PR_LOG_MAX, (&quot;ReleaseFolderLock haveSemaphore = %s&quot;, haveSemaphore ? &quot;TRUE&quot; : &quot;FALSE&quot;));</span>
<a href="#l38.76"></a><span id="l38.76" class="difflineplus">+  MOZ_LOG(POP3LOGMODULE, mozilla::LogLevel::Debug, (&quot;ReleaseFolderLock haveSemaphore = %s&quot;, haveSemaphore ? &quot;TRUE&quot; : &quot;FALSE&quot;));</span>
<a href="#l38.77"></a><span id="l38.77"> </span>
<a href="#l38.78"></a><span id="l38.78">   if(NS_SUCCEEDED(result) &amp;&amp; haveSemaphore)</span>
<a href="#l38.79"></a><span id="l38.79">     result = m_folder-&gt;ReleaseSemaphore(supports);</span>
<a href="#l38.80"></a><span id="l38.80">   return result;</span>
<a href="#l38.81"></a><span id="l38.81"> }</span>
<a href="#l38.82"></a><span id="l38.82"> </span>
<a href="#l38.83"></a><span id="l38.83"> nsresult</span>
<a href="#l38.84"></a><span id="l38.84"> nsPop3Sink::AbortMailDelivery(nsIPop3Protocol *protocol)</span>
<a href="#l38.85"></a><span id="l38.85" class="difflineat">@@ -399,17 +399,17 @@ nsPop3Sink::AbortMailDelivery(nsIPop3Pro</span>
<a href="#l38.86"></a><span id="l38.86"> </span>
<a href="#l38.87"></a><span id="l38.87">   if (m_downloadingToTempFile &amp;&amp; m_tmpDownloadFile)</span>
<a href="#l38.88"></a><span id="l38.88">     m_tmpDownloadFile-&gt;Remove(false);</span>
<a href="#l38.89"></a><span id="l38.89"> </span>
<a href="#l38.90"></a><span id="l38.90">   /* tell the parser to mark the db valid *after* closing the mailbox.</span>
<a href="#l38.91"></a><span id="l38.91">   we have truncated the inbox, so berkeley mailbox and msf file are in sync*/</span>
<a href="#l38.92"></a><span id="l38.92">   if (m_newMailParser)</span>
<a href="#l38.93"></a><span id="l38.93">     m_newMailParser-&gt;UpdateDBFolderInfo();</span>
<a href="#l38.94"></a><span id="l38.94" class="difflineminus">-  PR_LOG(POP3LOGMODULE, PR_LOG_MAX, (&quot;Calling ReleaseFolderLock from AbortMailDelivery&quot;));</span>
<a href="#l38.95"></a><span id="l38.95" class="difflineplus">+  MOZ_LOG(POP3LOGMODULE, mozilla::LogLevel::Debug, (&quot;Calling ReleaseFolderLock from AbortMailDelivery&quot;));</span>
<a href="#l38.96"></a><span id="l38.96"> </span>
<a href="#l38.97"></a><span id="l38.97">   nsresult rv = ReleaseFolderLock();</span>
<a href="#l38.98"></a><span id="l38.98">   NS_ASSERTION(NS_SUCCEEDED(rv),&quot;folder lock not released successfully&quot;);</span>
<a href="#l38.99"></a><span id="l38.99"> </span>
<a href="#l38.100"></a><span id="l38.100"> #ifdef DEBUG</span>
<a href="#l38.101"></a><span id="l38.101">     printf(&quot;Abort mail message delivery.\n&quot;);</span>
<a href="#l38.102"></a><span id="l38.102"> #endif</span>
<a href="#l38.103"></a><span id="l38.103">   nsCOMPtr&lt;nsIPop3Service&gt; pop3Service(do_GetService(NS_POP3SERVICE_CONTRACTID1, &amp;rv));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/mailnews/mapi/mapihook/src/msgMapiHook.cpp</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/mailnews/mapi/mapihook/src/msgMapiHook.cpp</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -40,16 +40,17 @@</span>
<a href="#l39.4"></a><span id="l39.4"> #include &quot;msgMapiMain.h&quot;</span>
<a href="#l39.5"></a><span id="l39.5"> #include &quot;nsThreadUtils.h&quot;</span>
<a href="#l39.6"></a><span id="l39.6"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l39.7"></a><span id="l39.7"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l39.8"></a><span id="l39.8"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l39.9"></a><span id="l39.9"> #include &quot;nsIArray.h&quot;</span>
<a href="#l39.10"></a><span id="l39.10"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l39.11"></a><span id="l39.11"> #include &quot;nsEmbedCID.h&quot;</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l39.13"></a><span id="l39.13"> </span>
<a href="#l39.14"></a><span id="l39.14"> extern PRLogModuleInfo *MAPI;</span>
<a href="#l39.15"></a><span id="l39.15"> </span>
<a href="#l39.16"></a><span id="l39.16"> class nsMAPISendListener : public nsIMsgSendListener</span>
<a href="#l39.17"></a><span id="l39.17"> {</span>
<a href="#l39.18"></a><span id="l39.18"> public:</span>
<a href="#l39.19"></a><span id="l39.19"> </span>
<a href="#l39.20"></a><span id="l39.20">     virtual ~nsMAPISendListener() { }</span>
<a href="#l39.21"></a><span id="l39.21" class="difflineat">@@ -407,17 +408,17 @@ nsresult nsMapiHook::PopulateCompFields(</span>
<a href="#l39.22"></a><span id="l39.22">             Bcc += Comma;</span>
<a href="#l39.23"></a><span id="l39.23">           Bcc.Append(NS_ConvertASCIItoUTF16(addressWithoutType));</span>
<a href="#l39.24"></a><span id="l39.24">           break;</span>
<a href="#l39.25"></a><span id="l39.25">         }</span>
<a href="#l39.26"></a><span id="l39.26">       }</span>
<a href="#l39.27"></a><span id="l39.27">     }</span>
<a href="#l39.28"></a><span id="l39.28">   }</span>
<a href="#l39.29"></a><span id="l39.29"> </span>
<a href="#l39.30"></a><span id="l39.30" class="difflineminus">-  PR_LOG(MAPI, PR_LOG_DEBUG, (&quot;to: %s cc: %s bcc: %s \n&quot;, NS_ConvertUTF16toUTF8(To).get(), NS_ConvertUTF16toUTF8(Cc).get(), NS_ConvertUTF16toUTF8(Bcc).get()));</span>
<a href="#l39.31"></a><span id="l39.31" class="difflineplus">+  MOZ_LOG(MAPI, mozilla::LogLevel::Debug, (&quot;to: %s cc: %s bcc: %s \n&quot;, NS_ConvertUTF16toUTF8(To).get(), NS_ConvertUTF16toUTF8(Cc).get(), NS_ConvertUTF16toUTF8(Bcc).get()));</span>
<a href="#l39.32"></a><span id="l39.32">   // set To, Cc, Bcc</span>
<a href="#l39.33"></a><span id="l39.33">   aCompFields-&gt;SetTo (To) ;</span>
<a href="#l39.34"></a><span id="l39.34">   aCompFields-&gt;SetCc (Cc) ;</span>
<a href="#l39.35"></a><span id="l39.35">   aCompFields-&gt;SetBcc (Bcc) ;</span>
<a href="#l39.36"></a><span id="l39.36"> </span>
<a href="#l39.37"></a><span id="l39.37">   // set subject</span>
<a href="#l39.38"></a><span id="l39.38">   if (aMessage-&gt;lpszSubject)</span>
<a href="#l39.39"></a><span id="l39.39">     aCompFields-&gt;SetSubject(NS_ConvertASCIItoUTF16(aMessage-&gt;lpszSubject));</span>
<a href="#l39.40"></a><span id="l39.40" class="difflineat">@@ -463,17 +464,17 @@ nsresult nsMapiHook::HandleAttachments (</span>
<a href="#l39.41"></a><span id="l39.41">             // check if attachment exists</span>
<a href="#l39.42"></a><span id="l39.42">             if (aIsUnicode)</span>
<a href="#l39.43"></a><span id="l39.43">                 pFile-&gt;InitWithPath (nsDependentString(aFiles[i].lpszPathName));</span>
<a href="#l39.44"></a><span id="l39.44">             else</span>
<a href="#l39.45"></a><span id="l39.45">                 pFile-&gt;InitWithNativePath (nsDependentCString((const char*)aFiles[i].lpszPathName));</span>
<a href="#l39.46"></a><span id="l39.46"> </span>
<a href="#l39.47"></a><span id="l39.47">             bool bExist ;</span>
<a href="#l39.48"></a><span id="l39.48">             rv = pFile-&gt;Exists(&amp;bExist) ;</span>
<a href="#l39.49"></a><span id="l39.49" class="difflineminus">-            PR_LOG(MAPI, PR_LOG_DEBUG, (&quot;nsMapiHook::HandleAttachments: filename: %s path: %s exists = %s \n&quot;, (const char*)aFiles[i].lpszFileName, (const char*)aFiles[i].lpszPathName, bExist ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l39.50"></a><span id="l39.50" class="difflineplus">+            MOZ_LOG(MAPI, mozilla::LogLevel::Debug, (&quot;nsMapiHook::HandleAttachments: filename: %s path: %s exists = %s \n&quot;, (const char*)aFiles[i].lpszFileName, (const char*)aFiles[i].lpszPathName, bExist ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l39.51"></a><span id="l39.51">             if (NS_FAILED(rv) || (!bExist) ) return NS_ERROR_FILE_TARGET_DOES_NOT_EXIST ;</span>
<a href="#l39.52"></a><span id="l39.52"> </span>
<a href="#l39.53"></a><span id="l39.53">             //Temp Directory</span>
<a href="#l39.54"></a><span id="l39.54">             nsCOMPtr &lt;nsIFile&gt; pTempDir;</span>
<a href="#l39.55"></a><span id="l39.55">             NS_GetSpecialDirectory(NS_OS_TEMP_DIR, getter_AddRefs(pTempDir));</span>
<a href="#l39.56"></a><span id="l39.56"> </span>
<a href="#l39.57"></a><span id="l39.57">             // create a new sub directory called moz_mapi underneath the temp directory</span>
<a href="#l39.58"></a><span id="l39.58">             pTempDir-&gt;AppendRelativePath(NS_LITERAL_STRING(&quot;moz_mapi&quot;));</span>
<a href="#l39.59"></a><span id="l39.59" class="difflineat">@@ -542,17 +543,17 @@ nsresult nsMapiHook::HandleAttachments (</span>
<a href="#l39.60"></a><span id="l39.60">             // set the file size</span>
<a href="#l39.61"></a><span id="l39.61">             int64_t fileSize;</span>
<a href="#l39.62"></a><span id="l39.62">             pFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l39.63"></a><span id="l39.63">             attachment-&gt;SetSize(fileSize);</span>
<a href="#l39.64"></a><span id="l39.64"> </span>
<a href="#l39.65"></a><span id="l39.65">             // add the attachment</span>
<a href="#l39.66"></a><span id="l39.66">             rv = aCompFields-&gt;AddAttachment (attachment);</span>
<a href="#l39.67"></a><span id="l39.67">             if (NS_FAILED(rv))</span>
<a href="#l39.68"></a><span id="l39.68" class="difflineminus">-              PR_LOG(MAPI, PR_LOG_DEBUG, (&quot;nsMapiHook::HandleAttachments: AddAttachment rv =  %lx\n&quot;, rv));</span>
<a href="#l39.69"></a><span id="l39.69" class="difflineplus">+              MOZ_LOG(MAPI, mozilla::LogLevel::Debug, (&quot;nsMapiHook::HandleAttachments: AddAttachment rv =  %lx\n&quot;, rv));</span>
<a href="#l39.70"></a><span id="l39.70">         }</span>
<a href="#l39.71"></a><span id="l39.71">     }</span>
<a href="#l39.72"></a><span id="l39.72">     return rv ;</span>
<a href="#l39.73"></a><span id="l39.73"> }</span>
<a href="#l39.74"></a><span id="l39.74"> </span>
<a href="#l39.75"></a><span id="l39.75"> </span>
<a href="#l39.76"></a><span id="l39.76"> // this is used to convert non Unicode data and then populate comp fields</span>
<a href="#l39.77"></a><span id="l39.77"> nsresult nsMapiHook::PopulateCompFieldsWithConversion(lpnsMapiMessage aMessage,</span>
<a href="#l39.78"></a><span id="l39.78" class="difflineat">@@ -606,17 +607,17 @@ nsresult nsMapiHook::PopulateCompFieldsW</span>
<a href="#l39.79"></a><span id="l39.79">     }</span>
<a href="#l39.80"></a><span id="l39.80">   }</span>
<a href="#l39.81"></a><span id="l39.81"> </span>
<a href="#l39.82"></a><span id="l39.82">   // set To, Cc, Bcc</span>
<a href="#l39.83"></a><span id="l39.83">   aCompFields-&gt;SetTo (To) ;</span>
<a href="#l39.84"></a><span id="l39.84">   aCompFields-&gt;SetCc (Cc) ;</span>
<a href="#l39.85"></a><span id="l39.85">   aCompFields-&gt;SetBcc (Bcc) ;</span>
<a href="#l39.86"></a><span id="l39.86"> </span>
<a href="#l39.87"></a><span id="l39.87" class="difflineminus">-  PR_LOG(MAPI, PR_LOG_DEBUG, (&quot;to: %s cc: %s bcc: %s \n&quot;, NS_ConvertUTF16toUTF8(To).get(), NS_ConvertUTF16toUTF8(Cc).get(), NS_ConvertUTF16toUTF8(Bcc).get()));</span>
<a href="#l39.88"></a><span id="l39.88" class="difflineplus">+  MOZ_LOG(MAPI, mozilla::LogLevel::Debug, (&quot;to: %s cc: %s bcc: %s \n&quot;, NS_ConvertUTF16toUTF8(To).get(), NS_ConvertUTF16toUTF8(Cc).get(), NS_ConvertUTF16toUTF8(Bcc).get()));</span>
<a href="#l39.89"></a><span id="l39.89"> </span>
<a href="#l39.90"></a><span id="l39.90">   nsAutoCString platformCharSet;</span>
<a href="#l39.91"></a><span id="l39.91">   // set subject</span>
<a href="#l39.92"></a><span id="l39.92">   if (aMessage-&gt;lpszSubject)</span>
<a href="#l39.93"></a><span id="l39.93">   {</span>
<a href="#l39.94"></a><span id="l39.94">     nsAutoString Subject ;</span>
<a href="#l39.95"></a><span id="l39.95">     if (platformCharSet.IsEmpty())</span>
<a href="#l39.96"></a><span id="l39.96">       platformCharSet.Assign(nsMsgI18NFileSystemCharset());</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/mailnews/mapi/mapihook/src/msgMapiImp.cpp</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/mailnews/mapi/mapihook/src/msgMapiImp.cpp</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -27,16 +27,17 @@</span>
<a href="#l40.4"></a><span id="l40.4"> #include &quot;nsIInputStream.h&quot;</span>
<a href="#l40.5"></a><span id="l40.5"> #include &quot;nsILineInputStream.h&quot;</span>
<a href="#l40.6"></a><span id="l40.6"> #include &quot;nsISeekableStream.h&quot;</span>
<a href="#l40.7"></a><span id="l40.7"> #include &quot;nsIFile.h&quot;</span>
<a href="#l40.8"></a><span id="l40.8"> #include &quot;nsIFileStreams.h&quot;</span>
<a href="#l40.9"></a><span id="l40.9"> #include &quot;nsNetCID.h&quot;</span>
<a href="#l40.10"></a><span id="l40.10"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l40.11"></a><span id="l40.11"> #include &quot;mozilla/mailnews/MimeHeaderParser.h&quot;</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l40.13"></a><span id="l40.13"> </span>
<a href="#l40.14"></a><span id="l40.14"> using namespace mozilla::mailnews;</span>
<a href="#l40.15"></a><span id="l40.15"> </span>
<a href="#l40.16"></a><span id="l40.16"> PRLogModuleInfo *MAPI;</span>
<a href="#l40.17"></a><span id="l40.17"> </span>
<a href="#l40.18"></a><span id="l40.18"> CMapiImp::CMapiImp()</span>
<a href="#l40.19"></a><span id="l40.19"> : m_cRef(1)</span>
<a href="#l40.20"></a><span id="l40.20"> {</span>
<a href="#l40.21"></a><span id="l40.21" class="difflineat">@@ -124,27 +125,27 @@ STDMETHODIMP CMapiImp::Initialize()</span>
<a href="#l40.22"></a><span id="l40.22"> </span>
<a href="#l40.23"></a><span id="l40.23"> STDMETHODIMP CMapiImp::Login(unsigned long aUIArg, LOGIN_PW_TYPE aLogin, LOGIN_PW_TYPE aPassWord,</span>
<a href="#l40.24"></a><span id="l40.24">                 unsigned long aFlags, unsigned long *aSessionId)</span>
<a href="#l40.25"></a><span id="l40.25"> {</span>
<a href="#l40.26"></a><span id="l40.26">     HRESULT hr = E_FAIL;</span>
<a href="#l40.27"></a><span id="l40.27">      bool bNewSession = false;</span>
<a href="#l40.28"></a><span id="l40.28">     nsCString id_key;</span>
<a href="#l40.29"></a><span id="l40.29"> </span>
<a href="#l40.30"></a><span id="l40.30" class="difflineminus">-    PR_LOG(MAPI, PR_LOG_DEBUG, (&quot;CMapiImp::Login using flags %d\n&quot;, aFlags));</span>
<a href="#l40.31"></a><span id="l40.31" class="difflineplus">+    MOZ_LOG(MAPI, mozilla::LogLevel::Debug, (&quot;CMapiImp::Login using flags %d\n&quot;, aFlags));</span>
<a href="#l40.32"></a><span id="l40.32">     if (aFlags &amp; MAPI_NEW_SESSION)</span>
<a href="#l40.33"></a><span id="l40.33">         bNewSession = true;</span>
<a href="#l40.34"></a><span id="l40.34"> </span>
<a href="#l40.35"></a><span id="l40.35">     // Check For Profile Name</span>
<a href="#l40.36"></a><span id="l40.36">     if (aLogin != nullptr &amp;&amp; aLogin[0] != '\0')</span>
<a href="#l40.37"></a><span id="l40.37">     {</span>
<a href="#l40.38"></a><span id="l40.38">         if (!nsMapiHook::VerifyUserName(nsString(aLogin), id_key))</span>
<a href="#l40.39"></a><span id="l40.39">         {</span>
<a href="#l40.40"></a><span id="l40.40">             *aSessionId = MAPI_E_LOGIN_FAILURE;</span>
<a href="#l40.41"></a><span id="l40.41" class="difflineminus">-            PR_LOG(MAPI, PR_LOG_DEBUG, (&quot;CMapiImp::Login failed for username %s\n&quot;, aLogin));</span>
<a href="#l40.42"></a><span id="l40.42" class="difflineplus">+            MOZ_LOG(MAPI, mozilla::LogLevel::Debug, (&quot;CMapiImp::Login failed for username %s\n&quot;, aLogin));</span>
<a href="#l40.43"></a><span id="l40.43">             NS_ASSERTION(false, &quot;failed verifying user name&quot;);</span>
<a href="#l40.44"></a><span id="l40.44">             return hr;</span>
<a href="#l40.45"></a><span id="l40.45">         }</span>
<a href="#l40.46"></a><span id="l40.46">     }</span>
<a href="#l40.47"></a><span id="l40.47">     else</span>
<a href="#l40.48"></a><span id="l40.48">     {</span>
<a href="#l40.49"></a><span id="l40.49">       // get default account</span>
<a href="#l40.50"></a><span id="l40.50">       nsresult rv;</span>
<a href="#l40.51"></a><span id="l40.51" class="difflineat">@@ -180,37 +181,37 @@ STDMETHODIMP CMapiImp::Login(unsigned lo</span>
<a href="#l40.52"></a><span id="l40.52">         case 0 :</span>
<a href="#l40.53"></a><span id="l40.53">         {</span>
<a href="#l40.54"></a><span id="l40.54">             *aSessionId = MAPI_E_INSUFFICIENT_MEMORY;</span>
<a href="#l40.55"></a><span id="l40.55">             return hr;</span>
<a href="#l40.56"></a><span id="l40.56">         }</span>
<a href="#l40.57"></a><span id="l40.57">         default :</span>
<a href="#l40.58"></a><span id="l40.58">         {</span>
<a href="#l40.59"></a><span id="l40.59">             *aSessionId = nSession_Id;</span>
<a href="#l40.60"></a><span id="l40.60" class="difflineminus">-            PR_LOG(MAPI, PR_LOG_DEBUG, (&quot;CMapiImp::Login succeeded\n&quot;));</span>
<a href="#l40.61"></a><span id="l40.61" class="difflineplus">+            MOZ_LOG(MAPI, mozilla::LogLevel::Debug, (&quot;CMapiImp::Login succeeded\n&quot;));</span>
<a href="#l40.62"></a><span id="l40.62">             break;</span>
<a href="#l40.63"></a><span id="l40.63">         }</span>
<a href="#l40.64"></a><span id="l40.64">     }</span>
<a href="#l40.65"></a><span id="l40.65"> </span>
<a href="#l40.66"></a><span id="l40.66">     return S_OK;</span>
<a href="#l40.67"></a><span id="l40.67"> }</span>
<a href="#l40.68"></a><span id="l40.68"> </span>
<a href="#l40.69"></a><span id="l40.69"> STDMETHODIMP CMapiImp::SendMail( unsigned long aSession, lpnsMapiMessage aMessage,</span>
<a href="#l40.70"></a><span id="l40.70">      short aRecipCount, lpnsMapiRecipDesc aRecips , short aFileCount, lpnsMapiFileDesc aFiles , </span>
<a href="#l40.71"></a><span id="l40.71">      unsigned long aFlags, unsigned long aReserved)</span>
<a href="#l40.72"></a><span id="l40.72"> {</span>
<a href="#l40.73"></a><span id="l40.73">     nsresult rv = NS_OK ;</span>
<a href="#l40.74"></a><span id="l40.74"> </span>
<a href="#l40.75"></a><span id="l40.75" class="difflineminus">-    PR_LOG(MAPI, PR_LOG_DEBUG, (&quot;CMapiImp::SendMail using flags %d\n&quot;, aFlags));</span>
<a href="#l40.76"></a><span id="l40.76" class="difflineplus">+    MOZ_LOG(MAPI, mozilla::LogLevel::Debug, (&quot;CMapiImp::SendMail using flags %d\n&quot;, aFlags));</span>
<a href="#l40.77"></a><span id="l40.77">     // Assign the pointers in the aMessage struct to the array of Recips and Files</span>
<a href="#l40.78"></a><span id="l40.78">     // received here from MS COM. These are used in BlindSendMail and ShowCompWin fns </span>
<a href="#l40.79"></a><span id="l40.79">     aMessage-&gt;lpRecips = aRecips ;</span>
<a href="#l40.80"></a><span id="l40.80">     aMessage-&gt;lpFiles = aFiles ;</span>
<a href="#l40.81"></a><span id="l40.81"> </span>
<a href="#l40.82"></a><span id="l40.82" class="difflineminus">-    PR_LOG(MAPI, PR_LOG_DEBUG, (&quot;CMapiImp::SendMail flags=%x subject: %s sender: %s\n&quot;, </span>
<a href="#l40.83"></a><span id="l40.83" class="difflineplus">+    MOZ_LOG(MAPI, mozilla::LogLevel::Debug, (&quot;CMapiImp::SendMail flags=%x subject: %s sender: %s\n&quot;, </span>
<a href="#l40.84"></a><span id="l40.84">       aFlags, (char *) aMessage-&gt;lpszSubject, (aMessage-&gt;lpOriginator) ? aMessage-&gt;lpOriginator-&gt;lpszAddress : &quot;&quot;));</span>
<a href="#l40.85"></a><span id="l40.85"> </span>
<a href="#l40.86"></a><span id="l40.86">     /** create nsIMsgCompFields obj and populate it **/</span>
<a href="#l40.87"></a><span id="l40.87">     nsCOMPtr&lt;nsIMsgCompFields&gt; pCompFields = do_CreateInstance(NS_MSGCOMPFIELDS_CONTRACTID, &amp;rv) ;</span>
<a href="#l40.88"></a><span id="l40.88">     if (NS_FAILED(rv) || (!pCompFields) ) return MAPI_E_INSUFFICIENT_MEMORY ;</span>
<a href="#l40.89"></a><span id="l40.89"> </span>
<a href="#l40.90"></a><span id="l40.90">     if (aFlags &amp; MAPI_UNICODE)</span>
<a href="#l40.91"></a><span id="l40.91">         rv = nsMapiHook::PopulateCompFields(aMessage, pCompFields) ;</span>
<a href="#l40.92"></a><span id="l40.92" class="difflineat">@@ -234,30 +235,30 @@ STDMETHODIMP CMapiImp::SendMail( unsigne</span>
<a href="#l40.93"></a><span id="l40.93"> }</span>
<a href="#l40.94"></a><span id="l40.94"> </span>
<a href="#l40.95"></a><span id="l40.95"> </span>
<a href="#l40.96"></a><span id="l40.96"> STDMETHODIMP CMapiImp::SendDocuments( unsigned long aSession, LPTSTR aDelimChar,</span>
<a href="#l40.97"></a><span id="l40.97">                             LPTSTR aFilePaths, LPTSTR aFileNames, ULONG aFlags)</span>
<a href="#l40.98"></a><span id="l40.98"> {</span>
<a href="#l40.99"></a><span id="l40.99">     nsresult rv = NS_OK ;</span>
<a href="#l40.100"></a><span id="l40.100"> </span>
<a href="#l40.101"></a><span id="l40.101" class="difflineminus">-    PR_LOG(MAPI, PR_LOG_DEBUG, (&quot;CMapiImp::SendDocument using flags %d\n&quot;, aFlags));</span>
<a href="#l40.102"></a><span id="l40.102" class="difflineplus">+    MOZ_LOG(MAPI, mozilla::LogLevel::Debug, (&quot;CMapiImp::SendDocument using flags %d\n&quot;, aFlags));</span>
<a href="#l40.103"></a><span id="l40.103">     /** create nsIMsgCompFields obj and populate it **/</span>
<a href="#l40.104"></a><span id="l40.104">     nsCOMPtr&lt;nsIMsgCompFields&gt; pCompFields = do_CreateInstance(NS_MSGCOMPFIELDS_CONTRACTID, &amp;rv) ;</span>
<a href="#l40.105"></a><span id="l40.105">     if (NS_FAILED(rv) || (!pCompFields) ) return MAPI_E_INSUFFICIENT_MEMORY ;</span>
<a href="#l40.106"></a><span id="l40.106"> </span>
<a href="#l40.107"></a><span id="l40.107">     if (aFilePaths)</span>
<a href="#l40.108"></a><span id="l40.108">     {</span>
<a href="#l40.109"></a><span id="l40.109">         rv = nsMapiHook::PopulateCompFieldsForSendDocs(pCompFields, aFlags, aDelimChar, aFilePaths) ;</span>
<a href="#l40.110"></a><span id="l40.110">     }</span>
<a href="#l40.111"></a><span id="l40.111"> </span>
<a href="#l40.112"></a><span id="l40.112">     if (NS_SUCCEEDED (rv)) </span>
<a href="#l40.113"></a><span id="l40.113">         rv = nsMapiHook::ShowComposerWindow(aSession, pCompFields);</span>
<a href="#l40.114"></a><span id="l40.114">     else</span>
<a href="#l40.115"></a><span id="l40.115" class="difflineminus">-      PR_LOG(MAPI, PR_LOG_DEBUG, (&quot;CMapiImp::SendDocument error rv = %lx, paths = %s names = %s\n&quot;, rv, aFilePaths, aFileNames));</span>
<a href="#l40.116"></a><span id="l40.116" class="difflineplus">+      MOZ_LOG(MAPI, mozilla::LogLevel::Debug, (&quot;CMapiImp::SendDocument error rv = %lx, paths = %s names = %s\n&quot;, rv, aFilePaths, aFileNames));</span>
<a href="#l40.117"></a><span id="l40.117"> </span>
<a href="#l40.118"></a><span id="l40.118">     return nsMAPIConfiguration::GetMAPIErrorFromNSError (rv) ;</span>
<a href="#l40.119"></a><span id="l40.119"> }</span>
<a href="#l40.120"></a><span id="l40.120"> </span>
<a href="#l40.121"></a><span id="l40.121"> nsresult CMapiImp::GetDefaultInbox(nsIMsgFolder **inboxFolder)</span>
<a href="#l40.122"></a><span id="l40.122"> {</span>
<a href="#l40.123"></a><span id="l40.123">   // get default account</span>
<a href="#l40.124"></a><span id="l40.124">   nsresult rv;</span>
<a href="#l40.125"></a><span id="l40.125" class="difflineat">@@ -400,26 +401,26 @@ STDMETHODIMP CMapiImp::FindNext(unsigned</span>
<a href="#l40.126"></a><span id="l40.126">       return(MAPI_E_NO_MESSAGES);</span>
<a href="#l40.127"></a><span id="l40.127">     }</span>
<a href="#l40.128"></a><span id="l40.128"> </span>
<a href="#l40.129"></a><span id="l40.129"> //    TRACE(&quot;MAPI: ProcessMAPIFindNext() Found message id = %d\n&quot;, nextKey);</span>
<a href="#l40.130"></a><span id="l40.130"> </span>
<a href="#l40.131"></a><span id="l40.131">     sprintf((char *) lpszMessageID, &quot;%d&quot;, nextKey);</span>
<a href="#l40.132"></a><span id="l40.132">   }</span>
<a href="#l40.133"></a><span id="l40.133"> </span>
<a href="#l40.134"></a><span id="l40.134" class="difflineminus">-  PR_LOG(MAPI, PR_LOG_DEBUG, (&quot;CMapiImp::FindNext returning key %s\n&quot;, (char *) lpszMessageID));</span>
<a href="#l40.135"></a><span id="l40.135" class="difflineplus">+  MOZ_LOG(MAPI, mozilla::LogLevel::Debug, (&quot;CMapiImp::FindNext returning key %s\n&quot;, (char *) lpszMessageID));</span>
<a href="#l40.136"></a><span id="l40.136">   return(SUCCESS_SUCCESS);</span>
<a href="#l40.137"></a><span id="l40.137"> }</span>
<a href="#l40.138"></a><span id="l40.138"> </span>
<a href="#l40.139"></a><span id="l40.139"> STDMETHODIMP CMapiImp::ReadMail(unsigned long aSession, unsigned long ulUIParam, LPTSTR lpszMessageID,</span>
<a href="#l40.140"></a><span id="l40.140">                               unsigned long flFlags, unsigned long ulReserved, lpnsMapiMessage *lppMessage)</span>
<a href="#l40.141"></a><span id="l40.141"> {</span>
<a href="#l40.142"></a><span id="l40.142">   nsresult irv;</span>
<a href="#l40.143"></a><span id="l40.143">   nsAutoCString keyString((char *) lpszMessageID);</span>
<a href="#l40.144"></a><span id="l40.144" class="difflineminus">-  PR_LOG(MAPI, PR_LOG_DEBUG, (&quot;CMapiImp::ReadMail asking for key %s\n&quot;, (char *) lpszMessageID));</span>
<a href="#l40.145"></a><span id="l40.145" class="difflineplus">+  MOZ_LOG(MAPI, mozilla::LogLevel::Debug, (&quot;CMapiImp::ReadMail asking for key %s\n&quot;, (char *) lpszMessageID));</span>
<a href="#l40.146"></a><span id="l40.146">   nsMsgKey msgKey = keyString.ToInteger(&amp;irv);</span>
<a href="#l40.147"></a><span id="l40.147">   if (NS_FAILED(irv))</span>
<a href="#l40.148"></a><span id="l40.148">   {</span>
<a href="#l40.149"></a><span id="l40.149">     NS_ASSERTION(false, &quot;invalid lpszMessageID&quot;);</span>
<a href="#l40.150"></a><span id="l40.150">     return MAPI_E_INVALID_MESSAGE;</span>
<a href="#l40.151"></a><span id="l40.151">   }</span>
<a href="#l40.152"></a><span id="l40.152">   MsgMapiListContext *listContext;</span>
<a href="#l40.153"></a><span id="l40.153">   LONG ret = InitContext(aSession, &amp;listContext);</span>
<a href="#l40.154"></a><span id="l40.154" class="difflineat">@@ -617,17 +618,17 @@ lpnsMapiMessage MsgMapiListContext::GetM</span>
<a href="#l40.155"></a><span id="l40.155">       if (message-&gt;lpRecips)</span>
<a href="#l40.156"></a><span id="l40.156">       {</span>
<a href="#l40.157"></a><span id="l40.157">         ConvertRecipientsToMapiFormat(parsedToRecips, message-&gt;lpRecips,</span>
<a href="#l40.158"></a><span id="l40.158">           MAPI_TO);</span>
<a href="#l40.159"></a><span id="l40.159">         ConvertRecipientsToMapiFormat(parsedCCRecips,</span>
<a href="#l40.160"></a><span id="l40.160">           &amp;message-&gt;lpRecips[numToRecips], MAPI_CC);</span>
<a href="#l40.161"></a><span id="l40.161">       }</span>
<a href="#l40.162"></a><span id="l40.162">   </span>
<a href="#l40.163"></a><span id="l40.163" class="difflineminus">-      PR_LOG(MAPI, PR_LOG_DEBUG, (&quot;MsgMapiListContext::GetMessage flags=%x subject %s date %s sender %s\n&quot;, </span>
<a href="#l40.164"></a><span id="l40.164" class="difflineplus">+      MOZ_LOG(MAPI, mozilla::LogLevel::Debug, (&quot;MsgMapiListContext::GetMessage flags=%x subject %s date %s sender %s\n&quot;, </span>
<a href="#l40.165"></a><span id="l40.165">         flFlags, (char *) message-&gt;lpszSubject,(char *) message-&gt;lpszDateReceived, author.get()) );</span>
<a href="#l40.166"></a><span id="l40.166"> </span>
<a href="#l40.167"></a><span id="l40.167">       // Convert any body text that we have locally</span>
<a href="#l40.168"></a><span id="l40.168">       if (!(flFlags &amp; MAPI_ENVELOPE_ONLY))</span>
<a href="#l40.169"></a><span id="l40.169">         message-&gt;lpszNoteText = (char *) ConvertBodyToMapiFormat (msgHdr);</span>
<a href="#l40.170"></a><span id="l40.170">       </span>
<a href="#l40.171"></a><span id="l40.171">     }</span>
<a href="#l40.172"></a><span id="l40.172">     if (! (flFlags &amp; (MAPI_PEEK | MAPI_ENVELOPE_ONLY)))</span>
<a href="#l40.173"></a><span id="l40.173" class="difflineat">@@ -743,17 +744,17 @@ char *MsgMapiListContext::ConvertBodyToM</span>
<a href="#l40.174"></a><span id="l40.174">       curLine.Append(CRLF);</span>
<a href="#l40.175"></a><span id="l40.175">       // make sure we have room left</span>
<a href="#l40.176"></a><span id="l40.176">       if (bytesCopied + curLine.Length() &lt; msgSize)</span>
<a href="#l40.177"></a><span id="l40.177">       {</span>
<a href="#l40.178"></a><span id="l40.178">         strcpy(body + bytesCopied, curLine.get());</span>
<a href="#l40.179"></a><span id="l40.179">         bytesCopied += curLine.Length();</span>
<a href="#l40.180"></a><span id="l40.180">       }</span>
<a href="#l40.181"></a><span id="l40.181">     }</span>
<a href="#l40.182"></a><span id="l40.182" class="difflineminus">-    PR_LOG(MAPI, PR_LOG_DEBUG, (&quot;ConvertBodyToMapiFormat size=%x allocated size %x body = %100.100s\n&quot;, </span>
<a href="#l40.183"></a><span id="l40.183" class="difflineplus">+    MOZ_LOG(MAPI, mozilla::LogLevel::Debug, (&quot;ConvertBodyToMapiFormat size=%x allocated size %x body = %100.100s\n&quot;, </span>
<a href="#l40.184"></a><span id="l40.184">         bytesCopied, msgSize + 1, (char *) body) );</span>
<a href="#l40.185"></a><span id="l40.185">     body[bytesCopied] = '\0';   // rhp - fix last line garbage...</span>
<a href="#l40.186"></a><span id="l40.186">     return body;</span>
<a href="#l40.187"></a><span id="l40.187">   }</span>
<a href="#l40.188"></a><span id="l40.188">   return nullptr;</span>
<a href="#l40.189"></a><span id="l40.189"> }</span>
<a href="#l40.190"></a><span id="l40.190"> </span>
<a href="#l40.191"></a><span id="l40.191"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/mailnews/mime/emitters/nsMimeBaseEmitter.cpp</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/mailnews/mime/emitters/nsMimeBaseEmitter.cpp</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -15,17 +15,17 @@</span>
<a href="#l41.4"></a><span id="l41.4"> #include &quot;nsEmitterUtils.h&quot;</span>
<a href="#l41.5"></a><span id="l41.5"> #include &quot;nsMimeStringResources.h&quot;</span>
<a href="#l41.6"></a><span id="l41.6"> #include &quot;msgCore.h&quot;</span>
<a href="#l41.7"></a><span id="l41.7"> #include &quot;nsIComponentManager.h&quot;</span>
<a href="#l41.8"></a><span id="l41.8"> #include &quot;nsEmitterUtils.h&quot;</span>
<a href="#l41.9"></a><span id="l41.9"> #include &quot;nsIMimeStreamConverter.h&quot;</span>
<a href="#l41.10"></a><span id="l41.10"> #include &quot;nsIMimeConverter.h&quot;</span>
<a href="#l41.11"></a><span id="l41.11"> #include &quot;nsMsgMimeCID.h&quot;</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">-#include &quot;prlog.h&quot;</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l41.14"></a><span id="l41.14"> #include &quot;prprf.h&quot;</span>
<a href="#l41.15"></a><span id="l41.15"> #include &quot;nsIMimeHeaders.h&quot;</span>
<a href="#l41.16"></a><span id="l41.16"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l41.17"></a><span id="l41.17"> #include &quot;nsIMsgMailNewsUrl.h&quot;</span>
<a href="#l41.18"></a><span id="l41.18"> #include &quot;nsDateTimeFormatCID.h&quot;</span>
<a href="#l41.19"></a><span id="l41.19"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l41.20"></a><span id="l41.20"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l41.21"></a><span id="l41.21"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l41.22"></a><span id="l41.22" class="difflineat">@@ -424,17 +424,17 @@ nsMimeBaseEmitter::Write(const nsACStrin</span>
<a href="#l41.23"></a><span id="l41.23">   nsresult rv = NS_OK;</span>
<a href="#l41.24"></a><span id="l41.24">   uint32_t            needToWrite;</span>
<a href="#l41.25"></a><span id="l41.25"> </span>
<a href="#l41.26"></a><span id="l41.26"> #ifdef DEBUG_BenB</span>
<a href="#l41.27"></a><span id="l41.27">   // If you want to see libmime output...</span>
<a href="#l41.28"></a><span id="l41.28">   printf(&quot;%s&quot;, buf);</span>
<a href="#l41.29"></a><span id="l41.29"> #endif</span>
<a href="#l41.30"></a><span id="l41.30"> </span>
<a href="#l41.31"></a><span id="l41.31" class="difflineminus">-  PR_LOG(gMimeEmitterLogModule, PR_LOG_ALWAYS, (&quot;%s&quot;, PromiseFlatCString(buf).get()));</span>
<a href="#l41.32"></a><span id="l41.32" class="difflineplus">+  MOZ_LOG(gMimeEmitterLogModule, mozilla::LogLevel::Info, (&quot;%s&quot;, PromiseFlatCString(buf).get()));</span>
<a href="#l41.33"></a><span id="l41.33">   //</span>
<a href="#l41.34"></a><span id="l41.34">   // Make sure that the buffer we are &quot;pushing&quot; into has enough room</span>
<a href="#l41.35"></a><span id="l41.35">   // for the write operation. If not, we have to buffer, return, and get</span>
<a href="#l41.36"></a><span id="l41.36">   // it on the next time through</span>
<a href="#l41.37"></a><span id="l41.37">   //</span>
<a href="#l41.38"></a><span id="l41.38">   *amountWritten = 0;</span>
<a href="#l41.39"></a><span id="l41.39"> </span>
<a href="#l41.40"></a><span id="l41.40">   needToWrite = mBufferMgr-&gt;GetSize();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/mailnews/mime/src/nsCMS.cpp</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/mailnews/mime/src/nsCMS.cpp</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -19,28 +19,26 @@</span>
<a href="#l42.4"></a><span id="l42.4"> #include &quot;nsNSSComponent.h&quot;</span>
<a href="#l42.5"></a><span id="l42.5"> #include &quot;nsNSSHelper.h&quot;</span>
<a href="#l42.6"></a><span id="l42.6"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l42.7"></a><span id="l42.7"> #include &quot;mozilla/RefPtr.h&quot;</span>
<a href="#l42.8"></a><span id="l42.8"> #include &quot;pkix/pkixtypes.h&quot;</span>
<a href="#l42.9"></a><span id="l42.9"> #include &quot;ScopedNSSTypes.h&quot;</span>
<a href="#l42.10"></a><span id="l42.10"> #include &quot;smime.h&quot;</span>
<a href="#l42.11"></a><span id="l42.11"> </span>
<a href="#l42.12"></a><span id="l42.12" class="difflineminus">-#include &quot;prlog.h&quot;</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l42.14"></a><span id="l42.14"> </span>
<a href="#l42.15"></a><span id="l42.15"> using namespace mozilla;</span>
<a href="#l42.16"></a><span id="l42.16"> using namespace mozilla::psm;</span>
<a href="#l42.17"></a><span id="l42.17"> using namespace mozilla::pkix;</span>
<a href="#l42.18"></a><span id="l42.18"> </span>
<a href="#l42.19"></a><span id="l42.19"> #ifdef PR_LOGGING</span>
<a href="#l42.20"></a><span id="l42.20"> extern PRLogModuleInfo* gPIPNSSLog;</span>
<a href="#l42.21"></a><span id="l42.21"> #endif</span>
<a href="#l42.22"></a><span id="l42.22"> </span>
<a href="#l42.23"></a><span id="l42.23" class="difflineminus">-using namespace mozilla;</span>
<a href="#l42.24"></a><span id="l42.24" class="difflineminus">-</span>
<a href="#l42.25"></a><span id="l42.25"> NS_IMPL_ISUPPORTS(nsCMSMessage, nsICMSMessage, nsICMSMessage2)</span>
<a href="#l42.26"></a><span id="l42.26"> </span>
<a href="#l42.27"></a><span id="l42.27"> nsCMSMessage::nsCMSMessage()</span>
<a href="#l42.28"></a><span id="l42.28"> {</span>
<a href="#l42.29"></a><span id="l42.29">   m_cmsMsg = nullptr;</span>
<a href="#l42.30"></a><span id="l42.30"> }</span>
<a href="#l42.31"></a><span id="l42.31"> nsCMSMessage::nsCMSMessage(NSSCMSMessage *aCMSMsg)</span>
<a href="#l42.32"></a><span id="l42.32"> {</span>
<a href="#l42.33"></a><span id="l42.33" class="difflineat">@@ -106,68 +104,68 @@ NSSCMSSignerInfo* nsCMSMessage::GetTopLe</span>
<a href="#l42.34"></a><span id="l42.34"> }</span>
<a href="#l42.35"></a><span id="l42.35"> </span>
<a href="#l42.36"></a><span id="l42.36"> NS_IMETHODIMP nsCMSMessage::GetSignerEmailAddress(char * * aEmail)</span>
<a href="#l42.37"></a><span id="l42.37"> {</span>
<a href="#l42.38"></a><span id="l42.38">   nsNSSShutDownPreventionLock locker;</span>
<a href="#l42.39"></a><span id="l42.39">   if (isAlreadyShutDown())</span>
<a href="#l42.40"></a><span id="l42.40">     return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l42.41"></a><span id="l42.41"> </span>
<a href="#l42.42"></a><span id="l42.42" class="difflineminus">-  PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::GetSignerEmailAddress\n&quot;));</span>
<a href="#l42.43"></a><span id="l42.43" class="difflineplus">+  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::GetSignerEmailAddress\n&quot;));</span>
<a href="#l42.44"></a><span id="l42.44">   NS_ENSURE_ARG(aEmail);</span>
<a href="#l42.45"></a><span id="l42.45"> </span>
<a href="#l42.46"></a><span id="l42.46">   NSSCMSSignerInfo *si = GetTopLevelSignerInfo();</span>
<a href="#l42.47"></a><span id="l42.47">   if (!si)</span>
<a href="#l42.48"></a><span id="l42.48">     return NS_ERROR_FAILURE;</span>
<a href="#l42.49"></a><span id="l42.49"> </span>
<a href="#l42.50"></a><span id="l42.50">   *aEmail = NSS_CMSSignerInfo_GetSignerEmailAddress(si);</span>
<a href="#l42.51"></a><span id="l42.51">   return NS_OK;</span>
<a href="#l42.52"></a><span id="l42.52"> }</span>
<a href="#l42.53"></a><span id="l42.53"> </span>
<a href="#l42.54"></a><span id="l42.54"> NS_IMETHODIMP nsCMSMessage::GetSignerCommonName(char ** aName)</span>
<a href="#l42.55"></a><span id="l42.55"> {</span>
<a href="#l42.56"></a><span id="l42.56">   nsNSSShutDownPreventionLock locker;</span>
<a href="#l42.57"></a><span id="l42.57">   if (isAlreadyShutDown())</span>
<a href="#l42.58"></a><span id="l42.58">     return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l42.59"></a><span id="l42.59"> </span>
<a href="#l42.60"></a><span id="l42.60" class="difflineminus">-  PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::GetSignerCommonName\n&quot;));</span>
<a href="#l42.61"></a><span id="l42.61" class="difflineplus">+  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::GetSignerCommonName\n&quot;));</span>
<a href="#l42.62"></a><span id="l42.62">   NS_ENSURE_ARG(aName);</span>
<a href="#l42.63"></a><span id="l42.63"> </span>
<a href="#l42.64"></a><span id="l42.64">   NSSCMSSignerInfo *si = GetTopLevelSignerInfo();</span>
<a href="#l42.65"></a><span id="l42.65">   if (!si)</span>
<a href="#l42.66"></a><span id="l42.66">     return NS_ERROR_FAILURE;</span>
<a href="#l42.67"></a><span id="l42.67"> </span>
<a href="#l42.68"></a><span id="l42.68">   *aName = NSS_CMSSignerInfo_GetSignerCommonName(si);</span>
<a href="#l42.69"></a><span id="l42.69">   return NS_OK;</span>
<a href="#l42.70"></a><span id="l42.70"> }</span>
<a href="#l42.71"></a><span id="l42.71"> </span>
<a href="#l42.72"></a><span id="l42.72"> NS_IMETHODIMP nsCMSMessage::ContentIsEncrypted(bool *isEncrypted)</span>
<a href="#l42.73"></a><span id="l42.73"> {</span>
<a href="#l42.74"></a><span id="l42.74">   nsNSSShutDownPreventionLock locker;</span>
<a href="#l42.75"></a><span id="l42.75">   if (isAlreadyShutDown())</span>
<a href="#l42.76"></a><span id="l42.76">     return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l42.77"></a><span id="l42.77"> </span>
<a href="#l42.78"></a><span id="l42.78" class="difflineminus">-  PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::ContentIsEncrypted\n&quot;));</span>
<a href="#l42.79"></a><span id="l42.79" class="difflineplus">+  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::ContentIsEncrypted\n&quot;));</span>
<a href="#l42.80"></a><span id="l42.80">   NS_ENSURE_ARG(isEncrypted);</span>
<a href="#l42.81"></a><span id="l42.81"> </span>
<a href="#l42.82"></a><span id="l42.82">   if (!m_cmsMsg)</span>
<a href="#l42.83"></a><span id="l42.83">     return NS_ERROR_FAILURE;</span>
<a href="#l42.84"></a><span id="l42.84"> </span>
<a href="#l42.85"></a><span id="l42.85">   *isEncrypted = NSS_CMSMessage_IsEncrypted(m_cmsMsg);</span>
<a href="#l42.86"></a><span id="l42.86"> </span>
<a href="#l42.87"></a><span id="l42.87">   return NS_OK;</span>
<a href="#l42.88"></a><span id="l42.88"> }</span>
<a href="#l42.89"></a><span id="l42.89"> </span>
<a href="#l42.90"></a><span id="l42.90"> NS_IMETHODIMP nsCMSMessage::ContentIsSigned(bool *isSigned)</span>
<a href="#l42.91"></a><span id="l42.91"> {</span>
<a href="#l42.92"></a><span id="l42.92">   nsNSSShutDownPreventionLock locker;</span>
<a href="#l42.93"></a><span id="l42.93">   if (isAlreadyShutDown())</span>
<a href="#l42.94"></a><span id="l42.94">     return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l42.95"></a><span id="l42.95"> </span>
<a href="#l42.96"></a><span id="l42.96" class="difflineminus">-  PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::ContentIsSigned\n&quot;));</span>
<a href="#l42.97"></a><span id="l42.97" class="difflineplus">+  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::ContentIsSigned\n&quot;));</span>
<a href="#l42.98"></a><span id="l42.98">   NS_ENSURE_ARG(isSigned);</span>
<a href="#l42.99"></a><span id="l42.99"> </span>
<a href="#l42.100"></a><span id="l42.100">   if (!m_cmsMsg)</span>
<a href="#l42.101"></a><span id="l42.101">     return NS_ERROR_FAILURE;</span>
<a href="#l42.102"></a><span id="l42.102"> </span>
<a href="#l42.103"></a><span id="l42.103">   *isSigned = NSS_CMSMessage_IsSigned(m_cmsMsg);</span>
<a href="#l42.104"></a><span id="l42.104"> </span>
<a href="#l42.105"></a><span id="l42.105">   return NS_OK;</span>
<a href="#l42.106"></a><span id="l42.106" class="difflineat">@@ -180,25 +178,25 @@ NS_IMETHODIMP nsCMSMessage::GetSignerCer</span>
<a href="#l42.107"></a><span id="l42.107">     return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l42.108"></a><span id="l42.108"> </span>
<a href="#l42.109"></a><span id="l42.109">   NSSCMSSignerInfo *si = GetTopLevelSignerInfo();</span>
<a href="#l42.110"></a><span id="l42.110">   if (!si)</span>
<a href="#l42.111"></a><span id="l42.111">     return NS_ERROR_FAILURE;</span>
<a href="#l42.112"></a><span id="l42.112"> </span>
<a href="#l42.113"></a><span id="l42.113">   nsCOMPtr&lt;nsIX509Cert&gt; cert;</span>
<a href="#l42.114"></a><span id="l42.114">   if (si-&gt;cert) {</span>
<a href="#l42.115"></a><span id="l42.115" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::GetSignerCert got signer cert\n&quot;));</span>
<a href="#l42.116"></a><span id="l42.116" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::GetSignerCert got signer cert\n&quot;));</span>
<a href="#l42.117"></a><span id="l42.117"> </span>
<a href="#l42.118"></a><span id="l42.118">     nsCOMPtr&lt;nsIX509CertDB&gt; certdb = do_GetService(NS_X509CERTDB_CONTRACTID);</span>
<a href="#l42.119"></a><span id="l42.119">     certdb-&gt;ConstructX509(reinterpret_cast&lt;const char *&gt;(si-&gt;cert-&gt;derCert.data),</span>
<a href="#l42.120"></a><span id="l42.120">                           si-&gt;cert-&gt;derCert.len,</span>
<a href="#l42.121"></a><span id="l42.121">                           getter_AddRefs(cert));</span>
<a href="#l42.122"></a><span id="l42.122">   }</span>
<a href="#l42.123"></a><span id="l42.123">   else {</span>
<a href="#l42.124"></a><span id="l42.124" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::GetSignerCert no signer cert, do we have a cert list? %s\n&quot;,</span>
<a href="#l42.125"></a><span id="l42.125" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::GetSignerCert no signer cert, do we have a cert list? %s\n&quot;,</span>
<a href="#l42.126"></a><span id="l42.126">       (si-&gt;certList ? &quot;yes&quot; : &quot;no&quot;) ));</span>
<a href="#l42.127"></a><span id="l42.127"> </span>
<a href="#l42.128"></a><span id="l42.128">     *scert = nullptr;</span>
<a href="#l42.129"></a><span id="l42.129">   }</span>
<a href="#l42.130"></a><span id="l42.130"> </span>
<a href="#l42.131"></a><span id="l42.131">   cert.forget(scert);</span>
<a href="#l42.132"></a><span id="l42.132"> </span>
<a href="#l42.133"></a><span id="l42.133">   return NS_OK;</span>
<a href="#l42.134"></a><span id="l42.134" class="difflineat">@@ -222,57 +220,57 @@ NS_IMETHODIMP nsCMSMessage::VerifyDetach</span>
<a href="#l42.135"></a><span id="l42.135"> }</span>
<a href="#l42.136"></a><span id="l42.136"> </span>
<a href="#l42.137"></a><span id="l42.137"> nsresult nsCMSMessage::CommonVerifySignature(unsigned char* aDigestData, uint32_t aDigestDataLen)</span>
<a href="#l42.138"></a><span id="l42.138"> {</span>
<a href="#l42.139"></a><span id="l42.139">   nsNSSShutDownPreventionLock locker;</span>
<a href="#l42.140"></a><span id="l42.140">   if (isAlreadyShutDown())</span>
<a href="#l42.141"></a><span id="l42.141">     return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l42.142"></a><span id="l42.142"> </span>
<a href="#l42.143"></a><span id="l42.143" class="difflineminus">-  PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CommonVerifySignature, content level count %d\n&quot;, NSS_CMSMessage_ContentLevelCount(m_cmsMsg)));</span>
<a href="#l42.144"></a><span id="l42.144" class="difflineplus">+  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CommonVerifySignature, content level count %d\n&quot;, NSS_CMSMessage_ContentLevelCount(m_cmsMsg)));</span>
<a href="#l42.145"></a><span id="l42.145">   NSSCMSContentInfo *cinfo = nullptr;</span>
<a href="#l42.146"></a><span id="l42.146">   NSSCMSSignedData *sigd = nullptr;</span>
<a href="#l42.147"></a><span id="l42.147">   NSSCMSSignerInfo *si;</span>
<a href="#l42.148"></a><span id="l42.148">   int32_t nsigners;</span>
<a href="#l42.149"></a><span id="l42.149">   RefPtr&lt;SharedCertVerifier&gt; certVerifier;</span>
<a href="#l42.150"></a><span id="l42.150">   nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l42.151"></a><span id="l42.151"> </span>
<a href="#l42.152"></a><span id="l42.152">   if (!NSS_CMSMessage_IsSigned(m_cmsMsg)) {</span>
<a href="#l42.153"></a><span id="l42.153" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CommonVerifySignature - not signed\n&quot;));</span>
<a href="#l42.154"></a><span id="l42.154" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CommonVerifySignature - not signed\n&quot;));</span>
<a href="#l42.155"></a><span id="l42.155">     return NS_ERROR_CMS_VERIFY_NOT_SIGNED;</span>
<a href="#l42.156"></a><span id="l42.156">   } </span>
<a href="#l42.157"></a><span id="l42.157"> </span>
<a href="#l42.158"></a><span id="l42.158">   cinfo = NSS_CMSMessage_ContentLevel(m_cmsMsg, 0);</span>
<a href="#l42.159"></a><span id="l42.159">   if (cinfo) {</span>
<a href="#l42.160"></a><span id="l42.160">     // I don't like this hard cast. We should check in some way, that we really have this type.</span>
<a href="#l42.161"></a><span id="l42.161">     sigd = (NSSCMSSignedData*)NSS_CMSContentInfo_GetContent(cinfo);</span>
<a href="#l42.162"></a><span id="l42.162">   }</span>
<a href="#l42.163"></a><span id="l42.163">   </span>
<a href="#l42.164"></a><span id="l42.164">   if (!sigd) {</span>
<a href="#l42.165"></a><span id="l42.165" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CommonVerifySignature - no content info\n&quot;));</span>
<a href="#l42.166"></a><span id="l42.166" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CommonVerifySignature - no content info\n&quot;));</span>
<a href="#l42.167"></a><span id="l42.167">     rv = NS_ERROR_CMS_VERIFY_NO_CONTENT_INFO;</span>
<a href="#l42.168"></a><span id="l42.168">     goto loser;</span>
<a href="#l42.169"></a><span id="l42.169">   }</span>
<a href="#l42.170"></a><span id="l42.170"> </span>
<a href="#l42.171"></a><span id="l42.171">   if (aDigestData &amp;&amp; aDigestDataLen)</span>
<a href="#l42.172"></a><span id="l42.172">   {</span>
<a href="#l42.173"></a><span id="l42.173">     SECItem digest;</span>
<a href="#l42.174"></a><span id="l42.174">     digest.data = aDigestData;</span>
<a href="#l42.175"></a><span id="l42.175">     digest.len = aDigestDataLen;</span>
<a href="#l42.176"></a><span id="l42.176"> </span>
<a href="#l42.177"></a><span id="l42.177">     if (NSS_CMSSignedData_SetDigestValue(sigd, SEC_OID_SHA1, &amp;digest)) {</span>
<a href="#l42.178"></a><span id="l42.178" class="difflineminus">-      PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CommonVerifySignature - bad digest\n&quot;));</span>
<a href="#l42.179"></a><span id="l42.179" class="difflineplus">+      MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CommonVerifySignature - bad digest\n&quot;));</span>
<a href="#l42.180"></a><span id="l42.180">       rv = NS_ERROR_CMS_VERIFY_BAD_DIGEST;</span>
<a href="#l42.181"></a><span id="l42.181">       goto loser;</span>
<a href="#l42.182"></a><span id="l42.182">     }</span>
<a href="#l42.183"></a><span id="l42.183">   }</span>
<a href="#l42.184"></a><span id="l42.184"> </span>
<a href="#l42.185"></a><span id="l42.185">   // Import certs. Note that import failure is not a signature verification failure. //</span>
<a href="#l42.186"></a><span id="l42.186">   if (NSS_CMSSignedData_ImportCerts(sigd, CERT_GetDefaultCertDB(), certUsageEmailRecipient, true) != SECSuccess) {</span>
<a href="#l42.187"></a><span id="l42.187" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CommonVerifySignature - can not import certs\n&quot;));</span>
<a href="#l42.188"></a><span id="l42.188" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CommonVerifySignature - can not import certs\n&quot;));</span>
<a href="#l42.189"></a><span id="l42.189">   }</span>
<a href="#l42.190"></a><span id="l42.190"> </span>
<a href="#l42.191"></a><span id="l42.191">   nsigners = NSS_CMSSignedData_SignerInfoCount(sigd);</span>
<a href="#l42.192"></a><span id="l42.192">   PR_ASSERT(nsigners &gt; 0);</span>
<a href="#l42.193"></a><span id="l42.193">   NS_ENSURE_TRUE(nsigners &gt; 0, NS_ERROR_UNEXPECTED);</span>
<a href="#l42.194"></a><span id="l42.194">   si = NSS_CMSSignedData_GetSignerInfo(sigd, 0);</span>
<a href="#l42.195"></a><span id="l42.195"> </span>
<a href="#l42.196"></a><span id="l42.196">   // See bug 324474. We want to make sure the signing cert is </span>
<a href="#l42.197"></a><span id="l42.197" class="difflineat">@@ -282,75 +280,75 @@ nsresult nsCMSMessage::CommonVerifySigna</span>
<a href="#l42.198"></a><span id="l42.198">   NS_ENSURE_TRUE(certVerifier, NS_ERROR_UNEXPECTED);</span>
<a href="#l42.199"></a><span id="l42.199"> </span>
<a href="#l42.200"></a><span id="l42.200">   {</span>
<a href="#l42.201"></a><span id="l42.201">     SECStatus srv = certVerifier-&gt;VerifyCert(si-&gt;cert,</span>
<a href="#l42.202"></a><span id="l42.202">                                              certificateUsageEmailSigner,</span>
<a href="#l42.203"></a><span id="l42.203">                                              Now(), nullptr /*XXX pinarg*/,</span>
<a href="#l42.204"></a><span id="l42.204">                                              nullptr /*hostname*/);</span>
<a href="#l42.205"></a><span id="l42.205">     if (srv != SECSuccess) {</span>
<a href="#l42.206"></a><span id="l42.206" class="difflineminus">-      PR_LOG(gPIPNSSLog, PR_LOG_DEBUG,</span>
<a href="#l42.207"></a><span id="l42.207" class="difflineplus">+      MOZ_LOG(gPIPNSSLog, LogLevel::Debug,</span>
<a href="#l42.208"></a><span id="l42.208">              (&quot;nsCMSMessage::CommonVerifySignature - signing cert not trusted now\n&quot;));</span>
<a href="#l42.209"></a><span id="l42.209">       rv = NS_ERROR_CMS_VERIFY_UNTRUSTED;</span>
<a href="#l42.210"></a><span id="l42.210">       goto loser;</span>
<a href="#l42.211"></a><span id="l42.211">     }</span>
<a href="#l42.212"></a><span id="l42.212">   }</span>
<a href="#l42.213"></a><span id="l42.213"> </span>
<a href="#l42.214"></a><span id="l42.214">   // We verify the first signer info,  only //</span>
<a href="#l42.215"></a><span id="l42.215">   // XXX: NSS_CMSSignedData_VerifySignerInfo calls CERT_VerifyCert, which</span>
<a href="#l42.216"></a><span id="l42.216">   // requires NSS's certificate verification configuration to be done in</span>
<a href="#l42.217"></a><span id="l42.217">   // order to work well (e.g. honoring OCSP preferences and proxy settings</span>
<a href="#l42.218"></a><span id="l42.218">   // for OCSP requests), but Gecko stopped doing that configuration. Something</span>
<a href="#l42.219"></a><span id="l42.219">   // similar to what was done for Gecko bug 1028643 needs to be done here too.</span>
<a href="#l42.220"></a><span id="l42.220">   if (NSS_CMSSignedData_VerifySignerInfo(sigd, 0, CERT_GetDefaultCertDB(), certUsageEmailSigner) != SECSuccess) {</span>
<a href="#l42.221"></a><span id="l42.221" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CommonVerifySignature - unable to verify signature\n&quot;));</span>
<a href="#l42.222"></a><span id="l42.222" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CommonVerifySignature - unable to verify signature\n&quot;));</span>
<a href="#l42.223"></a><span id="l42.223"> </span>
<a href="#l42.224"></a><span id="l42.224">     if (NSSCMSVS_SigningCertNotFound == si-&gt;verificationStatus) {</span>
<a href="#l42.225"></a><span id="l42.225" class="difflineminus">-      PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CommonVerifySignature - signing cert not found\n&quot;));</span>
<a href="#l42.226"></a><span id="l42.226" class="difflineplus">+      MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CommonVerifySignature - signing cert not found\n&quot;));</span>
<a href="#l42.227"></a><span id="l42.227">       rv = NS_ERROR_CMS_VERIFY_NOCERT;</span>
<a href="#l42.228"></a><span id="l42.228">     }</span>
<a href="#l42.229"></a><span id="l42.229">     else if(NSSCMSVS_SigningCertNotTrusted == si-&gt;verificationStatus) {</span>
<a href="#l42.230"></a><span id="l42.230" class="difflineminus">-      PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CommonVerifySignature - signing cert not trusted at signing time\n&quot;));</span>
<a href="#l42.231"></a><span id="l42.231" class="difflineplus">+      MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CommonVerifySignature - signing cert not trusted at signing time\n&quot;));</span>
<a href="#l42.232"></a><span id="l42.232">       rv = NS_ERROR_CMS_VERIFY_UNTRUSTED;</span>
<a href="#l42.233"></a><span id="l42.233">     }</span>
<a href="#l42.234"></a><span id="l42.234">     else if(NSSCMSVS_Unverified == si-&gt;verificationStatus) {</span>
<a href="#l42.235"></a><span id="l42.235" class="difflineminus">-      PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CommonVerifySignature - can not verify\n&quot;));</span>
<a href="#l42.236"></a><span id="l42.236" class="difflineplus">+      MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CommonVerifySignature - can not verify\n&quot;));</span>
<a href="#l42.237"></a><span id="l42.237">       rv = NS_ERROR_CMS_VERIFY_ERROR_UNVERIFIED;</span>
<a href="#l42.238"></a><span id="l42.238">     }</span>
<a href="#l42.239"></a><span id="l42.239">     else if(NSSCMSVS_ProcessingError == si-&gt;verificationStatus) {</span>
<a href="#l42.240"></a><span id="l42.240" class="difflineminus">-      PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CommonVerifySignature - processing error\n&quot;));</span>
<a href="#l42.241"></a><span id="l42.241" class="difflineplus">+      MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CommonVerifySignature - processing error\n&quot;));</span>
<a href="#l42.242"></a><span id="l42.242">       rv = NS_ERROR_CMS_VERIFY_ERROR_PROCESSING;</span>
<a href="#l42.243"></a><span id="l42.243">     }</span>
<a href="#l42.244"></a><span id="l42.244">     else if(NSSCMSVS_BadSignature == si-&gt;verificationStatus) {</span>
<a href="#l42.245"></a><span id="l42.245" class="difflineminus">-      PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CommonVerifySignature - bad signature\n&quot;));</span>
<a href="#l42.246"></a><span id="l42.246" class="difflineplus">+      MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CommonVerifySignature - bad signature\n&quot;));</span>
<a href="#l42.247"></a><span id="l42.247">       rv = NS_ERROR_CMS_VERIFY_BAD_SIGNATURE;</span>
<a href="#l42.248"></a><span id="l42.248">     }</span>
<a href="#l42.249"></a><span id="l42.249">     else if(NSSCMSVS_DigestMismatch == si-&gt;verificationStatus) {</span>
<a href="#l42.250"></a><span id="l42.250" class="difflineminus">-      PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CommonVerifySignature - digest mismatch\n&quot;));</span>
<a href="#l42.251"></a><span id="l42.251" class="difflineplus">+      MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CommonVerifySignature - digest mismatch\n&quot;));</span>
<a href="#l42.252"></a><span id="l42.252">       rv = NS_ERROR_CMS_VERIFY_DIGEST_MISMATCH;</span>
<a href="#l42.253"></a><span id="l42.253">     }</span>
<a href="#l42.254"></a><span id="l42.254">     else if(NSSCMSVS_SignatureAlgorithmUnknown == si-&gt;verificationStatus) {</span>
<a href="#l42.255"></a><span id="l42.255" class="difflineminus">-      PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CommonVerifySignature - algo unknown\n&quot;));</span>
<a href="#l42.256"></a><span id="l42.256" class="difflineplus">+      MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CommonVerifySignature - algo unknown\n&quot;));</span>
<a href="#l42.257"></a><span id="l42.257">       rv = NS_ERROR_CMS_VERIFY_UNKNOWN_ALGO;</span>
<a href="#l42.258"></a><span id="l42.258">     }</span>
<a href="#l42.259"></a><span id="l42.259">     else if(NSSCMSVS_SignatureAlgorithmUnsupported == si-&gt;verificationStatus) {</span>
<a href="#l42.260"></a><span id="l42.260" class="difflineminus">-      PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CommonVerifySignature - algo not supported\n&quot;));</span>
<a href="#l42.261"></a><span id="l42.261" class="difflineplus">+      MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CommonVerifySignature - algo not supported\n&quot;));</span>
<a href="#l42.262"></a><span id="l42.262">       rv = NS_ERROR_CMS_VERIFY_UNSUPPORTED_ALGO;</span>
<a href="#l42.263"></a><span id="l42.263">     }</span>
<a href="#l42.264"></a><span id="l42.264">     else if(NSSCMSVS_MalformedSignature == si-&gt;verificationStatus) {</span>
<a href="#l42.265"></a><span id="l42.265" class="difflineminus">-      PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CommonVerifySignature - malformed signature\n&quot;));</span>
<a href="#l42.266"></a><span id="l42.266" class="difflineplus">+      MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CommonVerifySignature - malformed signature\n&quot;));</span>
<a href="#l42.267"></a><span id="l42.267">       rv = NS_ERROR_CMS_VERIFY_MALFORMED_SIGNATURE;</span>
<a href="#l42.268"></a><span id="l42.268">     }</span>
<a href="#l42.269"></a><span id="l42.269"> </span>
<a href="#l42.270"></a><span id="l42.270">     goto loser;</span>
<a href="#l42.271"></a><span id="l42.271">   }</span>
<a href="#l42.272"></a><span id="l42.272"> </span>
<a href="#l42.273"></a><span id="l42.273">   // Save the profile. Note that save import failure is not a signature verification failure. //</span>
<a href="#l42.274"></a><span id="l42.274">   if (NSS_SMIMESignerInfo_SaveSMIMEProfile(si) != SECSuccess) {</span>
<a href="#l42.275"></a><span id="l42.275" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CommonVerifySignature - unable to save smime profile\n&quot;));</span>
<a href="#l42.276"></a><span id="l42.276" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CommonVerifySignature - unable to save smime profile\n&quot;));</span>
<a href="#l42.277"></a><span id="l42.277">   }</span>
<a href="#l42.278"></a><span id="l42.278"> </span>
<a href="#l42.279"></a><span id="l42.279">   rv = NS_OK;</span>
<a href="#l42.280"></a><span id="l42.280"> loser:</span>
<a href="#l42.281"></a><span id="l42.281">   return rv;</span>
<a href="#l42.282"></a><span id="l42.282"> }</span>
<a href="#l42.283"></a><span id="l42.283"> </span>
<a href="#l42.284"></a><span id="l42.284"> NS_IMETHODIMP nsCMSMessage::AsyncVerifySignature(</span>
<a href="#l42.285"></a><span id="l42.285" class="difflineat">@@ -530,17 +528,17 @@ private:</span>
<a href="#l42.286"></a><span id="l42.286"> };</span>
<a href="#l42.287"></a><span id="l42.287"> </span>
<a href="#l42.288"></a><span id="l42.288"> NS_IMETHODIMP nsCMSMessage::CreateEncrypted(nsIArray * aRecipientCerts)</span>
<a href="#l42.289"></a><span id="l42.289"> {</span>
<a href="#l42.290"></a><span id="l42.290">   nsNSSShutDownPreventionLock locker;</span>
<a href="#l42.291"></a><span id="l42.291">   if (isAlreadyShutDown())</span>
<a href="#l42.292"></a><span id="l42.292">     return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l42.293"></a><span id="l42.293"> </span>
<a href="#l42.294"></a><span id="l42.294" class="difflineminus">-  PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CreateEncrypted\n&quot;));</span>
<a href="#l42.295"></a><span id="l42.295" class="difflineplus">+  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateEncrypted\n&quot;));</span>
<a href="#l42.296"></a><span id="l42.296">   NSSCMSContentInfo *cinfo;</span>
<a href="#l42.297"></a><span id="l42.297">   NSSCMSEnvelopedData *envd;</span>
<a href="#l42.298"></a><span id="l42.298">   NSSCMSRecipientInfo *recipientInfo;</span>
<a href="#l42.299"></a><span id="l42.299">   nsZeroTerminatedCertArray recipientCerts;</span>
<a href="#l42.300"></a><span id="l42.300">   SECOidTag bulkAlgTag;</span>
<a href="#l42.301"></a><span id="l42.301">   int keySize;</span>
<a href="#l42.302"></a><span id="l42.302">   uint32_t i;</span>
<a href="#l42.303"></a><span id="l42.303">   nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l42.304"></a><span id="l42.304" class="difflineat">@@ -562,54 +560,54 @@ NS_IMETHODIMP nsCMSMessage::CreateEncryp</span>
<a href="#l42.305"></a><span id="l42.305"> </span>
<a href="#l42.306"></a><span id="l42.306">     mozilla::ScopedCERTCertificate c(x509cert-&gt;GetCert());</span>
<a href="#l42.307"></a><span id="l42.307">     recipientCerts.set(i, c.get());</span>
<a href="#l42.308"></a><span id="l42.308">   }</span>
<a href="#l42.309"></a><span id="l42.309">   </span>
<a href="#l42.310"></a><span id="l42.310">   // Find a bulk key algorithm //</span>
<a href="#l42.311"></a><span id="l42.311">   if (NSS_SMIMEUtil_FindBulkAlgForRecipients(recipientCerts.getRawArray(), &amp;bulkAlgTag,</span>
<a href="#l42.312"></a><span id="l42.312">                                             &amp;keySize) != SECSuccess) {</span>
<a href="#l42.313"></a><span id="l42.313" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CreateEncrypted - can't find bulk alg for recipients\n&quot;));</span>
<a href="#l42.314"></a><span id="l42.314" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateEncrypted - can't find bulk alg for recipients\n&quot;));</span>
<a href="#l42.315"></a><span id="l42.315">     rv = NS_ERROR_CMS_ENCRYPT_NO_BULK_ALG;</span>
<a href="#l42.316"></a><span id="l42.316">     goto loser;</span>
<a href="#l42.317"></a><span id="l42.317">   }</span>
<a href="#l42.318"></a><span id="l42.318"> </span>
<a href="#l42.319"></a><span id="l42.319">   m_cmsMsg = NSS_CMSMessage_Create(nullptr);</span>
<a href="#l42.320"></a><span id="l42.320">   if (!m_cmsMsg) {</span>
<a href="#l42.321"></a><span id="l42.321" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CreateEncrypted - can't create new cms message\n&quot;));</span>
<a href="#l42.322"></a><span id="l42.322" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateEncrypted - can't create new cms message\n&quot;));</span>
<a href="#l42.323"></a><span id="l42.323">     rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l42.324"></a><span id="l42.324">     goto loser;</span>
<a href="#l42.325"></a><span id="l42.325">   }</span>
<a href="#l42.326"></a><span id="l42.326"> </span>
<a href="#l42.327"></a><span id="l42.327">   if ((envd = NSS_CMSEnvelopedData_Create(m_cmsMsg, bulkAlgTag, keySize)) == nullptr) {</span>
<a href="#l42.328"></a><span id="l42.328" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CreateEncrypted - can't create enveloped data\n&quot;));</span>
<a href="#l42.329"></a><span id="l42.329" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateEncrypted - can't create enveloped data\n&quot;));</span>
<a href="#l42.330"></a><span id="l42.330">     goto loser;</span>
<a href="#l42.331"></a><span id="l42.331">   }</span>
<a href="#l42.332"></a><span id="l42.332"> </span>
<a href="#l42.333"></a><span id="l42.333">   cinfo = NSS_CMSMessage_GetContentInfo(m_cmsMsg);</span>
<a href="#l42.334"></a><span id="l42.334">   if (NSS_CMSContentInfo_SetContent_EnvelopedData(m_cmsMsg, cinfo, envd) != SECSuccess) {</span>
<a href="#l42.335"></a><span id="l42.335" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CreateEncrypted - can't create content enveloped data\n&quot;));</span>
<a href="#l42.336"></a><span id="l42.336" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateEncrypted - can't create content enveloped data\n&quot;));</span>
<a href="#l42.337"></a><span id="l42.337">     goto loser;</span>
<a href="#l42.338"></a><span id="l42.338">   }</span>
<a href="#l42.339"></a><span id="l42.339"> </span>
<a href="#l42.340"></a><span id="l42.340">   cinfo = NSS_CMSEnvelopedData_GetContentInfo(envd);</span>
<a href="#l42.341"></a><span id="l42.341">   if (NSS_CMSContentInfo_SetContent_Data(m_cmsMsg, cinfo, nullptr, false) != SECSuccess) {</span>
<a href="#l42.342"></a><span id="l42.342" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CreateEncrypted - can't set content data\n&quot;));</span>
<a href="#l42.343"></a><span id="l42.343" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateEncrypted - can't set content data\n&quot;));</span>
<a href="#l42.344"></a><span id="l42.344">     goto loser;</span>
<a href="#l42.345"></a><span id="l42.345">   }</span>
<a href="#l42.346"></a><span id="l42.346"> </span>
<a href="#l42.347"></a><span id="l42.347">   // Create and attach recipient information //</span>
<a href="#l42.348"></a><span id="l42.348">   for (i=0; i &lt; recipientCertCount; i++) {</span>
<a href="#l42.349"></a><span id="l42.349">     mozilla::ScopedCERTCertificate rc(recipientCerts.get(i));</span>
<a href="#l42.350"></a><span id="l42.350">     if ((recipientInfo = NSS_CMSRecipientInfo_Create(m_cmsMsg, rc.get())) == nullptr) {</span>
<a href="#l42.351"></a><span id="l42.351" class="difflineminus">-      PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CreateEncrypted - can't create recipient info\n&quot;));</span>
<a href="#l42.352"></a><span id="l42.352" class="difflineplus">+      MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateEncrypted - can't create recipient info\n&quot;));</span>
<a href="#l42.353"></a><span id="l42.353">       goto loser;</span>
<a href="#l42.354"></a><span id="l42.354">     }</span>
<a href="#l42.355"></a><span id="l42.355">     if (NSS_CMSEnvelopedData_AddRecipient(envd, recipientInfo) != SECSuccess) {</span>
<a href="#l42.356"></a><span id="l42.356" class="difflineminus">-      PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CreateEncrypted - can't add recipient info\n&quot;));</span>
<a href="#l42.357"></a><span id="l42.357" class="difflineplus">+      MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateEncrypted - can't add recipient info\n&quot;));</span>
<a href="#l42.358"></a><span id="l42.358">       goto loser;</span>
<a href="#l42.359"></a><span id="l42.359">     }</span>
<a href="#l42.360"></a><span id="l42.360">   }</span>
<a href="#l42.361"></a><span id="l42.361"> </span>
<a href="#l42.362"></a><span id="l42.362">   return NS_OK;</span>
<a href="#l42.363"></a><span id="l42.363"> loser:</span>
<a href="#l42.364"></a><span id="l42.364">   if (m_cmsMsg) {</span>
<a href="#l42.365"></a><span id="l42.365">     NSS_CMSMessage_Destroy(m_cmsMsg);</span>
<a href="#l42.366"></a><span id="l42.366" class="difflineat">@@ -624,17 +622,17 @@ nsCMSMessage::CreateSigned(nsIX509Cert* </span>
<a href="#l42.367"></a><span id="l42.367">                            unsigned char* aDigestData, uint32_t aDigestDataLen,</span>
<a href="#l42.368"></a><span id="l42.368">                            int16_t aDigestType)</span>
<a href="#l42.369"></a><span id="l42.369"> {</span>
<a href="#l42.370"></a><span id="l42.370">   NS_ENSURE_ARG(aSigningCert);</span>
<a href="#l42.371"></a><span id="l42.371">   nsNSSShutDownPreventionLock locker;</span>
<a href="#l42.372"></a><span id="l42.372">   if (isAlreadyShutDown())</span>
<a href="#l42.373"></a><span id="l42.373">     return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l42.374"></a><span id="l42.374"> </span>
<a href="#l42.375"></a><span id="l42.375" class="difflineminus">-  PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CreateSigned\n&quot;));</span>
<a href="#l42.376"></a><span id="l42.376" class="difflineplus">+  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateSigned\n&quot;));</span>
<a href="#l42.377"></a><span id="l42.377">   NSSCMSContentInfo *cinfo;</span>
<a href="#l42.378"></a><span id="l42.378">   NSSCMSSignedData *sigd;</span>
<a href="#l42.379"></a><span id="l42.379">   NSSCMSSignerInfo *signerinfo;</span>
<a href="#l42.380"></a><span id="l42.380">   mozilla::ScopedCERTCertificate scert(aSigningCert-&gt;GetCert());</span>
<a href="#l42.381"></a><span id="l42.381">   mozilla::ScopedCERTCertificate ecert;</span>
<a href="#l42.382"></a><span id="l42.382">   nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l42.383"></a><span id="l42.383"> </span>
<a href="#l42.384"></a><span id="l42.384">   if (!scert) {</span>
<a href="#l42.385"></a><span id="l42.385" class="difflineat">@@ -663,112 +661,112 @@ nsCMSMessage::CreateSigned(nsIX509Cert* </span>
<a href="#l42.386"></a><span id="l42.386">       return NS_ERROR_INVALID_ARG;</span>
<a href="#l42.387"></a><span id="l42.387">   }</span>
<a href="#l42.388"></a><span id="l42.388"> </span>
<a href="#l42.389"></a><span id="l42.389">   /*</span>
<a href="#l42.390"></a><span id="l42.390">    * create the message object</span>
<a href="#l42.391"></a><span id="l42.391">    */</span>
<a href="#l42.392"></a><span id="l42.392">   m_cmsMsg = NSS_CMSMessage_Create(nullptr); /* create a message on its own pool */</span>
<a href="#l42.393"></a><span id="l42.393">   if (!m_cmsMsg) {</span>
<a href="#l42.394"></a><span id="l42.394" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CreateSigned - can't create new message\n&quot;));</span>
<a href="#l42.395"></a><span id="l42.395" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateSigned - can't create new message\n&quot;));</span>
<a href="#l42.396"></a><span id="l42.396">     rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l42.397"></a><span id="l42.397">     goto loser;</span>
<a href="#l42.398"></a><span id="l42.398">   }</span>
<a href="#l42.399"></a><span id="l42.399"> </span>
<a href="#l42.400"></a><span id="l42.400">   /*</span>
<a href="#l42.401"></a><span id="l42.401">    * build chain of objects: message-&gt;signedData-&gt;data</span>
<a href="#l42.402"></a><span id="l42.402">    */</span>
<a href="#l42.403"></a><span id="l42.403">   if ((sigd = NSS_CMSSignedData_Create(m_cmsMsg)) == nullptr) {</span>
<a href="#l42.404"></a><span id="l42.404" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CreateSigned - can't create signed data\n&quot;));</span>
<a href="#l42.405"></a><span id="l42.405" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateSigned - can't create signed data\n&quot;));</span>
<a href="#l42.406"></a><span id="l42.406">     goto loser;</span>
<a href="#l42.407"></a><span id="l42.407">   }</span>
<a href="#l42.408"></a><span id="l42.408">   cinfo = NSS_CMSMessage_GetContentInfo(m_cmsMsg);</span>
<a href="#l42.409"></a><span id="l42.409">   if (NSS_CMSContentInfo_SetContent_SignedData(m_cmsMsg, cinfo, sigd) </span>
<a href="#l42.410"></a><span id="l42.410">           != SECSuccess) {</span>
<a href="#l42.411"></a><span id="l42.411" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CreateSigned - can't set content signed data\n&quot;));</span>
<a href="#l42.412"></a><span id="l42.412" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateSigned - can't set content signed data\n&quot;));</span>
<a href="#l42.413"></a><span id="l42.413">     goto loser;</span>
<a href="#l42.414"></a><span id="l42.414">   }</span>
<a href="#l42.415"></a><span id="l42.415"> </span>
<a href="#l42.416"></a><span id="l42.416">   cinfo = NSS_CMSSignedData_GetContentInfo(sigd);</span>
<a href="#l42.417"></a><span id="l42.417"> </span>
<a href="#l42.418"></a><span id="l42.418">   /* we're always passing data in and detaching optionally */</span>
<a href="#l42.419"></a><span id="l42.419">   if (NSS_CMSContentInfo_SetContent_Data(m_cmsMsg, cinfo, nullptr, true) </span>
<a href="#l42.420"></a><span id="l42.420">           != SECSuccess) {</span>
<a href="#l42.421"></a><span id="l42.421" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CreateSigned - can't set content data\n&quot;));</span>
<a href="#l42.422"></a><span id="l42.422" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateSigned - can't set content data\n&quot;));</span>
<a href="#l42.423"></a><span id="l42.423">     goto loser;</span>
<a href="#l42.424"></a><span id="l42.424">   }</span>
<a href="#l42.425"></a><span id="l42.425"> </span>
<a href="#l42.426"></a><span id="l42.426">   /* </span>
<a href="#l42.427"></a><span id="l42.427">    * create &amp; attach signer information</span>
<a href="#l42.428"></a><span id="l42.428">    */</span>
<a href="#l42.429"></a><span id="l42.429">   signerinfo = NSS_CMSSignerInfo_Create(m_cmsMsg, scert.get(), digestType);</span>
<a href="#l42.430"></a><span id="l42.430">   if (!signerinfo) {</span>
<a href="#l42.431"></a><span id="l42.431" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CreateSigned - can't create signer info\n&quot;));</span>
<a href="#l42.432"></a><span id="l42.432" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateSigned - can't create signer info\n&quot;));</span>
<a href="#l42.433"></a><span id="l42.433">     goto loser;</span>
<a href="#l42.434"></a><span id="l42.434">   }</span>
<a href="#l42.435"></a><span id="l42.435"> </span>
<a href="#l42.436"></a><span id="l42.436">   /* we want the cert chain included for this one */</span>
<a href="#l42.437"></a><span id="l42.437">   if (NSS_CMSSignerInfo_IncludeCerts(signerinfo, NSSCMSCM_CertChain, </span>
<a href="#l42.438"></a><span id="l42.438">                                        certUsageEmailSigner) </span>
<a href="#l42.439"></a><span id="l42.439">           != SECSuccess) {</span>
<a href="#l42.440"></a><span id="l42.440" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CreateSigned - can't include signer cert chain\n&quot;));</span>
<a href="#l42.441"></a><span id="l42.441" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateSigned - can't include signer cert chain\n&quot;));</span>
<a href="#l42.442"></a><span id="l42.442">     goto loser;</span>
<a href="#l42.443"></a><span id="l42.443">   }</span>
<a href="#l42.444"></a><span id="l42.444"> </span>
<a href="#l42.445"></a><span id="l42.445">   if (NSS_CMSSignerInfo_AddSigningTime(signerinfo, PR_Now()) </span>
<a href="#l42.446"></a><span id="l42.446"> 	      != SECSuccess) {</span>
<a href="#l42.447"></a><span id="l42.447" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CreateSigned - can't add signing time\n&quot;));</span>
<a href="#l42.448"></a><span id="l42.448" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateSigned - can't add signing time\n&quot;));</span>
<a href="#l42.449"></a><span id="l42.449">     goto loser;</span>
<a href="#l42.450"></a><span id="l42.450">   }</span>
<a href="#l42.451"></a><span id="l42.451"> </span>
<a href="#l42.452"></a><span id="l42.452">   if (NSS_CMSSignerInfo_AddSMIMECaps(signerinfo) != SECSuccess) {</span>
<a href="#l42.453"></a><span id="l42.453" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CreateSigned - can't add smime caps\n&quot;));</span>
<a href="#l42.454"></a><span id="l42.454" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateSigned - can't add smime caps\n&quot;));</span>
<a href="#l42.455"></a><span id="l42.455">     goto loser;</span>
<a href="#l42.456"></a><span id="l42.456">   }</span>
<a href="#l42.457"></a><span id="l42.457"> </span>
<a href="#l42.458"></a><span id="l42.458">   if (ecert) {</span>
<a href="#l42.459"></a><span id="l42.459">     if (NSS_CMSSignerInfo_AddSMIMEEncKeyPrefs(signerinfo, ecert.get(),</span>
<a href="#l42.460"></a><span id="l42.460"> 	                                      CERT_GetDefaultCertDB())</span>
<a href="#l42.461"></a><span id="l42.461"> 	  != SECSuccess) {</span>
<a href="#l42.462"></a><span id="l42.462" class="difflineminus">-      PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CreateSigned - can't add smime enc key prefs\n&quot;));</span>
<a href="#l42.463"></a><span id="l42.463" class="difflineplus">+      MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateSigned - can't add smime enc key prefs\n&quot;));</span>
<a href="#l42.464"></a><span id="l42.464">       goto loser;</span>
<a href="#l42.465"></a><span id="l42.465">     }</span>
<a href="#l42.466"></a><span id="l42.466"> </span>
<a href="#l42.467"></a><span id="l42.467">     if (NSS_CMSSignerInfo_AddMSSMIMEEncKeyPrefs(signerinfo, ecert.get(),</span>
<a href="#l42.468"></a><span id="l42.468"> 	                                        CERT_GetDefaultCertDB())</span>
<a href="#l42.469"></a><span id="l42.469"> 	  != SECSuccess) {</span>
<a href="#l42.470"></a><span id="l42.470" class="difflineminus">-      PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CreateSigned - can't add MS smime enc key prefs\n&quot;));</span>
<a href="#l42.471"></a><span id="l42.471" class="difflineplus">+      MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateSigned - can't add MS smime enc key prefs\n&quot;));</span>
<a href="#l42.472"></a><span id="l42.472">       goto loser;</span>
<a href="#l42.473"></a><span id="l42.473">     }</span>
<a href="#l42.474"></a><span id="l42.474"> </span>
<a href="#l42.475"></a><span id="l42.475">     // If signing and encryption cert are identical, don't add it twice.</span>
<a href="#l42.476"></a><span id="l42.476">     bool addEncryptionCert =</span>
<a href="#l42.477"></a><span id="l42.477">       (ecert &amp;&amp; (!scert || !CERT_CompareCerts(ecert.get(), scert.get())));</span>
<a href="#l42.478"></a><span id="l42.478"> </span>
<a href="#l42.479"></a><span id="l42.479">     if (addEncryptionCert &amp;&amp;</span>
<a href="#l42.480"></a><span id="l42.480">         NSS_CMSSignedData_AddCertificate(sigd, ecert.get()) != SECSuccess) {</span>
<a href="#l42.481"></a><span id="l42.481" class="difflineminus">-      PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CreateSigned - can't add own encryption certificate\n&quot;));</span>
<a href="#l42.482"></a><span id="l42.482" class="difflineplus">+      MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateSigned - can't add own encryption certificate\n&quot;));</span>
<a href="#l42.483"></a><span id="l42.483">       goto loser;</span>
<a href="#l42.484"></a><span id="l42.484">     }</span>
<a href="#l42.485"></a><span id="l42.485">   }</span>
<a href="#l42.486"></a><span id="l42.486"> </span>
<a href="#l42.487"></a><span id="l42.487">   if (NSS_CMSSignedData_AddSignerInfo(sigd, signerinfo) != SECSuccess) {</span>
<a href="#l42.488"></a><span id="l42.488" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CreateSigned - can't add signer info\n&quot;));</span>
<a href="#l42.489"></a><span id="l42.489" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateSigned - can't add signer info\n&quot;));</span>
<a href="#l42.490"></a><span id="l42.490">     goto loser;</span>
<a href="#l42.491"></a><span id="l42.491">   }</span>
<a href="#l42.492"></a><span id="l42.492"> </span>
<a href="#l42.493"></a><span id="l42.493">   // Finally, add the pre-computed digest if passed in</span>
<a href="#l42.494"></a><span id="l42.494">   if (aDigestData) {</span>
<a href="#l42.495"></a><span id="l42.495">     SECItem digest;</span>
<a href="#l42.496"></a><span id="l42.496"> </span>
<a href="#l42.497"></a><span id="l42.497">     digest.data = aDigestData;</span>
<a href="#l42.498"></a><span id="l42.498">     digest.len = aDigestDataLen;</span>
<a href="#l42.499"></a><span id="l42.499"> </span>
<a href="#l42.500"></a><span id="l42.500">     if (NSS_CMSSignedData_SetDigestValue(sigd, digestType, &amp;digest) != SECSuccess) {</span>
<a href="#l42.501"></a><span id="l42.501" class="difflineminus">-      PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSMessage::CreateSigned - can't set digest value\n&quot;));</span>
<a href="#l42.502"></a><span id="l42.502" class="difflineplus">+      MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateSigned - can't set digest value\n&quot;));</span>
<a href="#l42.503"></a><span id="l42.503">       goto loser;</span>
<a href="#l42.504"></a><span id="l42.504">     }</span>
<a href="#l42.505"></a><span id="l42.505">   }</span>
<a href="#l42.506"></a><span id="l42.506"> </span>
<a href="#l42.507"></a><span id="l42.507">   return NS_OK;</span>
<a href="#l42.508"></a><span id="l42.508"> loser:</span>
<a href="#l42.509"></a><span id="l42.509">   if (m_cmsMsg) {</span>
<a href="#l42.510"></a><span id="l42.510">     NSS_CMSMessage_Destroy(m_cmsMsg);</span>
<a href="#l42.511"></a><span id="l42.511" class="difflineat">@@ -816,47 +814,47 @@ void nsCMSDecoder::destructorSafeDestroy</span>
<a href="#l42.512"></a><span id="l42.512"> </span>
<a href="#l42.513"></a><span id="l42.513"> /* void start (in NSSCMSContentCallback cb, in voidPtr arg); */</span>
<a href="#l42.514"></a><span id="l42.514"> NS_IMETHODIMP nsCMSDecoder::Start(NSSCMSContentCallback cb, void * arg)</span>
<a href="#l42.515"></a><span id="l42.515"> {</span>
<a href="#l42.516"></a><span id="l42.516">   nsNSSShutDownPreventionLock locker;</span>
<a href="#l42.517"></a><span id="l42.517">   if (isAlreadyShutDown())</span>
<a href="#l42.518"></a><span id="l42.518">     return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l42.519"></a><span id="l42.519"> </span>
<a href="#l42.520"></a><span id="l42.520" class="difflineminus">-  PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSDecoder::Start\n&quot;));</span>
<a href="#l42.521"></a><span id="l42.521" class="difflineplus">+  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSDecoder::Start\n&quot;));</span>
<a href="#l42.522"></a><span id="l42.522">   m_ctx = new PipUIContext();</span>
<a href="#l42.523"></a><span id="l42.523"> </span>
<a href="#l42.524"></a><span id="l42.524">   m_dcx = NSS_CMSDecoder_Start(0, cb, arg, 0, m_ctx, 0, 0);</span>
<a href="#l42.525"></a><span id="l42.525">   if (!m_dcx) {</span>
<a href="#l42.526"></a><span id="l42.526" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSDecoder::Start - can't start decoder\n&quot;));</span>
<a href="#l42.527"></a><span id="l42.527" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSDecoder::Start - can't start decoder\n&quot;));</span>
<a href="#l42.528"></a><span id="l42.528">     return NS_ERROR_FAILURE;</span>
<a href="#l42.529"></a><span id="l42.529">   }</span>
<a href="#l42.530"></a><span id="l42.530">   return NS_OK;</span>
<a href="#l42.531"></a><span id="l42.531"> }</span>
<a href="#l42.532"></a><span id="l42.532"> </span>
<a href="#l42.533"></a><span id="l42.533"> /* void update (in string bug, in long len); */</span>
<a href="#l42.534"></a><span id="l42.534"> NS_IMETHODIMP nsCMSDecoder::Update(const char *buf, int32_t len)</span>
<a href="#l42.535"></a><span id="l42.535"> {</span>
<a href="#l42.536"></a><span id="l42.536">   nsNSSShutDownPreventionLock locker;</span>
<a href="#l42.537"></a><span id="l42.537">   if (isAlreadyShutDown())</span>
<a href="#l42.538"></a><span id="l42.538">     return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l42.539"></a><span id="l42.539"> </span>
<a href="#l42.540"></a><span id="l42.540" class="difflineminus">-  PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSDecoder::Update\n&quot;));</span>
<a href="#l42.541"></a><span id="l42.541" class="difflineplus">+  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSDecoder::Update\n&quot;));</span>
<a href="#l42.542"></a><span id="l42.542">   NSS_CMSDecoder_Update(m_dcx, (char *)buf, len);</span>
<a href="#l42.543"></a><span id="l42.543">   return NS_OK;</span>
<a href="#l42.544"></a><span id="l42.544"> }</span>
<a href="#l42.545"></a><span id="l42.545"> </span>
<a href="#l42.546"></a><span id="l42.546"> /* void finish (); */</span>
<a href="#l42.547"></a><span id="l42.547"> NS_IMETHODIMP nsCMSDecoder::Finish(nsICMSMessage ** aCMSMsg)</span>
<a href="#l42.548"></a><span id="l42.548"> {</span>
<a href="#l42.549"></a><span id="l42.549">   nsNSSShutDownPreventionLock locker;</span>
<a href="#l42.550"></a><span id="l42.550">   if (isAlreadyShutDown())</span>
<a href="#l42.551"></a><span id="l42.551">     return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l42.552"></a><span id="l42.552"> </span>
<a href="#l42.553"></a><span id="l42.553" class="difflineminus">-  PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSDecoder::Finish\n&quot;));</span>
<a href="#l42.554"></a><span id="l42.554" class="difflineplus">+  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSDecoder::Finish\n&quot;));</span>
<a href="#l42.555"></a><span id="l42.555">   NSSCMSMessage *cmsMsg;</span>
<a href="#l42.556"></a><span id="l42.556">   cmsMsg = NSS_CMSDecoder_Finish(m_dcx);</span>
<a href="#l42.557"></a><span id="l42.557">   m_dcx = nullptr;</span>
<a href="#l42.558"></a><span id="l42.558">   if (cmsMsg) {</span>
<a href="#l42.559"></a><span id="l42.559">     nsCMSMessage *obj = new nsCMSMessage(cmsMsg);</span>
<a href="#l42.560"></a><span id="l42.560">     // The NSS object cmsMsg still carries a reference to the context</span>
<a href="#l42.561"></a><span id="l42.561">     // we gave it on construction.</span>
<a href="#l42.562"></a><span id="l42.562">     // Make sure the context will live long enough.</span>
<a href="#l42.563"></a><span id="l42.563" class="difflineat">@@ -904,62 +902,62 @@ void nsCMSEncoder::destructorSafeDestroy</span>
<a href="#l42.564"></a><span id="l42.564"> </span>
<a href="#l42.565"></a><span id="l42.565"> /* void start (); */</span>
<a href="#l42.566"></a><span id="l42.566"> NS_IMETHODIMP nsCMSEncoder::Start(nsICMSMessage *aMsg, NSSCMSContentCallback cb, void * arg)</span>
<a href="#l42.567"></a><span id="l42.567"> {</span>
<a href="#l42.568"></a><span id="l42.568">   nsNSSShutDownPreventionLock locker;</span>
<a href="#l42.569"></a><span id="l42.569">   if (isAlreadyShutDown())</span>
<a href="#l42.570"></a><span id="l42.570">     return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l42.571"></a><span id="l42.571"> </span>
<a href="#l42.572"></a><span id="l42.572" class="difflineminus">-  PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSEncoder::Start\n&quot;));</span>
<a href="#l42.573"></a><span id="l42.573" class="difflineplus">+  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSEncoder::Start\n&quot;));</span>
<a href="#l42.574"></a><span id="l42.574">   nsCMSMessage *cmsMsg = static_cast&lt;nsCMSMessage*&gt;(aMsg);</span>
<a href="#l42.575"></a><span id="l42.575">   m_ctx = new PipUIContext();</span>
<a href="#l42.576"></a><span id="l42.576"> </span>
<a href="#l42.577"></a><span id="l42.577">   m_ecx = NSS_CMSEncoder_Start(cmsMsg-&gt;getCMS(), cb, arg, 0, 0, 0, m_ctx, 0, 0, 0, 0);</span>
<a href="#l42.578"></a><span id="l42.578">   if (!m_ecx) {</span>
<a href="#l42.579"></a><span id="l42.579" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSEncoder::Start - can't start encoder\n&quot;));</span>
<a href="#l42.580"></a><span id="l42.580" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSEncoder::Start - can't start encoder\n&quot;));</span>
<a href="#l42.581"></a><span id="l42.581">     return NS_ERROR_FAILURE;</span>
<a href="#l42.582"></a><span id="l42.582">   }</span>
<a href="#l42.583"></a><span id="l42.583">   return NS_OK;</span>
<a href="#l42.584"></a><span id="l42.584"> }</span>
<a href="#l42.585"></a><span id="l42.585"> </span>
<a href="#l42.586"></a><span id="l42.586"> /* void update (in string aBuf, in long aLen); */</span>
<a href="#l42.587"></a><span id="l42.587"> NS_IMETHODIMP nsCMSEncoder::Update(const char *aBuf, int32_t aLen)</span>
<a href="#l42.588"></a><span id="l42.588"> {</span>
<a href="#l42.589"></a><span id="l42.589">   nsNSSShutDownPreventionLock locker;</span>
<a href="#l42.590"></a><span id="l42.590">   if (isAlreadyShutDown())</span>
<a href="#l42.591"></a><span id="l42.591">     return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l42.592"></a><span id="l42.592"> </span>
<a href="#l42.593"></a><span id="l42.593" class="difflineminus">-  PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSEncoder::Update\n&quot;));</span>
<a href="#l42.594"></a><span id="l42.594" class="difflineplus">+  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSEncoder::Update\n&quot;));</span>
<a href="#l42.595"></a><span id="l42.595">   if (!m_ecx || NSS_CMSEncoder_Update(m_ecx, aBuf, aLen) != SECSuccess) {</span>
<a href="#l42.596"></a><span id="l42.596" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSEncoder::Update - can't update encoder\n&quot;));</span>
<a href="#l42.597"></a><span id="l42.597" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSEncoder::Update - can't update encoder\n&quot;));</span>
<a href="#l42.598"></a><span id="l42.598">     return NS_ERROR_FAILURE;</span>
<a href="#l42.599"></a><span id="l42.599">   }</span>
<a href="#l42.600"></a><span id="l42.600">   return NS_OK;</span>
<a href="#l42.601"></a><span id="l42.601"> }</span>
<a href="#l42.602"></a><span id="l42.602"> </span>
<a href="#l42.603"></a><span id="l42.603"> /* void finish (); */</span>
<a href="#l42.604"></a><span id="l42.604"> NS_IMETHODIMP nsCMSEncoder::Finish()</span>
<a href="#l42.605"></a><span id="l42.605"> {</span>
<a href="#l42.606"></a><span id="l42.606">   nsNSSShutDownPreventionLock locker;</span>
<a href="#l42.607"></a><span id="l42.607">   if (isAlreadyShutDown())</span>
<a href="#l42.608"></a><span id="l42.608">     return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l42.609"></a><span id="l42.609"> </span>
<a href="#l42.610"></a><span id="l42.610">   nsresult rv = NS_OK;</span>
<a href="#l42.611"></a><span id="l42.611" class="difflineminus">-  PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSEncoder::Finish\n&quot;));</span>
<a href="#l42.612"></a><span id="l42.612" class="difflineplus">+  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSEncoder::Finish\n&quot;));</span>
<a href="#l42.613"></a><span id="l42.613">   if (!m_ecx || NSS_CMSEncoder_Finish(m_ecx) != SECSuccess) {</span>
<a href="#l42.614"></a><span id="l42.614" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSEncoder::Finish - can't finish encoder\n&quot;));</span>
<a href="#l42.615"></a><span id="l42.615" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSEncoder::Finish - can't finish encoder\n&quot;));</span>
<a href="#l42.616"></a><span id="l42.616">     rv = NS_ERROR_FAILURE;</span>
<a href="#l42.617"></a><span id="l42.617">   }</span>
<a href="#l42.618"></a><span id="l42.618">   m_ecx = nullptr;</span>
<a href="#l42.619"></a><span id="l42.619">   return rv;</span>
<a href="#l42.620"></a><span id="l42.620"> }</span>
<a href="#l42.621"></a><span id="l42.621"> </span>
<a href="#l42.622"></a><span id="l42.622"> /* void encode (in nsICMSMessage aMsg); */</span>
<a href="#l42.623"></a><span id="l42.623"> NS_IMETHODIMP nsCMSEncoder::Encode(nsICMSMessage *aMsg)</span>
<a href="#l42.624"></a><span id="l42.624"> {</span>
<a href="#l42.625"></a><span id="l42.625">   nsNSSShutDownPreventionLock locker;</span>
<a href="#l42.626"></a><span id="l42.626">   if (isAlreadyShutDown())</span>
<a href="#l42.627"></a><span id="l42.627">     return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l42.628"></a><span id="l42.628"> </span>
<a href="#l42.629"></a><span id="l42.629" class="difflineminus">-  PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSEncoder::Encode\n&quot;));</span>
<a href="#l42.630"></a><span id="l42.630" class="difflineplus">+  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSEncoder::Encode\n&quot;));</span>
<a href="#l42.631"></a><span id="l42.631">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l42.632"></a><span id="l42.632"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/mailnews/mime/src/nsCMSSecureMessage.cpp</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/mailnews/mime/src/nsCMSSecureMessage.cpp</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -22,21 +22,23 @@</span>
<a href="#l43.4"></a><span id="l43.4"> #include &quot;plbase64.h&quot;</span>
<a href="#l43.5"></a><span id="l43.5"> #include &quot;cert.h&quot;</span>
<a href="#l43.6"></a><span id="l43.6"> #include &quot;cms.h&quot;</span>
<a href="#l43.7"></a><span id="l43.7"> </span>
<a href="#l43.8"></a><span id="l43.8"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l43.9"></a><span id="l43.9"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l43.10"></a><span id="l43.10"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l43.11"></a><span id="l43.11"> </span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-#include &quot;prlog.h&quot;</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l43.14"></a><span id="l43.14"> #ifdef PR_LOGGING</span>
<a href="#l43.15"></a><span id="l43.15"> extern PRLogModuleInfo* gPIPNSSLog;</span>
<a href="#l43.16"></a><span id="l43.16"> #endif</span>
<a href="#l43.17"></a><span id="l43.17"> </span>
<a href="#l43.18"></a><span id="l43.18" class="difflineplus">+using namespace mozilla;</span>
<a href="#l43.19"></a><span id="l43.19" class="difflineplus">+</span>
<a href="#l43.20"></a><span id="l43.20"> // Standard ISupports implementation</span>
<a href="#l43.21"></a><span id="l43.21"> // NOTE: Should these be the thread-safe versions?</span>
<a href="#l43.22"></a><span id="l43.22"> </span>
<a href="#l43.23"></a><span id="l43.23"> /*****</span>
<a href="#l43.24"></a><span id="l43.24">  * nsCMSSecureMessage</span>
<a href="#l43.25"></a><span id="l43.25">  *****/</span>
<a href="#l43.26"></a><span id="l43.26"> </span>
<a href="#l43.27"></a><span id="l43.27"> // Standard ISupports implementation</span>
<a href="#l43.28"></a><span id="l43.28" class="difflineat">@@ -60,17 +62,17 @@ nsresult nsCMSSecureMessage::Init()</span>
<a href="#l43.29"></a><span id="l43.29">   return rv;</span>
<a href="#l43.30"></a><span id="l43.30"> }</span>
<a href="#l43.31"></a><span id="l43.31"> </span>
<a href="#l43.32"></a><span id="l43.32"> /* string getCertByPrefID (in string certID); */</span>
<a href="#l43.33"></a><span id="l43.33"> NS_IMETHODIMP nsCMSSecureMessage::</span>
<a href="#l43.34"></a><span id="l43.34"> GetCertByPrefID(const char *certID, char **_retval)</span>
<a href="#l43.35"></a><span id="l43.35"> {</span>
<a href="#l43.36"></a><span id="l43.36">   nsNSSShutDownPreventionLock locker;</span>
<a href="#l43.37"></a><span id="l43.37" class="difflineminus">-  PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSSecureMessage::GetCertByPrefID\n&quot;));</span>
<a href="#l43.38"></a><span id="l43.38" class="difflineplus">+  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSSecureMessage::GetCertByPrefID\n&quot;));</span>
<a href="#l43.39"></a><span id="l43.39">   nsresult rv = NS_OK;</span>
<a href="#l43.40"></a><span id="l43.40">   CERTCertificate *cert = 0;</span>
<a href="#l43.41"></a><span id="l43.41">   nsXPIDLCString nickname;</span>
<a href="#l43.42"></a><span id="l43.42">   nsCOMPtr&lt;nsIInterfaceRequestor&gt; ctx = new PipUIContext();</span>
<a href="#l43.43"></a><span id="l43.43"> </span>
<a href="#l43.44"></a><span id="l43.44">   *_retval = 0;</span>
<a href="#l43.45"></a><span id="l43.45"> </span>
<a href="#l43.46"></a><span id="l43.46">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l43.47"></a><span id="l43.47" class="difflineat">@@ -83,17 +85,17 @@ GetCertByPrefID(const char *certID, char</span>
<a href="#l43.48"></a><span id="l43.48">   if (NS_FAILED(rv)) goto done;</span>
<a href="#l43.49"></a><span id="l43.49"> </span>
<a href="#l43.50"></a><span id="l43.50">   /* Find a good cert in the user's database */</span>
<a href="#l43.51"></a><span id="l43.51">   cert = CERT_FindUserCertByUsage(CERT_GetDefaultCertDB(), const_cast&lt;char*&gt;(nickname.get()), </span>
<a href="#l43.52"></a><span id="l43.52">            certUsageEmailRecipient, true, ctx);</span>
<a href="#l43.53"></a><span id="l43.53"> </span>
<a href="#l43.54"></a><span id="l43.54">   if (!cert) { </span>
<a href="#l43.55"></a><span id="l43.55">     /* Success, but no value */</span>
<a href="#l43.56"></a><span id="l43.56" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSSecureMessage::GetCertByPrefID - can't find user cert\n&quot;));</span>
<a href="#l43.57"></a><span id="l43.57" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSSecureMessage::GetCertByPrefID - can't find user cert\n&quot;));</span>
<a href="#l43.58"></a><span id="l43.58">     goto done;</span>
<a href="#l43.59"></a><span id="l43.59">   } </span>
<a href="#l43.60"></a><span id="l43.60"> </span>
<a href="#l43.61"></a><span id="l43.61">   /* Convert the DER to a BASE64 String */</span>
<a href="#l43.62"></a><span id="l43.62">   encode(cert-&gt;derCert.data, cert-&gt;derCert.len, _retval);</span>
<a href="#l43.63"></a><span id="l43.63"> </span>
<a href="#l43.64"></a><span id="l43.64"> done:</span>
<a href="#l43.65"></a><span id="l43.65">   if (cert) CERT_DestroyCertificate(cert);</span>
<a href="#l43.66"></a><span id="l43.66" class="difflineat">@@ -101,28 +103,28 @@ done:</span>
<a href="#l43.67"></a><span id="l43.67"> }</span>
<a href="#l43.68"></a><span id="l43.68"> </span>
<a href="#l43.69"></a><span id="l43.69"> </span>
<a href="#l43.70"></a><span id="l43.70"> // nsCMSSecureMessage::DecodeCert</span>
<a href="#l43.71"></a><span id="l43.71"> nsresult nsCMSSecureMessage::</span>
<a href="#l43.72"></a><span id="l43.72"> DecodeCert(const char *value, nsIX509Cert ** _retval)</span>
<a href="#l43.73"></a><span id="l43.73"> {</span>
<a href="#l43.74"></a><span id="l43.74">   nsNSSShutDownPreventionLock locker;</span>
<a href="#l43.75"></a><span id="l43.75" class="difflineminus">-  PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSSecureMessage::DecodeCert\n&quot;));</span>
<a href="#l43.76"></a><span id="l43.76" class="difflineplus">+  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSSecureMessage::DecodeCert\n&quot;));</span>
<a href="#l43.77"></a><span id="l43.77">   nsresult rv = NS_OK;</span>
<a href="#l43.78"></a><span id="l43.78">   int32_t length;</span>
<a href="#l43.79"></a><span id="l43.79">   unsigned char *data = 0;</span>
<a href="#l43.80"></a><span id="l43.80"> </span>
<a href="#l43.81"></a><span id="l43.81">   *_retval = 0;</span>
<a href="#l43.82"></a><span id="l43.82"> </span>
<a href="#l43.83"></a><span id="l43.83">   if (!value) { return NS_ERROR_FAILURE; }</span>
<a href="#l43.84"></a><span id="l43.84"> </span>
<a href="#l43.85"></a><span id="l43.85">   rv = decode(value, &amp;data, &amp;length);</span>
<a href="#l43.86"></a><span id="l43.86">   if (NS_FAILED(rv)) {</span>
<a href="#l43.87"></a><span id="l43.87" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSSecureMessage::DecodeCert - can't decode cert\n&quot;));</span>
<a href="#l43.88"></a><span id="l43.88" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSSecureMessage::DecodeCert - can't decode cert\n&quot;));</span>
<a href="#l43.89"></a><span id="l43.89">     return rv;</span>
<a href="#l43.90"></a><span id="l43.90">   }</span>
<a href="#l43.91"></a><span id="l43.91"> </span>
<a href="#l43.92"></a><span id="l43.92">   nsCOMPtr&lt;nsIX509CertDB&gt; certdb = do_GetService(NS_X509CERTDB_CONTRACTID);</span>
<a href="#l43.93"></a><span id="l43.93">   if (!certdb) {</span>
<a href="#l43.94"></a><span id="l43.94">     return NS_ERROR_FAILURE;</span>
<a href="#l43.95"></a><span id="l43.95">   }</span>
<a href="#l43.96"></a><span id="l43.96"> </span>
<a href="#l43.97"></a><span id="l43.97" class="difflineat">@@ -141,117 +143,117 @@ DecodeCert(const char *value, nsIX509Cer</span>
<a href="#l43.98"></a><span id="l43.98">   return rv;</span>
<a href="#l43.99"></a><span id="l43.99"> }</span>
<a href="#l43.100"></a><span id="l43.100"> </span>
<a href="#l43.101"></a><span id="l43.101"> // nsCMSSecureMessage::SendMessage</span>
<a href="#l43.102"></a><span id="l43.102"> nsresult nsCMSSecureMessage::</span>
<a href="#l43.103"></a><span id="l43.103"> SendMessage(const char *msg, const char *base64Cert, char ** _retval)</span>
<a href="#l43.104"></a><span id="l43.104"> {</span>
<a href="#l43.105"></a><span id="l43.105">   nsNSSShutDownPreventionLock locker;</span>
<a href="#l43.106"></a><span id="l43.106" class="difflineminus">-  PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSSecureMessage::SendMessage\n&quot;));</span>
<a href="#l43.107"></a><span id="l43.107" class="difflineplus">+  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSSecureMessage::SendMessage\n&quot;));</span>
<a href="#l43.108"></a><span id="l43.108">   nsresult rv = NS_OK;</span>
<a href="#l43.109"></a><span id="l43.109">   CERTCertificate *cert = 0;</span>
<a href="#l43.110"></a><span id="l43.110">   NSSCMSMessage *cmsMsg = 0;</span>
<a href="#l43.111"></a><span id="l43.111">   unsigned char *certDER = 0;</span>
<a href="#l43.112"></a><span id="l43.112">   int32_t derLen;</span>
<a href="#l43.113"></a><span id="l43.113">   NSSCMSEnvelopedData *env;</span>
<a href="#l43.114"></a><span id="l43.114">   NSSCMSContentInfo *cinfo;</span>
<a href="#l43.115"></a><span id="l43.115">   NSSCMSRecipientInfo *rcpt;</span>
<a href="#l43.116"></a><span id="l43.116">   SECItem output;</span>
<a href="#l43.117"></a><span id="l43.117">   PLArenaPool *arena = PORT_NewArena(1024);</span>
<a href="#l43.118"></a><span id="l43.118">   SECStatus s;</span>
<a href="#l43.119"></a><span id="l43.119">   nsCOMPtr&lt;nsIInterfaceRequestor&gt; ctx = new PipUIContext();</span>
<a href="#l43.120"></a><span id="l43.120"> </span>
<a href="#l43.121"></a><span id="l43.121">   /* Step 0. Create a CMS Message */</span>
<a href="#l43.122"></a><span id="l43.122">   cmsMsg = NSS_CMSMessage_Create(nullptr);</span>
<a href="#l43.123"></a><span id="l43.123">   if (!cmsMsg) {</span>
<a href="#l43.124"></a><span id="l43.124" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSSecureMessage::SendMessage - can't create NSSCMSMessage\n&quot;));</span>
<a href="#l43.125"></a><span id="l43.125" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSSecureMessage::SendMessage - can't create NSSCMSMessage\n&quot;));</span>
<a href="#l43.126"></a><span id="l43.126">     rv = NS_ERROR_FAILURE;</span>
<a href="#l43.127"></a><span id="l43.127">     goto done;</span>
<a href="#l43.128"></a><span id="l43.128">   }</span>
<a href="#l43.129"></a><span id="l43.129"> </span>
<a href="#l43.130"></a><span id="l43.130">   /* Step 1.  Import the certificate into NSS */</span>
<a href="#l43.131"></a><span id="l43.131">   rv = decode(base64Cert, &amp;certDER, &amp;derLen);</span>
<a href="#l43.132"></a><span id="l43.132">   if (NS_FAILED(rv)) {</span>
<a href="#l43.133"></a><span id="l43.133" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSSecureMessage::SendMessage - can't decode / import cert into NSS\n&quot;));</span>
<a href="#l43.134"></a><span id="l43.134" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSSecureMessage::SendMessage - can't decode / import cert into NSS\n&quot;));</span>
<a href="#l43.135"></a><span id="l43.135">     goto done;</span>
<a href="#l43.136"></a><span id="l43.136">   }</span>
<a href="#l43.137"></a><span id="l43.137"> </span>
<a href="#l43.138"></a><span id="l43.138">   cert = CERT_DecodeCertFromPackage((char *)certDER, derLen);</span>
<a href="#l43.139"></a><span id="l43.139">   if (!cert) {</span>
<a href="#l43.140"></a><span id="l43.140" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSSecureMessage::SendMessage - can't decode cert from package\n&quot;));</span>
<a href="#l43.141"></a><span id="l43.141" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSSecureMessage::SendMessage - can't decode cert from package\n&quot;));</span>
<a href="#l43.142"></a><span id="l43.142">     rv = NS_ERROR_FAILURE;</span>
<a href="#l43.143"></a><span id="l43.143">     goto done;</span>
<a href="#l43.144"></a><span id="l43.144">   }</span>
<a href="#l43.145"></a><span id="l43.145"> </span>
<a href="#l43.146"></a><span id="l43.146">   /* Step 2.  Get a signature cert */</span>
<a href="#l43.147"></a><span id="l43.147"> </span>
<a href="#l43.148"></a><span id="l43.148">   /* Step 3. Build inner (signature) content */</span>
<a href="#l43.149"></a><span id="l43.149"> </span>
<a href="#l43.150"></a><span id="l43.150">   /* Step 4. Build outer (enveloped) content */</span>
<a href="#l43.151"></a><span id="l43.151">   env = NSS_CMSEnvelopedData_Create(cmsMsg, SEC_OID_DES_EDE3_CBC, 0);</span>
<a href="#l43.152"></a><span id="l43.152">   if (!env) {</span>
<a href="#l43.153"></a><span id="l43.153" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSSecureMessage::SendMessage - can't create envelope data\n&quot;));</span>
<a href="#l43.154"></a><span id="l43.154" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSSecureMessage::SendMessage - can't create envelope data\n&quot;));</span>
<a href="#l43.155"></a><span id="l43.155">     rv = NS_ERROR_FAILURE;</span>
<a href="#l43.156"></a><span id="l43.156">     goto done;</span>
<a href="#l43.157"></a><span id="l43.157">   }</span>
<a href="#l43.158"></a><span id="l43.158"> </span>
<a href="#l43.159"></a><span id="l43.159">   cinfo = NSS_CMSEnvelopedData_GetContentInfo(env);</span>
<a href="#l43.160"></a><span id="l43.160">   s = NSS_CMSContentInfo_SetContent_Data(cmsMsg, cinfo, 0, false);</span>
<a href="#l43.161"></a><span id="l43.161">   if (s != SECSuccess) {</span>
<a href="#l43.162"></a><span id="l43.162" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSSecureMessage::SendMessage - can't set content data\n&quot;));</span>
<a href="#l43.163"></a><span id="l43.163" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSSecureMessage::SendMessage - can't set content data\n&quot;));</span>
<a href="#l43.164"></a><span id="l43.164">     rv = NS_ERROR_FAILURE;</span>
<a href="#l43.165"></a><span id="l43.165">     goto done;</span>
<a href="#l43.166"></a><span id="l43.166">   }</span>
<a href="#l43.167"></a><span id="l43.167"> </span>
<a href="#l43.168"></a><span id="l43.168">   rcpt = NSS_CMSRecipientInfo_Create(cmsMsg, cert);</span>
<a href="#l43.169"></a><span id="l43.169">   if (!rcpt) {</span>
<a href="#l43.170"></a><span id="l43.170" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSSecureMessage::SendMessage - can't create recipient info\n&quot;));</span>
<a href="#l43.171"></a><span id="l43.171" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSSecureMessage::SendMessage - can't create recipient info\n&quot;));</span>
<a href="#l43.172"></a><span id="l43.172">     rv = NS_ERROR_FAILURE;</span>
<a href="#l43.173"></a><span id="l43.173">     goto done;</span>
<a href="#l43.174"></a><span id="l43.174">   }</span>
<a href="#l43.175"></a><span id="l43.175"> </span>
<a href="#l43.176"></a><span id="l43.176">   s = NSS_CMSEnvelopedData_AddRecipient(env, rcpt);</span>
<a href="#l43.177"></a><span id="l43.177">   if (s != SECSuccess) {</span>
<a href="#l43.178"></a><span id="l43.178" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSSecureMessage::SendMessage - can't add recipient\n&quot;));</span>
<a href="#l43.179"></a><span id="l43.179" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSSecureMessage::SendMessage - can't add recipient\n&quot;));</span>
<a href="#l43.180"></a><span id="l43.180">     rv = NS_ERROR_FAILURE;</span>
<a href="#l43.181"></a><span id="l43.181">     goto done;</span>
<a href="#l43.182"></a><span id="l43.182">   }</span>
<a href="#l43.183"></a><span id="l43.183"> </span>
<a href="#l43.184"></a><span id="l43.184">   /* Step 5. Add content to message */</span>
<a href="#l43.185"></a><span id="l43.185">   cinfo = NSS_CMSMessage_GetContentInfo(cmsMsg);</span>
<a href="#l43.186"></a><span id="l43.186">   s = NSS_CMSContentInfo_SetContent_EnvelopedData(cmsMsg, cinfo, env);</span>
<a href="#l43.187"></a><span id="l43.187">   if (s != SECSuccess) {</span>
<a href="#l43.188"></a><span id="l43.188" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSSecureMessage::SendMessage - can't set content enveloped data\n&quot;));</span>
<a href="#l43.189"></a><span id="l43.189" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSSecureMessage::SendMessage - can't set content enveloped data\n&quot;));</span>
<a href="#l43.190"></a><span id="l43.190">     rv = NS_ERROR_FAILURE;</span>
<a href="#l43.191"></a><span id="l43.191">     goto done;</span>
<a href="#l43.192"></a><span id="l43.192">   }</span>
<a href="#l43.193"></a><span id="l43.193">   </span>
<a href="#l43.194"></a><span id="l43.194">   /* Step 6. Encode */</span>
<a href="#l43.195"></a><span id="l43.195">   NSSCMSEncoderContext *ecx;</span>
<a href="#l43.196"></a><span id="l43.196"> </span>
<a href="#l43.197"></a><span id="l43.197">   output.data = 0; output.len = 0;</span>
<a href="#l43.198"></a><span id="l43.198">   ecx = NSS_CMSEncoder_Start(cmsMsg, 0, 0, &amp;output, arena,</span>
<a href="#l43.199"></a><span id="l43.199">             0, ctx, 0, 0, 0, 0);</span>
<a href="#l43.200"></a><span id="l43.200">   if (!ecx) {</span>
<a href="#l43.201"></a><span id="l43.201" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSSecureMessage::SendMessage - can't start cms encoder\n&quot;));</span>
<a href="#l43.202"></a><span id="l43.202" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSSecureMessage::SendMessage - can't start cms encoder\n&quot;));</span>
<a href="#l43.203"></a><span id="l43.203">     rv = NS_ERROR_FAILURE;</span>
<a href="#l43.204"></a><span id="l43.204">     goto done;</span>
<a href="#l43.205"></a><span id="l43.205">   }</span>
<a href="#l43.206"></a><span id="l43.206"> </span>
<a href="#l43.207"></a><span id="l43.207">   s = NSS_CMSEncoder_Update(ecx, msg, strlen(msg));</span>
<a href="#l43.208"></a><span id="l43.208">   if (s != SECSuccess) {</span>
<a href="#l43.209"></a><span id="l43.209" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSSecureMessage::SendMessage - can't update encoder\n&quot;));</span>
<a href="#l43.210"></a><span id="l43.210" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSSecureMessage::SendMessage - can't update encoder\n&quot;));</span>
<a href="#l43.211"></a><span id="l43.211">     rv = NS_ERROR_FAILURE;</span>
<a href="#l43.212"></a><span id="l43.212">     goto done;</span>
<a href="#l43.213"></a><span id="l43.213">   }</span>
<a href="#l43.214"></a><span id="l43.214"> </span>
<a href="#l43.215"></a><span id="l43.215">   s = NSS_CMSEncoder_Finish(ecx);</span>
<a href="#l43.216"></a><span id="l43.216">   if (s != SECSuccess) {</span>
<a href="#l43.217"></a><span id="l43.217" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSSecureMessage::SendMessage - can't finish encoder\n&quot;));</span>
<a href="#l43.218"></a><span id="l43.218" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSSecureMessage::SendMessage - can't finish encoder\n&quot;));</span>
<a href="#l43.219"></a><span id="l43.219">     rv = NS_ERROR_FAILURE;</span>
<a href="#l43.220"></a><span id="l43.220">     goto done;</span>
<a href="#l43.221"></a><span id="l43.221">   }</span>
<a href="#l43.222"></a><span id="l43.222"> </span>
<a href="#l43.223"></a><span id="l43.223">   /* Step 7. Base64 encode and return the result */</span>
<a href="#l43.224"></a><span id="l43.224">   rv = encode(output.data, output.len, _retval);</span>
<a href="#l43.225"></a><span id="l43.225"> </span>
<a href="#l43.226"></a><span id="l43.226"> done:</span>
<a href="#l43.227"></a><span id="l43.227" class="difflineat">@@ -265,51 +267,51 @@ done:</span>
<a href="#l43.228"></a><span id="l43.228"> </span>
<a href="#l43.229"></a><span id="l43.229"> /*</span>
<a href="#l43.230"></a><span id="l43.230">  * nsCMSSecureMessage::ReceiveMessage</span>
<a href="#l43.231"></a><span id="l43.231">  */</span>
<a href="#l43.232"></a><span id="l43.232"> nsresult nsCMSSecureMessage::</span>
<a href="#l43.233"></a><span id="l43.233"> ReceiveMessage(const char *msg, char **_retval)</span>
<a href="#l43.234"></a><span id="l43.234"> {</span>
<a href="#l43.235"></a><span id="l43.235">   nsNSSShutDownPreventionLock locker;</span>
<a href="#l43.236"></a><span id="l43.236" class="difflineminus">-  PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSSecureMessage::ReceiveMessage\n&quot;));</span>
<a href="#l43.237"></a><span id="l43.237" class="difflineplus">+  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSSecureMessage::ReceiveMessage\n&quot;));</span>
<a href="#l43.238"></a><span id="l43.238">   nsresult rv = NS_OK;</span>
<a href="#l43.239"></a><span id="l43.239">   NSSCMSDecoderContext *dcx;</span>
<a href="#l43.240"></a><span id="l43.240">   unsigned char *der = 0;</span>
<a href="#l43.241"></a><span id="l43.241">   int32_t derLen;</span>
<a href="#l43.242"></a><span id="l43.242">   NSSCMSMessage *cmsMsg = 0;</span>
<a href="#l43.243"></a><span id="l43.243">   SECItem *content;</span>
<a href="#l43.244"></a><span id="l43.244">   nsCOMPtr&lt;nsIInterfaceRequestor&gt; ctx = new PipUIContext();</span>
<a href="#l43.245"></a><span id="l43.245"> </span>
<a href="#l43.246"></a><span id="l43.246">   /* Step 1. Decode the base64 wrapper */</span>
<a href="#l43.247"></a><span id="l43.247">   rv = decode(msg, &amp;der, &amp;derLen);</span>
<a href="#l43.248"></a><span id="l43.248">   if (NS_FAILED(rv)) {</span>
<a href="#l43.249"></a><span id="l43.249" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSSecureMessage::ReceiveMessage - can't base64 decode\n&quot;));</span>
<a href="#l43.250"></a><span id="l43.250" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSSecureMessage::ReceiveMessage - can't base64 decode\n&quot;));</span>
<a href="#l43.251"></a><span id="l43.251">     goto done;</span>
<a href="#l43.252"></a><span id="l43.252">   }</span>
<a href="#l43.253"></a><span id="l43.253"> </span>
<a href="#l43.254"></a><span id="l43.254">   dcx = NSS_CMSDecoder_Start(0, 0, 0, /* pw */ 0, ctx, /* key */ 0, 0);</span>
<a href="#l43.255"></a><span id="l43.255">   if (!dcx) {</span>
<a href="#l43.256"></a><span id="l43.256" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSSecureMessage::ReceiveMessage - can't start decoder\n&quot;));</span>
<a href="#l43.257"></a><span id="l43.257" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSSecureMessage::ReceiveMessage - can't start decoder\n&quot;));</span>
<a href="#l43.258"></a><span id="l43.258">     rv = NS_ERROR_FAILURE;</span>
<a href="#l43.259"></a><span id="l43.259">     goto done;</span>
<a href="#l43.260"></a><span id="l43.260">   }</span>
<a href="#l43.261"></a><span id="l43.261"> </span>
<a href="#l43.262"></a><span id="l43.262">   (void)NSS_CMSDecoder_Update(dcx, (char *)der, derLen);</span>
<a href="#l43.263"></a><span id="l43.263">   cmsMsg = NSS_CMSDecoder_Finish(dcx);</span>
<a href="#l43.264"></a><span id="l43.264">   if (!cmsMsg) {</span>
<a href="#l43.265"></a><span id="l43.265" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSSecureMessage::ReceiveMessage - can't finish decoder\n&quot;));</span>
<a href="#l43.266"></a><span id="l43.266" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSSecureMessage::ReceiveMessage - can't finish decoder\n&quot;));</span>
<a href="#l43.267"></a><span id="l43.267">     rv = NS_ERROR_FAILURE;</span>
<a href="#l43.268"></a><span id="l43.268">     /* Memory leak on dcx?? */</span>
<a href="#l43.269"></a><span id="l43.269">     goto done;</span>
<a href="#l43.270"></a><span id="l43.270">   }</span>
<a href="#l43.271"></a><span id="l43.271"> </span>
<a href="#l43.272"></a><span id="l43.272">   content = NSS_CMSMessage_GetContent(cmsMsg);</span>
<a href="#l43.273"></a><span id="l43.273">   if (!content) {</span>
<a href="#l43.274"></a><span id="l43.274" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSSecureMessage::ReceiveMessage - can't get content\n&quot;));</span>
<a href="#l43.275"></a><span id="l43.275" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSSecureMessage::ReceiveMessage - can't get content\n&quot;));</span>
<a href="#l43.276"></a><span id="l43.276">     rv = NS_ERROR_FAILURE;</span>
<a href="#l43.277"></a><span id="l43.277">     goto done;</span>
<a href="#l43.278"></a><span id="l43.278">   }</span>
<a href="#l43.279"></a><span id="l43.279"> </span>
<a href="#l43.280"></a><span id="l43.280">   /* Copy the data */</span>
<a href="#l43.281"></a><span id="l43.281">   *_retval = (char*)malloc(content-&gt;len+1);</span>
<a href="#l43.282"></a><span id="l43.282">   memcpy(*_retval, content-&gt;data, content-&gt;len);</span>
<a href="#l43.283"></a><span id="l43.283">   (*_retval)[content-&gt;len] = 0;</span>
<a href="#l43.284"></a><span id="l43.284" class="difflineat">@@ -331,30 +333,30 @@ encode(const unsigned char *data, int32_</span>
<a href="#l43.285"></a><span id="l43.285"> </span>
<a href="#l43.286"></a><span id="l43.286"> loser:</span>
<a href="#l43.287"></a><span id="l43.287">   return rv;</span>
<a href="#l43.288"></a><span id="l43.288"> }</span>
<a href="#l43.289"></a><span id="l43.289"> </span>
<a href="#l43.290"></a><span id="l43.290"> nsresult nsCMSSecureMessage::</span>
<a href="#l43.291"></a><span id="l43.291"> decode(const char *data, unsigned char **result, int32_t * _retval)</span>
<a href="#l43.292"></a><span id="l43.292"> {</span>
<a href="#l43.293"></a><span id="l43.293" class="difflineminus">-  PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSSecureMessage::decode\n&quot;));</span>
<a href="#l43.294"></a><span id="l43.294" class="difflineplus">+  MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSSecureMessage::decode\n&quot;));</span>
<a href="#l43.295"></a><span id="l43.295">   nsresult rv = NS_OK;</span>
<a href="#l43.296"></a><span id="l43.296">   uint32_t len = strlen(data);</span>
<a href="#l43.297"></a><span id="l43.297">   int adjust = 0;</span>
<a href="#l43.298"></a><span id="l43.298"> </span>
<a href="#l43.299"></a><span id="l43.299">   /* Compute length adjustment */</span>
<a href="#l43.300"></a><span id="l43.300">   if (data[len-1] == '=') {</span>
<a href="#l43.301"></a><span id="l43.301">     adjust++;</span>
<a href="#l43.302"></a><span id="l43.302">     if (data[len-2] == '=') adjust++;</span>
<a href="#l43.303"></a><span id="l43.303">   }</span>
<a href="#l43.304"></a><span id="l43.304"> </span>
<a href="#l43.305"></a><span id="l43.305">   *result = (unsigned char *)PL_Base64Decode(data, len, nullptr);</span>
<a href="#l43.306"></a><span id="l43.306">   if (!*result) {</span>
<a href="#l43.307"></a><span id="l43.307" class="difflineminus">-    PR_LOG(gPIPNSSLog, PR_LOG_DEBUG, (&quot;nsCMSSecureMessage::decode - error decoding base64\n&quot;));</span>
<a href="#l43.308"></a><span id="l43.308" class="difflineplus">+    MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSSecureMessage::decode - error decoding base64\n&quot;));</span>
<a href="#l43.309"></a><span id="l43.309">     rv = NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l43.310"></a><span id="l43.310">     goto loser;</span>
<a href="#l43.311"></a><span id="l43.311">   }</span>
<a href="#l43.312"></a><span id="l43.312"> </span>
<a href="#l43.313"></a><span id="l43.313">   *_retval = (len*3)/4 - adjust;</span>
<a href="#l43.314"></a><span id="l43.314"> </span>
<a href="#l43.315"></a><span id="l43.315"> loser:</span>
<a href="#l43.316"></a><span id="l43.316">   return rv;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPProtocol.cpp</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPProtocol.cpp</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -18,17 +18,17 @@</span>
<a href="#l44.4"></a><span id="l44.4"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l44.5"></a><span id="l44.5"> #include &quot;nsINNTPNewsgroupPost.h&quot;</span>
<a href="#l44.6"></a><span id="l44.6"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l44.7"></a><span id="l44.7"> #include &quot;nsMsgNewsCID.h&quot;</span>
<a href="#l44.8"></a><span id="l44.8"> </span>
<a href="#l44.9"></a><span id="l44.9"> #include &quot;nsINntpUrl.h&quot;</span>
<a href="#l44.10"></a><span id="l44.10"> #include &quot;prmem.h&quot;</span>
<a href="#l44.11"></a><span id="l44.11"> #include &quot;prtime.h&quot;</span>
<a href="#l44.12"></a><span id="l44.12" class="difflineminus">-#include &quot;prlog.h&quot;</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l44.14"></a><span id="l44.14"> #include &quot;prerror.h&quot;</span>
<a href="#l44.15"></a><span id="l44.15"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l44.16"></a><span id="l44.16"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l44.17"></a><span id="l44.17"> #include &quot;mozilla/mailnews/MimeHeaderParser.h&quot;</span>
<a href="#l44.18"></a><span id="l44.18"> </span>
<a href="#l44.19"></a><span id="l44.19"> #include &quot;prprf.h&quot;</span>
<a href="#l44.20"></a><span id="l44.20"> #include &lt;algorithm&gt;</span>
<a href="#l44.21"></a><span id="l44.21"> </span>
<a href="#l44.22"></a><span id="l44.22" class="difflineat">@@ -84,46 +84,47 @@</span>
<a href="#l44.23"></a><span id="l44.23"> #define PREF_NEWS_CANCEL_CONFIRM  &quot;news.cancel.confirm&quot;</span>
<a href="#l44.24"></a><span id="l44.24"> #define PREF_NEWS_CANCEL_ALERT_ON_SUCCESS &quot;news.cancel.alert_on_success&quot;</span>
<a href="#l44.25"></a><span id="l44.25"> #define READ_NEWS_LIST_COUNT_MAX 500 /* number of groups to process at a time when reading the list from the server */</span>
<a href="#l44.26"></a><span id="l44.26"> #define READ_NEWS_LIST_TIMEOUT 50  /* uSec to wait until doing more */</span>
<a href="#l44.27"></a><span id="l44.27"> #define RATE_STR_BUF_LEN 32</span>
<a href="#l44.28"></a><span id="l44.28"> #define UPDATE_THRESHHOLD 25600 /* only update every 25 KB */</span>
<a href="#l44.29"></a><span id="l44.29"> </span>
<a href="#l44.30"></a><span id="l44.30"> using namespace mozilla::mailnews;</span>
<a href="#l44.31"></a><span id="l44.31" class="difflineplus">+using namespace mozilla;</span>
<a href="#l44.32"></a><span id="l44.32"> </span>
<a href="#l44.33"></a><span id="l44.33"> // NNTP extensions are supported yet</span>
<a href="#l44.34"></a><span id="l44.34"> // until the extension code is ported,</span>
<a href="#l44.35"></a><span id="l44.35"> // we'll skip right to the first nntp command</span>
<a href="#l44.36"></a><span id="l44.36"> // after doing &quot;mode reader&quot;</span>
<a href="#l44.37"></a><span id="l44.37"> // and &quot;pushed&quot; authentication (if necessary),</span>
<a href="#l44.38"></a><span id="l44.38"> //#define HAVE_NNTP_EXTENSIONS</span>
<a href="#l44.39"></a><span id="l44.39"> </span>
<a href="#l44.40"></a><span id="l44.40"> // quiet compiler warnings by defining these function prototypes</span>
<a href="#l44.41"></a><span id="l44.41"> char *MSG_UnEscapeSearchUrl (const char *commandSpecificData);</span>
<a href="#l44.42"></a><span id="l44.42"> </span>
<a href="#l44.43"></a><span id="l44.43"> /* Logging stuff */</span>
<a href="#l44.44"></a><span id="l44.44"> </span>
<a href="#l44.45"></a><span id="l44.45"> PRLogModuleInfo* NNTP = NULL;</span>
<a href="#l44.46"></a><span id="l44.46" class="difflineminus">-#define out     PR_LOG_ALWAYS</span>
<a href="#l44.47"></a><span id="l44.47" class="difflineplus">+#define out     LogLevel::Info</span>
<a href="#l44.48"></a><span id="l44.48"> </span>
<a href="#l44.49"></a><span id="l44.49"> #define NNTP_LOG_READ(buf) \</span>
<a href="#l44.50"></a><span id="l44.50"> if (NNTP==NULL) \</span>
<a href="#l44.51"></a><span id="l44.51">     NNTP = PR_NewLogModule(&quot;NNTP&quot;); \</span>
<a href="#l44.52"></a><span id="l44.52" class="difflineminus">-PR_LOG(NNTP, out, (&quot;(%p) Receiving: %s&quot;, this, buf)) ;</span>
<a href="#l44.53"></a><span id="l44.53" class="difflineplus">+MOZ_LOG(NNTP, out, (&quot;(%p) Receiving: %s&quot;, this, buf)) ;</span>
<a href="#l44.54"></a><span id="l44.54"> </span>
<a href="#l44.55"></a><span id="l44.55"> #define NNTP_LOG_WRITE(buf) \</span>
<a href="#l44.56"></a><span id="l44.56"> if (NNTP==NULL) \</span>
<a href="#l44.57"></a><span id="l44.57">     NNTP = PR_NewLogModule(&quot;NNTP&quot;); \</span>
<a href="#l44.58"></a><span id="l44.58" class="difflineminus">-PR_LOG(NNTP, out, (&quot;(%p) Sending: %s&quot;, this, buf)) ;</span>
<a href="#l44.59"></a><span id="l44.59" class="difflineplus">+MOZ_LOG(NNTP, out, (&quot;(%p) Sending: %s&quot;, this, buf)) ;</span>
<a href="#l44.60"></a><span id="l44.60"> </span>
<a href="#l44.61"></a><span id="l44.61"> #define NNTP_LOG_NOTE(buf) \</span>
<a href="#l44.62"></a><span id="l44.62"> if (NNTP==NULL) \</span>
<a href="#l44.63"></a><span id="l44.63">     NNTP = PR_NewLogModule(&quot;NNTP&quot;); \</span>
<a href="#l44.64"></a><span id="l44.64" class="difflineminus">-PR_LOG(NNTP, out, (&quot;(%p) %s&quot;,this, buf)) ;</span>
<a href="#l44.65"></a><span id="l44.65" class="difflineplus">+MOZ_LOG(NNTP, out, (&quot;(%p) %s&quot;,this, buf)) ;</span>
<a href="#l44.66"></a><span id="l44.66"> </span>
<a href="#l44.67"></a><span id="l44.67"> const char *const stateLabels[] = {</span>
<a href="#l44.68"></a><span id="l44.68"> &quot;NNTP_RESPONSE&quot;,</span>
<a href="#l44.69"></a><span id="l44.69"> #ifdef BLOCK_UNTIL_AVAILABLE_CONNECTION</span>
<a href="#l44.70"></a><span id="l44.70"> &quot;NNTP_BLOCK_UNTIL_CONNECTIONS_ARE_AVAILABLE&quot;,</span>
<a href="#l44.71"></a><span id="l44.71"> &quot;NNTP_CONNECTIONS_ARE_AVAILABLE&quot;,</span>
<a href="#l44.72"></a><span id="l44.72"> #endif</span>
<a href="#l44.73"></a><span id="l44.73"> &quot;NNTP_CONNECT&quot;,</span>
<a href="#l44.74"></a><span id="l44.74" class="difflineat">@@ -281,25 +282,25 @@ nsNNTPProtocol::nsNNTPProtocol(nsINntpIn</span>
<a href="#l44.75"></a><span id="l44.75">   m_startTime = PR_Now();</span>
<a href="#l44.76"></a><span id="l44.76"> </span>
<a href="#l44.77"></a><span id="l44.77">   if (aMsgWindow) {</span>
<a href="#l44.78"></a><span id="l44.78">     m_msgWindow = aMsgWindow;</span>
<a href="#l44.79"></a><span id="l44.79">   }</span>
<a href="#l44.80"></a><span id="l44.80"> </span>
<a href="#l44.81"></a><span id="l44.81">   m_runningURL = nullptr;</span>
<a href="#l44.82"></a><span id="l44.82">   m_fromCache = false;</span>
<a href="#l44.83"></a><span id="l44.83" class="difflineminus">-  PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) creating&quot;,this));</span>
<a href="#l44.84"></a><span id="l44.84" class="difflineminus">-  PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) initializing, so unset m_currentGroup&quot;,this));</span>
<a href="#l44.85"></a><span id="l44.85" class="difflineplus">+  MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) creating&quot;,this));</span>
<a href="#l44.86"></a><span id="l44.86" class="difflineplus">+  MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) initializing, so unset m_currentGroup&quot;,this));</span>
<a href="#l44.87"></a><span id="l44.87">   m_currentGroup.Truncate();</span>
<a href="#l44.88"></a><span id="l44.88">   m_lastActiveTimeStamp = 0;</span>
<a href="#l44.89"></a><span id="l44.89"> }</span>
<a href="#l44.90"></a><span id="l44.90"> </span>
<a href="#l44.91"></a><span id="l44.91"> nsNNTPProtocol::~nsNNTPProtocol()</span>
<a href="#l44.92"></a><span id="l44.92"> {</span>
<a href="#l44.93"></a><span id="l44.93" class="difflineminus">-  PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) destroying&quot;,this));</span>
<a href="#l44.94"></a><span id="l44.94" class="difflineplus">+  MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) destroying&quot;,this));</span>
<a href="#l44.95"></a><span id="l44.95">   if (m_nntpServer) {</span>
<a href="#l44.96"></a><span id="l44.96">     m_nntpServer-&gt;WriteNewsrcFile();</span>
<a href="#l44.97"></a><span id="l44.97">     m_nntpServer-&gt;RemoveConnection(this);</span>
<a href="#l44.98"></a><span id="l44.98">   }</span>
<a href="#l44.99"></a><span id="l44.99">   if (m_lineStreamBuffer) {</span>
<a href="#l44.100"></a><span id="l44.100">      delete m_lineStreamBuffer;</span>
<a href="#l44.101"></a><span id="l44.101">   }</span>
<a href="#l44.102"></a><span id="l44.102">   if (mUpdateTimer) {</span>
<a href="#l44.103"></a><span id="l44.103" class="difflineat">@@ -423,17 +424,17 @@ NS_IMETHODIMP nsNNTPProtocol::Initialize</span>
<a href="#l44.104"></a><span id="l44.104"> </span>
<a href="#l44.105"></a><span id="l44.105">     int32_t port = 0;</span>
<a href="#l44.106"></a><span id="l44.106">     nsCString hostName;</span>
<a href="#l44.107"></a><span id="l44.107">     m_url-&gt;GetPort(&amp;port);</span>
<a href="#l44.108"></a><span id="l44.108"> </span>
<a href="#l44.109"></a><span id="l44.109">     rv = server-&gt;GetRealHostName(hostName);</span>
<a href="#l44.110"></a><span id="l44.110">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l44.111"></a><span id="l44.111"> </span>
<a href="#l44.112"></a><span id="l44.112" class="difflineminus">-    PR_LOG(NNTP, PR_LOG_ALWAYS, (&quot;(%p) opening connection to %s on port %d&quot;,</span>
<a href="#l44.113"></a><span id="l44.113" class="difflineplus">+    MOZ_LOG(NNTP,  LogLevel::Info, (&quot;(%p) opening connection to %s on port %d&quot;,</span>
<a href="#l44.114"></a><span id="l44.114">       this, hostName.get(), port));</span>
<a href="#l44.115"></a><span id="l44.115"> </span>
<a href="#l44.116"></a><span id="l44.116">     nsCOMPtr&lt;nsIProxyInfo&gt; proxyInfo;</span>
<a href="#l44.117"></a><span id="l44.117">     rv = MsgExamineForProxy(this, getter_AddRefs(proxyInfo));</span>
<a href="#l44.118"></a><span id="l44.118">     if (NS_FAILED(rv)) proxyInfo = nullptr;</span>
<a href="#l44.119"></a><span id="l44.119"> </span>
<a href="#l44.120"></a><span id="l44.120">     rv = OpenNetworkSocketWithInfo(hostName.get(), port,</span>
<a href="#l44.121"></a><span id="l44.121">            (socketType == nsMsgSocketType::SSL) ? &quot;ssl&quot; : nullptr,</span>
<a href="#l44.122"></a><span id="l44.122" class="difflineat">@@ -478,17 +479,17 @@ NS_IMETHODIMP nsNNTPProtocol::GetIsBusy(</span>
<a href="#l44.123"></a><span id="l44.123"> {</span>
<a href="#l44.124"></a><span id="l44.124">   NS_ENSURE_ARG_POINTER(aIsBusy);</span>
<a href="#l44.125"></a><span id="l44.125">   *aIsBusy = m_connectionBusy;</span>
<a href="#l44.126"></a><span id="l44.126">   return NS_OK;</span>
<a href="#l44.127"></a><span id="l44.127"> }</span>
<a href="#l44.128"></a><span id="l44.128"> </span>
<a href="#l44.129"></a><span id="l44.129"> NS_IMETHODIMP nsNNTPProtocol::SetIsBusy(bool aIsBusy)</span>
<a href="#l44.130"></a><span id="l44.130"> {</span>
<a href="#l44.131"></a><span id="l44.131" class="difflineminus">-  PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) setting busy to %d&quot;,this, aIsBusy));</span>
<a href="#l44.132"></a><span id="l44.132" class="difflineplus">+  MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) setting busy to %d&quot;,this, aIsBusy));</span>
<a href="#l44.133"></a><span id="l44.133">   m_connectionBusy = aIsBusy;</span>
<a href="#l44.134"></a><span id="l44.134">   </span>
<a href="#l44.135"></a><span id="l44.135">   // Maybe we could load another URI.</span>
<a href="#l44.136"></a><span id="l44.136">   if (!aIsBusy &amp;&amp; m_nntpServer)</span>
<a href="#l44.137"></a><span id="l44.137">     m_nntpServer-&gt;PrepareForNextUrl(this);</span>
<a href="#l44.138"></a><span id="l44.138"> </span>
<a href="#l44.139"></a><span id="l44.139">   return NS_OK;</span>
<a href="#l44.140"></a><span id="l44.140"> }</span>
<a href="#l44.141"></a><span id="l44.141" class="difflineat">@@ -830,21 +831,21 @@ nsNNTPProtocol::OnCacheEntryAvailable(ns</span>
<a href="#l44.142"></a><span id="l44.142">     // gets written to both</span>
<a href="#l44.143"></a><span id="l44.143">     if (access &amp; nsICache::ACCESS_WRITE &amp;&amp; !canRead)</span>
<a href="#l44.144"></a><span id="l44.144">     {</span>
<a href="#l44.145"></a><span id="l44.145">       // use a stream listener Tee to force data into the cache and to our current channel listener...</span>
<a href="#l44.146"></a><span id="l44.146">       nsCOMPtr&lt;nsIStreamListener&gt; newListener;</span>
<a href="#l44.147"></a><span id="l44.147">       nsCOMPtr&lt;nsIStreamListenerTee&gt; tee = do_CreateInstance(NS_STREAMLISTENERTEE_CONTRACTID, &amp;rv);</span>
<a href="#l44.148"></a><span id="l44.148">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l44.149"></a><span id="l44.149"> </span>
<a href="#l44.150"></a><span id="l44.150" class="difflineminus">-      nsCOMPtr&lt;nsIOutputStream&gt; out;</span>
<a href="#l44.151"></a><span id="l44.151" class="difflineminus">-      rv = entry-&gt;OpenOutputStream(0, getter_AddRefs(out));</span>
<a href="#l44.152"></a><span id="l44.152" class="difflineplus">+      nsCOMPtr&lt;nsIOutputStream&gt; outStream;</span>
<a href="#l44.153"></a><span id="l44.153" class="difflineplus">+      rv = entry-&gt;OpenOutputStream(0, getter_AddRefs(outStream));</span>
<a href="#l44.154"></a><span id="l44.154">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l44.155"></a><span id="l44.155"> </span>
<a href="#l44.156"></a><span id="l44.156" class="difflineminus">-      rv = tee-&gt;Init(m_channelListener, out, nullptr);</span>
<a href="#l44.157"></a><span id="l44.157" class="difflineplus">+      rv = tee-&gt;Init(m_channelListener, outStream, nullptr);</span>
<a href="#l44.158"></a><span id="l44.158">       m_channelListener = do_QueryInterface(tee);</span>
<a href="#l44.159"></a><span id="l44.159">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l44.160"></a><span id="l44.160">     }</span>
<a href="#l44.161"></a><span id="l44.161">     else if (canRead)</span>
<a href="#l44.162"></a><span id="l44.162">     {</span>
<a href="#l44.163"></a><span id="l44.163">       rv = ReadFromMemCache(entry);</span>
<a href="#l44.164"></a><span id="l44.164">       if (access &amp; nsICache::ACCESS_WRITE)</span>
<a href="#l44.165"></a><span id="l44.165">         entry-&gt;MarkValid();</span>
<a href="#l44.166"></a><span id="l44.166" class="difflineat">@@ -949,19 +950,19 @@ nsresult nsNNTPProtocol::LoadUrl(nsIURI </span>
<a href="#l44.167"></a><span id="l44.167"> </span>
<a href="#l44.168"></a><span id="l44.168">   rv = ParseURL(aURL, group, m_messageID);</span>
<a href="#l44.169"></a><span id="l44.169">   NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to parse news url&quot;);</span>
<a href="#l44.170"></a><span id="l44.170">   //if (NS_FAILED(rv)) return rv;</span>
<a href="#l44.171"></a><span id="l44.171">   // XXX group returned from ParseURL is assumed to be in UTF-8</span>
<a href="#l44.172"></a><span id="l44.172">   NS_ASSERTION(MsgIsUTF8(group), &quot;newsgroup name is not in UTF-8&quot;);</span>
<a href="#l44.173"></a><span id="l44.173">   NS_ASSERTION(m_nntpServer, &quot;Parsing must result in an m_nntpServer&quot;);</span>
<a href="#l44.174"></a><span id="l44.174"> </span>
<a href="#l44.175"></a><span id="l44.175" class="difflineminus">-  PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) m_messageID = %s&quot;, this, m_messageID.get()));</span>
<a href="#l44.176"></a><span id="l44.176" class="difflineminus">-  PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) group = %s&quot;, this, group.get()));</span>
<a href="#l44.177"></a><span id="l44.177" class="difflineminus">-  PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) m_key = %d&quot;,this,m_key));</span>
<a href="#l44.178"></a><span id="l44.178" class="difflineplus">+  MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) m_messageID = %s&quot;, this, m_messageID.get()));</span>
<a href="#l44.179"></a><span id="l44.179" class="difflineplus">+  MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) group = %s&quot;, this, group.get()));</span>
<a href="#l44.180"></a><span id="l44.180" class="difflineplus">+  MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) m_key = %d&quot;,this,m_key));</span>
<a href="#l44.181"></a><span id="l44.181"> </span>
<a href="#l44.182"></a><span id="l44.182">   if (m_newsAction == nsINntpUrl::ActionFetchArticle ||</span>
<a href="#l44.183"></a><span id="l44.183">       m_newsAction == nsINntpUrl::ActionFetchPart ||</span>
<a href="#l44.184"></a><span id="l44.184">       m_newsAction == nsINntpUrl::ActionSaveMessageToDisk)</span>
<a href="#l44.185"></a><span id="l44.185">     m_typeWanted = ARTICLE_WANTED;</span>
<a href="#l44.186"></a><span id="l44.186">   else if (m_newsAction == nsINntpUrl::ActionCancelArticle)</span>
<a href="#l44.187"></a><span id="l44.187">     m_typeWanted = CANCEL_WANTED;</span>
<a href="#l44.188"></a><span id="l44.188">   else if (m_newsAction == nsINntpUrl::ActionPostArticle)</span>
<a href="#l44.189"></a><span id="l44.189" class="difflineat">@@ -1176,17 +1177,17 @@ NS_IMETHODIMP nsNNTPProtocol::Cancel(nsr</span>
<a href="#l44.190"></a><span id="l44.190">     return nsMsgProtocol::Cancel(NS_BINDING_ABORTED);</span>
<a href="#l44.191"></a><span id="l44.191"> }</span>
<a href="#l44.192"></a><span id="l44.192"> </span>
<a href="#l44.193"></a><span id="l44.193"> nsresult</span>
<a href="#l44.194"></a><span id="l44.194"> nsNNTPProtocol::ParseURL(nsIURI *aURL, nsCString &amp;aGroup, nsCString &amp;aMessageID)</span>
<a href="#l44.195"></a><span id="l44.195"> {</span>
<a href="#l44.196"></a><span id="l44.196">     NS_ENSURE_ARG_POINTER(aURL);</span>
<a href="#l44.197"></a><span id="l44.197"> </span>
<a href="#l44.198"></a><span id="l44.198" class="difflineminus">-    PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) ParseURL&quot;,this));</span>
<a href="#l44.199"></a><span id="l44.199" class="difflineplus">+    MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) ParseURL&quot;,this));</span>
<a href="#l44.200"></a><span id="l44.200"> </span>
<a href="#l44.201"></a><span id="l44.201">     nsresult rv;</span>
<a href="#l44.202"></a><span id="l44.202">     nsCOMPtr &lt;nsIMsgFolder&gt; folder;</span>
<a href="#l44.203"></a><span id="l44.203">     nsCOMPtr &lt;nsINntpService&gt; nntpService = do_GetService(NS_NNTPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l44.204"></a><span id="l44.204">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l44.205"></a><span id="l44.205"> </span>
<a href="#l44.206"></a><span id="l44.206">     nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgUrl = do_QueryInterface(m_runningURL, &amp;rv);</span>
<a href="#l44.207"></a><span id="l44.207">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l44.208"></a><span id="l44.208" class="difflineat">@@ -1195,17 +1196,17 @@ nsNNTPProtocol::ParseURL(nsIURI *aURL, n</span>
<a href="#l44.209"></a><span id="l44.209">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l44.210"></a><span id="l44.210"> </span>
<a href="#l44.211"></a><span id="l44.211">     nsCString spec;</span>
<a href="#l44.212"></a><span id="l44.212">     rv = msgUrl-&gt;GetOriginalSpec(getter_Copies(spec));</span>
<a href="#l44.213"></a><span id="l44.213">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l44.214"></a><span id="l44.214"> </span>
<a href="#l44.215"></a><span id="l44.215">     // if the original spec is non empty, use it to determine m_newsFolder and m_key</span>
<a href="#l44.216"></a><span id="l44.216">     if (!spec.IsEmpty()) {</span>
<a href="#l44.217"></a><span id="l44.217" class="difflineminus">-        PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) original message spec = %s&quot;,this,spec.get()));</span>
<a href="#l44.218"></a><span id="l44.218" class="difflineplus">+        MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) original message spec = %s&quot;,this,spec.get()));</span>
<a href="#l44.219"></a><span id="l44.219"> </span>
<a href="#l44.220"></a><span id="l44.220">         rv = nntpService-&gt;DecomposeNewsURI(spec.get(), getter_AddRefs(folder), &amp;m_key);</span>
<a href="#l44.221"></a><span id="l44.221">         NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l44.222"></a><span id="l44.222"> </span>
<a href="#l44.223"></a><span id="l44.223">         // since we are reading a message in this folder, we can set m_newsFolder</span>
<a href="#l44.224"></a><span id="l44.224">         m_newsFolder = do_QueryInterface(folder, &amp;rv);</span>
<a href="#l44.225"></a><span id="l44.225">         NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l44.226"></a><span id="l44.226"> </span>
<a href="#l44.227"></a><span id="l44.227" class="difflineat">@@ -1268,17 +1269,17 @@ nsNNTPProtocol::ParseURL(nsIURI *aURL, n</span>
<a href="#l44.228"></a><span id="l44.228">  */</span>
<a href="#l44.229"></a><span id="l44.229"> </span>
<a href="#l44.230"></a><span id="l44.230"> nsresult nsNNTPProtocol::SendData(const char * dataBuffer, bool aSuppressLogging)</span>
<a href="#l44.231"></a><span id="l44.231"> {</span>
<a href="#l44.232"></a><span id="l44.232">     if (!aSuppressLogging) {</span>
<a href="#l44.233"></a><span id="l44.233">         NNTP_LOG_WRITE(dataBuffer);</span>
<a href="#l44.234"></a><span id="l44.234">     }</span>
<a href="#l44.235"></a><span id="l44.235">     else {</span>
<a href="#l44.236"></a><span id="l44.236" class="difflineminus">-        PR_LOG(NNTP, out, (&quot;(%p) Logging suppressed for this command (it probably contained authentication information)&quot;, this));</span>
<a href="#l44.237"></a><span id="l44.237" class="difflineplus">+        MOZ_LOG(NNTP, out, (&quot;(%p) Logging suppressed for this command (it probably contained authentication information)&quot;, this));</span>
<a href="#l44.238"></a><span id="l44.238">     }</span>
<a href="#l44.239"></a><span id="l44.239"> </span>
<a href="#l44.240"></a><span id="l44.240">   return nsMsgProtocol::SendData(dataBuffer); // base class actually transmits the data</span>
<a href="#l44.241"></a><span id="l44.241"> }</span>
<a href="#l44.242"></a><span id="l44.242"> </span>
<a href="#l44.243"></a><span id="l44.243"> /* gets the response code from the nntp server and the</span>
<a href="#l44.244"></a><span id="l44.244">  * response line</span>
<a href="#l44.245"></a><span id="l44.245">  *</span>
<a href="#l44.246"></a><span id="l44.246" class="difflineat">@@ -1700,17 +1701,17 @@ nsresult nsNNTPProtocol::SendFirstNNTPCo</span>
<a href="#l44.247"></a><span id="l44.247">     if (m_typeWanted == ARTICLE_WANTED) {</span>
<a href="#l44.248"></a><span id="l44.248">         if (m_key != nsMsgKey_None) {</span>
<a href="#l44.249"></a><span id="l44.249">             nsresult rv;</span>
<a href="#l44.250"></a><span id="l44.250">             nsCString newsgroupName;</span>
<a href="#l44.251"></a><span id="l44.251">             if (m_newsFolder) {</span>
<a href="#l44.252"></a><span id="l44.252">                 rv = m_newsFolder-&gt;GetRawName(newsgroupName);</span>
<a href="#l44.253"></a><span id="l44.253">                 NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l44.254"></a><span id="l44.254">             }</span>
<a href="#l44.255"></a><span id="l44.255" class="difflineminus">-            PR_LOG(NNTP,PR_LOG_ALWAYS,</span>
<a href="#l44.256"></a><span id="l44.256" class="difflineplus">+            MOZ_LOG(NNTP, LogLevel::Info,</span>
<a href="#l44.257"></a><span id="l44.257">                    (&quot;(%p) current group = %s, desired group = %s&quot;, this,</span>
<a href="#l44.258"></a><span id="l44.258">                    m_currentGroup.get(), newsgroupName.get()));</span>
<a href="#l44.259"></a><span id="l44.259">             // if the current group is the desired group, we can just issue the ARTICLE command</span>
<a href="#l44.260"></a><span id="l44.260">             // if not, we have to do a GROUP first</span>
<a href="#l44.261"></a><span id="l44.261">             if (newsgroupName.Equals(m_currentGroup))</span>
<a href="#l44.262"></a><span id="l44.262">               m_nextState = NNTP_SEND_ARTICLE_NUMBER;</span>
<a href="#l44.263"></a><span id="l44.263">             else</span>
<a href="#l44.264"></a><span id="l44.264">               m_nextState = NNTP_SEND_GROUP_FOR_ARTICLE;</span>
<a href="#l44.265"></a><span id="l44.265" class="difflineat">@@ -1792,17 +1793,17 @@ nsresult nsNNTPProtocol::SendFirstNNTPCo</span>
<a href="#l44.266"></a><span id="l44.266">         m_lastArticle = 0;</span>
<a href="#l44.267"></a><span id="l44.267"> </span>
<a href="#l44.268"></a><span id="l44.268">         NS_MsgSACopy(&amp;command, &quot;GROUP &quot;);</span>
<a href="#l44.269"></a><span id="l44.269">         NS_MsgSACat(&amp;command, group_name.get());</span>
<a href="#l44.270"></a><span id="l44.270">       }</span>
<a href="#l44.271"></a><span id="l44.271">   else if (m_typeWanted == SEARCH_WANTED)</span>
<a href="#l44.272"></a><span id="l44.272">   {</span>
<a href="#l44.273"></a><span id="l44.273">     nsresult rv;</span>
<a href="#l44.274"></a><span id="l44.274" class="difflineminus">-    PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) doing GROUP for XPAT&quot;, this));</span>
<a href="#l44.275"></a><span id="l44.275" class="difflineplus">+    MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) doing GROUP for XPAT&quot;, this));</span>
<a href="#l44.276"></a><span id="l44.276">     nsCString group_name;</span>
<a href="#l44.277"></a><span id="l44.277"> </span>
<a href="#l44.278"></a><span id="l44.278">     /* for XPAT, we have to GROUP into the group before searching */</span>
<a href="#l44.279"></a><span id="l44.279">     if (!m_newsFolder) {</span>
<a href="#l44.280"></a><span id="l44.280">         NNTP_LOG_NOTE(&quot;m_newsFolder is null, panic!&quot;);</span>
<a href="#l44.281"></a><span id="l44.281">         return NS_ERROR_FAILURE;</span>
<a href="#l44.282"></a><span id="l44.282">     }</span>
<a href="#l44.283"></a><span id="l44.283">     rv = m_newsFolder-&gt;GetRawName(group_name);</span>
<a href="#l44.284"></a><span id="l44.284" class="difflineat">@@ -1879,17 +1880,17 @@ nsresult nsNNTPProtocol::SendFirstNNTPCo</span>
<a href="#l44.285"></a><span id="l44.285"> </span>
<a href="#l44.286"></a><span id="l44.286">     nsString group_name;</span>
<a href="#l44.287"></a><span id="l44.287">     NS_ASSERTION(m_newsFolder, &quot;no newsFolder&quot;);</span>
<a href="#l44.288"></a><span id="l44.288">     if (m_newsFolder)</span>
<a href="#l44.289"></a><span id="l44.289">       rv = m_newsFolder-&gt;GetUnicodeName(group_name);</span>
<a href="#l44.290"></a><span id="l44.290"> </span>
<a href="#l44.291"></a><span id="l44.291">     if (m_responseCode == MK_NNTP_RESPONSE_GROUP_NO_GROUP &amp;&amp;</span>
<a href="#l44.292"></a><span id="l44.292">       m_typeWanted == GROUP_WANTED) {</span>
<a href="#l44.293"></a><span id="l44.293" class="difflineminus">-      PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) group (%s) not found, so unset&quot;</span>
<a href="#l44.294"></a><span id="l44.294" class="difflineplus">+      MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) group (%s) not found, so unset&quot;</span>
<a href="#l44.295"></a><span id="l44.295">                                  &quot; m_currentGroup&quot;, this,</span>
<a href="#l44.296"></a><span id="l44.296">                                  NS_ConvertUTF16toUTF8(group_name).get()));</span>
<a href="#l44.297"></a><span id="l44.297">       m_currentGroup.Truncate();</span>
<a href="#l44.298"></a><span id="l44.298"> </span>
<a href="#l44.299"></a><span id="l44.299">       m_nntpServer-&gt;GroupNotFound(m_msgWindow, group_name, true /* opening */);</span>
<a href="#l44.300"></a><span id="l44.300">     }</span>
<a href="#l44.301"></a><span id="l44.301"> </span>
<a href="#l44.302"></a><span id="l44.302">     /* if the server returned a 400 error then it is an expected</span>
<a href="#l44.303"></a><span id="l44.303" class="difflineat">@@ -2015,17 +2016,17 @@ nsNNTPProtocol::SetCurrentGroup()</span>
<a href="#l44.304"></a><span id="l44.304">   NS_ASSERTION(m_newsFolder, &quot;no news folder&quot;);</span>
<a href="#l44.305"></a><span id="l44.305">   if (!m_newsFolder) {</span>
<a href="#l44.306"></a><span id="l44.306">     m_currentGroup.Truncate();</span>
<a href="#l44.307"></a><span id="l44.307">     return NS_ERROR_UNEXPECTED;</span>
<a href="#l44.308"></a><span id="l44.308">   }</span>
<a href="#l44.309"></a><span id="l44.309"> </span>
<a href="#l44.310"></a><span id="l44.310">   rv = m_newsFolder-&gt;GetRawName(groupname);</span>
<a href="#l44.311"></a><span id="l44.311">   NS_ASSERTION(NS_SUCCEEDED(rv) &amp;&amp; !groupname.IsEmpty(), &quot;no group name&quot;);</span>
<a href="#l44.312"></a><span id="l44.312" class="difflineminus">-  PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) SetCurrentGroup to %s&quot;,this, groupname.get()));</span>
<a href="#l44.313"></a><span id="l44.313" class="difflineplus">+  MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) SetCurrentGroup to %s&quot;,this, groupname.get()));</span>
<a href="#l44.314"></a><span id="l44.314">   m_currentGroup = groupname;</span>
<a href="#l44.315"></a><span id="l44.315">   return NS_OK;</span>
<a href="#l44.316"></a><span id="l44.316"> }</span>
<a href="#l44.317"></a><span id="l44.317"> </span>
<a href="#l44.318"></a><span id="l44.318"> nsresult nsNNTPProtocol::SendGroupForArticleResponse()</span>
<a href="#l44.319"></a><span id="l44.319"> {</span>
<a href="#l44.320"></a><span id="l44.320">   /* ignore the response code and continue</span>
<a href="#l44.321"></a><span id="l44.321">    */</span>
<a href="#l44.322"></a><span id="l44.322" class="difflineat">@@ -2325,17 +2326,17 @@ nsresult nsNNTPProtocol::BeginAuthorizat</span>
<a href="#l44.323"></a><span id="l44.323"> </span>
<a href="#l44.324"></a><span id="l44.324">     m_nextState = NNTP_SUSPENDED;</span>
<a href="#l44.325"></a><span id="l44.325">     if (m_request)</span>
<a href="#l44.326"></a><span id="l44.326">       m_request-&gt;Suspend();</span>
<a href="#l44.327"></a><span id="l44.327">     return NS_OK;</span>
<a href="#l44.328"></a><span id="l44.328">   }</span>
<a href="#l44.329"></a><span id="l44.329"> </span>
<a href="#l44.330"></a><span id="l44.330">   NS_MsgSACopy(&amp;command, &quot;AUTHINFO user &quot;);</span>
<a href="#l44.331"></a><span id="l44.331" class="difflineminus">-  PR_LOG(NNTP, PR_LOG_ALWAYS,(&quot;(%p) use %s as the username&quot;, this, username.get()));</span>
<a href="#l44.332"></a><span id="l44.332" class="difflineplus">+  MOZ_LOG(NNTP,  LogLevel::Info,(&quot;(%p) use %s as the username&quot;, this, username.get()));</span>
<a href="#l44.333"></a><span id="l44.333">   NS_MsgSACat(&amp;command, username.get());</span>
<a href="#l44.334"></a><span id="l44.334">   NS_MsgSACat(&amp;command, CRLF);</span>
<a href="#l44.335"></a><span id="l44.335"> </span>
<a href="#l44.336"></a><span id="l44.336">   rv = SendData(command);</span>
<a href="#l44.337"></a><span id="l44.337"> </span>
<a href="#l44.338"></a><span id="l44.338">   PR_Free(command);</span>
<a href="#l44.339"></a><span id="l44.339"> </span>
<a href="#l44.340"></a><span id="l44.340">   m_nextState = NNTP_RESPONSE;</span>
<a href="#l44.341"></a><span id="l44.341" class="difflineat">@@ -2510,17 +2511,17 @@ NS_IMETHODIMP nsNNTPProtocol::OnPromptCa</span>
<a href="#l44.342"></a><span id="l44.342">   return ProcessProtocolState(nullptr, nullptr, 0, 0);</span>
<a href="#l44.343"></a><span id="l44.343"> }</span>
<a href="#l44.344"></a><span id="l44.344"> </span>
<a href="#l44.345"></a><span id="l44.345"> nsresult nsNNTPProtocol::DisplayNewsgroups()</span>
<a href="#l44.346"></a><span id="l44.346"> {</span>
<a href="#l44.347"></a><span id="l44.347">   m_nextState = NEWS_DONE;</span>
<a href="#l44.348"></a><span id="l44.348">   ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l44.349"></a><span id="l44.349"> </span>
<a href="#l44.350"></a><span id="l44.350" class="difflineminus">-  PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) DisplayNewsgroups()&quot;,this));</span>
<a href="#l44.351"></a><span id="l44.351" class="difflineplus">+  MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) DisplayNewsgroups()&quot;,this));</span>
<a href="#l44.352"></a><span id="l44.352"> </span>
<a href="#l44.353"></a><span id="l44.353">   return NS_OK;</span>
<a href="#l44.354"></a><span id="l44.354"> }</span>
<a href="#l44.355"></a><span id="l44.355"> </span>
<a href="#l44.356"></a><span id="l44.356"> nsresult nsNNTPProtocol::BeginNewsgroups()</span>
<a href="#l44.357"></a><span id="l44.357"> {</span>
<a href="#l44.358"></a><span id="l44.358">   m_nextState = NNTP_NEWGROUPS;</span>
<a href="#l44.359"></a><span id="l44.359">   mBytesReceived = 0;</span>
<a href="#l44.360"></a><span id="l44.360" class="difflineat">@@ -2557,17 +2558,17 @@ nsresult nsNNTPProtocol::ProcessNewsgrou</span>
<a href="#l44.361"></a><span id="l44.361">     if (NS_SUCCEEDED(rv) &amp;&amp; xactive)</span>
<a href="#l44.362"></a><span id="l44.362">     {</span>
<a href="#l44.363"></a><span id="l44.363">       nsAutoCString groupName;</span>
<a href="#l44.364"></a><span id="l44.364">       rv = m_nntpServer-&gt;GetFirstGroupNeedingExtraInfo(groupName);</span>
<a href="#l44.365"></a><span id="l44.365">       if (NS_SUCCEEDED(rv)) {</span>
<a href="#l44.366"></a><span id="l44.366">         rv = m_nntpServer-&gt;FindGroup(groupName, getter_AddRefs(m_newsFolder));</span>
<a href="#l44.367"></a><span id="l44.367">         NS_ASSERTION(NS_SUCCEEDED(rv), &quot;FindGroup failed&quot;);</span>
<a href="#l44.368"></a><span id="l44.368">         m_nextState = NNTP_LIST_XACTIVE;</span>
<a href="#l44.369"></a><span id="l44.369" class="difflineminus">-        PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) listing xactive for %s&quot;, this,</span>
<a href="#l44.370"></a><span id="l44.370" class="difflineplus">+        MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) listing xactive for %s&quot;, this,</span>
<a href="#l44.371"></a><span id="l44.371">                                    groupName.get()));</span>
<a href="#l44.372"></a><span id="l44.372">         PR_Free(lineToFree);</span>
<a href="#l44.373"></a><span id="l44.373">         return NS_OK;</span>
<a href="#l44.374"></a><span id="l44.374">       }</span>
<a href="#l44.375"></a><span id="l44.375">     }</span>
<a href="#l44.376"></a><span id="l44.376">     m_nextState = NEWS_DONE;</span>
<a href="#l44.377"></a><span id="l44.377"> </span>
<a href="#l44.378"></a><span id="l44.378">     PR_Free(lineToFree);</span>
<a href="#l44.379"></a><span id="l44.379" class="difflineat">@@ -2842,17 +2843,17 @@ nsNNTPProtocol::Notify(nsITimer *timer)</span>
<a href="#l44.380"></a><span id="l44.380">   NS_ASSERTION(timer == mUpdateTimer.get(), &quot;Hey, this ain't my timer!&quot;);</span>
<a href="#l44.381"></a><span id="l44.381">   mUpdateTimer = nullptr;    // release my hold</span>
<a href="#l44.382"></a><span id="l44.382">   TimerCallback();</span>
<a href="#l44.383"></a><span id="l44.383">   return NS_OK;</span>
<a href="#l44.384"></a><span id="l44.384"> }</span>
<a href="#l44.385"></a><span id="l44.385"> </span>
<a href="#l44.386"></a><span id="l44.386"> void nsNNTPProtocol::TimerCallback()</span>
<a href="#l44.387"></a><span id="l44.387"> {</span>
<a href="#l44.388"></a><span id="l44.388" class="difflineminus">-  PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;nsNNTPProtocol::TimerCallback\n&quot;));</span>
<a href="#l44.389"></a><span id="l44.389" class="difflineplus">+  MOZ_LOG(NNTP, LogLevel::Info,(&quot;nsNNTPProtocol::TimerCallback\n&quot;));</span>
<a href="#l44.390"></a><span id="l44.390">   m_nextState = NNTP_READ_LIST;</span>
<a href="#l44.391"></a><span id="l44.391"> </span>
<a href="#l44.392"></a><span id="l44.392">   // process whatever is already in the buffer at least once.</span>
<a href="#l44.393"></a><span id="l44.393">   //</span>
<a href="#l44.394"></a><span id="l44.394">   // NOTE: while downloading, it would almost be enough to just</span>
<a href="#l44.395"></a><span id="l44.395">   // resume necko since it will call us again with data.  however,</span>
<a href="#l44.396"></a><span id="l44.396">   // if we are at the end of the data stream then we must call</span>
<a href="#l44.397"></a><span id="l44.397">   // ProcessProtocolState since necko will not call us again.</span>
<a href="#l44.398"></a><span id="l44.398" class="difflineat">@@ -2957,17 +2958,17 @@ nsresult nsNNTPProtocol::BeginReadXover(</span>
<a href="#l44.399"></a><span id="l44.399"> nsresult nsNNTPProtocol::FigureNextChunk()</span>
<a href="#l44.400"></a><span id="l44.400"> {</span>
<a href="#l44.401"></a><span id="l44.401">     nsresult rv = NS_OK;</span>
<a href="#l44.402"></a><span id="l44.402">   int32_t status = 0;</span>
<a href="#l44.403"></a><span id="l44.403"> </span>
<a href="#l44.404"></a><span id="l44.404">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(m_runningURL);</span>
<a href="#l44.405"></a><span id="l44.405">   if (m_firstArticle &gt; 0)</span>
<a href="#l44.406"></a><span id="l44.406">   {</span>
<a href="#l44.407"></a><span id="l44.407" class="difflineminus">-      PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) add to known articles:  %d - %d&quot;, this, m_firstArticle, m_lastArticle));</span>
<a href="#l44.408"></a><span id="l44.408" class="difflineplus">+      MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) add to known articles:  %d - %d&quot;, this, m_firstArticle, m_lastArticle));</span>
<a href="#l44.409"></a><span id="l44.409"> </span>
<a href="#l44.410"></a><span id="l44.410">       if (NS_SUCCEEDED(rv) &amp;&amp; m_newsgroupList) {</span>
<a href="#l44.411"></a><span id="l44.411">           rv = m_newsgroupList-&gt;AddToKnownArticles(m_firstArticle,</span>
<a href="#l44.412"></a><span id="l44.412">                                                  m_lastArticle);</span>
<a href="#l44.413"></a><span id="l44.413">       }</span>
<a href="#l44.414"></a><span id="l44.414"> </span>
<a href="#l44.415"></a><span id="l44.415">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l44.416"></a><span id="l44.416">   }</span>
<a href="#l44.417"></a><span id="l44.417" class="difflineat">@@ -3004,17 +3005,17 @@ nsresult nsNNTPProtocol::FigureNextChunk</span>
<a href="#l44.418"></a><span id="l44.418">   if (m_firstArticle &lt;= 0 || m_firstArticle &gt; m_lastArticle)</span>
<a href="#l44.419"></a><span id="l44.419">   {</span>
<a href="#l44.420"></a><span id="l44.420">     /* Nothing more to get. */</span>
<a href="#l44.421"></a><span id="l44.421">     m_nextState = NEWS_PROCESS_XOVER;</span>
<a href="#l44.422"></a><span id="l44.422">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l44.423"></a><span id="l44.423">     return NS_OK;</span>
<a href="#l44.424"></a><span id="l44.424">   }</span>
<a href="#l44.425"></a><span id="l44.425"> </span>
<a href="#l44.426"></a><span id="l44.426" class="difflineminus">-  PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) Chunk will be (%d-%d)&quot;, this, m_firstArticle, m_lastArticle));</span>
<a href="#l44.427"></a><span id="l44.427" class="difflineplus">+  MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) Chunk will be (%d-%d)&quot;, this, m_firstArticle, m_lastArticle));</span>
<a href="#l44.428"></a><span id="l44.428"> </span>
<a href="#l44.429"></a><span id="l44.429">   m_articleNumber = m_firstArticle;</span>
<a href="#l44.430"></a><span id="l44.430"> </span>
<a href="#l44.431"></a><span id="l44.431">     /* was MSG_InitXOVER() */</span>
<a href="#l44.432"></a><span id="l44.432">     if (m_newsgroupList) {</span>
<a href="#l44.433"></a><span id="l44.433">         rv = m_newsgroupList-&gt;InitXOVER(m_firstArticle, m_lastArticle);</span>
<a href="#l44.434"></a><span id="l44.434">   }</span>
<a href="#l44.435"></a><span id="l44.435"> </span>
<a href="#l44.436"></a><span id="l44.436" class="difflineat">@@ -3290,17 +3291,17 @@ nsresult nsNNTPProtocol::ReadNewsgroupBo</span>
<a href="#l44.437"></a><span id="l44.437">     return NS_OK;</span>
<a href="#l44.438"></a><span id="l44.438">   }</span>
<a href="#l44.439"></a><span id="l44.439"> </span>
<a href="#l44.440"></a><span id="l44.440">   /* if TCP error of if there is not a full line yet return</span>
<a href="#l44.441"></a><span id="l44.441">   */</span>
<a href="#l44.442"></a><span id="l44.442">   if(!line)</span>
<a href="#l44.443"></a><span id="l44.443">     return rv;</span>
<a href="#l44.444"></a><span id="l44.444"> </span>
<a href="#l44.445"></a><span id="l44.445" class="difflineminus">-  PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) read_group_body: got line: %s|&quot;,this,line));</span>
<a href="#l44.446"></a><span id="l44.446" class="difflineplus">+  MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) read_group_body: got line: %s|&quot;,this,line));</span>
<a href="#l44.447"></a><span id="l44.447"> </span>
<a href="#l44.448"></a><span id="l44.448">   /* End of body? */</span>
<a href="#l44.449"></a><span id="l44.449">   if (line[0]=='.' &amp;&amp; line[1]=='\0')</span>
<a href="#l44.450"></a><span id="l44.450">   {</span>
<a href="#l44.451"></a><span id="l44.451">     m_nextState = NNTP_READ_GROUP;</span>
<a href="#l44.452"></a><span id="l44.452">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l44.453"></a><span id="l44.453">     return NS_OK;</span>
<a href="#l44.454"></a><span id="l44.454">   }</span>
<a href="#l44.455"></a><span id="l44.455" class="difflineat">@@ -3478,24 +3479,24 @@ nsresult nsNNTPProtocol::StartCancel()</span>
<a href="#l44.456"></a><span id="l44.456"> }</span>
<a href="#l44.457"></a><span id="l44.457"> </span>
<a href="#l44.458"></a><span id="l44.458"> void nsNNTPProtocol::CheckIfAuthor(nsIMsgIdentity *aIdentity, const nsCString &amp;aOldFrom, nsCString &amp;aFrom)</span>
<a href="#l44.459"></a><span id="l44.459"> {</span>
<a href="#l44.460"></a><span id="l44.460">   nsAutoCString from;</span>
<a href="#l44.461"></a><span id="l44.461">   nsresult rv = aIdentity-&gt;GetEmail(from);</span>
<a href="#l44.462"></a><span id="l44.462">   if (NS_FAILED(rv))</span>
<a href="#l44.463"></a><span id="l44.463">     return;</span>
<a href="#l44.464"></a><span id="l44.464" class="difflineminus">-  PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;from = %s&quot;, from.get()));</span>
<a href="#l44.465"></a><span id="l44.465" class="difflineplus">+  MOZ_LOG(NNTP, LogLevel::Info,(&quot;from = %s&quot;, from.get()));</span>
<a href="#l44.466"></a><span id="l44.466"> </span>
<a href="#l44.467"></a><span id="l44.467">   nsCString us;</span>
<a href="#l44.468"></a><span id="l44.468">   nsCString them;</span>
<a href="#l44.469"></a><span id="l44.469">   ExtractEmail(EncodedHeader(from), us);</span>
<a href="#l44.470"></a><span id="l44.470">   ExtractEmail(EncodedHeader(aOldFrom), them);</span>
<a href="#l44.471"></a><span id="l44.471"> </span>
<a href="#l44.472"></a><span id="l44.472" class="difflineminus">-  PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;us = %s, them = %s&quot;, us.get(), them.get()));</span>
<a href="#l44.473"></a><span id="l44.473" class="difflineplus">+  MOZ_LOG(NNTP, LogLevel::Info,(&quot;us = %s, them = %s&quot;, us.get(), them.get()));</span>
<a href="#l44.474"></a><span id="l44.474"> </span>
<a href="#l44.475"></a><span id="l44.475">   if (us.Equals(them, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l44.476"></a><span id="l44.476">     aFrom = from;</span>
<a href="#l44.477"></a><span id="l44.477"> }</span>
<a href="#l44.478"></a><span id="l44.478"> </span>
<a href="#l44.479"></a><span id="l44.479"> nsresult nsNNTPProtocol::DoCancel()</span>
<a href="#l44.480"></a><span id="l44.480"> {</span>
<a href="#l44.481"></a><span id="l44.481">     int32_t status = 0;</span>
<a href="#l44.482"></a><span id="l44.482" class="difflineat">@@ -3623,17 +3624,17 @@ nsresult nsNNTPProtocol::DoCancel()</span>
<a href="#l44.483"></a><span id="l44.483">       m_nextState = NNTP_RESPONSE;</span>
<a href="#l44.484"></a><span id="l44.484">       m_nextStateAfterResponse = NNTP_SEND_POST_DATA_RESPONSE;</span>
<a href="#l44.485"></a><span id="l44.485">       SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l44.486"></a><span id="l44.486">       failure = true;</span>
<a href="#l44.487"></a><span id="l44.487">       goto FAIL;</span>
<a href="#l44.488"></a><span id="l44.488">     }</span>
<a href="#l44.489"></a><span id="l44.489">     else</span>
<a href="#l44.490"></a><span id="l44.490">     {</span>
<a href="#l44.491"></a><span id="l44.491" class="difflineminus">-      PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) CANCELCHK not supported, so post the cancel message as %s&quot;, this, from.get()));</span>
<a href="#l44.492"></a><span id="l44.492" class="difflineplus">+      MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) CANCELCHK not supported, so post the cancel message as %s&quot;, this, from.get()));</span>
<a href="#l44.493"></a><span id="l44.493">     }</span>
<a href="#l44.494"></a><span id="l44.494">   }</span>
<a href="#l44.495"></a><span id="l44.495">   else</span>
<a href="#l44.496"></a><span id="l44.496">     NNTP_LOG_NOTE(&quot;CANCELCHK supported, don't do the us vs. them test&quot;);</span>
<a href="#l44.497"></a><span id="l44.497"> </span>
<a href="#l44.498"></a><span id="l44.498">   // QA needs to be able to disable this confirm dialog, for the automated tests.  see bug #31057</span>
<a href="#l44.499"></a><span id="l44.499">   rv = prefBranch-&gt;GetBoolPref(PREF_NEWS_CANCEL_CONFIRM, &amp;requireConfirmationForCancel);</span>
<a href="#l44.500"></a><span id="l44.500">   if (NS_FAILED(rv) || requireConfirmationForCancel) {</span>
<a href="#l44.501"></a><span id="l44.501" class="difflineat">@@ -3908,17 +3909,17 @@ nsresult nsNNTPProtocol::ListPrettyNames</span>
<a href="#l44.502"></a><span id="l44.502">         if (NS_FAILED(m_nntpServer-&gt;GetCharset(charset) ||</span>
<a href="#l44.503"></a><span id="l44.503">             NS_FAILED(ConvertToUnicode(charset, line, lineUtf16)) ||</span>
<a href="#l44.504"></a><span id="l44.504">             NS_FAILED(ConvertToUnicode(charset, prettyName, prettyNameUtf16)))) {</span>
<a href="#l44.505"></a><span id="l44.505">           CopyUTF8toUTF16(line, lineUtf16);</span>
<a href="#l44.506"></a><span id="l44.506">           CopyUTF8toUTF16(prettyName, prettyNameUtf16);</span>
<a href="#l44.507"></a><span id="l44.507">         }</span>
<a href="#l44.508"></a><span id="l44.508">         m_nntpServer-&gt;SetPrettyNameForGroup(lineUtf16, prettyNameUtf16);</span>
<a href="#l44.509"></a><span id="l44.509"> </span>
<a href="#l44.510"></a><span id="l44.510" class="difflineminus">-        PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) adding pretty name %s&quot;, this,</span>
<a href="#l44.511"></a><span id="l44.511" class="difflineplus">+        MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) adding pretty name %s&quot;, this,</span>
<a href="#l44.512"></a><span id="l44.512">                NS_ConvertUTF16toUTF8(prettyNameUtf16).get()));</span>
<a href="#l44.513"></a><span id="l44.513">       }</span>
<a href="#l44.514"></a><span id="l44.514"> #endif</span>
<a href="#l44.515"></a><span id="l44.515">     }</span>
<a href="#l44.516"></a><span id="l44.516">     else</span>
<a href="#l44.517"></a><span id="l44.517">     {</span>
<a href="#l44.518"></a><span id="l44.518">       m_nextState = DISPLAY_NEWSGROUPS;  /* this assumes we were doing a list */</span>
<a href="#l44.519"></a><span id="l44.519">       /*      m_nextState = NEWS_DONE;   */ /* ### dmb - don't really know */</span>
<a href="#l44.520"></a><span id="l44.520" class="difflineat">@@ -4009,17 +4010,17 @@ nsresult nsNNTPProtocol::ListXActiveResp</span>
<a href="#l44.521"></a><span id="l44.521">         if (m_nntpServer) {</span>
<a href="#l44.522"></a><span id="l44.522">           rv = m_nntpServer-&gt;AddNewsgroupToList(line);</span>
<a href="#l44.523"></a><span id="l44.523">           NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to add to subscribe ds&quot;);</span>
<a href="#l44.524"></a><span id="l44.524">         }</span>
<a href="#l44.525"></a><span id="l44.525"> </span>
<a href="#l44.526"></a><span id="l44.526">         /* we're either going to list prettynames first, or list</span>
<a href="#l44.527"></a><span id="l44.527">         all prettynames every time, so we won't care so much</span>
<a href="#l44.528"></a><span id="l44.528">         if it gets interrupted. */</span>
<a href="#l44.529"></a><span id="l44.529" class="difflineminus">-        PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) got xactive for %s of %s&quot;, this, line, flags));</span>
<a href="#l44.530"></a><span id="l44.530" class="difflineplus">+        MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) got xactive for %s of %s&quot;, this, line, flags));</span>
<a href="#l44.531"></a><span id="l44.531">         /*  This isn't required, because the extra info is</span>
<a href="#l44.532"></a><span id="l44.532">         initialized to false for new groups. And it's</span>
<a href="#l44.533"></a><span id="l44.533">         an expensive call.</span>
<a href="#l44.534"></a><span id="l44.534">         */</span>
<a href="#l44.535"></a><span id="l44.535">         /* MSG_SetGroupNeedsExtraInfo(cd-&gt;host, line, false); */</span>
<a href="#l44.536"></a><span id="l44.536">       }</span>
<a href="#l44.537"></a><span id="l44.537">     }</span>
<a href="#l44.538"></a><span id="l44.538">     else</span>
<a href="#l44.539"></a><span id="l44.539" class="difflineat">@@ -4039,17 +4040,17 @@ nsresult nsNNTPProtocol::ListXActiveResp</span>
<a href="#l44.540"></a><span id="l44.540">                                      getter_AddRefs(m_newsFolder));</span>
<a href="#l44.541"></a><span id="l44.541">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l44.542"></a><span id="l44.542"> </span>
<a href="#l44.543"></a><span id="l44.543">         // see if we got a different group</span>
<a href="#l44.544"></a><span id="l44.544">         if (old_newsFolder &amp;&amp; m_newsFolder &amp;&amp;</span>
<a href="#l44.545"></a><span id="l44.545">           (old_newsFolder.get() != m_newsFolder.get()))</span>
<a href="#l44.546"></a><span id="l44.546">           /* make sure we're not stuck on the same group */</span>
<a href="#l44.547"></a><span id="l44.547">         {</span>
<a href="#l44.548"></a><span id="l44.548" class="difflineminus">-          PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) listing xactive for %s&quot;, this, groupName.get()));</span>
<a href="#l44.549"></a><span id="l44.549" class="difflineplus">+          MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) listing xactive for %s&quot;, this, groupName.get()));</span>
<a href="#l44.550"></a><span id="l44.550">           m_nextState = NNTP_LIST_XACTIVE;</span>
<a href="#l44.551"></a><span id="l44.551">           ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l44.552"></a><span id="l44.552">           PR_FREEIF(line);</span>
<a href="#l44.553"></a><span id="l44.553">           return NS_OK;</span>
<a href="#l44.554"></a><span id="l44.554">         }</span>
<a href="#l44.555"></a><span id="l44.555">         else</span>
<a href="#l44.556"></a><span id="l44.556">         {</span>
<a href="#l44.557"></a><span id="l44.557">           m_newsFolder = nullptr;</span>
<a href="#l44.558"></a><span id="l44.558" class="difflineat">@@ -4239,17 +4240,17 @@ nsresult nsNNTPProtocol::ProcessProtocol</span>
<a href="#l44.559"></a><span id="l44.559">     // In these cases, we are going to return since our data is effectively</span>
<a href="#l44.560"></a><span id="l44.560">     // invalid. However, nsInputStream would really rather that we at least read</span>
<a href="#l44.561"></a><span id="l44.561">     // some of our input data (even if not all of it). Therefore, we'll read a</span>
<a href="#l44.562"></a><span id="l44.562">     // little bit.</span>
<a href="#l44.563"></a><span id="l44.563">     char buffer[128];</span>
<a href="#l44.564"></a><span id="l44.564">     uint32_t readData = 0;</span>
<a href="#l44.565"></a><span id="l44.565">     inputStream-&gt;Read(buffer, 127, &amp;readData);</span>
<a href="#l44.566"></a><span id="l44.566">     buffer[readData] = '\0';</span>
<a href="#l44.567"></a><span id="l44.567" class="difflineminus">-    PR_LOG(NNTP, PR_LOG_DEBUG, (&quot;(%p) Ignoring data: %s&quot;, this, buffer));</span>
<a href="#l44.568"></a><span id="l44.568" class="difflineplus">+    MOZ_LOG(NNTP, LogLevel::Debug, (&quot;(%p) Ignoring data: %s&quot;, this, buffer));</span>
<a href="#l44.569"></a><span id="l44.569">   }</span>
<a href="#l44.570"></a><span id="l44.570"> </span>
<a href="#l44.571"></a><span id="l44.571">   if (!mailnewsurl)</span>
<a href="#l44.572"></a><span id="l44.572">     return NS_OK; // probably no data available - it's OK.</span>
<a href="#l44.573"></a><span id="l44.573"> </span>
<a href="#l44.574"></a><span id="l44.574">   if (!m_nntpServer)</span>
<a href="#l44.575"></a><span id="l44.575">   {</span>
<a href="#l44.576"></a><span id="l44.576">     // Parsing must result in our m_nntpServer being set, so we should never</span>
<a href="#l44.577"></a><span id="l44.577" class="difflineat">@@ -4259,17 +4260,17 @@ nsresult nsNNTPProtocol::ProcessProtocol</span>
<a href="#l44.578"></a><span id="l44.578">     // input.</span>
<a href="#l44.579"></a><span id="l44.579">     return inputStream ? inputStream-&gt;Close() : NS_OK;</span>
<a href="#l44.580"></a><span id="l44.580">   }</span>
<a href="#l44.581"></a><span id="l44.581"> </span>
<a href="#l44.582"></a><span id="l44.582">   ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l44.583"></a><span id="l44.583"> </span>
<a href="#l44.584"></a><span id="l44.584">   while(!TestFlag(NNTP_PAUSE_FOR_READ))</span>
<a href="#l44.585"></a><span id="l44.585">   {</span>
<a href="#l44.586"></a><span id="l44.586" class="difflineminus">-    PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) Next state: %s&quot;,this, stateLabels[m_nextState]));</span>
<a href="#l44.587"></a><span id="l44.587" class="difflineplus">+    MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) Next state: %s&quot;,this, stateLabels[m_nextState]));</span>
<a href="#l44.588"></a><span id="l44.588">     // examine our current state and call an appropriate handler for that state.....</span>
<a href="#l44.589"></a><span id="l44.589">     switch(m_nextState)</span>
<a href="#l44.590"></a><span id="l44.590">     {</span>
<a href="#l44.591"></a><span id="l44.591">     case NNTP_RESPONSE:</span>
<a href="#l44.592"></a><span id="l44.592">       if (inputStream == nullptr)</span>
<a href="#l44.593"></a><span id="l44.593">         SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l44.594"></a><span id="l44.594">       else</span>
<a href="#l44.595"></a><span id="l44.595">         status = NewsResponse(inputStream, length);</span>
<a href="#l44.596"></a><span id="l44.596" class="difflineat">@@ -4591,17 +4592,17 @@ nsresult nsNNTPProtocol::ProcessProtocol</span>
<a href="#l44.597"></a><span id="l44.597"> </span>
<a href="#l44.598"></a><span id="l44.598">   } /* end big while */</span>
<a href="#l44.599"></a><span id="l44.599"> </span>
<a href="#l44.600"></a><span id="l44.600">   return NS_OK; /* keep going */</span>
<a href="#l44.601"></a><span id="l44.601"> }</span>
<a href="#l44.602"></a><span id="l44.602"> </span>
<a href="#l44.603"></a><span id="l44.603"> NS_IMETHODIMP nsNNTPProtocol::CloseConnection()</span>
<a href="#l44.604"></a><span id="l44.604"> {</span>
<a href="#l44.605"></a><span id="l44.605" class="difflineminus">-  PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) ClosingConnection&quot;,this));</span>
<a href="#l44.606"></a><span id="l44.606" class="difflineplus">+  MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) ClosingConnection&quot;,this));</span>
<a href="#l44.607"></a><span id="l44.607">   SendData(NNTP_CMD_QUIT); // this will cause OnStopRequest get called, which will call CloseSocket()</span>
<a href="#l44.608"></a><span id="l44.608">   // break some cycles</span>
<a href="#l44.609"></a><span id="l44.609">   CleanupNewsgroupList();</span>
<a href="#l44.610"></a><span id="l44.610"> </span>
<a href="#l44.611"></a><span id="l44.611">   if (m_nntpServer) {</span>
<a href="#l44.612"></a><span id="l44.612">     m_nntpServer-&gt;RemoveConnection(this);</span>
<a href="#l44.613"></a><span id="l44.613">     m_nntpServer = nullptr;</span>
<a href="#l44.614"></a><span id="l44.614">   }</span>
<a href="#l44.615"></a><span id="l44.615" class="difflineat">@@ -4632,17 +4633,17 @@ nsresult nsNNTPProtocol::CleanupAfterRun</span>
<a href="#l44.616"></a><span id="l44.616"> {</span>
<a href="#l44.617"></a><span id="l44.617">   /* do we need to know if we're parsing xover to call finish xover?  */</span>
<a href="#l44.618"></a><span id="l44.618">   /* yes, I think we do! Why did I think we should??? */</span>
<a href="#l44.619"></a><span id="l44.619">   /* If we've gotten to NEWS_FREE and there is still XOVER</span>
<a href="#l44.620"></a><span id="l44.620">   data, there was an error or we were interrupted or</span>
<a href="#l44.621"></a><span id="l44.621">   something.  So, tell libmsg there was an abnormal</span>
<a href="#l44.622"></a><span id="l44.622">   exit so that it can free its data. */</span>
<a href="#l44.623"></a><span id="l44.623"> </span>
<a href="#l44.624"></a><span id="l44.624" class="difflineminus">-  PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) CleanupAfterRunningUrl()&quot;, this));</span>
<a href="#l44.625"></a><span id="l44.625" class="difflineplus">+  MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) CleanupAfterRunningUrl()&quot;, this));</span>
<a href="#l44.626"></a><span id="l44.626"> </span>
<a href="#l44.627"></a><span id="l44.627">   // send StopRequest notification after we've cleaned up the protocol</span>
<a href="#l44.628"></a><span id="l44.628">   // because it can synchronously causes a new url to get run in the</span>
<a href="#l44.629"></a><span id="l44.629">   // protocol - truly evil, but we're stuck at the moment.</span>
<a href="#l44.630"></a><span id="l44.630">   if (m_channelListener)</span>
<a href="#l44.631"></a><span id="l44.631">     (void) m_channelListener-&gt;OnStopRequest(this, m_channelContext, NS_OK);</span>
<a href="#l44.632"></a><span id="l44.632"> </span>
<a href="#l44.633"></a><span id="l44.633">   if (m_loadGroup)</span>
<a href="#l44.634"></a><span id="l44.634" class="difflineat">@@ -4681,17 +4682,17 @@ nsresult nsNNTPProtocol::CleanupAfterRun</span>
<a href="#l44.635"></a><span id="l44.635">   // last thing we do.</span>
<a href="#l44.636"></a><span id="l44.636">   SetIsBusy(false);</span>
<a href="#l44.637"></a><span id="l44.637"> </span>
<a href="#l44.638"></a><span id="l44.638">   return NS_OK;</span>
<a href="#l44.639"></a><span id="l44.639"> }</span>
<a href="#l44.640"></a><span id="l44.640"> </span>
<a href="#l44.641"></a><span id="l44.641"> nsresult nsNNTPProtocol::CloseSocket()</span>
<a href="#l44.642"></a><span id="l44.642"> {</span>
<a href="#l44.643"></a><span id="l44.643" class="difflineminus">-  PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) ClosingSocket()&quot;,this));</span>
<a href="#l44.644"></a><span id="l44.644" class="difflineplus">+  MOZ_LOG(NNTP, LogLevel::Info,(&quot;(%p) ClosingSocket()&quot;,this));</span>
<a href="#l44.645"></a><span id="l44.645"> </span>
<a href="#l44.646"></a><span id="l44.646">   if (m_nntpServer) {</span>
<a href="#l44.647"></a><span id="l44.647">     m_nntpServer-&gt;RemoveConnection(this);</span>
<a href="#l44.648"></a><span id="l44.648">     m_nntpServer = nullptr;</span>
<a href="#l44.649"></a><span id="l44.649">   }</span>
<a href="#l44.650"></a><span id="l44.650"> </span>
<a href="#l44.651"></a><span id="l44.651">   CleanupAfterRunningUrl(); // is this needed?</span>
<a href="#l44.652"></a><span id="l44.652">   return nsMsgProtocol::CloseSocket();</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

