<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 1938:212adb96ed90119daf0027a44b176240f198569a</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 212adb96ed90119daf0027a44b176240f198569a" />
<meta property="og:url" content="/comm-central/rev/212adb96ed90119daf0027a44b176240f198569a" />
<meta property="og:description" content="Bug 36810 - Autosave URIs of open windows and tabs for later restoration in event of crash (session restore). r/rs=ajschult, sr=Neil, ui-r=Neil, a=wanted2+." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 212adb96ed90119daf0027a44b176240f198569a 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/212adb96ed90119daf0027a44b176240f198569a">shortlog</a> |
<a href="/comm-central/log/212adb96ed90119daf0027a44b176240f198569a">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/212adb96ed90119daf0027a44b176240f198569a">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/212adb96ed90119daf0027a44b176240f198569a">files</a> |
changeset |
<a href="/comm-central/raw-rev/212adb96ed90119daf0027a44b176240f198569a">raw</a>  | <a href="/comm-central/archive/212adb96ed90119daf0027a44b176240f198569a.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=36810">Bug 36810</a> - Autosave URIs of open windows and tabs for later restoration in event of crash (session restore). r/rs=ajschult, sr=Neil, ui-r=Neil, a=wanted2+.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#105;&#115;&#97;&#107;&#32;&#75;&#104;&#97;&#99;&#104;&#97;&#116;&#114;&#121;&#97;&#110;&#32;&#60;&#109;&#105;&#115;&#97;&#107;&#64;&#120;&#116;&#101;&#114;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 13 Feb 2009 19:49:27 +0100</td></tr>

<tr>
 <td>changeset 1938</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/212adb96ed90119daf0027a44b176240f198569a">212adb96ed90119daf0027a44b176240f198569a</a></td>
</tr>



<tr>
<td>parent 1937</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/6d1a6a5cb2705bb0baf17c33791703511eae520b">6d1a6a5cb2705bb0baf17c33791703511eae520b</a>
</td>
</tr>

<tr>
<td>child 1939</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b">1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=212adb96ed90119daf0027a44b176240f198569a">1568</a></td></tr>
<tr><td>push user</td><td>stefanh@inbox.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 13 Feb 2009 18:49:37 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@212adb96ed90 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=212adb96ed90119daf0027a44b176240f198569a">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=212adb96ed90119daf0027a44b176240f198569a&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=212adb96ed90119daf0027a44b176240f198569a&newProject=comm-central&newRevision=212adb96ed90119daf0027a44b176240f198569a&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=212adb96ed90119daf0027a44b176240f198569a&newProject=comm-central&newRevision=212adb96ed90119daf0027a44b176240f198569a&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=212adb96ed90119daf0027a44b176240f198569a&newProject=comm-central&newRevision=212adb96ed90119daf0027a44b176240f198569a&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Neil%29&revcount=50">Neil</a>, <a href="/comm-central/log?rev=reviewer%28Neil%29&revcount=50">Neil</a>, <a href="/comm-central/log?rev=reviewer%28wanted2%29&revcount=50">wanted2</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=36810">36810</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=36810">Bug 36810</a> - Autosave URIs of open windows and tabs for later restoration in event of crash (session restore). r/rs=ajschult, sr=Neil, ui-r=Neil, a=wanted2+.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/212adb96ed90119daf0027a44b176240f198569a/suite/browser/browser-prefs.js">suite/browser/browser-prefs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/212adb96ed90119daf0027a44b176240f198569a/suite/browser/browser-prefs.js">file</a> |
<a href="/comm-central/annotate/212adb96ed90119daf0027a44b176240f198569a/suite/browser/browser-prefs.js">annotate</a> |
<a href="/comm-central/diff/212adb96ed90119daf0027a44b176240f198569a/suite/browser/browser-prefs.js">diff</a> |
<a href="/comm-central/comparison/212adb96ed90119daf0027a44b176240f198569a/suite/browser/browser-prefs.js">comparison</a> |
<a href="/comm-central/log/212adb96ed90119daf0027a44b176240f198569a/suite/browser/browser-prefs.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/212adb96ed90119daf0027a44b176240f198569a/suite/browser/navigator.js">suite/browser/navigator.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/212adb96ed90119daf0027a44b176240f198569a/suite/browser/navigator.js">file</a> |
<a href="/comm-central/annotate/212adb96ed90119daf0027a44b176240f198569a/suite/browser/navigator.js">annotate</a> |
<a href="/comm-central/diff/212adb96ed90119daf0027a44b176240f198569a/suite/browser/navigator.js">diff</a> |
<a href="/comm-central/comparison/212adb96ed90119daf0027a44b176240f198569a/suite/browser/navigator.js">comparison</a> |
<a href="/comm-central/log/212adb96ed90119daf0027a44b176240f198569a/suite/browser/navigator.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/212adb96ed90119daf0027a44b176240f198569a/suite/browser/nsBrowserContentHandler.js">suite/browser/nsBrowserContentHandler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/212adb96ed90119daf0027a44b176240f198569a/suite/browser/nsBrowserContentHandler.js">file</a> |
<a href="/comm-central/annotate/212adb96ed90119daf0027a44b176240f198569a/suite/browser/nsBrowserContentHandler.js">annotate</a> |
<a href="/comm-central/diff/212adb96ed90119daf0027a44b176240f198569a/suite/browser/nsBrowserContentHandler.js">diff</a> |
<a href="/comm-central/comparison/212adb96ed90119daf0027a44b176240f198569a/suite/browser/nsBrowserContentHandler.js">comparison</a> |
<a href="/comm-central/log/212adb96ed90119daf0027a44b176240f198569a/suite/browser/nsBrowserContentHandler.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/212adb96ed90119daf0027a44b176240f198569a/suite/browser/tabbrowser.xml">suite/browser/tabbrowser.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/212adb96ed90119daf0027a44b176240f198569a/suite/browser/tabbrowser.xml">file</a> |
<a href="/comm-central/annotate/212adb96ed90119daf0027a44b176240f198569a/suite/browser/tabbrowser.xml">annotate</a> |
<a href="/comm-central/diff/212adb96ed90119daf0027a44b176240f198569a/suite/browser/tabbrowser.xml">diff</a> |
<a href="/comm-central/comparison/212adb96ed90119daf0027a44b176240f198569a/suite/browser/tabbrowser.xml">comparison</a> |
<a href="/comm-central/log/212adb96ed90119daf0027a44b176240f198569a/suite/browser/tabbrowser.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/212adb96ed90119daf0027a44b176240f198569a/suite/common/pref/pref-navigator.xul">suite/common/pref/pref-navigator.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/212adb96ed90119daf0027a44b176240f198569a/suite/common/pref/pref-navigator.xul">file</a> |
<a href="/comm-central/annotate/212adb96ed90119daf0027a44b176240f198569a/suite/common/pref/pref-navigator.xul">annotate</a> |
<a href="/comm-central/diff/212adb96ed90119daf0027a44b176240f198569a/suite/common/pref/pref-navigator.xul">diff</a> |
<a href="/comm-central/comparison/212adb96ed90119daf0027a44b176240f198569a/suite/common/pref/pref-navigator.xul">comparison</a> |
<a href="/comm-central/log/212adb96ed90119daf0027a44b176240f198569a/suite/common/pref/pref-navigator.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/212adb96ed90119daf0027a44b176240f198569a/suite/common/public/Makefile.in">suite/common/public/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/212adb96ed90119daf0027a44b176240f198569a/suite/common/public/Makefile.in">file</a> |
<a href="/comm-central/annotate/212adb96ed90119daf0027a44b176240f198569a/suite/common/public/Makefile.in">annotate</a> |
<a href="/comm-central/diff/212adb96ed90119daf0027a44b176240f198569a/suite/common/public/Makefile.in">diff</a> |
<a href="/comm-central/comparison/212adb96ed90119daf0027a44b176240f198569a/suite/common/public/Makefile.in">comparison</a> |
<a href="/comm-central/log/212adb96ed90119daf0027a44b176240f198569a/suite/common/public/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/212adb96ed90119daf0027a44b176240f198569a/suite/common/public/nsISessionStartup.idl">suite/common/public/nsISessionStartup.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/212adb96ed90119daf0027a44b176240f198569a/suite/common/public/nsISessionStartup.idl">file</a> |
<a href="/comm-central/annotate/212adb96ed90119daf0027a44b176240f198569a/suite/common/public/nsISessionStartup.idl">annotate</a> |
<a href="/comm-central/diff/212adb96ed90119daf0027a44b176240f198569a/suite/common/public/nsISessionStartup.idl">diff</a> |
<a href="/comm-central/comparison/212adb96ed90119daf0027a44b176240f198569a/suite/common/public/nsISessionStartup.idl">comparison</a> |
<a href="/comm-central/log/212adb96ed90119daf0027a44b176240f198569a/suite/common/public/nsISessionStartup.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/212adb96ed90119daf0027a44b176240f198569a/suite/common/public/nsISessionStore.idl">suite/common/public/nsISessionStore.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/212adb96ed90119daf0027a44b176240f198569a/suite/common/public/nsISessionStore.idl">file</a> |
<a href="/comm-central/annotate/212adb96ed90119daf0027a44b176240f198569a/suite/common/public/nsISessionStore.idl">annotate</a> |
<a href="/comm-central/diff/212adb96ed90119daf0027a44b176240f198569a/suite/common/public/nsISessionStore.idl">diff</a> |
<a href="/comm-central/comparison/212adb96ed90119daf0027a44b176240f198569a/suite/common/public/nsISessionStore.idl">comparison</a> |
<a href="/comm-central/log/212adb96ed90119daf0027a44b176240f198569a/suite/common/public/nsISessionStore.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/212adb96ed90119daf0027a44b176240f198569a/suite/common/src/Makefile.in">suite/common/src/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/212adb96ed90119daf0027a44b176240f198569a/suite/common/src/Makefile.in">file</a> |
<a href="/comm-central/annotate/212adb96ed90119daf0027a44b176240f198569a/suite/common/src/Makefile.in">annotate</a> |
<a href="/comm-central/diff/212adb96ed90119daf0027a44b176240f198569a/suite/common/src/Makefile.in">diff</a> |
<a href="/comm-central/comparison/212adb96ed90119daf0027a44b176240f198569a/suite/common/src/Makefile.in">comparison</a> |
<a href="/comm-central/log/212adb96ed90119daf0027a44b176240f198569a/suite/common/src/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/212adb96ed90119daf0027a44b176240f198569a/suite/common/src/nsSessionStartup.js">suite/common/src/nsSessionStartup.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/212adb96ed90119daf0027a44b176240f198569a/suite/common/src/nsSessionStartup.js">file</a> |
<a href="/comm-central/annotate/212adb96ed90119daf0027a44b176240f198569a/suite/common/src/nsSessionStartup.js">annotate</a> |
<a href="/comm-central/diff/212adb96ed90119daf0027a44b176240f198569a/suite/common/src/nsSessionStartup.js">diff</a> |
<a href="/comm-central/comparison/212adb96ed90119daf0027a44b176240f198569a/suite/common/src/nsSessionStartup.js">comparison</a> |
<a href="/comm-central/log/212adb96ed90119daf0027a44b176240f198569a/suite/common/src/nsSessionStartup.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/212adb96ed90119daf0027a44b176240f198569a/suite/common/src/nsSessionStore.js">suite/common/src/nsSessionStore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/212adb96ed90119daf0027a44b176240f198569a/suite/common/src/nsSessionStore.js">file</a> |
<a href="/comm-central/annotate/212adb96ed90119daf0027a44b176240f198569a/suite/common/src/nsSessionStore.js">annotate</a> |
<a href="/comm-central/diff/212adb96ed90119daf0027a44b176240f198569a/suite/common/src/nsSessionStore.js">diff</a> |
<a href="/comm-central/comparison/212adb96ed90119daf0027a44b176240f198569a/suite/common/src/nsSessionStore.js">comparison</a> |
<a href="/comm-central/log/212adb96ed90119daf0027a44b176240f198569a/suite/common/src/nsSessionStore.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/212adb96ed90119daf0027a44b176240f198569a/suite/common/src/nsSuiteGlue.js">suite/common/src/nsSuiteGlue.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/212adb96ed90119daf0027a44b176240f198569a/suite/common/src/nsSuiteGlue.js">file</a> |
<a href="/comm-central/annotate/212adb96ed90119daf0027a44b176240f198569a/suite/common/src/nsSuiteGlue.js">annotate</a> |
<a href="/comm-central/diff/212adb96ed90119daf0027a44b176240f198569a/suite/common/src/nsSuiteGlue.js">diff</a> |
<a href="/comm-central/comparison/212adb96ed90119daf0027a44b176240f198569a/suite/common/src/nsSuiteGlue.js">comparison</a> |
<a href="/comm-central/log/212adb96ed90119daf0027a44b176240f198569a/suite/common/src/nsSuiteGlue.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/212adb96ed90119daf0027a44b176240f198569a/suite/installer/unix/packages">suite/installer/unix/packages</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/212adb96ed90119daf0027a44b176240f198569a/suite/installer/unix/packages">file</a> |
<a href="/comm-central/annotate/212adb96ed90119daf0027a44b176240f198569a/suite/installer/unix/packages">annotate</a> |
<a href="/comm-central/diff/212adb96ed90119daf0027a44b176240f198569a/suite/installer/unix/packages">diff</a> |
<a href="/comm-central/comparison/212adb96ed90119daf0027a44b176240f198569a/suite/installer/unix/packages">comparison</a> |
<a href="/comm-central/log/212adb96ed90119daf0027a44b176240f198569a/suite/installer/unix/packages">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/212adb96ed90119daf0027a44b176240f198569a/suite/installer/windows/packages">suite/installer/windows/packages</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/212adb96ed90119daf0027a44b176240f198569a/suite/installer/windows/packages">file</a> |
<a href="/comm-central/annotate/212adb96ed90119daf0027a44b176240f198569a/suite/installer/windows/packages">annotate</a> |
<a href="/comm-central/diff/212adb96ed90119daf0027a44b176240f198569a/suite/installer/windows/packages">diff</a> |
<a href="/comm-central/comparison/212adb96ed90119daf0027a44b176240f198569a/suite/installer/windows/packages">comparison</a> |
<a href="/comm-central/log/212adb96ed90119daf0027a44b176240f198569a/suite/installer/windows/packages">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/212adb96ed90119daf0027a44b176240f198569a/suite/locales/en-US/chrome/common/pref/pref-navigator.dtd">suite/locales/en-US/chrome/common/pref/pref-navigator.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/212adb96ed90119daf0027a44b176240f198569a/suite/locales/en-US/chrome/common/pref/pref-navigator.dtd">file</a> |
<a href="/comm-central/annotate/212adb96ed90119daf0027a44b176240f198569a/suite/locales/en-US/chrome/common/pref/pref-navigator.dtd">annotate</a> |
<a href="/comm-central/diff/212adb96ed90119daf0027a44b176240f198569a/suite/locales/en-US/chrome/common/pref/pref-navigator.dtd">diff</a> |
<a href="/comm-central/comparison/212adb96ed90119daf0027a44b176240f198569a/suite/locales/en-US/chrome/common/pref/pref-navigator.dtd">comparison</a> |
<a href="/comm-central/log/212adb96ed90119daf0027a44b176240f198569a/suite/locales/en-US/chrome/common/pref/pref-navigator.dtd">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/212adb96ed90119daf0027a44b176240f198569a/suite/locales/en-US/chrome/common/sessionstore.properties">suite/locales/en-US/chrome/common/sessionstore.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/212adb96ed90119daf0027a44b176240f198569a/suite/locales/en-US/chrome/common/sessionstore.properties">file</a> |
<a href="/comm-central/annotate/212adb96ed90119daf0027a44b176240f198569a/suite/locales/en-US/chrome/common/sessionstore.properties">annotate</a> |
<a href="/comm-central/diff/212adb96ed90119daf0027a44b176240f198569a/suite/locales/en-US/chrome/common/sessionstore.properties">diff</a> |
<a href="/comm-central/comparison/212adb96ed90119daf0027a44b176240f198569a/suite/locales/en-US/chrome/common/sessionstore.properties">comparison</a> |
<a href="/comm-central/log/212adb96ed90119daf0027a44b176240f198569a/suite/locales/en-US/chrome/common/sessionstore.properties">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/212adb96ed90119daf0027a44b176240f198569a/suite/locales/jar.mn">suite/locales/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/212adb96ed90119daf0027a44b176240f198569a/suite/locales/jar.mn">file</a> |
<a href="/comm-central/annotate/212adb96ed90119daf0027a44b176240f198569a/suite/locales/jar.mn">annotate</a> |
<a href="/comm-central/diff/212adb96ed90119daf0027a44b176240f198569a/suite/locales/jar.mn">diff</a> |
<a href="/comm-central/comparison/212adb96ed90119daf0027a44b176240f198569a/suite/locales/jar.mn">comparison</a> |
<a href="/comm-central/log/212adb96ed90119daf0027a44b176240f198569a/suite/locales/jar.mn">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/suite/browser/browser-prefs.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/suite/browser/browser-prefs.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -305,16 +305,28 @@ pref(&quot;browser.contentHandlers.types.4.ty</span>
<a href="#l1.4"></a><span id="l1.4"> pref(&quot;browser.contentHandlers.types.5.title&quot;, &quot;chrome://navigator-region/locale/region.properties&quot;);</span>
<a href="#l1.5"></a><span id="l1.5"> pref(&quot;browser.contentHandlers.types.5.uri&quot;, &quot;chrome://navigator-region/locale/region.properties&quot;);</span>
<a href="#l1.6"></a><span id="l1.6"> pref(&quot;browser.contentHandlers.types.5.type&quot;, &quot;application/vnd.mozilla.maybe.feed&quot;);</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> pref(&quot;browser.feeds.handler&quot;, &quot;ask&quot;);</span>
<a href="#l1.9"></a><span id="l1.9"> pref(&quot;browser.videoFeeds.handler&quot;, &quot;ask&quot;);</span>
<a href="#l1.10"></a><span id="l1.10"> pref(&quot;browser.audioFeeds.handler&quot;, &quot;ask&quot;);</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+pref(&quot;browser.sessionstore.resume_from_crash&quot;, true);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+pref(&quot;browser.sessionstore.resume_session_once&quot;, false);</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+// minimal interval between two save operations in milliseconds</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+pref(&quot;browser.sessionstore.interval&quot;, 10000);</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+// maximum amount of POSTDATA to be saved in bytes per history entry (-1 = all of it)</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+// (NB: POSTDATA will be saved either entirely or not at all)</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+pref(&quot;browser.sessionstore.postdata&quot;, 0);</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+// on which sites to save text data, POSTDATA and cookies</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+// 0 = everywhere, 1 = unencrypted sites, 2 = nowhere</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+pref(&quot;browser.sessionstore.privacy_level&quot;, 1);</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+</span>
<a href="#l1.24"></a><span id="l1.24"> pref(&quot;shell.checkDefaultClient&quot;, true);</span>
<a href="#l1.25"></a><span id="l1.25"> // We want to check if we are the default client for browser and mail. See </span>
<a href="#l1.26"></a><span id="l1.26"> // suite/shell/public/nsIShellService.idl for the possible constants you can use</span>
<a href="#l1.27"></a><span id="l1.27"> pref(&quot;shell.checkDefaultApps&quot;, 3);</span>
<a href="#l1.28"></a><span id="l1.28"> </span>
<a href="#l1.29"></a><span id="l1.29"> pref(&quot;app.releaseNotesURL&quot;, &quot;chrome://branding/locale/brand.properties&quot;);</span>
<a href="#l1.30"></a><span id="l1.30"> pref(&quot;app.vendorURL&quot;, &quot;chrome://branding/locale/brand.properties&quot;);</span>
<a href="#l1.31"></a><span id="l1.31"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/suite/browser/navigator.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/suite/browser/navigator.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -681,32 +681,46 @@ function Startup()</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5">   // Before and after callbacks for the customizeToolbar code</span>
<a href="#l2.6"></a><span id="l2.6">   getNavToolbox().customizeInit = BrowserToolboxCustomizeInit;</span>
<a href="#l2.7"></a><span id="l2.7">   getNavToolbox().customizeDone = BrowserToolboxCustomizeDone;</span>
<a href="#l2.8"></a><span id="l2.8">   getNavToolbox().customizeChange = BrowserToolboxCustomizeChange;</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10">   // now load bookmarks after a delay</span>
<a href="#l2.11"></a><span id="l2.11">   setTimeout(LoadBookmarksCallback, 0);</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+  // initialize the session-restore service</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+  setTimeout(InitSessionStoreCallback, 0);</span>
<a href="#l2.15"></a><span id="l2.15"> }</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17"> function LoadBookmarksCallback()</span>
<a href="#l2.18"></a><span id="l2.18"> {</span>
<a href="#l2.19"></a><span id="l2.19">   // loads the services</span>
<a href="#l2.20"></a><span id="l2.20">   initServices();</span>
<a href="#l2.21"></a><span id="l2.21">   initBMService();</span>
<a href="#l2.22"></a><span id="l2.22">   BMSVC.readBookmarks();</span>
<a href="#l2.23"></a><span id="l2.23">   var bt = document.getElementById(&quot;bookmarks-ptf&quot;);</span>
<a href="#l2.24"></a><span id="l2.24">   if (bt) {</span>
<a href="#l2.25"></a><span id="l2.25">     bt.database.AddObserver(BookmarksToolbarRDFObserver);</span>
<a href="#l2.26"></a><span id="l2.26">   }</span>
<a href="#l2.27"></a><span id="l2.27">   window.addEventListener(&quot;resize&quot;, BookmarksToolbar.resizeFunc, false);</span>
<a href="#l2.28"></a><span id="l2.28">   controllers.appendController(BookmarksMenuController);</span>
<a href="#l2.29"></a><span id="l2.29"> }</span>
<a href="#l2.30"></a><span id="l2.30"> </span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+function InitSessionStoreCallback()</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+{</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+  try {</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+    var ss = Components.classes[&quot;@mozilla.org/suite/sessionstore;1&quot;]</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+                       .getService(Components.interfaces.nsISessionStore);</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+    ss.init(window);</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+  } catch(ex) {</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+    dump(&quot;nsSessionStore could not be initialized: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+  }</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+}</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+</span>
<a href="#l2.42"></a><span id="l2.42"> function WindowFocusTimerCallback(element)</span>
<a href="#l2.43"></a><span id="l2.43"> {</span>
<a href="#l2.44"></a><span id="l2.44">   // This fuction is a redo of the fix for jag bug 91884</span>
<a href="#l2.45"></a><span id="l2.45">   var ww = Components.classes[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l2.46"></a><span id="l2.46">                      .getService(Components.interfaces.nsIWindowWatcher);</span>
<a href="#l2.47"></a><span id="l2.47">   if (window == ww.activeWindow) {</span>
<a href="#l2.48"></a><span id="l2.48">     element.focus();</span>
<a href="#l2.49"></a><span id="l2.49">   } else {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/suite/browser/nsBrowserContentHandler.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/suite/browser/nsBrowserContentHandler.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -158,16 +158,25 @@ function getURLToLoad()</span>
<a href="#l3.4"></a><span id="l3.4">     try {</span>
<a href="#l3.5"></a><span id="l3.5">       return prefs.getComplexValue(&quot;startup.homepage_override_url&quot;,</span>
<a href="#l3.6"></a><span id="l3.6">                                    nsIPrefLocalizedString).data;</span>
<a href="#l3.7"></a><span id="l3.7">     } catch (e) {</span>
<a href="#l3.8"></a><span id="l3.8">     }</span>
<a href="#l3.9"></a><span id="l3.9">   }</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11">   try {</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+    var ss = Components.classes[&quot;@mozilla.org/suite/sessionstartup;1&quot;]</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+             .getService(Components.interfaces.nsISessionStartup);</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+    // return about:blank if we are restoring previous session</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+    if (ss.doRestore())</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+      return &quot;about:blank&quot;;</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+  } catch (e) {</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+  }</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+  try {</span>
<a href="#l3.21"></a><span id="l3.21">     switch (prefs.getIntPref(&quot;browser.startup.page&quot;)) {</span>
<a href="#l3.22"></a><span id="l3.22">     case 1:</span>
<a href="#l3.23"></a><span id="l3.23">       return getHomePageGroup(prefs);</span>
<a href="#l3.24"></a><span id="l3.24"> </span>
<a href="#l3.25"></a><span id="l3.25">     case 2:</span>
<a href="#l3.26"></a><span id="l3.26">       return Components.classes[&quot;@mozilla.org/browser/global-history;2&quot;]</span>
<a href="#l3.27"></a><span id="l3.27">                        .getService(nsIBrowserHistory).lastPageVisited;</span>
<a href="#l3.28"></a><span id="l3.28">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/suite/browser/tabbrowser.xml</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/suite/browser/tabbrowser.xml</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1278,17 +1278,17 @@</span>
<a href="#l4.4"></a><span id="l4.4">         &lt;/body&gt;</span>
<a href="#l4.5"></a><span id="l4.5">       &lt;/method&gt;</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7">       &lt;method name=&quot;restoreTab&quot;&gt;</span>
<a href="#l4.8"></a><span id="l4.8">         &lt;parameter name=&quot;aIndex&quot;/&gt;</span>
<a href="#l4.9"></a><span id="l4.9">         &lt;body&gt;</span>
<a href="#l4.10"></a><span id="l4.10">           &lt;![CDATA[</span>
<a href="#l4.11"></a><span id="l4.11">             if (aIndex &gt;= this.savedBrowsers.length || aIndex &lt; 0)</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-              return;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+              return null;</span>
<a href="#l4.14"></a><span id="l4.14"> </span>
<a href="#l4.15"></a><span id="l4.15">             this._browsers = null;</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17">             var t = this.referenceTab.cloneNode(true);</span>
<a href="#l4.18"></a><span id="l4.18">             var savedData = this.savedBrowsers.splice(aIndex, 1)[0];</span>
<a href="#l4.19"></a><span id="l4.19">             var b = savedData.browser;</span>
<a href="#l4.20"></a><span id="l4.20">             var hist = savedData.history;</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -1325,16 +1325,17 @@</span>
<a href="#l4.23"></a><span id="l4.23"> </span>
<a href="#l4.24"></a><span id="l4.24">             if (this.mTabs.length == 2 &amp;&amp;</span>
<a href="#l4.25"></a><span id="l4.25">                 !this.mTabs[0].linkedBrowser.webNavigation.sessionHistory.count)</span>
<a href="#l4.26"></a><span id="l4.26">               this.removeTab(this.mTabs[0]); // only one tab =&gt; selected anyway</span>
<a href="#l4.27"></a><span id="l4.27">             else {</span>
<a href="#l4.28"></a><span id="l4.28">               this.selectedTab = t;</span>
<a href="#l4.29"></a><span id="l4.29">               this.mStrip.collapsed = false;</span>
<a href="#l4.30"></a><span id="l4.30">             }</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+            return t;</span>
<a href="#l4.32"></a><span id="l4.32">           ]]&gt;</span>
<a href="#l4.33"></a><span id="l4.33">         &lt;/body&gt;</span>
<a href="#l4.34"></a><span id="l4.34">       &lt;/method&gt;</span>
<a href="#l4.35"></a><span id="l4.35"> </span>
<a href="#l4.36"></a><span id="l4.36">       &lt;method name=&quot;removeTab&quot;&gt;</span>
<a href="#l4.37"></a><span id="l4.37">         &lt;parameter name=&quot;aTab&quot;/&gt;</span>
<a href="#l4.38"></a><span id="l4.38">         &lt;parameter name=&quot;aDisableUndo&quot;/&gt;</span>
<a href="#l4.39"></a><span id="l4.39">         &lt;body&gt;</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineat">@@ -1449,17 +1450,17 @@</span>
<a href="#l4.41"></a><span id="l4.41">             // 1. save a copy of the session history (oldSH)</span>
<a href="#l4.42"></a><span id="l4.42">             // 2. hook up a new history</span>
<a href="#l4.43"></a><span id="l4.43">             // 3. add the last history entry from the old history the new</span>
<a href="#l4.44"></a><span id="l4.44">             //    history so we'll be able to go back from about:blank</span>
<a href="#l4.45"></a><span id="l4.45">             // 4. load a light URL in the browser, pushing the current page</span>
<a href="#l4.46"></a><span id="l4.46">             //    into bfcache - allows for saving of JS modifications</span>
<a href="#l4.47"></a><span id="l4.47">             //    and also saves RAM by allowing bfcache to evict the full page</span>
<a href="#l4.48"></a><span id="l4.48"> </span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-            this.savedBrowsers.unshift({browser: oldBrowser, history: oldSH});</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+            this.savedBrowsers.unshift({browser: oldBrowser, history: oldSH, tabData: aTab.tabData || {} });</span>
<a href="#l4.51"></a><span id="l4.51"> </span>
<a href="#l4.52"></a><span id="l4.52">             var newSH = Components.classes[&quot;@mozilla.org/browser/shistory;1&quot;]</span>
<a href="#l4.53"></a><span id="l4.53">                                     .createInstance(Components.interfaces.nsISHistoryInternal);</span>
<a href="#l4.54"></a><span id="l4.54">             oldBrowser.webNavigation.sessionHistory = newSH;</span>
<a href="#l4.55"></a><span id="l4.55">             var entry = oldSH.getEntryAtIndex(oldSH.index, false)</span>
<a href="#l4.56"></a><span id="l4.56">             newSH.addEntry(entry, true);</span>
<a href="#l4.57"></a><span id="l4.57"> </span>
<a href="#l4.58"></a><span id="l4.58">             // about:blank is light</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/suite/common/pref/pref-navigator.xul</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/suite/common/pref/pref-navigator.xul</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -104,16 +104,19 @@</span>
<a href="#l5.4"></a><span id="l5.4">                    label=&quot;&amp;blankPageRadio.label;&quot;</span>
<a href="#l5.5"></a><span id="l5.5">                    accesskey=&quot;&amp;blankPageRadio.accesskey;&quot;/&gt;</span>
<a href="#l5.6"></a><span id="l5.6">             &lt;radio value=&quot;1&quot;</span>
<a href="#l5.7"></a><span id="l5.7">                    label=&quot;&amp;homePageRadio.label;&quot;</span>
<a href="#l5.8"></a><span id="l5.8">                    accesskey=&quot;&amp;homePageRadio.accesskey;&quot;/&gt;</span>
<a href="#l5.9"></a><span id="l5.9">             &lt;radio value=&quot;2&quot;</span>
<a href="#l5.10"></a><span id="l5.10">                    label=&quot;&amp;lastPageRadio.label;&quot;</span>
<a href="#l5.11"></a><span id="l5.11">                    accesskey=&quot;&amp;lastPageRadio.accesskey;&quot;/&gt;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+            &lt;radio value=&quot;3&quot;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+                   label=&quot;&amp;restoreSessionRadio.label;&quot;</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+                   accesskey=&quot;&amp;restoreSessionRadio.accesskey;&quot;/&gt;</span>
<a href="#l5.15"></a><span id="l5.15">           &lt;/radiogroup&gt;</span>
<a href="#l5.16"></a><span id="l5.16">           &lt;radiogroup id=&quot;newWinPage&quot; preference=&quot;browser.windows.loadOnNewWindow&quot;&gt;</span>
<a href="#l5.17"></a><span id="l5.17">             &lt;radio value=&quot;0&quot;</span>
<a href="#l5.18"></a><span id="l5.18">                    label=&quot;&amp;blankPageRadio.label;&quot;</span>
<a href="#l5.19"></a><span id="l5.19">                    accesskey=&quot;&amp;blankPageRadio.accesskey;&quot;/&gt;</span>
<a href="#l5.20"></a><span id="l5.20">             &lt;radio value=&quot;1&quot;</span>
<a href="#l5.21"></a><span id="l5.21">                    label=&quot;&amp;homePageRadio.label;&quot;</span>
<a href="#l5.22"></a><span id="l5.22">                    accesskey=&quot;&amp;homePageRadio.accesskey;&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/suite/common/public/Makefile.in</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/suite/common/public/Makefile.in</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -42,12 +42,14 @@ VPATH		= @srcdir@</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5"> include $(DEPTH)/config/autoconf.mk</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7"> MODULE		= suitecommon</span>
<a href="#l6.8"></a><span id="l6.8"> XPIDL_MODULE	= suitecommon</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10"> XPIDLSRCS = \</span>
<a href="#l6.11"></a><span id="l6.11"> 	nsISuiteGlue.idl \</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+	nsISessionStartup.idl \</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+	nsISessionStore.idl \</span>
<a href="#l6.14"></a><span id="l6.14"> 	$(NULL)</span>
<a href="#l6.15"></a><span id="l6.15"> </span>
<a href="#l6.16"></a><span id="l6.16"> include $(topsrcdir)/config/rules.mk</span>
<a href="#l6.17"></a><span id="l6.17"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">new file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- /dev/null</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ b/suite/common/public/nsISessionStartup.idl</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -0,0 +1,67 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineplus">+ *</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+ *</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+ * License.</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+ *</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+ * The Original Code is the Session Restore component.</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+ *</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+ * Simon Bünzli &lt;zeniko@gmail.com&gt;</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2006</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+ *</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+ *   Dietrich Ayala &lt;dietrich@mozilla.com&gt;</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+ *</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+ *</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+/**</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+ * nsISessionStore keeps track of the current browsing state - i.e.</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+ * tab history, cookies, scroll state, form data, POSTDATA and window features</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+ * - and allows to restore everything into one window.</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+ */</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+[scriptable, uuid(34b4eded-1b07-4424-9012-33eea529d6ab)]</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+interface nsISessionStartup: nsISupports</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+{</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+  // Get session state as string</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+  readonly attribute AString state;</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+  /**</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+   * Determine if session should be restored</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+   */</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+  boolean doRestore();</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+  /**</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+   * What type of session we're restoring. If we have a session, we're</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+   * either restoring state from a crash or restoring state that the user</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+   * requested we save on shutdown.</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+   */</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+  const unsigned long NO_SESSION = 0;</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+  const unsigned long RECOVER_SESSION = 1;</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+  const unsigned long RESUME_SESSION = 2;</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+  readonly attribute unsigned long sessionType;</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">new file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- /dev/null</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ b/suite/common/public/nsISessionStore.idl</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -0,0 +1,175 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineplus">+ *</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+ *</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+ * License.</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+ *</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+ * The Original Code is the Session Restore component.</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+ *</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+ * Simon Bünzli &lt;zeniko@gmail.com&gt;</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2006</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+ *</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+ *   Dietrich Ayala &lt;dietrich@mozilla.com&gt;</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+ *</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+ *</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+interface nsIDOMWindow;</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+interface nsIDOMNode;</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+/**</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+ * nsISessionStore keeps track of the current browsing state - i.e.</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+ * tab history, cookies, scroll state, form data, POSTDATA and window features</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+ * - and allows to restore everything into one window.</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+ */</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+[scriptable, uuid(7e8a0f63-284a-493a-8658-ddb84db42a20)]</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+interface nsISessionStore : nsISupports</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+{</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+  /**</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+   * Initialize the service</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+   */</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+  void init(in nsIDOMWindow aWindow);</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+  /**</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+   * Get the current browsing state.</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+   * @return a JSON string representing the session state.</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+   */</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+  AString getBrowserState();</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+  /**</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+   * Set the browsing state.</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+   * This will immediately restore the state of the whole application to the state</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+   * passed in, *replacing* the current session.</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+   *</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+   * @param aState is a JSON string representing the session state.</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+   */</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+  void setBrowserState(in AString aState);</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+  /**</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+   * @param aWindow is the window whose state is to be returned.</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+   *</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+   * @return a JSON string representing a session state with only one window.</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+   */</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+  AString getWindowState(in nsIDOMWindow aWindow);</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+  /**</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+   * @param aWindow    is the window whose state is to be set.</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+   * @param aState     is a JSON string representing a session state.</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+   * @param aOverwrite boolean overwrite existing tabs</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+   */</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+  void setWindowState(in nsIDOMWindow aWindow, in AString aState, in boolean aOverwrite);</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+  /**</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+   * @param aTab is the tab whose state is to be returned.</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+   *</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+   * @return a JSON string representing the state of the tab</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+   *         (note: doesn't contain cookies - if you need them, use getWindowState instead).</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+   */</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+  AString getTabState(in nsIDOMNode aTab);</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+  /**</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+   * @param aTab   is the tab whose state is to be set.</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+   * @param aState is a JSON string representing a session state.</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+   */</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+  void setTabState(in nsIDOMNode aTab, in AString aState);</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+  /**</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineplus">+   * Duplicates a given tab as thoroughly as possible.</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+   *</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+   * @param aWindow is the window into which the tab will be duplicated.</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+   * @param aTab    is the tab to duplicate (can be from a different window).</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+   * @return a reference to the newly created tab.</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+   */</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+  nsIDOMNode duplicateTab(in nsIDOMWindow aWindow, in nsIDOMNode aTab);</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineplus">+</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+  /**</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+   * Get the number of restore-able tabs for a window</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+   */</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineplus">+  unsigned long getClosedTabCount(in nsIDOMWindow aWindow);</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineplus">+  /**</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+   * Get closed tab data</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+   * @return a JSON string representing the list of closed tabs.</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+   */</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+  AString getClosedTabData(in nsIDOMWindow aWindow);</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+  /**</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+   * @param aWindow</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+   *          The window to reopen a closed tab in.</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+   * @param aIndex</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+   *          Indicates the window to be restored (FIFO ordered).</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineplus">+   * @returns a reference to the reopened tab.</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+   */</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+  nsIDOMNode undoCloseTab(in nsIDOMWindow aWindow, in unsigned long aIndex);</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineplus">+  /**</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineplus">+   * @param aWindow is the window to get the value for.</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineplus">+   * @param aKey    is the value's name.</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+   *</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineplus">+   * @return A string value or &quot;&quot; if none is set.</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineplus">+   */</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineplus">+  AString getWindowValue(in nsIDOMWindow aWindow, in AString aKey);</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineplus">+  /**</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineplus">+   * @param aWindow      is the window to set the value for.</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineplus">+   * @param aKey         is the value's name.</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineplus">+   * @param aStringValue is the value itself (use toSource/eval before setting JS objects).</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineplus">+   */</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineplus">+  void setWindowValue(in nsIDOMWindow aWindow, in AString aKey, in AString aStringValue);</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineplus">+</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineplus">+  /**</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+   * @param aWindow is the window to get the value for.</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineplus">+   * @param aKey    is the value's name.</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineplus">+   */</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineplus">+  void deleteWindowValue(in nsIDOMWindow aWindow, in AString aKey);</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineplus">+</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineplus">+  /**</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineplus">+   * @param aTab is the tab to get the value for.</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineplus">+   * @param aKey is the value's name.</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineplus">+   *</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineplus">+   * @return A string value or &quot;&quot; if none is set.</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineplus">+   */</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineplus">+  AString getTabValue(in nsIDOMNode aTab, in AString aKey);</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineplus">+</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineplus">+  /**</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineplus">+   * @param aTab         is the tab to set the value for.</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineplus">+   * @param aKey         is the value's name.</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineplus">+   * @param aStringValue is the value itself (use toSource/eval before setting JS objects).</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineplus">+   */</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineplus">+  void setTabValue(in nsIDOMNode aTab, in AString aKey, in AString aStringValue);</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineplus">+</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineplus">+  /**</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineplus">+   * @param aTab is the tab to get the value for.</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineplus">+   * @param aKey is the value's name.</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineplus">+   */</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineplus">+  void deleteTabValue(in nsIDOMNode aTab, in AString aKey);</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineplus">+</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineplus">+  /**</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineplus">+   * @param aName is the name of the attribute to save/restore for all xul:tabs.</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineplus">+   */</span>
<a href="#l8.178"></a><span id="l8.178" class="difflineplus">+  void persistTabAttribute(in AString aName);</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/suite/common/src/Makefile.in</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/suite/common/src/Makefile.in</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -41,13 +41,15 @@ srcdir		= @srcdir@</span>
<a href="#l9.4"></a><span id="l9.4"> VPATH		= @srcdir@</span>
<a href="#l9.5"></a><span id="l9.5"> </span>
<a href="#l9.6"></a><span id="l9.6"> include $(DEPTH)/config/autoconf.mk</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8"> MODULE		= suitecommon</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10"> EXTRA_COMPONENTS = \</span>
<a href="#l9.11"></a><span id="l9.11"> 	nsAboutCertError.js \</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+	nsSessionStartup.js \</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+	nsSessionStore.js \</span>
<a href="#l9.14"></a><span id="l9.14"> 	nsSuiteGlue.js \</span>
<a href="#l9.15"></a><span id="l9.15"> 	$(NULL)</span>
<a href="#l9.16"></a><span id="l9.16"> </span>
<a href="#l9.17"></a><span id="l9.17"> include $(topsrcdir)/config/rules.mk</span>
<a href="#l9.18"></a><span id="l9.18"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">new file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- /dev/null</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ b/suite/common/src/nsSessionStartup.js</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -0,0 +1,343 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineplus">+ *</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+ *</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+ * License.</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+ *</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+ * The Original Code is the nsSessionStore component.</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+ *</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+ * Simon Bünzli &lt;zeniko@gmail.com&gt;</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2006</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+ *</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+ *   Dietrich Ayala &lt;autonome@gmail.com&gt;</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+ *</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+ *</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+/**</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+ * Session Storage and Restoration</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+ *</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+ * Overview</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+ * This service reads user's session file at startup, and makes a determination</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+ * as to whether the session should be restored. It will restore the session</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+ * under the circumstances described below.</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+ *</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+ * Crash Detection</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+ * The session file stores a session.state property, that</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+ * indicates whether the browser is currently running. When the browser shuts</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+ * down, the field is changed to &quot;stopped&quot;. At startup, this field is read, and</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+ * if it's value is &quot;running&quot;, then it's assumed that the browser had previously</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+ * crashed, or at the very least that something bad happened, and that we should</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+ * restore the session.</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+ *</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+ * Forced Restarts</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+ * In the event that a restart is required due to application update or extension</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineplus">+ * installation, set the browser.sessionstore.resume_session_once pref to true,</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+ * and the session will be restored the next time the browser starts.</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+ *</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineplus">+ * Always Resume</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+ * This service will always resume the session if the integer pref</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineplus">+ * browser.startup.page is set to 3.</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineplus">+*/</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineplus">+</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineplus">+/* :::::::: Constants and Helpers ::::::::::::::: */</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineplus">+</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineplus">+</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+const STATE_RUNNING_STR = &quot;running&quot;;</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+function debug(aMsg) {</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+  Components.classes[&quot;@mozilla.org/consoleservice;1&quot;]</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineplus">+            .getService(Components.interfaces.nsIConsoleService)</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineplus">+            .logStringMessage(&quot;SessionStartup: &quot; + aMsg);</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+}</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineplus">+</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineplus">+/* :::::::: The Service ::::::::::::::: */</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineplus">+function SessionStartup() {</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineplus">+}</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineplus">+</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineplus">+SessionStartup.prototype = {</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineplus">+</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineplus">+  // the state to restore at startup</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineplus">+  _iniString: null,</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineplus">+  _sessionType: Components.interfaces.nsISessionStartup.NO_SESSION,</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineplus">+</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+/* ........ Global Event Handlers .............. */</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineplus">+</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineplus">+  /**</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineplus">+   * Initialize the component</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineplus">+   */</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineplus">+  init: function sss_init() {</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineplus">+    this._prefBranch = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineplus">+                                 .getService(Components.interfaces.nsIPrefService)</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineplus">+                                 .getBranch(&quot;browser.&quot;);</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineplus">+</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+    // get file references</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineplus">+    var dirService = Components.classes[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineplus">+                               .getService(Components.interfaces.nsIProperties);</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineplus">+    let sessionFile = dirService.get(&quot;ProfD&quot;, Components.interfaces.nsILocalFile);</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineplus">+    sessionFile.append(&quot;sessionstore.js&quot;);</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineplus">+</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineplus">+    let doResumeSession = this._prefBranch.getBoolPref(&quot;sessionstore.resume_session_once&quot;) ||</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineplus">+                          this._prefBranch.getIntPref(&quot;startup.page&quot;) == 3;</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineplus">+</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineplus">+    // only read the session file if config allows possibility of restoring</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineplus">+    var resumeFromCrash = this._prefBranch.getBoolPref(&quot;sessionstore.resume_from_crash&quot;);</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineplus">+    if ((!resumeFromCrash &amp;&amp; !doResumeSession) || !sessionFile.exists())</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineplus">+      return;</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineplus">+</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineplus">+    // get string containing session state</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineplus">+    this._iniString = this._readStateFile(sessionFile);</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineplus">+    if (!this._iniString)</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineplus">+      return;</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineplus">+</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineplus">+    var initialState;</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineplus">+</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineplus">+    try {</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineplus">+      // parse the session state into JS objects</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineplus">+      var s = new Components.utils.Sandbox(&quot;about:blank&quot;);</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineplus">+      initialState = Components.utils.evalInSandbox(this._iniString, s);</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineplus">+    }</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineplus">+    catch (ex) {</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineplus">+      doResumeSession = false;</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineplus">+      debug(&quot;The session file is invalid: &quot; + ex);</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineplus">+    }</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineplus">+</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineplus">+    let lastSessionCrashed =</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineplus">+      initialState &amp;&amp; initialState.session &amp;&amp; initialState.session.state &amp;&amp;</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineplus">+      initialState.session.state == STATE_RUNNING_STR;</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineplus">+</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineplus">+    // set the startup type</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineplus">+    if (lastSessionCrashed &amp;&amp; resumeFromCrash &amp;&amp; this._doRecoverSession())</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineplus">+      this._sessionType = Components.interfaces.nsISessionStartup.RECOVER_SESSION;</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineplus">+    else if (!lastSessionCrashed &amp;&amp; doResumeSession)</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineplus">+      this._sessionType = Components.interfaces.nsISessionStartup.RESUME_SESSION;</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineplus">+    else</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineplus">+      this._iniString = null; // reset the state string</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineplus">+</span>
<a href="#l10.144"></a><span id="l10.144" class="difflineplus">+    if (this._sessionType != Components.interfaces.nsISessionStartup.NO_SESSION) {</span>
<a href="#l10.145"></a><span id="l10.145" class="difflineplus">+      // wait for the first browser window to open</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineplus">+      var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineplus">+                                      .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineplus">+      observerService.addObserver(this, &quot;browser:purge-session-history&quot;, true);</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineplus">+    }</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineplus">+  },</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineplus">+</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineplus">+  /**</span>
<a href="#l10.153"></a><span id="l10.153" class="difflineplus">+   * Handle notifications</span>
<a href="#l10.154"></a><span id="l10.154" class="difflineplus">+   */</span>
<a href="#l10.155"></a><span id="l10.155" class="difflineplus">+  observe: function sss_observe(aSubject, aTopic, aData) {</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineplus">+    var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineplus">+                                    .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l10.158"></a><span id="l10.158" class="difflineplus">+</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineplus">+    switch (aTopic) {</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineplus">+    case &quot;app-startup&quot;:</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineplus">+      observerService.addObserver(this, &quot;final-ui-startup&quot;, true);</span>
<a href="#l10.162"></a><span id="l10.162" class="difflineplus">+      observerService.addObserver(this, &quot;quit-application&quot;, true);</span>
<a href="#l10.163"></a><span id="l10.163" class="difflineplus">+      break;</span>
<a href="#l10.164"></a><span id="l10.164" class="difflineplus">+    case &quot;final-ui-startup&quot;:</span>
<a href="#l10.165"></a><span id="l10.165" class="difflineplus">+      observerService.removeObserver(this, &quot;final-ui-startup&quot;);</span>
<a href="#l10.166"></a><span id="l10.166" class="difflineplus">+      observerService.removeObserver(this, &quot;quit-application&quot;);</span>
<a href="#l10.167"></a><span id="l10.167" class="difflineplus">+      this.init();</span>
<a href="#l10.168"></a><span id="l10.168" class="difflineplus">+      break;</span>
<a href="#l10.169"></a><span id="l10.169" class="difflineplus">+    case &quot;quit-application&quot;:</span>
<a href="#l10.170"></a><span id="l10.170" class="difflineplus">+      // no reason for initializing at this point (cf. bug 409115)</span>
<a href="#l10.171"></a><span id="l10.171" class="difflineplus">+      observerService.removeObserver(this, &quot;final-ui-startup&quot;);</span>
<a href="#l10.172"></a><span id="l10.172" class="difflineplus">+      observerService.removeObserver(this, &quot;quit-application&quot;);</span>
<a href="#l10.173"></a><span id="l10.173" class="difflineplus">+      break;</span>
<a href="#l10.174"></a><span id="l10.174" class="difflineplus">+    case &quot;browser:purge-session-history&quot;:</span>
<a href="#l10.175"></a><span id="l10.175" class="difflineplus">+      // reset all state on sanitization</span>
<a href="#l10.176"></a><span id="l10.176" class="difflineplus">+      this._iniString = null;</span>
<a href="#l10.177"></a><span id="l10.177" class="difflineplus">+      this._sessionType = Components.interfaces.nsISessionStartup.NO_SESSION;</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineplus">+      // no need in repeating this, since startup state won't change</span>
<a href="#l10.179"></a><span id="l10.179" class="difflineplus">+      observerService.removeObserver(this, &quot;browser:purge-session-history&quot;);</span>
<a href="#l10.180"></a><span id="l10.180" class="difflineplus">+     break;</span>
<a href="#l10.181"></a><span id="l10.181" class="difflineplus">+    }</span>
<a href="#l10.182"></a><span id="l10.182" class="difflineplus">+  },</span>
<a href="#l10.183"></a><span id="l10.183" class="difflineplus">+</span>
<a href="#l10.184"></a><span id="l10.184" class="difflineplus">+/* ........ Public API ................*/</span>
<a href="#l10.185"></a><span id="l10.185" class="difflineplus">+</span>
<a href="#l10.186"></a><span id="l10.186" class="difflineplus">+  /**</span>
<a href="#l10.187"></a><span id="l10.187" class="difflineplus">+   * Get the session state as a string</span>
<a href="#l10.188"></a><span id="l10.188" class="difflineplus">+   */</span>
<a href="#l10.189"></a><span id="l10.189" class="difflineplus">+  get state() {</span>
<a href="#l10.190"></a><span id="l10.190" class="difflineplus">+    return this._iniString;</span>
<a href="#l10.191"></a><span id="l10.191" class="difflineplus">+  },</span>
<a href="#l10.192"></a><span id="l10.192" class="difflineplus">+</span>
<a href="#l10.193"></a><span id="l10.193" class="difflineplus">+  /**</span>
<a href="#l10.194"></a><span id="l10.194" class="difflineplus">+   * Determine whether there is a pending session restore.</span>
<a href="#l10.195"></a><span id="l10.195" class="difflineplus">+   * @returns bool</span>
<a href="#l10.196"></a><span id="l10.196" class="difflineplus">+   */</span>
<a href="#l10.197"></a><span id="l10.197" class="difflineplus">+  doRestore: function sss_doRestore() {</span>
<a href="#l10.198"></a><span id="l10.198" class="difflineplus">+    return this._sessionType != Components.interfaces.nsISessionStartup.NO_SESSION;</span>
<a href="#l10.199"></a><span id="l10.199" class="difflineplus">+  },</span>
<a href="#l10.200"></a><span id="l10.200" class="difflineplus">+</span>
<a href="#l10.201"></a><span id="l10.201" class="difflineplus">+  /**</span>
<a href="#l10.202"></a><span id="l10.202" class="difflineplus">+   * Get the type of pending session store, if any.</span>
<a href="#l10.203"></a><span id="l10.203" class="difflineplus">+   */</span>
<a href="#l10.204"></a><span id="l10.204" class="difflineplus">+  get sessionType() {</span>
<a href="#l10.205"></a><span id="l10.205" class="difflineplus">+    return this._sessionType;</span>
<a href="#l10.206"></a><span id="l10.206" class="difflineplus">+  },</span>
<a href="#l10.207"></a><span id="l10.207" class="difflineplus">+</span>
<a href="#l10.208"></a><span id="l10.208" class="difflineplus">+/* ........ Auxiliary Functions .............. */</span>
<a href="#l10.209"></a><span id="l10.209" class="difflineplus">+</span>
<a href="#l10.210"></a><span id="l10.210" class="difflineplus">+  /**</span>
<a href="#l10.211"></a><span id="l10.211" class="difflineplus">+   * prompt user whether or not to restore the previous session,</span>
<a href="#l10.212"></a><span id="l10.212" class="difflineplus">+   * if the browser crashed</span>
<a href="#l10.213"></a><span id="l10.213" class="difflineplus">+   * @returns bool</span>
<a href="#l10.214"></a><span id="l10.214" class="difflineplus">+   */</span>
<a href="#l10.215"></a><span id="l10.215" class="difflineplus">+  _doRecoverSession: function sss_doRecoverSession() {</span>
<a href="#l10.216"></a><span id="l10.216" class="difflineplus">+    // if the prompt fails, recover anyway</span>
<a href="#l10.217"></a><span id="l10.217" class="difflineplus">+    var recover = true;</span>
<a href="#l10.218"></a><span id="l10.218" class="difflineplus">+</span>
<a href="#l10.219"></a><span id="l10.219" class="difflineplus">+    // allow extensions to hook in a more elaborate restore prompt</span>
<a href="#l10.220"></a><span id="l10.220" class="difflineplus">+    // XXXzeniko drop this when we're using our own dialog instead of a standard prompt</span>
<a href="#l10.221"></a><span id="l10.221" class="difflineplus">+    var dialogURI = null;</span>
<a href="#l10.222"></a><span id="l10.222" class="difflineplus">+    try {</span>
<a href="#l10.223"></a><span id="l10.223" class="difflineplus">+      dialogURI = this._prefBranch.getCharPref(&quot;sessionstore.restore_prompt_uri&quot;);</span>
<a href="#l10.224"></a><span id="l10.224" class="difflineplus">+    }</span>
<a href="#l10.225"></a><span id="l10.225" class="difflineplus">+    catch (ex) { }</span>
<a href="#l10.226"></a><span id="l10.226" class="difflineplus">+</span>
<a href="#l10.227"></a><span id="l10.227" class="difflineplus">+    try {</span>
<a href="#l10.228"></a><span id="l10.228" class="difflineplus">+      if (dialogURI) { // extension provided dialog</span>
<a href="#l10.229"></a><span id="l10.229" class="difflineplus">+        var params = Components.classes[&quot;@mozilla.org/embedcomp/dialogparam;1&quot;]</span>
<a href="#l10.230"></a><span id="l10.230" class="difflineplus">+                               .createInstance(Components.interfaces.nsIDialogParamBlock);</span>
<a href="#l10.231"></a><span id="l10.231" class="difflineplus">+        // default to recovering</span>
<a href="#l10.232"></a><span id="l10.232" class="difflineplus">+        params.SetInt(0, 0);</span>
<a href="#l10.233"></a><span id="l10.233" class="difflineplus">+        Components.classes[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l10.234"></a><span id="l10.234" class="difflineplus">+                  .getService(Components.interfaces.nsIWindowWatcher)</span>
<a href="#l10.235"></a><span id="l10.235" class="difflineplus">+                  .openWindow(null, dialogURI, &quot;_blank&quot;, &quot;chrome,modal,centerscreen,titlebar&quot;, params);</span>
<a href="#l10.236"></a><span id="l10.236" class="difflineplus">+        recover = params.GetInt(0) == 0;</span>
<a href="#l10.237"></a><span id="l10.237" class="difflineplus">+      }</span>
<a href="#l10.238"></a><span id="l10.238" class="difflineplus">+      else { // basic prompt with no options</span>
<a href="#l10.239"></a><span id="l10.239" class="difflineplus">+        // get app name from branding properties</span>
<a href="#l10.240"></a><span id="l10.240" class="difflineplus">+        var brandStringBundle = this._getStringBundle(&quot;chrome://branding/locale/brand.properties&quot;);</span>
<a href="#l10.241"></a><span id="l10.241" class="difflineplus">+        var brandShortName = brandStringBundle.GetStringFromName(&quot;brandShortName&quot;);</span>
<a href="#l10.242"></a><span id="l10.242" class="difflineplus">+</span>
<a href="#l10.243"></a><span id="l10.243" class="difflineplus">+        // create prompt strings</span>
<a href="#l10.244"></a><span id="l10.244" class="difflineplus">+        var ssStringBundle = this._getStringBundle(&quot;chrome://communicator/locale/sessionstore.properties&quot;);</span>
<a href="#l10.245"></a><span id="l10.245" class="difflineplus">+        var restoreTitle = ssStringBundle.formatStringFromName(&quot;restoredTitle&quot;, [brandShortName], 1);</span>
<a href="#l10.246"></a><span id="l10.246" class="difflineplus">+        var restoreText = ssStringBundle.formatStringFromName(&quot;restoredMsg&quot;, [brandShortName], 1);</span>
<a href="#l10.247"></a><span id="l10.247" class="difflineplus">+        var okTitle = ssStringBundle.GetStringFromName(&quot;okTitle&quot;);</span>
<a href="#l10.248"></a><span id="l10.248" class="difflineplus">+        var cancelTitle = ssStringBundle.GetStringFromName(&quot;cancelTitle&quot;);</span>
<a href="#l10.249"></a><span id="l10.249" class="difflineplus">+</span>
<a href="#l10.250"></a><span id="l10.250" class="difflineplus">+        var promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l10.251"></a><span id="l10.251" class="difflineplus">+                                      .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l10.252"></a><span id="l10.252" class="difflineplus">+</span>
<a href="#l10.253"></a><span id="l10.253" class="difflineplus">+        // set the buttons that will appear on the dialog</span>
<a href="#l10.254"></a><span id="l10.254" class="difflineplus">+        var flags = promptService.BUTTON_TITLE_IS_STRING * promptService.BUTTON_POS_0 +</span>
<a href="#l10.255"></a><span id="l10.255" class="difflineplus">+                    promptService.BUTTON_TITLE_IS_STRING * promptService.BUTTON_POS_1 +</span>
<a href="#l10.256"></a><span id="l10.256" class="difflineplus">+                    promptService.BUTTON_POS_0_DEFAULT;</span>
<a href="#l10.257"></a><span id="l10.257" class="difflineplus">+        var buttonChoice = promptService.confirmEx(null, restoreTitle, restoreText,</span>
<a href="#l10.258"></a><span id="l10.258" class="difflineplus">+                                          flags, okTitle, cancelTitle, null,</span>
<a href="#l10.259"></a><span id="l10.259" class="difflineplus">+                                          null, {});</span>
<a href="#l10.260"></a><span id="l10.260" class="difflineplus">+        recover = (buttonChoice == 0);</span>
<a href="#l10.261"></a><span id="l10.261" class="difflineplus">+      }</span>
<a href="#l10.262"></a><span id="l10.262" class="difflineplus">+    }</span>
<a href="#l10.263"></a><span id="l10.263" class="difflineplus">+    catch (ex) { dump(ex + &quot;\n&quot;); } // if the prompt fails, recover anyway</span>
<a href="#l10.264"></a><span id="l10.264" class="difflineplus">+    return recover;</span>
<a href="#l10.265"></a><span id="l10.265" class="difflineplus">+  },</span>
<a href="#l10.266"></a><span id="l10.266" class="difflineplus">+</span>
<a href="#l10.267"></a><span id="l10.267" class="difflineplus">+  /**</span>
<a href="#l10.268"></a><span id="l10.268" class="difflineplus">+   * Convenience method to get localized string bundles</span>
<a href="#l10.269"></a><span id="l10.269" class="difflineplus">+   * @param aURI</span>
<a href="#l10.270"></a><span id="l10.270" class="difflineplus">+   * @returns nsIStringBundle</span>
<a href="#l10.271"></a><span id="l10.271" class="difflineplus">+   */</span>
<a href="#l10.272"></a><span id="l10.272" class="difflineplus">+  _getStringBundle: function sss_getStringBundle(aURI) {</span>
<a href="#l10.273"></a><span id="l10.273" class="difflineplus">+    var bundleService = Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l10.274"></a><span id="l10.274" class="difflineplus">+                                  .getService(Components.interfaces.nsIStringBundleService);</span>
<a href="#l10.275"></a><span id="l10.275" class="difflineplus">+    var appLocale = Components.classes[&quot;@mozilla.org/intl/nslocaleservice;1&quot;]</span>
<a href="#l10.276"></a><span id="l10.276" class="difflineplus">+                              .getService(Components.interfaces.nsILocaleService).getApplicationLocale();</span>
<a href="#l10.277"></a><span id="l10.277" class="difflineplus">+    return bundleService.createBundle(aURI, appLocale);</span>
<a href="#l10.278"></a><span id="l10.278" class="difflineplus">+  },</span>
<a href="#l10.279"></a><span id="l10.279" class="difflineplus">+</span>
<a href="#l10.280"></a><span id="l10.280" class="difflineplus">+/* ........ Storage API .............. */</span>
<a href="#l10.281"></a><span id="l10.281" class="difflineplus">+</span>
<a href="#l10.282"></a><span id="l10.282" class="difflineplus">+  /**</span>
<a href="#l10.283"></a><span id="l10.283" class="difflineplus">+   * Reads a session state file into a string and lets</span>
<a href="#l10.284"></a><span id="l10.284" class="difflineplus">+   * observers modify the state before it's being used</span>
<a href="#l10.285"></a><span id="l10.285" class="difflineplus">+   *</span>
<a href="#l10.286"></a><span id="l10.286" class="difflineplus">+   * @param aFile is any nsIFile</span>
<a href="#l10.287"></a><span id="l10.287" class="difflineplus">+   * @returns a session state string</span>
<a href="#l10.288"></a><span id="l10.288" class="difflineplus">+   */</span>
<a href="#l10.289"></a><span id="l10.289" class="difflineplus">+  _readStateFile: function sss_readStateFile(aFile) {</span>
<a href="#l10.290"></a><span id="l10.290" class="difflineplus">+    var stateString = Components.classes[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l10.291"></a><span id="l10.291" class="difflineplus">+                                .createInstance(Components.interfaces.nsISupportsString);</span>
<a href="#l10.292"></a><span id="l10.292" class="difflineplus">+    stateString.data = this._readFile(aFile) || &quot;&quot;;</span>
<a href="#l10.293"></a><span id="l10.293" class="difflineplus">+</span>
<a href="#l10.294"></a><span id="l10.294" class="difflineplus">+    var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l10.295"></a><span id="l10.295" class="difflineplus">+                                    .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l10.296"></a><span id="l10.296" class="difflineplus">+    observerService.notifyObservers(stateString, &quot;sessionstore-state-read&quot;, &quot;&quot;);</span>
<a href="#l10.297"></a><span id="l10.297" class="difflineplus">+</span>
<a href="#l10.298"></a><span id="l10.298" class="difflineplus">+    return stateString.data;</span>
<a href="#l10.299"></a><span id="l10.299" class="difflineplus">+  },</span>
<a href="#l10.300"></a><span id="l10.300" class="difflineplus">+</span>
<a href="#l10.301"></a><span id="l10.301" class="difflineplus">+  /**</span>
<a href="#l10.302"></a><span id="l10.302" class="difflineplus">+   * reads a file into a string</span>
<a href="#l10.303"></a><span id="l10.303" class="difflineplus">+   * @param aFile</span>
<a href="#l10.304"></a><span id="l10.304" class="difflineplus">+   *        nsIFile</span>
<a href="#l10.305"></a><span id="l10.305" class="difflineplus">+   * @returns string</span>
<a href="#l10.306"></a><span id="l10.306" class="difflineplus">+   */</span>
<a href="#l10.307"></a><span id="l10.307" class="difflineplus">+  _readFile: function sss_readFile(aFile) {</span>
<a href="#l10.308"></a><span id="l10.308" class="difflineplus">+    try {</span>
<a href="#l10.309"></a><span id="l10.309" class="difflineplus">+      var stream = Components.classes[&quot;@mozilla.org/network/file-input-stream;1&quot;]</span>
<a href="#l10.310"></a><span id="l10.310" class="difflineplus">+                             .createInstance(Components.interfaces.nsIFileInputStream);</span>
<a href="#l10.311"></a><span id="l10.311" class="difflineplus">+      stream.init(aFile, 0x01, 0, 0);</span>
<a href="#l10.312"></a><span id="l10.312" class="difflineplus">+      var cvStream = Components.classes[&quot;@mozilla.org/intl/converter-input-stream;1&quot;]</span>
<a href="#l10.313"></a><span id="l10.313" class="difflineplus">+                               .createInstance(Components.interfaces.nsIConverterInputStream);</span>
<a href="#l10.314"></a><span id="l10.314" class="difflineplus">+      cvStream.init(stream, &quot;UTF-8&quot;, 1024, Components.interfaces.nsIConverterInputStream.DEFAULT_REPLACEMENT_CHARACTER);</span>
<a href="#l10.315"></a><span id="l10.315" class="difflineplus">+</span>
<a href="#l10.316"></a><span id="l10.316" class="difflineplus">+      var content = &quot;&quot;;</span>
<a href="#l10.317"></a><span id="l10.317" class="difflineplus">+      var data = {};</span>
<a href="#l10.318"></a><span id="l10.318" class="difflineplus">+      while (cvStream.readString(4096, data)) {</span>
<a href="#l10.319"></a><span id="l10.319" class="difflineplus">+        content += data.value;</span>
<a href="#l10.320"></a><span id="l10.320" class="difflineplus">+      }</span>
<a href="#l10.321"></a><span id="l10.321" class="difflineplus">+      cvStream.close();</span>
<a href="#l10.322"></a><span id="l10.322" class="difflineplus">+</span>
<a href="#l10.323"></a><span id="l10.323" class="difflineplus">+      return content.replace(/\r\n?/g, &quot;\n&quot;);</span>
<a href="#l10.324"></a><span id="l10.324" class="difflineplus">+    }</span>
<a href="#l10.325"></a><span id="l10.325" class="difflineplus">+    catch (ex) { Components.utils.reportError(ex); }</span>
<a href="#l10.326"></a><span id="l10.326" class="difflineplus">+</span>
<a href="#l10.327"></a><span id="l10.327" class="difflineplus">+    return null;</span>
<a href="#l10.328"></a><span id="l10.328" class="difflineplus">+  },</span>
<a href="#l10.329"></a><span id="l10.329" class="difflineplus">+</span>
<a href="#l10.330"></a><span id="l10.330" class="difflineplus">+  /* ........ QueryInterface .............. */</span>
<a href="#l10.331"></a><span id="l10.331" class="difflineplus">+  QueryInterface : XPCOMUtils.generateQI([Components.interfaces.nsIObserver,</span>
<a href="#l10.332"></a><span id="l10.332" class="difflineplus">+                                          Components.interfaces.nsISupportsWeakReference,</span>
<a href="#l10.333"></a><span id="l10.333" class="difflineplus">+                                          Components.interfaces.nsISessionStartup]),</span>
<a href="#l10.334"></a><span id="l10.334" class="difflineplus">+  classDescription: &quot;Suite Session Startup Service&quot;,</span>
<a href="#l10.335"></a><span id="l10.335" class="difflineplus">+  classID:          Components.ID(&quot;{4e6c1112-57b6-44ba-adf9-99fb573b0a30}&quot;),</span>
<a href="#l10.336"></a><span id="l10.336" class="difflineplus">+  contractID:       &quot;@mozilla.org/suite/sessionstartup;1&quot;,</span>
<a href="#l10.337"></a><span id="l10.337" class="difflineplus">+</span>
<a href="#l10.338"></a><span id="l10.338" class="difflineplus">+  // get this contractID registered for certain categories via XPCOMUtils</span>
<a href="#l10.339"></a><span id="l10.339" class="difflineplus">+  _xpcom_categories: [</span>
<a href="#l10.340"></a><span id="l10.340" class="difflineplus">+    // make ourselves a startup observer</span>
<a href="#l10.341"></a><span id="l10.341" class="difflineplus">+    { category: &quot;app-startup&quot;, service: true }</span>
<a href="#l10.342"></a><span id="l10.342" class="difflineplus">+  ]</span>
<a href="#l10.343"></a><span id="l10.343" class="difflineplus">+</span>
<a href="#l10.344"></a><span id="l10.344" class="difflineplus">+};</span>
<a href="#l10.345"></a><span id="l10.345" class="difflineplus">+</span>
<a href="#l10.346"></a><span id="l10.346" class="difflineplus">+function NSGetModule(aCompMgr, aFileSpec)</span>
<a href="#l10.347"></a><span id="l10.347" class="difflineplus">+  XPCOMUtils.generateModule([SessionStartup]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">new file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- /dev/null</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ b/suite/common/src/nsSessionStore.js</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -0,0 +1,2495 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineplus">+ *</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+ *</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+ * License.</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+ *</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+ * The Original Code is the nsSessionStore component.</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+ *</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+ * Simon Bünzli &lt;zeniko@gmail.com&gt;</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2006</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+ *</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+ *   Dietrich Ayala &lt;dietrich@mozilla.com&gt;</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+ *</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+ *</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+/**</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+ * Session Storage and Restoration</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+ *</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+ * Overview</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+ * This service keeps track of a user's session, storing the various bits</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+ * required to return the browser to its current state. The relevant data is</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+ * stored in memory, and is periodically saved to disk in a file in the</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+ * profile directory. The service is started at first window load, in</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+ * delayedStartup, and will restore the session from the data received from</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+ * the nsSessionStartup service.</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+ */</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+/* :::::::: Constants and Helpers ::::::::::::::: */</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+const STATE_STOPPED = 0;</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+const STATE_RUNNING = 1;</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+const STATE_QUITTING = -1;</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineplus">+const STATE_STOPPED_STR = &quot;stopped&quot;;</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+const STATE_RUNNING_STR = &quot;running&quot;;</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineplus">+</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+const PRIVACY_NONE = 0;</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+const PRIVACY_ENCRYPTED = 1;</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+const PRIVACY_FULL = 2;</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+const NOTIFY_WINDOWS_RESTORED = &quot;sessionstore-windows-restored&quot;;</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineplus">+</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+// global notifications observed</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+const OBSERVING = [</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+  &quot;domwindowopened&quot;, &quot;domwindowclosed&quot;,</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+  &quot;quit-application-requested&quot;, &quot;quit-application-granted&quot;,</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+  &quot;quit-application&quot;, &quot;browser:purge-session-history&quot;</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+];</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+/*</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineplus">+XUL Window properties to (re)store</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+Restored in restoreDimensions()</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+*/</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+const WINDOW_ATTRIBUTES = [&quot;width&quot;, &quot;height&quot;, &quot;screenX&quot;, &quot;screenY&quot;, &quot;sizemode&quot;];</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineplus">+/*</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineplus">+Hideable window features to (re)store</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineplus">+Restored in restoreWindowFeatures()</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineplus">+*/</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineplus">+const WINDOW_HIDEABLE_FEATURES = [</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineplus">+  &quot;menubar&quot;, &quot;toolbar&quot;, &quot;locationbar&quot;,</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineplus">+  &quot;personalbar&quot;, &quot;statusbar&quot;, &quot;scrollbars&quot;</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+];</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineplus">+/*</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+docShell capabilities to (re)store</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineplus">+Restored in restoreHistory()</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineplus">+eg: browser.docShell[&quot;allow&quot; + aCapability] = false;</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineplus">+*/</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineplus">+const CAPABILITIES = [</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineplus">+  &quot;Subframes&quot;, &quot;Plugins&quot;, &quot;Javascript&quot;, &quot;MetaRedirects&quot;, &quot;Images&quot;</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineplus">+];</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineplus">+</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineplus">+// module for JSON conversion (needed for the nsISessionStore API)</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/JSON.jsm&quot;);</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineplus">+</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineplus">+function debug(aMsg) {</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineplus">+  Components.classes[&quot;@mozilla.org/consoleservice;1&quot;]</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineplus">+            .getService(Components.interfaces.nsIConsoleService)</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineplus">+            .logStringMessage(&quot;SessionStore: &quot; + aMsg);</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineplus">+}</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineplus">+</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineplus">+/* :::::::: The Service ::::::::::::::: */</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineplus">+</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineplus">+function SessionStoreService() {</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineplus">+}</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineplus">+</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineplus">+SessionStoreService.prototype = {</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineplus">+  classDescription: &quot;Suite Session Store Service&quot;,</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineplus">+  contractID: &quot;@mozilla.org/suite/sessionstore;1&quot;,</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineplus">+  classID: Components.ID(&quot;{d37ccdf1-496f-4135-9575-037180af010d}&quot;),</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineplus">+  QueryInterface: XPCOMUtils.generateQI([Components.interfaces.nsISessionStore,</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineplus">+                                         Components.interfaces.nsIDOMEventListener,</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineplus">+                                         Components.interfaces.nsIObserver,</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineplus">+                                         Components.interfaces.nsISupportsWeakReference]),</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineplus">+</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineplus">+  // xul:tab attributes to (re)store (extensions might want to hook in here)</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineplus">+  xulAttributes: [],</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineplus">+</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineplus">+  // set default load state</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineplus">+  _loadState: STATE_STOPPED,</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineplus">+</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineplus">+  // minimal interval between two save operations (in milliseconds)</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineplus">+  _interval: 10000,</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineplus">+</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineplus">+  // when crash recovery is disabled, session data is not written to disk</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineplus">+  _resume_from_crash: true,</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineplus">+</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineplus">+  // During the initial restore tracks the number of windows yet to be restored</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineplus">+  _restoreCount: 0,</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineplus">+</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineplus">+  // time in milliseconds (Date.now()) when the session was last written to file</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineplus">+  _lastSaveTime: 0,</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineplus">+</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineplus">+  // states for all currently opened windows</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineplus">+  _windows: {},</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineplus">+</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineplus">+  // in case the last closed window ain't a navigator:browser one</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineplus">+  // (also contains browser popup windows closed after the last non-popup one)</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineplus">+  _lastClosedWindows: null,</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineplus">+</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineplus">+  // not-&quot;dirty&quot; windows usually don't need to have their data updated</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineplus">+  _dirtyWindows: {},</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineplus">+</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineplus">+/* ........ Global Event Handlers .............. */</span>
<a href="#l11.153"></a><span id="l11.153" class="difflineplus">+</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineplus">+  /**</span>
<a href="#l11.155"></a><span id="l11.155" class="difflineplus">+   * Initialize the component</span>
<a href="#l11.156"></a><span id="l11.156" class="difflineplus">+   */</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineplus">+  init: function sss_init(aWindow) {</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineplus">+    if (!aWindow || this._loadState == STATE_RUNNING) {</span>
<a href="#l11.159"></a><span id="l11.159" class="difflineplus">+      // make sure that all browser windows which try to initialize</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineplus">+      // SessionStore are really tracked by it</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineplus">+      if (aWindow &amp;&amp; (!aWindow.__SSi || !this._windows[aWindow.__SSi]))</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineplus">+        this.onLoad(aWindow);</span>
<a href="#l11.163"></a><span id="l11.163" class="difflineplus">+      return;</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineplus">+    }</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineplus">+</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineplus">+    this._prefBranch = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l11.167"></a><span id="l11.167" class="difflineplus">+                                 .getService(Components.interfaces.nsIPrefService)</span>
<a href="#l11.168"></a><span id="l11.168" class="difflineplus">+                                 .getBranch(&quot;browser.&quot;);</span>
<a href="#l11.169"></a><span id="l11.169" class="difflineplus">+    this._prefBranch.QueryInterface(Components.interfaces.nsIPrefBranch2);</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineplus">+</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineplus">+    var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l11.172"></a><span id="l11.172" class="difflineplus">+                                    .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l11.173"></a><span id="l11.173" class="difflineplus">+</span>
<a href="#l11.174"></a><span id="l11.174" class="difflineplus">+    OBSERVING.forEach(function(aTopic) {</span>
<a href="#l11.175"></a><span id="l11.175" class="difflineplus">+      observerService.addObserver(this, aTopic, true);</span>
<a href="#l11.176"></a><span id="l11.176" class="difflineplus">+    }, this);</span>
<a href="#l11.177"></a><span id="l11.177" class="difflineplus">+</span>
<a href="#l11.178"></a><span id="l11.178" class="difflineplus">+    // get interval from prefs - used often, so caching/observing instead of fetching on-demand</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineplus">+    this._interval = this._prefBranch.getIntPref(&quot;sessionstore.interval&quot;);</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineplus">+    this._prefBranch.addObserver(&quot;sessionstore.interval&quot;, this, true);</span>
<a href="#l11.181"></a><span id="l11.181" class="difflineplus">+</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineplus">+    // get crash recovery state from prefs and allow for proper reaction to state changes</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineplus">+    this._resume_from_crash = this._prefBranch.getBoolPref(&quot;sessionstore.resume_from_crash&quot;);</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineplus">+    this._prefBranch.addObserver(&quot;sessionstore.resume_from_crash&quot;, this, true);</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineplus">+</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineplus">+    // observe prefs changes so we can modify stored data to match</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineplus">+    this._prefBranch.addObserver(&quot;tabs.undoclose.depth&quot;, this, true);</span>
<a href="#l11.188"></a><span id="l11.188" class="difflineplus">+    this._prefBranch.addObserver(&quot;sessionstore.max_tabs_undo&quot;, this, true);</span>
<a href="#l11.189"></a><span id="l11.189" class="difflineplus">+</span>
<a href="#l11.190"></a><span id="l11.190" class="difflineplus">+    // get file references</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineplus">+    var dirService = Components.classes[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l11.192"></a><span id="l11.192" class="difflineplus">+                               .getService(Components.interfaces.nsIProperties);</span>
<a href="#l11.193"></a><span id="l11.193" class="difflineplus">+    this._sessionFile = dirService.get(&quot;ProfD&quot;, Components.interfaces.nsILocalFile);</span>
<a href="#l11.194"></a><span id="l11.194" class="difflineplus">+    this._sessionFileBackup = this._sessionFile.clone();</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineplus">+    this._sessionFile.append(&quot;sessionstore.js&quot;);</span>
<a href="#l11.196"></a><span id="l11.196" class="difflineplus">+    this._sessionFileBackup.append(&quot;sessionstore.bak&quot;);</span>
<a href="#l11.197"></a><span id="l11.197" class="difflineplus">+</span>
<a href="#l11.198"></a><span id="l11.198" class="difflineplus">+    // get string containing session state</span>
<a href="#l11.199"></a><span id="l11.199" class="difflineplus">+    var iniString;</span>
<a href="#l11.200"></a><span id="l11.200" class="difflineplus">+    try {</span>
<a href="#l11.201"></a><span id="l11.201" class="difflineplus">+      var ss = Components.classes[&quot;@mozilla.org/suite/sessionstartup;1&quot;]</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineplus">+                         .getService(Components.interfaces.nsISessionStartup);</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineplus">+      if (ss.doRestore())</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineplus">+        iniString = ss.state;</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineplus">+    }</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineplus">+    catch(ex) { dump(ex + &quot;\n&quot;); } // no state to restore, which is ok</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineplus">+</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineplus">+    if (iniString) {</span>
<a href="#l11.209"></a><span id="l11.209" class="difflineplus">+      try {</span>
<a href="#l11.210"></a><span id="l11.210" class="difflineplus">+        // parse the session state into JS objects</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineplus">+        this._initialState = this._safeEval(iniString);</span>
<a href="#l11.212"></a><span id="l11.212" class="difflineplus">+      }</span>
<a href="#l11.213"></a><span id="l11.213" class="difflineplus">+      catch (ex) { debug(&quot;The session file is invalid: &quot; + ex); }</span>
<a href="#l11.214"></a><span id="l11.214" class="difflineplus">+</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineplus">+      let lastSessionCrashed =</span>
<a href="#l11.216"></a><span id="l11.216" class="difflineplus">+        this._initialState &amp;&amp; this._initialState.session &amp;&amp; this._initialState.session.state &amp;&amp;</span>
<a href="#l11.217"></a><span id="l11.217" class="difflineplus">+        this._initialState.session.state == STATE_RUNNING_STR;</span>
<a href="#l11.218"></a><span id="l11.218" class="difflineplus">+      // make sure that at least the first window doesn't have anything hidden</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineplus">+      if (this._initialState.windows[0])</span>
<a href="#l11.220"></a><span id="l11.220" class="difflineplus">+        delete this._initialState.windows[0].hidden;</span>
<a href="#l11.221"></a><span id="l11.221" class="difflineplus">+    }</span>
<a href="#l11.222"></a><span id="l11.222" class="difflineplus">+</span>
<a href="#l11.223"></a><span id="l11.223" class="difflineplus">+    // remove the session data files if crash recovery is disabled</span>
<a href="#l11.224"></a><span id="l11.224" class="difflineplus">+    if (!this._resume_from_crash)</span>
<a href="#l11.225"></a><span id="l11.225" class="difflineplus">+      this._clearDisk();</span>
<a href="#l11.226"></a><span id="l11.226" class="difflineplus">+    else { // create a backup if the session data file exists</span>
<a href="#l11.227"></a><span id="l11.227" class="difflineplus">+      try {</span>
<a href="#l11.228"></a><span id="l11.228" class="difflineplus">+        if (this._sessionFileBackup.exists())</span>
<a href="#l11.229"></a><span id="l11.229" class="difflineplus">+          this._sessionFileBackup.remove(false);</span>
<a href="#l11.230"></a><span id="l11.230" class="difflineplus">+        if (this._sessionFile.exists())</span>
<a href="#l11.231"></a><span id="l11.231" class="difflineplus">+          this._sessionFile.copyTo(null, this._sessionFileBackup.leafName);</span>
<a href="#l11.232"></a><span id="l11.232" class="difflineplus">+      }</span>
<a href="#l11.233"></a><span id="l11.233" class="difflineplus">+      catch (ex) { Cu.reportError(ex); } // file was write-locked?</span>
<a href="#l11.234"></a><span id="l11.234" class="difflineplus">+    }</span>
<a href="#l11.235"></a><span id="l11.235" class="difflineplus">+</span>
<a href="#l11.236"></a><span id="l11.236" class="difflineplus">+    // at this point, we've as good as resumed the session, so we can</span>
<a href="#l11.237"></a><span id="l11.237" class="difflineplus">+    // clear the resume_session_once flag, if it's set</span>
<a href="#l11.238"></a><span id="l11.238" class="difflineplus">+    if (this._loadState != STATE_QUITTING &amp;&amp;</span>
<a href="#l11.239"></a><span id="l11.239" class="difflineplus">+        this._prefBranch.getBoolPref(&quot;sessionstore.resume_session_once&quot;))</span>
<a href="#l11.240"></a><span id="l11.240" class="difflineplus">+      this._prefBranch.setBoolPref(&quot;sessionstore.resume_session_once&quot;, false);</span>
<a href="#l11.241"></a><span id="l11.241" class="difflineplus">+</span>
<a href="#l11.242"></a><span id="l11.242" class="difflineplus">+    // As this is called at delayedStartup, restoration must be initiated here</span>
<a href="#l11.243"></a><span id="l11.243" class="difflineplus">+    this.onLoad(aWindow);</span>
<a href="#l11.244"></a><span id="l11.244" class="difflineplus">+  },</span>
<a href="#l11.245"></a><span id="l11.245" class="difflineplus">+</span>
<a href="#l11.246"></a><span id="l11.246" class="difflineplus">+  /**</span>
<a href="#l11.247"></a><span id="l11.247" class="difflineplus">+   * Called on application shutdown, after notifications:</span>
<a href="#l11.248"></a><span id="l11.248" class="difflineplus">+   * quit-application-granted, quit-application</span>
<a href="#l11.249"></a><span id="l11.249" class="difflineplus">+   */</span>
<a href="#l11.250"></a><span id="l11.250" class="difflineplus">+  _uninit: function sss_uninit() {</span>
<a href="#l11.251"></a><span id="l11.251" class="difflineplus">+    if (this._doResumeSession()) { // save all data for session resuming</span>
<a href="#l11.252"></a><span id="l11.252" class="difflineplus">+      this.saveState(true);</span>
<a href="#l11.253"></a><span id="l11.253" class="difflineplus">+    }</span>
<a href="#l11.254"></a><span id="l11.254" class="difflineplus">+    else { // discard all session related data</span>
<a href="#l11.255"></a><span id="l11.255" class="difflineplus">+      this._clearDisk();</span>
<a href="#l11.256"></a><span id="l11.256" class="difflineplus">+    }</span>
<a href="#l11.257"></a><span id="l11.257" class="difflineplus">+    // Make sure to break our cycle with the save timer</span>
<a href="#l11.258"></a><span id="l11.258" class="difflineplus">+    if (this._saveTimer) {</span>
<a href="#l11.259"></a><span id="l11.259" class="difflineplus">+      this._saveTimer.cancel();</span>
<a href="#l11.260"></a><span id="l11.260" class="difflineplus">+      this._saveTimer = null;</span>
<a href="#l11.261"></a><span id="l11.261" class="difflineplus">+    }</span>
<a href="#l11.262"></a><span id="l11.262" class="difflineplus">+  },</span>
<a href="#l11.263"></a><span id="l11.263" class="difflineplus">+</span>
<a href="#l11.264"></a><span id="l11.264" class="difflineplus">+  /**</span>
<a href="#l11.265"></a><span id="l11.265" class="difflineplus">+   * Handle notifications</span>
<a href="#l11.266"></a><span id="l11.266" class="difflineplus">+   */</span>
<a href="#l11.267"></a><span id="l11.267" class="difflineplus">+  observe: function sss_observe(aSubject, aTopic, aData) {</span>
<a href="#l11.268"></a><span id="l11.268" class="difflineplus">+    // for event listeners</span>
<a href="#l11.269"></a><span id="l11.269" class="difflineplus">+    var _this = this;</span>
<a href="#l11.270"></a><span id="l11.270" class="difflineplus">+</span>
<a href="#l11.271"></a><span id="l11.271" class="difflineplus">+    switch (aTopic) {</span>
<a href="#l11.272"></a><span id="l11.272" class="difflineplus">+    case &quot;domwindowopened&quot;: // catch new windows</span>
<a href="#l11.273"></a><span id="l11.273" class="difflineplus">+      aSubject.addEventListener(&quot;load&quot;, function(aEvent) {</span>
<a href="#l11.274"></a><span id="l11.274" class="difflineplus">+        aEvent.currentTarget.removeEventListener(&quot;load&quot;, arguments.callee, false);</span>
<a href="#l11.275"></a><span id="l11.275" class="difflineplus">+        _this.onLoad(aEvent.currentTarget);</span>
<a href="#l11.276"></a><span id="l11.276" class="difflineplus">+        }, false);</span>
<a href="#l11.277"></a><span id="l11.277" class="difflineplus">+      break;</span>
<a href="#l11.278"></a><span id="l11.278" class="difflineplus">+    case &quot;domwindowclosed&quot;: // catch closed windows</span>
<a href="#l11.279"></a><span id="l11.279" class="difflineplus">+      this.onClose(aSubject);</span>
<a href="#l11.280"></a><span id="l11.280" class="difflineplus">+      break;</span>
<a href="#l11.281"></a><span id="l11.281" class="difflineplus">+    case &quot;quit-application-requested&quot;:</span>
<a href="#l11.282"></a><span id="l11.282" class="difflineplus">+      // get a current snapshot of all windows</span>
<a href="#l11.283"></a><span id="l11.283" class="difflineplus">+      this._forEachBrowserWindow(function(aWindow) {</span>
<a href="#l11.284"></a><span id="l11.284" class="difflineplus">+        this._collectWindowData(aWindow);</span>
<a href="#l11.285"></a><span id="l11.285" class="difflineplus">+      });</span>
<a href="#l11.286"></a><span id="l11.286" class="difflineplus">+      this._dirtyWindows = [];</span>
<a href="#l11.287"></a><span id="l11.287" class="difflineplus">+      break;</span>
<a href="#l11.288"></a><span id="l11.288" class="difflineplus">+    case &quot;quit-application-granted&quot;:</span>
<a href="#l11.289"></a><span id="l11.289" class="difflineplus">+      // freeze the data at what we've got (ignoring closing windows)</span>
<a href="#l11.290"></a><span id="l11.290" class="difflineplus">+      this._loadState = STATE_QUITTING;</span>
<a href="#l11.291"></a><span id="l11.291" class="difflineplus">+      break;</span>
<a href="#l11.292"></a><span id="l11.292" class="difflineplus">+    case &quot;quit-application&quot;:</span>
<a href="#l11.293"></a><span id="l11.293" class="difflineplus">+      // duplicate of quit-application request. Seamonkey doesn't have these yet.</span>
<a href="#l11.294"></a><span id="l11.294" class="difflineplus">+      this._forEachBrowserWindow(function(aWindow) {</span>
<a href="#l11.295"></a><span id="l11.295" class="difflineplus">+        this._collectWindowData(aWindow);</span>
<a href="#l11.296"></a><span id="l11.296" class="difflineplus">+      });</span>
<a href="#l11.297"></a><span id="l11.297" class="difflineplus">+      this._dirtyWindows = [];</span>
<a href="#l11.298"></a><span id="l11.298" class="difflineplus">+      this._dirty = false;</span>
<a href="#l11.299"></a><span id="l11.299" class="difflineplus">+</span>
<a href="#l11.300"></a><span id="l11.300" class="difflineplus">+      if (aData == &quot;restart&quot;)</span>
<a href="#l11.301"></a><span id="l11.301" class="difflineplus">+        this._prefBranch.setBoolPref(&quot;sessionstore.resume_session_once&quot;, true);</span>
<a href="#l11.302"></a><span id="l11.302" class="difflineplus">+      this._loadState = STATE_QUITTING; // just to be sure</span>
<a href="#l11.303"></a><span id="l11.303" class="difflineplus">+      this._uninit();</span>
<a href="#l11.304"></a><span id="l11.304" class="difflineplus">+      break;</span>
<a href="#l11.305"></a><span id="l11.305" class="difflineplus">+    case &quot;browser:purge-session-history&quot;: // catch sanitization</span>
<a href="#l11.306"></a><span id="l11.306" class="difflineplus">+      let openWindows = {};</span>
<a href="#l11.307"></a><span id="l11.307" class="difflineplus">+      this._forEachBrowserWindow(function(aWindow) {</span>
<a href="#l11.308"></a><span id="l11.308" class="difflineplus">+        Array.forEach(aWindow.getBrowser().browsers, function(aBrowser) {</span>
<a href="#l11.309"></a><span id="l11.309" class="difflineplus">+          delete aBrowser.parentNode.__SS_data;</span>
<a href="#l11.310"></a><span id="l11.310" class="difflineplus">+        });</span>
<a href="#l11.311"></a><span id="l11.311" class="difflineplus">+        openWindows[aWindow.__SSi] = true;</span>
<a href="#l11.312"></a><span id="l11.312" class="difflineplus">+      });</span>
<a href="#l11.313"></a><span id="l11.313" class="difflineplus">+      // also clear all data about closed tabs and windows</span>
<a href="#l11.314"></a><span id="l11.314" class="difflineplus">+      for (ix in this._windows) {</span>
<a href="#l11.315"></a><span id="l11.315" class="difflineplus">+        if (ix in openWindows)</span>
<a href="#l11.316"></a><span id="l11.316" class="difflineplus">+          this._windows[ix]._closedTabs = [];</span>
<a href="#l11.317"></a><span id="l11.317" class="difflineplus">+        else</span>
<a href="#l11.318"></a><span id="l11.318" class="difflineplus">+          delete this._windows[ix];</span>
<a href="#l11.319"></a><span id="l11.319" class="difflineplus">+      }</span>
<a href="#l11.320"></a><span id="l11.320" class="difflineplus">+      this._lastClosedWindows = null;</span>
<a href="#l11.321"></a><span id="l11.321" class="difflineplus">+      this._clearDisk();</span>
<a href="#l11.322"></a><span id="l11.322" class="difflineplus">+      // give the tabbrowsers a chance to clear their histories first</span>
<a href="#l11.323"></a><span id="l11.323" class="difflineplus">+      var win = this._getMostRecentBrowserWindow();</span>
<a href="#l11.324"></a><span id="l11.324" class="difflineplus">+      if (win)</span>
<a href="#l11.325"></a><span id="l11.325" class="difflineplus">+        win.setTimeout(function() { _this.saveState(true); }, 0);</span>
<a href="#l11.326"></a><span id="l11.326" class="difflineplus">+      else if (this._loadState == STATE_RUNNING)</span>
<a href="#l11.327"></a><span id="l11.327" class="difflineplus">+        this.saveState(true);</span>
<a href="#l11.328"></a><span id="l11.328" class="difflineplus">+      break;</span>
<a href="#l11.329"></a><span id="l11.329" class="difflineplus">+    case &quot;nsPref:changed&quot;: // catch pref changes</span>
<a href="#l11.330"></a><span id="l11.330" class="difflineplus">+      switch (aData) {</span>
<a href="#l11.331"></a><span id="l11.331" class="difflineplus">+      // if the user decreases the max number of closed tabs they want</span>
<a href="#l11.332"></a><span id="l11.332" class="difflineplus">+      // preserved update our internal states to match that max</span>
<a href="#l11.333"></a><span id="l11.333" class="difflineplus">+      // misak: this shouldn't be needed, will remove in final patch</span>
<a href="#l11.334"></a><span id="l11.334" class="difflineplus">+      //case &quot;tabs.undoclose.depth&quot;:</span>
<a href="#l11.335"></a><span id="l11.335" class="difflineplus">+      //  var ix;</span>
<a href="#l11.336"></a><span id="l11.336" class="difflineplus">+      //  for (ix in this._windows) {</span>
<a href="#l11.337"></a><span id="l11.337" class="difflineplus">+      //    this._windows[ix]._closedTabs.splice(this._prefBranch.getIntPref(&quot;tabs.undoclose.depth&quot;));</span>
<a href="#l11.338"></a><span id="l11.338" class="difflineplus">+      //  }</span>
<a href="#l11.339"></a><span id="l11.339" class="difflineplus">+      //  break;</span>
<a href="#l11.340"></a><span id="l11.340" class="difflineplus">+      case &quot;sessionstore.max_tabs_undo&quot;:</span>
<a href="#l11.341"></a><span id="l11.341" class="difflineplus">+        //todo: we need some way to syncronise sessionstore.max_tabs_undo and tabs.undoclose.depth</span>
<a href="#l11.342"></a><span id="l11.342" class="difflineplus">+        break;</span>
<a href="#l11.343"></a><span id="l11.343" class="difflineplus">+      case &quot;sessionstore.interval&quot;:</span>
<a href="#l11.344"></a><span id="l11.344" class="difflineplus">+        this._interval = this._prefBranch.getIntPref(&quot;sessionstore.interval&quot;);</span>
<a href="#l11.345"></a><span id="l11.345" class="difflineplus">+        // reset timer and save</span>
<a href="#l11.346"></a><span id="l11.346" class="difflineplus">+        if (this._saveTimer) {</span>
<a href="#l11.347"></a><span id="l11.347" class="difflineplus">+          this._saveTimer.cancel();</span>
<a href="#l11.348"></a><span id="l11.348" class="difflineplus">+          this._saveTimer = null;</span>
<a href="#l11.349"></a><span id="l11.349" class="difflineplus">+        }</span>
<a href="#l11.350"></a><span id="l11.350" class="difflineplus">+        this.saveStateDelayed(null, -1);</span>
<a href="#l11.351"></a><span id="l11.351" class="difflineplus">+        break;</span>
<a href="#l11.352"></a><span id="l11.352" class="difflineplus">+      case &quot;sessionstore.resume_from_crash&quot;:</span>
<a href="#l11.353"></a><span id="l11.353" class="difflineplus">+        this._resume_from_crash = this._prefBranch.getBoolPref(&quot;sessionstore.resume_from_crash&quot;);</span>
<a href="#l11.354"></a><span id="l11.354" class="difflineplus">+        // either create the file with crash recovery information or remove it</span>
<a href="#l11.355"></a><span id="l11.355" class="difflineplus">+        // (when _loadState is not STATE_RUNNING, that file is used for session resuming instead)</span>
<a href="#l11.356"></a><span id="l11.356" class="difflineplus">+        if (this._resume_from_crash)</span>
<a href="#l11.357"></a><span id="l11.357" class="difflineplus">+          this.saveState(true);</span>
<a href="#l11.358"></a><span id="l11.358" class="difflineplus">+        else if (this._loadState == STATE_RUNNING)</span>
<a href="#l11.359"></a><span id="l11.359" class="difflineplus">+          this._clearDisk();</span>
<a href="#l11.360"></a><span id="l11.360" class="difflineplus">+        break;</span>
<a href="#l11.361"></a><span id="l11.361" class="difflineplus">+      }</span>
<a href="#l11.362"></a><span id="l11.362" class="difflineplus">+      break;</span>
<a href="#l11.363"></a><span id="l11.363" class="difflineplus">+    case &quot;timer-callback&quot;: // timer call back for delayed saving</span>
<a href="#l11.364"></a><span id="l11.364" class="difflineplus">+      this._saveTimer = null;</span>
<a href="#l11.365"></a><span id="l11.365" class="difflineplus">+      this.saveState();</span>
<a href="#l11.366"></a><span id="l11.366" class="difflineplus">+      break;</span>
<a href="#l11.367"></a><span id="l11.367" class="difflineplus">+    }</span>
<a href="#l11.368"></a><span id="l11.368" class="difflineplus">+  },</span>
<a href="#l11.369"></a><span id="l11.369" class="difflineplus">+</span>
<a href="#l11.370"></a><span id="l11.370" class="difflineplus">+/* ........ Window Event Handlers .............. */</span>
<a href="#l11.371"></a><span id="l11.371" class="difflineplus">+</span>
<a href="#l11.372"></a><span id="l11.372" class="difflineplus">+  /**</span>
<a href="#l11.373"></a><span id="l11.373" class="difflineplus">+   * Implement nsIDOMEventListener for handling various window and tab events</span>
<a href="#l11.374"></a><span id="l11.374" class="difflineplus">+   */</span>
<a href="#l11.375"></a><span id="l11.375" class="difflineplus">+  handleEvent: function sss_handleEvent(aEvent) {</span>
<a href="#l11.376"></a><span id="l11.376" class="difflineplus">+    switch (aEvent.type) {</span>
<a href="#l11.377"></a><span id="l11.377" class="difflineplus">+      case &quot;load&quot;:</span>
<a href="#l11.378"></a><span id="l11.378" class="difflineplus">+      case &quot;pageshow&quot;:</span>
<a href="#l11.379"></a><span id="l11.379" class="difflineplus">+        this.onTabLoad(aEvent.currentTarget.ownerDocument.defaultView, aEvent.currentTarget, aEvent);</span>
<a href="#l11.380"></a><span id="l11.380" class="difflineplus">+        break;</span>
<a href="#l11.381"></a><span id="l11.381" class="difflineplus">+      case &quot;change&quot;:</span>
<a href="#l11.382"></a><span id="l11.382" class="difflineplus">+      case &quot;input&quot;:</span>
<a href="#l11.383"></a><span id="l11.383" class="difflineplus">+      case &quot;DOMAutoComplete&quot;:</span>
<a href="#l11.384"></a><span id="l11.384" class="difflineplus">+        this.onTabInput(aEvent.currentTarget.ownerDocument.defaultView, aEvent.currentTarget);</span>
<a href="#l11.385"></a><span id="l11.385" class="difflineplus">+        break;</span>
<a href="#l11.386"></a><span id="l11.386" class="difflineplus">+      case &quot;scroll&quot;:</span>
<a href="#l11.387"></a><span id="l11.387" class="difflineplus">+        this.onTabScroll(aEvent.currentTarget.ownerDocument.defaultView);</span>
<a href="#l11.388"></a><span id="l11.388" class="difflineplus">+        break;</span>
<a href="#l11.389"></a><span id="l11.389" class="difflineplus">+      case &quot;TabOpen&quot;:</span>
<a href="#l11.390"></a><span id="l11.390" class="difflineplus">+      case &quot;TabClose&quot;:</span>
<a href="#l11.391"></a><span id="l11.391" class="difflineplus">+        var panelID = aEvent.originalTarget.linkedPanel;</span>
<a href="#l11.392"></a><span id="l11.392" class="difflineplus">+        var tabpanel = aEvent.originalTarget.ownerDocument.getElementById(panelID);</span>
<a href="#l11.393"></a><span id="l11.393" class="difflineplus">+        if (aEvent.type == &quot;TabOpen&quot;) {</span>
<a href="#l11.394"></a><span id="l11.394" class="difflineplus">+          this.onTabAdd(aEvent.currentTarget.ownerDocument.defaultView, tabpanel);</span>
<a href="#l11.395"></a><span id="l11.395" class="difflineplus">+        }</span>
<a href="#l11.396"></a><span id="l11.396" class="difflineplus">+        else {</span>
<a href="#l11.397"></a><span id="l11.397" class="difflineplus">+          this.onTabClose(aEvent.currentTarget.ownerDocument.defaultView, aEvent.originalTarget);</span>
<a href="#l11.398"></a><span id="l11.398" class="difflineplus">+          this.onTabRemove(aEvent.currentTarget.ownerDocument.defaultView, tabpanel);</span>
<a href="#l11.399"></a><span id="l11.399" class="difflineplus">+        }</span>
<a href="#l11.400"></a><span id="l11.400" class="difflineplus">+        break;</span>
<a href="#l11.401"></a><span id="l11.401" class="difflineplus">+      case &quot;TabSelect&quot;:</span>
<a href="#l11.402"></a><span id="l11.402" class="difflineplus">+        var tabpanels = aEvent.currentTarget.mPanelContainer;</span>
<a href="#l11.403"></a><span id="l11.403" class="difflineplus">+        this.onTabSelect(aEvent.currentTarget.ownerDocument.defaultView, tabpanels);</span>
<a href="#l11.404"></a><span id="l11.404" class="difflineplus">+        break;</span>
<a href="#l11.405"></a><span id="l11.405" class="difflineplus">+    }</span>
<a href="#l11.406"></a><span id="l11.406" class="difflineplus">+  },</span>
<a href="#l11.407"></a><span id="l11.407" class="difflineplus">+</span>
<a href="#l11.408"></a><span id="l11.408" class="difflineplus">+  /**</span>
<a href="#l11.409"></a><span id="l11.409" class="difflineplus">+   * If it's the first window load since app start...</span>
<a href="#l11.410"></a><span id="l11.410" class="difflineplus">+   * - determine if we're reloading after a crash or a forced-restart</span>
<a href="#l11.411"></a><span id="l11.411" class="difflineplus">+   * - restore window state</span>
<a href="#l11.412"></a><span id="l11.412" class="difflineplus">+   * - restart downloads</span>
<a href="#l11.413"></a><span id="l11.413" class="difflineplus">+   * Set up event listeners for this window's tabs</span>
<a href="#l11.414"></a><span id="l11.414" class="difflineplus">+   * @param aWindow</span>
<a href="#l11.415"></a><span id="l11.415" class="difflineplus">+   *        Window reference</span>
<a href="#l11.416"></a><span id="l11.416" class="difflineplus">+   */</span>
<a href="#l11.417"></a><span id="l11.417" class="difflineplus">+  onLoad: function sss_onLoad(aWindow) {</span>
<a href="#l11.418"></a><span id="l11.418" class="difflineplus">+    // return if window has already been initialized</span>
<a href="#l11.419"></a><span id="l11.419" class="difflineplus">+    if (aWindow &amp;&amp; aWindow.__SSi &amp;&amp; this._windows[aWindow.__SSi])</span>
<a href="#l11.420"></a><span id="l11.420" class="difflineplus">+      return;</span>
<a href="#l11.421"></a><span id="l11.421" class="difflineplus">+</span>
<a href="#l11.422"></a><span id="l11.422" class="difflineplus">+    // ignore non-browser windows and windows opened while shutting down</span>
<a href="#l11.423"></a><span id="l11.423" class="difflineplus">+    if (aWindow.document.documentElement.getAttribute(&quot;windowtype&quot;) != &quot;navigator:browser&quot; ||</span>
<a href="#l11.424"></a><span id="l11.424" class="difflineplus">+      this._loadState == STATE_QUITTING)</span>
<a href="#l11.425"></a><span id="l11.425" class="difflineplus">+      return;</span>
<a href="#l11.426"></a><span id="l11.426" class="difflineplus">+</span>
<a href="#l11.427"></a><span id="l11.427" class="difflineplus">+    // assign it a unique identifier (timestamp)</span>
<a href="#l11.428"></a><span id="l11.428" class="difflineplus">+    aWindow.__SSi = &quot;window&quot; + Date.now();</span>
<a href="#l11.429"></a><span id="l11.429" class="difflineplus">+</span>
<a href="#l11.430"></a><span id="l11.430" class="difflineplus">+    // and create its data object</span>
<a href="#l11.431"></a><span id="l11.431" class="difflineplus">+    this._windows[aWindow.__SSi] = { tabs: [], selected: 0, _closedTabs: [] };</span>
<a href="#l11.432"></a><span id="l11.432" class="difflineplus">+    if (!aWindow.toolbar.visible)</span>
<a href="#l11.433"></a><span id="l11.433" class="difflineplus">+      this._windows[aWindow.__SSi].isPopup = true;</span>
<a href="#l11.434"></a><span id="l11.434" class="difflineplus">+</span>
<a href="#l11.435"></a><span id="l11.435" class="difflineplus">+    // perform additional initialization when the first window is loading</span>
<a href="#l11.436"></a><span id="l11.436" class="difflineplus">+    if (this._loadState == STATE_STOPPED) {</span>
<a href="#l11.437"></a><span id="l11.437" class="difflineplus">+      this._loadState = STATE_RUNNING;</span>
<a href="#l11.438"></a><span id="l11.438" class="difflineplus">+      this._lastSaveTime = Date.now();</span>
<a href="#l11.439"></a><span id="l11.439" class="difflineplus">+</span>
<a href="#l11.440"></a><span id="l11.440" class="difflineplus">+      // don't save during the first ten seconds</span>
<a href="#l11.441"></a><span id="l11.441" class="difflineplus">+      // (until most of the pages have been restored)</span>
<a href="#l11.442"></a><span id="l11.442" class="difflineplus">+      this.saveStateDelayed(aWindow, 10000);</span>
<a href="#l11.443"></a><span id="l11.443" class="difflineplus">+</span>
<a href="#l11.444"></a><span id="l11.444" class="difflineplus">+      // restore a crashed session resp. resume the last session if requested</span>
<a href="#l11.445"></a><span id="l11.445" class="difflineplus">+      if (this._initialState) {</span>
<a href="#l11.446"></a><span id="l11.446" class="difflineplus">+        // make sure that the restored tabs are first in the window</span>
<a href="#l11.447"></a><span id="l11.447" class="difflineplus">+        this._initialState._firstTabs = true;</span>
<a href="#l11.448"></a><span id="l11.448" class="difflineplus">+        this._restoreCount = this._initialState.windows ? this._initialState.windows.length : 0;</span>
<a href="#l11.449"></a><span id="l11.449" class="difflineplus">+        this.restoreWindow(aWindow, this._initialState, this._isCmdLineEmpty(aWindow));</span>
<a href="#l11.450"></a><span id="l11.450" class="difflineplus">+        delete this._initialState;</span>
<a href="#l11.451"></a><span id="l11.451" class="difflineplus">+      }</span>
<a href="#l11.452"></a><span id="l11.452" class="difflineplus">+      else {</span>
<a href="#l11.453"></a><span id="l11.453" class="difflineplus">+        // Nothing to restore, notify observers things are complete.</span>
<a href="#l11.454"></a><span id="l11.454" class="difflineplus">+        var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l11.455"></a><span id="l11.455" class="difflineplus">+                                        .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l11.456"></a><span id="l11.456" class="difflineplus">+        observerService.notifyObservers(null, NOTIFY_WINDOWS_RESTORED, &quot;&quot;);</span>
<a href="#l11.457"></a><span id="l11.457" class="difflineplus">+      }</span>
<a href="#l11.458"></a><span id="l11.458" class="difflineplus">+    }</span>
<a href="#l11.459"></a><span id="l11.459" class="difflineplus">+</span>
<a href="#l11.460"></a><span id="l11.460" class="difflineplus">+    var tabbrowser = aWindow.getBrowser();</span>
<a href="#l11.461"></a><span id="l11.461" class="difflineplus">+    var tabpanels = tabbrowser.mPanelContainer;</span>
<a href="#l11.462"></a><span id="l11.462" class="difflineplus">+</span>
<a href="#l11.463"></a><span id="l11.463" class="difflineplus">+    // add tab change listeners to all already existing tabs</span>
<a href="#l11.464"></a><span id="l11.464" class="difflineplus">+    for (var i = 0; i &lt; tabpanels.childNodes.length; i++) {</span>
<a href="#l11.465"></a><span id="l11.465" class="difflineplus">+      this.onTabAdd(aWindow, tabpanels.childNodes[i], true);</span>
<a href="#l11.466"></a><span id="l11.466" class="difflineplus">+    }</span>
<a href="#l11.467"></a><span id="l11.467" class="difflineplus">+    // notification of tab add/remove/selection</span>
<a href="#l11.468"></a><span id="l11.468" class="difflineplus">+    tabbrowser.addEventListener(&quot;TabOpen&quot;, this, true);</span>
<a href="#l11.469"></a><span id="l11.469" class="difflineplus">+    tabbrowser.addEventListener(&quot;TabClose&quot;, this, true);</span>
<a href="#l11.470"></a><span id="l11.470" class="difflineplus">+    tabbrowser.addEventListener(&quot;TabSelect&quot;, this, true);</span>
<a href="#l11.471"></a><span id="l11.471" class="difflineplus">+  },</span>
<a href="#l11.472"></a><span id="l11.472" class="difflineplus">+</span>
<a href="#l11.473"></a><span id="l11.473" class="difflineplus">+  /**</span>
<a href="#l11.474"></a><span id="l11.474" class="difflineplus">+   * On window close...</span>
<a href="#l11.475"></a><span id="l11.475" class="difflineplus">+   * - remove event listeners from tabs</span>
<a href="#l11.476"></a><span id="l11.476" class="difflineplus">+   * - save all window data</span>
<a href="#l11.477"></a><span id="l11.477" class="difflineplus">+   * @param aWindow</span>
<a href="#l11.478"></a><span id="l11.478" class="difflineplus">+   *        Window reference</span>
<a href="#l11.479"></a><span id="l11.479" class="difflineplus">+   */</span>
<a href="#l11.480"></a><span id="l11.480" class="difflineplus">+  onClose: function sss_onClose(aWindow) {</span>
<a href="#l11.481"></a><span id="l11.481" class="difflineplus">+    // ignore windows not tracked by SessionStore</span>
<a href="#l11.482"></a><span id="l11.482" class="difflineplus">+    if (!aWindow.__SSi || !this._windows[aWindow.__SSi]) {</span>
<a href="#l11.483"></a><span id="l11.483" class="difflineplus">+      return;</span>
<a href="#l11.484"></a><span id="l11.484" class="difflineplus">+    }</span>
<a href="#l11.485"></a><span id="l11.485" class="difflineplus">+</span>
<a href="#l11.486"></a><span id="l11.486" class="difflineplus">+    if (this.windowToFocus &amp;&amp; this.windowToFocus == aWindow) {</span>
<a href="#l11.487"></a><span id="l11.487" class="difflineplus">+      delete this.windowToFocus;</span>
<a href="#l11.488"></a><span id="l11.488" class="difflineplus">+    }</span>
<a href="#l11.489"></a><span id="l11.489" class="difflineplus">+</span>
<a href="#l11.490"></a><span id="l11.490" class="difflineplus">+    var tabbrowser = aWindow.getBrowser();</span>
<a href="#l11.491"></a><span id="l11.491" class="difflineplus">+    var tabpanels = tabbrowser.mPanelContainer;</span>
<a href="#l11.492"></a><span id="l11.492" class="difflineplus">+</span>
<a href="#l11.493"></a><span id="l11.493" class="difflineplus">+    tabbrowser.removeEventListener(&quot;TabOpen&quot;, this, true);</span>
<a href="#l11.494"></a><span id="l11.494" class="difflineplus">+    tabbrowser.removeEventListener(&quot;TabClose&quot;, this, true);</span>
<a href="#l11.495"></a><span id="l11.495" class="difflineplus">+    tabbrowser.removeEventListener(&quot;TabSelect&quot;, this, true);</span>
<a href="#l11.496"></a><span id="l11.496" class="difflineplus">+</span>
<a href="#l11.497"></a><span id="l11.497" class="difflineplus">+    if (this._loadState == STATE_RUNNING) { // window not closed during a regular shut-down</span>
<a href="#l11.498"></a><span id="l11.498" class="difflineplus">+      // update all window data for a last time</span>
<a href="#l11.499"></a><span id="l11.499" class="difflineplus">+      this._collectWindowData(aWindow);</span>
<a href="#l11.500"></a><span id="l11.500" class="difflineplus">+</span>
<a href="#l11.501"></a><span id="l11.501" class="difflineplus">+      // preserve this window's data (in case it was the last navigator:browser)</span>
<a href="#l11.502"></a><span id="l11.502" class="difflineplus">+      var winData = this._windows[aWindow.__SSi];</span>
<a href="#l11.503"></a><span id="l11.503" class="difflineplus">+      winData.title = aWindow.content.document.title;</span>
<a href="#l11.504"></a><span id="l11.504" class="difflineplus">+      winData._closedTabs = tabbrowser.savedBrowsers.map(function(e) { return e.tabData; });</span>
<a href="#l11.505"></a><span id="l11.505" class="difflineplus">+</span>
<a href="#l11.506"></a><span id="l11.506" class="difflineplus">+      // if this is a popup window, append it to what we've already got (cf. bug 368677)</span>
<a href="#l11.507"></a><span id="l11.507" class="difflineplus">+      if (!this._lastClosedWindows || !winData.isPopup)</span>
<a href="#l11.508"></a><span id="l11.508" class="difflineplus">+        this._lastClosedWindows = [winData];</span>
<a href="#l11.509"></a><span id="l11.509" class="difflineplus">+      else</span>
<a href="#l11.510"></a><span id="l11.510" class="difflineplus">+        this._lastClosedWindows.push(winData);</span>
<a href="#l11.511"></a><span id="l11.511" class="difflineplus">+</span>
<a href="#l11.512"></a><span id="l11.512" class="difflineplus">+      this._updateCookies(this._lastClosedWindows);</span>
<a href="#l11.513"></a><span id="l11.513" class="difflineplus">+</span>
<a href="#l11.514"></a><span id="l11.514" class="difflineplus">+      // clear this window from the list</span>
<a href="#l11.515"></a><span id="l11.515" class="difflineplus">+      delete this._windows[aWindow.__SSi];</span>
<a href="#l11.516"></a><span id="l11.516" class="difflineplus">+</span>
<a href="#l11.517"></a><span id="l11.517" class="difflineplus">+      // save the state without this window to disk</span>
<a href="#l11.518"></a><span id="l11.518" class="difflineplus">+      this.saveStateDelayed();</span>
<a href="#l11.519"></a><span id="l11.519" class="difflineplus">+    }</span>
<a href="#l11.520"></a><span id="l11.520" class="difflineplus">+</span>
<a href="#l11.521"></a><span id="l11.521" class="difflineplus">+    for (var i = 0; i &lt; tabpanels.childNodes.length; i++) {</span>
<a href="#l11.522"></a><span id="l11.522" class="difflineplus">+      this.onTabRemove(aWindow, tabpanels.childNodes[i], true);</span>
<a href="#l11.523"></a><span id="l11.523" class="difflineplus">+    }</span>
<a href="#l11.524"></a><span id="l11.524" class="difflineplus">+</span>
<a href="#l11.525"></a><span id="l11.525" class="difflineplus">+    // cache the window state until the window is completely gone</span>
<a href="#l11.526"></a><span id="l11.526" class="difflineplus">+    aWindow.__SS_dyingCache = this._windows[aWindow.__SSi] || winData;</span>
<a href="#l11.527"></a><span id="l11.527" class="difflineplus">+</span>
<a href="#l11.528"></a><span id="l11.528" class="difflineplus">+    // reset the _tab property to avoid keeping the tab's XUL element alive</span>
<a href="#l11.529"></a><span id="l11.529" class="difflineplus">+    // longer than we need it</span>
<a href="#l11.530"></a><span id="l11.530" class="difflineplus">+    var tabCount = aWindow.__SS_dyingCache.tabs.length;</span>
<a href="#l11.531"></a><span id="l11.531" class="difflineplus">+    for (var t = 0; t &lt; tabCount; t++) {</span>
<a href="#l11.532"></a><span id="l11.532" class="difflineplus">+      delete aWindow.__SS_dyingCache.tabs[t]._tab;</span>
<a href="#l11.533"></a><span id="l11.533" class="difflineplus">+    }</span>
<a href="#l11.534"></a><span id="l11.534" class="difflineplus">+</span>
<a href="#l11.535"></a><span id="l11.535" class="difflineplus">+    delete aWindow.__SSi;</span>
<a href="#l11.536"></a><span id="l11.536" class="difflineplus">+  },</span>
<a href="#l11.537"></a><span id="l11.537" class="difflineplus">+</span>
<a href="#l11.538"></a><span id="l11.538" class="difflineplus">+  /**</span>
<a href="#l11.539"></a><span id="l11.539" class="difflineplus">+   * set up listeners for a new tab</span>
<a href="#l11.540"></a><span id="l11.540" class="difflineplus">+   * @param aWindow</span>
<a href="#l11.541"></a><span id="l11.541" class="difflineplus">+   *        Window reference</span>
<a href="#l11.542"></a><span id="l11.542" class="difflineplus">+   * @param aPanel</span>
<a href="#l11.543"></a><span id="l11.543" class="difflineplus">+   *        TabPanel reference</span>
<a href="#l11.544"></a><span id="l11.544" class="difflineplus">+   * @param aNoNotification</span>
<a href="#l11.545"></a><span id="l11.545" class="difflineplus">+   *        bool Do not save state if we're updating an existing tab</span>
<a href="#l11.546"></a><span id="l11.546" class="difflineplus">+   */</span>
<a href="#l11.547"></a><span id="l11.547" class="difflineplus">+  onTabAdd: function sss_onTabAdd(aWindow, aPanel, aNoNotification) {</span>
<a href="#l11.548"></a><span id="l11.548" class="difflineplus">+    aPanel.addEventListener(&quot;load&quot;, this, true);</span>
<a href="#l11.549"></a><span id="l11.549" class="difflineplus">+    aPanel.addEventListener(&quot;pageshow&quot;, this, true);</span>
<a href="#l11.550"></a><span id="l11.550" class="difflineplus">+    aPanel.addEventListener(&quot;change&quot;, this, true);</span>
<a href="#l11.551"></a><span id="l11.551" class="difflineplus">+    aPanel.addEventListener(&quot;input&quot;, this, true);</span>
<a href="#l11.552"></a><span id="l11.552" class="difflineplus">+    aPanel.addEventListener(&quot;DOMAutoComplete&quot;, this, true);</span>
<a href="#l11.553"></a><span id="l11.553" class="difflineplus">+    aPanel.addEventListener(&quot;scroll&quot;, this, true);</span>
<a href="#l11.554"></a><span id="l11.554" class="difflineplus">+</span>
<a href="#l11.555"></a><span id="l11.555" class="difflineplus">+    if (!aNoNotification) {</span>
<a href="#l11.556"></a><span id="l11.556" class="difflineplus">+      this.saveStateDelayed(aWindow);</span>
<a href="#l11.557"></a><span id="l11.557" class="difflineplus">+    }</span>
<a href="#l11.558"></a><span id="l11.558" class="difflineplus">+  },</span>
<a href="#l11.559"></a><span id="l11.559" class="difflineplus">+</span>
<a href="#l11.560"></a><span id="l11.560" class="difflineplus">+  /**</span>
<a href="#l11.561"></a><span id="l11.561" class="difflineplus">+   * remove listeners for a tab</span>
<a href="#l11.562"></a><span id="l11.562" class="difflineplus">+   * @param aWindow</span>
<a href="#l11.563"></a><span id="l11.563" class="difflineplus">+   *        Window reference</span>
<a href="#l11.564"></a><span id="l11.564" class="difflineplus">+   * @param aPanel</span>
<a href="#l11.565"></a><span id="l11.565" class="difflineplus">+   *        TabPanel reference</span>
<a href="#l11.566"></a><span id="l11.566" class="difflineplus">+   * @param aNoNotification</span>
<a href="#l11.567"></a><span id="l11.567" class="difflineplus">+   *        bool Do not save state if we're updating an existing tab</span>
<a href="#l11.568"></a><span id="l11.568" class="difflineplus">+   */</span>
<a href="#l11.569"></a><span id="l11.569" class="difflineplus">+  onTabRemove: function sss_onTabRemove(aWindow, aPanel, aNoNotification) {</span>
<a href="#l11.570"></a><span id="l11.570" class="difflineplus">+    aPanel.removeEventListener(&quot;load&quot;, this, true);</span>
<a href="#l11.571"></a><span id="l11.571" class="difflineplus">+    aPanel.removeEventListener(&quot;pageshow&quot;, this, true);</span>
<a href="#l11.572"></a><span id="l11.572" class="difflineplus">+    aPanel.removeEventListener(&quot;change&quot;, this, true);</span>
<a href="#l11.573"></a><span id="l11.573" class="difflineplus">+    aPanel.removeEventListener(&quot;input&quot;, this, true);</span>
<a href="#l11.574"></a><span id="l11.574" class="difflineplus">+    aPanel.removeEventListener(&quot;DOMAutoComplete&quot;, this, true);</span>
<a href="#l11.575"></a><span id="l11.575" class="difflineplus">+    aPanel.removeEventListener(&quot;scroll&quot;, this, true);</span>
<a href="#l11.576"></a><span id="l11.576" class="difflineplus">+</span>
<a href="#l11.577"></a><span id="l11.577" class="difflineplus">+    delete aPanel.__SS_data;</span>
<a href="#l11.578"></a><span id="l11.578" class="difflineplus">+</span>
<a href="#l11.579"></a><span id="l11.579" class="difflineplus">+    if (!aNoNotification) {</span>
<a href="#l11.580"></a><span id="l11.580" class="difflineplus">+      this.saveStateDelayed(aWindow);</span>
<a href="#l11.581"></a><span id="l11.581" class="difflineplus">+    }</span>
<a href="#l11.582"></a><span id="l11.582" class="difflineplus">+  },</span>
<a href="#l11.583"></a><span id="l11.583" class="difflineplus">+</span>
<a href="#l11.584"></a><span id="l11.584" class="difflineplus">+  /**</span>
<a href="#l11.585"></a><span id="l11.585" class="difflineplus">+   * When a tab closes, collect its properties</span>
<a href="#l11.586"></a><span id="l11.586" class="difflineplus">+   * @param aWindow</span>
<a href="#l11.587"></a><span id="l11.587" class="difflineplus">+   *        Window reference</span>
<a href="#l11.588"></a><span id="l11.588" class="difflineplus">+   * @param aTab</span>
<a href="#l11.589"></a><span id="l11.589" class="difflineplus">+   *        TabPanel reference</span>
<a href="#l11.590"></a><span id="l11.590" class="difflineplus">+   */</span>
<a href="#l11.591"></a><span id="l11.591" class="difflineplus">+  onTabClose: function sss_onTabClose(aWindow, aTab) {</span>
<a href="#l11.592"></a><span id="l11.592" class="difflineplus">+    // notify the tabbrowser that the tab state will be retrieved for the last time</span>
<a href="#l11.593"></a><span id="l11.593" class="difflineplus">+    // (so that extension authors can easily set data on soon-to-be-closed tabs)</span>
<a href="#l11.594"></a><span id="l11.594" class="difflineplus">+    var event = aWindow.document.createEvent(&quot;Events&quot;);</span>
<a href="#l11.595"></a><span id="l11.595" class="difflineplus">+    event.initEvent(&quot;SSTabClosing&quot;, true, false);</span>
<a href="#l11.596"></a><span id="l11.596" class="difflineplus">+    aTab.dispatchEvent(event);</span>
<a href="#l11.597"></a><span id="l11.597" class="difflineplus">+</span>
<a href="#l11.598"></a><span id="l11.598" class="difflineplus">+    var maxTabsUndo = this._prefBranch.getIntPref(&quot;tabs.undoclose.depth&quot;);</span>
<a href="#l11.599"></a><span id="l11.599" class="difflineplus">+    // don't update our internal state if we don't have to</span>
<a href="#l11.600"></a><span id="l11.600" class="difflineplus">+    if (maxTabsUndo == 0) {</span>
<a href="#l11.601"></a><span id="l11.601" class="difflineplus">+      return;</span>
<a href="#l11.602"></a><span id="l11.602" class="difflineplus">+    }</span>
<a href="#l11.603"></a><span id="l11.603" class="difflineplus">+</span>
<a href="#l11.604"></a><span id="l11.604" class="difflineplus">+    // make sure that the tab related data is up-to-date</span>
<a href="#l11.605"></a><span id="l11.605" class="difflineplus">+    var tabState = this._collectTabData(aTab);</span>
<a href="#l11.606"></a><span id="l11.606" class="difflineplus">+    this._updateTextAndScrollDataForTab(aWindow, aTab.linkedBrowser, tabState);</span>
<a href="#l11.607"></a><span id="l11.607" class="difflineplus">+</span>
<a href="#l11.608"></a><span id="l11.608" class="difflineplus">+    // reset the _tab property to avoid keeping the tab's XUL element alive</span>
<a href="#l11.609"></a><span id="l11.609" class="difflineplus">+    // longer than we need it</span>
<a href="#l11.610"></a><span id="l11.610" class="difflineplus">+    delete tabState._tab;</span>
<a href="#l11.611"></a><span id="l11.611" class="difflineplus">+</span>
<a href="#l11.612"></a><span id="l11.612" class="difflineplus">+    // store closed-tab data for undo</span>
<a href="#l11.613"></a><span id="l11.613" class="difflineplus">+    if (tabState.entries.length &gt; 0) {</span>
<a href="#l11.614"></a><span id="l11.614" class="difflineplus">+      let tabTitle = aTab.label;</span>
<a href="#l11.615"></a><span id="l11.615" class="difflineplus">+      let tabbrowser = aWindow.gBrowser;</span>
<a href="#l11.616"></a><span id="l11.616" class="difflineplus">+      // replace &quot;Loading...&quot; with the document title (with minimal side-effects)</span>
<a href="#l11.617"></a><span id="l11.617" class="difflineplus">+      if (tabTitle == tabbrowser.mStringBundle.getString(&quot;tabs.loading&quot;)) {</span>
<a href="#l11.618"></a><span id="l11.618" class="difflineplus">+        tabbrowser.setTabTitle(aTab);</span>
<a href="#l11.619"></a><span id="l11.619" class="difflineplus">+        [tabTitle, aTab.label] = [aTab.label, tabTitle];</span>
<a href="#l11.620"></a><span id="l11.620" class="difflineplus">+      }</span>
<a href="#l11.621"></a><span id="l11.621" class="difflineplus">+</span>
<a href="#l11.622"></a><span id="l11.622" class="difflineplus">+      var tabsData = {</span>
<a href="#l11.623"></a><span id="l11.623" class="difflineplus">+          state: tabState,</span>
<a href="#l11.624"></a><span id="l11.624" class="difflineplus">+          title: tabTitle,</span>
<a href="#l11.625"></a><span id="l11.625" class="difflineplus">+          image: aTab.getAttribute(&quot;image&quot;),</span>
<a href="#l11.626"></a><span id="l11.626" class="difflineplus">+          pos: tabState.entries.length - 1</span>
<a href="#l11.627"></a><span id="l11.627" class="difflineplus">+      };</span>
<a href="#l11.628"></a><span id="l11.628" class="difflineplus">+      aTab.tabData = tabsData;</span>
<a href="#l11.629"></a><span id="l11.629" class="difflineplus">+    };</span>
<a href="#l11.630"></a><span id="l11.630" class="difflineplus">+  },</span>
<a href="#l11.631"></a><span id="l11.631" class="difflineplus">+</span>
<a href="#l11.632"></a><span id="l11.632" class="difflineplus">+  /**</span>
<a href="#l11.633"></a><span id="l11.633" class="difflineplus">+   * When a tab loads, save state.</span>
<a href="#l11.634"></a><span id="l11.634" class="difflineplus">+   * @param aWindow</span>
<a href="#l11.635"></a><span id="l11.635" class="difflineplus">+   *        Window reference</span>
<a href="#l11.636"></a><span id="l11.636" class="difflineplus">+   * @param aPanel</span>
<a href="#l11.637"></a><span id="l11.637" class="difflineplus">+   *        TabPanel reference</span>
<a href="#l11.638"></a><span id="l11.638" class="difflineplus">+   * @param aEvent</span>
<a href="#l11.639"></a><span id="l11.639" class="difflineplus">+   *        Event obj</span>
<a href="#l11.640"></a><span id="l11.640" class="difflineplus">+   */</span>
<a href="#l11.641"></a><span id="l11.641" class="difflineplus">+  onTabLoad: function sss_onTabLoad(aWindow, aPanel, aEvent) {</span>
<a href="#l11.642"></a><span id="l11.642" class="difflineplus">+    // react on &quot;load&quot; and solitary &quot;pageshow&quot; events (the first &quot;pageshow&quot;</span>
<a href="#l11.643"></a><span id="l11.643" class="difflineplus">+    // following &quot;load&quot; is too late for deleting the data caches)</span>
<a href="#l11.644"></a><span id="l11.644" class="difflineplus">+    if (aEvent.type != &quot;load&quot; &amp;&amp; !aEvent.persisted) {</span>
<a href="#l11.645"></a><span id="l11.645" class="difflineplus">+      return;</span>
<a href="#l11.646"></a><span id="l11.646" class="difflineplus">+    }</span>
<a href="#l11.647"></a><span id="l11.647" class="difflineplus">+</span>
<a href="#l11.648"></a><span id="l11.648" class="difflineplus">+    delete aPanel.__SS_data;</span>
<a href="#l11.649"></a><span id="l11.649" class="difflineplus">+    this.saveStateDelayed(aWindow);</span>
<a href="#l11.650"></a><span id="l11.650" class="difflineplus">+</span>
<a href="#l11.651"></a><span id="l11.651" class="difflineplus">+    // attempt to update the current URL we send in a crash report</span>
<a href="#l11.652"></a><span id="l11.652" class="difflineplus">+    this._updateCrashReportURL(aWindow);</span>
<a href="#l11.653"></a><span id="l11.653" class="difflineplus">+  },</span>
<a href="#l11.654"></a><span id="l11.654" class="difflineplus">+</span>
<a href="#l11.655"></a><span id="l11.655" class="difflineplus">+  /**</span>
<a href="#l11.656"></a><span id="l11.656" class="difflineplus">+   * Called when a tabpanel sends the &quot;input&quot; notification</span>
<a href="#l11.657"></a><span id="l11.657" class="difflineplus">+   * @param aWindow</span>
<a href="#l11.658"></a><span id="l11.658" class="difflineplus">+   *        Window reference</span>
<a href="#l11.659"></a><span id="l11.659" class="difflineplus">+   * @param aPanel</span>
<a href="#l11.660"></a><span id="l11.660" class="difflineplus">+   *        TabPanel reference</span>
<a href="#l11.661"></a><span id="l11.661" class="difflineplus">+   */</span>
<a href="#l11.662"></a><span id="l11.662" class="difflineplus">+  onTabInput: function sss_onTabInput(aWindow, aPanel) {</span>
<a href="#l11.663"></a><span id="l11.663" class="difflineplus">+    if (aPanel.__SS_data)</span>
<a href="#l11.664"></a><span id="l11.664" class="difflineplus">+      delete aPanel.__SS_data._formDataSaved;</span>
<a href="#l11.665"></a><span id="l11.665" class="difflineplus">+</span>
<a href="#l11.666"></a><span id="l11.666" class="difflineplus">+    this.saveStateDelayed(aWindow, 3000);</span>
<a href="#l11.667"></a><span id="l11.667" class="difflineplus">+  },</span>
<a href="#l11.668"></a><span id="l11.668" class="difflineplus">+</span>
<a href="#l11.669"></a><span id="l11.669" class="difflineplus">+  /**</span>
<a href="#l11.670"></a><span id="l11.670" class="difflineplus">+   * Called when a tabpanel sends a &quot;scroll&quot; notification</span>
<a href="#l11.671"></a><span id="l11.671" class="difflineplus">+   * @param aWindow</span>
<a href="#l11.672"></a><span id="l11.672" class="difflineplus">+   *        Window reference</span>
<a href="#l11.673"></a><span id="l11.673" class="difflineplus">+   */</span>
<a href="#l11.674"></a><span id="l11.674" class="difflineplus">+  onTabScroll: function sss_onTabScroll(aWindow) {</span>
<a href="#l11.675"></a><span id="l11.675" class="difflineplus">+    this.saveStateDelayed(aWindow, 3000);</span>
<a href="#l11.676"></a><span id="l11.676" class="difflineplus">+  },</span>
<a href="#l11.677"></a><span id="l11.677" class="difflineplus">+</span>
<a href="#l11.678"></a><span id="l11.678" class="difflineplus">+  /**</span>
<a href="#l11.679"></a><span id="l11.679" class="difflineplus">+   * When a tab is selected, save session data</span>
<a href="#l11.680"></a><span id="l11.680" class="difflineplus">+   * @param aWindow</span>
<a href="#l11.681"></a><span id="l11.681" class="difflineplus">+   *        Window reference</span>
<a href="#l11.682"></a><span id="l11.682" class="difflineplus">+   * @param aPanels</span>
<a href="#l11.683"></a><span id="l11.683" class="difflineplus">+   *        TabPanel reference</span>
<a href="#l11.684"></a><span id="l11.684" class="difflineplus">+   */</span>
<a href="#l11.685"></a><span id="l11.685" class="difflineplus">+  onTabSelect: function sss_onTabSelect(aWindow, aPanels) {</span>
<a href="#l11.686"></a><span id="l11.686" class="difflineplus">+    if (this._loadState == STATE_RUNNING) {</span>
<a href="#l11.687"></a><span id="l11.687" class="difflineplus">+      this._windows[aWindow.__SSi].selected = aPanels.selectedIndex;</span>
<a href="#l11.688"></a><span id="l11.688" class="difflineplus">+      this.saveStateDelayed(aWindow);</span>
<a href="#l11.689"></a><span id="l11.689" class="difflineplus">+</span>
<a href="#l11.690"></a><span id="l11.690" class="difflineplus">+      // attempt to update the current URL we send in a crash report</span>
<a href="#l11.691"></a><span id="l11.691" class="difflineplus">+      this._updateCrashReportURL(aWindow);</span>
<a href="#l11.692"></a><span id="l11.692" class="difflineplus">+    }</span>
<a href="#l11.693"></a><span id="l11.693" class="difflineplus">+  },</span>
<a href="#l11.694"></a><span id="l11.694" class="difflineplus">+</span>
<a href="#l11.695"></a><span id="l11.695" class="difflineplus">+/* ........ nsISessionStore API .............. */</span>
<a href="#l11.696"></a><span id="l11.696" class="difflineplus">+</span>
<a href="#l11.697"></a><span id="l11.697" class="difflineplus">+  getBrowserState: function sss_getBrowserState() {</span>
<a href="#l11.698"></a><span id="l11.698" class="difflineplus">+    return this._toJSONString(this._getCurrentState());</span>
<a href="#l11.699"></a><span id="l11.699" class="difflineplus">+  },</span>
<a href="#l11.700"></a><span id="l11.700" class="difflineplus">+</span>
<a href="#l11.701"></a><span id="l11.701" class="difflineplus">+  setBrowserState: function sss_setBrowserState(aState) {</span>
<a href="#l11.702"></a><span id="l11.702" class="difflineplus">+    var window = this._getMostRecentBrowserWindow();</span>
<a href="#l11.703"></a><span id="l11.703" class="difflineplus">+    if (!window) {</span>
<a href="#l11.704"></a><span id="l11.704" class="difflineplus">+      this._openWindowWithState(&quot;(&quot; + aState + &quot;)&quot;);</span>
<a href="#l11.705"></a><span id="l11.705" class="difflineplus">+      return;</span>
<a href="#l11.706"></a><span id="l11.706" class="difflineplus">+    }</span>
<a href="#l11.707"></a><span id="l11.707" class="difflineplus">+</span>
<a href="#l11.708"></a><span id="l11.708" class="difflineplus">+    // close all other browser windows</span>
<a href="#l11.709"></a><span id="l11.709" class="difflineplus">+    this._forEachBrowserWindow(function(aWindow) {</span>
<a href="#l11.710"></a><span id="l11.710" class="difflineplus">+      if (aWindow != window) {</span>
<a href="#l11.711"></a><span id="l11.711" class="difflineplus">+        aWindow.close();</span>
<a href="#l11.712"></a><span id="l11.712" class="difflineplus">+      }</span>
<a href="#l11.713"></a><span id="l11.713" class="difflineplus">+    });</span>
<a href="#l11.714"></a><span id="l11.714" class="difflineplus">+</span>
<a href="#l11.715"></a><span id="l11.715" class="difflineplus">+    // restore to the given state</span>
<a href="#l11.716"></a><span id="l11.716" class="difflineplus">+    this.restoreWindow(window, &quot;(&quot; + aState + &quot;)&quot;, true);</span>
<a href="#l11.717"></a><span id="l11.717" class="difflineplus">+  },</span>
<a href="#l11.718"></a><span id="l11.718" class="difflineplus">+</span>
<a href="#l11.719"></a><span id="l11.719" class="difflineplus">+  getWindowState: function sss_getWindowState(aWindow) {</span>
<a href="#l11.720"></a><span id="l11.720" class="difflineplus">+    if (!aWindow.__SSi &amp;&amp; !aWindow.__SS_dyingCache)</span>
<a href="#l11.721"></a><span id="l11.721" class="difflineplus">+      throw (Components.returnCode = Components.results.NS_ERROR_INVALID_ARG);</span>
<a href="#l11.722"></a><span id="l11.722" class="difflineplus">+</span>
<a href="#l11.723"></a><span id="l11.723" class="difflineplus">+    if (!aWindow.__SSi)</span>
<a href="#l11.724"></a><span id="l11.724" class="difflineplus">+      return this._toJSONString({ windows: [aWindow.__SS_dyingCache] });</span>
<a href="#l11.725"></a><span id="l11.725" class="difflineplus">+    return this._toJSONString(this._getWindowState(aWindow));</span>
<a href="#l11.726"></a><span id="l11.726" class="difflineplus">+  },</span>
<a href="#l11.727"></a><span id="l11.727" class="difflineplus">+</span>
<a href="#l11.728"></a><span id="l11.728" class="difflineplus">+  setWindowState: function sss_setWindowState(aWindow, aState, aOverwrite) {</span>
<a href="#l11.729"></a><span id="l11.729" class="difflineplus">+    if (!aWindow.__SSi)</span>
<a href="#l11.730"></a><span id="l11.730" class="difflineplus">+      throw (Components.returnCode = Components.results.NS_ERROR_INVALID_ARG);</span>
<a href="#l11.731"></a><span id="l11.731" class="difflineplus">+</span>
<a href="#l11.732"></a><span id="l11.732" class="difflineplus">+    this.restoreWindow(aWindow, &quot;(&quot; + aState + &quot;)&quot;, aOverwrite);</span>
<a href="#l11.733"></a><span id="l11.733" class="difflineplus">+  },</span>
<a href="#l11.734"></a><span id="l11.734" class="difflineplus">+</span>
<a href="#l11.735"></a><span id="l11.735" class="difflineplus">+  getTabState: function sss_getTabState(aTab) {</span>
<a href="#l11.736"></a><span id="l11.736" class="difflineplus">+    if (!aTab.ownerDocument || !aTab.ownerDocument.defaultView.__SSi)</span>
<a href="#l11.737"></a><span id="l11.737" class="difflineplus">+      throw (Components.returnCode = Components.results.NS_ERROR_INVALID_ARG);</span>
<a href="#l11.738"></a><span id="l11.738" class="difflineplus">+</span>
<a href="#l11.739"></a><span id="l11.739" class="difflineplus">+    var tabState = this._collectTabData(aTab);</span>
<a href="#l11.740"></a><span id="l11.740" class="difflineplus">+</span>
<a href="#l11.741"></a><span id="l11.741" class="difflineplus">+    var window = aTab.ownerDocument.defaultView;</span>
<a href="#l11.742"></a><span id="l11.742" class="difflineplus">+    this._updateTextAndScrollDataForTab(window, aTab.linkedBrowser, tabState);</span>
<a href="#l11.743"></a><span id="l11.743" class="difflineplus">+</span>
<a href="#l11.744"></a><span id="l11.744" class="difflineplus">+    return this._toJSONString(tabState);</span>
<a href="#l11.745"></a><span id="l11.745" class="difflineplus">+  },</span>
<a href="#l11.746"></a><span id="l11.746" class="difflineplus">+</span>
<a href="#l11.747"></a><span id="l11.747" class="difflineplus">+  setTabState: function sss_setTabState(aTab, aState) {</span>
<a href="#l11.748"></a><span id="l11.748" class="difflineplus">+    var tabState = this._safeEval(&quot;(&quot; + aState + &quot;)&quot;);</span>
<a href="#l11.749"></a><span id="l11.749" class="difflineplus">+    if (!tabState.entries || !aTab.ownerDocument || !aTab.ownerDocument.defaultView.__SSi)</span>
<a href="#l11.750"></a><span id="l11.750" class="difflineplus">+      throw (Components.returnCode = Components.results.NS_ERROR_INVALID_ARG);</span>
<a href="#l11.751"></a><span id="l11.751" class="difflineplus">+</span>
<a href="#l11.752"></a><span id="l11.752" class="difflineplus">+    tabState._tab = aTab;</span>
<a href="#l11.753"></a><span id="l11.753" class="difflineplus">+</span>
<a href="#l11.754"></a><span id="l11.754" class="difflineplus">+    var window = aTab.ownerDocument.defaultView;</span>
<a href="#l11.755"></a><span id="l11.755" class="difflineplus">+    this.restoreHistoryPrecursor(window, [tabState], 0, 0, 0);</span>
<a href="#l11.756"></a><span id="l11.756" class="difflineplus">+  },</span>
<a href="#l11.757"></a><span id="l11.757" class="difflineplus">+</span>
<a href="#l11.758"></a><span id="l11.758" class="difflineplus">+  duplicateTab: function sss_duplicateTab(aWindow, aTab) {</span>
<a href="#l11.759"></a><span id="l11.759" class="difflineplus">+    if (!aTab.ownerDocument || !aTab.ownerDocument.defaultView.__SSi ||</span>
<a href="#l11.760"></a><span id="l11.760" class="difflineplus">+        !aWindow.getBrowser)</span>
<a href="#l11.761"></a><span id="l11.761" class="difflineplus">+      throw (Components.returnCode = Components.results.NS_ERROR_INVALID_ARG);</span>
<a href="#l11.762"></a><span id="l11.762" class="difflineplus">+</span>
<a href="#l11.763"></a><span id="l11.763" class="difflineplus">+    var tabState = this._collectTabData(aTab, true);</span>
<a href="#l11.764"></a><span id="l11.764" class="difflineplus">+    var sourceWindow = aTab.ownerDocument.defaultView;</span>
<a href="#l11.765"></a><span id="l11.765" class="difflineplus">+    this._updateTextAndScrollDataForTab(sourceWindow, aTab.linkedBrowser, tabState, true);</span>
<a href="#l11.766"></a><span id="l11.766" class="difflineplus">+</span>
<a href="#l11.767"></a><span id="l11.767" class="difflineplus">+    var newTab = aWindow.getBrowser().addTab();</span>
<a href="#l11.768"></a><span id="l11.768" class="difflineplus">+    tabState._tab = newTab;</span>
<a href="#l11.769"></a><span id="l11.769" class="difflineplus">+    this.restoreHistoryPrecursor(aWindow, [tabState], 0, 0, 0);</span>
<a href="#l11.770"></a><span id="l11.770" class="difflineplus">+</span>
<a href="#l11.771"></a><span id="l11.771" class="difflineplus">+    return newTab;</span>
<a href="#l11.772"></a><span id="l11.772" class="difflineplus">+  },</span>
<a href="#l11.773"></a><span id="l11.773" class="difflineplus">+</span>
<a href="#l11.774"></a><span id="l11.774" class="difflineplus">+  getClosedTabCount: function sss_getClosedTabCount(aWindow) {</span>
<a href="#l11.775"></a><span id="l11.775" class="difflineplus">+    //misak: 2 lines uncommented</span>
<a href="#l11.776"></a><span id="l11.776" class="difflineplus">+    if (!aWindow.__SSi &amp;&amp; aWindow.__SS_dyingCache)</span>
<a href="#l11.777"></a><span id="l11.777" class="difflineplus">+      return aWindow.__SS_dyingCache._closedTabs.length;</span>
<a href="#l11.778"></a><span id="l11.778" class="difflineplus">+</span>
<a href="#l11.779"></a><span id="l11.779" class="difflineplus">+    if (!aWindow.__SSi)</span>
<a href="#l11.780"></a><span id="l11.780" class="difflineplus">+      // XXXzeniko shouldn't we throw here?</span>
<a href="#l11.781"></a><span id="l11.781" class="difflineplus">+      return 0; // not a browser window, or not otherwise tracked by SS.</span>
<a href="#l11.782"></a><span id="l11.782" class="difflineplus">+</span>
<a href="#l11.783"></a><span id="l11.783" class="difflineplus">+    return aWindow.getBrowser().savedBrowsers.length;</span>
<a href="#l11.784"></a><span id="l11.784" class="difflineplus">+    //return this._windows[aWindow.__SSi]._closedTabs.length;</span>
<a href="#l11.785"></a><span id="l11.785" class="difflineplus">+  },</span>
<a href="#l11.786"></a><span id="l11.786" class="difflineplus">+</span>
<a href="#l11.787"></a><span id="l11.787" class="difflineplus">+  getClosedTabData: function sss_getClosedTabDataAt(aWindow) {</span>
<a href="#l11.788"></a><span id="l11.788" class="difflineplus">+    if (!aWindow.__SSi &amp;&amp; !aWindow.__SS_dyingCache)</span>
<a href="#l11.789"></a><span id="l11.789" class="difflineplus">+      throw (Components.returnCode = Components.results.NS_ERROR_INVALID_ARG);</span>
<a href="#l11.790"></a><span id="l11.790" class="difflineplus">+</span>
<a href="#l11.791"></a><span id="l11.791" class="difflineplus">+    if (!aWindow.__SSi)</span>
<a href="#l11.792"></a><span id="l11.792" class="difflineplus">+      return this._toJSONString(aWindow.__SS_dyingCache._closedTabs);</span>
<a href="#l11.793"></a><span id="l11.793" class="difflineplus">+    return this._toJSONString(aWindow.getBrowser().savedBrowsers.map(function(e) { return e.tabData; }))</span>
<a href="#l11.794"></a><span id="l11.794" class="difflineplus">+  },</span>
<a href="#l11.795"></a><span id="l11.795" class="difflineplus">+</span>
<a href="#l11.796"></a><span id="l11.796" class="difflineplus">+  undoCloseTab: function sss_undoCloseTab(aWindow, aIndex) {</span>
<a href="#l11.797"></a><span id="l11.797" class="difflineplus">+    if (!aWindow.__SSi)</span>
<a href="#l11.798"></a><span id="l11.798" class="difflineplus">+      throw (Components.returnCode = Components.results.NS_ERROR_INVALID_ARG);</span>
<a href="#l11.799"></a><span id="l11.799" class="difflineplus">+</span>
<a href="#l11.800"></a><span id="l11.800" class="difflineplus">+    var closedTabs = aWindow.getBrowser().savedBrowsers.map(function(e) { return e.tabData; });</span>
<a href="#l11.801"></a><span id="l11.801" class="difflineplus">+    // default to the most-recently closed tab</span>
<a href="#l11.802"></a><span id="l11.802" class="difflineplus">+</span>
<a href="#l11.803"></a><span id="l11.803" class="difflineplus">+    aIndex = aIndex || 0;</span>
<a href="#l11.804"></a><span id="l11.804" class="difflineplus">+    if (!(aIndex in closedTabs))</span>
<a href="#l11.805"></a><span id="l11.805" class="difflineplus">+      throw (Components.returnCode = Components.results.NS_ERROR_INVALID_ARG);</span>
<a href="#l11.806"></a><span id="l11.806" class="difflineplus">+</span>
<a href="#l11.807"></a><span id="l11.807" class="difflineplus">+    //var browser = aWindow.getBrowser();</span>
<a href="#l11.808"></a><span id="l11.808" class="difflineplus">+    let browser = aWindow.gBrowser;</span>
<a href="#l11.809"></a><span id="l11.809" class="difflineplus">+</span>
<a href="#l11.810"></a><span id="l11.810" class="difflineplus">+    // Seamonkey has it's own undoclosetab functionality</span>
<a href="#l11.811"></a><span id="l11.811" class="difflineplus">+    tab = browser.restoreTab(aIndex);</span>
<a href="#l11.812"></a><span id="l11.812" class="difflineplus">+</span>
<a href="#l11.813"></a><span id="l11.813" class="difflineplus">+    return tab;</span>
<a href="#l11.814"></a><span id="l11.814" class="difflineplus">+  },</span>
<a href="#l11.815"></a><span id="l11.815" class="difflineplus">+</span>
<a href="#l11.816"></a><span id="l11.816" class="difflineplus">+  getWindowValue: function sss_getWindowValue(aWindow, aKey) {</span>
<a href="#l11.817"></a><span id="l11.817" class="difflineplus">+    if (aWindow.__SSi) {</span>
<a href="#l11.818"></a><span id="l11.818" class="difflineplus">+      var data = this._windows[aWindow.__SSi].extData || {};</span>
<a href="#l11.819"></a><span id="l11.819" class="difflineplus">+      return data[aKey] || &quot;&quot;;</span>
<a href="#l11.820"></a><span id="l11.820" class="difflineplus">+    }</span>
<a href="#l11.821"></a><span id="l11.821" class="difflineplus">+    if (aWindow.__SS_dyingCache) {</span>
<a href="#l11.822"></a><span id="l11.822" class="difflineplus">+      data = aWindow.__SS_dyingCache.extData || {};</span>
<a href="#l11.823"></a><span id="l11.823" class="difflineplus">+      return data[aKey] || &quot;&quot;;</span>
<a href="#l11.824"></a><span id="l11.824" class="difflineplus">+    }</span>
<a href="#l11.825"></a><span id="l11.825" class="difflineplus">+    throw (Components.returnCode = Components.results.NS_ERROR_INVALID_ARG);</span>
<a href="#l11.826"></a><span id="l11.826" class="difflineplus">+  },</span>
<a href="#l11.827"></a><span id="l11.827" class="difflineplus">+</span>
<a href="#l11.828"></a><span id="l11.828" class="difflineplus">+  setWindowValue: function sss_setWindowValue(aWindow, aKey, aStringValue) {</span>
<a href="#l11.829"></a><span id="l11.829" class="difflineplus">+    if (aWindow.__SSi) {</span>
<a href="#l11.830"></a><span id="l11.830" class="difflineplus">+      if (!this._windows[aWindow.__SSi].extData) {</span>
<a href="#l11.831"></a><span id="l11.831" class="difflineplus">+        this._windows[aWindow.__SSi].extData = {};</span>
<a href="#l11.832"></a><span id="l11.832" class="difflineplus">+      }</span>
<a href="#l11.833"></a><span id="l11.833" class="difflineplus">+      this._windows[aWindow.__SSi].extData[aKey] = aStringValue;</span>
<a href="#l11.834"></a><span id="l11.834" class="difflineplus">+      this.saveStateDelayed(aWindow);</span>
<a href="#l11.835"></a><span id="l11.835" class="difflineplus">+    }</span>
<a href="#l11.836"></a><span id="l11.836" class="difflineplus">+    else {</span>
<a href="#l11.837"></a><span id="l11.837" class="difflineplus">+      throw (Components.returnCode = Components.results.NS_ERROR_INVALID_ARG);</span>
<a href="#l11.838"></a><span id="l11.838" class="difflineplus">+    }</span>
<a href="#l11.839"></a><span id="l11.839" class="difflineplus">+  },</span>
<a href="#l11.840"></a><span id="l11.840" class="difflineplus">+</span>
<a href="#l11.841"></a><span id="l11.841" class="difflineplus">+  deleteWindowValue: function sss_deleteWindowValue(aWindow, aKey) {</span>
<a href="#l11.842"></a><span id="l11.842" class="difflineplus">+    if (aWindow.__SSi &amp;&amp; this._windows[aWindow.__SSi].extData &amp;&amp;</span>
<a href="#l11.843"></a><span id="l11.843" class="difflineplus">+        this._windows[aWindow.__SSi].extData[aKey])</span>
<a href="#l11.844"></a><span id="l11.844" class="difflineplus">+      delete this._windows[aWindow.__SSi].extData[aKey];</span>
<a href="#l11.845"></a><span id="l11.845" class="difflineplus">+    else</span>
<a href="#l11.846"></a><span id="l11.846" class="difflineplus">+      throw (Components.returnCode = Components.results.NS_ERROR_INVALID_ARG);</span>
<a href="#l11.847"></a><span id="l11.847" class="difflineplus">+  },</span>
<a href="#l11.848"></a><span id="l11.848" class="difflineplus">+</span>
<a href="#l11.849"></a><span id="l11.849" class="difflineplus">+  getTabValue: function sss_getTabValue(aTab, aKey) {</span>
<a href="#l11.850"></a><span id="l11.850" class="difflineplus">+    var data = aTab.__SS_extdata || {};</span>
<a href="#l11.851"></a><span id="l11.851" class="difflineplus">+    return data[aKey] || &quot;&quot;;</span>
<a href="#l11.852"></a><span id="l11.852" class="difflineplus">+  },</span>
<a href="#l11.853"></a><span id="l11.853" class="difflineplus">+</span>
<a href="#l11.854"></a><span id="l11.854" class="difflineplus">+  setTabValue: function sss_setTabValue(aTab, aKey, aStringValue) {</span>
<a href="#l11.855"></a><span id="l11.855" class="difflineplus">+    if (!aTab.__SS_extdata) {</span>
<a href="#l11.856"></a><span id="l11.856" class="difflineplus">+      aTab.__SS_extdata = {};</span>
<a href="#l11.857"></a><span id="l11.857" class="difflineplus">+    }</span>
<a href="#l11.858"></a><span id="l11.858" class="difflineplus">+    aTab.__SS_extdata[aKey] = aStringValue;</span>
<a href="#l11.859"></a><span id="l11.859" class="difflineplus">+    this.saveStateDelayed(aTab.ownerDocument.defaultView);</span>
<a href="#l11.860"></a><span id="l11.860" class="difflineplus">+  },</span>
<a href="#l11.861"></a><span id="l11.861" class="difflineplus">+</span>
<a href="#l11.862"></a><span id="l11.862" class="difflineplus">+  deleteTabValue: function sss_deleteTabValue(aTab, aKey) {</span>
<a href="#l11.863"></a><span id="l11.863" class="difflineplus">+    if (aTab.__SS_extdata &amp;&amp; aTab.__SS_extdata[aKey])</span>
<a href="#l11.864"></a><span id="l11.864" class="difflineplus">+      delete aTab.__SS_extdata[aKey];</span>
<a href="#l11.865"></a><span id="l11.865" class="difflineplus">+    else</span>
<a href="#l11.866"></a><span id="l11.866" class="difflineplus">+      throw (Components.returnCode = Components.results.NS_ERROR_INVALID_ARG);</span>
<a href="#l11.867"></a><span id="l11.867" class="difflineplus">+  },</span>
<a href="#l11.868"></a><span id="l11.868" class="difflineplus">+</span>
<a href="#l11.869"></a><span id="l11.869" class="difflineplus">+  persistTabAttribute: function sss_persistTabAttribute(aName) {</span>
<a href="#l11.870"></a><span id="l11.870" class="difflineplus">+    if (this.xulAttributes.indexOf(aName) != -1)</span>
<a href="#l11.871"></a><span id="l11.871" class="difflineplus">+      return; // this attribute is already being tracked</span>
<a href="#l11.872"></a><span id="l11.872" class="difflineplus">+</span>
<a href="#l11.873"></a><span id="l11.873" class="difflineplus">+    this.xulAttributes.push(aName);</span>
<a href="#l11.874"></a><span id="l11.874" class="difflineplus">+    this.saveStateDelayed();</span>
<a href="#l11.875"></a><span id="l11.875" class="difflineplus">+  },</span>
<a href="#l11.876"></a><span id="l11.876" class="difflineplus">+</span>
<a href="#l11.877"></a><span id="l11.877" class="difflineplus">+/* ........ Saving Functionality .............. */</span>
<a href="#l11.878"></a><span id="l11.878" class="difflineplus">+</span>
<a href="#l11.879"></a><span id="l11.879" class="difflineplus">+  /**</span>
<a href="#l11.880"></a><span id="l11.880" class="difflineplus">+   * Store all session data for a window</span>
<a href="#l11.881"></a><span id="l11.881" class="difflineplus">+   * @param aWindow</span>
<a href="#l11.882"></a><span id="l11.882" class="difflineplus">+   *        Window reference</span>
<a href="#l11.883"></a><span id="l11.883" class="difflineplus">+   */</span>
<a href="#l11.884"></a><span id="l11.884" class="difflineplus">+  _saveWindowHistory: function sss_saveWindowHistory(aWindow) {</span>
<a href="#l11.885"></a><span id="l11.885" class="difflineplus">+    var tabbrowser = aWindow.getBrowser();</span>
<a href="#l11.886"></a><span id="l11.886" class="difflineplus">+    var tabs = tabbrowser.mTabs;</span>
<a href="#l11.887"></a><span id="l11.887" class="difflineplus">+    var tabsData = this._windows[aWindow.__SSi].tabs = [];</span>
<a href="#l11.888"></a><span id="l11.888" class="difflineplus">+</span>
<a href="#l11.889"></a><span id="l11.889" class="difflineplus">+    for (var i = 0; i &lt; tabs.length; i++)</span>
<a href="#l11.890"></a><span id="l11.890" class="difflineplus">+      tabsData.push(this._collectTabData(tabs[i]));</span>
<a href="#l11.891"></a><span id="l11.891" class="difflineplus">+</span>
<a href="#l11.892"></a><span id="l11.892" class="difflineplus">+    this._windows[aWindow.__SSi].selected = tabbrowser.mTabBox.selectedIndex + 1;</span>
<a href="#l11.893"></a><span id="l11.893" class="difflineplus">+  },</span>
<a href="#l11.894"></a><span id="l11.894" class="difflineplus">+</span>
<a href="#l11.895"></a><span id="l11.895" class="difflineplus">+  /**</span>
<a href="#l11.896"></a><span id="l11.896" class="difflineplus">+   * Collect data related to a single tab</span>
<a href="#l11.897"></a><span id="l11.897" class="difflineplus">+   * @param aTab</span>
<a href="#l11.898"></a><span id="l11.898" class="difflineplus">+   *        tabbrowser tab</span>
<a href="#l11.899"></a><span id="l11.899" class="difflineplus">+   * @param aFullData</span>
<a href="#l11.900"></a><span id="l11.900" class="difflineplus">+   *        always return privacy sensitive data (use with care)</span>
<a href="#l11.901"></a><span id="l11.901" class="difflineplus">+   * @returns object</span>
<a href="#l11.902"></a><span id="l11.902" class="difflineplus">+   */</span>
<a href="#l11.903"></a><span id="l11.903" class="difflineplus">+  _collectTabData: function sss_collectTabData(aTab, aFullData) {</span>
<a href="#l11.904"></a><span id="l11.904" class="difflineplus">+    var tabData = { entries: [] };</span>
<a href="#l11.905"></a><span id="l11.905" class="difflineplus">+    var browser = aTab.linkedBrowser;</span>
<a href="#l11.906"></a><span id="l11.906" class="difflineplus">+</span>
<a href="#l11.907"></a><span id="l11.907" class="difflineplus">+    if (!browser || !browser.currentURI)</span>
<a href="#l11.908"></a><span id="l11.908" class="difflineplus">+      // can happen when calling this function right after .addTab()</span>
<a href="#l11.909"></a><span id="l11.909" class="difflineplus">+      return tabData;</span>
<a href="#l11.910"></a><span id="l11.910" class="difflineplus">+    else if (browser.parentNode.__SS_data &amp;&amp; browser.parentNode.__SS_data._tab)</span>
<a href="#l11.911"></a><span id="l11.911" class="difflineplus">+      // use the data to be restored when the tab hasn't been completely loaded</span>
<a href="#l11.912"></a><span id="l11.912" class="difflineplus">+      return browser.parentNode.__SS_data;</span>
<a href="#l11.913"></a><span id="l11.913" class="difflineplus">+</span>
<a href="#l11.914"></a><span id="l11.914" class="difflineplus">+    var history = null;</span>
<a href="#l11.915"></a><span id="l11.915" class="difflineplus">+    try {</span>
<a href="#l11.916"></a><span id="l11.916" class="difflineplus">+      history = browser.sessionHistory;</span>
<a href="#l11.917"></a><span id="l11.917" class="difflineplus">+    }</span>
<a href="#l11.918"></a><span id="l11.918" class="difflineplus">+    catch (ex) { } // this could happen if we catch a tab during (de)initialization</span>
<a href="#l11.919"></a><span id="l11.919" class="difflineplus">+</span>
<a href="#l11.920"></a><span id="l11.920" class="difflineplus">+    if (history &amp;&amp; browser.parentNode.__SS_data &amp;&amp;</span>
<a href="#l11.921"></a><span id="l11.921" class="difflineplus">+        browser.parentNode.__SS_data.entries[history.index] &amp;&amp; !aFullData) {</span>
<a href="#l11.922"></a><span id="l11.922" class="difflineplus">+      tabData = browser.parentNode.__SS_data;</span>
<a href="#l11.923"></a><span id="l11.923" class="difflineplus">+      tabData.index = history.index + 1;</span>
<a href="#l11.924"></a><span id="l11.924" class="difflineplus">+    }</span>
<a href="#l11.925"></a><span id="l11.925" class="difflineplus">+    else if (history &amp;&amp; history.count &gt; 0) {</span>
<a href="#l11.926"></a><span id="l11.926" class="difflineplus">+      for (var j = 0; j &lt; history.count; j++)</span>
<a href="#l11.927"></a><span id="l11.927" class="difflineplus">+        tabData.entries.push(this._serializeHistoryEntry(history.getEntryAtIndex(j, false),</span>
<a href="#l11.928"></a><span id="l11.928" class="difflineplus">+                                                         aFullData));</span>
<a href="#l11.929"></a><span id="l11.929" class="difflineplus">+      tabData.index = history.index + 1;</span>
<a href="#l11.930"></a><span id="l11.930" class="difflineplus">+</span>
<a href="#l11.931"></a><span id="l11.931" class="difflineplus">+      // make sure not to cache privacy sensitive data which shouldn't get out</span>
<a href="#l11.932"></a><span id="l11.932" class="difflineplus">+      if (!aFullData)</span>
<a href="#l11.933"></a><span id="l11.933" class="difflineplus">+        browser.parentNode.__SS_data = tabData;</span>
<a href="#l11.934"></a><span id="l11.934" class="difflineplus">+    }</span>
<a href="#l11.935"></a><span id="l11.935" class="difflineplus">+    else if (browser.currentURI.spec != &quot;about:blank&quot; ||</span>
<a href="#l11.936"></a><span id="l11.936" class="difflineplus">+             browser.contentDocument.body.hasChildNodes()) {</span>
<a href="#l11.937"></a><span id="l11.937" class="difflineplus">+      tabData.entries[0] = { url: browser.currentURI.spec };</span>
<a href="#l11.938"></a><span id="l11.938" class="difflineplus">+      tabData.index = 1;</span>
<a href="#l11.939"></a><span id="l11.939" class="difflineplus">+    }</span>
<a href="#l11.940"></a><span id="l11.940" class="difflineplus">+</span>
<a href="#l11.941"></a><span id="l11.941" class="difflineplus">+    var disallow = [];</span>
<a href="#l11.942"></a><span id="l11.942" class="difflineplus">+    for (var i = 0; i &lt; CAPABILITIES.length; i++)</span>
<a href="#l11.943"></a><span id="l11.943" class="difflineplus">+      if (!browser.docShell[&quot;allow&quot; + CAPABILITIES[i]])</span>
<a href="#l11.944"></a><span id="l11.944" class="difflineplus">+        disallow.push(CAPABILITIES[i]);</span>
<a href="#l11.945"></a><span id="l11.945" class="difflineplus">+    if (disallow.length &gt; 0)</span>
<a href="#l11.946"></a><span id="l11.946" class="difflineplus">+      tabData.disallow = disallow.join(&quot;,&quot;);</span>
<a href="#l11.947"></a><span id="l11.947" class="difflineplus">+    else if (tabData.disallow)</span>
<a href="#l11.948"></a><span id="l11.948" class="difflineplus">+      delete tabData.disallow;</span>
<a href="#l11.949"></a><span id="l11.949" class="difflineplus">+</span>
<a href="#l11.950"></a><span id="l11.950" class="difflineplus">+    if (this.xulAttributes.length &gt; 0) {</span>
<a href="#l11.951"></a><span id="l11.951" class="difflineplus">+      tabData.attributes = {};</span>
<a href="#l11.952"></a><span id="l11.952" class="difflineplus">+      Array.forEach(aTab.attributes, function(aAttr) {</span>
<a href="#l11.953"></a><span id="l11.953" class="difflineplus">+        if (this.xulAttributes.indexOf(aAttr.name) &gt; -1)</span>
<a href="#l11.954"></a><span id="l11.954" class="difflineplus">+          tabData.attributes[aAttr.name] = aAttr.value;</span>
<a href="#l11.955"></a><span id="l11.955" class="difflineplus">+      }, this);</span>
<a href="#l11.956"></a><span id="l11.956" class="difflineplus">+    }</span>
<a href="#l11.957"></a><span id="l11.957" class="difflineplus">+</span>
<a href="#l11.958"></a><span id="l11.958" class="difflineplus">+    if (aTab.__SS_extdata)</span>
<a href="#l11.959"></a><span id="l11.959" class="difflineplus">+      tabData.extData = aTab.__SS_extdata;</span>
<a href="#l11.960"></a><span id="l11.960" class="difflineplus">+    else if (tabData.extData)</span>
<a href="#l11.961"></a><span id="l11.961" class="difflineplus">+      delete tabData.extData;</span>
<a href="#l11.962"></a><span id="l11.962" class="difflineplus">+</span>
<a href="#l11.963"></a><span id="l11.963" class="difflineplus">+    if (history &amp;&amp; browser.docShell instanceof Components.interfaces.nsIDocShell)</span>
<a href="#l11.964"></a><span id="l11.964" class="difflineplus">+      this._serializeSessionStorage(tabData, history, browser.docShell, aFullData);</span>
<a href="#l11.965"></a><span id="l11.965" class="difflineplus">+</span>
<a href="#l11.966"></a><span id="l11.966" class="difflineplus">+    return tabData;</span>
<a href="#l11.967"></a><span id="l11.967" class="difflineplus">+  },</span>
<a href="#l11.968"></a><span id="l11.968" class="difflineplus">+</span>
<a href="#l11.969"></a><span id="l11.969" class="difflineplus">+  /**</span>
<a href="#l11.970"></a><span id="l11.970" class="difflineplus">+   * Get an object that is a serialized representation of a History entry</span>
<a href="#l11.971"></a><span id="l11.971" class="difflineplus">+   * Used for data storage</span>
<a href="#l11.972"></a><span id="l11.972" class="difflineplus">+   * @param aEntry</span>
<a href="#l11.973"></a><span id="l11.973" class="difflineplus">+   *        nsISHEntry instance</span>
<a href="#l11.974"></a><span id="l11.974" class="difflineplus">+   * @param aFullData</span>
<a href="#l11.975"></a><span id="l11.975" class="difflineplus">+   *        always return privacy sensitive data (use with care)</span>
<a href="#l11.976"></a><span id="l11.976" class="difflineplus">+   * @returns object</span>
<a href="#l11.977"></a><span id="l11.977" class="difflineplus">+   */</span>
<a href="#l11.978"></a><span id="l11.978" class="difflineplus">+  _serializeHistoryEntry: function sss_serializeHistoryEntry(aEntry, aFullData) {</span>
<a href="#l11.979"></a><span id="l11.979" class="difflineplus">+    var entry = { url: aEntry.URI.spec };</span>
<a href="#l11.980"></a><span id="l11.980" class="difflineplus">+</span>
<a href="#l11.981"></a><span id="l11.981" class="difflineplus">+    if (aEntry.title &amp;&amp; aEntry.title != entry.url) {</span>
<a href="#l11.982"></a><span id="l11.982" class="difflineplus">+      entry.title = aEntry.title;</span>
<a href="#l11.983"></a><span id="l11.983" class="difflineplus">+    }</span>
<a href="#l11.984"></a><span id="l11.984" class="difflineplus">+    if (aEntry.isSubFrame) {</span>
<a href="#l11.985"></a><span id="l11.985" class="difflineplus">+      entry.subframe = true;</span>
<a href="#l11.986"></a><span id="l11.986" class="difflineplus">+    }</span>
<a href="#l11.987"></a><span id="l11.987" class="difflineplus">+    if (!(aEntry instanceof Components.interfaces.nsISHEntry)) {</span>
<a href="#l11.988"></a><span id="l11.988" class="difflineplus">+      return entry;</span>
<a href="#l11.989"></a><span id="l11.989" class="difflineplus">+    }</span>
<a href="#l11.990"></a><span id="l11.990" class="difflineplus">+</span>
<a href="#l11.991"></a><span id="l11.991" class="difflineplus">+    var cacheKey = aEntry.cacheKey;</span>
<a href="#l11.992"></a><span id="l11.992" class="difflineplus">+    if (cacheKey &amp;&amp; cacheKey instanceof Components.interfaces.nsISupportsPRUint32 &amp;&amp;</span>
<a href="#l11.993"></a><span id="l11.993" class="difflineplus">+        cacheKey.data != 0) {</span>
<a href="#l11.994"></a><span id="l11.994" class="difflineplus">+      // XXXbz would be better to have cache keys implement</span>
<a href="#l11.995"></a><span id="l11.995" class="difflineplus">+      // nsISerializable or something.</span>
<a href="#l11.996"></a><span id="l11.996" class="difflineplus">+      entry.cacheKey = cacheKey.data;</span>
<a href="#l11.997"></a><span id="l11.997" class="difflineplus">+    }</span>
<a href="#l11.998"></a><span id="l11.998" class="difflineplus">+    entry.ID = aEntry.ID;</span>
<a href="#l11.999"></a><span id="l11.999" class="difflineplus">+</span>
<a href="#l11.1000"></a><span id="l11.1000" class="difflineplus">+    if (aEntry.contentType)</span>
<a href="#l11.1001"></a><span id="l11.1001" class="difflineplus">+      entry.contentType = aEntry.contentType;</span>
<a href="#l11.1002"></a><span id="l11.1002" class="difflineplus">+</span>
<a href="#l11.1003"></a><span id="l11.1003" class="difflineplus">+    var x = {}, y = {};</span>
<a href="#l11.1004"></a><span id="l11.1004" class="difflineplus">+    aEntry.getScrollPosition(x, y);</span>
<a href="#l11.1005"></a><span id="l11.1005" class="difflineplus">+    if (x.value != 0 || y.value != 0)</span>
<a href="#l11.1006"></a><span id="l11.1006" class="difflineplus">+      entry.scroll = x.value + &quot;,&quot; + y.value;</span>
<a href="#l11.1007"></a><span id="l11.1007" class="difflineplus">+</span>
<a href="#l11.1008"></a><span id="l11.1008" class="difflineplus">+    try {</span>
<a href="#l11.1009"></a><span id="l11.1009" class="difflineplus">+      var prefPostdata = this._prefBranch.getIntPref(&quot;sessionstore.postdata&quot;);</span>
<a href="#l11.1010"></a><span id="l11.1010" class="difflineplus">+      if (aEntry.postData &amp;&amp; (aFullData ||</span>
<a href="#l11.1011"></a><span id="l11.1011" class="difflineplus">+            prefPostdata &amp;&amp; this._checkPrivacyLevel(aEntry.URI.schemeIs(&quot;https&quot;)))) {</span>
<a href="#l11.1012"></a><span id="l11.1012" class="difflineplus">+        aEntry.postData.QueryInterface(Components.interfaces.nsISeekableStream)</span>
<a href="#l11.1013"></a><span id="l11.1013" class="difflineplus">+                       .seek(Components.interfaces.nsISeekableStream.NS_SEEK_SET, 0);</span>
<a href="#l11.1014"></a><span id="l11.1014" class="difflineplus">+        var stream = Components.classes[&quot;@mozilla.org/binaryinputstream;1&quot;]</span>
<a href="#l11.1015"></a><span id="l11.1015" class="difflineplus">+                               .createInstance(Components.interfaces.nsIBinaryInputStream);</span>
<a href="#l11.1016"></a><span id="l11.1016" class="difflineplus">+        stream.setInputStream(aEntry.postData);</span>
<a href="#l11.1017"></a><span id="l11.1017" class="difflineplus">+        var postBytes = stream.readByteArray(stream.available());</span>
<a href="#l11.1018"></a><span id="l11.1018" class="difflineplus">+        var postdata = String.fromCharCode.apply(null, postBytes);</span>
<a href="#l11.1019"></a><span id="l11.1019" class="difflineplus">+        if (aFullData || prefPostdata == -1 ||</span>
<a href="#l11.1020"></a><span id="l11.1020" class="difflineplus">+            postdata.replace(/^(Content-.*\r\n)+(\r\n)*/, &quot;&quot;).length &lt;=</span>
<a href="#l11.1021"></a><span id="l11.1021" class="difflineplus">+              prefPostdata) {</span>
<a href="#l11.1022"></a><span id="l11.1022" class="difflineplus">+          // We can stop doing base64 encoding once our serialization into JSON</span>
<a href="#l11.1023"></a><span id="l11.1023" class="difflineplus">+          // is guaranteed to handle all chars in strings, including embedded</span>
<a href="#l11.1024"></a><span id="l11.1024" class="difflineplus">+          // nulls.</span>
<a href="#l11.1025"></a><span id="l11.1025" class="difflineplus">+          entry.postdata_b64 = btoa(postdata);</span>
<a href="#l11.1026"></a><span id="l11.1026" class="difflineplus">+        }</span>
<a href="#l11.1027"></a><span id="l11.1027" class="difflineplus">+      }</span>
<a href="#l11.1028"></a><span id="l11.1028" class="difflineplus">+    }</span>
<a href="#l11.1029"></a><span id="l11.1029" class="difflineplus">+    catch (ex) { debug(ex); } // POSTDATA is tricky - especially since some extensions don't get it right</span>
<a href="#l11.1030"></a><span id="l11.1030" class="difflineplus">+</span>
<a href="#l11.1031"></a><span id="l11.1031" class="difflineplus">+    if (aEntry.owner) {</span>
<a href="#l11.1032"></a><span id="l11.1032" class="difflineplus">+      // Not catching anything specific here, just possible errors</span>
<a href="#l11.1033"></a><span id="l11.1033" class="difflineplus">+      // from writeCompoundObject and the like.</span>
<a href="#l11.1034"></a><span id="l11.1034" class="difflineplus">+      try {</span>
<a href="#l11.1035"></a><span id="l11.1035" class="difflineplus">+        var binaryStream = Components.classes[&quot;@mozilla.org/binaryoutputstream;1&quot;]</span>
<a href="#l11.1036"></a><span id="l11.1036" class="difflineplus">+                                     .createInstance(Components.interfaces.nsIObjectOutputStream);</span>
<a href="#l11.1037"></a><span id="l11.1037" class="difflineplus">+        var pipe = Components.classes[&quot;@mozilla.org/pipe;1&quot;].createInstance(Components.interfaces.nsIPipe);</span>
<a href="#l11.1038"></a><span id="l11.1038" class="difflineplus">+        pipe.init(false, false, 0, 0xffffffff, null);</span>
<a href="#l11.1039"></a><span id="l11.1039" class="difflineplus">+        binaryStream.setOutputStream(pipe.outputStream);</span>
<a href="#l11.1040"></a><span id="l11.1040" class="difflineplus">+        binaryStream.writeCompoundObject(aEntry.owner, Components.interfaces.nsISupports, true);</span>
<a href="#l11.1041"></a><span id="l11.1041" class="difflineplus">+        binaryStream.close();</span>
<a href="#l11.1042"></a><span id="l11.1042" class="difflineplus">+</span>
<a href="#l11.1043"></a><span id="l11.1043" class="difflineplus">+        // Now we want to read the data from the pipe's input end and encode it.</span>
<a href="#l11.1044"></a><span id="l11.1044" class="difflineplus">+        var scriptableStream = Components.classes[&quot;@mozilla.org/binaryinputstream;1&quot;]</span>
<a href="#l11.1045"></a><span id="l11.1045" class="difflineplus">+                                         .createInstance(Components.interfaces.nsIBinaryInputStream);</span>
<a href="#l11.1046"></a><span id="l11.1046" class="difflineplus">+        scriptableStream.setInputStream(pipe.inputStream);</span>
<a href="#l11.1047"></a><span id="l11.1047" class="difflineplus">+        var ownerBytes =</span>
<a href="#l11.1048"></a><span id="l11.1048" class="difflineplus">+          scriptableStream.readByteArray(scriptableStream.available());</span>
<a href="#l11.1049"></a><span id="l11.1049" class="difflineplus">+        // We can stop doing base64 encoding once our serialization into JSON</span>
<a href="#l11.1050"></a><span id="l11.1050" class="difflineplus">+        // is guaranteed to handle all chars in strings, including embedded</span>
<a href="#l11.1051"></a><span id="l11.1051" class="difflineplus">+        // nulls.</span>
<a href="#l11.1052"></a><span id="l11.1052" class="difflineplus">+        entry.owner_b64 = btoa(String.fromCharCode.apply(null, ownerBytes));</span>
<a href="#l11.1053"></a><span id="l11.1053" class="difflineplus">+      }</span>
<a href="#l11.1054"></a><span id="l11.1054" class="difflineplus">+      catch (ex) { debug(ex); }</span>
<a href="#l11.1055"></a><span id="l11.1055" class="difflineplus">+    }</span>
<a href="#l11.1056"></a><span id="l11.1056" class="difflineplus">+</span>
<a href="#l11.1057"></a><span id="l11.1057" class="difflineplus">+    if (!(aEntry instanceof Components.interfaces.nsISHContainer)) {</span>
<a href="#l11.1058"></a><span id="l11.1058" class="difflineplus">+      return entry;</span>
<a href="#l11.1059"></a><span id="l11.1059" class="difflineplus">+    }</span>
<a href="#l11.1060"></a><span id="l11.1060" class="difflineplus">+</span>
<a href="#l11.1061"></a><span id="l11.1061" class="difflineplus">+    if (aEntry.childCount &gt; 0) {</span>
<a href="#l11.1062"></a><span id="l11.1062" class="difflineplus">+      entry.children = [];</span>
<a href="#l11.1063"></a><span id="l11.1063" class="difflineplus">+      for (var i = 0; i &lt; aEntry.childCount; i++) {</span>
<a href="#l11.1064"></a><span id="l11.1064" class="difflineplus">+        var child = aEntry.GetChildAt(i);</span>
<a href="#l11.1065"></a><span id="l11.1065" class="difflineplus">+        if (child) {</span>
<a href="#l11.1066"></a><span id="l11.1066" class="difflineplus">+          entry.children.push(this._serializeHistoryEntry(child, aFullData));</span>
<a href="#l11.1067"></a><span id="l11.1067" class="difflineplus">+        }</span>
<a href="#l11.1068"></a><span id="l11.1068" class="difflineplus">+        else { // to maintain the correct frame order, insert a dummy entry</span>
<a href="#l11.1069"></a><span id="l11.1069" class="difflineplus">+          entry.children.push({ url: &quot;about:blank&quot; });</span>
<a href="#l11.1070"></a><span id="l11.1070" class="difflineplus">+        }</span>
<a href="#l11.1071"></a><span id="l11.1071" class="difflineplus">+        // don't try to restore framesets containing wyciwyg URLs (cf. bug 424689 and bug 450595)</span>
<a href="#l11.1072"></a><span id="l11.1072" class="difflineplus">+        if (/^wyciwyg:\/\//.test(entry.children[i].url)) {</span>
<a href="#l11.1073"></a><span id="l11.1073" class="difflineplus">+          delete entry.children;</span>
<a href="#l11.1074"></a><span id="l11.1074" class="difflineplus">+          break;</span>
<a href="#l11.1075"></a><span id="l11.1075" class="difflineplus">+        }</span>
<a href="#l11.1076"></a><span id="l11.1076" class="difflineplus">+      }</span>
<a href="#l11.1077"></a><span id="l11.1077" class="difflineplus">+    }</span>
<a href="#l11.1078"></a><span id="l11.1078" class="difflineplus">+</span>
<a href="#l11.1079"></a><span id="l11.1079" class="difflineplus">+    return entry;</span>
<a href="#l11.1080"></a><span id="l11.1080" class="difflineplus">+  },</span>
<a href="#l11.1081"></a><span id="l11.1081" class="difflineplus">+</span>
<a href="#l11.1082"></a><span id="l11.1082" class="difflineplus">+  /**</span>
<a href="#l11.1083"></a><span id="l11.1083" class="difflineplus">+   * Updates all sessionStorage &quot;super cookies&quot;</span>
<a href="#l11.1084"></a><span id="l11.1084" class="difflineplus">+   * @param aTabData</span>
<a href="#l11.1085"></a><span id="l11.1085" class="difflineplus">+   *        The data object for a specific tab</span>
<a href="#l11.1086"></a><span id="l11.1086" class="difflineplus">+   * @param aHistory</span>
<a href="#l11.1087"></a><span id="l11.1087" class="difflineplus">+   *        That tab's session history</span>
<a href="#l11.1088"></a><span id="l11.1088" class="difflineplus">+   * @param aDocShell</span>
<a href="#l11.1089"></a><span id="l11.1089" class="difflineplus">+   *        That tab's docshell (containing the sessionStorage)</span>
<a href="#l11.1090"></a><span id="l11.1090" class="difflineplus">+   * @param aFullData</span>
<a href="#l11.1091"></a><span id="l11.1091" class="difflineplus">+   *        always return privacy sensitive data (use with care)</span>
<a href="#l11.1092"></a><span id="l11.1092" class="difflineplus">+   */</span>
<a href="#l11.1093"></a><span id="l11.1093" class="difflineplus">+  _serializeSessionStorage:</span>
<a href="#l11.1094"></a><span id="l11.1094" class="difflineplus">+    function sss_serializeSessionStorage(aTabData, aHistory, aDocShell, aFullData) {</span>
<a href="#l11.1095"></a><span id="l11.1095" class="difflineplus">+    let storageData = {};</span>
<a href="#l11.1096"></a><span id="l11.1096" class="difflineplus">+    let hasContent = false;</span>
<a href="#l11.1097"></a><span id="l11.1097" class="difflineplus">+</span>
<a href="#l11.1098"></a><span id="l11.1098" class="difflineplus">+    for (let i = 0; i &lt; aHistory.count; i++) {</span>
<a href="#l11.1099"></a><span id="l11.1099" class="difflineplus">+      let uri = aHistory.getEntryAtIndex(i, false).URI;</span>
<a href="#l11.1100"></a><span id="l11.1100" class="difflineplus">+      // sessionStorage is saved per domain (cf. nsDocShell::GetSessionStorageForURI)</span>
<a href="#l11.1101"></a><span id="l11.1101" class="difflineplus">+      let domain = uri.spec;</span>
<a href="#l11.1102"></a><span id="l11.1102" class="difflineplus">+      try {</span>
<a href="#l11.1103"></a><span id="l11.1103" class="difflineplus">+        if (uri.host)</span>
<a href="#l11.1104"></a><span id="l11.1104" class="difflineplus">+          domain = uri.prePath;</span>
<a href="#l11.1105"></a><span id="l11.1105" class="difflineplus">+      }</span>
<a href="#l11.1106"></a><span id="l11.1106" class="difflineplus">+      catch (ex) { /* this throws for host-less URIs (such as about: or jar:) */ }</span>
<a href="#l11.1107"></a><span id="l11.1107" class="difflineplus">+      if (storageData[domain] || !(aFullData || this._checkPrivacyLevel(uri.schemeIs(&quot;https&quot;))))</span>
<a href="#l11.1108"></a><span id="l11.1108" class="difflineplus">+        continue;</span>
<a href="#l11.1109"></a><span id="l11.1109" class="difflineplus">+</span>
<a href="#l11.1110"></a><span id="l11.1110" class="difflineplus">+      let storage, storageItemCount = 0;</span>
<a href="#l11.1111"></a><span id="l11.1111" class="difflineplus">+      try {</span>
<a href="#l11.1112"></a><span id="l11.1112" class="difflineplus">+        storage = aDocShell.getSessionStorageForURI(uri);</span>
<a href="#l11.1113"></a><span id="l11.1113" class="difflineplus">+        storageItemCount = storage.length;</span>
<a href="#l11.1114"></a><span id="l11.1114" class="difflineplus">+      }</span>
<a href="#l11.1115"></a><span id="l11.1115" class="difflineplus">+      catch (ex) { /* sessionStorage might throw if it's turned off, see bug 458954 */ }</span>
<a href="#l11.1116"></a><span id="l11.1116" class="difflineplus">+      if (storageItemCount == 0)</span>
<a href="#l11.1117"></a><span id="l11.1117" class="difflineplus">+        continue;</span>
<a href="#l11.1118"></a><span id="l11.1118" class="difflineplus">+</span>
<a href="#l11.1119"></a><span id="l11.1119" class="difflineplus">+      let data = storageData[domain] = {};</span>
<a href="#l11.1120"></a><span id="l11.1120" class="difflineplus">+      for (let j = 0; j &lt; storageItemCount; j++) {</span>
<a href="#l11.1121"></a><span id="l11.1121" class="difflineplus">+        try {</span>
<a href="#l11.1122"></a><span id="l11.1122" class="difflineplus">+          let key = storage.key(j);</span>
<a href="#l11.1123"></a><span id="l11.1123" class="difflineplus">+          let item = storage.getItem(key);</span>
<a href="#l11.1124"></a><span id="l11.1124" class="difflineplus">+          data[key] = { value: item.value };</span>
<a href="#l11.1125"></a><span id="l11.1125" class="difflineplus">+          if (uri.schemeIs(&quot;https&quot;) &amp;&amp; item.secure)</span>
<a href="#l11.1126"></a><span id="l11.1126" class="difflineplus">+            data[key].secure = true;</span>
<a href="#l11.1127"></a><span id="l11.1127" class="difflineplus">+        }</span>
<a href="#l11.1128"></a><span id="l11.1128" class="difflineplus">+        catch (ex) { /* XXXzeniko this currently throws for secured items (cf. bug 442048) */ }</span>
<a href="#l11.1129"></a><span id="l11.1129" class="difflineplus">+      }</span>
<a href="#l11.1130"></a><span id="l11.1130" class="difflineplus">+      hasContent = true;</span>
<a href="#l11.1131"></a><span id="l11.1131" class="difflineplus">+    }</span>
<a href="#l11.1132"></a><span id="l11.1132" class="difflineplus">+</span>
<a href="#l11.1133"></a><span id="l11.1133" class="difflineplus">+    if (hasContent)</span>
<a href="#l11.1134"></a><span id="l11.1134" class="difflineplus">+      aTabData.storage = storageData;</span>
<a href="#l11.1135"></a><span id="l11.1135" class="difflineplus">+  },</span>
<a href="#l11.1136"></a><span id="l11.1136" class="difflineplus">+</span>
<a href="#l11.1137"></a><span id="l11.1137" class="difflineplus">+  /**</span>
<a href="#l11.1138"></a><span id="l11.1138" class="difflineplus">+   * go through all tabs and store the current scroll positions</span>
<a href="#l11.1139"></a><span id="l11.1139" class="difflineplus">+   * and innerHTML content of WYSIWYG editors</span>
<a href="#l11.1140"></a><span id="l11.1140" class="difflineplus">+   * @param aWindow</span>
<a href="#l11.1141"></a><span id="l11.1141" class="difflineplus">+   *        Window reference</span>
<a href="#l11.1142"></a><span id="l11.1142" class="difflineplus">+   */</span>
<a href="#l11.1143"></a><span id="l11.1143" class="difflineplus">+  _updateTextAndScrollData: function sss_updateTextAndScrollData(aWindow) {</span>
<a href="#l11.1144"></a><span id="l11.1144" class="difflineplus">+    var browsers = aWindow.getBrowser().browsers;</span>
<a href="#l11.1145"></a><span id="l11.1145" class="difflineplus">+    for (var i = 0; i &lt; browsers.length; i++) {</span>
<a href="#l11.1146"></a><span id="l11.1146" class="difflineplus">+      try {</span>
<a href="#l11.1147"></a><span id="l11.1147" class="difflineplus">+        var tabData = this._windows[aWindow.__SSi].tabs[i];</span>
<a href="#l11.1148"></a><span id="l11.1148" class="difflineplus">+        if (browsers[i].parentNode.__SS_data &amp;&amp; browsers[i].parentNode.__SS_data._tab)</span>
<a href="#l11.1149"></a><span id="l11.1149" class="difflineplus">+          continue; // ignore incompletely initialized tabs</span>
<a href="#l11.1150"></a><span id="l11.1150" class="difflineplus">+        this._updateTextAndScrollDataForTab(aWindow, browsers[i], tabData);</span>
<a href="#l11.1151"></a><span id="l11.1151" class="difflineplus">+      }</span>
<a href="#l11.1152"></a><span id="l11.1152" class="difflineplus">+      catch (ex) { debug(ex); } // get as much data as possible, ignore failures (might succeed the next time)</span>
<a href="#l11.1153"></a><span id="l11.1153" class="difflineplus">+    }</span>
<a href="#l11.1154"></a><span id="l11.1154" class="difflineplus">+  },</span>
<a href="#l11.1155"></a><span id="l11.1155" class="difflineplus">+</span>
<a href="#l11.1156"></a><span id="l11.1156" class="difflineplus">+  /**</span>
<a href="#l11.1157"></a><span id="l11.1157" class="difflineplus">+   * go through all frames and store the current scroll positions</span>
<a href="#l11.1158"></a><span id="l11.1158" class="difflineplus">+   * and innerHTML content of WYSIWYG editors</span>
<a href="#l11.1159"></a><span id="l11.1159" class="difflineplus">+   * @param aWindow</span>
<a href="#l11.1160"></a><span id="l11.1160" class="difflineplus">+   *        Window reference</span>
<a href="#l11.1161"></a><span id="l11.1161" class="difflineplus">+   * @param aBrowser</span>
<a href="#l11.1162"></a><span id="l11.1162" class="difflineplus">+   *        single browser reference</span>
<a href="#l11.1163"></a><span id="l11.1163" class="difflineplus">+   * @param aTabData</span>
<a href="#l11.1164"></a><span id="l11.1164" class="difflineplus">+   *        tabData object to add the information to</span>
<a href="#l11.1165"></a><span id="l11.1165" class="difflineplus">+   * @param aFullData</span>
<a href="#l11.1166"></a><span id="l11.1166" class="difflineplus">+   *        always return privacy sensitive data (use with care)</span>
<a href="#l11.1167"></a><span id="l11.1167" class="difflineplus">+   */</span>
<a href="#l11.1168"></a><span id="l11.1168" class="difflineplus">+  _updateTextAndScrollDataForTab:</span>
<a href="#l11.1169"></a><span id="l11.1169" class="difflineplus">+    function sss_updateTextAndScrollDataForTab(aWindow, aBrowser, aTabData, aFullData) {</span>
<a href="#l11.1170"></a><span id="l11.1170" class="difflineplus">+    var tabIndex = (aTabData.index || aTabData.entries.length) - 1;</span>
<a href="#l11.1171"></a><span id="l11.1171" class="difflineplus">+    // entry data needn't exist for tabs just initialized with an incomplete session state</span>
<a href="#l11.1172"></a><span id="l11.1172" class="difflineplus">+    if (!aTabData.entries[tabIndex])</span>
<a href="#l11.1173"></a><span id="l11.1173" class="difflineplus">+      return;</span>
<a href="#l11.1174"></a><span id="l11.1174" class="difflineplus">+</span>
<a href="#l11.1175"></a><span id="l11.1175" class="difflineplus">+    let selectedPageStyle = aBrowser.markupDocumentViewer.authorStyleDisabled ? &quot;_nostyle&quot; :</span>
<a href="#l11.1176"></a><span id="l11.1176" class="difflineplus">+                            this._getSelectedPageStyle(aBrowser.contentWindow);</span>
<a href="#l11.1177"></a><span id="l11.1177" class="difflineplus">+    if (selectedPageStyle)</span>
<a href="#l11.1178"></a><span id="l11.1178" class="difflineplus">+      aTabData.pageStyle = selectedPageStyle;</span>
<a href="#l11.1179"></a><span id="l11.1179" class="difflineplus">+    else if (aTabData.pageStyle)</span>
<a href="#l11.1180"></a><span id="l11.1180" class="difflineplus">+      delete aTabData.pageStyle;</span>
<a href="#l11.1181"></a><span id="l11.1181" class="difflineplus">+</span>
<a href="#l11.1182"></a><span id="l11.1182" class="difflineplus">+    this._updateTextAndScrollDataForFrame(aWindow, aBrowser.contentWindow,</span>
<a href="#l11.1183"></a><span id="l11.1183" class="difflineplus">+                                          aTabData.entries[tabIndex],</span>
<a href="#l11.1184"></a><span id="l11.1184" class="difflineplus">+                                          !aTabData._formDataSaved, aFullData);</span>
<a href="#l11.1185"></a><span id="l11.1185" class="difflineplus">+    aTabData._formDataSaved = true;</span>
<a href="#l11.1186"></a><span id="l11.1186" class="difflineplus">+    if (aBrowser.currentURI.spec == &quot;about:config&quot;)</span>
<a href="#l11.1187"></a><span id="l11.1187" class="difflineplus">+      aTabData.entries[tabIndex].formdata = {</span>
<a href="#l11.1188"></a><span id="l11.1188" class="difflineplus">+        &quot;#textbox&quot;: aBrowser.contentDocument.getElementById(&quot;textbox&quot;).wrappedJSObject.value</span>
<a href="#l11.1189"></a><span id="l11.1189" class="difflineplus">+      };</span>
<a href="#l11.1190"></a><span id="l11.1190" class="difflineplus">+  },</span>
<a href="#l11.1191"></a><span id="l11.1191" class="difflineplus">+</span>
<a href="#l11.1192"></a><span id="l11.1192" class="difflineplus">+  /**</span>
<a href="#l11.1193"></a><span id="l11.1193" class="difflineplus">+   * go through all subframes and store all form data, the current</span>
<a href="#l11.1194"></a><span id="l11.1194" class="difflineplus">+   * scroll positions and innerHTML content of WYSIWYG editors</span>
<a href="#l11.1195"></a><span id="l11.1195" class="difflineplus">+   * @param aWindow</span>
<a href="#l11.1196"></a><span id="l11.1196" class="difflineplus">+   *        Window reference</span>
<a href="#l11.1197"></a><span id="l11.1197" class="difflineplus">+   * @param aContent</span>
<a href="#l11.1198"></a><span id="l11.1198" class="difflineplus">+   *        frame reference</span>
<a href="#l11.1199"></a><span id="l11.1199" class="difflineplus">+   * @param aData</span>
<a href="#l11.1200"></a><span id="l11.1200" class="difflineplus">+   *        part of a tabData object to add the information to</span>
<a href="#l11.1201"></a><span id="l11.1201" class="difflineplus">+   * @param aUpdateFormData</span>
<a href="#l11.1202"></a><span id="l11.1202" class="difflineplus">+   *        update all form data for this tab</span>
<a href="#l11.1203"></a><span id="l11.1203" class="difflineplus">+   * @param aFullData</span>
<a href="#l11.1204"></a><span id="l11.1204" class="difflineplus">+   *        always return privacy sensitive data (use with care)</span>
<a href="#l11.1205"></a><span id="l11.1205" class="difflineplus">+   */</span>
<a href="#l11.1206"></a><span id="l11.1206" class="difflineplus">+  _updateTextAndScrollDataForFrame:</span>
<a href="#l11.1207"></a><span id="l11.1207" class="difflineplus">+    function sss_updateTextAndScrollDataForFrame(aWindow, aContent, aData,</span>
<a href="#l11.1208"></a><span id="l11.1208" class="difflineplus">+                                                 aUpdateFormData, aFullData) {</span>
<a href="#l11.1209"></a><span id="l11.1209" class="difflineplus">+    for (var i = 0; i &lt; aContent.frames.length; i++) {</span>
<a href="#l11.1210"></a><span id="l11.1210" class="difflineplus">+      if (aData.children &amp;&amp; aData.children[i])</span>
<a href="#l11.1211"></a><span id="l11.1211" class="difflineplus">+        this._updateTextAndScrollDataForFrame(aWindow, aContent.frames[i],</span>
<a href="#l11.1212"></a><span id="l11.1212" class="difflineplus">+                                              aData.children[i], aUpdateFormData, aFullData);</span>
<a href="#l11.1213"></a><span id="l11.1213" class="difflineplus">+    }</span>
<a href="#l11.1214"></a><span id="l11.1214" class="difflineplus">+    var isHTTPS = this._getURIFromString((aContent.parent || aContent).</span>
<a href="#l11.1215"></a><span id="l11.1215" class="difflineplus">+                                         document.location.href).schemeIs(&quot;https&quot;);</span>
<a href="#l11.1216"></a><span id="l11.1216" class="difflineplus">+    if (aFullData || this._checkPrivacyLevel(isHTTPS)) {</span>
<a href="#l11.1217"></a><span id="l11.1217" class="difflineplus">+      if (aFullData || aUpdateFormData) {</span>
<a href="#l11.1218"></a><span id="l11.1218" class="difflineplus">+        let formData = this._collectFormDataForFrame(aContent.document);</span>
<a href="#l11.1219"></a><span id="l11.1219" class="difflineplus">+        if (formData)</span>
<a href="#l11.1220"></a><span id="l11.1220" class="difflineplus">+          aData.formdata = formData;</span>
<a href="#l11.1221"></a><span id="l11.1221" class="difflineplus">+        else if (aData.formdata)</span>
<a href="#l11.1222"></a><span id="l11.1222" class="difflineplus">+          delete aData.formdata;</span>
<a href="#l11.1223"></a><span id="l11.1223" class="difflineplus">+      }</span>
<a href="#l11.1224"></a><span id="l11.1224" class="difflineplus">+</span>
<a href="#l11.1225"></a><span id="l11.1225" class="difflineplus">+      // designMode is undefined e.g. for XUL documents (as about:config)</span>
<a href="#l11.1226"></a><span id="l11.1226" class="difflineplus">+      if ((aContent.document.designMode || &quot;&quot;) == &quot;on&quot;) {</span>
<a href="#l11.1227"></a><span id="l11.1227" class="difflineplus">+        if (aData.innerHTML === undefined &amp;&amp; !aFullData) {</span>
<a href="#l11.1228"></a><span id="l11.1228" class="difflineplus">+          // we get no &quot;input&quot; events from iframes - listen for keypress here</span>
<a href="#l11.1229"></a><span id="l11.1229" class="difflineplus">+          let _this = this;</span>
<a href="#l11.1230"></a><span id="l11.1230" class="difflineplus">+          aContent.addEventListener(&quot;keypress&quot;, function(aEvent) {</span>
<a href="#l11.1231"></a><span id="l11.1231" class="difflineplus">+            _this.saveStateDelayed(aWindow, 3000);</span>
<a href="#l11.1232"></a><span id="l11.1232" class="difflineplus">+          }, true);</span>
<a href="#l11.1233"></a><span id="l11.1233" class="difflineplus">+        }</span>
<a href="#l11.1234"></a><span id="l11.1234" class="difflineplus">+        aData.innerHTML = aContent.document.body.innerHTML;</span>
<a href="#l11.1235"></a><span id="l11.1235" class="difflineplus">+      }</span>
<a href="#l11.1236"></a><span id="l11.1236" class="difflineplus">+    }</span>
<a href="#l11.1237"></a><span id="l11.1237" class="difflineplus">+    aData.scroll = aContent.scrollX + &quot;,&quot; + aContent.scrollY;</span>
<a href="#l11.1238"></a><span id="l11.1238" class="difflineplus">+  },</span>
<a href="#l11.1239"></a><span id="l11.1239" class="difflineplus">+</span>
<a href="#l11.1240"></a><span id="l11.1240" class="difflineplus">+  /**</span>
<a href="#l11.1241"></a><span id="l11.1241" class="difflineplus">+   * determine the title of the currently enabled style sheet (if any)</span>
<a href="#l11.1242"></a><span id="l11.1242" class="difflineplus">+   * and recurse through the frameset if necessary</span>
<a href="#l11.1243"></a><span id="l11.1243" class="difflineplus">+   * @param   aContent is a frame reference</span>
<a href="#l11.1244"></a><span id="l11.1244" class="difflineplus">+   * @returns the title style sheet determined to be enabled (empty string if none)</span>
<a href="#l11.1245"></a><span id="l11.1245" class="difflineplus">+   */</span>
<a href="#l11.1246"></a><span id="l11.1246" class="difflineplus">+  _getSelectedPageStyle: function sss_getSelectedPageStyle(aContent) {</span>
<a href="#l11.1247"></a><span id="l11.1247" class="difflineplus">+    const forScreen = /(?:^|,)\s*(?:all|screen)\s*(?:,|$)/i;</span>
<a href="#l11.1248"></a><span id="l11.1248" class="difflineplus">+    for (let i = 0; i &lt; aContent.document.styleSheets.length; i++) {</span>
<a href="#l11.1249"></a><span id="l11.1249" class="difflineplus">+      let ss = aContent.document.styleSheets[i];</span>
<a href="#l11.1250"></a><span id="l11.1250" class="difflineplus">+      let media = ss.media.mediaText;</span>
<a href="#l11.1251"></a><span id="l11.1251" class="difflineplus">+      if (!ss.disabled &amp;&amp; ss.title &amp;&amp; (!media || forScreen.test(media)))</span>
<a href="#l11.1252"></a><span id="l11.1252" class="difflineplus">+        return ss.title</span>
<a href="#l11.1253"></a><span id="l11.1253" class="difflineplus">+    }</span>
<a href="#l11.1254"></a><span id="l11.1254" class="difflineplus">+    for (let i = 0; i &lt; aContent.frames.length; i++) {</span>
<a href="#l11.1255"></a><span id="l11.1255" class="difflineplus">+      let selectedPageStyle = this._getSelectedPageStyle(aContent.frames[i]);</span>
<a href="#l11.1256"></a><span id="l11.1256" class="difflineplus">+      if (selectedPageStyle)</span>
<a href="#l11.1257"></a><span id="l11.1257" class="difflineplus">+        return selectedPageStyle;</span>
<a href="#l11.1258"></a><span id="l11.1258" class="difflineplus">+    }</span>
<a href="#l11.1259"></a><span id="l11.1259" class="difflineplus">+    return &quot;&quot;;</span>
<a href="#l11.1260"></a><span id="l11.1260" class="difflineplus">+  },</span>
<a href="#l11.1261"></a><span id="l11.1261" class="difflineplus">+</span>
<a href="#l11.1262"></a><span id="l11.1262" class="difflineplus">+  /**</span>
<a href="#l11.1263"></a><span id="l11.1263" class="difflineplus">+   * collect the state of all form elements</span>
<a href="#l11.1264"></a><span id="l11.1264" class="difflineplus">+   * @param aDocument</span>
<a href="#l11.1265"></a><span id="l11.1265" class="difflineplus">+   *        document reference</span>
<a href="#l11.1266"></a><span id="l11.1266" class="difflineplus">+   */</span>
<a href="#l11.1267"></a><span id="l11.1267" class="difflineplus">+  _collectFormDataForFrame: function sss_collectFormDataForFrame(aDocument) {</span>
<a href="#l11.1268"></a><span id="l11.1268" class="difflineplus">+    let formNodes = aDocument.evaluate(XPathHelper.restorableFormNodes, aDocument,</span>
<a href="#l11.1269"></a><span id="l11.1269" class="difflineplus">+                                       XPathHelper.resolveNS,</span>
<a href="#l11.1270"></a><span id="l11.1270" class="difflineplus">+                                       Components.interfaces.nsIDOMXPathResult.UNORDERED_NODE_ITERATOR_TYPE, null);</span>
<a href="#l11.1271"></a><span id="l11.1271" class="difflineplus">+    let node = formNodes.iterateNext();</span>
<a href="#l11.1272"></a><span id="l11.1272" class="difflineplus">+    if (!node)</span>
<a href="#l11.1273"></a><span id="l11.1273" class="difflineplus">+      return null;</span>
<a href="#l11.1274"></a><span id="l11.1274" class="difflineplus">+</span>
<a href="#l11.1275"></a><span id="l11.1275" class="difflineplus">+    let data = {};</span>
<a href="#l11.1276"></a><span id="l11.1276" class="difflineplus">+    do {</span>
<a href="#l11.1277"></a><span id="l11.1277" class="difflineplus">+      let id = node.id ? &quot;#&quot; + node.id : XPathHelper.generate(node);</span>
<a href="#l11.1278"></a><span id="l11.1278" class="difflineplus">+      if (node instanceof Components.interfaces.nsIDOMHTMLInputElement)</span>
<a href="#l11.1279"></a><span id="l11.1279" class="difflineplus">+        data[id] = node.type == &quot;checkbox&quot; || node.type == &quot;radio&quot; ? node.checked : node.value;</span>
<a href="#l11.1280"></a><span id="l11.1280" class="difflineplus">+      else if (node instanceof Components.interfaces.nsIDOMHTMLTextAreaElement)</span>
<a href="#l11.1281"></a><span id="l11.1281" class="difflineplus">+        data[id] = node.value;</span>
<a href="#l11.1282"></a><span id="l11.1282" class="difflineplus">+      else if (!node.multiple)</span>
<a href="#l11.1283"></a><span id="l11.1283" class="difflineplus">+        data[id] = node.selectedIndex;</span>
<a href="#l11.1284"></a><span id="l11.1284" class="difflineplus">+      else {</span>
<a href="#l11.1285"></a><span id="l11.1285" class="difflineplus">+        let options = Array.map(node.options, function(aOpt, aIx) aOpt.selected ? aIx : -1);</span>
<a href="#l11.1286"></a><span id="l11.1286" class="difflineplus">+        data[id] = options.filter(function(aIx) aIx &gt;= 0);</span>
<a href="#l11.1287"></a><span id="l11.1287" class="difflineplus">+      }</span>
<a href="#l11.1288"></a><span id="l11.1288" class="difflineplus">+    } while ((node = formNodes.iterateNext()));</span>
<a href="#l11.1289"></a><span id="l11.1289" class="difflineplus">+</span>
<a href="#l11.1290"></a><span id="l11.1290" class="difflineplus">+    return data;</span>
<a href="#l11.1291"></a><span id="l11.1291" class="difflineplus">+  },</span>
<a href="#l11.1292"></a><span id="l11.1292" class="difflineplus">+</span>
<a href="#l11.1293"></a><span id="l11.1293" class="difflineplus">+  /**</span>
<a href="#l11.1294"></a><span id="l11.1294" class="difflineplus">+   * store all hosts for a URL</span>
<a href="#l11.1295"></a><span id="l11.1295" class="difflineplus">+   * @param aWindow</span>
<a href="#l11.1296"></a><span id="l11.1296" class="difflineplus">+   *        Window reference</span>
<a href="#l11.1297"></a><span id="l11.1297" class="difflineplus">+   */</span>
<a href="#l11.1298"></a><span id="l11.1298" class="difflineplus">+  _updateCookieHosts: function sss_updateCookieHosts(aWindow) {</span>
<a href="#l11.1299"></a><span id="l11.1299" class="difflineplus">+    var hosts = this._windows[aWindow.__SSi]._hosts = {};</span>
<a href="#l11.1300"></a><span id="l11.1300" class="difflineplus">+</span>
<a href="#l11.1301"></a><span id="l11.1301" class="difflineplus">+    // get all possible subdomain levels for a given URL</span>
<a href="#l11.1302"></a><span id="l11.1302" class="difflineplus">+    var _this = this;</span>
<a href="#l11.1303"></a><span id="l11.1303" class="difflineplus">+    function extractHosts(aEntry) {</span>
<a href="#l11.1304"></a><span id="l11.1304" class="difflineplus">+      if (/^https?:\/\/(?:[^@\/\s]+@)?([\w.-]+)/.test(aEntry.url) &amp;&amp;</span>
<a href="#l11.1305"></a><span id="l11.1305" class="difflineplus">+        !hosts[RegExp.$1] &amp;&amp; _this._checkPrivacyLevel(_this._getURIFromString(aEntry.url).schemeIs(&quot;https&quot;))) {</span>
<a href="#l11.1306"></a><span id="l11.1306" class="difflineplus">+        var host = RegExp.$1;</span>
<a href="#l11.1307"></a><span id="l11.1307" class="difflineplus">+        var ix;</span>
<a href="#l11.1308"></a><span id="l11.1308" class="difflineplus">+        for (ix = host.indexOf(&quot;.&quot;) + 1; ix; ix = host.indexOf(&quot;.&quot;, ix) + 1) {</span>
<a href="#l11.1309"></a><span id="l11.1309" class="difflineplus">+          hosts[host.substr(ix)] = true;</span>
<a href="#l11.1310"></a><span id="l11.1310" class="difflineplus">+        }</span>
<a href="#l11.1311"></a><span id="l11.1311" class="difflineplus">+        hosts[host] = true;</span>
<a href="#l11.1312"></a><span id="l11.1312" class="difflineplus">+      }</span>
<a href="#l11.1313"></a><span id="l11.1313" class="difflineplus">+      else if (/^file:\/\/([^\/]*)/.test(aEntry.url)) {</span>
<a href="#l11.1314"></a><span id="l11.1314" class="difflineplus">+        hosts[RegExp.$1] = true;</span>
<a href="#l11.1315"></a><span id="l11.1315" class="difflineplus">+      }</span>
<a href="#l11.1316"></a><span id="l11.1316" class="difflineplus">+      if (aEntry.children) {</span>
<a href="#l11.1317"></a><span id="l11.1317" class="difflineplus">+        aEntry.children.forEach(extractHosts);</span>
<a href="#l11.1318"></a><span id="l11.1318" class="difflineplus">+      }</span>
<a href="#l11.1319"></a><span id="l11.1319" class="difflineplus">+    }</span>
<a href="#l11.1320"></a><span id="l11.1320" class="difflineplus">+</span>
<a href="#l11.1321"></a><span id="l11.1321" class="difflineplus">+    this._windows[aWindow.__SSi].tabs.forEach(function(aTabData) { aTabData.entries.forEach(extractHosts); });</span>
<a href="#l11.1322"></a><span id="l11.1322" class="difflineplus">+  },</span>
<a href="#l11.1323"></a><span id="l11.1323" class="difflineplus">+</span>
<a href="#l11.1324"></a><span id="l11.1324" class="difflineplus">+  /**</span>
<a href="#l11.1325"></a><span id="l11.1325" class="difflineplus">+   * Serialize cookie data</span>
<a href="#l11.1326"></a><span id="l11.1326" class="difflineplus">+   * @param aWindows</span>
<a href="#l11.1327"></a><span id="l11.1327" class="difflineplus">+   *        array of Window references</span>
<a href="#l11.1328"></a><span id="l11.1328" class="difflineplus">+   */</span>
<a href="#l11.1329"></a><span id="l11.1329" class="difflineplus">+  _updateCookies: function sss_updateCookies(aWindows) {</span>
<a href="#l11.1330"></a><span id="l11.1330" class="difflineplus">+    var cookiesEnum = Components.classes[&quot;@mozilla.org/cookiemanager;1&quot;].</span>
<a href="#l11.1331"></a><span id="l11.1331" class="difflineplus">+                      getService(Components.interfaces.nsICookieManager).enumerator;</span>
<a href="#l11.1332"></a><span id="l11.1332" class="difflineplus">+    // collect the cookies per window</span>
<a href="#l11.1333"></a><span id="l11.1333" class="difflineplus">+    for (var i = 0; i &lt; aWindows.length; i++)</span>
<a href="#l11.1334"></a><span id="l11.1334" class="difflineplus">+      aWindows[i].cookies = [];</span>
<a href="#l11.1335"></a><span id="l11.1335" class="difflineplus">+</span>
<a href="#l11.1336"></a><span id="l11.1336" class="difflineplus">+    // MAX_EXPIRY should be 2^63-1, but JavaScript can't handle that precision</span>
<a href="#l11.1337"></a><span id="l11.1337" class="difflineplus">+    var MAX_EXPIRY = Math.pow(2, 62);</span>
<a href="#l11.1338"></a><span id="l11.1338" class="difflineplus">+    while (cookiesEnum.hasMoreElements()) {</span>
<a href="#l11.1339"></a><span id="l11.1339" class="difflineplus">+      var cookie = cookiesEnum.getNext().QueryInterface(Components.interfaces.nsICookie2);</span>
<a href="#l11.1340"></a><span id="l11.1340" class="difflineplus">+      if (cookie.isSession &amp;&amp; this._checkPrivacyLevel(cookie.isSecure)) {</span>
<a href="#l11.1341"></a><span id="l11.1341" class="difflineplus">+        var jscookie = null;</span>
<a href="#l11.1342"></a><span id="l11.1342" class="difflineplus">+        aWindows.forEach(function(aWindow) {</span>
<a href="#l11.1343"></a><span id="l11.1343" class="difflineplus">+          if (aWindow._hosts &amp;&amp; aWindow._hosts[cookie.rawHost]) {</span>
<a href="#l11.1344"></a><span id="l11.1344" class="difflineplus">+            // serialize the cookie when it's first needed</span>
<a href="#l11.1345"></a><span id="l11.1345" class="difflineplus">+            if (!jscookie) {</span>
<a href="#l11.1346"></a><span id="l11.1346" class="difflineplus">+              jscookie = { host: cookie.host, value: cookie.value };</span>
<a href="#l11.1347"></a><span id="l11.1347" class="difflineplus">+              // only add attributes with non-default values (saving a few bits)</span>
<a href="#l11.1348"></a><span id="l11.1348" class="difflineplus">+              if (cookie.path) jscookie.path = cookie.path;</span>
<a href="#l11.1349"></a><span id="l11.1349" class="difflineplus">+              if (cookie.name) jscookie.name = cookie.name;</span>
<a href="#l11.1350"></a><span id="l11.1350" class="difflineplus">+              if (cookie.isSecure) jscookie.secure = true;</span>
<a href="#l11.1351"></a><span id="l11.1351" class="difflineplus">+              if (cookie.isHttpOnly) jscookie.httponly = true;</span>
<a href="#l11.1352"></a><span id="l11.1352" class="difflineplus">+              if (cookie.expiry &lt; MAX_EXPIRY) jscookie.expiry = cookie.expiry;</span>
<a href="#l11.1353"></a><span id="l11.1353" class="difflineplus">+            }</span>
<a href="#l11.1354"></a><span id="l11.1354" class="difflineplus">+            aWindow.cookies.push(jscookie);</span>
<a href="#l11.1355"></a><span id="l11.1355" class="difflineplus">+          }</span>
<a href="#l11.1356"></a><span id="l11.1356" class="difflineplus">+        });</span>
<a href="#l11.1357"></a><span id="l11.1357" class="difflineplus">+      }</span>
<a href="#l11.1358"></a><span id="l11.1358" class="difflineplus">+    }</span>
<a href="#l11.1359"></a><span id="l11.1359" class="difflineplus">+</span>
<a href="#l11.1360"></a><span id="l11.1360" class="difflineplus">+    // don't include empty cookie sections</span>
<a href="#l11.1361"></a><span id="l11.1361" class="difflineplus">+    for (i = 0; i &lt; aWindows.length; i++)</span>
<a href="#l11.1362"></a><span id="l11.1362" class="difflineplus">+      if (aWindows[i].cookies.length == 0)</span>
<a href="#l11.1363"></a><span id="l11.1363" class="difflineplus">+        delete aWindows[i].cookies;</span>
<a href="#l11.1364"></a><span id="l11.1364" class="difflineplus">+  },</span>
<a href="#l11.1365"></a><span id="l11.1365" class="difflineplus">+</span>
<a href="#l11.1366"></a><span id="l11.1366" class="difflineplus">+  /**</span>
<a href="#l11.1367"></a><span id="l11.1367" class="difflineplus">+   * Store window dimensions, visibility, sidebar</span>
<a href="#l11.1368"></a><span id="l11.1368" class="difflineplus">+   * @param aWindow</span>
<a href="#l11.1369"></a><span id="l11.1369" class="difflineplus">+   *        Window reference</span>
<a href="#l11.1370"></a><span id="l11.1370" class="difflineplus">+   */</span>
<a href="#l11.1371"></a><span id="l11.1371" class="difflineplus">+  _updateWindowFeatures: function sss_updateWindowFeatures(aWindow) {</span>
<a href="#l11.1372"></a><span id="l11.1372" class="difflineplus">+    var winData = this._windows[aWindow.__SSi];</span>
<a href="#l11.1373"></a><span id="l11.1373" class="difflineplus">+</span>
<a href="#l11.1374"></a><span id="l11.1374" class="difflineplus">+    WINDOW_ATTRIBUTES.forEach(function(aAttr) {</span>
<a href="#l11.1375"></a><span id="l11.1375" class="difflineplus">+      winData[aAttr] = this._getWindowDimension(aWindow, aAttr);</span>
<a href="#l11.1376"></a><span id="l11.1376" class="difflineplus">+    }, this);</span>
<a href="#l11.1377"></a><span id="l11.1377" class="difflineplus">+</span>
<a href="#l11.1378"></a><span id="l11.1378" class="difflineplus">+    var hidden = WINDOW_HIDEABLE_FEATURES.filter(function(aItem) {</span>
<a href="#l11.1379"></a><span id="l11.1379" class="difflineplus">+      return aWindow[aItem] &amp;&amp; !aWindow[aItem].visible;</span>
<a href="#l11.1380"></a><span id="l11.1380" class="difflineplus">+    });</span>
<a href="#l11.1381"></a><span id="l11.1381" class="difflineplus">+    if (hidden.length != 0)</span>
<a href="#l11.1382"></a><span id="l11.1382" class="difflineplus">+      winData.hidden = hidden.join(&quot;,&quot;);</span>
<a href="#l11.1383"></a><span id="l11.1383" class="difflineplus">+    else if (winData.hidden)</span>
<a href="#l11.1384"></a><span id="l11.1384" class="difflineplus">+      delete winData.hidden;</span>
<a href="#l11.1385"></a><span id="l11.1385" class="difflineplus">+</span>
<a href="#l11.1386"></a><span id="l11.1386" class="difflineplus">+    var sidebar = aWindow.document.getElementById(&quot;sidebar-box&quot;).getAttribute(&quot;sidebarcommand&quot;);</span>
<a href="#l11.1387"></a><span id="l11.1387" class="difflineplus">+    if (sidebar)</span>
<a href="#l11.1388"></a><span id="l11.1388" class="difflineplus">+      winData.sidebar = sidebar;</span>
<a href="#l11.1389"></a><span id="l11.1389" class="difflineplus">+    else if (winData.sidebar)</span>
<a href="#l11.1390"></a><span id="l11.1390" class="difflineplus">+      delete winData.sidebar;</span>
<a href="#l11.1391"></a><span id="l11.1391" class="difflineplus">+  },</span>
<a href="#l11.1392"></a><span id="l11.1392" class="difflineplus">+</span>
<a href="#l11.1393"></a><span id="l11.1393" class="difflineplus">+  /**</span>
<a href="#l11.1394"></a><span id="l11.1394" class="difflineplus">+   * serialize session data as Ini-formatted string</span>
<a href="#l11.1395"></a><span id="l11.1395" class="difflineplus">+   * @param aUpdateAll</span>
<a href="#l11.1396"></a><span id="l11.1396" class="difflineplus">+   *        Bool update all windows</span>
<a href="#l11.1397"></a><span id="l11.1397" class="difflineplus">+   * @returns string</span>
<a href="#l11.1398"></a><span id="l11.1398" class="difflineplus">+   */</span>
<a href="#l11.1399"></a><span id="l11.1399" class="difflineplus">+  _getCurrentState: function sss_getCurrentState(aUpdateAll) {</span>
<a href="#l11.1400"></a><span id="l11.1400" class="difflineplus">+    var activeWindow = this._getMostRecentBrowserWindow();</span>
<a href="#l11.1401"></a><span id="l11.1401" class="difflineplus">+</span>
<a href="#l11.1402"></a><span id="l11.1402" class="difflineplus">+    if (this._loadState == STATE_RUNNING) {</span>
<a href="#l11.1403"></a><span id="l11.1403" class="difflineplus">+      // update the data for all windows with activities since the last save operation</span>
<a href="#l11.1404"></a><span id="l11.1404" class="difflineplus">+      this._forEachBrowserWindow(function(aWindow) {</span>
<a href="#l11.1405"></a><span id="l11.1405" class="difflineplus">+        if (aUpdateAll || this._dirtyWindows[aWindow.__SSi] || aWindow == activeWindow) {</span>
<a href="#l11.1406"></a><span id="l11.1406" class="difflineplus">+          this._collectWindowData(aWindow);</span>
<a href="#l11.1407"></a><span id="l11.1407" class="difflineplus">+        }</span>
<a href="#l11.1408"></a><span id="l11.1408" class="difflineplus">+        else { // always update the window features (whose change alone never triggers a save operation)</span>
<a href="#l11.1409"></a><span id="l11.1409" class="difflineplus">+          this._updateWindowFeatures(aWindow);</span>
<a href="#l11.1410"></a><span id="l11.1410" class="difflineplus">+        }</span>
<a href="#l11.1411"></a><span id="l11.1411" class="difflineplus">+      }, this);</span>
<a href="#l11.1412"></a><span id="l11.1412" class="difflineplus">+      this._dirtyWindows = [];</span>
<a href="#l11.1413"></a><span id="l11.1413" class="difflineplus">+    }</span>
<a href="#l11.1414"></a><span id="l11.1414" class="difflineplus">+</span>
<a href="#l11.1415"></a><span id="l11.1415" class="difflineplus">+    // collect the data for all windows</span>
<a href="#l11.1416"></a><span id="l11.1416" class="difflineplus">+    var total = [], windows = [];</span>
<a href="#l11.1417"></a><span id="l11.1417" class="difflineplus">+    var nonPopupCount = 0;</span>
<a href="#l11.1418"></a><span id="l11.1418" class="difflineplus">+    var ix;</span>
<a href="#l11.1419"></a><span id="l11.1419" class="difflineplus">+    for (ix in this._windows) {</span>
<a href="#l11.1420"></a><span id="l11.1420" class="difflineplus">+      total.push(this._windows[ix]);</span>
<a href="#l11.1421"></a><span id="l11.1421" class="difflineplus">+      windows.push(ix);</span>
<a href="#l11.1422"></a><span id="l11.1422" class="difflineplus">+      if (!this._windows[ix].isPopup)</span>
<a href="#l11.1423"></a><span id="l11.1423" class="difflineplus">+        nonPopupCount++;</span>
<a href="#l11.1424"></a><span id="l11.1424" class="difflineplus">+    }</span>
<a href="#l11.1425"></a><span id="l11.1425" class="difflineplus">+    this._updateCookies(total);</span>
<a href="#l11.1426"></a><span id="l11.1426" class="difflineplus">+    // if no non-popup browser window remains open, return the state of the last closed window(s)</span>
<a href="#l11.1427"></a><span id="l11.1427" class="difflineplus">+    if (nonPopupCount == 0 &amp;&amp; this._lastClosedWindows) {</span>
<a href="#l11.1428"></a><span id="l11.1428" class="difflineplus">+      // prepend the last non-popup browser window, so that if the user loads more tabs</span>
<a href="#l11.1429"></a><span id="l11.1429" class="difflineplus">+      // at startup we don't accidentally add them to a popup window</span>
<a href="#l11.1430"></a><span id="l11.1430" class="difflineplus">+      total = this._lastClosedWindows.concat(total);</span>
<a href="#l11.1431"></a><span id="l11.1431" class="difflineplus">+    }</span>
<a href="#l11.1432"></a><span id="l11.1432" class="difflineplus">+    if (activeWindow) {</span>
<a href="#l11.1433"></a><span id="l11.1433" class="difflineplus">+      this.activeWindowSSiCache = activeWindow.__SSi || &quot;&quot;;</span>
<a href="#l11.1434"></a><span id="l11.1434" class="difflineplus">+    }</span>
<a href="#l11.1435"></a><span id="l11.1435" class="difflineplus">+    ix = this.activeWindowSSiCache ? windows.indexOf(this.activeWindowSSiCache) : -1;</span>
<a href="#l11.1436"></a><span id="l11.1436" class="difflineplus">+    return { windows: total, selectedWindow: ix + 1 };</span>
<a href="#l11.1437"></a><span id="l11.1437" class="difflineplus">+  },</span>
<a href="#l11.1438"></a><span id="l11.1438" class="difflineplus">+</span>
<a href="#l11.1439"></a><span id="l11.1439" class="difflineplus">+  /**</span>
<a href="#l11.1440"></a><span id="l11.1440" class="difflineplus">+   * serialize session data for a window</span>
<a href="#l11.1441"></a><span id="l11.1441" class="difflineplus">+   * @param aWindow</span>
<a href="#l11.1442"></a><span id="l11.1442" class="difflineplus">+   *        Window reference</span>
<a href="#l11.1443"></a><span id="l11.1443" class="difflineplus">+   * @returns string</span>
<a href="#l11.1444"></a><span id="l11.1444" class="difflineplus">+   */</span>
<a href="#l11.1445"></a><span id="l11.1445" class="difflineplus">+  _getWindowState: function sss_getWindowState(aWindow) {</span>
<a href="#l11.1446"></a><span id="l11.1446" class="difflineplus">+    if (this._loadState == STATE_RUNNING) {</span>
<a href="#l11.1447"></a><span id="l11.1447" class="difflineplus">+      this._collectWindowData(aWindow);</span>
<a href="#l11.1448"></a><span id="l11.1448" class="difflineplus">+    }</span>
<a href="#l11.1449"></a><span id="l11.1449" class="difflineplus">+</span>
<a href="#l11.1450"></a><span id="l11.1450" class="difflineplus">+    var total = [this._windows[aWindow.__SSi]];</span>
<a href="#l11.1451"></a><span id="l11.1451" class="difflineplus">+    total._closedTabs = this._windows[aWindow.__SSi].getBrowser().savedBrowsers.map(function(e) { return e.tabData; });</span>
<a href="#l11.1452"></a><span id="l11.1452" class="difflineplus">+    this._updateCookies(total);</span>
<a href="#l11.1453"></a><span id="l11.1453" class="difflineplus">+</span>
<a href="#l11.1454"></a><span id="l11.1454" class="difflineplus">+    return { windows: total };</span>
<a href="#l11.1455"></a><span id="l11.1455" class="difflineplus">+  },</span>
<a href="#l11.1456"></a><span id="l11.1456" class="difflineplus">+</span>
<a href="#l11.1457"></a><span id="l11.1457" class="difflineplus">+  _collectWindowData: function sss_collectWindowData(aWindow) {</span>
<a href="#l11.1458"></a><span id="l11.1458" class="difflineplus">+    // update the internal state data for this window</span>
<a href="#l11.1459"></a><span id="l11.1459" class="difflineplus">+    this._saveWindowHistory(aWindow);</span>
<a href="#l11.1460"></a><span id="l11.1460" class="difflineplus">+    this._updateTextAndScrollData(aWindow);</span>
<a href="#l11.1461"></a><span id="l11.1461" class="difflineplus">+    this._updateCookieHosts(aWindow);</span>
<a href="#l11.1462"></a><span id="l11.1462" class="difflineplus">+    this._updateWindowFeatures(aWindow);</span>
<a href="#l11.1463"></a><span id="l11.1463" class="difflineplus">+</span>
<a href="#l11.1464"></a><span id="l11.1464" class="difflineplus">+    this._windows[aWindow.__SSi]._closedTabs = aWindow.getBrowser().savedBrowsers.map(function(e) { return e.tabData; });</span>
<a href="#l11.1465"></a><span id="l11.1465" class="difflineplus">+</span>
<a href="#l11.1466"></a><span id="l11.1466" class="difflineplus">+    this._dirtyWindows[aWindow.__SSi] = false;</span>
<a href="#l11.1467"></a><span id="l11.1467" class="difflineplus">+  },</span>
<a href="#l11.1468"></a><span id="l11.1468" class="difflineplus">+</span>
<a href="#l11.1469"></a><span id="l11.1469" class="difflineplus">+/* ........ Restoring Functionality .............. */</span>
<a href="#l11.1470"></a><span id="l11.1470" class="difflineplus">+</span>
<a href="#l11.1471"></a><span id="l11.1471" class="difflineplus">+  /**</span>
<a href="#l11.1472"></a><span id="l11.1472" class="difflineplus">+   * restore features to a single window</span>
<a href="#l11.1473"></a><span id="l11.1473" class="difflineplus">+   * @param aWindow</span>
<a href="#l11.1474"></a><span id="l11.1474" class="difflineplus">+   *        Window reference</span>
<a href="#l11.1475"></a><span id="l11.1475" class="difflineplus">+   * @param aState</span>
<a href="#l11.1476"></a><span id="l11.1476" class="difflineplus">+   *        JS object or its eval'able source</span>
<a href="#l11.1477"></a><span id="l11.1477" class="difflineplus">+   * @param aOverwriteTabs</span>
<a href="#l11.1478"></a><span id="l11.1478" class="difflineplus">+   *        bool overwrite existing tabs w/ new ones</span>
<a href="#l11.1479"></a><span id="l11.1479" class="difflineplus">+   * @param aFollowUp</span>
<a href="#l11.1480"></a><span id="l11.1480" class="difflineplus">+   *        bool this isn't the restoration of the first window</span>
<a href="#l11.1481"></a><span id="l11.1481" class="difflineplus">+   */</span>
<a href="#l11.1482"></a><span id="l11.1482" class="difflineplus">+  restoreWindow: function sss_restoreWindow(aWindow, aState, aOverwriteTabs, aFollowUp) {</span>
<a href="#l11.1483"></a><span id="l11.1483" class="difflineplus">+    if (!aFollowUp) {</span>
<a href="#l11.1484"></a><span id="l11.1484" class="difflineplus">+      this.windowToFocus = aWindow;</span>
<a href="#l11.1485"></a><span id="l11.1485" class="difflineplus">+    }</span>
<a href="#l11.1486"></a><span id="l11.1486" class="difflineplus">+    // initialize window if necessary</span>
<a href="#l11.1487"></a><span id="l11.1487" class="difflineplus">+    if (aWindow &amp;&amp; (!aWindow.__SSi || !this._windows[aWindow.__SSi]))</span>
<a href="#l11.1488"></a><span id="l11.1488" class="difflineplus">+      this.onLoad(aWindow);</span>
<a href="#l11.1489"></a><span id="l11.1489" class="difflineplus">+</span>
<a href="#l11.1490"></a><span id="l11.1490" class="difflineplus">+    try {</span>
<a href="#l11.1491"></a><span id="l11.1491" class="difflineplus">+      var root = typeof aState == &quot;string&quot; ? this._safeEval(aState) : aState;</span>
<a href="#l11.1492"></a><span id="l11.1492" class="difflineplus">+      if (!root.windows[0]) {</span>
<a href="#l11.1493"></a><span id="l11.1493" class="difflineplus">+        this._notifyIfAllWindowsRestored();</span>
<a href="#l11.1494"></a><span id="l11.1494" class="difflineplus">+        return; // nothing to restore</span>
<a href="#l11.1495"></a><span id="l11.1495" class="difflineplus">+      }</span>
<a href="#l11.1496"></a><span id="l11.1496" class="difflineplus">+    }</span>
<a href="#l11.1497"></a><span id="l11.1497" class="difflineplus">+    catch (ex) { // invalid state object - don't restore anything</span>
<a href="#l11.1498"></a><span id="l11.1498" class="difflineplus">+      debug(ex);</span>
<a href="#l11.1499"></a><span id="l11.1499" class="difflineplus">+      this._notifyIfAllWindowsRestored();</span>
<a href="#l11.1500"></a><span id="l11.1500" class="difflineplus">+      return;</span>
<a href="#l11.1501"></a><span id="l11.1501" class="difflineplus">+    }</span>
<a href="#l11.1502"></a><span id="l11.1502" class="difflineplus">+</span>
<a href="#l11.1503"></a><span id="l11.1503" class="difflineplus">+    var winData;</span>
<a href="#l11.1504"></a><span id="l11.1504" class="difflineplus">+    if (!aState.selectedWindow) {</span>
<a href="#l11.1505"></a><span id="l11.1505" class="difflineplus">+      aState.selectedWindow = 0;</span>
<a href="#l11.1506"></a><span id="l11.1506" class="difflineplus">+    }</span>
<a href="#l11.1507"></a><span id="l11.1507" class="difflineplus">+    // open new windows for all further window entries of a multi-window session</span>
<a href="#l11.1508"></a><span id="l11.1508" class="difflineplus">+    // (unless they don't contain any tab data)</span>
<a href="#l11.1509"></a><span id="l11.1509" class="difflineplus">+    for (var w = 1; w &lt; root.windows.length; w++) {</span>
<a href="#l11.1510"></a><span id="l11.1510" class="difflineplus">+      winData = root.windows[w];</span>
<a href="#l11.1511"></a><span id="l11.1511" class="difflineplus">+      if (winData &amp;&amp; winData.tabs &amp;&amp; winData.tabs[0]) {</span>
<a href="#l11.1512"></a><span id="l11.1512" class="difflineplus">+        var window = this._openWindowWithState({ windows: [winData] });</span>
<a href="#l11.1513"></a><span id="l11.1513" class="difflineplus">+        if (w == aState.selectedWindow - 1) {</span>
<a href="#l11.1514"></a><span id="l11.1514" class="difflineplus">+          this.windowToFocus = window;</span>
<a href="#l11.1515"></a><span id="l11.1515" class="difflineplus">+        }</span>
<a href="#l11.1516"></a><span id="l11.1516" class="difflineplus">+      }</span>
<a href="#l11.1517"></a><span id="l11.1517" class="difflineplus">+    }</span>
<a href="#l11.1518"></a><span id="l11.1518" class="difflineplus">+    winData = root.windows[0];</span>
<a href="#l11.1519"></a><span id="l11.1519" class="difflineplus">+    if (!winData.tabs) {</span>
<a href="#l11.1520"></a><span id="l11.1520" class="difflineplus">+      winData.tabs = [];</span>
<a href="#l11.1521"></a><span id="l11.1521" class="difflineplus">+    }</span>
<a href="#l11.1522"></a><span id="l11.1522" class="difflineplus">+    // don't restore a single blank tab when we've had an external</span>
<a href="#l11.1523"></a><span id="l11.1523" class="difflineplus">+    // URL passed in for loading at startup (cf. bug 357419)</span>
<a href="#l11.1524"></a><span id="l11.1524" class="difflineplus">+    else if (root._firstTabs &amp;&amp; !aOverwriteTabs &amp;&amp; winData.tabs.length == 1 &amp;&amp;</span>
<a href="#l11.1525"></a><span id="l11.1525" class="difflineplus">+             (!winData.tabs[0].entries || winData.tabs[0].entries.length == 0)) {</span>
<a href="#l11.1526"></a><span id="l11.1526" class="difflineplus">+      winData.tabs = [];</span>
<a href="#l11.1527"></a><span id="l11.1527" class="difflineplus">+    }</span>
<a href="#l11.1528"></a><span id="l11.1528" class="difflineplus">+</span>
<a href="#l11.1529"></a><span id="l11.1529" class="difflineplus">+    var tabbrowser = aWindow.getBrowser();</span>
<a href="#l11.1530"></a><span id="l11.1530" class="difflineplus">+    var openTabCount = aOverwriteTabs ? tabbrowser.browsers.length : -1;</span>
<a href="#l11.1531"></a><span id="l11.1531" class="difflineplus">+    var newTabCount = winData.tabs.length;</span>
<a href="#l11.1532"></a><span id="l11.1532" class="difflineplus">+</span>
<a href="#l11.1533"></a><span id="l11.1533" class="difflineplus">+    for (var t = 0; t &lt; newTabCount; t++) {</span>
<a href="#l11.1534"></a><span id="l11.1534" class="difflineplus">+      winData.tabs[t]._tab = t &lt; openTabCount ? tabbrowser.mTabs[t] : tabbrowser.addTab();</span>
<a href="#l11.1535"></a><span id="l11.1535" class="difflineplus">+      // when resuming at startup: add additionally requested pages to the end</span>
<a href="#l11.1536"></a><span id="l11.1536" class="difflineplus">+      if (!aOverwriteTabs &amp;&amp; root._firstTabs) {</span>
<a href="#l11.1537"></a><span id="l11.1537" class="difflineplus">+        tabbrowser.moveTabTo(winData.tabs[t]._tab, t);</span>
<a href="#l11.1538"></a><span id="l11.1538" class="difflineplus">+      }</span>
<a href="#l11.1539"></a><span id="l11.1539" class="difflineplus">+    }</span>
<a href="#l11.1540"></a><span id="l11.1540" class="difflineplus">+</span>
<a href="#l11.1541"></a><span id="l11.1541" class="difflineplus">+    // when overwriting tabs, remove all superflous ones</span>
<a href="#l11.1542"></a><span id="l11.1542" class="difflineplus">+    for (t = openTabCount - 1; t &gt;= newTabCount; t--) {</span>
<a href="#l11.1543"></a><span id="l11.1543" class="difflineplus">+      tabbrowser.removeTab(tabbrowser.mTabs[t]);</span>
<a href="#l11.1544"></a><span id="l11.1544" class="difflineplus">+    }</span>
<a href="#l11.1545"></a><span id="l11.1545" class="difflineplus">+</span>
<a href="#l11.1546"></a><span id="l11.1546" class="difflineplus">+    if (aOverwriteTabs) {</span>
<a href="#l11.1547"></a><span id="l11.1547" class="difflineplus">+      this.restoreWindowFeatures(aWindow, winData);</span>
<a href="#l11.1548"></a><span id="l11.1548" class="difflineplus">+    }</span>
<a href="#l11.1549"></a><span id="l11.1549" class="difflineplus">+    if (winData.cookies) {</span>
<a href="#l11.1550"></a><span id="l11.1550" class="difflineplus">+      this.restoreCookies(winData.cookies);</span>
<a href="#l11.1551"></a><span id="l11.1551" class="difflineplus">+    }</span>
<a href="#l11.1552"></a><span id="l11.1552" class="difflineplus">+    if (winData.extData) {</span>
<a href="#l11.1553"></a><span id="l11.1553" class="difflineplus">+      if (!this._windows[aWindow.__SSi].extData) {</span>
<a href="#l11.1554"></a><span id="l11.1554" class="difflineplus">+        this._windows[aWindow.__SSi].extData = {}</span>
<a href="#l11.1555"></a><span id="l11.1555" class="difflineplus">+      }</span>
<a href="#l11.1556"></a><span id="l11.1556" class="difflineplus">+      for (var key in winData.extData) {</span>
<a href="#l11.1557"></a><span id="l11.1557" class="difflineplus">+        this._windows[aWindow.__SSi].extData[key] = winData.extData[key];</span>
<a href="#l11.1558"></a><span id="l11.1558" class="difflineplus">+      }</span>
<a href="#l11.1559"></a><span id="l11.1559" class="difflineplus">+    }</span>
<a href="#l11.1560"></a><span id="l11.1560" class="difflineplus">+    //this is firefox part of code, keeping it for reference only. Will be removed in final patch</span>
<a href="#l11.1561"></a><span id="l11.1561" class="difflineplus">+    //misak if (winData._closedTabs &amp;&amp; (root._firstTabs || aOverwriteTabs)) {</span>
<a href="#l11.1562"></a><span id="l11.1562" class="difflineplus">+    //  this._windows[aWindow.__SSi]._closedTabs = winData._closedTabs;</span>
<a href="#l11.1563"></a><span id="l11.1563" class="difflineplus">+    //}</span>
<a href="#l11.1564"></a><span id="l11.1564" class="difflineplus">+</span>
<a href="#l11.1565"></a><span id="l11.1565" class="difflineplus">+    // this part of code should reconstruct savedBrowsers from session</span>
<a href="#l11.1566"></a><span id="l11.1566" class="difflineplus">+    // file. Commenting out now, will file separate bug for this.</span>
<a href="#l11.1567"></a><span id="l11.1567" class="difflineplus">+    //if (winData._closedTabs &amp;&amp; (root._firstTabs || aOverwriteTabs)) {</span>
<a href="#l11.1568"></a><span id="l11.1568" class="difflineplus">+      //aWindow.getBrowser().savedBrowsers.tabData = winData._closedTabs;</span>
<a href="#l11.1569"></a><span id="l11.1569" class="difflineplus">+      //aWindow.getBrowser().savedBrowsers.map(function(e) { return e.tabData; })</span>
<a href="#l11.1570"></a><span id="l11.1570" class="difflineplus">+    //  for ( var iix = winData._closedTabs.length - 1; iix &gt;= 0 ; iix--) {</span>
<a href="#l11.1571"></a><span id="l11.1571" class="difflineplus">+        //aWindow.getBrowser().savedBrowsers[iix].tabData = winData._closedTabs[iix];</span>
<a href="#l11.1572"></a><span id="l11.1572" class="difflineplus">+    //    aWindow.getBrowser().savedBrowsers.unshift({browser: aWindow.getBrowser(), history: {}, tabData: winData._closedTabs[iix] });</span>
<a href="#l11.1573"></a><span id="l11.1573" class="difflineplus">+    //  }</span>
<a href="#l11.1574"></a><span id="l11.1574" class="difflineplus">+    //}</span>
<a href="#l11.1575"></a><span id="l11.1575" class="difflineplus">+</span>
<a href="#l11.1576"></a><span id="l11.1576" class="difflineplus">+    this.restoreHistoryPrecursor(aWindow, winData.tabs, (aOverwriteTabs ?</span>
<a href="#l11.1577"></a><span id="l11.1577" class="difflineplus">+      (parseInt(winData.selected) || 1) : 0), 0, 0);</span>
<a href="#l11.1578"></a><span id="l11.1578" class="difflineplus">+</span>
<a href="#l11.1579"></a><span id="l11.1579" class="difflineplus">+    this._notifyIfAllWindowsRestored();</span>
<a href="#l11.1580"></a><span id="l11.1580" class="difflineplus">+  },</span>
<a href="#l11.1581"></a><span id="l11.1581" class="difflineplus">+</span>
<a href="#l11.1582"></a><span id="l11.1582" class="difflineplus">+  /**</span>
<a href="#l11.1583"></a><span id="l11.1583" class="difflineplus">+   * Manage history restoration for a window</span>
<a href="#l11.1584"></a><span id="l11.1584" class="difflineplus">+   * @param aTabs</span>
<a href="#l11.1585"></a><span id="l11.1585" class="difflineplus">+   *        Array of tab data</span>
<a href="#l11.1586"></a><span id="l11.1586" class="difflineplus">+   * @param aCurrentTabs</span>
<a href="#l11.1587"></a><span id="l11.1587" class="difflineplus">+   *        Array of tab references</span>
<a href="#l11.1588"></a><span id="l11.1588" class="difflineplus">+   * @param aSelectTab</span>
<a href="#l11.1589"></a><span id="l11.1589" class="difflineplus">+   *        Index of selected tab</span>
<a href="#l11.1590"></a><span id="l11.1590" class="difflineplus">+   * @param aIx</span>
<a href="#l11.1591"></a><span id="l11.1591" class="difflineplus">+   *        Index of the next tab to check readyness for</span>
<a href="#l11.1592"></a><span id="l11.1592" class="difflineplus">+   * @param aCount</span>
<a href="#l11.1593"></a><span id="l11.1593" class="difflineplus">+   *        Counter for number of times delaying b/c browser or history aren't ready</span>
<a href="#l11.1594"></a><span id="l11.1594" class="difflineplus">+   */</span>
<a href="#l11.1595"></a><span id="l11.1595" class="difflineplus">+  restoreHistoryPrecursor: function sss_restoreHistoryPrecursor(aWindow, aTabs, aSelectTab, aIx, aCount) {</span>
<a href="#l11.1596"></a><span id="l11.1596" class="difflineplus">+    var tabbrowser = aWindow.getBrowser();</span>
<a href="#l11.1597"></a><span id="l11.1597" class="difflineplus">+</span>
<a href="#l11.1598"></a><span id="l11.1598" class="difflineplus">+    // make sure that all browsers and their histories are available</span>
<a href="#l11.1599"></a><span id="l11.1599" class="difflineplus">+    // - if one's not, resume this check in 100ms (repeat at most 10 times)</span>
<a href="#l11.1600"></a><span id="l11.1600" class="difflineplus">+    for (var t = aIx; t &lt; aTabs.length; t++) {</span>
<a href="#l11.1601"></a><span id="l11.1601" class="difflineplus">+      try {</span>
<a href="#l11.1602"></a><span id="l11.1602" class="difflineplus">+        if (!tabbrowser.getBrowserForTab(aTabs[t]._tab).webNavigation.sessionHistory) {</span>
<a href="#l11.1603"></a><span id="l11.1603" class="difflineplus">+          throw new Error();</span>
<a href="#l11.1604"></a><span id="l11.1604" class="difflineplus">+        }</span>
<a href="#l11.1605"></a><span id="l11.1605" class="difflineplus">+      }</span>
<a href="#l11.1606"></a><span id="l11.1606" class="difflineplus">+      catch (ex) { // in case browser or history aren't ready yet</span>
<a href="#l11.1607"></a><span id="l11.1607" class="difflineplus">+        if (aCount &lt; 10) {</span>
<a href="#l11.1608"></a><span id="l11.1608" class="difflineplus">+          var restoreHistoryFunc = function(self) {</span>
<a href="#l11.1609"></a><span id="l11.1609" class="difflineplus">+            self.restoreHistoryPrecursor(aWindow, aTabs, aSelectTab, aIx, aCount + 1);</span>
<a href="#l11.1610"></a><span id="l11.1610" class="difflineplus">+          }</span>
<a href="#l11.1611"></a><span id="l11.1611" class="difflineplus">+          aWindow.setTimeout(restoreHistoryFunc, 100, this);</span>
<a href="#l11.1612"></a><span id="l11.1612" class="difflineplus">+          return;</span>
<a href="#l11.1613"></a><span id="l11.1613" class="difflineplus">+        }</span>
<a href="#l11.1614"></a><span id="l11.1614" class="difflineplus">+      }</span>
<a href="#l11.1615"></a><span id="l11.1615" class="difflineplus">+    }</span>
<a href="#l11.1616"></a><span id="l11.1616" class="difflineplus">+</span>
<a href="#l11.1617"></a><span id="l11.1617" class="difflineplus">+    // mark the tabs as loading</span>
<a href="#l11.1618"></a><span id="l11.1618" class="difflineplus">+    for (t = 0; t &lt; aTabs.length; t++) {</span>
<a href="#l11.1619"></a><span id="l11.1619" class="difflineplus">+      var tab = aTabs[t]._tab;</span>
<a href="#l11.1620"></a><span id="l11.1620" class="difflineplus">+      var browser = tabbrowser.getBrowserForTab(tab);</span>
<a href="#l11.1621"></a><span id="l11.1621" class="difflineplus">+</span>
<a href="#l11.1622"></a><span id="l11.1622" class="difflineplus">+      if (!aTabs[t].entries || aTabs[t].entries.length == 0) {</span>
<a href="#l11.1623"></a><span id="l11.1623" class="difflineplus">+        // make sure to blank out this tab's content</span>
<a href="#l11.1624"></a><span id="l11.1624" class="difflineplus">+        // (just purging the tab's history won't be enough)</span>
<a href="#l11.1625"></a><span id="l11.1625" class="difflineplus">+        browser.contentDocument.location = &quot;about:blank&quot;;</span>
<a href="#l11.1626"></a><span id="l11.1626" class="difflineplus">+        continue;</span>
<a href="#l11.1627"></a><span id="l11.1627" class="difflineplus">+      }</span>
<a href="#l11.1628"></a><span id="l11.1628" class="difflineplus">+</span>
<a href="#l11.1629"></a><span id="l11.1629" class="difflineplus">+      browser.stop(); // in case about:blank isn't done yet</span>
<a href="#l11.1630"></a><span id="l11.1630" class="difflineplus">+</span>
<a href="#l11.1631"></a><span id="l11.1631" class="difflineplus">+      tab.setAttribute(&quot;busy&quot;, &quot;true&quot;);</span>
<a href="#l11.1632"></a><span id="l11.1632" class="difflineplus">+      tab.removeAttribute(&quot;image&quot;);</span>
<a href="#l11.1633"></a><span id="l11.1633" class="difflineplus">+      // not implemented in suite - replacing with two lines tabbrowser.setTabTitleLoading(tab);</span>
<a href="#l11.1634"></a><span id="l11.1634" class="difflineplus">+      // tab.label = this.mStringBundle.getString(&quot;tabs.loading&quot;);</span>
<a href="#l11.1635"></a><span id="l11.1635" class="difflineplus">+      // tab.setAttribute(&quot;crop&quot;, &quot;end&quot;);</span>
<a href="#l11.1636"></a><span id="l11.1636" class="difflineplus">+</span>
<a href="#l11.1637"></a><span id="l11.1637" class="difflineplus">+      // wall-paper fix for bug 439675: make sure that the URL to be loaded</span>
<a href="#l11.1638"></a><span id="l11.1638" class="difflineplus">+      // is always visible in the address bar</span>
<a href="#l11.1639"></a><span id="l11.1639" class="difflineplus">+      let activeIndex = (aTabs[t].index || aTabs[t].entries.length) - 1;</span>
<a href="#l11.1640"></a><span id="l11.1640" class="difflineplus">+      let activePageData = aTabs[t].entries[activeIndex] || null;</span>
<a href="#l11.1641"></a><span id="l11.1641" class="difflineplus">+      browser.userTypedValue = activePageData ? activePageData.url || null : null;</span>
<a href="#l11.1642"></a><span id="l11.1642" class="difflineplus">+</span>
<a href="#l11.1643"></a><span id="l11.1643" class="difflineplus">+      // keep the data around to prevent dataloss in case</span>
<a href="#l11.1644"></a><span id="l11.1644" class="difflineplus">+      // a tab gets closed before it's been properly restored</span>
<a href="#l11.1645"></a><span id="l11.1645" class="difflineplus">+      browser.parentNode.__SS_data = aTabs[t];</span>
<a href="#l11.1646"></a><span id="l11.1646" class="difflineplus">+    }</span>
<a href="#l11.1647"></a><span id="l11.1647" class="difflineplus">+</span>
<a href="#l11.1648"></a><span id="l11.1648" class="difflineplus">+    // make sure to restore the selected tab first (if any)</span>
<a href="#l11.1649"></a><span id="l11.1649" class="difflineplus">+    if (aSelectTab-- &amp;&amp; aTabs[aSelectTab]) {</span>
<a href="#l11.1650"></a><span id="l11.1650" class="difflineplus">+        aTabs.unshift(aTabs.splice(aSelectTab, 1)[0]);</span>
<a href="#l11.1651"></a><span id="l11.1651" class="difflineplus">+        tabbrowser.selectedTab = aTabs[0]._tab;</span>
<a href="#l11.1652"></a><span id="l11.1652" class="difflineplus">+    }</span>
<a href="#l11.1653"></a><span id="l11.1653" class="difflineplus">+</span>
<a href="#l11.1654"></a><span id="l11.1654" class="difflineplus">+    // helper hash for ensuring unique frame IDs</span>
<a href="#l11.1655"></a><span id="l11.1655" class="difflineplus">+    var idMap = { used: {} };</span>
<a href="#l11.1656"></a><span id="l11.1656" class="difflineplus">+    this.restoreHistory(aWindow, aTabs, idMap);</span>
<a href="#l11.1657"></a><span id="l11.1657" class="difflineplus">+  },</span>
<a href="#l11.1658"></a><span id="l11.1658" class="difflineplus">+</span>
<a href="#l11.1659"></a><span id="l11.1659" class="difflineplus">+  /**</span>
<a href="#l11.1660"></a><span id="l11.1660" class="difflineplus">+   * Restore history for a window</span>
<a href="#l11.1661"></a><span id="l11.1661" class="difflineplus">+   * @param aWindow</span>
<a href="#l11.1662"></a><span id="l11.1662" class="difflineplus">+   *        Window reference</span>
<a href="#l11.1663"></a><span id="l11.1663" class="difflineplus">+   * @param aTabs</span>
<a href="#l11.1664"></a><span id="l11.1664" class="difflineplus">+   *        Array of tab data</span>
<a href="#l11.1665"></a><span id="l11.1665" class="difflineplus">+   * @param aIdMap</span>
<a href="#l11.1666"></a><span id="l11.1666" class="difflineplus">+   *        Hash for ensuring unique frame IDs</span>
<a href="#l11.1667"></a><span id="l11.1667" class="difflineplus">+   */</span>
<a href="#l11.1668"></a><span id="l11.1668" class="difflineplus">+  restoreHistory: function sss_restoreHistory(aWindow, aTabs, aIdMap) {</span>
<a href="#l11.1669"></a><span id="l11.1669" class="difflineplus">+    var _this = this;</span>
<a href="#l11.1670"></a><span id="l11.1670" class="difflineplus">+    while (aTabs.length &gt; 0 &amp;&amp; (!aTabs[0]._tab || !aTabs[0]._tab.parentNode)) {</span>
<a href="#l11.1671"></a><span id="l11.1671" class="difflineplus">+      aTabs.shift(); // this tab got removed before being completely restored</span>
<a href="#l11.1672"></a><span id="l11.1672" class="difflineplus">+    }</span>
<a href="#l11.1673"></a><span id="l11.1673" class="difflineplus">+    if (aTabs.length == 0) {</span>
<a href="#l11.1674"></a><span id="l11.1674" class="difflineplus">+      return; // no more tabs to restore</span>
<a href="#l11.1675"></a><span id="l11.1675" class="difflineplus">+    }</span>
<a href="#l11.1676"></a><span id="l11.1676" class="difflineplus">+</span>
<a href="#l11.1677"></a><span id="l11.1677" class="difflineplus">+    var tabData = aTabs.shift();</span>
<a href="#l11.1678"></a><span id="l11.1678" class="difflineplus">+</span>
<a href="#l11.1679"></a><span id="l11.1679" class="difflineplus">+    var tab = tabData._tab;</span>
<a href="#l11.1680"></a><span id="l11.1680" class="difflineplus">+    var browser = aWindow.getBrowser().getBrowserForTab(tab);</span>
<a href="#l11.1681"></a><span id="l11.1681" class="difflineplus">+    var history = browser.webNavigation.sessionHistory;</span>
<a href="#l11.1682"></a><span id="l11.1682" class="difflineplus">+</span>
<a href="#l11.1683"></a><span id="l11.1683" class="difflineplus">+    if (history.count &gt; 0) {</span>
<a href="#l11.1684"></a><span id="l11.1684" class="difflineplus">+      history.PurgeHistory(history.count);</span>
<a href="#l11.1685"></a><span id="l11.1685" class="difflineplus">+    }</span>
<a href="#l11.1686"></a><span id="l11.1686" class="difflineplus">+    history.QueryInterface(Components.interfaces.nsISHistoryInternal);</span>
<a href="#l11.1687"></a><span id="l11.1687" class="difflineplus">+</span>
<a href="#l11.1688"></a><span id="l11.1688" class="difflineplus">+    if (!tabData.entries) {</span>
<a href="#l11.1689"></a><span id="l11.1689" class="difflineplus">+      tabData.entries = [];</span>
<a href="#l11.1690"></a><span id="l11.1690" class="difflineplus">+    }</span>
<a href="#l11.1691"></a><span id="l11.1691" class="difflineplus">+    if (tabData.extData) {</span>
<a href="#l11.1692"></a><span id="l11.1692" class="difflineplus">+      tab.__SS_extdata = tabData.extData;</span>
<a href="#l11.1693"></a><span id="l11.1693" class="difflineplus">+    }</span>
<a href="#l11.1694"></a><span id="l11.1694" class="difflineplus">+</span>
<a href="#l11.1695"></a><span id="l11.1695" class="difflineplus">+    for (var i = 0; i &lt; tabData.entries.length; i++) {</span>
<a href="#l11.1696"></a><span id="l11.1696" class="difflineplus">+      history.addEntry(this._deserializeHistoryEntry(tabData.entries[i], aIdMap), true);</span>
<a href="#l11.1697"></a><span id="l11.1697" class="difflineplus">+    }</span>
<a href="#l11.1698"></a><span id="l11.1698" class="difflineplus">+</span>
<a href="#l11.1699"></a><span id="l11.1699" class="difflineplus">+    // make sure to reset the capabilities and attributes, in case this tab gets reused</span>
<a href="#l11.1700"></a><span id="l11.1700" class="difflineplus">+    var disallow = (tabData.disallow)?tabData.disallow.split(&quot;,&quot;):[];</span>
<a href="#l11.1701"></a><span id="l11.1701" class="difflineplus">+    CAPABILITIES.forEach(function(aCapability) {</span>
<a href="#l11.1702"></a><span id="l11.1702" class="difflineplus">+      browser.docShell[&quot;allow&quot; + aCapability] = disallow.indexOf(aCapability) == -1;</span>
<a href="#l11.1703"></a><span id="l11.1703" class="difflineplus">+    });</span>
<a href="#l11.1704"></a><span id="l11.1704" class="difflineplus">+    Array.filter(tab.attributes, function(aAttr) {</span>
<a href="#l11.1705"></a><span id="l11.1705" class="difflineplus">+      return (_this.xulAttributes.indexOf(aAttr.name) &gt; -1);</span>
<a href="#l11.1706"></a><span id="l11.1706" class="difflineplus">+    }).forEach(tab.removeAttribute, tab);</span>
<a href="#l11.1707"></a><span id="l11.1707" class="difflineplus">+    if (tabData.xultab) {</span>
<a href="#l11.1708"></a><span id="l11.1708" class="difflineplus">+      // restore attributes from the legacy format</span>
<a href="#l11.1709"></a><span id="l11.1709" class="difflineplus">+      tabData.xultab.split(&quot; &quot;).forEach(function(aAttr) {</span>
<a href="#l11.1710"></a><span id="l11.1710" class="difflineplus">+        if (/^([^\s=]+)=(.*)/.test(aAttr)) {</span>
<a href="#l11.1711"></a><span id="l11.1711" class="difflineplus">+          tab.setAttribute(RegExp.$1, decodeURI(RegExp.$2));</span>
<a href="#l11.1712"></a><span id="l11.1712" class="difflineplus">+        }</span>
<a href="#l11.1713"></a><span id="l11.1713" class="difflineplus">+      });</span>
<a href="#l11.1714"></a><span id="l11.1714" class="difflineplus">+    }</span>
<a href="#l11.1715"></a><span id="l11.1715" class="difflineplus">+    for (let name in tabData.attributes)</span>
<a href="#l11.1716"></a><span id="l11.1716" class="difflineplus">+      tab.setAttribute(name, tabData.attributes[name]);</span>
<a href="#l11.1717"></a><span id="l11.1717" class="difflineplus">+</span>
<a href="#l11.1718"></a><span id="l11.1718" class="difflineplus">+    if (tabData.storage &amp;&amp; browser.docShell instanceof Components.interfaces.nsIDocShell)</span>
<a href="#l11.1719"></a><span id="l11.1719" class="difflineplus">+      this._deserializeSessionStorage(tabData.storage, browser.docShell);</span>
<a href="#l11.1720"></a><span id="l11.1720" class="difflineplus">+</span>
<a href="#l11.1721"></a><span id="l11.1721" class="difflineplus">+    // notify the tabbrowser that the tab chrome has been restored</span>
<a href="#l11.1722"></a><span id="l11.1722" class="difflineplus">+    var event = aWindow.document.createEvent(&quot;Events&quot;);</span>
<a href="#l11.1723"></a><span id="l11.1723" class="difflineplus">+    event.initEvent(&quot;SSTabRestoring&quot;, true, false);</span>
<a href="#l11.1724"></a><span id="l11.1724" class="difflineplus">+    tab.dispatchEvent(event);</span>
<a href="#l11.1725"></a><span id="l11.1725" class="difflineplus">+</span>
<a href="#l11.1726"></a><span id="l11.1726" class="difflineplus">+    let activeIndex = (tabData.index || tabData.entries.length) - 1;</span>
<a href="#l11.1727"></a><span id="l11.1727" class="difflineplus">+    if (activeIndex &gt;= tabData.entries.length)</span>
<a href="#l11.1728"></a><span id="l11.1728" class="difflineplus">+      activeIndex = tabData.entries.length - 1;</span>
<a href="#l11.1729"></a><span id="l11.1729" class="difflineplus">+    try {</span>
<a href="#l11.1730"></a><span id="l11.1730" class="difflineplus">+      if (activeIndex &gt;= 0)</span>
<a href="#l11.1731"></a><span id="l11.1731" class="difflineplus">+        browser.webNavigation.gotoIndex(activeIndex);</span>
<a href="#l11.1732"></a><span id="l11.1732" class="difflineplus">+    }</span>
<a href="#l11.1733"></a><span id="l11.1733" class="difflineplus">+    catch (ex) {</span>
<a href="#l11.1734"></a><span id="l11.1734" class="difflineplus">+      // ignore page load errors</span>
<a href="#l11.1735"></a><span id="l11.1735" class="difflineplus">+      tab.removeAttribute(&quot;busy&quot;);</span>
<a href="#l11.1736"></a><span id="l11.1736" class="difflineplus">+    }</span>
<a href="#l11.1737"></a><span id="l11.1737" class="difflineplus">+</span>
<a href="#l11.1738"></a><span id="l11.1738" class="difflineplus">+    if (tabData.entries.length &gt; 0) {</span>
<a href="#l11.1739"></a><span id="l11.1739" class="difflineplus">+      // restore those aspects of the currently active documents</span>
<a href="#l11.1740"></a><span id="l11.1740" class="difflineplus">+      // which are not preserved in the plain history entries</span>
<a href="#l11.1741"></a><span id="l11.1741" class="difflineplus">+      // (mainly scroll state and text data)</span>
<a href="#l11.1742"></a><span id="l11.1742" class="difflineplus">+      browser.__SS_restore_data = tabData.entries[activeIndex] || {};</span>
<a href="#l11.1743"></a><span id="l11.1743" class="difflineplus">+      browser.__SS_restore_text = tabData.text || &quot;&quot;;</span>
<a href="#l11.1744"></a><span id="l11.1744" class="difflineplus">+      browser.__SS_restore_pageStyle = tabData.pageStyle || &quot;&quot;;</span>
<a href="#l11.1745"></a><span id="l11.1745" class="difflineplus">+      browser.__SS_restore_tab = tab;</span>
<a href="#l11.1746"></a><span id="l11.1746" class="difflineplus">+      browser.__SS_restore = this.restoreDocument_proxy;</span>
<a href="#l11.1747"></a><span id="l11.1747" class="difflineplus">+      browser.addEventListener(&quot;load&quot;, browser.__SS_restore, true);</span>
<a href="#l11.1748"></a><span id="l11.1748" class="difflineplus">+    }</span>
<a href="#l11.1749"></a><span id="l11.1749" class="difflineplus">+</span>
<a href="#l11.1750"></a><span id="l11.1750" class="difflineplus">+    aWindow.setTimeout(function(){ _this.restoreHistory(aWindow, aTabs, aIdMap); }, 0);</span>
<a href="#l11.1751"></a><span id="l11.1751" class="difflineplus">+  },</span>
<a href="#l11.1752"></a><span id="l11.1752" class="difflineplus">+</span>
<a href="#l11.1753"></a><span id="l11.1753" class="difflineplus">+  /**</span>
<a href="#l11.1754"></a><span id="l11.1754" class="difflineplus">+   * expands serialized history data into a session-history-entry instance</span>
<a href="#l11.1755"></a><span id="l11.1755" class="difflineplus">+   * @param aEntry</span>
<a href="#l11.1756"></a><span id="l11.1756" class="difflineplus">+   *        Object containing serialized history data for a URL</span>
<a href="#l11.1757"></a><span id="l11.1757" class="difflineplus">+   * @param aIdMap</span>
<a href="#l11.1758"></a><span id="l11.1758" class="difflineplus">+   *        Hash for ensuring unique frame IDs</span>
<a href="#l11.1759"></a><span id="l11.1759" class="difflineplus">+   * @returns nsISHEntry</span>
<a href="#l11.1760"></a><span id="l11.1760" class="difflineplus">+   */</span>
<a href="#l11.1761"></a><span id="l11.1761" class="difflineplus">+  _deserializeHistoryEntry: function sss_deserializeHistoryEntry(aEntry, aIdMap) {</span>
<a href="#l11.1762"></a><span id="l11.1762" class="difflineplus">+    var shEntry = Components.classes[&quot;@mozilla.org/browser/session-history-entry;1&quot;]</span>
<a href="#l11.1763"></a><span id="l11.1763" class="difflineplus">+                            .createInstance(Components.interfaces.nsISHEntry);</span>
<a href="#l11.1764"></a><span id="l11.1764" class="difflineplus">+</span>
<a href="#l11.1765"></a><span id="l11.1765" class="difflineplus">+    var ioService = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l11.1766"></a><span id="l11.1766" class="difflineplus">+                              .getService(Components.interfaces.nsIIOService);</span>
<a href="#l11.1767"></a><span id="l11.1767" class="difflineplus">+    shEntry.setURI(ioService.newURI(aEntry.url, null, null));</span>
<a href="#l11.1768"></a><span id="l11.1768" class="difflineplus">+    shEntry.setTitle(aEntry.title || aEntry.url);</span>
<a href="#l11.1769"></a><span id="l11.1769" class="difflineplus">+    if (aEntry.subframe)</span>
<a href="#l11.1770"></a><span id="l11.1770" class="difflineplus">+      shEntry.setIsSubFrame(aEntry.subframe || false);</span>
<a href="#l11.1771"></a><span id="l11.1771" class="difflineplus">+    shEntry.loadType = Components.interfaces.nsIDocShellLoadInfo.loadHistory;</span>
<a href="#l11.1772"></a><span id="l11.1772" class="difflineplus">+    if (aEntry.contentType)</span>
<a href="#l11.1773"></a><span id="l11.1773" class="difflineplus">+      shEntry.contentType = aEntry.contentType;</span>
<a href="#l11.1774"></a><span id="l11.1774" class="difflineplus">+</span>
<a href="#l11.1775"></a><span id="l11.1775" class="difflineplus">+    if (aEntry.cacheKey) {</span>
<a href="#l11.1776"></a><span id="l11.1776" class="difflineplus">+      var cacheKey = Components.classes[&quot;@mozilla.org/supports-PRUint32;1&quot;]</span>
<a href="#l11.1777"></a><span id="l11.1777" class="difflineplus">+                               .createInstance(Components.interfaces.nsISupportsPRUint32);</span>
<a href="#l11.1778"></a><span id="l11.1778" class="difflineplus">+      cacheKey.data = aEntry.cacheKey;</span>
<a href="#l11.1779"></a><span id="l11.1779" class="difflineplus">+      shEntry.cacheKey = cacheKey;</span>
<a href="#l11.1780"></a><span id="l11.1780" class="difflineplus">+    }</span>
<a href="#l11.1781"></a><span id="l11.1781" class="difflineplus">+</span>
<a href="#l11.1782"></a><span id="l11.1782" class="difflineplus">+    if (aEntry.ID) {</span>
<a href="#l11.1783"></a><span id="l11.1783" class="difflineplus">+      // get a new unique ID for this frame (since the one from the last</span>
<a href="#l11.1784"></a><span id="l11.1784" class="difflineplus">+      // start might already be in use)</span>
<a href="#l11.1785"></a><span id="l11.1785" class="difflineplus">+      var id = aIdMap[aEntry.ID] || 0;</span>
<a href="#l11.1786"></a><span id="l11.1786" class="difflineplus">+      if (!id) {</span>
<a href="#l11.1787"></a><span id="l11.1787" class="difflineplus">+        for (id = Date.now(); aIdMap.used[id]; id++);</span>
<a href="#l11.1788"></a><span id="l11.1788" class="difflineplus">+        aIdMap[aEntry.ID] = id;</span>
<a href="#l11.1789"></a><span id="l11.1789" class="difflineplus">+        aIdMap.used[id] = true;</span>
<a href="#l11.1790"></a><span id="l11.1790" class="difflineplus">+      }</span>
<a href="#l11.1791"></a><span id="l11.1791" class="difflineplus">+      shEntry.ID = id;</span>
<a href="#l11.1792"></a><span id="l11.1792" class="difflineplus">+    }</span>
<a href="#l11.1793"></a><span id="l11.1793" class="difflineplus">+</span>
<a href="#l11.1794"></a><span id="l11.1794" class="difflineplus">+    if (aEntry.scroll) {</span>
<a href="#l11.1795"></a><span id="l11.1795" class="difflineplus">+      var scrollPos = (aEntry.scroll || &quot;0,0&quot;).split(&quot;,&quot;);</span>
<a href="#l11.1796"></a><span id="l11.1796" class="difflineplus">+      scrollPos = [parseInt(scrollPos[0]) || 0, parseInt(scrollPos[1]) || 0];</span>
<a href="#l11.1797"></a><span id="l11.1797" class="difflineplus">+      shEntry.setScrollPosition(scrollPos[0], scrollPos[1]);</span>
<a href="#l11.1798"></a><span id="l11.1798" class="difflineplus">+    }</span>
<a href="#l11.1799"></a><span id="l11.1799" class="difflineplus">+</span>
<a href="#l11.1800"></a><span id="l11.1800" class="difflineplus">+    var postdata;</span>
<a href="#l11.1801"></a><span id="l11.1801" class="difflineplus">+    if (aEntry.postdata_b64) {  // Firefox 3</span>
<a href="#l11.1802"></a><span id="l11.1802" class="difflineplus">+      postdata = atob(aEntry.postdata_b64);</span>
<a href="#l11.1803"></a><span id="l11.1803" class="difflineplus">+    } else if (aEntry.postdata) { // Firefox 2</span>
<a href="#l11.1804"></a><span id="l11.1804" class="difflineplus">+      postdata = aEntry.postdata;</span>
<a href="#l11.1805"></a><span id="l11.1805" class="difflineplus">+    }</span>
<a href="#l11.1806"></a><span id="l11.1806" class="difflineplus">+</span>
<a href="#l11.1807"></a><span id="l11.1807" class="difflineplus">+    if (postdata) {</span>
<a href="#l11.1808"></a><span id="l11.1808" class="difflineplus">+      var stream = Components.classes[&quot;@mozilla.org/io/string-input-stream;1&quot;]</span>
<a href="#l11.1809"></a><span id="l11.1809" class="difflineplus">+                             .createInstance(Components.interfaces.nsIStringInputStream);</span>
<a href="#l11.1810"></a><span id="l11.1810" class="difflineplus">+      stream.setData(postdata, postdata.length);</span>
<a href="#l11.1811"></a><span id="l11.1811" class="difflineplus">+      shEntry.postData = stream;</span>
<a href="#l11.1812"></a><span id="l11.1812" class="difflineplus">+    }</span>
<a href="#l11.1813"></a><span id="l11.1813" class="difflineplus">+</span>
<a href="#l11.1814"></a><span id="l11.1814" class="difflineplus">+    if (aEntry.owner_b64) {  // Firefox 3</span>
<a href="#l11.1815"></a><span id="l11.1815" class="difflineplus">+      var ownerInput = Components.classes[&quot;@mozilla.org/io/string-input-stream;1&quot;]</span>
<a href="#l11.1816"></a><span id="l11.1816" class="difflineplus">+                                 .createInstance(Components.interfaces.nsIStringInputStream);</span>
<a href="#l11.1817"></a><span id="l11.1817" class="difflineplus">+      var binaryData = atob(aEntry.owner_b64);</span>
<a href="#l11.1818"></a><span id="l11.1818" class="difflineplus">+      ownerInput.setData(binaryData, binaryData.length);</span>
<a href="#l11.1819"></a><span id="l11.1819" class="difflineplus">+      var binaryStream = Components.classes[&quot;@mozilla.org/binaryinputstream;1&quot;]</span>
<a href="#l11.1820"></a><span id="l11.1820" class="difflineplus">+                                   .createInstance(Components.interfaces.nsIObjectInputStream);</span>
<a href="#l11.1821"></a><span id="l11.1821" class="difflineplus">+      binaryStream.setInputStream(ownerInput);</span>
<a href="#l11.1822"></a><span id="l11.1822" class="difflineplus">+      try { // Catch possible deserialization exceptions</span>
<a href="#l11.1823"></a><span id="l11.1823" class="difflineplus">+        shEntry.owner = binaryStream.readObject(true);</span>
<a href="#l11.1824"></a><span id="l11.1824" class="difflineplus">+      } catch (ex) { debug(ex); }</span>
<a href="#l11.1825"></a><span id="l11.1825" class="difflineplus">+    } else if (aEntry.ownerURI) { // Firefox 2</span>
<a href="#l11.1826"></a><span id="l11.1826" class="difflineplus">+      var uriObj = ioService.newURI(aEntry.ownerURI, null, null);</span>
<a href="#l11.1827"></a><span id="l11.1827" class="difflineplus">+      shEntry.owner = Components.classes[&quot;@mozilla.org/scriptsecuritymanager;1&quot;]</span>
<a href="#l11.1828"></a><span id="l11.1828" class="difflineplus">+                                .getService(Components.interfaces.nsIScriptSecurityManager)</span>
<a href="#l11.1829"></a><span id="l11.1829" class="difflineplus">+                                .getCodebasePrincipal(uriObj);</span>
<a href="#l11.1830"></a><span id="l11.1830" class="difflineplus">+    }</span>
<a href="#l11.1831"></a><span id="l11.1831" class="difflineplus">+</span>
<a href="#l11.1832"></a><span id="l11.1832" class="difflineplus">+    if (aEntry.children &amp;&amp; shEntry instanceof Components.interfaces.nsISHContainer) {</span>
<a href="#l11.1833"></a><span id="l11.1833" class="difflineplus">+      for (var i = 0; i &lt; aEntry.children.length; i++) {</span>
<a href="#l11.1834"></a><span id="l11.1834" class="difflineplus">+        shEntry.AddChild(this._deserializeHistoryEntry(aEntry.children[i], aIdMap), i);</span>
<a href="#l11.1835"></a><span id="l11.1835" class="difflineplus">+      }</span>
<a href="#l11.1836"></a><span id="l11.1836" class="difflineplus">+    }</span>
<a href="#l11.1837"></a><span id="l11.1837" class="difflineplus">+</span>
<a href="#l11.1838"></a><span id="l11.1838" class="difflineplus">+    return shEntry;</span>
<a href="#l11.1839"></a><span id="l11.1839" class="difflineplus">+  },</span>
<a href="#l11.1840"></a><span id="l11.1840" class="difflineplus">+</span>
<a href="#l11.1841"></a><span id="l11.1841" class="difflineplus">+  /**</span>
<a href="#l11.1842"></a><span id="l11.1842" class="difflineplus">+   * restores all sessionStorage &quot;super cookies&quot;</span>
<a href="#l11.1843"></a><span id="l11.1843" class="difflineplus">+   * @param aStorageData</span>
<a href="#l11.1844"></a><span id="l11.1844" class="difflineplus">+   *        Storage data to be restored</span>
<a href="#l11.1845"></a><span id="l11.1845" class="difflineplus">+   * @param aDocShell</span>
<a href="#l11.1846"></a><span id="l11.1846" class="difflineplus">+   *        A tab's docshell (containing the sessionStorage)</span>
<a href="#l11.1847"></a><span id="l11.1847" class="difflineplus">+   */</span>
<a href="#l11.1848"></a><span id="l11.1848" class="difflineplus">+  _deserializeSessionStorage: function sss_deserializeSessionStorage(aStorageData, aDocShell) {</span>
<a href="#l11.1849"></a><span id="l11.1849" class="difflineplus">+    let ioService = Cc[&quot;@mozilla.org/network/io-service;1&quot;].getService(Components.interfaces.nsIIOService);</span>
<a href="#l11.1850"></a><span id="l11.1850" class="difflineplus">+    for (let url in aStorageData) {</span>
<a href="#l11.1851"></a><span id="l11.1851" class="difflineplus">+      let uri = ioService.newURI(url, null, null);</span>
<a href="#l11.1852"></a><span id="l11.1852" class="difflineplus">+      let storage = aDocShell.getSessionStorageForURI(uri);</span>
<a href="#l11.1853"></a><span id="l11.1853" class="difflineplus">+      for (let key in aStorageData[url]) {</span>
<a href="#l11.1854"></a><span id="l11.1854" class="difflineplus">+        try {</span>
<a href="#l11.1855"></a><span id="l11.1855" class="difflineplus">+          storage.setItem(key, aStorageData[url][key].value);</span>
<a href="#l11.1856"></a><span id="l11.1856" class="difflineplus">+          if (uri.schemeIs(&quot;https&quot;))</span>
<a href="#l11.1857"></a><span id="l11.1857" class="difflineplus">+            storage.getItem(key).secure = aStorageData[url][key].secure || false;</span>
<a href="#l11.1858"></a><span id="l11.1858" class="difflineplus">+        }</span>
<a href="#l11.1859"></a><span id="l11.1859" class="difflineplus">+        catch (ex) { Cu.reportError(ex); } // throws e.g. for URIs that can't have sessionStorage</span>
<a href="#l11.1860"></a><span id="l11.1860" class="difflineplus">+      }</span>
<a href="#l11.1861"></a><span id="l11.1861" class="difflineplus">+    }</span>
<a href="#l11.1862"></a><span id="l11.1862" class="difflineplus">+  },</span>
<a href="#l11.1863"></a><span id="l11.1863" class="difflineplus">+</span>
<a href="#l11.1864"></a><span id="l11.1864" class="difflineplus">+  /**</span>
<a href="#l11.1865"></a><span id="l11.1865" class="difflineplus">+   * Restore properties to a loaded document</span>
<a href="#l11.1866"></a><span id="l11.1866" class="difflineplus">+   */</span>
<a href="#l11.1867"></a><span id="l11.1867" class="difflineplus">+  restoreDocument_proxy: function sss_restoreDocument_proxy(aEvent) {</span>
<a href="#l11.1868"></a><span id="l11.1868" class="difflineplus">+    // wait for the top frame to be loaded completely</span>
<a href="#l11.1869"></a><span id="l11.1869" class="difflineplus">+    if (!aEvent || !aEvent.originalTarget || !aEvent.originalTarget.defaultView || aEvent.originalTarget.defaultView != aEvent.originalTarget.defaultView.top) {</span>
<a href="#l11.1870"></a><span id="l11.1870" class="difflineplus">+      return;</span>
<a href="#l11.1871"></a><span id="l11.1871" class="difflineplus">+    }</span>
<a href="#l11.1872"></a><span id="l11.1872" class="difflineplus">+</span>
<a href="#l11.1873"></a><span id="l11.1873" class="difflineplus">+    // always call this before injecting content into a document!</span>
<a href="#l11.1874"></a><span id="l11.1874" class="difflineplus">+    function hasExpectedURL(aDocument, aURL)</span>
<a href="#l11.1875"></a><span id="l11.1875" class="difflineplus">+      !aURL || aURL.replace(/#.*/, &quot;&quot;) == aDocument.location.href.replace(/#.*/, &quot;&quot;);</span>
<a href="#l11.1876"></a><span id="l11.1876" class="difflineplus">+</span>
<a href="#l11.1877"></a><span id="l11.1877" class="difflineplus">+    // restore text data saved by SeaMonkey</span>
<a href="#l11.1878"></a><span id="l11.1878" class="difflineplus">+    var textArray = this.__SS_restore_text ? this.__SS_restore_text.split(&quot; &quot;) : [];</span>
<a href="#l11.1879"></a><span id="l11.1879" class="difflineplus">+    function restoreTextData(aContent, aPrefix, aURL) {</span>
<a href="#l11.1880"></a><span id="l11.1880" class="difflineplus">+      textArray.forEach(function(aEntry) {</span>
<a href="#l11.1881"></a><span id="l11.1881" class="difflineplus">+        if (/^((?:\d+\|)*)(#?)([^\s=]+)=(.*)$/.test(aEntry) &amp;&amp;</span>
<a href="#l11.1882"></a><span id="l11.1882" class="difflineplus">+            RegExp.$1 == aPrefix &amp;&amp; hasExpectedURL(aContent.document, aURL)) {</span>
<a href="#l11.1883"></a><span id="l11.1883" class="difflineplus">+          var document = aContent.document;</span>
<a href="#l11.1884"></a><span id="l11.1884" class="difflineplus">+          var node = RegExp.$2 ? document.getElementById(RegExp.$3) : document.getElementsByName(RegExp.$3)[0] || null;</span>
<a href="#l11.1885"></a><span id="l11.1885" class="difflineplus">+          if (node &amp;&amp; &quot;value&quot; in node) {</span>
<a href="#l11.1886"></a><span id="l11.1886" class="difflineplus">+            node.value = decodeURI(RegExp.$4);</span>
<a href="#l11.1887"></a><span id="l11.1887" class="difflineplus">+</span>
<a href="#l11.1888"></a><span id="l11.1888" class="difflineplus">+            var event = document.createEvent(&quot;UIEvents&quot;);</span>
<a href="#l11.1889"></a><span id="l11.1889" class="difflineplus">+            event.initUIEvent(&quot;input&quot;, true, true, aContent, 0);</span>
<a href="#l11.1890"></a><span id="l11.1890" class="difflineplus">+            node.dispatchEvent(event);</span>
<a href="#l11.1891"></a><span id="l11.1891" class="difflineplus">+          }</span>
<a href="#l11.1892"></a><span id="l11.1892" class="difflineplus">+        }</span>
<a href="#l11.1893"></a><span id="l11.1893" class="difflineplus">+      });</span>
<a href="#l11.1894"></a><span id="l11.1894" class="difflineplus">+    }</span>
<a href="#l11.1895"></a><span id="l11.1895" class="difflineplus">+</span>
<a href="#l11.1896"></a><span id="l11.1896" class="difflineplus">+    function restoreFormData(aDocument, aData, aURL) {</span>
<a href="#l11.1897"></a><span id="l11.1897" class="difflineplus">+      for (let key in aData) {</span>
<a href="#l11.1898"></a><span id="l11.1898" class="difflineplus">+        if (!hasExpectedURL(aDocument, aURL))</span>
<a href="#l11.1899"></a><span id="l11.1899" class="difflineplus">+          return;</span>
<a href="#l11.1900"></a><span id="l11.1900" class="difflineplus">+</span>
<a href="#l11.1901"></a><span id="l11.1901" class="difflineplus">+        let node = key.charAt(0) == &quot;#&quot; ? aDocument.getElementById(key.slice(1)) :</span>
<a href="#l11.1902"></a><span id="l11.1902" class="difflineplus">+                                          XPathHelper.resolve(aDocument, key);</span>
<a href="#l11.1903"></a><span id="l11.1903" class="difflineplus">+        if (!node)</span>
<a href="#l11.1904"></a><span id="l11.1904" class="difflineplus">+          continue;</span>
<a href="#l11.1905"></a><span id="l11.1905" class="difflineplus">+</span>
<a href="#l11.1906"></a><span id="l11.1906" class="difflineplus">+        let value = aData[key];</span>
<a href="#l11.1907"></a><span id="l11.1907" class="difflineplus">+        if (typeof value == &quot;string&quot;) {</span>
<a href="#l11.1908"></a><span id="l11.1908" class="difflineplus">+          node.value = value;</span>
<a href="#l11.1909"></a><span id="l11.1909" class="difflineplus">+</span>
<a href="#l11.1910"></a><span id="l11.1910" class="difflineplus">+          let event = aDocument.createEvent(&quot;UIEvents&quot;);</span>
<a href="#l11.1911"></a><span id="l11.1911" class="difflineplus">+          event.initUIEvent(&quot;input&quot;, true, true, aDocument.defaultView, 0);</span>
<a href="#l11.1912"></a><span id="l11.1912" class="difflineplus">+          node.dispatchEvent(event);</span>
<a href="#l11.1913"></a><span id="l11.1913" class="difflineplus">+        }</span>
<a href="#l11.1914"></a><span id="l11.1914" class="difflineplus">+        else if (typeof value == &quot;boolean&quot;)</span>
<a href="#l11.1915"></a><span id="l11.1915" class="difflineplus">+          node.checked = value;</span>
<a href="#l11.1916"></a><span id="l11.1916" class="difflineplus">+        else if (typeof value == &quot;number&quot;)</span>
<a href="#l11.1917"></a><span id="l11.1917" class="difflineplus">+          try {</span>
<a href="#l11.1918"></a><span id="l11.1918" class="difflineplus">+            node.selectedIndex = value;</span>
<a href="#l11.1919"></a><span id="l11.1919" class="difflineplus">+          } catch (ex) { /* throws for invalid indices */ }</span>
<a href="#l11.1920"></a><span id="l11.1920" class="difflineplus">+        else if (value &amp;&amp; typeof value.indexOf == &quot;function&quot; &amp;&amp; node.options) {</span>
<a href="#l11.1921"></a><span id="l11.1921" class="difflineplus">+          Array.forEach(node.options, function(aOpt, aIx) {</span>
<a href="#l11.1922"></a><span id="l11.1922" class="difflineplus">+            aOpt.selected = value.indexOf(aIx) &gt; -1;</span>
<a href="#l11.1923"></a><span id="l11.1923" class="difflineplus">+          });</span>
<a href="#l11.1924"></a><span id="l11.1924" class="difflineplus">+        }</span>
<a href="#l11.1925"></a><span id="l11.1925" class="difflineplus">+        // NB: dispatching &quot;change&quot; events might have unintended side-effects</span>
<a href="#l11.1926"></a><span id="l11.1926" class="difflineplus">+      }</span>
<a href="#l11.1927"></a><span id="l11.1927" class="difflineplus">+    }</span>
<a href="#l11.1928"></a><span id="l11.1928" class="difflineplus">+</span>
<a href="#l11.1929"></a><span id="l11.1929" class="difflineplus">+    let selectedPageStyle = this.__SS_restore_pageStyle;</span>
<a href="#l11.1930"></a><span id="l11.1930" class="difflineplus">+    let window = this.ownerDocument.defaultView;</span>
<a href="#l11.1931"></a><span id="l11.1931" class="difflineplus">+    function restoreTextDataAndScrolling(aContent, aData, aPrefix) {</span>
<a href="#l11.1932"></a><span id="l11.1932" class="difflineplus">+      if (aData.formdata)</span>
<a href="#l11.1933"></a><span id="l11.1933" class="difflineplus">+        restoreFormData(aContent.document, aData.formdata, aData.url);</span>
<a href="#l11.1934"></a><span id="l11.1934" class="difflineplus">+      else</span>
<a href="#l11.1935"></a><span id="l11.1935" class="difflineplus">+        restoreTextData(aContent, aPrefix, aData.url);</span>
<a href="#l11.1936"></a><span id="l11.1936" class="difflineplus">+      if (aData.innerHTML) {</span>
<a href="#l11.1937"></a><span id="l11.1937" class="difflineplus">+        window.setTimeout(function() {</span>
<a href="#l11.1938"></a><span id="l11.1938" class="difflineplus">+          if (aContent.document.designMode == &quot;on&quot; &amp;&amp;</span>
<a href="#l11.1939"></a><span id="l11.1939" class="difflineplus">+              hasExpectedURL(aContent.document, aData.url)) {</span>
<a href="#l11.1940"></a><span id="l11.1940" class="difflineplus">+            aContent.document.body.innerHTML = aData.innerHTML;</span>
<a href="#l11.1941"></a><span id="l11.1941" class="difflineplus">+          }</span>
<a href="#l11.1942"></a><span id="l11.1942" class="difflineplus">+        }, 0);</span>
<a href="#l11.1943"></a><span id="l11.1943" class="difflineplus">+      }</span>
<a href="#l11.1944"></a><span id="l11.1944" class="difflineplus">+      if (aData.scroll &amp;&amp; /(\d+),(\d+)/.test(aData.scroll)) {</span>
<a href="#l11.1945"></a><span id="l11.1945" class="difflineplus">+        aContent.scrollTo(RegExp.$1, RegExp.$2);</span>
<a href="#l11.1946"></a><span id="l11.1946" class="difflineplus">+      }</span>
<a href="#l11.1947"></a><span id="l11.1947" class="difflineplus">+      Array.forEach(aContent.document.styleSheets, function(aSS) {</span>
<a href="#l11.1948"></a><span id="l11.1948" class="difflineplus">+        aSS.disabled = aSS.title &amp;&amp; aSS.title != selectedPageStyle;</span>
<a href="#l11.1949"></a><span id="l11.1949" class="difflineplus">+      });</span>
<a href="#l11.1950"></a><span id="l11.1950" class="difflineplus">+      for (var i = 0; i &lt; aContent.frames.length; i++) {</span>
<a href="#l11.1951"></a><span id="l11.1951" class="difflineplus">+        if (aData.children &amp;&amp; aData.children[i] &amp;&amp;</span>
<a href="#l11.1952"></a><span id="l11.1952" class="difflineplus">+          hasExpectedURL(aContent.document, aData.url)) {</span>
<a href="#l11.1953"></a><span id="l11.1953" class="difflineplus">+          restoreTextDataAndScrolling(aContent.frames[i], aData.children[i], aPrefix + i + &quot;|&quot;);</span>
<a href="#l11.1954"></a><span id="l11.1954" class="difflineplus">+        }</span>
<a href="#l11.1955"></a><span id="l11.1955" class="difflineplus">+      }</span>
<a href="#l11.1956"></a><span id="l11.1956" class="difflineplus">+    }</span>
<a href="#l11.1957"></a><span id="l11.1957" class="difflineplus">+</span>
<a href="#l11.1958"></a><span id="l11.1958" class="difflineplus">+    // don't restore text data and scrolling state if the user has navigated</span>
<a href="#l11.1959"></a><span id="l11.1959" class="difflineplus">+    // away before the loading completed (except for in-page navigation)</span>
<a href="#l11.1960"></a><span id="l11.1960" class="difflineplus">+    if (hasExpectedURL(aEvent.originalTarget, this.__SS_restore_data.url)) {</span>
<a href="#l11.1961"></a><span id="l11.1961" class="difflineplus">+      var content = aEvent.originalTarget.defaultView;</span>
<a href="#l11.1962"></a><span id="l11.1962" class="difflineplus">+      if (this.currentURI.spec == &quot;about:config&quot;) {</span>
<a href="#l11.1963"></a><span id="l11.1963" class="difflineplus">+        // unwrap the document for about:config because otherwise the properties</span>
<a href="#l11.1964"></a><span id="l11.1964" class="difflineplus">+        // of the XBL bindings - as the textbox - aren't accessible (see bug 350718)</span>
<a href="#l11.1965"></a><span id="l11.1965" class="difflineplus">+        content = content.wrappedJSObject;</span>
<a href="#l11.1966"></a><span id="l11.1966" class="difflineplus">+      }</span>
<a href="#l11.1967"></a><span id="l11.1967" class="difflineplus">+      restoreTextDataAndScrolling(content, this.__SS_restore_data, &quot;&quot;);</span>
<a href="#l11.1968"></a><span id="l11.1968" class="difflineplus">+      this.markupDocumentViewer.authorStyleDisabled = selectedPageStyle == &quot;_nostyle&quot;;</span>
<a href="#l11.1969"></a><span id="l11.1969" class="difflineplus">+</span>
<a href="#l11.1970"></a><span id="l11.1970" class="difflineplus">+      // notify the tabbrowser that this document has been completely restored</span>
<a href="#l11.1971"></a><span id="l11.1971" class="difflineplus">+      var event = this.ownerDocument.createEvent(&quot;Events&quot;);</span>
<a href="#l11.1972"></a><span id="l11.1972" class="difflineplus">+      event.initEvent(&quot;SSTabRestored&quot;, true, false);</span>
<a href="#l11.1973"></a><span id="l11.1973" class="difflineplus">+      this.__SS_restore_tab.dispatchEvent(event);</span>
<a href="#l11.1974"></a><span id="l11.1974" class="difflineplus">+    }</span>
<a href="#l11.1975"></a><span id="l11.1975" class="difflineplus">+</span>
<a href="#l11.1976"></a><span id="l11.1976" class="difflineplus">+    this.removeEventListener(&quot;load&quot;, this.__SS_restore, true);</span>
<a href="#l11.1977"></a><span id="l11.1977" class="difflineplus">+    delete this.__SS_restore_data;</span>
<a href="#l11.1978"></a><span id="l11.1978" class="difflineplus">+    delete this.__SS_restore_text;</span>
<a href="#l11.1979"></a><span id="l11.1979" class="difflineplus">+    delete this.__SS_restore_pageStyle;</span>
<a href="#l11.1980"></a><span id="l11.1980" class="difflineplus">+    delete this.__SS_restore_tab;</span>
<a href="#l11.1981"></a><span id="l11.1981" class="difflineplus">+    delete this.__SS_restore;</span>
<a href="#l11.1982"></a><span id="l11.1982" class="difflineplus">+  },</span>
<a href="#l11.1983"></a><span id="l11.1983" class="difflineplus">+</span>
<a href="#l11.1984"></a><span id="l11.1984" class="difflineplus">+  /**</span>
<a href="#l11.1985"></a><span id="l11.1985" class="difflineplus">+   * Restore visibility and dimension features to a window</span>
<a href="#l11.1986"></a><span id="l11.1986" class="difflineplus">+   * @param aWindow</span>
<a href="#l11.1987"></a><span id="l11.1987" class="difflineplus">+   *        Window reference</span>
<a href="#l11.1988"></a><span id="l11.1988" class="difflineplus">+   * @param aWinData</span>
<a href="#l11.1989"></a><span id="l11.1989" class="difflineplus">+   *        Object containing session data for the window</span>
<a href="#l11.1990"></a><span id="l11.1990" class="difflineplus">+   */</span>
<a href="#l11.1991"></a><span id="l11.1991" class="difflineplus">+  restoreWindowFeatures: function sss_restoreWindowFeatures(aWindow, aWinData) {</span>
<a href="#l11.1992"></a><span id="l11.1992" class="difflineplus">+    var hidden = (aWinData.hidden)?aWinData.hidden.split(&quot;,&quot;):[];</span>
<a href="#l11.1993"></a><span id="l11.1993" class="difflineplus">+    WINDOW_HIDEABLE_FEATURES.forEach(function(aItem) {</span>
<a href="#l11.1994"></a><span id="l11.1994" class="difflineplus">+      aWindow[aItem].visible = hidden.indexOf(aItem) == -1;</span>
<a href="#l11.1995"></a><span id="l11.1995" class="difflineplus">+    });</span>
<a href="#l11.1996"></a><span id="l11.1996" class="difflineplus">+</span>
<a href="#l11.1997"></a><span id="l11.1997" class="difflineplus">+    if (aWinData.isPopup)</span>
<a href="#l11.1998"></a><span id="l11.1998" class="difflineplus">+      this._windows[aWindow.__SSi].isPopup = true;</span>
<a href="#l11.1999"></a><span id="l11.1999" class="difflineplus">+    else</span>
<a href="#l11.2000"></a><span id="l11.2000" class="difflineplus">+      delete this._windows[aWindow.__SSi].isPopup;</span>
<a href="#l11.2001"></a><span id="l11.2001" class="difflineplus">+</span>
<a href="#l11.2002"></a><span id="l11.2002" class="difflineplus">+    var _this = this;</span>
<a href="#l11.2003"></a><span id="l11.2003" class="difflineplus">+    aWindow.setTimeout(function() {</span>
<a href="#l11.2004"></a><span id="l11.2004" class="difflineplus">+      _this.restoreDimensions.apply(_this, [aWindow, aWinData.width || 0,</span>
<a href="#l11.2005"></a><span id="l11.2005" class="difflineplus">+        aWinData.height || 0, &quot;screenX&quot; in aWinData ? aWinData.screenX : NaN,</span>
<a href="#l11.2006"></a><span id="l11.2006" class="difflineplus">+        &quot;screenY&quot; in aWinData ? aWinData.screenY : NaN,</span>
<a href="#l11.2007"></a><span id="l11.2007" class="difflineplus">+        aWinData.sizemode || &quot;&quot;, aWinData.sidebar || &quot;&quot;]);</span>
<a href="#l11.2008"></a><span id="l11.2008" class="difflineplus">+    }, 0);</span>
<a href="#l11.2009"></a><span id="l11.2009" class="difflineplus">+  },</span>
<a href="#l11.2010"></a><span id="l11.2010" class="difflineplus">+</span>
<a href="#l11.2011"></a><span id="l11.2011" class="difflineplus">+  /**</span>
<a href="#l11.2012"></a><span id="l11.2012" class="difflineplus">+   * Restore a window's dimensions</span>
<a href="#l11.2013"></a><span id="l11.2013" class="difflineplus">+   * @param aWidth</span>
<a href="#l11.2014"></a><span id="l11.2014" class="difflineplus">+   *        Window width</span>
<a href="#l11.2015"></a><span id="l11.2015" class="difflineplus">+   * @param aHeight</span>
<a href="#l11.2016"></a><span id="l11.2016" class="difflineplus">+   *        Window height</span>
<a href="#l11.2017"></a><span id="l11.2017" class="difflineplus">+   * @param aLeft</span>
<a href="#l11.2018"></a><span id="l11.2018" class="difflineplus">+   *        Window left</span>
<a href="#l11.2019"></a><span id="l11.2019" class="difflineplus">+   * @param aTop</span>
<a href="#l11.2020"></a><span id="l11.2020" class="difflineplus">+   *        Window top</span>
<a href="#l11.2021"></a><span id="l11.2021" class="difflineplus">+   * @param aSizeMode</span>
<a href="#l11.2022"></a><span id="l11.2022" class="difflineplus">+   *        Window size mode (eg: maximized)</span>
<a href="#l11.2023"></a><span id="l11.2023" class="difflineplus">+   * @param aSidebar</span>
<a href="#l11.2024"></a><span id="l11.2024" class="difflineplus">+   *        Sidebar command</span>
<a href="#l11.2025"></a><span id="l11.2025" class="difflineplus">+   */</span>
<a href="#l11.2026"></a><span id="l11.2026" class="difflineplus">+  restoreDimensions: function sss_restoreDimensions(aWindow, aWidth, aHeight, aLeft, aTop, aSizeMode, aSidebar) {</span>
<a href="#l11.2027"></a><span id="l11.2027" class="difflineplus">+    var win = aWindow;</span>
<a href="#l11.2028"></a><span id="l11.2028" class="difflineplus">+    var _this = this;</span>
<a href="#l11.2029"></a><span id="l11.2029" class="difflineplus">+    function win_(aName) { return _this._getWindowDimension(win, aName); }</span>
<a href="#l11.2030"></a><span id="l11.2030" class="difflineplus">+</span>
<a href="#l11.2031"></a><span id="l11.2031" class="difflineplus">+    // only modify those aspects which aren't correct yet</span>
<a href="#l11.2032"></a><span id="l11.2032" class="difflineplus">+    if (aWidth &amp;&amp; aHeight &amp;&amp; (aWidth != win_(&quot;width&quot;) || aHeight != win_(&quot;height&quot;))) {</span>
<a href="#l11.2033"></a><span id="l11.2033" class="difflineplus">+      aWindow.resizeTo(aWidth, aHeight);</span>
<a href="#l11.2034"></a><span id="l11.2034" class="difflineplus">+    }</span>
<a href="#l11.2035"></a><span id="l11.2035" class="difflineplus">+    if (!isNaN(aLeft) &amp;&amp; !isNaN(aTop) &amp;&amp; (aLeft != win_(&quot;screenX&quot;) || aTop != win_(&quot;screenY&quot;))) {</span>
<a href="#l11.2036"></a><span id="l11.2036" class="difflineplus">+      aWindow.moveTo(aLeft, aTop);</span>
<a href="#l11.2037"></a><span id="l11.2037" class="difflineplus">+    }</span>
<a href="#l11.2038"></a><span id="l11.2038" class="difflineplus">+    if (aSizeMode == &quot;maximized&quot; &amp;&amp; win_(&quot;sizemode&quot;) != &quot;maximized&quot;) {</span>
<a href="#l11.2039"></a><span id="l11.2039" class="difflineplus">+      aWindow.maximize();</span>
<a href="#l11.2040"></a><span id="l11.2040" class="difflineplus">+    }</span>
<a href="#l11.2041"></a><span id="l11.2041" class="difflineplus">+    else if (aSizeMode &amp;&amp; aSizeMode != &quot;maximized&quot; &amp;&amp; win_(&quot;sizemode&quot;) != &quot;normal&quot;) {</span>
<a href="#l11.2042"></a><span id="l11.2042" class="difflineplus">+      aWindow.restore();</span>
<a href="#l11.2043"></a><span id="l11.2043" class="difflineplus">+    }</span>
<a href="#l11.2044"></a><span id="l11.2044" class="difflineplus">+    var sidebar = aWindow.document.getElementById(&quot;sidebar-box&quot;);</span>
<a href="#l11.2045"></a><span id="l11.2045" class="difflineplus">+    if (sidebar.getAttribute(&quot;sidebarcommand&quot;) != aSidebar) {</span>
<a href="#l11.2046"></a><span id="l11.2046" class="difflineplus">+      aWindow.toggleSidebar(aSidebar);</span>
<a href="#l11.2047"></a><span id="l11.2047" class="difflineplus">+    }</span>
<a href="#l11.2048"></a><span id="l11.2048" class="difflineplus">+    // since resizing/moving a window brings it to the foreground,</span>
<a href="#l11.2049"></a><span id="l11.2049" class="difflineplus">+    // we might want to re-focus the last focused window</span>
<a href="#l11.2050"></a><span id="l11.2050" class="difflineplus">+    if (this.windowToFocus) {</span>
<a href="#l11.2051"></a><span id="l11.2051" class="difflineplus">+      this.windowToFocus.focus();</span>
<a href="#l11.2052"></a><span id="l11.2052" class="difflineplus">+    }</span>
<a href="#l11.2053"></a><span id="l11.2053" class="difflineplus">+  },</span>
<a href="#l11.2054"></a><span id="l11.2054" class="difflineplus">+</span>
<a href="#l11.2055"></a><span id="l11.2055" class="difflineplus">+  /**</span>
<a href="#l11.2056"></a><span id="l11.2056" class="difflineplus">+   * Restores cookies (accepting both Firefox 2.0 and current format)</span>
<a href="#l11.2057"></a><span id="l11.2057" class="difflineplus">+   * @param aCookies</span>
<a href="#l11.2058"></a><span id="l11.2058" class="difflineplus">+   *        Array of cookie objects</span>
<a href="#l11.2059"></a><span id="l11.2059" class="difflineplus">+   */</span>
<a href="#l11.2060"></a><span id="l11.2060" class="difflineplus">+  restoreCookies: function sss_restoreCookies(aCookies) {</span>
<a href="#l11.2061"></a><span id="l11.2061" class="difflineplus">+    if (aCookies.count &amp;&amp; aCookies.domain1) {</span>
<a href="#l11.2062"></a><span id="l11.2062" class="difflineplus">+      // convert to the new cookie serialization format</span>
<a href="#l11.2063"></a><span id="l11.2063" class="difflineplus">+      var converted = [];</span>
<a href="#l11.2064"></a><span id="l11.2064" class="difflineplus">+      for (var i = 1; i &lt;= aCookies.count; i++) {</span>
<a href="#l11.2065"></a><span id="l11.2065" class="difflineplus">+        // for simplicity we only accept the format we produced ourselves</span>
<a href="#l11.2066"></a><span id="l11.2066" class="difflineplus">+        var parsed = aCookies[&quot;value&quot; + i].match(/^([^=;]+)=([^;]*);(?:domain=[^;]+;)?(?:path=([^;]*);)?(secure;)?(httponly;)?/);</span>
<a href="#l11.2067"></a><span id="l11.2067" class="difflineplus">+        if (parsed &amp;&amp; /^https?:\/\/([^\/]+)/.test(aCookies[&quot;domain&quot; + i]))</span>
<a href="#l11.2068"></a><span id="l11.2068" class="difflineplus">+          converted.push({</span>
<a href="#l11.2069"></a><span id="l11.2069" class="difflineplus">+            host: RegExp.$1, path: parsed[3], name: parsed[1], value: parsed[2],</span>
<a href="#l11.2070"></a><span id="l11.2070" class="difflineplus">+            secure: parsed[4], httponly: parsed[5]</span>
<a href="#l11.2071"></a><span id="l11.2071" class="difflineplus">+          });</span>
<a href="#l11.2072"></a><span id="l11.2072" class="difflineplus">+      }</span>
<a href="#l11.2073"></a><span id="l11.2073" class="difflineplus">+      aCookies = converted;</span>
<a href="#l11.2074"></a><span id="l11.2074" class="difflineplus">+    }</span>
<a href="#l11.2075"></a><span id="l11.2075" class="difflineplus">+</span>
<a href="#l11.2076"></a><span id="l11.2076" class="difflineplus">+    var cookieManager = Components.classes[&quot;@mozilla.org/cookiemanager;1&quot;]</span>
<a href="#l11.2077"></a><span id="l11.2077" class="difflineplus">+                                  .getService(Components.interfaces.nsICookieManager2);</span>
<a href="#l11.2078"></a><span id="l11.2078" class="difflineplus">+    // MAX_EXPIRY should be 2^63-1, but JavaScript can't handle that precision</span>
<a href="#l11.2079"></a><span id="l11.2079" class="difflineplus">+    var MAX_EXPIRY = Math.pow(2, 62);</span>
<a href="#l11.2080"></a><span id="l11.2080" class="difflineplus">+    for (i = 0; i &lt; aCookies.length; i++) {</span>
<a href="#l11.2081"></a><span id="l11.2081" class="difflineplus">+      var cookie = aCookies[i];</span>
<a href="#l11.2082"></a><span id="l11.2082" class="difflineplus">+      try {</span>
<a href="#l11.2083"></a><span id="l11.2083" class="difflineplus">+        cookieManager.add(cookie.host, cookie.path || &quot;&quot;, cookie.name || &quot;&quot;, cookie.value, !!cookie.secure, !!cookie.httponly, true, &quot;expiry&quot; in cookie ? cookie.expiry : MAX_EXPIRY);</span>
<a href="#l11.2084"></a><span id="l11.2084" class="difflineplus">+      }</span>
<a href="#l11.2085"></a><span id="l11.2085" class="difflineplus">+      catch (ex) { Components.utils.reportError(ex); } // don't let a single cookie stop recovering</span>
<a href="#l11.2086"></a><span id="l11.2086" class="difflineplus">+    }</span>
<a href="#l11.2087"></a><span id="l11.2087" class="difflineplus">+  },</span>
<a href="#l11.2088"></a><span id="l11.2088" class="difflineplus">+</span>
<a href="#l11.2089"></a><span id="l11.2089" class="difflineplus">+/* ........ Disk Access .............. */</span>
<a href="#l11.2090"></a><span id="l11.2090" class="difflineplus">+</span>
<a href="#l11.2091"></a><span id="l11.2091" class="difflineplus">+  /**</span>
<a href="#l11.2092"></a><span id="l11.2092" class="difflineplus">+   * save state delayed by N ms</span>
<a href="#l11.2093"></a><span id="l11.2093" class="difflineplus">+   * marks window as dirty (i.e. data update can't be skipped)</span>
<a href="#l11.2094"></a><span id="l11.2094" class="difflineplus">+   * @param aWindow</span>
<a href="#l11.2095"></a><span id="l11.2095" class="difflineplus">+   *        Window reference</span>
<a href="#l11.2096"></a><span id="l11.2096" class="difflineplus">+   * @param aDelay</span>
<a href="#l11.2097"></a><span id="l11.2097" class="difflineplus">+   *        Milliseconds to delay</span>
<a href="#l11.2098"></a><span id="l11.2098" class="difflineplus">+   */</span>
<a href="#l11.2099"></a><span id="l11.2099" class="difflineplus">+  saveStateDelayed: function sss_saveStateDelayed(aWindow, aDelay) {</span>
<a href="#l11.2100"></a><span id="l11.2100" class="difflineplus">+    if (aWindow) {</span>
<a href="#l11.2101"></a><span id="l11.2101" class="difflineplus">+      this._dirtyWindows[aWindow.__SSi] = true;</span>
<a href="#l11.2102"></a><span id="l11.2102" class="difflineplus">+    }</span>
<a href="#l11.2103"></a><span id="l11.2103" class="difflineplus">+</span>
<a href="#l11.2104"></a><span id="l11.2104" class="difflineplus">+    if (!this._saveTimer &amp;&amp; this._resume_from_crash) {</span>
<a href="#l11.2105"></a><span id="l11.2105" class="difflineplus">+      // interval until the next disk operation is allowed</span>
<a href="#l11.2106"></a><span id="l11.2106" class="difflineplus">+      var minimalDelay = this._lastSaveTime + this._interval - Date.now();</span>
<a href="#l11.2107"></a><span id="l11.2107" class="difflineplus">+</span>
<a href="#l11.2108"></a><span id="l11.2108" class="difflineplus">+      // if we have to wait, set a timer, otherwise saveState directly</span>
<a href="#l11.2109"></a><span id="l11.2109" class="difflineplus">+      aDelay = Math.max(minimalDelay, aDelay || 2000);</span>
<a href="#l11.2110"></a><span id="l11.2110" class="difflineplus">+      if (aDelay &gt; 0) {</span>
<a href="#l11.2111"></a><span id="l11.2111" class="difflineplus">+        this._saveTimer = Components.classes[&quot;@mozilla.org/timer;1&quot;].createInstance(Components.interfaces.nsITimer);</span>
<a href="#l11.2112"></a><span id="l11.2112" class="difflineplus">+        this._saveTimer.init(this, aDelay, Components.interfaces.nsITimer.TYPE_ONE_SHOT);</span>
<a href="#l11.2113"></a><span id="l11.2113" class="difflineplus">+      }</span>
<a href="#l11.2114"></a><span id="l11.2114" class="difflineplus">+      else {</span>
<a href="#l11.2115"></a><span id="l11.2115" class="difflineplus">+        this.saveState();</span>
<a href="#l11.2116"></a><span id="l11.2116" class="difflineplus">+      }</span>
<a href="#l11.2117"></a><span id="l11.2117" class="difflineplus">+    }</span>
<a href="#l11.2118"></a><span id="l11.2118" class="difflineplus">+  },</span>
<a href="#l11.2119"></a><span id="l11.2119" class="difflineplus">+</span>
<a href="#l11.2120"></a><span id="l11.2120" class="difflineplus">+  /**</span>
<a href="#l11.2121"></a><span id="l11.2121" class="difflineplus">+   * save state to disk</span>
<a href="#l11.2122"></a><span id="l11.2122" class="difflineplus">+   * @param aUpdateAll</span>
<a href="#l11.2123"></a><span id="l11.2123" class="difflineplus">+   *        Bool update all windows</span>
<a href="#l11.2124"></a><span id="l11.2124" class="difflineplus">+   */</span>
<a href="#l11.2125"></a><span id="l11.2125" class="difflineplus">+  saveState: function sss_saveState(aUpdateAll) {</span>
<a href="#l11.2126"></a><span id="l11.2126" class="difflineplus">+    // if crash recovery is disabled, only save session resuming information</span>
<a href="#l11.2127"></a><span id="l11.2127" class="difflineplus">+    if (!this._resume_from_crash &amp;&amp; this._loadState == STATE_RUNNING)</span>
<a href="#l11.2128"></a><span id="l11.2128" class="difflineplus">+      return;</span>
<a href="#l11.2129"></a><span id="l11.2129" class="difflineplus">+</span>
<a href="#l11.2130"></a><span id="l11.2130" class="difflineplus">+    var oState = this._getCurrentState(aUpdateAll);</span>
<a href="#l11.2131"></a><span id="l11.2131" class="difflineplus">+    oState.session = { state: ((this._loadState == STATE_RUNNING) ? STATE_RUNNING_STR : STATE_STOPPED_STR) };</span>
<a href="#l11.2132"></a><span id="l11.2132" class="difflineplus">+</span>
<a href="#l11.2133"></a><span id="l11.2133" class="difflineplus">+    var stateString = Components.classes[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l11.2134"></a><span id="l11.2134" class="difflineplus">+                                .createInstance(Components.interfaces.nsISupportsString);</span>
<a href="#l11.2135"></a><span id="l11.2135" class="difflineplus">+    stateString.data = oState.toSource();</span>
<a href="#l11.2136"></a><span id="l11.2136" class="difflineplus">+</span>
<a href="#l11.2137"></a><span id="l11.2137" class="difflineplus">+    var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l11.2138"></a><span id="l11.2138" class="difflineplus">+                                    .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l11.2139"></a><span id="l11.2139" class="difflineplus">+    observerService.notifyObservers(stateString, &quot;sessionstore-state-write&quot;, &quot;&quot;);</span>
<a href="#l11.2140"></a><span id="l11.2140" class="difflineplus">+</span>
<a href="#l11.2141"></a><span id="l11.2141" class="difflineplus">+    // don't touch the file if an observer has deleted all state data</span>
<a href="#l11.2142"></a><span id="l11.2142" class="difflineplus">+    if (stateString.data)</span>
<a href="#l11.2143"></a><span id="l11.2143" class="difflineplus">+      this._writeFile(this._sessionFile, stateString.data);</span>
<a href="#l11.2144"></a><span id="l11.2144" class="difflineplus">+</span>
<a href="#l11.2145"></a><span id="l11.2145" class="difflineplus">+    this._lastSaveTime = Date.now();</span>
<a href="#l11.2146"></a><span id="l11.2146" class="difflineplus">+  },</span>
<a href="#l11.2147"></a><span id="l11.2147" class="difflineplus">+</span>
<a href="#l11.2148"></a><span id="l11.2148" class="difflineplus">+  /**</span>
<a href="#l11.2149"></a><span id="l11.2149" class="difflineplus">+   * delete session datafile and backup</span>
<a href="#l11.2150"></a><span id="l11.2150" class="difflineplus">+   */</span>
<a href="#l11.2151"></a><span id="l11.2151" class="difflineplus">+  _clearDisk: function sss_clearDisk() {</span>
<a href="#l11.2152"></a><span id="l11.2152" class="difflineplus">+    if (this._sessionFile.exists()) {</span>
<a href="#l11.2153"></a><span id="l11.2153" class="difflineplus">+      try {</span>
<a href="#l11.2154"></a><span id="l11.2154" class="difflineplus">+        this._sessionFile.remove(false);</span>
<a href="#l11.2155"></a><span id="l11.2155" class="difflineplus">+      }</span>
<a href="#l11.2156"></a><span id="l11.2156" class="difflineplus">+      catch (ex) { dump(ex + '\n'); } // couldn't remove the file - what now?</span>
<a href="#l11.2157"></a><span id="l11.2157" class="difflineplus">+    }</span>
<a href="#l11.2158"></a><span id="l11.2158" class="difflineplus">+    if (this._sessionFileBackup.exists()) {</span>
<a href="#l11.2159"></a><span id="l11.2159" class="difflineplus">+      try {</span>
<a href="#l11.2160"></a><span id="l11.2160" class="difflineplus">+        this._sessionFileBackup.remove(false);</span>
<a href="#l11.2161"></a><span id="l11.2161" class="difflineplus">+      }</span>
<a href="#l11.2162"></a><span id="l11.2162" class="difflineplus">+      catch (ex) { dump(ex + '\n'); } // couldn't remove the file - what now?</span>
<a href="#l11.2163"></a><span id="l11.2163" class="difflineplus">+    }</span>
<a href="#l11.2164"></a><span id="l11.2164" class="difflineplus">+  },</span>
<a href="#l11.2165"></a><span id="l11.2165" class="difflineplus">+</span>
<a href="#l11.2166"></a><span id="l11.2166" class="difflineplus">+/* ........ Auxiliary Functions .............. */</span>
<a href="#l11.2167"></a><span id="l11.2167" class="difflineplus">+</span>
<a href="#l11.2168"></a><span id="l11.2168" class="difflineplus">+  /**</span>
<a href="#l11.2169"></a><span id="l11.2169" class="difflineplus">+   * call a callback for all currently opened browser windows</span>
<a href="#l11.2170"></a><span id="l11.2170" class="difflineplus">+   * (might miss the most recent one)</span>
<a href="#l11.2171"></a><span id="l11.2171" class="difflineplus">+   * @param aFunc</span>
<a href="#l11.2172"></a><span id="l11.2172" class="difflineplus">+   *        Callback each window is passed to</span>
<a href="#l11.2173"></a><span id="l11.2173" class="difflineplus">+   */</span>
<a href="#l11.2174"></a><span id="l11.2174" class="difflineplus">+  _forEachBrowserWindow: function sss_forEachBrowserWindow(aFunc) {</span>
<a href="#l11.2175"></a><span id="l11.2175" class="difflineplus">+    var windowMediator = Components.classes[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l11.2176"></a><span id="l11.2176" class="difflineplus">+                                   .getService(Components.interfaces.nsIWindowMediator);</span>
<a href="#l11.2177"></a><span id="l11.2177" class="difflineplus">+    var windowsEnum = windowMediator.getEnumerator(&quot;navigator:browser&quot;);</span>
<a href="#l11.2178"></a><span id="l11.2178" class="difflineplus">+</span>
<a href="#l11.2179"></a><span id="l11.2179" class="difflineplus">+    while (windowsEnum.hasMoreElements()) {</span>
<a href="#l11.2180"></a><span id="l11.2180" class="difflineplus">+      var window = windowsEnum.getNext();</span>
<a href="#l11.2181"></a><span id="l11.2181" class="difflineplus">+      if (window.__SSi) {</span>
<a href="#l11.2182"></a><span id="l11.2182" class="difflineplus">+        aFunc.call(this, window);</span>
<a href="#l11.2183"></a><span id="l11.2183" class="difflineplus">+      }</span>
<a href="#l11.2184"></a><span id="l11.2184" class="difflineplus">+    }</span>
<a href="#l11.2185"></a><span id="l11.2185" class="difflineplus">+  },</span>
<a href="#l11.2186"></a><span id="l11.2186" class="difflineplus">+</span>
<a href="#l11.2187"></a><span id="l11.2187" class="difflineplus">+  /**</span>
<a href="#l11.2188"></a><span id="l11.2188" class="difflineplus">+   * Returns most recent window</span>
<a href="#l11.2189"></a><span id="l11.2189" class="difflineplus">+   * @returns Window reference</span>
<a href="#l11.2190"></a><span id="l11.2190" class="difflineplus">+   */</span>
<a href="#l11.2191"></a><span id="l11.2191" class="difflineplus">+  _getMostRecentBrowserWindow: function sss_getMostRecentBrowserWindow() {</span>
<a href="#l11.2192"></a><span id="l11.2192" class="difflineplus">+    var windowMediator = Components.classes[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l11.2193"></a><span id="l11.2193" class="difflineplus">+                                   .getService(Components.interfaces.nsIWindowMediator);</span>
<a href="#l11.2194"></a><span id="l11.2194" class="difflineplus">+    return windowMediator.getMostRecentWindow(&quot;navigator:browser&quot;);</span>
<a href="#l11.2195"></a><span id="l11.2195" class="difflineplus">+  },</span>
<a href="#l11.2196"></a><span id="l11.2196" class="difflineplus">+</span>
<a href="#l11.2197"></a><span id="l11.2197" class="difflineplus">+  /**</span>
<a href="#l11.2198"></a><span id="l11.2198" class="difflineplus">+   * open a new browser window for a given session state</span>
<a href="#l11.2199"></a><span id="l11.2199" class="difflineplus">+   * called when restoring a multi-window session</span>
<a href="#l11.2200"></a><span id="l11.2200" class="difflineplus">+   * @param aState</span>
<a href="#l11.2201"></a><span id="l11.2201" class="difflineplus">+   *        Object containing session data</span>
<a href="#l11.2202"></a><span id="l11.2202" class="difflineplus">+   */</span>
<a href="#l11.2203"></a><span id="l11.2203" class="difflineplus">+  _openWindowWithState: function sss_openWindowWithState(aState) {</span>
<a href="#l11.2204"></a><span id="l11.2204" class="difflineplus">+    var argString = Components.classes[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l11.2205"></a><span id="l11.2205" class="difflineplus">+                              .createInstance(Components.interfaces.nsISupportsString);</span>
<a href="#l11.2206"></a><span id="l11.2206" class="difflineplus">+    argString.data = &quot;about:blank&quot;;</span>
<a href="#l11.2207"></a><span id="l11.2207" class="difflineplus">+</span>
<a href="#l11.2208"></a><span id="l11.2208" class="difflineplus">+    //XXXzeniko shouldn't it be possible to set the window's dimensions here (as feature)?</span>
<a href="#l11.2209"></a><span id="l11.2209" class="difflineplus">+    var window = Components.classes[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l11.2210"></a><span id="l11.2210" class="difflineplus">+                           .getService(Components.interfaces.nsIWindowWatcher)</span>
<a href="#l11.2211"></a><span id="l11.2211" class="difflineplus">+                           .openWindow(null, this._prefBranch.getCharPref(&quot;chromeURL&quot;), &quot;_blank&quot;,</span>
<a href="#l11.2212"></a><span id="l11.2212" class="difflineplus">+                            &quot;chrome,dialog=no,all&quot;, argString);</span>
<a href="#l11.2213"></a><span id="l11.2213" class="difflineplus">+</span>
<a href="#l11.2214"></a><span id="l11.2214" class="difflineplus">+    window.__SS_state = aState;</span>
<a href="#l11.2215"></a><span id="l11.2215" class="difflineplus">+    var _this = this;</span>
<a href="#l11.2216"></a><span id="l11.2216" class="difflineplus">+    window.addEventListener(&quot;load&quot;, function(aEvent) {</span>
<a href="#l11.2217"></a><span id="l11.2217" class="difflineplus">+      aEvent.currentTarget.removeEventListener(&quot;load&quot;, arguments.callee, true);</span>
<a href="#l11.2218"></a><span id="l11.2218" class="difflineplus">+      _this.restoreWindow(aEvent.currentTarget, aEvent.currentTarget.__SS_state, true, true);</span>
<a href="#l11.2219"></a><span id="l11.2219" class="difflineplus">+      delete aEvent.currentTarget.__SS_state;</span>
<a href="#l11.2220"></a><span id="l11.2220" class="difflineplus">+    }, true);</span>
<a href="#l11.2221"></a><span id="l11.2221" class="difflineplus">+</span>
<a href="#l11.2222"></a><span id="l11.2222" class="difflineplus">+    return window;</span>
<a href="#l11.2223"></a><span id="l11.2223" class="difflineplus">+  },</span>
<a href="#l11.2224"></a><span id="l11.2224" class="difflineplus">+</span>
<a href="#l11.2225"></a><span id="l11.2225" class="difflineplus">+  /**</span>
<a href="#l11.2226"></a><span id="l11.2226" class="difflineplus">+   * Whether or not to resume session, if not recovering from a crash.</span>
<a href="#l11.2227"></a><span id="l11.2227" class="difflineplus">+   * @returns bool</span>
<a href="#l11.2228"></a><span id="l11.2228" class="difflineplus">+   */</span>
<a href="#l11.2229"></a><span id="l11.2229" class="difflineplus">+  _doResumeSession: function sss_doResumeSession() {</span>
<a href="#l11.2230"></a><span id="l11.2230" class="difflineplus">+    return this._prefBranch.getIntPref(&quot;startup.page&quot;) == 3 ||</span>
<a href="#l11.2231"></a><span id="l11.2231" class="difflineplus">+      this._prefBranch.getBoolPref(&quot;sessionstore.resume_session_once&quot;);</span>
<a href="#l11.2232"></a><span id="l11.2232" class="difflineplus">+  },</span>
<a href="#l11.2233"></a><span id="l11.2233" class="difflineplus">+</span>
<a href="#l11.2234"></a><span id="l11.2234" class="difflineplus">+  /**</span>
<a href="#l11.2235"></a><span id="l11.2235" class="difflineplus">+   * whether the user wants to load any other page at startup</span>
<a href="#l11.2236"></a><span id="l11.2236" class="difflineplus">+   * (except the homepage) - needed for determining whether to overwrite the current tabs</span>
<a href="#l11.2237"></a><span id="l11.2237" class="difflineplus">+   * C.f.: nsBrowserContentHandler's defaultArgs implementation.</span>
<a href="#l11.2238"></a><span id="l11.2238" class="difflineplus">+   * @returns bool</span>
<a href="#l11.2239"></a><span id="l11.2239" class="difflineplus">+   */</span>
<a href="#l11.2240"></a><span id="l11.2240" class="difflineplus">+  _isCmdLineEmpty: function sss_isCmdLineEmpty(aWindow) {</span>
<a href="#l11.2241"></a><span id="l11.2241" class="difflineplus">+    return &quot;arguments&quot; in aWindow &amp;&amp; aWindow.arguments.length &amp;&amp;</span>
<a href="#l11.2242"></a><span id="l11.2242" class="difflineplus">+      aWindow.arguments[0] == &quot;about:blank&quot;;</span>
<a href="#l11.2243"></a><span id="l11.2243" class="difflineplus">+  },</span>
<a href="#l11.2244"></a><span id="l11.2244" class="difflineplus">+</span>
<a href="#l11.2245"></a><span id="l11.2245" class="difflineplus">+  /**</span>
<a href="#l11.2246"></a><span id="l11.2246" class="difflineplus">+   * don't save sensitive data if the user doesn't want to</span>
<a href="#l11.2247"></a><span id="l11.2247" class="difflineplus">+   * (distinguishes between encrypted and non-encrypted sites)</span>
<a href="#l11.2248"></a><span id="l11.2248" class="difflineplus">+   * @param aIsHTTPS</span>
<a href="#l11.2249"></a><span id="l11.2249" class="difflineplus">+   *        Bool is encrypted</span>
<a href="#l11.2250"></a><span id="l11.2250" class="difflineplus">+   * @returns bool</span>
<a href="#l11.2251"></a><span id="l11.2251" class="difflineplus">+   */</span>
<a href="#l11.2252"></a><span id="l11.2252" class="difflineplus">+  _checkPrivacyLevel: function sss_checkPrivacyLevel(aIsHTTPS) {</span>
<a href="#l11.2253"></a><span id="l11.2253" class="difflineplus">+    return this._prefBranch.getIntPref(&quot;sessionstore.privacy_level&quot;) &lt; (aIsHTTPS ? PRIVACY_ENCRYPTED : PRIVACY_FULL);</span>
<a href="#l11.2254"></a><span id="l11.2254" class="difflineplus">+  },</span>
<a href="#l11.2255"></a><span id="l11.2255" class="difflineplus">+</span>
<a href="#l11.2256"></a><span id="l11.2256" class="difflineplus">+  /**</span>
<a href="#l11.2257"></a><span id="l11.2257" class="difflineplus">+   * on popup windows, the XULWindow's attributes seem not to be set correctly</span>
<a href="#l11.2258"></a><span id="l11.2258" class="difflineplus">+   * we use thus JSDOMWindow attributes for sizemode and normal window attributes</span>
<a href="#l11.2259"></a><span id="l11.2259" class="difflineplus">+   * (and hope for reasonable values when maximized/minimized - since then</span>
<a href="#l11.2260"></a><span id="l11.2260" class="difflineplus">+   * outerWidth/outerHeight aren't the dimensions of the restored window)</span>
<a href="#l11.2261"></a><span id="l11.2261" class="difflineplus">+   * @param aWindow</span>
<a href="#l11.2262"></a><span id="l11.2262" class="difflineplus">+   *        Window reference</span>
<a href="#l11.2263"></a><span id="l11.2263" class="difflineplus">+   * @param aAttribute</span>
<a href="#l11.2264"></a><span id="l11.2264" class="difflineplus">+   *        String sizemode | width | height | other window attribute</span>
<a href="#l11.2265"></a><span id="l11.2265" class="difflineplus">+   * @returns string</span>
<a href="#l11.2266"></a><span id="l11.2266" class="difflineplus">+   */</span>
<a href="#l11.2267"></a><span id="l11.2267" class="difflineplus">+  _getWindowDimension: function sss_getWindowDimension(aWindow, aAttribute) {</span>
<a href="#l11.2268"></a><span id="l11.2268" class="difflineplus">+    if (aAttribute == &quot;sizemode&quot;) {</span>
<a href="#l11.2269"></a><span id="l11.2269" class="difflineplus">+      switch (aWindow.windowState) {</span>
<a href="#l11.2270"></a><span id="l11.2270" class="difflineplus">+      case aWindow.STATE_MAXIMIZED:</span>
<a href="#l11.2271"></a><span id="l11.2271" class="difflineplus">+        return &quot;maximized&quot;;</span>
<a href="#l11.2272"></a><span id="l11.2272" class="difflineplus">+      case aWindow.STATE_MINIMIZED:</span>
<a href="#l11.2273"></a><span id="l11.2273" class="difflineplus">+        return &quot;minimized&quot;;</span>
<a href="#l11.2274"></a><span id="l11.2274" class="difflineplus">+      default:</span>
<a href="#l11.2275"></a><span id="l11.2275" class="difflineplus">+        return &quot;normal&quot;;</span>
<a href="#l11.2276"></a><span id="l11.2276" class="difflineplus">+      }</span>
<a href="#l11.2277"></a><span id="l11.2277" class="difflineplus">+    }</span>
<a href="#l11.2278"></a><span id="l11.2278" class="difflineplus">+</span>
<a href="#l11.2279"></a><span id="l11.2279" class="difflineplus">+    var dimension;</span>
<a href="#l11.2280"></a><span id="l11.2280" class="difflineplus">+    switch (aAttribute) {</span>
<a href="#l11.2281"></a><span id="l11.2281" class="difflineplus">+    case &quot;width&quot;:</span>
<a href="#l11.2282"></a><span id="l11.2282" class="difflineplus">+      dimension = aWindow.outerWidth;</span>
<a href="#l11.2283"></a><span id="l11.2283" class="difflineplus">+      break;</span>
<a href="#l11.2284"></a><span id="l11.2284" class="difflineplus">+    case &quot;height&quot;:</span>
<a href="#l11.2285"></a><span id="l11.2285" class="difflineplus">+      dimension = aWindow.outerHeight;</span>
<a href="#l11.2286"></a><span id="l11.2286" class="difflineplus">+      break;</span>
<a href="#l11.2287"></a><span id="l11.2287" class="difflineplus">+    default:</span>
<a href="#l11.2288"></a><span id="l11.2288" class="difflineplus">+      dimension = aAttribute in aWindow ? aWindow[aAttribute] : &quot;&quot;;</span>
<a href="#l11.2289"></a><span id="l11.2289" class="difflineplus">+      break;</span>
<a href="#l11.2290"></a><span id="l11.2290" class="difflineplus">+    }</span>
<a href="#l11.2291"></a><span id="l11.2291" class="difflineplus">+</span>
<a href="#l11.2292"></a><span id="l11.2292" class="difflineplus">+    if (aWindow.windowState == aWindow.STATE_NORMAL) {</span>
<a href="#l11.2293"></a><span id="l11.2293" class="difflineplus">+      return dimension;</span>
<a href="#l11.2294"></a><span id="l11.2294" class="difflineplus">+    }</span>
<a href="#l11.2295"></a><span id="l11.2295" class="difflineplus">+    return aWindow.document.documentElement.getAttribute(aAttribute) || dimension;</span>
<a href="#l11.2296"></a><span id="l11.2296" class="difflineplus">+  },</span>
<a href="#l11.2297"></a><span id="l11.2297" class="difflineplus">+</span>
<a href="#l11.2298"></a><span id="l11.2298" class="difflineplus">+  /**</span>
<a href="#l11.2299"></a><span id="l11.2299" class="difflineplus">+   * Convenience method to get localized string bundles</span>
<a href="#l11.2300"></a><span id="l11.2300" class="difflineplus">+   * @param aURI</span>
<a href="#l11.2301"></a><span id="l11.2301" class="difflineplus">+   * @returns nsIStringBundle</span>
<a href="#l11.2302"></a><span id="l11.2302" class="difflineplus">+   */</span>
<a href="#l11.2303"></a><span id="l11.2303" class="difflineplus">+  _getStringBundle: function sss_getStringBundle(aURI) {</span>
<a href="#l11.2304"></a><span id="l11.2304" class="difflineplus">+     var bundleService = Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l11.2305"></a><span id="l11.2305" class="difflineplus">+                                   .getService(Components.interfaces.nsIStringBundleService);</span>
<a href="#l11.2306"></a><span id="l11.2306" class="difflineplus">+     var appLocale = Components.classes[&quot;@mozilla.org/intl/nslocaleservice;1&quot;]</span>
<a href="#l11.2307"></a><span id="l11.2307" class="difflineplus">+                               .getService(Components.interfaces.nsILocaleService).getApplicationLocale();</span>
<a href="#l11.2308"></a><span id="l11.2308" class="difflineplus">+     return bundleService.createBundle(aURI, appLocale);</span>
<a href="#l11.2309"></a><span id="l11.2309" class="difflineplus">+  },</span>
<a href="#l11.2310"></a><span id="l11.2310" class="difflineplus">+</span>
<a href="#l11.2311"></a><span id="l11.2311" class="difflineplus">+  /**</span>
<a href="#l11.2312"></a><span id="l11.2312" class="difflineplus">+   * Get nsIURI from string</span>
<a href="#l11.2313"></a><span id="l11.2313" class="difflineplus">+   * @param string</span>
<a href="#l11.2314"></a><span id="l11.2314" class="difflineplus">+   * @returns nsIURI</span>
<a href="#l11.2315"></a><span id="l11.2315" class="difflineplus">+   */</span>
<a href="#l11.2316"></a><span id="l11.2316" class="difflineplus">+  _getURIFromString: function sss_getURIFromString(aString) {</span>
<a href="#l11.2317"></a><span id="l11.2317" class="difflineplus">+    var ioService = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l11.2318"></a><span id="l11.2318" class="difflineplus">+                              .getService(Components.interfaces.nsIIOService);</span>
<a href="#l11.2319"></a><span id="l11.2319" class="difflineplus">+    return ioService.newURI(aString, null, null);</span>
<a href="#l11.2320"></a><span id="l11.2320" class="difflineplus">+  },</span>
<a href="#l11.2321"></a><span id="l11.2321" class="difflineplus">+</span>
<a href="#l11.2322"></a><span id="l11.2322" class="difflineplus">+  /**</span>
<a href="#l11.2323"></a><span id="l11.2323" class="difflineplus">+   * Annotate a breakpad crash report with the currently selected tab's URL.</span>
<a href="#l11.2324"></a><span id="l11.2324" class="difflineplus">+   */</span>
<a href="#l11.2325"></a><span id="l11.2325" class="difflineplus">+  _updateCrashReportURL: function sss_updateCrashReportURL(aWindow) {</span>
<a href="#l11.2326"></a><span id="l11.2326" class="difflineplus">+    if (!Components.interfaces.nsICrashReporter) {</span>
<a href="#l11.2327"></a><span id="l11.2327" class="difflineplus">+      // if breakpad isn't built, don't bother next time at all</span>
<a href="#l11.2328"></a><span id="l11.2328" class="difflineplus">+      this._updateCrashReportURL = function(aWindow) {};</span>
<a href="#l11.2329"></a><span id="l11.2329" class="difflineplus">+      return;</span>
<a href="#l11.2330"></a><span id="l11.2330" class="difflineplus">+    }</span>
<a href="#l11.2331"></a><span id="l11.2331" class="difflineplus">+    try {</span>
<a href="#l11.2332"></a><span id="l11.2332" class="difflineplus">+      var currentURI = aWindow.getBrowser().currentURI.clone();</span>
<a href="#l11.2333"></a><span id="l11.2333" class="difflineplus">+      // if the current URI contains a username/password, remove it</span>
<a href="#l11.2334"></a><span id="l11.2334" class="difflineplus">+      try {</span>
<a href="#l11.2335"></a><span id="l11.2335" class="difflineplus">+        currentURI.userPass = &quot;&quot;;</span>
<a href="#l11.2336"></a><span id="l11.2336" class="difflineplus">+      }</span>
<a href="#l11.2337"></a><span id="l11.2337" class="difflineplus">+      catch (ex) { } // ignore failures on about: URIs</span>
<a href="#l11.2338"></a><span id="l11.2338" class="difflineplus">+</span>
<a href="#l11.2339"></a><span id="l11.2339" class="difflineplus">+      var cr = Components.classes[&quot;@mozilla.org/xre/app-info;1&quot;].getService(Components.interfaces.nsICrashReporter);</span>
<a href="#l11.2340"></a><span id="l11.2340" class="difflineplus">+      cr.annotateCrashReport(&quot;URL&quot;, currentURI.spec);</span>
<a href="#l11.2341"></a><span id="l11.2341" class="difflineplus">+    }</span>
<a href="#l11.2342"></a><span id="l11.2342" class="difflineplus">+    catch (ex) {</span>
<a href="#l11.2343"></a><span id="l11.2343" class="difflineplus">+      // don't make noise when crashreporter is built but not enabled</span>
<a href="#l11.2344"></a><span id="l11.2344" class="difflineplus">+      if (ex.result != Components.results.NS_ERROR_NOT_INITIALIZED)</span>
<a href="#l11.2345"></a><span id="l11.2345" class="difflineplus">+        debug(ex);</span>
<a href="#l11.2346"></a><span id="l11.2346" class="difflineplus">+    }</span>
<a href="#l11.2347"></a><span id="l11.2347" class="difflineplus">+  },</span>
<a href="#l11.2348"></a><span id="l11.2348" class="difflineplus">+</span>
<a href="#l11.2349"></a><span id="l11.2349" class="difflineplus">+  /**</span>
<a href="#l11.2350"></a><span id="l11.2350" class="difflineplus">+   * safe eval'ing</span>
<a href="#l11.2351"></a><span id="l11.2351" class="difflineplus">+   */</span>
<a href="#l11.2352"></a><span id="l11.2352" class="difflineplus">+  _safeEval: function sss_safeEval(aStr) {</span>
<a href="#l11.2353"></a><span id="l11.2353" class="difflineplus">+    return Components.utils.evalInSandbox(aStr, new Components.utils.Sandbox(&quot;about:blank&quot;));</span>
<a href="#l11.2354"></a><span id="l11.2354" class="difflineplus">+  },</span>
<a href="#l11.2355"></a><span id="l11.2355" class="difflineplus">+</span>
<a href="#l11.2356"></a><span id="l11.2356" class="difflineplus">+  /**</span>
<a href="#l11.2357"></a><span id="l11.2357" class="difflineplus">+   * Converts a JavaScript object into a JSON string</span>
<a href="#l11.2358"></a><span id="l11.2358" class="difflineplus">+   * (see http://www.json.org/ for more information).</span>
<a href="#l11.2359"></a><span id="l11.2359" class="difflineplus">+   *</span>
<a href="#l11.2360"></a><span id="l11.2360" class="difflineplus">+   * The inverse operation consists of eval(&quot;(&quot; + JSON_string + &quot;)&quot;);</span>
<a href="#l11.2361"></a><span id="l11.2361" class="difflineplus">+   * and should be provably safe.</span>
<a href="#l11.2362"></a><span id="l11.2362" class="difflineplus">+   *</span>
<a href="#l11.2363"></a><span id="l11.2363" class="difflineplus">+   * @param aJSObject is the object to be converted</span>
<a href="#l11.2364"></a><span id="l11.2364" class="difflineplus">+   * @return the object's JSON representation</span>
<a href="#l11.2365"></a><span id="l11.2365" class="difflineplus">+   */</span>
<a href="#l11.2366"></a><span id="l11.2366" class="difflineplus">+  _toJSONString: function sss_toJSONString(aJSObject) {</span>
<a href="#l11.2367"></a><span id="l11.2367" class="difflineplus">+    let str = JSONModule.toString(aJSObject, [&quot;_tab&quot;, &quot;_hosts&quot;, &quot;_formDataSaved&quot;] /* keys to drop */);</span>
<a href="#l11.2368"></a><span id="l11.2368" class="difflineplus">+</span>
<a href="#l11.2369"></a><span id="l11.2369" class="difflineplus">+    // sanity check - so that API consumers can just eval this string</span>
<a href="#l11.2370"></a><span id="l11.2370" class="difflineplus">+    if (!JSONModule.isMostlyHarmless(str))</span>
<a href="#l11.2371"></a><span id="l11.2371" class="difflineplus">+      throw new Error(&quot;JSON conversion failed unexpectedly!&quot;);</span>
<a href="#l11.2372"></a><span id="l11.2372" class="difflineplus">+</span>
<a href="#l11.2373"></a><span id="l11.2373" class="difflineplus">+    return str;</span>
<a href="#l11.2374"></a><span id="l11.2374" class="difflineplus">+  },</span>
<a href="#l11.2375"></a><span id="l11.2375" class="difflineplus">+</span>
<a href="#l11.2376"></a><span id="l11.2376" class="difflineplus">+  _notifyIfAllWindowsRestored: function sss_notifyIfAllWindowsRestored() {</span>
<a href="#l11.2377"></a><span id="l11.2377" class="difflineplus">+    if (this._restoreCount) {</span>
<a href="#l11.2378"></a><span id="l11.2378" class="difflineplus">+      this._restoreCount--;</span>
<a href="#l11.2379"></a><span id="l11.2379" class="difflineplus">+      if (this._restoreCount == 0) {</span>
<a href="#l11.2380"></a><span id="l11.2380" class="difflineplus">+        // This was the last window restored at startup, notify observers.</span>
<a href="#l11.2381"></a><span id="l11.2381" class="difflineplus">+        var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l11.2382"></a><span id="l11.2382" class="difflineplus">+                                        .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l11.2383"></a><span id="l11.2383" class="difflineplus">+        observerService.notifyObservers(null, NOTIFY_WINDOWS_RESTORED, &quot;&quot;);</span>
<a href="#l11.2384"></a><span id="l11.2384" class="difflineplus">+      }</span>
<a href="#l11.2385"></a><span id="l11.2385" class="difflineplus">+    }</span>
<a href="#l11.2386"></a><span id="l11.2386" class="difflineplus">+  },</span>
<a href="#l11.2387"></a><span id="l11.2387" class="difflineplus">+</span>
<a href="#l11.2388"></a><span id="l11.2388" class="difflineplus">+/* ........ Storage API .............. */</span>
<a href="#l11.2389"></a><span id="l11.2389" class="difflineplus">+</span>
<a href="#l11.2390"></a><span id="l11.2390" class="difflineplus">+  /**</span>
<a href="#l11.2391"></a><span id="l11.2391" class="difflineplus">+   * write file to disk</span>
<a href="#l11.2392"></a><span id="l11.2392" class="difflineplus">+   * @param aFile</span>
<a href="#l11.2393"></a><span id="l11.2393" class="difflineplus">+   *        nsIFile</span>
<a href="#l11.2394"></a><span id="l11.2394" class="difflineplus">+   * @param aData</span>
<a href="#l11.2395"></a><span id="l11.2395" class="difflineplus">+   *        String data</span>
<a href="#l11.2396"></a><span id="l11.2396" class="difflineplus">+   */</span>
<a href="#l11.2397"></a><span id="l11.2397" class="difflineplus">+  _writeFile: function sss_writeFile(aFile, aData) {</span>
<a href="#l11.2398"></a><span id="l11.2398" class="difflineplus">+    // init stream</span>
<a href="#l11.2399"></a><span id="l11.2399" class="difflineplus">+    var stream = Components.classes[&quot;@mozilla.org/network/safe-file-output-stream;1&quot;]</span>
<a href="#l11.2400"></a><span id="l11.2400" class="difflineplus">+                           .createInstance(Components.interfaces.nsIFileOutputStream);</span>
<a href="#l11.2401"></a><span id="l11.2401" class="difflineplus">+    stream.init(aFile, 0x02 | 0x08 | 0x20, 0600, 0);</span>
<a href="#l11.2402"></a><span id="l11.2402" class="difflineplus">+</span>
<a href="#l11.2403"></a><span id="l11.2403" class="difflineplus">+    // convert to UTF-8</span>
<a href="#l11.2404"></a><span id="l11.2404" class="difflineplus">+    var converter = Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l11.2405"></a><span id="l11.2405" class="difflineplus">+                              .createInstance(Components.interfaces.nsIScriptableUnicodeConverter);</span>
<a href="#l11.2406"></a><span id="l11.2406" class="difflineplus">+    converter.charset = &quot;UTF-8&quot;;</span>
<a href="#l11.2407"></a><span id="l11.2407" class="difflineplus">+    var convertedData = converter.ConvertFromUnicode(aData);</span>
<a href="#l11.2408"></a><span id="l11.2408" class="difflineplus">+    convertedData += converter.Finish();</span>
<a href="#l11.2409"></a><span id="l11.2409" class="difflineplus">+</span>
<a href="#l11.2410"></a><span id="l11.2410" class="difflineplus">+    // write and close stream</span>
<a href="#l11.2411"></a><span id="l11.2411" class="difflineplus">+    stream.write(convertedData, convertedData.length);</span>
<a href="#l11.2412"></a><span id="l11.2412" class="difflineplus">+    if (stream instanceof Components.interfaces.nsISafeOutputStream) {</span>
<a href="#l11.2413"></a><span id="l11.2413" class="difflineplus">+      stream.finish();</span>
<a href="#l11.2414"></a><span id="l11.2414" class="difflineplus">+    } else {</span>
<a href="#l11.2415"></a><span id="l11.2415" class="difflineplus">+      stream.close();</span>
<a href="#l11.2416"></a><span id="l11.2416" class="difflineplus">+    }</span>
<a href="#l11.2417"></a><span id="l11.2417" class="difflineplus">+  }</span>
<a href="#l11.2418"></a><span id="l11.2418" class="difflineplus">+};</span>
<a href="#l11.2419"></a><span id="l11.2419" class="difflineplus">+</span>
<a href="#l11.2420"></a><span id="l11.2420" class="difflineplus">+let XPathHelper = {</span>
<a href="#l11.2421"></a><span id="l11.2421" class="difflineplus">+  // these two hashes should be kept in sync</span>
<a href="#l11.2422"></a><span id="l11.2422" class="difflineplus">+  namespaceURIs:     { &quot;xhtml&quot;: &quot;http://www.w3.org/1999/xhtml&quot; },</span>
<a href="#l11.2423"></a><span id="l11.2423" class="difflineplus">+  namespacePrefixes: { &quot;http://www.w3.org/1999/xhtml&quot;: &quot;xhtml&quot; },</span>
<a href="#l11.2424"></a><span id="l11.2424" class="difflineplus">+</span>
<a href="#l11.2425"></a><span id="l11.2425" class="difflineplus">+  /**</span>
<a href="#l11.2426"></a><span id="l11.2426" class="difflineplus">+   * Generates an approximate XPath query to an (X)HTML node</span>
<a href="#l11.2427"></a><span id="l11.2427" class="difflineplus">+   */</span>
<a href="#l11.2428"></a><span id="l11.2428" class="difflineplus">+  generate: function sss_xph_generate(aNode) {</span>
<a href="#l11.2429"></a><span id="l11.2429" class="difflineplus">+    // have we reached the document node already?</span>
<a href="#l11.2430"></a><span id="l11.2430" class="difflineplus">+    if (!aNode.parentNode)</span>
<a href="#l11.2431"></a><span id="l11.2431" class="difflineplus">+      return &quot;&quot;;</span>
<a href="#l11.2432"></a><span id="l11.2432" class="difflineplus">+</span>
<a href="#l11.2433"></a><span id="l11.2433" class="difflineplus">+    let prefix = this.namespacePrefixes[aNode.namespaceURI] || null;</span>
<a href="#l11.2434"></a><span id="l11.2434" class="difflineplus">+    let tag = (prefix ? prefix + &quot;:&quot; : &quot;&quot;) + aNode.localName;</span>
<a href="#l11.2435"></a><span id="l11.2435" class="difflineplus">+</span>
<a href="#l11.2436"></a><span id="l11.2436" class="difflineplus">+    // stop once we've found a tag with an ID</span>
<a href="#l11.2437"></a><span id="l11.2437" class="difflineplus">+    if (aNode.id)</span>
<a href="#l11.2438"></a><span id="l11.2438" class="difflineplus">+      return &quot;//&quot; + tag + &quot;[@id=&quot; + this.quoteArgument(aNode.id) + &quot;]&quot;;</span>
<a href="#l11.2439"></a><span id="l11.2439" class="difflineplus">+</span>
<a href="#l11.2440"></a><span id="l11.2440" class="difflineplus">+    // count the number of previous sibling nodes of the same tag</span>
<a href="#l11.2441"></a><span id="l11.2441" class="difflineplus">+    // (and possible also the same name)</span>
<a href="#l11.2442"></a><span id="l11.2442" class="difflineplus">+    let count = 0;</span>
<a href="#l11.2443"></a><span id="l11.2443" class="difflineplus">+    let nName = aNode.name || null;</span>
<a href="#l11.2444"></a><span id="l11.2444" class="difflineplus">+    for (let n = aNode; (n = n.previousSibling); )</span>
<a href="#l11.2445"></a><span id="l11.2445" class="difflineplus">+      if (n.localName == aNode.localName &amp;&amp; n.namespaceURI == aNode.namespaceURI &amp;&amp;</span>
<a href="#l11.2446"></a><span id="l11.2446" class="difflineplus">+          (!nName || n.name == nName))</span>
<a href="#l11.2447"></a><span id="l11.2447" class="difflineplus">+        count++;</span>
<a href="#l11.2448"></a><span id="l11.2448" class="difflineplus">+</span>
<a href="#l11.2449"></a><span id="l11.2449" class="difflineplus">+    // recurse until hitting either the document node or an ID'd node</span>
<a href="#l11.2450"></a><span id="l11.2450" class="difflineplus">+    return this.generate(aNode.parentNode) + &quot;/&quot; + tag +</span>
<a href="#l11.2451"></a><span id="l11.2451" class="difflineplus">+           (nName ? &quot;[@name=&quot; + this.quoteArgument(nName) + &quot;]&quot; : &quot;&quot;) +</span>
<a href="#l11.2452"></a><span id="l11.2452" class="difflineplus">+           (count ? &quot;[&quot; + (count + 1) + &quot;]&quot; : &quot;&quot;);</span>
<a href="#l11.2453"></a><span id="l11.2453" class="difflineplus">+  },</span>
<a href="#l11.2454"></a><span id="l11.2454" class="difflineplus">+</span>
<a href="#l11.2455"></a><span id="l11.2455" class="difflineplus">+  /**</span>
<a href="#l11.2456"></a><span id="l11.2456" class="difflineplus">+   * Resolves an XPath query generated by XPathHelper.generate</span>
<a href="#l11.2457"></a><span id="l11.2457" class="difflineplus">+   */</span>
<a href="#l11.2458"></a><span id="l11.2458" class="difflineplus">+  resolve: function sss_xph_resolve(aDocument, aQuery) {</span>
<a href="#l11.2459"></a><span id="l11.2459" class="difflineplus">+    let xptype = Components.interfaces.nsIDOMXPathResult.FIRST_ORDERED_NODE_TYPE;</span>
<a href="#l11.2460"></a><span id="l11.2460" class="difflineplus">+    return aDocument.evaluate(aQuery, aDocument, this.resolveNS, xptype, null).singleNodeValue;</span>
<a href="#l11.2461"></a><span id="l11.2461" class="difflineplus">+  },</span>
<a href="#l11.2462"></a><span id="l11.2462" class="difflineplus">+</span>
<a href="#l11.2463"></a><span id="l11.2463" class="difflineplus">+  /**</span>
<a href="#l11.2464"></a><span id="l11.2464" class="difflineplus">+   * Namespace resolver for the above XPath resolver</span>
<a href="#l11.2465"></a><span id="l11.2465" class="difflineplus">+   */</span>
<a href="#l11.2466"></a><span id="l11.2466" class="difflineplus">+  resolveNS: function sss_xph_resolveNS(aPrefix) {</span>
<a href="#l11.2467"></a><span id="l11.2467" class="difflineplus">+    return XPathHelper.namespaceURIs[aPrefix] || null;</span>
<a href="#l11.2468"></a><span id="l11.2468" class="difflineplus">+  },</span>
<a href="#l11.2469"></a><span id="l11.2469" class="difflineplus">+</span>
<a href="#l11.2470"></a><span id="l11.2470" class="difflineplus">+  /**</span>
<a href="#l11.2471"></a><span id="l11.2471" class="difflineplus">+   * @returns a properly quoted string to insert into an XPath query</span>
<a href="#l11.2472"></a><span id="l11.2472" class="difflineplus">+   */</span>
<a href="#l11.2473"></a><span id="l11.2473" class="difflineplus">+  quoteArgument: function sss_xph_quoteArgument(aArg) {</span>
<a href="#l11.2474"></a><span id="l11.2474" class="difflineplus">+    return !/'/.test(aArg) ? &quot;'&quot; + aArg + &quot;'&quot; :</span>
<a href="#l11.2475"></a><span id="l11.2475" class="difflineplus">+           !/&quot;/.test(aArg) ? '&quot;' + aArg + '&quot;' :</span>
<a href="#l11.2476"></a><span id="l11.2476" class="difflineplus">+           &quot;concat('&quot; + aArg.replace(/'+/g, &quot;',\&quot;$&amp;\&quot;,'&quot;) + &quot;')&quot;;</span>
<a href="#l11.2477"></a><span id="l11.2477" class="difflineplus">+  },</span>
<a href="#l11.2478"></a><span id="l11.2478" class="difflineplus">+</span>
<a href="#l11.2479"></a><span id="l11.2479" class="difflineplus">+  /**</span>
<a href="#l11.2480"></a><span id="l11.2480" class="difflineplus">+   * @returns an XPath query to all savable form field nodes</span>
<a href="#l11.2481"></a><span id="l11.2481" class="difflineplus">+   */</span>
<a href="#l11.2482"></a><span id="l11.2482" class="difflineplus">+  get restorableFormNodes() {</span>
<a href="#l11.2483"></a><span id="l11.2483" class="difflineplus">+    // for a comprehensive list of all available &lt;INPUT&gt; types see</span>
<a href="#l11.2484"></a><span id="l11.2484" class="difflineplus">+    // http://mxr.mozilla.org/mozilla-central/search?string=kInputTypeTable</span>
<a href="#l11.2485"></a><span id="l11.2485" class="difflineplus">+    let ignoreTypes = [&quot;password&quot;, &quot;hidden&quot;, &quot;button&quot;, &quot;image&quot;, &quot;submit&quot;, &quot;reset&quot;];</span>
<a href="#l11.2486"></a><span id="l11.2486" class="difflineplus">+    // XXXzeniko work-around until lower-case has been implemented (bug 398389)</span>
<a href="#l11.2487"></a><span id="l11.2487" class="difflineplus">+    let toLowerCase = '&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;, &quot;abcdefghijklmnopqrstuvwxyz&quot;';</span>
<a href="#l11.2488"></a><span id="l11.2488" class="difflineplus">+    let ignore = &quot;not(translate(@type, &quot; + toLowerCase + &quot;)='&quot; +</span>
<a href="#l11.2489"></a><span id="l11.2489" class="difflineplus">+      ignoreTypes.join(&quot;' or translate(@type, &quot; + toLowerCase + &quot;)='&quot;) + &quot;')&quot;;</span>
<a href="#l11.2490"></a><span id="l11.2490" class="difflineplus">+    let formNodesXPath = &quot;//textarea|//select|//xhtml:textarea|//xhtml:select|&quot; +</span>
<a href="#l11.2491"></a><span id="l11.2491" class="difflineplus">+      &quot;//input[&quot; + ignore + &quot;]|//xhtml:input[&quot; + ignore + &quot;]&quot;;</span>
<a href="#l11.2492"></a><span id="l11.2492" class="difflineplus">+</span>
<a href="#l11.2493"></a><span id="l11.2493" class="difflineplus">+    delete this.restorableFormNodes;</span>
<a href="#l11.2494"></a><span id="l11.2494" class="difflineplus">+    return (this.restorableFormNodes = formNodesXPath);</span>
<a href="#l11.2495"></a><span id="l11.2495" class="difflineplus">+  }</span>
<a href="#l11.2496"></a><span id="l11.2496" class="difflineplus">+};</span>
<a href="#l11.2497"></a><span id="l11.2497" class="difflineplus">+</span>
<a href="#l11.2498"></a><span id="l11.2498" class="difflineplus">+function NSGetModule(aComMgr, aFileSpec)</span>
<a href="#l11.2499"></a><span id="l11.2499" class="difflineplus">+  XPCOMUtils.generateModule([SessionStoreService]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/suite/common/src/nsSuiteGlue.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/suite/common/src/nsSuiteGlue.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -43,16 +43,25 @@ Components.utils.import(&quot;resource://app/</span>
<a href="#l12.4"></a><span id="l12.4"> </span>
<a href="#l12.5"></a><span id="l12.5"> // Constructor</span>
<a href="#l12.6"></a><span id="l12.6"> </span>
<a href="#l12.7"></a><span id="l12.7"> function SuiteGlue() {</span>
<a href="#l12.8"></a><span id="l12.8">   this._init();</span>
<a href="#l12.9"></a><span id="l12.9"> }</span>
<a href="#l12.10"></a><span id="l12.10"> </span>
<a href="#l12.11"></a><span id="l12.11"> SuiteGlue.prototype = {</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+  _saveSession: false,</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+  _setPrefToSaveSession: function()</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+  {</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+    var prefBranch = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;].</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+                     getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+    prefBranch.setBoolPref(&quot;browser.sessionstore.resume_session_once&quot;, true);</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+  },</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+</span>
<a href="#l12.21"></a><span id="l12.21">   // nsIObserver implementation</span>
<a href="#l12.22"></a><span id="l12.22">   observe: function(subject, topic, data)</span>
<a href="#l12.23"></a><span id="l12.23">   {</span>
<a href="#l12.24"></a><span id="l12.24">     switch(topic) {</span>
<a href="#l12.25"></a><span id="l12.25">       case &quot;xpcom-shutdown&quot;:</span>
<a href="#l12.26"></a><span id="l12.26">         this._dispose();</span>
<a href="#l12.27"></a><span id="l12.27">         break;</span>
<a href="#l12.28"></a><span id="l12.28">       case &quot;quit-application&quot;:</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineat">@@ -63,42 +72,61 @@ SuiteGlue.prototype = {</span>
<a href="#l12.30"></a><span id="l12.30">         break;</span>
<a href="#l12.31"></a><span id="l12.31">       case &quot;browser:purge-session-history&quot;:</span>
<a href="#l12.32"></a><span id="l12.32">         // reset the console service's error buffer</span>
<a href="#l12.33"></a><span id="l12.33">         const cs = Components.classes[&quot;@mozilla.org/consoleservice;1&quot;]</span>
<a href="#l12.34"></a><span id="l12.34">                              .getService(Components.interfaces.nsIConsoleService);</span>
<a href="#l12.35"></a><span id="l12.35">         cs.logStringMessage(null); // clear the console (in case it's open)</span>
<a href="#l12.36"></a><span id="l12.36">         cs.reset();</span>
<a href="#l12.37"></a><span id="l12.37">         break;</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineminus">-    }</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+      case &quot;quit-application-requested&quot;:</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+        this._onQuitRequest(subject, data);</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+        break;</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+      case &quot;quit-application-granted&quot;:</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+        if (this._saveSession) {</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+          this._setPrefToSaveSession();</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+        }</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+        break;</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+      case &quot;session-save&quot;:</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+        this._setPrefToSaveSession();</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+        subject.QueryInterface(Components.interfaces.nsISupportsPRBool);</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+        subject.data = true;</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+        break;</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+   }</span>
<a href="#l12.53"></a><span id="l12.53">   },</span>
<a href="#l12.54"></a><span id="l12.54"> </span>
<a href="#l12.55"></a><span id="l12.55">   // initialization (called on application startup)</span>
<a href="#l12.56"></a><span id="l12.56">   _init: function() </span>
<a href="#l12.57"></a><span id="l12.57">   {</span>
<a href="#l12.58"></a><span id="l12.58">     // observer registration</span>
<a href="#l12.59"></a><span id="l12.59">     const osvr = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l12.60"></a><span id="l12.60">                            .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l12.61"></a><span id="l12.61">     osvr.addObserver(this, &quot;xpcom-shutdown&quot;, false);</span>
<a href="#l12.62"></a><span id="l12.62">     osvr.addObserver(this, &quot;quit-application&quot;, false);</span>
<a href="#l12.63"></a><span id="l12.63">     osvr.addObserver(this, &quot;final-ui-startup&quot;, false);</span>
<a href="#l12.64"></a><span id="l12.64">     osvr.addObserver(this, &quot;browser:purge-session-history&quot;, false);</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+    osvr.addObserver(this, &quot;quit-application-requested&quot;, false);</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineplus">+    osvr.addObserver(this, &quot;quit-application-granted&quot;, false);</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineplus">+    osvr.addObserver(this, &quot;session-save&quot;, false);</span>
<a href="#l12.68"></a><span id="l12.68">   },</span>
<a href="#l12.69"></a><span id="l12.69"> </span>
<a href="#l12.70"></a><span id="l12.70">   // cleanup (called on application shutdown)</span>
<a href="#l12.71"></a><span id="l12.71">   _dispose: function()</span>
<a href="#l12.72"></a><span id="l12.72">   {</span>
<a href="#l12.73"></a><span id="l12.73">     // observer removal</span>
<a href="#l12.74"></a><span id="l12.74">     const osvr = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l12.75"></a><span id="l12.75">                            .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l12.76"></a><span id="l12.76">     osvr.removeObserver(this, &quot;xpcom-shutdown&quot;);</span>
<a href="#l12.77"></a><span id="l12.77">     osvr.removeObserver(this, &quot;quit-application&quot;);</span>
<a href="#l12.78"></a><span id="l12.78">     osvr.removeObserver(this, &quot;final-ui-startup&quot;);</span>
<a href="#l12.79"></a><span id="l12.79">     osvr.removeObserver(this, &quot;browser:purge-session-history&quot;);</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineminus">-  },</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+    osvr.removeObserver(this, &quot;quit-application-requested&quot;);</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+    osvr.removeObserver(this, &quot;quit-application-granted&quot;);</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineplus">+    osvr.removeObserver(this, &quot;session-save&quot;);</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineplus">+ },</span>
<a href="#l12.85"></a><span id="l12.85"> </span>
<a href="#l12.86"></a><span id="l12.86">   // profile startup handler (contains profile initialization routines)</span>
<a href="#l12.87"></a><span id="l12.87">   _onProfileStartup: function()</span>
<a href="#l12.88"></a><span id="l12.88">   {</span>
<a href="#l12.89"></a><span id="l12.89">     Sanitizer.checkAndSanitize();</span>
<a href="#l12.90"></a><span id="l12.90"> </span>
<a href="#l12.91"></a><span id="l12.91">     const prefSvc = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l12.92"></a><span id="l12.92">                               .getService(Components.interfaces.nsIPrefBranch2);</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineat">@@ -113,16 +141,130 @@ SuiteGlue.prototype = {</span>
<a href="#l12.94"></a><span id="l12.94">   },</span>
<a href="#l12.95"></a><span id="l12.95"> </span>
<a href="#l12.96"></a><span id="l12.96">   // profile shutdown handler (contains profile cleanup routines)</span>
<a href="#l12.97"></a><span id="l12.97">   _onProfileShutdown: function()</span>
<a href="#l12.98"></a><span id="l12.98">   {</span>
<a href="#l12.99"></a><span id="l12.99">     Sanitizer.checkAndSanitize();</span>
<a href="#l12.100"></a><span id="l12.100">   },</span>
<a href="#l12.101"></a><span id="l12.101"> </span>
<a href="#l12.102"></a><span id="l12.102" class="difflineplus">+  _onQuitRequest: function(aCancelQuit, aQuitType)</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineplus">+  {</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineplus">+    // If user has already dismissed quit request, then do nothing</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineplus">+    if ((aCancelQuit instanceof Components.interfaces.nsISupportsPRBool) &amp;&amp; aCancelQuit.data)</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineplus">+      return;</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineplus">+</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineplus">+    var wm = Components.classes[&quot;@mozilla.org/appshell/window-mediator;1&quot;].</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineplus">+             getService(Components.interfaces.nsIWindowMediator);</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineplus">+    var windowcount = 0;</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineplus">+    var pagecount = 0;</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineplus">+    var browserEnum = wm.getEnumerator(&quot;navigator:browser&quot;);</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineplus">+    while (browserEnum.hasMoreElements()) {</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineplus">+      windowcount++;</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineplus">+</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineplus">+      var browser = browserEnum.getNext();</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineplus">+      var tabbrowser = browser.document.getElementById(&quot;content&quot;);</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineplus">+      if (tabbrowser)</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineplus">+        pagecount += tabbrowser.browsers.length;</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineplus">+    }</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineplus">+</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineplus">+    this._saveSession = false;</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineplus">+    if (pagecount &lt; 2)</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineplus">+      return;</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineplus">+</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineplus">+    if (aQuitType != &quot;restart&quot;)</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineplus">+      aQuitType = &quot;quit&quot;;</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineplus">+</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineplus">+    var prefBranch = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;].</span>
<a href="#l12.130"></a><span id="l12.130" class="difflineplus">+                     getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l12.131"></a><span id="l12.131" class="difflineplus">+    var showPrompt = true;</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineplus">+    try {</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineplus">+      // browser.warnOnQuit is a hidden global boolean to override all quit prompts</span>
<a href="#l12.134"></a><span id="l12.134" class="difflineplus">+      // browser.warnOnRestart specifically covers app-initiated restarts where we restart the app</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineplus">+      // browser.tabs.warnOnClose is the global &quot;warn when closing multiple tabs&quot; pref</span>
<a href="#l12.136"></a><span id="l12.136" class="difflineplus">+      if (prefBranch.getBoolPref(&quot;browser.warnOnQuit&quot;) == false)</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineplus">+        showPrompt = false;</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineplus">+      else if (aQuitType == &quot;restart&quot;)</span>
<a href="#l12.139"></a><span id="l12.139" class="difflineplus">+        showPrompt = prefBranch.getBoolPref(&quot;browser.warnOnRestart&quot;);</span>
<a href="#l12.140"></a><span id="l12.140" class="difflineplus">+      else</span>
<a href="#l12.141"></a><span id="l12.141" class="difflineplus">+        showPrompt = prefBranch.getBoolPref(&quot;browser.tabs.warnOnClose&quot;);</span>
<a href="#l12.142"></a><span id="l12.142" class="difflineplus">+    } catch (ex) {}</span>
<a href="#l12.143"></a><span id="l12.143" class="difflineplus">+</span>
<a href="#l12.144"></a><span id="l12.144" class="difflineplus">+    var buttonChoice = 0;</span>
<a href="#l12.145"></a><span id="l12.145" class="difflineplus">+    if (showPrompt) {</span>
<a href="#l12.146"></a><span id="l12.146" class="difflineplus">+      var bundleService = Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;].</span>
<a href="#l12.147"></a><span id="l12.147" class="difflineplus">+                          getService(Components.interfaces.nsIStringBundleService);</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineplus">+      var quitBundle = bundleService.createBundle(&quot;chrome://browser/locale/quitDialog.properties&quot;);</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineplus">+      var brandBundle = bundleService.createBundle(&quot;chrome://branding/locale/brand.properties&quot;);</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineplus">+</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineplus">+      var appName = brandBundle.GetStringFromName(&quot;brandShortName&quot;);</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineplus">+      var quitDialogTitle = quitBundle.formatStringFromName(aQuitType + &quot;DialogTitle&quot;,</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineplus">+                                                              [appName], 1);</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineplus">+</span>
<a href="#l12.155"></a><span id="l12.155" class="difflineplus">+      var message;</span>
<a href="#l12.156"></a><span id="l12.156" class="difflineplus">+      if (aQuitType == &quot;restart&quot;)</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineplus">+        message = quitBundle.formatStringFromName(&quot;messageRestart&quot;,</span>
<a href="#l12.158"></a><span id="l12.158" class="difflineplus">+                                                  [appName], 1);</span>
<a href="#l12.159"></a><span id="l12.159" class="difflineplus">+      else if (windowcount == 1)</span>
<a href="#l12.160"></a><span id="l12.160" class="difflineplus">+        message = quitBundle.formatStringFromName(&quot;messageNoWindows&quot;,</span>
<a href="#l12.161"></a><span id="l12.161" class="difflineplus">+                                                  [appName], 1);</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineplus">+      else</span>
<a href="#l12.163"></a><span id="l12.163" class="difflineplus">+        message = quitBundle.formatStringFromName(&quot;message&quot;,</span>
<a href="#l12.164"></a><span id="l12.164" class="difflineplus">+                                                  [appName], 1);</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineplus">+</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineplus">+      var promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;].</span>
<a href="#l12.167"></a><span id="l12.167" class="difflineplus">+                          getService(Components.interfaces.nsIPromptService);</span>
<a href="#l12.168"></a><span id="l12.168" class="difflineplus">+</span>
<a href="#l12.169"></a><span id="l12.169" class="difflineplus">+      var flags = promptService.BUTTON_TITLE_IS_STRING * promptService.BUTTON_POS_0 +</span>
<a href="#l12.170"></a><span id="l12.170" class="difflineplus">+                  promptService.BUTTON_TITLE_IS_STRING * promptService.BUTTON_POS_1 +</span>
<a href="#l12.171"></a><span id="l12.171" class="difflineplus">+                  promptService.BUTTON_POS_0_DEFAULT;</span>
<a href="#l12.172"></a><span id="l12.172" class="difflineplus">+</span>
<a href="#l12.173"></a><span id="l12.173" class="difflineplus">+      var neverAsk = {value:false};</span>
<a href="#l12.174"></a><span id="l12.174" class="difflineplus">+      var button0Title, button2Title;</span>
<a href="#l12.175"></a><span id="l12.175" class="difflineplus">+      var button1Title = quitBundle.GetStringFromName(&quot;cancelTitle&quot;);</span>
<a href="#l12.176"></a><span id="l12.176" class="difflineplus">+      var neverAskText = quitBundle.GetStringFromName(&quot;neverAsk&quot;);</span>
<a href="#l12.177"></a><span id="l12.177" class="difflineplus">+</span>
<a href="#l12.178"></a><span id="l12.178" class="difflineplus">+      if (aQuitType == &quot;restart&quot;)</span>
<a href="#l12.179"></a><span id="l12.179" class="difflineplus">+        button0Title = quitBundle.GetStringFromName(&quot;restartTitle&quot;);</span>
<a href="#l12.180"></a><span id="l12.180" class="difflineplus">+      else {</span>
<a href="#l12.181"></a><span id="l12.181" class="difflineplus">+        flags += promptService.BUTTON_TITLE_IS_STRING * promptService.BUTTON_POS_2;</span>
<a href="#l12.182"></a><span id="l12.182" class="difflineplus">+        button0Title = quitBundle.GetStringFromName(&quot;saveTitle&quot;);</span>
<a href="#l12.183"></a><span id="l12.183" class="difflineplus">+        button2Title = quitBundle.GetStringFromName(&quot;quitTitle&quot;);</span>
<a href="#l12.184"></a><span id="l12.184" class="difflineplus">+      }</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineplus">+</span>
<a href="#l12.186"></a><span id="l12.186" class="difflineplus">+      buttonChoice = promptService.confirmEx(null, quitDialogTitle, message,</span>
<a href="#l12.187"></a><span id="l12.187" class="difflineplus">+                                   flags, button0Title, button1Title, button2Title,</span>
<a href="#l12.188"></a><span id="l12.188" class="difflineplus">+                                   neverAskText, neverAsk);</span>
<a href="#l12.189"></a><span id="l12.189" class="difflineplus">+</span>
<a href="#l12.190"></a><span id="l12.190" class="difflineplus">+      switch (buttonChoice) {</span>
<a href="#l12.191"></a><span id="l12.191" class="difflineplus">+      case 2:</span>
<a href="#l12.192"></a><span id="l12.192" class="difflineplus">+        if (neverAsk.value)</span>
<a href="#l12.193"></a><span id="l12.193" class="difflineplus">+          prefBranch.setBoolPref(&quot;browser.tabs.warnOnClose&quot;, false);</span>
<a href="#l12.194"></a><span id="l12.194" class="difflineplus">+        break;</span>
<a href="#l12.195"></a><span id="l12.195" class="difflineplus">+      case 1:</span>
<a href="#l12.196"></a><span id="l12.196" class="difflineplus">+        aCancelQuit.QueryInterface(Components.interfaces.nsISupportsPRBool);</span>
<a href="#l12.197"></a><span id="l12.197" class="difflineplus">+        aCancelQuit.data = true;</span>
<a href="#l12.198"></a><span id="l12.198" class="difflineplus">+        break;</span>
<a href="#l12.199"></a><span id="l12.199" class="difflineplus">+      case 0:</span>
<a href="#l12.200"></a><span id="l12.200" class="difflineplus">+        this._saveSession = true;</span>
<a href="#l12.201"></a><span id="l12.201" class="difflineplus">+        if (neverAsk.value) {</span>
<a href="#l12.202"></a><span id="l12.202" class="difflineplus">+          if (aQuitType == &quot;restart&quot;)</span>
<a href="#l12.203"></a><span id="l12.203" class="difflineplus">+            prefBranch.setBoolPref(&quot;browser.warnOnRestart&quot;, false);</span>
<a href="#l12.204"></a><span id="l12.204" class="difflineplus">+          else {</span>
<a href="#l12.205"></a><span id="l12.205" class="difflineplus">+            // don't prompt in the future</span>
<a href="#l12.206"></a><span id="l12.206" class="difflineplus">+            prefBranch.setBoolPref(&quot;browser.tabs.warnOnClose&quot;, false);</span>
<a href="#l12.207"></a><span id="l12.207" class="difflineplus">+            // always save state when shutting down</span>
<a href="#l12.208"></a><span id="l12.208" class="difflineplus">+            prefBranch.setIntPref(&quot;browser.startup.page&quot;, 3);</span>
<a href="#l12.209"></a><span id="l12.209" class="difflineplus">+          }</span>
<a href="#l12.210"></a><span id="l12.210" class="difflineplus">+        }</span>
<a href="#l12.211"></a><span id="l12.211" class="difflineplus">+        break;</span>
<a href="#l12.212"></a><span id="l12.212" class="difflineplus">+      }</span>
<a href="#l12.213"></a><span id="l12.213" class="difflineplus">+    }</span>
<a href="#l12.214"></a><span id="l12.214" class="difflineplus">+  },</span>
<a href="#l12.215"></a><span id="l12.215" class="difflineplus">+</span>
<a href="#l12.216"></a><span id="l12.216"> </span>
<a href="#l12.217"></a><span id="l12.217">   // ------------------------------</span>
<a href="#l12.218"></a><span id="l12.218">   // public nsISuiteGlue members</span>
<a href="#l12.219"></a><span id="l12.219">   // ------------------------------</span>
<a href="#l12.220"></a><span id="l12.220"> </span>
<a href="#l12.221"></a><span id="l12.221">   sanitize: function(aParentWindow)</span>
<a href="#l12.222"></a><span id="l12.222">   {</span>
<a href="#l12.223"></a><span id="l12.223">     // call the Sanitizer object's sanitize, which might return errors</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/suite/installer/unix/packages</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/suite/installer/unix/packages</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -234,16 +234,19 @@ bin/components/xpcom_xpti.xpt</span>
<a href="#l13.4"></a><span id="l13.4"> bin/components/xpconnect.xpt</span>
<a href="#l13.5"></a><span id="l13.5"> bin/components/libxpconnect.so</span>
<a href="#l13.6"></a><span id="l13.6"> bin/components/xpinstall.xpt</span>
<a href="#l13.7"></a><span id="l13.7"> bin/components/xulapp.xpt</span>
<a href="#l13.8"></a><span id="l13.8"> bin/components/xuldoc.xpt</span>
<a href="#l13.9"></a><span id="l13.9"> bin/components/xultmpl.xpt</span>
<a href="#l13.10"></a><span id="l13.10"> bin/components/zipwriter.xpt</span>
<a href="#l13.11"></a><span id="l13.11"> bin/components/libzipwriter.so</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+bin/components/nsSessionStartup.js</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+bin/components/nsSessionStore.js</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+bin/components/sessionstore.xpt</span>
<a href="#l13.15"></a><span id="l13.15"> </span>
<a href="#l13.16"></a><span id="l13.16"> ; JavaScript components</span>
<a href="#l13.17"></a><span id="l13.17"> bin/components/FeedProcessor.js</span>
<a href="#l13.18"></a><span id="l13.18"> bin/components/jsconsole-clhandler.js</span>
<a href="#l13.19"></a><span id="l13.19"> bin/components/nsAboutAbout.js</span>
<a href="#l13.20"></a><span id="l13.20"> bin/components/nsAboutCertError.js</span>
<a href="#l13.21"></a><span id="l13.21"> bin/components/nsAddonRepository.js</span>
<a href="#l13.22"></a><span id="l13.22"> bin/components/nsBadCertHandler.js</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/suite/installer/windows/packages</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/suite/installer/windows/packages</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -238,16 +238,19 @@ bin\components\xulapp.xpt</span>
<a href="#l14.4"></a><span id="l14.4"> bin\components\xuldoc.xpt</span>
<a href="#l14.5"></a><span id="l14.5"> bin\components\xultmpl.xpt</span>
<a href="#l14.6"></a><span id="l14.6"> bin\components\zipwriter.xpt</span>
<a href="#l14.7"></a><span id="l14.7"> bin\components\zipwriter.dll</span>
<a href="#l14.8"></a><span id="l14.8"> bin\plugins\npnul32.dll</span>
<a href="#l14.9"></a><span id="l14.9"> bin\components\helperAppDlg.xpt</span>
<a href="#l14.10"></a><span id="l14.10"> bin\AccessibleMarshal.dll</span>
<a href="#l14.11"></a><span id="l14.11"> bin\sqlite3.dll</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+bin\components\nsSessionStartup.js</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+bin\components\nsSessionStore.js</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+bin\components\sessionstore.xpt</span>
<a href="#l14.15"></a><span id="l14.15"> </span>
<a href="#l14.16"></a><span id="l14.16"> ; JavaScript components</span>
<a href="#l14.17"></a><span id="l14.17"> bin\components\FeedProcessor.js</span>
<a href="#l14.18"></a><span id="l14.18"> bin\components\jsconsole-clhandler.js</span>
<a href="#l14.19"></a><span id="l14.19"> bin\components\nsAboutCertError.js</span>
<a href="#l14.20"></a><span id="l14.20"> bin\components\nsAddonRepository.js</span>
<a href="#l14.21"></a><span id="l14.21"> bin\components\nsAxSecurityPolicy.js</span>
<a href="#l14.22"></a><span id="l14.22"> bin\components\nsBadCertHandler.js</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/suite/locales/en-US/chrome/common/pref/pref-navigator.dtd</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/common/pref/pref-navigator.dtd</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -7,16 +7,18 @@</span>
<a href="#l15.4"></a><span id="l15.4"> &lt;!ENTITY newTabPageMenu.label           &quot;New Tab&quot;&gt;</span>
<a href="#l15.5"></a><span id="l15.5"> </span>
<a href="#l15.6"></a><span id="l15.6"> &lt;!ENTITY blankPageRadio.label           &quot;Blank page&quot;&gt;</span>
<a href="#l15.7"></a><span id="l15.7"> &lt;!ENTITY blankPageRadio.accesskey       &quot;B&quot;&gt;</span>
<a href="#l15.8"></a><span id="l15.8"> &lt;!ENTITY homePageRadio.label            &quot;Home page&quot;&gt;</span>
<a href="#l15.9"></a><span id="l15.9"> &lt;!ENTITY homePageRadio.accesskey        &quot;m&quot;&gt;</span>
<a href="#l15.10"></a><span id="l15.10"> &lt;!ENTITY lastPageRadio.label            &quot;Last page visited&quot;&gt;</span>
<a href="#l15.11"></a><span id="l15.11"> &lt;!ENTITY lastPageRadio.accesskey        &quot;L&quot;&gt;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+&lt;!ENTITY restoreSessionRadio.label      &quot;Restore Previous Session&quot;&gt;</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+&lt;!ENTITY restoreSessionRadio.accesskey  &quot;P&quot;&gt;</span>
<a href="#l15.14"></a><span id="l15.14"> </span>
<a href="#l15.15"></a><span id="l15.15"> &lt;!ENTITY header2.label                  &quot;Home Page&quot;&gt;</span>
<a href="#l15.16"></a><span id="l15.16"> &lt;!ENTITY homePageIntro.label            &quot;Clicking the Home button takes you to this group of pages:&quot;&gt;</span>
<a href="#l15.17"></a><span id="l15.17"> &lt;!ENTITY useCurrent.label               &quot;Use Current Page&quot;&gt;</span>
<a href="#l15.18"></a><span id="l15.18"> &lt;!ENTITY useCurrent.accesskey           &quot;U&quot;&gt;</span>
<a href="#l15.19"></a><span id="l15.19"> &lt;!ENTITY useCurrentGroup.label          &quot;Use Current Group&quot;&gt;</span>
<a href="#l15.20"></a><span id="l15.20"> &lt;!ENTITY useCurrentGroup.accesskey      &quot;G&quot;&gt;</span>
<a href="#l15.21"></a><span id="l15.21"> &lt;!ENTITY browseFile.label               &quot;Choose File…&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">new file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineminus">--- /dev/null</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineplus">+++ b/suite/locales/en-US/chrome/common/sessionstore.properties</span>
<a href="#l16.4"></a><span id="l16.4" class="difflineat">@@ -0,0 +1,7 @@</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineplus">+restoredTitle= %S - Restore Previous Session</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineplus">+restoredMsg=Your last %S session closed unexpectedly. You can restore the tabs and windows from your previous session, or start a new session if you think the problem was related to a page you were viewing.</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineplus">+</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineplus">+# Localization note: It is recommended that okTitle be longer than cancelTitle</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineplus">+# so that hitting the more prominent button doesn't lead to dataloss (see bug 346264).</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineplus">+okTitle=Restore Previous Session</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineplus">+cancelTitle=Start New Session</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/suite/locales/jar.mn</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/suite/locales/jar.mn</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -24,16 +24,17 @@</span>
<a href="#l17.4"></a><span id="l17.4">   locale/@AB_CD@/communicator/contentAreaCommands.dtd                       (%chrome/common/contentAreaCommands.dtd)</span>
<a href="#l17.5"></a><span id="l17.5">   locale/@AB_CD@/communicator/contentAreaCommands.properties                (%chrome/common/contentAreaCommands.properties)</span>
<a href="#l17.6"></a><span id="l17.6">   locale/@AB_CD@/communicator/defaultClientDialog.dtd                       (%chrome/common/defaultClientDialog.dtd)</span>
<a href="#l17.7"></a><span id="l17.7">   locale/@AB_CD@/communicator/notification.properties                       (%chrome/common/notification.properties)</span>
<a href="#l17.8"></a><span id="l17.8">   locale/@AB_CD@/communicator/openLocation.dtd                              (%chrome/common/openLocation.dtd)</span>
<a href="#l17.9"></a><span id="l17.9">   locale/@AB_CD@/communicator/openLocation.properties                       (%chrome/common/openLocation.properties)</span>
<a href="#l17.10"></a><span id="l17.10">   locale/@AB_CD@/communicator/passwordManager.dtd                           (%chrome/common/passwordManager.dtd)</span>
<a href="#l17.11"></a><span id="l17.11">   locale/@AB_CD@/communicator/printPreview.dtd                              (%chrome/common/printPreview.dtd)</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+  locale/@AB_CD@/communicator/sessionstore.properties                       (%chrome/common/sessionstore.properties)</span>
<a href="#l17.13"></a><span id="l17.13">   locale/@AB_CD@/communicator/shellservice.properties                       (%chrome/common/shellservice.properties)</span>
<a href="#l17.14"></a><span id="l17.14">   locale/@AB_CD@/communicator/sanitize.dtd                                  (%chrome/common/sanitize.dtd)</span>
<a href="#l17.15"></a><span id="l17.15">   locale/@AB_CD@/communicator/tasksOverlay.dtd                              (%chrome/common/tasksOverlay.dtd)</span>
<a href="#l17.16"></a><span id="l17.16">   locale/@AB_CD@/communicator/typeaheadfind.properties                      (%chrome/common/typeaheadfind.properties)</span>
<a href="#l17.17"></a><span id="l17.17">   locale/@AB_CD@/communicator/utilityOverlay.dtd                            (%chrome/common/utilityOverlay.dtd)</span>
<a href="#l17.18"></a><span id="l17.18">   locale/@AB_CD@/communicator/utilityOverlay.properties                     (%chrome/common/utilityOverlay.properties)</span>
<a href="#l17.19"></a><span id="l17.19">   locale/@AB_CD@/communicator/viewZoomOverlay.dtd                           (%chrome/common/viewZoomOverlay.dtd)</span>
<a href="#l17.20"></a><span id="l17.20">   locale/@AB_CD@/communicator/viewZoomOverlay.properties                    (%chrome/common/viewZoomOverlay.properties)</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

