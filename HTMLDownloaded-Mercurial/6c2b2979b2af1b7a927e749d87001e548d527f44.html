<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 24058:6c2b2979b2af1b7a927e749d87001e548d527f44</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 6c2b2979b2af1b7a927e749d87001e548d527f44" />
<meta property="og:url" content="/comm-central/rev/6c2b2979b2af1b7a927e749d87001e548d527f44" />
<meta property="og:description" content="Bug 1466782 - Port bug 1466673: replace use of nsITreeColumn. r=bz" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 6c2b2979b2af1b7a927e749d87001e548d527f44 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/6c2b2979b2af1b7a927e749d87001e548d527f44">shortlog</a> |
<a href="/comm-central/log/6c2b2979b2af1b7a927e749d87001e548d527f44">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/6c2b2979b2af1b7a927e749d87001e548d527f44">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/6c2b2979b2af1b7a927e749d87001e548d527f44">files</a> |
changeset |
<a href="/comm-central/raw-rev/6c2b2979b2af1b7a927e749d87001e548d527f44">raw</a>  | <a href="/comm-central/archive/6c2b2979b2af1b7a927e749d87001e548d527f44.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1466782">Bug 1466782</a> - Port <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1466673">bug 1466673</a>: replace use of nsITreeColumn. r=bz
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 06 Jun 2018 22:33:30 +0200</td></tr>

<tr>
 <td>changeset 24058</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/6c2b2979b2af1b7a927e749d87001e548d527f44">6c2b2979b2af1b7a927e749d87001e548d527f44</a></td>
</tr>



<tr>
<td>parent 24057</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/15001f098daa00c14b623976fbcc09803aa0a897">15001f098daa00c14b623976fbcc09803aa0a897</a>
</td>
</tr>

<tr>
<td>child 24059</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/82206ad8748fd53cc2f2fc76295836a123d8583a">82206ad8748fd53cc2f2fc76295836a123d8583a</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=6c2b2979b2af1b7a927e749d87001e548d527f44">14503</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 06 Jun 2018 20:39:20 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@7a2b8cfdb36e [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7a2b8cfdb36e3cbcc3abd8a877772e4a39a7612b">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7a2b8cfdb36e3cbcc3abd8a877772e4a39a7612b&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7a2b8cfdb36e3cbcc3abd8a877772e4a39a7612b&newProject=comm-central&newRevision=15001f098daa00c14b623976fbcc09803aa0a897&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7a2b8cfdb36e3cbcc3abd8a877772e4a39a7612b&newProject=comm-central&newRevision=15001f098daa00c14b623976fbcc09803aa0a897&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7a2b8cfdb36e3cbcc3abd8a877772e4a39a7612b&newProject=comm-central&newRevision=15001f098daa00c14b623976fbcc09803aa0a897&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28bz%29&revcount=50">bz</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1466782">1466782</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1466673">1466673</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1466782">Bug 1466782</a> - Port <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1466673">bug 1466673</a>: replace use of nsITreeColumn. r=bz</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/addrbook/src/nsAbView.cpp">mailnews/addrbook/src/nsAbView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/addrbook/src/nsAbView.cpp">file</a> |
<a href="/comm-central/annotate/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/addrbook/src/nsAbView.cpp">annotate</a> |
<a href="/comm-central/diff/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/addrbook/src/nsAbView.cpp">diff</a> |
<a href="/comm-central/comparison/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/addrbook/src/nsAbView.cpp">comparison</a> |
<a href="/comm-central/log/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/addrbook/src/nsAbView.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/addrbook/src/nsAbView.h">mailnews/addrbook/src/nsAbView.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/addrbook/src/nsAbView.h">file</a> |
<a href="/comm-central/annotate/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/addrbook/src/nsAbView.h">annotate</a> |
<a href="/comm-central/diff/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/addrbook/src/nsAbView.h">diff</a> |
<a href="/comm-central/comparison/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/addrbook/src/nsAbView.h">comparison</a> |
<a href="/comm-central/log/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/addrbook/src/nsAbView.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgDBView.cpp">mailnews/base/src/nsMsgDBView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgDBView.cpp">file</a> |
<a href="/comm-central/annotate/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgDBView.cpp">annotate</a> |
<a href="/comm-central/diff/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgDBView.cpp">diff</a> |
<a href="/comm-central/comparison/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgDBView.cpp">comparison</a> |
<a href="/comm-central/log/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgDBView.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgDBView.h">mailnews/base/src/nsMsgDBView.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgDBView.h">file</a> |
<a href="/comm-central/annotate/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgDBView.h">annotate</a> |
<a href="/comm-central/diff/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgDBView.h">diff</a> |
<a href="/comm-central/comparison/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgDBView.h">comparison</a> |
<a href="/comm-central/log/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgDBView.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgGroupView.cpp">mailnews/base/src/nsMsgGroupView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgGroupView.cpp">file</a> |
<a href="/comm-central/annotate/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgGroupView.cpp">annotate</a> |
<a href="/comm-central/diff/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgGroupView.cpp">diff</a> |
<a href="/comm-central/comparison/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgGroupView.cpp">comparison</a> |
<a href="/comm-central/log/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgGroupView.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgGroupView.h">mailnews/base/src/nsMsgGroupView.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgGroupView.h">file</a> |
<a href="/comm-central/annotate/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgGroupView.h">annotate</a> |
<a href="/comm-central/diff/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgGroupView.h">diff</a> |
<a href="/comm-central/comparison/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgGroupView.h">comparison</a> |
<a href="/comm-central/log/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgGroupView.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgSearchDBView.cpp">mailnews/base/src/nsMsgSearchDBView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgSearchDBView.cpp">file</a> |
<a href="/comm-central/annotate/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgSearchDBView.cpp">annotate</a> |
<a href="/comm-central/diff/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgSearchDBView.cpp">diff</a> |
<a href="/comm-central/comparison/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgSearchDBView.cpp">comparison</a> |
<a href="/comm-central/log/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgSearchDBView.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgSearchDBView.h">mailnews/base/src/nsMsgSearchDBView.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgSearchDBView.h">file</a> |
<a href="/comm-central/annotate/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgSearchDBView.h">annotate</a> |
<a href="/comm-central/diff/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgSearchDBView.h">diff</a> |
<a href="/comm-central/comparison/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgSearchDBView.h">comparison</a> |
<a href="/comm-central/log/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgSearchDBView.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp">mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp">file</a> |
<a href="/comm-central/annotate/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp">annotate</a> |
<a href="/comm-central/diff/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp">diff</a> |
<a href="/comm-central/comparison/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp">comparison</a> |
<a href="/comm-central/log/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/news/src/nsNntpIncomingServer.cpp">mailnews/news/src/nsNntpIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/news/src/nsNntpIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/news/src/nsNntpIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/news/src/nsNntpIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/news/src/nsNntpIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/6c2b2979b2af1b7a927e749d87001e548d527f44/mailnews/news/src/nsNntpIncomingServer.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbView.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbView.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -9,17 +9,17 @@</span>
<a href="#l1.4"></a><span id="l1.4"> #include &quot;nsISupports.h&quot;</span>
<a href="#l1.5"></a><span id="l1.5"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l1.6"></a><span id="l1.6"> #include &quot;nsIAbCard.h&quot;</span>
<a href="#l1.7"></a><span id="l1.7"> #include &quot;prmem.h&quot;</span>
<a href="#l1.8"></a><span id="l1.8"> #include &quot;nsCollationCID.h&quot;</span>
<a href="#l1.9"></a><span id="l1.9"> #include &quot;nsIAbManager.h&quot;</span>
<a href="#l1.10"></a><span id="l1.10"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l1.11"></a><span id="l1.11"> #include &quot;nsXPCOM.h&quot;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-#include &quot;nsITreeColumns.h&quot;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+#include &quot;nsTreeColumns.h&quot;</span>
<a href="#l1.14"></a><span id="l1.14"> #include &quot;nsCRTGlue.h&quot;</span>
<a href="#l1.15"></a><span id="l1.15"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l1.16"></a><span id="l1.16"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l1.17"></a><span id="l1.17"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l1.18"></a><span id="l1.18"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l1.19"></a><span id="l1.19"> #include &quot;nsIPrefLocalizedString.h&quot;</span>
<a href="#l1.20"></a><span id="l1.20"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l1.21"></a><span id="l1.21"> #include &quot;nsIAddrDatabase.h&quot; // for kPhoneticNameColumn</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -247,17 +247,17 @@ NS_IMETHODIMP nsAbView::SetView(nsIAbDir</span>
<a href="#l1.23"></a><span id="l1.23">   nsAutoString actualSortColumn;</span>
<a href="#l1.24"></a><span id="l1.24">   if (!generatedNameColumnId.Equals(aSortColumn) &amp;&amp; mCards.Length()) {</span>
<a href="#l1.25"></a><span id="l1.25">     nsIAbCard *card = mCards.ElementAt(0)-&gt;card;</span>
<a href="#l1.26"></a><span id="l1.26">     nsString value;</span>
<a href="#l1.27"></a><span id="l1.27">     // XXX todo</span>
<a href="#l1.28"></a><span id="l1.28">     // Need to check if _Generic is valid.  GetCardValue() will always return NS_OK for _Generic</span>
<a href="#l1.29"></a><span id="l1.29">     // We're going to have to ask mDirectory if it is.</span>
<a href="#l1.30"></a><span id="l1.30">     // It might not be.  example:  _ScreenName is valid in Netscape, but not Mozilla.</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-    rv = GetCardValue(card, PromiseFlatString(aSortColumn).get(), value);</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+    rv = GetCardValue(card, aSortColumn, value);</span>
<a href="#l1.33"></a><span id="l1.33">     if (NS_FAILED(rv))</span>
<a href="#l1.34"></a><span id="l1.34">       actualSortColumn = generatedNameColumnId;</span>
<a href="#l1.35"></a><span id="l1.35">     else</span>
<a href="#l1.36"></a><span id="l1.36">       actualSortColumn = aSortColumn;</span>
<a href="#l1.37"></a><span id="l1.37">   }</span>
<a href="#l1.38"></a><span id="l1.38">   else</span>
<a href="#l1.39"></a><span id="l1.39">     actualSortColumn = aSortColumn;</span>
<a href="#l1.40"></a><span id="l1.40"> </span>
<a href="#l1.41"></a><span id="l1.41" class="difflineat">@@ -342,42 +342,41 @@ NS_IMETHODIMP nsAbView::SetSelection(nsI</span>
<a href="#l1.42"></a><span id="l1.42">   return NS_OK;</span>
<a href="#l1.43"></a><span id="l1.43"> }</span>
<a href="#l1.44"></a><span id="l1.44"> </span>
<a href="#l1.45"></a><span id="l1.45"> NS_IMETHODIMP nsAbView::GetRowProperties(int32_t index, nsAString&amp; properties)</span>
<a href="#l1.46"></a><span id="l1.46"> {</span>
<a href="#l1.47"></a><span id="l1.47">     return NS_OK;</span>
<a href="#l1.48"></a><span id="l1.48"> }</span>
<a href="#l1.49"></a><span id="l1.49"> </span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-NS_IMETHODIMP nsAbView::GetCellProperties(int32_t row, nsITreeColumn* col, nsAString&amp; properties)</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+NS_IMETHODIMP nsAbView::GetCellProperties(int32_t row, nsTreeColumn* col, nsAString&amp; properties)</span>
<a href="#l1.52"></a><span id="l1.52"> {</span>
<a href="#l1.53"></a><span id="l1.53">   NS_ENSURE_TRUE(row &gt;= 0, NS_ERROR_UNEXPECTED);</span>
<a href="#l1.54"></a><span id="l1.54"> </span>
<a href="#l1.55"></a><span id="l1.55">   if (mCards.Length() &lt;= (size_t)row)</span>
<a href="#l1.56"></a><span id="l1.56">     return NS_OK;</span>
<a href="#l1.57"></a><span id="l1.57"> </span>
<a href="#l1.58"></a><span id="l1.58" class="difflineminus">-  const char16_t* colID;</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-  col-&gt;GetIdConst(&amp;colID);</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+  const nsAString&amp; colID = col-&gt;GetId();</span>
<a href="#l1.61"></a><span id="l1.61">   // &quot;G&quot; == &quot;GeneratedName&quot;</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-  if (colID[0] != char16_t('G'))</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+  if (colID.IsEmpty() || colID.First() != 'G')</span>
<a href="#l1.64"></a><span id="l1.64">     return NS_OK;</span>
<a href="#l1.65"></a><span id="l1.65"> </span>
<a href="#l1.66"></a><span id="l1.66">   nsIAbCard *card = mCards.ElementAt(row)-&gt;card;</span>
<a href="#l1.67"></a><span id="l1.67"> </span>
<a href="#l1.68"></a><span id="l1.68">   bool isMailList;</span>
<a href="#l1.69"></a><span id="l1.69">   nsresult rv = card-&gt;GetIsMailList(&amp;isMailList);</span>
<a href="#l1.70"></a><span id="l1.70">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.71"></a><span id="l1.71"> </span>
<a href="#l1.72"></a><span id="l1.72">   if (isMailList)</span>
<a href="#l1.73"></a><span id="l1.73">     properties.AssignLiteral(&quot;MailList&quot;);</span>
<a href="#l1.74"></a><span id="l1.74"> </span>
<a href="#l1.75"></a><span id="l1.75">   return NS_OK;</span>
<a href="#l1.76"></a><span id="l1.76"> }</span>
<a href="#l1.77"></a><span id="l1.77"> </span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-NS_IMETHODIMP nsAbView::GetColumnProperties(nsITreeColumn* col, nsAString&amp; properties)</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+NS_IMETHODIMP nsAbView::GetColumnProperties(nsTreeColumn* col, nsAString&amp; properties)</span>
<a href="#l1.80"></a><span id="l1.80"> {</span>
<a href="#l1.81"></a><span id="l1.81">     return NS_OK;</span>
<a href="#l1.82"></a><span id="l1.82"> }</span>
<a href="#l1.83"></a><span id="l1.83"> </span>
<a href="#l1.84"></a><span id="l1.84"> NS_IMETHODIMP nsAbView::IsContainer(int32_t index, bool *_retval)</span>
<a href="#l1.85"></a><span id="l1.85"> {</span>
<a href="#l1.86"></a><span id="l1.86">     *_retval = false;</span>
<a href="#l1.87"></a><span id="l1.87">     return NS_OK;</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineat">@@ -431,30 +430,30 @@ NS_IMETHODIMP nsAbView::HasNextSibling(i</span>
<a href="#l1.89"></a><span id="l1.89"> }</span>
<a href="#l1.90"></a><span id="l1.90"> </span>
<a href="#l1.91"></a><span id="l1.91"> NS_IMETHODIMP nsAbView::GetLevel(int32_t index, int32_t *_retval)</span>
<a href="#l1.92"></a><span id="l1.92"> {</span>
<a href="#l1.93"></a><span id="l1.93">   *_retval = 0;</span>
<a href="#l1.94"></a><span id="l1.94">   return NS_OK;</span>
<a href="#l1.95"></a><span id="l1.95"> }</span>
<a href="#l1.96"></a><span id="l1.96"> </span>
<a href="#l1.97"></a><span id="l1.97" class="difflineminus">-NS_IMETHODIMP nsAbView::GetImageSrc(int32_t row, nsITreeColumn* col, nsAString&amp; _retval)</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineplus">+NS_IMETHODIMP nsAbView::GetImageSrc(int32_t row, nsTreeColumn* col, nsAString&amp; _retval)</span>
<a href="#l1.99"></a><span id="l1.99"> {</span>
<a href="#l1.100"></a><span id="l1.100">   return NS_OK;</span>
<a href="#l1.101"></a><span id="l1.101"> }</span>
<a href="#l1.102"></a><span id="l1.102"> </span>
<a href="#l1.103"></a><span id="l1.103" class="difflineminus">-NS_IMETHODIMP nsAbView::GetCellValue(int32_t row, nsITreeColumn* col, nsAString&amp; _retval)</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+NS_IMETHODIMP nsAbView::GetCellValue(int32_t row, nsTreeColumn* col, nsAString&amp; _retval)</span>
<a href="#l1.105"></a><span id="l1.105"> {</span>
<a href="#l1.106"></a><span id="l1.106">   return NS_OK;</span>
<a href="#l1.107"></a><span id="l1.107"> }</span>
<a href="#l1.108"></a><span id="l1.108"> </span>
<a href="#l1.109"></a><span id="l1.109" class="difflineminus">-nsresult nsAbView::GetCardValue(nsIAbCard *card, const char16_t *colID,</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineplus">+nsresult nsAbView::GetCardValue(nsIAbCard *card, const nsAString&amp; colID,</span>
<a href="#l1.111"></a><span id="l1.111">                                 nsAString &amp;_retval)</span>
<a href="#l1.112"></a><span id="l1.112"> {</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineminus">-  if (nsString(colID).EqualsLiteral(&quot;addrbook&quot;)) {</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineplus">+  if (colID.EqualsLiteral(&quot;addrbook&quot;)) {</span>
<a href="#l1.115"></a><span id="l1.115">     nsCString dirID;</span>
<a href="#l1.116"></a><span id="l1.116">     nsresult rv = card-&gt;GetDirectoryId(dirID);</span>
<a href="#l1.117"></a><span id="l1.117">     if (NS_SUCCEEDED(rv))</span>
<a href="#l1.118"></a><span id="l1.118">       CopyUTF8toUTF16(Substring(dirID, dirID.FindChar('&amp;') + 1), _retval);</span>
<a href="#l1.119"></a><span id="l1.119"> </span>
<a href="#l1.120"></a><span id="l1.120">     return rv;</span>
<a href="#l1.121"></a><span id="l1.121">   }</span>
<a href="#l1.122"></a><span id="l1.122"> </span>
<a href="#l1.123"></a><span id="l1.123" class="difflineat">@@ -462,17 +461,17 @@ nsresult nsAbView::GetCardValue(nsIAbCar</span>
<a href="#l1.124"></a><span id="l1.124">   // else, standard column (like PrimaryEmail and _AimScreenName)</span>
<a href="#l1.125"></a><span id="l1.125">   if (colID[0] == char16_t('G'))</span>
<a href="#l1.126"></a><span id="l1.126">     return card-&gt;GenerateName(mGeneratedNameFormat, mABBundle, _retval);</span>
<a href="#l1.127"></a><span id="l1.127"> </span>
<a href="#l1.128"></a><span id="l1.128">   if (colID[0] == char16_t('_') &amp;&amp; colID[1] == char16_t('P'))</span>
<a href="#l1.129"></a><span id="l1.129">     // Use LN/FN order for the phonetic name</span>
<a href="#l1.130"></a><span id="l1.130">     return card-&gt;GeneratePhoneticName(true, _retval);</span>
<a href="#l1.131"></a><span id="l1.131"> </span>
<a href="#l1.132"></a><span id="l1.132" class="difflineminus">-  if (!NS_strcmp(colID, u&quot;ChatName&quot;))</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineplus">+  if (colID.EqualsLiteral(&quot;ChatName&quot;))</span>
<a href="#l1.134"></a><span id="l1.134">     return card-&gt;GenerateChatName(_retval);</span>
<a href="#l1.135"></a><span id="l1.135"> </span>
<a href="#l1.136"></a><span id="l1.136">   nsresult rv = card-&gt;GetPropertyAsAString(NS_ConvertUTF16toUTF8(colID).get(), _retval);</span>
<a href="#l1.137"></a><span id="l1.137">   if (rv == NS_ERROR_NOT_AVAILABLE) {</span>
<a href="#l1.138"></a><span id="l1.138">     rv = NS_OK;</span>
<a href="#l1.139"></a><span id="l1.139">     _retval.Truncate();</span>
<a href="#l1.140"></a><span id="l1.140">   }</span>
<a href="#l1.141"></a><span id="l1.141">   return rv;</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineat">@@ -510,38 +509,37 @@ nsresult nsAbView::RefreshTree()</span>
<a href="#l1.143"></a><span id="l1.143">     // to be displayed differently, therefore pretend that the selection has</span>
<a href="#l1.144"></a><span id="l1.144">     // changed to force that update.</span>
<a href="#l1.145"></a><span id="l1.145">     SelectionChanged();</span>
<a href="#l1.146"></a><span id="l1.146">   }</span>
<a href="#l1.147"></a><span id="l1.147"> </span>
<a href="#l1.148"></a><span id="l1.148">   return rv;</span>
<a href="#l1.149"></a><span id="l1.149"> }</span>
<a href="#l1.150"></a><span id="l1.150"> </span>
<a href="#l1.151"></a><span id="l1.151" class="difflineminus">-NS_IMETHODIMP nsAbView::GetCellText(int32_t row, nsITreeColumn* col, nsAString&amp; _retval)</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineplus">+NS_IMETHODIMP nsAbView::GetCellText(int32_t row, nsTreeColumn* col, nsAString&amp; _retval)</span>
<a href="#l1.153"></a><span id="l1.153"> {</span>
<a href="#l1.154"></a><span id="l1.154">   NS_ENSURE_TRUE(row &gt;= 0 &amp;&amp; (size_t)row &lt; mCards.Length(), NS_ERROR_UNEXPECTED);</span>
<a href="#l1.155"></a><span id="l1.155"> </span>
<a href="#l1.156"></a><span id="l1.156">   nsIAbCard *card = mCards.ElementAt(row)-&gt;card;</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineminus">-  const char16_t* colID;</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineminus">-  col-&gt;GetIdConst(&amp;colID);</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineplus">+  const nsAString&amp; colID = col-&gt;GetId();</span>
<a href="#l1.160"></a><span id="l1.160">   return GetCardValue(card, colID, _retval);</span>
<a href="#l1.161"></a><span id="l1.161"> }</span>
<a href="#l1.162"></a><span id="l1.162"> </span>
<a href="#l1.163"></a><span id="l1.163"> NS_IMETHODIMP nsAbView::SetTree(nsITreeBoxObject *tree)</span>
<a href="#l1.164"></a><span id="l1.164"> {</span>
<a href="#l1.165"></a><span id="l1.165">   mTree = tree;</span>
<a href="#l1.166"></a><span id="l1.166">   return NS_OK;</span>
<a href="#l1.167"></a><span id="l1.167"> }</span>
<a href="#l1.168"></a><span id="l1.168"> </span>
<a href="#l1.169"></a><span id="l1.169"> NS_IMETHODIMP nsAbView::ToggleOpenState(int32_t index)</span>
<a href="#l1.170"></a><span id="l1.170"> {</span>
<a href="#l1.171"></a><span id="l1.171">     return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l1.172"></a><span id="l1.172"> }</span>
<a href="#l1.173"></a><span id="l1.173"> </span>
<a href="#l1.174"></a><span id="l1.174" class="difflineminus">-NS_IMETHODIMP nsAbView::CycleHeader(nsITreeColumn* col)</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineplus">+NS_IMETHODIMP nsAbView::CycleHeader(nsTreeColumn* col)</span>
<a href="#l1.176"></a><span id="l1.176"> {</span>
<a href="#l1.177"></a><span id="l1.177">   return NS_OK;</span>
<a href="#l1.178"></a><span id="l1.178"> }</span>
<a href="#l1.179"></a><span id="l1.179"> </span>
<a href="#l1.180"></a><span id="l1.180"> nsresult nsAbView::InvalidateTree(int32_t row)</span>
<a href="#l1.181"></a><span id="l1.181"> {</span>
<a href="#l1.182"></a><span id="l1.182">   if (!mTree)</span>
<a href="#l1.183"></a><span id="l1.183">     return NS_OK;</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineat">@@ -556,52 +554,52 @@ NS_IMETHODIMP nsAbView::SelectionChanged</span>
<a href="#l1.185"></a><span id="l1.185"> {</span>
<a href="#l1.186"></a><span id="l1.186">   if (mAbViewListener &amp;&amp; !mSuppressSelectionChange) {</span>
<a href="#l1.187"></a><span id="l1.187">     nsresult rv = mAbViewListener-&gt;OnSelectionChanged();</span>
<a href="#l1.188"></a><span id="l1.188">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.189"></a><span id="l1.189">   }</span>
<a href="#l1.190"></a><span id="l1.190">   return NS_OK;</span>
<a href="#l1.191"></a><span id="l1.191"> }</span>
<a href="#l1.192"></a><span id="l1.192"> </span>
<a href="#l1.193"></a><span id="l1.193" class="difflineminus">-NS_IMETHODIMP nsAbView::CycleCell(int32_t row, nsITreeColumn* col)</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineplus">+NS_IMETHODIMP nsAbView::CycleCell(int32_t row, nsTreeColumn* col)</span>
<a href="#l1.195"></a><span id="l1.195"> {</span>
<a href="#l1.196"></a><span id="l1.196">     return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l1.197"></a><span id="l1.197"> }</span>
<a href="#l1.198"></a><span id="l1.198"> </span>
<a href="#l1.199"></a><span id="l1.199" class="difflineminus">-NS_IMETHODIMP nsAbView::IsEditable(int32_t row, nsITreeColumn* col, bool* _retval)</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineplus">+NS_IMETHODIMP nsAbView::IsEditable(int32_t row, nsTreeColumn* col, bool* _retval)</span>
<a href="#l1.201"></a><span id="l1.201"> {</span>
<a href="#l1.202"></a><span id="l1.202">     return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l1.203"></a><span id="l1.203"> }</span>
<a href="#l1.204"></a><span id="l1.204"> </span>
<a href="#l1.205"></a><span id="l1.205" class="difflineminus">-NS_IMETHODIMP nsAbView::IsSelectable(int32_t row, nsITreeColumn* col, bool* _retval)</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineplus">+NS_IMETHODIMP nsAbView::IsSelectable(int32_t row, nsTreeColumn* col, bool* _retval)</span>
<a href="#l1.207"></a><span id="l1.207"> {</span>
<a href="#l1.208"></a><span id="l1.208">     return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l1.209"></a><span id="l1.209"> }</span>
<a href="#l1.210"></a><span id="l1.210"> </span>
<a href="#l1.211"></a><span id="l1.211" class="difflineminus">-NS_IMETHODIMP nsAbView::SetCellValue(int32_t row, nsITreeColumn* col, const nsAString&amp; value)</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineplus">+NS_IMETHODIMP nsAbView::SetCellValue(int32_t row, nsTreeColumn* col, const nsAString&amp; value)</span>
<a href="#l1.213"></a><span id="l1.213"> {</span>
<a href="#l1.214"></a><span id="l1.214">     return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l1.215"></a><span id="l1.215"> }</span>
<a href="#l1.216"></a><span id="l1.216"> </span>
<a href="#l1.217"></a><span id="l1.217" class="difflineminus">-NS_IMETHODIMP nsAbView::SetCellText(int32_t row, nsITreeColumn* col, const nsAString&amp; value)</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineplus">+NS_IMETHODIMP nsAbView::SetCellText(int32_t row, nsTreeColumn* col, const nsAString&amp; value)</span>
<a href="#l1.219"></a><span id="l1.219"> {</span>
<a href="#l1.220"></a><span id="l1.220">     return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l1.221"></a><span id="l1.221"> }</span>
<a href="#l1.222"></a><span id="l1.222"> </span>
<a href="#l1.223"></a><span id="l1.223"> NS_IMETHODIMP nsAbView::PerformAction(const char16_t *action)</span>
<a href="#l1.224"></a><span id="l1.224"> {</span>
<a href="#l1.225"></a><span id="l1.225">     return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l1.226"></a><span id="l1.226"> }</span>
<a href="#l1.227"></a><span id="l1.227"> </span>
<a href="#l1.228"></a><span id="l1.228"> NS_IMETHODIMP nsAbView::PerformActionOnRow(const char16_t *action, int32_t row)</span>
<a href="#l1.229"></a><span id="l1.229"> {</span>
<a href="#l1.230"></a><span id="l1.230">     return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l1.231"></a><span id="l1.231"> }</span>
<a href="#l1.232"></a><span id="l1.232"> </span>
<a href="#l1.233"></a><span id="l1.233" class="difflineminus">-NS_IMETHODIMP nsAbView::PerformActionOnCell(const char16_t *action, int32_t row, nsITreeColumn* col)</span>
<a href="#l1.234"></a><span id="l1.234" class="difflineplus">+NS_IMETHODIMP nsAbView::PerformActionOnCell(const char16_t *action, int32_t row, nsTreeColumn* col)</span>
<a href="#l1.235"></a><span id="l1.235"> {</span>
<a href="#l1.236"></a><span id="l1.236">     return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l1.237"></a><span id="l1.237"> }</span>
<a href="#l1.238"></a><span id="l1.238"> </span>
<a href="#l1.239"></a><span id="l1.239"> NS_IMETHODIMP nsAbView::GetCardFromRow(int32_t row, nsIAbCard **aCard)</span>
<a href="#l1.240"></a><span id="l1.240"> {</span>
<a href="#l1.241"></a><span id="l1.241">   *aCard = nullptr;</span>
<a href="#l1.242"></a><span id="l1.242">   NS_ENSURE_TRUE(row &gt;= 0, NS_ERROR_UNEXPECTED);</span>
<a href="#l1.243"></a><span id="l1.243" class="difflineat">@@ -717,17 +715,17 @@ NS_IMETHODIMP nsAbView::SortBy(const cha</span>
<a href="#l1.244"></a><span id="l1.244">       mSortDirection = sortDir;</span>
<a href="#l1.245"></a><span id="l1.245">     }</span>
<a href="#l1.246"></a><span id="l1.246">   }</span>
<a href="#l1.247"></a><span id="l1.247">   else {</span>
<a href="#l1.248"></a><span id="l1.248">     // Generate collation keys</span>
<a href="#l1.249"></a><span id="l1.249">     for (int32_t i = 0; i &lt; count; i++) {</span>
<a href="#l1.250"></a><span id="l1.250">       AbCard *abcard = mCards.ElementAt(i);</span>
<a href="#l1.251"></a><span id="l1.251"> </span>
<a href="#l1.252"></a><span id="l1.252" class="difflineminus">-      rv = GenerateCollationKeysForCard(sortColumn.get(), abcard);</span>
<a href="#l1.253"></a><span id="l1.253" class="difflineplus">+      rv = GenerateCollationKeysForCard(sortColumn, abcard);</span>
<a href="#l1.254"></a><span id="l1.254">       NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.255"></a><span id="l1.255">     }</span>
<a href="#l1.256"></a><span id="l1.256"> </span>
<a href="#l1.257"></a><span id="l1.257">     // We need to do full sort.</span>
<a href="#l1.258"></a><span id="l1.258">     SortClosure closure;</span>
<a href="#l1.259"></a><span id="l1.259">     SetSortClosure(sortColumn.get(), sortDirection.get(), this, &amp;closure);</span>
<a href="#l1.260"></a><span id="l1.260"> </span>
<a href="#l1.261"></a><span id="l1.261">     nsCOMPtr&lt;nsIMutableArray&gt; selectedCards = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l1.262"></a><span id="l1.262" class="difflineat">@@ -776,17 +774,17 @@ int32_t nsAbView::CompareCollationKeys(u</span>
<a href="#l1.263"></a><span id="l1.263"> </span>
<a href="#l1.264"></a><span id="l1.264">   nsresult rv = mCollationKeyGenerator-&gt;CompareRawSortKey(key1,len1,key2,len2,&amp;result);</span>
<a href="#l1.265"></a><span id="l1.265">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;key compare failed&quot;);</span>
<a href="#l1.266"></a><span id="l1.266">   if (NS_FAILED(rv))</span>
<a href="#l1.267"></a><span id="l1.267">     result = 0;</span>
<a href="#l1.268"></a><span id="l1.268">   return result;</span>
<a href="#l1.269"></a><span id="l1.269"> }</span>
<a href="#l1.270"></a><span id="l1.270"> </span>
<a href="#l1.271"></a><span id="l1.271" class="difflineminus">-nsresult nsAbView::GenerateCollationKeysForCard(const char16_t *colID, AbCard *abcard)</span>
<a href="#l1.272"></a><span id="l1.272" class="difflineplus">+nsresult nsAbView::GenerateCollationKeysForCard(const nsAString&amp; colID, AbCard *abcard)</span>
<a href="#l1.273"></a><span id="l1.273"> {</span>
<a href="#l1.274"></a><span id="l1.274">   nsresult rv;</span>
<a href="#l1.275"></a><span id="l1.275">   nsString value;</span>
<a href="#l1.276"></a><span id="l1.276"> </span>
<a href="#l1.277"></a><span id="l1.277">   if (!mCollationKeyGenerator)</span>
<a href="#l1.278"></a><span id="l1.278">   {</span>
<a href="#l1.279"></a><span id="l1.279">     nsCOMPtr &lt;nsICollationFactory&gt; factory = do_CreateInstance(NS_COLLATIONFACTORY_CONTRACTID, &amp;rv);</span>
<a href="#l1.280"></a><span id="l1.280">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.281"></a><span id="l1.281" class="difflineat">@@ -871,17 +869,17 @@ NS_IMETHODIMP nsAbView::OnItemAdded(nsIS</span>
<a href="#l1.282"></a><span id="l1.282">       // Malloc these from an arena</span>
<a href="#l1.283"></a><span id="l1.283">       AbCard *abcard = (AbCard *) PR_Calloc(1, sizeof(struct AbCard));</span>
<a href="#l1.284"></a><span id="l1.284">       if (!abcard)</span>
<a href="#l1.285"></a><span id="l1.285">         return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l1.286"></a><span id="l1.286"> </span>
<a href="#l1.287"></a><span id="l1.287">       abcard-&gt;card = addedCard;</span>
<a href="#l1.288"></a><span id="l1.288">       NS_IF_ADDREF(abcard-&gt;card);</span>
<a href="#l1.289"></a><span id="l1.289"> </span>
<a href="#l1.290"></a><span id="l1.290" class="difflineminus">-      rv = GenerateCollationKeysForCard(mSortColumn.get(), abcard);</span>
<a href="#l1.291"></a><span id="l1.291" class="difflineplus">+      rv = GenerateCollationKeysForCard(mSortColumn, abcard);</span>
<a href="#l1.292"></a><span id="l1.292">       NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.293"></a><span id="l1.293"> </span>
<a href="#l1.294"></a><span id="l1.294">       int32_t index;</span>
<a href="#l1.295"></a><span id="l1.295">       rv = AddCard(abcard, false /* select card */, &amp;index);</span>
<a href="#l1.296"></a><span id="l1.296">       NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.297"></a><span id="l1.297">     }</span>
<a href="#l1.298"></a><span id="l1.298">   }</span>
<a href="#l1.299"></a><span id="l1.299">   return rv;</span>
<a href="#l1.300"></a><span id="l1.300" class="difflineat">@@ -1050,17 +1048,17 @@ NS_IMETHODIMP nsAbView::OnItemPropertyCh</span>
<a href="#l1.301"></a><span id="l1.301">   // Malloc these from an arena</span>
<a href="#l1.302"></a><span id="l1.302">   AbCard *newCard = (AbCard *) PR_Calloc(1, sizeof(struct AbCard));</span>
<a href="#l1.303"></a><span id="l1.303">   if (!newCard)</span>
<a href="#l1.304"></a><span id="l1.304">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l1.305"></a><span id="l1.305"> </span>
<a href="#l1.306"></a><span id="l1.306">   newCard-&gt;card = card;</span>
<a href="#l1.307"></a><span id="l1.307">   NS_IF_ADDREF(newCard-&gt;card);</span>
<a href="#l1.308"></a><span id="l1.308"> </span>
<a href="#l1.309"></a><span id="l1.309" class="difflineminus">-  rv = GenerateCollationKeysForCard(mSortColumn.get(), newCard);</span>
<a href="#l1.310"></a><span id="l1.310" class="difflineplus">+  rv = GenerateCollationKeysForCard(mSortColumn, newCard);</span>
<a href="#l1.311"></a><span id="l1.311">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.312"></a><span id="l1.312"> </span>
<a href="#l1.313"></a><span id="l1.313">   bool cardWasSelected = false;</span>
<a href="#l1.314"></a><span id="l1.314"> </span>
<a href="#l1.315"></a><span id="l1.315">   if (mTreeSelection) {</span>
<a href="#l1.316"></a><span id="l1.316">     rv = mTreeSelection-&gt;IsSelected(index, &amp;cardWasSelected);</span>
<a href="#l1.317"></a><span id="l1.317">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.318"></a><span id="l1.318">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbView.h</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbView.h</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -45,26 +45,26 @@ public:</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5">   int32_t CompareCollationKeys(uint8_t *key1, uint32_t len1, uint8_t *key2, uint32_t len2);</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> private:</span>
<a href="#l2.8"></a><span id="l2.8">   virtual ~nsAbView();</span>
<a href="#l2.9"></a><span id="l2.9">   nsresult Initialize();</span>
<a href="#l2.10"></a><span id="l2.10">   int32_t FindIndexForInsert(AbCard *abcard);</span>
<a href="#l2.11"></a><span id="l2.11">   int32_t FindIndexForCard(nsIAbCard *card);</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  nsresult GenerateCollationKeysForCard(const char16_t *colID, AbCard *abcard);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+  nsresult GenerateCollationKeysForCard(const nsAString&amp; colID, AbCard *abcard);</span>
<a href="#l2.14"></a><span id="l2.14">   nsresult InvalidateTree(int32_t row);</span>
<a href="#l2.15"></a><span id="l2.15">   nsresult RemoveCardAt(int32_t row);</span>
<a href="#l2.16"></a><span id="l2.16">   nsresult AddCard(AbCard *abcard, bool selectCardAfterAdding, int32_t *index);</span>
<a href="#l2.17"></a><span id="l2.17">   nsresult RemoveCardAndSelectNextCard(nsISupports *item);</span>
<a href="#l2.18"></a><span id="l2.18">   nsresult EnumerateCards();</span>
<a href="#l2.19"></a><span id="l2.19">   nsresult SetGeneratedNameFormatFromPrefs();</span>
<a href="#l2.20"></a><span id="l2.20">   nsresult GetSelectedCards(nsCOMPtr&lt;nsIMutableArray&gt; &amp;aSelectedCards);</span>
<a href="#l2.21"></a><span id="l2.21">   nsresult ReselectCards(nsIArray *aCards, nsIAbCard *aIndexCard);</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-  nsresult GetCardValue(nsIAbCard *card, const char16_t *colID, nsAString &amp;_retval);</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+  nsresult GetCardValue(nsIAbCard *card, const nsAString&amp; colID, nsAString &amp;_retval);</span>
<a href="#l2.24"></a><span id="l2.24">   nsresult RefreshTree();</span>
<a href="#l2.25"></a><span id="l2.25"> </span>
<a href="#l2.26"></a><span id="l2.26">   nsCOMPtr&lt;nsITreeBoxObject&gt; mTree;</span>
<a href="#l2.27"></a><span id="l2.27">   nsCOMPtr&lt;nsITreeSelection&gt; mTreeSelection;</span>
<a href="#l2.28"></a><span id="l2.28">   nsCOMPtr &lt;nsIAbDirectory&gt; mDirectory;</span>
<a href="#l2.29"></a><span id="l2.29">   nsTArray&lt;AbCard*&gt; mCards;</span>
<a href="#l2.30"></a><span id="l2.30">   nsString mSortColumn;</span>
<a href="#l2.31"></a><span id="l2.31">   nsString mSortDirection;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/src/nsMsgDBView.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgDBView.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -24,17 +24,17 @@</span>
<a href="#l3.4"></a><span id="l3.4"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l3.5"></a><span id="l3.5"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l3.6"></a><span id="l3.6"> #include &quot;nsIPrefLocalizedString.h&quot;</span>
<a href="#l3.7"></a><span id="l3.7"> #include &quot;nsIMsgSearchSession.h&quot;</span>
<a href="#l3.8"></a><span id="l3.8"> #include &quot;nsIMsgCopyService.h&quot;</span>
<a href="#l3.9"></a><span id="l3.9"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l3.10"></a><span id="l3.10"> #include &quot;nsISpamSettings.h&quot;</span>
<a href="#l3.11"></a><span id="l3.11"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-#include &quot;nsITreeColumns.h&quot;</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+#include &quot;nsTreeColumns.h&quot;</span>
<a href="#l3.14"></a><span id="l3.14"> #include &quot;nsTextFormatter.h&quot;</span>
<a href="#l3.15"></a><span id="l3.15"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l3.16"></a><span id="l3.16"> #include &quot;nsIMimeConverter.h&quot;</span>
<a href="#l3.17"></a><span id="l3.17"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l3.18"></a><span id="l3.18"> #include &quot;nsIPrompt.h&quot;</span>
<a href="#l3.19"></a><span id="l3.19"> #include &quot;nsIWindowWatcher.h&quot;</span>
<a href="#l3.20"></a><span id="l3.20"> #include &quot;nsMsgDBCID.h&quot;</span>
<a href="#l3.21"></a><span id="l3.21"> #include &quot;nsIMsgFolderNotificationService.h&quot;</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -1039,58 +1039,56 @@ nsMsgDBView::GenerateURIForMsgKey(nsMsgK</span>
<a href="#l3.23"></a><span id="l3.23"> nsresult</span>
<a href="#l3.24"></a><span id="l3.24"> nsMsgDBView::GetMessageEnumerator(nsISimpleEnumerator **enumerator)</span>
<a href="#l3.25"></a><span id="l3.25"> {</span>
<a href="#l3.26"></a><span id="l3.26">   return m_db-&gt;EnumerateMessages(enumerator);</span>
<a href="#l3.27"></a><span id="l3.27"> }</span>
<a href="#l3.28"></a><span id="l3.28"> </span>
<a href="#l3.29"></a><span id="l3.29"> NS_IMETHODIMP</span>
<a href="#l3.30"></a><span id="l3.30"> nsMsgDBView::IsEditable(int32_t row,</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-                        nsITreeColumn* col,</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+                        nsTreeColumn* col,</span>
<a href="#l3.33"></a><span id="l3.33">                         bool* _retval)</span>
<a href="#l3.34"></a><span id="l3.34"> {</span>
<a href="#l3.35"></a><span id="l3.35">   NS_ENSURE_ARG_POINTER(col);</span>
<a href="#l3.36"></a><span id="l3.36">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l3.37"></a><span id="l3.37">   // Attempt to retrieve a custom column handler. If it exists call it and</span>
<a href="#l3.38"></a><span id="l3.38">   // return.</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-  const char16_t* colID;</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-  col-&gt;GetIdConst(&amp;colID);</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+  const nsAString&amp; colID = col-&gt;GetId();</span>
<a href="#l3.43"></a><span id="l3.43">   nsIMsgCustomColumnHandler* colHandler = GetColumnHandler(colID);</span>
<a href="#l3.44"></a><span id="l3.44"> </span>
<a href="#l3.45"></a><span id="l3.45">   if (colHandler)</span>
<a href="#l3.46"></a><span id="l3.46">   {</span>
<a href="#l3.47"></a><span id="l3.47">     colHandler-&gt;IsEditable(row, col, _retval);</span>
<a href="#l3.48"></a><span id="l3.48">     return NS_OK;</span>
<a href="#l3.49"></a><span id="l3.49">   }</span>
<a href="#l3.50"></a><span id="l3.50"> </span>
<a href="#l3.51"></a><span id="l3.51">   *_retval = false;</span>
<a href="#l3.52"></a><span id="l3.52">   return NS_OK;</span>
<a href="#l3.53"></a><span id="l3.53"> }</span>
<a href="#l3.54"></a><span id="l3.54"> </span>
<a href="#l3.55"></a><span id="l3.55"> NS_IMETHODIMP</span>
<a href="#l3.56"></a><span id="l3.56"> nsMsgDBView::IsSelectable(int32_t row,</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-                          nsITreeColumn* col,</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+                          nsTreeColumn* col,</span>
<a href="#l3.59"></a><span id="l3.59">                           bool* _retval)</span>
<a href="#l3.60"></a><span id="l3.60"> {</span>
<a href="#l3.61"></a><span id="l3.61">   *_retval = false;</span>
<a href="#l3.62"></a><span id="l3.62">   return NS_OK;</span>
<a href="#l3.63"></a><span id="l3.63"> }</span>
<a href="#l3.64"></a><span id="l3.64"> </span>
<a href="#l3.65"></a><span id="l3.65"> NS_IMETHODIMP</span>
<a href="#l3.66"></a><span id="l3.66"> nsMsgDBView::SetCellValue(int32_t row,</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-                          nsITreeColumn* col,</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+                          nsTreeColumn* col,</span>
<a href="#l3.69"></a><span id="l3.69">                           const nsAString&amp; value)</span>
<a href="#l3.70"></a><span id="l3.70"> {</span>
<a href="#l3.71"></a><span id="l3.71">   return NS_OK;</span>
<a href="#l3.72"></a><span id="l3.72"> }</span>
<a href="#l3.73"></a><span id="l3.73"> </span>
<a href="#l3.74"></a><span id="l3.74"> NS_IMETHODIMP</span>
<a href="#l3.75"></a><span id="l3.75"> nsMsgDBView::SetCellText(int32_t row,</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-                         nsITreeColumn* col,</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+                         nsTreeColumn* col,</span>
<a href="#l3.78"></a><span id="l3.78">                          const nsAString&amp; value)</span>
<a href="#l3.79"></a><span id="l3.79"> {</span>
<a href="#l3.80"></a><span id="l3.80">   return NS_OK;</span>
<a href="#l3.81"></a><span id="l3.81"> }</span>
<a href="#l3.82"></a><span id="l3.82"> </span>
<a href="#l3.83"></a><span id="l3.83"> NS_IMETHODIMP</span>
<a href="#l3.84"></a><span id="l3.84"> nsMsgDBView::GetRowCount(int32_t *aRowCount)</span>
<a href="#l3.85"></a><span id="l3.85"> {</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineat">@@ -1438,24 +1436,24 @@ nsMsgDBView::GetRowProperties(int32_t in</span>
<a href="#l3.87"></a><span id="l3.87">       properties.Append(extra);</span>
<a href="#l3.88"></a><span id="l3.88">     }</span>
<a href="#l3.89"></a><span id="l3.89">   }</span>
<a href="#l3.90"></a><span id="l3.90"> </span>
<a href="#l3.91"></a><span id="l3.91">   return NS_OK;</span>
<a href="#l3.92"></a><span id="l3.92"> }</span>
<a href="#l3.93"></a><span id="l3.93"> </span>
<a href="#l3.94"></a><span id="l3.94"> NS_IMETHODIMP</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineminus">-nsMsgDBView::GetColumnProperties(nsITreeColumn* col, nsAString&amp; properties)</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+nsMsgDBView::GetColumnProperties(nsTreeColumn* col, nsAString&amp; properties)</span>
<a href="#l3.97"></a><span id="l3.97"> {</span>
<a href="#l3.98"></a><span id="l3.98">   return NS_OK;</span>
<a href="#l3.99"></a><span id="l3.99"> }</span>
<a href="#l3.100"></a><span id="l3.100"> </span>
<a href="#l3.101"></a><span id="l3.101"> NS_IMETHODIMP</span>
<a href="#l3.102"></a><span id="l3.102"> nsMsgDBView::GetCellProperties(int32_t aRow,</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineminus">-                               nsITreeColumn *col,</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+                               nsTreeColumn *col,</span>
<a href="#l3.105"></a><span id="l3.105">                                nsAString&amp; properties)</span>
<a href="#l3.106"></a><span id="l3.106"> {</span>
<a href="#l3.107"></a><span id="l3.107">   if (!IsValidIndex(aRow))</span>
<a href="#l3.108"></a><span id="l3.108">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l3.109"></a><span id="l3.109"> </span>
<a href="#l3.110"></a><span id="l3.110">   // This is where we tell the tree to apply styles to a particular row</span>
<a href="#l3.111"></a><span id="l3.111">   // i.e. if the row is an unread message...</span>
<a href="#l3.112"></a><span id="l3.112"> </span>
<a href="#l3.113"></a><span id="l3.113" class="difflineat">@@ -1465,18 +1463,17 @@ nsMsgDBView::GetCellProperties(int32_t a</span>
<a href="#l3.114"></a><span id="l3.114">   rv = GetMsgHdrForViewIndex(aRow, getter_AddRefs(msgHdr));</span>
<a href="#l3.115"></a><span id="l3.115"> </span>
<a href="#l3.116"></a><span id="l3.116">   if (NS_FAILED(rv) || !msgHdr)</span>
<a href="#l3.117"></a><span id="l3.117">   {</span>
<a href="#l3.118"></a><span id="l3.118">     ClearHdrCache();</span>
<a href="#l3.119"></a><span id="l3.119">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l3.120"></a><span id="l3.120">   }</span>
<a href="#l3.121"></a><span id="l3.121"> </span>
<a href="#l3.122"></a><span id="l3.122" class="difflineminus">-  const char16_t* colID;</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineminus">-  col-&gt;GetIdConst(&amp;colID);</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+  const nsAString&amp; colID = col-&gt;GetId();</span>
<a href="#l3.125"></a><span id="l3.125">   nsIMsgCustomColumnHandler* colHandler = GetColumnHandler(colID);</span>
<a href="#l3.126"></a><span id="l3.126">   if (colHandler != nullptr)</span>
<a href="#l3.127"></a><span id="l3.127">   {</span>
<a href="#l3.128"></a><span id="l3.128">     colHandler-&gt;GetCellProperties(aRow, col, properties);</span>
<a href="#l3.129"></a><span id="l3.129">   }</span>
<a href="#l3.130"></a><span id="l3.130">   else if (colID[0] == 'c')</span>
<a href="#l3.131"></a><span id="l3.131">   {</span>
<a href="#l3.132"></a><span id="l3.132">     // Correspondent.</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineat">@@ -1848,64 +1845,64 @@ nsMsgDBView::GetDBForViewIndex(nsMsgView</span>
<a href="#l3.134"></a><span id="l3.134">                                nsIMsgDatabase **db)</span>
<a href="#l3.135"></a><span id="l3.135"> {</span>
<a href="#l3.136"></a><span id="l3.136">   NS_IF_ADDREF(*db = m_db);</span>
<a href="#l3.137"></a><span id="l3.137">   return NS_OK;</span>
<a href="#l3.138"></a><span id="l3.138"> }</span>
<a href="#l3.139"></a><span id="l3.139"> </span>
<a href="#l3.140"></a><span id="l3.140"> NS_IMETHODIMP</span>
<a href="#l3.141"></a><span id="l3.141"> nsMsgDBView::GetImageSrc(int32_t aRow,</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineminus">-                         nsITreeColumn* aCol,</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+                         nsTreeColumn* aCol,</span>
<a href="#l3.144"></a><span id="l3.144">                          nsAString&amp; aValue)</span>
<a href="#l3.145"></a><span id="l3.145"> {</span>
<a href="#l3.146"></a><span id="l3.146">   NS_ENSURE_ARG_POINTER(aCol);</span>
<a href="#l3.147"></a><span id="l3.147">   // Attempt to retrieve a custom column handler. If it exists call it and</span>
<a href="#l3.148"></a><span id="l3.148">   // return.</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineminus">-  const char16_t* colID;</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineminus">-  aCol-&gt;GetIdConst(&amp;colID);</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineminus">-</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineplus">+  const nsAString&amp; colID = aCol-&gt;GetId();</span>
<a href="#l3.153"></a><span id="l3.153">   nsIMsgCustomColumnHandler* colHandler = GetColumnHandler(colID);</span>
<a href="#l3.154"></a><span id="l3.154"> </span>
<a href="#l3.155"></a><span id="l3.155">   if (colHandler)</span>
<a href="#l3.156"></a><span id="l3.156">   {</span>
<a href="#l3.157"></a><span id="l3.157">     colHandler-&gt;GetImageSrc(aRow, aCol, aValue);</span>
<a href="#l3.158"></a><span id="l3.158">     return NS_OK;</span>
<a href="#l3.159"></a><span id="l3.159">   }</span>
<a href="#l3.160"></a><span id="l3.160"> </span>
<a href="#l3.161"></a><span id="l3.161">   return NS_OK;</span>
<a href="#l3.162"></a><span id="l3.162"> }</span>
<a href="#l3.163"></a><span id="l3.163"> </span>
<a href="#l3.164"></a><span id="l3.164"> NS_IMETHODIMP</span>
<a href="#l3.165"></a><span id="l3.165"> nsMsgDBView::GetCellValue(int32_t aRow,</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineminus">-                          nsITreeColumn* aCol,</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineplus">+                          nsTreeColumn* aCol,</span>
<a href="#l3.168"></a><span id="l3.168">                           nsAString&amp; aValue)</span>
<a href="#l3.169"></a><span id="l3.169"> {</span>
<a href="#l3.170"></a><span id="l3.170">   if (!IsValidIndex(aRow))</span>
<a href="#l3.171"></a><span id="l3.171">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l3.172"></a><span id="l3.172"> </span>
<a href="#l3.173"></a><span id="l3.173">   nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l3.174"></a><span id="l3.174">   nsresult rv = GetMsgHdrForViewIndex(aRow, getter_AddRefs(msgHdr));</span>
<a href="#l3.175"></a><span id="l3.175"> </span>
<a href="#l3.176"></a><span id="l3.176">   if (NS_FAILED(rv) || !msgHdr)</span>
<a href="#l3.177"></a><span id="l3.177">   {</span>
<a href="#l3.178"></a><span id="l3.178">     ClearHdrCache();</span>
<a href="#l3.179"></a><span id="l3.179">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l3.180"></a><span id="l3.180">   }</span>
<a href="#l3.181"></a><span id="l3.181"> </span>
<a href="#l3.182"></a><span id="l3.182" class="difflineminus">-  const char16_t* colID;</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineminus">-  aCol-&gt;GetIdConst(&amp;colID);</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineplus">+  const nsAString&amp; colID = aCol-&gt;GetId();</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineplus">+</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineplus">+  aValue.Truncate();</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineplus">+  if (colID.IsEmpty())</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineplus">+    return NS_OK;</span>
<a href="#l3.189"></a><span id="l3.189"> </span>
<a href="#l3.190"></a><span id="l3.190">   uint32_t flags;</span>
<a href="#l3.191"></a><span id="l3.191">   msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l3.192"></a><span id="l3.192"> </span>
<a href="#l3.193"></a><span id="l3.193" class="difflineminus">-  aValue.Truncate();</span>
<a href="#l3.194"></a><span id="l3.194">   // Provide a string &quot;value&quot; for cells that do not normally have text.</span>
<a href="#l3.195"></a><span id="l3.195">   // Use empty string for the normal states &quot;Read&quot;, &quot;Not Starred&quot;,</span>
<a href="#l3.196"></a><span id="l3.196">   // &quot;No Attachment&quot; and &quot;Not Junk&quot;.</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineminus">-  switch (colID[0])</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineplus">+  switch (colID.First())</span>
<a href="#l3.199"></a><span id="l3.199">   {</span>
<a href="#l3.200"></a><span id="l3.200">     case 'a': // attachment column</span>
<a href="#l3.201"></a><span id="l3.201">       if (flags &amp; nsMsgMessageFlags::Attachment)</span>
<a href="#l3.202"></a><span id="l3.202">       {</span>
<a href="#l3.203"></a><span id="l3.203">         nsString tmp_str;</span>
<a href="#l3.204"></a><span id="l3.204">         tmp_str.Adopt(GetString(u&quot;messageHasAttachment&quot;));</span>
<a href="#l3.205"></a><span id="l3.205">         aValue.Assign(tmp_str);</span>
<a href="#l3.206"></a><span id="l3.206">       }</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineat">@@ -1928,17 +1925,18 @@ nsMsgDBView::GetCellValue(int32_t aRow,</span>
<a href="#l3.208"></a><span id="l3.208">         if (!junkScoreStr.IsEmpty() &amp;&amp;</span>
<a href="#l3.209"></a><span id="l3.209">             (junkScoreStr.ToInteger(&amp;rv) == nsIJunkMailPlugin::IS_SPAM_SCORE))</span>
<a href="#l3.210"></a><span id="l3.210">           aValue.AssignLiteral(&quot;messageJunk&quot;);</span>
<a href="#l3.211"></a><span id="l3.211"> </span>
<a href="#l3.212"></a><span id="l3.212">         NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Converting junkScore to integer failed.&quot;);</span>
<a href="#l3.213"></a><span id="l3.213">       }</span>
<a href="#l3.214"></a><span id="l3.214">       break;</span>
<a href="#l3.215"></a><span id="l3.215">     case 't':</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineminus">-      if (colID[1] == 'h' &amp;&amp; (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineplus">+      if (colID.Length() &gt;= 2 &amp;&amp; colID.CharAt(1) == 'h' &amp;&amp;</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineplus">+          (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l3.219"></a><span id="l3.219">       {</span>
<a href="#l3.220"></a><span id="l3.220">         // thread column</span>
<a href="#l3.221"></a><span id="l3.221">         bool isContainer, isContainerEmpty, isContainerOpen;</span>
<a href="#l3.222"></a><span id="l3.222">         IsContainer(aRow, &amp;isContainer);</span>
<a href="#l3.223"></a><span id="l3.223">         if (isContainer)</span>
<a href="#l3.224"></a><span id="l3.224">         {</span>
<a href="#l3.225"></a><span id="l3.225">           IsContainerEmpty(aRow, &amp;isContainerEmpty);</span>
<a href="#l3.226"></a><span id="l3.226">           if (!isContainerEmpty)</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineat">@@ -2069,17 +2067,17 @@ nsMsgDBView::RemoveColumnHandler(const n</span>
<a href="#l3.228"></a><span id="l3.228"> </span>
<a href="#l3.229"></a><span id="l3.229">   // Can't remove a column that isn't currently custom handled.</span>
<a href="#l3.230"></a><span id="l3.230">   return NS_ERROR_FAILURE;</span>
<a href="#l3.231"></a><span id="l3.231"> }</span>
<a href="#l3.232"></a><span id="l3.232"> </span>
<a href="#l3.233"></a><span id="l3.233"> //TODO: NS_ENSURE_SUCCESS</span>
<a href="#l3.234"></a><span id="l3.234"> nsIMsgCustomColumnHandler* nsMsgDBView::GetCurColumnHandler()</span>
<a href="#l3.235"></a><span id="l3.235"> {</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineminus">-  return GetColumnHandler(m_curCustomColumn.get());</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineplus">+  return GetColumnHandler(m_curCustomColumn);</span>
<a href="#l3.238"></a><span id="l3.238"> }</span>
<a href="#l3.239"></a><span id="l3.239"> </span>
<a href="#l3.240"></a><span id="l3.240"> NS_IMETHODIMP</span>
<a href="#l3.241"></a><span id="l3.241"> nsMsgDBView::SetCurCustomColumn(const nsAString&amp; aColID)</span>
<a href="#l3.242"></a><span id="l3.242"> {</span>
<a href="#l3.243"></a><span id="l3.243">   m_curCustomColumn = aColID;</span>
<a href="#l3.244"></a><span id="l3.244">   if (m_viewFolder)</span>
<a href="#l3.245"></a><span id="l3.245">   {</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineat">@@ -2102,30 +2100,30 @@ nsMsgDBView::GetCurCustomColumn(nsAStrin</span>
<a href="#l3.247"></a><span id="l3.247"> </span>
<a href="#l3.248"></a><span id="l3.248"> NS_IMETHODIMP</span>
<a href="#l3.249"></a><span id="l3.249"> nsMsgDBView::GetSecondaryCustomColumn(nsAString &amp;result)</span>
<a href="#l3.250"></a><span id="l3.250"> {</span>
<a href="#l3.251"></a><span id="l3.251">   result = m_secondaryCustomColumn;</span>
<a href="#l3.252"></a><span id="l3.252">   return NS_OK;</span>
<a href="#l3.253"></a><span id="l3.253"> }</span>
<a href="#l3.254"></a><span id="l3.254"> </span>
<a href="#l3.255"></a><span id="l3.255" class="difflineminus">-nsIMsgCustomColumnHandler* nsMsgDBView::GetColumnHandler(const char16_t *colID)</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineminus">-{</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineminus">-  size_t index = m_customColumnHandlerIDs.IndexOf(nsDependentString(colID));</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineplus">+nsIMsgCustomColumnHandler* nsMsgDBView::GetColumnHandler(const nsAString &amp;colID)</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineplus">+{</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineplus">+  size_t index = m_customColumnHandlerIDs.IndexOf(colID);</span>
<a href="#l3.261"></a><span id="l3.261">   return (index != m_customColumnHandlerIDs.NoIndex) ?</span>
<a href="#l3.262"></a><span id="l3.262">     m_customColumnHandlers[index] : nullptr;</span>
<a href="#l3.263"></a><span id="l3.263"> }</span>
<a href="#l3.264"></a><span id="l3.264"> </span>
<a href="#l3.265"></a><span id="l3.265"> NS_IMETHODIMP</span>
<a href="#l3.266"></a><span id="l3.266"> nsMsgDBView::GetColumnHandler(const nsAString&amp; aColID,</span>
<a href="#l3.267"></a><span id="l3.267">                               nsIMsgCustomColumnHandler** aHandler)</span>
<a href="#l3.268"></a><span id="l3.268"> {</span>
<a href="#l3.269"></a><span id="l3.269">   NS_ENSURE_ARG_POINTER(aHandler);</span>
<a href="#l3.270"></a><span id="l3.270">   nsAutoString column(aColID);</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineminus">-  NS_IF_ADDREF(*aHandler = GetColumnHandler(column.get()));</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineplus">+  NS_IF_ADDREF(*aHandler = GetColumnHandler(column));</span>
<a href="#l3.273"></a><span id="l3.273">   return (*aHandler) ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l3.274"></a><span id="l3.274"> }</span>
<a href="#l3.275"></a><span id="l3.275"> </span>
<a href="#l3.276"></a><span id="l3.276"> // Check if any active sort columns are custom. If none are custom, return false</span>
<a href="#l3.277"></a><span id="l3.277"> // and go on as always. If any are custom, and all are not registered yet,</span>
<a href="#l3.278"></a><span id="l3.278"> // return true (so that the caller can postpone sort). When the custom column</span>
<a href="#l3.279"></a><span id="l3.279"> // observer is notified with MsgCreateDBView and registers the handler,</span>
<a href="#l3.280"></a><span id="l3.280"> // AddColumnHandler will sort once all required handlers are set.</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineat">@@ -2149,38 +2147,40 @@ bool nsMsgDBView::CustomColumnsInSortAnd</span>
<a href="#l3.282"></a><span id="l3.282">   }</span>
<a href="#l3.283"></a><span id="l3.283"> </span>
<a href="#l3.284"></a><span id="l3.284">   return custColNotRegistered;</span>
<a href="#l3.285"></a><span id="l3.285"> }</span>
<a href="#l3.286"></a><span id="l3.286"> // END CUSTOM COLUMNS.</span>
<a href="#l3.287"></a><span id="l3.287"> </span>
<a href="#l3.288"></a><span id="l3.288"> NS_IMETHODIMP</span>
<a href="#l3.289"></a><span id="l3.289"> nsMsgDBView::GetCellText(int32_t aRow,</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineminus">-                         nsITreeColumn* aCol,</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineplus">+                         nsTreeColumn* aCol,</span>
<a href="#l3.292"></a><span id="l3.292">                          nsAString&amp; aValue)</span>
<a href="#l3.293"></a><span id="l3.293"> {</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineminus">-  const char16_t* colID;</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineminus">-  aCol-&gt;GetIdConst(&amp;colID);</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineplus">+  nsAutoString colID;  // This is null-terminated which we need for</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineplus">+  aCol-&gt;GetId(colID);  // the call to CellTextForColumn() below.</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineplus">+                       // XXX: That's defined in the IDL and sadly the function</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineplus">+                       // is dangerous due to reaching into the character string.</span>
<a href="#l3.300"></a><span id="l3.300"> </span>
<a href="#l3.301"></a><span id="l3.301">   if (!IsValidIndex(aRow))</span>
<a href="#l3.302"></a><span id="l3.302">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l3.303"></a><span id="l3.303"> </span>
<a href="#l3.304"></a><span id="l3.304">   aValue.Truncate();</span>
<a href="#l3.305"></a><span id="l3.305"> </span>
<a href="#l3.306"></a><span id="l3.306">   // Attempt to retrieve a custom column handler. If it exists call it and</span>
<a href="#l3.307"></a><span id="l3.307">   // return.</span>
<a href="#l3.308"></a><span id="l3.308">   nsIMsgCustomColumnHandler* colHandler = GetColumnHandler(colID);</span>
<a href="#l3.309"></a><span id="l3.309"> </span>
<a href="#l3.310"></a><span id="l3.310">   if (colHandler)</span>
<a href="#l3.311"></a><span id="l3.311">   {</span>
<a href="#l3.312"></a><span id="l3.312">     colHandler-&gt;GetCellText(aRow, aCol, aValue);</span>
<a href="#l3.313"></a><span id="l3.313">     return NS_OK;</span>
<a href="#l3.314"></a><span id="l3.314">   }</span>
<a href="#l3.315"></a><span id="l3.315"> </span>
<a href="#l3.316"></a><span id="l3.316" class="difflineminus">-  return CellTextForColumn(aRow, colID, aValue);</span>
<a href="#l3.317"></a><span id="l3.317" class="difflineplus">+  return CellTextForColumn(aRow, colID.get(), aValue);</span>
<a href="#l3.318"></a><span id="l3.318"> }</span>
<a href="#l3.319"></a><span id="l3.319"> </span>
<a href="#l3.320"></a><span id="l3.320"> NS_IMETHODIMP</span>
<a href="#l3.321"></a><span id="l3.321"> nsMsgDBView::CellTextForColumn(int32_t aRow,</span>
<a href="#l3.322"></a><span id="l3.322">                                const char16_t *aColumnName,</span>
<a href="#l3.323"></a><span id="l3.323">                                nsAString &amp;aValue)</span>
<a href="#l3.324"></a><span id="l3.324"> {</span>
<a href="#l3.325"></a><span id="l3.325">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineat">@@ -2312,32 +2312,31 @@ nsMsgDBView::ToggleOpenState(int32_t ind</span>
<a href="#l3.327"></a><span id="l3.327"> {</span>
<a href="#l3.328"></a><span id="l3.328">   uint32_t numChanged;</span>
<a href="#l3.329"></a><span id="l3.329">   nsresult rv = ToggleExpansion(index, &amp;numChanged);</span>
<a href="#l3.330"></a><span id="l3.330">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.331"></a><span id="l3.331">   return NS_OK;</span>
<a href="#l3.332"></a><span id="l3.332"> }</span>
<a href="#l3.333"></a><span id="l3.333"> </span>
<a href="#l3.334"></a><span id="l3.334"> NS_IMETHODIMP</span>
<a href="#l3.335"></a><span id="l3.335" class="difflineminus">-nsMsgDBView::CycleHeader(nsITreeColumn* aCol)</span>
<a href="#l3.336"></a><span id="l3.336" class="difflineplus">+nsMsgDBView::CycleHeader(nsTreeColumn* aCol)</span>
<a href="#l3.337"></a><span id="l3.337"> {</span>
<a href="#l3.338"></a><span id="l3.338">   // Let HandleColumnClick() in threadPane.js handle it</span>
<a href="#l3.339"></a><span id="l3.339">   // since it will set / clear the sort indicators.</span>
<a href="#l3.340"></a><span id="l3.340">   return NS_OK;</span>
<a href="#l3.341"></a><span id="l3.341"> }</span>
<a href="#l3.342"></a><span id="l3.342"> </span>
<a href="#l3.343"></a><span id="l3.343"> NS_IMETHODIMP</span>
<a href="#l3.344"></a><span id="l3.344"> nsMsgDBView::CycleCell(int32_t row,</span>
<a href="#l3.345"></a><span id="l3.345" class="difflineminus">-                       nsITreeColumn* col)</span>
<a href="#l3.346"></a><span id="l3.346" class="difflineplus">+                       nsTreeColumn* col)</span>
<a href="#l3.347"></a><span id="l3.347"> {</span>
<a href="#l3.348"></a><span id="l3.348">   if (!IsValidIndex(row))</span>
<a href="#l3.349"></a><span id="l3.349">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l3.350"></a><span id="l3.350"> </span>
<a href="#l3.351"></a><span id="l3.351" class="difflineminus">-  const char16_t* colID;</span>
<a href="#l3.352"></a><span id="l3.352" class="difflineminus">-  col-&gt;GetIdConst(&amp;colID);</span>
<a href="#l3.353"></a><span id="l3.353" class="difflineplus">+  const nsAString&amp; colID = col-&gt;GetId();</span>
<a href="#l3.354"></a><span id="l3.354"> </span>
<a href="#l3.355"></a><span id="l3.355">   // Attempt to retrieve a custom column handler. If it exists call it and</span>
<a href="#l3.356"></a><span id="l3.356">   // return.</span>
<a href="#l3.357"></a><span id="l3.357">   nsIMsgCustomColumnHandler* colHandler = GetColumnHandler(colID);</span>
<a href="#l3.358"></a><span id="l3.358"> </span>
<a href="#l3.359"></a><span id="l3.359">   if (colHandler)</span>
<a href="#l3.360"></a><span id="l3.360">   {</span>
<a href="#l3.361"></a><span id="l3.361">     colHandler-&gt;CycleCell(row, col);</span>
<a href="#l3.362"></a><span id="l3.362" class="difflineat">@@ -2345,17 +2344,20 @@ nsMsgDBView::CycleCell(int32_t row,</span>
<a href="#l3.363"></a><span id="l3.363">   }</span>
<a href="#l3.364"></a><span id="l3.364"> </span>
<a href="#l3.365"></a><span id="l3.365">   // The cyclers below don't work for the grouped header dummy row, currently.</span>
<a href="#l3.366"></a><span id="l3.366">   // A future implementation should consider both collapsed and expanded state.</span>
<a href="#l3.367"></a><span id="l3.367">   if (m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort &amp;&amp;</span>
<a href="#l3.368"></a><span id="l3.368">       m_flags[row] &amp; MSG_VIEW_FLAG_DUMMY)</span>
<a href="#l3.369"></a><span id="l3.369">     return NS_OK;</span>
<a href="#l3.370"></a><span id="l3.370"> </span>
<a href="#l3.371"></a><span id="l3.371" class="difflineminus">-  switch (colID[0])</span>
<a href="#l3.372"></a><span id="l3.372" class="difflineplus">+  if (colID.IsEmpty())</span>
<a href="#l3.373"></a><span id="l3.373" class="difflineplus">+    return NS_OK;</span>
<a href="#l3.374"></a><span id="l3.374" class="difflineplus">+</span>
<a href="#l3.375"></a><span id="l3.375" class="difflineplus">+  switch (colID.First())</span>
<a href="#l3.376"></a><span id="l3.376">   {</span>
<a href="#l3.377"></a><span id="l3.377">     case 'u': // unreadButtonColHeader</span>
<a href="#l3.378"></a><span id="l3.378">       if (colID[6] == 'B')</span>
<a href="#l3.379"></a><span id="l3.379">         ApplyCommandToIndices(nsMsgViewCommandType::toggleMessageRead,</span>
<a href="#l3.380"></a><span id="l3.380">                               (nsMsgViewIndex *) &amp;row, 1);</span>
<a href="#l3.381"></a><span id="l3.381">      break;</span>
<a href="#l3.382"></a><span id="l3.382">     case 't': // tag cell, threaded cell or total cell</span>
<a href="#l3.383"></a><span id="l3.383">       if (colID[1] == 'h')</span>
<a href="#l3.384"></a><span id="l3.384" class="difflineat">@@ -2419,17 +2421,17 @@ NS_IMETHODIMP</span>
<a href="#l3.385"></a><span id="l3.385"> nsMsgDBView::PerformActionOnRow(const char16_t *action, int32_t row)</span>
<a href="#l3.386"></a><span id="l3.386"> {</span>
<a href="#l3.387"></a><span id="l3.387">   return NS_OK;</span>
<a href="#l3.388"></a><span id="l3.388"> }</span>
<a href="#l3.389"></a><span id="l3.389"> </span>
<a href="#l3.390"></a><span id="l3.390"> NS_IMETHODIMP</span>
<a href="#l3.391"></a><span id="l3.391"> nsMsgDBView::PerformActionOnCell(const char16_t *action,</span>
<a href="#l3.392"></a><span id="l3.392">                                  int32_t row,</span>
<a href="#l3.393"></a><span id="l3.393" class="difflineminus">-                                 nsITreeColumn* col)</span>
<a href="#l3.394"></a><span id="l3.394" class="difflineplus">+                                 nsTreeColumn* col)</span>
<a href="#l3.395"></a><span id="l3.395"> {</span>
<a href="#l3.396"></a><span id="l3.396">   return NS_OK;</span>
<a href="#l3.397"></a><span id="l3.397"> }</span>
<a href="#l3.398"></a><span id="l3.398"> </span>
<a href="#l3.399"></a><span id="l3.399"> ///////////////////////////////////////////////////////////////////////////</span>
<a href="#l3.400"></a><span id="l3.400"> // end nsITreeView Implementation Methods</span>
<a href="#l3.401"></a><span id="l3.401"> ///////////////////////////////////////////////////////////////////////////</span>
<a href="#l3.402"></a><span id="l3.402"> </span>
<a href="#l3.403"></a><span id="l3.403" class="difflineat">@@ -4616,17 +4618,17 @@ nsMsgDBView::DecodeColumnSort(nsString &amp;</span>
<a href="#l3.404"></a><span id="l3.404">     sortColumnInfo.mSortType = (nsMsgViewSortTypeValue) *stringPtr++;</span>
<a href="#l3.405"></a><span id="l3.405">     sortColumnInfo.mSortOrder = (nsMsgViewSortOrderValue) (*stringPtr++) - '0';</span>
<a href="#l3.406"></a><span id="l3.406">     if (sortColumnInfo.mSortType == nsMsgViewSortType::byCustom)</span>
<a href="#l3.407"></a><span id="l3.407">     {</span>
<a href="#l3.408"></a><span id="l3.408">       while (*stringPtr &amp;&amp; *stringPtr != '\r')</span>
<a href="#l3.409"></a><span id="l3.409">         sortColumnInfo.mCustomColumnName.Append(*stringPtr++);</span>
<a href="#l3.410"></a><span id="l3.410"> </span>
<a href="#l3.411"></a><span id="l3.411">       sortColumnInfo.mColHandler =</span>
<a href="#l3.412"></a><span id="l3.412" class="difflineminus">-        GetColumnHandler(sortColumnInfo.mCustomColumnName.get());</span>
<a href="#l3.413"></a><span id="l3.413" class="difflineplus">+        GetColumnHandler(sortColumnInfo.mCustomColumnName);</span>
<a href="#l3.414"></a><span id="l3.414"> </span>
<a href="#l3.415"></a><span id="l3.415">       // Advance past '\r'.</span>
<a href="#l3.416"></a><span id="l3.416">       if (*stringPtr)</span>
<a href="#l3.417"></a><span id="l3.417">         stringPtr++;</span>
<a href="#l3.418"></a><span id="l3.418">     }</span>
<a href="#l3.419"></a><span id="l3.419"> </span>
<a href="#l3.420"></a><span id="l3.420">     m_sortColumns.AppendElement(sortColumnInfo);</span>
<a href="#l3.421"></a><span id="l3.421">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/src/nsMsgDBView.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgDBView.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -510,17 +510,17 @@ protected:</span>
<a href="#l4.4"></a><span id="l4.4">   void RememberDeletedMsgHdr(nsIMsgDBHdr *msgHdr);</span>
<a href="#l4.5"></a><span id="l4.5">   bool WasHdrRecentlyDeleted(nsIMsgDBHdr *msgHdr);</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7">   // These hold pointers (and IDs) for the nsIMsgCustomColumnHandler object</span>
<a href="#l4.8"></a><span id="l4.8">   // that constitutes the custom column handler.</span>
<a href="#l4.9"></a><span id="l4.9">   nsCOMArray &lt;nsIMsgCustomColumnHandler&gt; m_customColumnHandlers;</span>
<a href="#l4.10"></a><span id="l4.10">   nsTArray&lt;nsString&gt; m_customColumnHandlerIDs;</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  nsIMsgCustomColumnHandler* GetColumnHandler(const char16_t*);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  nsIMsgCustomColumnHandler* GetColumnHandler(const nsAString &amp;colID);</span>
<a href="#l4.14"></a><span id="l4.14">   nsIMsgCustomColumnHandler* GetCurColumnHandler();</span>
<a href="#l4.15"></a><span id="l4.15">   bool CustomColumnsInSortAndNotRegistered();</span>
<a href="#l4.16"></a><span id="l4.16">   void EnsureCustomColumnsValid();</span>
<a href="#l4.17"></a><span id="l4.17"> </span>
<a href="#l4.18"></a><span id="l4.18"> #ifdef DEBUG_David_Bienvenu</span>
<a href="#l4.19"></a><span id="l4.19"> void InitEntryInfoForIndex(nsMsgViewIndex i, IdKeyPtr &amp;EntryInfo);</span>
<a href="#l4.20"></a><span id="l4.20"> void ValidateSort();</span>
<a href="#l4.21"></a><span id="l4.21"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/src/nsMsgGroupView.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgGroupView.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -6,17 +6,17 @@</span>
<a href="#l5.4"></a><span id="l5.4"> #include &quot;msgCore.h&quot;</span>
<a href="#l5.5"></a><span id="l5.5"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l5.6"></a><span id="l5.6"> #include &quot;nsMsgGroupView.h&quot;</span>
<a href="#l5.7"></a><span id="l5.7"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l5.8"></a><span id="l5.8"> #include &quot;nsIMsgThread.h&quot;</span>
<a href="#l5.9"></a><span id="l5.9"> #include &quot;nsIDBFolderInfo.h&quot;</span>
<a href="#l5.10"></a><span id="l5.10"> #include &quot;nsIMsgSearchSession.h&quot;</span>
<a href="#l5.11"></a><span id="l5.11"> #include &quot;nsMsgGroupThread.h&quot;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-#include &quot;nsITreeColumns.h&quot;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+#include &quot;nsTreeColumns.h&quot;</span>
<a href="#l5.14"></a><span id="l5.14"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l5.15"></a><span id="l5.15"> #include &lt;plhash.h&gt;</span>
<a href="#l5.16"></a><span id="l5.16"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l5.17"></a><span id="l5.17"> </span>
<a href="#l5.18"></a><span id="l5.18"> // Allocate this more to avoid reallocation on new mail.</span>
<a href="#l5.19"></a><span id="l5.19"> #define MSGHDR_CACHE_LOOK_AHEAD_SIZE  25</span>
<a href="#l5.20"></a><span id="l5.20"> // Max msghdr cache entries.</span>
<a href="#l5.21"></a><span id="l5.21"> #define MSGHDR_CACHE_MAX_SIZE         8192</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineat">@@ -791,17 +791,17 @@ nsMsgGroupView::GetRowProperties(int32_t</span>
<a href="#l5.23"></a><span id="l5.23">     return NS_OK;</span>
<a href="#l5.24"></a><span id="l5.24">   }</span>
<a href="#l5.25"></a><span id="l5.25"> </span>
<a href="#l5.26"></a><span id="l5.26">   return nsMsgDBView::GetRowProperties(aRow, aProperties);</span>
<a href="#l5.27"></a><span id="l5.27"> }</span>
<a href="#l5.28"></a><span id="l5.28"> </span>
<a href="#l5.29"></a><span id="l5.29"> NS_IMETHODIMP</span>
<a href="#l5.30"></a><span id="l5.30"> nsMsgGroupView::GetCellProperties(int32_t aRow,</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-                                  nsITreeColumn *aCol,</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+                                  nsTreeColumn *aCol,</span>
<a href="#l5.33"></a><span id="l5.33">                                   nsAString&amp; aProperties)</span>
<a href="#l5.34"></a><span id="l5.34"> {</span>
<a href="#l5.35"></a><span id="l5.35">   if (!IsValidIndex(aRow))</span>
<a href="#l5.36"></a><span id="l5.36">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l5.37"></a><span id="l5.37"> </span>
<a href="#l5.38"></a><span id="l5.38">   if (m_flags[aRow] &amp; MSG_VIEW_FLAG_DUMMY)</span>
<a href="#l5.39"></a><span id="l5.39">   {</span>
<a href="#l5.40"></a><span id="l5.40">     aProperties.AssignLiteral(&quot;dummy read&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/src/nsMsgGroupView.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgGroupView.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -33,17 +33,17 @@ public:</span>
<a href="#l6.4"></a><span id="l6.4">                         nsIMsgWindow *aMsgWindow, nsIMsgDBViewCommandUpdater *aCmdUpdater);</span>
<a href="#l6.5"></a><span id="l6.5">   NS_IMETHOD Close() override;</span>
<a href="#l6.6"></a><span id="l6.6">   NS_IMETHOD OnHdrDeleted(nsIMsgDBHdr *aHdrDeleted, nsMsgKey aParentKey, int32_t aFlags,</span>
<a href="#l6.7"></a><span id="l6.7">                           nsIDBChangeListener *aInstigator) override;</span>
<a href="#l6.8"></a><span id="l6.8">   NS_IMETHOD OnHdrFlagsChanged(nsIMsgDBHdr *aHdrChanged, uint32_t aOldFlags,</span>
<a href="#l6.9"></a><span id="l6.9">                                uint32_t aNewFlags, nsIDBChangeListener *aInstigator) override;</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11">   NS_IMETHOD LoadMessageByViewIndex(nsMsgViewIndex aViewIndex) override;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  NS_IMETHOD GetCellProperties(int32_t aRow, nsITreeColumn *aCol, nsAString&amp; aProperties) override;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  NS_IMETHOD GetCellProperties(int32_t aRow, nsTreeColumn *aCol, nsAString&amp; aProperties) override;</span>
<a href="#l6.14"></a><span id="l6.14">   NS_IMETHOD GetRowProperties(int32_t aRow, nsAString&amp; aProperties) override;</span>
<a href="#l6.15"></a><span id="l6.15">   NS_IMETHOD CellTextForColumn(int32_t aRow, const char16_t *aColumnName,</span>
<a href="#l6.16"></a><span id="l6.16">                                nsAString &amp;aValue) override;</span>
<a href="#l6.17"></a><span id="l6.17">   NS_IMETHOD GetThreadContainingMsgHdr(nsIMsgDBHdr *msgHdr, nsIMsgThread **pThread) override;</span>
<a href="#l6.18"></a><span id="l6.18">   NS_IMETHOD AddColumnHandler(const nsAString&amp; column, nsIMsgCustomColumnHandler* handler) override;</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20"> protected:</span>
<a href="#l6.21"></a><span id="l6.21">   virtual void InternalClose();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/src/nsMsgSearchDBView.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgSearchDBView.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -8,17 +8,17 @@</span>
<a href="#l7.4"></a><span id="l7.4"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l7.5"></a><span id="l7.5"> #include &quot;nsIMsgThread.h&quot;</span>
<a href="#l7.6"></a><span id="l7.6"> #include &quot;nsQuickSort.h&quot;</span>
<a href="#l7.7"></a><span id="l7.7"> #include &quot;nsIDBFolderInfo.h&quot;</span>
<a href="#l7.8"></a><span id="l7.8"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l7.9"></a><span id="l7.9"> #include &quot;nsIMsgCopyService.h&quot;</span>
<a href="#l7.10"></a><span id="l7.10"> #include &quot;nsICopyMsgStreamListener.h&quot;</span>
<a href="#l7.11"></a><span id="l7.11"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-#include &quot;nsITreeColumns.h&quot;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+#include &quot;nsTreeColumns.h&quot;</span>
<a href="#l7.14"></a><span id="l7.14"> #include &quot;nsIMsgMessageService.h&quot;</span>
<a href="#l7.15"></a><span id="l7.15"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l7.16"></a><span id="l7.16"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l7.17"></a><span id="l7.17"> #include &quot;nsMsgGroupThread.h&quot;</span>
<a href="#l7.18"></a><span id="l7.18"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l7.19"></a><span id="l7.19"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l7.20"></a><span id="l7.20"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l7.21"></a><span id="l7.21"> #include &quot;nsIMsgSearchSession.h&quot;</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineat">@@ -147,29 +147,29 @@ void nsMsgSearchDBView::InternalClose()</span>
<a href="#l7.23"></a><span id="l7.23">   m_threadsTable.Clear();</span>
<a href="#l7.24"></a><span id="l7.24">   m_hdrsTable.Clear();</span>
<a href="#l7.25"></a><span id="l7.25">   nsMsgGroupView::InternalClose();</span>
<a href="#l7.26"></a><span id="l7.26">   m_folders.Clear();</span>
<a href="#l7.27"></a><span id="l7.27"> }</span>
<a href="#l7.28"></a><span id="l7.28"> </span>
<a href="#l7.29"></a><span id="l7.29"> NS_IMETHODIMP</span>
<a href="#l7.30"></a><span id="l7.30"> nsMsgSearchDBView::GetCellText(int32_t aRow,</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-                               nsITreeColumn* aCol,</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+                               nsTreeColumn* aCol,</span>
<a href="#l7.33"></a><span id="l7.33">                                nsAString&amp; aValue)</span>
<a href="#l7.34"></a><span id="l7.34"> {</span>
<a href="#l7.35"></a><span id="l7.35">   NS_ENSURE_TRUE(IsValidIndex(aRow), NS_MSG_INVALID_DBVIEW_INDEX);</span>
<a href="#l7.36"></a><span id="l7.36">   NS_ENSURE_ARG_POINTER(aCol);</span>
<a href="#l7.37"></a><span id="l7.37"> </span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-  const char16_t* colID;</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-  aCol-&gt;GetIdConst(&amp;colID);</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+  const nsAString&amp; colID = aCol-&gt;GetId();</span>
<a href="#l7.41"></a><span id="l7.41">   // The only thing we contribute is location; dummy rows have no location, so</span>
<a href="#l7.42"></a><span id="l7.42">   // bail in that case. Otherwise, check if we are dealing with 'location'.</span>
<a href="#l7.43"></a><span id="l7.43">   // 'location', need to check for &quot;lo&quot; not just &quot;l&quot; to avoid &quot;label&quot; column.</span>
<a href="#l7.44"></a><span id="l7.44">   if (!(m_flags[aRow] &amp; MSG_VIEW_FLAG_DUMMY) &amp;&amp;</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">-      colID[0] == 'l' &amp;&amp; colID[1] == 'o')</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+      colID.Length() &gt;= 2 &amp;&amp;</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+      colID.First() == 'l' &amp;&amp; colID.CharAt(1) == 'o')</span>
<a href="#l7.48"></a><span id="l7.48">     return FetchLocation(aRow, aValue);</span>
<a href="#l7.49"></a><span id="l7.49">   else</span>
<a href="#l7.50"></a><span id="l7.50">     return nsMsgGroupView::GetCellText(aRow, aCol, aValue);</span>
<a href="#l7.51"></a><span id="l7.51"> }</span>
<a href="#l7.52"></a><span id="l7.52"> </span>
<a href="#l7.53"></a><span id="l7.53"> nsresult</span>
<a href="#l7.54"></a><span id="l7.54"> nsMsgSearchDBView::HashHdr(nsIMsgDBHdr *msgHdr,</span>
<a href="#l7.55"></a><span id="l7.55">                            nsString&amp; aHashKey)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/base/src/nsMsgSearchDBView.h</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgSearchDBView.h</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -61,17 +61,17 @@ public:</span>
<a href="#l8.4"></a><span id="l8.4">                           nsMsgViewFlagsTypeValue aViewFlags,</span>
<a href="#l8.5"></a><span id="l8.5">                           int32_t *aCount) override;</span>
<a href="#l8.6"></a><span id="l8.6">   NS_IMETHOD OnHdrDeleted(nsIMsgDBHdr *aHdrDeleted, nsMsgKey aParentKey,</span>
<a href="#l8.7"></a><span id="l8.7">                           int32_t aFlags, nsIDBChangeListener *aInstigator) override;</span>
<a href="#l8.8"></a><span id="l8.8">   NS_IMETHOD OnHdrFlagsChanged(nsIMsgDBHdr *aHdrChanged, uint32_t aOldFlags,</span>
<a href="#l8.9"></a><span id="l8.9">                                uint32_t aNewFlags, nsIDBChangeListener *aInstigator) override;</span>
<a href="#l8.10"></a><span id="l8.10">   NS_IMETHOD GetNumMsgsInView(int32_t *aNumMsgs) override;</span>
<a href="#l8.11"></a><span id="l8.11">   // override to get location</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  NS_IMETHOD GetCellText(int32_t aRow, nsITreeColumn* aCol, nsAString&amp; aValue) override;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+  NS_IMETHOD GetCellText(int32_t aRow, nsTreeColumn* aCol, nsAString&amp; aValue) override;</span>
<a href="#l8.14"></a><span id="l8.14">   virtual nsresult GetMsgHdrForViewIndex(nsMsgViewIndex index, nsIMsgDBHdr **msgHdr) override;</span>
<a href="#l8.15"></a><span id="l8.15">   virtual nsresult OnNewHeader(nsIMsgDBHdr *newHdr,</span>
<a href="#l8.16"></a><span id="l8.16">                                nsMsgKey parentKey,</span>
<a href="#l8.17"></a><span id="l8.17">                                bool ensureListed) override;</span>
<a href="#l8.18"></a><span id="l8.18">   NS_IMETHOD GetFolderForViewIndex(nsMsgViewIndex index, nsIMsgFolder **folder) override;</span>
<a href="#l8.19"></a><span id="l8.19"> </span>
<a href="#l8.20"></a><span id="l8.20">   NS_IMETHOD OnAnnouncerGoingAway(nsIDBChangeAnnouncer *instigator) override;</span>
<a href="#l8.21"></a><span id="l8.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -8,17 +8,16 @@</span>
<a href="#l9.4"></a><span id="l9.4"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l9.5"></a><span id="l9.5"> #include &quot;nsIMsgThread.h&quot;</span>
<a href="#l9.6"></a><span id="l9.6"> #include &quot;nsQuickSort.h&quot;</span>
<a href="#l9.7"></a><span id="l9.7"> #include &quot;nsIDBFolderInfo.h&quot;</span>
<a href="#l9.8"></a><span id="l9.8"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l9.9"></a><span id="l9.9"> #include &quot;nsIMsgCopyService.h&quot;</span>
<a href="#l9.10"></a><span id="l9.10"> #include &quot;nsICopyMsgStreamListener.h&quot;</span>
<a href="#l9.11"></a><span id="l9.11"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-#include &quot;nsITreeColumns.h&quot;</span>
<a href="#l9.13"></a><span id="l9.13"> #include &quot;nsIMsgSearchSession.h&quot;</span>
<a href="#l9.14"></a><span id="l9.14"> #include &quot;nsMsgDBCID.h&quot;</span>
<a href="#l9.15"></a><span id="l9.15"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l9.16"></a><span id="l9.16"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l9.17"></a><span id="l9.17"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l9.18"></a><span id="l9.18"> </span>
<a href="#l9.19"></a><span id="l9.19"> nsMsgXFVirtualFolderDBView::nsMsgXFVirtualFolderDBView()</span>
<a href="#l9.20"></a><span id="l9.20"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/news/src/nsNntpIncomingServer.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/news/src/nsNntpIncomingServer.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1718,45 +1718,47 @@ nsNntpIncomingServer::SetSelection(nsITr</span>
<a href="#l10.4"></a><span id="l10.4"> </span>
<a href="#l10.5"></a><span id="l10.5"> NS_IMETHODIMP</span>
<a href="#l10.6"></a><span id="l10.6"> nsNntpIncomingServer::GetRowProperties(int32_t index, nsAString&amp; properties)</span>
<a href="#l10.7"></a><span id="l10.7"> {</span>
<a href="#l10.8"></a><span id="l10.8">   return NS_OK;</span>
<a href="#l10.9"></a><span id="l10.9"> }</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11"> NS_IMETHODIMP</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-nsNntpIncomingServer::GetCellProperties(int32_t row, nsITreeColumn* col, nsAString&amp; properties)</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+nsNntpIncomingServer::GetCellProperties(int32_t row, nsTreeColumn* col, nsAString&amp; properties)</span>
<a href="#l10.14"></a><span id="l10.14"> {</span>
<a href="#l10.15"></a><span id="l10.15">   if (!IsValidRow(row))</span>
<a href="#l10.16"></a><span id="l10.16">     return NS_ERROR_UNEXPECTED;</span>
<a href="#l10.17"></a><span id="l10.17"> </span>
<a href="#l10.18"></a><span id="l10.18">   NS_ENSURE_ARG_POINTER(col);</span>
<a href="#l10.19"></a><span id="l10.19"> </span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-  const char16_t* colID;</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-  col-&gt;GetIdConst(&amp;colID);</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-  if (colID[0] == 's') {</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+  const nsAString&amp; colID = col-&gt;GetId();</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+  if (colID.IsEmpty())</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+    return NS_OK;</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+  if (colID.First() == 's') {</span>
<a href="#l10.28"></a><span id="l10.28">     // if &lt;name&gt; is in our temporary list of subscribed groups</span>
<a href="#l10.29"></a><span id="l10.29">     // add the &quot;subscribed-true&quot; property so the check mark shows up</span>
<a href="#l10.30"></a><span id="l10.30">     // in the &quot;subscribedColumn2&quot;</span>
<a href="#l10.31"></a><span id="l10.31">     if (mSearchResultSortDescending)</span>
<a href="#l10.32"></a><span id="l10.32">       row = mSubscribeSearchResult.Length() - 1 - row;</span>
<a href="#l10.33"></a><span id="l10.33">     if (mTempSubscribed.Contains(mSubscribeSearchResult.ElementAt(row))) {</span>
<a href="#l10.34"></a><span id="l10.34">       properties.AssignLiteral(&quot;subscribed-true&quot;);</span>
<a href="#l10.35"></a><span id="l10.35">     }</span>
<a href="#l10.36"></a><span id="l10.36">   }</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-  else if (colID[0] == 'n') {</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+  else if (colID.First() == 'n') {</span>
<a href="#l10.39"></a><span id="l10.39">     // add the &quot;serverType-nntp&quot; property to the &quot;nameColumn2&quot;</span>
<a href="#l10.40"></a><span id="l10.40">     // so we get the news folder icon in the search view</span>
<a href="#l10.41"></a><span id="l10.41">     properties.AssignLiteral(&quot;serverType-nntp&quot;);</span>
<a href="#l10.42"></a><span id="l10.42">   }</span>
<a href="#l10.43"></a><span id="l10.43">   return NS_OK;</span>
<a href="#l10.44"></a><span id="l10.44"> }</span>
<a href="#l10.45"></a><span id="l10.45"> </span>
<a href="#l10.46"></a><span id="l10.46"> NS_IMETHODIMP</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-nsNntpIncomingServer::GetColumnProperties(nsITreeColumn* col, nsAString&amp; properties)</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+nsNntpIncomingServer::GetColumnProperties(nsTreeColumn* col, nsAString&amp; properties)</span>
<a href="#l10.49"></a><span id="l10.49"> {</span>
<a href="#l10.50"></a><span id="l10.50">   return NS_OK;</span>
<a href="#l10.51"></a><span id="l10.51"> }</span>
<a href="#l10.52"></a><span id="l10.52"> </span>
<a href="#l10.53"></a><span id="l10.53"> NS_IMETHODIMP</span>
<a href="#l10.54"></a><span id="l10.54"> nsNntpIncomingServer::IsContainer(int32_t index, bool *_retval)</span>
<a href="#l10.55"></a><span id="l10.55"> {</span>
<a href="#l10.56"></a><span id="l10.56">   *_retval = false;</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineat">@@ -1826,55 +1828,51 @@ nsNntpIncomingServer::GetLevel(int32_t i</span>
<a href="#l10.58"></a><span id="l10.58"> </span>
<a href="#l10.59"></a><span id="l10.59"> bool</span>
<a href="#l10.60"></a><span id="l10.60"> nsNntpIncomingServer::IsValidRow(int32_t row)</span>
<a href="#l10.61"></a><span id="l10.61"> {</span>
<a href="#l10.62"></a><span id="l10.62">   return ((row &gt;= 0) &amp;&amp; (row &lt; (int32_t)mSubscribeSearchResult.Length()));</span>
<a href="#l10.63"></a><span id="l10.63"> }</span>
<a href="#l10.64"></a><span id="l10.64"> </span>
<a href="#l10.65"></a><span id="l10.65"> NS_IMETHODIMP</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineminus">-nsNntpIncomingServer::GetImageSrc(int32_t row, nsITreeColumn* col, nsAString&amp; _retval)</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineplus">+nsNntpIncomingServer::GetImageSrc(int32_t row, nsTreeColumn* col, nsAString&amp; _retval)</span>
<a href="#l10.68"></a><span id="l10.68"> {</span>
<a href="#l10.69"></a><span id="l10.69">   return NS_OK;</span>
<a href="#l10.70"></a><span id="l10.70"> }</span>
<a href="#l10.71"></a><span id="l10.71"> </span>
<a href="#l10.72"></a><span id="l10.72"> NS_IMETHODIMP</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineminus">-nsNntpIncomingServer::GetCellValue(int32_t row, nsITreeColumn* col, nsAString&amp; _retval)</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+nsNntpIncomingServer::GetCellValue(int32_t row, nsTreeColumn* col, nsAString&amp; _retval)</span>
<a href="#l10.75"></a><span id="l10.75"> {</span>
<a href="#l10.76"></a><span id="l10.76">   if (!IsValidRow(row))</span>
<a href="#l10.77"></a><span id="l10.77">     return NS_ERROR_UNEXPECTED;</span>
<a href="#l10.78"></a><span id="l10.78"> </span>
<a href="#l10.79"></a><span id="l10.79">   NS_ENSURE_ARG_POINTER(col);</span>
<a href="#l10.80"></a><span id="l10.80"> </span>
<a href="#l10.81"></a><span id="l10.81" class="difflineminus">-  const char16_t* colID;</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineminus">-  col-&gt;GetIdConst(&amp;colID);</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineminus">-</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineplus">+  const nsAString&amp; colID = col-&gt;GetId();</span>
<a href="#l10.85"></a><span id="l10.85">   nsresult rv = NS_OK;</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineminus">-  if (colID[0] == 'n') {</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineplus">+  if (!colID.IsEmpty() &amp;&amp; colID.First() == 'n') {</span>
<a href="#l10.88"></a><span id="l10.88">     nsAutoCString str;</span>
<a href="#l10.89"></a><span id="l10.89">     if (mSearchResultSortDescending)</span>
<a href="#l10.90"></a><span id="l10.90">       row = mSubscribeSearchResult.Length() - 1 - row;</span>
<a href="#l10.91"></a><span id="l10.91">     _retval.Assign(NS_ConvertASCIItoUTF16(mSubscribeSearchResult.ElementAt(row)));</span>
<a href="#l10.92"></a><span id="l10.92">   }</span>
<a href="#l10.93"></a><span id="l10.93">   return rv;</span>
<a href="#l10.94"></a><span id="l10.94"> }</span>
<a href="#l10.95"></a><span id="l10.95"> </span>
<a href="#l10.96"></a><span id="l10.96"> NS_IMETHODIMP</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineminus">-nsNntpIncomingServer::GetCellText(int32_t row, nsITreeColumn* col, nsAString&amp; _retval)</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineplus">+nsNntpIncomingServer::GetCellText(int32_t row, nsTreeColumn* col, nsAString&amp; _retval)</span>
<a href="#l10.99"></a><span id="l10.99"> {</span>
<a href="#l10.100"></a><span id="l10.100">   if (!IsValidRow(row))</span>
<a href="#l10.101"></a><span id="l10.101">     return NS_ERROR_UNEXPECTED;</span>
<a href="#l10.102"></a><span id="l10.102"> </span>
<a href="#l10.103"></a><span id="l10.103">   NS_ENSURE_ARG_POINTER(col);</span>
<a href="#l10.104"></a><span id="l10.104"> </span>
<a href="#l10.105"></a><span id="l10.105" class="difflineminus">-  const char16_t* colID;</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineminus">-  col-&gt;GetIdConst(&amp;colID);</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineminus">-</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineplus">+  const nsAString&amp; colID = col-&gt;GetId();</span>
<a href="#l10.109"></a><span id="l10.109">   nsresult rv = NS_OK;</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineminus">-  if (colID[0] == 'n') {</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineplus">+  if (!colID.IsEmpty() &amp;&amp; colID.First() == 'n') {</span>
<a href="#l10.112"></a><span id="l10.112">     nsAutoCString str;</span>
<a href="#l10.113"></a><span id="l10.113">     if (mSearchResultSortDescending)</span>
<a href="#l10.114"></a><span id="l10.114">       row = mSubscribeSearchResult.Length() - 1 - row;</span>
<a href="#l10.115"></a><span id="l10.115">     // some servers have newsgroup names that are non ASCII.  we store</span>
<a href="#l10.116"></a><span id="l10.116">     // those as escaped. unescape here so the UI is consistent</span>
<a href="#l10.117"></a><span id="l10.117">     rv = NS_MsgDecodeUnescapeURLPath(mSubscribeSearchResult.ElementAt(row), _retval);</span>
<a href="#l10.118"></a><span id="l10.118">   }</span>
<a href="#l10.119"></a><span id="l10.119">   return rv;</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineat">@@ -1887,48 +1885,45 @@ nsNntpIncomingServer::SetTree(nsITreeBox</span>
<a href="#l10.121"></a><span id="l10.121">   if (!tree)</span>
<a href="#l10.122"></a><span id="l10.122">     return NS_OK;</span>
<a href="#l10.123"></a><span id="l10.123"> </span>
<a href="#l10.124"></a><span id="l10.124">   RefPtr&lt;nsTreeColumns&gt; cols;</span>
<a href="#l10.125"></a><span id="l10.125">   tree-&gt;GetColumns(getter_AddRefs(cols));</span>
<a href="#l10.126"></a><span id="l10.126">   if (!cols)</span>
<a href="#l10.127"></a><span id="l10.127">     return NS_OK;</span>
<a href="#l10.128"></a><span id="l10.128"> </span>
<a href="#l10.129"></a><span id="l10.129" class="difflineminus">-  nsCOMPtr&lt;nsITreeColumn&gt; col = cols-&gt;GetKeyColumn();</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineplus">+  RefPtr&lt;nsTreeColumn&gt; col = cols-&gt;GetKeyColumn();</span>
<a href="#l10.131"></a><span id="l10.131">   if (!col)</span>
<a href="#l10.132"></a><span id="l10.132">     return NS_OK;</span>
<a href="#l10.133"></a><span id="l10.133"> </span>
<a href="#l10.134"></a><span id="l10.134" class="difflineminus">-  RefPtr&lt;mozilla::dom::Element&gt; element;</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineminus">-  col-&gt;GetElement(getter_AddRefs(element));</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineplus">+  RefPtr&lt;mozilla::dom::Element&gt; element = col-&gt;Element();</span>
<a href="#l10.137"></a><span id="l10.137">   if (!element)</span>
<a href="#l10.138"></a><span id="l10.138">     return NS_OK;</span>
<a href="#l10.139"></a><span id="l10.139"> </span>
<a href="#l10.140"></a><span id="l10.140">   nsAutoString dir;</span>
<a href="#l10.141"></a><span id="l10.141">   element-&gt;GetAttribute(NS_LITERAL_STRING(&quot;sortDirection&quot;), dir);</span>
<a href="#l10.142"></a><span id="l10.142">   mSearchResultSortDescending = dir.EqualsLiteral(&quot;descending&quot;);</span>
<a href="#l10.143"></a><span id="l10.143">   return NS_OK;</span>
<a href="#l10.144"></a><span id="l10.144"> }</span>
<a href="#l10.145"></a><span id="l10.145"> </span>
<a href="#l10.146"></a><span id="l10.146"> NS_IMETHODIMP</span>
<a href="#l10.147"></a><span id="l10.147"> nsNntpIncomingServer::ToggleOpenState(int32_t index)</span>
<a href="#l10.148"></a><span id="l10.148"> {</span>
<a href="#l10.149"></a><span id="l10.149">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l10.150"></a><span id="l10.150"> }</span>
<a href="#l10.151"></a><span id="l10.151"> </span>
<a href="#l10.152"></a><span id="l10.152"> NS_IMETHODIMP</span>
<a href="#l10.153"></a><span id="l10.153" class="difflineminus">-nsNntpIncomingServer::CycleHeader(nsITreeColumn* col)</span>
<a href="#l10.154"></a><span id="l10.154" class="difflineplus">+nsNntpIncomingServer::CycleHeader(nsTreeColumn* col)</span>
<a href="#l10.155"></a><span id="l10.155"> {</span>
<a href="#l10.156"></a><span id="l10.156">   NS_ENSURE_ARG_POINTER(col);</span>
<a href="#l10.157"></a><span id="l10.157"> </span>
<a href="#l10.158"></a><span id="l10.158" class="difflineminus">-  bool cycler;</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineminus">-  col-&gt;GetCycler(&amp;cycler);</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineplus">+  bool cycler = col-&gt;Cycler();</span>
<a href="#l10.161"></a><span id="l10.161">   if (!cycler) {</span>
<a href="#l10.162"></a><span id="l10.162">     NS_NAMED_LITERAL_STRING(dir, &quot;sortDirection&quot;);</span>
<a href="#l10.163"></a><span id="l10.163" class="difflineminus">-    RefPtr&lt;mozilla::dom::Element&gt; element;</span>
<a href="#l10.164"></a><span id="l10.164" class="difflineminus">-    col-&gt;GetElement(getter_AddRefs(element));</span>
<a href="#l10.165"></a><span id="l10.165" class="difflineplus">+    RefPtr&lt;mozilla::dom::Element&gt; element = col-&gt;Element();</span>
<a href="#l10.166"></a><span id="l10.166">     mSearchResultSortDescending = !mSearchResultSortDescending;</span>
<a href="#l10.167"></a><span id="l10.167">     mozilla::IgnoredErrorResult rv2;</span>
<a href="#l10.168"></a><span id="l10.168">     element-&gt;SetAttribute(dir,</span>
<a href="#l10.169"></a><span id="l10.169">                           mSearchResultSortDescending ?</span>
<a href="#l10.170"></a><span id="l10.170">                             NS_LITERAL_STRING(&quot;descending&quot;) :</span>
<a href="#l10.171"></a><span id="l10.171">                             NS_LITERAL_STRING(&quot;ascending&quot;),</span>
<a href="#l10.172"></a><span id="l10.172">                           rv2);</span>
<a href="#l10.173"></a><span id="l10.173">     mTree-&gt;Invalidate();</span>
<a href="#l10.174"></a><span id="l10.174" class="difflineat">@@ -1938,43 +1933,43 @@ nsNntpIncomingServer::CycleHeader(nsITre</span>
<a href="#l10.175"></a><span id="l10.175"> </span>
<a href="#l10.176"></a><span id="l10.176"> NS_IMETHODIMP</span>
<a href="#l10.177"></a><span id="l10.177"> nsNntpIncomingServer::SelectionChanged()</span>
<a href="#l10.178"></a><span id="l10.178"> {</span>
<a href="#l10.179"></a><span id="l10.179">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l10.180"></a><span id="l10.180"> }</span>
<a href="#l10.181"></a><span id="l10.181"> </span>
<a href="#l10.182"></a><span id="l10.182"> NS_IMETHODIMP</span>
<a href="#l10.183"></a><span id="l10.183" class="difflineminus">-nsNntpIncomingServer::CycleCell(int32_t row, nsITreeColumn* col)</span>
<a href="#l10.184"></a><span id="l10.184" class="difflineplus">+nsNntpIncomingServer::CycleCell(int32_t row, nsTreeColumn* col)</span>
<a href="#l10.185"></a><span id="l10.185"> {</span>
<a href="#l10.186"></a><span id="l10.186">   return NS_OK;</span>
<a href="#l10.187"></a><span id="l10.187"> }</span>
<a href="#l10.188"></a><span id="l10.188"> </span>
<a href="#l10.189"></a><span id="l10.189"> NS_IMETHODIMP</span>
<a href="#l10.190"></a><span id="l10.190" class="difflineminus">-nsNntpIncomingServer::IsEditable(int32_t row, nsITreeColumn* col, bool *_retval)</span>
<a href="#l10.191"></a><span id="l10.191" class="difflineplus">+nsNntpIncomingServer::IsEditable(int32_t row, nsTreeColumn* col, bool *_retval)</span>
<a href="#l10.192"></a><span id="l10.192"> {</span>
<a href="#l10.193"></a><span id="l10.193">   *_retval = false;</span>
<a href="#l10.194"></a><span id="l10.194">   return NS_OK;</span>
<a href="#l10.195"></a><span id="l10.195"> }</span>
<a href="#l10.196"></a><span id="l10.196"> </span>
<a href="#l10.197"></a><span id="l10.197"> NS_IMETHODIMP</span>
<a href="#l10.198"></a><span id="l10.198" class="difflineminus">-nsNntpIncomingServer::IsSelectable(int32_t row, nsITreeColumn* col, bool *_retval)</span>
<a href="#l10.199"></a><span id="l10.199" class="difflineplus">+nsNntpIncomingServer::IsSelectable(int32_t row, nsTreeColumn* col, bool *_retval)</span>
<a href="#l10.200"></a><span id="l10.200"> {</span>
<a href="#l10.201"></a><span id="l10.201">   *_retval = false;</span>
<a href="#l10.202"></a><span id="l10.202">   return NS_OK;</span>
<a href="#l10.203"></a><span id="l10.203"> }</span>
<a href="#l10.204"></a><span id="l10.204"> </span>
<a href="#l10.205"></a><span id="l10.205"> NS_IMETHODIMP</span>
<a href="#l10.206"></a><span id="l10.206" class="difflineminus">-nsNntpIncomingServer::SetCellValue(int32_t row, nsITreeColumn* col, const nsAString&amp; value)</span>
<a href="#l10.207"></a><span id="l10.207" class="difflineplus">+nsNntpIncomingServer::SetCellValue(int32_t row, nsTreeColumn* col, const nsAString&amp; value)</span>
<a href="#l10.208"></a><span id="l10.208"> {</span>
<a href="#l10.209"></a><span id="l10.209">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l10.210"></a><span id="l10.210"> }</span>
<a href="#l10.211"></a><span id="l10.211"> </span>
<a href="#l10.212"></a><span id="l10.212"> NS_IMETHODIMP</span>
<a href="#l10.213"></a><span id="l10.213" class="difflineminus">-nsNntpIncomingServer::SetCellText(int32_t row, nsITreeColumn* col, const nsAString&amp; value)</span>
<a href="#l10.214"></a><span id="l10.214" class="difflineplus">+nsNntpIncomingServer::SetCellText(int32_t row, nsTreeColumn* col, const nsAString&amp; value)</span>
<a href="#l10.215"></a><span id="l10.215"> {</span>
<a href="#l10.216"></a><span id="l10.216">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l10.217"></a><span id="l10.217"> }</span>
<a href="#l10.218"></a><span id="l10.218"> </span>
<a href="#l10.219"></a><span id="l10.219"> NS_IMETHODIMP</span>
<a href="#l10.220"></a><span id="l10.220"> nsNntpIncomingServer::PerformAction(const char16_t *action)</span>
<a href="#l10.221"></a><span id="l10.221"> {</span>
<a href="#l10.222"></a><span id="l10.222">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l10.223"></a><span id="l10.223" class="difflineat">@@ -1982,17 +1977,17 @@ nsNntpIncomingServer::PerformAction(cons</span>
<a href="#l10.224"></a><span id="l10.224"> </span>
<a href="#l10.225"></a><span id="l10.225"> NS_IMETHODIMP</span>
<a href="#l10.226"></a><span id="l10.226"> nsNntpIncomingServer::PerformActionOnRow(const char16_t *action, int32_t row)</span>
<a href="#l10.227"></a><span id="l10.227"> {</span>
<a href="#l10.228"></a><span id="l10.228">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l10.229"></a><span id="l10.229"> }</span>
<a href="#l10.230"></a><span id="l10.230"> </span>
<a href="#l10.231"></a><span id="l10.231"> NS_IMETHODIMP</span>
<a href="#l10.232"></a><span id="l10.232" class="difflineminus">-nsNntpIncomingServer::PerformActionOnCell(const char16_t *action, int32_t row, nsITreeColumn* col)</span>
<a href="#l10.233"></a><span id="l10.233" class="difflineplus">+nsNntpIncomingServer::PerformActionOnCell(const char16_t *action, int32_t row, nsTreeColumn* col)</span>
<a href="#l10.234"></a><span id="l10.234"> {</span>
<a href="#l10.235"></a><span id="l10.235">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l10.236"></a><span id="l10.236"> }</span>
<a href="#l10.237"></a><span id="l10.237"> </span>
<a href="#l10.238"></a><span id="l10.238"> NS_IMETHODIMP</span>
<a href="#l10.239"></a><span id="l10.239"> nsNntpIncomingServer::GetCanFileMessagesOnServer(bool *aCanFileMessagesOnServer)</span>
<a href="#l10.240"></a><span id="l10.240"> {</span>
<a href="#l10.241"></a><span id="l10.241">   NS_ENSURE_ARG_POINTER(aCanFileMessagesOnServer);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

