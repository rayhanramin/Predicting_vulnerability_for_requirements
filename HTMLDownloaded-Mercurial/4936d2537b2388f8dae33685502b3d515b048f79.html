<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 10687:4936d2537b2388f8dae33685502b3d515b048f79</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 4936d2537b2388f8dae33685502b3d515b048f79" />
<meta property="og:url" content="/comm-central/rev/4936d2537b2388f8dae33685502b3d515b048f79" />
<meta property="og:description" content="Bug 765958 - IMAP test cleanup. r=mconley" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 4936d2537b2388f8dae33685502b3d515b048f79 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/4936d2537b2388f8dae33685502b3d515b048f79">shortlog</a> |
<a href="/comm-central/log/4936d2537b2388f8dae33685502b3d515b048f79">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/4936d2537b2388f8dae33685502b3d515b048f79">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/4936d2537b2388f8dae33685502b3d515b048f79">files</a> |
changeset |
<a href="/comm-central/raw-rev/4936d2537b2388f8dae33685502b3d515b048f79">raw</a>  | <a href="/comm-central/archive/4936d2537b2388f8dae33685502b3d515b048f79.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=765958">Bug 765958</a> - IMAP test cleanup. r=mconley
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#72;&#105;&#114;&#111;&#121;&#117;&#107;&#105;&#32;&#73;&#107;&#101;&#122;&#111;&#101;&#32;&#60;&#104;&#105;&#105;&#107;&#101;&#122;&#111;&#101;&#64;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#45;&#106;&#97;&#112;&#97;&#110;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 18 Jul 2012 21:18:33 -0400</td></tr>

<tr>
 <td>changeset 10687</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/4936d2537b2388f8dae33685502b3d515b048f79">4936d2537b2388f8dae33685502b3d515b048f79</a></td>
</tr>



<tr>
<td>parent 10686</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/e7508a6c7dca3f4b4b8db3c6e71161e1d03f3ce2">e7508a6c7dca3f4b4b8db3c6e71161e1d03f3ce2</a>
</td>
</tr>

<tr>
<td>child 10688</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/fcaac2b8b60820c861f8e8c77eaa1b76ecd88d18">fcaac2b8b60820c861f8e8c77eaa1b76ecd88d18</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=4936d2537b2388f8dae33685502b3d515b048f79">8064</a></td></tr>
<tr><td>push user</td><td>ryanvm@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 19 Jul 2012 01:21:59 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@62ddb46cd654 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=62ddb46cd65453697e8efe7d9e4ae987682d9213">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=62ddb46cd65453697e8efe7d9e4ae987682d9213&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=62ddb46cd65453697e8efe7d9e4ae987682d9213&newProject=comm-central&newRevision=e7508a6c7dca3f4b4b8db3c6e71161e1d03f3ce2&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=62ddb46cd65453697e8efe7d9e4ae987682d9213&newProject=comm-central&newRevision=e7508a6c7dca3f4b4b8db3c6e71161e1d03f3ce2&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=62ddb46cd65453697e8efe7d9e4ae987682d9213&newProject=comm-central&newRevision=e7508a6c7dca3f4b4b8db3c6e71161e1d03f3ce2&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mconley%29&revcount=50">mconley</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=765958">765958</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=765958">Bug 765958</a> - IMAP test cleanup. r=mconley</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_autosync_date_constraints.js">mailnews/imap/test/unit/test_autosync_date_constraints.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_autosync_date_constraints.js">file</a> |
<a href="/comm-central/annotate/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_autosync_date_constraints.js">annotate</a> |
<a href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_autosync_date_constraints.js">diff</a> |
<a href="/comm-central/comparison/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_autosync_date_constraints.js">comparison</a> |
<a href="/comm-central/log/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_autosync_date_constraints.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_bccProperty.js">mailnews/imap/test/unit/test_bccProperty.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_bccProperty.js">file</a> |
<a href="/comm-central/annotate/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_bccProperty.js">annotate</a> |
<a href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_bccProperty.js">diff</a> |
<a href="/comm-central/comparison/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_bccProperty.js">comparison</a> |
<a href="/comm-central/log/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_bccProperty.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_bug460636.js">mailnews/imap/test/unit/test_bug460636.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_bug460636.js">file</a> |
<a href="/comm-central/annotate/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_bug460636.js">annotate</a> |
<a href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_bug460636.js">diff</a> |
<a href="/comm-central/comparison/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_bug460636.js">comparison</a> |
<a href="/comm-central/log/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_bug460636.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_compactOfflineStore.js">mailnews/imap/test/unit/test_compactOfflineStore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_compactOfflineStore.js">file</a> |
<a href="/comm-central/annotate/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_compactOfflineStore.js">annotate</a> |
<a href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_compactOfflineStore.js">diff</a> |
<a href="/comm-central/comparison/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_compactOfflineStore.js">comparison</a> |
<a href="/comm-central/log/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_compactOfflineStore.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_copyThenMove.js">mailnews/imap/test/unit/test_copyThenMove.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_copyThenMove.js">file</a> |
<a href="/comm-central/annotate/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_copyThenMove.js">annotate</a> |
<a href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_copyThenMove.js">diff</a> |
<a href="/comm-central/comparison/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_copyThenMove.js">comparison</a> |
<a href="/comm-central/log/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_copyThenMove.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_downloadOffline.js">mailnews/imap/test/unit/test_downloadOffline.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_downloadOffline.js">file</a> |
<a href="/comm-central/annotate/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_downloadOffline.js">annotate</a> |
<a href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_downloadOffline.js">diff</a> |
<a href="/comm-central/comparison/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_downloadOffline.js">comparison</a> |
<a href="/comm-central/log/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_downloadOffline.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_filterNeedsBody.js">mailnews/imap/test/unit/test_filterNeedsBody.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_filterNeedsBody.js">file</a> |
<a href="/comm-central/annotate/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_filterNeedsBody.js">annotate</a> |
<a href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_filterNeedsBody.js">diff</a> |
<a href="/comm-central/comparison/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_filterNeedsBody.js">comparison</a> |
<a href="/comm-central/log/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_filterNeedsBody.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapAttachmentSaves.js">mailnews/imap/test/unit/test_imapAttachmentSaves.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapAttachmentSaves.js">file</a> |
<a href="/comm-central/annotate/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapAttachmentSaves.js">annotate</a> |
<a href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapAttachmentSaves.js">diff</a> |
<a href="/comm-central/comparison/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapAttachmentSaves.js">comparison</a> |
<a href="/comm-central/log/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapAttachmentSaves.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapContentLength.js">mailnews/imap/test/unit/test_imapContentLength.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapContentLength.js">file</a> |
<a href="/comm-central/annotate/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapContentLength.js">annotate</a> |
<a href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapContentLength.js">diff</a> |
<a href="/comm-central/comparison/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapContentLength.js">comparison</a> |
<a href="/comm-central/log/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapContentLength.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapCopyTimeout.js">mailnews/imap/test/unit/test_imapCopyTimeout.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapCopyTimeout.js">file</a> |
<a href="/comm-central/annotate/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapCopyTimeout.js">annotate</a> |
<a href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapCopyTimeout.js">diff</a> |
<a href="/comm-central/comparison/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapCopyTimeout.js">comparison</a> |
<a href="/comm-central/log/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapCopyTimeout.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapFlagChange.js">mailnews/imap/test/unit/test_imapFlagChange.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapFlagChange.js">file</a> |
<a href="/comm-central/annotate/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapFlagChange.js">annotate</a> |
<a href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapFlagChange.js">diff</a> |
<a href="/comm-central/comparison/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapFlagChange.js">comparison</a> |
<a href="/comm-central/log/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapFlagChange.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapFolderCopy.js">mailnews/imap/test/unit/test_imapFolderCopy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapFolderCopy.js">file</a> |
<a href="/comm-central/annotate/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapFolderCopy.js">annotate</a> |
<a href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapFolderCopy.js">diff</a> |
<a href="/comm-central/comparison/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapFolderCopy.js">comparison</a> |
<a href="/comm-central/log/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapFolderCopy.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapID.js">mailnews/imap/test/unit/test_imapID.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapID.js">file</a> |
<a href="/comm-central/annotate/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapID.js">annotate</a> |
<a href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapID.js">diff</a> |
<a href="/comm-central/comparison/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapID.js">comparison</a> |
<a href="/comm-central/log/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapID.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapMove.js">mailnews/imap/test/unit/test_imapMove.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapMove.js">file</a> |
<a href="/comm-central/annotate/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapMove.js">annotate</a> |
<a href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapMove.js">diff</a> |
<a href="/comm-central/comparison/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapMove.js">comparison</a> |
<a href="/comm-central/log/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapMove.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapStatusCloseDBs.js">mailnews/imap/test/unit/test_imapStatusCloseDBs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapStatusCloseDBs.js">file</a> |
<a href="/comm-central/annotate/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapStatusCloseDBs.js">annotate</a> |
<a href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapStatusCloseDBs.js">diff</a> |
<a href="/comm-central/comparison/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapStatusCloseDBs.js">comparison</a> |
<a href="/comm-central/log/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapStatusCloseDBs.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapStoreMsgOffline.js">mailnews/imap/test/unit/test_imapStoreMsgOffline.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapStoreMsgOffline.js">file</a> |
<a href="/comm-central/annotate/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapStoreMsgOffline.js">annotate</a> |
<a href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapStoreMsgOffline.js">diff</a> |
<a href="/comm-central/comparison/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapStoreMsgOffline.js">comparison</a> |
<a href="/comm-central/log/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapStoreMsgOffline.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapUndo.js">mailnews/imap/test/unit/test_imapUndo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapUndo.js">file</a> |
<a href="/comm-central/annotate/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapUndo.js">annotate</a> |
<a href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapUndo.js">diff</a> |
<a href="/comm-central/comparison/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapUndo.js">comparison</a> |
<a href="/comm-central/log/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_imapUndo.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_largeOfflineStore.js">mailnews/imap/test/unit/test_largeOfflineStore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_largeOfflineStore.js">file</a> |
<a href="/comm-central/annotate/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_largeOfflineStore.js">annotate</a> |
<a href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_largeOfflineStore.js">diff</a> |
<a href="/comm-central/comparison/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_largeOfflineStore.js">comparison</a> |
<a href="/comm-central/log/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_largeOfflineStore.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_listClosesDB.js">mailnews/imap/test/unit/test_listClosesDB.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_listClosesDB.js">file</a> |
<a href="/comm-central/annotate/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_listClosesDB.js">annotate</a> |
<a href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_listClosesDB.js">diff</a> |
<a href="/comm-central/comparison/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_listClosesDB.js">comparison</a> |
<a href="/comm-central/log/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_listClosesDB.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_localToImapFilter.js">mailnews/imap/test/unit/test_localToImapFilter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_localToImapFilter.js">file</a> |
<a href="/comm-central/annotate/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_localToImapFilter.js">annotate</a> |
<a href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_localToImapFilter.js">diff</a> |
<a href="/comm-central/comparison/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_localToImapFilter.js">comparison</a> |
<a href="/comm-central/log/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_localToImapFilter.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_mailboxes.js">mailnews/imap/test/unit/test_mailboxes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_mailboxes.js">file</a> |
<a href="/comm-central/annotate/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_mailboxes.js">annotate</a> |
<a href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_mailboxes.js">diff</a> |
<a href="/comm-central/comparison/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_mailboxes.js">comparison</a> |
<a href="/comm-central/log/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_mailboxes.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_offlinePlayback.js">mailnews/imap/test/unit/test_offlinePlayback.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_offlinePlayback.js">file</a> |
<a href="/comm-central/annotate/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_offlinePlayback.js">annotate</a> |
<a href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_offlinePlayback.js">diff</a> |
<a href="/comm-central/comparison/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_offlinePlayback.js">comparison</a> |
<a href="/comm-central/log/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_offlinePlayback.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_offlineStoreLocking.js">mailnews/imap/test/unit/test_offlineStoreLocking.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_offlineStoreLocking.js">file</a> |
<a href="/comm-central/annotate/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_offlineStoreLocking.js">annotate</a> |
<a href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_offlineStoreLocking.js">diff</a> |
<a href="/comm-central/comparison/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_offlineStoreLocking.js">comparison</a> |
<a href="/comm-central/log/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_offlineStoreLocking.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_preserveDataOnMove.js">mailnews/imap/test/unit/test_preserveDataOnMove.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_preserveDataOnMove.js">file</a> |
<a href="/comm-central/annotate/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_preserveDataOnMove.js">annotate</a> |
<a href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_preserveDataOnMove.js">diff</a> |
<a href="/comm-central/comparison/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_preserveDataOnMove.js">comparison</a> |
<a href="/comm-central/log/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_preserveDataOnMove.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_saveImapDraft.js">mailnews/imap/test/unit/test_saveImapDraft.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_saveImapDraft.js">file</a> |
<a href="/comm-central/annotate/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_saveImapDraft.js">annotate</a> |
<a href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_saveImapDraft.js">diff</a> |
<a href="/comm-central/comparison/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_saveImapDraft.js">comparison</a> |
<a href="/comm-central/log/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_saveImapDraft.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_saveTemplate.js">mailnews/imap/test/unit/test_saveTemplate.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_saveTemplate.js">file</a> |
<a href="/comm-central/annotate/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_saveTemplate.js">annotate</a> |
<a href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_saveTemplate.js">diff</a> |
<a href="/comm-central/comparison/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_saveTemplate.js">comparison</a> |
<a href="/comm-central/log/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_saveTemplate.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_starttlsFailure.js">mailnews/imap/test/unit/test_starttlsFailure.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_starttlsFailure.js">file</a> |
<a href="/comm-central/annotate/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_starttlsFailure.js">annotate</a> |
<a href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_starttlsFailure.js">diff</a> |
<a href="/comm-central/comparison/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_starttlsFailure.js">comparison</a> |
<a href="/comm-central/log/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_starttlsFailure.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_stopMovingToLocalFolder.js">mailnews/imap/test/unit/test_stopMovingToLocalFolder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_stopMovingToLocalFolder.js">file</a> |
<a href="/comm-central/annotate/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_stopMovingToLocalFolder.js">annotate</a> |
<a href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_stopMovingToLocalFolder.js">diff</a> |
<a href="/comm-central/comparison/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_stopMovingToLocalFolder.js">comparison</a> |
<a href="/comm-central/log/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_stopMovingToLocalFolder.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_syncChanges.js">mailnews/imap/test/unit/test_syncChanges.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_syncChanges.js">file</a> |
<a href="/comm-central/annotate/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_syncChanges.js">annotate</a> |
<a href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_syncChanges.js">diff</a> |
<a href="/comm-central/comparison/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_syncChanges.js">comparison</a> |
<a href="/comm-central/log/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_syncChanges.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_trustSpamAssassin.js">mailnews/imap/test/unit/test_trustSpamAssassin.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_trustSpamAssassin.js">file</a> |
<a href="/comm-central/annotate/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_trustSpamAssassin.js">annotate</a> |
<a href="/comm-central/diff/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_trustSpamAssassin.js">diff</a> |
<a href="/comm-central/comparison/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_trustSpamAssassin.js">comparison</a> |
<a href="/comm-central/log/4936d2537b2388f8dae33685502b3d515b048f79/mailnews/imap/test/unit/test_trustSpamAssassin.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_autosync_date_constraints.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_autosync_date_constraints.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1,38 +1,41 @@</span>
<a href="#l1.4"></a><span id="l1.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l1.5"></a><span id="l1.5"> /*</span>
<a href="#l1.6"></a><span id="l1.6">  * Test autosync date constraints</span>
<a href="#l1.7"></a><span id="l1.7">  */</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9" class="difflineplus">+load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l1.10"></a><span id="l1.10" class="difflineplus">+load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineplus">+load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l1.12"></a><span id="l1.12"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l1.14"></a><span id="l1.14"> </span>
<a href="#l1.15"></a><span id="l1.15"> var gRootFolder;</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-var gIMAPInbox, gIMAPTrashFolder, gMsgImapInboxFolder;</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-var gIMAPDaemon, gServer, gIMAPIncomingServer;</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+var gIMAPTrashFolder, gMsgImapInboxFolder;</span>
<a href="#l1.19"></a><span id="l1.19"> var gImapInboxOfflineStoreSize;</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-var gCurTestNum;</span>
<a href="#l1.21"></a><span id="l1.21"> </span>
<a href="#l1.22"></a><span id="l1.22"> // Adds some messages directly to a mailbox (eg new mail)</span>
<a href="#l1.23"></a><span id="l1.23"> function addMessagesToServer(messages, mailbox, localFolder)</span>
<a href="#l1.24"></a><span id="l1.24"> {</span>
<a href="#l1.25"></a><span id="l1.25">   // Create the imapMessages and store them on the mailbox</span>
<a href="#l1.26"></a><span id="l1.26">   messages.forEach(function (message)</span>
<a href="#l1.27"></a><span id="l1.27">   {</span>
<a href="#l1.28"></a><span id="l1.28">     let dataUri = 'data:text/plain,' + message.toMessageString();</span>
<a href="#l1.29"></a><span id="l1.29">     mailbox.addMessage(new imapMessage(dataUri, mailbox.uidnext++, []));</span>
<a href="#l1.30"></a><span id="l1.30">   });</span>
<a href="#l1.31"></a><span id="l1.31"> }</span>
<a href="#l1.32"></a><span id="l1.32"> </span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-const gTestArray =</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-[</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+var tests = [</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+  setup,</span>
<a href="#l1.37"></a><span id="l1.37">   function downloadForOffline() {</span>
<a href="#l1.38"></a><span id="l1.38">     // ...and download for offline use.</span>
<a href="#l1.39"></a><span id="l1.39">     // This downloads all messages, ignoring the autosync age constraints.</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-    gIMAPInbox.downloadAllForOffline(UrlListener, null);</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+    gIMAPInbox.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+    yield false;</span>
<a href="#l1.43"></a><span id="l1.43">   },</span>
<a href="#l1.44"></a><span id="l1.44">   function applyRetentionSettings() {</span>
<a href="#l1.45"></a><span id="l1.45">     gIMAPInbox.applyRetentionSettings();</span>
<a href="#l1.46"></a><span id="l1.46">     let enumerator = gIMAPInbox.msgDatabase.EnumerateMessages();</span>
<a href="#l1.47"></a><span id="l1.47">     if (enumerator) {</span>
<a href="#l1.48"></a><span id="l1.48">       let now = new Date();</span>
<a href="#l1.49"></a><span id="l1.49">       let dateInSeconds = now.getSeconds();</span>
<a href="#l1.50"></a><span id="l1.50">       let cutOffDateInSeconds = dateInSeconds - (5 * 60 * 24);</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineat">@@ -41,64 +44,26 @@ const gTestArray =</span>
<a href="#l1.52"></a><span id="l1.52">         if (header instanceof Components.interfaces.nsIMsgDBHdr) {</span>
<a href="#l1.53"></a><span id="l1.53">           if (header.dateInSeconds &lt; cutOffDateInSeconds)</span>
<a href="#l1.54"></a><span id="l1.54">             do_check_eq(header.getStringProperty(&quot;pendingRemoval&quot;), &quot;1&quot;);</span>
<a href="#l1.55"></a><span id="l1.55">           else</span>
<a href="#l1.56"></a><span id="l1.56">             do_check_eq(header.getStringProperty(&quot;pendingRemoval&quot;), &quot;&quot;);</span>
<a href="#l1.57"></a><span id="l1.57">         }</span>
<a href="#l1.58"></a><span id="l1.58">       }</span>
<a href="#l1.59"></a><span id="l1.59">     }</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-    doTest(++gCurTestNum);</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineminus">-  }</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+  },</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+  teardown</span>
<a href="#l1.64"></a><span id="l1.64"> ];</span>
<a href="#l1.65"></a><span id="l1.65"> </span>
<a href="#l1.66"></a><span id="l1.66" class="difflineminus">-function run_test()</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineminus">-{</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineminus">-  // Add a listener.</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineminus">-  gIMAPDaemon = new imapDaemon();</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineminus">-  gServer = makeServer(gIMAPDaemon, &quot;&quot;);</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineminus">-</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineminus">-  gIMAPIncomingServer = createLocalIMAPServer();</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineminus">-</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineminus">-  loadLocalMailAccount();</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineminus">-</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineminus">-  // We need an identity so that updateFolder doesn't fail</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineminus">-  let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineminus">-  let localAccount = acctMgr.createAccount();</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineminus">-  let identity = acctMgr.createIdentity();</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineminus">-  localAccount.addIdentity(identity);</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineminus">-  localAccount.defaultIdentity = identity;</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineminus">-  localAccount.incomingServer = gLocalIncomingServer;</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineminus">-  acctMgr.defaultAccount = localAccount;</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+function setup() {</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+  Services.prefs.setIntPref(&quot;mail.server.server1.autosync_max_age_days&quot;, 4);</span>
<a href="#l1.87"></a><span id="l1.87"> </span>
<a href="#l1.88"></a><span id="l1.88" class="difflineminus">-  // Let's also have another account, using the same identity</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineminus">-  let imapAccount = acctMgr.createAccount();</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineminus">-  imapAccount.addIdentity(identity);</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineminus">-  imapAccount.defaultIdentity = identity;</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineminus">-  imapAccount.incomingServer = gIMAPIncomingServer;</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineminus">-</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineminus">-  // The server doesn't support more than one connection</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineminus">-  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineminus">-                     .getService(Ci.nsIPrefBranch);</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineminus">-  prefBranch.setIntPref(&quot;mail.server.server1.max_cached_connections&quot;, 1);</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineminus">-  // Make sure no biff notifications happen</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineminus">-  // We aren't interested in downloading messages automatically</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.server.server1.download_on_biff&quot;, false);</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineminus">-  prefBranch.setIntPref(&quot;mail.server.server1.autosync_max_age_days&quot;, 4);</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineminus">-</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineminus">-  // Get the server list...</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineminus">-  gIMAPIncomingServer.performExpand(null);</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineplus">+  setupIMAPPump();</span>
<a href="#l1.110"></a><span id="l1.110"> </span>
<a href="#l1.111"></a><span id="l1.111">   gRootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineminus">-  gIMAPInbox = gRootFolder.getChildNamed(&quot;INBOX&quot;);</span>
<a href="#l1.113"></a><span id="l1.113">   gMsgImapInboxFolder = gIMAPInbox.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l1.114"></a><span id="l1.114">   // these hacks are required because we've created the inbox before</span>
<a href="#l1.115"></a><span id="l1.115">   // running initial folder discovery, and adding the folder bails</span>
<a href="#l1.116"></a><span id="l1.116">   // out before we set it as verified online, so we bail out, and</span>
<a href="#l1.117"></a><span id="l1.117">   // then remove the INBOX folder since it's not verified.</span>
<a href="#l1.118"></a><span id="l1.118">   gMsgImapInboxFolder.hierarchyDelimiter = '/';</span>
<a href="#l1.119"></a><span id="l1.119">   gMsgImapInboxFolder.verifiedAsOnlineFolder = true;</span>
<a href="#l1.120"></a><span id="l1.120"> </span>
<a href="#l1.121"></a><span id="l1.121" class="difflineat">@@ -111,72 +76,17 @@ function run_test()</span>
<a href="#l1.122"></a><span id="l1.122">   // build up a diverse list of messages</span>
<a href="#l1.123"></a><span id="l1.123">   let messages = [];</span>
<a href="#l1.124"></a><span id="l1.124">   messages = messages.concat(messageGenerator.makeMessage({age: {days: 2, hours: 1}}));</span>
<a href="#l1.125"></a><span id="l1.125">   messages = messages.concat(messageGenerator.makeMessage({age: {days: 8, hours: 1}}));</span>
<a href="#l1.126"></a><span id="l1.126">   messages = messages.concat(messageGenerator.makeMessage({age: {days: 10, hours: 1}}));</span>
<a href="#l1.127"></a><span id="l1.127"> </span>
<a href="#l1.128"></a><span id="l1.128">   addMessagesToServer(messages,</span>
<a href="#l1.129"></a><span id="l1.129">                       gIMAPDaemon.getMailbox(&quot;INBOX&quot;), gIMAPInbox);</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineminus">-  // &quot;Master&quot; do_test_pending(), paired with a do_test_finished() at the end of</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineminus">-  // all the operations.</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineminus">-  do_test_pending();</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineminus">-  //start first test</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineminus">-  doTest(1);</span>
<a href="#l1.135"></a><span id="l1.135"> }</span>
<a href="#l1.136"></a><span id="l1.136"> </span>
<a href="#l1.137"></a><span id="l1.137" class="difflineminus">-function doTest(test)</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineminus">-{</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineminus">-  if (test &lt;= gTestArray.length)</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineminus">-  {</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineminus">-    dump(&quot;Doing test &quot; + test + &quot;\n&quot;);</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineminus">-    gCurTestNum = test;</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineminus">-</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineminus">-    var testFn = gTestArray[test-1];</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineminus">-    // Set a limit of three seconds; if the notifications haven't arrived by then there's a problem.</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineminus">-    do_timeout(10000, function(){</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineminus">-        if (gCurTestNum == test)</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineminus">-          do_throw(&quot;Notifications not received in 10000 ms for operation &quot; + testFn.name);</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineminus">-        }</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineminus">-      );</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineminus">-    try {</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineminus">-    testFn();</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineminus">-    } catch(ex) {dump(ex);}</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineminus">-  }</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineminus">-  else</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineminus">-  {</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineminus">-    // Cleanup, null out everything, close all cached connections and stop the</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineminus">-    // server</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineminus">-    gRootFolder = null;</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineminus">-    gIMAPInbox = null;</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineminus">-    gMsgImapInboxFolder = null;</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineminus">-    gIMAPTrashFolder = null;</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineminus">-    do_timeout_function(1000, endTest);</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineminus">-  }</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineplus">+function teardown() {</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineplus">+  teardownIMAPPump();</span>
<a href="#l1.167"></a><span id="l1.167"> }</span>
<a href="#l1.168"></a><span id="l1.168"> </span>
<a href="#l1.169"></a><span id="l1.169" class="difflineminus">-function endTest()</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineminus">-{</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineminus">-  gServer.resetTest();</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineminus">-  gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineminus">-  gServer.performTest();</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineminus">-  gServer.stop();</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineminus">-  let thread = gThreadManager.currentThread;</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineminus">-  while (thread.hasPendingEvents())</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineminus">-    thread.processNextEvent(true);</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineminus">-</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineminus">-  do_test_finished(); // for the one in run_test()</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineplus">+function run_test() {</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineplus">+  async_run_tests(tests);</span>
<a href="#l1.182"></a><span id="l1.182"> }</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineminus">-</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineminus">-var UrlListener = </span>
<a href="#l1.185"></a><span id="l1.185" class="difflineminus">-{</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineminus">-  OnStartRunningUrl: function(url) { },</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineminus">-</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineminus">-  OnStopRunningUrl: function (aUrl, aExitCode) {</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineminus">-    // Check: message successfully copied.</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineminus">-    do_check_eq(aExitCode, 0);</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineminus">-    // Ugly hack: make sure we don't get stuck in a JS-&gt;C++-&gt;JS-&gt;C++... call stack</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineminus">-    // This can happen with a bunch of synchronous functions grouped together, and</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineminus">-    // can even cause tests to fail because they're still waiting for the listener</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineminus">-    // to return</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineminus">-    do_timeout(0, function(){doTest(++gCurTestNum)});</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineminus">-  }</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_bccProperty.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_bccProperty.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -2,101 +2,66 @@</span>
<a href="#l2.4"></a><span id="l2.4"> /*</span>
<a href="#l2.5"></a><span id="l2.5">  * Test to ensure that BCC gets added to message headers on IMAP download</span>
<a href="#l2.6"></a><span id="l2.6">  *</span>
<a href="#l2.7"></a><span id="l2.7">  * adapted from test_downloadOffline.js</span>
<a href="#l2.8"></a><span id="l2.8">  *</span>
<a href="#l2.9"></a><span id="l2.9">  * original author Kent James &lt;kent@caspia.com&gt;</span>
<a href="#l2.10"></a><span id="l2.10">  */</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-var gIMAPDaemon, gServer, gIMAPIncomingServer;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18"> const gFileName = &quot;draft1&quot;;</span>
<a href="#l2.19"></a><span id="l2.19"> const gMsgFile = do_get_file(&quot;../../../data/&quot; + gFileName);</span>
<a href="#l2.20"></a><span id="l2.20"> </span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-var gDownloadedOnce = false;</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-var gIMAPInbox;</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-function run_test()</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">-{</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-  loadLocalMailAccount();</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+var tests = [</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+  setup,</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+  downloadAllForOffline,</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+  checkBccs,</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+  teardown</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+];</span>
<a href="#l2.33"></a><span id="l2.33"> </span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-  /*</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-   * Set up an IMAP server.</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-   */</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-  gIMAPDaemon = new imapDaemon();</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-  gServer = makeServer(gIMAPDaemon, &quot;&quot;);</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-  gIMAPIncomingServer = createLocalIMAPServer();</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-  gIMAPIncomingServer.maximumConnectionsNumber = 1;</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-  // pref tuning: one connection only, turn off notifications</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-                     .getService(Ci.nsIPrefBranch);</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-  let inbox = gIMAPDaemon.getMailbox(&quot;INBOX&quot;);</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+function setup() {</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+  setupIMAPPump();</span>
<a href="#l2.53"></a><span id="l2.53"> </span>
<a href="#l2.54"></a><span id="l2.54">   /*</span>
<a href="#l2.55"></a><span id="l2.55">    * Ok, prelude done. Read the original message from disk</span>
<a href="#l2.56"></a><span id="l2.56">    * (through a file URI), and add it to the Inbox.</span>
<a href="#l2.57"></a><span id="l2.57">    */</span>
<a href="#l2.58"></a><span id="l2.58">   let msgfileuri = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l2.59"></a><span id="l2.59">                      .getService(Ci.nsIIOService)</span>
<a href="#l2.60"></a><span id="l2.60">                      .newFileURI(gMsgFile).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l2.61"></a><span id="l2.61"> </span>
<a href="#l2.62"></a><span id="l2.62" class="difflineminus">-  inbox.addMessage(new imapMessage(msgfileuri.spec, inbox.uidnext++, []));</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-  do_test_pending();</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-  do_timeout(10000, function(){</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-      do_throw('downloadAllForOffline did not complete within 10 seconds. ABORTING.');</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineminus">-      }</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-    );</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-  // Get the IMAP inbox...</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-  let rootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineminus">-  gIMAPInbox = rootFolder.getFolderWithFlags(Ci.nsMsgFolderFlags.Inbox);</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+  gIMAPMailbox.addMessage(new imapMessage(msgfileuri.spec,</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+                                          gIMAPMailbox.uidnext++, []));</span>
<a href="#l2.75"></a><span id="l2.75"> </span>
<a href="#l2.76"></a><span id="l2.76">   // ...and download for offline use.</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-  gIMAPInbox.downloadAllForOffline(UrlListener, null);</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+  gIMAPInbox.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+  yield false;</span>
<a href="#l2.80"></a><span id="l2.80"> }</span>
<a href="#l2.81"></a><span id="l2.81"> </span>
<a href="#l2.82"></a><span id="l2.82" class="difflineminus">-var UrlListener = </span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-{</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-  OnStartRunningUrl: function(url) { },</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-  OnStopRunningUrl: function(url, rc)</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-  {</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-    // Check for ok status.</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-    do_check_eq(rc, 0);</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+function downloadAllForOffline() {</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+  gIMAPInbox.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+  yield false;</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+}</span>
<a href="#l2.93"></a><span id="l2.93"> </span>
<a href="#l2.94"></a><span id="l2.94" class="difflineminus">-    dump(&quot;in on stop running url\n&quot;);</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineminus">-    if (!gDownloadedOnce) {</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineminus">-      gDownloadedOnce = true;</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineminus">-      gIMAPInbox.downloadAllForOffline(UrlListener, null);</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineminus">-      return;</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineminus">-    }</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineminus">-    do_timeout(1000, endTest);</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-  }</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineminus">-};</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineminus">-</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineminus">-function endTest()</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineminus">-{</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineplus">+function checkBccs() {</span>
<a href="#l2.107"></a><span id="l2.107">   // locate the new message by enumerating through the database</span>
<a href="#l2.108"></a><span id="l2.108">   let enumerator = gIMAPInbox.msgDatabase.EnumerateMessages();</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineminus">-  while(enumerator.hasMoreElements())</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineminus">-  {</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+  while(enumerator.hasMoreElements()) {</span>
<a href="#l2.112"></a><span id="l2.112">     let hdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l2.113"></a><span id="l2.113">     do_check_true(hdr.bccList.indexOf(&quot;Another Person&quot;) &gt;= 0);</span>
<a href="#l2.114"></a><span id="l2.114">     do_check_true(hdr.bccList.indexOf(&quot;&lt;u1@example.com&gt;&quot;) &gt;= 0);</span>
<a href="#l2.115"></a><span id="l2.115">     do_check_false(hdr.bccList.indexOf(&quot;IDoNotExist&quot;) &gt;=0);</span>
<a href="#l2.116"></a><span id="l2.116">   }</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineminus">-</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineminus">-  gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineminus">-  gServer.stop();</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineplus">+}</span>
<a href="#l2.121"></a><span id="l2.121"> </span>
<a href="#l2.122"></a><span id="l2.122" class="difflineminus">-  var thread = gThreadManager.currentThread;</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineminus">-  while (thread.hasPendingEvents())</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineminus">-    thread.processNextEvent(true);</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineplus">+function teardown() {</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineplus">+  teardownIMAPPump();</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineplus">+}</span>
<a href="#l2.128"></a><span id="l2.128"> </span>
<a href="#l2.129"></a><span id="l2.129" class="difflineminus">-  do_test_finished();</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+function run_test() {</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineplus">+  async_run_tests(tests);</span>
<a href="#l2.132"></a><span id="l2.132"> }</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_bug460636.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_bug460636.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,107 +1,83 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /*</span>
<a href="#l3.5"></a><span id="l3.5">  * Test bug 460636 - nsMsgSaveAsListener sometimes inserts extra LF characters</span>
<a href="#l3.6"></a><span id="l3.6">  */</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8" class="difflineminus">-var gIMAPDaemon, gServer, gIMAPIncomingServer, gSavedMsgFile;</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+var gSavedMsgFile;</span>
<a href="#l3.15"></a><span id="l3.15"> </span>
<a href="#l3.16"></a><span id="l3.16"> const gIMAPService = Cc[&quot;@mozilla.org/messenger/messageservice;1?type=imap&quot;]</span>
<a href="#l3.17"></a><span id="l3.17">                        .getService(Ci.nsIMsgMessageService);</span>
<a href="#l3.18"></a><span id="l3.18"> </span>
<a href="#l3.19"></a><span id="l3.19"> const gFileName = &quot;bug460636&quot;;</span>
<a href="#l3.20"></a><span id="l3.20"> const gMsgFile = do_get_file(&quot;../../../data/&quot; + gFileName);</span>
<a href="#l3.21"></a><span id="l3.21">                      </span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-function run_test()</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-{</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-  /*</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-   * Set up an IMAP server. The bug is only triggered when nsMsgSaveAsListener</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-   * is used (i.e., for IMAP and NNTP).</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-   */</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-  gIMAPDaemon = new imapDaemon();</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-  gServer = makeServer(gIMAPDaemon, &quot;&quot;);</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-  gIMAPIncomingServer = createLocalIMAPServer();</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+var tests = [</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+  setup,</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+  checkSavedMessage,</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+  teardown</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+];</span>
<a href="#l3.36"></a><span id="l3.36"> </span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">-  // pref tuning: one connection only, turn off notifications</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-  var prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-                     .getService(Ci.nsIPrefBranch);</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-  prefBranch.setIntPref(&quot;mail.server.server1.max_cached_connections&quot;, 1);</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-  var inbox = gIMAPDaemon.getMailbox(&quot;INBOX&quot;);</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+function setup() {</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+  setupIMAPPump();</span>
<a href="#l3.49"></a><span id="l3.49"> </span>
<a href="#l3.50"></a><span id="l3.50">   /*</span>
<a href="#l3.51"></a><span id="l3.51">    * Ok, prelude done. Read the original message from disk</span>
<a href="#l3.52"></a><span id="l3.52">    * (through a file URI), and add it to the Inbox.</span>
<a href="#l3.53"></a><span id="l3.53">    */</span>
<a href="#l3.54"></a><span id="l3.54">   var msgfileuri = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l3.55"></a><span id="l3.55">                      .getService(Ci.nsIIOService)</span>
<a href="#l3.56"></a><span id="l3.56">                      .newFileURI(gMsgFile).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l3.57"></a><span id="l3.57"> </span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-  inbox.addMessage(new imapMessage(msgfileuri.spec, inbox.uidnext++, []));</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+  gIMAPMailbox.addMessage(new imapMessage(msgfileuri.spec, gIMAPMailbox.uidnext++, []));</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+  yield false;</span>
<a href="#l3.62"></a><span id="l3.62"> </span>
<a href="#l3.63"></a><span id="l3.63">   /*</span>
<a href="#l3.64"></a><span id="l3.64">    * Save the message to a local file. IMapMD corresponds to</span>
<a href="#l3.65"></a><span id="l3.65">    * &lt;profile_dir&gt;/mailtest/ImapMail (where fakeserver puts the IMAP mailbox</span>
<a href="#l3.66"></a><span id="l3.66">    * files). If we pass the test, we'll remove the file afterwards</span>
<a href="#l3.67"></a><span id="l3.67">    * (cf. UrlListener), otherwise it's kept in IMapMD.</span>
<a href="#l3.68"></a><span id="l3.68">    */</span>
<a href="#l3.69"></a><span id="l3.69">   gSavedMsgFile = Cc[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l3.70"></a><span id="l3.70">                   .getService(Ci.nsIProperties)</span>
<a href="#l3.71"></a><span id="l3.71">                   .get(&quot;IMapMD&quot;, Ci.nsILocalFile);</span>
<a href="#l3.72"></a><span id="l3.72">   gSavedMsgFile.append(gFileName + &quot;.eml&quot;);</span>
<a href="#l3.73"></a><span id="l3.73"> </span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-  do_test_pending();</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-  do_timeout(10000, function(){</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-      do_throw('SaveMessageToDisk did not complete within 10 seconds' +</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-        '(incorrect messageURI?). ABORTING.');</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-      }</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-    );</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineminus">-</span>
<a href="#l3.81"></a><span id="l3.81">   /*</span>
<a href="#l3.82"></a><span id="l3.82">    * From nsIMsgMessageService.idl:</span>
<a href="#l3.83"></a><span id="l3.83">    * void SaveMessageToDisk(in string aMessageURI, in nsIFile aFile,</span>
<a href="#l3.84"></a><span id="l3.84">    *                        in boolean aGenerateDummyEnvelope,</span>
<a href="#l3.85"></a><span id="l3.85">    *                        in nsIUrlListener aUrlListener, out nsIURI aURL,</span>
<a href="#l3.86"></a><span id="l3.86">    *                        in boolean canonicalLineEnding,</span>
<a href="#l3.87"></a><span id="l3.87">    *                        in nsIMsgWindow aMsgWindow);</span>
<a href="#l3.88"></a><span id="l3.88">    * Enforcing canonicalLineEnding (i.e., CRLF) makes sure that the</span>
<a href="#l3.89"></a><span id="l3.89">    * test also runs successfully on platforms not using CRLF by default.</span>
<a href="#l3.90"></a><span id="l3.90">    */</span>
<a href="#l3.91"></a><span id="l3.91">   gIMAPService.SaveMessageToDisk(&quot;imap-message://user@localhost/INBOX#&quot;</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineminus">-                                 + (inbox.uidnext-1), gSavedMsgFile,</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineminus">-                                 false, UrlListener, {}, true, null);</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+                                 + (gIMAPMailbox.uidnext-1), gSavedMsgFile,</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+                                 false, asyncUrlListener, {}, true, null);</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+  yield false;</span>
<a href="#l3.97"></a><span id="l3.97"> }</span>
<a href="#l3.98"></a><span id="l3.98"> </span>
<a href="#l3.99"></a><span id="l3.99" class="difflineminus">-function endTest()</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineminus">-{</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-  gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineminus">-  gServer.stop();</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineminus">-  var thread = gThreadManager.currentThread;</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineminus">-  while (thread.hasPendingEvents())</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineminus">-    thread.processNextEvent(true);</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+function checkSavedMessage() {</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+  do_check_eq(loadFileToString(gMsgFile), loadFileToString(gSavedMsgFile));</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+}</span>
<a href="#l3.109"></a><span id="l3.109"> </span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+function teardown() {</span>
<a href="#l3.111"></a><span id="l3.111">   try {</span>
<a href="#l3.112"></a><span id="l3.112">     gSavedMsgFile.remove(false);</span>
<a href="#l3.113"></a><span id="l3.113">   }</span>
<a href="#l3.114"></a><span id="l3.114">   catch (ex) {</span>
<a href="#l3.115"></a><span id="l3.115">     dump(ex);</span>
<a href="#l3.116"></a><span id="l3.116">     do_throw(ex);</span>
<a href="#l3.117"></a><span id="l3.117">   }</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineminus">-  do_test_finished();</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+  teardownIMAPPump();</span>
<a href="#l3.120"></a><span id="l3.120"> }</span>
<a href="#l3.121"></a><span id="l3.121"> </span>
<a href="#l3.122"></a><span id="l3.122" class="difflineminus">-var UrlListener = </span>
<a href="#l3.123"></a><span id="l3.123" class="difflineminus">-{</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineminus">-  OnStartRunningUrl: function(url) { },</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineminus">-  OnStopRunningUrl: function(url, rc)</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineminus">-  {</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineminus">-    do_check_eq(loadFileToString(gMsgFile), loadFileToString(gSavedMsgFile));</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineminus">-    // The file doesn't get closed straight away, but does after a little bit.</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineminus">-    // So wait, and then remove it. We need to test this to ensure we don't</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineminus">-    // indefinitely lock the file.</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineminus">-    do_timeout(1000, endTest);</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineminus">-  }</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineminus">-};</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+function run_test() {</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+  async_run_tests(tests);</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_compactOfflineStore.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_compactOfflineStore.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -2,28 +2,28 @@</span>
<a href="#l4.4"></a><span id="l4.4"> /*</span>
<a href="#l4.5"></a><span id="l4.5">  * Test to ensure that compacting offline stores works correctly with imap folders</span>
<a href="#l4.6"></a><span id="l4.6">  * and returns success.</span>
<a href="#l4.7"></a><span id="l4.7">  */</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;,</span>
<a href="#l4.10"></a><span id="l4.10">                            &quot;@mozilla.org/msgstore/berkeleystore;1&quot;);</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l4.15"></a><span id="l4.15"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-</span>
<a href="#l4.23"></a><span id="l4.23"> // Globals</span>
<a href="#l4.24"></a><span id="l4.24"> var gRootFolder;</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineminus">-var gIMAPInbox, gIMAPTrashFolder, gMsgImapInboxFolder;</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-var gIMAPDaemon, gServer, gIMAPIncomingServer;</span>
<a href="#l4.27"></a><span id="l4.27"> var gImapInboxOfflineStoreSize;</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-var gCurTestNum;</span>
<a href="#l4.29"></a><span id="l4.29"> </span>
<a href="#l4.30"></a><span id="l4.30"> const gMsgFile1 = do_get_file(&quot;../../../data/bugmail10&quot;);</span>
<a href="#l4.31"></a><span id="l4.31"> const gMsgFile2 = do_get_file(&quot;../../../data/bugmail11&quot;);</span>
<a href="#l4.32"></a><span id="l4.32"> const gMsgFile3 = do_get_file(&quot;../../../data/draft1&quot;);</span>
<a href="#l4.33"></a><span id="l4.33"> const gMsgFile4 = do_get_file(&quot;../../../data/bugmail7&quot;);</span>
<a href="#l4.34"></a><span id="l4.34"> const gMsgFile5 = do_get_file(&quot;../../../data/bugmail6&quot;);</span>
<a href="#l4.35"></a><span id="l4.35"> </span>
<a href="#l4.36"></a><span id="l4.36"> // Copied straight from the example files</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineat">@@ -84,225 +84,133 @@ function checkOfflineStore(prevOfflineSt</span>
<a href="#l4.38"></a><span id="l4.38">         gIMAPInbox.getOfflineFileStream(header.messageKey, offset, size).close();</span>
<a href="#l4.39"></a><span id="l4.39">     }</span>
<a href="#l4.40"></a><span id="l4.40">   }</span>
<a href="#l4.41"></a><span id="l4.41">   // check that the offline store shrunk by at least 100 bytes.</span>
<a href="#l4.42"></a><span id="l4.42">   // (exact calculation might be fragile).</span>
<a href="#l4.43"></a><span id="l4.43">   do_check_true(prevOfflineStoreSize &gt; gIMAPInbox.filePath.fileSize + 100);</span>
<a href="#l4.44"></a><span id="l4.44"> }</span>
<a href="#l4.45"></a><span id="l4.45"> </span>
<a href="#l4.46"></a><span id="l4.46" class="difflineminus">-const gTestArray =</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineminus">-[</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+var tests = [</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+  setup,</span>
<a href="#l4.50"></a><span id="l4.50">   function downloadForOffline() {</span>
<a href="#l4.51"></a><span id="l4.51">     // ...and download for offline use.</span>
<a href="#l4.52"></a><span id="l4.52">     dump(&quot;Downloading for offline use\n&quot;);</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineminus">-    gIMAPInbox.downloadAllForOffline(UrlListener, null);</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+    gIMAPInbox.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+    yield false;</span>
<a href="#l4.56"></a><span id="l4.56">   },</span>
<a href="#l4.57"></a><span id="l4.57">   function markOneMsgDeleted() {</span>
<a href="#l4.58"></a><span id="l4.58">     // mark a message deleted, and then do a compact of just</span>
<a href="#l4.59"></a><span id="l4.59">     // that folder.</span>
<a href="#l4.60"></a><span id="l4.60">     let msgHdr = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gMsgId5);</span>
<a href="#l4.61"></a><span id="l4.61">     let array = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l4.62"></a><span id="l4.62">     array.appendElement(msgHdr, false);</span>
<a href="#l4.63"></a><span id="l4.63">     // store the deleted flag</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineminus">-    gIMAPInbox.storeImapFlags(0x0008, true, [msgHdr.messageKey], 1, UrlListener);</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+    gIMAPInbox.storeImapFlags(0x0008, true, [msgHdr.messageKey], 1, asyncUrlListener);</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+    yield false;</span>
<a href="#l4.67"></a><span id="l4.67">   },</span>
<a href="#l4.68"></a><span id="l4.68">   function compactOneFolder() {</span>
<a href="#l4.69"></a><span id="l4.69">     gIMAPIncomingServer.deleteModel = Ci.nsMsgImapDeleteModels.IMAPDelete;</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineminus">-    // UrlListener will get called when both expunge and offline store</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+    // asyncUrlListener will get called when both expunge and offline store</span>
<a href="#l4.72"></a><span id="l4.72">     // compaction are finished. dummyMsgWindow is required to make the backend</span>
<a href="#l4.73"></a><span id="l4.73">     // compact the offline store.</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineminus">-    gIMAPInbox.compact(UrlListener, gDummyMsgWindow);</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+    gIMAPInbox.compact(asyncUrlListener, gDummyMsgWindow);</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+    yield false;</span>
<a href="#l4.77"></a><span id="l4.77">   },</span>
<a href="#l4.78"></a><span id="l4.78">   function deleteOneMessage() {</span>
<a href="#l4.79"></a><span id="l4.79">     // check that nstmp file has been cleaned up.</span>
<a href="#l4.80"></a><span id="l4.80">     let tmpFile = gRootFolder.filePath;</span>
<a href="#l4.81"></a><span id="l4.81">     tmpFile.append(&quot;nstmp&quot;);</span>
<a href="#l4.82"></a><span id="l4.82">     do_check_false(tmpFile.exists());</span>
<a href="#l4.83"></a><span id="l4.83">     dump(&quot;deleting one message\n&quot;);</span>
<a href="#l4.84"></a><span id="l4.84">     gIMAPIncomingServer.deleteModel = Ci.nsMsgImapDeleteModels.MoveToTrash;</span>
<a href="#l4.85"></a><span id="l4.85">     let msgHdr = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l4.86"></a><span id="l4.86">     let array = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l4.87"></a><span id="l4.87">     array.appendElement(msgHdr, false);</span>
<a href="#l4.88"></a><span id="l4.88">     gIMAPInbox.deleteMessages(array, null, false, true, CopyListener, false);</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineminus">-    gIMAPTrashFolder = gRootFolder.getChildNamed(&quot;Trash&quot;);</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+    let trashFolder = gRootFolder.getChildNamed(&quot;Trash&quot;);</span>
<a href="#l4.91"></a><span id="l4.91">     // hack to force uid validity to get initialized for trash.</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineminus">-    gIMAPTrashFolder.updateFolder(null);</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+    trashFolder.updateFolder(null);</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+    yield false;</span>
<a href="#l4.95"></a><span id="l4.95">   },</span>
<a href="#l4.96"></a><span id="l4.96">   function compactOfflineStore() {</span>
<a href="#l4.97"></a><span id="l4.97">     dump(&quot;compacting offline store\n&quot;);</span>
<a href="#l4.98"></a><span id="l4.98">     gImapInboxOfflineStoreSize = gIMAPInbox.filePath.fileSize;</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineminus">-    gRootFolder.compactAll(UrlListener, null, true);</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+    gRootFolder.compactAll(asyncUrlListener, null, true);</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+    yield false;</span>
<a href="#l4.102"></a><span id="l4.102">   },</span>
<a href="#l4.103"></a><span id="l4.103">   function checkCompactionResult() {</span>
<a href="#l4.104"></a><span id="l4.104">     checkOfflineStore(gImapInboxOfflineStoreSize);</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineminus">-    UrlListener.OnStopRunningUrl(null, 0);</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+    asyncUrlListener.OnStopRunningUrl(null, 0);</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+    yield false;</span>
<a href="#l4.108"></a><span id="l4.108">   },</span>
<a href="#l4.109"></a><span id="l4.109">   function testPendingRemoval() {</span>
<a href="#l4.110"></a><span id="l4.110">     let msgHdr = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gMsgId2);</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineminus">-    gMsgImapInboxFolder.markPendingRemoval(msgHdr, true);</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+    gIMAPInbox.markPendingRemoval(msgHdr, true);</span>
<a href="#l4.113"></a><span id="l4.113">     gImapInboxOfflineStoreSize = gIMAPInbox.filePath.fileSize;</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineminus">-    gRootFolder.compactAll(UrlListener, null, true);</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+    gRootFolder.compactAll(asyncUrlListener, null, true);</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+    yield false;</span>
<a href="#l4.117"></a><span id="l4.117">   },</span>
<a href="#l4.118"></a><span id="l4.118">   function checkCompactionResult() {</span>
<a href="#l4.119"></a><span id="l4.119">     let tmpFile = gRootFolder.filePath;</span>
<a href="#l4.120"></a><span id="l4.120">     tmpFile.append(&quot;nstmp&quot;);</span>
<a href="#l4.121"></a><span id="l4.121">     do_check_false(tmpFile.exists());</span>
<a href="#l4.122"></a><span id="l4.122">     checkOfflineStore(gImapInboxOfflineStoreSize);</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineminus">-    UrlListener.OnStopRunningUrl(null, 0);</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+    asyncUrlListener.OnStopRunningUrl(null, 0);</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+    yield false;</span>
<a href="#l4.126"></a><span id="l4.126">     let msgHdr = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gMsgId2);</span>
<a href="#l4.127"></a><span id="l4.127">     do_check_eq(msgHdr.flags &amp; Ci.nsMsgMessageFlags.Offline, 0);</span>
<a href="#l4.128"></a><span id="l4.128">   },</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+  teardown</span>
<a href="#l4.130"></a><span id="l4.130"> ];</span>
<a href="#l4.131"></a><span id="l4.131"> </span>
<a href="#l4.132"></a><span id="l4.132" class="difflineminus">-function run_test()</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineminus">-{</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineminus">-  // Add a listener.</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineminus">-  gIMAPDaemon = new imapDaemon();</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineminus">-  gServer = makeServer(gIMAPDaemon, &quot;&quot;);</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineminus">-</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineminus">-  gIMAPIncomingServer = createLocalIMAPServer();</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineminus">-</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineminus">-  loadLocalMailAccount();</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineminus">-</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineminus">-  // We need an identity so that updateFolder doesn't fail</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineminus">-  let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineminus">-                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineminus">-  let localAccount = acctMgr.createAccount();</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineminus">-  let identity = acctMgr.createIdentity();</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineminus">-  localAccount.addIdentity(identity);</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineminus">-  localAccount.defaultIdentity = identity;</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineminus">-  localAccount.incomingServer = gLocalIncomingServer;</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineminus">-  acctMgr.defaultAccount = localAccount;</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineminus">-</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineminus">-  // Let's also have another account, using the same identity</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineminus">-  let imapAccount = acctMgr.createAccount();</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineminus">-  imapAccount.addIdentity(identity);</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineminus">-  imapAccount.defaultIdentity = identity;</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineminus">-  imapAccount.incomingServer = gIMAPIncomingServer;</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineminus">-</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineminus">-  // The server doesn't support more than one connection</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineminus">-  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineminus">-                     .getService(Ci.nsIPrefBranch);</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineminus">-  prefBranch.setIntPref(&quot;mail.server.server1.max_cached_connections&quot;, 1);</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineminus">-  // Make sure no biff notifications happen</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineminus">-  // We aren't interested in downloading messages automatically</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.server.server1.download_on_biff&quot;, false);</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineminus">-</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineminus">-  // Get the server list...</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineminus">-  gIMAPIncomingServer.performExpand(null);</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineplus">+function setup() {</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineplus">+  setupIMAPPump();</span>
<a href="#l4.174"></a><span id="l4.174"> </span>
<a href="#l4.175"></a><span id="l4.175">   gRootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineminus">-  gIMAPInbox = gRootFolder.getChildNamed(&quot;INBOX&quot;);</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineminus">-  gMsgImapInboxFolder = gIMAPInbox.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l4.178"></a><span id="l4.178">   // these hacks are required because we've created the inbox before</span>
<a href="#l4.179"></a><span id="l4.179">   // running initial folder discovery, and adding the folder bails</span>
<a href="#l4.180"></a><span id="l4.180">   // out before we set it as verified online, so we bail out, and</span>
<a href="#l4.181"></a><span id="l4.181">   // then remove the INBOX folder since it's not verified.</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineminus">-  gMsgImapInboxFolder.hierarchyDelimiter = '/';</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineminus">-  gMsgImapInboxFolder.verifiedAsOnlineFolder = true;</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineplus">+  gIMAPInbox.hierarchyDelimiter = '/';</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineplus">+  gIMAPInbox.verifiedAsOnlineFolder = true;</span>
<a href="#l4.186"></a><span id="l4.186"> </span>
<a href="#l4.187"></a><span id="l4.187">   let messageGenerator = new MessageGenerator();</span>
<a href="#l4.188"></a><span id="l4.188">   let messages = [];</span>
<a href="#l4.189"></a><span id="l4.189">   for (let i = 0; i &lt; 50; i++)</span>
<a href="#l4.190"></a><span id="l4.190">     messages = messages.concat(messageGenerator.makeMessage());</span>
<a href="#l4.191"></a><span id="l4.191"> </span>
<a href="#l4.192"></a><span id="l4.192">   addGeneratedMessagesToServer(messages, gIMAPDaemon.getMailbox(&quot;INBOX&quot;));</span>
<a href="#l4.193"></a><span id="l4.193"> </span>
<a href="#l4.194"></a><span id="l4.194">   // Add a couple of messages to the INBOX</span>
<a href="#l4.195"></a><span id="l4.195">   // this is synchronous, afaik</span>
<a href="#l4.196"></a><span id="l4.196">   addMessagesToServer([{file: gMsgFile1, messageId: gMsgId1},</span>
<a href="#l4.197"></a><span id="l4.197">                         {file: gMsgFile4, messageId: gMsgId4},</span>
<a href="#l4.198"></a><span id="l4.198">                         {file: gMsgFile2, messageId: gMsgId2},</span>
<a href="#l4.199"></a><span id="l4.199">                         {file: gMsgFile5, messageId: gMsgId5}],</span>
<a href="#l4.200"></a><span id="l4.200">                         gIMAPDaemon.getMailbox(&quot;INBOX&quot;), gIMAPInbox);</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineminus">-  // &quot;Master&quot; do_test_pending(), paired with a do_test_finished() at the end of</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineminus">-  // all the operations.</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineminus">-  do_test_pending();</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineminus">-  //start first test</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineminus">-  doTest(1);</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineminus">-}</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineminus">-</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineminus">-function doTest(test)</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineminus">-{</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineminus">-  if (test &lt;= gTestArray.length)</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineminus">-  {</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineminus">-    dump(&quot;Doing test &quot; + test + &quot;\n&quot;);</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineminus">-    gCurTestNum = test;</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineminus">-</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineminus">-    var testFn = gTestArray[test-1];</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineminus">-    // Set a limit of 10 seconds; if the notifications haven't arrived by then there's a problem.</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineminus">-    do_timeout(10000, function(){</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineminus">-        if (gCurTestNum == test) </span>
<a href="#l4.219"></a><span id="l4.219" class="difflineminus">-          do_throw(&quot;Notifications not received in 10000 ms for operation &quot; + testFn.name);</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineminus">-        }</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineminus">-      );</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineminus">-    try {</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineminus">-    testFn();</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineminus">-    } catch(ex) {do_throw(ex);}</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineminus">-  }</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineminus">-  else</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineminus">-  {</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineminus">-    // Cleanup, null out everything, close all cached connections and stop the</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineminus">-    // server</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineminus">-    gRootFolder = null;</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineminus">-    gIMAPInbox = null;</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineminus">-    gMsgImapInboxFolder = null;</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineminus">-    gIMAPTrashFolder = null;</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineminus">-    do_timeout_function(1000, endTest);</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineminus">-  }</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineminus">-}</span>
<a href="#l4.237"></a><span id="l4.237" class="difflineminus">-</span>
<a href="#l4.238"></a><span id="l4.238" class="difflineminus">-function endTest()</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineminus">-{</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineminus">-  gServer.resetTest();</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineminus">-  gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineminus">-  gServer.performTest();</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineminus">-  gServer.stop();</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineminus">-  let thread = gThreadManager.currentThread;</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineminus">-  while (thread.hasPendingEvents())</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineminus">-    thread.processNextEvent(true);</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineminus">-</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineminus">-  do_test_finished(); // for the one in run_test()</span>
<a href="#l4.249"></a><span id="l4.249"> }</span>
<a href="#l4.250"></a><span id="l4.250"> </span>
<a href="#l4.251"></a><span id="l4.251"> // nsIMsgCopyServiceListener implementation - runs next test when copy</span>
<a href="#l4.252"></a><span id="l4.252"> // is completed.</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineminus">-var CopyListener = </span>
<a href="#l4.254"></a><span id="l4.254" class="difflineminus">-{</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineplus">+var CopyListener = {</span>
<a href="#l4.256"></a><span id="l4.256">   OnStartCopy: function() {},</span>
<a href="#l4.257"></a><span id="l4.257">   OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineminus">-  SetMessageKey: function(aKey)</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineminus">-  {</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineplus">+  SetMessageKey: function(aKey) {</span>
<a href="#l4.261"></a><span id="l4.261">     let hdr = gLocalInboxFolder.GetMessageHeader(aKey);</span>
<a href="#l4.262"></a><span id="l4.262">     gMsgHdrs.push({hdr: hdr, ID: hdr.messageId});</span>
<a href="#l4.263"></a><span id="l4.263">   },</span>
<a href="#l4.264"></a><span id="l4.264">   SetMessageId: function(aMessageId) {},</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineminus">-  OnStopCopy: function(aStatus)</span>
<a href="#l4.266"></a><span id="l4.266" class="difflineminus">-  {</span>
<a href="#l4.267"></a><span id="l4.267" class="difflineplus">+  OnStopCopy: function(aStatus) {</span>
<a href="#l4.268"></a><span id="l4.268">     // Check: message successfully copied.</span>
<a href="#l4.269"></a><span id="l4.269">     do_check_eq(aStatus, 0);</span>
<a href="#l4.270"></a><span id="l4.270" class="difflineminus">-    // Ugly hack: make sure we don't get stuck in a JS-&gt;C++-&gt;JS-&gt;C++... call stack</span>
<a href="#l4.271"></a><span id="l4.271" class="difflineminus">-    // This can happen with a bunch of synchronous functions grouped together, and</span>
<a href="#l4.272"></a><span id="l4.272" class="difflineminus">-    // can even cause tests to fail because they're still waiting for the listener</span>
<a href="#l4.273"></a><span id="l4.273" class="difflineminus">-    // to return</span>
<a href="#l4.274"></a><span id="l4.274" class="difflineminus">-    do_timeout(0, function(){doTest(++gCurTestNum)});</span>
<a href="#l4.275"></a><span id="l4.275" class="difflineplus">+    async_driver();</span>
<a href="#l4.276"></a><span id="l4.276">   }</span>
<a href="#l4.277"></a><span id="l4.277"> };</span>
<a href="#l4.278"></a><span id="l4.278"> </span>
<a href="#l4.279"></a><span id="l4.279" class="difflineminus">-var UrlListener = </span>
<a href="#l4.280"></a><span id="l4.280" class="difflineminus">-{</span>
<a href="#l4.281"></a><span id="l4.281" class="difflineminus">-  OnStartRunningUrl: function(url) { },</span>
<a href="#l4.282"></a><span id="l4.282" class="difflineplus">+function teardown() {</span>
<a href="#l4.283"></a><span id="l4.283" class="difflineplus">+  gRootFolder = null;</span>
<a href="#l4.284"></a><span id="l4.284" class="difflineplus">+  teardownIMAPPump();</span>
<a href="#l4.285"></a><span id="l4.285" class="difflineplus">+}</span>
<a href="#l4.286"></a><span id="l4.286"> </span>
<a href="#l4.287"></a><span id="l4.287" class="difflineminus">-  OnStopRunningUrl: function (aUrl, aExitCode) {</span>
<a href="#l4.288"></a><span id="l4.288" class="difflineminus">-    // Check: message successfully copied.</span>
<a href="#l4.289"></a><span id="l4.289" class="difflineminus">-    do_check_eq(aExitCode, 0);</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineminus">-    // Ugly hack: make sure we don't get stuck in a JS-&gt;C++-&gt;JS-&gt;C++... call stack</span>
<a href="#l4.291"></a><span id="l4.291" class="difflineminus">-    // This can happen with a bunch of synchronous functions grouped together, and</span>
<a href="#l4.292"></a><span id="l4.292" class="difflineminus">-    // can even cause tests to fail because they're still waiting for the listener</span>
<a href="#l4.293"></a><span id="l4.293" class="difflineminus">-    // to return</span>
<a href="#l4.294"></a><span id="l4.294" class="difflineminus">-    do_timeout(0, function(){doTest(++gCurTestNum)});</span>
<a href="#l4.295"></a><span id="l4.295" class="difflineminus">-  }</span>
<a href="#l4.296"></a><span id="l4.296" class="difflineminus">-};</span>
<a href="#l4.297"></a><span id="l4.297" class="difflineplus">+function run_test() {</span>
<a href="#l4.298"></a><span id="l4.298" class="difflineplus">+  async_run_tests(tests);</span>
<a href="#l4.299"></a><span id="l4.299" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_copyThenMove.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_copyThenMove.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,235 +1,155 @@</span>
<a href="#l5.4"></a><span id="l5.4"> // This file extends test_imapFolderCopy.js to test message</span>
<a href="#l5.5"></a><span id="l5.5"> // moves from a local folder to an IMAP folder.</span>
<a href="#l5.6"></a><span id="l5.6"> //</span>
<a href="#l5.7"></a><span id="l5.7"> // Original Author: Kent James &lt;kent@caspia.com&gt;</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10" class="difflineminus">-var gRootFolder;</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineminus">-var gIMAPInbox, gIMAPTrashFolder;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+</span>
<a href="#l5.18"></a><span id="l5.18"> var gEmptyLocal1, gEmptyLocal2;</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-var gIMAPDaemon, gServer, gIMAPIncomingServer;</span>
<a href="#l5.20"></a><span id="l5.20"> var gLastKey;</span>
<a href="#l5.21"></a><span id="l5.21"> var gMessages = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l5.22"></a><span id="l5.22"> var gCopyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l5.23"></a><span id="l5.23">                 .getService(Ci.nsIMsgCopyService);</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-var gCurTestNum;</span>
<a href="#l5.25"></a><span id="l5.25"> </span>
<a href="#l5.26"></a><span id="l5.26"> Components.utils.import(&quot;resource:///modules/folderUtils.jsm&quot;);</span>
<a href="#l5.27"></a><span id="l5.27"> Components.utils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l5.28"></a><span id="l5.28"> </span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">-const gTestArray =</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-[</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+var tests = [</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+  setup,</span>
<a href="#l5.33"></a><span id="l5.33">   function copyFolder1() {</span>
<a href="#l5.34"></a><span id="l5.34">     dump(&quot;gEmpty1 &quot; + gEmptyLocal1.URI + &quot;\n&quot;);</span>
<a href="#l5.35"></a><span id="l5.35">     let folders = new Array;</span>
<a href="#l5.36"></a><span id="l5.36">     folders.push(gEmptyLocal1.QueryInterface(Ci.nsIMsgFolder));</span>
<a href="#l5.37"></a><span id="l5.37">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l5.38"></a><span id="l5.38">     gCopyService.CopyFolders(array, gIMAPInbox, false, CopyListener, null);</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+    yield false;</span>
<a href="#l5.40"></a><span id="l5.40">   },</span>
<a href="#l5.41"></a><span id="l5.41">   function copyFolder2() {</span>
<a href="#l5.42"></a><span id="l5.42">     dump(&quot;gEmpty2 &quot; + gEmptyLocal2.URI + &quot;\n&quot;);</span>
<a href="#l5.43"></a><span id="l5.43">     let folders = new Array;</span>
<a href="#l5.44"></a><span id="l5.44">     folders.push(gEmptyLocal2);</span>
<a href="#l5.45"></a><span id="l5.45">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l5.46"></a><span id="l5.46">     gCopyService.CopyFolders(array, gIMAPInbox, false, CopyListener, null);</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+    yield false;</span>
<a href="#l5.48"></a><span id="l5.48">   },</span>
<a href="#l5.49"></a><span id="l5.49">   function getLocalMessage1() {</span>
<a href="#l5.50"></a><span id="l5.50">     dump(&quot;getLocalMessage\n&quot;);</span>
<a href="#l5.51"></a><span id="l5.51">     var file = do_get_file(&quot;../../../data/bugmail1&quot;);</span>
<a href="#l5.52"></a><span id="l5.52">     gCopyService.CopyFileMessage(file, gLocalInboxFolder, null, false, 0,</span>
<a href="#l5.53"></a><span id="l5.53">                                 &quot;&quot;, CopyListener, null);</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+    yield false;</span>
<a href="#l5.55"></a><span id="l5.55">   },</span>
<a href="#l5.56"></a><span id="l5.56">   function getLocalMessage2() {</span>
<a href="#l5.57"></a><span id="l5.57">     gMessages.appendElement(gLocalInboxFolder.GetMessageHeader(gLastKey), false);</span>
<a href="#l5.58"></a><span id="l5.58">     dump(&quot;getLocalMessage\n&quot;);</span>
<a href="#l5.59"></a><span id="l5.59">     var file = do_get_file(&quot;../../../data/draft1&quot;);</span>
<a href="#l5.60"></a><span id="l5.60">     gCopyService.CopyFileMessage(file, gLocalInboxFolder, null, false, 0,</span>
<a href="#l5.61"></a><span id="l5.61">                                 &quot;&quot;, CopyListener, null);</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+    yield false;</span>
<a href="#l5.63"></a><span id="l5.63">   },</span>
<a href="#l5.64"></a><span id="l5.64">   function copyMessages() {</span>
<a href="#l5.65"></a><span id="l5.65">     gMessages.appendElement(gLocalInboxFolder.GetMessageHeader(gLastKey), false);</span>
<a href="#l5.66"></a><span id="l5.66">     let folder1 = gIMAPInbox.getChildNamed(&quot;empty 1&quot;);</span>
<a href="#l5.67"></a><span id="l5.67">     gCopyService.CopyMessages(gLocalInboxFolder, gMessages, folder1, false, CopyListener, null, false);</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+    yield false;</span>
<a href="#l5.69"></a><span id="l5.69">   },</span>
<a href="#l5.70"></a><span id="l5.70">   function moveMessages() {</span>
<a href="#l5.71"></a><span id="l5.71">     let folder2 = gIMAPInbox.getChildNamed(&quot;empty 2&quot;);</span>
<a href="#l5.72"></a><span id="l5.72">     gCopyService.CopyMessages(gLocalInboxFolder, gMessages, folder2, true, CopyListener, null, false);</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+    yield false;</span>
<a href="#l5.74"></a><span id="l5.74">   },</span>
<a href="#l5.75"></a><span id="l5.75">   function update1() {</span>
<a href="#l5.76"></a><span id="l5.76">     let folder1 = gIMAPInbox.getChildNamed(&quot;empty 1&quot;).QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineminus">-    folder1.updateFolderWithListener(null, URLListener);</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+    folder1.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+    yield false;</span>
<a href="#l5.80"></a><span id="l5.80">   },</span>
<a href="#l5.81"></a><span id="l5.81">   function update2() {</span>
<a href="#l5.82"></a><span id="l5.82">     let folder2 = gIMAPInbox.getChildNamed(&quot;empty 2&quot;).QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineminus">-    folder2.updateFolderWithListener(null, URLListener);</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+    folder2.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+    yield false;</span>
<a href="#l5.86"></a><span id="l5.86">   },</span>
<a href="#l5.87"></a><span id="l5.87">   function verifyFolders() {</span>
<a href="#l5.88"></a><span id="l5.88">     let folder1 = gIMAPInbox.getChildNamed(&quot;empty 1&quot;);</span>
<a href="#l5.89"></a><span id="l5.89">     do_check_eq(folderCount(folder1), 2);</span>
<a href="#l5.90"></a><span id="l5.90">     let folder2 = gIMAPInbox.getChildNamed(&quot;empty 2&quot;);</span>
<a href="#l5.91"></a><span id="l5.91">     do_check_neq(folder2, null);</span>
<a href="#l5.92"></a><span id="l5.92">     // folder 1 and 2 should each now have two messages in them.</span>
<a href="#l5.93"></a><span id="l5.93">     do_check_neq(folder1, null);</span>
<a href="#l5.94"></a><span id="l5.94">     do_check_eq(folderCount(folder2), 2);</span>
<a href="#l5.95"></a><span id="l5.95">     // The local inbox folder should now be empty, since the second</span>
<a href="#l5.96"></a><span id="l5.96">     // operation was a move.</span>
<a href="#l5.97"></a><span id="l5.97">     do_check_eq(folderCount(gLocalInboxFolder), 0);</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineminus">-    doTest(++gCurTestNum);</span>
<a href="#l5.99"></a><span id="l5.99">   },</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+  teardown</span>
<a href="#l5.101"></a><span id="l5.101"> ];</span>
<a href="#l5.102"></a><span id="l5.102"> </span>
<a href="#l5.103"></a><span id="l5.103"> function folderCount(folder)</span>
<a href="#l5.104"></a><span id="l5.104"> {</span>
<a href="#l5.105"></a><span id="l5.105">   let enumerator = folder.msgDatabase.EnumerateMessages();</span>
<a href="#l5.106"></a><span id="l5.106">   let count = 0;</span>
<a href="#l5.107"></a><span id="l5.107">   while (enumerator.hasMoreElements())</span>
<a href="#l5.108"></a><span id="l5.108">   {</span>
<a href="#l5.109"></a><span id="l5.109">     count++;</span>
<a href="#l5.110"></a><span id="l5.110">     let hdr = enumerator.getNext();</span>
<a href="#l5.111"></a><span id="l5.111">   }</span>
<a href="#l5.112"></a><span id="l5.112">   return count;</span>
<a href="#l5.113"></a><span id="l5.113"> }</span>
<a href="#l5.114"></a><span id="l5.114"> </span>
<a href="#l5.115"></a><span id="l5.115" class="difflineminus">-function run_test()</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineminus">-{</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineminus">-  // Add a listener.</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineminus">-  gIMAPDaemon = new imapDaemon();</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineminus">-  gServer = makeServer(gIMAPDaemon, &quot;&quot;);</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineminus">-</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineminus">-  gIMAPIncomingServer = createLocalIMAPServer();</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineminus">-</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineminus">-  loadLocalMailAccount();</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineplus">+function setup() {</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+  // Turn off autosync_offline_stores because</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+  // fetching messages is invoked after copying the messages.</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineplus">+  // (i.e. The fetching process will be invoked after OnStopCopy)</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+  // It will cause crash with an assertion</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineplus">+  // (ASSERTION: tried to add duplicate listener: 'index == -1') on teardown.</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l5.131"></a><span id="l5.131"> </span>
<a href="#l5.132"></a><span id="l5.132" class="difflineminus">-  // We need an identity so that updateFolder doesn't fail</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineminus">-  let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineminus">-                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineminus">-  let localAccount = acctMgr.createAccount();</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineminus">-  let identity = acctMgr.createIdentity();</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineminus">-  localAccount.addIdentity(identity);</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineminus">-  localAccount.defaultIdentity = identity;</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineminus">-  localAccount.incomingServer = gLocalIncomingServer;</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineminus">-  acctMgr.defaultAccount = localAccount;</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineminus">-</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineminus">-  // Let's also have another account, using the same identity</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineminus">-  let imapAccount = acctMgr.createAccount();</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineminus">-  imapAccount.addIdentity(identity);</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineminus">-  imapAccount.defaultIdentity = identity;</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineminus">-  imapAccount.incomingServer = gIMAPIncomingServer;</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineminus">-</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineminus">-  // The server doesn't support more than one connection</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineminus">-  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineminus">-                     .getService(Ci.nsIPrefBranch);</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineminus">-  prefBranch.setIntPref(&quot;mail.server.server1.max_cached_connections&quot;, 1);</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineminus">-  // Make sure no biff notifications happen</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineminus">-  // We aren't interested in downloading messages automatically</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.server.server1.download_on_biff&quot;, false);</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineplus">+  setupIMAPPump();</span>
<a href="#l5.160"></a><span id="l5.160"> </span>
<a href="#l5.161"></a><span id="l5.161">   gEmptyLocal1 = gLocalIncomingServer.rootFolder.createLocalSubfolder(&quot;empty 1&quot;);</span>
<a href="#l5.162"></a><span id="l5.162">   gEmptyLocal2 = gLocalIncomingServer.rootFolder.createLocalSubfolder(&quot;empty 2&quot;);</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineminus">-  // Get the server list...</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineminus">-  gIMAPIncomingServer.performExpand(null);</span>
<a href="#l5.165"></a><span id="l5.165"> </span>
<a href="#l5.166"></a><span id="l5.166" class="difflineminus">-  gRootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineminus">-  gIMAPInbox = gRootFolder.getChildNamed(&quot;INBOX&quot;);</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineminus">-  dump(&quot;gIMAPInbox uri = &quot; + gIMAPInbox.URI + &quot;\n&quot;);</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineminus">-  let msgImapFolder = gIMAPInbox.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l5.170"></a><span id="l5.170">   // these hacks are required because we've created the inbox before</span>
<a href="#l5.171"></a><span id="l5.171">   // running initial folder discovery, and adding the folder bails</span>
<a href="#l5.172"></a><span id="l5.172">   // out before we set it as verified online, so we bail out, and</span>
<a href="#l5.173"></a><span id="l5.173">   // then remove the INBOX folder since it's not verified.</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineminus">-  msgImapFolder.hierarchyDelimiter = '/';</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineminus">-  msgImapFolder.verifiedAsOnlineFolder = true;</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineminus">-</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineminus">-  // &quot;Master&quot; do_test_pending(), paired with a do_test_finished() at the end of</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineminus">-  // all the operations.</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineminus">-</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineminus">-  do_test_pending();</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineminus">-  //start first test</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineminus">-  doTest(1);</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineminus">-}</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineminus">-</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineminus">-function doTest(test)</span>
<a href="#l5.186"></a><span id="l5.186" class="difflineminus">-{</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineminus">-  if (test &lt;= gTestArray.length)</span>
<a href="#l5.188"></a><span id="l5.188" class="difflineminus">-  {</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineminus">-    dump(&quot;Doing test &quot; + test + &quot;\n&quot;);</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineminus">-    gCurTestNum = test;</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineminus">-</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineminus">-    var testFn = gTestArray[test - 1];</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineminus">-    // Set a limit of ten seconds; if the notifications haven't arrived by then there's a problem.</span>
<a href="#l5.194"></a><span id="l5.194" class="difflineminus">-    do_timeout(10000, function(){</span>
<a href="#l5.195"></a><span id="l5.195" class="difflineminus">-        if (gCurTestNum == test)</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineminus">-          do_throw(&quot;Notifications not received in 10000 ms for operation &quot; + testFn.name);</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineminus">-        }</span>
<a href="#l5.198"></a><span id="l5.198" class="difflineminus">-      );</span>
<a href="#l5.199"></a><span id="l5.199" class="difflineminus">-    try {</span>
<a href="#l5.200"></a><span id="l5.200" class="difflineminus">-    testFn();</span>
<a href="#l5.201"></a><span id="l5.201" class="difflineminus">-    } catch(ex) {</span>
<a href="#l5.202"></a><span id="l5.202" class="difflineminus">-      gServer.stop();</span>
<a href="#l5.203"></a><span id="l5.203" class="difflineminus">-      do_throw ('TEST FAILED ' + ex);</span>
<a href="#l5.204"></a><span id="l5.204" class="difflineminus">-    }</span>
<a href="#l5.205"></a><span id="l5.205" class="difflineminus">-  }</span>
<a href="#l5.206"></a><span id="l5.206" class="difflineminus">-  else</span>
<a href="#l5.207"></a><span id="l5.207" class="difflineminus">-  {</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineminus">-    do_timeout(1000, endTest);</span>
<a href="#l5.209"></a><span id="l5.209" class="difflineminus">-  }</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineplus">+  gIMAPInbox.hierarchyDelimiter = '/';</span>
<a href="#l5.211"></a><span id="l5.211" class="difflineplus">+  gIMAPInbox.verifiedAsOnlineFolder = true;</span>
<a href="#l5.212"></a><span id="l5.212"> }</span>
<a href="#l5.213"></a><span id="l5.213"> </span>
<a href="#l5.214"></a><span id="l5.214"> // nsIMsgCopyServiceListener implementation - runs next test when copy</span>
<a href="#l5.215"></a><span id="l5.215"> // is completed.</span>
<a href="#l5.216"></a><span id="l5.216"> var CopyListener =</span>
<a href="#l5.217"></a><span id="l5.217"> {</span>
<a href="#l5.218"></a><span id="l5.218">   OnStartCopy: function() {},</span>
<a href="#l5.219"></a><span id="l5.219">   OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l5.220"></a><span id="l5.220">   SetMessageKey: function(aKey)</span>
<a href="#l5.221"></a><span id="l5.221">   {</span>
<a href="#l5.222"></a><span id="l5.222">     gLastKey = aKey;</span>
<a href="#l5.223"></a><span id="l5.223">   },</span>
<a href="#l5.224"></a><span id="l5.224">   SetMessageId: function(aMessageId) {},</span>
<a href="#l5.225"></a><span id="l5.225">   OnStopCopy: function(aStatus)</span>
<a href="#l5.226"></a><span id="l5.226">   {</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineminus">-    dump(&quot;in OnStopCopy &quot; + gCurTestNum + &quot;\n&quot;);</span>
<a href="#l5.228"></a><span id="l5.228">     // Check: message successfully copied.</span>
<a href="#l5.229"></a><span id="l5.229">     do_check_eq(aStatus, 0);</span>
<a href="#l5.230"></a><span id="l5.230" class="difflineminus">-    // Ugly hack: make sure we don't get stuck in a JS-&gt;C++-&gt;JS-&gt;C++... call stack</span>
<a href="#l5.231"></a><span id="l5.231" class="difflineminus">-    // This can happen with a bunch of synchronous functions grouped together, and</span>
<a href="#l5.232"></a><span id="l5.232" class="difflineminus">-    // can even cause tests to fail because they're still waiting for the listener</span>
<a href="#l5.233"></a><span id="l5.233" class="difflineminus">-    // to return</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineminus">-    do_timeout(0, function(){doTest(++gCurTestNum);});</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineplus">+    async_driver();</span>
<a href="#l5.236"></a><span id="l5.236">   }</span>
<a href="#l5.237"></a><span id="l5.237"> };</span>
<a href="#l5.238"></a><span id="l5.238"> </span>
<a href="#l5.239"></a><span id="l5.239" class="difflineminus">-// nsIURLListener implementation - runs next test</span>
<a href="#l5.240"></a><span id="l5.240" class="difflineminus">-var URLListener =</span>
<a href="#l5.241"></a><span id="l5.241" class="difflineminus">-{</span>
<a href="#l5.242"></a><span id="l5.242" class="difflineminus">-  OnStartRunningUrl: function(aURL) {},</span>
<a href="#l5.243"></a><span id="l5.243" class="difflineminus">-  OnStopRunningUrl: function(aURL, aStatus)</span>
<a href="#l5.244"></a><span id="l5.244" class="difflineminus">-  {</span>
<a href="#l5.245"></a><span id="l5.245" class="difflineminus">-    dump(&quot;in OnStopRunningURL &quot; + gCurTestNum + &quot;\n&quot;);</span>
<a href="#l5.246"></a><span id="l5.246" class="difflineminus">-    do_check_eq(aStatus, 0);</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineminus">-    do_timeout(0, function(){doTest(++gCurTestNum);});</span>
<a href="#l5.248"></a><span id="l5.248" class="difflineminus">-  }</span>
<a href="#l5.249"></a><span id="l5.249" class="difflineplus">+asyncUrlListener.callback = function(aUrl, aExitCode) {</span>
<a href="#l5.250"></a><span id="l5.250" class="difflineplus">+  do_check_eq(aExitCode, 0);</span>
<a href="#l5.251"></a><span id="l5.251" class="difflineplus">+};</span>
<a href="#l5.252"></a><span id="l5.252" class="difflineplus">+</span>
<a href="#l5.253"></a><span id="l5.253" class="difflineplus">+function teardown() {</span>
<a href="#l5.254"></a><span id="l5.254" class="difflineplus">+  gMessages.clear();</span>
<a href="#l5.255"></a><span id="l5.255" class="difflineplus">+  teardownIMAPPump();</span>
<a href="#l5.256"></a><span id="l5.256"> }</span>
<a href="#l5.257"></a><span id="l5.257"> </span>
<a href="#l5.258"></a><span id="l5.258" class="difflineminus">-function endTest()</span>
<a href="#l5.259"></a><span id="l5.259" class="difflineminus">-{</span>
<a href="#l5.260"></a><span id="l5.260" class="difflineminus">-  // Cleanup, null out everything, close all cached connections and stop the</span>
<a href="#l5.261"></a><span id="l5.261" class="difflineminus">-  // server</span>
<a href="#l5.262"></a><span id="l5.262" class="difflineminus">-  gMessages.clear();</span>
<a href="#l5.263"></a><span id="l5.263" class="difflineminus">-  gRootFolder = null;</span>
<a href="#l5.264"></a><span id="l5.264" class="difflineminus">-  gIMAPInbox = null;</span>
<a href="#l5.265"></a><span id="l5.265" class="difflineminus">-  gIMAPTrashFolder = null;</span>
<a href="#l5.266"></a><span id="l5.266" class="difflineminus">-  gServer.resetTest();</span>
<a href="#l5.267"></a><span id="l5.267" class="difflineminus">-  gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l5.268"></a><span id="l5.268" class="difflineminus">-  gServer.performTest();</span>
<a href="#l5.269"></a><span id="l5.269" class="difflineminus">-  gServer.stop();</span>
<a href="#l5.270"></a><span id="l5.270" class="difflineminus">-  let thread = gThreadManager.currentThread;</span>
<a href="#l5.271"></a><span id="l5.271" class="difflineminus">-  while (thread.hasPendingEvents())</span>
<a href="#l5.272"></a><span id="l5.272" class="difflineminus">-    thread.processNextEvent(true);</span>
<a href="#l5.273"></a><span id="l5.273" class="difflineplus">+function run_test() {</span>
<a href="#l5.274"></a><span id="l5.274" class="difflineplus">+  async_run_tests(tests);</span>
<a href="#l5.275"></a><span id="l5.275" class="difflineplus">+}</span>
<a href="#l5.276"></a><span id="l5.276"> </span>
<a href="#l5.277"></a><span id="l5.277" class="difflineminus">-  do_test_finished(); // for the one in run_test()</span>
<a href="#l5.278"></a><span id="l5.278" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_downloadOffline.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_downloadOffline.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1,120 +1,79 @@</span>
<a href="#l6.4"></a><span id="l6.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l6.5"></a><span id="l6.5"> /*</span>
<a href="#l6.6"></a><span id="l6.6">  * Test to ensure that downloadAllForOffline works correctly with imap folders</span>
<a href="#l6.7"></a><span id="l6.7">  * and returns success.</span>
<a href="#l6.8"></a><span id="l6.8">  */</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10" class="difflineminus">-var gIMAPDaemon, gServer, gIMAPIncomingServer;</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineminus">-</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l6.15"></a><span id="l6.15"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l6.17"></a><span id="l6.17"> </span>
<a href="#l6.18"></a><span id="l6.18"> const gFileName = &quot;bug460636&quot;;</span>
<a href="#l6.19"></a><span id="l6.19"> const gMsgFile = do_get_file(&quot;../../../data/&quot; + gFileName);</span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-var gDownloadedOnce = false;</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">-var gIMAPInbox;</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-function run_test()</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">-{</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">-  loadLocalMailAccount();</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+var tests = [</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+  setup,</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+  downloadAllForOffline,</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+  verifyDownloaded,</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+  teardown</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+];</span>
<a href="#l6.33"></a><span id="l6.33"> </span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-  /*</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-   * Set up an IMAP server.</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-   */</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">-  gIMAPDaemon = new imapDaemon();</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-  gServer = makeServer(gIMAPDaemon, &quot;&quot;);</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">-  gIMAPIncomingServer = createLocalIMAPServer();</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineminus">-  gIMAPIncomingServer.maximumConnectionsNumber = 1;</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">-</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-  // pref tuning: one connection only, turn off notifications</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-                     .getService(Ci.nsIPrefBranch);</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineminus">-</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineminus">-  let inbox = gIMAPDaemon.getMailbox(&quot;INBOX&quot;);</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+function setup() {</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+  setupIMAPPump();</span>
<a href="#l6.53"></a><span id="l6.53"> </span>
<a href="#l6.54"></a><span id="l6.54">   let ioService = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-  .getService(Ci.nsIIOService);</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+                    .getService(Ci.nsIIOService);</span>
<a href="#l6.57"></a><span id="l6.57">  /*</span>
<a href="#l6.58"></a><span id="l6.58">    * Ok, prelude done. Read the original message from disk</span>
<a href="#l6.59"></a><span id="l6.59">    * (through a file URI), and add it to the Inbox.</span>
<a href="#l6.60"></a><span id="l6.60">    */</span>
<a href="#l6.61"></a><span id="l6.61">   let msgfileuri = ioService.newFileURI(gMsgFile).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l6.62"></a><span id="l6.62"> </span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-  inbox.addMessage(new imapMessage(msgfileuri.spec, inbox.uidnext++, []));</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+  gIMAPMailbox.addMessage(new imapMessage(msgfileuri.spec, gIMAPMailbox.uidnext++, []));</span>
<a href="#l6.65"></a><span id="l6.65"> </span>
<a href="#l6.66"></a><span id="l6.66">   let messages = [];</span>
<a href="#l6.67"></a><span id="l6.67">   let gMessageGenerator = new MessageGenerator();</span>
<a href="#l6.68"></a><span id="l6.68">   messages = messages.concat(gMessageGenerator.makeMessage());</span>
<a href="#l6.69"></a><span id="l6.69">   gSynthMessage = messages[0];</span>
<a href="#l6.70"></a><span id="l6.70">   let dataUri = ioService.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l6.71"></a><span id="l6.71">                    btoa(messages[0].toMessageString()),</span>
<a href="#l6.72"></a><span id="l6.72">                    null, null);</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineminus">-  let imapMsg = new imapMessage(dataUri.spec, inbox.uidnext++, []);</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+  let imapMsg = new imapMessage(dataUri.spec, gIMAPMailbox.uidnext++, []);</span>
<a href="#l6.75"></a><span id="l6.75">   imapMsg.setSize(5000);</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineminus">-  inbox.addMessage(imapMsg);</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+  gIMAPMailbox.addMessage(imapMsg);</span>
<a href="#l6.78"></a><span id="l6.78">   </span>
<a href="#l6.79"></a><span id="l6.79" class="difflineminus">-  do_test_pending();</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">-  do_timeout(10000, function(){</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-        do_throw('downloadAllForOffline did not complete within 10 seconds. ABORTING.');</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineminus">-      }</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineminus">-    );</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineplus">+  // ...and download for offline use.</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+  gIMAPInbox.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineplus">+  yield false;</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+}</span>
<a href="#l6.88"></a><span id="l6.88"> </span>
<a href="#l6.89"></a><span id="l6.89" class="difflineminus">-  // Get the IMAP inbox...</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineminus">-  let rootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">-  gIMAPInbox = rootFolder.getFolderWithFlags(Ci.nsMsgFolderFlags.Inbox);</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineminus">-</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineminus">-  // ...and download for offline use.</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineminus">-  gIMAPInbox.downloadAllForOffline(UrlListener, null);</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+function downloadAllForOffline() {</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+  gIMAPInbox.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+  yield false;</span>
<a href="#l6.98"></a><span id="l6.98"> }</span>
<a href="#l6.99"></a><span id="l6.99"> </span>
<a href="#l6.100"></a><span id="l6.100" class="difflineminus">-var UrlListener = </span>
<a href="#l6.101"></a><span id="l6.101" class="difflineminus">-{</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineminus">-  OnStartRunningUrl: function(url) { },</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineminus">-  OnStopRunningUrl: function(url, rc)</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineminus">-  {</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineminus">-    // Check for ok status.</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineminus">-    do_check_eq(rc, 0);</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineplus">+function verifyDownloaded() {</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineplus">+  // verify that the message headers have the offline flag set.</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineplus">+  let msgEnumerator = gIMAPInbox.msgDatabase.EnumerateMessages();</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineplus">+  let offset = {};</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+  let size = {};</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+  while (msgEnumerator.hasMoreElements()) {</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+    let header = msgEnumerator.getNext();</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineplus">+    // Verify that each message has been downloaded and looks OK.</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineplus">+    if (header instanceof Components.interfaces.nsIMsgDBHdr &amp;&amp;</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineplus">+        (header.flags &amp; Ci.nsMsgMessageFlags.Offline))</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineplus">+      gIMAPInbox.getOfflineFileStream(header.messageKey, offset, size).close();</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineplus">+    else</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineplus">+      do_throw(&quot;Message not downloaded for offline use&quot;);</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineplus">+  }</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineplus">+}</span>
<a href="#l6.122"></a><span id="l6.122"> </span>
<a href="#l6.123"></a><span id="l6.123" class="difflineminus">-    if (!gDownloadedOnce) {</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineminus">-      gDownloadedOnce = true;</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineminus">-      gIMAPInbox.downloadAllForOffline(UrlListener, null);</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineminus">-      return;</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineminus">-    }</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineminus">-    else {</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineminus">-      // verify that the message headers have the offline flag set.</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineminus">-      let msgEnumerator = gIMAPInbox.msgDatabase.EnumerateMessages();</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineminus">-      let offset = new Object;</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineminus">-      let size = new Object;</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineminus">-      while (msgEnumerator.hasMoreElements())</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineminus">-      {</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineminus">-        let header = msgEnumerator.getNext();</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineminus">-        // Verify that each message has been downloaded and looks OK.</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineminus">-        if (header instanceof Components.interfaces.nsIMsgDBHdr &amp;&amp;</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineminus">-            (header.flags &amp; Ci.nsMsgMessageFlags.Offline))</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineminus">-          gIMAPInbox.getOfflineFileStream(header.messageKey, offset, size).close();</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineminus">-        else</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineminus">-          do_throw(&quot;Message not downloaded for offline use&quot;);</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineminus">-      }</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineminus">-    }</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineminus">-    do_timeout(1000, endTest);</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineminus">-  },</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineminus">-  finalize: function() {</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineminus">-    do_timeout(0, endTest);</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineminus">-  }</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineminus">-};</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineplus">+function teardown() {</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineplus">+  teardownIMAPPump();</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineplus">+}</span>
<a href="#l6.153"></a><span id="l6.153"> </span>
<a href="#l6.154"></a><span id="l6.154" class="difflineminus">-function endTest()</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineminus">-{</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineminus">-  gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineminus">-  gServer.stop();</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineminus">-</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineminus">-  var thread = gThreadManager.currentThread;</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineminus">-  while (thread.hasPendingEvents())</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineminus">-    thread.processNextEvent(true);</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineminus">-</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineminus">-  do_test_finished();</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineplus">+function run_test() {</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineplus">+  async_run_tests(tests);</span>
<a href="#l6.166"></a><span id="l6.166"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_filterNeedsBody.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_filterNeedsBody.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1,201 +1,91 @@</span>
<a href="#l7.4"></a><span id="l7.4"> /*</span>
<a href="#l7.5"></a><span id="l7.5">  * This file tests the needsBody attribute added to a</span>
<a href="#l7.6"></a><span id="l7.6">  *  custom filter action in bug 555051.</span>
<a href="#l7.7"></a><span id="l7.7">  *</span>
<a href="#l7.8"></a><span id="l7.8">  * Original author: Kent James &lt;kent@caspia.com&gt;</span>
<a href="#l7.9"></a><span id="l7.9">  * adapted from test_imapFilterActions.js</span>
<a href="#l7.10"></a><span id="l7.10">  */</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+</span>
<a href="#l7.17"></a><span id="l7.17"> // Globals</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-var gIMAPDaemon; // the imap fake server daemon</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-var gServer; // the imap fake server</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-var gIMAPIncomingServer; // nsIMsgIncomingServer for the imap server</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-var gIMAPInbox; // imap inbox message folder</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-var gIMAPMailbox; // imap mailbox</span>
<a href="#l7.23"></a><span id="l7.23"> var gFilter; // a message filter with a subject search</span>
<a href="#l7.24"></a><span id="l7.24"> var gAction; // current message action (reused)</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-var gCurTestNum; // the current test number</span>
<a href="#l7.26"></a><span id="l7.26"> const gMessage = &quot;draft1&quot;; // message file used as the test message</span>
<a href="#l7.27"></a><span id="l7.27"> </span>
<a href="#l7.28"></a><span id="l7.28"> // Definition of tests</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-const gTestArray =</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-[</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+var tests = [</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+  setup,</span>
<a href="#l7.34"></a><span id="l7.34">   function NeedsBodyTrue() {</span>
<a href="#l7.35"></a><span id="l7.35">     gAction.type = Ci.nsMsgFilterAction.Custom;</span>
<a href="#l7.36"></a><span id="l7.36">     gAction.customId = 'mailnews@mozilla.org#testOffline';</span>
<a href="#l7.37"></a><span id="l7.37">     actionTestOffline.needsBody = true;</span>
<a href="#l7.38"></a><span id="l7.38">     gAction.strValue = 'true';</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-    setupTest(gFilter, gAction);</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+    runFilterAction(gFilter, gAction);</span>
<a href="#l7.41"></a><span id="l7.41">   },</span>
<a href="#l7.42"></a><span id="l7.42">   function NeedsBodyFalse() {</span>
<a href="#l7.43"></a><span id="l7.43">     gAction.type = Ci.nsMsgFilterAction.Custom;</span>
<a href="#l7.44"></a><span id="l7.44">     gAction.customId = 'mailnews@mozilla.org#testOffline';</span>
<a href="#l7.45"></a><span id="l7.45">     actionTestOffline.needsBody = false;</span>
<a href="#l7.46"></a><span id="l7.46">     gAction.strValue = 'false';</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineminus">-    setupTest(gFilter, gAction);</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+    runFilterAction(gFilter, gAction);</span>
<a href="#l7.49"></a><span id="l7.49">   },</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+  teardown</span>
<a href="#l7.51"></a><span id="l7.51"> ];</span>
<a href="#l7.52"></a><span id="l7.52"> </span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-function run_test()</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-{</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-  // Add a listener.</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineminus">-  gIMAPDaemon = new imapDaemon();</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-  gServer = makeServer(gIMAPDaemon, &quot;&quot;);</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineminus">-  gIMAPIncomingServer = createLocalIMAPServer();</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineminus">-</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineminus">-  if (!gLocalInboxFolder)</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-    loadLocalMailAccount();</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-  // We need an identity so that updateFolder doesn't fail</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineminus">-  let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-  let localAccount = acctMgr.createAccount();</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineminus">-  let identity = acctMgr.createIdentity();</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-  localAccount.addIdentity(identity);</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineminus">-  localAccount.defaultIdentity = identity;</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineminus">-  localAccount.incomingServer = gLocalIncomingServer;</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-  acctMgr.defaultAccount = localAccount;</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+function setup() {</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+  setupIMAPPump();</span>
<a href="#l7.75"></a><span id="l7.75"> </span>
<a href="#l7.76"></a><span id="l7.76" class="difflineminus">-  // Let's also have another account, using the same identity</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineminus">-  let imapAccount = acctMgr.createAccount();</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineminus">-  imapAccount.addIdentity(identity);</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-  imapAccount.defaultIdentity = identity;</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-  imapAccount.incomingServer = gIMAPIncomingServer;</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineminus">-</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-  // The server doesn't support more than one connection</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineminus">-                     .getService(Ci.nsIPrefBranch);</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineminus">-  prefBranch.setIntPref(&quot;mail.server.default.max_cached_connections&quot;, 1);</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineminus">-  // We aren't interested in downloading messages automatically</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.server.default.download_on_biff&quot;, false);</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineminus">-</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineminus">-  gIMAPIncomingServer.performExpand(null);</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineminus">-</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineminus">-  gIMAPInbox = gIMAPIncomingServer.rootFolder.getChildNamed(&quot;INBOX&quot;);</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineminus">-  gIMAPMailbox = gIMAPDaemon.getMailbox(&quot;INBOX&quot;);</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineminus">-  dump(&quot;gIMAPInbox uri = &quot; + gIMAPInbox.URI + &quot;\n&quot;);</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineminus">-  gIMAPInbox instanceof Ci.nsIMsgImapMailFolder;</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineminus">-</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineminus">-// Create a test filter.</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+  // Create a test filter.</span>
<a href="#l7.102"></a><span id="l7.102">   let filterList = gIMAPIncomingServer.getFilterList(null);</span>
<a href="#l7.103"></a><span id="l7.103">   gFilter = filterList.createFilter(&quot;test offline&quot;);</span>
<a href="#l7.104"></a><span id="l7.104">   let searchTerm = gFilter.createTerm();</span>
<a href="#l7.105"></a><span id="l7.105">   searchTerm.matchAll = true;</span>
<a href="#l7.106"></a><span id="l7.106"> </span>
<a href="#l7.107"></a><span id="l7.107">   gFilter.appendTerm(searchTerm);</span>
<a href="#l7.108"></a><span id="l7.108">   gFilter.enabled = true;</span>
<a href="#l7.109"></a><span id="l7.109"> </span>
<a href="#l7.110"></a><span id="l7.110">   // an action that can be modified by tests</span>
<a href="#l7.111"></a><span id="l7.111">   gAction = gFilter.createAction();</span>
<a href="#l7.112"></a><span id="l7.112"> </span>
<a href="#l7.113"></a><span id="l7.113">   // add the custom actions</span>
<a href="#l7.114"></a><span id="l7.114">   var filterService = Cc[&quot;@mozilla.org/messenger/services/filters;1&quot;]</span>
<a href="#l7.115"></a><span id="l7.115">                         .getService(Ci.nsIMsgFilterService);</span>
<a href="#l7.116"></a><span id="l7.116">   filterService.addCustomAction(actionTestOffline);</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineminus">-  // &quot;Master&quot; do_test_pending(), paired with a do_test_finished() at the end of</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineminus">-  // all the operations.</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineminus">-  do_test_pending();</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineminus">-</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineminus">-  //start first test</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineminus">-  gCurTestNum = 1;</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineminus">-  doTest();</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineminus">-}</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineminus">-</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineminus">-/*</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineminus">- * functions used to support test setup and execution</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineminus">- */</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineminus">-</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineminus">-// if the source matches the listener used to continue a test,</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineminus">-// run the test checks, and start the next test.</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineminus">-function testContinue(source)</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineminus">-{</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineminus">-  gCurTestNum++;</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineminus">-  do_timeout(200, doTest);</span>
<a href="#l7.136"></a><span id="l7.136"> }</span>
<a href="#l7.137"></a><span id="l7.137"> </span>
<a href="#l7.138"></a><span id="l7.138"> // basic preparation done for each test</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineminus">-function setupTest(aFilter, aAction)</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineminus">-{</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineplus">+function runFilterAction(aFilter, aAction) {</span>
<a href="#l7.142"></a><span id="l7.142">   let filterList = gIMAPIncomingServer.getFilterList(null);</span>
<a href="#l7.143"></a><span id="l7.143">   while (filterList.filterCount)</span>
<a href="#l7.144"></a><span id="l7.144">     filterList.removeFilterAt(0);</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineminus">-  if (aFilter)</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineminus">-  {</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineplus">+  if (aFilter) {</span>
<a href="#l7.148"></a><span id="l7.148">     aFilter.clearActionList();</span>
<a href="#l7.149"></a><span id="l7.149">     if (aAction) {</span>
<a href="#l7.150"></a><span id="l7.150">       aFilter.appendAction(aAction);</span>
<a href="#l7.151"></a><span id="l7.151">       filterList.insertFilterAt(0, aFilter);</span>
<a href="#l7.152"></a><span id="l7.152">     }</span>
<a href="#l7.153"></a><span id="l7.153">   }</span>
<a href="#l7.154"></a><span id="l7.154">   gIMAPMailbox.addMessage(new imapMessage(specForFileName(gMessage),</span>
<a href="#l7.155"></a><span id="l7.155">                           gIMAPMailbox.uidnext++, []));</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, URLListener);</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineplus">+  yield false;</span>
<a href="#l7.159"></a><span id="l7.159"> }</span>
<a href="#l7.160"></a><span id="l7.160"> </span>
<a href="#l7.161"></a><span id="l7.161" class="difflineminus">-// run the next test</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineminus">-function doTest()</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineminus">-{</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineminus">-  var test = gCurTestNum;</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineminus">-  if (test &lt;= gTestArray.length)</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineminus">-  {</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineminus">-    var testFn = gTestArray[test-1];</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineminus">-    dump(&quot;Doing test &quot; + test + &quot; &quot; + testFn.name + &quot;\n&quot;);</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineminus">-    // Set a limit of ten seconds; if the notifications haven't arrived by then there's a problem.</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineminus">-    do_timeout(10000, function()</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineminus">-        {</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineminus">-          if (gCurTestNum == test)</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineminus">-            do_throw(&quot;Notifications not received in 10000 ms for operation &quot; + testFn.name);</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineminus">-        }</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineminus">-      );</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineminus">-    try {</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineminus">-    testFn();</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineminus">-    } catch(ex) {</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineminus">-      gServer.stop();</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineminus">-      do_throw ('TEST FAILED ' + ex);</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineminus">-    }</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineminus">-  }</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineminus">-  else</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineminus">-    do_timeout(1000, endTest);</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineplus">+function teardown() {</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineplus">+  teardownIMAPPump();</span>
<a href="#l7.187"></a><span id="l7.187"> }</span>
<a href="#l7.188"></a><span id="l7.188"> </span>
<a href="#l7.189"></a><span id="l7.189" class="difflineminus">-// Cleanup, null out everything, close all cached connections and stop the</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineminus">-// server</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineminus">-function endTest()</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineminus">-{</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineminus">-  dump(&quot; Exiting mail tests\n&quot;);</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineminus">-  gIMAPInbox = null;</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineminus">-  gServer.resetTest();</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineminus">-  gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineminus">-  gServer.performTest();</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineminus">-  gServer.stop();</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineminus">-  let thread = gThreadManager.currentThread;</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineminus">-  while (thread.hasPendingEvents())</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineminus">-    thread.processNextEvent(true);</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineminus">-</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineminus">-  do_test_finished(); // for the one in run_test()</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineminus">-}</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineminus">-</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineminus">-// nsIURLListener implementation - runs next test</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineminus">-var URLListener =</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineminus">-{</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineminus">-  OnStartRunningUrl: function OnStartRunningUrl(aURL) {},</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineminus">-  OnStopRunningUrl: function OnStopRunningUrl(aURL, aStatus)</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineminus">-  {</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineminus">-    dump(&quot;in OnStopRunningURL &quot; + gCurTestNum + &quot;\n&quot;);</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineminus">-    do_check_eq(aStatus, 0);</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineminus">-    testContinue(this);</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineminus">-  }</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineplus">+function run_test() {</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineplus">+  async_run_tests(tests);</span>
<a href="#l7.218"></a><span id="l7.218"> }</span>
<a href="#l7.219"></a><span id="l7.219"> </span>
<a href="#l7.220"></a><span id="l7.220"> // custom action to test offline status</span>
<a href="#l7.221"></a><span id="l7.221"> actionTestOffline =</span>
<a href="#l7.222"></a><span id="l7.222"> {</span>
<a href="#l7.223"></a><span id="l7.223">   id: &quot;mailnews@mozilla.org#testOffline&quot;,</span>
<a href="#l7.224"></a><span id="l7.224">   name: &quot;test if offline&quot;,</span>
<a href="#l7.225"></a><span id="l7.225">   apply: function(aMsgHdrs, aActionValue, aListener, aType, aMsgWindow)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapAttachmentSaves.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapAttachmentSaves.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -54,17 +54,17 @@ function loadImapMessage()</span>
<a href="#l8.4"></a><span id="l8.4">                   .getService(Ci.nsIIOService);</span>
<a href="#l8.5"></a><span id="l8.5">   let msgURI =</span>
<a href="#l8.6"></a><span id="l8.6">     ioService.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l8.7"></a><span id="l8.7">                      btoa(smsg.toMessageString()),</span>
<a href="#l8.8"></a><span id="l8.8">                      null, null);</span>
<a href="#l8.9"></a><span id="l8.9">   let imapInbox =  gIMAPDaemon.getMailbox(&quot;INBOX&quot;)</span>
<a href="#l8.10"></a><span id="l8.10">   let message = new imapMessage(msgURI.spec, imapInbox.uidnext++, []);</span>
<a href="#l8.11"></a><span id="l8.11">   gIMAPMailbox.addMessage(message);</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, UrlListener);</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l8.14"></a><span id="l8.14">   yield false;</span>
<a href="#l8.15"></a><span id="l8.15">   do_check_eq(1, gIMAPInbox.getTotalMessages(false));</span>
<a href="#l8.16"></a><span id="l8.16">   let msgHdr = firstMsgHdr(gIMAPInbox);</span>
<a href="#l8.17"></a><span id="l8.17">   do_check_true(msgHdr instanceof Ci.nsIMsgDBHdr);</span>
<a href="#l8.18"></a><span id="l8.18"> </span>
<a href="#l8.19"></a><span id="l8.19">   yield true;</span>
<a href="#l8.20"></a><span id="l8.20"> }</span>
<a href="#l8.21"></a><span id="l8.21"> </span>
<a href="#l8.22"></a><span id="l8.22" class="difflineat">@@ -129,25 +129,16 @@ function SaveAttachmentCallback() {</span>
<a href="#l8.23"></a><span id="l8.23"> SaveAttachmentCallback.prototype = {</span>
<a href="#l8.24"></a><span id="l8.24">   callback: function saveAttachmentCallback_callback(aMsgHdr, aMimeMessage) {</span>
<a href="#l8.25"></a><span id="l8.25">     this.attachments = aMimeMessage.allAttachments;</span>
<a href="#l8.26"></a><span id="l8.26">     async_driver();</span>
<a href="#l8.27"></a><span id="l8.27">   }</span>
<a href="#l8.28"></a><span id="l8.28"> }</span>
<a href="#l8.29"></a><span id="l8.29"> let gCallbackObject = new SaveAttachmentCallback();</span>
<a href="#l8.30"></a><span id="l8.30"> </span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-var UrlListener = {</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-  OnStartRunningUrl: function _OnStartRunningUrl(aUrl) {</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-  },</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-  OnStopRunningUrl: function _OnStopRunningUrl(aUrl, aExitCode) {</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">-    async_driver();</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">-  }</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-};</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-</span>
<a href="#l8.40"></a><span id="l8.40"> function run_test()</span>
<a href="#l8.41"></a><span id="l8.41"> {</span>
<a href="#l8.42"></a><span id="l8.42">   // Add folder listeners that will capture async events</span>
<a href="#l8.43"></a><span id="l8.43">   const nsIMFNService = Ci.nsIMsgFolderNotificationService;</span>
<a href="#l8.44"></a><span id="l8.44">   let MFNService = Cc[&quot;@mozilla.org/messenger/msgnotificationservice;1&quot;]</span>
<a href="#l8.45"></a><span id="l8.45">                       .getService(nsIMFNService);</span>
<a href="#l8.46"></a><span id="l8.46">   MFNService.addListener(mfnListener, nsIMFNService.msgsDeleted);</span>
<a href="#l8.47"></a><span id="l8.47"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapContentLength.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapContentLength.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -6,94 +6,65 @@</span>
<a href="#l9.4"></a><span id="l9.4">  *</span>
<a href="#l9.5"></a><span id="l9.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l9.6"></a><span id="l9.6"> </span>
<a href="#l9.7"></a><span id="l9.7"> /*</span>
<a href="#l9.8"></a><span id="l9.8">  * Test content length for the IMAP protocol. This focuses on necko URLs</span>
<a href="#l9.9"></a><span id="l9.9">  * that are run externally.</span>
<a href="#l9.10"></a><span id="l9.10">  */</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+var gMsgHdr = null;</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+</span>
<a href="#l9.19"></a><span id="l9.19"> // Take a multipart message as we're testing attachment URLs as well</span>
<a href="#l9.20"></a><span id="l9.20"> const gFile = do_get_file(&quot;../../../data/multipart-complex2&quot;);</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-var gIMAPDaemon, gIMAPServer, gIMAPIncomingServer, gIMAPInbox;</span>
<a href="#l9.22"></a><span id="l9.22"> const gMFNService = Cc[&quot;@mozilla.org/messenger/msgnotificationservice;1&quot;]</span>
<a href="#l9.23"></a><span id="l9.23">                       .getService(Ci.nsIMsgFolderNotificationService);</span>
<a href="#l9.24"></a><span id="l9.24">                    </span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+var tests = [</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+  setup,</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+  addMessageToServer,</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+  verifyContentLength,</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+  teardown</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+];</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+</span>
<a href="#l9.32"></a><span id="l9.32"> // Adds some messages directly to a mailbox (eg new mail)</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-function addMessageToServer(file, mailbox)</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-{</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+function addMessageToServer() {</span>
<a href="#l9.36"></a><span id="l9.36">   let ioService = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l9.37"></a><span id="l9.37">                     .getService(Ci.nsIIOService);</span>
<a href="#l9.38"></a><span id="l9.38"> </span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-  let URI = ioService.newFileURI(file).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-  mailbox.addMessage(new imapMessage(URI.spec, mailbox.uidnext++, []));</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+  let URI = ioService.newFileURI(gFile).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+  gIMAPMailbox.addMessage(new imapMessage(URI.spec, gIMAPMailbox.uidnext++, []));</span>
<a href="#l9.43"></a><span id="l9.43"> </span>
<a href="#l9.44"></a><span id="l9.44">   gIMAPInbox.updateFolder(null);</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+  yield false;</span>
<a href="#l9.46"></a><span id="l9.46"> }</span>
<a href="#l9.47"></a><span id="l9.47"> </span>
<a href="#l9.48"></a><span id="l9.48" class="difflineminus">-var msgFolderListener =</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">-{</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-  msgAdded: function(aMsgHdr)</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-  {</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineminus">-    do_timeout_function(0, verifyContentLength, null, [aMsgHdr]);</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineminus">-  }</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+var msgFolderListener = {</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+  msgAdded: function(aMsgHdr) {</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+    gMsgHdr = aMsgHdr;</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+    do_execute_soon(async_driver);</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+  },</span>
<a href="#l9.59"></a><span id="l9.59"> };</span>
<a href="#l9.60"></a><span id="l9.60"> </span>
<a href="#l9.61"></a><span id="l9.61" class="difflineminus">-</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-function run_test()</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-{</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-  // Disable new mail notifications</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineminus">-  let prefSvc = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineminus">-                  .getService(Ci.nsIPrefBranch);</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineminus">-</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineminus">-  prefSvc.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineminus">-  prefSvc.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineminus">-  prefSvc.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineminus">-  prefSvc.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+function setup() {</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineplus">+  setupIMAPPump();</span>
<a href="#l9.74"></a><span id="l9.74"> </span>
<a href="#l9.75"></a><span id="l9.75">   // Set up nsIMsgFolderListener to get the header when it's received</span>
<a href="#l9.76"></a><span id="l9.76">   gMFNService.addListener(msgFolderListener, gMFNService.msgAdded);</span>
<a href="#l9.77"></a><span id="l9.77"> </span>
<a href="#l9.78"></a><span id="l9.78" class="difflineminus">-  // set up IMAP fakeserver and incoming server</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineminus">-  gIMAPDaemon = new imapDaemon();</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineminus">-  gIMAPServer = makeServer(gIMAPDaemon, &quot;&quot;);</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineminus">-  gIMAPIncomingServer = createLocalIMAPServer();</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineminus">-</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineminus">-  // we need a local account for the IMAP server to have its sent messages in</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineminus">-  loadLocalMailAccount();</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineminus">-</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineminus">-  // We need an identity so that updateFolder doesn't fail</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineminus">-  let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineminus">-                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineminus">-  let imapAccount = acctMgr.createAccount();</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineminus">-  let identity = acctMgr.createIdentity();</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineminus">-  imapAccount.addIdentity(identity);</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineminus">-  imapAccount.defaultIdentity = identity;</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineminus">-  imapAccount.incomingServer = gIMAPIncomingServer;</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineminus">-  acctMgr.defaultAccount = imapAccount;</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">-</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineminus">-  // The server doesn't support more than one connection</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineminus">-  prefSvc.setIntPref(&quot;mail.server.server1.max_cached_connections&quot;, 1);</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineminus">-  // We aren't interested in downloading messages automatically</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineminus">-  prefSvc.setBoolPref(&quot;mail.server.server1.download_on_biff&quot;, false);</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineminus">-</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineminus">-  gIMAPInbox = gIMAPIncomingServer.rootFolder.getChildNamed(&quot;Inbox&quot;);</span>
<a href="#l9.102"></a><span id="l9.102">   gIMAPInbox.flags &amp;= ~Ci.nsMsgFolderFlags.Offline;</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineminus">-</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineminus">-  do_test_pending();</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineminus">-</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineminus">-  // Add a message to the IMAP server</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineminus">-  addMessageToServer(gFile, gIMAPDaemon.getMailbox(&quot;INBOX&quot;));</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineminus">-</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineminus">-  gIMAPInbox.updateFolder(null);</span>
<a href="#l9.110"></a><span id="l9.110"> }</span>
<a href="#l9.111"></a><span id="l9.111"> </span>
<a href="#l9.112"></a><span id="l9.112" class="difflineminus">-function verifyContentLength(aMsgHdr)</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineminus">-{</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineminus">-  let messageUri = gIMAPInbox.getUriForMsg(aMsgHdr);</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineplus">+function verifyContentLength() {</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineplus">+  let messageUri = gIMAPInbox.getUriForMsg(gMsgHdr);</span>
<a href="#l9.117"></a><span id="l9.117">   // Convert this to a URI that necko can run</span>
<a href="#l9.118"></a><span id="l9.118">   let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l9.119"></a><span id="l9.119">   let neckoURL = {};</span>
<a href="#l9.120"></a><span id="l9.120">   let messageService = messenger.messageServiceFromURI(messageUri);</span>
<a href="#l9.121"></a><span id="l9.121">   messageService.GetUrlForUri(messageUri, neckoURL, null);</span>
<a href="#l9.122"></a><span id="l9.122">   // Don't use the necko URL directly. Instead, get the spec and create a new</span>
<a href="#l9.123"></a><span id="l9.123">   // URL using the IO service</span>
<a href="#l9.124"></a><span id="l9.124">   let urlToRun = gIOService.newURI(neckoURL.value.spec, null, null);</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineat">@@ -104,25 +75,18 @@ function verifyContentLength(aMsgHdr)</span>
<a href="#l9.126"></a><span id="l9.126"> </span>
<a href="#l9.127"></a><span id="l9.127">   // Now try an attachment. &amp;part=1.2</span>
<a href="#l9.128"></a><span id="l9.128">   let attachmentURL = gIOService.newURI(neckoURL.value.spec + &quot;&amp;part=1.2&quot;,</span>
<a href="#l9.129"></a><span id="l9.129">                                         null, null);</span>
<a href="#l9.130"></a><span id="l9.130">   let attachmentChannel = gIOService.newChannelFromURI(attachmentURL);</span>
<a href="#l9.131"></a><span id="l9.131">   // Currently attachments have their content length set to the length of the</span>
<a href="#l9.132"></a><span id="l9.132">   // entire message</span>
<a href="#l9.133"></a><span id="l9.133">   do_check_eq(attachmentChannel.contentLength, gFile.fileSize);</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineminus">-</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineminus">-  do_timeout_function(1000, endTest);</span>
<a href="#l9.136"></a><span id="l9.136"> }</span>
<a href="#l9.137"></a><span id="l9.137"> </span>
<a href="#l9.138"></a><span id="l9.138" class="difflineminus">-function endTest()</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineminus">-{</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineminus">-  gIMAPServer.resetTest();</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineminus">-  gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineminus">-  gIMAPServer.performTest();</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineminus">-  gIMAPServer.stop();</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineminus">-  let thread = gThreadManager.currentThread;</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineminus">-  while (thread.hasPendingEvents())</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineminus">-    thread.processNextEvent(true);</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineplus">+function teardown() {</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineplus">+  gMFNService.removeListener(msgFolderListener);</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineplus">+  teardownIMAPPump();</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineplus">+}</span>
<a href="#l9.151"></a><span id="l9.151"> </span>
<a href="#l9.152"></a><span id="l9.152" class="difflineminus">-  gMFNService.removeListener(msgFolderListener);</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineminus">-  do_test_finished(); // for the one in run_test()</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineplus">+function run_test() {</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineplus">+  async_run_tests(tests);</span>
<a href="#l9.156"></a><span id="l9.156"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapCopyTimeout.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapCopyTimeout.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -55,17 +55,17 @@ var tests = [</span>
<a href="#l10.4"></a><span id="l10.4"> let gTargetFolder;</span>
<a href="#l10.5"></a><span id="l10.5"> function createTargetFolder()</span>
<a href="#l10.6"></a><span id="l10.6"> {</span>
<a href="#l10.7"></a><span id="l10.7">   gIMAPDaemon.copySleep = 5000;</span>
<a href="#l10.8"></a><span id="l10.8">   gIMAPIncomingServer.rootFolder.createSubfolder(&quot;targetFolder&quot;, null);</span>
<a href="#l10.9"></a><span id="l10.9">   yield false; </span>
<a href="#l10.10"></a><span id="l10.10">   gTargetFolder = gIMAPIncomingServer.rootFolder.getChildNamed(&quot;targetFolder&quot;);</span>
<a href="#l10.11"></a><span id="l10.11">   do_check_true(gTargetFolder instanceof Ci.nsIMsgImapMailFolder);</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-  gTargetFolder.updateFolderWithListener(null, UrlListener);</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+  gTargetFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l10.14"></a><span id="l10.14">   yield false;</span>
<a href="#l10.15"></a><span id="l10.15"> }  </span>
<a href="#l10.16"></a><span id="l10.16"> </span>
<a href="#l10.17"></a><span id="l10.17"> // load and update a message in the imap fake server</span>
<a href="#l10.18"></a><span id="l10.18"> function loadImapMessage()</span>
<a href="#l10.19"></a><span id="l10.19"> {</span>
<a href="#l10.20"></a><span id="l10.20">   let messages = [];</span>
<a href="#l10.21"></a><span id="l10.21">   let gMessageGenerator = new MessageGenerator();</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineat">@@ -113,28 +113,20 @@ function waitForOfflinePlayback()</span>
<a href="#l10.23"></a><span id="l10.23">   yield false;</span>
<a href="#l10.24"></a><span id="l10.24">   // then, wait for a second so we don't get our next url aborted.</span>
<a href="#l10.25"></a><span id="l10.25">   do_timeout(1000, async_driver);</span>
<a href="#l10.26"></a><span id="l10.26">   yield false;</span>
<a href="#l10.27"></a><span id="l10.27"> }</span>
<a href="#l10.28"></a><span id="l10.28"> </span>
<a href="#l10.29"></a><span id="l10.29"> function updateTargetFolder()</span>
<a href="#l10.30"></a><span id="l10.30"> {</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-  gTargetFolder.updateFolderWithListener(null, UrlListener);</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+  gTargetFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l10.33"></a><span id="l10.33">   yield false;</span>
<a href="#l10.34"></a><span id="l10.34"> }</span>
<a href="#l10.35"></a><span id="l10.35"> </span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">-var UrlListener = {</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-  OnStartRunningUrl: function _OnStartRunningUrl(aUrl) {</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">-  },</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-  OnStopRunningUrl: function _OnStopRunningUrl(aUrl, aExitCode) {</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineminus">-    async_driver();</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineminus">-  }</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineminus">-};</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineminus">-</span>
<a href="#l10.44"></a><span id="l10.44"> // Cleanup</span>
<a href="#l10.45"></a><span id="l10.45"> function endTest()</span>
<a href="#l10.46"></a><span id="l10.46"> {</span>
<a href="#l10.47"></a><span id="l10.47">   do_check_true(gGotAlert);</span>
<a href="#l10.48"></a><span id="l10.48">   // Make sure neither source nor target folder have offline events.</span>
<a href="#l10.49"></a><span id="l10.49">   do_check_false(gIMAPInbox.getFlag(Ci.nsMsgFolderFlags.OfflineEvents));</span>
<a href="#l10.50"></a><span id="l10.50">   do_check_false(gTargetFolder.getFlag(Ci.nsMsgFolderFlags.OfflineEvents));</span>
<a href="#l10.51"></a><span id="l10.51"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapFlagChange.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapFlagChange.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1,200 +1,142 @@</span>
<a href="#l11.4"></a><span id="l11.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l11.5"></a><span id="l11.5"> /*</span>
<a href="#l11.6"></a><span id="l11.6">  * Test to ensure that imap flag changes made from a different profile/machine</span>
<a href="#l11.7"></a><span id="l11.7">  * are stored in db.</span>
<a href="#l11.8"></a><span id="l11.8">  */</span>
<a href="#l11.9"></a><span id="l11.9"> </span>
<a href="#l11.10"></a><span id="l11.10" class="difflineminus">-var gIMAPDaemon, gServer, gIMAPIncomingServer;</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineminus">-</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l11.15"></a><span id="l11.15"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l11.17"></a><span id="l11.17"> </span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-var gIMAPInbox;</span>
<a href="#l11.19"></a><span id="l11.19"> var gMessage;</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-var gTest;</span>
<a href="#l11.21"></a><span id="l11.21"> var gSecondFolder;</span>
<a href="#l11.22"></a><span id="l11.22"> var gSynthMessage;</span>
<a href="#l11.23"></a><span id="l11.23"> </span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-const gTestArray =</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-[</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+var tests = [</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+  setup,</span>
<a href="#l11.28"></a><span id="l11.28">   function switchAwayFromInbox() {</span>
<a href="#l11.29"></a><span id="l11.29">     let rootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l11.30"></a><span id="l11.30">     gSecondFolder =  rootFolder.getChildNamed(&quot;secondFolder&quot;)</span>
<a href="#l11.31"></a><span id="l11.31">                            .QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l11.32"></a><span id="l11.32"> </span>
<a href="#l11.33"></a><span id="l11.33">     // Selecting the second folder will close the cached connection</span>
<a href="#l11.34"></a><span id="l11.34">     // on the inbox because fake server only supports one connection at a time.</span>
<a href="#l11.35"></a><span id="l11.35">     //  Then, we can poke at the message on the imap server directly, which</span>
<a href="#l11.36"></a><span id="l11.36">     // simulates the user changing the message from a different machine,</span>
<a href="#l11.37"></a><span id="l11.37">     // and Thunderbird discovering the change when it does a flag sync </span>
<a href="#l11.38"></a><span id="l11.38">     // upon reselecting the Inbox.</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-    gSecondFolder.updateFolderWithListener(null, UrlListener);</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+    gSecondFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+    yield false;</span>
<a href="#l11.42"></a><span id="l11.42">   },</span>
<a href="#l11.43"></a><span id="l11.43">   function simulateForwardFlagSet() {</span>
<a href="#l11.44"></a><span id="l11.44">     gMessage.setFlag(&quot;$Forwarded&quot;);</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-    gIMAPInbox.updateFolderWithListener(null, UrlListener);</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+    gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+    yield false;</span>
<a href="#l11.48"></a><span id="l11.48">   },</span>
<a href="#l11.49"></a><span id="l11.49">   function checkForwardedFlagSet() {</span>
<a href="#l11.50"></a><span id="l11.50">     let msgHdr = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gSynthMessage.messageId);</span>
<a href="#l11.51"></a><span id="l11.51">     do_check_eq(msgHdr.flags &amp; Ci.nsMsgMessageFlags.Forwarded,</span>
<a href="#l11.52"></a><span id="l11.52">       Ci.nsMsgMessageFlags.Forwarded);</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineminus">-    gSecondFolder.updateFolderWithListener(null, UrlListener);</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+    gSecondFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+    yield false;</span>
<a href="#l11.56"></a><span id="l11.56">   },</span>
<a href="#l11.57"></a><span id="l11.57">   function clearForwardedFlag() {</span>
<a href="#l11.58"></a><span id="l11.58">     gMessage.clearFlag(&quot;$Forwarded&quot;);</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineminus">-    gIMAPInbox.updateFolderWithListener(null, UrlListener);</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineplus">+    gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+    yield false;</span>
<a href="#l11.62"></a><span id="l11.62">   },</span>
<a href="#l11.63"></a><span id="l11.63">   function checkForwardedFlagCleared() {</span>
<a href="#l11.64"></a><span id="l11.64">     let msgHdr = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gSynthMessage.messageId);</span>
<a href="#l11.65"></a><span id="l11.65">     do_check_eq(msgHdr.flags &amp; Ci.nsMsgMessageFlags.Forwarded, 0);</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineminus">-    gSecondFolder.updateFolderWithListener(null, UrlListener);</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+    gSecondFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineplus">+    yield false;</span>
<a href="#l11.69"></a><span id="l11.69">   },</span>
<a href="#l11.70"></a><span id="l11.70">   function setSeenFlag() {</span>
<a href="#l11.71"></a><span id="l11.71">     gMessage.setFlag(&quot;\\Seen&quot;);</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineminus">-    gIMAPInbox.updateFolderWithListener(null, UrlListener);</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+    gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+    yield false;</span>
<a href="#l11.75"></a><span id="l11.75">   },</span>
<a href="#l11.76"></a><span id="l11.76">   function checkSeenFlagSet() {</span>
<a href="#l11.77"></a><span id="l11.77">     let msgHdr = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gSynthMessage.messageId);</span>
<a href="#l11.78"></a><span id="l11.78">     do_check_eq(msgHdr.flags &amp; Ci.nsMsgMessageFlags.Read,</span>
<a href="#l11.79"></a><span id="l11.79">                 Ci.nsMsgMessageFlags.Read);</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineminus">-    gSecondFolder.updateFolderWithListener(null, UrlListener);</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+    gSecondFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineplus">+    yield false;</span>
<a href="#l11.83"></a><span id="l11.83">   },</span>
<a href="#l11.84"></a><span id="l11.84">   function simulateRepliedFlagSet() {</span>
<a href="#l11.85"></a><span id="l11.85">     gMessage.setFlag(&quot;\\Answered&quot;);</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineminus">-    gIMAPInbox.updateFolderWithListener(null, UrlListener);</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineplus">+    gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineplus">+    yield false;</span>
<a href="#l11.89"></a><span id="l11.89">   },</span>
<a href="#l11.90"></a><span id="l11.90">   function checkRepliedFlagSet() {</span>
<a href="#l11.91"></a><span id="l11.91">     let msgHdr = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gSynthMessage.messageId);</span>
<a href="#l11.92"></a><span id="l11.92">     do_check_eq(msgHdr.flags &amp; Ci.nsMsgMessageFlags.Replied,</span>
<a href="#l11.93"></a><span id="l11.93">       Ci.nsMsgMessageFlags.Replied);</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineminus">-    gSecondFolder.updateFolderWithListener(null, UrlListener);</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineplus">+    gSecondFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineplus">+    yield false;</span>
<a href="#l11.97"></a><span id="l11.97">   },</span>
<a href="#l11.98"></a><span id="l11.98">   function simulateTagAdded() {</span>
<a href="#l11.99"></a><span id="l11.99">     gMessage.setFlag(&quot;randomtag&quot;);</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineminus">-    gIMAPInbox.updateFolderWithListener(null, UrlListener);</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineplus">+    gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineplus">+    yield false;</span>
<a href="#l11.103"></a><span id="l11.103">   },</span>
<a href="#l11.104"></a><span id="l11.104">   function checkTagSet() {</span>
<a href="#l11.105"></a><span id="l11.105">     let msgHdr = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gSynthMessage.messageId);</span>
<a href="#l11.106"></a><span id="l11.106">     let keywords = msgHdr.getStringProperty(&quot;keywords&quot;);</span>
<a href="#l11.107"></a><span id="l11.107">     do_check_true(keywords.indexOf(&quot;randomtag&quot;) != -1);</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineminus">-    gSecondFolder.updateFolderWithListener(null, UrlListener);</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineplus">+    gSecondFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineplus">+    yield false;</span>
<a href="#l11.111"></a><span id="l11.111">   },</span>
<a href="#l11.112"></a><span id="l11.112">   function clearTag() {</span>
<a href="#l11.113"></a><span id="l11.113">     gMessage.clearFlag(&quot;randomtag&quot;);</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineminus">-    gIMAPInbox.updateFolderWithListener(null, UrlListener);</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineplus">+    gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineplus">+    yield false;</span>
<a href="#l11.117"></a><span id="l11.117">   },</span>
<a href="#l11.118"></a><span id="l11.118">   function checkTagCleared() {</span>
<a href="#l11.119"></a><span id="l11.119">     let msgHdr = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gSynthMessage.messageId);</span>
<a href="#l11.120"></a><span id="l11.120">     let keywords = msgHdr.getStringProperty(&quot;keywords&quot;);</span>
<a href="#l11.121"></a><span id="l11.121">     do_check_eq(keywords.indexOf(&quot;randomtag&quot;), -1);</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineminus">-    doTest(++gTest);</span>
<a href="#l11.123"></a><span id="l11.123">   },</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineplus">+  teardown</span>
<a href="#l11.125"></a><span id="l11.125"> ];</span>
<a href="#l11.126"></a><span id="l11.126"> </span>
<a href="#l11.127"></a><span id="l11.127" class="difflineminus">-function run_test()</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineminus">-{</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineminus">-  gTest = 0;</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineminus">-  loadLocalMailAccount();</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineminus">-</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineminus">-  /*</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineminus">-   * Set up an IMAP server.</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineminus">-   */</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineminus">-  gIMAPDaemon = new imapDaemon();</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineminus">-  gServer = makeServer(gIMAPDaemon, &quot;&quot;);</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;secondFolder&quot;, {subscribed : true});</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineminus">-  gIMAPIncomingServer = createLocalIMAPServer();</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineminus">-  gIMAPIncomingServer.maximumConnectionsNumber = 1;</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineplus">+function setup() {</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l11.142"></a><span id="l11.142"> </span>
<a href="#l11.143"></a><span id="l11.143" class="difflineminus">-  // We need an identity so that updateFolder doesn't fail</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineminus">-  let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineminus">-  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineminus">-  let localAccount = acctMgr.createAccount();</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineminus">-  let identity = acctMgr.createIdentity();</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineminus">-  localAccount.addIdentity(identity);</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineminus">-  localAccount.defaultIdentity = identity;</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineminus">-  localAccount.incomingServer = gLocalIncomingServer;</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineminus">-  acctMgr.defaultAccount = localAccount;</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineminus">-  </span>
<a href="#l11.153"></a><span id="l11.153" class="difflineminus">-  // Let's also have another account, using the same identity</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineminus">-  let imapAccount = acctMgr.createAccount();</span>
<a href="#l11.155"></a><span id="l11.155" class="difflineminus">-  imapAccount.addIdentity(identity);</span>
<a href="#l11.156"></a><span id="l11.156" class="difflineminus">-  imapAccount.defaultIdentity = identity;</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineminus">-  imapAccount.incomingServer = gIMAPIncomingServer;</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineminus">-  </span>
<a href="#l11.159"></a><span id="l11.159" class="difflineminus">-  // pref tuning: one connection only, turn off notifications</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineminus">-  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineminus">-                     .getService(Ci.nsIPrefBranch);</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l11.163"></a><span id="l11.163" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineplus">+  setupIMAPPump();</span>
<a href="#l11.167"></a><span id="l11.167" class="difflineplus">+</span>
<a href="#l11.168"></a><span id="l11.168" class="difflineplus">+  gIMAPDaemon.createMailbox(&quot;secondFolder&quot;, {subscribed : true});</span>
<a href="#l11.169"></a><span id="l11.169"> </span>
<a href="#l11.170"></a><span id="l11.170">   // build up a diverse list of messages</span>
<a href="#l11.171"></a><span id="l11.171">   let messages = [];</span>
<a href="#l11.172"></a><span id="l11.172">   let gMessageGenerator = new MessageGenerator();</span>
<a href="#l11.173"></a><span id="l11.173">   messages = messages.concat(gMessageGenerator.makeMessage());</span>
<a href="#l11.174"></a><span id="l11.174">   gSynthMessage = messages[0];</span>
<a href="#l11.175"></a><span id="l11.175"> </span>
<a href="#l11.176"></a><span id="l11.176">   let ioService = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l11.177"></a><span id="l11.177">                   .getService(Ci.nsIIOService);</span>
<a href="#l11.178"></a><span id="l11.178">   let msgURI =</span>
<a href="#l11.179"></a><span id="l11.179">     ioService.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l11.180"></a><span id="l11.180">                      btoa(gSynthMessage.toMessageString()),</span>
<a href="#l11.181"></a><span id="l11.181">                      null, null);</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineminus">-  let imapInbox =  gIMAPDaemon.getMailbox(&quot;INBOX&quot;)</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineminus">-  gMessage = new imapMessage(msgURI.spec, imapInbox.uidnext++, []);</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineminus">-  imapInbox.addMessage(gMessage);</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineminus">-  do_test_pending();</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineminus">-</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineminus">-  // Get the IMAP inbox...</span>
<a href="#l11.188"></a><span id="l11.188" class="difflineminus">-  let rootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l11.189"></a><span id="l11.189" class="difflineminus">-  gIMAPInbox = rootFolder.getFolderWithFlags(Ci.nsMsgFolderFlags.Inbox)</span>
<a href="#l11.190"></a><span id="l11.190" class="difflineminus">-                         .QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineplus">+  gMessage = new imapMessage(msgURI.spec, gIMAPMailbox.uidnext++, []);</span>
<a href="#l11.192"></a><span id="l11.192" class="difflineplus">+  gIMAPMailbox.addMessage(gMessage);</span>
<a href="#l11.193"></a><span id="l11.193"> </span>
<a href="#l11.194"></a><span id="l11.194">   // update folder to download header.</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, UrlListener);</span>
<a href="#l11.196"></a><span id="l11.196" class="difflineplus">+  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l11.197"></a><span id="l11.197" class="difflineplus">+  yield false;</span>
<a href="#l11.198"></a><span id="l11.198"> }</span>
<a href="#l11.199"></a><span id="l11.199"> </span>
<a href="#l11.200"></a><span id="l11.200" class="difflineminus">-var UrlListener = </span>
<a href="#l11.201"></a><span id="l11.201" class="difflineminus">-{</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineminus">-  OnStartRunningUrl: function(url) { },</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineminus">-  OnStopRunningUrl: function(url, rc)</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineminus">-  {</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineminus">-    // Check for ok status.</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineminus">-    do_check_eq(rc, 0);</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineminus">-    doTest(++gTest);</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineminus">-  }</span>
<a href="#l11.209"></a><span id="l11.209" class="difflineplus">+asyncUrlListener.callback = function(aUrl, aExitCode) {</span>
<a href="#l11.210"></a><span id="l11.210" class="difflineplus">+  do_check_eq(aExitCode, 0);</span>
<a href="#l11.211"></a><span id="l11.211"> };</span>
<a href="#l11.212"></a><span id="l11.212"> </span>
<a href="#l11.213"></a><span id="l11.213" class="difflineminus">-function doTest(test)</span>
<a href="#l11.214"></a><span id="l11.214" class="difflineminus">-{</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineminus">-  if (test &lt;= gTestArray.length)</span>
<a href="#l11.216"></a><span id="l11.216" class="difflineminus">-  {</span>
<a href="#l11.217"></a><span id="l11.217" class="difflineminus">-    dump(&quot;Doing test &quot; + test + &quot;\n&quot;);</span>
<a href="#l11.218"></a><span id="l11.218" class="difflineminus">-    gTest = test;</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineminus">-</span>
<a href="#l11.220"></a><span id="l11.220" class="difflineminus">-    var testFn = gTestArray[test - 1];</span>
<a href="#l11.221"></a><span id="l11.221" class="difflineminus">-    // Set a limit of ten seconds; if the notifications haven't arrived by then there's a problem.</span>
<a href="#l11.222"></a><span id="l11.222" class="difflineminus">-    try {</span>
<a href="#l11.223"></a><span id="l11.223" class="difflineminus">-      testFn();</span>
<a href="#l11.224"></a><span id="l11.224" class="difflineminus">-    } catch(ex) {</span>
<a href="#l11.225"></a><span id="l11.225" class="difflineminus">-      gServer.stop();</span>
<a href="#l11.226"></a><span id="l11.226" class="difflineminus">-      do_throw ('TEST FAILED ' + ex);</span>
<a href="#l11.227"></a><span id="l11.227" class="difflineminus">-    }</span>
<a href="#l11.228"></a><span id="l11.228" class="difflineminus">-  }</span>
<a href="#l11.229"></a><span id="l11.229" class="difflineminus">-  else</span>
<a href="#l11.230"></a><span id="l11.230" class="difflineminus">-  {</span>
<a href="#l11.231"></a><span id="l11.231" class="difflineminus">-    do_timeout_function(1000, endTest);</span>
<a href="#l11.232"></a><span id="l11.232" class="difflineminus">-  }</span>
<a href="#l11.233"></a><span id="l11.233" class="difflineplus">+function teardown() {</span>
<a href="#l11.234"></a><span id="l11.234" class="difflineplus">+  teardownIMAPPump();</span>
<a href="#l11.235"></a><span id="l11.235"> }</span>
<a href="#l11.236"></a><span id="l11.236"> </span>
<a href="#l11.237"></a><span id="l11.237" class="difflineminus">-function endTest()</span>
<a href="#l11.238"></a><span id="l11.238" class="difflineminus">-{</span>
<a href="#l11.239"></a><span id="l11.239" class="difflineminus">-  gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l11.240"></a><span id="l11.240" class="difflineminus">-  gServer.stop();</span>
<a href="#l11.241"></a><span id="l11.241" class="difflineminus">-</span>
<a href="#l11.242"></a><span id="l11.242" class="difflineminus">-  var thread = gThreadManager.currentThread;</span>
<a href="#l11.243"></a><span id="l11.243" class="difflineminus">-  while (thread.hasPendingEvents())</span>
<a href="#l11.244"></a><span id="l11.244" class="difflineminus">-    thread.processNextEvent(true);</span>
<a href="#l11.245"></a><span id="l11.245" class="difflineminus">-</span>
<a href="#l11.246"></a><span id="l11.246" class="difflineminus">-  do_test_finished();</span>
<a href="#l11.247"></a><span id="l11.247" class="difflineplus">+function run_test() {</span>
<a href="#l11.248"></a><span id="l11.248" class="difflineplus">+  async_run_tests(tests);</span>
<a href="#l11.249"></a><span id="l11.249"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapFolderCopy.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapFolderCopy.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -1,233 +1,145 @@</span>
<a href="#l12.4"></a><span id="l12.4"> // This file tests the folder copying with IMAP. In particular, we're</span>
<a href="#l12.5"></a><span id="l12.5"> // going to test copying local folders to imap servers, but other tests</span>
<a href="#l12.6"></a><span id="l12.6"> // could be added.</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l12.11"></a><span id="l12.11"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l12.13"></a><span id="l12.13"> </span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-var gRootFolder;</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">-var gIMAPInbox, gIMAPTrashFolder;</span>
<a href="#l12.16"></a><span id="l12.16"> var gEmptyLocal1, gEmptyLocal2, gEmptyLocal3, gNotEmptyLocal4;</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-var gIMAPDaemon, gServer, gIMAPIncomingServer;</span>
<a href="#l12.18"></a><span id="l12.18"> var gCopyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l12.19"></a><span id="l12.19">                 .getService(Ci.nsIMsgCopyService);</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineminus">-var gCurTestNum;</span>
<a href="#l12.21"></a><span id="l12.21"> </span>
<a href="#l12.22"></a><span id="l12.22"> Components.utils.import(&quot;resource:///modules/folderUtils.jsm&quot;);</span>
<a href="#l12.23"></a><span id="l12.23"> Components.utils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l12.24"></a><span id="l12.24"> </span>
<a href="#l12.25"></a><span id="l12.25" class="difflineminus">-const gTestArray =</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineminus">-[</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+var tests = [</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+  setup,</span>
<a href="#l12.29"></a><span id="l12.29">   function copyFolder1() {</span>
<a href="#l12.30"></a><span id="l12.30">     dump(&quot;gEmpty1 &quot; + gEmptyLocal1.URI + &quot;\n&quot;);</span>
<a href="#l12.31"></a><span id="l12.31">     let folders = new Array;</span>
<a href="#l12.32"></a><span id="l12.32">     folders.push(gEmptyLocal1.QueryInterface(Ci.nsIMsgFolder));</span>
<a href="#l12.33"></a><span id="l12.33">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l12.34"></a><span id="l12.34">     gCopyService.CopyFolders(array, gIMAPInbox, false, CopyListener, null);</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+    yield false;</span>
<a href="#l12.36"></a><span id="l12.36">   },</span>
<a href="#l12.37"></a><span id="l12.37">   function copyFolder2() {</span>
<a href="#l12.38"></a><span id="l12.38">     dump(&quot;gEmpty2 &quot; + gEmptyLocal2.URI + &quot;\n&quot;);</span>
<a href="#l12.39"></a><span id="l12.39">     let folders = new Array;</span>
<a href="#l12.40"></a><span id="l12.40">     folders.push(gEmptyLocal2);</span>
<a href="#l12.41"></a><span id="l12.41">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l12.42"></a><span id="l12.42">     gCopyService.CopyFolders(array, gIMAPInbox, false, CopyListener, null);</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+    yield false;</span>
<a href="#l12.44"></a><span id="l12.44">   },</span>
<a href="#l12.45"></a><span id="l12.45">   function copyFolder3() {</span>
<a href="#l12.46"></a><span id="l12.46">     dump(&quot;gEmpty3 &quot; + gEmptyLocal3.URI + &quot;\n&quot;);</span>
<a href="#l12.47"></a><span id="l12.47">     let folders = new Array;</span>
<a href="#l12.48"></a><span id="l12.48">     folders.push(gEmptyLocal3);</span>
<a href="#l12.49"></a><span id="l12.49">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l12.50"></a><span id="l12.50">     gCopyService.CopyFolders(array, gIMAPInbox, false, CopyListener, null);</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+    yield false;</span>
<a href="#l12.52"></a><span id="l12.52">   },</span>
<a href="#l12.53"></a><span id="l12.53">   function verifyFolders() {</span>
<a href="#l12.54"></a><span id="l12.54">     let folder1 = gIMAPInbox.getChildNamed(&quot;empty 1&quot;);</span>
<a href="#l12.55"></a><span id="l12.55">     dump(&quot;found folder1\n&quot;);</span>
<a href="#l12.56"></a><span id="l12.56">     let folder2 = gIMAPInbox.getChildNamed(&quot;empty 2&quot;);</span>
<a href="#l12.57"></a><span id="l12.57">     dump(&quot;found folder2\n&quot;);</span>
<a href="#l12.58"></a><span id="l12.58">     let folder3 = gIMAPInbox.getChildNamed(&quot;empty 3&quot;);</span>
<a href="#l12.59"></a><span id="l12.59">     dump(&quot;found folder3\n&quot;);</span>
<a href="#l12.60"></a><span id="l12.60">     do_check_neq(folder1, null);</span>
<a href="#l12.61"></a><span id="l12.61">     do_check_neq(folder2, null);</span>
<a href="#l12.62"></a><span id="l12.62">     do_check_neq(folder3, null);</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineminus">-    doTest(++gCurTestNum);</span>
<a href="#l12.64"></a><span id="l12.64">   },</span>
<a href="#l12.65"></a><span id="l12.65">   function moveImapFolder1() {</span>
<a href="#l12.66"></a><span id="l12.66">     let folders = new Array;</span>
<a href="#l12.67"></a><span id="l12.67">     let folder1 = gIMAPInbox.getChildNamed(&quot;empty 1&quot;);</span>
<a href="#l12.68"></a><span id="l12.68">     let folder2 = gIMAPInbox.getChildNamed(&quot;empty 2&quot;);</span>
<a href="#l12.69"></a><span id="l12.69">     folders.push(folder2.QueryInterface(Ci.nsIMsgFolder));</span>
<a href="#l12.70"></a><span id="l12.70">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l12.71"></a><span id="l12.71">     gCopyService.CopyFolders(array, folder1, true, CopyListener, null);</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineplus">+    yield false;</span>
<a href="#l12.73"></a><span id="l12.73">   },</span>
<a href="#l12.74"></a><span id="l12.74">   function moveImapFolder2() {</span>
<a href="#l12.75"></a><span id="l12.75">     let folders = new Array;</span>
<a href="#l12.76"></a><span id="l12.76">     let folder1 = gIMAPInbox.getChildNamed(&quot;empty 1&quot;);</span>
<a href="#l12.77"></a><span id="l12.77">     let folder3 = gIMAPInbox.getChildNamed(&quot;empty 3&quot;);</span>
<a href="#l12.78"></a><span id="l12.78">     folders.push(folder3.QueryInterface(Ci.nsIMsgFolder));</span>
<a href="#l12.79"></a><span id="l12.79">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l12.80"></a><span id="l12.80">     gCopyService.CopyFolders(array, folder1, true, CopyListener, null);</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+    yield false;</span>
<a href="#l12.82"></a><span id="l12.82">   },</span>
<a href="#l12.83"></a><span id="l12.83">   function verifyImapFolders() {</span>
<a href="#l12.84"></a><span id="l12.84">     let folder1 = gIMAPInbox.getChildNamed(&quot;empty 1&quot;);</span>
<a href="#l12.85"></a><span id="l12.85">     dump(&quot;found folder1\n&quot;);</span>
<a href="#l12.86"></a><span id="l12.86">     let folder2 = folder1.getChildNamed(&quot;empty 2&quot;);</span>
<a href="#l12.87"></a><span id="l12.87">     dump(&quot;found folder2\n&quot;);</span>
<a href="#l12.88"></a><span id="l12.88">     let folder3 = folder1.getChildNamed(&quot;empty 3&quot;);</span>
<a href="#l12.89"></a><span id="l12.89">     dump(&quot;found folder3\n&quot;);</span>
<a href="#l12.90"></a><span id="l12.90">     do_check_neq(folder1, null);</span>
<a href="#l12.91"></a><span id="l12.91">     do_check_neq(folder2, null);</span>
<a href="#l12.92"></a><span id="l12.92">     do_check_neq(folder3, null);</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineminus">-    doTest(++gCurTestNum);</span>
<a href="#l12.94"></a><span id="l12.94">   },</span>
<a href="#l12.95"></a><span id="l12.95">   function testImapFolderCopyFailure() {</span>
<a href="#l12.96"></a><span id="l12.96">     let folders = new Array;</span>
<a href="#l12.97"></a><span id="l12.97">     folders.push(gNotEmptyLocal4.QueryInterface(Ci.nsIMsgFolder));</span>
<a href="#l12.98"></a><span id="l12.98">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l12.99"></a><span id="l12.99">     gIMAPDaemon.commandToFail = &quot;APPEND&quot;;</span>
<a href="#l12.100"></a><span id="l12.100">     // we expect NS_MSG_ERROR_IMAP_COMMAND_FAILED;</span>
<a href="#l12.101"></a><span id="l12.101">     CopyListener._expectedStatus = 0x80550021;</span>
<a href="#l12.102"></a><span id="l12.102">     gCopyService.CopyFolders(array, gIMAPInbox, false, CopyListener, null);</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineplus">+</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineplus">+    // In failure case OnStopCopy is sent twice, the first one comes from</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineplus">+    // nsMsgCopyService, the second one comes from nsImapFolderCopyState.</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineplus">+    yield false;</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineplus">+</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineplus">+    yield false;</span>
<a href="#l12.109"></a><span id="l12.109">   },</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineminus">-  function finishTest() {</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineminus">-    doTest(++gCurTestNum);</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineminus">-  }</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineplus">+  teardown</span>
<a href="#l12.114"></a><span id="l12.114"> ];</span>
<a href="#l12.115"></a><span id="l12.115"> </span>
<a href="#l12.116"></a><span id="l12.116" class="difflineminus">-function run_test()</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineminus">-{</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineminus">-  // Add a listener.</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineminus">-  gIMAPDaemon = new imapDaemon();</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineminus">-  gServer = makeServer(gIMAPDaemon, &quot;&quot;);</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineminus">-</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineminus">-  gIMAPIncomingServer = createLocalIMAPServer();</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineminus">-</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineminus">-  loadLocalMailAccount();</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineminus">-</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineminus">-  // We need an identity so that updateFolder doesn't fail</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineminus">-  let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineminus">-                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineminus">-  let localAccount = acctMgr.createAccount();</span>
<a href="#l12.130"></a><span id="l12.130" class="difflineminus">-  let identity = acctMgr.createIdentity();</span>
<a href="#l12.131"></a><span id="l12.131" class="difflineminus">-  localAccount.addIdentity(identity);</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineminus">-  localAccount.defaultIdentity = identity;</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineminus">-  localAccount.incomingServer = gLocalIncomingServer;</span>
<a href="#l12.134"></a><span id="l12.134" class="difflineminus">-  acctMgr.defaultAccount = localAccount;</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineminus">-</span>
<a href="#l12.136"></a><span id="l12.136" class="difflineminus">-  // Let's also have another account, using the same identity</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineminus">-  let imapAccount = acctMgr.createAccount();</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineminus">-  imapAccount.addIdentity(identity);</span>
<a href="#l12.139"></a><span id="l12.139" class="difflineminus">-  imapAccount.defaultIdentity = identity;</span>
<a href="#l12.140"></a><span id="l12.140" class="difflineminus">-  imapAccount.incomingServer = gIMAPIncomingServer;</span>
<a href="#l12.141"></a><span id="l12.141" class="difflineminus">-</span>
<a href="#l12.142"></a><span id="l12.142" class="difflineminus">-  // The server doesn't support more than one connection</span>
<a href="#l12.143"></a><span id="l12.143" class="difflineminus">-  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l12.144"></a><span id="l12.144" class="difflineminus">-                     .getService(Ci.nsIPrefBranch);</span>
<a href="#l12.145"></a><span id="l12.145" class="difflineminus">-  prefBranch.setIntPref(&quot;mail.server.server1.max_cached_connections&quot;, 1);</span>
<a href="#l12.146"></a><span id="l12.146" class="difflineminus">-  // Make sure no biff notifications happen</span>
<a href="#l12.147"></a><span id="l12.147" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineminus">-  // We aren't interested in downloading messages automatically</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.server.server1.download_on_biff&quot;, false);</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineplus">+function setup() {</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineplus">+  setupIMAPPump();</span>
<a href="#l12.155"></a><span id="l12.155"> </span>
<a href="#l12.156"></a><span id="l12.156">   gEmptyLocal1 = gLocalIncomingServer.rootFolder.createLocalSubfolder(&quot;empty 1&quot;);</span>
<a href="#l12.157"></a><span id="l12.157">   gEmptyLocal2 = gLocalIncomingServer.rootFolder.createLocalSubfolder(&quot;empty 2&quot;);</span>
<a href="#l12.158"></a><span id="l12.158">   gEmptyLocal3 = gLocalIncomingServer.rootFolder.createLocalSubfolder(&quot;empty 3&quot;);</span>
<a href="#l12.159"></a><span id="l12.159">   gNotEmptyLocal4 = gLocalIncomingServer.rootFolder.createLocalSubfolder(&quot;not empty 4&quot;);</span>
<a href="#l12.160"></a><span id="l12.160"> </span>
<a href="#l12.161"></a><span id="l12.161">   let messageGenerator = new MessageGenerator();</span>
<a href="#l12.162"></a><span id="l12.162">   let message = messageGenerator.makeMessage();</span>
<a href="#l12.163"></a><span id="l12.163">   gNotEmptyLocal4.QueryInterface(Ci.nsIMsgLocalMailFolder);</span>
<a href="#l12.164"></a><span id="l12.164">   gNotEmptyLocal4.addMessage(message.toMboxString());</span>
<a href="#l12.165"></a><span id="l12.165"> </span>
<a href="#l12.166"></a><span id="l12.166" class="difflineminus">-  // Get the server list...</span>
<a href="#l12.167"></a><span id="l12.167" class="difflineminus">-  gIMAPIncomingServer.performExpand(null);</span>
<a href="#l12.168"></a><span id="l12.168" class="difflineminus">-</span>
<a href="#l12.169"></a><span id="l12.169" class="difflineminus">-  gRootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l12.170"></a><span id="l12.170" class="difflineminus">-  gIMAPInbox = gRootFolder.getChildNamed(&quot;INBOX&quot;);</span>
<a href="#l12.171"></a><span id="l12.171" class="difflineminus">-  dump(&quot;gIMAPInbox uri = &quot; + gIMAPInbox.URI + &quot;\n&quot;);</span>
<a href="#l12.172"></a><span id="l12.172" class="difflineminus">-  let msgImapFolder = gIMAPInbox.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l12.173"></a><span id="l12.173">   // these hacks are required because we've created the inbox before</span>
<a href="#l12.174"></a><span id="l12.174">   // running initial folder discovery, and adding the folder bails</span>
<a href="#l12.175"></a><span id="l12.175">   // out before we set it as verified online, so we bail out, and</span>
<a href="#l12.176"></a><span id="l12.176">   // then remove the INBOX folder since it's not verified.</span>
<a href="#l12.177"></a><span id="l12.177" class="difflineminus">-  msgImapFolder.hierarchyDelimiter = '/';</span>
<a href="#l12.178"></a><span id="l12.178" class="difflineminus">-  msgImapFolder.verifiedAsOnlineFolder = true;</span>
<a href="#l12.179"></a><span id="l12.179" class="difflineminus">-</span>
<a href="#l12.180"></a><span id="l12.180" class="difflineminus">-  // &quot;Master&quot; do_test_pending(), paired with a do_test_finished() at the end of</span>
<a href="#l12.181"></a><span id="l12.181" class="difflineminus">-  // all the operations.</span>
<a href="#l12.182"></a><span id="l12.182" class="difflineminus">-</span>
<a href="#l12.183"></a><span id="l12.183" class="difflineminus">-</span>
<a href="#l12.184"></a><span id="l12.184" class="difflineminus">-  do_test_pending();</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineminus">-  //start first test</span>
<a href="#l12.186"></a><span id="l12.186" class="difflineminus">-  doTest(1);</span>
<a href="#l12.187"></a><span id="l12.187" class="difflineminus">-}</span>
<a href="#l12.188"></a><span id="l12.188" class="difflineminus">-</span>
<a href="#l12.189"></a><span id="l12.189" class="difflineminus">-function doTest(test)</span>
<a href="#l12.190"></a><span id="l12.190" class="difflineminus">-{</span>
<a href="#l12.191"></a><span id="l12.191" class="difflineminus">-  if (test &lt;= gTestArray.length)</span>
<a href="#l12.192"></a><span id="l12.192" class="difflineminus">-  {</span>
<a href="#l12.193"></a><span id="l12.193" class="difflineminus">-    dump(&quot;Doing test &quot; + test + &quot;\n&quot;);</span>
<a href="#l12.194"></a><span id="l12.194" class="difflineminus">-    gCurTestNum = test;</span>
<a href="#l12.195"></a><span id="l12.195" class="difflineminus">-</span>
<a href="#l12.196"></a><span id="l12.196" class="difflineminus">-    var testFn = gTestArray[test-1];</span>
<a href="#l12.197"></a><span id="l12.197" class="difflineminus">-    // Set a limit of ten seconds; if the notifications haven't arrived by then there's a problem.</span>
<a href="#l12.198"></a><span id="l12.198" class="difflineminus">-    do_timeout(10000, function()</span>
<a href="#l12.199"></a><span id="l12.199" class="difflineminus">-        {</span>
<a href="#l12.200"></a><span id="l12.200" class="difflineminus">-        if (gCurTestNum == test)</span>
<a href="#l12.201"></a><span id="l12.201" class="difflineminus">-          do_throw(&quot;Notifications not received in 10000 ms for operation &quot; + testFn.name);</span>
<a href="#l12.202"></a><span id="l12.202" class="difflineminus">-        }</span>
<a href="#l12.203"></a><span id="l12.203" class="difflineminus">-      );</span>
<a href="#l12.204"></a><span id="l12.204" class="difflineminus">-    try {</span>
<a href="#l12.205"></a><span id="l12.205" class="difflineminus">-    testFn();</span>
<a href="#l12.206"></a><span id="l12.206" class="difflineminus">-    } catch(ex) {</span>
<a href="#l12.207"></a><span id="l12.207" class="difflineminus">-      gServer.stop();</span>
<a href="#l12.208"></a><span id="l12.208" class="difflineminus">-      do_throw ('TEST FAILED ' + ex);</span>
<a href="#l12.209"></a><span id="l12.209" class="difflineminus">-    }</span>
<a href="#l12.210"></a><span id="l12.210" class="difflineminus">-  }</span>
<a href="#l12.211"></a><span id="l12.211" class="difflineminus">-  else</span>
<a href="#l12.212"></a><span id="l12.212" class="difflineminus">-  {</span>
<a href="#l12.213"></a><span id="l12.213" class="difflineminus">-    do_timeout(1000, endTest);</span>
<a href="#l12.214"></a><span id="l12.214" class="difflineminus">-  }</span>
<a href="#l12.215"></a><span id="l12.215" class="difflineplus">+  gIMAPInbox.hierarchyDelimiter = '/';</span>
<a href="#l12.216"></a><span id="l12.216" class="difflineplus">+  gIMAPInbox.verifiedAsOnlineFolder = true;</span>
<a href="#l12.217"></a><span id="l12.217"> }</span>
<a href="#l12.218"></a><span id="l12.218"> </span>
<a href="#l12.219"></a><span id="l12.219"> // nsIMsgCopyServiceListener implementation - runs next test when copy</span>
<a href="#l12.220"></a><span id="l12.220"> // is completed.</span>
<a href="#l12.221"></a><span id="l12.221" class="difflineminus">-var CopyListener =</span>
<a href="#l12.222"></a><span id="l12.222" class="difflineminus">-{</span>
<a href="#l12.223"></a><span id="l12.223" class="difflineplus">+var CopyListener = {</span>
<a href="#l12.224"></a><span id="l12.224">   _expectedStatus : 0,</span>
<a href="#l12.225"></a><span id="l12.225">   OnStartCopy: function() {},</span>
<a href="#l12.226"></a><span id="l12.226">   OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l12.227"></a><span id="l12.227" class="difflineminus">-  SetMessageKey: function(aKey)</span>
<a href="#l12.228"></a><span id="l12.228" class="difflineminus">-  {</span>
<a href="#l12.229"></a><span id="l12.229" class="difflineminus">-  },</span>
<a href="#l12.230"></a><span id="l12.230" class="difflineplus">+  SetMessageKey: function(aKey) {},</span>
<a href="#l12.231"></a><span id="l12.231">   SetMessageId: function(aMessageId) {},</span>
<a href="#l12.232"></a><span id="l12.232" class="difflineminus">-  OnStopCopy: function(aStatus)</span>
<a href="#l12.233"></a><span id="l12.233" class="difflineminus">-  {</span>
<a href="#l12.234"></a><span id="l12.234" class="difflineminus">-    dump(&quot;in OnStopCopy &quot; + gCurTestNum + &quot;\n&quot;);</span>
<a href="#l12.235"></a><span id="l12.235" class="difflineplus">+  OnStopCopy: function(aStatus) {</span>
<a href="#l12.236"></a><span id="l12.236">     // Check: message successfully copied.</span>
<a href="#l12.237"></a><span id="l12.237">     do_check_eq(aStatus, this._expectedStatus);</span>
<a href="#l12.238"></a><span id="l12.238" class="difflineminus">-    // Ugly hack: make sure we don't get stuck in a JS-&gt;C++-&gt;JS-&gt;C++... call stack</span>
<a href="#l12.239"></a><span id="l12.239" class="difflineminus">-    // This can happen with a bunch of synchronous functions grouped together, and</span>
<a href="#l12.240"></a><span id="l12.240" class="difflineminus">-    // can even cause tests to fail because they're still waiting for the listener</span>
<a href="#l12.241"></a><span id="l12.241" class="difflineminus">-    // to return</span>
<a href="#l12.242"></a><span id="l12.242" class="difflineminus">-    do_timeout(0, function(){doTest(++gCurTestNum);});</span>
<a href="#l12.243"></a><span id="l12.243" class="difflineplus">+    async_driver();</span>
<a href="#l12.244"></a><span id="l12.244">   }</span>
<a href="#l12.245"></a><span id="l12.245"> };</span>
<a href="#l12.246"></a><span id="l12.246"> </span>
<a href="#l12.247"></a><span id="l12.247" class="difflineminus">-function endTest()</span>
<a href="#l12.248"></a><span id="l12.248" class="difflineminus">-{</span>
<a href="#l12.249"></a><span id="l12.249" class="difflineminus">-  dump(&quot;in end test\n&quot;);</span>
<a href="#l12.250"></a><span id="l12.250" class="difflineminus">-  // Cleanup, null out everything, close all cached connections and stop the</span>
<a href="#l12.251"></a><span id="l12.251" class="difflineminus">-  // server</span>
<a href="#l12.252"></a><span id="l12.252" class="difflineminus">-  gRootFolder = null;</span>
<a href="#l12.253"></a><span id="l12.253" class="difflineminus">-  gIMAPInbox = null;</span>
<a href="#l12.254"></a><span id="l12.254" class="difflineminus">-  gIMAPTrashFolder = null;</span>
<a href="#l12.255"></a><span id="l12.255" class="difflineminus">-  gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l12.256"></a><span id="l12.256" class="difflineminus">-  gServer.stop();</span>
<a href="#l12.257"></a><span id="l12.257" class="difflineminus">-  let thread = gThreadManager.currentThread;</span>
<a href="#l12.258"></a><span id="l12.258" class="difflineminus">-  while (thread.hasPendingEvents())</span>
<a href="#l12.259"></a><span id="l12.259" class="difflineminus">-    thread.processNextEvent(true);</span>
<a href="#l12.260"></a><span id="l12.260" class="difflineplus">+function teardown() {</span>
<a href="#l12.261"></a><span id="l12.261" class="difflineplus">+  teardownIMAPPump();</span>
<a href="#l12.262"></a><span id="l12.262" class="difflineplus">+}</span>
<a href="#l12.263"></a><span id="l12.263"> </span>
<a href="#l12.264"></a><span id="l12.264" class="difflineminus">-  do_test_finished(); // for the one in run_test()</span>
<a href="#l12.265"></a><span id="l12.265" class="difflineplus">+function run_test() {</span>
<a href="#l12.266"></a><span id="l12.266" class="difflineplus">+  async_run_tests(tests);</span>
<a href="#l12.267"></a><span id="l12.267"> }</span>
<a href="#l12.268"></a><span id="l12.268" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapID.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapID.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -1,20 +1,21 @@</span>
<a href="#l13.4"></a><span id="l13.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l13.5"></a><span id="l13.5"> /*</span>
<a href="#l13.6"></a><span id="l13.6">  * Test to ensure that we handle the RFC2197 ID command.</span>
<a href="#l13.7"></a><span id="l13.7">  */</span>
<a href="#l13.8"></a><span id="l13.8"> </span>
<a href="#l13.9"></a><span id="l13.9" class="difflineplus">+load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineplus">+load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineplus">+load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+</span>
<a href="#l13.14"></a><span id="l13.14"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l13.15"></a><span id="l13.15"> </span>
<a href="#l13.16"></a><span id="l13.16" class="difflineminus">-var gIMAPDaemon, gServer, gIMAPIncomingServer;</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">-</span>
<a href="#l13.18"></a><span id="l13.18"> const kIDResponse = &quot;(\&quot;name\&quot; \&quot;GImap\&quot; \&quot;vendor\&quot; \&quot;Google, Inc.\&quot; \&quot;support-url\&quot; \&quot;http://mail.google.com/support\&quot;)&quot;;</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineminus">-var gIMAPInbox;</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineminus">-var gTest;</span>
<a href="#l13.21"></a><span id="l13.21"> </span>
<a href="#l13.22"></a><span id="l13.22"> const XULAPPINFO_CONTRACTID = &quot;@mozilla.org/xre/app-info;1&quot;;</span>
<a href="#l13.23"></a><span id="l13.23"> const XULAPPINFO_CID = Components.ID(&quot;{7e10a36e-1085-4302-9e3f-9571fc003ee0}&quot;);</span>
<a href="#l13.24"></a><span id="l13.24"> </span>
<a href="#l13.25"></a><span id="l13.25"> var gAppInfo = null;</span>
<a href="#l13.26"></a><span id="l13.26"> </span>
<a href="#l13.27"></a><span id="l13.27"> function createAppInfo(id, name, version, platformVersion) {</span>
<a href="#l13.28"></a><span id="l13.28">   gAppInfo = {</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineat">@@ -39,117 +40,40 @@ function createAppInfo(id, name, version</span>
<a href="#l13.30"></a><span id="l13.30">     }</span>
<a href="#l13.31"></a><span id="l13.31">   };</span>
<a href="#l13.32"></a><span id="l13.32">   var registrar = Components.manager.QueryInterface(Components.interfaces.nsIComponentRegistrar);</span>
<a href="#l13.33"></a><span id="l13.33">   registrar.registerFactory(XULAPPINFO_CID, &quot;XULAppInfo&quot;,</span>
<a href="#l13.34"></a><span id="l13.34">                             XULAPPINFO_CONTRACTID, XULAppInfoFactory);</span>
<a href="#l13.35"></a><span id="l13.35"> </span>
<a href="#l13.36"></a><span id="l13.36"> }</span>
<a href="#l13.37"></a><span id="l13.37"> </span>
<a href="#l13.38"></a><span id="l13.38" class="difflineminus">-const gTestArray =</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineminus">-[</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+var tests = [</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+  setup,</span>
<a href="#l13.42"></a><span id="l13.42">   function updateInbox() {</span>
<a href="#l13.43"></a><span id="l13.43">     let rootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineminus">-    gIMAPInbox.updateFolderWithListener(null, UrlListener);</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+    gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+    yield false;</span>
<a href="#l13.47"></a><span id="l13.47">   },</span>
<a href="#l13.48"></a><span id="l13.48">   function checkIDHandling() {</span>
<a href="#l13.49"></a><span id="l13.49">     do_check_eq(gIMAPDaemon.clientID, &quot;(\&quot;name\&quot; \&quot;XPCShell\&quot; \&quot;version\&quot; \&quot;5\&quot;)&quot;);</span>
<a href="#l13.50"></a><span id="l13.50">     do_check_eq(gIMAPIncomingServer.serverIDPref, kIDResponse);</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineminus">-    doTest(++gTest);</span>
<a href="#l13.52"></a><span id="l13.52">   },</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+  teardown</span>
<a href="#l13.54"></a><span id="l13.54"> ]</span>
<a href="#l13.55"></a><span id="l13.55"> </span>
<a href="#l13.56"></a><span id="l13.56" class="difflineminus">-function run_test()</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineminus">-{</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+function setup() {</span>
<a href="#l13.59"></a><span id="l13.59">   createAppInfo(&quot;xpcshell@tests.mozilla.org&quot;, &quot;XPCShell&quot;, &quot;5&quot;, &quot;2.0&quot;);</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineminus">-  gTest = 0;</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineminus">-  loadLocalMailAccount();</span>
<a href="#l13.62"></a><span id="l13.62"> </span>
<a href="#l13.63"></a><span id="l13.63" class="difflineminus">-  /*</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineminus">-   * Set up an IMAP server.</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineminus">-   */</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineminus">-  gIMAPDaemon = new imapDaemon();</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineplus">+  setupIMAPPump(&quot;GMail&quot;);</span>
<a href="#l13.68"></a><span id="l13.68">   gIMAPDaemon.idResponse = kIDResponse;</span>
<a href="#l13.69"></a><span id="l13.69"> </span>
<a href="#l13.70"></a><span id="l13.70" class="difflineminus">-  gServer = makeServer(gIMAPDaemon, &quot;GMail&quot;);</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineminus">-  gIMAPIncomingServer = createLocalIMAPServer();</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineminus">-  gIMAPIncomingServer.maximumConnectionsNumber = 1;</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineminus">-</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineminus">-  // We need an identity so that updateFolder doesn't fail</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineminus">-  let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineminus">-  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineminus">-  let localAccount = acctMgr.createAccount();</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineminus">-  let identity = acctMgr.createIdentity();</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineminus">-  localAccount.addIdentity(identity);</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineminus">-  localAccount.defaultIdentity = identity;</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineminus">-  localAccount.incomingServer = gLocalIncomingServer;</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineminus">-  acctMgr.defaultAccount = localAccount;</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineminus">-  </span>
<a href="#l13.84"></a><span id="l13.84" class="difflineminus">-  // Let's also have another account, using the same identity</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineminus">-  let imapAccount = acctMgr.createAccount();</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineminus">-  imapAccount.addIdentity(identity);</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineminus">-  imapAccount.defaultIdentity = identity;</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineminus">-  imapAccount.incomingServer = gIMAPIncomingServer;</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineminus">-  </span>
<a href="#l13.90"></a><span id="l13.90" class="difflineminus">-  // pref tuning: one connection only, turn off notifications</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineminus">-  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineminus">-                     .getService(Ci.nsIPrefBranch);</span>
<a href="#l13.93"></a><span id="l13.93" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineminus">-</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineminus">-  do_test_pending();</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineminus">-</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineminus">-  // Get the IMAP inbox...</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineminus">-  let rootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineminus">-  gIMAPInbox = rootFolder.getFolderWithFlags(Ci.nsMsgFolderFlags.Inbox)</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineminus">-                         .QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineminus">-</span>
<a href="#l13.105"></a><span id="l13.105">   // update folder to kick start tests.</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, UrlListener);</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineplus">+  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineplus">+  yield false;</span>
<a href="#l13.109"></a><span id="l13.109"> }</span>
<a href="#l13.110"></a><span id="l13.110"> </span>
<a href="#l13.111"></a><span id="l13.111" class="difflineminus">-var UrlListener = </span>
<a href="#l13.112"></a><span id="l13.112" class="difflineminus">-{</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineminus">-  OnStartRunningUrl: function(url) { },</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineminus">-  OnStopRunningUrl: function(url, rc)</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineminus">-  {</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineminus">-    // Check for ok status.</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineminus">-    do_check_eq(rc, 0);</span>
<a href="#l13.118"></a><span id="l13.118" class="difflineminus">-    // chain tests with interval in between so we'll go idle.</span>
<a href="#l13.119"></a><span id="l13.119" class="difflineminus">-    do_timeout_function(100, function(){doTest(++gTest)});</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineminus">-  }</span>
<a href="#l13.121"></a><span id="l13.121" class="difflineminus">-};</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineminus">-</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineminus">-function doTest(test)</span>
<a href="#l13.124"></a><span id="l13.124" class="difflineminus">-{</span>
<a href="#l13.125"></a><span id="l13.125" class="difflineminus">-  if (test &lt;= gTestArray.length)</span>
<a href="#l13.126"></a><span id="l13.126" class="difflineminus">-  {</span>
<a href="#l13.127"></a><span id="l13.127" class="difflineminus">-    dump(&quot;Doing test &quot; + test + &quot;\n&quot;);</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineminus">-    gTest = test;</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineminus">-</span>
<a href="#l13.130"></a><span id="l13.130" class="difflineminus">-    var testFn = gTestArray[test - 1];</span>
<a href="#l13.131"></a><span id="l13.131" class="difflineminus">-    // Set a limit of ten seconds; if the notifications haven't arrived by then there's a problem.</span>
<a href="#l13.132"></a><span id="l13.132" class="difflineminus">-    try {</span>
<a href="#l13.133"></a><span id="l13.133" class="difflineminus">-      testFn();</span>
<a href="#l13.134"></a><span id="l13.134" class="difflineminus">-    } catch(ex) {</span>
<a href="#l13.135"></a><span id="l13.135" class="difflineminus">-      gServer.stop();</span>
<a href="#l13.136"></a><span id="l13.136" class="difflineminus">-      do_throw ('TEST FAILED ' + ex);</span>
<a href="#l13.137"></a><span id="l13.137" class="difflineminus">-    }</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineminus">-  }</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineminus">-  else</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineminus">-  {</span>
<a href="#l13.141"></a><span id="l13.141" class="difflineminus">-    do_timeout_function(1000, endTest);</span>
<a href="#l13.142"></a><span id="l13.142" class="difflineminus">-  }</span>
<a href="#l13.143"></a><span id="l13.143" class="difflineplus">+function teardown() {</span>
<a href="#l13.144"></a><span id="l13.144" class="difflineplus">+  teardownIMAPPump();</span>
<a href="#l13.145"></a><span id="l13.145"> }</span>
<a href="#l13.146"></a><span id="l13.146"> </span>
<a href="#l13.147"></a><span id="l13.147" class="difflineminus">-function endTest()</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineminus">-{</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineminus">-  gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineminus">-  gServer.stop();</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineminus">-</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineminus">-  var thread = gThreadManager.currentThread;</span>
<a href="#l13.153"></a><span id="l13.153" class="difflineminus">-  while (thread.hasPendingEvents())</span>
<a href="#l13.154"></a><span id="l13.154" class="difflineminus">-    thread.processNextEvent(true);</span>
<a href="#l13.155"></a><span id="l13.155" class="difflineminus">-</span>
<a href="#l13.156"></a><span id="l13.156" class="difflineminus">-  do_test_finished();</span>
<a href="#l13.157"></a><span id="l13.157" class="difflineplus">+function run_test() {</span>
<a href="#l13.158"></a><span id="l13.158" class="difflineplus">+  async_run_tests(tests);</span>
<a href="#l13.159"></a><span id="l13.159"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapMove.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapMove.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -40,17 +40,17 @@ function startTest()</span>
<a href="#l14.4"></a><span id="l14.4">   messages = messages.concat(gMessageGenerator.makeMessage());</span>
<a href="#l14.5"></a><span id="l14.5">   gSynthMessage = messages[0];</span>
<a href="#l14.6"></a><span id="l14.6">   let dataUri = Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l14.7"></a><span id="l14.7">                   btoa(messages[0].toMessageString()),</span>
<a href="#l14.8"></a><span id="l14.8">                   null, null);</span>
<a href="#l14.9"></a><span id="l14.9">   let imapMsg = new imapMessage(dataUri.spec, gIMAPMailbox.uidnext++, []);</span>
<a href="#l14.10"></a><span id="l14.10">   gIMAPMailbox.addMessage(imapMsg);</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, UrlListener);</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l14.14"></a><span id="l14.14">   yield false;</span>
<a href="#l14.15"></a><span id="l14.15"> }</span>
<a href="#l14.16"></a><span id="l14.16"> </span>
<a href="#l14.17"></a><span id="l14.17"> function doMove() {</span>
<a href="#l14.18"></a><span id="l14.18">   let rootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l14.19"></a><span id="l14.19">   gFolder1 = rootFolder.getChildNamed(&quot;folder 1&quot;)</span>
<a href="#l14.20"></a><span id="l14.20">                .QueryInterface(Components.interfaces.nsIMsgImapMailFolder);</span>
<a href="#l14.21"></a><span id="l14.21">   let msg = gIMAPInbox.msgDatabase.GetMsgHdrForKey(gIMAPMailbox.uidnext - 1);</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineat">@@ -59,30 +59,22 @@ function doMove() {</span>
<a href="#l14.23"></a><span id="l14.23">   MailServices.copy.CopyMessages(gIMAPInbox, gMessages, gFolder1, true,</span>
<a href="#l14.24"></a><span id="l14.24">                             asyncCopyListener, null, false);</span>
<a href="#l14.25"></a><span id="l14.25">   gIMAPServer.performTest(&quot;UID MOVE&quot;);</span>
<a href="#l14.26"></a><span id="l14.26">   yield false;</span>
<a href="#l14.27"></a><span id="l14.27"> }</span>
<a href="#l14.28"></a><span id="l14.28"> </span>
<a href="#l14.29"></a><span id="l14.29"> function testMove() {</span>
<a href="#l14.30"></a><span id="l14.30">   do_check_eq(gIMAPInbox.getTotalMessages(false), 0);</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-  gFolder1.updateFolderWithListener(null, UrlListener);</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+  gFolder1.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l14.33"></a><span id="l14.33">   yield false;</span>
<a href="#l14.34"></a><span id="l14.34">   do_check_eq(gFolder1.getTotalMessages(false), 1);</span>
<a href="#l14.35"></a><span id="l14.35">   yield true;</span>
<a href="#l14.36"></a><span id="l14.36"> }</span>
<a href="#l14.37"></a><span id="l14.37"> </span>
<a href="#l14.38"></a><span id="l14.38" class="difflineminus">-var UrlListener = {</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineminus">-  OnStartRunningUrl: function _OnStartRunningUrl(aUrl) {</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">-  },</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineminus">-  OnStopRunningUrl: function _OnStopRunningUrl(aUrl, aExitCode) {</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineminus">-    async_driver();</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineminus">-  }</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineminus">-};</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineminus">-</span>
<a href="#l14.46"></a><span id="l14.46"> var mfnListener =</span>
<a href="#l14.47"></a><span id="l14.47"> {</span>
<a href="#l14.48"></a><span id="l14.48">   folderAdded: function folderAdded(aFolder)</span>
<a href="#l14.49"></a><span id="l14.49">   {</span>
<a href="#l14.50"></a><span id="l14.50">     // we are only using async yield on the target folder add</span>
<a href="#l14.51"></a><span id="l14.51">     if (aFolder.name == &quot;folder 1&quot;)</span>
<a href="#l14.52"></a><span id="l14.52">       async_driver();</span>
<a href="#l14.53"></a><span id="l14.53">   },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapStatusCloseDBs.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapStatusCloseDBs.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -1,58 +1,54 @@</span>
<a href="#l15.4"></a><span id="l15.4"> // This file tests that checking folders for new mail with STATUS</span>
<a href="#l15.5"></a><span id="l15.5"> // doesn't leave db's open.</span>
<a href="#l15.6"></a><span id="l15.6"> </span>
<a href="#l15.7"></a><span id="l15.7" class="difflineminus">-var gServer, gImapServer;</span>
<a href="#l15.8"></a><span id="l15.8" class="difflineminus">-var gIMAPInbox, gIMAPFolder1, gIMAPFolder2;</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineplus">+load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineplus">+load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l15.11"></a><span id="l15.11" class="difflineplus">+load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l15.13"></a><span id="l15.13"> </span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">-function run_test() {</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineminus">-  var daemon = new imapDaemon();</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineminus">-  daemon.createMailbox(&quot;folder 1&quot;, {subscribed : true});</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">-  daemon.createMailbox(&quot;folder 2&quot;, {subscribed : true});</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">-  gServer = makeServer(daemon, &quot;&quot;);</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineminus">-</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineminus">-  gImapServer = createLocalIMAPServer();</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineminus">-  gImapServer.maximumConnectionsNumber = 1;</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineplus">+var gFolder1, gFolder2;</span>
<a href="#l15.23"></a><span id="l15.23"> </span>
<a href="#l15.24"></a><span id="l15.24" class="difflineminus">-  // Get the folder list...</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineminus">-  gImapServer.performExpand(null);</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineminus">-  gServer.performTest(&quot;SUBSCRIBE&quot;);</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineplus">+var tests = [</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineplus">+  setup,</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineplus">+  check,</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+  teardown</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+];</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+function setup() {</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.check_all_imap_folders_for_new&quot;, true);</span>
<a href="#l15.35"></a><span id="l15.35"> </span>
<a href="#l15.36"></a><span id="l15.36" class="difflineminus">-  // pref tuning: one connection only, turn off notifications</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineminus">-  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineminus">-                     .getService(Ci.nsIPrefBranch);</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.check_all_imap_folders_for_new&quot;, true);</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineminus">-  // Make sure no biff notifications happen</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+  setupIMAPPump();</span>
<a href="#l15.46"></a><span id="l15.46"> </span>
<a href="#l15.47"></a><span id="l15.47" class="difflineminus">-  let rootFolder = gImapServer.rootFolder;</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineminus">-  gIMAPInbox = rootFolder.getFolderWithFlags(Ci.nsMsgFolderFlags.Inbox);</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineplus">+  gIMAPDaemon.createMailbox(&quot;folder 1&quot;, {subscribed : true});</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineplus">+  gIMAPDaemon.createMailbox(&quot;folder 2&quot;, {subscribed : true});</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineplus">+  gIMAPServer.performTest(&quot;SUBSCRIBE&quot;);</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineplus">+</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineplus">+  let rootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l15.55"></a><span id="l15.55">   gFolder1 = rootFolder.getChildNamed(&quot;folder 1&quot;);</span>
<a href="#l15.56"></a><span id="l15.56">   gFolder2 = rootFolder.getChildNamed(&quot;folder 2&quot;);</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineminus">-  do_test_pending();</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineplus">+</span>
<a href="#l15.59"></a><span id="l15.59">   gIMAPInbox.getNewMessages(null, null);</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineminus">-  gServer.performTest(&quot;STATUS&quot;);</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineplus">+  gIMAPServer.performTest(&quot;STATUS&quot;);</span>
<a href="#l15.62"></a><span id="l15.62">   // don't know if this will work, but we'll try. Wait for</span>
<a href="#l15.63"></a><span id="l15.63">   // second status response</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineminus">-  gServer.performTest(&quot;STATUS&quot;);</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineminus">-  do_timeout_function(1000, endTest);</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineplus">+  gIMAPServer.performTest(&quot;STATUS&quot;);</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineplus">+  do_timeout_function(1000, async_driver);</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineplus">+  yield false;</span>
<a href="#l15.69"></a><span id="l15.69"> }</span>
<a href="#l15.70"></a><span id="l15.70"> </span>
<a href="#l15.71"></a><span id="l15.71" class="difflineminus">-function endTest()</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineminus">-{</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineplus">+function check() {</span>
<a href="#l15.74"></a><span id="l15.74">   const gDbService = Cc[&quot;@mozilla.org/msgDatabase/msgDBService;1&quot;]</span>
<a href="#l15.75"></a><span id="l15.75">                        .getService(Ci.nsIMsgDBService);</span>
<a href="#l15.76"></a><span id="l15.76">   do_check_neq(gDbService.cachedDBForFolder(gIMAPInbox), null);</span>
<a href="#l15.77"></a><span id="l15.77">   do_check_eq(gDbService.cachedDBForFolder(gFolder1), null);</span>
<a href="#l15.78"></a><span id="l15.78">   do_check_eq(gDbService.cachedDBForFolder(gFolder2), null);</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineplus">+}</span>
<a href="#l15.80"></a><span id="l15.80"> </span>
<a href="#l15.81"></a><span id="l15.81" class="difflineminus">-  // Clean up the server in preparation</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineminus">-  gServer.resetTest();</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineminus">-  gImapServer.closeCachedConnections();</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineminus">-  gServer.performTest();</span>
<a href="#l15.85"></a><span id="l15.85" class="difflineminus">-  gServer.stop();</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineplus">+function teardown() {</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineplus">+  teardownIMAPPump();</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineplus">+}</span>
<a href="#l15.89"></a><span id="l15.89"> </span>
<a href="#l15.90"></a><span id="l15.90" class="difflineminus">-  do_test_finished();</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineplus">+function run_test() {</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineplus">+  async_run_tests(tests);</span>
<a href="#l15.93"></a><span id="l15.93"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapStoreMsgOffline.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapStoreMsgOffline.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -5,37 +5,30 @@</span>
<a href="#l16.4"></a><span id="l16.4">  *   - Normal messages, no attachments.</span>
<a href="#l16.5"></a><span id="l16.5">  *   - Message with inline attachment (e.g., image)</span>
<a href="#l16.6"></a><span id="l16.6">  *   - Message with non-inline attachment (e.g., .doc file)</span>
<a href="#l16.7"></a><span id="l16.7">  *   - Message with mix of attachment types.</span>
<a href="#l16.8"></a><span id="l16.8">  */</span>
<a href="#l16.9"></a><span id="l16.9"> </span>
<a href="#l16.10"></a><span id="l16.10"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l16.14"></a><span id="l16.14"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l16.15"></a><span id="l16.15"> </span>
<a href="#l16.16"></a><span id="l16.16"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l16.17"></a><span id="l16.17"> load(&quot;../../../resources/messageModifier.js&quot;);</span>
<a href="#l16.18"></a><span id="l16.18"> load(&quot;../../../resources/messageInjection.js&quot;);</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineplus">+load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l16.20"></a><span id="l16.20"> </span>
<a href="#l16.21"></a><span id="l16.21"> var gMessageGenerator = new MessageGenerator();</span>
<a href="#l16.22"></a><span id="l16.22"> var gScenarioFactory = new MessageScenarioFactory(gMessageGenerator);</span>
<a href="#l16.23"></a><span id="l16.23"> </span>
<a href="#l16.24"></a><span id="l16.24"> const nsMsgMessageFlags = Ci.nsMsgMessageFlags;</span>
<a href="#l16.25"></a><span id="l16.25"> </span>
<a href="#l16.26"></a><span id="l16.26" class="difflineminus">-var gServer;</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineminus">-var gIMAPDaemon;</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineminus">-var gIMAPInbox;</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineminus">-var gIMAPIncomingServer;</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineminus">-var gIMAPTrashFolder;</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-var gMessenger;</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineminus">-var gMsgWindow;</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineminus">-var gRootFolder;</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineminus">-var gCurTestNum;</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineminus">-</span>
<a href="#l16.36"></a><span id="l16.36"> var gMsgFile1 = do_get_file(&quot;../../../data/bugmail10&quot;);</span>
<a href="#l16.37"></a><span id="l16.37"> const gMsgId1 = &quot;200806061706.m56H6RWT004933@mrapp54.mozilla.org&quot;;</span>
<a href="#l16.38"></a><span id="l16.38"> var gMsgFile2 = do_get_file(&quot;../../../data/image-attach-test&quot;);</span>
<a href="#l16.39"></a><span id="l16.39"> const gMsgId2 = &quot;4A947F73.5030709@xxx.com&quot;;</span>
<a href="#l16.40"></a><span id="l16.40"> var gMsgFile3 = do_get_file(&quot;../../../data/external-attach-test&quot;);</span>
<a href="#l16.41"></a><span id="l16.41"> const gMsgId3 = &quot;876TY.5030709@xxx.com&quot;;</span>
<a href="#l16.42"></a><span id="l16.42"> </span>
<a href="#l16.43"></a><span id="l16.43"> var gFirstNewMsg;</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineat">@@ -83,149 +76,104 @@ function addMessagesToServer(messages, m</span>
<a href="#l16.45"></a><span id="l16.45"> </span>
<a href="#l16.46"></a><span id="l16.46">   // Create the imapMessages and store them on the mailbox</span>
<a href="#l16.47"></a><span id="l16.47">   messages.forEach(function (message)</span>
<a href="#l16.48"></a><span id="l16.48">   {</span>
<a href="#l16.49"></a><span id="l16.49">     mailbox.addMessage(new imapMessage(message.spec, mailbox.uidnext++, []));</span>
<a href="#l16.50"></a><span id="l16.50">   });</span>
<a href="#l16.51"></a><span id="l16.51"> }</span>
<a href="#l16.52"></a><span id="l16.52"> </span>
<a href="#l16.53"></a><span id="l16.53" class="difflineminus">-var incomingServer, server;</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineminus">-function run_test() {</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineminus">-  // The server doesn't support more than one connection</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineminus">-  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineminus">-                     .getService(Ci.nsIPrefBranch);</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineminus">-  prefBranch.setIntPref(&quot;mail.server.server1.max_cached_connections&quot;, 1);</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineminus">-  // Make sure no biff notifications happen</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineplus">+function setup() {</span>
<a href="#l16.65"></a><span id="l16.65">   // We aren't interested in downloading messages automatically</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.server.server1.download_on_biff&quot;, false);</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.server.server1.autosync_offline_stores&quot;, false);</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.server.server1.offline_download&quot;, true);</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.server.server1.autosync_offline_stores&quot;, false);</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.server.server1.offline_download&quot;, true);</span>
<a href="#l16.71"></a><span id="l16.71">   // make small threshhold for mpod so our test messages don't have to be big.</span>
<a href="#l16.72"></a><span id="l16.72">   // XXX We can't set this pref until the fake server supports body structure.</span>
<a href="#l16.73"></a><span id="l16.73">   // So for now, we'll leave it at the default value, which is larger than any of</span>
<a href="#l16.74"></a><span id="l16.74">   // our test messages.</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineminus">-  // prefBranch.setIntPref(&quot;mail.imap.mime_parts_on_demand_threshold&quot;, 3000);</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineminus">-</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineminus">-  gIMAPDaemon = new imapDaemon();</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineminus">-  gServer = makeServer(gIMAPDaemon, &quot;&quot;);</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineminus">-</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineminus">-  gIMAPIncomingServer = createLocalIMAPServer();</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineminus">-</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineminus">-  loadLocalMailAccount();</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineplus">+  // Services.prefs.setIntPref(&quot;mail.imap.mime_parts_on_demand_threshold&quot;, 3000);</span>
<a href="#l16.84"></a><span id="l16.84"> </span>
<a href="#l16.85"></a><span id="l16.85" class="difflineminus">-  // We need an identity so that updateFolder doesn't fail</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineminus">-  let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineminus">-                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineminus">-  let localAccount = acctMgr.createAccount();</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineminus">-  let identity = acctMgr.createIdentity();</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineminus">-  localAccount.addIdentity(identity);</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineminus">-  localAccount.defaultIdentity = identity;</span>
<a href="#l16.92"></a><span id="l16.92" class="difflineminus">-  localAccount.incomingServer = gLocalIncomingServer;</span>
<a href="#l16.93"></a><span id="l16.93" class="difflineminus">-  acctMgr.defaultAccount = localAccount;</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineplus">+  setupIMAPPump();</span>
<a href="#l16.95"></a><span id="l16.95"> </span>
<a href="#l16.96"></a><span id="l16.96" class="difflineminus">-  // Let's also have another account, using the same identity</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineminus">-  let imapAccount = acctMgr.createAccount();</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineminus">-  imapAccount.addIdentity(identity);</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineminus">-  imapAccount.defaultIdentity = identity;</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineminus">-  imapAccount.incomingServer = gIMAPIncomingServer;</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineminus">-</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineminus">-  gMessenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineminus">-</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineminus">-  gMsgWindow = Cc[&quot;@mozilla.org/messenger/msgwindow;1&quot;]</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineminus">-                  .createInstance(Components.interfaces.nsIMsgWindow);</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineminus">-</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineminus">-  // Get the server list...</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineminus">-  gIMAPIncomingServer.performExpand(null);</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineminus">-</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineminus">-  gRootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l16.111"></a><span id="l16.111" class="difflineminus">-  gIMAPInbox = gRootFolder.getChildNamed(&quot;INBOX&quot;);</span>
<a href="#l16.112"></a><span id="l16.112" class="difflineminus">-  let msgImapFolder = gIMAPInbox.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l16.113"></a><span id="l16.113">   // these hacks are required because we've created the inbox before</span>
<a href="#l16.114"></a><span id="l16.114">   // running initial folder discovery, and adding the folder bails</span>
<a href="#l16.115"></a><span id="l16.115">   // out before we set it as verified online, so we bail out, and</span>
<a href="#l16.116"></a><span id="l16.116">   // then remove the INBOX folder since it's not verified.</span>
<a href="#l16.117"></a><span id="l16.117" class="difflineminus">-  msgImapFolder.hierarchyDelimiter = '/';</span>
<a href="#l16.118"></a><span id="l16.118" class="difflineminus">-  msgImapFolder.verifiedAsOnlineFolder = true;</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineplus">+  gIMAPInbox.hierarchyDelimiter = '/';</span>
<a href="#l16.120"></a><span id="l16.120" class="difflineplus">+  gIMAPInbox.verifiedAsOnlineFolder = true;</span>
<a href="#l16.121"></a><span id="l16.121"> </span>
<a href="#l16.122"></a><span id="l16.122"> </span>
<a href="#l16.123"></a><span id="l16.123">   // Add a couple of messages to the INBOX</span>
<a href="#l16.124"></a><span id="l16.124">   // this is synchronous, afaik</span>
<a href="#l16.125"></a><span id="l16.125">   addMessagesToServer([{file: gMsgFile1, messageId: gMsgId1},</span>
<a href="#l16.126"></a><span id="l16.126">                         {file: gMsgFile2, messageId: gMsgId2},</span>
<a href="#l16.127"></a><span id="l16.127">                         {file: gMsgFile3, messageId: gMsgId3},</span>
<a href="#l16.128"></a><span id="l16.128"> //                         {file: gMsgFile5, messageId: gMsgId5},</span>
<a href="#l16.129"></a><span id="l16.129">                       ],</span>
<a href="#l16.130"></a><span id="l16.130">                         gIMAPDaemon.getMailbox(&quot;INBOX&quot;), gIMAPInbox);</span>
<a href="#l16.131"></a><span id="l16.131" class="difflineminus">-  // &quot;Master&quot; do_test_pending(), paired with a do_test_finished() at the end of</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineminus">-  // all the operations.</span>
<a href="#l16.133"></a><span id="l16.133" class="difflineminus">-  do_test_pending();</span>
<a href="#l16.134"></a><span id="l16.134" class="difflineminus">-  //start first test</span>
<a href="#l16.135"></a><span id="l16.135" class="difflineminus">-  doTest(1);</span>
<a href="#l16.136"></a><span id="l16.136"> }</span>
<a href="#l16.137"></a><span id="l16.137"> </span>
<a href="#l16.138"></a><span id="l16.138"> var gIMAPService;</span>
<a href="#l16.139"></a><span id="l16.139"> </span>
<a href="#l16.140"></a><span id="l16.140" class="difflineminus">-const gTestArray =</span>
<a href="#l16.141"></a><span id="l16.141" class="difflineminus">-[</span>
<a href="#l16.142"></a><span id="l16.142" class="difflineplus">+var tests = [</span>
<a href="#l16.143"></a><span id="l16.143" class="difflineplus">+  setup,</span>
<a href="#l16.144"></a><span id="l16.144">   function updateFolder() {</span>
<a href="#l16.145"></a><span id="l16.145" class="difflineminus">-    gIMAPInbox.updateFolderWithListener(null, URLListener);</span>
<a href="#l16.146"></a><span id="l16.146" class="difflineplus">+    gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l16.147"></a><span id="l16.147" class="difflineplus">+    yield false;</span>
<a href="#l16.148"></a><span id="l16.148">   },</span>
<a href="#l16.149"></a><span id="l16.149">   function selectFirstMsg() {</span>
<a href="#l16.150"></a><span id="l16.150"> </span>
<a href="#l16.151"></a><span id="l16.151">   // We postpone creating the imap service until after we've set the prefs</span>
<a href="#l16.152"></a><span id="l16.152">   // that it reads on its startup.</span>
<a href="#l16.153"></a><span id="l16.153">   gIMAPService = Cc[&quot;@mozilla.org/messenger/messageservice;1?type=imap&quot;]</span>
<a href="#l16.154"></a><span id="l16.154">                        .getService(Ci.nsIMsgMessageService);</span>
<a href="#l16.155"></a><span id="l16.155"> </span>
<a href="#l16.156"></a><span id="l16.156">     let db = gIMAPInbox.msgDatabase;</span>
<a href="#l16.157"></a><span id="l16.157">     let msg1 = db.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l16.158"></a><span id="l16.158">     let url = new Object;</span>
<a href="#l16.159"></a><span id="l16.159">     gIMAPService.DisplayMessage(gIMAPInbox.getUriForMsg(msg1),</span>
<a href="#l16.160"></a><span id="l16.160">                                             streamListener,</span>
<a href="#l16.161"></a><span id="l16.161">                                             null,</span>
<a href="#l16.162"></a><span id="l16.162" class="difflineminus">-                                            URLListener,</span>
<a href="#l16.163"></a><span id="l16.163" class="difflineplus">+                                            asyncUrlListener,</span>
<a href="#l16.164"></a><span id="l16.164">                                             null,</span>
<a href="#l16.165"></a><span id="l16.165">                                             url);</span>
<a href="#l16.166"></a><span id="l16.166" class="difflineplus">+    yield false;</span>
<a href="#l16.167"></a><span id="l16.167">   },</span>
<a href="#l16.168"></a><span id="l16.168">   function select2ndMsg() {</span>
<a href="#l16.169"></a><span id="l16.169">     let msg1 = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l16.170"></a><span id="l16.170">     do_check_neq(msg1.flags &amp; nsMsgMessageFlags.Offline, 0);</span>
<a href="#l16.171"></a><span id="l16.171">     let db = gIMAPInbox.msgDatabase;</span>
<a href="#l16.172"></a><span id="l16.172">     let msg2 = db.getMsgHdrForMessageID(gMsgId2);</span>
<a href="#l16.173"></a><span id="l16.173">     let url = new Object;</span>
<a href="#l16.174"></a><span id="l16.174">     gIMAPService.DisplayMessage(gIMAPInbox.getUriForMsg(msg2),</span>
<a href="#l16.175"></a><span id="l16.175">                                             streamListener,</span>
<a href="#l16.176"></a><span id="l16.176">                                             null,</span>
<a href="#l16.177"></a><span id="l16.177" class="difflineminus">-                                            URLListener,</span>
<a href="#l16.178"></a><span id="l16.178" class="difflineplus">+                                            asyncUrlListener,</span>
<a href="#l16.179"></a><span id="l16.179">                                             null,</span>
<a href="#l16.180"></a><span id="l16.180">                                             url);</span>
<a href="#l16.181"></a><span id="l16.181" class="difflineplus">+    yield false;</span>
<a href="#l16.182"></a><span id="l16.182">   },</span>
<a href="#l16.183"></a><span id="l16.183">   function select3rdMsg() {</span>
<a href="#l16.184"></a><span id="l16.184">     let msg2 = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gMsgId2);</span>
<a href="#l16.185"></a><span id="l16.185">     do_check_neq(msg2.flags &amp; nsMsgMessageFlags.Offline, 0);</span>
<a href="#l16.186"></a><span id="l16.186">     let db = gIMAPInbox.msgDatabase;</span>
<a href="#l16.187"></a><span id="l16.187">     let msg3 = db.getMsgHdrForMessageID(gMsgId3);</span>
<a href="#l16.188"></a><span id="l16.188">     let url = new Object;</span>
<a href="#l16.189"></a><span id="l16.189">     gIMAPService.DisplayMessage(gIMAPInbox.getUriForMsg(msg3),</span>
<a href="#l16.190"></a><span id="l16.190">                                             streamListener,</span>
<a href="#l16.191"></a><span id="l16.191">                                             null,</span>
<a href="#l16.192"></a><span id="l16.192" class="difflineminus">-                                            URLListener,</span>
<a href="#l16.193"></a><span id="l16.193" class="difflineplus">+                                            asyncUrlListener,</span>
<a href="#l16.194"></a><span id="l16.194">                                             null,</span>
<a href="#l16.195"></a><span id="l16.195">                                             url);</span>
<a href="#l16.196"></a><span id="l16.196" class="difflineplus">+    yield false;</span>
<a href="#l16.197"></a><span id="l16.197">   },</span>
<a href="#l16.198"></a><span id="l16.198">   function verify3rdMsg() {</span>
<a href="#l16.199"></a><span id="l16.199">     let msg3 = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gMsgId3);</span>
<a href="#l16.200"></a><span id="l16.200">     // can't turn this on because our fake server doesn't support body structure.</span>
<a href="#l16.201"></a><span id="l16.201"> //    do_check_eq(msg3.flags &amp; nsMsgMessageFlags.Offline, 0);</span>
<a href="#l16.202"></a><span id="l16.202" class="difflineminus">-    do_timeout(0, function(){doTest(++gCurTestNum)});</span>
<a href="#l16.203"></a><span id="l16.203">   },</span>
<a href="#l16.204"></a><span id="l16.204">   function addNewMsgs() {</span>
<a href="#l16.205"></a><span id="l16.205">     let mbox = gIMAPDaemon.getMailbox(&quot;INBOX&quot;)</span>
<a href="#l16.206"></a><span id="l16.206">     // make a couple messges</span>
<a href="#l16.207"></a><span id="l16.207">     let messages = [];</span>
<a href="#l16.208"></a><span id="l16.208">     let bodyString = &quot;&quot;;</span>
<a href="#l16.209"></a><span id="l16.209">     for (i = 0; i &lt; 100; i++)</span>
<a href="#l16.210"></a><span id="l16.210">       bodyString += &quot;1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890\r\n&quot;;</span>
<a href="#l16.211"></a><span id="l16.211" class="difflineat">@@ -242,123 +190,73 @@ const gTestArray =</span>
<a href="#l16.212"></a><span id="l16.212"> </span>
<a href="#l16.213"></a><span id="l16.213">     messages.forEach(function (message)</span>
<a href="#l16.214"></a><span id="l16.214">     {</span>
<a href="#l16.215"></a><span id="l16.215">       let dataUri = ioService.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l16.216"></a><span id="l16.216">                                       btoa(message.toMessageString()),</span>
<a href="#l16.217"></a><span id="l16.217">                                      null, null);</span>
<a href="#l16.218"></a><span id="l16.218">       mbox.addMessage(new imapMessage(dataUri.spec, mbox.uidnext++, []));</span>
<a href="#l16.219"></a><span id="l16.219">     });</span>
<a href="#l16.220"></a><span id="l16.220" class="difflineminus">-    gIMAPInbox.updateFolderWithListener(null, URLListener);</span>
<a href="#l16.221"></a><span id="l16.221" class="difflineplus">+    gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l16.222"></a><span id="l16.222" class="difflineplus">+    yield false;</span>
<a href="#l16.223"></a><span id="l16.223">   },</span>
<a href="#l16.224"></a><span id="l16.224">   function testQueuedOfflineDownload()</span>
<a href="#l16.225"></a><span id="l16.225">   {</span>
<a href="#l16.226"></a><span id="l16.226">     // Make sure that streaming the same message and then trying to download</span>
<a href="#l16.227"></a><span id="l16.227">     // it for offline use doesn't end up in it getting added to the offline </span>
<a href="#l16.228"></a><span id="l16.228">     // store twice.</span>
<a href="#l16.229"></a><span id="l16.229">     gImapInboxOfflineStoreSize = gIMAPInbox.filePath.fileSize + gFirstMsgSize;</span>
<a href="#l16.230"></a><span id="l16.230">     let newMsgHdr = gIMAPInbox.GetMessageHeader(gFirstNewMsg);</span>
<a href="#l16.231"></a><span id="l16.231">     let msgURI = newMsgHdr.folder.getUriForMsg(newMsgHdr);</span>
<a href="#l16.232"></a><span id="l16.232">     let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l16.233"></a><span id="l16.233">     let msgServ = messenger.messageServiceFromURI(msgURI);</span>
<a href="#l16.234"></a><span id="l16.234">     msgServ.streamMessage(msgURI, gStreamListener, null, null, false, &quot;&quot;, false);</span>
<a href="#l16.235"></a><span id="l16.235" class="difflineminus">-    let msgs = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l16.236"></a><span id="l16.236" class="difflineminus">-    msgs.appendElement(gIMAPInbox.GetMessageHeader(gFirstNewMsg), false);</span>
<a href="#l16.237"></a><span id="l16.237" class="difflineminus">-    gIMAPInbox.DownloadMessagesForOffline(msgs, null);</span>
<a href="#l16.238"></a><span id="l16.238" class="difflineplus">+    yield false;</span>
<a href="#l16.239"></a><span id="l16.239">   },</span>
<a href="#l16.240"></a><span id="l16.240">   function firstStreamFinished()</span>
<a href="#l16.241"></a><span id="l16.241">   {</span>
<a href="#l16.242"></a><span id="l16.242" class="difflineminus">-    dump(&quot;first stream finished\n&quot;);</span>
<a href="#l16.243"></a><span id="l16.243" class="difflineminus">-    // Wait for a couple seconds for the second download to either start</span>
<a href="#l16.244"></a><span id="l16.244" class="difflineminus">-    // writing to the offline store (failure case), or complete instantly.</span>
<a href="#l16.245"></a><span id="l16.245" class="difflineminus">-    // If DownloadMessagesForOffline took a listener, we wouldn't have to</span>
<a href="#l16.246"></a><span id="l16.246" class="difflineminus">-    // do this.</span>
<a href="#l16.247"></a><span id="l16.247" class="difflineminus">-    do_timeout(2000, function(){doTest(++gCurTestNum);});</span>
<a href="#l16.248"></a><span id="l16.248" class="difflineplus">+    // nsIMsgFolder.DownloadMessagesForOffline does not take a listener, so</span>
<a href="#l16.249"></a><span id="l16.249" class="difflineplus">+    // we invoke nsIImapService.downloadMessagesForOffline directly with a </span>
<a href="#l16.250"></a><span id="l16.250" class="difflineplus">+    // listener.</span>
<a href="#l16.251"></a><span id="l16.251" class="difflineplus">+    MailServices.imap.downloadMessagesForOffline(gFirstNewMsg,</span>
<a href="#l16.252"></a><span id="l16.252" class="difflineplus">+                                                 gIMAPInbox,</span>
<a href="#l16.253"></a><span id="l16.253" class="difflineplus">+                                                 asyncUrlListener,</span>
<a href="#l16.254"></a><span id="l16.254" class="difflineplus">+                                                 null);</span>
<a href="#l16.255"></a><span id="l16.255" class="difflineplus">+    yield false;</span>
<a href="#l16.256"></a><span id="l16.256">   },</span>
<a href="#l16.257"></a><span id="l16.257">   function checkOfflineStoreSize()</span>
<a href="#l16.258"></a><span id="l16.258">   {</span>
<a href="#l16.259"></a><span id="l16.259">     dump(&quot;checking offline store size\n&quot;);</span>
<a href="#l16.260"></a><span id="l16.260">     do_check_true(gIMAPInbox.filePath.fileSize &lt;= gImapInboxOfflineStoreSize);</span>
<a href="#l16.261"></a><span id="l16.261" class="difflineminus">-    do_timeout(0, function(){doTest(++gCurTestNum);});</span>
<a href="#l16.262"></a><span id="l16.262">   },</span>
<a href="#l16.263"></a><span id="l16.263" class="difflineplus">+  teardown</span>
<a href="#l16.264"></a><span id="l16.264"> ]</span>
<a href="#l16.265"></a><span id="l16.265"> </span>
<a href="#l16.266"></a><span id="l16.266"> gStreamListener = {</span>
<a href="#l16.267"></a><span id="l16.267">   QueryInterface : XPCOMUtils.generateQI([Ci.nsIStreamListener]),</span>
<a href="#l16.268"></a><span id="l16.268">   _stream : null,</span>
<a href="#l16.269"></a><span id="l16.269">   _data : null,</span>
<a href="#l16.270"></a><span id="l16.270">   onStartRequest : function (aRequest, aContext) {</span>
<a href="#l16.271"></a><span id="l16.271">     this._data = &quot;&quot;;</span>
<a href="#l16.272"></a><span id="l16.272">   },</span>
<a href="#l16.273"></a><span id="l16.273">   onStopRequest : function (aRequest, aContext, aStatusCode) {</span>
<a href="#l16.274"></a><span id="l16.274" class="difflineminus">-    do_timeout(0, function(){doTest(++gCurTestNum);});</span>
<a href="#l16.275"></a><span id="l16.275" class="difflineplus">+    async_driver();</span>
<a href="#l16.276"></a><span id="l16.276">   },</span>
<a href="#l16.277"></a><span id="l16.277">   onDataAvailable : function (aRequest, aContext, aInputStream, aOff, aCount) {</span>
<a href="#l16.278"></a><span id="l16.278">     if (this._stream == null) {</span>
<a href="#l16.279"></a><span id="l16.279">       this._stream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;].createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l16.280"></a><span id="l16.280">       this._stream.init(aInputStream);</span>
<a href="#l16.281"></a><span id="l16.281">     }</span>
<a href="#l16.282"></a><span id="l16.282">     this._data += this._stream.read(aCount);</span>
<a href="#l16.283"></a><span id="l16.283">   },</span>
<a href="#l16.284"></a><span id="l16.284"> };</span>
<a href="#l16.285"></a><span id="l16.285"> </span>
<a href="#l16.286"></a><span id="l16.286" class="difflineminus">-function doTest(test)</span>
<a href="#l16.287"></a><span id="l16.287" class="difflineminus">-{</span>
<a href="#l16.288"></a><span id="l16.288" class="difflineminus">-  if (test &lt;= gTestArray.length)</span>
<a href="#l16.289"></a><span id="l16.289" class="difflineminus">-  {</span>
<a href="#l16.290"></a><span id="l16.290" class="difflineminus">-    dump(&quot;Doing test &quot; + test + &quot;\n&quot;);</span>
<a href="#l16.291"></a><span id="l16.291" class="difflineminus">-    gCurTestNum = test;</span>
<a href="#l16.292"></a><span id="l16.292" class="difflineplus">+asyncUrlListener.callback = function(aUrl, aExitCode) {</span>
<a href="#l16.293"></a><span id="l16.293" class="difflineplus">+  do_check_eq(aExitCode, 0);</span>
<a href="#l16.294"></a><span id="l16.294" class="difflineplus">+};</span>
<a href="#l16.295"></a><span id="l16.295"> </span>
<a href="#l16.296"></a><span id="l16.296" class="difflineminus">-    var testFn = gTestArray[test - 1];</span>
<a href="#l16.297"></a><span id="l16.297" class="difflineminus">-    // Set a limit of ten seconds; if the notifications haven't arrived by then there's a problem.</span>
<a href="#l16.298"></a><span id="l16.298" class="difflineminus">-    do_timeout(10000, function(){</span>
<a href="#l16.299"></a><span id="l16.299" class="difflineminus">-          if (gCurTestNum == test)</span>
<a href="#l16.300"></a><span id="l16.300" class="difflineminus">-          do_throw(&quot;Notifications not received in 10000 ms for operation &quot; + testFn.name);</span>
<a href="#l16.301"></a><span id="l16.301" class="difflineminus">-        }</span>
<a href="#l16.302"></a><span id="l16.302" class="difflineminus">-      );</span>
<a href="#l16.303"></a><span id="l16.303" class="difflineminus">-    try {</span>
<a href="#l16.304"></a><span id="l16.304" class="difflineminus">-    testFn();</span>
<a href="#l16.305"></a><span id="l16.305" class="difflineminus">-    } catch(ex) {</span>
<a href="#l16.306"></a><span id="l16.306" class="difflineminus">-      gServer.stop();</span>
<a href="#l16.307"></a><span id="l16.307" class="difflineminus">-      do_throw ('TEST FAILED ' + ex);</span>
<a href="#l16.308"></a><span id="l16.308" class="difflineminus">-    }</span>
<a href="#l16.309"></a><span id="l16.309" class="difflineminus">-  }</span>
<a href="#l16.310"></a><span id="l16.310" class="difflineminus">-  else</span>
<a href="#l16.311"></a><span id="l16.311" class="difflineminus">-  {</span>
<a href="#l16.312"></a><span id="l16.312" class="difflineminus">-    do_timeout(1000, endTest);</span>
<a href="#l16.313"></a><span id="l16.313" class="difflineminus">-  }</span>
<a href="#l16.314"></a><span id="l16.314" class="difflineplus">+function teardown() {</span>
<a href="#l16.315"></a><span id="l16.315" class="difflineplus">+  teardownIMAPPump();</span>
<a href="#l16.316"></a><span id="l16.316"> }</span>
<a href="#l16.317"></a><span id="l16.317"> </span>
<a href="#l16.318"></a><span id="l16.318" class="difflineminus">-// nsIURLListener implementation - runs next test</span>
<a href="#l16.319"></a><span id="l16.319" class="difflineminus">-var URLListener =</span>
<a href="#l16.320"></a><span id="l16.320" class="difflineminus">-{</span>
<a href="#l16.321"></a><span id="l16.321" class="difflineminus">-  OnStartRunningUrl: function(aURL) {},</span>
<a href="#l16.322"></a><span id="l16.322" class="difflineminus">-  OnStopRunningUrl: function(aURL, aStatus)</span>
<a href="#l16.323"></a><span id="l16.323" class="difflineminus">-  {</span>
<a href="#l16.324"></a><span id="l16.324" class="difflineminus">-    dump(&quot;in OnStopRunningURL &quot; + gCurTestNum + &quot;\n&quot;);</span>
<a href="#l16.325"></a><span id="l16.325" class="difflineminus">-    do_check_eq(aStatus, 0);</span>
<a href="#l16.326"></a><span id="l16.326" class="difflineminus">-    do_timeout(0, function(){doTest(++gCurTestNum);});</span>
<a href="#l16.327"></a><span id="l16.327" class="difflineminus">-  }</span>
<a href="#l16.328"></a><span id="l16.328" class="difflineplus">+function run_test() {</span>
<a href="#l16.329"></a><span id="l16.329" class="difflineplus">+  async_run_tests(tests);</span>
<a href="#l16.330"></a><span id="l16.330"> }</span>
<a href="#l16.331"></a><span id="l16.331" class="difflineminus">-</span>
<a href="#l16.332"></a><span id="l16.332" class="difflineminus">-function endTest()</span>
<a href="#l16.333"></a><span id="l16.333" class="difflineminus">-{</span>
<a href="#l16.334"></a><span id="l16.334" class="difflineminus">-  // Cleanup, null out everything, close all cached connections and stop the</span>
<a href="#l16.335"></a><span id="l16.335" class="difflineminus">-  // server</span>
<a href="#l16.336"></a><span id="l16.336" class="difflineminus">-//  gMessages.clear();</span>
<a href="#l16.337"></a><span id="l16.337" class="difflineminus">-  gMessenger = null;</span>
<a href="#l16.338"></a><span id="l16.338" class="difflineminus">-  gMsgWindow = null;</span>
<a href="#l16.339"></a><span id="l16.339" class="difflineminus">-  gRootFolder = null;</span>
<a href="#l16.340"></a><span id="l16.340" class="difflineminus">-  gIMAPInbox = null;</span>
<a href="#l16.341"></a><span id="l16.341" class="difflineminus">-  gIMAPTrashFolder = null;</span>
<a href="#l16.342"></a><span id="l16.342" class="difflineminus">-  gServer.resetTest();</span>
<a href="#l16.343"></a><span id="l16.343" class="difflineminus">-  gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l16.344"></a><span id="l16.344" class="difflineminus">-  gIMAPIncomingServer = null;</span>
<a href="#l16.345"></a><span id="l16.345" class="difflineminus">-  gLocalInboxFolder = null;</span>
<a href="#l16.346"></a><span id="l16.346" class="difflineminus">-  gLocalIncomingServer = null;</span>
<a href="#l16.347"></a><span id="l16.347" class="difflineminus">-  gServer.performTest();</span>
<a href="#l16.348"></a><span id="l16.348" class="difflineminus">-  gServer.stop();</span>
<a href="#l16.349"></a><span id="l16.349" class="difflineminus">-  let thread = gThreadManager.currentThread;</span>
<a href="#l16.350"></a><span id="l16.350" class="difflineminus">-  while (thread.hasPendingEvents())</span>
<a href="#l16.351"></a><span id="l16.351" class="difflineminus">-    thread.processNextEvent(true);</span>
<a href="#l16.352"></a><span id="l16.352" class="difflineminus">-</span>
<a href="#l16.353"></a><span id="l16.353" class="difflineminus">-  do_test_finished(); // for the one in run_test()</span>
<a href="#l16.354"></a><span id="l16.354" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapUndo.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapUndo.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -2,26 +2,27 @@</span>
<a href="#l17.4"></a><span id="l17.4"> // There are three main cases:</span>
<a href="#l17.5"></a><span id="l17.5"> // 1. Normal undo</span>
<a href="#l17.6"></a><span id="l17.6"> // 2. Undo after the source folder has been compacted.</span>
<a href="#l17.7"></a><span id="l17.7"> // 2.1 Same, but the server doesn't support COPYUID (GMail case)</span>
<a href="#l17.8"></a><span id="l17.8"> //</span>
<a href="#l17.9"></a><span id="l17.9"> // Original Author: David Bienvenu &lt;bienvenu@nventure.com&gt;</span>
<a href="#l17.10"></a><span id="l17.10"> </span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+</span>
<a href="#l17.17"></a><span id="l17.17"> var gRootFolder;</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineminus">-var gIMAPInbox, gIMAPTrashFolder;</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineminus">-var gIMAPDaemon, gServer, gIMAPIncomingServer;</span>
<a href="#l17.20"></a><span id="l17.20"> var gLastKey;</span>
<a href="#l17.21"></a><span id="l17.21"> var gMessages = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l17.22"></a><span id="l17.22"> var gCopyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l17.23"></a><span id="l17.23">                 .getService(Ci.nsIMsgCopyService);</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineminus">-var gMessenger;</span>
<a href="#l17.25"></a><span id="l17.25"> var gMsgWindow;</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineminus">-var gCurTestNum;</span>
<a href="#l17.27"></a><span id="l17.27"> </span>
<a href="#l17.28"></a><span id="l17.28"> Components.utils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l17.29"></a><span id="l17.29"> </span>
<a href="#l17.30"></a><span id="l17.30"> const gMsgFile1 = do_get_file(&quot;../../../data/bugmail10&quot;);</span>
<a href="#l17.31"></a><span id="l17.31"> const gMsgFile2 = do_get_file(&quot;../../../data/bugmail11&quot;);</span>
<a href="#l17.32"></a><span id="l17.32"> const gMsgFile3 = do_get_file(&quot;../../../data/draft1&quot;);</span>
<a href="#l17.33"></a><span id="l17.33"> const gMsgFile4 = do_get_file(&quot;../../../data/bugmail7&quot;);</span>
<a href="#l17.34"></a><span id="l17.34"> const gMsgFile5 = do_get_file(&quot;../../../data/bugmail6&quot;);</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineat">@@ -62,209 +63,100 @@ alertListener.prototype = {</span>
<a href="#l17.36"></a><span id="l17.36">   },</span>
<a href="#l17.37"></a><span id="l17.37"> </span>
<a href="#l17.38"></a><span id="l17.38">   onAlert: function (aMessage, aMsgWindow) {</span>
<a href="#l17.39"></a><span id="l17.39">     dump(&quot;got alert &quot; + aMessage + &quot;\n&quot;);</span>
<a href="#l17.40"></a><span id="l17.40">     do_throw ('TEST FAILED ' + aMessage);</span>
<a href="#l17.41"></a><span id="l17.41">   }</span>
<a href="#l17.42"></a><span id="l17.42"> };</span>
<a href="#l17.43"></a><span id="l17.43"> </span>
<a href="#l17.44"></a><span id="l17.44" class="difflineminus">-const gTestArray =</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineminus">-[</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineplus">+var tests = [</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineplus">+  setup,</span>
<a href="#l17.48"></a><span id="l17.48">   function updateFolder() {</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineminus">-    gIMAPInbox.updateFolderWithListener(null, URLListener);</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineplus">+    gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineplus">+    yield false;</span>
<a href="#l17.52"></a><span id="l17.52">   },</span>
<a href="#l17.53"></a><span id="l17.53">   function deleteMessage() {</span>
<a href="#l17.54"></a><span id="l17.54">     let msgToDelete = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l17.55"></a><span id="l17.55">     gMessages.appendElement(msgToDelete, false);</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineminus">-    // This delete happens offline, so we need to wait for playback before</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineminus">-    // doing the expunge. Playback happens 500 ms after the operation starts.</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineminus">-    gIMAPInbox.deleteMessages(gMessages, gMsgWindow, false, true, null, true);</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineminus">-    do_timeout(1500, function(){doTest(++gCurTestNum);});</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineplus">+    gIMAPInbox.deleteMessages(gMessages, gMsgWindow, false, true, asyncCopyListener, true);</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineplus">+    yield false;</span>
<a href="#l17.62"></a><span id="l17.62">   },</span>
<a href="#l17.63"></a><span id="l17.63">   function expunge() {</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineminus">-    gIMAPInbox.expunge(URLListener, gMsgWindow);</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineplus">+    gIMAPInbox.expunge(asyncUrlListener, gMsgWindow);</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineplus">+    yield false;</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineplus">+</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineplus">+    // Ensure that the message has been surely deleted.</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineplus">+    do_check_eq(gIMAPInbox.msgDatabase.dBFolderInfo.numMessages, 3);</span>
<a href="#l17.70"></a><span id="l17.70">   },</span>
<a href="#l17.71"></a><span id="l17.71">   function undoDelete() {</span>
<a href="#l17.72"></a><span id="l17.72">     gMsgWindow.transactionManager.undoTransaction();</span>
<a href="#l17.73"></a><span id="l17.73">     // after undo, we select the trash and then the inbox, so that we sync</span>
<a href="#l17.74"></a><span id="l17.74">     // up with the server, and clear out the effects of having done the</span>
<a href="#l17.75"></a><span id="l17.75">     // delete offline.</span>
<a href="#l17.76"></a><span id="l17.76">     let trash = gRootFolder.getChildNamed(&quot;Trash&quot;);</span>
<a href="#l17.77"></a><span id="l17.77">     trash.QueryInterface(Ci.nsIMsgImapMailFolder)</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineminus">-         .updateFolderWithListener(null, URLListener);</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineplus">+         .updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineplus">+    yield false;</span>
<a href="#l17.81"></a><span id="l17.81">   },</span>
<a href="#l17.82"></a><span id="l17.82">   function goBackToInbox() {</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineminus">-    gIMAPInbox.updateFolderWithListener(gMsgWindow, URLListener);</span>
<a href="#l17.84"></a><span id="l17.84" class="difflineplus">+    gIMAPInbox.updateFolderWithListener(gMsgWindow, asyncUrlListener);</span>
<a href="#l17.85"></a><span id="l17.85" class="difflineplus">+    yield false;</span>
<a href="#l17.86"></a><span id="l17.86">   },</span>
<a href="#l17.87"></a><span id="l17.87">   function verifyFolders() {</span>
<a href="#l17.88"></a><span id="l17.88">     let msgRestored = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l17.89"></a><span id="l17.89">     do_check_neq(msgRestored, null);</span>
<a href="#l17.90"></a><span id="l17.90">     do_check_eq(gIMAPInbox.msgDatabase.dBFolderInfo.numMessages, 4);</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineminus">-    doTest(++gCurTestNum);</span>
<a href="#l17.92"></a><span id="l17.92">   },</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineplus">+  teardown</span>
<a href="#l17.94"></a><span id="l17.94"> ];</span>
<a href="#l17.95"></a><span id="l17.95"> </span>
<a href="#l17.96"></a><span id="l17.96" class="difflineminus">-function run_test()</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineminus">-{</span>
<a href="#l17.98"></a><span id="l17.98" class="difflineminus">-  gIMAPDaemon = new imapDaemon();</span>
<a href="#l17.99"></a><span id="l17.99" class="difflineminus">-  gServer = makeServer(gIMAPDaemon, &quot;&quot;);</span>
<a href="#l17.100"></a><span id="l17.100" class="difflineminus">-</span>
<a href="#l17.101"></a><span id="l17.101" class="difflineminus">-  gIMAPIncomingServer = createLocalIMAPServer();</span>
<a href="#l17.102"></a><span id="l17.102" class="difflineminus">-</span>
<a href="#l17.103"></a><span id="l17.103" class="difflineminus">-  loadLocalMailAccount();</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineminus">-</span>
<a href="#l17.105"></a><span id="l17.105" class="difflineminus">-  // We need an identity so that updateFolder doesn't fail</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineminus">-  let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l17.107"></a><span id="l17.107" class="difflineminus">-                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l17.108"></a><span id="l17.108" class="difflineminus">-  let localAccount = acctMgr.createAccount();</span>
<a href="#l17.109"></a><span id="l17.109" class="difflineminus">-  let identity = acctMgr.createIdentity();</span>
<a href="#l17.110"></a><span id="l17.110" class="difflineminus">-  localAccount.addIdentity(identity);</span>
<a href="#l17.111"></a><span id="l17.111" class="difflineminus">-  localAccount.defaultIdentity = identity;</span>
<a href="#l17.112"></a><span id="l17.112" class="difflineminus">-  localAccount.incomingServer = gLocalIncomingServer;</span>
<a href="#l17.113"></a><span id="l17.113" class="difflineminus">-  acctMgr.defaultAccount = localAccount;</span>
<a href="#l17.114"></a><span id="l17.114" class="difflineminus">-</span>
<a href="#l17.115"></a><span id="l17.115" class="difflineminus">-  // Let's also have another account, using the same identity</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineminus">-  let imapAccount = acctMgr.createAccount();</span>
<a href="#l17.117"></a><span id="l17.117" class="difflineminus">-  imapAccount.addIdentity(identity);</span>
<a href="#l17.118"></a><span id="l17.118" class="difflineminus">-  imapAccount.defaultIdentity = identity;</span>
<a href="#l17.119"></a><span id="l17.119" class="difflineminus">-  imapAccount.incomingServer = gIMAPIncomingServer;</span>
<a href="#l17.120"></a><span id="l17.120" class="difflineplus">+function setup() {</span>
<a href="#l17.121"></a><span id="l17.121" class="difflineplus">+  setupIMAPPump();</span>
<a href="#l17.122"></a><span id="l17.122"> </span>
<a href="#l17.123"></a><span id="l17.123">   var mailSession = Cc[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l17.124"></a><span id="l17.124">     .getService(Ci.nsIMsgMailSession);</span>
<a href="#l17.125"></a><span id="l17.125"> </span>
<a href="#l17.126"></a><span id="l17.126">   var listener1 = new alertListener();</span>
<a href="#l17.127"></a><span id="l17.127"> </span>
<a href="#l17.128"></a><span id="l17.128">   mailSession.addUserFeedbackListener(listener1);</span>
<a href="#l17.129"></a><span id="l17.129"> </span>
<a href="#l17.130"></a><span id="l17.130" class="difflineminus">-  // The server doesn't support more than one connection</span>
<a href="#l17.131"></a><span id="l17.131" class="difflineminus">-  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l17.132"></a><span id="l17.132" class="difflineminus">-                     .getService(Ci.nsIPrefBranch);</span>
<a href="#l17.133"></a><span id="l17.133" class="difflineminus">-  prefBranch.setIntPref(&quot;mail.server.server1.max_cached_connections&quot;, 1);</span>
<a href="#l17.134"></a><span id="l17.134" class="difflineminus">-  // Make sure no biff notifications happen</span>
<a href="#l17.135"></a><span id="l17.135" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l17.136"></a><span id="l17.136" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l17.137"></a><span id="l17.137" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l17.138"></a><span id="l17.138" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l17.139"></a><span id="l17.139" class="difflineminus">-  // We aren't interested in downloading messages automatically</span>
<a href="#l17.140"></a><span id="l17.140" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.server.server1.download_on_biff&quot;, false);</span>
<a href="#l17.141"></a><span id="l17.141" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.server.server1.autosync_offline_stores&quot;, false);</span>
<a href="#l17.142"></a><span id="l17.142" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.server.server1.offline_download&quot;, false);</span>
<a href="#l17.143"></a><span id="l17.143" class="difflineminus">-  gMessenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l17.144"></a><span id="l17.144" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.server.server1.autosync_offline_stores&quot;, false);</span>
<a href="#l17.145"></a><span id="l17.145" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.server.server1.offline_download&quot;, false);</span>
<a href="#l17.146"></a><span id="l17.146"> </span>
<a href="#l17.147"></a><span id="l17.147">   gMsgWindow = Cc[&quot;@mozilla.org/messenger/msgwindow;1&quot;]</span>
<a href="#l17.148"></a><span id="l17.148">                   .createInstance(Components.interfaces.nsIMsgWindow);</span>
<a href="#l17.149"></a><span id="l17.149"> </span>
<a href="#l17.150"></a><span id="l17.150" class="difflineminus">-  // Get the server list...</span>
<a href="#l17.151"></a><span id="l17.151" class="difflineminus">-  gIMAPIncomingServer.performExpand(null);</span>
<a href="#l17.152"></a><span id="l17.152" class="difflineminus">-</span>
<a href="#l17.153"></a><span id="l17.153">   gRootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l17.154"></a><span id="l17.154" class="difflineminus">-  gIMAPInbox = gRootFolder.getChildNamed(&quot;INBOX&quot;);</span>
<a href="#l17.155"></a><span id="l17.155" class="difflineminus">-  let msgImapFolder = gIMAPInbox.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l17.156"></a><span id="l17.156">   // these hacks are required because we've created the inbox before</span>
<a href="#l17.157"></a><span id="l17.157">   // running initial folder discovery, and adding the folder bails</span>
<a href="#l17.158"></a><span id="l17.158">   // out before we set it as verified online, so we bail out, and</span>
<a href="#l17.159"></a><span id="l17.159">   // then remove the INBOX folder since it's not verified.</span>
<a href="#l17.160"></a><span id="l17.160" class="difflineminus">-  msgImapFolder.hierarchyDelimiter = '/';</span>
<a href="#l17.161"></a><span id="l17.161" class="difflineminus">-  msgImapFolder.verifiedAsOnlineFolder = true;</span>
<a href="#l17.162"></a><span id="l17.162" class="difflineplus">+  gIMAPInbox.hierarchyDelimiter = '/';</span>
<a href="#l17.163"></a><span id="l17.163" class="difflineplus">+  gIMAPInbox.verifiedAsOnlineFolder = true;</span>
<a href="#l17.164"></a><span id="l17.164"> </span>
<a href="#l17.165"></a><span id="l17.165"> </span>
<a href="#l17.166"></a><span id="l17.166">   // Add a couple of messages to the INBOX</span>
<a href="#l17.167"></a><span id="l17.167">   // this is synchronous, afaik</span>
<a href="#l17.168"></a><span id="l17.168">   addMessagesToServer([{file: gMsgFile1, messageId: gMsgId1},</span>
<a href="#l17.169"></a><span id="l17.169" class="difflineminus">-                        {file: gMsgFile4, messageId: gMsgId4},</span>
<a href="#l17.170"></a><span id="l17.170" class="difflineminus">-                         {file: gMsgFile5, messageId: gMsgId5},</span>
<a href="#l17.171"></a><span id="l17.171" class="difflineminus">-                        {file: gMsgFile2, messageId: gMsgId2}],</span>
<a href="#l17.172"></a><span id="l17.172" class="difflineminus">-                        gIMAPDaemon.getMailbox(&quot;INBOX&quot;), gIMAPInbox);</span>
<a href="#l17.173"></a><span id="l17.173" class="difflineminus">-  // &quot;Master&quot; do_test_pending(), paired with a do_test_finished() at the end of</span>
<a href="#l17.174"></a><span id="l17.174" class="difflineminus">-  // all the operations.</span>
<a href="#l17.175"></a><span id="l17.175" class="difflineminus">-  do_test_pending();</span>
<a href="#l17.176"></a><span id="l17.176" class="difflineminus">-  //start first test</span>
<a href="#l17.177"></a><span id="l17.177" class="difflineminus">-  doTest(1);</span>
<a href="#l17.178"></a><span id="l17.178" class="difflineminus">-}</span>
<a href="#l17.179"></a><span id="l17.179" class="difflineminus">-</span>
<a href="#l17.180"></a><span id="l17.180" class="difflineminus">-function doTest(test)</span>
<a href="#l17.181"></a><span id="l17.181" class="difflineminus">-{</span>
<a href="#l17.182"></a><span id="l17.182" class="difflineminus">-  if (test &lt;= gTestArray.length)</span>
<a href="#l17.183"></a><span id="l17.183" class="difflineminus">-  {</span>
<a href="#l17.184"></a><span id="l17.184" class="difflineminus">-    dump(&quot;Doing test &quot; + test + &quot;\n&quot;);</span>
<a href="#l17.185"></a><span id="l17.185" class="difflineminus">-    gCurTestNum = test;</span>
<a href="#l17.186"></a><span id="l17.186" class="difflineminus">-</span>
<a href="#l17.187"></a><span id="l17.187" class="difflineminus">-    var testFn = gTestArray[test - 1];</span>
<a href="#l17.188"></a><span id="l17.188" class="difflineminus">-    // Set a limit of ten seconds; if the notifications haven't arrived by then there's a problem.</span>
<a href="#l17.189"></a><span id="l17.189" class="difflineminus">-    do_timeout(10000, function(){</span>
<a href="#l17.190"></a><span id="l17.190" class="difflineminus">-        if (gCurTestNum == test)</span>
<a href="#l17.191"></a><span id="l17.191" class="difflineminus">-          do_throw(&quot;Notifications not received in 10000 ms for operation &quot; + testFn.name);</span>
<a href="#l17.192"></a><span id="l17.192" class="difflineminus">-        }</span>
<a href="#l17.193"></a><span id="l17.193" class="difflineminus">-      );</span>
<a href="#l17.194"></a><span id="l17.194" class="difflineminus">-    try {</span>
<a href="#l17.195"></a><span id="l17.195" class="difflineminus">-    testFn();</span>
<a href="#l17.196"></a><span id="l17.196" class="difflineminus">-    } catch(ex) {</span>
<a href="#l17.197"></a><span id="l17.197" class="difflineminus">-      gServer.stop();</span>
<a href="#l17.198"></a><span id="l17.198" class="difflineminus">-      do_throw ('TEST FAILED ' + ex);</span>
<a href="#l17.199"></a><span id="l17.199" class="difflineminus">-    }</span>
<a href="#l17.200"></a><span id="l17.200" class="difflineminus">-  }</span>
<a href="#l17.201"></a><span id="l17.201" class="difflineminus">-  else</span>
<a href="#l17.202"></a><span id="l17.202" class="difflineminus">-  {</span>
<a href="#l17.203"></a><span id="l17.203" class="difflineminus">-    do_timeout(1000, endTest);</span>
<a href="#l17.204"></a><span id="l17.204" class="difflineminus">-  }</span>
<a href="#l17.205"></a><span id="l17.205" class="difflineplus">+                       {file: gMsgFile4, messageId: gMsgId4},</span>
<a href="#l17.206"></a><span id="l17.206" class="difflineplus">+                       {file: gMsgFile5, messageId: gMsgId5},</span>
<a href="#l17.207"></a><span id="l17.207" class="difflineplus">+                       {file: gMsgFile2, messageId: gMsgId2}],</span>
<a href="#l17.208"></a><span id="l17.208" class="difflineplus">+                      gIMAPMailbox, gIMAPInbox);</span>
<a href="#l17.209"></a><span id="l17.209"> }</span>
<a href="#l17.210"></a><span id="l17.210"> </span>
<a href="#l17.211"></a><span id="l17.211" class="difflineminus">-// nsIMsgCopyServiceListener implementation - runs next test when copy</span>
<a href="#l17.212"></a><span id="l17.212" class="difflineminus">-// is completed.</span>
<a href="#l17.213"></a><span id="l17.213" class="difflineminus">-var CopyListener =</span>
<a href="#l17.214"></a><span id="l17.214" class="difflineminus">-{</span>
<a href="#l17.215"></a><span id="l17.215" class="difflineminus">-  OnStartCopy: function() {},</span>
<a href="#l17.216"></a><span id="l17.216" class="difflineminus">-  OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l17.217"></a><span id="l17.217" class="difflineminus">-  SetMessageKey: function(aKey)</span>
<a href="#l17.218"></a><span id="l17.218" class="difflineminus">-  {</span>
<a href="#l17.219"></a><span id="l17.219" class="difflineminus">-    gLastKey = aKey;</span>
<a href="#l17.220"></a><span id="l17.220" class="difflineminus">-  },</span>
<a href="#l17.221"></a><span id="l17.221" class="difflineminus">-  SetMessageId: function(aMessageId) {},</span>
<a href="#l17.222"></a><span id="l17.222" class="difflineminus">-  OnStopCopy: function(aStatus)</span>
<a href="#l17.223"></a><span id="l17.223" class="difflineminus">-  {</span>
<a href="#l17.224"></a><span id="l17.224" class="difflineminus">-    dump(&quot;in OnStopCopy &quot; + gCurTestNum + &quot;\n&quot;);</span>
<a href="#l17.225"></a><span id="l17.225" class="difflineminus">-    // Check: message successfully copied.</span>
<a href="#l17.226"></a><span id="l17.226" class="difflineminus">-    do_check_eq(aStatus, 0);</span>
<a href="#l17.227"></a><span id="l17.227" class="difflineminus">-    // Ugly hack: make sure we don't get stuck in a JS-&gt;C++-&gt;JS-&gt;C++... call stack</span>
<a href="#l17.228"></a><span id="l17.228" class="difflineminus">-    // This can happen with a bunch of synchronous functions grouped together, and</span>
<a href="#l17.229"></a><span id="l17.229" class="difflineminus">-    // can even cause tests to fail because they're still waiting for the listener</span>
<a href="#l17.230"></a><span id="l17.230" class="difflineminus">-    // to return</span>
<a href="#l17.231"></a><span id="l17.231" class="difflineminus">-    do_timeout(0, function(){doTest(++gCurTestNum);});</span>
<a href="#l17.232"></a><span id="l17.232" class="difflineminus">-  }</span>
<a href="#l17.233"></a><span id="l17.233" class="difflineplus">+asyncUrlListener.callback = function(aUrl, aExitCode) {</span>
<a href="#l17.234"></a><span id="l17.234" class="difflineplus">+  do_check_eq(aExitCode, 0);</span>
<a href="#l17.235"></a><span id="l17.235"> };</span>
<a href="#l17.236"></a><span id="l17.236"> </span>
<a href="#l17.237"></a><span id="l17.237" class="difflineminus">-</span>
<a href="#l17.238"></a><span id="l17.238" class="difflineminus">-// nsIURLListener implementation - runs next test</span>
<a href="#l17.239"></a><span id="l17.239" class="difflineminus">-var URLListener =</span>
<a href="#l17.240"></a><span id="l17.240" class="difflineminus">-{</span>
<a href="#l17.241"></a><span id="l17.241" class="difflineminus">-  OnStartRunningUrl: function(aURL) {},</span>
<a href="#l17.242"></a><span id="l17.242" class="difflineminus">-  OnStopRunningUrl: function(aURL, aStatus)</span>
<a href="#l17.243"></a><span id="l17.243" class="difflineminus">-  {</span>
<a href="#l17.244"></a><span id="l17.244" class="difflineminus">-    dump(&quot;in OnStopRunningURL &quot; + gCurTestNum + &quot;\n&quot;);</span>
<a href="#l17.245"></a><span id="l17.245" class="difflineminus">-    do_check_eq(aStatus, 0);</span>
<a href="#l17.246"></a><span id="l17.246" class="difflineminus">-    do_timeout(0, function(){doTest(++gCurTestNum);});</span>
<a href="#l17.247"></a><span id="l17.247" class="difflineminus">-  }</span>
<a href="#l17.248"></a><span id="l17.248" class="difflineminus">-}</span>
<a href="#l17.249"></a><span id="l17.249" class="difflineminus">-</span>
<a href="#l17.250"></a><span id="l17.250" class="difflineminus">-function endTest()</span>
<a href="#l17.251"></a><span id="l17.251" class="difflineminus">-{</span>
<a href="#l17.252"></a><span id="l17.252" class="difflineplus">+function teardown() {</span>
<a href="#l17.253"></a><span id="l17.253">   // Cleanup, null out everything, close all cached connections and stop the</span>
<a href="#l17.254"></a><span id="l17.254">   // server</span>
<a href="#l17.255"></a><span id="l17.255">   gMessages.clear();</span>
<a href="#l17.256"></a><span id="l17.256" class="difflineminus">-  gMessenger = null;</span>
<a href="#l17.257"></a><span id="l17.257" class="difflineplus">+  gMsgWindow.closeWindow();</span>
<a href="#l17.258"></a><span id="l17.258">   gMsgWindow = null;</span>
<a href="#l17.259"></a><span id="l17.259">   gRootFolder = null;</span>
<a href="#l17.260"></a><span id="l17.260" class="difflineminus">-  gIMAPInbox = null;</span>
<a href="#l17.261"></a><span id="l17.261" class="difflineminus">-  gIMAPTrashFolder = null;</span>
<a href="#l17.262"></a><span id="l17.262" class="difflineminus">-  gServer.resetTest();</span>
<a href="#l17.263"></a><span id="l17.263" class="difflineminus">-  gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l17.264"></a><span id="l17.264" class="difflineminus">-  gIMAPIncomingServer = null;</span>
<a href="#l17.265"></a><span id="l17.265" class="difflineminus">-  gLocalInboxFolder = null;</span>
<a href="#l17.266"></a><span id="l17.266" class="difflineminus">-  gLocalIncomingServer = null;</span>
<a href="#l17.267"></a><span id="l17.267" class="difflineminus">-  gServer.performTest();</span>
<a href="#l17.268"></a><span id="l17.268" class="difflineminus">-  gServer.stop();</span>
<a href="#l17.269"></a><span id="l17.269" class="difflineminus">-  let thread = gThreadManager.currentThread;</span>
<a href="#l17.270"></a><span id="l17.270" class="difflineminus">-  while (thread.hasPendingEvents())</span>
<a href="#l17.271"></a><span id="l17.271" class="difflineminus">-    thread.processNextEvent(true);</span>
<a href="#l17.272"></a><span id="l17.272" class="difflineplus">+  teardownIMAPPump();</span>
<a href="#l17.273"></a><span id="l17.273" class="difflineplus">+}</span>
<a href="#l17.274"></a><span id="l17.274"> </span>
<a href="#l17.275"></a><span id="l17.275" class="difflineminus">-  do_test_finished(); // for the one in run_test()</span>
<a href="#l17.276"></a><span id="l17.276" class="difflineplus">+function run_test() {</span>
<a href="#l17.277"></a><span id="l17.277" class="difflineplus">+  async_run_tests(tests);</span>
<a href="#l17.278"></a><span id="l17.278"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_largeOfflineStore.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_largeOfflineStore.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -1,105 +1,88 @@</span>
<a href="#l18.4"></a><span id="l18.4"> /* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l18.5"></a><span id="l18.5"> /*</span>
<a href="#l18.6"></a><span id="l18.6">  * Test to ensure that downloadAllForOffline works correctly for large imap</span>
<a href="#l18.7"></a><span id="l18.7">  * stores, i.e., over 4 GiB.</span>
<a href="#l18.8"></a><span id="l18.8">  */</span>
<a href="#l18.9"></a><span id="l18.9"> </span>
<a href="#l18.10"></a><span id="l18.10" class="difflineplus">+load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l18.11"></a><span id="l18.11" class="difflineplus">+load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l18.12"></a><span id="l18.12"> load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l18.13"></a><span id="l18.13"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l18.15"></a><span id="l18.15"> </span>
<a href="#l18.16"></a><span id="l18.16"> Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;,</span>
<a href="#l18.17"></a><span id="l18.17">                            &quot;@mozilla.org/msgstore/berkeleystore;1&quot;);</span>
<a href="#l18.18"></a><span id="l18.18"> </span>
<a href="#l18.19"></a><span id="l18.19" class="difflineminus">-var gDownloadedOnce = false;</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineminus">-var gIMAPDaemon;</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineminus">-var gIMAPInbox;</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineminus">-var gIMAPIncomingServer;</span>
<a href="#l18.23"></a><span id="l18.23"> var gOfflineStoreSize;</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineminus">-var gServer;</span>
<a href="#l18.25"></a><span id="l18.25"> </span>
<a href="#l18.26"></a><span id="l18.26" class="difflineminus">-function run_test()</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineminus">-{</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineminus">-  // Preference tuning: turn off notifications.</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineminus">-  Services.prefs.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineminus">-  Services.prefs.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineminus">-  Services.prefs.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineminus">-  Services.prefs.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineminus">-</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineminus">-  loadLocalMailAccount();</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineplus">+var tests = [</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineplus">+  setup,</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineplus">+  check_result,</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineplus">+  teardown</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineplus">+];</span>
<a href="#l18.40"></a><span id="l18.40"> </span>
<a href="#l18.41"></a><span id="l18.41" class="difflineminus">-  // &quot;Master&quot; do_test_pending(), paired with a do_test_finished() at the end of</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineminus">-  // all the operations.</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineminus">-  do_test_pending();</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineminus">-</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineminus">-  /*</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineminus">-   * Set up an IMAP server.</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineminus">-   */</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineminus">-  gIMAPDaemon = new imapDaemon();</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineminus">-  gServer = makeServer(gIMAPDaemon, &quot;&quot;);</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineminus">-  gIMAPIncomingServer = createLocalIMAPServer();</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineminus">-  gIMAPIncomingServer.maximumConnectionsNumber = 1;</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineplus">+function run_test() {</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineplus">+  setupIMAPPump();</span>
<a href="#l18.54"></a><span id="l18.54"> </span>
<a href="#l18.55"></a><span id="l18.55">   // Figure out the name of the IMAP inbox</span>
<a href="#l18.56"></a><span id="l18.56">   let inboxFile = gIMAPIncomingServer.rootMsgFolder.filePath;</span>
<a href="#l18.57"></a><span id="l18.57">   inboxFile.append(&quot;INBOX&quot;);</span>
<a href="#l18.58"></a><span id="l18.58">   if (!inboxFile.exists())</span>
<a href="#l18.59"></a><span id="l18.59">     inboxFile.create(Ci.nsIFile.NORMAL_FILE_TYPE, parseInt(&quot;0644&quot;, 8));</span>
<a href="#l18.60"></a><span id="l18.60"> </span>
<a href="#l18.61"></a><span id="l18.61">   let neededFreeSpace = 0x200000000;</span>
<a href="#l18.62"></a><span id="l18.62">   // On Windows, check whether the drive is NTFS. If it is, mark the file as</span>
<a href="#l18.63"></a><span id="l18.63">   // sparse. If it isn't, then bail out now, because in all probability it is</span>
<a href="#l18.64"></a><span id="l18.64">   // FAT32, which doesn't support file sizes greater than 4 GB.</span>
<a href="#l18.65"></a><span id="l18.65">   if (&quot;@mozilla.org/windows-registry-key;1&quot; in Cc &amp;&amp;</span>
<a href="#l18.66"></a><span id="l18.66">       get_file_system(inboxFile) != &quot;NTFS&quot;)</span>
<a href="#l18.67"></a><span id="l18.67">   {</span>
<a href="#l18.68"></a><span id="l18.68">     dump(&quot;On Windows, this test only works on NTFS volumes.\n&quot;);</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineminus">-    endTest();</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineplus">+    teardown();</span>
<a href="#l18.71"></a><span id="l18.71">     return;</span>
<a href="#l18.72"></a><span id="l18.72">   }</span>
<a href="#l18.73"></a><span id="l18.73"> </span>
<a href="#l18.74"></a><span id="l18.74">   let isFileSparse = mark_file_region_sparse(inboxFile, 0, 0x10000000f);</span>
<a href="#l18.75"></a><span id="l18.75">   let freeDiskSpace = inboxFile.diskSpaceAvailable;</span>
<a href="#l18.76"></a><span id="l18.76">   do_print(&quot;Free disk space = &quot; + toMiBString(freeDiskSpace));</span>
<a href="#l18.77"></a><span id="l18.77">   if (!isFileSparse &amp;&amp; freeDiskSpace &lt; neededFreeSpace) {</span>
<a href="#l18.78"></a><span id="l18.78">     do_print(&quot;This test needs &quot; + toMiBString(neededFreeSpace) +</span>
<a href="#l18.79"></a><span id="l18.79">              &quot; free space to run. Aborting.&quot;);</span>
<a href="#l18.80"></a><span id="l18.80">     todo_check_true(false);</span>
<a href="#l18.81"></a><span id="l18.81"> </span>
<a href="#l18.82"></a><span id="l18.82" class="difflineminus">-    endTest();</span>
<a href="#l18.83"></a><span id="l18.83" class="difflineplus">+    teardown();</span>
<a href="#l18.84"></a><span id="l18.84">     return;</span>
<a href="#l18.85"></a><span id="l18.85">   }</span>
<a href="#l18.86"></a><span id="l18.86"> </span>
<a href="#l18.87"></a><span id="l18.87" class="difflineminus">-  let inbox = gIMAPDaemon.getMailbox(&quot;INBOX&quot;);</span>
<a href="#l18.88"></a><span id="l18.88" class="difflineplus">+  async_run_tests(tests);</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineplus">+}</span>
<a href="#l18.90"></a><span id="l18.90"> </span>
<a href="#l18.91"></a><span id="l18.91" class="difflineplus">+function setup() {</span>
<a href="#l18.92"></a><span id="l18.92">   let ioService = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l18.93"></a><span id="l18.93">                     .getService(Ci.nsIIOService);</span>
<a href="#l18.94"></a><span id="l18.94"> </span>
<a href="#l18.95"></a><span id="l18.95">   // Create a couple test messages on the IMAP server.</span>
<a href="#l18.96"></a><span id="l18.96">   let messages = [];</span>
<a href="#l18.97"></a><span id="l18.97">   let messageGenerator = new MessageGenerator();</span>
<a href="#l18.98"></a><span id="l18.98">   let scenarioFactory = new MessageScenarioFactory(messageGenerator);</span>
<a href="#l18.99"></a><span id="l18.99"> </span>
<a href="#l18.100"></a><span id="l18.100">   messages = messages.concat(scenarioFactory.directReply(2));</span>
<a href="#l18.101"></a><span id="l18.101">   let dataUri = ioService.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l18.102"></a><span id="l18.102">                                    btoa(messages[0].toMessageString()),</span>
<a href="#l18.103"></a><span id="l18.103">                                  null, null);</span>
<a href="#l18.104"></a><span id="l18.104" class="difflineminus">-  let imapMsg = new imapMessage(dataUri.spec, inbox.uidnext++, []);</span>
<a href="#l18.105"></a><span id="l18.105" class="difflineminus">-  inbox.addMessage(imapMsg);</span>
<a href="#l18.106"></a><span id="l18.106" class="difflineplus">+  let imapMsg = new imapMessage(dataUri.spec, gIMAPMailbox.uidnext++, []);</span>
<a href="#l18.107"></a><span id="l18.107" class="difflineplus">+  gIMAPMailbox.addMessage(imapMsg);</span>
<a href="#l18.108"></a><span id="l18.108"> </span>
<a href="#l18.109"></a><span id="l18.109">   dataUri = ioService.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l18.110"></a><span id="l18.110">                                btoa(messages[1].toMessageString()),</span>
<a href="#l18.111"></a><span id="l18.111">                              null, null);</span>
<a href="#l18.112"></a><span id="l18.112" class="difflineminus">-  imapMsg = new imapMessage(dataUri.spec, inbox.uidnext++, []);</span>
<a href="#l18.113"></a><span id="l18.113" class="difflineminus">-  inbox.addMessage(imapMsg);</span>
<a href="#l18.114"></a><span id="l18.114" class="difflineminus">-</span>
<a href="#l18.115"></a><span id="l18.115" class="difflineminus">-  // Get local IMAP inbox.</span>
<a href="#l18.116"></a><span id="l18.116" class="difflineminus">-  let rootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l18.117"></a><span id="l18.117" class="difflineminus">-  gIMAPInbox = rootFolder.getFolderWithFlags(Ci.nsMsgFolderFlags.Inbox);</span>
<a href="#l18.118"></a><span id="l18.118" class="difflineplus">+  imapMsg = new imapMessage(dataUri.spec, gIMAPMailbox.uidnext++, []);</span>
<a href="#l18.119"></a><span id="l18.119" class="difflineplus">+  gIMAPMailbox.addMessage(imapMsg);</span>
<a href="#l18.120"></a><span id="l18.120"> </span>
<a href="#l18.121"></a><span id="l18.121">   // Extend local IMAP inbox to over 4 GiB.</span>
<a href="#l18.122"></a><span id="l18.122">   let outputStream = Cc[&quot;@mozilla.org/network/file-output-stream;1&quot;]</span>
<a href="#l18.123"></a><span id="l18.123">                        .createInstance(Ci.nsIFileOutputStream)</span>
<a href="#l18.124"></a><span id="l18.124">                        .QueryInterface(Ci.nsISeekableStream);</span>
<a href="#l18.125"></a><span id="l18.125">   // Open in write-only mode, no truncate.</span>
<a href="#l18.126"></a><span id="l18.126">   outputStream.init(gIMAPInbox.filePath, 0x02, -1, 0);</span>
<a href="#l18.127"></a><span id="l18.127">   // seek to 15 bytes past 4GB.</span>
<a href="#l18.128"></a><span id="l18.128" class="difflineat">@@ -109,73 +92,47 @@ function run_test()</span>
<a href="#l18.129"></a><span id="l18.129">   outputStream.close();</span>
<a href="#l18.130"></a><span id="l18.130"> </span>
<a href="#l18.131"></a><span id="l18.131">   // Save initial file size.</span>
<a href="#l18.132"></a><span id="l18.132">   gOfflineStoreSize = gIMAPInbox.filePath.fileSize;</span>
<a href="#l18.133"></a><span id="l18.133">   do_print(&quot;Offline store size (before 1st downloadAllForOffline()) = &quot; +</span>
<a href="#l18.134"></a><span id="l18.134">            gOfflineStoreSize);</span>
<a href="#l18.135"></a><span id="l18.135"> </span>
<a href="#l18.136"></a><span id="l18.136">   // Download for offline use, to append created messages to local IMAP inbox.</span>
<a href="#l18.137"></a><span id="l18.137" class="difflineminus">-  gIMAPInbox.downloadAllForOffline(UrlListener, null);</span>
<a href="#l18.138"></a><span id="l18.138" class="difflineplus">+  gIMAPInbox.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l18.139"></a><span id="l18.139" class="difflineplus">+  yield false;</span>
<a href="#l18.140"></a><span id="l18.140"> }</span>
<a href="#l18.141"></a><span id="l18.141"> </span>
<a href="#l18.142"></a><span id="l18.142" class="difflineminus">-var UrlListener =</span>
<a href="#l18.143"></a><span id="l18.143" class="difflineminus">-{</span>
<a href="#l18.144"></a><span id="l18.144" class="difflineminus">-  OnStartRunningUrl: function(url) {},</span>
<a href="#l18.145"></a><span id="l18.145" class="difflineminus">-  OnStopRunningUrl: function(url, rc)</span>
<a href="#l18.146"></a><span id="l18.146" class="difflineminus">-  {</span>
<a href="#l18.147"></a><span id="l18.147" class="difflineminus">-    // Check for ok status.</span>
<a href="#l18.148"></a><span id="l18.148" class="difflineminus">-    do_check_eq(rc, 0);</span>
<a href="#l18.149"></a><span id="l18.149" class="difflineplus">+function check_result() {</span>
<a href="#l18.150"></a><span id="l18.150" class="difflineplus">+  // Call downloadAllForOffline() a second time.</span>
<a href="#l18.151"></a><span id="l18.151" class="difflineplus">+  gIMAPInbox.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l18.152"></a><span id="l18.152" class="difflineplus">+  yield false;</span>
<a href="#l18.153"></a><span id="l18.153"> </span>
<a href="#l18.154"></a><span id="l18.154" class="difflineminus">-    if (!gDownloadedOnce) {</span>
<a href="#l18.155"></a><span id="l18.155" class="difflineminus">-      gDownloadedOnce = true;</span>
<a href="#l18.156"></a><span id="l18.156" class="difflineminus">-      // Call downloadAllForOffline() a second time.</span>
<a href="#l18.157"></a><span id="l18.157" class="difflineminus">-      gIMAPInbox.downloadAllForOffline(UrlListener, null);</span>
<a href="#l18.158"></a><span id="l18.158" class="difflineminus">-      return;</span>
<a href="#l18.159"></a><span id="l18.159" class="difflineminus">-    }</span>
<a href="#l18.160"></a><span id="l18.160" class="difflineminus">-</span>
<a href="#l18.161"></a><span id="l18.161" class="difflineminus">-    // Make sure offline store grew (i.e., we were not writing over data).</span>
<a href="#l18.162"></a><span id="l18.162" class="difflineminus">-    let offlineStoreSize = gIMAPInbox.filePath.fileSize;</span>
<a href="#l18.163"></a><span id="l18.163" class="difflineminus">-    do_print(&quot;Offline store size (after 2nd downloadAllForOffline()) = &quot; +</span>
<a href="#l18.164"></a><span id="l18.164" class="difflineminus">-             offlineStoreSize + &quot;. (Msg hdr offsets should be close to it.)&quot;);</span>
<a href="#l18.165"></a><span id="l18.165" class="difflineminus">-    do_check_true(offlineStoreSize &gt; gOfflineStoreSize);</span>
<a href="#l18.166"></a><span id="l18.166" class="difflineplus">+  // Make sure offline store grew (i.e., we were not writing over data).</span>
<a href="#l18.167"></a><span id="l18.167" class="difflineplus">+  let offlineStoreSize = gIMAPInbox.filePath.fileSize;</span>
<a href="#l18.168"></a><span id="l18.168" class="difflineplus">+  do_print(&quot;Offline store size (after 2nd downloadAllForOffline()) = &quot; +</span>
<a href="#l18.169"></a><span id="l18.169" class="difflineplus">+           offlineStoreSize + &quot;. (Msg hdr offsets should be close to it.)&quot;);</span>
<a href="#l18.170"></a><span id="l18.170" class="difflineplus">+  do_check_true(offlineStoreSize &gt; gOfflineStoreSize);</span>
<a href="#l18.171"></a><span id="l18.171"> </span>
<a href="#l18.172"></a><span id="l18.172" class="difflineminus">-    // Verify that the message headers have the offline flag set.</span>
<a href="#l18.173"></a><span id="l18.173" class="difflineminus">-    let msgEnumerator = gIMAPInbox.msgDatabase.EnumerateMessages();</span>
<a href="#l18.174"></a><span id="l18.174" class="difflineminus">-    let offset = new Object;</span>
<a href="#l18.175"></a><span id="l18.175" class="difflineminus">-    let size = new Object;</span>
<a href="#l18.176"></a><span id="l18.176" class="difflineminus">-    while (msgEnumerator.hasMoreElements()) {</span>
<a href="#l18.177"></a><span id="l18.177" class="difflineminus">-      let header = msgEnumerator.getNext();</span>
<a href="#l18.178"></a><span id="l18.178" class="difflineminus">-      // Verify that each message has been downloaded and looks OK.</span>
<a href="#l18.179"></a><span id="l18.179" class="difflineminus">-      if (!(header instanceof Components.interfaces.nsIMsgDBHdr &amp;&amp;</span>
<a href="#l18.180"></a><span id="l18.180" class="difflineminus">-            (header.flags &amp; Ci.nsMsgMessageFlags.Offline)))</span>
<a href="#l18.181"></a><span id="l18.181" class="difflineminus">-        do_throw(&quot;Message not downloaded for offline use&quot;);</span>
<a href="#l18.182"></a><span id="l18.182" class="difflineplus">+  // Verify that the message headers have the offline flag set.</span>
<a href="#l18.183"></a><span id="l18.183" class="difflineplus">+  let msgEnumerator = gIMAPInbox.msgDatabase.EnumerateMessages();</span>
<a href="#l18.184"></a><span id="l18.184" class="difflineplus">+  let offset = {};</span>
<a href="#l18.185"></a><span id="l18.185" class="difflineplus">+  let size = {};</span>
<a href="#l18.186"></a><span id="l18.186" class="difflineplus">+  while (msgEnumerator.hasMoreElements()) {</span>
<a href="#l18.187"></a><span id="l18.187" class="difflineplus">+    let header = msgEnumerator.getNext();</span>
<a href="#l18.188"></a><span id="l18.188" class="difflineplus">+    // Verify that each message has been downloaded and looks OK.</span>
<a href="#l18.189"></a><span id="l18.189" class="difflineplus">+    if (!(header instanceof Components.interfaces.nsIMsgDBHdr &amp;&amp;</span>
<a href="#l18.190"></a><span id="l18.190" class="difflineplus">+          (header.flags &amp; Ci.nsMsgMessageFlags.Offline)))</span>
<a href="#l18.191"></a><span id="l18.191" class="difflineplus">+      do_throw(&quot;Message not downloaded for offline use&quot;);</span>
<a href="#l18.192"></a><span id="l18.192"> </span>
<a href="#l18.193"></a><span id="l18.193" class="difflineminus">-      gIMAPInbox.getOfflineFileStream(header.messageKey, offset, size).close();</span>
<a href="#l18.194"></a><span id="l18.194" class="difflineminus">-      do_print(&quot;Msg hdr offset = &quot; + offset.value);</span>
<a href="#l18.195"></a><span id="l18.195" class="difflineminus">-    }</span>
<a href="#l18.196"></a><span id="l18.196" class="difflineminus">-</span>
<a href="#l18.197"></a><span id="l18.197" class="difflineminus">-    try {</span>
<a href="#l18.198"></a><span id="l18.198" class="difflineminus">-      do_timeout(1000, endTest);</span>
<a href="#l18.199"></a><span id="l18.199" class="difflineminus">-    } catch(ex) {</span>
<a href="#l18.200"></a><span id="l18.200" class="difflineminus">-      do_throw(ex);</span>
<a href="#l18.201"></a><span id="l18.201" class="difflineminus">-    }</span>
<a href="#l18.202"></a><span id="l18.202" class="difflineplus">+    gIMAPInbox.getOfflineFileStream(header.messageKey, offset, size).close();</span>
<a href="#l18.203"></a><span id="l18.203" class="difflineplus">+    do_print(&quot;Msg hdr offset = &quot; + offset.value);</span>
<a href="#l18.204"></a><span id="l18.204">   }</span>
<a href="#l18.205"></a><span id="l18.205"> };</span>
<a href="#l18.206"></a><span id="l18.206"> </span>
<a href="#l18.207"></a><span id="l18.207" class="difflineminus">-function endTest()</span>
<a href="#l18.208"></a><span id="l18.208" class="difflineminus">-{</span>
<a href="#l18.209"></a><span id="l18.209" class="difflineplus">+function teardown() {</span>
<a href="#l18.210"></a><span id="l18.210">   // Free up disk space - if you want to look at the file after running</span>
<a href="#l18.211"></a><span id="l18.211">   // this test, comment out this line.</span>
<a href="#l18.212"></a><span id="l18.212">   if (gIMAPInbox)</span>
<a href="#l18.213"></a><span id="l18.213">     gIMAPInbox.filePath.remove(false);</span>
<a href="#l18.214"></a><span id="l18.214"> </span>
<a href="#l18.215"></a><span id="l18.215" class="difflineminus">-  if (gIMAPIncomingServer)</span>
<a href="#l18.216"></a><span id="l18.216" class="difflineminus">-    gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l18.217"></a><span id="l18.217" class="difflineminus">-  if (gServer)</span>
<a href="#l18.218"></a><span id="l18.218" class="difflineminus">-    gServer.stop();</span>
<a href="#l18.219"></a><span id="l18.219" class="difflineminus">-</span>
<a href="#l18.220"></a><span id="l18.220" class="difflineminus">-  let thread = gThreadManager.currentThread;</span>
<a href="#l18.221"></a><span id="l18.221" class="difflineminus">-  while (thread.hasPendingEvents())</span>
<a href="#l18.222"></a><span id="l18.222" class="difflineminus">-    thread.processNextEvent(true);</span>
<a href="#l18.223"></a><span id="l18.223" class="difflineminus">-</span>
<a href="#l18.224"></a><span id="l18.224" class="difflineminus">-  do_test_finished();</span>
<a href="#l18.225"></a><span id="l18.225" class="difflineplus">+  teardownIMAPPump();</span>
<a href="#l18.226"></a><span id="l18.226"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_listClosesDB.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_listClosesDB.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -1,90 +1,59 @@</span>
<a href="#l19.4"></a><span id="l19.4"> // This file tests that listing folders on startup because we're not using</span>
<a href="#l19.5"></a><span id="l19.5"> // subscription doesn't leave db's open.</span>
<a href="#l19.6"></a><span id="l19.6"> </span>
<a href="#l19.7"></a><span id="l19.7" class="difflineminus">-var gServer, gImapServer;</span>
<a href="#l19.8"></a><span id="l19.8" class="difflineminus">-var gIMAPInbox;</span>
<a href="#l19.9"></a><span id="l19.9" class="difflineplus">+load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l19.10"></a><span id="l19.10" class="difflineplus">+load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l19.11"></a><span id="l19.11" class="difflineplus">+load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+</span>
<a href="#l19.15"></a><span id="l19.15"> var gSub3;</span>
<a href="#l19.16"></a><span id="l19.16"> </span>
<a href="#l19.17"></a><span id="l19.17" class="difflineminus">-function run_test() {</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineminus">-  loadLocalMailAccount();</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineminus">-</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineminus">-  var daemon = new imapDaemon();</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineminus">-  daemon.createMailbox(&quot;folder1&quot;, {subscribed : true});</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineminus">-  daemon.createMailbox(&quot;folder1/sub1&quot;, &quot;&quot;, {subscribed : true});</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineminus">-  daemon.createMailbox(&quot;folder1/sub1/sub2&quot;, &quot;&quot;, {subscribed : true});</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineminus">-  daemon.createMailbox(&quot;folder1/sub1/sub2/sub3&quot;, &quot;&quot;, {subscribed : true});</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineminus">-  gServer = makeServer(daemon, &quot;&quot;);</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineminus">-</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineminus">-  gImapServer = createLocalIMAPServer();</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineminus">-  gImapServer.maximumConnectionsNumber = 1;</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineminus">-  gImapServer.usingSubscription = false;</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineplus">+var tests = [</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineplus">+  setup,</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineplus">+  updateInbox,</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineplus">+  checkCachedDBForFolder,</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineplus">+  teardown</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineplus">+];</span>
<a href="#l19.36"></a><span id="l19.36"> </span>
<a href="#l19.37"></a><span id="l19.37" class="difflineminus">-  // We need an identity so that updateFolder doesn't fail</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineminus">-  let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineminus">-                .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineminus">-  let localAccount = acctMgr.createAccount();</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineminus">-  let identity = acctMgr.createIdentity();</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineminus">-  localAccount.addIdentity(identity);</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineminus">-  localAccount.defaultIdentity = identity;</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineminus">-  localAccount.incomingServer = gLocalIncomingServer;</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineminus">-  acctMgr.defaultAccount = localAccount;</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineplus">+function setup() {</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineplus">+  setupIMAPPump();</span>
<a href="#l19.48"></a><span id="l19.48"> </span>
<a href="#l19.49"></a><span id="l19.49" class="difflineminus">-  // Let's also have another account, using the same identity</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineminus">-  let imapAccount = acctMgr.createAccount();</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineminus">-  imapAccount.addIdentity(identity);</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineminus">-  imapAccount.defaultIdentity = identity;</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineminus">-  imapAccount.incomingServer = gImapServer;</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineplus">+  gIMAPDaemon.createMailbox(&quot;folder1&quot;, {subscribed : true});</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineplus">+  gIMAPDaemon.createMailbox(&quot;folder1/sub1&quot;, &quot;&quot;, {subscribed : true});</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineplus">+  gIMAPDaemon.createMailbox(&quot;folder1/sub1/sub2&quot;, &quot;&quot;, {subscribed : true});</span>
<a href="#l19.57"></a><span id="l19.57" class="difflineplus">+  gIMAPDaemon.createMailbox(&quot;folder1/sub1/sub2/sub3&quot;, &quot;&quot;, {subscribed : true});</span>
<a href="#l19.58"></a><span id="l19.58"> </span>
<a href="#l19.59"></a><span id="l19.59" class="difflineminus">-  // pref tuning: one connection only, turn off notifications</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineminus">-  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineminus">-                     .getService(Ci.nsIPrefBranch);</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineminus">-  // Make sure no biff notifications happen</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineplus">+  gIMAPIncomingServer.usingSubscription = false;</span>
<a href="#l19.68"></a><span id="l19.68"> </span>
<a href="#l19.69"></a><span id="l19.69" class="difflineminus">-  let rootFolder = gImapServer.rootFolder.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l19.70"></a><span id="l19.70" class="difflineminus">-  gIMAPInbox = rootFolder.getFolderWithFlags(Ci.nsMsgFolderFlags.Inbox)</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineminus">-                         .QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineplus">+  let rootFolder = gIMAPIncomingServer.rootFolder.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l19.73"></a><span id="l19.73">   rootFolder.hierarchyDelimiter = '/';</span>
<a href="#l19.74"></a><span id="l19.74">   gIMAPInbox.hierarchyDelimiter = '/';</span>
<a href="#l19.75"></a><span id="l19.75">   rootFolder.addSubfolder(&quot;folder1&quot;);</span>
<a href="#l19.76"></a><span id="l19.76">   rootFolder.addSubfolder(&quot;folder1/sub1&quot;);</span>
<a href="#l19.77"></a><span id="l19.77">   rootFolder.addSubfolder(&quot;folder1/sub1/sub2&quot;);</span>
<a href="#l19.78"></a><span id="l19.78">   gSub3 = rootFolder.addSubfolder(&quot;folder1/sub1/sub2/sub3&quot;);</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineminus">-  gImapServer.performExpand(null);</span>
<a href="#l19.80"></a><span id="l19.80" class="difflineminus">-  gServer.performTest(&quot;LIST&quot;);</span>
<a href="#l19.81"></a><span id="l19.81" class="difflineplus">+  gIMAPServer.performTest(&quot;LIST&quot;);</span>
<a href="#l19.82"></a><span id="l19.82"> </span>
<a href="#l19.83"></a><span id="l19.83" class="difflineminus">-  do_test_pending();</span>
<a href="#l19.84"></a><span id="l19.84" class="difflineminus">-  do_timeout_function(1000, updateInbox);</span>
<a href="#l19.85"></a><span id="l19.85" class="difflineplus">+  do_timeout(1000, async_driver);</span>
<a href="#l19.86"></a><span id="l19.86" class="difflineplus">+  yield false;</span>
<a href="#l19.87"></a><span id="l19.87"> }</span>
<a href="#l19.88"></a><span id="l19.88"> </span>
<a href="#l19.89"></a><span id="l19.89" class="difflineminus">-function updateInbox()</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineminus">-{</span>
<a href="#l19.91"></a><span id="l19.91" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, UrlListener);</span>
<a href="#l19.92"></a><span id="l19.92" class="difflineplus">+function updateInbox() {</span>
<a href="#l19.93"></a><span id="l19.93" class="difflineplus">+  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l19.94"></a><span id="l19.94" class="difflineplus">+  yield false;</span>
<a href="#l19.95"></a><span id="l19.95"> }</span>
<a href="#l19.96"></a><span id="l19.96"> </span>
<a href="#l19.97"></a><span id="l19.97" class="difflineminus">-var UrlListener =</span>
<a href="#l19.98"></a><span id="l19.98" class="difflineminus">-{</span>
<a href="#l19.99"></a><span id="l19.99" class="difflineminus">-  OnStartRunningUrl: function(url) { },</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineminus">-  OnStopRunningUrl: function(url, rc)</span>
<a href="#l19.101"></a><span id="l19.101" class="difflineminus">-  {</span>
<a href="#l19.102"></a><span id="l19.102" class="difflineminus">-    // Check for ok status.</span>
<a href="#l19.103"></a><span id="l19.103" class="difflineminus">-    do_check_eq(rc, 0);</span>
<a href="#l19.104"></a><span id="l19.104" class="difflineminus">-    try {</span>
<a href="#l19.105"></a><span id="l19.105" class="difflineminus">-      const gDbService = Cc[&quot;@mozilla.org/msgDatabase/msgDBService;1&quot;]</span>
<a href="#l19.106"></a><span id="l19.106" class="difflineminus">-                           .getService(Ci.nsIMsgDBService);</span>
<a href="#l19.107"></a><span id="l19.107" class="difflineminus">-      do_check_eq(gDbService.cachedDBForFolder(gSub3), null);</span>
<a href="#l19.108"></a><span id="l19.108" class="difflineminus">-      do_timeout_function(1000, endTest);</span>
<a href="#l19.109"></a><span id="l19.109" class="difflineminus">-    } catch (ex) {dump (ex);}</span>
<a href="#l19.110"></a><span id="l19.110" class="difflineminus">-  }</span>
<a href="#l19.111"></a><span id="l19.111" class="difflineminus">-};</span>
<a href="#l19.112"></a><span id="l19.112" class="difflineplus">+function checkCachedDBForFolder() {</span>
<a href="#l19.113"></a><span id="l19.113" class="difflineplus">+  const gDbService = Cc[&quot;@mozilla.org/msgDatabase/msgDBService;1&quot;]</span>
<a href="#l19.114"></a><span id="l19.114" class="difflineplus">+                       .getService(Ci.nsIMsgDBService);</span>
<a href="#l19.115"></a><span id="l19.115" class="difflineplus">+  do_check_eq(gDbService.cachedDBForFolder(gSub3), null);</span>
<a href="#l19.116"></a><span id="l19.116" class="difflineplus">+}</span>
<a href="#l19.117"></a><span id="l19.117"> </span>
<a href="#l19.118"></a><span id="l19.118" class="difflineminus">-function endTest()</span>
<a href="#l19.119"></a><span id="l19.119" class="difflineminus">-{</span>
<a href="#l19.120"></a><span id="l19.120" class="difflineminus">-  gImapServer.closeCachedConnections();</span>
<a href="#l19.121"></a><span id="l19.121" class="difflineminus">-  gServer.performTest();</span>
<a href="#l19.122"></a><span id="l19.122" class="difflineminus">-  gServer.stop();</span>
<a href="#l19.123"></a><span id="l19.123" class="difflineminus">-  do_test_finished();</span>
<a href="#l19.124"></a><span id="l19.124" class="difflineplus">+function teardown() {</span>
<a href="#l19.125"></a><span id="l19.125" class="difflineplus">+  teardownIMAPPump();</span>
<a href="#l19.126"></a><span id="l19.126"> }</span>
<a href="#l19.127"></a><span id="l19.127" class="difflineplus">+</span>
<a href="#l19.128"></a><span id="l19.128" class="difflineplus">+function run_test() {</span>
<a href="#l19.129"></a><span id="l19.129" class="difflineplus">+  async_run_tests(tests);</span>
<a href="#l19.130"></a><span id="l19.130" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_localToImapFilter.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_localToImapFilter.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -2,47 +2,50 @@</span>
<a href="#l20.4"></a><span id="l20.4">  * This file tests copies of multiple messages using filters</span>
<a href="#l20.5"></a><span id="l20.5">  * from incoming POP3, with filter actions copying and moving</span>
<a href="#l20.6"></a><span id="l20.6">  * messages to IMAP folders. This test is adapted from</span>
<a href="#l20.7"></a><span id="l20.7">  * test_imapFolderCopy.js</span>
<a href="#l20.8"></a><span id="l20.8">  *</span>
<a href="#l20.9"></a><span id="l20.9">  * Original author: Kent James &lt;kent@caspia.com&gt;</span>
<a href="#l20.10"></a><span id="l20.10">  */</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l20.15"></a><span id="l20.15"> load(&quot;../../../resources/POP3pump.js&quot;);</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineplus">+load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l20.17"></a><span id="l20.17"> Components.utils.import(&quot;resource:///modules/folderUtils.jsm&quot;);</span>
<a href="#l20.18"></a><span id="l20.18"> Components.utils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l20.19"></a><span id="l20.19"> </span>
<a href="#l20.20"></a><span id="l20.20" class="difflineminus">-var gRootFolder;</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineminus">-var gIMAPInbox, gIMAPTrashFolder;</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineplus">+var gIMAPTrashFolder;</span>
<a href="#l20.23"></a><span id="l20.23"> var gEmptyLocal1, gEmptyLocal2;</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineminus">-var gIMAPDaemon, gServer, gIMAPIncomingServer;</span>
<a href="#l20.25"></a><span id="l20.25"> var gLastKey;</span>
<a href="#l20.26"></a><span id="l20.26"> var gMessages = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l20.27"></a><span id="l20.27"> var gCopyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l20.28"></a><span id="l20.28">                 .getService(Ci.nsIMsgCopyService);</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineminus">-var gCurTestNum;</span>
<a href="#l20.30"></a><span id="l20.30"> const gFiles = [&quot;../../../data/bugmail1&quot;,</span>
<a href="#l20.31"></a><span id="l20.31">                 &quot;../../../data/draft1&quot;];</span>
<a href="#l20.32"></a><span id="l20.32"> </span>
<a href="#l20.33"></a><span id="l20.33" class="difflineminus">-const gTestArray =</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineminus">-[</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineplus">+var tests = [</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineplus">+  setup,</span>
<a href="#l20.37"></a><span id="l20.37">   function copyFolder1() {</span>
<a href="#l20.38"></a><span id="l20.38">     dump(&quot;gEmpty1 &quot; + gEmptyLocal1.URI + &quot;\n&quot;);</span>
<a href="#l20.39"></a><span id="l20.39">     let folders = new Array;</span>
<a href="#l20.40"></a><span id="l20.40">     folders.push(gEmptyLocal1.QueryInterface(Ci.nsIMsgFolder));</span>
<a href="#l20.41"></a><span id="l20.41">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l20.42"></a><span id="l20.42">     gCopyService.CopyFolders(array, gIMAPInbox, false, CopyListener, null);</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineplus">+    yield false;</span>
<a href="#l20.44"></a><span id="l20.44">   },</span>
<a href="#l20.45"></a><span id="l20.45">   function copyFolder2() {</span>
<a href="#l20.46"></a><span id="l20.46">     dump(&quot;gEmpty2 &quot; + gEmptyLocal2.URI + &quot;\n&quot;);</span>
<a href="#l20.47"></a><span id="l20.47">     let folders = new Array;</span>
<a href="#l20.48"></a><span id="l20.48">     folders.push(gEmptyLocal2);</span>
<a href="#l20.49"></a><span id="l20.49">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l20.50"></a><span id="l20.50">     gCopyService.CopyFolders(array, gIMAPInbox, false, CopyListener, null);</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineplus">+    yield false;</span>
<a href="#l20.52"></a><span id="l20.52">   },</span>
<a href="#l20.53"></a><span id="l20.53">   function getLocalMessages() {</span>
<a href="#l20.54"></a><span id="l20.54">     // setup copy then move mail filters on the inbox</span>
<a href="#l20.55"></a><span id="l20.55">     let filterList = gPOP3Pump.fakeServer.getFilterList(null);</span>
<a href="#l20.56"></a><span id="l20.56">     let filter = filterList.createFilter(&quot;copyThenMoveAll&quot;);</span>
<a href="#l20.57"></a><span id="l20.57">     let searchTerm = filter.createTerm();</span>
<a href="#l20.58"></a><span id="l20.58">     searchTerm.matchAll = true;</span>
<a href="#l20.59"></a><span id="l20.59">     filter.appendTerm(searchTerm);</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineat">@@ -53,210 +56,115 @@ const gTestArray =</span>
<a href="#l20.61"></a><span id="l20.61">     let moveAction = filter.createAction();</span>
<a href="#l20.62"></a><span id="l20.62">     moveAction.type = Ci.nsMsgFilterAction.MoveToFolder;</span>
<a href="#l20.63"></a><span id="l20.63">     moveAction.targetFolderUri = gIMAPInbox.getChildNamed(&quot;empty 2&quot;).URI;</span>
<a href="#l20.64"></a><span id="l20.64">     filter.appendAction(moveAction);</span>
<a href="#l20.65"></a><span id="l20.65">     filter.enabled = true;</span>
<a href="#l20.66"></a><span id="l20.66">     filterList.insertFilterAt(0, filter);</span>
<a href="#l20.67"></a><span id="l20.67"> </span>
<a href="#l20.68"></a><span id="l20.68">     gPOP3Pump.files = gFiles;</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineminus">-    gPOP3Pump.onDone = &quot;doTest();&quot;;</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineminus">-    ++gCurTestNum;</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineplus">+    gPOP3Pump.onDone = async_driver;</span>
<a href="#l20.72"></a><span id="l20.72">     gPOP3Pump.run();</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineplus">+    yield false;</span>
<a href="#l20.74"></a><span id="l20.74">   },</span>
<a href="#l20.75"></a><span id="l20.75">   function update1() {</span>
<a href="#l20.76"></a><span id="l20.76">     let folder1 = gIMAPInbox.getChildNamed(&quot;empty 1&quot;).QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineminus">-    folder1.updateFolderWithListener(null, URLListener);</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineplus">+    folder1.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineplus">+    yield false;</span>
<a href="#l20.80"></a><span id="l20.80">   },</span>
<a href="#l20.81"></a><span id="l20.81">   function update2() {</span>
<a href="#l20.82"></a><span id="l20.82">     let folder2 = gIMAPInbox.getChildNamed(&quot;empty 2&quot;).QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineminus">-    folder2.updateFolderWithListener(null, URLListener);</span>
<a href="#l20.84"></a><span id="l20.84" class="difflineplus">+    folder2.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l20.85"></a><span id="l20.85" class="difflineplus">+    yield false;</span>
<a href="#l20.86"></a><span id="l20.86">   },</span>
<a href="#l20.87"></a><span id="l20.87">   function verifyFolders() {</span>
<a href="#l20.88"></a><span id="l20.88">     let folder1 = gIMAPInbox.getChildNamed(&quot;empty 1&quot;);</span>
<a href="#l20.89"></a><span id="l20.89">     listMessages(folder1);</span>
<a href="#l20.90"></a><span id="l20.90">     let folder2 = gIMAPInbox.getChildNamed(&quot;empty 2&quot;);</span>
<a href="#l20.91"></a><span id="l20.91">     listMessages(folder2);</span>
<a href="#l20.92"></a><span id="l20.92">     listMessages(gLocalInboxFolder);</span>
<a href="#l20.93"></a><span id="l20.93">     do_check_neq(folder1, null);</span>
<a href="#l20.94"></a><span id="l20.94">     do_check_neq(folder2, null);</span>
<a href="#l20.95"></a><span id="l20.95">     // folder 1 and 2 should each now have 2 messages in them.</span>
<a href="#l20.96"></a><span id="l20.96">     do_check_eq(folderCount(folder1), 2);</span>
<a href="#l20.97"></a><span id="l20.97">     do_check_eq(folderCount(folder2), 2);</span>
<a href="#l20.98"></a><span id="l20.98">     // the local inbox folder should now be empty, since the second</span>
<a href="#l20.99"></a><span id="l20.99">     // operation was a move</span>
<a href="#l20.100"></a><span id="l20.100">     do_check_eq(folderCount(gLocalInboxFolder), 0);</span>
<a href="#l20.101"></a><span id="l20.101" class="difflineminus">-    doTest(++gCurTestNum);</span>
<a href="#l20.102"></a><span id="l20.102">   },</span>
<a href="#l20.103"></a><span id="l20.103" class="difflineminus">-</span>
<a href="#l20.104"></a><span id="l20.104" class="difflineplus">+  teardown</span>
<a href="#l20.105"></a><span id="l20.105"> ];</span>
<a href="#l20.106"></a><span id="l20.106"> </span>
<a href="#l20.107"></a><span id="l20.107"> function folderCount(folder)</span>
<a href="#l20.108"></a><span id="l20.108"> {</span>
<a href="#l20.109"></a><span id="l20.109">   let enumerator = folder.msgDatabase.EnumerateMessages();</span>
<a href="#l20.110"></a><span id="l20.110">   let count = 0;</span>
<a href="#l20.111"></a><span id="l20.111">   while (enumerator.hasMoreElements())</span>
<a href="#l20.112"></a><span id="l20.112">   {</span>
<a href="#l20.113"></a><span id="l20.113">     count++;</span>
<a href="#l20.114"></a><span id="l20.114">     let hdr = enumerator.getNext();</span>
<a href="#l20.115"></a><span id="l20.115">   }</span>
<a href="#l20.116"></a><span id="l20.116">   return count;</span>
<a href="#l20.117"></a><span id="l20.117"> }</span>
<a href="#l20.118"></a><span id="l20.118"> </span>
<a href="#l20.119"></a><span id="l20.119" class="difflineminus">-function run_test()</span>
<a href="#l20.120"></a><span id="l20.120" class="difflineminus">-{</span>
<a href="#l20.121"></a><span id="l20.121" class="difflineminus">-  // XXX Disabled due to intermittent failures, bug 502928 will fix.</span>
<a href="#l20.122"></a><span id="l20.122" class="difflineminus">-  return 0;</span>
<a href="#l20.123"></a><span id="l20.123" class="difflineminus">-</span>
<a href="#l20.124"></a><span id="l20.124" class="difflineminus">-  // Add a listener.</span>
<a href="#l20.125"></a><span id="l20.125" class="difflineminus">-  gIMAPDaemon = new imapDaemon();</span>
<a href="#l20.126"></a><span id="l20.126" class="difflineminus">-  gServer = makeServer(gIMAPDaemon, &quot;&quot;);</span>
<a href="#l20.127"></a><span id="l20.127" class="difflineminus">-</span>
<a href="#l20.128"></a><span id="l20.128" class="difflineminus">-  gIMAPIncomingServer = createLocalIMAPServer();</span>
<a href="#l20.129"></a><span id="l20.129" class="difflineminus">-</span>
<a href="#l20.130"></a><span id="l20.130" class="difflineminus">-  if (!gLocalInboxFolder)</span>
<a href="#l20.131"></a><span id="l20.131" class="difflineminus">-    loadLocalMailAccount();</span>
<a href="#l20.132"></a><span id="l20.132" class="difflineminus">-</span>
<a href="#l20.133"></a><span id="l20.133" class="difflineminus">-  // We need an identity so that updateFolder doesn't fail</span>
<a href="#l20.134"></a><span id="l20.134" class="difflineminus">-  let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l20.135"></a><span id="l20.135" class="difflineminus">-                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l20.136"></a><span id="l20.136" class="difflineminus">-  let localAccount = acctMgr.createAccount();</span>
<a href="#l20.137"></a><span id="l20.137" class="difflineminus">-  let identity = acctMgr.createIdentity();</span>
<a href="#l20.138"></a><span id="l20.138" class="difflineminus">-  localAccount.addIdentity(identity);</span>
<a href="#l20.139"></a><span id="l20.139" class="difflineminus">-  localAccount.defaultIdentity = identity;</span>
<a href="#l20.140"></a><span id="l20.140" class="difflineminus">-  localAccount.incomingServer = gLocalIncomingServer;</span>
<a href="#l20.141"></a><span id="l20.141" class="difflineminus">-  acctMgr.defaultAccount = localAccount;</span>
<a href="#l20.142"></a><span id="l20.142" class="difflineminus">-</span>
<a href="#l20.143"></a><span id="l20.143" class="difflineminus">-  // Let's also have another account, using the same identity</span>
<a href="#l20.144"></a><span id="l20.144" class="difflineminus">-  let imapAccount = acctMgr.createAccount();</span>
<a href="#l20.145"></a><span id="l20.145" class="difflineminus">-  imapAccount.addIdentity(identity);</span>
<a href="#l20.146"></a><span id="l20.146" class="difflineminus">-  imapAccount.defaultIdentity = identity;</span>
<a href="#l20.147"></a><span id="l20.147" class="difflineminus">-  imapAccount.incomingServer = gIMAPIncomingServer;</span>
<a href="#l20.148"></a><span id="l20.148" class="difflineminus">-</span>
<a href="#l20.149"></a><span id="l20.149" class="difflineminus">-  // The server doesn't support more than one connection</span>
<a href="#l20.150"></a><span id="l20.150" class="difflineminus">-  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l20.151"></a><span id="l20.151" class="difflineminus">-                     .getService(Ci.nsIPrefBranch);</span>
<a href="#l20.152"></a><span id="l20.152" class="difflineminus">-  prefBranch.setIntPref(&quot;mail.server.default.max_cached_connections&quot;, 1);</span>
<a href="#l20.153"></a><span id="l20.153" class="difflineminus">-  // We aren't interested in downloading messages automatically</span>
<a href="#l20.154"></a><span id="l20.154" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.server.default.download_on_biff&quot;, false);</span>
<a href="#l20.155"></a><span id="l20.155" class="difflineminus">-</span>
<a href="#l20.156"></a><span id="l20.156" class="difflineplus">+function setup() {</span>
<a href="#l20.157"></a><span id="l20.157" class="difflineplus">+  setupIMAPPump(); </span>
<a href="#l20.158"></a><span id="l20.158">   gEmptyLocal1 = gLocalIncomingServer.rootFolder.createLocalSubfolder(&quot;empty 1&quot;);</span>
<a href="#l20.159"></a><span id="l20.159">   gEmptyLocal2 = gLocalIncomingServer.rootFolder.createLocalSubfolder(&quot;empty 2&quot;);</span>
<a href="#l20.160"></a><span id="l20.160" class="difflineminus">-  gIMAPIncomingServer.performExpand(null);</span>
<a href="#l20.161"></a><span id="l20.161"> </span>
<a href="#l20.162"></a><span id="l20.162" class="difflineminus">-  gRootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l20.163"></a><span id="l20.163" class="difflineminus">-  gIMAPInbox = gRootFolder.getChildNamed(&quot;INBOX&quot;);</span>
<a href="#l20.164"></a><span id="l20.164" class="difflineminus">-  dump(&quot;gIMAPInbox uri = &quot; + gIMAPInbox.URI + &quot;\n&quot;);</span>
<a href="#l20.165"></a><span id="l20.165" class="difflineminus">-  let msgImapFolder = gIMAPInbox.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l20.166"></a><span id="l20.166">   // these hacks are required because we've created the inbox before</span>
<a href="#l20.167"></a><span id="l20.167">   // running initial folder discovery, and adding the folder bails</span>
<a href="#l20.168"></a><span id="l20.168">   // out before we set it as verified online, so we bail out, and</span>
<a href="#l20.169"></a><span id="l20.169">   // then remove the INBOX folder since it's not verified.</span>
<a href="#l20.170"></a><span id="l20.170" class="difflineminus">-  msgImapFolder.hierarchyDelimiter = '/';</span>
<a href="#l20.171"></a><span id="l20.171" class="difflineminus">-  msgImapFolder.verifiedAsOnlineFolder = true;</span>
<a href="#l20.172"></a><span id="l20.172" class="difflineminus">-</span>
<a href="#l20.173"></a><span id="l20.173" class="difflineminus">-  // &quot;Master&quot; do_test_pending(), paired with a do_test_finished() at the end of</span>
<a href="#l20.174"></a><span id="l20.174" class="difflineminus">-  // all the operations.</span>
<a href="#l20.175"></a><span id="l20.175" class="difflineminus">-  do_test_pending();</span>
<a href="#l20.176"></a><span id="l20.176" class="difflineminus">-</span>
<a href="#l20.177"></a><span id="l20.177" class="difflineminus">-  //start first test</span>
<a href="#l20.178"></a><span id="l20.178" class="difflineminus">-  gCurTestNum = 1;</span>
<a href="#l20.179"></a><span id="l20.179" class="difflineminus">-  doTest();</span>
<a href="#l20.180"></a><span id="l20.180" class="difflineminus">-}</span>
<a href="#l20.181"></a><span id="l20.181" class="difflineminus">-</span>
<a href="#l20.182"></a><span id="l20.182" class="difflineminus">-function doTest()</span>
<a href="#l20.183"></a><span id="l20.183" class="difflineminus">-{</span>
<a href="#l20.184"></a><span id="l20.184" class="difflineminus">-  var test = gCurTestNum;</span>
<a href="#l20.185"></a><span id="l20.185" class="difflineminus">-  if (test &lt;= gTestArray.length)</span>
<a href="#l20.186"></a><span id="l20.186" class="difflineminus">-  {</span>
<a href="#l20.187"></a><span id="l20.187" class="difflineminus">-    dump(&quot;Doing test &quot; + test + &quot;\n&quot;);</span>
<a href="#l20.188"></a><span id="l20.188" class="difflineminus">-</span>
<a href="#l20.189"></a><span id="l20.189" class="difflineminus">-    var testFn = gTestArray[test-1];</span>
<a href="#l20.190"></a><span id="l20.190" class="difflineminus">-    // Set a limit of ten seconds; if the notifications haven't arrived by then there's a problem.</span>
<a href="#l20.191"></a><span id="l20.191" class="difflineminus">-    do_timeout(10000, function(){</span>
<a href="#l20.192"></a><span id="l20.192" class="difflineminus">-          if (gCurTestNum == test)</span>
<a href="#l20.193"></a><span id="l20.193" class="difflineminus">-            do_throw(&quot;Notifications not received in 10000 ms for operation &quot; + testFn.name);</span>
<a href="#l20.194"></a><span id="l20.194" class="difflineminus">-        }</span>
<a href="#l20.195"></a><span id="l20.195" class="difflineminus">-      );</span>
<a href="#l20.196"></a><span id="l20.196" class="difflineminus">-    try {</span>
<a href="#l20.197"></a><span id="l20.197" class="difflineminus">-    testFn();</span>
<a href="#l20.198"></a><span id="l20.198" class="difflineminus">-    } catch(ex) {</span>
<a href="#l20.199"></a><span id="l20.199" class="difflineminus">-      gServer.stop();</span>
<a href="#l20.200"></a><span id="l20.200" class="difflineminus">-      do_throw ('TEST FAILED ' + ex);</span>
<a href="#l20.201"></a><span id="l20.201" class="difflineminus">-    }</span>
<a href="#l20.202"></a><span id="l20.202" class="difflineminus">-  }</span>
<a href="#l20.203"></a><span id="l20.203" class="difflineminus">-  else</span>
<a href="#l20.204"></a><span id="l20.204" class="difflineminus">-    do_timeout(1000, endTest);</span>
<a href="#l20.205"></a><span id="l20.205" class="difflineplus">+  gIMAPInbox.hierarchyDelimiter = '/';</span>
<a href="#l20.206"></a><span id="l20.206" class="difflineplus">+  gIMAPInbox.verifiedAsOnlineFolder = true;</span>
<a href="#l20.207"></a><span id="l20.207"> }</span>
<a href="#l20.208"></a><span id="l20.208"> </span>
<a href="#l20.209"></a><span id="l20.209"> // nsIMsgCopyServiceListener implementation - runs next test when copy</span>
<a href="#l20.210"></a><span id="l20.210"> // is completed.</span>
<a href="#l20.211"></a><span id="l20.211"> var CopyListener =</span>
<a href="#l20.212"></a><span id="l20.212"> {</span>
<a href="#l20.213"></a><span id="l20.213">   OnStartCopy: function OnStartCopy() {},</span>
<a href="#l20.214"></a><span id="l20.214">   OnProgress: function OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l20.215"></a><span id="l20.215">   SetMessageKey: function SetMessageKey(aKey)</span>
<a href="#l20.216"></a><span id="l20.216">   {</span>
<a href="#l20.217"></a><span id="l20.217">     gLastKey = aKey;</span>
<a href="#l20.218"></a><span id="l20.218">   },</span>
<a href="#l20.219"></a><span id="l20.219">   SetMessageId: function SetMessageId(aMessageId) {},</span>
<a href="#l20.220"></a><span id="l20.220">   OnStopCopy: function OnStopCopy(aStatus)</span>
<a href="#l20.221"></a><span id="l20.221">   {</span>
<a href="#l20.222"></a><span id="l20.222" class="difflineminus">-    dump(&quot;in OnStopCopy &quot; + gCurTestNum + &quot;\n&quot;);</span>
<a href="#l20.223"></a><span id="l20.223">     // Check: message successfully copied.</span>
<a href="#l20.224"></a><span id="l20.224">     do_check_eq(aStatus, 0);</span>
<a href="#l20.225"></a><span id="l20.225" class="difflineminus">-    // Ugly hack: make sure we don't get stuck in a JS-&gt;C++-&gt;JS-&gt;C++... call stack</span>
<a href="#l20.226"></a><span id="l20.226" class="difflineminus">-    // This can happen with a bunch of synchronous functions grouped together, and</span>
<a href="#l20.227"></a><span id="l20.227" class="difflineminus">-    // can even cause tests to fail because they're still waiting for the listener</span>
<a href="#l20.228"></a><span id="l20.228" class="difflineminus">-    // to return</span>
<a href="#l20.229"></a><span id="l20.229" class="difflineminus">-    ++gCurTestNum;</span>
<a href="#l20.230"></a><span id="l20.230" class="difflineminus">-    do_timeout(0, doTest);</span>
<a href="#l20.231"></a><span id="l20.231" class="difflineplus">+    async_driver();</span>
<a href="#l20.232"></a><span id="l20.232">   }</span>
<a href="#l20.233"></a><span id="l20.233"> };</span>
<a href="#l20.234"></a><span id="l20.234"> </span>
<a href="#l20.235"></a><span id="l20.235" class="difflineminus">-// nsIURLListener implementation - runs next test</span>
<a href="#l20.236"></a><span id="l20.236" class="difflineminus">-var URLListener =</span>
<a href="#l20.237"></a><span id="l20.237" class="difflineminus">-{</span>
<a href="#l20.238"></a><span id="l20.238" class="difflineminus">-  OnStartRunningUrl: function OnStartRunningUrl(aURL) {},</span>
<a href="#l20.239"></a><span id="l20.239" class="difflineminus">-  OnStopRunningUrl: function OnStopRunningUrl(aURL, aStatus)</span>
<a href="#l20.240"></a><span id="l20.240" class="difflineminus">-  {</span>
<a href="#l20.241"></a><span id="l20.241" class="difflineminus">-    dump(&quot;in OnStopRunningURL &quot; + gCurTestNum + &quot;\n&quot;);</span>
<a href="#l20.242"></a><span id="l20.242" class="difflineminus">-    do_check_eq(aStatus, 0);</span>
<a href="#l20.243"></a><span id="l20.243" class="difflineminus">-    gCurTestNum++;</span>
<a href="#l20.244"></a><span id="l20.244" class="difflineminus">-    do_timeout(0, doTest);</span>
<a href="#l20.245"></a><span id="l20.245" class="difflineminus">-  }</span>
<a href="#l20.246"></a><span id="l20.246" class="difflineminus">-}</span>
<a href="#l20.247"></a><span id="l20.247" class="difflineminus">-</span>
<a href="#l20.248"></a><span id="l20.248" class="difflineminus">-function endTest()</span>
<a href="#l20.249"></a><span id="l20.249" class="difflineminus">-{</span>
<a href="#l20.250"></a><span id="l20.250" class="difflineminus">-  // Cleanup, null out everything, close all cached connections and stop the</span>
<a href="#l20.251"></a><span id="l20.251" class="difflineminus">-  // server</span>
<a href="#l20.252"></a><span id="l20.252" class="difflineminus">-  dump(&quot; Exiting mail tests\n&quot;);</span>
<a href="#l20.253"></a><span id="l20.253" class="difflineminus">-  gMessages.clear();</span>
<a href="#l20.254"></a><span id="l20.254" class="difflineminus">-  gRootFolder = null;</span>
<a href="#l20.255"></a><span id="l20.255" class="difflineminus">-  gIMAPInbox = null;</span>
<a href="#l20.256"></a><span id="l20.256" class="difflineminus">-  gIMAPTrashFolder = null;</span>
<a href="#l20.257"></a><span id="l20.257" class="difflineminus">-  gEmptyLocal1 = null;</span>
<a href="#l20.258"></a><span id="l20.258" class="difflineminus">-  gEmptyLocal2 = null;</span>
<a href="#l20.259"></a><span id="l20.259" class="difflineminus">-  gServer.resetTest();</span>
<a href="#l20.260"></a><span id="l20.260" class="difflineminus">-  gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l20.261"></a><span id="l20.261" class="difflineminus">-  gServer.performTest();</span>
<a href="#l20.262"></a><span id="l20.262" class="difflineminus">-  gServer.stop();</span>
<a href="#l20.263"></a><span id="l20.263" class="difflineminus">-  let thread = gThreadManager.currentThread;</span>
<a href="#l20.264"></a><span id="l20.264" class="difflineminus">-  while (thread.hasPendingEvents())</span>
<a href="#l20.265"></a><span id="l20.265" class="difflineminus">-    thread.processNextEvent(true);</span>
<a href="#l20.266"></a><span id="l20.266" class="difflineminus">-  gPOP3Pump = null;</span>
<a href="#l20.267"></a><span id="l20.267" class="difflineminus">-</span>
<a href="#l20.268"></a><span id="l20.268" class="difflineminus">-  do_test_finished(); // for the one in run_test()</span>
<a href="#l20.269"></a><span id="l20.269" class="difflineminus">-}</span>
<a href="#l20.270"></a><span id="l20.270" class="difflineplus">+asyncUrlListener.callback = function(aUrl, aExitCode) {</span>
<a href="#l20.271"></a><span id="l20.271" class="difflineplus">+  do_check_eq(aExitCode, 0);</span>
<a href="#l20.272"></a><span id="l20.272" class="difflineplus">+};</span>
<a href="#l20.273"></a><span id="l20.273"> </span>
<a href="#l20.274"></a><span id="l20.274"> function listMessages(folder) {</span>
<a href="#l20.275"></a><span id="l20.275">   let enumerator = folder.msgDatabase.EnumerateMessages();</span>
<a href="#l20.276"></a><span id="l20.276">   var msgCount = 0;</span>
<a href="#l20.277"></a><span id="l20.277">   dump(&quot;listing messages for &quot; + folder.prettyName + &quot;\n&quot;);</span>
<a href="#l20.278"></a><span id="l20.278">   while(enumerator.hasMoreElements())</span>
<a href="#l20.279"></a><span id="l20.279">   {</span>
<a href="#l20.280"></a><span id="l20.280">     msgCount++;</span>
<a href="#l20.281"></a><span id="l20.281">     let hdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l20.282"></a><span id="l20.282">     dump(msgCount + &quot;: &quot; + hdr.subject + &quot;\n&quot;);</span>
<a href="#l20.283"></a><span id="l20.283">   }</span>
<a href="#l20.284"></a><span id="l20.284"> }</span>
<a href="#l20.285"></a><span id="l20.285"> </span>
<a href="#l20.286"></a><span id="l20.286" class="difflineplus">+function teardown() {</span>
<a href="#l20.287"></a><span id="l20.287" class="difflineplus">+  gMessages.clear();</span>
<a href="#l20.288"></a><span id="l20.288" class="difflineplus">+  gIMAPTrashFolder = null;</span>
<a href="#l20.289"></a><span id="l20.289" class="difflineplus">+  gEmptyLocal1 = null;</span>
<a href="#l20.290"></a><span id="l20.290" class="difflineplus">+  gEmptyLocal2 = null;</span>
<a href="#l20.291"></a><span id="l20.291" class="difflineplus">+  gPOP3Pump = null;</span>
<a href="#l20.292"></a><span id="l20.292" class="difflineplus">+  teardownIMAPPump();</span>
<a href="#l20.293"></a><span id="l20.293" class="difflineplus">+}</span>
<a href="#l20.294"></a><span id="l20.294" class="difflineplus">+</span>
<a href="#l20.295"></a><span id="l20.295" class="difflineplus">+function run_test() {</span>
<a href="#l20.296"></a><span id="l20.296" class="difflineplus">+  // XXX Disabled due to intermittent failures, bug 502928 will fix.</span>
<a href="#l20.297"></a><span id="l20.297" class="difflineplus">+  return 0;</span>
<a href="#l20.298"></a><span id="l20.298" class="difflineplus">+</span>
<a href="#l20.299"></a><span id="l20.299" class="difflineplus">+  async_run_tests(tests);</span>
<a href="#l20.300"></a><span id="l20.300" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_mailboxes.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_mailboxes.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -1,152 +1,76 @@</span>
<a href="#l21.4"></a><span id="l21.4"> // This file tests the mailbox handling of IMAP.</span>
<a href="#l21.5"></a><span id="l21.5"> </span>
<a href="#l21.6"></a><span id="l21.6" class="difflineminus">-var gServer, gIMAPServer;</span>
<a href="#l21.7"></a><span id="l21.7" class="difflineminus">-var gCurTestNum = 0;</span>
<a href="#l21.8"></a><span id="l21.8" class="difflineminus">-var rootFolder;</span>
<a href="#l21.9"></a><span id="l21.9" class="difflineplus">+load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l21.10"></a><span id="l21.10" class="difflineplus">+load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l21.11"></a><span id="l21.11" class="difflineplus">+load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineplus">+load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l21.14"></a><span id="l21.14"> </span>
<a href="#l21.15"></a><span id="l21.15" class="difflineminus">-const gIMAPService = Cc[&quot;@mozilla.org/messenger/imapservice;1&quot;]</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineminus">-                       .getService(Ci.nsIImapService);</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineplus">+function setup() {</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineplus">+  setupIMAPPump();</span>
<a href="#l21.19"></a><span id="l21.19"> </span>
<a href="#l21.20"></a><span id="l21.20" class="difflineminus">-function run_test() {</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineminus">-  var daemon = new imapDaemon();</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineminus">-  daemon.createMailbox(&quot;I18N box\u00E1&quot;, {subscribed : true});</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineminus">-  daemon.createMailbox(&quot;Unsubscribed box&quot;);</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineplus">+  gIMAPDaemon.createMailbox(&quot;I18N box\u00E1&quot;, {subscribed : true});</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineplus">+  gIMAPDaemon.createMailbox(&quot;Unsubscribed box&quot;);</span>
<a href="#l21.26"></a><span id="l21.26">   // Create an all upper case trash folder name to make sure</span>
<a href="#l21.27"></a><span id="l21.27">   // we handle special folder names case-insensitively.</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineminus">-  daemon.createMailbox(&quot;TRASH&quot;, {subscribed : true});</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineminus">-  gServer = makeServer(daemon, &quot;&quot;);</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineminus">-</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-  gIMAPServer = createLocalIMAPServer();</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineminus">-  loadLocalMailAccount();</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineminus">-</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineminus">-  // The server doesn't support more than one connection</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineminus">-  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineminus">-                     .getService(Ci.nsIPrefBranch);</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineminus">-  prefBranch.setIntPref(&quot;mail.server.server1.max_cached_connections&quot;, 1);</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineminus">-  // Make sure no biff notifications happen</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineminus">-  // We aren't interested in downloading messages automatically</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.server.server1.download_on_biff&quot;, false);</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineminus">-</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineminus">-  // We need an identity so that updateFolder doesn't fail</span>
<a href="#l21.47"></a><span id="l21.47" class="difflineminus">-  let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l21.48"></a><span id="l21.48" class="difflineminus">-                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l21.49"></a><span id="l21.49" class="difflineminus">-  let localAccount = acctMgr.createAccount();</span>
<a href="#l21.50"></a><span id="l21.50" class="difflineminus">-  let identity = acctMgr.createIdentity();</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineminus">-  localAccount.addIdentity(identity);</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineminus">-  localAccount.defaultIdentity = identity;</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineminus">-  localAccount.incomingServer = gLocalIncomingServer;</span>
<a href="#l21.54"></a><span id="l21.54" class="difflineminus">-  acctMgr.defaultAccount = localAccount;</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineminus">-</span>
<a href="#l21.56"></a><span id="l21.56" class="difflineminus">-  // Let's also have another account, using the same identity</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineminus">-  let imapAccount = acctMgr.createAccount();</span>
<a href="#l21.58"></a><span id="l21.58" class="difflineminus">-  imapAccount.addIdentity(identity);</span>
<a href="#l21.59"></a><span id="l21.59" class="difflineminus">-  imapAccount.defaultIdentity = identity;</span>
<a href="#l21.60"></a><span id="l21.60" class="difflineminus">-  imapAccount.incomingServer = gIMAPServer;</span>
<a href="#l21.61"></a><span id="l21.61" class="difflineplus">+  gIMAPDaemon.createMailbox(&quot;TRASH&quot;, {subscribed : true});</span>
<a href="#l21.62"></a><span id="l21.62"> </span>
<a href="#l21.63"></a><span id="l21.63">   // Get the server list...</span>
<a href="#l21.64"></a><span id="l21.64" class="difflineminus">-  gIMAPServer.performExpand(null);</span>
<a href="#l21.65"></a><span id="l21.65" class="difflineminus">-  gServer.performTest(&quot;LIST&quot;);</span>
<a href="#l21.66"></a><span id="l21.66" class="difflineminus">-  gRootFolder = gIMAPServer.rootFolder;</span>
<a href="#l21.67"></a><span id="l21.67" class="difflineminus">-  gIMAPInbox = gRootFolder.getChildNamed(&quot;INBOX&quot;).QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l21.68"></a><span id="l21.68" class="difflineminus">-  do_test_pending();</span>
<a href="#l21.69"></a><span id="l21.69" class="difflineplus">+  gIMAPServer.performTest(&quot;LIST&quot;);</span>
<a href="#l21.70"></a><span id="l21.70"> </span>
<a href="#l21.71"></a><span id="l21.71" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, UrlListener);</span>
<a href="#l21.72"></a><span id="l21.72" class="difflineplus">+  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l21.73"></a><span id="l21.73" class="difflineplus">+  yield false;</span>
<a href="#l21.74"></a><span id="l21.74"> }</span>
<a href="#l21.75"></a><span id="l21.75"> </span>
<a href="#l21.76"></a><span id="l21.76" class="difflineminus">-const gTestArray =</span>
<a href="#l21.77"></a><span id="l21.77" class="difflineminus">-[</span>
<a href="#l21.78"></a><span id="l21.78" class="difflineplus">+var tests = [</span>
<a href="#l21.79"></a><span id="l21.79" class="difflineplus">+  setup,</span>
<a href="#l21.80"></a><span id="l21.80">   function checkDiscovery() {</span>
<a href="#l21.81"></a><span id="l21.81">     dump(&quot;in check discovery\n&quot;);</span>
<a href="#l21.82"></a><span id="l21.82" class="difflineminus">-    rootFolder = gIMAPServer.rootFolder;</span>
<a href="#l21.83"></a><span id="l21.83" class="difflineplus">+    let rootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l21.84"></a><span id="l21.84">     // Check that we've subscribed to the boxes returned by LSUB. We also get</span>
<a href="#l21.85"></a><span id="l21.85">     // checking of proper i18n in mailboxes for free here.</span>
<a href="#l21.86"></a><span id="l21.86">     do_check_true(rootFolder.containsChildNamed(&quot;Inbox&quot;));</span>
<a href="#l21.87"></a><span id="l21.87">     do_check_true(rootFolder.containsChildNamed(&quot;TRASH&quot;));</span>
<a href="#l21.88"></a><span id="l21.88">     // Make sure we haven't created an extra &quot;Trash&quot; folder.</span>
<a href="#l21.89"></a><span id="l21.89">     let trashes = rootFolder.getFoldersWithFlags(Ci.nsMsgFolderFlags.Trash);</span>
<a href="#l21.90"></a><span id="l21.90">     do_check_eq(trashes.length, 1);</span>
<a href="#l21.91"></a><span id="l21.91">     do_check_eq(rootFolder.numSubFolders, 3);</span>
<a href="#l21.92"></a><span id="l21.92">     do_check_true(rootFolder.containsChildNamed(&quot;I18N box\u00E1&quot;));</span>
<a href="#l21.93"></a><span id="l21.93">     // This is not a subscribed box, so we shouldn't be subscribing to it.</span>
<a href="#l21.94"></a><span id="l21.94">     do_check_false(rootFolder.containsChildNamed(&quot;Unsubscribed box&quot;));</span>
<a href="#l21.95"></a><span id="l21.95"> </span>
<a href="#l21.96"></a><span id="l21.96">     let i18nChild = rootFolder.getChildNamed(&quot;I18N box\u00E1&quot;);</span>
<a href="#l21.97"></a><span id="l21.97"> </span>
<a href="#l21.98"></a><span id="l21.98" class="difflineminus">-    gIMAPService.renameLeaf(i18nChild, &quot;test \u00E4&quot;, UrlListener, null);</span>
<a href="#l21.99"></a><span id="l21.99" class="difflineplus">+    MailServices.imap.renameLeaf(i18nChild,</span>
<a href="#l21.100"></a><span id="l21.100" class="difflineplus">+                                 &quot;test \u00E4&quot;,</span>
<a href="#l21.101"></a><span id="l21.101" class="difflineplus">+                                 asyncUrlListener,</span>
<a href="#l21.102"></a><span id="l21.102" class="difflineplus">+                                 null);</span>
<a href="#l21.103"></a><span id="l21.103" class="difflineplus">+    yield false;</span>
<a href="#l21.104"></a><span id="l21.104">   },</span>
<a href="#l21.105"></a><span id="l21.105">   function checkRename() {</span>
<a href="#l21.106"></a><span id="l21.106" class="difflineplus">+    let rootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l21.107"></a><span id="l21.107">     do_check_true(rootFolder.containsChildNamed(&quot;test \u00E4&quot;));</span>
<a href="#l21.108"></a><span id="l21.108">     let newChild = rootFolder.getChildNamed(&quot;test \u00E4&quot;).</span>
<a href="#l21.109"></a><span id="l21.109">                    QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l21.110"></a><span id="l21.110" class="difflineminus">-    newChild.updateFolderWithListener(null, UrlListener);</span>
<a href="#l21.111"></a><span id="l21.111" class="difflineplus">+    newChild.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l21.112"></a><span id="l21.112" class="difflineplus">+    yield false;</span>
<a href="#l21.113"></a><span id="l21.113">   },</span>
<a href="#l21.114"></a><span id="l21.114">   function checkEmptyFolder() {</span>
<a href="#l21.115"></a><span id="l21.115">     try {</span>
<a href="#l21.116"></a><span id="l21.116">     let serverSink = gIMAPServer.QueryInterface(Ci.nsIImapServerSink);</span>
<a href="#l21.117"></a><span id="l21.117">       serverSink.possibleImapMailbox(&quot;/&quot;, '/', 0);</span>
<a href="#l21.118"></a><span id="l21.118">     }</span>
<a href="#l21.119"></a><span id="l21.119">     catch (ex) {</span>
<a href="#l21.120"></a><span id="l21.120">       // we expect this to fail, but not crash or assert.</span>
<a href="#l21.121"></a><span id="l21.121">     }</span>
<a href="#l21.122"></a><span id="l21.122" class="difflineminus">-    do_timeout_function(0, function(){doTest(++gCurTestNum)});</span>
<a href="#l21.123"></a><span id="l21.123">   },</span>
<a href="#l21.124"></a><span id="l21.124" class="difflineplus">+  teardown</span>
<a href="#l21.125"></a><span id="l21.125"> ];</span>
<a href="#l21.126"></a><span id="l21.126"> </span>
<a href="#l21.127"></a><span id="l21.127" class="difflineminus">-function endTest()</span>
<a href="#l21.128"></a><span id="l21.128" class="difflineminus">-{</span>
<a href="#l21.129"></a><span id="l21.129" class="difflineminus">-  // Clean up the server in preparation</span>
<a href="#l21.130"></a><span id="l21.130" class="difflineminus">-  gServer.resetTest();</span>
<a href="#l21.131"></a><span id="l21.131" class="difflineminus">-  gIMAPServer.closeCachedConnections();</span>
<a href="#l21.132"></a><span id="l21.132" class="difflineminus">-  gServer.performTest();</span>
<a href="#l21.133"></a><span id="l21.133" class="difflineminus">-  gServer.stop();</span>
<a href="#l21.134"></a><span id="l21.134" class="difflineminus">-</span>
<a href="#l21.135"></a><span id="l21.135" class="difflineminus">-  do_test_finished();</span>
<a href="#l21.136"></a><span id="l21.136" class="difflineminus">-}</span>
<a href="#l21.137"></a><span id="l21.137" class="difflineminus">-function doTest(test)</span>
<a href="#l21.138"></a><span id="l21.138" class="difflineminus">-{</span>
<a href="#l21.139"></a><span id="l21.139" class="difflineminus">-  if (test &lt;= gTestArray.length)</span>
<a href="#l21.140"></a><span id="l21.140" class="difflineminus">-  {</span>
<a href="#l21.141"></a><span id="l21.141" class="difflineminus">-    dump(&quot;Doing test &quot; + test + &quot;\n&quot;);</span>
<a href="#l21.142"></a><span id="l21.142" class="difflineminus">-    gCurTestNum = test;</span>
<a href="#l21.143"></a><span id="l21.143" class="difflineminus">-</span>
<a href="#l21.144"></a><span id="l21.144" class="difflineminus">-    var testFn = gTestArray[test-1];</span>
<a href="#l21.145"></a><span id="l21.145" class="difflineminus">-    // Set a limit of 10 seconds; if the notifications haven't arrived by then there's a problem.</span>
<a href="#l21.146"></a><span id="l21.146" class="difflineminus">-    do_timeout_function(10000, function(){</span>
<a href="#l21.147"></a><span id="l21.147" class="difflineminus">-        if (gCurTestNum == test)</span>
<a href="#l21.148"></a><span id="l21.148" class="difflineminus">-          do_throw(&quot;Notifications not received in 10000 ms for operation &quot; + testFn.name);</span>
<a href="#l21.149"></a><span id="l21.149" class="difflineminus">-        }</span>
<a href="#l21.150"></a><span id="l21.150" class="difflineminus">-      );</span>
<a href="#l21.151"></a><span id="l21.151" class="difflineminus">-    try {</span>
<a href="#l21.152"></a><span id="l21.152" class="difflineminus">-    testFn();</span>
<a href="#l21.153"></a><span id="l21.153" class="difflineminus">-    } catch(ex) {do_throw(ex);}</span>
<a href="#l21.154"></a><span id="l21.154" class="difflineminus">-  }</span>
<a href="#l21.155"></a><span id="l21.155" class="difflineminus">-  else</span>
<a href="#l21.156"></a><span id="l21.156" class="difflineminus">-  {</span>
<a href="#l21.157"></a><span id="l21.157" class="difflineminus">-    // Cleanup, null out everything, close all cached connections and stop the</span>
<a href="#l21.158"></a><span id="l21.158" class="difflineminus">-    // server</span>
<a href="#l21.159"></a><span id="l21.159" class="difflineminus">-    gRootFolder = null;</span>
<a href="#l21.160"></a><span id="l21.160" class="difflineminus">-    gIMAPInbox = null;</span>
<a href="#l21.161"></a><span id="l21.161" class="difflineminus">-    gMsgImapInboxFolder = null;</span>
<a href="#l21.162"></a><span id="l21.162" class="difflineminus">-    gIMAPTrashFolder = null;</span>
<a href="#l21.163"></a><span id="l21.163" class="difflineminus">-    do_timeout_function(1000, endTest);</span>
<a href="#l21.164"></a><span id="l21.164" class="difflineminus">-  }</span>
<a href="#l21.165"></a><span id="l21.165" class="difflineplus">+function teardown() {</span>
<a href="#l21.166"></a><span id="l21.166" class="difflineplus">+  teardownIMAPPump();</span>
<a href="#l21.167"></a><span id="l21.167"> }</span>
<a href="#l21.168"></a><span id="l21.168"> </span>
<a href="#l21.169"></a><span id="l21.169" class="difflineminus">-var UrlListener =</span>
<a href="#l21.170"></a><span id="l21.170" class="difflineminus">-{</span>
<a href="#l21.171"></a><span id="l21.171" class="difflineminus">-  OnStartRunningUrl: function(url) { },</span>
<a href="#l21.172"></a><span id="l21.172" class="difflineminus">-</span>
<a href="#l21.173"></a><span id="l21.173" class="difflineminus">-  OnStopRunningUrl: function (aUrl, aExitCode) {</span>
<a href="#l21.174"></a><span id="l21.174" class="difflineminus">-    // Check: message successfully copied.</span>
<a href="#l21.175"></a><span id="l21.175" class="difflineminus">-    do_check_eq(aExitCode, 0);</span>
<a href="#l21.176"></a><span id="l21.176" class="difflineminus">-    // Ugly hack: make sure we don't get stuck in a JS-&gt;C++-&gt;JS-&gt;C++... call stack</span>
<a href="#l21.177"></a><span id="l21.177" class="difflineminus">-    // This can happen with a bunch of synchronous functions grouped together, and</span>
<a href="#l21.178"></a><span id="l21.178" class="difflineminus">-    // can even cause tests to fail because they're still waiting for the listener</span>
<a href="#l21.179"></a><span id="l21.179" class="difflineminus">-    // to return</span>
<a href="#l21.180"></a><span id="l21.180" class="difflineminus">-    do_timeout_function(0, function(){doTest(++gCurTestNum)});</span>
<a href="#l21.181"></a><span id="l21.181" class="difflineminus">-  }</span>
<a href="#l21.182"></a><span id="l21.182" class="difflineminus">-};</span>
<a href="#l21.183"></a><span id="l21.183" class="difflineplus">+function run_test() {</span>
<a href="#l21.184"></a><span id="l21.184" class="difflineplus">+  async_run_tests(tests);</span>
<a href="#l21.185"></a><span id="l21.185" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_offlinePlayback.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_offlinePlayback.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -1,50 +1,51 @@</span>
<a href="#l22.4"></a><span id="l22.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l22.5"></a><span id="l22.5"> /*</span>
<a href="#l22.6"></a><span id="l22.6">  * Test to ensure that changes made while offline are played back when we</span>
<a href="#l22.7"></a><span id="l22.7">  * go back online.</span>
<a href="#l22.8"></a><span id="l22.8">  */</span>
<a href="#l22.9"></a><span id="l22.9"> </span>
<a href="#l22.10"></a><span id="l22.10" class="difflineminus">-var gIMAPDaemon, gServer, gIMAPIncomingServer;</span>
<a href="#l22.11"></a><span id="l22.11" class="difflineminus">-</span>
<a href="#l22.12"></a><span id="l22.12"> const copyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l22.13"></a><span id="l22.13">                       .getService(Ci.nsIMsgCopyService);</span>
<a href="#l22.14"></a><span id="l22.14"> </span>
<a href="#l22.15"></a><span id="l22.15"> const nsIIOService = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l22.16"></a><span id="l22.16">                      .getService(Ci.nsIIOService);</span>
<a href="#l22.17"></a><span id="l22.17"> </span>
<a href="#l22.18"></a><span id="l22.18" class="difflineplus">+load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineplus">+load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineplus">+load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l22.21"></a><span id="l22.21"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineplus">+load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l22.23"></a><span id="l22.23"> </span>
<a href="#l22.24"></a><span id="l22.24" class="difflineminus">-var gIMAPInbox;</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineminus">-var gTest;</span>
<a href="#l22.26"></a><span id="l22.26"> var gSecondFolder, gThirdFolder;</span>
<a href="#l22.27"></a><span id="l22.27"> var gSynthMessage1, gSynthMessage2;</span>
<a href="#l22.28"></a><span id="l22.28"> // the message id of bugmail10</span>
<a href="#l22.29"></a><span id="l22.29"> const gMsgId1 = &quot;200806061706.m56H6RWT004933@mrapp54.mozilla.org&quot;;</span>
<a href="#l22.30"></a><span id="l22.30"> var gOfflineManager;</span>
<a href="#l22.31"></a><span id="l22.31"> </span>
<a href="#l22.32"></a><span id="l22.32" class="difflineminus">-const gTestArray =</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineminus">-[</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineplus">+var tests = [</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineplus">+  setup,</span>
<a href="#l22.36"></a><span id="l22.36">   function prepareToGoOffline() {</span>
<a href="#l22.37"></a><span id="l22.37">     let rootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l22.38"></a><span id="l22.38">     gSecondFolder = rootFolder.getChildNamed(&quot;secondFolder&quot;)</span>
<a href="#l22.39"></a><span id="l22.39">                       .QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l22.40"></a><span id="l22.40">     gThirdFolder =  rootFolder.getChildNamed(&quot;thirdFolder&quot;)</span>
<a href="#l22.41"></a><span id="l22.41">                       .QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l22.42"></a><span id="l22.42">     gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l22.43"></a><span id="l22.43">     var thread = gThreadManager.currentThread;</span>
<a href="#l22.44"></a><span id="l22.44">     while (thread.hasPendingEvents())</span>
<a href="#l22.45"></a><span id="l22.45">       thread.processNextEvent(true);</span>
<a href="#l22.46"></a><span id="l22.46"> </span>
<a href="#l22.47"></a><span id="l22.47">     dump(&quot;wait 2 seconds, then go offline\n&quot;);</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineminus">-    do_timeout(2000, function () {doTest(++gTest);});</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineplus">+    do_timeout(2000, async_driver);</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineplus">+    yield false;</span>
<a href="#l22.51"></a><span id="l22.51">   },</span>
<a href="#l22.52"></a><span id="l22.52">   function doOfflineOps() {</span>
<a href="#l22.53"></a><span id="l22.53" class="difflineminus">-    gServer.stop();</span>
<a href="#l22.54"></a><span id="l22.54" class="difflineplus">+    gIMAPServer.stop();</span>
<a href="#l22.55"></a><span id="l22.55">     nsIIOService.offline = true;</span>
<a href="#l22.56"></a><span id="l22.56"> </span>
<a href="#l22.57"></a><span id="l22.57">     // Flag the two messages, and then copy them to different folders. Since</span>
<a href="#l22.58"></a><span id="l22.58">     // we're offline, these operations are synchronous.</span>
<a href="#l22.59"></a><span id="l22.59">     let msgHdr1 = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gSynthMessage1.messageId);</span>
<a href="#l22.60"></a><span id="l22.60">     let msgHdr2 = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gSynthMessage2.messageId);</span>
<a href="#l22.61"></a><span id="l22.61">     let headers1 = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l22.62"></a><span id="l22.62">                      .createInstance(Ci.nsIMutableArray);</span>
<a href="#l22.63"></a><span id="l22.63" class="difflineat">@@ -55,91 +56,66 @@ const gTestArray =</span>
<a href="#l22.64"></a><span id="l22.64">     msgHdr1.folder.markMessagesFlagged(headers1, true);</span>
<a href="#l22.65"></a><span id="l22.65">     msgHdr2.folder.markMessagesFlagged(headers2, true);</span>
<a href="#l22.66"></a><span id="l22.66">     copyService.CopyMessages(gIMAPInbox, headers1, gSecondFolder, true, null,</span>
<a href="#l22.67"></a><span id="l22.67">                              null, true);</span>
<a href="#l22.68"></a><span id="l22.68">     copyService.CopyMessages(gIMAPInbox, headers2, gThirdFolder, true, null,</span>
<a href="#l22.69"></a><span id="l22.69">                              null, true);</span>
<a href="#l22.70"></a><span id="l22.70">     var file = do_get_file(&quot;../../../data/bugmail10&quot;);</span>
<a href="#l22.71"></a><span id="l22.71">     copyService.CopyFileMessage(file, gIMAPInbox, null, false, 0,</span>
<a href="#l22.72"></a><span id="l22.72" class="difflineminus">-                                &quot;&quot;, CopyListener, null);</span>
<a href="#l22.73"></a><span id="l22.73" class="difflineplus">+                                &quot;&quot;, asyncCopyListener, null);</span>
<a href="#l22.74"></a><span id="l22.74" class="difflineplus">+    yield false;</span>
<a href="#l22.75"></a><span id="l22.75">   },</span>
<a href="#l22.76"></a><span id="l22.76">   function goOffline() {</span>
<a href="#l22.77"></a><span id="l22.77">     gOfflineManager = Cc[&quot;@mozilla.org/messenger/offline-manager;1&quot;]</span>
<a href="#l22.78"></a><span id="l22.78">                            .getService(Ci.nsIMsgOfflineManager);</span>
<a href="#l22.79"></a><span id="l22.79">     gIMAPDaemon.closing = false;</span>
<a href="#l22.80"></a><span id="l22.80">     nsIIOService.offline = false;</span>
<a href="#l22.81"></a><span id="l22.81"> </span>
<a href="#l22.82"></a><span id="l22.82" class="difflineminus">-    gServer.start(IMAP_PORT);</span>
<a href="#l22.83"></a><span id="l22.83" class="difflineplus">+    gIMAPServer.start(IMAP_PORT);</span>
<a href="#l22.84"></a><span id="l22.84">     gOfflineManager.goOnline(false, true, null);</span>
<a href="#l22.85"></a><span id="l22.85" class="difflineminus">-    do_timeout(2000, function() {doTest(++gTest);});</span>
<a href="#l22.86"></a><span id="l22.86" class="difflineplus">+    do_timeout(2000, async_driver);</span>
<a href="#l22.87"></a><span id="l22.87" class="difflineplus">+    yield false;</span>
<a href="#l22.88"></a><span id="l22.88">   },</span>
<a href="#l22.89"></a><span id="l22.89">   function updateSecondFolder() {</span>
<a href="#l22.90"></a><span id="l22.90">     if (gOfflineManager.inProgress)</span>
<a href="#l22.91"></a><span id="l22.91">       do_timeout(2000, updateSecondFolder);</span>
<a href="#l22.92"></a><span id="l22.92" class="difflineminus">-    gSecondFolder.updateFolderWithListener(null, UrlListener);</span>
<a href="#l22.93"></a><span id="l22.93" class="difflineplus">+    gSecondFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l22.94"></a><span id="l22.94" class="difflineplus">+    yield false;</span>
<a href="#l22.95"></a><span id="l22.95">   },</span>
<a href="#l22.96"></a><span id="l22.96">   function updateThirdFolder() {</span>
<a href="#l22.97"></a><span id="l22.97" class="difflineminus">-    gThirdFolder.updateFolderWithListener(null, UrlListener);</span>
<a href="#l22.98"></a><span id="l22.98" class="difflineplus">+    gThirdFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l22.99"></a><span id="l22.99" class="difflineplus">+    yield false;</span>
<a href="#l22.100"></a><span id="l22.100">   },</span>
<a href="#l22.101"></a><span id="l22.101">   function updateInbox() {</span>
<a href="#l22.102"></a><span id="l22.102" class="difflineminus">-    gIMAPInbox.updateFolderWithListener(null, UrlListener);</span>
<a href="#l22.103"></a><span id="l22.103" class="difflineplus">+    gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l22.104"></a><span id="l22.104" class="difflineplus">+    yield false;</span>
<a href="#l22.105"></a><span id="l22.105">   },</span>
<a href="#l22.106"></a><span id="l22.106">   function checkDone() {</span>
<a href="#l22.107"></a><span id="l22.107">     let msgHdr1 = gSecondFolder.msgDatabase.getMsgHdrForMessageID(gSynthMessage1.messageId);</span>
<a href="#l22.108"></a><span id="l22.108">     let msgHdr2 = gThirdFolder.msgDatabase.getMsgHdrForMessageID(gSynthMessage2.messageId);</span>
<a href="#l22.109"></a><span id="l22.109">     let msgHdr3 = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l22.110"></a><span id="l22.110">     do_check_neq(msgHdr1, null);</span>
<a href="#l22.111"></a><span id="l22.111">     do_check_neq(msgHdr2, null);</span>
<a href="#l22.112"></a><span id="l22.112">     do_check_neq(msgHdr3, null);</span>
<a href="#l22.113"></a><span id="l22.113" class="difflineminus">-    doTest(++gTest);</span>
<a href="#l22.114"></a><span id="l22.114" class="difflineminus">-  }</span>
<a href="#l22.115"></a><span id="l22.115" class="difflineplus">+  },</span>
<a href="#l22.116"></a><span id="l22.116" class="difflineplus">+  teardown</span>
<a href="#l22.117"></a><span id="l22.117"> ];</span>
<a href="#l22.118"></a><span id="l22.118"> </span>
<a href="#l22.119"></a><span id="l22.119" class="difflineminus">-function run_test()</span>
<a href="#l22.120"></a><span id="l22.120" class="difflineminus">-{</span>
<a href="#l22.121"></a><span id="l22.121" class="difflineminus">-  gTest = 0;</span>
<a href="#l22.122"></a><span id="l22.122" class="difflineminus">-  loadLocalMailAccount();</span>
<a href="#l22.123"></a><span id="l22.123" class="difflineplus">+function setup() {</span>
<a href="#l22.124"></a><span id="l22.124" class="difflineplus">+  setupIMAPPump();</span>
<a href="#l22.125"></a><span id="l22.125"> </span>
<a href="#l22.126"></a><span id="l22.126">   /*</span>
<a href="#l22.127"></a><span id="l22.127">    * Set up an IMAP server.</span>
<a href="#l22.128"></a><span id="l22.128">    */</span>
<a href="#l22.129"></a><span id="l22.129" class="difflineminus">-  gIMAPDaemon = new imapDaemon();</span>
<a href="#l22.130"></a><span id="l22.130" class="difflineminus">-  gServer = makeServer(gIMAPDaemon, &quot;&quot;);</span>
<a href="#l22.131"></a><span id="l22.131">   gIMAPDaemon.createMailbox(&quot;secondFolder&quot;, {subscribed : true});</span>
<a href="#l22.132"></a><span id="l22.132">   gIMAPDaemon.createMailbox(&quot;thirdFolder&quot;, {subscribed : true});</span>
<a href="#l22.133"></a><span id="l22.133" class="difflineminus">-  gIMAPIncomingServer = createLocalIMAPServer();</span>
<a href="#l22.134"></a><span id="l22.134" class="difflineminus">-  gIMAPIncomingServer.maximumConnectionsNumber = 1;</span>
<a href="#l22.135"></a><span id="l22.135" class="difflineminus">-</span>
<a href="#l22.136"></a><span id="l22.136" class="difflineminus">-  // We need an identity so that updateFolder doesn't fail</span>
<a href="#l22.137"></a><span id="l22.137" class="difflineminus">-  let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l22.138"></a><span id="l22.138" class="difflineminus">-  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l22.139"></a><span id="l22.139" class="difflineminus">-  let localAccount = acctMgr.createAccount();</span>
<a href="#l22.140"></a><span id="l22.140" class="difflineminus">-  let identity = acctMgr.createIdentity();</span>
<a href="#l22.141"></a><span id="l22.141" class="difflineminus">-  localAccount.addIdentity(identity);</span>
<a href="#l22.142"></a><span id="l22.142" class="difflineminus">-  localAccount.defaultIdentity = identity;</span>
<a href="#l22.143"></a><span id="l22.143" class="difflineminus">-  localAccount.incomingServer = gLocalIncomingServer;</span>
<a href="#l22.144"></a><span id="l22.144" class="difflineminus">-  acctMgr.defaultAccount = localAccount;</span>
<a href="#l22.145"></a><span id="l22.145" class="difflineminus">-</span>
<a href="#l22.146"></a><span id="l22.146" class="difflineminus">-  // Let's also have another account, using the same identity</span>
<a href="#l22.147"></a><span id="l22.147" class="difflineminus">-  let imapAccount = acctMgr.createAccount();</span>
<a href="#l22.148"></a><span id="l22.148" class="difflineminus">-  imapAccount.addIdentity(identity);</span>
<a href="#l22.149"></a><span id="l22.149" class="difflineminus">-  imapAccount.defaultIdentity = identity;</span>
<a href="#l22.150"></a><span id="l22.150" class="difflineminus">-  imapAccount.incomingServer = gIMAPIncomingServer;</span>
<a href="#l22.151"></a><span id="l22.151" class="difflineminus">-  </span>
<a href="#l22.152"></a><span id="l22.152" class="difflineminus">-  // pref tuning: one connection only, turn off notifications</span>
<a href="#l22.153"></a><span id="l22.153" class="difflineminus">-  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l22.154"></a><span id="l22.154" class="difflineminus">-                     .getService(Ci.nsIPrefBranch);</span>
<a href="#l22.155"></a><span id="l22.155" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l22.156"></a><span id="l22.156" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l22.157"></a><span id="l22.157" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l22.158"></a><span id="l22.158" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l22.159"></a><span id="l22.159" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l22.160"></a><span id="l22.160" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l22.161"></a><span id="l22.161">   // Don't prompt about offline download when going offline</span>
<a href="#l22.162"></a><span id="l22.162" class="difflineminus">-  prefBranch.setIntPref(&quot;offline.download.download_messages&quot;, 2);</span>
<a href="#l22.163"></a><span id="l22.163" class="difflineplus">+  Services.prefs.setIntPref(&quot;offline.download.download_messages&quot;, 2);</span>
<a href="#l22.164"></a><span id="l22.164"> </span>
<a href="#l22.165"></a><span id="l22.165">   // make a couple messges</span>
<a href="#l22.166"></a><span id="l22.166">   let messages = [];</span>
<a href="#l22.167"></a><span id="l22.167">   let gMessageGenerator = new MessageGenerator();</span>
<a href="#l22.168"></a><span id="l22.168">   messages = messages.concat(gMessageGenerator.makeMessage());</span>
<a href="#l22.169"></a><span id="l22.169">   messages = messages.concat(gMessageGenerator.makeMessage());</span>
<a href="#l22.170"></a><span id="l22.170">   gSynthMessage1 = messages[0];</span>
<a href="#l22.171"></a><span id="l22.171">   gSynthMessage2 = messages[1];</span>
<a href="#l22.172"></a><span id="l22.172" class="difflineat">@@ -152,76 +128,21 @@ function run_test()</span>
<a href="#l22.173"></a><span id="l22.173">   let message = new imapMessage(msgURI.spec, imapInbox.uidnext++, [&quot;\\Seen&quot;]);</span>
<a href="#l22.174"></a><span id="l22.174">   imapInbox.addMessage(message);</span>
<a href="#l22.175"></a><span id="l22.175">   msgURI =</span>
<a href="#l22.176"></a><span id="l22.176">     nsIIOService.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l22.177"></a><span id="l22.177">                      btoa(messages[1].toMessageString()),</span>
<a href="#l22.178"></a><span id="l22.178">                      null, null);</span>
<a href="#l22.179"></a><span id="l22.179">   message = new imapMessage(msgURI.spec, imapInbox.uidnext++, [&quot;\\Seen&quot;]);</span>
<a href="#l22.180"></a><span id="l22.180">   imapInbox.addMessage(message);</span>
<a href="#l22.181"></a><span id="l22.181" class="difflineminus">-  do_test_pending();</span>
<a href="#l22.182"></a><span id="l22.182" class="difflineminus">-</span>
<a href="#l22.183"></a><span id="l22.183" class="difflineminus">-  // Get the IMAP inbox...</span>
<a href="#l22.184"></a><span id="l22.184" class="difflineminus">-  let rootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l22.185"></a><span id="l22.185" class="difflineminus">-  gIMAPInbox = rootFolder.getFolderWithFlags(Ci.nsMsgFolderFlags.Inbox)</span>
<a href="#l22.186"></a><span id="l22.186" class="difflineminus">-                         .QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l22.187"></a><span id="l22.187"> </span>
<a href="#l22.188"></a><span id="l22.188">   // update folder to download header.</span>
<a href="#l22.189"></a><span id="l22.189" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, UrlListener);</span>
<a href="#l22.190"></a><span id="l22.190" class="difflineplus">+  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l22.191"></a><span id="l22.191" class="difflineplus">+  yield false;</span>
<a href="#l22.192"></a><span id="l22.192"> }</span>
<a href="#l22.193"></a><span id="l22.193"> </span>
<a href="#l22.194"></a><span id="l22.194" class="difflineminus">-var UrlListener = </span>
<a href="#l22.195"></a><span id="l22.195" class="difflineminus">-{</span>
<a href="#l22.196"></a><span id="l22.196" class="difflineminus">-  OnStartRunningUrl: function(url) { },</span>
<a href="#l22.197"></a><span id="l22.197" class="difflineminus">-  OnStopRunningUrl: function(url, rc)</span>
<a href="#l22.198"></a><span id="l22.198" class="difflineminus">-  {</span>
<a href="#l22.199"></a><span id="l22.199" class="difflineminus">-    // Check for ok status.</span>
<a href="#l22.200"></a><span id="l22.200" class="difflineminus">-    do_check_eq(rc, 0);</span>
<a href="#l22.201"></a><span id="l22.201" class="difflineminus">-    doTest(++gTest);</span>
<a href="#l22.202"></a><span id="l22.202" class="difflineminus">-  }</span>
<a href="#l22.203"></a><span id="l22.203" class="difflineminus">-};</span>
<a href="#l22.204"></a><span id="l22.204" class="difflineminus">-</span>
<a href="#l22.205"></a><span id="l22.205" class="difflineminus">-// nsIMsgCopyServiceListener implementation</span>
<a href="#l22.206"></a><span id="l22.206" class="difflineminus">-var CopyListener = </span>
<a href="#l22.207"></a><span id="l22.207" class="difflineminus">-{</span>
<a href="#l22.208"></a><span id="l22.208" class="difflineminus">-  OnStartCopy: function() {},</span>
<a href="#l22.209"></a><span id="l22.209" class="difflineminus">-  OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l22.210"></a><span id="l22.210" class="difflineminus">-  SetMessageKey: function(aKey){},</span>
<a href="#l22.211"></a><span id="l22.211" class="difflineminus">-  SetMessageId: function(aMessageId) {},</span>
<a href="#l22.212"></a><span id="l22.212" class="difflineminus">-  OnStopCopy: function(aStatus){</span>
<a href="#l22.213"></a><span id="l22.213" class="difflineminus">-    do_check_eq(aStatus, 0);</span>
<a href="#l22.214"></a><span id="l22.214" class="difflineminus">-    do_timeout (0, function(){doTest(++gTest)});;</span>
<a href="#l22.215"></a><span id="l22.215" class="difflineminus">-  }</span>
<a href="#l22.216"></a><span id="l22.216" class="difflineminus">-};</span>
<a href="#l22.217"></a><span id="l22.217" class="difflineminus">-</span>
<a href="#l22.218"></a><span id="l22.218" class="difflineminus">-function doTest(test)</span>
<a href="#l22.219"></a><span id="l22.219" class="difflineminus">-{</span>
<a href="#l22.220"></a><span id="l22.220" class="difflineminus">-  if (test &lt;= gTestArray.length)</span>
<a href="#l22.221"></a><span id="l22.221" class="difflineminus">-  {</span>
<a href="#l22.222"></a><span id="l22.222" class="difflineminus">-    dump(&quot;Doing test &quot; + test + &quot;\n&quot;);</span>
<a href="#l22.223"></a><span id="l22.223" class="difflineminus">-    gTest = test;</span>
<a href="#l22.224"></a><span id="l22.224" class="difflineminus">-</span>
<a href="#l22.225"></a><span id="l22.225" class="difflineminus">-    var testFn = gTestArray[test - 1];</span>
<a href="#l22.226"></a><span id="l22.226" class="difflineminus">-    // Set a limit of ten seconds; if the notifications haven't arrived by then there's a problem.</span>
<a href="#l22.227"></a><span id="l22.227" class="difflineminus">-    try {</span>
<a href="#l22.228"></a><span id="l22.228" class="difflineminus">-      testFn();</span>
<a href="#l22.229"></a><span id="l22.229" class="difflineminus">-    } catch(ex) {</span>
<a href="#l22.230"></a><span id="l22.230" class="difflineminus">-      gServer.stop();</span>
<a href="#l22.231"></a><span id="l22.231" class="difflineminus">-      do_throw ('TEST FAILED ' + ex);</span>
<a href="#l22.232"></a><span id="l22.232" class="difflineminus">-    }</span>
<a href="#l22.233"></a><span id="l22.233" class="difflineminus">-  }</span>
<a href="#l22.234"></a><span id="l22.234" class="difflineminus">-  else</span>
<a href="#l22.235"></a><span id="l22.235" class="difflineminus">-  {</span>
<a href="#l22.236"></a><span id="l22.236" class="difflineminus">-    do_timeout(1000, endTest);</span>
<a href="#l22.237"></a><span id="l22.237" class="difflineminus">-  }</span>
<a href="#l22.238"></a><span id="l22.238" class="difflineplus">+function teardown() {</span>
<a href="#l22.239"></a><span id="l22.239" class="difflineplus">+  teardownIMAPPump();</span>
<a href="#l22.240"></a><span id="l22.240"> }</span>
<a href="#l22.241"></a><span id="l22.241"> </span>
<a href="#l22.242"></a><span id="l22.242" class="difflineminus">-function endTest()</span>
<a href="#l22.243"></a><span id="l22.243" class="difflineminus">-{</span>
<a href="#l22.244"></a><span id="l22.244" class="difflineminus">-  gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l22.245"></a><span id="l22.245" class="difflineminus">-  gServer.stop();</span>
<a href="#l22.246"></a><span id="l22.246" class="difflineminus">-</span>
<a href="#l22.247"></a><span id="l22.247" class="difflineminus">-  var thread = gThreadManager.currentThread;</span>
<a href="#l22.248"></a><span id="l22.248" class="difflineminus">-  while (thread.hasPendingEvents())</span>
<a href="#l22.249"></a><span id="l22.249" class="difflineminus">-    thread.processNextEvent(true);</span>
<a href="#l22.250"></a><span id="l22.250" class="difflineminus">-</span>
<a href="#l22.251"></a><span id="l22.251" class="difflineminus">-  do_test_finished();</span>
<a href="#l22.252"></a><span id="l22.252" class="difflineplus">+function run_test() {</span>
<a href="#l22.253"></a><span id="l22.253" class="difflineplus">+  async_run_tests(tests);</span>
<a href="#l22.254"></a><span id="l22.254"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_offlineStoreLocking.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_offlineStoreLocking.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -2,28 +2,28 @@</span>
<a href="#l23.4"></a><span id="l23.4"> /*</span>
<a href="#l23.5"></a><span id="l23.5">  * Test to ensure that code that writes to the imap offline store deals</span>
<a href="#l23.6"></a><span id="l23.6">  * with offline store locking correctly.</span>
<a href="#l23.7"></a><span id="l23.7">  */</span>
<a href="#l23.8"></a><span id="l23.8"> </span>
<a href="#l23.9"></a><span id="l23.9"> const nsIIOService = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l23.10"></a><span id="l23.10">                        .getService(Ci.nsIIOService);</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineplus">+load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineplus">+load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l23.15"></a><span id="l23.15"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineplus">+load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineplus">+load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l23.18"></a><span id="l23.18"> </span>
<a href="#l23.19"></a><span id="l23.19"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l23.20"></a><span id="l23.20"> </span>
<a href="#l23.21"></a><span id="l23.21" class="difflineminus">-load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l23.22"></a><span id="l23.22"> </span>
<a href="#l23.23"></a><span id="l23.23"> // Globals</span>
<a href="#l23.24"></a><span id="l23.24" class="difflineminus">-var gRootFolder;</span>
<a href="#l23.25"></a><span id="l23.25" class="difflineminus">-var gIMAPInbox, gIMAPTrashFolder, gMsgImapInboxFolder;</span>
<a href="#l23.26"></a><span id="l23.26" class="difflineminus">-var gIMAPDaemon, gServer, gIMAPIncomingServer;</span>
<a href="#l23.27"></a><span id="l23.27" class="difflineminus">-var gImapInboxOfflineStoreSize;</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineminus">-var gCurTestNum;</span>
<a href="#l23.29"></a><span id="l23.29" class="difflineplus">+var gIMAPTrashFolder, gMsgImapInboxFolder;</span>
<a href="#l23.30"></a><span id="l23.30"> var gGotAlert = false;</span>
<a href="#l23.31"></a><span id="l23.31"> var gMovedMsgId;</span>
<a href="#l23.32"></a><span id="l23.32"> </span>
<a href="#l23.33"></a><span id="l23.33"> function alert(aDialogTitle, aText) {</span>
<a href="#l23.34"></a><span id="l23.34"> //  do_check_eq(aText.indexOf(&quot;Connection to server Mail for  timed out.&quot;), 0);</span>
<a href="#l23.35"></a><span id="l23.35">   gGotAlert = true;</span>
<a href="#l23.36"></a><span id="l23.36"> }</span>
<a href="#l23.37"></a><span id="l23.37"> </span>
<a href="#l23.38"></a><span id="l23.38" class="difflineat">@@ -60,29 +60,31 @@ function checkOfflineStore(prevOfflineSt</span>
<a href="#l23.39"></a><span id="l23.39">         gIMAPInbox.getOfflineFileStream(header.messageKey, offset, size).close();</span>
<a href="#l23.40"></a><span id="l23.40">     }</span>
<a href="#l23.41"></a><span id="l23.41">   }</span>
<a href="#l23.42"></a><span id="l23.42">   // check that the offline store shrunk by at least 100 bytes.</span>
<a href="#l23.43"></a><span id="l23.43">   // (exact calculation might be fragile).</span>
<a href="#l23.44"></a><span id="l23.44">   do_check_true(prevOfflineStoreSize &gt; gIMAPInbox.filePath.fileSize + 100);</span>
<a href="#l23.45"></a><span id="l23.45"> }</span>
<a href="#l23.46"></a><span id="l23.46"> </span>
<a href="#l23.47"></a><span id="l23.47" class="difflineminus">-const gTestArray =</span>
<a href="#l23.48"></a><span id="l23.48" class="difflineminus">-[</span>
<a href="#l23.49"></a><span id="l23.49" class="difflineplus">+var tests = [</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineplus">+  setup,</span>
<a href="#l23.51"></a><span id="l23.51">   function downloadForOffline() {</span>
<a href="#l23.52"></a><span id="l23.52">     // ...and download for offline use.</span>
<a href="#l23.53"></a><span id="l23.53">     dump(&quot;Downloading for offline use\n&quot;);</span>
<a href="#l23.54"></a><span id="l23.54" class="difflineminus">-    gIMAPInbox.downloadAllForOffline(UrlListener, null);</span>
<a href="#l23.55"></a><span id="l23.55" class="difflineplus">+    gIMAPInbox.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l23.56"></a><span id="l23.56" class="difflineplus">+    yield false;</span>
<a href="#l23.57"></a><span id="l23.57">   },</span>
<a href="#l23.58"></a><span id="l23.58">   function deleteOneMsg() {</span>
<a href="#l23.59"></a><span id="l23.59">     let enumerator = gIMAPInbox.msgDatabase.EnumerateMessages();</span>
<a href="#l23.60"></a><span id="l23.60">     let msgHdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l23.61"></a><span id="l23.61">     let array = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l23.62"></a><span id="l23.62">     array.appendElement(msgHdr, false);</span>
<a href="#l23.63"></a><span id="l23.63">     gIMAPInbox.deleteMessages(array, null, false, true, CopyListener, false);</span>
<a href="#l23.64"></a><span id="l23.64" class="difflineplus">+    yield false;</span>
<a href="#l23.65"></a><span id="l23.65">   },</span>
<a href="#l23.66"></a><span id="l23.66">   function compactOneFolder() {</span>
<a href="#l23.67"></a><span id="l23.67">     let enumerator = gIMAPInbox.msgDatabase.EnumerateMessages();</span>
<a href="#l23.68"></a><span id="l23.68">     let msgHdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l23.69"></a><span id="l23.69">     gStreamedHdr = msgHdr;</span>
<a href="#l23.70"></a><span id="l23.70">     // mark the message as not being offline, and then we'll make sure that</span>
<a href="#l23.71"></a><span id="l23.71">     // streaming the message while we're compacting doesn't result in the</span>
<a href="#l23.72"></a><span id="l23.72">     // message being marked for offline use.</span>
<a href="#l23.73"></a><span id="l23.73" class="difflineat">@@ -90,124 +92,94 @@ const gTestArray =</span>
<a href="#l23.74"></a><span id="l23.74">     // lock the offline store.</span>
<a href="#l23.75"></a><span id="l23.75">     gIMAPInbox.msgDatabase.MarkOffline(msgHdr.messageKey, false, null);</span>
<a href="#l23.76"></a><span id="l23.76">     let msgURI = msgHdr.folder.getUriForMsg(msgHdr);</span>
<a href="#l23.77"></a><span id="l23.77">     let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l23.78"></a><span id="l23.78">     let msgServ = messenger.messageServiceFromURI(msgURI);</span>
<a href="#l23.79"></a><span id="l23.79">     // UrlListener will get called when both expunge and offline store</span>
<a href="#l23.80"></a><span id="l23.80">     // compaction are finished. dummyMsgWindow is required to make the backend</span>
<a href="#l23.81"></a><span id="l23.81">     // compact the offline store.</span>
<a href="#l23.82"></a><span id="l23.82" class="difflineminus">-    gIMAPInbox.compact(UrlListener, gDummyMsgWindow);</span>
<a href="#l23.83"></a><span id="l23.83" class="difflineplus">+    gIMAPInbox.compact(asyncUrlListener, gDummyMsgWindow);</span>
<a href="#l23.84"></a><span id="l23.84">     // Stream the message w/o a stream listener in an attempt to get the url</span>
<a href="#l23.85"></a><span id="l23.85">     // started more quickly, while the compact is still going on.</span>
<a href="#l23.86"></a><span id="l23.86" class="difflineminus">-    msgServ.streamMessage(msgURI, null, null, UrlListener2, false, &quot;&quot;, false);</span>
<a href="#l23.87"></a><span id="l23.87" class="difflineminus">-    // We can't know which will finish first (compact or streaming), so we'll</span>
<a href="#l23.88"></a><span id="l23.88" class="difflineminus">-    // have a dummy test. There's a chance that the stream won't start until</span>
<a href="#l23.89"></a><span id="l23.89" class="difflineminus">-    // after the compact is finished, because the stream will get queued after</span>
<a href="#l23.90"></a><span id="l23.90" class="difflineminus">-    // the expunge, which will hide failures. However, that's not happening</span>
<a href="#l23.91"></a><span id="l23.91" class="difflineminus">-    // here.</span>
<a href="#l23.92"></a><span id="l23.92" class="difflineminus">-  },</span>
<a href="#l23.93"></a><span id="l23.93" class="difflineminus">-  function dummyTest() {</span>
<a href="#l23.94"></a><span id="l23.94" class="difflineplus">+    msgServ.streamMessage(msgURI, null, null, asyncUrlListener, false, &quot;&quot;, false);</span>
<a href="#l23.95"></a><span id="l23.95" class="difflineplus">+    yield false;</span>
<a href="#l23.96"></a><span id="l23.96" class="difflineplus">+</span>
<a href="#l23.97"></a><span id="l23.97" class="difflineplus">+    // Because we're streaming the message while compaction is going on,</span>
<a href="#l23.98"></a><span id="l23.98" class="difflineplus">+    // we should not have stored it for offline use.</span>
<a href="#l23.99"></a><span id="l23.99" class="difflineplus">+    do_check_false(gStreamedHdr.flags &amp; Ci.nsMsgMessageFlags.Offline);</span>
<a href="#l23.100"></a><span id="l23.100" class="difflineplus">+</span>
<a href="#l23.101"></a><span id="l23.101" class="difflineplus">+    yield false;</span>
<a href="#l23.102"></a><span id="l23.102">   },</span>
<a href="#l23.103"></a><span id="l23.103">   function deleteAnOtherMsg() {</span>
<a href="#l23.104"></a><span id="l23.104">     let enumerator = gIMAPInbox.msgDatabase.EnumerateMessages();</span>
<a href="#l23.105"></a><span id="l23.105">     let msgHdr = enumerator.getNext();</span>
<a href="#l23.106"></a><span id="l23.106">     let array = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l23.107"></a><span id="l23.107">     array.appendElement(msgHdr, false);</span>
<a href="#l23.108"></a><span id="l23.108">     gIMAPInbox.deleteMessages(array, null, false, true, CopyListener, false);</span>
<a href="#l23.109"></a><span id="l23.109" class="difflineplus">+    yield false;</span>
<a href="#l23.110"></a><span id="l23.110">   },</span>
<a href="#l23.111"></a><span id="l23.111">   function updateTrash() {</span>
<a href="#l23.112"></a><span id="l23.112">     gIMAPTrashFolder = gIMAPIncomingServer.rootFolder.getChildNamed(&quot;Trash&quot;)</span>
<a href="#l23.113"></a><span id="l23.113">                          .QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l23.114"></a><span id="l23.114">     // hack to force uid validity to get initialized for trash.</span>
<a href="#l23.115"></a><span id="l23.115" class="difflineminus">-    gIMAPTrashFolder.updateFolderWithListener(null, UrlListener);</span>
<a href="#l23.116"></a><span id="l23.116" class="difflineplus">+    gIMAPTrashFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l23.117"></a><span id="l23.117" class="difflineplus">+    yield false;</span>
<a href="#l23.118"></a><span id="l23.118">   },</span>
<a href="#l23.119"></a><span id="l23.119">   function downloadTrashForOffline() {</span>
<a href="#l23.120"></a><span id="l23.120">     // ...and download for offline use.</span>
<a href="#l23.121"></a><span id="l23.121">     dump(&quot;Downloading for offline use\n&quot;);</span>
<a href="#l23.122"></a><span id="l23.122" class="difflineminus">-    gIMAPTrashFolder.downloadAllForOffline(UrlListener, null);</span>
<a href="#l23.123"></a><span id="l23.123" class="difflineplus">+    gIMAPTrashFolder.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l23.124"></a><span id="l23.124" class="difflineplus">+    yield false;</span>
<a href="#l23.125"></a><span id="l23.125">   },</span>
<a href="#l23.126"></a><span id="l23.126">   function testOfflineBodyCopy() {</span>
<a href="#l23.127"></a><span id="l23.127">     // In order to check that offline copy of messages doesn't try to copy</span>
<a href="#l23.128"></a><span id="l23.128">     // the body if the offline store is locked, we're going to go offline.</span>
<a href="#l23.129"></a><span id="l23.129">     // Thunderbird itself does move/copies pseudo-offline, but that's too</span>
<a href="#l23.130"></a><span id="l23.130">     // hard to test because of the half-second delay.</span>
<a href="#l23.131"></a><span id="l23.131" class="difflineminus">-    gServer.stop();</span>
<a href="#l23.132"></a><span id="l23.132" class="difflineplus">+    gIMAPServer.stop();</span>
<a href="#l23.133"></a><span id="l23.133">     nsIIOService.offline = true;</span>
<a href="#l23.134"></a><span id="l23.134">     let trashHdr;</span>
<a href="#l23.135"></a><span id="l23.135">     let enumerator = gIMAPTrashFolder.msgDatabase.EnumerateMessages();</span>
<a href="#l23.136"></a><span id="l23.136">     let msgHdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l23.137"></a><span id="l23.137">     gMovedMsgId = msgHdr.messageId;</span>
<a href="#l23.138"></a><span id="l23.138">     let array = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l23.139"></a><span id="l23.139">     array.appendElement(msgHdr, false);</span>
<a href="#l23.140"></a><span id="l23.140">     const gCopyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l23.141"></a><span id="l23.141">                           .getService(Ci.nsIMsgCopyService);</span>
<a href="#l23.142"></a><span id="l23.142"> </span>
<a href="#l23.143"></a><span id="l23.143" class="difflineminus">-    gIMAPInbox.compact(UrlListener, gDummyMsgWindow);</span>
<a href="#l23.144"></a><span id="l23.144" class="difflineplus">+    gIMAPInbox.compact(asyncUrlListener, gDummyMsgWindow);</span>
<a href="#l23.145"></a><span id="l23.145">     gCopyService.CopyMessages(gIMAPTrashFolder, array, gIMAPInbox, true,</span>
<a href="#l23.146"></a><span id="l23.146">                               CopyListener, null, true);</span>
<a href="#l23.147"></a><span id="l23.147">   },</span>
<a href="#l23.148"></a><span id="l23.148">   function verifyNoOfflineMsg() {</span>
<a href="#l23.149"></a><span id="l23.149">     try {</span>
<a href="#l23.150"></a><span id="l23.150">     let movedMsg = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gMovedMsgId);</span>
<a href="#l23.151"></a><span id="l23.151">     do_check_false(movedMsg.flags &amp; Ci.nsMsgMessageFlags.Offline);</span>
<a href="#l23.152"></a><span id="l23.152" class="difflineminus">-    do_timeout(0, function(){doTest(++gCurTestNum)});</span>
<a href="#l23.153"></a><span id="l23.153">     } catch (ex) {dump(ex);}</span>
<a href="#l23.154"></a><span id="l23.154" class="difflineminus">-  }</span>
<a href="#l23.155"></a><span id="l23.155" class="difflineplus">+    yield false;</span>
<a href="#l23.156"></a><span id="l23.156" class="difflineplus">+    yield false;</span>
<a href="#l23.157"></a><span id="l23.157" class="difflineplus">+  },</span>
<a href="#l23.158"></a><span id="l23.158" class="difflineplus">+  teardown</span>
<a href="#l23.159"></a><span id="l23.159"> ];</span>
<a href="#l23.160"></a><span id="l23.160"> </span>
<a href="#l23.161"></a><span id="l23.161" class="difflineminus">-function run_test()</span>
<a href="#l23.162"></a><span id="l23.162" class="difflineminus">-{</span>
<a href="#l23.163"></a><span id="l23.163" class="difflineplus">+function run_test() {</span>
<a href="#l23.164"></a><span id="l23.164">   // XXX Disable on windows for now as it is failing there.</span>
<a href="#l23.165"></a><span id="l23.165">   if (&quot;@mozilla.org/windows-registry-key;1&quot; in Cc) {</span>
<a href="#l23.166"></a><span id="l23.166">     dump(&quot;Disabled on windows due to permanent failures\n&quot;);</span>
<a href="#l23.167"></a><span id="l23.167">     return;</span>
<a href="#l23.168"></a><span id="l23.168">   }</span>
<a href="#l23.169"></a><span id="l23.169" class="difflineminus">-  // Add a listener.</span>
<a href="#l23.170"></a><span id="l23.170" class="difflineminus">-  gIMAPDaemon = new imapDaemon();</span>
<a href="#l23.171"></a><span id="l23.171" class="difflineminus">-  gServer = makeServer(gIMAPDaemon, &quot;&quot;);</span>
<a href="#l23.172"></a><span id="l23.172" class="difflineminus">-</span>
<a href="#l23.173"></a><span id="l23.173" class="difflineminus">-  gIMAPIncomingServer = createLocalIMAPServer();</span>
<a href="#l23.174"></a><span id="l23.174" class="difflineminus">-</span>
<a href="#l23.175"></a><span id="l23.175" class="difflineminus">-  loadLocalMailAccount();</span>
<a href="#l23.176"></a><span id="l23.176" class="difflineminus">-</span>
<a href="#l23.177"></a><span id="l23.177" class="difflineminus">-  // We need an identity so that updateFolder doesn't fail</span>
<a href="#l23.178"></a><span id="l23.178" class="difflineminus">-  let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l23.179"></a><span id="l23.179" class="difflineminus">-                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l23.180"></a><span id="l23.180" class="difflineminus">-  let localAccount = acctMgr.createAccount();</span>
<a href="#l23.181"></a><span id="l23.181" class="difflineminus">-  let identity = acctMgr.createIdentity();</span>
<a href="#l23.182"></a><span id="l23.182" class="difflineminus">-  localAccount.addIdentity(identity);</span>
<a href="#l23.183"></a><span id="l23.183" class="difflineminus">-  localAccount.defaultIdentity = identity;</span>
<a href="#l23.184"></a><span id="l23.184" class="difflineminus">-  localAccount.incomingServer = gLocalIncomingServer;</span>
<a href="#l23.185"></a><span id="l23.185" class="difflineminus">-  acctMgr.defaultAccount = localAccount;</span>
<a href="#l23.186"></a><span id="l23.186" class="difflineplus">+  async_run_tests(tests);</span>
<a href="#l23.187"></a><span id="l23.187" class="difflineplus">+}</span>
<a href="#l23.188"></a><span id="l23.188"> </span>
<a href="#l23.189"></a><span id="l23.189" class="difflineminus">-  // Let's also have another account, using the same identity</span>
<a href="#l23.190"></a><span id="l23.190" class="difflineminus">-  let imapAccount = acctMgr.createAccount();</span>
<a href="#l23.191"></a><span id="l23.191" class="difflineminus">-  imapAccount.addIdentity(identity);</span>
<a href="#l23.192"></a><span id="l23.192" class="difflineminus">-  imapAccount.defaultIdentity = identity;</span>
<a href="#l23.193"></a><span id="l23.193" class="difflineminus">-  imapAccount.incomingServer = gIMAPIncomingServer;</span>
<a href="#l23.194"></a><span id="l23.194" class="difflineplus">+function setup() {</span>
<a href="#l23.195"></a><span id="l23.195" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l23.196"></a><span id="l23.196"> </span>
<a href="#l23.197"></a><span id="l23.197" class="difflineminus">-  // The server doesn't support more than one connection</span>
<a href="#l23.198"></a><span id="l23.198" class="difflineminus">-  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l23.199"></a><span id="l23.199" class="difflineminus">-                     .getService(Ci.nsIPrefBranch);</span>
<a href="#l23.200"></a><span id="l23.200" class="difflineminus">-  prefBranch.setIntPref(&quot;mail.server.server1.max_cached_connections&quot;, 1);</span>
<a href="#l23.201"></a><span id="l23.201" class="difflineminus">-  // Make sure no biff notifications happen</span>
<a href="#l23.202"></a><span id="l23.202" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l23.203"></a><span id="l23.203" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l23.204"></a><span id="l23.204" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l23.205"></a><span id="l23.205" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l23.206"></a><span id="l23.206" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l23.207"></a><span id="l23.207" class="difflineminus">-  // We aren't interested in downloading messages automatically</span>
<a href="#l23.208"></a><span id="l23.208" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.server.server1.download_on_biff&quot;, false);</span>
<a href="#l23.209"></a><span id="l23.209" class="difflineplus">+  setupIMAPPump();</span>
<a href="#l23.210"></a><span id="l23.210"> </span>
<a href="#l23.211"></a><span id="l23.211" class="difflineminus">-  // Get the server list...</span>
<a href="#l23.212"></a><span id="l23.212" class="difflineminus">-  gIMAPIncomingServer.performExpand(null);</span>
<a href="#l23.213"></a><span id="l23.213" class="difflineminus">-</span>
<a href="#l23.214"></a><span id="l23.214" class="difflineminus">-  gRootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l23.215"></a><span id="l23.215" class="difflineminus">-  gIMAPInbox = gRootFolder.getChildNamed(&quot;INBOX&quot;);</span>
<a href="#l23.216"></a><span id="l23.216">   gMsgImapInboxFolder = gIMAPInbox.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l23.217"></a><span id="l23.217">   // these hacks are required because we've created the inbox before</span>
<a href="#l23.218"></a><span id="l23.218">   // running initial folder discovery, and adding the folder bails</span>
<a href="#l23.219"></a><span id="l23.219">   // out before we set it as verified online, so we bail out, and</span>
<a href="#l23.220"></a><span id="l23.220">   // then remove the INBOX folder since it's not verified.</span>
<a href="#l23.221"></a><span id="l23.221">   gMsgImapInboxFolder.hierarchyDelimiter = '/';</span>
<a href="#l23.222"></a><span id="l23.222">   gMsgImapInboxFolder.verifiedAsOnlineFolder = true;</span>
<a href="#l23.223"></a><span id="l23.223"> </span>
<a href="#l23.224"></a><span id="l23.224" class="difflineat">@@ -216,60 +188,16 @@ function run_test()</span>
<a href="#l23.225"></a><span id="l23.225">   let bodyString = &quot;&quot;;</span>
<a href="#l23.226"></a><span id="l23.226">   for (i = 0; i &lt; 100; i++)</span>
<a href="#l23.227"></a><span id="l23.227">     bodyString += &quot;1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890\r\n&quot;;</span>
<a href="#l23.228"></a><span id="l23.228"> </span>
<a href="#l23.229"></a><span id="l23.229">   for (let i = 0; i &lt; 50; i++)</span>
<a href="#l23.230"></a><span id="l23.230">     messages = messages.concat(messageGenerator.makeMessage({body: {body: bodyString, contentType: &quot;text/plain&quot;}}));</span>
<a href="#l23.231"></a><span id="l23.231"> </span>
<a href="#l23.232"></a><span id="l23.232">   addGeneratedMessagesToServer(messages, gIMAPDaemon.getMailbox(&quot;INBOX&quot;));</span>
<a href="#l23.233"></a><span id="l23.233" class="difflineminus">-</span>
<a href="#l23.234"></a><span id="l23.234" class="difflineminus">-  // &quot;Master&quot; do_test_pending(), paired with a do_test_finished() at the end of</span>
<a href="#l23.235"></a><span id="l23.235" class="difflineminus">-  // all the operations.</span>
<a href="#l23.236"></a><span id="l23.236" class="difflineminus">-  do_test_pending();</span>
<a href="#l23.237"></a><span id="l23.237" class="difflineminus">-  //start first test</span>
<a href="#l23.238"></a><span id="l23.238" class="difflineminus">-  doTest(1);</span>
<a href="#l23.239"></a><span id="l23.239" class="difflineminus">-}</span>
<a href="#l23.240"></a><span id="l23.240" class="difflineminus">-</span>
<a href="#l23.241"></a><span id="l23.241" class="difflineminus">-function doTest(test)</span>
<a href="#l23.242"></a><span id="l23.242" class="difflineminus">-{</span>
<a href="#l23.243"></a><span id="l23.243" class="difflineminus">-  if (test &lt;= gTestArray.length)</span>
<a href="#l23.244"></a><span id="l23.244" class="difflineminus">-  {</span>
<a href="#l23.245"></a><span id="l23.245" class="difflineminus">-    dump(&quot;Doing test &quot; + test + &quot;\n&quot;);</span>
<a href="#l23.246"></a><span id="l23.246" class="difflineminus">-    gCurTestNum = test;</span>
<a href="#l23.247"></a><span id="l23.247" class="difflineminus">-</span>
<a href="#l23.248"></a><span id="l23.248" class="difflineminus">-    var testFn = gTestArray[test-1];</span>
<a href="#l23.249"></a><span id="l23.249" class="difflineminus">-    // Set a limit of 10 seconds; if the notifications haven't arrived by then there's a problem.</span>
<a href="#l23.250"></a><span id="l23.250" class="difflineminus">-    do_timeout(10000, function(){</span>
<a href="#l23.251"></a><span id="l23.251" class="difflineminus">-        if (gCurTestNum == test) </span>
<a href="#l23.252"></a><span id="l23.252" class="difflineminus">-          do_throw(&quot;Notifications not received in 10000 ms for operation &quot; + testFn.name);</span>
<a href="#l23.253"></a><span id="l23.253" class="difflineminus">-        }</span>
<a href="#l23.254"></a><span id="l23.254" class="difflineminus">-      );</span>
<a href="#l23.255"></a><span id="l23.255" class="difflineminus">-    try {</span>
<a href="#l23.256"></a><span id="l23.256" class="difflineminus">-    testFn();</span>
<a href="#l23.257"></a><span id="l23.257" class="difflineminus">-    } catch(ex) {do_throw(ex);}</span>
<a href="#l23.258"></a><span id="l23.258" class="difflineminus">-  }</span>
<a href="#l23.259"></a><span id="l23.259" class="difflineminus">-  else</span>
<a href="#l23.260"></a><span id="l23.260" class="difflineminus">-  {</span>
<a href="#l23.261"></a><span id="l23.261" class="difflineminus">-    dump(&quot;finishing tests\n&quot;);</span>
<a href="#l23.262"></a><span id="l23.262" class="difflineminus">-    // Cleanup, null out everything, close all cached connections and stop the</span>
<a href="#l23.263"></a><span id="l23.263" class="difflineminus">-    // server</span>
<a href="#l23.264"></a><span id="l23.264" class="difflineminus">-    gRootFolder = null;</span>
<a href="#l23.265"></a><span id="l23.265" class="difflineminus">-    gIMAPInbox = null;</span>
<a href="#l23.266"></a><span id="l23.266" class="difflineminus">-    gMsgImapInboxFolder = null;</span>
<a href="#l23.267"></a><span id="l23.267" class="difflineminus">-    gIMAPTrashFolder = null;</span>
<a href="#l23.268"></a><span id="l23.268" class="difflineminus">-    do_timeout_function(1000, endTest);</span>
<a href="#l23.269"></a><span id="l23.269" class="difflineminus">-  }</span>
<a href="#l23.270"></a><span id="l23.270" class="difflineminus">-}</span>
<a href="#l23.271"></a><span id="l23.271" class="difflineminus">-</span>
<a href="#l23.272"></a><span id="l23.272" class="difflineminus">-function endTest()</span>
<a href="#l23.273"></a><span id="l23.273" class="difflineminus">-{</span>
<a href="#l23.274"></a><span id="l23.274" class="difflineminus">-  dump(&quot;in end test\n&quot;);</span>
<a href="#l23.275"></a><span id="l23.275" class="difflineminus">-</span>
<a href="#l23.276"></a><span id="l23.276" class="difflineminus">-  do_test_finished(); // for the one in run_test()</span>
<a href="#l23.277"></a><span id="l23.277"> }</span>
<a href="#l23.278"></a><span id="l23.278"> </span>
<a href="#l23.279"></a><span id="l23.279"> // nsIMsgCopyServiceListener implementation - runs next test when copy</span>
<a href="#l23.280"></a><span id="l23.280"> // is completed.</span>
<a href="#l23.281"></a><span id="l23.281"> var CopyListener = </span>
<a href="#l23.282"></a><span id="l23.282"> {</span>
<a href="#l23.283"></a><span id="l23.283">   OnStartCopy: function() {},</span>
<a href="#l23.284"></a><span id="l23.284">   OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l23.285"></a><span id="l23.285" class="difflineat">@@ -278,45 +206,27 @@ var CopyListener =</span>
<a href="#l23.286"></a><span id="l23.286">     let hdr = gLocalInboxFolder.GetMessageHeader(aKey);</span>
<a href="#l23.287"></a><span id="l23.287">     gMsgHdrs.push({hdr: hdr, ID: hdr.messageId});</span>
<a href="#l23.288"></a><span id="l23.288">   },</span>
<a href="#l23.289"></a><span id="l23.289">   SetMessageId: function(aMessageId) {},</span>
<a href="#l23.290"></a><span id="l23.290">   OnStopCopy: function(aStatus)</span>
<a href="#l23.291"></a><span id="l23.291">   {</span>
<a href="#l23.292"></a><span id="l23.292">     // Check: message successfully copied.</span>
<a href="#l23.293"></a><span id="l23.293">     do_check_eq(aStatus, 0);</span>
<a href="#l23.294"></a><span id="l23.294" class="difflineminus">-    // Ugly hack: make sure we don't get stuck in a JS-&gt;C++-&gt;JS-&gt;C++... call stack</span>
<a href="#l23.295"></a><span id="l23.295" class="difflineminus">-    // This can happen with a bunch of synchronous functions grouped together, and</span>
<a href="#l23.296"></a><span id="l23.296" class="difflineminus">-    // can even cause tests to fail because they're still waiting for the listener</span>
<a href="#l23.297"></a><span id="l23.297" class="difflineminus">-    // to return</span>
<a href="#l23.298"></a><span id="l23.298" class="difflineminus">-    do_timeout(0, function(){doTest(++gCurTestNum)});</span>
<a href="#l23.299"></a><span id="l23.299" class="difflineplus">+    async_driver();</span>
<a href="#l23.300"></a><span id="l23.300">   }</span>
<a href="#l23.301"></a><span id="l23.301"> };</span>
<a href="#l23.302"></a><span id="l23.302"> </span>
<a href="#l23.303"></a><span id="l23.303" class="difflineminus">-var UrlListener = </span>
<a href="#l23.304"></a><span id="l23.304" class="difflineminus">-{</span>
<a href="#l23.305"></a><span id="l23.305" class="difflineminus">-  OnStartRunningUrl: function(url) { },</span>
<a href="#l23.306"></a><span id="l23.306" class="difflineminus">-</span>
<a href="#l23.307"></a><span id="l23.307" class="difflineminus">-  OnStopRunningUrl: function (aUrl, aExitCode) {</span>
<a href="#l23.308"></a><span id="l23.308" class="difflineminus">-    // Check: message successfully copied.</span>
<a href="#l23.309"></a><span id="l23.309" class="difflineminus">-    do_check_eq(aExitCode, 0);</span>
<a href="#l23.310"></a><span id="l23.310" class="difflineminus">-    // Ugly hack: make sure we don't get stuck in a JS-&gt;C++-&gt;JS-&gt;C++... call stack</span>
<a href="#l23.311"></a><span id="l23.311" class="difflineminus">-    // This can happen with a bunch of synchronous functions grouped together, and</span>
<a href="#l23.312"></a><span id="l23.312" class="difflineminus">-    // can even cause tests to fail because they're still waiting for the listener</span>
<a href="#l23.313"></a><span id="l23.313" class="difflineminus">-    // to return</span>
<a href="#l23.314"></a><span id="l23.314" class="difflineminus">-    do_timeout(0, function(){doTest(++gCurTestNum)});</span>
<a href="#l23.315"></a><span id="l23.315" class="difflineminus">-  }</span>
<a href="#l23.316"></a><span id="l23.316" class="difflineminus">-};</span>
<a href="#l23.317"></a><span id="l23.317" class="difflineplus">+function teardown() {</span>
<a href="#l23.318"></a><span id="l23.318" class="difflineplus">+  gMsgImapInboxFolder = null;</span>
<a href="#l23.319"></a><span id="l23.319" class="difflineplus">+  gIMAPTrashFolder = null;</span>
<a href="#l23.320"></a><span id="l23.320"> </span>
<a href="#l23.321"></a><span id="l23.321" class="difflineminus">-var UrlListener2 = </span>
<a href="#l23.322"></a><span id="l23.322" class="difflineminus">-{</span>
<a href="#l23.323"></a><span id="l23.323" class="difflineminus">-  OnStartRunningUrl: function(url) { },</span>
<a href="#l23.324"></a><span id="l23.324" class="difflineminus">-</span>
<a href="#l23.325"></a><span id="l23.325" class="difflineminus">-  OnStopRunningUrl: function (aUrl, aExitCode) {</span>
<a href="#l23.326"></a><span id="l23.326" class="difflineminus">-    // Check: message successfully copied.</span>
<a href="#l23.327"></a><span id="l23.327" class="difflineminus">-    do_check_eq(aExitCode, 0);</span>
<a href="#l23.328"></a><span id="l23.328" class="difflineminus">-    // Because we're streaming the message while compaction is going on,</span>
<a href="#l23.329"></a><span id="l23.329" class="difflineminus">-    // we should not have stored it for offline use.</span>
<a href="#l23.330"></a><span id="l23.330" class="difflineminus">-    dump(&quot;finished streaming &quot; + gStreamedHdr.messageKey + &quot;\n&quot;);</span>
<a href="#l23.331"></a><span id="l23.331" class="difflineminus">-    do_check_false(gStreamedHdr.flags &amp; Ci.nsMsgMessageFlags.Offline);</span>
<a href="#l23.332"></a><span id="l23.332" class="difflineminus">-    do_timeout(0, function(){doTest(++gCurTestNum)});</span>
<a href="#l23.333"></a><span id="l23.333" class="difflineminus">-  }</span>
<a href="#l23.334"></a><span id="l23.334" class="difflineminus">-};</span>
<a href="#l23.335"></a><span id="l23.335" class="difflineplus">+  // gIMAPServer has already stopped, we do not need to gIMAPServer.stop().</span>
<a href="#l23.336"></a><span id="l23.336" class="difflineplus">+  gIMAPInbox = null;</span>
<a href="#l23.337"></a><span id="l23.337" class="difflineplus">+  try {</span>
<a href="#l23.338"></a><span id="l23.338" class="difflineplus">+    gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l23.339"></a><span id="l23.339" class="difflineplus">+    let serverSink = gIMAPIncomingServer.QueryInterface(Ci.nsIImapServerSink);</span>
<a href="#l23.340"></a><span id="l23.340" class="difflineplus">+    serverSink.abortQueuedUrls();</span>
<a href="#l23.341"></a><span id="l23.341" class="difflineplus">+  } catch (ex) {dump(ex);}</span>
<a href="#l23.342"></a><span id="l23.342" class="difflineplus">+  let thread = gThreadManager.currentThread;</span>
<a href="#l23.343"></a><span id="l23.343" class="difflineplus">+  while (thread.hasPendingEvents())</span>
<a href="#l23.344"></a><span id="l23.344" class="difflineplus">+    thread.processNextEvent(true);</span>
<a href="#l23.345"></a><span id="l23.345" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_preserveDataOnMove.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_preserveDataOnMove.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -31,17 +31,17 @@ var tests = [</span>
<a href="#l24.4"></a><span id="l24.4"> let gSubfolder;</span>
<a href="#l24.5"></a><span id="l24.5"> function createSubfolder()</span>
<a href="#l24.6"></a><span id="l24.6"> {</span>
<a href="#l24.7"></a><span id="l24.7">   gIMAPIncomingServer.rootFolder.createSubfolder(&quot;Subfolder&quot;, null);</span>
<a href="#l24.8"></a><span id="l24.8">   dl('wait for folderAdded notification');</span>
<a href="#l24.9"></a><span id="l24.9">   yield false; </span>
<a href="#l24.10"></a><span id="l24.10">   gSubfolder = gIMAPIncomingServer.rootFolder.getChildNamed(&quot;Subfolder&quot;);</span>
<a href="#l24.11"></a><span id="l24.11">   do_check_true(gSubfolder instanceof Ci.nsIMsgImapMailFolder);</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-  gSubfolder.updateFolderWithListener(null, UrlListener);</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+  gSubfolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l24.14"></a><span id="l24.14">   dl('wait for OnStopRunningURL');</span>
<a href="#l24.15"></a><span id="l24.15">   yield false;</span>
<a href="#l24.16"></a><span id="l24.16"> }  </span>
<a href="#l24.17"></a><span id="l24.17"> </span>
<a href="#l24.18"></a><span id="l24.18"> // load and update a message in the imap fake server</span>
<a href="#l24.19"></a><span id="l24.19"> function loadImapMessage()</span>
<a href="#l24.20"></a><span id="l24.20"> {</span>
<a href="#l24.21"></a><span id="l24.21">   gIMAPMailbox.addMessage(new imapMessage(specForFileName(gMessage),</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineat">@@ -80,29 +80,19 @@ function moveMessageToSubfolder()</span>
<a href="#l24.23"></a><span id="l24.23">   let copyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l24.24"></a><span id="l24.24">                       .getService(Ci.nsIMsgCopyService);</span>
<a href="#l24.25"></a><span id="l24.25">   copyService.CopyMessages(gIMAPInbox, messages, gSubfolder, true,</span>
<a href="#l24.26"></a><span id="l24.26">                            asyncCopyListener, null, false);</span>
<a href="#l24.27"></a><span id="l24.27">   dl('wait for OnStopCopy');</span>
<a href="#l24.28"></a><span id="l24.28">   yield false;</span>
<a href="#l24.29"></a><span id="l24.29"> }</span>
<a href="#l24.30"></a><span id="l24.30"> </span>
<a href="#l24.31"></a><span id="l24.31" class="difflineminus">-var UrlListener = {</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineminus">-  OnStartRunningUrl: function _OnStartRunningUrl(aUrl) {</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineminus">-    dl('OnStartRunningUrl');</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineminus">-  },</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineminus">-  OnStopRunningUrl: function _OnStopRunningUrl(aUrl, aExitCode) {</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineminus">-    dl('OnStopRunningUrl');</span>
<a href="#l24.37"></a><span id="l24.37" class="difflineminus">-    async_driver();</span>
<a href="#l24.38"></a><span id="l24.38" class="difflineminus">-  }</span>
<a href="#l24.39"></a><span id="l24.39" class="difflineminus">-};</span>
<a href="#l24.40"></a><span id="l24.40" class="difflineminus">-</span>
<a href="#l24.41"></a><span id="l24.41"> function testPropertyOnMove()</span>
<a href="#l24.42"></a><span id="l24.42"> {</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineminus">-  gSubfolder.updateFolderWithListener(null, UrlListener);</span>
<a href="#l24.44"></a><span id="l24.44" class="difflineplus">+  gSubfolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l24.45"></a><span id="l24.45">   dl('wait for msgAdded');</span>
<a href="#l24.46"></a><span id="l24.46">   yield false; // wait for msgAdded notification</span>
<a href="#l24.47"></a><span id="l24.47">   dl('wait for OnStopRunningURL');</span>
<a href="#l24.48"></a><span id="l24.48">   yield false; // wait for OnStopRunningUrl</span>
<a href="#l24.49"></a><span id="l24.49">   let msgHdr = firstMsgHdr(gSubfolder);</span>
<a href="#l24.50"></a><span id="l24.50">   do_check_eq(msgHdr.getStringProperty(&quot;testprop&quot;), &quot;somevalue&quot;);</span>
<a href="#l24.51"></a><span id="l24.51">   yield true;</span>
<a href="#l24.52"></a><span id="l24.52"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_saveImapDraft.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_saveImapDraft.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -32,17 +32,17 @@ var tests = [</span>
<a href="#l25.4"></a><span id="l25.4"> let gDraftsFolder;</span>
<a href="#l25.5"></a><span id="l25.5"> function createDraftsFolder()</span>
<a href="#l25.6"></a><span id="l25.6"> {</span>
<a href="#l25.7"></a><span id="l25.7">   gIMAPIncomingServer.rootFolder.createSubfolder(&quot;Drafts&quot;, null);</span>
<a href="#l25.8"></a><span id="l25.8">   dl('wait for folderAdded');</span>
<a href="#l25.9"></a><span id="l25.9">   yield false;</span>
<a href="#l25.10"></a><span id="l25.10">   gDraftsFolder = gIMAPIncomingServer.rootFolder.getChildNamed(&quot;Drafts&quot;);</span>
<a href="#l25.11"></a><span id="l25.11">   do_check_true(gDraftsFolder instanceof Ci.nsIMsgImapMailFolder);</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-  gDraftsFolder.updateFolderWithListener(null, urlListener);</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+  gDraftsFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l25.14"></a><span id="l25.14">   dl('wait for OnStopRunningURL');</span>
<a href="#l25.15"></a><span id="l25.15">   yield false;</span>
<a href="#l25.16"></a><span id="l25.16"> }</span>
<a href="#l25.17"></a><span id="l25.17"> </span>
<a href="#l25.18"></a><span id="l25.18"> function saveDraft()</span>
<a href="#l25.19"></a><span id="l25.19"> {</span>
<a href="#l25.20"></a><span id="l25.20">   var msgCompose = Cc[&quot;@mozilla.org/messengercompose/compose;1&quot;]</span>
<a href="#l25.21"></a><span id="l25.21">                      .createInstance(Ci.nsIMsgCompose);</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineat">@@ -66,17 +66,17 @@ function saveDraft()</span>
<a href="#l25.23"></a><span id="l25.23">   msgCompose.SendMsg(Ci.nsIMsgSend.nsMsgSaveAsDraft, identity, &quot;&quot;, null,</span>
<a href="#l25.24"></a><span id="l25.24">                      progress);</span>
<a href="#l25.25"></a><span id="l25.25">   yield false;</span>
<a href="#l25.26"></a><span id="l25.26"> }</span>
<a href="#l25.27"></a><span id="l25.27"> </span>
<a href="#l25.28"></a><span id="l25.28"> function updateDrafts()</span>
<a href="#l25.29"></a><span id="l25.29"> {</span>
<a href="#l25.30"></a><span id="l25.30">   dump(&quot;updating drafts\n&quot;);</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineminus">-  gDraftsFolder.updateFolderWithListener(null, urlListener);</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineplus">+  gDraftsFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l25.33"></a><span id="l25.33">   yield false;</span>
<a href="#l25.34"></a><span id="l25.34"> }</span>
<a href="#l25.35"></a><span id="l25.35"> </span>
<a href="#l25.36"></a><span id="l25.36"> function checkResult()</span>
<a href="#l25.37"></a><span id="l25.37"> {</span>
<a href="#l25.38"></a><span id="l25.38">   dump(&quot;checking result\n&quot;);</span>
<a href="#l25.39"></a><span id="l25.39">   do_check_eq(gDraftsFolder.getTotalMessages(false), 1);</span>
<a href="#l25.40"></a><span id="l25.40">   do_check_eq(gDraftsFolder.getNumUnread(false), 1);</span>
<a href="#l25.41"></a><span id="l25.41" class="difflineat">@@ -104,28 +104,16 @@ function run_test()</span>
<a href="#l25.42"></a><span id="l25.42">         nsIMFNService.folderAdded |</span>
<a href="#l25.43"></a><span id="l25.43">         nsIMFNService.msgAdded;</span>
<a href="#l25.44"></a><span id="l25.44">   MFNService.addListener(mfnListener, flags);</span>
<a href="#l25.45"></a><span id="l25.45"> </span>
<a href="#l25.46"></a><span id="l25.46">   //start first test</span>
<a href="#l25.47"></a><span id="l25.47">   async_run_tests(tests);</span>
<a href="#l25.48"></a><span id="l25.48"> }</span>
<a href="#l25.49"></a><span id="l25.49"> </span>
<a href="#l25.50"></a><span id="l25.50" class="difflineminus">-var urlListener = {</span>
<a href="#l25.51"></a><span id="l25.51" class="difflineminus">-  OnStartRunningUrl: function _OnStartRunningUrl(aUrl) {</span>
<a href="#l25.52"></a><span id="l25.52" class="difflineminus">-    // funny but this never seems to get called.</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineminus">-    dl('OnStartRunningUrl');</span>
<a href="#l25.54"></a><span id="l25.54" class="difflineminus">-  },</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineminus">-  OnStopRunningUrl: function _OnStopRunningUrl(aUrl, aExitCode) {</span>
<a href="#l25.56"></a><span id="l25.56" class="difflineminus">-    dl('OnStopRunningUrl');</span>
<a href="#l25.57"></a><span id="l25.57" class="difflineminus">-    dump(&quot;got on stop running url\n&quot;);</span>
<a href="#l25.58"></a><span id="l25.58" class="difflineminus">-    async_driver();</span>
<a href="#l25.59"></a><span id="l25.59" class="difflineminus">-  }</span>
<a href="#l25.60"></a><span id="l25.60" class="difflineminus">-};</span>
<a href="#l25.61"></a><span id="l25.61" class="difflineminus">-</span>
<a href="#l25.62"></a><span id="l25.62"> var mfnListener =</span>
<a href="#l25.63"></a><span id="l25.63"> {</span>
<a href="#l25.64"></a><span id="l25.64">   msgsMoveCopyCompleted: function (aMove, aSrcMsgs, aDestFolder, aDestMsgs)</span>
<a href="#l25.65"></a><span id="l25.65">   {</span>
<a href="#l25.66"></a><span id="l25.66">     dl('msgsMoveCopyCompleted to folder ' + aDestFolder.name);</span>
<a href="#l25.67"></a><span id="l25.67">   },</span>
<a href="#l25.68"></a><span id="l25.68"> </span>
<a href="#l25.69"></a><span id="l25.69">   folderAdded: function (aFolder)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_saveTemplate.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_saveTemplate.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -36,17 +36,17 @@ function loadImapMessage()</span>
<a href="#l26.4"></a><span id="l26.4"> </span>
<a href="#l26.5"></a><span id="l26.5">   let msgURI =</span>
<a href="#l26.6"></a><span id="l26.6">     Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l26.7"></a><span id="l26.7">                         btoa(smsg.toMessageString()),</span>
<a href="#l26.8"></a><span id="l26.8">                         null, null);</span>
<a href="#l26.9"></a><span id="l26.9">   let imapInbox =  gIMAPDaemon.getMailbox(&quot;INBOX&quot;)</span>
<a href="#l26.10"></a><span id="l26.10">   let message = new imapMessage(msgURI.spec, imapInbox.uidnext++, []);</span>
<a href="#l26.11"></a><span id="l26.11">   gIMAPMailbox.addMessage(message);</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, UrlListener);</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l26.14"></a><span id="l26.14">   yield false;</span>
<a href="#l26.15"></a><span id="l26.15">   MailServices.mfn.addListener(mfnListener, MailServices.mfn.msgAdded);</span>
<a href="#l26.16"></a><span id="l26.16">   yield true;</span>
<a href="#l26.17"></a><span id="l26.17"> }</span>
<a href="#l26.18"></a><span id="l26.18"> </span>
<a href="#l26.19"></a><span id="l26.19"> // Cleanup</span>
<a href="#l26.20"></a><span id="l26.20"> function endTest()</span>
<a href="#l26.21"></a><span id="l26.21"> {</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineat">@@ -81,24 +81,16 @@ function saveAsTemplate() {</span>
<a href="#l26.23"></a><span id="l26.23">   let templates = MailUtils.getFolderForURI(identity.stationeryFolder, false);</span>
<a href="#l26.24"></a><span id="l26.24">   // Verify that Templates folder doesn't exist, and then create it.</span>
<a href="#l26.25"></a><span id="l26.25">   do_check_eq(templates.parent, null);</span>
<a href="#l26.26"></a><span id="l26.26">   templates.setFlag(Ci.nsMsgFolderFlags.Templates);</span>
<a href="#l26.27"></a><span id="l26.27">   templates.createStorageIfMissing(new saveAsUrlListener(uri, identity));</span>
<a href="#l26.28"></a><span id="l26.28">   yield false;</span>
<a href="#l26.29"></a><span id="l26.29"> }</span>
<a href="#l26.30"></a><span id="l26.30"> </span>
<a href="#l26.31"></a><span id="l26.31" class="difflineminus">-var UrlListener = {</span>
<a href="#l26.32"></a><span id="l26.32" class="difflineminus">-  OnStartRunningUrl: function _OnStartRunningUrl(aUrl) {</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineminus">-  },</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineminus">-  OnStopRunningUrl: function _OnStopRunningUrl(aUrl, aExitCode) {</span>
<a href="#l26.35"></a><span id="l26.35" class="difflineminus">-    async_driver();</span>
<a href="#l26.36"></a><span id="l26.36" class="difflineminus">-  }</span>
<a href="#l26.37"></a><span id="l26.37" class="difflineminus">-};</span>
<a href="#l26.38"></a><span id="l26.38" class="difflineminus">-</span>
<a href="#l26.39"></a><span id="l26.39"> // listener for saveAsTemplate adding a message to the templates folder.</span>
<a href="#l26.40"></a><span id="l26.40"> mfnListener =</span>
<a href="#l26.41"></a><span id="l26.41"> {</span>
<a href="#l26.42"></a><span id="l26.42">   msgAdded: function msgAdded(aMsg)</span>
<a href="#l26.43"></a><span id="l26.43">   {</span>
<a href="#l26.44"></a><span id="l26.44">     // Check this is the templates folder.</span>
<a href="#l26.45"></a><span id="l26.45">     do_check_eq(aMsg.folder.prettyName, &quot;Templates&quot;);</span>
<a href="#l26.46"></a><span id="l26.46">     async_driver();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_starttlsFailure.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_starttlsFailure.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -1,26 +1,34 @@</span>
<a href="#l27.4"></a><span id="l27.4"> /**</span>
<a href="#l27.5"></a><span id="l27.5">  * This test checks that we handle the server dropping the connection</span>
<a href="#l27.6"></a><span id="l27.6">  * on starttls. Since fakeserver doesn't support STARTTLS, I've made</span>
<a href="#l27.7"></a><span id="l27.7">  * it drop the connection when it's attempted.</span>
<a href="#l27.8"></a><span id="l27.8">  */</span>
<a href="#l27.9"></a><span id="l27.9"> </span>
<a href="#l27.10"></a><span id="l27.10"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l27.11"></a><span id="l27.11"> </span>
<a href="#l27.12"></a><span id="l27.12" class="difflineplus">+load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l27.13"></a><span id="l27.13"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineplus">+load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l27.15"></a><span id="l27.15"> </span>
<a href="#l27.16"></a><span id="l27.16"> var gGotAlert = false;</span>
<a href="#l27.17"></a><span id="l27.17"> </span>
<a href="#l27.18"></a><span id="l27.18"> function alert(aDialogTitle, aText) {</span>
<a href="#l27.19"></a><span id="l27.19">   do_check_eq(aText.indexOf(&quot;Server Mail for  has disconnected&quot;), 0);</span>
<a href="#l27.20"></a><span id="l27.20">   gGotAlert = true;</span>
<a href="#l27.21"></a><span id="l27.21"> }</span>
<a href="#l27.22"></a><span id="l27.22"> </span>
<a href="#l27.23"></a><span id="l27.23" class="difflineminus">-function run_test() {</span>
<a href="#l27.24"></a><span id="l27.24" class="difflineplus">+var tests = [</span>
<a href="#l27.25"></a><span id="l27.25" class="difflineplus">+  setup,</span>
<a href="#l27.26"></a><span id="l27.26" class="difflineplus">+  check_alert,</span>
<a href="#l27.27"></a><span id="l27.27" class="difflineplus">+  teardown</span>
<a href="#l27.28"></a><span id="l27.28" class="difflineplus">+];</span>
<a href="#l27.29"></a><span id="l27.29" class="difflineplus">+</span>
<a href="#l27.30"></a><span id="l27.30" class="difflineplus">+function setup() {</span>
<a href="#l27.31"></a><span id="l27.31">   // set up IMAP fakeserver and incoming server</span>
<a href="#l27.32"></a><span id="l27.32">   gIMAPDaemon = new imapDaemon();</span>
<a href="#l27.33"></a><span id="l27.33">   gIMAPServer = makeServer(gIMAPDaemon, &quot;&quot;, {dropOnStartTLS: true});</span>
<a href="#l27.34"></a><span id="l27.34">   gIMAPIncomingServer = createLocalIMAPServer();</span>
<a href="#l27.35"></a><span id="l27.35">   gIMAPIncomingServer.socketType = Ci.nsMsgSocketType.alwaysSTARTTLS;</span>
<a href="#l27.36"></a><span id="l27.36"> </span>
<a href="#l27.37"></a><span id="l27.37">   // we need a local account for the IMAP server to have its sent messages in</span>
<a href="#l27.38"></a><span id="l27.38">   loadLocalMailAccount();</span>
<a href="#l27.39"></a><span id="l27.39" class="difflineat">@@ -40,37 +48,34 @@ function run_test() {</span>
<a href="#l27.40"></a><span id="l27.40">   // The server doesn't support more than one connection</span>
<a href="#l27.41"></a><span id="l27.41">   prefBranch.setIntPref(&quot;mail.server.server1.max_cached_connections&quot;, 1);</span>
<a href="#l27.42"></a><span id="l27.42">   // We aren't interested in downloading messages automatically</span>
<a href="#l27.43"></a><span id="l27.43">   prefBranch.setBoolPref(&quot;mail.server.server1.download_on_biff&quot;, false);</span>
<a href="#l27.44"></a><span id="l27.44"> </span>
<a href="#l27.45"></a><span id="l27.45">   gIMAPInbox = gIMAPIncomingServer.rootFolder.getChildNamed(&quot;Inbox&quot;)</span>
<a href="#l27.46"></a><span id="l27.46">                                   .QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l27.47"></a><span id="l27.47"> </span>
<a href="#l27.48"></a><span id="l27.48" class="difflineminus">-  do_test_pending();</span>
<a href="#l27.49"></a><span id="l27.49" class="difflineminus">-</span>
<a href="#l27.50"></a><span id="l27.50">   registerAlertTestUtils();</span>
<a href="#l27.51"></a><span id="l27.51"> </span>
<a href="#l27.52"></a><span id="l27.52" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(gDummyMsgWindow, UrlListener);</span>
<a href="#l27.53"></a><span id="l27.53" class="difflineplus">+  gIMAPInbox.updateFolderWithListener(gDummyMsgWindow, asyncUrlListener);</span>
<a href="#l27.54"></a><span id="l27.54" class="difflineplus">+  yield false;</span>
<a href="#l27.55"></a><span id="l27.55"> }</span>
<a href="#l27.56"></a><span id="l27.56"> </span>
<a href="#l27.57"></a><span id="l27.57" class="difflineminus">-var UrlListener =</span>
<a href="#l27.58"></a><span id="l27.58" class="difflineminus">-{</span>
<a href="#l27.59"></a><span id="l27.59" class="difflineminus">-  OnStartRunningUrl: function(url) { },</span>
<a href="#l27.60"></a><span id="l27.60" class="difflineminus">-  OnStopRunningUrl: function(url, rc)</span>
<a href="#l27.61"></a><span id="l27.61" class="difflineminus">-  {</span>
<a href="#l27.62"></a><span id="l27.62" class="difflineminus">-    // Check for failure.</span>
<a href="#l27.63"></a><span id="l27.63" class="difflineminus">-    do_check_false(Components.isSuccessCode(rc));</span>
<a href="#l27.64"></a><span id="l27.64" class="difflineminus">-    do_timeout_function(1000, endTest);</span>
<a href="#l27.65"></a><span id="l27.65" class="difflineminus">-  }</span>
<a href="#l27.66"></a><span id="l27.66" class="difflineplus">+asyncUrlListener.callback = function(aUrl, aExitCode) {</span>
<a href="#l27.67"></a><span id="l27.67" class="difflineplus">+  do_check_false(Components.isSuccessCode(aExitCode));</span>
<a href="#l27.68"></a><span id="l27.68"> };</span>
<a href="#l27.69"></a><span id="l27.69"> </span>
<a href="#l27.70"></a><span id="l27.70" class="difflineminus">-function endTest() {</span>
<a href="#l27.71"></a><span id="l27.71" class="difflineplus">+function check_alert() {</span>
<a href="#l27.72"></a><span id="l27.72">   do_check_true(gGotAlert);</span>
<a href="#l27.73"></a><span id="l27.73" class="difflineplus">+}</span>
<a href="#l27.74"></a><span id="l27.74" class="difflineplus">+</span>
<a href="#l27.75"></a><span id="l27.75" class="difflineplus">+function teardown() {</span>
<a href="#l27.76"></a><span id="l27.76">   gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l27.77"></a><span id="l27.77">   gIMAPServer.stop();</span>
<a href="#l27.78"></a><span id="l27.78"> </span>
<a href="#l27.79"></a><span id="l27.79">   var thread = gThreadManager.currentThread;</span>
<a href="#l27.80"></a><span id="l27.80">   while (thread.hasPendingEvents())</span>
<a href="#l27.81"></a><span id="l27.81">     thread.processNextEvent(true);</span>
<a href="#l27.82"></a><span id="l27.82" class="difflineplus">+}</span>
<a href="#l27.83"></a><span id="l27.83"> </span>
<a href="#l27.84"></a><span id="l27.84" class="difflineminus">-  do_test_finished();</span>
<a href="#l27.85"></a><span id="l27.85" class="difflineplus">+function run_test() {</span>
<a href="#l27.86"></a><span id="l27.86" class="difflineplus">+  async_run_tests(tests);</span>
<a href="#l27.87"></a><span id="l27.87"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_stopMovingToLocalFolder.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_stopMovingToLocalFolder.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -31,40 +31,33 @@ var asyncCopyListener = {</span>
<a href="#l28.4"></a><span id="l28.4">     stop_server();</span>
<a href="#l28.5"></a><span id="l28.5">   },</span>
<a href="#l28.6"></a><span id="l28.6">   OnStopCopy: function(aStatus) {</span>
<a href="#l28.7"></a><span id="l28.7">     do_check_eq(aStatus, 0);</span>
<a href="#l28.8"></a><span id="l28.8">     async_driver();</span>
<a href="#l28.9"></a><span id="l28.9">   }</span>
<a href="#l28.10"></a><span id="l28.10"> };</span>
<a href="#l28.11"></a><span id="l28.11"> </span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-var urlListener = {</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineminus">-  OnStartRunningUrl: function _OnStartRunningUrl(aUrl) {},</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineminus">-  OnStopRunningUrl: function _OnStopRunningUrl(aUrl, aExitCode) {</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineminus">-    async_driver();</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineminus">-  }</span>
<a href="#l28.17"></a><span id="l28.17" class="difflineminus">-};</span>
<a href="#l28.18"></a><span id="l28.18" class="difflineminus">-</span>
<a href="#l28.19"></a><span id="l28.19"> var tests = [</span>
<a href="#l28.20"></a><span id="l28.20">   setup_messages,</span>
<a href="#l28.21"></a><span id="l28.21">   move_messages,</span>
<a href="#l28.22"></a><span id="l28.22">   check_messages</span>
<a href="#l28.23"></a><span id="l28.23"> ];</span>
<a href="#l28.24"></a><span id="l28.24"> </span>
<a href="#l28.25"></a><span id="l28.25"> function setup_messages() {</span>
<a href="#l28.26"></a><span id="l28.26">   Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l28.27"></a><span id="l28.27"> </span>
<a href="#l28.28"></a><span id="l28.28">   let messageGenerator = new MessageGenerator();</span>
<a href="#l28.29"></a><span id="l28.29">   let messageString = messageGenerator.makeMessage().toMessageString();</span>
<a href="#l28.30"></a><span id="l28.30">   let dataUri = Services.io.newURI(&quot;data:text/plain;base64,&quot; + btoa(messageString),</span>
<a href="#l28.31"></a><span id="l28.31">                                    null, null);</span>
<a href="#l28.32"></a><span id="l28.32">   let imapMsg = new imapMessage(dataUri.spec, gIMAPMailbox.uidnext++, []);</span>
<a href="#l28.33"></a><span id="l28.33">   gIMAPMailbox.addMessage(imapMsg);</span>
<a href="#l28.34"></a><span id="l28.34"> </span>
<a href="#l28.35"></a><span id="l28.35" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, urlListener);</span>
<a href="#l28.36"></a><span id="l28.36" class="difflineplus">+  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l28.37"></a><span id="l28.37">   yield false;</span>
<a href="#l28.38"></a><span id="l28.38"> }</span>
<a href="#l28.39"></a><span id="l28.39"> </span>
<a href="#l28.40"></a><span id="l28.40"> function move_messages() {</span>
<a href="#l28.41"></a><span id="l28.41">   let messages = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l28.42"></a><span id="l28.42">   let msg = gIMAPInbox.msgDatabase.GetMsgHdrForKey(gIMAPMailbox.uidnext - 1);</span>
<a href="#l28.43"></a><span id="l28.43">   messages.appendElement(msg, false);</span>
<a href="#l28.44"></a><span id="l28.44">   MailServices.copy.CopyMessages(gIMAPInbox, messages, gLocalInboxFolder,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_syncChanges.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_syncChanges.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -1,152 +1,85 @@</span>
<a href="#l29.4"></a><span id="l29.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l29.5"></a><span id="l29.5"> /*</span>
<a href="#l29.6"></a><span id="l29.6">  * Test to ensure that changes made from a different profile/machine</span>
<a href="#l29.7"></a><span id="l29.7">  * are synced correctly. In particular, we're checking that emptying out</span>
<a href="#l29.8"></a><span id="l29.8">  * an imap folder on the server makes us delete all the headers from our db.</span>
<a href="#l29.9"></a><span id="l29.9">  */</span>
<a href="#l29.10"></a><span id="l29.10"> </span>
<a href="#l29.11"></a><span id="l29.11" class="difflineminus">-var gIMAPDaemon, gServer, gIMAPIncomingServer;</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineplus">+load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineplus">+load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l29.16"></a><span id="l29.16"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l29.17"></a><span id="l29.17" class="difflineplus">+load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l29.18"></a><span id="l29.18"> </span>
<a href="#l29.19"></a><span id="l29.19" class="difflineminus">-var gIMAPInbox;</span>
<a href="#l29.20"></a><span id="l29.20"> var gMessage;</span>
<a href="#l29.21"></a><span id="l29.21" class="difflineminus">-var gTest;</span>
<a href="#l29.22"></a><span id="l29.22"> var gSecondFolder;</span>
<a href="#l29.23"></a><span id="l29.23"> var gSynthMessage;</span>
<a href="#l29.24"></a><span id="l29.24"> </span>
<a href="#l29.25"></a><span id="l29.25" class="difflineminus">-const gTestArray =</span>
<a href="#l29.26"></a><span id="l29.26" class="difflineminus">-[</span>
<a href="#l29.27"></a><span id="l29.27" class="difflineplus">+var tests = [</span>
<a href="#l29.28"></a><span id="l29.28" class="difflineplus">+  setup,</span>
<a href="#l29.29"></a><span id="l29.29">   function switchAwayFromInbox() {</span>
<a href="#l29.30"></a><span id="l29.30">     let rootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l29.31"></a><span id="l29.31">     gSecondFolder =  rootFolder.getChildNamed(&quot;secondFolder&quot;)</span>
<a href="#l29.32"></a><span id="l29.32">                            .QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l29.33"></a><span id="l29.33"> </span>
<a href="#l29.34"></a><span id="l29.34">     // Selecting the second folder will close the cached connection</span>
<a href="#l29.35"></a><span id="l29.35">     // on the inbox because fake server only supports one connection at a time.</span>
<a href="#l29.36"></a><span id="l29.36">     //  Then, we can poke at the message on the imap server directly, which</span>
<a href="#l29.37"></a><span id="l29.37">     // simulates the user changing the message from a different machine,</span>
<a href="#l29.38"></a><span id="l29.38">     // and Thunderbird discovering the change when it does a flag sync </span>
<a href="#l29.39"></a><span id="l29.39">     // upon reselecting the Inbox.</span>
<a href="#l29.40"></a><span id="l29.40" class="difflineminus">-    gSecondFolder.updateFolderWithListener(null, UrlListener);</span>
<a href="#l29.41"></a><span id="l29.41" class="difflineplus">+    gSecondFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l29.42"></a><span id="l29.42" class="difflineplus">+    yield false;</span>
<a href="#l29.43"></a><span id="l29.43">   },</span>
<a href="#l29.44"></a><span id="l29.44">   function simulateMailboxEmptied() {</span>
<a href="#l29.45"></a><span id="l29.45">     gMessage.setFlag(&quot;\\Deleted&quot;);</span>
<a href="#l29.46"></a><span id="l29.46" class="difflineminus">-    gIMAPDaemon.getMailbox(&quot;INBOX&quot;).expunge();</span>
<a href="#l29.47"></a><span id="l29.47" class="difflineminus">-    gIMAPInbox.updateFolderWithListener(null, UrlListener);</span>
<a href="#l29.48"></a><span id="l29.48" class="difflineplus">+    gIMAPInbox.expunge(asyncUrlListener, null);</span>
<a href="#l29.49"></a><span id="l29.49" class="difflineplus">+    yield false;</span>
<a href="#l29.50"></a><span id="l29.50" class="difflineplus">+    gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l29.51"></a><span id="l29.51" class="difflineplus">+    yield false;</span>
<a href="#l29.52"></a><span id="l29.52">   },</span>
<a href="#l29.53"></a><span id="l29.53">   function checkMailboxEmpty() {</span>
<a href="#l29.54"></a><span id="l29.54">     let msgHdr = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gSynthMessage.messageId);</span>
<a href="#l29.55"></a><span id="l29.55">     do_check_eq(gIMAPInbox.getTotalMessages(false), 0);</span>
<a href="#l29.56"></a><span id="l29.56" class="difflineminus">-    doTest(++gTest);</span>
<a href="#l29.57"></a><span id="l29.57">   },</span>
<a href="#l29.58"></a><span id="l29.58" class="difflineplus">+  teardown</span>
<a href="#l29.59"></a><span id="l29.59"> ];</span>
<a href="#l29.60"></a><span id="l29.60"> </span>
<a href="#l29.61"></a><span id="l29.61" class="difflineminus">-function run_test()</span>
<a href="#l29.62"></a><span id="l29.62" class="difflineminus">-{</span>
<a href="#l29.63"></a><span id="l29.63" class="difflineminus">-  gTest = 0;</span>
<a href="#l29.64"></a><span id="l29.64" class="difflineminus">-  loadLocalMailAccount();</span>
<a href="#l29.65"></a><span id="l29.65" class="difflineminus">-</span>
<a href="#l29.66"></a><span id="l29.66" class="difflineplus">+function setup() {</span>
<a href="#l29.67"></a><span id="l29.67">   /*</span>
<a href="#l29.68"></a><span id="l29.68">    * Set up an IMAP server.</span>
<a href="#l29.69"></a><span id="l29.69">    */</span>
<a href="#l29.70"></a><span id="l29.70" class="difflineminus">-  gIMAPDaemon = new imapDaemon();</span>
<a href="#l29.71"></a><span id="l29.71" class="difflineminus">-  gServer = makeServer(gIMAPDaemon, &quot;&quot;);</span>
<a href="#l29.72"></a><span id="l29.72" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;secondFolder&quot;, {subscribed : true});</span>
<a href="#l29.73"></a><span id="l29.73" class="difflineminus">-  gIMAPIncomingServer = createLocalIMAPServer();</span>
<a href="#l29.74"></a><span id="l29.74" class="difflineminus">-  gIMAPIncomingServer.maximumConnectionsNumber = 1;</span>
<a href="#l29.75"></a><span id="l29.75" class="difflineplus">+  setupIMAPPump();</span>
<a href="#l29.76"></a><span id="l29.76"> </span>
<a href="#l29.77"></a><span id="l29.77" class="difflineminus">-  // We need an identity so that updateFolder doesn't fail</span>
<a href="#l29.78"></a><span id="l29.78" class="difflineminus">-  let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l29.79"></a><span id="l29.79" class="difflineminus">-  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l29.80"></a><span id="l29.80" class="difflineminus">-  let localAccount = acctMgr.createAccount();</span>
<a href="#l29.81"></a><span id="l29.81" class="difflineminus">-  let identity = acctMgr.createIdentity();</span>
<a href="#l29.82"></a><span id="l29.82" class="difflineminus">-  localAccount.addIdentity(identity);</span>
<a href="#l29.83"></a><span id="l29.83" class="difflineminus">-  localAccount.defaultIdentity = identity;</span>
<a href="#l29.84"></a><span id="l29.84" class="difflineminus">-  localAccount.incomingServer = gLocalIncomingServer;</span>
<a href="#l29.85"></a><span id="l29.85" class="difflineminus">-  acctMgr.defaultAccount = localAccount;</span>
<a href="#l29.86"></a><span id="l29.86" class="difflineminus">-  </span>
<a href="#l29.87"></a><span id="l29.87" class="difflineminus">-  // Let's also have another account, using the same identity</span>
<a href="#l29.88"></a><span id="l29.88" class="difflineminus">-  let imapAccount = acctMgr.createAccount();</span>
<a href="#l29.89"></a><span id="l29.89" class="difflineminus">-  imapAccount.addIdentity(identity);</span>
<a href="#l29.90"></a><span id="l29.90" class="difflineminus">-  imapAccount.defaultIdentity = identity;</span>
<a href="#l29.91"></a><span id="l29.91" class="difflineminus">-  imapAccount.incomingServer = gIMAPIncomingServer;</span>
<a href="#l29.92"></a><span id="l29.92" class="difflineminus">-  </span>
<a href="#l29.93"></a><span id="l29.93" class="difflineminus">-  // pref tuning: one connection only, turn off notifications</span>
<a href="#l29.94"></a><span id="l29.94" class="difflineminus">-  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l29.95"></a><span id="l29.95" class="difflineminus">-                     .getService(Ci.nsIPrefBranch);</span>
<a href="#l29.96"></a><span id="l29.96" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l29.97"></a><span id="l29.97" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l29.98"></a><span id="l29.98" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l29.99"></a><span id="l29.99" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l29.100"></a><span id="l29.100" class="difflineminus">-</span>
<a href="#l29.101"></a><span id="l29.101" class="difflineplus">+  gIMAPDaemon.createMailbox(&quot;secondFolder&quot;, {subscribed : true});</span>
<a href="#l29.102"></a><span id="l29.102"> </span>
<a href="#l29.103"></a><span id="l29.103">   let messages = [];</span>
<a href="#l29.104"></a><span id="l29.104">   let gMessageGenerator = new MessageGenerator();</span>
<a href="#l29.105"></a><span id="l29.105">   messages = messages.concat(gMessageGenerator.makeMessage());</span>
<a href="#l29.106"></a><span id="l29.106">   gSynthMessage = messages[0];</span>
<a href="#l29.107"></a><span id="l29.107"> </span>
<a href="#l29.108"></a><span id="l29.108">   let ioService = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l29.109"></a><span id="l29.109">                   .getService(Ci.nsIIOService);</span>
<a href="#l29.110"></a><span id="l29.110">   let msgURI =</span>
<a href="#l29.111"></a><span id="l29.111">     ioService.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l29.112"></a><span id="l29.112">                      btoa(gSynthMessage.toMessageString()),</span>
<a href="#l29.113"></a><span id="l29.113">                      null, null);</span>
<a href="#l29.114"></a><span id="l29.114" class="difflineminus">-  let imapInbox =  gIMAPDaemon.getMailbox(&quot;INBOX&quot;)</span>
<a href="#l29.115"></a><span id="l29.115" class="difflineminus">-  gMessage = new imapMessage(msgURI.spec, imapInbox.uidnext++, []);</span>
<a href="#l29.116"></a><span id="l29.116" class="difflineminus">-  imapInbox.addMessage(gMessage);</span>
<a href="#l29.117"></a><span id="l29.117" class="difflineminus">-  do_test_pending();</span>
<a href="#l29.118"></a><span id="l29.118" class="difflineminus">-</span>
<a href="#l29.119"></a><span id="l29.119" class="difflineminus">-  // Get the IMAP inbox...</span>
<a href="#l29.120"></a><span id="l29.120" class="difflineminus">-  let rootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l29.121"></a><span id="l29.121" class="difflineminus">-  gIMAPInbox = rootFolder.getFolderWithFlags(Ci.nsMsgFolderFlags.Inbox)</span>
<a href="#l29.122"></a><span id="l29.122" class="difflineminus">-                         .QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l29.123"></a><span id="l29.123" class="difflineplus">+  gMessage = new imapMessage(msgURI.spec, gIMAPMailbox.uidnext++, []);</span>
<a href="#l29.124"></a><span id="l29.124" class="difflineplus">+  gIMAPMailbox.addMessage(gMessage);</span>
<a href="#l29.125"></a><span id="l29.125"> </span>
<a href="#l29.126"></a><span id="l29.126">   // update folder to download header.</span>
<a href="#l29.127"></a><span id="l29.127" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, UrlListener);</span>
<a href="#l29.128"></a><span id="l29.128" class="difflineplus">+  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l29.129"></a><span id="l29.129" class="difflineplus">+  yield false;</span>
<a href="#l29.130"></a><span id="l29.130"> }</span>
<a href="#l29.131"></a><span id="l29.131"> </span>
<a href="#l29.132"></a><span id="l29.132" class="difflineminus">-var UrlListener = </span>
<a href="#l29.133"></a><span id="l29.133" class="difflineminus">-{</span>
<a href="#l29.134"></a><span id="l29.134" class="difflineminus">-  OnStartRunningUrl: function(url) { },</span>
<a href="#l29.135"></a><span id="l29.135" class="difflineminus">-  OnStopRunningUrl: function(url, rc)</span>
<a href="#l29.136"></a><span id="l29.136" class="difflineminus">-  {</span>
<a href="#l29.137"></a><span id="l29.137" class="difflineminus">-    // Check for ok status.</span>
<a href="#l29.138"></a><span id="l29.138" class="difflineminus">-    do_check_eq(rc, 0);</span>
<a href="#l29.139"></a><span id="l29.139" class="difflineminus">-    doTest(++gTest);</span>
<a href="#l29.140"></a><span id="l29.140" class="difflineminus">-  }</span>
<a href="#l29.141"></a><span id="l29.141" class="difflineplus">+asyncUrlListener.callback = function(aUrl, aExitCode) {</span>
<a href="#l29.142"></a><span id="l29.142" class="difflineplus">+  do_check_eq(aExitCode, 0);</span>
<a href="#l29.143"></a><span id="l29.143"> };</span>
<a href="#l29.144"></a><span id="l29.144"> </span>
<a href="#l29.145"></a><span id="l29.145" class="difflineminus">-function doTest(test)</span>
<a href="#l29.146"></a><span id="l29.146" class="difflineminus">-{</span>
<a href="#l29.147"></a><span id="l29.147" class="difflineminus">-  if (test &lt;= gTestArray.length)</span>
<a href="#l29.148"></a><span id="l29.148" class="difflineminus">-  {</span>
<a href="#l29.149"></a><span id="l29.149" class="difflineminus">-    dump(&quot;Doing test &quot; + test + &quot;\n&quot;);</span>
<a href="#l29.150"></a><span id="l29.150" class="difflineminus">-    gTest = test;</span>
<a href="#l29.151"></a><span id="l29.151" class="difflineminus">-</span>
<a href="#l29.152"></a><span id="l29.152" class="difflineminus">-    var testFn = gTestArray[test - 1];</span>
<a href="#l29.153"></a><span id="l29.153" class="difflineminus">-    // Set a limit of ten seconds; if the notifications haven't arrived by then there's a problem.</span>
<a href="#l29.154"></a><span id="l29.154" class="difflineminus">-    try {</span>
<a href="#l29.155"></a><span id="l29.155" class="difflineminus">-      testFn();</span>
<a href="#l29.156"></a><span id="l29.156" class="difflineminus">-    } catch(ex) {</span>
<a href="#l29.157"></a><span id="l29.157" class="difflineminus">-      gServer.stop();</span>
<a href="#l29.158"></a><span id="l29.158" class="difflineminus">-      do_throw ('TEST FAILED ' + ex);</span>
<a href="#l29.159"></a><span id="l29.159" class="difflineminus">-    }</span>
<a href="#l29.160"></a><span id="l29.160" class="difflineminus">-  }</span>
<a href="#l29.161"></a><span id="l29.161" class="difflineminus">-  else</span>
<a href="#l29.162"></a><span id="l29.162" class="difflineminus">-  {</span>
<a href="#l29.163"></a><span id="l29.163" class="difflineminus">-    do_timeout_function(1000, endTest);</span>
<a href="#l29.164"></a><span id="l29.164" class="difflineminus">-  }</span>
<a href="#l29.165"></a><span id="l29.165" class="difflineplus">+function teardown() {</span>
<a href="#l29.166"></a><span id="l29.166" class="difflineplus">+  teardownIMAPPump();</span>
<a href="#l29.167"></a><span id="l29.167"> }</span>
<a href="#l29.168"></a><span id="l29.168"> </span>
<a href="#l29.169"></a><span id="l29.169" class="difflineminus">-function endTest()</span>
<a href="#l29.170"></a><span id="l29.170" class="difflineminus">-{</span>
<a href="#l29.171"></a><span id="l29.171" class="difflineminus">-  gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l29.172"></a><span id="l29.172" class="difflineminus">-  gServer.stop();</span>
<a href="#l29.173"></a><span id="l29.173" class="difflineminus">-</span>
<a href="#l29.174"></a><span id="l29.174" class="difflineminus">-  var thread = gThreadManager.currentThread;</span>
<a href="#l29.175"></a><span id="l29.175" class="difflineminus">-  while (thread.hasPendingEvents())</span>
<a href="#l29.176"></a><span id="l29.176" class="difflineminus">-    thread.processNextEvent(true);</span>
<a href="#l29.177"></a><span id="l29.177" class="difflineminus">-</span>
<a href="#l29.178"></a><span id="l29.178" class="difflineminus">-  do_test_finished();</span>
<a href="#l29.179"></a><span id="l29.179" class="difflineplus">+function run_test() {</span>
<a href="#l29.180"></a><span id="l29.180" class="difflineplus">+  async_run_tests(tests);</span>
<a href="#l29.181"></a><span id="l29.181"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_trustSpamAssassin.js</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_trustSpamAssassin.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -38,17 +38,17 @@ var tests = [</span>
<a href="#l30.4"></a><span id="l30.4"> let gJunkFolder;</span>
<a href="#l30.5"></a><span id="l30.5"> function createJunkFolder()</span>
<a href="#l30.6"></a><span id="l30.6"> {</span>
<a href="#l30.7"></a><span id="l30.7">   gIMAPIncomingServer.rootFolder.createSubfolder(&quot;Junk&quot;, null);</span>
<a href="#l30.8"></a><span id="l30.8">   dl('wait for folderAdded');</span>
<a href="#l30.9"></a><span id="l30.9">   yield false;</span>
<a href="#l30.10"></a><span id="l30.10">   gJunkFolder = gIMAPIncomingServer.rootFolder.getChildNamed(&quot;Junk&quot;);</span>
<a href="#l30.11"></a><span id="l30.11">   do_check_true(gJunkFolder instanceof Ci.nsIMsgImapMailFolder);</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-  gJunkFolder.updateFolderWithListener(null, urlListener);</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+  gJunkFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l30.14"></a><span id="l30.14">   dl('wait for OnStopRunningURL');</span>
<a href="#l30.15"></a><span id="l30.15">   yield false;</span>
<a href="#l30.16"></a><span id="l30.16"> }</span>
<a href="#l30.17"></a><span id="l30.17"> </span>
<a href="#l30.18"></a><span id="l30.18"> /*</span>
<a href="#l30.19"></a><span id="l30.19">  * Load and update a message in the imap fake server, should move</span>
<a href="#l30.20"></a><span id="l30.20">  *  SpamAssassin-marked junk message to junk folder</span>
<a href="#l30.21"></a><span id="l30.21">  */</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineat">@@ -58,17 +58,17 @@ function loadImapMessage()</span>
<a href="#l30.23"></a><span id="l30.23">                           gIMAPMailbox.uidnext++, []));</span>
<a href="#l30.24"></a><span id="l30.24">   /*</span>
<a href="#l30.25"></a><span id="l30.25">    * The message matched the SpamAssassin header, so it moved</span>
<a href="#l30.26"></a><span id="l30.26">    *  to the junk folder</span>
<a href="#l30.27"></a><span id="l30.27">    */</span>
<a href="#l30.28"></a><span id="l30.28">   gIMAPInbox.updateFolder(null);</span>
<a href="#l30.29"></a><span id="l30.29">   dl('wait for msgsMoveCopyCompleted');</span>
<a href="#l30.30"></a><span id="l30.30">   yield false;</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineminus">-  gJunkFolder.updateFolderWithListener(null, urlListener);</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineplus">+  gJunkFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l30.33"></a><span id="l30.33">   dl('wait for OnStopRunningURL');</span>
<a href="#l30.34"></a><span id="l30.34">   yield false;</span>
<a href="#l30.35"></a><span id="l30.35"> }</span>
<a href="#l30.36"></a><span id="l30.36"> </span>
<a href="#l30.37"></a><span id="l30.37"> function testMessageInJunk()</span>
<a href="#l30.38"></a><span id="l30.38"> {</span>
<a href="#l30.39"></a><span id="l30.39">   do_check_eq(0, gIMAPInbox.getTotalMessages(false));</span>
<a href="#l30.40"></a><span id="l30.40">   do_check_eq(1, gJunkFolder.getTotalMessages(false));</span>
<a href="#l30.41"></a><span id="l30.41" class="difflineat">@@ -112,20 +112,20 @@ function markMessageAsGood()</span>
<a href="#l30.42"></a><span id="l30.42">   copyService.CopyMessages(gJunkFolder, messages, gIMAPInbox, true,</span>
<a href="#l30.43"></a><span id="l30.43">                             null, null, false);</span>
<a href="#l30.44"></a><span id="l30.44">   dl('wait for msgsMoveCopyCompleted');</span>
<a href="#l30.45"></a><span id="l30.45">   yield false;</span>
<a href="#l30.46"></a><span id="l30.46"> }</span>
<a href="#l30.47"></a><span id="l30.47"> </span>
<a href="#l30.48"></a><span id="l30.48"> function updateFoldersAndCheck()</span>
<a href="#l30.49"></a><span id="l30.49"> {</span>
<a href="#l30.50"></a><span id="l30.50" class="difflineminus">-  gIMAPInbox.updateFolderWithListener(null, urlListener);</span>
<a href="#l30.51"></a><span id="l30.51" class="difflineplus">+  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l30.52"></a><span id="l30.52">   dl('wait for OnStopRunningURL');</span>
<a href="#l30.53"></a><span id="l30.53">   yield false;</span>
<a href="#l30.54"></a><span id="l30.54" class="difflineminus">-  gJunkFolder.updateFolderWithListener(null, urlListener);</span>
<a href="#l30.55"></a><span id="l30.55" class="difflineplus">+  gJunkFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l30.56"></a><span id="l30.56">   dl('wait for OnStopRunningURL');</span>
<a href="#l30.57"></a><span id="l30.57">   yield false;</span>
<a href="#l30.58"></a><span id="l30.58">   // bug 540385 causes this test to fail</span>
<a href="#l30.59"></a><span id="l30.59">   do_check_eq(1, gIMAPInbox.getTotalMessages(false));</span>
<a href="#l30.60"></a><span id="l30.60">   do_check_eq(0, gJunkFolder.getTotalMessages(false));</span>
<a href="#l30.61"></a><span id="l30.61">   yield true;</span>
<a href="#l30.62"></a><span id="l30.62"> }</span>
<a href="#l30.63"></a><span id="l30.63"> </span>
<a href="#l30.64"></a><span id="l30.64" class="difflineat">@@ -157,27 +157,16 @@ function run_test()</span>
<a href="#l30.65"></a><span id="l30.65">         nsIMFNService.folderAdded | </span>
<a href="#l30.66"></a><span id="l30.66">         nsIMFNService.msgAdded;</span>
<a href="#l30.67"></a><span id="l30.67">   MFNService.addListener(mfnListener, flags);</span>
<a href="#l30.68"></a><span id="l30.68"> </span>
<a href="#l30.69"></a><span id="l30.69">   //start first test</span>
<a href="#l30.70"></a><span id="l30.70">   async_run_tests(tests);</span>
<a href="#l30.71"></a><span id="l30.71"> }</span>
<a href="#l30.72"></a><span id="l30.72"> </span>
<a href="#l30.73"></a><span id="l30.73" class="difflineminus">-var urlListener = {</span>
<a href="#l30.74"></a><span id="l30.74" class="difflineminus">-  OnStartRunningUrl: function _OnStartRunningUrl(aUrl) {</span>
<a href="#l30.75"></a><span id="l30.75" class="difflineminus">-    // funny but this never seems to get called.</span>
<a href="#l30.76"></a><span id="l30.76" class="difflineminus">-    dl('OnStartRunningUrl');</span>
<a href="#l30.77"></a><span id="l30.77" class="difflineminus">-  },</span>
<a href="#l30.78"></a><span id="l30.78" class="difflineminus">-  OnStopRunningUrl: function _OnStopRunningUrl(aUrl, aExitCode) {</span>
<a href="#l30.79"></a><span id="l30.79" class="difflineminus">-    dl('OnStopRunningUrl');</span>
<a href="#l30.80"></a><span id="l30.80" class="difflineminus">-    async_driver();</span>
<a href="#l30.81"></a><span id="l30.81" class="difflineminus">-  }</span>
<a href="#l30.82"></a><span id="l30.82" class="difflineminus">-};</span>
<a href="#l30.83"></a><span id="l30.83" class="difflineminus">-</span>
<a href="#l30.84"></a><span id="l30.84"> mfnListener =</span>
<a href="#l30.85"></a><span id="l30.85"> {</span>
<a href="#l30.86"></a><span id="l30.86">   msgsMoveCopyCompleted: function (aMove, aSrcMsgs, aDestFolder, aDestMsgs)</span>
<a href="#l30.87"></a><span id="l30.87">   {</span>
<a href="#l30.88"></a><span id="l30.88">     dl('msgsMoveCopyCompleted to folder ' + aDestFolder.name);</span>
<a href="#l30.89"></a><span id="l30.89">     async_driver();</span>
<a href="#l30.90"></a><span id="l30.90">   },</span>
<a href="#l30.91"></a><span id="l30.91"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

