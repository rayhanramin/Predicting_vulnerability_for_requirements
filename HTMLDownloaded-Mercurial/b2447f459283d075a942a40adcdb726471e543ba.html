<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26590:b2447f459283d075a942a40adcdb726471e543ba</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ b2447f459283d075a942a40adcdb726471e543ba" />
<meta property="og:url" content="/comm-central/rev/b2447f459283d075a942a40adcdb726471e543ba" />
<meta property="og:description" content="Bug 1515877 - Turn on ESLint in mailnews/mime; r=aceman" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / b2447f459283d075a942a40adcdb726471e543ba 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/b2447f459283d075a942a40adcdb726471e543ba">shortlog</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/b2447f459283d075a942a40adcdb726471e543ba">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba">files</a> |
changeset |
<a href="/comm-central/raw-rev/b2447f459283d075a942a40adcdb726471e543ba">raw</a>  | <a href="/comm-central/archive/b2447f459283d075a942a40adcdb726471e543ba.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1515877">Bug 1515877</a> - Turn on ESLint in mailnews/mime; r=aceman
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 13 May 2019 19:54:17 +1200</td></tr>

<tr>
 <td>changeset 26590</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/b2447f459283d075a942a40adcdb726471e543ba">b2447f459283d075a942a40adcdb726471e543ba</a></td>
</tr>



<tr>
<td>parent 26589</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b39e405810ed7a8a2b13d96d8f49f3eead66fed6">b39e405810ed7a8a2b13d96d8f49f3eead66fed6</a>
</td>
</tr>

<tr>
<td>child 26591</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/937e7c60b40043bbdd456e18aaef5df8c0af91a1">937e7c60b40043bbdd456e18aaef5df8c0af91a1</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=b2447f459283d075a942a40adcdb726471e543ba">15903</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Mon, 13 May 2019 07:56:55 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@b2447f459283 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b2447f459283d075a942a40adcdb726471e543ba">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b2447f459283d075a942a40adcdb726471e543ba&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b2447f459283d075a942a40adcdb726471e543ba&newProject=comm-central&newRevision=973cbf59e0bc89dbb150cd662389904c8bbdbfce&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b2447f459283d075a942a40adcdb726471e543ba&newProject=comm-central&newRevision=973cbf59e0bc89dbb150cd662389904c8bbdbfce&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b2447f459283d075a942a40adcdb726471e543ba&newProject=comm-central&newRevision=973cbf59e0bc89dbb150cd662389904c8bbdbfce&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28aceman%29&revcount=50">aceman</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1515877">1515877</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1515877">Bug 1515877</a> - Turn on ESLint in mailnews/mime; r=aceman</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/.eslintignore">.eslintignore</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/.eslintignore">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/.eslintignore">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/.eslintignore">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/.eslintignore">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/.eslintignore">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/jsmime.js">mailnews/mime/jsmime/jsmime.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/jsmime.js">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/jsmime.js">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/jsmime.js">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/jsmime.js">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/jsmime.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/.eslintrc.js">mailnews/mime/jsmime/test/.eslintrc.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/.eslintrc.js">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/.eslintrc.js">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/.eslintrc.js">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/.eslintrc.js">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/.eslintrc.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/head_xpcshell_glue.js">mailnews/mime/jsmime/test/head_xpcshell_glue.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/head_xpcshell_glue.js">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/head_xpcshell_glue.js">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/head_xpcshell_glue.js">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/head_xpcshell_glue.js">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/head_xpcshell_glue.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/mock_date.js">mailnews/mime/jsmime/test/mock_date.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/mock_date.js">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/mock_date.js">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/mock_date.js">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/mock_date.js">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/mock_date.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/test_custom_headers.js">mailnews/mime/jsmime/test/test_custom_headers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/test_custom_headers.js">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/test_custom_headers.js">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/test_custom_headers.js">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/test_custom_headers.js">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/test_custom_headers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/test_header.js">mailnews/mime/jsmime/test/test_header.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/test_header.js">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/test_header.js">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/test_header.js">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/test_header.js">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/test_header.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/test_header_emitter.js">mailnews/mime/jsmime/test/test_header_emitter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/test_header_emitter.js">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/test_header_emitter.js">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/test_header_emitter.js">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/test_header_emitter.js">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/test_header_emitter.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/test_mime_tree.js">mailnews/mime/jsmime/test/test_mime_tree.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/test_mime_tree.js">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/test_mime_tree.js">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/test_mime_tree.js">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/test_mime_tree.js">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/test_mime_tree.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/test_structured_header_emitters.js">mailnews/mime/jsmime/test/test_structured_header_emitters.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/test_structured_header_emitters.js">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/test_structured_header_emitters.js">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/test_structured_header_emitters.js">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/test_structured_header_emitters.js">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/test_structured_header_emitters.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/test_structured_headers.js">mailnews/mime/jsmime/test/test_structured_headers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/test_structured_headers.js">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/test_structured_headers.js">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/test_structured_headers.js">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/test_structured_headers.js">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/jsmime/test/test_structured_headers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/src/extraMimeParsers.jsm">mailnews/mime/src/extraMimeParsers.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/src/extraMimeParsers.jsm">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/src/extraMimeParsers.jsm">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/src/extraMimeParsers.jsm">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/src/extraMimeParsers.jsm">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/src/extraMimeParsers.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/src/jsmime.jsm">mailnews/mime/src/jsmime.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/src/jsmime.jsm">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/src/jsmime.jsm">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/src/jsmime.jsm">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/src/jsmime.jsm">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/src/jsmime.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/src/mimeJSComponents.js">mailnews/mime/src/mimeJSComponents.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/src/mimeJSComponents.js">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/src/mimeJSComponents.js">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/src/mimeJSComponents.js">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/src/mimeJSComponents.js">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/src/mimeJSComponents.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/src/mimeParser.jsm">mailnews/mime/src/mimeParser.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/src/mimeParser.jsm">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/src/mimeParser.jsm">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/src/mimeParser.jsm">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/src/mimeParser.jsm">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/src/mimeParser.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/src/mimemcms.cpp">mailnews/mime/src/mimemcms.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/src/mimemcms.cpp">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/src/mimemcms.cpp">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/src/mimemcms.cpp">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/src/mimemcms.cpp">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/src/mimemcms.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/.eslintrc.js">mailnews/mime/test/unit/.eslintrc.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/.eslintrc.js">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/.eslintrc.js">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/.eslintrc.js">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/.eslintrc.js">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/.eslintrc.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/custom_header.js">mailnews/mime/test/unit/custom_header.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/custom_header.js">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/custom_header.js">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/custom_header.js">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/custom_header.js">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/custom_header.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/head_mime.js">mailnews/mime/test/unit/head_mime.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/head_mime.js">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/head_mime.js">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/head_mime.js">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/head_mime.js">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/head_mime.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_EncodeMimePartIIStr_UTF8.js">mailnews/mime/test/unit/test_EncodeMimePartIIStr_UTF8.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_EncodeMimePartIIStr_UTF8.js">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_EncodeMimePartIIStr_UTF8.js">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_EncodeMimePartIIStr_UTF8.js">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_EncodeMimePartIIStr_UTF8.js">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_EncodeMimePartIIStr_UTF8.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_alternate_p7m_handling.js">mailnews/mime/test/unit/test_alternate_p7m_handling.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_alternate_p7m_handling.js">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_alternate_p7m_handling.js">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_alternate_p7m_handling.js">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_alternate_p7m_handling.js">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_alternate_p7m_handling.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_attachment_size.js">mailnews/mime/test/unit/test_attachment_size.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_attachment_size.js">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_attachment_size.js">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_attachment_size.js">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_attachment_size.js">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_attachment_size.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_badContentType.js">mailnews/mime/test/unit/test_badContentType.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_badContentType.js">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_badContentType.js">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_badContentType.js">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_badContentType.js">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_badContentType.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_bug493544.js">mailnews/mime/test/unit/test_bug493544.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_bug493544.js">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_bug493544.js">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_bug493544.js">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_bug493544.js">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_bug493544.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_hidden_attachments.js">mailnews/mime/test/unit/test_hidden_attachments.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_hidden_attachments.js">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_hidden_attachments.js">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_hidden_attachments.js">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_hidden_attachments.js">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_hidden_attachments.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_jsmime_charset.js">mailnews/mime/test/unit/test_jsmime_charset.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_jsmime_charset.js">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_jsmime_charset.js">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_jsmime_charset.js">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_jsmime_charset.js">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_jsmime_charset.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_message_attachment.js">mailnews/mime/test/unit/test_message_attachment.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_message_attachment.js">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_message_attachment.js">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_message_attachment.js">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_message_attachment.js">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_message_attachment.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_mimeContentType.js">mailnews/mime/test/unit/test_mimeContentType.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_mimeContentType.js">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_mimeContentType.js">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_mimeContentType.js">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_mimeContentType.js">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_mimeContentType.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_mimeStreaming.js">mailnews/mime/test/unit/test_mimeStreaming.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_mimeStreaming.js">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_mimeStreaming.js">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_mimeStreaming.js">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_mimeStreaming.js">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_mimeStreaming.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_nsIMsgHeaderParser1.js">mailnews/mime/test/unit/test_nsIMsgHeaderParser1.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_nsIMsgHeaderParser1.js">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_nsIMsgHeaderParser1.js">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_nsIMsgHeaderParser1.js">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_nsIMsgHeaderParser1.js">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_nsIMsgHeaderParser1.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_nsIMsgHeaderParser2.js">mailnews/mime/test/unit/test_nsIMsgHeaderParser2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_nsIMsgHeaderParser2.js">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_nsIMsgHeaderParser2.js">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_nsIMsgHeaderParser2.js">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_nsIMsgHeaderParser2.js">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_nsIMsgHeaderParser2.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_nsIMsgHeaderParser3.js">mailnews/mime/test/unit/test_nsIMsgHeaderParser3.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_nsIMsgHeaderParser3.js">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_nsIMsgHeaderParser3.js">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_nsIMsgHeaderParser3.js">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_nsIMsgHeaderParser3.js">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_nsIMsgHeaderParser3.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_nsIMsgHeaderParser4.js">mailnews/mime/test/unit/test_nsIMsgHeaderParser4.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_nsIMsgHeaderParser4.js">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_nsIMsgHeaderParser4.js">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_nsIMsgHeaderParser4.js">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_nsIMsgHeaderParser4.js">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_nsIMsgHeaderParser4.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_nsIMsgHeaderParser5.js">mailnews/mime/test/unit/test_nsIMsgHeaderParser5.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_nsIMsgHeaderParser5.js">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_nsIMsgHeaderParser5.js">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_nsIMsgHeaderParser5.js">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_nsIMsgHeaderParser5.js">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_nsIMsgHeaderParser5.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_parser.js">mailnews/mime/test/unit/test_parser.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_parser.js">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_parser.js">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_parser.js">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_parser.js">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_parser.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_rfc822_body.js">mailnews/mime/test/unit/test_rfc822_body.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_rfc822_body.js">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_rfc822_body.js">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_rfc822_body.js">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_rfc822_body.js">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_rfc822_body.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_smime_decrypt.js">mailnews/mime/test/unit/test_smime_decrypt.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_smime_decrypt.js">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_smime_decrypt.js">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_smime_decrypt.js">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_smime_decrypt.js">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_smime_decrypt.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_structured_headers.js">mailnews/mime/test/unit/test_structured_headers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_structured_headers.js">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_structured_headers.js">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_structured_headers.js">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_structured_headers.js">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_structured_headers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_text_attachment.js">mailnews/mime/test/unit/test_text_attachment.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_text_attachment.js">file</a> |
<a href="/comm-central/annotate/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_text_attachment.js">annotate</a> |
<a href="/comm-central/diff/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_text_attachment.js">diff</a> |
<a href="/comm-central/comparison/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_text_attachment.js">comparison</a> |
<a href="/comm-central/log/b2447f459283d075a942a40adcdb726471e543ba/mailnews/mime/test/unit/test_text_attachment.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/.eslintignore</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/.eslintignore</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -59,17 +59,16 @@ editor/ui/dialogs/content/EdSnapToGrid.j</span>
<a href="#l1.4"></a><span id="l1.4"> editor/ui/dialogs/content/EdSnapToGrid.xul</span>
<a href="#l1.5"></a><span id="l1.5"> editor/ui/texzilla/**</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> # mailnews exclusions</span>
<a href="#l1.8"></a><span id="l1.8"> mailnews/mailnews.js</span>
<a href="#l1.9"></a><span id="l1.9"> mailnews/extensions/dsn/content/dsn.js</span>
<a href="#l1.10"></a><span id="l1.10"> mailnews/extensions/mdn/content/mdn.js</span>
<a href="#l1.11"></a><span id="l1.11"> mailnews/extensions/smime/content/smime.js</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-mailnews/mime/*</span>
<a href="#l1.13"></a><span id="l1.13"> </span>
<a href="#l1.14"></a><span id="l1.14"> # mail exclusions</span>
<a href="#l1.15"></a><span id="l1.15"> mail/app/profile/all-thunderbird.js</span>
<a href="#l1.16"></a><span id="l1.16"> mail/app/profile/channel-prefs.js</span>
<a href="#l1.17"></a><span id="l1.17"> mail/app/profile/prefs.js</span>
<a href="#l1.18"></a><span id="l1.18"> mail/base/content/protovis-r2.6-modded.js</span>
<a href="#l1.19"></a><span id="l1.19"> mail/branding/nightly/thunderbird-branding.js</span>
<a href="#l1.20"></a><span id="l1.20"> mail/branding/thunderbird/thunderbird-branding.js</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/mime/jsmime/jsmime.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/mime/jsmime/jsmime.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1,26 +1,29 @@</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineminus">-(function (root, fn) {</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineminus">-  if (typeof define === 'function' &amp;&amp; define.amd) {</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineplus">+/* import-globals-from ../src/jsmime.jsm */</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineplus">+/* globals define, module */</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineplus">+</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+(function(root, fn) {</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+  if (typeof define === &quot;function&quot; &amp;&amp; define.amd) {</span>
<a href="#l2.11"></a><span id="l2.11">     define(fn);</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  } else if (typeof module !== 'undefined' &amp;&amp; module.exports) {</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+  } else if (typeof module !== &quot;undefined&quot; &amp;&amp; module.exports) {</span>
<a href="#l2.14"></a><span id="l2.14">     module.exports = fn();</span>
<a href="#l2.15"></a><span id="l2.15">   } else {</span>
<a href="#l2.16"></a><span id="l2.16">     root.jsmime = fn();</span>
<a href="#l2.17"></a><span id="l2.17">   }</span>
<a href="#l2.18"></a><span id="l2.18"> }(this, function() {</span>
<a href="#l2.19"></a><span id="l2.19">   var mods = {};</span>
<a href="#l2.20"></a><span id="l2.20">   function req(id) {</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-    return mods[id.replace(/^\.\//, '')];</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+    return mods[id.replace(/^\.\//, &quot;&quot;)];</span>
<a href="#l2.23"></a><span id="l2.23">   }</span>
<a href="#l2.24"></a><span id="l2.24"> </span>
<a href="#l2.25"></a><span id="l2.25">   function def(id, fn) {</span>
<a href="#l2.26"></a><span id="l2.26">     mods[id] = fn(req);</span>
<a href="#l2.27"></a><span id="l2.27">   }</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">-def('mimeutils', function() {</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+def(&quot;mimeutils&quot;, function() {</span>
<a href="#l2.30"></a><span id="l2.30"> &quot;use strict&quot;;</span>
<a href="#l2.31"></a><span id="l2.31"> </span>
<a href="#l2.32"></a><span id="l2.32"> /**</span>
<a href="#l2.33"></a><span id="l2.33">  * Decode a quoted-printable buffer into a binary string.</span>
<a href="#l2.34"></a><span id="l2.34">  *</span>
<a href="#l2.35"></a><span id="l2.35">  * @param buffer {BinaryString} The string to decode.</span>
<a href="#l2.36"></a><span id="l2.36">  * @param more   {Boolean}      This argument is ignored.</span>
<a href="#l2.37"></a><span id="l2.37">  * @returns {Array(BinaryString, BinaryString)} The first element of the array</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineat">@@ -28,53 +31,53 @@ def('mimeutils', function() {</span>
<a href="#l2.39"></a><span id="l2.39">  *          string.</span>
<a href="#l2.40"></a><span id="l2.40">  */</span>
<a href="#l2.41"></a><span id="l2.41"> function decode_qp(buffer, more) {</span>
<a href="#l2.42"></a><span id="l2.42">   // Unlike base64, quoted-printable isn't stateful across multiple lines, so</span>
<a href="#l2.43"></a><span id="l2.43">   // there is no need to buffer input, so we can always ignore more.</span>
<a href="#l2.44"></a><span id="l2.44">   let decoded = buffer.replace(</span>
<a href="#l2.45"></a><span id="l2.45">     // Replace either =&lt;hex&gt;&lt;hex&gt; or =&lt;wsp&gt;CRLF</span>
<a href="#l2.46"></a><span id="l2.46">     /=([0-9A-F][0-9A-F]|[ \t]*(\r\n|[\r\n]|$))/gi,</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-    function replace_chars(match, param) {</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+    function(match, param) {</span>
<a href="#l2.49"></a><span id="l2.49">       // If trailing text matches [ \t]*CRLF, drop everything, since it's a</span>
<a href="#l2.50"></a><span id="l2.50">       // soft line break.</span>
<a href="#l2.51"></a><span id="l2.51">       if (param.trim().length == 0)</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-        return '';</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+        return &quot;&quot;;</span>
<a href="#l2.54"></a><span id="l2.54">       return String.fromCharCode(parseInt(param, 16));</span>
<a href="#l2.55"></a><span id="l2.55">     });</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-  return [decoded, ''];</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+  return [decoded, &quot;&quot;];</span>
<a href="#l2.58"></a><span id="l2.58"> }</span>
<a href="#l2.59"></a><span id="l2.59"> </span>
<a href="#l2.60"></a><span id="l2.60"> /**</span>
<a href="#l2.61"></a><span id="l2.61">  * Decode a base64 buffer into a binary string. Unlike window.atob, the buffer</span>
<a href="#l2.62"></a><span id="l2.62">  * may contain non-base64 characters that will be ignored.</span>
<a href="#l2.63"></a><span id="l2.63">  *</span>
<a href="#l2.64"></a><span id="l2.64">  * @param buffer {BinaryString} The string to decode.</span>
<a href="#l2.65"></a><span id="l2.65">  * @param more   {Boolean}      If true, we expect that this function could be</span>
<a href="#l2.66"></a><span id="l2.66">  *                              called again and should retain extra data. If</span>
<a href="#l2.67"></a><span id="l2.67">  *                              false, we should flush all pending output.</span>
<a href="#l2.68"></a><span id="l2.68">  * @returns {Array(BinaryString, BinaryString)} The first element of the array</span>
<a href="#l2.69"></a><span id="l2.69">  *          is the decoded string. The second element contains the data that</span>
<a href="#l2.70"></a><span id="l2.70">  *          could not be decoded and needs to be retained for the next call.</span>
<a href="#l2.71"></a><span id="l2.71">  */</span>
<a href="#l2.72"></a><span id="l2.72"> function decode_base64(buffer, more) {</span>
<a href="#l2.73"></a><span id="l2.73">   // Drop all non-base64 characters</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-  let sanitize = buffer.replace(/[^A-Za-z0-9+\/=]/g,'');</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+  let sanitize = buffer.replace(/[^A-Za-z0-9+\/=]/g, &quot;&quot;);</span>
<a href="#l2.76"></a><span id="l2.76">   // Remove harmful `=' chars in the middle.</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-  sanitize = sanitize.replace(/=+([A-Za-z0-9+\/])/g, '$1');</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+  sanitize = sanitize.replace(/=+([A-Za-z0-9+\/])/g, &quot;$1&quot;);</span>
<a href="#l2.79"></a><span id="l2.79">   // We need to encode in groups of 4 chars. If we don't have enough, leave the</span>
<a href="#l2.80"></a><span id="l2.80">   // excess for later. If there aren't any more, drop enough to make it 4.</span>
<a href="#l2.81"></a><span id="l2.81">   let excess = sanitize.length % 4;</span>
<a href="#l2.82"></a><span id="l2.82">   if (excess != 0 &amp;&amp; more)</span>
<a href="#l2.83"></a><span id="l2.83">     buffer = sanitize.slice(-excess);</span>
<a href="#l2.84"></a><span id="l2.84">   else</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-    buffer = '';</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+    buffer = &quot;&quot;;</span>
<a href="#l2.87"></a><span id="l2.87">   sanitize = sanitize.substring(0, sanitize.length - excess);</span>
<a href="#l2.88"></a><span id="l2.88">   // Delete all unnecessary '====' in padding.</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineminus">-  sanitize = sanitize.replace(/(====)+$/g, '');</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+  sanitize = sanitize.replace(/(====)+$/g, &quot;&quot;);</span>
<a href="#l2.91"></a><span id="l2.91">   // Use the atob function we (ought to) have in global scope.</span>
<a href="#l2.92"></a><span id="l2.92">   return [atob(sanitize), buffer];</span>
<a href="#l2.93"></a><span id="l2.93"> }</span>
<a href="#l2.94"></a><span id="l2.94"> </span>
<a href="#l2.95"></a><span id="l2.95"> /**</span>
<a href="#l2.96"></a><span id="l2.96">  * Converts a binary string into a Uint8Array buffer.</span>
<a href="#l2.97"></a><span id="l2.97">  *</span>
<a href="#l2.98"></a><span id="l2.98">  * @param buffer {BinaryString} The string to convert.</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineat">@@ -89,40 +92,40 @@ function stringToTypedArray(buffer) {</span>
<a href="#l2.100"></a><span id="l2.100"> </span>
<a href="#l2.101"></a><span id="l2.101"> /**</span>
<a href="#l2.102"></a><span id="l2.102">  * Converts a Uint8Array buffer to a binary string.</span>
<a href="#l2.103"></a><span id="l2.103">  *</span>
<a href="#l2.104"></a><span id="l2.104">  * @param buffer {BinaryString} The string to convert.</span>
<a href="#l2.105"></a><span id="l2.105">  * @returns {Uint8Array} The converted data.</span>
<a href="#l2.106"></a><span id="l2.106">  */</span>
<a href="#l2.107"></a><span id="l2.107"> function typedArrayToString(buffer) {</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineminus">-  var string = '';</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineminus">-  for (var i = 0; i &lt; buffer.length; i+= 100)</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineplus">+  var string = &quot;&quot;;</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+  for (let i = 0; i &lt; buffer.length; i += 100)</span>
<a href="#l2.112"></a><span id="l2.112">     string += String.fromCharCode.apply(undefined, buffer.subarray(i, i + 100));</span>
<a href="#l2.113"></a><span id="l2.113">   return string;</span>
<a href="#l2.114"></a><span id="l2.114"> }</span>
<a href="#l2.115"></a><span id="l2.115"> </span>
<a href="#l2.116"></a><span id="l2.116"> /** A list of month names for Date parsing. */</span>
<a href="#l2.117"></a><span id="l2.117"> var kMonthNames = [&quot;Jan&quot;, &quot;Feb&quot;, &quot;Mar&quot;, &quot;Apr&quot;, &quot;May&quot;, &quot;Jun&quot;, &quot;Jul&quot;, &quot;Aug&quot;,</span>
<a href="#l2.118"></a><span id="l2.118">   &quot;Sep&quot;, &quot;Oct&quot;, &quot;Nov&quot;, &quot;Dec&quot;];</span>
<a href="#l2.119"></a><span id="l2.119"> </span>
<a href="#l2.120"></a><span id="l2.120"> return {</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineminus">-  decode_base64: decode_base64,</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineminus">-  decode_qp: decode_qp,</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineminus">-  kMonthNames: kMonthNames,</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineminus">-  stringToTypedArray: stringToTypedArray,</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineminus">-  typedArrayToString: typedArrayToString,</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineplus">+  decode_base64,</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineplus">+  decode_qp,</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineplus">+  kMonthNames,</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineplus">+  stringToTypedArray,</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+  typedArrayToString,</span>
<a href="#l2.131"></a><span id="l2.131"> };</span>
<a href="#l2.132"></a><span id="l2.132"> });</span>
<a href="#l2.133"></a><span id="l2.133"> /**</span>
<a href="#l2.134"></a><span id="l2.134">  * This file implements knowledge of how to encode or decode structured headers</span>
<a href="#l2.135"></a><span id="l2.135">  * for several key headers. It is not meant to be used externally to jsmime.</span>
<a href="#l2.136"></a><span id="l2.136">  */</span>
<a href="#l2.137"></a><span id="l2.137"> </span>
<a href="#l2.138"></a><span id="l2.138" class="difflineminus">-def('structuredHeaders', function (require) {</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineplus">+def(&quot;structuredHeaders&quot;, function(require) {</span>
<a href="#l2.140"></a><span id="l2.140"> &quot;use strict&quot;;</span>
<a href="#l2.141"></a><span id="l2.141"> </span>
<a href="#l2.142"></a><span id="l2.142"> var structuredDecoders = new Map();</span>
<a href="#l2.143"></a><span id="l2.143"> var structuredEncoders = new Map();</span>
<a href="#l2.144"></a><span id="l2.144"> var preferredSpellings = new Map();</span>
<a href="#l2.145"></a><span id="l2.145"> </span>
<a href="#l2.146"></a><span id="l2.146"> function addHeader(name, decoder, encoder) {</span>
<a href="#l2.147"></a><span id="l2.147">   var lowerName = name.toLowerCase();</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineat">@@ -132,19 +135,18 @@ function addHeader(name, decoder, encode</span>
<a href="#l2.149"></a><span id="l2.149"> }</span>
<a href="#l2.150"></a><span id="l2.150"> </span>
<a href="#l2.151"></a><span id="l2.151"> </span>
<a href="#l2.152"></a><span id="l2.152"> // Addressing headers: We assume that they can be specified in 1* form (this is</span>
<a href="#l2.153"></a><span id="l2.153"> // false for From, but it's close enough to the truth that it shouldn't matter).</span>
<a href="#l2.154"></a><span id="l2.154"> // There is no need to specialize the results for the header, so just pun it</span>
<a href="#l2.155"></a><span id="l2.155"> // back to parseAddressingHeader.</span>
<a href="#l2.156"></a><span id="l2.156"> function parseAddress(value) {</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineminus">-  let results = [];</span>
<a href="#l2.158"></a><span id="l2.158">   let headerparser = this;</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineminus">-  return value.reduce(function (results, header) {</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineplus">+  return value.reduce(function(results, header) {</span>
<a href="#l2.161"></a><span id="l2.161">     return results.concat(headerparser.parseAddressingHeader(header, true));</span>
<a href="#l2.162"></a><span id="l2.162">   }, []);</span>
<a href="#l2.163"></a><span id="l2.163"> }</span>
<a href="#l2.164"></a><span id="l2.164"> function writeAddress(value) {</span>
<a href="#l2.165"></a><span id="l2.165">   // Make sure the input is an array (accept a single entry)</span>
<a href="#l2.166"></a><span id="l2.166">   if (!Array.isArray(value))</span>
<a href="#l2.167"></a><span id="l2.167">     value = [value];</span>
<a href="#l2.168"></a><span id="l2.168">   this.addAddresses(value);</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineat">@@ -181,30 +183,30 @@ function parseParameterHeader(value, do2</span>
<a href="#l2.170"></a><span id="l2.170">   // Only use the first header for parameters; ignore subsequent redefinitions.</span>
<a href="#l2.171"></a><span id="l2.171">   return this.parseParameterHeader(value[0], do2231, do2047);</span>
<a href="#l2.172"></a><span id="l2.172"> }</span>
<a href="#l2.173"></a><span id="l2.173"> </span>
<a href="#l2.174"></a><span id="l2.174"> // RFC 2045</span>
<a href="#l2.175"></a><span id="l2.175"> function parseContentType(value) {</span>
<a href="#l2.176"></a><span id="l2.176">   let params = parseParameterHeader.call(this, value, false, false);</span>
<a href="#l2.177"></a><span id="l2.177">   let origtype = params.preSemi;</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineminus">-  let parts = origtype.split('/');</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineplus">+  let parts = origtype.split(&quot;/&quot;);</span>
<a href="#l2.180"></a><span id="l2.180">   if (parts.length != 2) {</span>
<a href="#l2.181"></a><span id="l2.181">     // Malformed. Return to text/plain. Evil, ain't it?</span>
<a href="#l2.182"></a><span id="l2.182">     params = new Map();</span>
<a href="#l2.183"></a><span id="l2.183">     parts = [&quot;text&quot;, &quot;plain&quot;];</span>
<a href="#l2.184"></a><span id="l2.184">   }</span>
<a href="#l2.185"></a><span id="l2.185">   let mediatype = parts[0].toLowerCase();</span>
<a href="#l2.186"></a><span id="l2.186">   let subtype = parts[1].toLowerCase();</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineminus">-  let type = mediatype + '/' + subtype;</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineplus">+  let type = mediatype + &quot;/&quot; + subtype;</span>
<a href="#l2.189"></a><span id="l2.189">   let structure = new Map();</span>
<a href="#l2.190"></a><span id="l2.190">   structure.mediatype = mediatype;</span>
<a href="#l2.191"></a><span id="l2.191">   structure.subtype = subtype;</span>
<a href="#l2.192"></a><span id="l2.192">   structure.type = type;</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineminus">-  params.forEach(function (value, name) {</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineplus">+  params.forEach(function(value, name) {</span>
<a href="#l2.195"></a><span id="l2.195">     structure.set(name.toLowerCase(), value);</span>
<a href="#l2.196"></a><span id="l2.196">   });</span>
<a href="#l2.197"></a><span id="l2.197">   return structure;</span>
<a href="#l2.198"></a><span id="l2.198"> }</span>
<a href="#l2.199"></a><span id="l2.199"> structuredDecoders.set(&quot;Content-Type&quot;, parseContentType);</span>
<a href="#l2.200"></a><span id="l2.200"> </span>
<a href="#l2.201"></a><span id="l2.201"> // Unstructured headers (just decode RFC 2047 for the first header value)</span>
<a href="#l2.202"></a><span id="l2.202"> function parseUnstructured(values) {</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineat">@@ -250,53 +252,52 @@ addHeader(&quot;NNTP-Posting-Date&quot;, parseDate</span>
<a href="#l2.204"></a><span id="l2.204"> </span>
<a href="#l2.205"></a><span id="l2.205"> // RFC 5322</span>
<a href="#l2.206"></a><span id="l2.206"> addHeader(&quot;Message-ID&quot;, parseMessageID, writeMessageID);</span>
<a href="#l2.207"></a><span id="l2.207"> addHeader(&quot;Resent-Message-ID&quot;, parseMessageID, writeMessageID);</span>
<a href="#l2.208"></a><span id="l2.208"> </span>
<a href="#l2.209"></a><span id="l2.209"> // Miscellaneous headers (those that don't fall under the above schemes):</span>
<a href="#l2.210"></a><span id="l2.210"> </span>
<a href="#l2.211"></a><span id="l2.211"> // RFC 2047</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineminus">-structuredDecoders.set(&quot;Content-Transfer-Encoding&quot;, function (values) {</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineplus">+structuredDecoders.set(&quot;Content-Transfer-Encoding&quot;, function(values) {</span>
<a href="#l2.214"></a><span id="l2.214">   return values[0].toLowerCase();</span>
<a href="#l2.215"></a><span id="l2.215"> });</span>
<a href="#l2.216"></a><span id="l2.216"> structuredEncoders.set(&quot;Content-Transfer-Encoding&quot;, writeUnstructured);</span>
<a href="#l2.217"></a><span id="l2.217"> </span>
<a href="#l2.218"></a><span id="l2.218"> // Some clients like outlook.com send non-compliant References headers that</span>
<a href="#l2.219"></a><span id="l2.219"> // separate values using commas. Also, some clients don't separate References</span>
<a href="#l2.220"></a><span id="l2.220"> // with spaces, since these are optional according to RFC2822. So here we</span>
<a href="#l2.221"></a><span id="l2.221"> // preprocess these headers (see bug 1154521 and bug 1197686).</span>
<a href="#l2.222"></a><span id="l2.222"> function preprocessMessageIDs(values) {</span>
<a href="#l2.223"></a><span id="l2.223">   let msgId = /&lt;[^&gt;]*&gt;/g;</span>
<a href="#l2.224"></a><span id="l2.224">   let match, ids = [];</span>
<a href="#l2.225"></a><span id="l2.225">   while ((match = msgId.exec(values)) !== null) {</span>
<a href="#l2.226"></a><span id="l2.226">     ids.push(match[0]);</span>
<a href="#l2.227"></a><span id="l2.227">   }</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineminus">-  return ids.join(' ');</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineplus">+  return ids.join(&quot; &quot;);</span>
<a href="#l2.230"></a><span id="l2.230"> }</span>
<a href="#l2.231"></a><span id="l2.231"> structuredDecoders.set(&quot;References&quot;, preprocessMessageIDs);</span>
<a href="#l2.232"></a><span id="l2.232"> structuredDecoders.set(&quot;In-Reply-To&quot;, preprocessMessageIDs);</span>
<a href="#l2.233"></a><span id="l2.233"> </span>
<a href="#l2.234"></a><span id="l2.234"> return Object.freeze({</span>
<a href="#l2.235"></a><span id="l2.235">   decoders: structuredDecoders,</span>
<a href="#l2.236"></a><span id="l2.236">   encoders: structuredEncoders,</span>
<a href="#l2.237"></a><span id="l2.237">   spellings: preferredSpellings,</span>
<a href="#l2.238"></a><span id="l2.238"> });</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineminus">-</span>
<a href="#l2.240"></a><span id="l2.240"> });</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineminus">-def('headerparser', function(require) {</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineplus">+def(&quot;headerparser&quot;, function(require) {</span>
<a href="#l2.243"></a><span id="l2.243"> /**</span>
<a href="#l2.244"></a><span id="l2.244">  * This file implements the structured decoding of message header fields. It is</span>
<a href="#l2.245"></a><span id="l2.245">  * part of the same system as found in mimemimeutils.js, and occasionally makes</span>
<a href="#l2.246"></a><span id="l2.246">  * references to globals defined in that file or other dependencies thereof. See</span>
<a href="#l2.247"></a><span id="l2.247">  * documentation in that file for more information about external dependencies.</span>
<a href="#l2.248"></a><span id="l2.248">  */</span>
<a href="#l2.249"></a><span id="l2.249"> </span>
<a href="#l2.250"></a><span id="l2.250"> &quot;use strict&quot;;</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineminus">-var mimeutils = require('./mimeutils');</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineplus">+var mimeutils = require(&quot;./mimeutils&quot;);</span>
<a href="#l2.253"></a><span id="l2.253"> </span>
<a href="#l2.254"></a><span id="l2.254"> /**</span>
<a href="#l2.255"></a><span id="l2.255">  * This is the API that we ultimately return.</span>
<a href="#l2.256"></a><span id="l2.256">  *</span>
<a href="#l2.257"></a><span id="l2.257">  * We define it as a global here, because we need to pass it as a |this|</span>
<a href="#l2.258"></a><span id="l2.258">  * argument to a few functions.</span>
<a href="#l2.259"></a><span id="l2.259">  */</span>
<a href="#l2.260"></a><span id="l2.260"> var headerparser = {};</span>
<a href="#l2.261"></a><span id="l2.261" class="difflineat">@@ -370,28 +371,29 @@ var headerparser = {};</span>
<a href="#l2.262"></a><span id="l2.262">  * @param {Boolean} [opts.dliteral] If true, recognize domain literals.</span>
<a href="#l2.263"></a><span id="l2.263">  * @param {Boolean} [opts.comments] If true, recognize comments.</span>
<a href="#l2.264"></a><span id="l2.264">  * @param {Boolean} [opts.rfc2047]  If true, parse and decode RFC 2047</span>
<a href="#l2.265"></a><span id="l2.265">  *                                  encoded-words.</span>
<a href="#l2.266"></a><span id="l2.266">  * @returns {(Token|String)[]} An array of Token objects (which have a toString</span>
<a href="#l2.267"></a><span id="l2.267">  *                             method returning their value) or String objects</span>
<a href="#l2.268"></a><span id="l2.268">  *                             (representing delimiters).</span>
<a href="#l2.269"></a><span id="l2.269">  */</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineplus">+/* eslint-disable complexity */</span>
<a href="#l2.271"></a><span id="l2.271"> function getHeaderTokens(value, delimiters, opts) {</span>
<a href="#l2.272"></a><span id="l2.272">   // The array of parsed tokens. This method used to be a generator, but it</span>
<a href="#l2.273"></a><span id="l2.273">   // appears that generators are poorly optimized in current engines, so it was</span>
<a href="#l2.274"></a><span id="l2.274">   // converted to not be one.</span>
<a href="#l2.275"></a><span id="l2.275">   let tokenList = [];</span>
<a href="#l2.276"></a><span id="l2.276"> </span>
<a href="#l2.277"></a><span id="l2.277" class="difflineminus">-  /// Represents a non-delimiter token</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineplus">+  // Represents a non-delimiter token</span>
<a href="#l2.279"></a><span id="l2.279">   function Token(token) {</span>
<a href="#l2.280"></a><span id="l2.280">     // Unescape all quoted pairs. Any trailing \ is deleted.</span>
<a href="#l2.281"></a><span id="l2.281">     this.token = token.replace(/\\(.?)/g, &quot;$1&quot;);</span>
<a href="#l2.282"></a><span id="l2.282">   }</span>
<a href="#l2.283"></a><span id="l2.283" class="difflineminus">-  Token.prototype.toString = function () { return this.token; };</span>
<a href="#l2.284"></a><span id="l2.284" class="difflineplus">+  Token.prototype.toString = function() { return this.token; };</span>
<a href="#l2.285"></a><span id="l2.285"> </span>
<a href="#l2.286"></a><span id="l2.286">   // The start of the current token (e.g., atoms, strings)</span>
<a href="#l2.287"></a><span id="l2.287">   let tokenStart = undefined;</span>
<a href="#l2.288"></a><span id="l2.288">   // The set of whitespace characters, as defined by RFC 5322</span>
<a href="#l2.289"></a><span id="l2.289">   let wsp = &quot; \t\r\n&quot;;</span>
<a href="#l2.290"></a><span id="l2.290">   // If we are a domain literal ([]) or a quoted string (&quot;), this is set to the</span>
<a href="#l2.291"></a><span id="l2.291">   // character to look for at the end.</span>
<a href="#l2.292"></a><span id="l2.292">   let endQuote = undefined;</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineat">@@ -400,17 +402,17 @@ function getHeaderTokens(value, delimite</span>
<a href="#l2.294"></a><span id="l2.294">   let commentDepth = 0;</span>
<a href="#l2.295"></a><span id="l2.295"> </span>
<a href="#l2.296"></a><span id="l2.296">   // Iterate over every character one character at a time.</span>
<a href="#l2.297"></a><span id="l2.297">   let length = value.length;</span>
<a href="#l2.298"></a><span id="l2.298">   for (let i = 0; i &lt; length; i++) {</span>
<a href="#l2.299"></a><span id="l2.299">     let ch = value[i];</span>
<a href="#l2.300"></a><span id="l2.300">     // If we see a \, no matter what context we are in, ignore the next</span>
<a href="#l2.301"></a><span id="l2.301">     // character.</span>
<a href="#l2.302"></a><span id="l2.302" class="difflineminus">-    if (ch == '\\') {</span>
<a href="#l2.303"></a><span id="l2.303" class="difflineplus">+    if (ch == &quot;\\&quot;) {</span>
<a href="#l2.304"></a><span id="l2.304">       i++;</span>
<a href="#l2.305"></a><span id="l2.305">       continue;</span>
<a href="#l2.306"></a><span id="l2.306">     }</span>
<a href="#l2.307"></a><span id="l2.307"> </span>
<a href="#l2.308"></a><span id="l2.308">     // If we are in a qstring or a dliteral, process the character only if it is</span>
<a href="#l2.309"></a><span id="l2.309">     // what we are looking for to end the quote.</span>
<a href="#l2.310"></a><span id="l2.310">     if (endQuote !== undefined) {</span>
<a href="#l2.311"></a><span id="l2.311">       if (ch == endQuote &amp;&amp; ch == '&quot;') {</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineat">@@ -419,29 +421,29 @@ function getHeaderTokens(value, delimite</span>
<a href="#l2.313"></a><span id="l2.313"> </span>
<a href="#l2.314"></a><span id="l2.314">         // If RFC 2047 is enabled, always decode the qstring.</span>
<a href="#l2.315"></a><span id="l2.315">         if (opts.rfc2047)</span>
<a href="#l2.316"></a><span id="l2.316">           text = decodeRFC2047Words(text);</span>
<a href="#l2.317"></a><span id="l2.317"> </span>
<a href="#l2.318"></a><span id="l2.318">         tokenList.push(new Token(text));</span>
<a href="#l2.319"></a><span id="l2.319">         endQuote = undefined;</span>
<a href="#l2.320"></a><span id="l2.320">         tokenStart = undefined;</span>
<a href="#l2.321"></a><span id="l2.321" class="difflineminus">-      } else if (ch == endQuote &amp;&amp; ch == ']') {</span>
<a href="#l2.322"></a><span id="l2.322" class="difflineplus">+      } else if (ch == endQuote &amp;&amp; ch == &quot;]&quot;) {</span>
<a href="#l2.323"></a><span id="l2.323">         // Domain literals include their delimiters.</span>
<a href="#l2.324"></a><span id="l2.324">         tokenList.push(new Token(value.slice(tokenStart, i + 1)));</span>
<a href="#l2.325"></a><span id="l2.325">         endQuote = undefined;</span>
<a href="#l2.326"></a><span id="l2.326">         tokenStart = undefined;</span>
<a href="#l2.327"></a><span id="l2.327">       }</span>
<a href="#l2.328"></a><span id="l2.328">       // Avoid any further processing.</span>
<a href="#l2.329"></a><span id="l2.329">       continue;</span>
<a href="#l2.330"></a><span id="l2.330">     }</span>
<a href="#l2.331"></a><span id="l2.331"> </span>
<a href="#l2.332"></a><span id="l2.332">     // If we can match the RFC 2047 encoded-word pattern, we need to decode the</span>
<a href="#l2.333"></a><span id="l2.333">     // entire word or set of words.</span>
<a href="#l2.334"></a><span id="l2.334" class="difflineminus">-    if (opts.rfc2047 &amp;&amp; ch == '=' &amp;&amp; i + 1 &lt; value.length &amp;&amp; value[i + 1] == '?') {</span>
<a href="#l2.335"></a><span id="l2.335" class="difflineplus">+    if (opts.rfc2047 &amp;&amp; ch == &quot;=&quot; &amp;&amp; i + 1 &lt; value.length &amp;&amp; value[i + 1] == &quot;?&quot;) {</span>
<a href="#l2.336"></a><span id="l2.336">       // RFC 2047 tokens separated only by whitespace are conceptually part of</span>
<a href="#l2.337"></a><span id="l2.337">       // the same output token, so we need to decode them all at once.</span>
<a href="#l2.338"></a><span id="l2.338">       let encodedWordsRE = /([ \t\r\n]*=\?[^?]*\?[BbQq]\?[^?]*\?=)+/;</span>
<a href="#l2.339"></a><span id="l2.339">       let result = encodedWordsRE.exec(value.slice(i));</span>
<a href="#l2.340"></a><span id="l2.340">       if (result !== null) {</span>
<a href="#l2.341"></a><span id="l2.341">         // If we were in the middle of a prior token (i.e., something like</span>
<a href="#l2.342"></a><span id="l2.342">         // foobar=?UTF-8?Q?blah?=), yield the previous segment as a token.</span>
<a href="#l2.343"></a><span id="l2.343">         if (tokenStart !== undefined) {</span>
<a href="#l2.344"></a><span id="l2.344" class="difflineat">@@ -450,17 +452,17 @@ function getHeaderTokens(value, delimite</span>
<a href="#l2.345"></a><span id="l2.345">         }</span>
<a href="#l2.346"></a><span id="l2.346"> </span>
<a href="#l2.347"></a><span id="l2.347">         // Find out how much we need to decode...</span>
<a href="#l2.348"></a><span id="l2.348">         let encWordsLen = result[0].length;</span>
<a href="#l2.349"></a><span id="l2.349">         let string = decodeRFC2047Words(value.slice(i, i + encWordsLen),</span>
<a href="#l2.350"></a><span id="l2.350">           &quot;UTF-8&quot;);</span>
<a href="#l2.351"></a><span id="l2.351">         // Don't make a new Token variable, since we do not want to unescape the</span>
<a href="#l2.352"></a><span id="l2.352">         // decoded string.</span>
<a href="#l2.353"></a><span id="l2.353" class="difflineminus">-        tokenList.push({ toString: function() { return string; }});</span>
<a href="#l2.354"></a><span id="l2.354" class="difflineplus">+        tokenList.push({ toString() { return string; }});</span>
<a href="#l2.355"></a><span id="l2.355"> </span>
<a href="#l2.356"></a><span id="l2.356">         // Skip everything we decoded. The -1 is because we don't want to</span>
<a href="#l2.357"></a><span id="l2.357">         // include the starting character.</span>
<a href="#l2.358"></a><span id="l2.358">         i += encWordsLen - 1;</span>
<a href="#l2.359"></a><span id="l2.359">         continue;</span>
<a href="#l2.360"></a><span id="l2.360">       }</span>
<a href="#l2.361"></a><span id="l2.361"> </span>
<a href="#l2.362"></a><span id="l2.362">       // If we are here, then we failed to match the simple 2047 encoded-word</span>
<a href="#l2.363"></a><span id="l2.363" class="difflineat">@@ -491,33 +493,33 @@ function getHeaderTokens(value, delimite</span>
<a href="#l2.364"></a><span id="l2.364">       // apply within comments.</span>
<a href="#l2.365"></a><span id="l2.365">       tokenIsEnding = true;</span>
<a href="#l2.366"></a><span id="l2.366">       isSpecial = true;</span>
<a href="#l2.367"></a><span id="l2.367">     } else if (opts.qstring &amp;&amp; ch == '&quot;') {</span>
<a href="#l2.368"></a><span id="l2.368">       // Quoted strings end the last token and start a new one.</span>
<a href="#l2.369"></a><span id="l2.369">       tokenIsEnding = true;</span>
<a href="#l2.370"></a><span id="l2.370">       tokenIsStarting = true;</span>
<a href="#l2.371"></a><span id="l2.371">       endQuote = ch;</span>
<a href="#l2.372"></a><span id="l2.372" class="difflineminus">-    } else if (opts.dliteral &amp;&amp; ch == '[') {</span>
<a href="#l2.373"></a><span id="l2.373" class="difflineplus">+    } else if (opts.dliteral &amp;&amp; ch == &quot;[&quot;) {</span>
<a href="#l2.374"></a><span id="l2.374">       // Domain literals end the last token and start a new one.</span>
<a href="#l2.375"></a><span id="l2.375">       tokenIsEnding = true;</span>
<a href="#l2.376"></a><span id="l2.376">       tokenIsStarting = true;</span>
<a href="#l2.377"></a><span id="l2.377" class="difflineminus">-      endQuote = ']';</span>
<a href="#l2.378"></a><span id="l2.378" class="difflineminus">-    } else if (opts.comments &amp;&amp; ch == '(') {</span>
<a href="#l2.379"></a><span id="l2.379" class="difflineplus">+      endQuote = &quot;]&quot;;</span>
<a href="#l2.380"></a><span id="l2.380" class="difflineplus">+    } else if (opts.comments &amp;&amp; ch == &quot;(&quot;) {</span>
<a href="#l2.381"></a><span id="l2.381">       // Comments are nested (oh joy). We only really care for the outer</span>
<a href="#l2.382"></a><span id="l2.382">       // delimiter, though, which also ends the prior token and needs to be</span>
<a href="#l2.383"></a><span id="l2.383">       // output if the consumer requests it.</span>
<a href="#l2.384"></a><span id="l2.384">       commentDepth++;</span>
<a href="#l2.385"></a><span id="l2.385">       if (commentDepth == 1) {</span>
<a href="#l2.386"></a><span id="l2.386">         tokenIsEnding = true;</span>
<a href="#l2.387"></a><span id="l2.387">         isSpecial = true;</span>
<a href="#l2.388"></a><span id="l2.388">       } else {</span>
<a href="#l2.389"></a><span id="l2.389">         tokenIsStarting = true;</span>
<a href="#l2.390"></a><span id="l2.390">       }</span>
<a href="#l2.391"></a><span id="l2.391" class="difflineminus">-    } else if (opts.comments &amp;&amp; ch == ')') {</span>
<a href="#l2.392"></a><span id="l2.392" class="difflineplus">+    } else if (opts.comments &amp;&amp; ch == &quot;)&quot;) {</span>
<a href="#l2.393"></a><span id="l2.393">       // Comments are nested (oh joy). We only really care for the outer</span>
<a href="#l2.394"></a><span id="l2.394">       // delimiter, though, which also ends the prior token and needs to be</span>
<a href="#l2.395"></a><span id="l2.395">       // output if the consumer requests it.</span>
<a href="#l2.396"></a><span id="l2.396">       if (commentDepth &gt; 0)</span>
<a href="#l2.397"></a><span id="l2.397">         commentDepth--;</span>
<a href="#l2.398"></a><span id="l2.398">       if (commentDepth == 0) {</span>
<a href="#l2.399"></a><span id="l2.399">         tokenIsEnding = true;</span>
<a href="#l2.400"></a><span id="l2.400">         isSpecial = true;</span>
<a href="#l2.401"></a><span id="l2.401" class="difflineat">@@ -554,16 +556,17 @@ function getHeaderTokens(value, delimite</span>
<a href="#l2.402"></a><span id="l2.402">     if (endQuote == '&quot;')</span>
<a href="#l2.403"></a><span id="l2.403">       tokenList.push(new Token(value.slice(tokenStart + 1)));</span>
<a href="#l2.404"></a><span id="l2.404">     else</span>
<a href="#l2.405"></a><span id="l2.405">       tokenList.push(new Token(value.slice(tokenStart)));</span>
<a href="#l2.406"></a><span id="l2.406">   }</span>
<a href="#l2.407"></a><span id="l2.407"> </span>
<a href="#l2.408"></a><span id="l2.408">   return tokenList;</span>
<a href="#l2.409"></a><span id="l2.409"> }</span>
<a href="#l2.410"></a><span id="l2.410" class="difflineplus">+/* eslint-enable complexity */</span>
<a href="#l2.411"></a><span id="l2.411"> </span>
<a href="#l2.412"></a><span id="l2.412"> /**</span>
<a href="#l2.413"></a><span id="l2.413">  * Convert a header value into UTF-16 strings by attempting to decode as UTF-8</span>
<a href="#l2.414"></a><span id="l2.414">  * or another legacy charset. If the header is valid UTF-8, it will be decoded</span>
<a href="#l2.415"></a><span id="l2.415">  * as UTF-8; if it is not, the fallbackCharset will be attempted instead.</span>
<a href="#l2.416"></a><span id="l2.416">  *</span>
<a href="#l2.417"></a><span id="l2.417">  * @param {String} headerValue       The header (as a binary string) to attempt</span>
<a href="#l2.418"></a><span id="l2.418">  *                                   to convert to UTF-16.</span>
<a href="#l2.419"></a><span id="l2.419" class="difflineat">@@ -607,66 +610,66 @@ function convert8BitHeader(headerValue, </span>
<a href="#l2.420"></a><span id="l2.420">  */</span>
<a href="#l2.421"></a><span id="l2.421"> function decodeRFC2047Words(headerValue) {</span>
<a href="#l2.422"></a><span id="l2.422">   // Unfortunately, many implementations of RFC 2047 encoding are actually wrong</span>
<a href="#l2.423"></a><span id="l2.423">   // in that they split over-long encoded words without regard for whether or</span>
<a href="#l2.424"></a><span id="l2.424">   // not the split point is in the middle of a multibyte character. Therefore,</span>
<a href="#l2.425"></a><span id="l2.425">   // we need to be able to handle these situations gracefully. This is done by</span>
<a href="#l2.426"></a><span id="l2.426">   // using the decoder in streaming mode so long as the next token is another</span>
<a href="#l2.427"></a><span id="l2.427">   // 2047 token with the same charset.</span>
<a href="#l2.428"></a><span id="l2.428" class="difflineminus">-  let lastCharset = '', currentDecoder = undefined;</span>
<a href="#l2.429"></a><span id="l2.429" class="difflineplus">+  let lastCharset = &quot;&quot;, currentDecoder = undefined;</span>
<a href="#l2.430"></a><span id="l2.430"> </span>
<a href="#l2.431"></a><span id="l2.431">   /**</span>
<a href="#l2.432"></a><span id="l2.432">    * Decode a single RFC 2047 token. This function is inline so that we can</span>
<a href="#l2.433"></a><span id="l2.433">    * easily close over the lastCharset/currentDecoder variables, needed for</span>
<a href="#l2.434"></a><span id="l2.434">    * handling bad RFC 2047 productions properly.</span>
<a href="#l2.435"></a><span id="l2.435">    */</span>
<a href="#l2.436"></a><span id="l2.436">   function decode2047Token(token, isLastToken) {</span>
<a href="#l2.437"></a><span id="l2.437">     let tokenParts = token.split(&quot;?&quot;);</span>
<a href="#l2.438"></a><span id="l2.438"> </span>
<a href="#l2.439"></a><span id="l2.439">     // If it's obviously not a valid token, return false immediately.</span>
<a href="#l2.440"></a><span id="l2.440" class="difflineminus">-    if (tokenParts.length != 5 || tokenParts[4] != '=')</span>
<a href="#l2.441"></a><span id="l2.441" class="difflineplus">+    if (tokenParts.length != 5 || tokenParts[4] != &quot;=&quot;)</span>
<a href="#l2.442"></a><span id="l2.442">       return false;</span>
<a href="#l2.443"></a><span id="l2.443"> </span>
<a href="#l2.444"></a><span id="l2.444">     // The charset parameter is defined in RFC 2231 to be charset or</span>
<a href="#l2.445"></a><span id="l2.445">     // charset*language. We only care about the charset here, so ignore any</span>
<a href="#l2.446"></a><span id="l2.446">     // language parameter that gets passed in.</span>
<a href="#l2.447"></a><span id="l2.447" class="difflineminus">-    let charset = tokenParts[1].split('*', 1)[0];</span>
<a href="#l2.448"></a><span id="l2.448" class="difflineplus">+    let charset = tokenParts[1].split(&quot;*&quot;, 1)[0];</span>
<a href="#l2.449"></a><span id="l2.449">     let encoding = tokenParts[2], text = tokenParts[3];</span>
<a href="#l2.450"></a><span id="l2.450"> </span>
<a href="#l2.451"></a><span id="l2.451">     let buffer;</span>
<a href="#l2.452"></a><span id="l2.452" class="difflineminus">-    if (encoding == 'B' || encoding == 'b') {</span>
<a href="#l2.453"></a><span id="l2.453" class="difflineplus">+    if (encoding == &quot;B&quot; || encoding == &quot;b&quot;) {</span>
<a href="#l2.454"></a><span id="l2.454">       // Decode base64. If there's any non-base64 data, treat the string as</span>
<a href="#l2.455"></a><span id="l2.455">       // an illegal token.</span>
<a href="#l2.456"></a><span id="l2.456">       if (/[^ A-Za-z0-9+\/=]/.exec(text))</span>
<a href="#l2.457"></a><span id="l2.457">         return false;</span>
<a href="#l2.458"></a><span id="l2.458"> </span>
<a href="#l2.459"></a><span id="l2.459">       // Decode the string</span>
<a href="#l2.460"></a><span id="l2.460">       buffer = mimeutils.decode_base64(text, false)[0];</span>
<a href="#l2.461"></a><span id="l2.461" class="difflineminus">-    } else if (encoding == 'Q' || encoding == 'q') {</span>
<a href="#l2.462"></a><span id="l2.462" class="difflineplus">+    } else if (encoding == &quot;Q&quot; || encoding == &quot;q&quot;) {</span>
<a href="#l2.463"></a><span id="l2.463">       // Q encoding here looks a lot like quoted-printable text. The differences</span>
<a href="#l2.464"></a><span id="l2.464">       // between quoted-printable and this are that quoted-printable allows you</span>
<a href="#l2.465"></a><span id="l2.465">       // to quote newlines (this doesn't), while this replaces spaces with _.</span>
<a href="#l2.466"></a><span id="l2.466">       // We can reuse the decode_qp code here, since newlines are already</span>
<a href="#l2.467"></a><span id="l2.467">       // stripped from the header. There is one edge case that could trigger a</span>
<a href="#l2.468"></a><span id="l2.468">       // false positive, namely when you have a single = or an = followed by</span>
<a href="#l2.469"></a><span id="l2.469">       // whitespace at the end of the string. Such an input string is already</span>
<a href="#l2.470"></a><span id="l2.470">       // malformed to begin with, so stripping the = and following input in that</span>
<a href="#l2.471"></a><span id="l2.471">       // case should not be an important loss.</span>
<a href="#l2.472"></a><span id="l2.472" class="difflineminus">-      buffer = mimeutils.decode_qp(text.replace(/_/g, ' '), false)[0];</span>
<a href="#l2.473"></a><span id="l2.473" class="difflineplus">+      buffer = mimeutils.decode_qp(text.replace(/_/g, &quot; &quot;), false)[0];</span>
<a href="#l2.474"></a><span id="l2.474">     } else {</span>
<a href="#l2.475"></a><span id="l2.475">       return false;</span>
<a href="#l2.476"></a><span id="l2.476">     }</span>
<a href="#l2.477"></a><span id="l2.477"> </span>
<a href="#l2.478"></a><span id="l2.478">     // Make the buffer be a typed array for what follows</span>
<a href="#l2.479"></a><span id="l2.479">     let stringBuffer = buffer;</span>
<a href="#l2.480"></a><span id="l2.480">     buffer = mimeutils.stringToTypedArray(buffer);</span>
<a href="#l2.481"></a><span id="l2.481"> </span>
<a href="#l2.482"></a><span id="l2.482">     // If we cannot reuse the last decoder, flush out whatever remains.</span>
<a href="#l2.483"></a><span id="l2.483" class="difflineminus">-    var output = '';</span>
<a href="#l2.484"></a><span id="l2.484" class="difflineplus">+    var output = &quot;&quot;;</span>
<a href="#l2.485"></a><span id="l2.485">     if (charset != lastCharset &amp;&amp; currentDecoder) {</span>
<a href="#l2.486"></a><span id="l2.486">       output += currentDecoder.decode();</span>
<a href="#l2.487"></a><span id="l2.487">       currentDecoder = null;</span>
<a href="#l2.488"></a><span id="l2.488">     }</span>
<a href="#l2.489"></a><span id="l2.489"> </span>
<a href="#l2.490"></a><span id="l2.490">     // Initialize the decoder for this token.</span>
<a href="#l2.491"></a><span id="l2.491">     lastCharset = charset;</span>
<a href="#l2.492"></a><span id="l2.492">     if (!currentDecoder) {</span>
<a href="#l2.493"></a><span id="l2.493" class="difflineat">@@ -717,37 +720,36 @@ function decodeRFC2047Words(headerValue)</span>
<a href="#l2.494"></a><span id="l2.494">         components[i] = decoded;</span>
<a href="#l2.495"></a><span id="l2.495"> </span>
<a href="#l2.496"></a><span id="l2.496">         // We're done processing, so continue to the next link.</span>
<a href="#l2.497"></a><span id="l2.497">         continue;</span>
<a href="#l2.498"></a><span id="l2.498">       }</span>
<a href="#l2.499"></a><span id="l2.499">     } else if (/^[ \t\r\n]*$/.exec(components[i])) {</span>
<a href="#l2.500"></a><span id="l2.500">       // Whitespace-only tokens get squashed into nothing, so 2047 tokens will</span>
<a href="#l2.501"></a><span id="l2.501">       // be concatenated together.</span>
<a href="#l2.502"></a><span id="l2.502" class="difflineminus">-      components[i] = '';</span>
<a href="#l2.503"></a><span id="l2.503" class="difflineplus">+      components[i] = &quot;&quot;;</span>
<a href="#l2.504"></a><span id="l2.504">       continue;</span>
<a href="#l2.505"></a><span id="l2.505">     }</span>
<a href="#l2.506"></a><span id="l2.506"> </span>
<a href="#l2.507"></a><span id="l2.507">     // If there was stuff left over from decoding the last 2047 token, flush it</span>
<a href="#l2.508"></a><span id="l2.508">     // out.</span>
<a href="#l2.509"></a><span id="l2.509" class="difflineminus">-    lastCharset = '';</span>
<a href="#l2.510"></a><span id="l2.510" class="difflineplus">+    lastCharset = &quot;&quot;;</span>
<a href="#l2.511"></a><span id="l2.511">     if (currentDecoder) {</span>
<a href="#l2.512"></a><span id="l2.512">       components[i] = currentDecoder.decode() + components[i];</span>
<a href="#l2.513"></a><span id="l2.513">       currentDecoder = null;</span>
<a href="#l2.514"></a><span id="l2.514">     }</span>
<a href="#l2.515"></a><span id="l2.515">   }</span>
<a href="#l2.516"></a><span id="l2.516"> </span>
<a href="#l2.517"></a><span id="l2.517">   // After the for loop, we'll have a set of decoded strings. Concatenate them</span>
<a href="#l2.518"></a><span id="l2.518">   // together to make the return value.</span>
<a href="#l2.519"></a><span id="l2.519" class="difflineminus">-  return components.join('');</span>
<a href="#l2.520"></a><span id="l2.520" class="difflineplus">+  return components.join(&quot;&quot;);</span>
<a href="#l2.521"></a><span id="l2.521"> }</span>
<a href="#l2.522"></a><span id="l2.522"> </span>
<a href="#l2.523"></a><span id="l2.523" class="difflineminus">-///////////////////////////////</span>
<a href="#l2.524"></a><span id="l2.524" class="difflineminus">-// Structured field decoders //</span>
<a href="#l2.525"></a><span id="l2.525" class="difflineminus">-///////////////////////////////</span>
<a href="#l2.526"></a><span id="l2.526" class="difflineplus">+// Structured field decoders</span>
<a href="#l2.527"></a><span id="l2.527" class="difflineplus">+// -------------------------</span>
<a href="#l2.528"></a><span id="l2.528"> </span>
<a href="#l2.529"></a><span id="l2.529"> /**</span>
<a href="#l2.530"></a><span id="l2.530">  * Extract a list of addresses from a header which matches the RFC 5322</span>
<a href="#l2.531"></a><span id="l2.531">  * address-list production, possibly doing RFC 2047 decoding along the way.</span>
<a href="#l2.532"></a><span id="l2.532">  *</span>
<a href="#l2.533"></a><span id="l2.533">  * The output of this method is an array of elements corresponding to the</span>
<a href="#l2.534"></a><span id="l2.534">  * addresses and the groups in the input header. An address is represented by</span>
<a href="#l2.535"></a><span id="l2.535">  * an object of the form:</span>
<a href="#l2.536"></a><span id="l2.536" class="difflineat">@@ -774,17 +776,17 @@ function parseAddressingHeader(header, d</span>
<a href="#l2.537"></a><span id="l2.537">     doRFC2047 = true;</span>
<a href="#l2.538"></a><span id="l2.538"> </span>
<a href="#l2.539"></a><span id="l2.539">   // The final (top-level) results list to append to.</span>
<a href="#l2.540"></a><span id="l2.540">   let results = [];</span>
<a href="#l2.541"></a><span id="l2.541">   // Temporary results</span>
<a href="#l2.542"></a><span id="l2.542">   let addrlist = [];</span>
<a href="#l2.543"></a><span id="l2.543"> </span>
<a href="#l2.544"></a><span id="l2.544">   // Build up all of the values</span>
<a href="#l2.545"></a><span id="l2.545" class="difflineminus">-  let name = '', groupName = '', localPart = '', address = '', comment = '';</span>
<a href="#l2.546"></a><span id="l2.546" class="difflineplus">+  let name = &quot;&quot;, groupName = &quot;&quot;, localPart = &quot;&quot;, address = &quot;&quot;, comment = &quot;&quot;;</span>
<a href="#l2.547"></a><span id="l2.547">   // Indicators of current state</span>
<a href="#l2.548"></a><span id="l2.548">   let inAngle = false, inComment = false, needsSpace = false;</span>
<a href="#l2.549"></a><span id="l2.549">   let preserveSpace = false;</span>
<a href="#l2.550"></a><span id="l2.550">   let commentClosed = false;</span>
<a href="#l2.551"></a><span id="l2.551"> </span>
<a href="#l2.552"></a><span id="l2.552">   // RFC 5322 §3.4 notes that legacy implementations exist which use a simple</span>
<a href="#l2.553"></a><span id="l2.553">   // recipient form where the addr-spec appears without the angle brackets,</span>
<a href="#l2.554"></a><span id="l2.554">   // but includes the name of the recipient in parentheses as a comment</span>
<a href="#l2.555"></a><span id="l2.555" class="difflineat">@@ -799,17 +801,17 @@ function parseAddressingHeader(header, d</span>
<a href="#l2.556"></a><span id="l2.556">   // If the display-name is empty while the last comment is not, we assume it's</span>
<a href="#l2.557"></a><span id="l2.557">   // the legacy form above and take the comment content as the display-name.</span>
<a href="#l2.558"></a><span id="l2.558">   //</span>
<a href="#l2.559"></a><span id="l2.559">   // When parsing the address field, we at first do not know whether any</span>
<a href="#l2.560"></a><span id="l2.560">   // strings belong to the display-name (which may include comments) or to the</span>
<a href="#l2.561"></a><span id="l2.561">   // local-part of an addr-spec (where we ignore comments) until we find an</span>
<a href="#l2.562"></a><span id="l2.562">   // '@' or an '&lt;' token. Thus, we collect both variants until the fog lifts,</span>
<a href="#l2.563"></a><span id="l2.563">   // plus the last comment seen.</span>
<a href="#l2.564"></a><span id="l2.564" class="difflineminus">-  let lastComment = '';</span>
<a href="#l2.565"></a><span id="l2.565" class="difflineplus">+  let lastComment = &quot;&quot;;</span>
<a href="#l2.566"></a><span id="l2.566"> </span>
<a href="#l2.567"></a><span id="l2.567">   /**</span>
<a href="#l2.568"></a><span id="l2.568">    * Add the parsed mailbox object to the address list.</span>
<a href="#l2.569"></a><span id="l2.569">    * If it's in the legacy form above, correct the display-name.</span>
<a href="#l2.570"></a><span id="l2.570">    * Also reset any faked flags.</span>
<a href="#l2.571"></a><span id="l2.571">    * @param {String} displayName   display-name as per RFC 5322</span>
<a href="#l2.572"></a><span id="l2.572">    * @param {String} addrSpec      addr-spec as per RFC 5322</span>
<a href="#l2.573"></a><span id="l2.573">    */</span>
<a href="#l2.574"></a><span id="l2.574" class="difflineat">@@ -819,121 +821,121 @@ function parseAddressingHeader(header, d</span>
<a href="#l2.575"></a><span id="l2.575">     if (/[ !()&lt;&gt;\[\]:;@\\,&quot;]/.exec(lp) !== null) {</span>
<a href="#l2.576"></a><span id="l2.576">       addrSpec = '&quot;' + lp.replace(/([\\&quot;])/g, &quot;\\$1&quot;) + '&quot;' +</span>
<a href="#l2.577"></a><span id="l2.577">                  addrSpec.substring(addrSpec.lastIndexOf(&quot;@&quot;));</span>
<a href="#l2.578"></a><span id="l2.578">     }</span>
<a href="#l2.579"></a><span id="l2.579"> </span>
<a href="#l2.580"></a><span id="l2.580">     // Replace consecutive whitespace in the name with a single whitespace.</span>
<a href="#l2.581"></a><span id="l2.581">     displayName = displayName.replace(/\s\s+/g, &quot; &quot;);</span>
<a href="#l2.582"></a><span id="l2.582"> </span>
<a href="#l2.583"></a><span id="l2.583" class="difflineminus">-    if (displayName === '' &amp;&amp; lastComment !== '') {</span>
<a href="#l2.584"></a><span id="l2.584" class="difflineplus">+    if (displayName === &quot;&quot; &amp;&amp; lastComment !== &quot;&quot;) {</span>
<a href="#l2.585"></a><span id="l2.585">       // Take last comment content as the display-name.</span>
<a href="#l2.586"></a><span id="l2.586" class="difflineminus">-      let offset = lastComment[0] === ' ' ? 2 : 1;</span>
<a href="#l2.587"></a><span id="l2.587" class="difflineplus">+      let offset = lastComment[0] === &quot; &quot; ? 2 : 1;</span>
<a href="#l2.588"></a><span id="l2.588">       displayName = lastComment.substr(offset, lastComment.length - offset - 1);</span>
<a href="#l2.589"></a><span id="l2.589">     }</span>
<a href="#l2.590"></a><span id="l2.590" class="difflineminus">-    if (displayName !== '' || addrSpec !== '') {</span>
<a href="#l2.591"></a><span id="l2.591" class="difflineplus">+    if (displayName !== &quot;&quot; || addrSpec !== &quot;&quot;) {</span>
<a href="#l2.592"></a><span id="l2.592">       addrlist.push({name: displayName, email: addrSpec});</span>
<a href="#l2.593"></a><span id="l2.593">     }</span>
<a href="#l2.594"></a><span id="l2.594">     // Clear pending flags and variables.</span>
<a href="#l2.595"></a><span id="l2.595" class="difflineminus">-    name = localPart = address = lastComment = '';</span>
<a href="#l2.596"></a><span id="l2.596" class="difflineplus">+    name = localPart = address = lastComment = &quot;&quot;;</span>
<a href="#l2.597"></a><span id="l2.597">     inAngle = inComment = needsSpace = false;</span>
<a href="#l2.598"></a><span id="l2.598">   }</span>
<a href="#l2.599"></a><span id="l2.599"> </span>
<a href="#l2.600"></a><span id="l2.600">   // Main parsing loop</span>
<a href="#l2.601"></a><span id="l2.601">   for (let token of getHeaderTokens(header, &quot;:,;&lt;&gt;@&quot;,</span>
<a href="#l2.602"></a><span id="l2.602">         {qstring: true, comments: true, dliteral: true, rfc2047: doRFC2047})) {</span>
<a href="#l2.603"></a><span id="l2.603" class="difflineminus">-    if (token === ':') {</span>
<a href="#l2.604"></a><span id="l2.604" class="difflineplus">+    if (token === &quot;:&quot;) {</span>
<a href="#l2.605"></a><span id="l2.605">       groupName = name;</span>
<a href="#l2.606"></a><span id="l2.606" class="difflineminus">-      name = '';</span>
<a href="#l2.607"></a><span id="l2.607" class="difflineminus">-      localPart = '';</span>
<a href="#l2.608"></a><span id="l2.608" class="difflineplus">+      name = &quot;&quot;;</span>
<a href="#l2.609"></a><span id="l2.609" class="difflineplus">+      localPart = &quot;&quot;;</span>
<a href="#l2.610"></a><span id="l2.610">       // If we had prior email address results, commit them to the top-level.</span>
<a href="#l2.611"></a><span id="l2.611">       if (addrlist.length &gt; 0)</span>
<a href="#l2.612"></a><span id="l2.612">         results = results.concat(addrlist);</span>
<a href="#l2.613"></a><span id="l2.613">       addrlist = [];</span>
<a href="#l2.614"></a><span id="l2.614" class="difflineminus">-    } else if (token === '&lt;') {</span>
<a href="#l2.615"></a><span id="l2.615" class="difflineplus">+    } else if (token === &quot;&lt;&quot;) {</span>
<a href="#l2.616"></a><span id="l2.616">       if (inAngle) {</span>
<a href="#l2.617"></a><span id="l2.617">         // Interpret the address we were parsing as a name.</span>
<a href="#l2.618"></a><span id="l2.618">         if (address.length &gt; 0) {</span>
<a href="#l2.619"></a><span id="l2.619">           name = address;</span>
<a href="#l2.620"></a><span id="l2.620">         }</span>
<a href="#l2.621"></a><span id="l2.621" class="difflineminus">-        localPart = address = '';</span>
<a href="#l2.622"></a><span id="l2.622" class="difflineplus">+        localPart = address = &quot;&quot;;</span>
<a href="#l2.623"></a><span id="l2.623">       } else {</span>
<a href="#l2.624"></a><span id="l2.624">         inAngle = true;</span>
<a href="#l2.625"></a><span id="l2.625">       }</span>
<a href="#l2.626"></a><span id="l2.626" class="difflineminus">-    } else if (token === '&gt;') {</span>
<a href="#l2.627"></a><span id="l2.627" class="difflineplus">+    } else if (token === &quot;&gt;&quot;) {</span>
<a href="#l2.628"></a><span id="l2.628">       inAngle = false;</span>
<a href="#l2.629"></a><span id="l2.629">       // Forget addr-spec comments.</span>
<a href="#l2.630"></a><span id="l2.630" class="difflineminus">-      lastComment = '';</span>
<a href="#l2.631"></a><span id="l2.631" class="difflineminus">-    } else if (token === '(') {</span>
<a href="#l2.632"></a><span id="l2.632" class="difflineplus">+      lastComment = &quot;&quot;;</span>
<a href="#l2.633"></a><span id="l2.633" class="difflineplus">+    } else if (token === &quot;(&quot;) {</span>
<a href="#l2.634"></a><span id="l2.634">       inComment = true;</span>
<a href="#l2.635"></a><span id="l2.635">       // The needsSpace flag may not always be set even if it should be,</span>
<a href="#l2.636"></a><span id="l2.636">       // e.g. for a comment behind an angle-addr.</span>
<a href="#l2.637"></a><span id="l2.637">       // Also, we need to restore the needsSpace flag if we ignore the comment.</span>
<a href="#l2.638"></a><span id="l2.638">       preserveSpace = needsSpace;</span>
<a href="#l2.639"></a><span id="l2.639">       if (!needsSpace)</span>
<a href="#l2.640"></a><span id="l2.640" class="difflineminus">-        needsSpace = name !== '' &amp;&amp; name.substr(-1) !== ' ';</span>
<a href="#l2.641"></a><span id="l2.641" class="difflineminus">-      comment = needsSpace ? ' (' : '(';</span>
<a href="#l2.642"></a><span id="l2.642" class="difflineplus">+        needsSpace = name !== &quot;&quot; &amp;&amp; name.substr(-1) !== &quot; &quot;;</span>
<a href="#l2.643"></a><span id="l2.643" class="difflineplus">+      comment = needsSpace ? &quot; (&quot; : &quot;(&quot;;</span>
<a href="#l2.644"></a><span id="l2.644">       commentClosed = false;</span>
<a href="#l2.645"></a><span id="l2.645" class="difflineminus">-    } else if (token === ')') {</span>
<a href="#l2.646"></a><span id="l2.646" class="difflineplus">+    } else if (token === &quot;)&quot;) {</span>
<a href="#l2.647"></a><span id="l2.647">       inComment = false;</span>
<a href="#l2.648"></a><span id="l2.648" class="difflineminus">-      comment += ')';</span>
<a href="#l2.649"></a><span id="l2.649" class="difflineplus">+      comment += &quot;)&quot;;</span>
<a href="#l2.650"></a><span id="l2.650">       lastComment = comment;</span>
<a href="#l2.651"></a><span id="l2.651">       // The comment may be part of the name, but not of the local-part.</span>
<a href="#l2.652"></a><span id="l2.652">       // Enforce a space behind the comment only when not ignoring it.</span>
<a href="#l2.653"></a><span id="l2.653">       if (inAngle) {</span>
<a href="#l2.654"></a><span id="l2.654">         needsSpace = preserveSpace;</span>
<a href="#l2.655"></a><span id="l2.655">       } else {</span>
<a href="#l2.656"></a><span id="l2.656">         name += comment;</span>
<a href="#l2.657"></a><span id="l2.657">         needsSpace = true;</span>
<a href="#l2.658"></a><span id="l2.658">       }</span>
<a href="#l2.659"></a><span id="l2.659">       commentClosed = true;</span>
<a href="#l2.660"></a><span id="l2.660">       continue;</span>
<a href="#l2.661"></a><span id="l2.661" class="difflineminus">-    } else if (token === '@') {</span>
<a href="#l2.662"></a><span id="l2.662" class="difflineplus">+    } else if (token === &quot;@&quot;) {</span>
<a href="#l2.663"></a><span id="l2.663">       // An @ means we see an email address. If we're not within &lt;&gt; brackets,</span>
<a href="#l2.664"></a><span id="l2.664">       // then we just parsed an email address instead of a display name. Empty</span>
<a href="#l2.665"></a><span id="l2.665">       // out the display name for the current production.</span>
<a href="#l2.666"></a><span id="l2.666">       if (!inAngle) {</span>
<a href="#l2.667"></a><span id="l2.667">         address = localPart;</span>
<a href="#l2.668"></a><span id="l2.668" class="difflineminus">-        name = '';</span>
<a href="#l2.669"></a><span id="l2.669" class="difflineminus">-        localPart = '';</span>
<a href="#l2.670"></a><span id="l2.670" class="difflineplus">+        name = &quot;&quot;;</span>
<a href="#l2.671"></a><span id="l2.671" class="difflineplus">+        localPart = &quot;&quot;;</span>
<a href="#l2.672"></a><span id="l2.672">         // The remainder of this mailbox is part of an addr-spec.</span>
<a href="#l2.673"></a><span id="l2.673">         inAngle = true;</span>
<a href="#l2.674"></a><span id="l2.674">       }</span>
<a href="#l2.675"></a><span id="l2.675" class="difflineminus">-      address += '@';</span>
<a href="#l2.676"></a><span id="l2.676" class="difflineminus">-    } else if (token === ',') {</span>
<a href="#l2.677"></a><span id="l2.677" class="difflineplus">+      address += &quot;@&quot;;</span>
<a href="#l2.678"></a><span id="l2.678" class="difflineplus">+    } else if (token === &quot;,&quot;) {</span>
<a href="#l2.679"></a><span id="l2.679">       // A comma ends the current name. If we have something that's kind of a</span>
<a href="#l2.680"></a><span id="l2.680">       // name, add it to the result list. If we don't, then our input looks like</span>
<a href="#l2.681"></a><span id="l2.681">       // To: , , -&gt; don't bother adding an empty entry.</span>
<a href="#l2.682"></a><span id="l2.682">       addToAddrList(name, address);</span>
<a href="#l2.683"></a><span id="l2.683" class="difflineminus">-    } else if (token === ';') {</span>
<a href="#l2.684"></a><span id="l2.684" class="difflineplus">+    } else if (token === &quot;;&quot;) {</span>
<a href="#l2.685"></a><span id="l2.685">       // Add pending name to the list</span>
<a href="#l2.686"></a><span id="l2.686">       addToAddrList(name, address);</span>
<a href="#l2.687"></a><span id="l2.687"> </span>
<a href="#l2.688"></a><span id="l2.688">       // If no group name was found, treat the ';' as a ','. In any case, we</span>
<a href="#l2.689"></a><span id="l2.689">       // need to copy the results of addrlist into either a new group object or</span>
<a href="#l2.690"></a><span id="l2.690">       // the main list.</span>
<a href="#l2.691"></a><span id="l2.691" class="difflineminus">-      if (groupName === '') {</span>
<a href="#l2.692"></a><span id="l2.692" class="difflineplus">+      if (groupName === &quot;&quot;) {</span>
<a href="#l2.693"></a><span id="l2.693">         results = results.concat(addrlist);</span>
<a href="#l2.694"></a><span id="l2.694">       } else {</span>
<a href="#l2.695"></a><span id="l2.695">         results.push({</span>
<a href="#l2.696"></a><span id="l2.696">           name: groupName,</span>
<a href="#l2.697"></a><span id="l2.697" class="difflineminus">-          group: addrlist</span>
<a href="#l2.698"></a><span id="l2.698" class="difflineplus">+          group: addrlist,</span>
<a href="#l2.699"></a><span id="l2.699">         });</span>
<a href="#l2.700"></a><span id="l2.700">       }</span>
<a href="#l2.701"></a><span id="l2.701">       // ... and reset every other variable.</span>
<a href="#l2.702"></a><span id="l2.702">       addrlist = [];</span>
<a href="#l2.703"></a><span id="l2.703" class="difflineminus">-      groupName = '';</span>
<a href="#l2.704"></a><span id="l2.704" class="difflineplus">+      groupName = &quot;&quot;;</span>
<a href="#l2.705"></a><span id="l2.705">     } else {</span>
<a href="#l2.706"></a><span id="l2.706">       // This is either comment content, a quoted-string, or some span of</span>
<a href="#l2.707"></a><span id="l2.707">       // dots and atoms.</span>
<a href="#l2.708"></a><span id="l2.708"> </span>
<a href="#l2.709"></a><span id="l2.709">       // Ignore the needs space if we're a &quot;close&quot; delimiter token.</span>
<a href="#l2.710"></a><span id="l2.710">       let spacedToken = token;</span>
<a href="#l2.711"></a><span id="l2.711" class="difflineminus">-      if (needsSpace &amp;&amp; token.toString()[0] != '.')</span>
<a href="#l2.712"></a><span id="l2.712" class="difflineminus">-        spacedToken = ' ' + spacedToken;</span>
<a href="#l2.713"></a><span id="l2.713" class="difflineplus">+      if (needsSpace &amp;&amp; token.toString()[0] != &quot;.&quot;)</span>
<a href="#l2.714"></a><span id="l2.714" class="difflineplus">+        spacedToken = &quot; &quot; + spacedToken;</span>
<a href="#l2.715"></a><span id="l2.715"> </span>
<a href="#l2.716"></a><span id="l2.716">       // Which field do we add this data to?</span>
<a href="#l2.717"></a><span id="l2.717">       if (inComment) {</span>
<a href="#l2.718"></a><span id="l2.718">         comment += spacedToken;</span>
<a href="#l2.719"></a><span id="l2.719">       } else if (inAngle) {</span>
<a href="#l2.720"></a><span id="l2.720">         address += spacedToken;</span>
<a href="#l2.721"></a><span id="l2.721">       } else {</span>
<a href="#l2.722"></a><span id="l2.722">         name += spacedToken;</span>
<a href="#l2.723"></a><span id="l2.723" class="difflineat">@@ -943,31 +945,31 @@ function parseAddressingHeader(header, d</span>
<a href="#l2.724"></a><span id="l2.724">           commentClosed = false;</span>
<a href="#l2.725"></a><span id="l2.725">         } else {</span>
<a href="#l2.726"></a><span id="l2.726">           localPart += spacedToken;</span>
<a href="#l2.727"></a><span id="l2.727">         }</span>
<a href="#l2.728"></a><span id="l2.728">       }</span>
<a href="#l2.729"></a><span id="l2.729"> </span>
<a href="#l2.730"></a><span id="l2.730">       // We need space for the next token if we aren't some kind of comment or</span>
<a href="#l2.731"></a><span id="l2.731">       // . delimiter.</span>
<a href="#l2.732"></a><span id="l2.732" class="difflineminus">-      needsSpace = (token.toString().length &gt; 0) &amp;&amp; (token.toString()[0] != '.');</span>
<a href="#l2.733"></a><span id="l2.733" class="difflineplus">+      needsSpace = (token.toString().length &gt; 0) &amp;&amp; (token.toString()[0] != &quot;.&quot;);</span>
<a href="#l2.734"></a><span id="l2.734">       // The fall-through case after this resets needsSpace to false, and we</span>
<a href="#l2.735"></a><span id="l2.735">       // don't want that!</span>
<a href="#l2.736"></a><span id="l2.736">       continue;</span>
<a href="#l2.737"></a><span id="l2.737">     }</span>
<a href="#l2.738"></a><span id="l2.738"> </span>
<a href="#l2.739"></a><span id="l2.739">     // If we just parsed a delimiter, we don't need any space for the next</span>
<a href="#l2.740"></a><span id="l2.740">     // token.</span>
<a href="#l2.741"></a><span id="l2.741">     needsSpace = false;</span>
<a href="#l2.742"></a><span id="l2.742">   }</span>
<a href="#l2.743"></a><span id="l2.743"> </span>
<a href="#l2.744"></a><span id="l2.744">   // If we're missing the final ';' of a group, assume it was present. Also, add</span>
<a href="#l2.745"></a><span id="l2.745">   // in the details of any email/address that we previously saw.</span>
<a href="#l2.746"></a><span id="l2.746">   addToAddrList(name, address);</span>
<a href="#l2.747"></a><span id="l2.747" class="difflineminus">-  if (groupName !== '') {</span>
<a href="#l2.748"></a><span id="l2.748" class="difflineplus">+  if (groupName !== &quot;&quot;) {</span>
<a href="#l2.749"></a><span id="l2.749">     results.push({name: groupName, group: addrlist});</span>
<a href="#l2.750"></a><span id="l2.750">     addrlist = [];</span>
<a href="#l2.751"></a><span id="l2.751">   }</span>
<a href="#l2.752"></a><span id="l2.752"> </span>
<a href="#l2.753"></a><span id="l2.753">   // Add the current address list build-up to the list of addresses, and return</span>
<a href="#l2.754"></a><span id="l2.754">   // the whole array to the caller.</span>
<a href="#l2.755"></a><span id="l2.755">   return results.concat(addrlist);</span>
<a href="#l2.756"></a><span id="l2.756"> }</span>
<a href="#l2.757"></a><span id="l2.757" class="difflineat">@@ -978,74 +980,75 @@ function parseAddressingHeader(header, d</span>
<a href="#l2.758"></a><span id="l2.758">  *</span>
<a href="#l2.759"></a><span id="l2.759">  * @param {String} headerValue The MIME header value to parse.</span>
<a href="#l2.760"></a><span id="l2.760">  * @param {Boolean} doRFC2047  If true, decode RFC 2047 encoded-words.</span>
<a href="#l2.761"></a><span id="l2.761">  * @param {Boolean} doRFC2231  If true, decode RFC 2231 encoded parameters.</span>
<a href="#l2.762"></a><span id="l2.762">  * @return {Map(String -&gt; String)} A map of parameter names to parameter values.</span>
<a href="#l2.763"></a><span id="l2.763">  *                                 The property preSemi is set to the token that</span>
<a href="#l2.764"></a><span id="l2.764">  *                                 precedes the first semicolon.</span>
<a href="#l2.765"></a><span id="l2.765">  */</span>
<a href="#l2.766"></a><span id="l2.766" class="difflineplus">+/* eslint-disable complexity */</span>
<a href="#l2.767"></a><span id="l2.767"> function parseParameterHeader(headerValue, doRFC2047, doRFC2231) {</span>
<a href="#l2.768"></a><span id="l2.768">   // The basic syntax of headerValue is token [; token = token-or-qstring]*</span>
<a href="#l2.769"></a><span id="l2.769">   // Copying more or less liberally from nsMIMEHeaderParamImpl:</span>
<a href="#l2.770"></a><span id="l2.770">   // The first token is the text to the first whitespace or semicolon.</span>
<a href="#l2.771"></a><span id="l2.771">   var semi = headerValue.indexOf(&quot;;&quot;);</span>
<a href="#l2.772"></a><span id="l2.772" class="difflineplus">+  let start, rest;</span>
<a href="#l2.773"></a><span id="l2.773">   if (semi &lt; 0) {</span>
<a href="#l2.774"></a><span id="l2.774" class="difflineminus">-    var start = headerValue;</span>
<a href="#l2.775"></a><span id="l2.775" class="difflineminus">-    var rest = '';</span>
<a href="#l2.776"></a><span id="l2.776" class="difflineplus">+    start = headerValue;</span>
<a href="#l2.777"></a><span id="l2.777" class="difflineplus">+    rest = &quot;&quot;;</span>
<a href="#l2.778"></a><span id="l2.778">   } else {</span>
<a href="#l2.779"></a><span id="l2.779" class="difflineminus">-    var start = headerValue.substring(0, semi);</span>
<a href="#l2.780"></a><span id="l2.780" class="difflineminus">-    var rest = headerValue.substring(semi); // Include the semicolon</span>
<a href="#l2.781"></a><span id="l2.781" class="difflineplus">+    start = headerValue.substring(0, semi);</span>
<a href="#l2.782"></a><span id="l2.782" class="difflineplus">+    rest = headerValue.substring(semi); // Include the semicolon</span>
<a href="#l2.783"></a><span id="l2.783">   }</span>
<a href="#l2.784"></a><span id="l2.784">   // Strip start to be &lt;WSP&gt;&lt;nowsp&gt;&lt;WSP&gt;.</span>
<a href="#l2.785"></a><span id="l2.785">   start = start.trim().split(/[ \t\r\n]/)[0];</span>
<a href="#l2.786"></a><span id="l2.786"> </span>
<a href="#l2.787"></a><span id="l2.787">   // Decode the the parameter tokens.</span>
<a href="#l2.788"></a><span id="l2.788">   let opts = {qstring: true, rfc2047: doRFC2047};</span>
<a href="#l2.789"></a><span id="l2.789">   // Name is the name of the parameter, inName is true iff we don't have a name</span>
<a href="#l2.790"></a><span id="l2.790">   // yet.</span>
<a href="#l2.791"></a><span id="l2.791" class="difflineminus">-  let name = '', inName = true;</span>
<a href="#l2.792"></a><span id="l2.792" class="difflineplus">+  let name = &quot;&quot;, inName = true;</span>
<a href="#l2.793"></a><span id="l2.793">   // Matches is a list of [name, value] pairs, where we found something that</span>
<a href="#l2.794"></a><span id="l2.794">   // looks like name=value in the input string.</span>
<a href="#l2.795"></a><span id="l2.795">   let matches = [];</span>
<a href="#l2.796"></a><span id="l2.796">   for (let token of getHeaderTokens(rest, &quot;;=&quot;, opts)) {</span>
<a href="#l2.797"></a><span id="l2.797" class="difflineminus">-    if (token === ';') {</span>
<a href="#l2.798"></a><span id="l2.798" class="difflineplus">+    if (token === &quot;;&quot;) {</span>
<a href="#l2.799"></a><span id="l2.799">       // If we didn't find a name yet (we have ... tokenA; tokenB), push the</span>
<a href="#l2.800"></a><span id="l2.800">       // name with an empty token instead.</span>
<a href="#l2.801"></a><span id="l2.801" class="difflineminus">-      if (name != '' &amp;&amp; inName == false)</span>
<a href="#l2.802"></a><span id="l2.802" class="difflineminus">-        matches.push([name, '']);</span>
<a href="#l2.803"></a><span id="l2.803" class="difflineminus">-      name = '';</span>
<a href="#l2.804"></a><span id="l2.804" class="difflineplus">+      if (name != &quot;&quot; &amp;&amp; !inName)</span>
<a href="#l2.805"></a><span id="l2.805" class="difflineplus">+        matches.push([name, &quot;&quot;]);</span>
<a href="#l2.806"></a><span id="l2.806" class="difflineplus">+      name = &quot;&quot;;</span>
<a href="#l2.807"></a><span id="l2.807">       inName = true;</span>
<a href="#l2.808"></a><span id="l2.808" class="difflineminus">-    } else if (token === '=') {</span>
<a href="#l2.809"></a><span id="l2.809" class="difflineplus">+    } else if (token === &quot;=&quot;) {</span>
<a href="#l2.810"></a><span id="l2.810">       inName = false;</span>
<a href="#l2.811"></a><span id="l2.811" class="difflineminus">-    } else if (inName &amp;&amp; name == '') {</span>
<a href="#l2.812"></a><span id="l2.812" class="difflineplus">+    } else if (inName &amp;&amp; name == &quot;&quot;) {</span>
<a href="#l2.813"></a><span id="l2.813">       name = token.toString();</span>
<a href="#l2.814"></a><span id="l2.814" class="difflineminus">-    } else if (!inName &amp;&amp; name != '') {</span>
<a href="#l2.815"></a><span id="l2.815" class="difflineplus">+    } else if (!inName &amp;&amp; name != &quot;&quot;) {</span>
<a href="#l2.816"></a><span id="l2.816">       token = token.toString();</span>
<a href="#l2.817"></a><span id="l2.817">       // RFC 2231 doesn't make it clear if %-encoding is supposed to happen</span>
<a href="#l2.818"></a><span id="l2.818">       // within a quoted string, but this is very much required in practice. If</span>
<a href="#l2.819"></a><span id="l2.819">       // it ends with a '*', then the string is an extended-value, which means</span>
<a href="#l2.820"></a><span id="l2.820">       // that its value may be %-encoded.</span>
<a href="#l2.821"></a><span id="l2.821" class="difflineminus">-      if (doRFC2231 &amp;&amp; name.endsWith('*')) {</span>
<a href="#l2.822"></a><span id="l2.822" class="difflineminus">-        token = token.replace(/%([0-9A-Fa-f]{2})/g,</span>
<a href="#l2.823"></a><span id="l2.823" class="difflineminus">-          function percent_deencode(match, hexchars) {</span>
<a href="#l2.824"></a><span id="l2.824" class="difflineminus">-            return String.fromCharCode(parseInt(hexchars, 16));</span>
<a href="#l2.825"></a><span id="l2.825" class="difflineplus">+      if (doRFC2231 &amp;&amp; name.endsWith(&quot;*&quot;)) {</span>
<a href="#l2.826"></a><span id="l2.826" class="difflineplus">+        token = token.replace(/%([0-9A-Fa-f]{2})/g, function(match, hexchars) {</span>
<a href="#l2.827"></a><span id="l2.827" class="difflineplus">+          return String.fromCharCode(parseInt(hexchars, 16));</span>
<a href="#l2.828"></a><span id="l2.828">         });</span>
<a href="#l2.829"></a><span id="l2.829">       }</span>
<a href="#l2.830"></a><span id="l2.830">       matches.push([name, token]);</span>
<a href="#l2.831"></a><span id="l2.831">       // Clear the name, so we ignore anything afterwards.</span>
<a href="#l2.832"></a><span id="l2.832" class="difflineminus">-      name = '';</span>
<a href="#l2.833"></a><span id="l2.833" class="difflineplus">+      name = &quot;&quot;;</span>
<a href="#l2.834"></a><span id="l2.834">     } else if (inName) {</span>
<a href="#l2.835"></a><span id="l2.835">       // We have ...; tokenA tokenB ... -&gt; ignore both tokens</span>
<a href="#l2.836"></a><span id="l2.836" class="difflineminus">-      name = ''; // Error recovery, ignore this one</span>
<a href="#l2.837"></a><span id="l2.837" class="difflineplus">+      name = &quot;&quot;; // Error recovery, ignore this one</span>
<a href="#l2.838"></a><span id="l2.838">     }</span>
<a href="#l2.839"></a><span id="l2.839">   }</span>
<a href="#l2.840"></a><span id="l2.840">   // If we have a leftover ...; tokenA, push the tokenA</span>
<a href="#l2.841"></a><span id="l2.841" class="difflineminus">-  if (name != '' &amp;&amp; inName == false)</span>
<a href="#l2.842"></a><span id="l2.842" class="difflineminus">-    matches.push([name, '']);</span>
<a href="#l2.843"></a><span id="l2.843" class="difflineplus">+  if (name != &quot;&quot; &amp;&amp; !inName)</span>
<a href="#l2.844"></a><span id="l2.844" class="difflineplus">+    matches.push([name, &quot;&quot;]);</span>
<a href="#l2.845"></a><span id="l2.845"> </span>
<a href="#l2.846"></a><span id="l2.846">   // Now matches holds the parameters, so clean up for RFC 2231. There are three</span>
<a href="#l2.847"></a><span id="l2.847">   // cases: param=val, param*=us-ascii'en-US'blah, and param*n= variants. The</span>
<a href="#l2.848"></a><span id="l2.848">   // order of preference is to pick the middle, then the last, then the first.</span>
<a href="#l2.849"></a><span id="l2.849">   // Note that we already unpacked %-encoded values.</span>
<a href="#l2.850"></a><span id="l2.850"> </span>
<a href="#l2.851"></a><span id="l2.851">   // simpleValues is just a straight parameter -&gt; value map.</span>
<a href="#l2.852"></a><span id="l2.852">   // charsetValues is the parameter -&gt; value map, although values are stored</span>
<a href="#l2.853"></a><span id="l2.853" class="difflineat">@@ -1054,17 +1057,17 @@ function parseParameterHeader(headerValu</span>
<a href="#l2.854"></a><span id="l2.854">   // valid (if we decided we couldn't do anything anymore) and hasCharset (which</span>
<a href="#l2.855"></a><span id="l2.855">   // records if we need to decode the charset parameter or not).</span>
<a href="#l2.856"></a><span id="l2.856">   var simpleValues = new Map(), charsetValues = new Map(),</span>
<a href="#l2.857"></a><span id="l2.857">       continuationValues = new Map();</span>
<a href="#l2.858"></a><span id="l2.858">   for (let pair of matches) {</span>
<a href="#l2.859"></a><span id="l2.859">     let name = pair[0];</span>
<a href="#l2.860"></a><span id="l2.860">     let value = pair[1];</span>
<a href="#l2.861"></a><span id="l2.861">     // Get first index, not last index, so we match param*0*= like param*0=.</span>
<a href="#l2.862"></a><span id="l2.862" class="difflineminus">-    let star = name.indexOf('*');</span>
<a href="#l2.863"></a><span id="l2.863" class="difflineplus">+    let star = name.indexOf(&quot;*&quot;);</span>
<a href="#l2.864"></a><span id="l2.864">     if (star == -1) {</span>
<a href="#l2.865"></a><span id="l2.865">       // This is the case of param=val. Select the first value here, if there</span>
<a href="#l2.866"></a><span id="l2.866">       // are multiple ones.</span>
<a href="#l2.867"></a><span id="l2.867">       if (!simpleValues.has(name))</span>
<a href="#l2.868"></a><span id="l2.868">         simpleValues.set(name, value);</span>
<a href="#l2.869"></a><span id="l2.869">     } else if (star == name.length - 1) {</span>
<a href="#l2.870"></a><span id="l2.870">       // This is the case of param*=us-ascii'en-US'blah.</span>
<a href="#l2.871"></a><span id="l2.871">       name = name.substring(0, star);</span>
<a href="#l2.872"></a><span id="l2.872" class="difflineat">@@ -1077,32 +1080,30 @@ function parseParameterHeader(headerValu</span>
<a href="#l2.873"></a><span id="l2.873">       let entry = continuationValues.get(param);</span>
<a href="#l2.874"></a><span id="l2.874">       // Did we previously find this one to be bungled? Then ignore it.</span>
<a href="#l2.875"></a><span id="l2.875">       if (continuationValues.has(param) &amp;&amp; !entry.valid)</span>
<a href="#l2.876"></a><span id="l2.876">         continue;</span>
<a href="#l2.877"></a><span id="l2.877"> </span>
<a href="#l2.878"></a><span id="l2.878">       // If we haven't seen it yet, set up entry already. Note that entries are</span>
<a href="#l2.879"></a><span id="l2.879">       // not straight string values but rather [valid, hasCharset, param0, ... ]</span>
<a href="#l2.880"></a><span id="l2.880">       if (!continuationValues.has(param)) {</span>
<a href="#l2.881"></a><span id="l2.881" class="difflineminus">-        entry = new Array();</span>
<a href="#l2.882"></a><span id="l2.882" class="difflineplus">+        entry = [];</span>
<a href="#l2.883"></a><span id="l2.883">         entry.valid = true;</span>
<a href="#l2.884"></a><span id="l2.884">         entry.hasCharset = undefined;</span>
<a href="#l2.885"></a><span id="l2.885">         continuationValues.set(param, entry);</span>
<a href="#l2.886"></a><span id="l2.886">       }</span>
<a href="#l2.887"></a><span id="l2.887"> </span>
<a href="#l2.888"></a><span id="l2.888">       // When the string ends in *, we need to charset decoding.</span>
<a href="#l2.889"></a><span id="l2.889">       // Note that the star is only meaningful for the *0*= case.</span>
<a href="#l2.890"></a><span id="l2.890" class="difflineminus">-      let lastStar = name[name.length - 1] == '*';</span>
<a href="#l2.891"></a><span id="l2.891" class="difflineplus">+      let lastStar = name[name.length - 1] == &quot;*&quot;;</span>
<a href="#l2.892"></a><span id="l2.892">       let number = name.substring(star + 1, name.length - (lastStar ? 1 : 0));</span>
<a href="#l2.893"></a><span id="l2.893" class="difflineminus">-      if (number == '0')</span>
<a href="#l2.894"></a><span id="l2.894" class="difflineplus">+      if (number == &quot;0&quot;) {</span>
<a href="#l2.895"></a><span id="l2.895">         entry.hasCharset = lastStar;</span>
<a href="#l2.896"></a><span id="l2.896" class="difflineminus">-</span>
<a href="#l2.897"></a><span id="l2.897" class="difflineminus">-      // Is the continuation number illegal?</span>
<a href="#l2.898"></a><span id="l2.898" class="difflineminus">-      else if (number.length == 0 || (number[0] == '0' &amp;&amp; number != '0') ||</span>
<a href="#l2.899"></a><span id="l2.899" class="difflineminus">-          !(/^[0-9]+$/.test(number))) {</span>
<a href="#l2.900"></a><span id="l2.900" class="difflineplus">+      } else if (number.length == 0 || (number[0] == &quot;0&quot; &amp;&amp; number != &quot;0&quot;) ||</span>
<a href="#l2.901"></a><span id="l2.901" class="difflineplus">+          !(/^[0-9]+$/.test(number))) { // Is the continuation number illegal?</span>
<a href="#l2.902"></a><span id="l2.902">         entry.valid = false;</span>
<a href="#l2.903"></a><span id="l2.903">         continue;</span>
<a href="#l2.904"></a><span id="l2.904">       }</span>
<a href="#l2.905"></a><span id="l2.905">       // Normalize to an integer</span>
<a href="#l2.906"></a><span id="l2.906">       number = parseInt(number, 10);</span>
<a href="#l2.907"></a><span id="l2.907"> </span>
<a href="#l2.908"></a><span id="l2.908">       // Is this a repeat? If so, bail.</span>
<a href="#l2.909"></a><span id="l2.909">       if (entry[number] !== undefined) {</span>
<a href="#l2.910"></a><span id="l2.910" class="difflineat">@@ -1137,17 +1138,17 @@ function parseParameterHeader(headerValu</span>
<a href="#l2.911"></a><span id="l2.911">       // entry, stop there.</span>
<a href="#l2.912"></a><span id="l2.912">       let valid = true;</span>
<a href="#l2.913"></a><span id="l2.913">       for (var i = 0; valid &amp;&amp; i &lt; entry.length; i++)</span>
<a href="#l2.914"></a><span id="l2.914">         if (entry[i] === undefined)</span>
<a href="#l2.915"></a><span id="l2.915">           valid = false;</span>
<a href="#l2.916"></a><span id="l2.916"> </span>
<a href="#l2.917"></a><span id="l2.917">       // Concatenate as many parameters as are valid. If we need to decode thec</span>
<a href="#l2.918"></a><span id="l2.918">       // charset, do so now.</span>
<a href="#l2.919"></a><span id="l2.919" class="difflineminus">-      let value = entry.slice(0, i).join('');</span>
<a href="#l2.920"></a><span id="l2.920" class="difflineplus">+      let value = entry.slice(0, i).join(&quot;&quot;);</span>
<a href="#l2.921"></a><span id="l2.921">       if (entry.hasCharset) {</span>
<a href="#l2.922"></a><span id="l2.922">         try {</span>
<a href="#l2.923"></a><span id="l2.923">           value = decode2231Value(value);</span>
<a href="#l2.924"></a><span id="l2.924">         } catch (e) {</span>
<a href="#l2.925"></a><span id="l2.925">           // Bad charset, don't add anything.</span>
<a href="#l2.926"></a><span id="l2.926">           continue;</span>
<a href="#l2.927"></a><span id="l2.927">         }</span>
<a href="#l2.928"></a><span id="l2.928">       }</span>
<a href="#l2.929"></a><span id="l2.929" class="difflineat">@@ -1164,32 +1165,33 @@ function parseParameterHeader(headerValu</span>
<a href="#l2.930"></a><span id="l2.930">       }</span>
<a href="#l2.931"></a><span id="l2.931">     }</span>
<a href="#l2.932"></a><span id="l2.932">   }</span>
<a href="#l2.933"></a><span id="l2.933"> </span>
<a href="#l2.934"></a><span id="l2.934">   // Finally, return the values computed above.</span>
<a href="#l2.935"></a><span id="l2.935">   values.preSemi = start;</span>
<a href="#l2.936"></a><span id="l2.936">   return values;</span>
<a href="#l2.937"></a><span id="l2.937"> }</span>
<a href="#l2.938"></a><span id="l2.938" class="difflineplus">+/* eslint-enable complexity */</span>
<a href="#l2.939"></a><span id="l2.939"> </span>
<a href="#l2.940"></a><span id="l2.940"> /**</span>
<a href="#l2.941"></a><span id="l2.941">  * Convert a RFC 2231-encoded string parameter into a Unicode version of the</span>
<a href="#l2.942"></a><span id="l2.942">  * string. This assumes that percent-decoding has already been applied.</span>
<a href="#l2.943"></a><span id="l2.943">  *</span>
<a href="#l2.944"></a><span id="l2.944">  * @param {String} value The RFC 2231-encoded string to decode.</span>
<a href="#l2.945"></a><span id="l2.945">  * @return The Unicode version of the string.</span>
<a href="#l2.946"></a><span id="l2.946">  */</span>
<a href="#l2.947"></a><span id="l2.947"> function decode2231Value(value) {</span>
<a href="#l2.948"></a><span id="l2.948">   let quote1 = value.indexOf(&quot;'&quot;);</span>
<a href="#l2.949"></a><span id="l2.949">   let quote2 = quote1 &gt;= 0 ? value.indexOf(&quot;'&quot;, quote1 + 1) : -1;</span>
<a href="#l2.950"></a><span id="l2.950"> </span>
<a href="#l2.951"></a><span id="l2.951">   let charset = (quote1 &gt;= 0 ? value.substring(0, quote1) : &quot;&quot;);</span>
<a href="#l2.952"></a><span id="l2.952">   // It turns out that the language isn't useful anywhere in our codebase for</span>
<a href="#l2.953"></a><span id="l2.953">   // the present time, so we will safely ignore it.</span>
<a href="#l2.954"></a><span id="l2.954" class="difflineminus">-  //var language = (quote2 &gt;= 0 ? value.substring(quote1 + 2, quote2) : &quot;&quot;);</span>
<a href="#l2.955"></a><span id="l2.955" class="difflineplus">+  // var language = (quote2 &gt;= 0 ? value.substring(quote1 + 2, quote2) : &quot;&quot;);</span>
<a href="#l2.956"></a><span id="l2.956">   value = value.substring(Math.max(quote1, quote2) + 1);</span>
<a href="#l2.957"></a><span id="l2.957"> </span>
<a href="#l2.958"></a><span id="l2.958">   // Convert the value into a typed array for decoding</span>
<a href="#l2.959"></a><span id="l2.959">   let typedarray = mimeutils.stringToTypedArray(value);</span>
<a href="#l2.960"></a><span id="l2.960"> </span>
<a href="#l2.961"></a><span id="l2.961">   // Decode the charset. If the charset isn't found, we throw an error. Try to</span>
<a href="#l2.962"></a><span id="l2.962">   // fallback in that case.</span>
<a href="#l2.963"></a><span id="l2.963">   return new MimeTextDecoder(charset, {fatal: true})</span>
<a href="#l2.964"></a><span id="l2.964" class="difflineat">@@ -1206,17 +1208,17 @@ var kKnownTZs = {</span>
<a href="#l2.965"></a><span id="l2.965">   &quot;MST&quot;: &quot;-0700&quot;, &quot;MDT&quot;: &quot;-0600&quot;,</span>
<a href="#l2.966"></a><span id="l2.966">   &quot;PST&quot;: &quot;-0800&quot;, &quot;PDT&quot;: &quot;-0700&quot;,</span>
<a href="#l2.967"></a><span id="l2.967">   // The following are time zones copied from NSPR's prtime.c</span>
<a href="#l2.968"></a><span id="l2.968">   &quot;AST&quot;: &quot;-0400&quot;, // Atlantic Standard Time</span>
<a href="#l2.969"></a><span id="l2.969">   &quot;NST&quot;: &quot;-0330&quot;, // Newfoundland Standard Time</span>
<a href="#l2.970"></a><span id="l2.970">   &quot;BST&quot;: &quot;+0100&quot;, // British Summer Time</span>
<a href="#l2.971"></a><span id="l2.971">   &quot;MET&quot;: &quot;+0100&quot;, // Middle Europe Time</span>
<a href="#l2.972"></a><span id="l2.972">   &quot;EET&quot;: &quot;+0200&quot;, // Eastern Europe Time</span>
<a href="#l2.973"></a><span id="l2.973" class="difflineminus">-  &quot;JST&quot;: &quot;+0900&quot;  // Japan Standard Time</span>
<a href="#l2.974"></a><span id="l2.974" class="difflineplus">+  &quot;JST&quot;: &quot;+0900&quot;, // Japan Standard Time</span>
<a href="#l2.975"></a><span id="l2.975"> };</span>
<a href="#l2.976"></a><span id="l2.976"> </span>
<a href="#l2.977"></a><span id="l2.977"> /**</span>
<a href="#l2.978"></a><span id="l2.978">  * Parse a header that contains a date-time definition according to RFC 5322.</span>
<a href="#l2.979"></a><span id="l2.979">  * The result is a JS date object with the same timestamp as the header.</span>
<a href="#l2.980"></a><span id="l2.980">  *</span>
<a href="#l2.981"></a><span id="l2.981">  * The dates returned by this parser cannot be reliably converted back into the</span>
<a href="#l2.982"></a><span id="l2.982">  * original header for two reasons. First, JS date objects cannot retain the</span>
<a href="#l2.983"></a><span id="l2.983" class="difflineat">@@ -1240,17 +1242,17 @@ var kKnownTZs = {</span>
<a href="#l2.984"></a><span id="l2.984"> function parseDateHeader(header) {</span>
<a href="#l2.985"></a><span id="l2.985">   let tokens = getHeaderTokens(header, &quot;,:&quot;, {}).map(x =&gt; x.toString());</span>
<a href="#l2.986"></a><span id="l2.986">   // What does a Date header look like? In practice, most date headers devolve</span>
<a href="#l2.987"></a><span id="l2.987">   // into Date: [dow ,] dom mon year hh:mm:ss tzoff [(abbrev)], with the day of</span>
<a href="#l2.988"></a><span id="l2.988">   // week mostly present and the timezone abbreviation mostly absent.</span>
<a href="#l2.989"></a><span id="l2.989"> </span>
<a href="#l2.990"></a><span id="l2.990">   // First, ignore the day-of-the-week if present. This would be the first two</span>
<a href="#l2.991"></a><span id="l2.991">   // tokens.</span>
<a href="#l2.992"></a><span id="l2.992" class="difflineminus">-  if (tokens.length &gt; 1 &amp;&amp; tokens[1] === ',')</span>
<a href="#l2.993"></a><span id="l2.993" class="difflineplus">+  if (tokens.length &gt; 1 &amp;&amp; tokens[1] === &quot;,&quot;)</span>
<a href="#l2.994"></a><span id="l2.994">     tokens = tokens.slice(2);</span>
<a href="#l2.995"></a><span id="l2.995"> </span>
<a href="#l2.996"></a><span id="l2.996">   // If there are too few tokens, the date is obviously invalid.</span>
<a href="#l2.997"></a><span id="l2.997">   if (tokens.length &lt; 8)</span>
<a href="#l2.998"></a><span id="l2.998">     return new Date(NaN);</span>
<a href="#l2.999"></a><span id="l2.999"> </span>
<a href="#l2.1000"></a><span id="l2.1000">   // Save off the numeric tokens</span>
<a href="#l2.1001"></a><span id="l2.1001">   let day = parseInt(tokens[0]);</span>
<a href="#l2.1002"></a><span id="l2.1002" class="difflineat">@@ -1278,19 +1280,19 @@ function parseDateHeader(header) {</span>
<a href="#l2.1003"></a><span id="l2.1003">   // Compute the timezone offset. If it's not in the form ±hhmm, convert it to</span>
<a href="#l2.1004"></a><span id="l2.1004">   // that form.</span>
<a href="#l2.1005"></a><span id="l2.1005">   let tzoffset = tokens[8];</span>
<a href="#l2.1006"></a><span id="l2.1006">   if (tzoffset in kKnownTZs)</span>
<a href="#l2.1007"></a><span id="l2.1007">     tzoffset = kKnownTZs[tzoffset];</span>
<a href="#l2.1008"></a><span id="l2.1008">   let decompose = /^([+-])(\d\d)(\d\d)$/.exec(tzoffset);</span>
<a href="#l2.1009"></a><span id="l2.1009">   // Unknown? Make it +0000</span>
<a href="#l2.1010"></a><span id="l2.1010">   if (decompose === null)</span>
<a href="#l2.1011"></a><span id="l2.1011" class="difflineminus">-    decompose = ['+0000', '+', '00', '00'];</span>
<a href="#l2.1012"></a><span id="l2.1012" class="difflineplus">+    decompose = [&quot;+0000&quot;, &quot;+&quot;, &quot;00&quot;, &quot;00&quot;];</span>
<a href="#l2.1013"></a><span id="l2.1013">   let tzOffsetInMin = parseInt(decompose[2]) * 60 + parseInt(decompose[3]);</span>
<a href="#l2.1014"></a><span id="l2.1014" class="difflineminus">-  if (decompose[1] == '-')</span>
<a href="#l2.1015"></a><span id="l2.1015" class="difflineplus">+  if (decompose[1] == &quot;-&quot;)</span>
<a href="#l2.1016"></a><span id="l2.1016">     tzOffsetInMin = -tzOffsetInMin;</span>
<a href="#l2.1017"></a><span id="l2.1017"> </span>
<a href="#l2.1018"></a><span id="l2.1018">   // How do we make the date at this point? Well, the JS date's constructor</span>
<a href="#l2.1019"></a><span id="l2.1019">   // builds the time in terms of the local timezone. To account for the offset</span>
<a href="#l2.1020"></a><span id="l2.1020">   // properly, we need to build in UTC.</span>
<a href="#l2.1021"></a><span id="l2.1021">   let finalDate = new Date(Date.UTC(year, month, day, hours, minutes, seconds)</span>
<a href="#l2.1022"></a><span id="l2.1022">     - tzOffsetInMin * 60 * 1000);</span>
<a href="#l2.1023"></a><span id="l2.1023"> </span>
<a href="#l2.1024"></a><span id="l2.1024" class="difflineat">@@ -1298,23 +1300,22 @@ function parseDateHeader(header) {</span>
<a href="#l2.1025"></a><span id="l2.1025">   // became undefined. In that case, the date would become invalid, and the</span>
<a href="#l2.1026"></a><span id="l2.1026">   // indication that it is so is that the underlying number is a NaN. In that</span>
<a href="#l2.1027"></a><span id="l2.1027">   // scenario, we could build attempt to use JS Date parsing as a last-ditch</span>
<a href="#l2.1028"></a><span id="l2.1028">   // attempt. But it's not clear that such messages really exist in practice,</span>
<a href="#l2.1029"></a><span id="l2.1029">   // and the valid formats for Date in ES6 are unspecified.</span>
<a href="#l2.1030"></a><span id="l2.1030">   return finalDate;</span>
<a href="#l2.1031"></a><span id="l2.1031"> }</span>
<a href="#l2.1032"></a><span id="l2.1032"> </span>
<a href="#l2.1033"></a><span id="l2.1033" class="difflineminus">-////////////////////////////////////////</span>
<a href="#l2.1034"></a><span id="l2.1034" class="difflineminus">-// Structured header decoding support //</span>
<a href="#l2.1035"></a><span id="l2.1035" class="difflineminus">-////////////////////////////////////////</span>
<a href="#l2.1036"></a><span id="l2.1036" class="difflineplus">+// Structured header decoding support</span>
<a href="#l2.1037"></a><span id="l2.1037" class="difflineplus">+// ----------------------------------</span>
<a href="#l2.1038"></a><span id="l2.1038"> </span>
<a href="#l2.1039"></a><span id="l2.1039"> // Load the default structured decoders</span>
<a href="#l2.1040"></a><span id="l2.1040"> var structuredDecoders = new Map();</span>
<a href="#l2.1041"></a><span id="l2.1041" class="difflineminus">-var structuredHeaders = require('./structuredHeaders');</span>
<a href="#l2.1042"></a><span id="l2.1042" class="difflineplus">+var structuredHeaders = require(&quot;./structuredHeaders&quot;);</span>
<a href="#l2.1043"></a><span id="l2.1043"> var preferredSpellings = structuredHeaders.spellings;</span>
<a href="#l2.1044"></a><span id="l2.1044"> var forbiddenHeaders = new Set();</span>
<a href="#l2.1045"></a><span id="l2.1045"> for (let pair of structuredHeaders.decoders) {</span>
<a href="#l2.1046"></a><span id="l2.1046">   addStructuredDecoder(pair[0], pair[1]);</span>
<a href="#l2.1047"></a><span id="l2.1047">   forbiddenHeaders.add(pair[0].toLowerCase());</span>
<a href="#l2.1048"></a><span id="l2.1048"> }</span>
<a href="#l2.1049"></a><span id="l2.1049"> </span>
<a href="#l2.1050"></a><span id="l2.1050"> /**</span>
<a href="#l2.1051"></a><span id="l2.1051" class="difflineat">@@ -1448,22 +1449,20 @@ headerparser.addStructuredDecoder = addS</span>
<a href="#l2.1052"></a><span id="l2.1052"> headerparser.convert8BitHeader = convert8BitHeader;</span>
<a href="#l2.1053"></a><span id="l2.1053"> headerparser.decodeRFC2047Words = decodeRFC2047Words;</span>
<a href="#l2.1054"></a><span id="l2.1054"> headerparser.getHeaderTokens = getHeaderTokens;</span>
<a href="#l2.1055"></a><span id="l2.1055"> headerparser.parseAddressingHeader = parseAddressingHeader;</span>
<a href="#l2.1056"></a><span id="l2.1056"> headerparser.parseDateHeader = parseDateHeader;</span>
<a href="#l2.1057"></a><span id="l2.1057"> headerparser.parseParameterHeader = parseParameterHeader;</span>
<a href="#l2.1058"></a><span id="l2.1058"> headerparser.parseStructuredHeader = parseStructuredHeader;</span>
<a href="#l2.1059"></a><span id="l2.1059"> return Object.freeze(headerparser);</span>
<a href="#l2.1060"></a><span id="l2.1060" class="difflineminus">-</span>
<a href="#l2.1061"></a><span id="l2.1061"> });</span>
<a href="#l2.1062"></a><span id="l2.1062"> </span>
<a href="#l2.1063"></a><span id="l2.1063" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.1064"></a><span id="l2.1064" class="difflineminus">-//                        JavaScript Raw MIME Parser                          //</span>
<a href="#l2.1065"></a><span id="l2.1065" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.1066"></a><span id="l2.1066" class="difflineplus">+// JavaScript Raw MIME Parser</span>
<a href="#l2.1067"></a><span id="l2.1067" class="difflineplus">+// --------------------------</span>
<a href="#l2.1068"></a><span id="l2.1068"> </span>
<a href="#l2.1069"></a><span id="l2.1069"> /**</span>
<a href="#l2.1070"></a><span id="l2.1070">  * The parser implemented in this file produces a MIME part tree for a given</span>
<a href="#l2.1071"></a><span id="l2.1071">  * input message via a streaming callback interface. It does not, by itself,</span>
<a href="#l2.1072"></a><span id="l2.1072">  * understand concepts like attachments (hence the term 'Raw'); the consumer</span>
<a href="#l2.1073"></a><span id="l2.1073">  * must translate output into such a format.</span>
<a href="#l2.1074"></a><span id="l2.1074">  *</span>
<a href="#l2.1075"></a><span id="l2.1075">  * Charsets:</span>
<a href="#l2.1076"></a><span id="l2.1076" class="difflineat">@@ -1505,22 +1504,22 @@ return Object.freeze(headerparser);</span>
<a href="#l2.1077"></a><span id="l2.1077">  * - The numbers of multipart/* parts are separated by `.' characters.</span>
<a href="#l2.1078"></a><span id="l2.1078">  * - The outermost message is referred to by use of the empty string.</span>
<a href="#l2.1079"></a><span id="l2.1079">  * --&gt; The following segments are not accounted for by IMAP part numbering. &lt;--</span>
<a href="#l2.1080"></a><span id="l2.1080">  * - The body of any message/rfc822 or similar part is distinguished from the</span>
<a href="#l2.1081"></a><span id="l2.1081">  *   message part as a whole by appending a `$' character. This does not apply</span>
<a href="#l2.1082"></a><span id="l2.1082">  *   to the outermost message/rfc822 envelope.</span>
<a href="#l2.1083"></a><span id="l2.1083">  */</span>
<a href="#l2.1084"></a><span id="l2.1084"> </span>
<a href="#l2.1085"></a><span id="l2.1085" class="difflineminus">-def('mimeparser', function(require) {</span>
<a href="#l2.1086"></a><span id="l2.1086" class="difflineplus">+def(&quot;mimeparser&quot;, function(require) {</span>
<a href="#l2.1087"></a><span id="l2.1087"> &quot;use strict&quot;;</span>
<a href="#l2.1088"></a><span id="l2.1088"> </span>
<a href="#l2.1089"></a><span id="l2.1089" class="difflineminus">-var mimeutils = require('./mimeutils');</span>
<a href="#l2.1090"></a><span id="l2.1090" class="difflineminus">-var headerparser = require('./headerparser');</span>
<a href="#l2.1091"></a><span id="l2.1091" class="difflineminus">-var spellings = require('./structuredHeaders').spellings;</span>
<a href="#l2.1092"></a><span id="l2.1092" class="difflineplus">+var mimeutils = require(&quot;./mimeutils&quot;);</span>
<a href="#l2.1093"></a><span id="l2.1093" class="difflineplus">+var headerparser = require(&quot;./headerparser&quot;);</span>
<a href="#l2.1094"></a><span id="l2.1094" class="difflineplus">+var spellings = require(&quot;./structuredHeaders&quot;).spellings;</span>
<a href="#l2.1095"></a><span id="l2.1095"> </span>
<a href="#l2.1096"></a><span id="l2.1096"> /**</span>
<a href="#l2.1097"></a><span id="l2.1097">  * An object that represents the structured MIME headers for a message.</span>
<a href="#l2.1098"></a><span id="l2.1098">  *</span>
<a href="#l2.1099"></a><span id="l2.1099">  * This class is primarily used as the 'headers' parameter in the startPart</span>
<a href="#l2.1100"></a><span id="l2.1100">  * callback on handlers for MimeParser. As such, it is designed to do the right</span>
<a href="#l2.1101"></a><span id="l2.1101">  * thing in common cases as much as possible, with some advanced customization</span>
<a href="#l2.1102"></a><span id="l2.1102">  * possible for clients that need such flexibility.</span>
<a href="#l2.1103"></a><span id="l2.1103" class="difflineat">@@ -1587,40 +1586,41 @@ function StructuredHeaders(rawHeaderText</span>
<a href="#l2.1104"></a><span id="l2.1104">   // and don't capture the strings or else split results get nasty.</span>
<a href="#l2.1105"></a><span id="l2.1105">   let values = rawHeaderText.split(/(?:\r\n|\n)(?![ \t])|\r(?![ \t\n])/);</span>
<a href="#l2.1106"></a><span id="l2.1106"> </span>
<a href="#l2.1107"></a><span id="l2.1107">   // Ignore the first &quot;header&quot; if it begins with an mbox delimiter</span>
<a href="#l2.1108"></a><span id="l2.1108">   if (values.length &gt; 0 &amp;&amp; values[0].substring(0, 5) == &quot;From &quot;) {</span>
<a href="#l2.1109"></a><span id="l2.1109">     values.shift();</span>
<a href="#l2.1110"></a><span id="l2.1110">     // Elide the mbox delimiter from this._headerData</span>
<a href="#l2.1111"></a><span id="l2.1111">     if (values.length == 0)</span>
<a href="#l2.1112"></a><span id="l2.1112" class="difflineminus">-      rawHeaderText = '';</span>
<a href="#l2.1113"></a><span id="l2.1113" class="difflineplus">+      rawHeaderText = &quot;&quot;;</span>
<a href="#l2.1114"></a><span id="l2.1114">     else</span>
<a href="#l2.1115"></a><span id="l2.1115">       rawHeaderText = rawHeaderText.substring(rawHeaderText.indexOf(values[0]));</span>
<a href="#l2.1116"></a><span id="l2.1116">   }</span>
<a href="#l2.1117"></a><span id="l2.1117"> </span>
<a href="#l2.1118"></a><span id="l2.1118">   let headers = new Map();</span>
<a href="#l2.1119"></a><span id="l2.1119">   for (let i = 0; i &lt; values.length; i++) {</span>
<a href="#l2.1120"></a><span id="l2.1120">     // Look for a colon. If it's not present, this header line is malformed,</span>
<a href="#l2.1121"></a><span id="l2.1121">     // perhaps by premature EOF or similar.</span>
<a href="#l2.1122"></a><span id="l2.1122">     let colon = values[i].indexOf(&quot;:&quot;);</span>
<a href="#l2.1123"></a><span id="l2.1123" class="difflineplus">+    let header, val;</span>
<a href="#l2.1124"></a><span id="l2.1124">     if (colon &gt;= 0) {</span>
<a href="#l2.1125"></a><span id="l2.1125" class="difflineminus">-      var header = values[i].substring(0, colon);</span>
<a href="#l2.1126"></a><span id="l2.1126" class="difflineminus">-      var val = values[i].substring(colon + 1).trim();</span>
<a href="#l2.1127"></a><span id="l2.1127" class="difflineplus">+      header = values[i].substring(0, colon);</span>
<a href="#l2.1128"></a><span id="l2.1128" class="difflineplus">+      val = values[i].substring(colon + 1).trim();</span>
<a href="#l2.1129"></a><span id="l2.1129">       if (options.stripcontinuations)</span>
<a href="#l2.1130"></a><span id="l2.1130" class="difflineminus">-        val = val.replace(/[\r\n]/g, '');</span>
<a href="#l2.1131"></a><span id="l2.1131" class="difflineplus">+        val = val.replace(/[\r\n]/g, &quot;&quot;);</span>
<a href="#l2.1132"></a><span id="l2.1132">     } else {</span>
<a href="#l2.1133"></a><span id="l2.1133" class="difflineminus">-      var header = values[i];</span>
<a href="#l2.1134"></a><span id="l2.1134" class="difflineminus">-      var val = '';</span>
<a href="#l2.1135"></a><span id="l2.1135" class="difflineplus">+      header = values[i];</span>
<a href="#l2.1136"></a><span id="l2.1136" class="difflineplus">+      val = &quot;&quot;;</span>
<a href="#l2.1137"></a><span id="l2.1137">     }</span>
<a href="#l2.1138"></a><span id="l2.1138"> </span>
<a href="#l2.1139"></a><span id="l2.1139">     // Canonicalize the header in lower-case form.</span>
<a href="#l2.1140"></a><span id="l2.1140">     header = header.trim().toLowerCase();</span>
<a href="#l2.1141"></a><span id="l2.1141">     // Omit &quot;empty&quot; headers</span>
<a href="#l2.1142"></a><span id="l2.1142" class="difflineminus">-    if (header == '')</span>
<a href="#l2.1143"></a><span id="l2.1143" class="difflineplus">+    if (header == &quot;&quot;)</span>
<a href="#l2.1144"></a><span id="l2.1144">       continue;</span>
<a href="#l2.1145"></a><span id="l2.1145"> </span>
<a href="#l2.1146"></a><span id="l2.1146">     // We keep an array of values for each header, since a given header may be</span>
<a href="#l2.1147"></a><span id="l2.1147">     // repeated multiple times.</span>
<a href="#l2.1148"></a><span id="l2.1148">     if (headers.has(header)) {</span>
<a href="#l2.1149"></a><span id="l2.1149">       headers.get(header).push(val);</span>
<a href="#l2.1150"></a><span id="l2.1150">     } else {</span>
<a href="#l2.1151"></a><span id="l2.1151">       headers.set(header, [val]);</span>
<a href="#l2.1152"></a><span id="l2.1152" class="difflineat">@@ -1632,41 +1632,43 @@ function StructuredHeaders(rawHeaderText</span>
<a href="#l2.1153"></a><span id="l2.1153">    * @private</span>
<a href="#l2.1154"></a><span id="l2.1154">    */</span>
<a href="#l2.1155"></a><span id="l2.1155">   this._rawHeaders = headers;</span>
<a href="#l2.1156"></a><span id="l2.1156">   /**</span>
<a href="#l2.1157"></a><span id="l2.1157">    * Cached results of structured header parsing.</span>
<a href="#l2.1158"></a><span id="l2.1158">    * @private</span>
<a href="#l2.1159"></a><span id="l2.1159">    */</span>
<a href="#l2.1160"></a><span id="l2.1160">   this._cachedHeaders = new Map();</span>
<a href="#l2.1161"></a><span id="l2.1161" class="difflineminus">-  Object.defineProperty(this, &quot;rawHeaderText&quot;,</span>
<a href="#l2.1162"></a><span id="l2.1162" class="difflineminus">-    {get: function () { return rawHeaderText; }});</span>
<a href="#l2.1163"></a><span id="l2.1163" class="difflineminus">-  Object.defineProperty(this, &quot;size&quot;,</span>
<a href="#l2.1164"></a><span id="l2.1164" class="difflineminus">-    {get: function () { return this._rawHeaders.size; }});</span>
<a href="#l2.1165"></a><span id="l2.1165" class="difflineplus">+  Object.defineProperty(this, &quot;rawHeaderText&quot;, {</span>
<a href="#l2.1166"></a><span id="l2.1166" class="difflineplus">+    get() { return rawHeaderText; },</span>
<a href="#l2.1167"></a><span id="l2.1167" class="difflineplus">+  });</span>
<a href="#l2.1168"></a><span id="l2.1168" class="difflineplus">+  Object.defineProperty(this, &quot;size&quot;, {</span>
<a href="#l2.1169"></a><span id="l2.1169" class="difflineplus">+    get() { return this._rawHeaders.size; },</span>
<a href="#l2.1170"></a><span id="l2.1170" class="difflineplus">+  });</span>
<a href="#l2.1171"></a><span id="l2.1171">   Object.defineProperty(this, &quot;charset&quot;, {</span>
<a href="#l2.1172"></a><span id="l2.1172" class="difflineminus">-    get: function () { return this._charset; },</span>
<a href="#l2.1173"></a><span id="l2.1173" class="difflineminus">-    set: function (value) {</span>
<a href="#l2.1174"></a><span id="l2.1174" class="difflineplus">+    get() { return this._charset; },</span>
<a href="#l2.1175"></a><span id="l2.1175" class="difflineplus">+    set(value) {</span>
<a href="#l2.1176"></a><span id="l2.1176">       this._charset = value;</span>
<a href="#l2.1177"></a><span id="l2.1177">       // Clear the cached headers, since this could change their values</span>
<a href="#l2.1178"></a><span id="l2.1178">       this._cachedHeaders.clear();</span>
<a href="#l2.1179"></a><span id="l2.1179" class="difflineminus">-    }</span>
<a href="#l2.1180"></a><span id="l2.1180" class="difflineplus">+    },</span>
<a href="#l2.1181"></a><span id="l2.1181">   });</span>
<a href="#l2.1182"></a><span id="l2.1182"> </span>
<a href="#l2.1183"></a><span id="l2.1183">   // Default to the charset, until the message parser overrides us.</span>
<a href="#l2.1184"></a><span id="l2.1184" class="difflineminus">-  if ('charset' in options)</span>
<a href="#l2.1185"></a><span id="l2.1185" class="difflineplus">+  if (&quot;charset&quot; in options)</span>
<a href="#l2.1186"></a><span id="l2.1186">     this._charset = options.charset;</span>
<a href="#l2.1187"></a><span id="l2.1187">   else</span>
<a href="#l2.1188"></a><span id="l2.1188">     this._charset = null;</span>
<a href="#l2.1189"></a><span id="l2.1189"> </span>
<a href="#l2.1190"></a><span id="l2.1190">   // If we have a Content-Type header, set contentType to return the structured</span>
<a href="#l2.1191"></a><span id="l2.1191">   // representation. We don't set the value off the bat, since we want to let</span>
<a href="#l2.1192"></a><span id="l2.1192">   // someone who changes the charset affect the values of 8-bit parameters.</span>
<a href="#l2.1193"></a><span id="l2.1193">   Object.defineProperty(this, &quot;contentType&quot;, {</span>
<a href="#l2.1194"></a><span id="l2.1194">     configurable: true,</span>
<a href="#l2.1195"></a><span id="l2.1195" class="difflineminus">-    get: function () { return this.get('Content-Type'); }</span>
<a href="#l2.1196"></a><span id="l2.1196" class="difflineplus">+    get() { return this.get(&quot;Content-Type&quot;); },</span>
<a href="#l2.1197"></a><span id="l2.1197">   });</span>
<a href="#l2.1198"></a><span id="l2.1198"> }</span>
<a href="#l2.1199"></a><span id="l2.1199"> </span>
<a href="#l2.1200"></a><span id="l2.1200"> /**</span>
<a href="#l2.1201"></a><span id="l2.1201">  * Get a raw header.</span>
<a href="#l2.1202"></a><span id="l2.1202">  *</span>
<a href="#l2.1203"></a><span id="l2.1203">  * Raw headers are an array of the header values, listed in order that they were</span>
<a href="#l2.1204"></a><span id="l2.1204">  * specified in the header block, and without any attempt to convert charsets or</span>
<a href="#l2.1205"></a><span id="l2.1205" class="difflineat">@@ -1680,17 +1682,17 @@ function StructuredHeaders(rawHeaderText</span>
<a href="#l2.1206"></a><span id="l2.1206">  * the result of calling getRawHeader('X-Header') or getRawHeader('x-header')</span>
<a href="#l2.1207"></a><span id="l2.1207">  * would be ['Value A', 'V\xC3\xA5lue B'] and the result of</span>
<a href="#l2.1208"></a><span id="l2.1208">  * getRawHeader('Header2') would be ['Q'].</span>
<a href="#l2.1209"></a><span id="l2.1209">  *</span>
<a href="#l2.1210"></a><span id="l2.1210">  * @param headerName {String} The header name for which to get header values.</span>
<a href="#l2.1211"></a><span id="l2.1211">  * @returns {BinaryString[]} The raw header values (with no charset conversion</span>
<a href="#l2.1212"></a><span id="l2.1212">  *                           applied).</span>
<a href="#l2.1213"></a><span id="l2.1213">  */</span>
<a href="#l2.1214"></a><span id="l2.1214" class="difflineminus">-StructuredHeaders.prototype.getRawHeader = function (headerName) {</span>
<a href="#l2.1215"></a><span id="l2.1215" class="difflineplus">+StructuredHeaders.prototype.getRawHeader = function(headerName) {</span>
<a href="#l2.1216"></a><span id="l2.1216">   return this._rawHeaders.get(headerName.toLowerCase());</span>
<a href="#l2.1217"></a><span id="l2.1217"> };</span>
<a href="#l2.1218"></a><span id="l2.1218"> </span>
<a href="#l2.1219"></a><span id="l2.1219"> /**</span>
<a href="#l2.1220"></a><span id="l2.1220">  * Retrieve a structured version of the header.</span>
<a href="#l2.1221"></a><span id="l2.1221">  *</span>
<a href="#l2.1222"></a><span id="l2.1222">  * If there is a registered structured decoder (registration happens via</span>
<a href="#l2.1223"></a><span id="l2.1223">  * headerparser.addStructuredDecoder), then the result of calling that decoder</span>
<a href="#l2.1224"></a><span id="l2.1224" class="difflineat">@@ -1700,113 +1702,113 @@ StructuredHeaders.prototype.getRawHeader</span>
<a href="#l2.1225"></a><span id="l2.1225">  *</span>
<a href="#l2.1226"></a><span id="l2.1226">  * A substantial set of headers have pre-registed structured decoders, which, in</span>
<a href="#l2.1227"></a><span id="l2.1227">  * some cases, are unable to be overridden due to their importance in the</span>
<a href="#l2.1228"></a><span id="l2.1228">  * functioning of the parser code itself.</span>
<a href="#l2.1229"></a><span id="l2.1229">  *</span>
<a href="#l2.1230"></a><span id="l2.1230">  * @param headerName {String} The header name for which to get the header value.</span>
<a href="#l2.1231"></a><span id="l2.1231">  * @returns The structured header value of the output.</span>
<a href="#l2.1232"></a><span id="l2.1232">  */</span>
<a href="#l2.1233"></a><span id="l2.1233" class="difflineminus">-StructuredHeaders.prototype.get = function (headerName) {</span>
<a href="#l2.1234"></a><span id="l2.1234" class="difflineplus">+StructuredHeaders.prototype.get = function(headerName) {</span>
<a href="#l2.1235"></a><span id="l2.1235">   // Normalize the header name to lower case</span>
<a href="#l2.1236"></a><span id="l2.1236">   headerName = headerName.toLowerCase();</span>
<a href="#l2.1237"></a><span id="l2.1237"> </span>
<a href="#l2.1238"></a><span id="l2.1238">   // First, check the cache for the header value</span>
<a href="#l2.1239"></a><span id="l2.1239">   if (this._cachedHeaders.has(headerName))</span>
<a href="#l2.1240"></a><span id="l2.1240">     return this._cachedHeaders.get(headerName);</span>
<a href="#l2.1241"></a><span id="l2.1241"> </span>
<a href="#l2.1242"></a><span id="l2.1242">   // Not cached? Grab it [propagating lack of header to caller]</span>
<a href="#l2.1243"></a><span id="l2.1243">   let headerValue = this._rawHeaders.get(headerName);</span>
<a href="#l2.1244"></a><span id="l2.1244">   if (headerValue === undefined)</span>
<a href="#l2.1245"></a><span id="l2.1245">     return headerValue;</span>
<a href="#l2.1246"></a><span id="l2.1246"> </span>
<a href="#l2.1247"></a><span id="l2.1247">   // Convert the header to Unicode</span>
<a href="#l2.1248"></a><span id="l2.1248">   let charset = this.charset;</span>
<a href="#l2.1249"></a><span id="l2.1249" class="difflineminus">-  headerValue = headerValue.map(function (value) {</span>
<a href="#l2.1250"></a><span id="l2.1250" class="difflineplus">+  headerValue = headerValue.map(function(value) {</span>
<a href="#l2.1251"></a><span id="l2.1251">     return headerparser.convert8BitHeader(value, charset);</span>
<a href="#l2.1252"></a><span id="l2.1252">   });</span>
<a href="#l2.1253"></a><span id="l2.1253"> </span>
<a href="#l2.1254"></a><span id="l2.1254">   // If there is a structured decoder, use that; otherwise, assume that the</span>
<a href="#l2.1255"></a><span id="l2.1255">   // header is unstructured and only do RFC 2047 conversion</span>
<a href="#l2.1256"></a><span id="l2.1256">   let structured;</span>
<a href="#l2.1257"></a><span id="l2.1257">   try {</span>
<a href="#l2.1258"></a><span id="l2.1258">     structured = headerparser.parseStructuredHeader(headerName, headerValue);</span>
<a href="#l2.1259"></a><span id="l2.1259">   } catch (e) {</span>
<a href="#l2.1260"></a><span id="l2.1260" class="difflineminus">-    structured = headerValue.map(function (value) {</span>
<a href="#l2.1261"></a><span id="l2.1261" class="difflineplus">+    structured = headerValue.map(function(value) {</span>
<a href="#l2.1262"></a><span id="l2.1262">       return headerparser.decodeRFC2047Words(value);</span>
<a href="#l2.1263"></a><span id="l2.1263">     });</span>
<a href="#l2.1264"></a><span id="l2.1264">   }</span>
<a href="#l2.1265"></a><span id="l2.1265"> </span>
<a href="#l2.1266"></a><span id="l2.1266">   // Cache the result and return it</span>
<a href="#l2.1267"></a><span id="l2.1267">   this._cachedHeaders.set(headerName, structured);</span>
<a href="#l2.1268"></a><span id="l2.1268">   return structured;</span>
<a href="#l2.1269"></a><span id="l2.1269"> };</span>
<a href="#l2.1270"></a><span id="l2.1270"> </span>
<a href="#l2.1271"></a><span id="l2.1271"> /**</span>
<a href="#l2.1272"></a><span id="l2.1272">  * Check if the message has the given header.</span>
<a href="#l2.1273"></a><span id="l2.1273">  *</span>
<a href="#l2.1274"></a><span id="l2.1274">  * @param headerName {String} The header name for which to get the header value.</span>
<a href="#l2.1275"></a><span id="l2.1275">  * @returns {Boolean} True if the header is present in this header block.</span>
<a href="#l2.1276"></a><span id="l2.1276">  */</span>
<a href="#l2.1277"></a><span id="l2.1277" class="difflineminus">-StructuredHeaders.prototype.has = function (headerName) {</span>
<a href="#l2.1278"></a><span id="l2.1278" class="difflineplus">+StructuredHeaders.prototype.has = function(headerName) {</span>
<a href="#l2.1279"></a><span id="l2.1279">   // Check for presence in the raw headers instead of cached headers.</span>
<a href="#l2.1280"></a><span id="l2.1280">   return this._rawHeaders.has(headerName.toLowerCase());</span>
<a href="#l2.1281"></a><span id="l2.1281"> };</span>
<a href="#l2.1282"></a><span id="l2.1282"> </span>
<a href="#l2.1283"></a><span id="l2.1283"> // Make a custom iterator. Presently, support for Symbol isn't yet present in</span>
<a href="#l2.1284"></a><span id="l2.1284"> // SpiderMonkey (or V8 for that matter), so type-pun the name for now.</span>
<a href="#l2.1285"></a><span id="l2.1285"> var JS_HAS_SYMBOLS = typeof Symbol === &quot;function&quot;;</span>
<a href="#l2.1286"></a><span id="l2.1286"> var ITERATOR_SYMBOL = JS_HAS_SYMBOLS ? Symbol.iterator : &quot;@@iterator&quot;;</span>
<a href="#l2.1287"></a><span id="l2.1287"> </span>
<a href="#l2.1288"></a><span id="l2.1288"> /**</span>
<a href="#l2.1289"></a><span id="l2.1289">  * An equivalent of Map.@@iterator, applied to the structured header</span>
<a href="#l2.1290"></a><span id="l2.1290">  * representations. This is the function that makes</span>
<a href="#l2.1291"></a><span id="l2.1291">  * for (let [header, value] of headers) work properly.</span>
<a href="#l2.1292"></a><span id="l2.1292">  */</span>
<a href="#l2.1293"></a><span id="l2.1293" class="difflineminus">-StructuredHeaders.prototype[ITERATOR_SYMBOL] = function*() {</span>
<a href="#l2.1294"></a><span id="l2.1294" class="difflineplus">+StructuredHeaders.prototype[ITERATOR_SYMBOL] = function* () {</span>
<a href="#l2.1295"></a><span id="l2.1295">   // Iterate over all the raw headers, and use the cached headers to retrieve</span>
<a href="#l2.1296"></a><span id="l2.1296">   // them.</span>
<a href="#l2.1297"></a><span id="l2.1297">   for (let headerName of this.keys()) {</span>
<a href="#l2.1298"></a><span id="l2.1298">     yield [headerName, this.get(headerName)];</span>
<a href="#l2.1299"></a><span id="l2.1299">   }</span>
<a href="#l2.1300"></a><span id="l2.1300"> };</span>
<a href="#l2.1301"></a><span id="l2.1301"> </span>
<a href="#l2.1302"></a><span id="l2.1302"> /**</span>
<a href="#l2.1303"></a><span id="l2.1303">  * An equivalent of Map.forEach, applied to the structured header</span>
<a href="#l2.1304"></a><span id="l2.1304">  * representations.</span>
<a href="#l2.1305"></a><span id="l2.1305">  *</span>
<a href="#l2.1306"></a><span id="l2.1306">  * @param callback {Function(value, name, headers)} The callback to call for</span>
<a href="#l2.1307"></a><span id="l2.1307">  *                                                  each header/value combo.</span>
<a href="#l2.1308"></a><span id="l2.1308">  * @param thisarg  {Object}                         The parameter that will be</span>
<a href="#l2.1309"></a><span id="l2.1309">  *                                                  the |this| of the callback.</span>
<a href="#l2.1310"></a><span id="l2.1310">  */</span>
<a href="#l2.1311"></a><span id="l2.1311" class="difflineminus">-StructuredHeaders.prototype.forEach = function (callback, thisarg) {</span>
<a href="#l2.1312"></a><span id="l2.1312" class="difflineplus">+StructuredHeaders.prototype.forEach = function(callback, thisarg) {</span>
<a href="#l2.1313"></a><span id="l2.1313">   for (let [header, value] of this) {</span>
<a href="#l2.1314"></a><span id="l2.1314">     callback.call(thisarg, value, header, this);</span>
<a href="#l2.1315"></a><span id="l2.1315">   }</span>
<a href="#l2.1316"></a><span id="l2.1316"> };</span>
<a href="#l2.1317"></a><span id="l2.1317"> </span>
<a href="#l2.1318"></a><span id="l2.1318"> /**</span>
<a href="#l2.1319"></a><span id="l2.1319">  * An equivalent of Map.entries, applied to the structured header</span>
<a href="#l2.1320"></a><span id="l2.1320">  * representations.</span>
<a href="#l2.1321"></a><span id="l2.1321">  */</span>
<a href="#l2.1322"></a><span id="l2.1322"> StructuredHeaders.prototype.entries =</span>
<a href="#l2.1323"></a><span id="l2.1323">   StructuredHeaders.prototype[Symbol.iterator];</span>
<a href="#l2.1324"></a><span id="l2.1324"> </span>
<a href="#l2.1325"></a><span id="l2.1325" class="difflineminus">-/// This function maps lower case names to a pseudo-preferred spelling.</span>
<a href="#l2.1326"></a><span id="l2.1326" class="difflineplus">+// This function maps lower case names to a pseudo-preferred spelling.</span>
<a href="#l2.1327"></a><span id="l2.1327"> function capitalize(headerName) {</span>
<a href="#l2.1328"></a><span id="l2.1328" class="difflineminus">-  return headerName.replace(/\b[a-z]/g, function (match) {</span>
<a href="#l2.1329"></a><span id="l2.1329" class="difflineplus">+  return headerName.replace(/\b[a-z]/g, function(match) {</span>
<a href="#l2.1330"></a><span id="l2.1330">     return match.toUpperCase();</span>
<a href="#l2.1331"></a><span id="l2.1331">   });</span>
<a href="#l2.1332"></a><span id="l2.1332"> }</span>
<a href="#l2.1333"></a><span id="l2.1333"> </span>
<a href="#l2.1334"></a><span id="l2.1334"> /**</span>
<a href="#l2.1335"></a><span id="l2.1335">  * An equivalent of Map.keys, applied to the structured header representations.</span>
<a href="#l2.1336"></a><span id="l2.1336">  */</span>
<a href="#l2.1337"></a><span id="l2.1337" class="difflineminus">-StructuredHeaders.prototype.keys = function*() {</span>
<a href="#l2.1338"></a><span id="l2.1338" class="difflineplus">+StructuredHeaders.prototype.keys = function* () {</span>
<a href="#l2.1339"></a><span id="l2.1339">   for (let name of this._rawHeaders.keys()) {</span>
<a href="#l2.1340"></a><span id="l2.1340">     yield spellings.get(name) || capitalize(name);</span>
<a href="#l2.1341"></a><span id="l2.1341">   }</span>
<a href="#l2.1342"></a><span id="l2.1342"> };</span>
<a href="#l2.1343"></a><span id="l2.1343"> </span>
<a href="#l2.1344"></a><span id="l2.1344"> /**</span>
<a href="#l2.1345"></a><span id="l2.1345">  * An equivalent of Map.values, applied to the structured header</span>
<a href="#l2.1346"></a><span id="l2.1346">  * representations.</span>
<a href="#l2.1347"></a><span id="l2.1347" class="difflineat">@@ -1876,74 +1878,74 @@ StructuredHeaders.prototype.values = fun</span>
<a href="#l2.1348"></a><span id="l2.1348">  *      If true, then the newlines in headers are removed in the returned</span>
<a href="#l2.1349"></a><span id="l2.1349">  *      header objects.</span>
<a href="#l2.1350"></a><span id="l2.1350">  *    onerror: &lt;function(thrown error)&gt; [default = nop-function]</span>
<a href="#l2.1351"></a><span id="l2.1351">  *      An error function that is called if an emitter callback throws an error.</span>
<a href="#l2.1352"></a><span id="l2.1352">  *      By default, such errors are swallowed by the parser. If you want the</span>
<a href="#l2.1353"></a><span id="l2.1353">  *      parser itself to throw an error, rethrow it via the onerror function.</span>
<a href="#l2.1354"></a><span id="l2.1354">  */</span>
<a href="#l2.1355"></a><span id="l2.1355"> function MimeParser(emitter, options) {</span>
<a href="#l2.1356"></a><span id="l2.1356" class="difflineminus">-  /// The actual emitter</span>
<a href="#l2.1357"></a><span id="l2.1357" class="difflineplus">+  // The actual emitter</span>
<a href="#l2.1358"></a><span id="l2.1358">   this._emitter = emitter;</span>
<a href="#l2.1359"></a><span id="l2.1359" class="difflineminus">-  /// Options for the parser (those listed here are defaults)</span>
<a href="#l2.1360"></a><span id="l2.1360" class="difflineplus">+  // Options for the parser (those listed here are defaults)</span>
<a href="#l2.1361"></a><span id="l2.1361">   this._options = {</span>
<a href="#l2.1362"></a><span id="l2.1362">     pruneat: &quot;&quot;,</span>
<a href="#l2.1363"></a><span id="l2.1363">     bodyformat: &quot;nodecode&quot;,</span>
<a href="#l2.1364"></a><span id="l2.1364">     strformat: &quot;binarystring&quot;,</span>
<a href="#l2.1365"></a><span id="l2.1365">     stripcontinuations: true,</span>
<a href="#l2.1366"></a><span id="l2.1366">     charset: &quot;&quot;,</span>
<a href="#l2.1367"></a><span id="l2.1367">     &quot;force-charset&quot;: false,</span>
<a href="#l2.1368"></a><span id="l2.1368" class="difflineminus">-    onerror: function swallow(error) {}</span>
<a href="#l2.1369"></a><span id="l2.1369" class="difflineplus">+    onerror(error) {},</span>
<a href="#l2.1370"></a><span id="l2.1370">   };</span>
<a href="#l2.1371"></a><span id="l2.1371">   // Load the options as a copy here (prevents people from changing on the fly).</span>
<a href="#l2.1372"></a><span id="l2.1372">   if (options)</span>
<a href="#l2.1373"></a><span id="l2.1373">     for (var opt in options) {</span>
<a href="#l2.1374"></a><span id="l2.1374">       this._options[opt] = options[opt];</span>
<a href="#l2.1375"></a><span id="l2.1375">     }</span>
<a href="#l2.1376"></a><span id="l2.1376"> </span>
<a href="#l2.1377"></a><span id="l2.1377">   // Ensure that the error function is in fact a function</span>
<a href="#l2.1378"></a><span id="l2.1378">   if (typeof this._options.onerror != &quot;function&quot;)</span>
<a href="#l2.1379"></a><span id="l2.1379" class="difflineminus">-    throw new Exception(&quot;onerror callback must be a function&quot;);</span>
<a href="#l2.1380"></a><span id="l2.1380" class="difflineplus">+    throw new Error(&quot;onerror callback must be a function&quot;);</span>
<a href="#l2.1381"></a><span id="l2.1381"> </span>
<a href="#l2.1382"></a><span id="l2.1382">   // Reset the parser</span>
<a href="#l2.1383"></a><span id="l2.1383">   this.resetParser();</span>
<a href="#l2.1384"></a><span id="l2.1384"> }</span>
<a href="#l2.1385"></a><span id="l2.1385"> </span>
<a href="#l2.1386"></a><span id="l2.1386"> /**</span>
<a href="#l2.1387"></a><span id="l2.1387">  * Resets the parser to read a new message. This method need not be called</span>
<a href="#l2.1388"></a><span id="l2.1388">  * immediately after construction.</span>
<a href="#l2.1389"></a><span id="l2.1389">  */</span>
<a href="#l2.1390"></a><span id="l2.1390" class="difflineminus">-MimeParser.prototype.resetParser = function () {</span>
<a href="#l2.1391"></a><span id="l2.1391" class="difflineminus">-  /// Current parser state</span>
<a href="#l2.1392"></a><span id="l2.1392" class="difflineplus">+MimeParser.prototype.resetParser = function() {</span>
<a href="#l2.1393"></a><span id="l2.1393" class="difflineplus">+  // Current parser state</span>
<a href="#l2.1394"></a><span id="l2.1394">   this._state = PARSING_HEADERS;</span>
<a href="#l2.1395"></a><span id="l2.1395" class="difflineminus">-  /// Input data that needs to be held for buffer conditioning</span>
<a href="#l2.1396"></a><span id="l2.1396" class="difflineminus">-  this._holdData = '';</span>
<a href="#l2.1397"></a><span id="l2.1397" class="difflineminus">-  /// Complete collection of headers (also used to accumulate _headerData)</span>
<a href="#l2.1398"></a><span id="l2.1398" class="difflineminus">-  this._headerData = '';</span>
<a href="#l2.1399"></a><span id="l2.1399" class="difflineminus">-  /// Whether or not emitter.startMessage has been called</span>
<a href="#l2.1400"></a><span id="l2.1400" class="difflineplus">+  // Input data that needs to be held for buffer conditioning</span>
<a href="#l2.1401"></a><span id="l2.1401" class="difflineplus">+  this._holdData = &quot;&quot;;</span>
<a href="#l2.1402"></a><span id="l2.1402" class="difflineplus">+  // Complete collection of headers (also used to accumulate _headerData)</span>
<a href="#l2.1403"></a><span id="l2.1403" class="difflineplus">+  this._headerData = &quot;&quot;;</span>
<a href="#l2.1404"></a><span id="l2.1404" class="difflineplus">+  // Whether or not emitter.startMessage has been called</span>
<a href="#l2.1405"></a><span id="l2.1405">   this._triggeredCall = false;</span>
<a href="#l2.1406"></a><span id="l2.1406"> </span>
<a href="#l2.1407"></a><span id="l2.1407" class="difflineminus">-  /// Splitting input</span>
<a href="#l2.1408"></a><span id="l2.1408" class="difflineplus">+  // Splitting input</span>
<a href="#l2.1409"></a><span id="l2.1409">   this._splitRegex = this._handleSplit = undefined;</span>
<a href="#l2.1410"></a><span id="l2.1410" class="difflineminus">-  /// Subparsing</span>
<a href="#l2.1411"></a><span id="l2.1411" class="difflineplus">+  // Subparsing</span>
<a href="#l2.1412"></a><span id="l2.1412">   this._subparser = this._subPartNum = undefined;</span>
<a href="#l2.1413"></a><span id="l2.1413" class="difflineminus">-  /// Data that has yet to be consumed by _convertData</span>
<a href="#l2.1414"></a><span id="l2.1414" class="difflineminus">-  this._savedBuffer = '';</span>
<a href="#l2.1415"></a><span id="l2.1415" class="difflineminus">-  /// Convert data</span>
<a href="#l2.1416"></a><span id="l2.1416" class="difflineplus">+  // Data that has yet to be consumed by _convertData</span>
<a href="#l2.1417"></a><span id="l2.1417" class="difflineplus">+  this._savedBuffer = &quot;&quot;;</span>
<a href="#l2.1418"></a><span id="l2.1418" class="difflineplus">+  // Convert data</span>
<a href="#l2.1419"></a><span id="l2.1419">   this._convertData = undefined;</span>
<a href="#l2.1420"></a><span id="l2.1420" class="difflineminus">-  /// String decoder</span>
<a href="#l2.1421"></a><span id="l2.1421" class="difflineplus">+  // String decoder</span>
<a href="#l2.1422"></a><span id="l2.1422">   this._decoder = undefined;</span>
<a href="#l2.1423"></a><span id="l2.1423"> };</span>
<a href="#l2.1424"></a><span id="l2.1424"> </span>
<a href="#l2.1425"></a><span id="l2.1425"> /**</span>
<a href="#l2.1426"></a><span id="l2.1426">  * Deliver a buffer of data to the parser.</span>
<a href="#l2.1427"></a><span id="l2.1427">  *</span>
<a href="#l2.1428"></a><span id="l2.1428">  * @param buffer {BinaryString} The raw data to add to the message.</span>
<a href="#l2.1429"></a><span id="l2.1429">  */</span>
<a href="#l2.1430"></a><span id="l2.1430" class="difflineminus">-MimeParser.prototype.deliverData = function (buffer) {</span>
<a href="#l2.1431"></a><span id="l2.1431" class="difflineplus">+MimeParser.prototype.deliverData = function(buffer) {</span>
<a href="#l2.1432"></a><span id="l2.1432">   // In ideal circumstances, we'd like to parse the message all at once. In</span>
<a href="#l2.1433"></a><span id="l2.1433">   // reality, though, data will be coming to us in packets. To keep the amount</span>
<a href="#l2.1434"></a><span id="l2.1434">   // of saved state low, we want to make basic guarantees about how packets get</span>
<a href="#l2.1435"></a><span id="l2.1435">   // delivered. Our basic model is a twist on line-buffering, as the format of</span>
<a href="#l2.1436"></a><span id="l2.1436">   // MIME and messages make it hard to not do so: we can handle multiple lines</span>
<a href="#l2.1437"></a><span id="l2.1437">   // at once. To ensure this, we start by conditioning the packet by</span>
<a href="#l2.1438"></a><span id="l2.1438">   // withholding data to make sure that the internal deliveries have the</span>
<a href="#l2.1439"></a><span id="l2.1439">   // guarantees. This implies that we need to do the following steps:</span>
<a href="#l2.1440"></a><span id="l2.1440" class="difflineat">@@ -1955,17 +1957,17 @@ MimeParser.prototype.deliverData = funct</span>
<a href="#l2.1441"></a><span id="l2.1441">   // is being passed to us via a line-buffered input is going to have most of</span>
<a href="#l2.1442"></a><span id="l2.1442">   // its data being withhold until the next buffer. Since \r is so uncommon of</span>
<a href="#l2.1443"></a><span id="l2.1443">   // a line ending in modern times, this is acceptable lossage.]</span>
<a href="#l2.1444"></a><span id="l2.1444">   // 3. Eliminate empty packets.</span>
<a href="#l2.1445"></a><span id="l2.1445"> </span>
<a href="#l2.1446"></a><span id="l2.1446">   // Add in previously saved data</span>
<a href="#l2.1447"></a><span id="l2.1447">   if (this._holdData) {</span>
<a href="#l2.1448"></a><span id="l2.1448">     buffer = this._holdData + buffer;</span>
<a href="#l2.1449"></a><span id="l2.1449" class="difflineminus">-    this._holdData = '';</span>
<a href="#l2.1450"></a><span id="l2.1450" class="difflineplus">+    this._holdData = &quot;&quot;;</span>
<a href="#l2.1451"></a><span id="l2.1451">   }</span>
<a href="#l2.1452"></a><span id="l2.1452"> </span>
<a href="#l2.1453"></a><span id="l2.1453">   // Condition the input, so that we get the multiline-buffering mentioned in</span>
<a href="#l2.1454"></a><span id="l2.1454">   // the above comment.</span>
<a href="#l2.1455"></a><span id="l2.1455">   if (buffer.length &gt; 0) {</span>
<a href="#l2.1456"></a><span id="l2.1456">     [buffer, this._holdData] = conditionToEndOnCRLF(buffer);</span>
<a href="#l2.1457"></a><span id="l2.1457">   }</span>
<a href="#l2.1458"></a><span id="l2.1458"> </span>
<a href="#l2.1459"></a><span id="l2.1459" class="difflineat">@@ -1976,43 +1978,43 @@ MimeParser.prototype.deliverData = funct</span>
<a href="#l2.1460"></a><span id="l2.1460">   // Signal the beginning, if we haven't done so.</span>
<a href="#l2.1461"></a><span id="l2.1461">   if (!this._triggeredCall) {</span>
<a href="#l2.1462"></a><span id="l2.1462">     this._callEmitter(&quot;startMessage&quot;);</span>
<a href="#l2.1463"></a><span id="l2.1463">     this._triggeredCall = true;</span>
<a href="#l2.1464"></a><span id="l2.1464">   }</span>
<a href="#l2.1465"></a><span id="l2.1465"> </span>
<a href="#l2.1466"></a><span id="l2.1466">   // Finally, send it the internal parser.</span>
<a href="#l2.1467"></a><span id="l2.1467">   this._dispatchData(&quot;&quot;, buffer, true);</span>
<a href="#l2.1468"></a><span id="l2.1468" class="difflineminus">-}</span>
<a href="#l2.1469"></a><span id="l2.1469" class="difflineplus">+};</span>
<a href="#l2.1470"></a><span id="l2.1470"> </span>
<a href="#l2.1471"></a><span id="l2.1471"> /**</span>
<a href="#l2.1472"></a><span id="l2.1472">  * Ensure that a set of data always ends in an end-of-line character.</span>
<a href="#l2.1473"></a><span id="l2.1473">  *</span>
<a href="#l2.1474"></a><span id="l2.1474">  * @param buffer {BinaryString} The data with no guarantees about where it ends.</span>
<a href="#l2.1475"></a><span id="l2.1475">  * @returns {BinaryString[]} An array of 2 binary strings where the first string</span>
<a href="#l2.1476"></a><span id="l2.1476">  *                           ends in a newline and the last string contains the</span>
<a href="#l2.1477"></a><span id="l2.1477">  *                           text in buffer following the first string.</span>
<a href="#l2.1478"></a><span id="l2.1478">  */</span>
<a href="#l2.1479"></a><span id="l2.1479"> function conditionToEndOnCRLF(buffer) {</span>
<a href="#l2.1480"></a><span id="l2.1480">   // Find the last occurrence of '\r' or '\n' to split the string. However, we</span>
<a href="#l2.1481"></a><span id="l2.1481">   // don't want to consider '\r' if it is the very last character, as we need</span>
<a href="#l2.1482"></a><span id="l2.1482">   // the next packet to tell if the '\r' is the beginning of a CRLF or a line</span>
<a href="#l2.1483"></a><span id="l2.1483">   // ending by itself.</span>
<a href="#l2.1484"></a><span id="l2.1484" class="difflineminus">-  let lastCR = buffer.lastIndexOf('\r', buffer.length - 2);</span>
<a href="#l2.1485"></a><span id="l2.1485" class="difflineminus">-  let lastLF = buffer.lastIndexOf('\n');</span>
<a href="#l2.1486"></a><span id="l2.1486" class="difflineplus">+  let lastCR = buffer.lastIndexOf(&quot;\r&quot;, buffer.length - 2);</span>
<a href="#l2.1487"></a><span id="l2.1487" class="difflineplus">+  let lastLF = buffer.lastIndexOf(&quot;\n&quot;);</span>
<a href="#l2.1488"></a><span id="l2.1488">   let end = lastLF &gt; lastCR ? lastLF : lastCR;</span>
<a href="#l2.1489"></a><span id="l2.1489">   return [buffer.substring(0, end + 1), buffer.substring(end + 1)];</span>
<a href="#l2.1490"></a><span id="l2.1490" class="difflineminus">-};</span>
<a href="#l2.1491"></a><span id="l2.1491" class="difflineplus">+}</span>
<a href="#l2.1492"></a><span id="l2.1492"> </span>
<a href="#l2.1493"></a><span id="l2.1493"> /**</span>
<a href="#l2.1494"></a><span id="l2.1494">  * Tell the parser that all of the data has been delivered.</span>
<a href="#l2.1495"></a><span id="l2.1495">  *</span>
<a href="#l2.1496"></a><span id="l2.1496">  * This will flush all of the internal state of the parser.</span>
<a href="#l2.1497"></a><span id="l2.1497">  */</span>
<a href="#l2.1498"></a><span id="l2.1498" class="difflineminus">-MimeParser.prototype.deliverEOF = function () {</span>
<a href="#l2.1499"></a><span id="l2.1499" class="difflineplus">+MimeParser.prototype.deliverEOF = function() {</span>
<a href="#l2.1500"></a><span id="l2.1500">   // Start of input buffered too long? Call start message now.</span>
<a href="#l2.1501"></a><span id="l2.1501">   if (!this._triggeredCall) {</span>
<a href="#l2.1502"></a><span id="l2.1502">     this._triggeredCall = true;</span>
<a href="#l2.1503"></a><span id="l2.1503">     this._callEmitter(&quot;startMessage&quot;);</span>
<a href="#l2.1504"></a><span id="l2.1504">   }</span>
<a href="#l2.1505"></a><span id="l2.1505">   // Force a flush of all of the data.</span>
<a href="#l2.1506"></a><span id="l2.1506">   if (this._holdData)</span>
<a href="#l2.1507"></a><span id="l2.1507">     this._dispatchData(&quot;&quot;, this._holdData, true);</span>
<a href="#l2.1508"></a><span id="l2.1508" class="difflineat">@@ -2025,17 +2027,17 @@ MimeParser.prototype.deliverEOF = functi</span>
<a href="#l2.1509"></a><span id="l2.1509">  * Calls a method on the emitter safely.</span>
<a href="#l2.1510"></a><span id="l2.1510">  *</span>
<a href="#l2.1511"></a><span id="l2.1511">  * This method ensures that errors in the emitter call won't cause the parser</span>
<a href="#l2.1512"></a><span id="l2.1512">  * to exit with an error, unless the user wants it to.</span>
<a href="#l2.1513"></a><span id="l2.1513">  *</span>
<a href="#l2.1514"></a><span id="l2.1514">  * @param funcname {String} The function name to call on the emitter.</span>
<a href="#l2.1515"></a><span id="l2.1515">  * @param args...           Extra arguments to pass into the emitter callback.</span>
<a href="#l2.1516"></a><span id="l2.1516">  */</span>
<a href="#l2.1517"></a><span id="l2.1517" class="difflineminus">-MimeParser.prototype._callEmitter = function (funcname, ...args) {</span>
<a href="#l2.1518"></a><span id="l2.1518" class="difflineplus">+MimeParser.prototype._callEmitter = function(funcname, ...args) {</span>
<a href="#l2.1519"></a><span id="l2.1519">   if (this._emitter &amp;&amp; funcname in this._emitter) {</span>
<a href="#l2.1520"></a><span id="l2.1520">     if (args.length &gt; 0 &amp;&amp; this._willIgnorePart(args[0])) {</span>
<a href="#l2.1521"></a><span id="l2.1521">       // partNum is always the first argument, so check to make sure that it</span>
<a href="#l2.1522"></a><span id="l2.1522">       // satisfies our emitter's pruneat requirement.</span>
<a href="#l2.1523"></a><span id="l2.1523">       return;</span>
<a href="#l2.1524"></a><span id="l2.1524">     }</span>
<a href="#l2.1525"></a><span id="l2.1525">     try {</span>
<a href="#l2.1526"></a><span id="l2.1526">       this._emitter[funcname].apply(this._emitter, args);</span>
<a href="#l2.1527"></a><span id="l2.1527" class="difflineat">@@ -2048,32 +2050,31 @@ MimeParser.prototype._callEmitter = func</span>
<a href="#l2.1528"></a><span id="l2.1528"> };</span>
<a href="#l2.1529"></a><span id="l2.1529"> </span>
<a href="#l2.1530"></a><span id="l2.1530"> /**</span>
<a href="#l2.1531"></a><span id="l2.1531">  * Helper function to decide if a part's output will never be seen.</span>
<a href="#l2.1532"></a><span id="l2.1532">  *</span>
<a href="#l2.1533"></a><span id="l2.1533">  * @param part {String} The number of the part.</span>
<a href="#l2.1534"></a><span id="l2.1534">  * @returns {Boolean} True if the emitter is not interested in this part.</span>
<a href="#l2.1535"></a><span id="l2.1535">  */</span>
<a href="#l2.1536"></a><span id="l2.1536" class="difflineminus">-MimeParser.prototype._willIgnorePart = function (part) {</span>
<a href="#l2.1537"></a><span id="l2.1537" class="difflineminus">-  if (this._options[&quot;pruneat&quot;]) {</span>
<a href="#l2.1538"></a><span id="l2.1538" class="difflineminus">-    let match = this._options[&quot;pruneat&quot;];</span>
<a href="#l2.1539"></a><span id="l2.1539" class="difflineplus">+MimeParser.prototype._willIgnorePart = function(part) {</span>
<a href="#l2.1540"></a><span id="l2.1540" class="difflineplus">+  if (this._options.pruneat) {</span>
<a href="#l2.1541"></a><span id="l2.1541" class="difflineplus">+    let match = this._options.pruneat;</span>
<a href="#l2.1542"></a><span id="l2.1542">     let start = part.substr(0, match.length);</span>
<a href="#l2.1543"></a><span id="l2.1543">     // It needs to start with and follow with a new part indicator</span>
<a href="#l2.1544"></a><span id="l2.1544">     // (i.e., don't let 10 match with 1, but let 1.1 or 1$ do so)</span>
<a href="#l2.1545"></a><span id="l2.1545">     if (start != match || (match.length &lt; part.length &amp;&amp;</span>
<a href="#l2.1546"></a><span id="l2.1546" class="difflineminus">-          &quot;$.&quot;.indexOf(part[match.length]) == -1))</span>
<a href="#l2.1547"></a><span id="l2.1547" class="difflineplus">+          !(&quot;$.&quot;.includes(part[match.length]))))</span>
<a href="#l2.1548"></a><span id="l2.1548">       return true;</span>
<a href="#l2.1549"></a><span id="l2.1549">   }</span>
<a href="#l2.1550"></a><span id="l2.1550">   return false;</span>
<a href="#l2.1551"></a><span id="l2.1551"> };</span>
<a href="#l2.1552"></a><span id="l2.1552"> </span>
<a href="#l2.1553"></a><span id="l2.1553" class="difflineminus">-//////////////////////</span>
<a href="#l2.1554"></a><span id="l2.1554" class="difflineminus">-// MIME parser core //</span>
<a href="#l2.1555"></a><span id="l2.1555" class="difflineminus">-//////////////////////</span>
<a href="#l2.1556"></a><span id="l2.1556" class="difflineplus">+// MIME parser core</span>
<a href="#l2.1557"></a><span id="l2.1557" class="difflineplus">+// ----------------</span>
<a href="#l2.1558"></a><span id="l2.1558"> </span>
<a href="#l2.1559"></a><span id="l2.1559"> // This MIME parser is a stateful parser; handling of the MIME tree is mostly</span>
<a href="#l2.1560"></a><span id="l2.1560"> // done by creating new parsers and feeding data to them manually. In parallel</span>
<a href="#l2.1561"></a><span id="l2.1561"> // to the externally-visible deliverData and deliverEOF, the two methods</span>
<a href="#l2.1562"></a><span id="l2.1562"> // _dispatchData and _dispatchEOF are the internal counterparts that do the</span>
<a href="#l2.1563"></a><span id="l2.1563"> // main work of moving data to where it needs to go; helper functions are used</span>
<a href="#l2.1564"></a><span id="l2.1564"> // to handle translation.</span>
<a href="#l2.1565"></a><span id="l2.1565"> //</span>
<a href="#l2.1566"></a><span id="l2.1566" class="difflineat">@@ -2130,17 +2131,17 @@ var SEND_TO_SUBPARSER = 4;</span>
<a href="#l2.1567"></a><span id="l2.1567">  *</span>
<a href="#l2.1568"></a><span id="l2.1568">  * @param partNum    {String}       The part number being currently parsed.</span>
<a href="#l2.1569"></a><span id="l2.1569">  * @param buffer     {BinaryString} The text (conditioned as mentioned above) to</span>
<a href="#l2.1570"></a><span id="l2.1570">  *                                  pass to the parser.</span>
<a href="#l2.1571"></a><span id="l2.1571">  * @param checkSplit {Boolean}      If true, split the text using _splitRegex.</span>
<a href="#l2.1572"></a><span id="l2.1572">  *                                  This is set to false internally to handle</span>
<a href="#l2.1573"></a><span id="l2.1573">  *                                  low-level splitting details.</span>
<a href="#l2.1574"></a><span id="l2.1574">  */</span>
<a href="#l2.1575"></a><span id="l2.1575" class="difflineminus">-MimeParser.prototype._dispatchData = function (partNum, buffer, checkSplit) {</span>
<a href="#l2.1576"></a><span id="l2.1576" class="difflineplus">+MimeParser.prototype._dispatchData = function(partNum, buffer, checkSplit) {</span>
<a href="#l2.1577"></a><span id="l2.1577">   // Are we parsing headers?</span>
<a href="#l2.1578"></a><span id="l2.1578">   if (this._state == PARSING_HEADERS) {</span>
<a href="#l2.1579"></a><span id="l2.1579">     this._headerData += buffer;</span>
<a href="#l2.1580"></a><span id="l2.1580">     // Find the end of the headers--either it's a CRLF at the beginning (in</span>
<a href="#l2.1581"></a><span id="l2.1581">     // which case we have no headers), or it's a pair of CRLFs.</span>
<a href="#l2.1582"></a><span id="l2.1582">     let result = /(?:^(?:\r\n|[\r\n]))|(\r\n|[\r\n])\1/.exec(this._headerData);</span>
<a href="#l2.1583"></a><span id="l2.1583">     if (result != null) {</span>
<a href="#l2.1584"></a><span id="l2.1584">       // If we found the end of headers, split the data at this point and send</span>
<a href="#l2.1585"></a><span id="l2.1585" class="difflineat">@@ -2177,23 +2178,22 @@ MimeParser.prototype._dispatchData = fun</span>
<a href="#l2.1586"></a><span id="l2.1586">         this._dispatchData(partNum, buffer, true);</span>
<a href="#l2.1587"></a><span id="l2.1587">       return;</span>
<a href="#l2.1588"></a><span id="l2.1588">     }</span>
<a href="#l2.1589"></a><span id="l2.1589">   }</span>
<a href="#l2.1590"></a><span id="l2.1590"> </span>
<a href="#l2.1591"></a><span id="l2.1591">   // Where does the data go?</span>
<a href="#l2.1592"></a><span id="l2.1592">   if (this._state == SEND_TO_BLACK_HOLE) {</span>
<a href="#l2.1593"></a><span id="l2.1593">     // Don't send any data when going to the black hole.</span>
<a href="#l2.1594"></a><span id="l2.1594" class="difflineminus">-    return;</span>
<a href="#l2.1595"></a><span id="l2.1595">   } else if (this._state == SEND_TO_EMITTER) {</span>
<a href="#l2.1596"></a><span id="l2.1596">     // Don't pass body data if the format is to be none</span>
<a href="#l2.1597"></a><span id="l2.1597" class="difflineminus">-    let passData = this._options[&quot;bodyformat&quot;] != &quot;none&quot;;</span>
<a href="#l2.1598"></a><span id="l2.1598" class="difflineplus">+    let passData = this._options.bodyformat != &quot;none&quot;;</span>
<a href="#l2.1599"></a><span id="l2.1599">     if (!passData || this._willIgnorePart(partNum))</span>
<a href="#l2.1600"></a><span id="l2.1600">       return;</span>
<a href="#l2.1601"></a><span id="l2.1601" class="difflineminus">-    buffer = this._applyDataConversion(buffer, this._options[&quot;strformat&quot;]);</span>
<a href="#l2.1602"></a><span id="l2.1602" class="difflineplus">+    buffer = this._applyDataConversion(buffer, this._options.strformat);</span>
<a href="#l2.1603"></a><span id="l2.1603">     if (buffer.length &gt; 0)</span>
<a href="#l2.1604"></a><span id="l2.1604">       this._callEmitter(&quot;deliverPartData&quot;, partNum, buffer);</span>
<a href="#l2.1605"></a><span id="l2.1605">   } else if (this._state == SEND_TO_SUBPARSER) {</span>
<a href="#l2.1606"></a><span id="l2.1606">     buffer = this._applyDataConversion(buffer, &quot;binarystring&quot;);</span>
<a href="#l2.1607"></a><span id="l2.1607">     if (buffer.length &gt; 0)</span>
<a href="#l2.1608"></a><span id="l2.1608">       this._subparser._dispatchData(this._subPartNum, buffer, true);</span>
<a href="#l2.1609"></a><span id="l2.1609">   }</span>
<a href="#l2.1610"></a><span id="l2.1610"> };</span>
<a href="#l2.1611"></a><span id="l2.1611" class="difflineat">@@ -2203,17 +2203,17 @@ MimeParser.prototype._dispatchData = fun</span>
<a href="#l2.1612"></a><span id="l2.1612">  * needs extra data to be saved.</span>
<a href="#l2.1613"></a><span id="l2.1613">  *</span>
<a href="#l2.1614"></a><span id="l2.1614">  * @param buf  {BinaryString} The data to be sent to the output.</span>
<a href="#l2.1615"></a><span id="l2.1615">  * @param type {String}       The type of the data to output. Valid values are</span>
<a href="#l2.1616"></a><span id="l2.1616">  *                            the same as the strformat option.</span>
<a href="#l2.1617"></a><span id="l2.1617">  * @returns Coerced and converted data that can be sent to the emitter or</span>
<a href="#l2.1618"></a><span id="l2.1618">  *          subparser.</span>
<a href="#l2.1619"></a><span id="l2.1619">  */</span>
<a href="#l2.1620"></a><span id="l2.1620" class="difflineminus">-MimeParser.prototype._applyDataConversion = function (buf, type) {</span>
<a href="#l2.1621"></a><span id="l2.1621" class="difflineplus">+MimeParser.prototype._applyDataConversion = function(buf, type) {</span>
<a href="#l2.1622"></a><span id="l2.1622">   // If we need to convert data, do so.</span>
<a href="#l2.1623"></a><span id="l2.1623">   if (this._convertData) {</span>
<a href="#l2.1624"></a><span id="l2.1624">     // Prepend leftover data from the last conversion.</span>
<a href="#l2.1625"></a><span id="l2.1625">     buf = this._savedBuffer + buf;</span>
<a href="#l2.1626"></a><span id="l2.1626">     [buf, this._savedBuffer] = this._convertData(buf, true);</span>
<a href="#l2.1627"></a><span id="l2.1627">   }</span>
<a href="#l2.1628"></a><span id="l2.1628">   return this._coerceData(buf, type, false);</span>
<a href="#l2.1629"></a><span id="l2.1629"> };</span>
<a href="#l2.1630"></a><span id="l2.1630" class="difflineat">@@ -2222,18 +2222,18 @@ MimeParser.prototype._applyDataConversio</span>
<a href="#l2.1631"></a><span id="l2.1631">  * Coerce the input buffer into the given output type.</span>
<a href="#l2.1632"></a><span id="l2.1632">  *</span>
<a href="#l2.1633"></a><span id="l2.1633">  * @param buffer {BinaryString|Uint8Array} The data to be converted.</span>
<a href="#l2.1634"></a><span id="l2.1634">  * @param type   {String}                  The type to convert the data to.</span>
<a href="#l2.1635"></a><span id="l2.1635">  * @param more   {boolean}                 If true, this function will never be</span>
<a href="#l2.1636"></a><span id="l2.1636">  *                                         called again.</span>
<a href="#l2.1637"></a><span id="l2.1637">  * @returns {BinaryString|String|Uint8Array} The desired output format.</span>
<a href="#l2.1638"></a><span id="l2.1638">  */</span>
<a href="#l2.1639"></a><span id="l2.1639" class="difflineminus">-/// Coerces the buffer (a string or typedarray) into a given type</span>
<a href="#l2.1640"></a><span id="l2.1640" class="difflineminus">-MimeParser.prototype._coerceData = function (buffer, type, more) {</span>
<a href="#l2.1641"></a><span id="l2.1641" class="difflineplus">+// Coerces the buffer (a string or typedarray) into a given type</span>
<a href="#l2.1642"></a><span id="l2.1642" class="difflineplus">+MimeParser.prototype._coerceData = function(buffer, type, more) {</span>
<a href="#l2.1643"></a><span id="l2.1643">   if (typeof buffer == &quot;string&quot;) {</span>
<a href="#l2.1644"></a><span id="l2.1644">     // string -&gt; binarystring is a nop</span>
<a href="#l2.1645"></a><span id="l2.1645">     if (type == &quot;binarystring&quot;)</span>
<a href="#l2.1646"></a><span id="l2.1646">       return buffer;</span>
<a href="#l2.1647"></a><span id="l2.1647">     // Either we're going to array or unicode. Both people need the array</span>
<a href="#l2.1648"></a><span id="l2.1648">     var typedarray = mimeutils.stringToTypedArray(buffer);</span>
<a href="#l2.1649"></a><span id="l2.1649">     // If it's unicode, do the coercion from the array</span>
<a href="#l2.1650"></a><span id="l2.1650">     // If its typedarray, just return the synthesized one</span>
<a href="#l2.1651"></a><span id="l2.1651" class="difflineat">@@ -2252,123 +2252,123 @@ MimeParser.prototype._coerceData = funct</span>
<a href="#l2.1652"></a><span id="l2.1652">   throw new Error(&quot;Invalid type: &quot; + type);</span>
<a href="#l2.1653"></a><span id="l2.1653"> };</span>
<a href="#l2.1654"></a><span id="l2.1654"> </span>
<a href="#l2.1655"></a><span id="l2.1655"> /**</span>
<a href="#l2.1656"></a><span id="l2.1656">  * Signal that no more data will be dispatched to this parser.</span>
<a href="#l2.1657"></a><span id="l2.1657">  *</span>
<a href="#l2.1658"></a><span id="l2.1658">  * @param partNum {String} The part number being currently parsed.</span>
<a href="#l2.1659"></a><span id="l2.1659">  */</span>
<a href="#l2.1660"></a><span id="l2.1660" class="difflineminus">-MimeParser.prototype._dispatchEOF = function (partNum) {</span>
<a href="#l2.1661"></a><span id="l2.1661" class="difflineplus">+MimeParser.prototype._dispatchEOF = function(partNum) {</span>
<a href="#l2.1662"></a><span id="l2.1662">   if (this._state == PARSING_HEADERS) {</span>
<a href="#l2.1663"></a><span id="l2.1663">     // Unexpected EOF in headers. Parse them now and call startPart/endPart</span>
<a href="#l2.1664"></a><span id="l2.1664">     this._headers = this._parseHeaders();</span>
<a href="#l2.1665"></a><span id="l2.1665">     this._callEmitter(&quot;startPart&quot;, partNum, this._headers);</span>
<a href="#l2.1666"></a><span id="l2.1666">   } else if (this._state == SEND_TO_SUBPARSER) {</span>
<a href="#l2.1667"></a><span id="l2.1667">     // Pass in any lingering data</span>
<a href="#l2.1668"></a><span id="l2.1668">     if (this._convertData &amp;&amp; this._savedBuffer)</span>
<a href="#l2.1669"></a><span id="l2.1669">       this._subparser._dispatchData(this._subPartNum,</span>
<a href="#l2.1670"></a><span id="l2.1670">         this._convertData(this._savedBuffer, false)[0], true);</span>
<a href="#l2.1671"></a><span id="l2.1671">     this._subparser._dispatchEOF(this._subPartNum);</span>
<a href="#l2.1672"></a><span id="l2.1672">     // Clean up after ourselves</span>
<a href="#l2.1673"></a><span id="l2.1673">     this._subparser = null;</span>
<a href="#l2.1674"></a><span id="l2.1674">   } else if (this._convertData &amp;&amp; this._savedBuffer) {</span>
<a href="#l2.1675"></a><span id="l2.1675">     // Convert lingering data</span>
<a href="#l2.1676"></a><span id="l2.1676" class="difflineminus">-    let [buffer, ] = this._convertData(this._savedBuffer, false);</span>
<a href="#l2.1677"></a><span id="l2.1677" class="difflineminus">-    buffer = this._coerceData(buffer, this._options[&quot;strformat&quot;], false);</span>
<a href="#l2.1678"></a><span id="l2.1678" class="difflineplus">+    let [buffer] = this._convertData(this._savedBuffer, false);</span>
<a href="#l2.1679"></a><span id="l2.1679" class="difflineplus">+    buffer = this._coerceData(buffer, this._options.strformat, false);</span>
<a href="#l2.1680"></a><span id="l2.1680">     if (buffer.length &gt; 0)</span>
<a href="#l2.1681"></a><span id="l2.1681">       this._callEmitter(&quot;deliverPartData&quot;, partNum, buffer);</span>
<a href="#l2.1682"></a><span id="l2.1682">   }</span>
<a href="#l2.1683"></a><span id="l2.1683"> </span>
<a href="#l2.1684"></a><span id="l2.1684">   // We've reached EOF for this part; tell the emitter</span>
<a href="#l2.1685"></a><span id="l2.1685">   this._callEmitter(&quot;endPart&quot;, partNum);</span>
<a href="#l2.1686"></a><span id="l2.1686"> };</span>
<a href="#l2.1687"></a><span id="l2.1687"> </span>
<a href="#l2.1688"></a><span id="l2.1688"> /**</span>
<a href="#l2.1689"></a><span id="l2.1689">  * Produce a dictionary of all headers as if they were unstructured fields.</span>
<a href="#l2.1690"></a><span id="l2.1690">  *</span>
<a href="#l2.1691"></a><span id="l2.1691">  * @returns {StructuredHeaders} The structured header objects for the header</span>
<a href="#l2.1692"></a><span id="l2.1692">  *                              block.</span>
<a href="#l2.1693"></a><span id="l2.1693">  */</span>
<a href="#l2.1694"></a><span id="l2.1694" class="difflineminus">-MimeParser.prototype._parseHeaders = function () {</span>
<a href="#l2.1695"></a><span id="l2.1695" class="difflineplus">+MimeParser.prototype._parseHeaders = function() {</span>
<a href="#l2.1696"></a><span id="l2.1696">   let headers = new StructuredHeaders(this._headerData, this._options);</span>
<a href="#l2.1697"></a><span id="l2.1697"> </span>
<a href="#l2.1698"></a><span id="l2.1698">   // Fill the headers.contentType parameter of headers.</span>
<a href="#l2.1699"></a><span id="l2.1699" class="difflineminus">-  let contentType = headers.get('Content-Type');</span>
<a href="#l2.1700"></a><span id="l2.1700" class="difflineplus">+  let contentType = headers.get(&quot;Content-Type&quot;);</span>
<a href="#l2.1701"></a><span id="l2.1701">   if (typeof contentType === &quot;undefined&quot;) {</span>
<a href="#l2.1702"></a><span id="l2.1702" class="difflineminus">-    contentType = headerparser.parseStructuredHeader('Content-Type',</span>
<a href="#l2.1703"></a><span id="l2.1703" class="difflineminus">-      this._defaultContentType || 'text/plain');</span>
<a href="#l2.1704"></a><span id="l2.1704" class="difflineplus">+    contentType = headerparser.parseStructuredHeader(&quot;Content-Type&quot;,</span>
<a href="#l2.1705"></a><span id="l2.1705" class="difflineplus">+      this._defaultContentType || &quot;text/plain&quot;);</span>
<a href="#l2.1706"></a><span id="l2.1706">     Object.defineProperty(headers, &quot;contentType&quot;, {</span>
<a href="#l2.1707"></a><span id="l2.1707" class="difflineminus">-      get: function () { return contentType; }</span>
<a href="#l2.1708"></a><span id="l2.1708" class="difflineplus">+      get() { return contentType; },</span>
<a href="#l2.1709"></a><span id="l2.1709">     });</span>
<a href="#l2.1710"></a><span id="l2.1710">   } else {</span>
<a href="#l2.1711"></a><span id="l2.1711">     Object.defineProperty(headers, &quot;contentType&quot;, { configurable: false });</span>
<a href="#l2.1712"></a><span id="l2.1712">   }</span>
<a href="#l2.1713"></a><span id="l2.1713"> </span>
<a href="#l2.1714"></a><span id="l2.1714">   // Find the charset for the current part. If the user requested a forced</span>
<a href="#l2.1715"></a><span id="l2.1715">   // conversion, use that first. Otherwise, check the content-type for one and</span>
<a href="#l2.1716"></a><span id="l2.1716">   // fallback to a default if it is not present.</span>
<a href="#l2.1717"></a><span id="l2.1717" class="difflineminus">-  let charset = '';</span>
<a href="#l2.1718"></a><span id="l2.1718" class="difflineplus">+  let charset = &quot;&quot;;</span>
<a href="#l2.1719"></a><span id="l2.1719">   if (this._options[&quot;force-charset&quot;])</span>
<a href="#l2.1720"></a><span id="l2.1720" class="difflineminus">-    charset = this._options[&quot;charset&quot;];</span>
<a href="#l2.1721"></a><span id="l2.1721" class="difflineplus">+    charset = this._options.charset;</span>
<a href="#l2.1722"></a><span id="l2.1722">   else if (contentType.has(&quot;charset&quot;))</span>
<a href="#l2.1723"></a><span id="l2.1723">     charset = contentType.get(&quot;charset&quot;);</span>
<a href="#l2.1724"></a><span id="l2.1724">   else</span>
<a href="#l2.1725"></a><span id="l2.1725" class="difflineminus">-    charset = this._options[&quot;charset&quot;];</span>
<a href="#l2.1726"></a><span id="l2.1726" class="difflineplus">+    charset = this._options.charset;</span>
<a href="#l2.1727"></a><span id="l2.1727">   headers.charset = charset;</span>
<a href="#l2.1728"></a><span id="l2.1728"> </span>
<a href="#l2.1729"></a><span id="l2.1729">   // Retain a copy of the charset so that users don't override our decision for</span>
<a href="#l2.1730"></a><span id="l2.1730">   // decoding body parts.</span>
<a href="#l2.1731"></a><span id="l2.1731">   this._charset = charset;</span>
<a href="#l2.1732"></a><span id="l2.1732">   return headers;</span>
<a href="#l2.1733"></a><span id="l2.1733"> };</span>
<a href="#l2.1734"></a><span id="l2.1734"> </span>
<a href="#l2.1735"></a><span id="l2.1735"> /**</span>
<a href="#l2.1736"></a><span id="l2.1736">  * Initialize the parser state for the body of this message.</span>
<a href="#l2.1737"></a><span id="l2.1737">  *</span>
<a href="#l2.1738"></a><span id="l2.1738">  * @param partNum {String} The part number being currently parsed.</span>
<a href="#l2.1739"></a><span id="l2.1739">  */</span>
<a href="#l2.1740"></a><span id="l2.1740" class="difflineminus">-MimeParser.prototype._startBody = function Parser_startBody(partNum) {</span>
<a href="#l2.1741"></a><span id="l2.1741" class="difflineplus">+MimeParser.prototype._startBody = function(partNum) {</span>
<a href="#l2.1742"></a><span id="l2.1742">   let contentType = this._headers.contentType;</span>
<a href="#l2.1743"></a><span id="l2.1743"> </span>
<a href="#l2.1744"></a><span id="l2.1744">   // Should the bodyformat be raw, we just want to pass through all data without</span>
<a href="#l2.1745"></a><span id="l2.1745">   // trying to interpret it.</span>
<a href="#l2.1746"></a><span id="l2.1746" class="difflineminus">-  if (this._options[&quot;bodyformat&quot;] == &quot;raw&quot; &amp;&amp;</span>
<a href="#l2.1747"></a><span id="l2.1747" class="difflineminus">-      partNum == this._options[&quot;pruneat&quot;]) {</span>
<a href="#l2.1748"></a><span id="l2.1748" class="difflineplus">+  if (this._options.bodyformat == &quot;raw&quot; &amp;&amp;</span>
<a href="#l2.1749"></a><span id="l2.1749" class="difflineplus">+      partNum == this._options.pruneat) {</span>
<a href="#l2.1750"></a><span id="l2.1750">     this._state = SEND_TO_EMITTER;</span>
<a href="#l2.1751"></a><span id="l2.1751">     return;</span>
<a href="#l2.1752"></a><span id="l2.1752">   }</span>
<a href="#l2.1753"></a><span id="l2.1753"> </span>
<a href="#l2.1754"></a><span id="l2.1754">   // The output depents on the content-type. Basic rule of thumb:</span>
<a href="#l2.1755"></a><span id="l2.1755">   // 1. Discrete media types (text, video, audio, image, application) are passed</span>
<a href="#l2.1756"></a><span id="l2.1756">   //    through with no alterations beyond Content-Transfer-Encoding unpacking.</span>
<a href="#l2.1757"></a><span id="l2.1757">   // 2. Everything with a media type of multipart is treated the same.</span>
<a href="#l2.1758"></a><span id="l2.1758">   // 3. Any message/* type that acts like a mail message (rfc822, news, global)</span>
<a href="#l2.1759"></a><span id="l2.1759">   //    is parsed as a header/body pair again. Most of the other message/* types</span>
<a href="#l2.1760"></a><span id="l2.1760">   //    have similar structures, but they don't have cascading child subparts,</span>
<a href="#l2.1761"></a><span id="l2.1761">   //    so it's better to pass their entire contents to the emitter and let the</span>
<a href="#l2.1762"></a><span id="l2.1762">   //    consumer deal with them.</span>
<a href="#l2.1763"></a><span id="l2.1763">   // 4. For untyped data, there needs to be no Content-Type header. This helps</span>
<a href="#l2.1764"></a><span id="l2.1764">   //    avoid false positives.</span>
<a href="#l2.1765"></a><span id="l2.1765" class="difflineminus">-  if (contentType.mediatype == 'multipart') {</span>
<a href="#l2.1766"></a><span id="l2.1766" class="difflineplus">+  if (contentType.mediatype == &quot;multipart&quot;) {</span>
<a href="#l2.1767"></a><span id="l2.1767">     // If there's no boundary type, everything will be part of the prologue of</span>
<a href="#l2.1768"></a><span id="l2.1768">     // the multipart message, so just feed everything into a black hole.</span>
<a href="#l2.1769"></a><span id="l2.1769" class="difflineminus">-    if (!contentType.has('boundary')) {</span>
<a href="#l2.1770"></a><span id="l2.1770" class="difflineplus">+    if (!contentType.has(&quot;boundary&quot;)) {</span>
<a href="#l2.1771"></a><span id="l2.1771">       this._state = SEND_TO_BLACK_HOLE;</span>
<a href="#l2.1772"></a><span id="l2.1772">       return;</span>
<a href="#l2.1773"></a><span id="l2.1773">     }</span>
<a href="#l2.1774"></a><span id="l2.1774">     // The boundary of a multipart message needs to start with -- and be at the</span>
<a href="#l2.1775"></a><span id="l2.1775">     // beginning of the line. If -- is after the boundary, it represents the</span>
<a href="#l2.1776"></a><span id="l2.1776">     // terminator of the multipart. After the line, there may be only whitespace</span>
<a href="#l2.1777"></a><span id="l2.1777">     // and then the CRLF at the end. Since the CRLFs in here are necessary for</span>
<a href="#l2.1778"></a><span id="l2.1778">     // distinguishing the parts, they are not included in the subparts, so we</span>
<a href="#l2.1779"></a><span id="l2.1779">     // need to capture them in the regex as well to prevent them leaking out.</span>
<a href="#l2.1780"></a><span id="l2.1780" class="difflineminus">-    this._splitRegex = new RegExp('(\r\n|[\r\n]|^)--' +</span>
<a href="#l2.1781"></a><span id="l2.1781" class="difflineminus">-      contentType.get('boundary').replace(/[\\^$*+?.()|{}[\]]/g, '\\$&amp;') +</span>
<a href="#l2.1782"></a><span id="l2.1782" class="difflineminus">-      '(--)?[ \t]*(?:\r\n|[\r\n]|$)');</span>
<a href="#l2.1783"></a><span id="l2.1783" class="difflineplus">+    this._splitRegex = new RegExp(&quot;(\r\n|[\r\n]|^)--&quot; +</span>
<a href="#l2.1784"></a><span id="l2.1784" class="difflineplus">+      contentType.get(&quot;boundary&quot;).replace(/[\\^$*+?.()|{}[\]]/g, &quot;\\$&amp;&quot;) +</span>
<a href="#l2.1785"></a><span id="l2.1785" class="difflineplus">+      &quot;(--)?[ \t]*(?:\r\n|[\r\n]|$)&quot;);</span>
<a href="#l2.1786"></a><span id="l2.1786">     this._handleSplit = this._whenMultipart;</span>
<a href="#l2.1787"></a><span id="l2.1787">     this._subparser = new MimeParser(this._emitter, this._options);</span>
<a href="#l2.1788"></a><span id="l2.1788">     // multipart/digest defaults to message/rfc822 instead of text/plain</span>
<a href="#l2.1789"></a><span id="l2.1789">     if (contentType.subtype == &quot;digest&quot;)</span>
<a href="#l2.1790"></a><span id="l2.1790">       this._subparser._defaultContentType = &quot;message/rfc822&quot;;</span>
<a href="#l2.1791"></a><span id="l2.1791"> </span>
<a href="#l2.1792"></a><span id="l2.1792">     // All text before the first boundary and after the closing boundary are</span>
<a href="#l2.1793"></a><span id="l2.1793">     // supposed to be ignored (&quot;must be ignored&quot;, according to RFC 2046 §5.1.1);</span>
<a href="#l2.1794"></a><span id="l2.1794" class="difflineat">@@ -2376,114 +2376,114 @@ MimeParser.prototype._startBody = functi</span>
<a href="#l2.1795"></a><span id="l2.1795">     // deliverPartData.</span>
<a href="#l2.1796"></a><span id="l2.1796">     this._state = SEND_TO_BLACK_HOLE;</span>
<a href="#l2.1797"></a><span id="l2.1797"> </span>
<a href="#l2.1798"></a><span id="l2.1798">     // Multipart MIME messages stipulate that the final CRLF before the boundary</span>
<a href="#l2.1799"></a><span id="l2.1799">     // delimiter is not matched. When the packet ends on a CRLF, we don't know</span>
<a href="#l2.1800"></a><span id="l2.1800">     // if the next text could be the boundary. Therefore, we need to withhold</span>
<a href="#l2.1801"></a><span id="l2.1801">     // the last line of text to be sure of what's going on. The _convertData is</span>
<a href="#l2.1802"></a><span id="l2.1802">     // how we do this, even though we're not really converting any data.</span>
<a href="#l2.1803"></a><span id="l2.1803" class="difflineminus">-    this._convertData = function mpart_no_leak_crlf(buffer, more) {</span>
<a href="#l2.1804"></a><span id="l2.1804" class="difflineplus">+    this._convertData = function(buffer, more) {</span>
<a href="#l2.1805"></a><span id="l2.1805">       let splitPoint = buffer.length;</span>
<a href="#l2.1806"></a><span id="l2.1806">       if (more) {</span>
<a href="#l2.1807"></a><span id="l2.1807" class="difflineminus">-        if (buffer.charAt(splitPoint - 1) == '\n')</span>
<a href="#l2.1808"></a><span id="l2.1808" class="difflineplus">+        if (buffer.charAt(splitPoint - 1) == &quot;\n&quot;)</span>
<a href="#l2.1809"></a><span id="l2.1809">           splitPoint--;</span>
<a href="#l2.1810"></a><span id="l2.1810" class="difflineminus">-        if (splitPoint &gt;= 0 &amp;&amp; buffer.charAt(splitPoint - 1) == '\r')</span>
<a href="#l2.1811"></a><span id="l2.1811" class="difflineplus">+        if (splitPoint &gt;= 0 &amp;&amp; buffer.charAt(splitPoint - 1) == &quot;\r&quot;)</span>
<a href="#l2.1812"></a><span id="l2.1812">           splitPoint--;</span>
<a href="#l2.1813"></a><span id="l2.1813">       }</span>
<a href="#l2.1814"></a><span id="l2.1814">       let res = conditionToEndOnCRLF(buffer.substring(0, splitPoint));</span>
<a href="#l2.1815"></a><span id="l2.1815">       let preLF = res[0];</span>
<a href="#l2.1816"></a><span id="l2.1816">       let rest = res[1];</span>
<a href="#l2.1817"></a><span id="l2.1817">       return [preLF, rest + buffer.substring(splitPoint)];</span>
<a href="#l2.1818"></a><span id="l2.1818" class="difflineminus">-    }</span>
<a href="#l2.1819"></a><span id="l2.1819" class="difflineminus">-  } else if (contentType.type == 'message/rfc822' ||</span>
<a href="#l2.1820"></a><span id="l2.1820" class="difflineminus">-      contentType.type == 'message/global' ||</span>
<a href="#l2.1821"></a><span id="l2.1821" class="difflineminus">-      contentType.type == 'message/news') {</span>
<a href="#l2.1822"></a><span id="l2.1822" class="difflineplus">+    };</span>
<a href="#l2.1823"></a><span id="l2.1823" class="difflineplus">+  } else if (contentType.type == &quot;message/rfc822&quot; ||</span>
<a href="#l2.1824"></a><span id="l2.1824" class="difflineplus">+      contentType.type == &quot;message/global&quot; ||</span>
<a href="#l2.1825"></a><span id="l2.1825" class="difflineplus">+      contentType.type == &quot;message/news&quot;) {</span>
<a href="#l2.1826"></a><span id="l2.1826">     // The subpart is just another header/body pair that goes to EOF, so just</span>
<a href="#l2.1827"></a><span id="l2.1827">     // return the parse from that blob</span>
<a href="#l2.1828"></a><span id="l2.1828">     this._state = SEND_TO_SUBPARSER;</span>
<a href="#l2.1829"></a><span id="l2.1829">     this._subPartNum = partNum + &quot;$&quot;;</span>
<a href="#l2.1830"></a><span id="l2.1830">     this._subparser = new MimeParser(this._emitter, this._options);</span>
<a href="#l2.1831"></a><span id="l2.1831"> </span>
<a href="#l2.1832"></a><span id="l2.1832">     // So, RFC 6532 happily allows message/global types to have CTE applied.</span>
<a href="#l2.1833"></a><span id="l2.1833">     // This means that subparts would need to be decoded to determine their</span>
<a href="#l2.1834"></a><span id="l2.1834">     // contents properly. There seems to be some evidence that message/rfc822</span>
<a href="#l2.1835"></a><span id="l2.1835">     // that is illegally-encoded exists in the wild, so be lenient and decode</span>
<a href="#l2.1836"></a><span id="l2.1836">     // for any message/* type that gets here.</span>
<a href="#l2.1837"></a><span id="l2.1837" class="difflineminus">-    let cte = this._extractHeader('content-transfer-encoding', '');</span>
<a href="#l2.1838"></a><span id="l2.1838" class="difflineplus">+    let cte = this._extractHeader(&quot;content-transfer-encoding&quot;, &quot;&quot;);</span>
<a href="#l2.1839"></a><span id="l2.1839">     if (cte in ContentDecoders)</span>
<a href="#l2.1840"></a><span id="l2.1840">       this._convertData = ContentDecoders[cte];</span>
<a href="#l2.1841"></a><span id="l2.1841">   } else {</span>
<a href="#l2.1842"></a><span id="l2.1842">     // Okay, we just have to feed the data into the output</span>
<a href="#l2.1843"></a><span id="l2.1843">     this._state = SEND_TO_EMITTER;</span>
<a href="#l2.1844"></a><span id="l2.1844" class="difflineminus">-    if (this._options[&quot;bodyformat&quot;] == &quot;decode&quot;) {</span>
<a href="#l2.1845"></a><span id="l2.1845" class="difflineplus">+    if (this._options.bodyformat == &quot;decode&quot;) {</span>
<a href="#l2.1846"></a><span id="l2.1846">       // If we wish to decode, look it up in one of our decoders.</span>
<a href="#l2.1847"></a><span id="l2.1847" class="difflineminus">-      let cte = this._extractHeader('content-transfer-encoding', '');</span>
<a href="#l2.1848"></a><span id="l2.1848" class="difflineplus">+      let cte = this._extractHeader(&quot;content-transfer-encoding&quot;, &quot;&quot;);</span>
<a href="#l2.1849"></a><span id="l2.1849">       if (cte in ContentDecoders)</span>
<a href="#l2.1850"></a><span id="l2.1850">         this._convertData = ContentDecoders[cte];</span>
<a href="#l2.1851"></a><span id="l2.1851">     }</span>
<a href="#l2.1852"></a><span id="l2.1852">   }</span>
<a href="#l2.1853"></a><span id="l2.1853"> </span>
<a href="#l2.1854"></a><span id="l2.1854">   // Set up the encoder for charset conversions; only do this for text parts.</span>
<a href="#l2.1855"></a><span id="l2.1855">   // Other parts are almost certainly binary, so no translation should be</span>
<a href="#l2.1856"></a><span id="l2.1856">   // applied to them.</span>
<a href="#l2.1857"></a><span id="l2.1857" class="difflineminus">-  if (this._options[&quot;strformat&quot;] == &quot;unicode&quot; &amp;&amp;</span>
<a href="#l2.1858"></a><span id="l2.1858" class="difflineplus">+  if (this._options.strformat == &quot;unicode&quot; &amp;&amp;</span>
<a href="#l2.1859"></a><span id="l2.1859">       contentType.mediatype == &quot;text&quot;) {</span>
<a href="#l2.1860"></a><span id="l2.1860">     // If the charset is nonempty, initialize the decoder</span>
<a href="#l2.1861"></a><span id="l2.1861">     if (this._charset !== &quot;&quot;) {</span>
<a href="#l2.1862"></a><span id="l2.1862">       this._decoder = new MimeTextDecoder(this._charset);</span>
<a href="#l2.1863"></a><span id="l2.1863">     } else {</span>
<a href="#l2.1864"></a><span id="l2.1864">       // There's no charset we can use for decoding, so pass through as an</span>
<a href="#l2.1865"></a><span id="l2.1865">       // identity encoder or otherwise this._coerceData will complain.</span>
<a href="#l2.1866"></a><span id="l2.1866">       this._decoder = {</span>
<a href="#l2.1867"></a><span id="l2.1867" class="difflineminus">-        decode: function identity_decoder(buffer) {</span>
<a href="#l2.1868"></a><span id="l2.1868" class="difflineplus">+        decode(buffer) {</span>
<a href="#l2.1869"></a><span id="l2.1869">           return MimeParser.prototype._coerceData(buffer, &quot;binarystring&quot;, true);</span>
<a href="#l2.1870"></a><span id="l2.1870" class="difflineminus">-        }</span>
<a href="#l2.1871"></a><span id="l2.1871" class="difflineplus">+        },</span>
<a href="#l2.1872"></a><span id="l2.1872">       };</span>
<a href="#l2.1873"></a><span id="l2.1873">     }</span>
<a href="#l2.1874"></a><span id="l2.1874">   } else {</span>
<a href="#l2.1875"></a><span id="l2.1875">     this._decoder = null;</span>
<a href="#l2.1876"></a><span id="l2.1876">   }</span>
<a href="#l2.1877"></a><span id="l2.1877"> };</span>
<a href="#l2.1878"></a><span id="l2.1878"> </span>
<a href="#l2.1879"></a><span id="l2.1879"> // Internal split handling for multipart messages.</span>
<a href="#l2.1880"></a><span id="l2.1880"> /**</span>
<a href="#l2.1881"></a><span id="l2.1881">  * When a multipary boundary is found, handle the process of managing the</span>
<a href="#l2.1882"></a><span id="l2.1882">  * subparser state. This is meant to be used as a value for this._handleSplit.</span>
<a href="#l2.1883"></a><span id="l2.1883">  *</span>
<a href="#l2.1884"></a><span id="l2.1884">  * @param partNum    {String} The part number being currently parsed.</span>
<a href="#l2.1885"></a><span id="l2.1885">  * @param lastResult {Array}  The result of the regular expression match.</span>
<a href="#l2.1886"></a><span id="l2.1886">  */</span>
<a href="#l2.1887"></a><span id="l2.1887" class="difflineminus">-MimeParser.prototype._whenMultipart = function (partNum, lastResult) {</span>
<a href="#l2.1888"></a><span id="l2.1888" class="difflineplus">+MimeParser.prototype._whenMultipart = function(partNum, lastResult) {</span>
<a href="#l2.1889"></a><span id="l2.1889">   // Fix up the part number (don't do '' -&gt; '.4' and don't do '1' -&gt; '14')</span>
<a href="#l2.1890"></a><span id="l2.1890">   if (partNum != &quot;&quot;) partNum += &quot;.&quot;;</span>
<a href="#l2.1891"></a><span id="l2.1891">   if (!this._subPartNum) {</span>
<a href="#l2.1892"></a><span id="l2.1892">     // No count? This means that this is the first time we've seen the boundary,</span>
<a href="#l2.1893"></a><span id="l2.1893">     // so do some initialization for later here.</span>
<a href="#l2.1894"></a><span id="l2.1894">     this._count = 1;</span>
<a href="#l2.1895"></a><span id="l2.1895">   } else {</span>
<a href="#l2.1896"></a><span id="l2.1896">     // If we did not match a CRLF at the beginning of the line, strip CRLF from</span>
<a href="#l2.1897"></a><span id="l2.1897">     // the saved buffer. We do this in the else block because it is not</span>
<a href="#l2.1898"></a><span id="l2.1898">     // necessary for the prologue, since that gets ignored anyways.</span>
<a href="#l2.1899"></a><span id="l2.1899" class="difflineminus">-    if (this._savedBuffer != '' &amp;&amp; lastResult[1] === '') {</span>
<a href="#l2.1900"></a><span id="l2.1900" class="difflineplus">+    if (this._savedBuffer != &quot;&quot; &amp;&amp; lastResult[1] === &quot;&quot;) {</span>
<a href="#l2.1901"></a><span id="l2.1901">       let useEnd = this._savedBuffer.length - 1;</span>
<a href="#l2.1902"></a><span id="l2.1902" class="difflineminus">-      if (this._savedBuffer[useEnd] == '\n')</span>
<a href="#l2.1903"></a><span id="l2.1903" class="difflineplus">+      if (this._savedBuffer[useEnd] == &quot;\n&quot;)</span>
<a href="#l2.1904"></a><span id="l2.1904">         useEnd--;</span>
<a href="#l2.1905"></a><span id="l2.1905" class="difflineminus">-      if (useEnd &gt;= 0 &amp;&amp; this._savedBuffer[useEnd] == '\r')</span>
<a href="#l2.1906"></a><span id="l2.1906" class="difflineplus">+      if (useEnd &gt;= 0 &amp;&amp; this._savedBuffer[useEnd] == &quot;\r&quot;)</span>
<a href="#l2.1907"></a><span id="l2.1907">         useEnd--;</span>
<a href="#l2.1908"></a><span id="l2.1908">       this._savedBuffer = this._savedBuffer.substring(0, useEnd + 1);</span>
<a href="#l2.1909"></a><span id="l2.1909">     }</span>
<a href="#l2.1910"></a><span id="l2.1910">     // If we have saved data and we matched a CRLF, pass the saved data in.</span>
<a href="#l2.1911"></a><span id="l2.1911" class="difflineminus">-    if (this._savedBuffer != '')</span>
<a href="#l2.1912"></a><span id="l2.1912" class="difflineplus">+    if (this._savedBuffer != &quot;&quot;)</span>
<a href="#l2.1913"></a><span id="l2.1913">       this._subparser._dispatchData(this._subPartNum, this._savedBuffer, true);</span>
<a href="#l2.1914"></a><span id="l2.1914">     // We've seen the boundary at least once before, so this must end a subpart.</span>
<a href="#l2.1915"></a><span id="l2.1915">     // Tell that subpart that it has reached EOF.</span>
<a href="#l2.1916"></a><span id="l2.1916">     this._subparser._dispatchEOF(this._subPartNum);</span>
<a href="#l2.1917"></a><span id="l2.1917">   }</span>
<a href="#l2.1918"></a><span id="l2.1918" class="difflineminus">-  this._savedBuffer = '';</span>
<a href="#l2.1919"></a><span id="l2.1919" class="difflineplus">+  this._savedBuffer = &quot;&quot;;</span>
<a href="#l2.1920"></a><span id="l2.1920"> </span>
<a href="#l2.1921"></a><span id="l2.1921">   // The regex feeder has a capture on the (--)?, so if its result is present,</span>
<a href="#l2.1922"></a><span id="l2.1922">   // then we have seen the terminator. Alternatively, the message may have been</span>
<a href="#l2.1923"></a><span id="l2.1923">   // mangled to exclude the terminator, so also check if EOF has occurred.</span>
<a href="#l2.1924"></a><span id="l2.1924">   if (lastResult[2] == undefined) {</span>
<a href="#l2.1925"></a><span id="l2.1925">     this._subparser.resetParser();</span>
<a href="#l2.1926"></a><span id="l2.1926">     this._state = SEND_TO_SUBPARSER;</span>
<a href="#l2.1927"></a><span id="l2.1927">     this._subPartNum = partNum + this._count;</span>
<a href="#l2.1928"></a><span id="l2.1928" class="difflineat">@@ -2498,51 +2498,51 @@ MimeParser.prototype._whenMultipart = fu</span>
<a href="#l2.1929"></a><span id="l2.1929"> /**</span>
<a href="#l2.1930"></a><span id="l2.1930">  * Return the structured header from the current header block, or a default if</span>
<a href="#l2.1931"></a><span id="l2.1931">  * it is not present.</span>
<a href="#l2.1932"></a><span id="l2.1932">  *</span>
<a href="#l2.1933"></a><span id="l2.1933">  * @param name {String} The header name to get.</span>
<a href="#l2.1934"></a><span id="l2.1934">  * @param dflt {String} The default MIME value of the header.</span>
<a href="#l2.1935"></a><span id="l2.1935">  * @returns The structured representation of the header.</span>
<a href="#l2.1936"></a><span id="l2.1936">  */</span>
<a href="#l2.1937"></a><span id="l2.1937" class="difflineminus">-MimeParser.prototype._extractHeader = function (name, dflt) {</span>
<a href="#l2.1938"></a><span id="l2.1938" class="difflineplus">+MimeParser.prototype._extractHeader = function(name, dflt) {</span>
<a href="#l2.1939"></a><span id="l2.1939">   name = name.toLowerCase(); // Normalize name</span>
<a href="#l2.1940"></a><span id="l2.1940">   return this._headers.has(name) ? this._headers.get(name) :</span>
<a href="#l2.1941"></a><span id="l2.1941">     headerparser.parseStructuredHeader(name, [dflt]);</span>
<a href="#l2.1942"></a><span id="l2.1942"> };</span>
<a href="#l2.1943"></a><span id="l2.1943"> </span>
<a href="#l2.1944"></a><span id="l2.1944"> var ContentDecoders = {};</span>
<a href="#l2.1945"></a><span id="l2.1945" class="difflineminus">-ContentDecoders['quoted-printable'] = mimeutils.decode_qp;</span>
<a href="#l2.1946"></a><span id="l2.1946" class="difflineminus">-ContentDecoders['base64'] = mimeutils.decode_base64;</span>
<a href="#l2.1947"></a><span id="l2.1947" class="difflineplus">+ContentDecoders[&quot;quoted-printable&quot;] = mimeutils.decode_qp;</span>
<a href="#l2.1948"></a><span id="l2.1948" class="difflineplus">+ContentDecoders.base64 = mimeutils.decode_base64;</span>
<a href="#l2.1949"></a><span id="l2.1949"> </span>
<a href="#l2.1950"></a><span id="l2.1950"> return MimeParser;</span>
<a href="#l2.1951"></a><span id="l2.1951"> });</span>
<a href="#l2.1952"></a><span id="l2.1952" class="difflineminus">-def('headeremitter', function(require) {</span>
<a href="#l2.1953"></a><span id="l2.1953" class="difflineplus">+def(&quot;headeremitter&quot;, function(require) {</span>
<a href="#l2.1954"></a><span id="l2.1954"> /**</span>
<a href="#l2.1955"></a><span id="l2.1955">  * This module implements the code for emitting structured representations of</span>
<a href="#l2.1956"></a><span id="l2.1956">  * MIME headers into their encoded forms. The code here is a companion to,</span>
<a href="#l2.1957"></a><span id="l2.1957">  * but completely independent of, jsmime.headerparser: the structured</span>
<a href="#l2.1958"></a><span id="l2.1958">  * representations that are used as input to the functions in this file are the</span>
<a href="#l2.1959"></a><span id="l2.1959">  * same forms that would be parsed.</span>
<a href="#l2.1960"></a><span id="l2.1960">  */</span>
<a href="#l2.1961"></a><span id="l2.1961"> </span>
<a href="#l2.1962"></a><span id="l2.1962"> &quot;use strict&quot;;</span>
<a href="#l2.1963"></a><span id="l2.1963"> </span>
<a href="#l2.1964"></a><span id="l2.1964" class="difflineminus">-var mimeutils = require('./mimeutils');</span>
<a href="#l2.1965"></a><span id="l2.1965" class="difflineplus">+var mimeutils = require(&quot;./mimeutils&quot;);</span>
<a href="#l2.1966"></a><span id="l2.1966"> </span>
<a href="#l2.1967"></a><span id="l2.1967"> // Get the default structured encoders and add them to the map</span>
<a href="#l2.1968"></a><span id="l2.1968" class="difflineminus">-var structuredHeaders = require('./structuredHeaders');</span>
<a href="#l2.1969"></a><span id="l2.1969" class="difflineplus">+var structuredHeaders = require(&quot;./structuredHeaders&quot;);</span>
<a href="#l2.1970"></a><span id="l2.1970"> var encoders = new Map();</span>
<a href="#l2.1971"></a><span id="l2.1971"> var preferredSpellings = structuredHeaders.spellings;</span>
<a href="#l2.1972"></a><span id="l2.1972"> for (let [header, encoder] of structuredHeaders.encoders) {</span>
<a href="#l2.1973"></a><span id="l2.1973">   addStructuredEncoder(header, encoder);</span>
<a href="#l2.1974"></a><span id="l2.1974"> }</span>
<a href="#l2.1975"></a><span id="l2.1975"> </span>
<a href="#l2.1976"></a><span id="l2.1976" class="difflineminus">-/// Clamp a value in the range [min, max], defaulting to def</span>
<a href="#l2.1977"></a><span id="l2.1977" class="difflineminus">-/// if the object[property] does not contain the value.</span>
<a href="#l2.1978"></a><span id="l2.1978" class="difflineplus">+// Clamp a value in the range [min, max], defaulting to def</span>
<a href="#l2.1979"></a><span id="l2.1979" class="difflineplus">+// if the object[property] does not contain the value.</span>
<a href="#l2.1980"></a><span id="l2.1980"> function clamp(object, property, min, max, def) {</span>
<a href="#l2.1981"></a><span id="l2.1981">   if (!(property in object))</span>
<a href="#l2.1982"></a><span id="l2.1982">     return def;</span>
<a href="#l2.1983"></a><span id="l2.1983">   let value = object[property];</span>
<a href="#l2.1984"></a><span id="l2.1984">   if (value &lt; min)</span>
<a href="#l2.1985"></a><span id="l2.1985">     return min;</span>
<a href="#l2.1986"></a><span id="l2.1986">   if (value &gt; max)</span>
<a href="#l2.1987"></a><span id="l2.1987">     return max;</span>
<a href="#l2.1988"></a><span id="l2.1988" class="difflineat">@@ -2588,19 +2588,19 @@ function clamp(object, property, min, ma</span>
<a href="#l2.1989"></a><span id="l2.1989">  *     The maximum number of logical characters that can be included in a line,</span>
<a href="#l2.1990"></a><span id="l2.1990">  *     not including the final CRLF pair. If this count would be exceeded, then</span>
<a href="#l2.1991"></a><span id="l2.1991">  *     an error will be thrown and encoding will not be possible.</span>
<a href="#l2.1992"></a><span id="l2.1992">  *   @param [options.useASCII=true] {Boolean}</span>
<a href="#l2.1993"></a><span id="l2.1993">  *     If true, then RFC 2047 and RFC 2231 encoding of headers will be performed</span>
<a href="#l2.1994"></a><span id="l2.1994">  *     as needed to retain headers as ASCII.</span>
<a href="#l2.1995"></a><span id="l2.1995">  */</span>
<a href="#l2.1996"></a><span id="l2.1996"> function HeaderEmitter(handler, options) {</span>
<a href="#l2.1997"></a><span id="l2.1997" class="difflineminus">-  /// The inferred value of options.useASCII</span>
<a href="#l2.1998"></a><span id="l2.1998" class="difflineplus">+  // The inferred value of options.useASCII</span>
<a href="#l2.1999"></a><span id="l2.1999">   this._useASCII = options.useASCII === undefined ? true : options.useASCII;</span>
<a href="#l2.2000"></a><span id="l2.2000" class="difflineminus">-  /// The handler to use.</span>
<a href="#l2.2001"></a><span id="l2.2001" class="difflineplus">+  // The handler to use.</span>
<a href="#l2.2002"></a><span id="l2.2002">   this._handler = handler;</span>
<a href="#l2.2003"></a><span id="l2.2003">   /**</span>
<a href="#l2.2004"></a><span id="l2.2004">    * The current line being built; note that we may insert a line break in the</span>
<a href="#l2.2005"></a><span id="l2.2005">    * middle to keep under the maximum line length.</span>
<a href="#l2.2006"></a><span id="l2.2006">    *</span>
<a href="#l2.2007"></a><span id="l2.2007">    * @type String</span>
<a href="#l2.2008"></a><span id="l2.2008">    * @private</span>
<a href="#l2.2009"></a><span id="l2.2009">    */</span>
<a href="#l2.2010"></a><span id="l2.2010" class="difflineat">@@ -2622,19 +2622,18 @@ function HeaderEmitter(handler, options)</span>
<a href="#l2.2011"></a><span id="l2.2011">    *</span>
<a href="#l2.2012"></a><span id="l2.2012">    * @type Integer</span>
<a href="#l2.2013"></a><span id="l2.2013">    * @private</span>
<a href="#l2.2014"></a><span id="l2.2014">    */</span>
<a href="#l2.2015"></a><span id="l2.2015">   this._preferredBreakpoint = 0;</span>
<a href="#l2.2016"></a><span id="l2.2016"> }</span>
<a href="#l2.2017"></a><span id="l2.2017"> </span>
<a href="#l2.2018"></a><span id="l2.2018"> </span>
<a href="#l2.2019"></a><span id="l2.2019" class="difflineminus">-///////////////////////</span>
<a href="#l2.2020"></a><span id="l2.2020" class="difflineminus">-// Low-level methods //</span>
<a href="#l2.2021"></a><span id="l2.2021" class="difflineminus">-///////////////////////</span>
<a href="#l2.2022"></a><span id="l2.2022" class="difflineplus">+// Low-level methods</span>
<a href="#l2.2023"></a><span id="l2.2023" class="difflineplus">+// -----------------</span>
<a href="#l2.2024"></a><span id="l2.2024"> </span>
<a href="#l2.2025"></a><span id="l2.2025"> // Explanation of the emitter internals:</span>
<a href="#l2.2026"></a><span id="l2.2026"> // RFC 5322 requires that we wrap our lines, ideally at 78 characters and at</span>
<a href="#l2.2027"></a><span id="l2.2027"> // least by 998 octets. We can't wrap in arbitrary places, but wherever CFWS is</span>
<a href="#l2.2028"></a><span id="l2.2028"> // valid... and ideally wherever clients are likely to expect it. In theory, we</span>
<a href="#l2.2029"></a><span id="l2.2029"> // can break between every token (this is how RFC 822 operates), but, in RFC</span>
<a href="#l2.2030"></a><span id="l2.2030"> // 5322, many of those breaks are relegated to obsolete productions, mostly</span>
<a href="#l2.2031"></a><span id="l2.2031"> // because it is common to not properly handle breaks in those locations.</span>
<a href="#l2.2032"></a><span id="l2.2032" class="difflineat">@@ -2671,58 +2670,55 @@ function HeaderEmitter(handler, options)</span>
<a href="#l2.2033"></a><span id="l2.2033">  * value being emitted is done and therefore we should not send a continuation</span>
<a href="#l2.2034"></a><span id="l2.2034">  * space. Otherwise, we presume that we're still working, so we will send the</span>
<a href="#l2.2035"></a><span id="l2.2035">  * continuation space.</span>
<a href="#l2.2036"></a><span id="l2.2036">  *</span>
<a href="#l2.2037"></a><span id="l2.2037">  * @private</span>
<a href="#l2.2038"></a><span id="l2.2038">  * @param [count] {Integer} The number of characters in the current line to</span>
<a href="#l2.2039"></a><span id="l2.2039">  *   include before wrapping.</span>
<a href="#l2.2040"></a><span id="l2.2040">  */</span>
<a href="#l2.2041"></a><span id="l2.2041" class="difflineminus">-HeaderEmitter.prototype._commitLine = function (count) {</span>
<a href="#l2.2042"></a><span id="l2.2042" class="difflineplus">+HeaderEmitter.prototype._commitLine = function(count) {</span>
<a href="#l2.2043"></a><span id="l2.2043">   let isContinuing = typeof count !== &quot;undefined&quot;;</span>
<a href="#l2.2044"></a><span id="l2.2044"> </span>
<a href="#l2.2045"></a><span id="l2.2045">   // Split at the point, and lop off whitespace immediately before and after.</span>
<a href="#l2.2046"></a><span id="l2.2046" class="difflineplus">+  let firstN, lastN;</span>
<a href="#l2.2047"></a><span id="l2.2047">   if (isContinuing) {</span>
<a href="#l2.2048"></a><span id="l2.2048" class="difflineminus">-    var firstN = this._currentLine.slice(0, count).trimRight();</span>
<a href="#l2.2049"></a><span id="l2.2049" class="difflineminus">-    var lastN = this._currentLine.slice(count).trimLeft();</span>
<a href="#l2.2050"></a><span id="l2.2050" class="difflineplus">+    firstN = this._currentLine.slice(0, count).trimRight();</span>
<a href="#l2.2051"></a><span id="l2.2051" class="difflineplus">+    lastN = this._currentLine.slice(count).trimLeft();</span>
<a href="#l2.2052"></a><span id="l2.2052">   } else {</span>
<a href="#l2.2053"></a><span id="l2.2053" class="difflineminus">-    var firstN = this._currentLine.trimRight();</span>
<a href="#l2.2054"></a><span id="l2.2054" class="difflineminus">-    var lastN = &quot;&quot;;</span>
<a href="#l2.2055"></a><span id="l2.2055" class="difflineplus">+    firstN = this._currentLine.trimRight();</span>
<a href="#l2.2056"></a><span id="l2.2056" class="difflineplus">+    lastN = &quot;&quot;;</span>
<a href="#l2.2057"></a><span id="l2.2057">   }</span>
<a href="#l2.2058"></a><span id="l2.2058"> </span>
<a href="#l2.2059"></a><span id="l2.2059" class="difflineminus">-  // How many characters do we need to shift preferred/emergency breakpoints?</span>
<a href="#l2.2060"></a><span id="l2.2060" class="difflineminus">-  let shift = this._currentLine.length - lastN.length;</span>
<a href="#l2.2061"></a><span id="l2.2061" class="difflineminus">-</span>
<a href="#l2.2062"></a><span id="l2.2062">   // Send the line plus the final CRLF.</span>
<a href="#l2.2063"></a><span id="l2.2063" class="difflineminus">-  this._handler.deliverData(firstN + '\r\n');</span>
<a href="#l2.2064"></a><span id="l2.2064" class="difflineplus">+  this._handler.deliverData(firstN + &quot;\r\n&quot;);</span>
<a href="#l2.2065"></a><span id="l2.2065"> </span>
<a href="#l2.2066"></a><span id="l2.2066">   // Fill the start of the line with the new data.</span>
<a href="#l2.2067"></a><span id="l2.2067">   this._currentLine = lastN;</span>
<a href="#l2.2068"></a><span id="l2.2068"> </span>
<a href="#l2.2069"></a><span id="l2.2069">   // If this is a continuation, add an extra space at the beginning of the line.</span>
<a href="#l2.2070"></a><span id="l2.2070">   // Adjust the breakpoint shift amount as well.</span>
<a href="#l2.2071"></a><span id="l2.2071">   if (isContinuing) {</span>
<a href="#l2.2072"></a><span id="l2.2072" class="difflineminus">-    this._currentLine = ' ' + this._currentLine;</span>
<a href="#l2.2073"></a><span id="l2.2073" class="difflineminus">-    shift++;</span>
<a href="#l2.2074"></a><span id="l2.2074" class="difflineplus">+    this._currentLine = &quot; &quot; + this._currentLine;</span>
<a href="#l2.2075"></a><span id="l2.2075">   }</span>
<a href="#l2.2076"></a><span id="l2.2076"> </span>
<a href="#l2.2077"></a><span id="l2.2077">   // We will always break at a point at or after the _preferredBreakpoint, if it</span>
<a href="#l2.2078"></a><span id="l2.2078">   // exists, so this always gets reset to 0.</span>
<a href="#l2.2079"></a><span id="l2.2079">   this._preferredBreakpoint = 0;</span>
<a href="#l2.2080"></a><span id="l2.2080"> };</span>
<a href="#l2.2081"></a><span id="l2.2081"> </span>
<a href="#l2.2082"></a><span id="l2.2082"> /**</span>
<a href="#l2.2083"></a><span id="l2.2083">  * Reserve at least length characters in the current line. If there aren't</span>
<a href="#l2.2084"></a><span id="l2.2084">  * enough characters, insert a line break.</span>
<a href="#l2.2085"></a><span id="l2.2085">  *</span>
<a href="#l2.2086"></a><span id="l2.2086">  * @private</span>
<a href="#l2.2087"></a><span id="l2.2087">  * @param length {Integer} The number of characters to reserve space for.</span>
<a href="#l2.2088"></a><span id="l2.2088">  * @return {Boolean} Whether or not there is enough space for length characters.</span>
<a href="#l2.2089"></a><span id="l2.2089">  */</span>
<a href="#l2.2090"></a><span id="l2.2090" class="difflineminus">-HeaderEmitter.prototype._reserveTokenSpace = function (length) {</span>
<a href="#l2.2091"></a><span id="l2.2091" class="difflineplus">+HeaderEmitter.prototype._reserveTokenSpace = function(length) {</span>
<a href="#l2.2092"></a><span id="l2.2092">   // We are not going to do a sanity check that length is within the wrap</span>
<a href="#l2.2093"></a><span id="l2.2093">   // margins. The rationale is that this lets code simply call this function to</span>
<a href="#l2.2094"></a><span id="l2.2094">   // force a higher-level line break than normal preferred line breaks (see</span>
<a href="#l2.2095"></a><span id="l2.2095">   // addAddress for an example use). The text that would be added may need to be</span>
<a href="#l2.2096"></a><span id="l2.2096">   // itself broken up, so it might not need all the length anyways, but it</span>
<a href="#l2.2097"></a><span id="l2.2097">   // starts the break already.</span>
<a href="#l2.2098"></a><span id="l2.2098"> </span>
<a href="#l2.2099"></a><span id="l2.2099">   // If we have enough space, we don't need to do anything.</span>
<a href="#l2.2100"></a><span id="l2.2100" class="difflineat">@@ -2760,27 +2756,27 @@ HeaderEmitter.prototype._reserveTokenSpa</span>
<a href="#l2.2101"></a><span id="l2.2101">  * character may be added to the output. If the text could not be added without</span>
<a href="#l2.2102"></a><span id="l2.2102">  * violating line length restrictions, an error is thrown instead.</span>
<a href="#l2.2103"></a><span id="l2.2103">  *</span>
<a href="#l2.2104"></a><span id="l2.2104">  * @protected</span>
<a href="#l2.2105"></a><span id="l2.2105">  * @param {String}  text          The text to add to the output.</span>
<a href="#l2.2106"></a><span id="l2.2106">  * @param {Boolean} mayBreakAfter If true, the end of this text is a preferred</span>
<a href="#l2.2107"></a><span id="l2.2107">  *                                breakpoint.</span>
<a href="#l2.2108"></a><span id="l2.2108">  */</span>
<a href="#l2.2109"></a><span id="l2.2109" class="difflineminus">-HeaderEmitter.prototype.addText = function (text, mayBreakAfter) {</span>
<a href="#l2.2110"></a><span id="l2.2110" class="difflineplus">+HeaderEmitter.prototype.addText = function(text, mayBreakAfter) {</span>
<a href="#l2.2111"></a><span id="l2.2111">   // Try to reserve space for the tokens. If we can't, give up.</span>
<a href="#l2.2112"></a><span id="l2.2112">   if (!this._reserveTokenSpace(text.length))</span>
<a href="#l2.2113"></a><span id="l2.2113">     throw new Error(&quot;Cannot encode &quot; + text + &quot; due to length.&quot;);</span>
<a href="#l2.2114"></a><span id="l2.2114"> </span>
<a href="#l2.2115"></a><span id="l2.2115">   this._currentLine += text;</span>
<a href="#l2.2116"></a><span id="l2.2116">   if (mayBreakAfter) {</span>
<a href="#l2.2117"></a><span id="l2.2117">     // Make sure that there is an extra space if text could break afterwards.</span>
<a href="#l2.2118"></a><span id="l2.2118">     this._preferredBreakpoint = this._currentLine.length;</span>
<a href="#l2.2119"></a><span id="l2.2119" class="difflineminus">-    if (text[text.length - 1] != ' ') {</span>
<a href="#l2.2120"></a><span id="l2.2120" class="difflineminus">-      this._currentLine += ' ';</span>
<a href="#l2.2121"></a><span id="l2.2121" class="difflineplus">+    if (text[text.length - 1] != &quot; &quot;) {</span>
<a href="#l2.2122"></a><span id="l2.2122" class="difflineplus">+      this._currentLine += &quot; &quot;;</span>
<a href="#l2.2123"></a><span id="l2.2123">     }</span>
<a href="#l2.2124"></a><span id="l2.2124">   }</span>
<a href="#l2.2125"></a><span id="l2.2125"> };</span>
<a href="#l2.2126"></a><span id="l2.2126"> </span>
<a href="#l2.2127"></a><span id="l2.2127"> /**</span>
<a href="#l2.2128"></a><span id="l2.2128">  * Adds a block of text that may need quoting if it contains some character in</span>
<a href="#l2.2129"></a><span id="l2.2129">  * qchars. If it is already quoted, no quoting will be applied. If the text</span>
<a href="#l2.2130"></a><span id="l2.2130">  * cannot be added without violating maximum line length, an error is thrown</span>
<a href="#l2.2131"></a><span id="l2.2131" class="difflineat">@@ -2788,26 +2784,26 @@ HeaderEmitter.prototype.addText = functi</span>
<a href="#l2.2132"></a><span id="l2.2132">  *</span>
<a href="#l2.2133"></a><span id="l2.2133">  * @protected</span>
<a href="#l2.2134"></a><span id="l2.2134">  * @param {String}  text          The text to add to the output.</span>
<a href="#l2.2135"></a><span id="l2.2135">  * @param {String}  qchars        The set of characters that cannot appear</span>
<a href="#l2.2136"></a><span id="l2.2136">  *                                outside of a quoted string.</span>
<a href="#l2.2137"></a><span id="l2.2137">  * @param {Boolean} mayBreakAfter If true, the end of this text is a preferred</span>
<a href="#l2.2138"></a><span id="l2.2138">  *                                breakpoint.</span>
<a href="#l2.2139"></a><span id="l2.2139">  */</span>
<a href="#l2.2140"></a><span id="l2.2140" class="difflineminus">-HeaderEmitter.prototype.addQuotable = function (text, qchars, mayBreakAfter) {</span>
<a href="#l2.2141"></a><span id="l2.2141" class="difflineplus">+HeaderEmitter.prototype.addQuotable = function(text, qchars, mayBreakAfter) {</span>
<a href="#l2.2142"></a><span id="l2.2142">   // No text -&gt; no need to be quoted (prevents strict warning errors).</span>
<a href="#l2.2143"></a><span id="l2.2143">   if (text.length == 0)</span>
<a href="#l2.2144"></a><span id="l2.2144">     return;</span>
<a href="#l2.2145"></a><span id="l2.2145"> </span>
<a href="#l2.2146"></a><span id="l2.2146">   // Figure out if we need to quote the string. Don't quote a string which</span>
<a href="#l2.2147"></a><span id="l2.2147">   // already appears to be quoted.</span>
<a href="#l2.2148"></a><span id="l2.2148">   let needsQuote = false;</span>
<a href="#l2.2149"></a><span id="l2.2149"> </span>
<a href="#l2.2150"></a><span id="l2.2150" class="difflineminus">-  if (!(text[0] == '&quot;' &amp;&amp; text[text.length - 1] == '&quot;') &amp;&amp; qchars != '') {</span>
<a href="#l2.2151"></a><span id="l2.2151" class="difflineplus">+  if (!(text[0] == '&quot;' &amp;&amp; text[text.length - 1] == '&quot;') &amp;&amp; qchars != &quot;&quot;) {</span>
<a href="#l2.2152"></a><span id="l2.2152">     for (let i = 0; i &lt; text.length; i++) {</span>
<a href="#l2.2153"></a><span id="l2.2153">       if (qchars.includes(text[i])) {</span>
<a href="#l2.2154"></a><span id="l2.2154">         needsQuote = true;</span>
<a href="#l2.2155"></a><span id="l2.2155">         break;</span>
<a href="#l2.2156"></a><span id="l2.2156">       }</span>
<a href="#l2.2157"></a><span id="l2.2157">     }</span>
<a href="#l2.2158"></a><span id="l2.2158">   }</span>
<a href="#l2.2159"></a><span id="l2.2159"> </span>
<a href="#l2.2160"></a><span id="l2.2160" class="difflineat">@@ -2825,17 +2821,17 @@ HeaderEmitter.prototype.addQuotable = fu</span>
<a href="#l2.2161"></a><span id="l2.2161">  *</span>
<a href="#l2.2162"></a><span id="l2.2162">  * @protected</span>
<a href="#l2.2163"></a><span id="l2.2163">  * @param {String}  text          The text to add to the output.</span>
<a href="#l2.2164"></a><span id="l2.2164">  * @param {String}  qchars        The set of characters that cannot appear</span>
<a href="#l2.2165"></a><span id="l2.2165">  *                                outside of a quoted string.</span>
<a href="#l2.2166"></a><span id="l2.2166">  * @param {Boolean} mayBreakAfter If true, the end of this text is a preferred</span>
<a href="#l2.2167"></a><span id="l2.2167">  *                                breakpoint.</span>
<a href="#l2.2168"></a><span id="l2.2168">  */</span>
<a href="#l2.2169"></a><span id="l2.2169" class="difflineminus">-HeaderEmitter.prototype.addPhrase = function (text, qchars, mayBreakAfter) {</span>
<a href="#l2.2170"></a><span id="l2.2170" class="difflineplus">+HeaderEmitter.prototype.addPhrase = function(text, qchars, mayBreakAfter) {</span>
<a href="#l2.2171"></a><span id="l2.2171">   // Collapse all whitespace spans into a single whitespace node.</span>
<a href="#l2.2172"></a><span id="l2.2172">   text = text.replace(/[ \t\r\n]+/g, &quot; &quot;);</span>
<a href="#l2.2173"></a><span id="l2.2173"> </span>
<a href="#l2.2174"></a><span id="l2.2174">   // If we have non-ASCII text, encode it using RFC 2047.</span>
<a href="#l2.2175"></a><span id="l2.2175">   if (this._useASCII &amp;&amp; nonAsciiRe.test(text)) {</span>
<a href="#l2.2176"></a><span id="l2.2176">     this.encodeRFC2047Phrase(text, mayBreakAfter);</span>
<a href="#l2.2177"></a><span id="l2.2177">     return;</span>
<a href="#l2.2178"></a><span id="l2.2178">   }</span>
<a href="#l2.2179"></a><span id="l2.2179" class="difflineat">@@ -2859,77 +2855,77 @@ HeaderEmitter.prototype.addPhrase = func</span>
<a href="#l2.2180"></a><span id="l2.2180">       // because the string was too long. Fall through to the case where we know</span>
<a href="#l2.2181"></a><span id="l2.2181">       // that the input was too long to begin with.</span>
<a href="#l2.2182"></a><span id="l2.2182">     }</span>
<a href="#l2.2183"></a><span id="l2.2183">   }</span>
<a href="#l2.2184"></a><span id="l2.2184"> </span>
<a href="#l2.2185"></a><span id="l2.2185">   // If the text is too long, split the quotable string at space boundaries and</span>
<a href="#l2.2186"></a><span id="l2.2186">   // add each word individually. If we still can't add all those words, there is</span>
<a href="#l2.2187"></a><span id="l2.2187">   // nothing that we can do.</span>
<a href="#l2.2188"></a><span id="l2.2188" class="difflineminus">-  let words = text.split(' ');</span>
<a href="#l2.2189"></a><span id="l2.2189" class="difflineplus">+  let words = text.split(&quot; &quot;);</span>
<a href="#l2.2190"></a><span id="l2.2190">   for (let i = 0; i &lt; words.length; i++) {</span>
<a href="#l2.2191"></a><span id="l2.2191">     this.addQuotable(words[i], qchars,</span>
<a href="#l2.2192"></a><span id="l2.2192">       i == words.length - 1 ? mayBreakAfter : true);</span>
<a href="#l2.2193"></a><span id="l2.2193">   }</span>
<a href="#l2.2194"></a><span id="l2.2194"> };</span>
<a href="#l2.2195"></a><span id="l2.2195"> </span>
<a href="#l2.2196"></a><span id="l2.2196" class="difflineminus">-/// A regular expression for characters that need to be encoded.</span>
<a href="#l2.2197"></a><span id="l2.2197" class="difflineplus">+// A regular expression for characters that need to be encoded.</span>
<a href="#l2.2198"></a><span id="l2.2198"> var nonAsciiRe = /[^\x20-\x7e]/;</span>
<a href="#l2.2199"></a><span id="l2.2199"> </span>
<a href="#l2.2200"></a><span id="l2.2200" class="difflineminus">-/// The beginnings of RFC 2047 encoded-word</span>
<a href="#l2.2201"></a><span id="l2.2201" class="difflineplus">+// The beginnings of RFC 2047 encoded-word</span>
<a href="#l2.2202"></a><span id="l2.2202"> var b64Prelude = &quot;=?UTF-8?B?&quot;, qpPrelude = &quot;=?UTF-8?Q?&quot;;</span>
<a href="#l2.2203"></a><span id="l2.2203"> </span>
<a href="#l2.2204"></a><span id="l2.2204" class="difflineminus">-/// A list of ASCII characters forbidden in RFC 2047 encoded-words</span>
<a href="#l2.2205"></a><span id="l2.2205" class="difflineplus">+// A list of ASCII characters forbidden in RFC 2047 encoded-words</span>
<a href="#l2.2206"></a><span id="l2.2206"> var qpForbidden = &quot;\&quot;#$%&amp;'(),.:;&lt;=&gt;?@[\\]^_`{|}~&quot;;</span>
<a href="#l2.2207"></a><span id="l2.2207"> </span>
<a href="#l2.2208"></a><span id="l2.2208"> var hexString = &quot;0123456789abcdef&quot;;</span>
<a href="#l2.2209"></a><span id="l2.2209"> </span>
<a href="#l2.2210"></a><span id="l2.2210"> /**</span>
<a href="#l2.2211"></a><span id="l2.2211">  * Add a block of text as a single RFC 2047 encoded word. This does not try to</span>
<a href="#l2.2212"></a><span id="l2.2212">  * split words if they are too long.</span>
<a href="#l2.2213"></a><span id="l2.2213">  *</span>
<a href="#l2.2214"></a><span id="l2.2214">  * @private</span>
<a href="#l2.2215"></a><span id="l2.2215">  * @param {Uint8Array} encodedText   The octets to encode.</span>
<a href="#l2.2216"></a><span id="l2.2216">  * @param {Boolean}    useQP         If true, use quoted-printable; if false,</span>
<a href="#l2.2217"></a><span id="l2.2217">  *                                   use base64.</span>
<a href="#l2.2218"></a><span id="l2.2218">  * @param {Boolean}    mayBreakAfter If true, the end of this text is a</span>
<a href="#l2.2219"></a><span id="l2.2219">  *                                   preferred breakpoint.</span>
<a href="#l2.2220"></a><span id="l2.2220">  */</span>
<a href="#l2.2221"></a><span id="l2.2221" class="difflineminus">-HeaderEmitter.prototype._addRFC2047Word = function (encodedText, useQP,</span>
<a href="#l2.2222"></a><span id="l2.2222" class="difflineminus">-    mayBreakAfter) {</span>
<a href="#l2.2223"></a><span id="l2.2223" class="difflineplus">+HeaderEmitter.prototype._addRFC2047Word = function(encodedText, useQP, mayBreakAfter) {</span>
<a href="#l2.2224"></a><span id="l2.2224">   let binaryString = mimeutils.typedArrayToString(encodedText);</span>
<a href="#l2.2225"></a><span id="l2.2225" class="difflineplus">+  let token;</span>
<a href="#l2.2226"></a><span id="l2.2226">   if (useQP) {</span>
<a href="#l2.2227"></a><span id="l2.2227" class="difflineminus">-    var token = qpPrelude;</span>
<a href="#l2.2228"></a><span id="l2.2228" class="difflineplus">+    token = qpPrelude;</span>
<a href="#l2.2229"></a><span id="l2.2229">     for (let i = 0; i &lt; encodedText.length; i++) {</span>
<a href="#l2.2230"></a><span id="l2.2230">       if (encodedText[i] &lt; 0x20 || encodedText[i] &gt;= 0x7F ||</span>
<a href="#l2.2231"></a><span id="l2.2231">           qpForbidden.includes(binaryString[i])) {</span>
<a href="#l2.2232"></a><span id="l2.2232">         let ch = encodedText[i];</span>
<a href="#l2.2233"></a><span id="l2.2233">         token += &quot;=&quot; + hexString[(ch &amp; 0xf0) &gt;&gt; 4] + hexString[ch &amp; 0x0f];</span>
<a href="#l2.2234"></a><span id="l2.2234">       } else if (binaryString[i] == &quot; &quot;) {</span>
<a href="#l2.2235"></a><span id="l2.2235">         token += &quot;_&quot;;</span>
<a href="#l2.2236"></a><span id="l2.2236">       } else {</span>
<a href="#l2.2237"></a><span id="l2.2237">         token += binaryString[i];</span>
<a href="#l2.2238"></a><span id="l2.2238">       }</span>
<a href="#l2.2239"></a><span id="l2.2239">     }</span>
<a href="#l2.2240"></a><span id="l2.2240">     token += &quot;?=&quot;;</span>
<a href="#l2.2241"></a><span id="l2.2241">   } else {</span>
<a href="#l2.2242"></a><span id="l2.2242" class="difflineminus">-    var token = b64Prelude + btoa(binaryString) + &quot;?=&quot;;</span>
<a href="#l2.2243"></a><span id="l2.2243" class="difflineplus">+    token = b64Prelude + btoa(binaryString) + &quot;?=&quot;;</span>
<a href="#l2.2244"></a><span id="l2.2244">   }</span>
<a href="#l2.2245"></a><span id="l2.2245">   this.addText(token, mayBreakAfter);</span>
<a href="#l2.2246"></a><span id="l2.2246"> };</span>
<a href="#l2.2247"></a><span id="l2.2247"> </span>
<a href="#l2.2248"></a><span id="l2.2248"> /**</span>
<a href="#l2.2249"></a><span id="l2.2249">  * Add a block of text as potentially several RFC 2047 encoded-word tokens.</span>
<a href="#l2.2250"></a><span id="l2.2250">  *</span>
<a href="#l2.2251"></a><span id="l2.2251">  * @protected</span>
<a href="#l2.2252"></a><span id="l2.2252">  * @param {String}  text          The text to add to the output.</span>
<a href="#l2.2253"></a><span id="l2.2253">  * @param {Boolean} mayBreakAfter If true, the end of this text is a preferred</span>
<a href="#l2.2254"></a><span id="l2.2254">  *                                breakpoint.</span>
<a href="#l2.2255"></a><span id="l2.2255">  */</span>
<a href="#l2.2256"></a><span id="l2.2256" class="difflineminus">-HeaderEmitter.prototype.encodeRFC2047Phrase = function (text, mayBreakAfter) {</span>
<a href="#l2.2257"></a><span id="l2.2257" class="difflineplus">+HeaderEmitter.prototype.encodeRFC2047Phrase = function(text, mayBreakAfter) {</span>
<a href="#l2.2258"></a><span id="l2.2258">   // Start by encoding the text into UTF-8 directly.</span>
<a href="#l2.2259"></a><span id="l2.2259">   let encodedText = new TextEncoder(&quot;UTF-8&quot;).encode(text);</span>
<a href="#l2.2260"></a><span id="l2.2260"> </span>
<a href="#l2.2261"></a><span id="l2.2261">   // Make sure there's enough room for a single token.</span>
<a href="#l2.2262"></a><span id="l2.2262">   let minLineLen = b64Prelude.length + 10; // Eight base64 characters plus ?=</span>
<a href="#l2.2263"></a><span id="l2.2263">   if (!this._reserveTokenSpace(minLineLen)) {</span>
<a href="#l2.2264"></a><span id="l2.2264">     this._commitLine(this._currentLine.length);</span>
<a href="#l2.2265"></a><span id="l2.2265">   }</span>
<a href="#l2.2266"></a><span id="l2.2266" class="difflineat">@@ -2977,27 +2973,26 @@ HeaderEmitter.prototype.encodeRFC2047Phr</span>
<a href="#l2.2267"></a><span id="l2.2267">     }</span>
<a href="#l2.2268"></a><span id="l2.2268">   }</span>
<a href="#l2.2269"></a><span id="l2.2269"> </span>
<a href="#l2.2270"></a><span id="l2.2270">   // Add the entire array at this point.</span>
<a href="#l2.2271"></a><span id="l2.2271">   this._addRFC2047Word(encodedText.subarray(start), b64Len &gt;= qpLen,</span>
<a href="#l2.2272"></a><span id="l2.2272">     mayBreakAfter);</span>
<a href="#l2.2273"></a><span id="l2.2273"> };</span>
<a href="#l2.2274"></a><span id="l2.2274"> </span>
<a href="#l2.2275"></a><span id="l2.2275" class="difflineminus">-////////////////////////</span>
<a href="#l2.2276"></a><span id="l2.2276" class="difflineminus">-// High-level methods //</span>
<a href="#l2.2277"></a><span id="l2.2277" class="difflineminus">-////////////////////////</span>
<a href="#l2.2278"></a><span id="l2.2278" class="difflineplus">+// High-level methods</span>
<a href="#l2.2279"></a><span id="l2.2279" class="difflineplus">+// ------------------</span>
<a href="#l2.2280"></a><span id="l2.2280"> </span>
<a href="#l2.2281"></a><span id="l2.2281"> /**</span>
<a href="#l2.2282"></a><span id="l2.2282">  * Add the header name, with the colon and trailing space, to the output.</span>
<a href="#l2.2283"></a><span id="l2.2283">  *</span>
<a href="#l2.2284"></a><span id="l2.2284">  * @public</span>
<a href="#l2.2285"></a><span id="l2.2285">  * @param {String} name The name of the header.</span>
<a href="#l2.2286"></a><span id="l2.2286">  */</span>
<a href="#l2.2287"></a><span id="l2.2287" class="difflineminus">-HeaderEmitter.prototype.addHeaderName = function (name) {</span>
<a href="#l2.2288"></a><span id="l2.2288" class="difflineplus">+HeaderEmitter.prototype.addHeaderName = function(name) {</span>
<a href="#l2.2289"></a><span id="l2.2289">   this._currentLine = this._currentLine.trimRight();</span>
<a href="#l2.2290"></a><span id="l2.2290">   if (this._currentLine.length &gt; 0) {</span>
<a href="#l2.2291"></a><span id="l2.2291">     this._commitLine();</span>
<a href="#l2.2292"></a><span id="l2.2292">   }</span>
<a href="#l2.2293"></a><span id="l2.2293">   this.addText(name + &quot;: &quot;, false);</span>
<a href="#l2.2294"></a><span id="l2.2294"> };</span>
<a href="#l2.2295"></a><span id="l2.2295"> </span>
<a href="#l2.2296"></a><span id="l2.2296"> /**</span>
<a href="#l2.2297"></a><span id="l2.2297" class="difflineat">@@ -3008,17 +3003,17 @@ HeaderEmitter.prototype.addHeaderName = </span>
<a href="#l2.2298"></a><span id="l2.2298">  * case put into the name. If no structured encoder can be found, and the input</span>
<a href="#l2.2299"></a><span id="l2.2299">  * value is a string, then the header is assumed to be unstructured and the</span>
<a href="#l2.2300"></a><span id="l2.2300">  * value is added as if {@link addUnstructured} were called.</span>
<a href="#l2.2301"></a><span id="l2.2301">  *</span>
<a href="#l2.2302"></a><span id="l2.2302">  * @public</span>
<a href="#l2.2303"></a><span id="l2.2303">  * @param {String} name  The name of the header.</span>
<a href="#l2.2304"></a><span id="l2.2304">  * @param          value The structured value of the header.</span>
<a href="#l2.2305"></a><span id="l2.2305">  */</span>
<a href="#l2.2306"></a><span id="l2.2306" class="difflineminus">-HeaderEmitter.prototype.addStructuredHeader = function (name, value) {</span>
<a href="#l2.2307"></a><span id="l2.2307" class="difflineplus">+HeaderEmitter.prototype.addStructuredHeader = function(name, value) {</span>
<a href="#l2.2308"></a><span id="l2.2308">   let lowerName = name.toLowerCase();</span>
<a href="#l2.2309"></a><span id="l2.2309">   if (encoders.has(lowerName)) {</span>
<a href="#l2.2310"></a><span id="l2.2310">     this.addHeaderName(preferredSpellings.get(lowerName));</span>
<a href="#l2.2311"></a><span id="l2.2311">     encoders.get(lowerName).call(this, value);</span>
<a href="#l2.2312"></a><span id="l2.2312">   } else if (typeof value === &quot;string&quot;) {</span>
<a href="#l2.2313"></a><span id="l2.2313">     // Assume it's an unstructured header.</span>
<a href="#l2.2314"></a><span id="l2.2314">     // All-lower-case-names are ugly, so capitalize first letters.</span>
<a href="#l2.2315"></a><span id="l2.2315">     name = name.replace(/(^|-)[a-z]/g, function(match) {</span>
<a href="#l2.2316"></a><span id="l2.2316" class="difflineat">@@ -3036,17 +3031,17 @@ HeaderEmitter.prototype.addStructuredHea</span>
<a href="#l2.2317"></a><span id="l2.2317">  * possibly-empty display name and an email address.</span>
<a href="#l2.2318"></a><span id="l2.2318">  *</span>
<a href="#l2.2319"></a><span id="l2.2319">  * @public</span>
<a href="#l2.2320"></a><span id="l2.2320">  * @param Address addr The address to be added.</span>
<a href="#l2.2321"></a><span id="l2.2321">  * @param {String} addr.name  The (possibly-empty) name of the address to add.</span>
<a href="#l2.2322"></a><span id="l2.2322">  * @param {String} addr.email The email of the address to add.</span>
<a href="#l2.2323"></a><span id="l2.2323">  * @see headerparser.parseAddressingHeader</span>
<a href="#l2.2324"></a><span id="l2.2324">  */</span>
<a href="#l2.2325"></a><span id="l2.2325" class="difflineminus">-HeaderEmitter.prototype.addAddress = function (addr) {</span>
<a href="#l2.2326"></a><span id="l2.2326" class="difflineplus">+HeaderEmitter.prototype.addAddress = function(addr) {</span>
<a href="#l2.2327"></a><span id="l2.2327">   // If we have a display name, add that first.</span>
<a href="#l2.2328"></a><span id="l2.2328">   if (addr.name) {</span>
<a href="#l2.2329"></a><span id="l2.2329">     // This is a simple estimate that keeps names on one line if possible.</span>
<a href="#l2.2330"></a><span id="l2.2330">     this._reserveTokenSpace(addr.name.length + addr.email.length + 3);</span>
<a href="#l2.2331"></a><span id="l2.2331">     this.addPhrase(addr.name, &quot;,()&lt;&gt;[]:;@.\&quot;&quot;, true);</span>
<a href="#l2.2332"></a><span id="l2.2332"> </span>
<a href="#l2.2333"></a><span id="l2.2333">     // If we don't have an email address, don't write out the angle brackets for</span>
<a href="#l2.2334"></a><span id="l2.2334">     // the address. It's already an abnormal situation should this appear, and</span>
<a href="#l2.2335"></a><span id="l2.2335" class="difflineat">@@ -3056,20 +3051,20 @@ HeaderEmitter.prototype.addAddress = fun</span>
<a href="#l2.2336"></a><span id="l2.2336"> </span>
<a href="#l2.2337"></a><span id="l2.2337">     this.addText(&quot;&lt;&quot;, false);</span>
<a href="#l2.2338"></a><span id="l2.2338">   }</span>
<a href="#l2.2339"></a><span id="l2.2339"> </span>
<a href="#l2.2340"></a><span id="l2.2340">   // Find the local-part and domain of the address, since the local-part may</span>
<a href="#l2.2341"></a><span id="l2.2341">   // need to be quoted separately. Note that the @ goes to the domain, so that</span>
<a href="#l2.2342"></a><span id="l2.2342">   // the local-part may be quoted if it needs to be.</span>
<a href="#l2.2343"></a><span id="l2.2343">   let at = addr.email.lastIndexOf(&quot;@&quot;);</span>
<a href="#l2.2344"></a><span id="l2.2344" class="difflineminus">-  let localpart = &quot;&quot;, domain = &quot;&quot;</span>
<a href="#l2.2345"></a><span id="l2.2345" class="difflineminus">-  if (at == -1)</span>
<a href="#l2.2346"></a><span id="l2.2346" class="difflineplus">+  let localpart = &quot;&quot;, domain = &quot;&quot;;</span>
<a href="#l2.2347"></a><span id="l2.2347" class="difflineplus">+  if (at == -1) {</span>
<a href="#l2.2348"></a><span id="l2.2348">     localpart = addr.email;</span>
<a href="#l2.2349"></a><span id="l2.2349" class="difflineminus">-  else {</span>
<a href="#l2.2350"></a><span id="l2.2350" class="difflineplus">+  } else {</span>
<a href="#l2.2351"></a><span id="l2.2351">     localpart = addr.email.slice(0, at);</span>
<a href="#l2.2352"></a><span id="l2.2352">     domain = addr.email.slice(at);</span>
<a href="#l2.2353"></a><span id="l2.2353">   }</span>
<a href="#l2.2354"></a><span id="l2.2354"> </span>
<a href="#l2.2355"></a><span id="l2.2355">   this.addQuotable(localpart, &quot;()&lt;&gt;[]:;@\\,\&quot; !&quot;, false);</span>
<a href="#l2.2356"></a><span id="l2.2356">   this.addText(domain + (addr.name ? &quot;&gt;&quot; : &quot;&quot;), false);</span>
<a href="#l2.2357"></a><span id="l2.2357"> };</span>
<a href="#l2.2358"></a><span id="l2.2358"> </span>
<a href="#l2.2359"></a><span id="l2.2359" class="difflineat">@@ -3083,17 +3078,17 @@ HeaderEmitter.prototype.addAddress = fun</span>
<a href="#l2.2360"></a><span id="l2.2360">  * @param {(Address|Group)[]} addrs A collection of addresses to add.</span>
<a href="#l2.2361"></a><span id="l2.2361">  * @param {String}    addrs[i].name    The (possibly-empty) name of the</span>
<a href="#l2.2362"></a><span id="l2.2362">  *                                     address or the group to add.</span>
<a href="#l2.2363"></a><span id="l2.2363">  * @param {String}    [addrs[i].email] The email of the address to add.</span>
<a href="#l2.2364"></a><span id="l2.2364">  * @param {Address[]} [addrs[i].group] A list of email addresses in the group.</span>
<a href="#l2.2365"></a><span id="l2.2365">  * @see HeaderEmitter.addAddress</span>
<a href="#l2.2366"></a><span id="l2.2366">  * @see headerparser.parseAddressingHeader</span>
<a href="#l2.2367"></a><span id="l2.2367">  */</span>
<a href="#l2.2368"></a><span id="l2.2368" class="difflineminus">-HeaderEmitter.prototype.addAddresses = function (addresses) {</span>
<a href="#l2.2369"></a><span id="l2.2369" class="difflineplus">+HeaderEmitter.prototype.addAddresses = function(addresses) {</span>
<a href="#l2.2370"></a><span id="l2.2370">   let needsComma = false;</span>
<a href="#l2.2371"></a><span id="l2.2371">   for (let addr of addresses) {</span>
<a href="#l2.2372"></a><span id="l2.2372">     // Add a comma if this is not the first element.</span>
<a href="#l2.2373"></a><span id="l2.2373">     if (needsComma)</span>
<a href="#l2.2374"></a><span id="l2.2374">       this.addText(&quot;, &quot;, true);</span>
<a href="#l2.2375"></a><span id="l2.2375">     needsComma = true;</span>
<a href="#l2.2376"></a><span id="l2.2376"> </span>
<a href="#l2.2377"></a><span id="l2.2377">     if (&quot;email&quot; in addr) {</span>
<a href="#l2.2378"></a><span id="l2.2378" class="difflineat">@@ -3113,17 +3108,17 @@ HeaderEmitter.prototype.addAddresses = f</span>
<a href="#l2.2379"></a><span id="l2.2379"> /**</span>
<a href="#l2.2380"></a><span id="l2.2380">  * Add an unstructured header value to the output. This effectively means only</span>
<a href="#l2.2381"></a><span id="l2.2381">  * inserting line breaks were necessary, and using RFC 2047 encoding where</span>
<a href="#l2.2382"></a><span id="l2.2382">  * necessary.</span>
<a href="#l2.2383"></a><span id="l2.2383">  *</span>
<a href="#l2.2384"></a><span id="l2.2384">  * @public</span>
<a href="#l2.2385"></a><span id="l2.2385">  * @param {String} text The text to add to the output.</span>
<a href="#l2.2386"></a><span id="l2.2386">  */</span>
<a href="#l2.2387"></a><span id="l2.2387" class="difflineminus">-HeaderEmitter.prototype.addUnstructured = function (text) {</span>
<a href="#l2.2388"></a><span id="l2.2388" class="difflineplus">+HeaderEmitter.prototype.addUnstructured = function(text) {</span>
<a href="#l2.2389"></a><span id="l2.2389">   if (text.length == 0)</span>
<a href="#l2.2390"></a><span id="l2.2390">     return;</span>
<a href="#l2.2391"></a><span id="l2.2391"> </span>
<a href="#l2.2392"></a><span id="l2.2392">   // Unstructured text is basically a phrase that can't be quoted. So, if we</span>
<a href="#l2.2393"></a><span id="l2.2393">   // have nothing in qchars, nothing should be quoted.</span>
<a href="#l2.2394"></a><span id="l2.2394">   this.addPhrase(text, &quot;&quot;, false);</span>
<a href="#l2.2395"></a><span id="l2.2395"> };</span>
<a href="#l2.2396"></a><span id="l2.2396"> </span>
<a href="#l2.2397"></a><span id="l2.2397" class="difflineat">@@ -3145,17 +3140,17 @@ function padTo2Digits(num) {</span>
<a href="#l2.2398"></a><span id="l2.2398">  *</span>
<a href="#l2.2399"></a><span id="l2.2399">  * Note that if the date is an invalid date (its internal date parameter is a</span>
<a href="#l2.2400"></a><span id="l2.2400">  * NaN value), this method throws an error instead of generating an invalid</span>
<a href="#l2.2401"></a><span id="l2.2401">  * string.</span>
<a href="#l2.2402"></a><span id="l2.2402">  *</span>
<a href="#l2.2403"></a><span id="l2.2403">  * @public</span>
<a href="#l2.2404"></a><span id="l2.2404">  * @param {Date} date The date to be added to the output string.</span>
<a href="#l2.2405"></a><span id="l2.2405">  */</span>
<a href="#l2.2406"></a><span id="l2.2406" class="difflineminus">-HeaderEmitter.prototype.addDate = function (date) {</span>
<a href="#l2.2407"></a><span id="l2.2407" class="difflineplus">+HeaderEmitter.prototype.addDate = function(date) {</span>
<a href="#l2.2408"></a><span id="l2.2408">   // Rather than make a header plastered with NaN values, throw an error on</span>
<a href="#l2.2409"></a><span id="l2.2409">   // specific invalid dates.</span>
<a href="#l2.2410"></a><span id="l2.2410">   if (isNaN(date.getTime()))</span>
<a href="#l2.2411"></a><span id="l2.2411">     throw new Error(&quot;Cannot encode an invalid date&quot;);</span>
<a href="#l2.2412"></a><span id="l2.2412"> </span>
<a href="#l2.2413"></a><span id="l2.2413">   // RFC 5322 says years can't be before 1900. The after 9999 is a bit that</span>
<a href="#l2.2414"></a><span id="l2.2414">   // derives from the specification saying that years have 4 digits.</span>
<a href="#l2.2415"></a><span id="l2.2415">   if (date.getFullYear() &lt; 1900 || date.getFullYear() &gt; 9999)</span>
<a href="#l2.2416"></a><span id="l2.2416" class="difflineat">@@ -3176,29 +3171,29 @@ HeaderEmitter.prototype.addDate = functi</span>
<a href="#l2.2417"></a><span id="l2.2417">   let dayTime = [</span>
<a href="#l2.2418"></a><span id="l2.2418">     kDaysOfWeek[date.getDay()] + &quot;,&quot;,</span>
<a href="#l2.2419"></a><span id="l2.2419">     date.getDate(),</span>
<a href="#l2.2420"></a><span id="l2.2420">     mimeutils.kMonthNames[date.getMonth()],</span>
<a href="#l2.2421"></a><span id="l2.2421">     date.getFullYear(),</span>
<a href="#l2.2422"></a><span id="l2.2422">     padTo2Digits(date.getHours()) + &quot;:&quot; +</span>
<a href="#l2.2423"></a><span id="l2.2423">       padTo2Digits(date.getMinutes()) + &quot;:&quot; +</span>
<a href="#l2.2424"></a><span id="l2.2424">       padTo2Digits(date.getSeconds()),</span>
<a href="#l2.2425"></a><span id="l2.2425" class="difflineminus">-    tzOffsetStr</span>
<a href="#l2.2426"></a><span id="l2.2426" class="difflineplus">+    tzOffsetStr,</span>
<a href="#l2.2427"></a><span id="l2.2427">   ].join(&quot; &quot;);</span>
<a href="#l2.2428"></a><span id="l2.2428">   this.addText(dayTime, false);</span>
<a href="#l2.2429"></a><span id="l2.2429"> };</span>
<a href="#l2.2430"></a><span id="l2.2430"> </span>
<a href="#l2.2431"></a><span id="l2.2431"> /**</span>
<a href="#l2.2432"></a><span id="l2.2432">  * Signal that the current header has been finished encoding.</span>
<a href="#l2.2433"></a><span id="l2.2433">  *</span>
<a href="#l2.2434"></a><span id="l2.2434">  * @public</span>
<a href="#l2.2435"></a><span id="l2.2435">  * @param {Boolean} deliverEOF If true, signal to the handler that no more text</span>
<a href="#l2.2436"></a><span id="l2.2436">  *                             will be arriving.</span>
<a href="#l2.2437"></a><span id="l2.2437">  */</span>
<a href="#l2.2438"></a><span id="l2.2438" class="difflineminus">-HeaderEmitter.prototype.finish = function (deliverEOF) {</span>
<a href="#l2.2439"></a><span id="l2.2439" class="difflineplus">+HeaderEmitter.prototype.finish = function(deliverEOF) {</span>
<a href="#l2.2440"></a><span id="l2.2440">   this._commitLine();</span>
<a href="#l2.2441"></a><span id="l2.2441">   if (deliverEOF)</span>
<a href="#l2.2442"></a><span id="l2.2442">     this._handler.deliverEOF();</span>
<a href="#l2.2443"></a><span id="l2.2443"> };</span>
<a href="#l2.2444"></a><span id="l2.2444"> </span>
<a href="#l2.2445"></a><span id="l2.2445"> /**</span>
<a href="#l2.2446"></a><span id="l2.2446">  * Make a streaming header emitter that outputs on the given handler.</span>
<a href="#l2.2447"></a><span id="l2.2447">  *</span>
<a href="#l2.2448"></a><span id="l2.2448" class="difflineat">@@ -3208,18 +3203,18 @@ HeaderEmitter.prototype.finish = functio</span>
<a href="#l2.2449"></a><span id="l2.2449">  * @returns {HeaderEmitter} A header emitter constructed with the given options.</span>
<a href="#l2.2450"></a><span id="l2.2450">  */</span>
<a href="#l2.2451"></a><span id="l2.2451"> function makeStreamingEmitter(handler, options) {</span>
<a href="#l2.2452"></a><span id="l2.2452">   return new HeaderEmitter(handler, options);</span>
<a href="#l2.2453"></a><span id="l2.2453"> }</span>
<a href="#l2.2454"></a><span id="l2.2454"> </span>
<a href="#l2.2455"></a><span id="l2.2455"> function StringHandler() {</span>
<a href="#l2.2456"></a><span id="l2.2456">   this.value = &quot;&quot;;</span>
<a href="#l2.2457"></a><span id="l2.2457" class="difflineminus">-  this.deliverData = function (str) { this.value += str; };</span>
<a href="#l2.2458"></a><span id="l2.2458" class="difflineminus">-  this.deliverEOF = function () { };</span>
<a href="#l2.2459"></a><span id="l2.2459" class="difflineplus">+  this.deliverData = function(str) { this.value += str; };</span>
<a href="#l2.2460"></a><span id="l2.2460" class="difflineplus">+  this.deliverEOF = function() {};</span>
<a href="#l2.2461"></a><span id="l2.2461"> }</span>
<a href="#l2.2462"></a><span id="l2.2462"> </span>
<a href="#l2.2463"></a><span id="l2.2463"> /**</span>
<a href="#l2.2464"></a><span id="l2.2464">  * Given a header name and its structured value, output a string containing its</span>
<a href="#l2.2465"></a><span id="l2.2465">  * MIME-encoded value. The trailing CRLF for the header is included.</span>
<a href="#l2.2466"></a><span id="l2.2466">  *</span>
<a href="#l2.2467"></a><span id="l2.2467">  * @param {String} name    The name of the structured header.</span>
<a href="#l2.2468"></a><span id="l2.2468">  * @param          value   The value of the structured header.</span>
<a href="#l2.2469"></a><span id="l2.2469" class="difflineat">@@ -3249,18 +3244,18 @@ function emitStructuredHeader(name, valu</span>
<a href="#l2.2470"></a><span id="l2.2470">  *                                             constructor.</span>
<a href="#l2.2471"></a><span id="l2.2471">  * @returns {String} A MIME-encoded representation of the structured header.</span>
<a href="#l2.2472"></a><span id="l2.2472">  * @see HeaderEmitter.addStructuredHeader</span>
<a href="#l2.2473"></a><span id="l2.2473">  */</span>
<a href="#l2.2474"></a><span id="l2.2474"> function emitStructuredHeaders(headerValues, options) {</span>
<a href="#l2.2475"></a><span id="l2.2475">   let handler = new StringHandler();</span>
<a href="#l2.2476"></a><span id="l2.2476">   let emitter = new HeaderEmitter(handler, options);</span>
<a href="#l2.2477"></a><span id="l2.2477">   for (let instance of headerValues) {</span>
<a href="#l2.2478"></a><span id="l2.2478" class="difflineminus">-    instance[1].forEach(function (e) {</span>
<a href="#l2.2479"></a><span id="l2.2479" class="difflineminus">-      emitter.addStructuredHeader(instance[0], e)</span>
<a href="#l2.2480"></a><span id="l2.2480" class="difflineplus">+    instance[1].forEach(function(e) {</span>
<a href="#l2.2481"></a><span id="l2.2481" class="difflineplus">+      emitter.addStructuredHeader(instance[0], e);</span>
<a href="#l2.2482"></a><span id="l2.2482">     });</span>
<a href="#l2.2483"></a><span id="l2.2483">   }</span>
<a href="#l2.2484"></a><span id="l2.2484">   emitter.finish(true);</span>
<a href="#l2.2485"></a><span id="l2.2485">   return handler.value;</span>
<a href="#l2.2486"></a><span id="l2.2486"> }</span>
<a href="#l2.2487"></a><span id="l2.2487"> </span>
<a href="#l2.2488"></a><span id="l2.2488"> /**</span>
<a href="#l2.2489"></a><span id="l2.2489">  * Add a custom structured MIME encoder to the set of known encoders. These</span>
<a href="#l2.2490"></a><span id="l2.2490" class="difflineat">@@ -3283,25 +3278,24 @@ function emitStructuredHeaders(headerVal</span>
<a href="#l2.2491"></a><span id="l2.2491"> function addStructuredEncoder(header, encoder) {</span>
<a href="#l2.2492"></a><span id="l2.2492">   let lowerName = header.toLowerCase();</span>
<a href="#l2.2493"></a><span id="l2.2493">   encoders.set(lowerName, encoder);</span>
<a href="#l2.2494"></a><span id="l2.2494">   if (!preferredSpellings.has(lowerName))</span>
<a href="#l2.2495"></a><span id="l2.2495">     preferredSpellings.set(lowerName, header);</span>
<a href="#l2.2496"></a><span id="l2.2496"> }</span>
<a href="#l2.2497"></a><span id="l2.2497"> </span>
<a href="#l2.2498"></a><span id="l2.2498"> return Object.freeze({</span>
<a href="#l2.2499"></a><span id="l2.2499" class="difflineminus">-  addStructuredEncoder: addStructuredEncoder,</span>
<a href="#l2.2500"></a><span id="l2.2500" class="difflineminus">-  emitStructuredHeader: emitStructuredHeader,</span>
<a href="#l2.2501"></a><span id="l2.2501" class="difflineminus">-  emitStructuredHeaders: emitStructuredHeaders,</span>
<a href="#l2.2502"></a><span id="l2.2502" class="difflineminus">-  makeStreamingEmitter: makeStreamingEmitter</span>
<a href="#l2.2503"></a><span id="l2.2503" class="difflineplus">+  addStructuredEncoder,</span>
<a href="#l2.2504"></a><span id="l2.2504" class="difflineplus">+  emitStructuredHeader,</span>
<a href="#l2.2505"></a><span id="l2.2505" class="difflineplus">+  emitStructuredHeaders,</span>
<a href="#l2.2506"></a><span id="l2.2506" class="difflineplus">+  makeStreamingEmitter,</span>
<a href="#l2.2507"></a><span id="l2.2507"> });</span>
<a href="#l2.2508"></a><span id="l2.2508" class="difflineminus">-</span>
<a href="#l2.2509"></a><span id="l2.2509"> });</span>
<a href="#l2.2510"></a><span id="l2.2510"> </span>
<a href="#l2.2511"></a><span id="l2.2511" class="difflineminus">-def('jsmime', function(require) {</span>
<a href="#l2.2512"></a><span id="l2.2512" class="difflineplus">+def(&quot;jsmime&quot;, function(require) {</span>
<a href="#l2.2513"></a><span id="l2.2513">   return {</span>
<a href="#l2.2514"></a><span id="l2.2514" class="difflineminus">-    MimeParser: require('./mimeparser'),</span>
<a href="#l2.2515"></a><span id="l2.2515" class="difflineminus">-    headerparser: require('./headerparser'),</span>
<a href="#l2.2516"></a><span id="l2.2516" class="difflineminus">-    headeremitter: require('./headeremitter')</span>
<a href="#l2.2517"></a><span id="l2.2517" class="difflineminus">-  }</span>
<a href="#l2.2518"></a><span id="l2.2518" class="difflineplus">+    MimeParser: require(&quot;./mimeparser&quot;),</span>
<a href="#l2.2519"></a><span id="l2.2519" class="difflineplus">+    headerparser: require(&quot;./headerparser&quot;),</span>
<a href="#l2.2520"></a><span id="l2.2520" class="difflineplus">+    headeremitter: require(&quot;./headeremitter&quot;),</span>
<a href="#l2.2521"></a><span id="l2.2521" class="difflineplus">+  };</span>
<a href="#l2.2522"></a><span id="l2.2522"> });</span>
<a href="#l2.2523"></a><span id="l2.2523" class="difflineminus">-  return mods['jsmime'];</span>
<a href="#l2.2524"></a><span id="l2.2524" class="difflineplus">+  return mods.jsmime;</span>
<a href="#l2.2525"></a><span id="l2.2525"> }));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">new file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- /dev/null</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ b/mailnews/mime/jsmime/test/.eslintrc.js</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -0,0 +1,14 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineplus">+</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineplus">+module.exports = {</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+  &quot;extends&quot;: &quot;plugin:mozilla/xpcshell-test&quot;,</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+  &quot;rules&quot;: {</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+    &quot;func-names&quot;: &quot;off&quot;,</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+    &quot;mozilla/import-headjs-globals&quot;: &quot;error&quot;,</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+    &quot;no-unused-vars&quot;: [&quot;error&quot;, {</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+      &quot;args&quot;: &quot;none&quot;,</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+      &quot;vars&quot;: &quot;all&quot;,</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+    }],</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+  },</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/mime/jsmime/test/head_xpcshell_glue.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/mime/jsmime/test/head_xpcshell_glue.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -3,63 +3,64 @@</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5"> var {OS} = ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l4.6"></a><span id="l4.6"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l4.7"></a><span id="l4.7"> var {Assert} = ChromeUtils.import(&quot;resource://testing-common/Assert.jsm&quot;);</span>
<a href="#l4.8"></a><span id="l4.8"> var requireCache = new Map();</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10"> // Preload an assert module</span>
<a href="#l4.11"></a><span id="l4.11"> var assert = new Assert();</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-assert.doesNotThrow = function (block, message) {</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-  message = (message ? ' ' + message : '.');</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+assert.doesNotThrow = function(block, message) {</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+  message = (message ? &quot; &quot; + message : &quot;.&quot;);</span>
<a href="#l4.16"></a><span id="l4.16">   try {</span>
<a href="#l4.17"></a><span id="l4.17">     block();</span>
<a href="#l4.18"></a><span id="l4.18">   } catch (e) {</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-    this.report(true, e, null, 'Got unwanted exception' + message);</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+    this.report(true, e, null, &quot;Got unwanted exception&quot; + message);</span>
<a href="#l4.21"></a><span id="l4.21">   }</span>
<a href="#l4.22"></a><span id="l4.22"> };</span>
<a href="#l4.23"></a><span id="l4.23"> requireCache.set(&quot;assert&quot;, assert);</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25"> // Preload an fs module</span>
<a href="#l4.26"></a><span id="l4.26"> var fs = {</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-  readFile: function (filename, options, callback) {</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+  readFile(filename, options, callback) {</span>
<a href="#l4.29"></a><span id="l4.29">     if (callback === undefined) {</span>
<a href="#l4.30"></a><span id="l4.30">       callback = options;</span>
<a href="#l4.31"></a><span id="l4.31">       options = {};</span>
<a href="#l4.32"></a><span id="l4.32">     }</span>
<a href="#l4.33"></a><span id="l4.33"> </span>
<a href="#l4.34"></a><span id="l4.34">     // Convert according to encoding. For the moment, we don't support this</span>
<a href="#l4.35"></a><span id="l4.35">     // node.js feature in the shim since we don't need to.</span>
<a href="#l4.36"></a><span id="l4.36">     var translator = (contents =&gt; contents);</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-    if (options !== undefined &amp;&amp; 'encoding' in options) {</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-      translator = function () {</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+    if (options !== undefined &amp;&amp; &quot;encoding&quot; in options) {</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+      translator = function() {</span>
<a href="#l4.41"></a><span id="l4.41">         throw new Error(&quot;I can't do this!&quot;);</span>
<a href="#l4.42"></a><span id="l4.42">       };</span>
<a href="#l4.43"></a><span id="l4.43">     }</span>
<a href="#l4.44"></a><span id="l4.44"> </span>
<a href="#l4.45"></a><span id="l4.45">     Promise.resolve(filename)</span>
<a href="#l4.46"></a><span id="l4.46">            .then(do_get_file)</span>
<a href="#l4.47"></a><span id="l4.47">            .then(file =&gt; OS.File.read(file.path))</span>
<a href="#l4.48"></a><span id="l4.48">            .then(translator)</span>
<a href="#l4.49"></a><span id="l4.49">            .then(contents =&gt; callback(undefined, contents), callback);</span>
<a href="#l4.50"></a><span id="l4.50">   },</span>
<a href="#l4.51"></a><span id="l4.51"> };</span>
<a href="#l4.52"></a><span id="l4.52"> requireCache.set(&quot;fs&quot;, fs);</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineminus">-Components.utils.import(&quot;resource:///modules/jsmime.jsm&quot;);</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+var {jsmime} = ChromeUtils.import(&quot;resource:///modules/jsmime.jsm&quot;);</span>
<a href="#l4.55"></a><span id="l4.55"> requireCache.set(&quot;jsmime&quot;, jsmime);</span>
<a href="#l4.56"></a><span id="l4.56"> </span>
<a href="#l4.57"></a><span id="l4.57"> function require(path) {</span>
<a href="#l4.58"></a><span id="l4.58">   if (requireCache.has(path))</span>
<a href="#l4.59"></a><span id="l4.59">     return requireCache.get(path);</span>
<a href="#l4.60"></a><span id="l4.60"> </span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+  let file;</span>
<a href="#l4.62"></a><span id="l4.62">   if (path.startsWith(&quot;test/&quot;)) {</span>
<a href="#l4.63"></a><span id="l4.63">     let name = path.substring(&quot;test/&quot;.length);</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineminus">-    var file = &quot;resource://testing-common/jsmime/&quot; + name + &quot;.js&quot;;</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+    file = &quot;resource://testing-common/jsmime/&quot; + name + &quot;.js&quot;;</span>
<a href="#l4.66"></a><span id="l4.66">   } else {</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineminus">-    var file = &quot;resource:///modules/jsmime/&quot; + path + &quot;.js&quot;;</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+    file = &quot;resource:///modules/jsmime/&quot; + path + &quot;.js&quot;;</span>
<a href="#l4.69"></a><span id="l4.69">   }</span>
<a href="#l4.70"></a><span id="l4.70"> </span>
<a href="#l4.71"></a><span id="l4.71">   var globalObject = {</span>
<a href="#l4.72"></a><span id="l4.72">     define: innerDefine.bind(this, path),</span>
<a href="#l4.73"></a><span id="l4.73">   };</span>
<a href="#l4.74"></a><span id="l4.74">   Services.scriptloader.loadSubScript(file, globalObject);</span>
<a href="#l4.75"></a><span id="l4.75">   return requireCache.get(path);</span>
<a href="#l4.76"></a><span id="l4.76"> }</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineat">@@ -73,58 +74,57 @@ function innerDefine(moduleName, dfn) {</span>
<a href="#l4.78"></a><span id="l4.78">     return require(path);</span>
<a href="#l4.79"></a><span id="l4.79">   }</span>
<a href="#l4.80"></a><span id="l4.80">   var result = dfn(resolvingRequire);</span>
<a href="#l4.81"></a><span id="l4.81">   requireCache.set(moduleName, result);</span>
<a href="#l4.82"></a><span id="l4.82"> }</span>
<a href="#l4.83"></a><span id="l4.83"> </span>
<a href="#l4.84"></a><span id="l4.84"> var define = innerDefine.bind(this, &quot;xpcshell-test&quot;);</span>
<a href="#l4.85"></a><span id="l4.85"> </span>
<a href="#l4.86"></a><span id="l4.86" class="difflineminus">-///////////////////////////</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineminus">-// Mocha TDD UI Bindings //</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineminus">-///////////////////////////</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+// Mocha TDD UI Bindings</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+// ---------------------</span>
<a href="#l4.91"></a><span id="l4.91"> </span>
<a href="#l4.92"></a><span id="l4.92"> /**</span>
<a href="#l4.93"></a><span id="l4.93">  * A block of tests, from the suite class.</span>
<a href="#l4.94"></a><span id="l4.94">  */</span>
<a href="#l4.95"></a><span id="l4.95"> function MochaSuite(name) {</span>
<a href="#l4.96"></a><span id="l4.96">   this.name = name;</span>
<a href="#l4.97"></a><span id="l4.97">   this.setup = [];</span>
<a href="#l4.98"></a><span id="l4.98">   this.tests = [];</span>
<a href="#l4.99"></a><span id="l4.99">   this.teardown = [];</span>
<a href="#l4.100"></a><span id="l4.100">   this.suites = [];</span>
<a href="#l4.101"></a><span id="l4.101"> }</span>
<a href="#l4.102"></a><span id="l4.102"> </span>
<a href="#l4.103"></a><span id="l4.103" class="difflineminus">-/// The real code for running a suite of tests, written as async function.</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineminus">-MochaSuite.prototype._runSuite = async function () {</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+// The real code for running a suite of tests, written as async function.</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+MochaSuite.prototype._runSuite = async function() {</span>
<a href="#l4.107"></a><span id="l4.107">   info(&quot;Running suite &quot; + this.name);</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineminus">-  for (let setup of this.setup) {</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineminus">-    await runFunction(setup);</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+  for (let setup_ of this.setup) {</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+    await runFunction(setup_);</span>
<a href="#l4.112"></a><span id="l4.112">   }</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineminus">-  for (let test of this.tests) {</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineminus">-    info(&quot;Running test &quot; + test.name);</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineminus">-    await runFunction(test.test);</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+  for (let test_ of this.tests) {</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+    info(&quot;Running test &quot; + test_.name);</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+    await runFunction(test_.test);</span>
<a href="#l4.119"></a><span id="l4.119">   }</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineminus">-  for (let suite of this.suites) {</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineminus">-    await suite.runSuite();</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+  for (let suite_ of this.suites) {</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+    await suite_.runSuite();</span>
<a href="#l4.124"></a><span id="l4.124">   }</span>
<a href="#l4.125"></a><span id="l4.125">   for (let fn of this.teardown) {</span>
<a href="#l4.126"></a><span id="l4.126">     await runFunction(fn);</span>
<a href="#l4.127"></a><span id="l4.127">   }</span>
<a href="#l4.128"></a><span id="l4.128">   info(&quot;Finished suite &quot; + this.name);</span>
<a href="#l4.129"></a><span id="l4.129"> };</span>
<a href="#l4.130"></a><span id="l4.130"> </span>
<a href="#l4.131"></a><span id="l4.131" class="difflineminus">-/// The outer call to run a test suite, which returns a promise of completion.</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineminus">-MochaSuite.prototype.runSuite = function () {</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineplus">+// The outer call to run a test suite, which returns a promise of completion.</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineplus">+MochaSuite.prototype.runSuite = function() {</span>
<a href="#l4.135"></a><span id="l4.135">   return this._runSuite();</span>
<a href="#l4.136"></a><span id="l4.136"> };</span>
<a href="#l4.137"></a><span id="l4.137"> </span>
<a href="#l4.138"></a><span id="l4.138" class="difflineminus">-/// Run the given function, returning a promise of when the test will complete.</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineplus">+// Run the given function, returning a promise of when the test will complete.</span>
<a href="#l4.140"></a><span id="l4.140"> function runFunction(fn) {</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineminus">-  let completed = new Promise(function (resolve, reject) {</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineplus">+  let completed = new Promise(function(resolve, reject) {</span>
<a href="#l4.143"></a><span id="l4.143">     function onEnd(error) {</span>
<a href="#l4.144"></a><span id="l4.144">       if (error !== undefined)</span>
<a href="#l4.145"></a><span id="l4.145">         reject(error);</span>
<a href="#l4.146"></a><span id="l4.146">       else</span>
<a href="#l4.147"></a><span id="l4.147">         resolve();</span>
<a href="#l4.148"></a><span id="l4.148">     }</span>
<a href="#l4.149"></a><span id="l4.149">     // If the function is expecting an argument, that argument is the callback</span>
<a href="#l4.150"></a><span id="l4.150">     // above. If it's not, then it may be returning a promise.</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineat">@@ -134,37 +134,37 @@ function runFunction(fn) {</span>
<a href="#l4.152"></a><span id="l4.152">       // Promise.resolve nicely handles both promises and not-promise values for</span>
<a href="#l4.153"></a><span id="l4.153">       // us.</span>
<a href="#l4.154"></a><span id="l4.154">       resolve(fn());</span>
<a href="#l4.155"></a><span id="l4.155">     }</span>
<a href="#l4.156"></a><span id="l4.156">   });</span>
<a href="#l4.157"></a><span id="l4.157">   return completed;</span>
<a href="#l4.158"></a><span id="l4.158"> }</span>
<a href="#l4.159"></a><span id="l4.159"> </span>
<a href="#l4.160"></a><span id="l4.160" class="difflineminus">-var currentSuite = new MochaSuite('');</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineplus">+var currentSuite = new MochaSuite(&quot;&quot;);</span>
<a href="#l4.162"></a><span id="l4.162"> function suite(name, tests) {</span>
<a href="#l4.163"></a><span id="l4.163">   name = name.toString();</span>
<a href="#l4.164"></a><span id="l4.164">   if (/[\x80-]/.exec(name))</span>
<a href="#l4.165"></a><span id="l4.165">     name = &quot;&lt;unprintable name&gt;&quot;;</span>
<a href="#l4.166"></a><span id="l4.166">   let suiteParent = currentSuite;</span>
<a href="#l4.167"></a><span id="l4.167">   currentSuite = new MochaSuite(name);</span>
<a href="#l4.168"></a><span id="l4.168">   suiteParent.suites.push(currentSuite);</span>
<a href="#l4.169"></a><span id="l4.169">   tests();</span>
<a href="#l4.170"></a><span id="l4.170">   currentSuite = suiteParent;</span>
<a href="#l4.171"></a><span id="l4.171"> }</span>
<a href="#l4.172"></a><span id="l4.172"> function test(name, block) {</span>
<a href="#l4.173"></a><span id="l4.173">   name = name.toString();</span>
<a href="#l4.174"></a><span id="l4.174">   if (/[\x80-]/.exec(name))</span>
<a href="#l4.175"></a><span id="l4.175">     name = &quot;&lt;unprintable name&gt;&quot;;</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineminus">-  currentSuite.tests.push({name: name, test: block});</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineplus">+  currentSuite.tests.push({name, test: block});</span>
<a href="#l4.178"></a><span id="l4.178"> }</span>
<a href="#l4.179"></a><span id="l4.179"> function setup(block) {</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineminus">-  currentSetup.setup.push(block);</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineplus">+  currentSuite.setup.push(block);</span>
<a href="#l4.182"></a><span id="l4.182"> }</span>
<a href="#l4.183"></a><span id="l4.183"> function teardown(block) {</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineminus">-  currentSetup.teardown.push(block);</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineplus">+  currentSuite.teardown.push(block);</span>
<a href="#l4.186"></a><span id="l4.186"> }</span>
<a href="#l4.187"></a><span id="l4.187"> </span>
<a href="#l4.188"></a><span id="l4.188" class="difflineminus">-/// The actual binding xpcshell needs to do its work.</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineplus">+// The actual binding xpcshell needs to do its work.</span>
<a href="#l4.190"></a><span id="l4.190"> function run_test() {</span>
<a href="#l4.191"></a><span id="l4.191">   add_task(() =&gt; currentSuite.runSuite());</span>
<a href="#l4.192"></a><span id="l4.192">   run_next_test();</span>
<a href="#l4.193"></a><span id="l4.193"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/mime/jsmime/test/mock_date.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/mime/jsmime/test/mock_date.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,72 +1,78 @@</span>
<a href="#l5.4"></a><span id="l5.4"> &quot;use strict&quot;;</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineminus">-define(function (require) {</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+/* globals define */</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+define(function(require) {</span>
<a href="#l5.10"></a><span id="l5.10"> /**</span>
<a href="#l5.11"></a><span id="l5.11">  * A class which appears to act like the Date class with customizable timezone</span>
<a href="#l5.12"></a><span id="l5.12">  * offsets.</span>
<a href="#l5.13"></a><span id="l5.13">  * @param {String} iso8601String An ISO-8601 date/time string including a</span>
<a href="#l5.14"></a><span id="l5.14">  *                               timezone offset.</span>
<a href="#l5.15"></a><span id="l5.15">  */</span>
<a href="#l5.16"></a><span id="l5.16"> function MockDate(iso8601String) {</span>
<a href="#l5.17"></a><span id="l5.17">   // Find the timezone offset (Z or ±hhmm) from the ISO-8601 date string, and</span>
<a href="#l5.18"></a><span id="l5.18">   // then convert that into a number of minutes.</span>
<a href="#l5.19"></a><span id="l5.19">   let parse = /\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(Z|[+-]\d{4})/.exec(iso8601String);</span>
<a href="#l5.20"></a><span id="l5.20">   let tzOffsetStr = parse[1];</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineminus">-  if (tzOffsetStr == 'Z')</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+  if (tzOffsetStr == &quot;Z&quot;) {</span>
<a href="#l5.23"></a><span id="l5.23">     this._tzOffset = 0;</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-  else {</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+  } else {</span>
<a href="#l5.26"></a><span id="l5.26">     this._tzOffset = parseInt(tzOffsetStr.substring(1, 3)) * 60 +</span>
<a href="#l5.27"></a><span id="l5.27">       parseInt(tzOffsetStr.substring(3));</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-    if (tzOffsetStr[0] == '-')</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+    if (tzOffsetStr[0] == &quot;-&quot;)</span>
<a href="#l5.30"></a><span id="l5.30">       this._tzOffset = -this._tzOffset;</span>
<a href="#l5.31"></a><span id="l5.31">   }</span>
<a href="#l5.32"></a><span id="l5.32"> </span>
<a href="#l5.33"></a><span id="l5.33">   // To store the offset, we store both the real time in _realDate and a time</span>
<a href="#l5.34"></a><span id="l5.34">   // that is offset by the tzOffset in _shiftedDate. Only the getUTC* methods</span>
<a href="#l5.35"></a><span id="l5.35">   // should be used on these properties, to avoid problems caused by daylight</span>
<a href="#l5.36"></a><span id="l5.36">   // savings time or other timezone effects. This shifting is always legal</span>
<a href="#l5.37"></a><span id="l5.37">   // because ES6 is specified to assume that leap seconds do not exist, so there</span>
<a href="#l5.38"></a><span id="l5.38">   // are always 60 seconds in a minute.</span>
<a href="#l5.39"></a><span id="l5.39">   this._realDate = new Date(iso8601String);</span>
<a href="#l5.40"></a><span id="l5.40">   this._shiftedDate = new Date(this._realDate.getTime() +</span>
<a href="#l5.41"></a><span id="l5.41">     this._tzOffset * 60 * 1000);</span>
<a href="#l5.42"></a><span id="l5.42"> }</span>
<a href="#l5.43"></a><span id="l5.43"> MockDate.prototype = {</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-  getTimezoneOffset: function () {</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+  getTimezoneOffset() {</span>
<a href="#l5.46"></a><span id="l5.46">     // This property is reversed from how it's defined in ISO 8601, i.e.,</span>
<a href="#l5.47"></a><span id="l5.47">     // UTC +0100 needs to return -60.</span>
<a href="#l5.48"></a><span id="l5.48">     return -this._tzOffset;</span>
<a href="#l5.49"></a><span id="l5.49">   },</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-  getTime: function () {</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+  getTime() {</span>
<a href="#l5.52"></a><span id="l5.52">     return this._realDate.getTime();</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineminus">-  }</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+  },</span>
<a href="#l5.55"></a><span id="l5.55"> };</span>
<a href="#l5.56"></a><span id="l5.56"> </span>
<a href="#l5.57"></a><span id="l5.57"> // Provide an implementation of Date methods that will be need in JSMime. For</span>
<a href="#l5.58"></a><span id="l5.58"> // the time being, we only need .get* methods.</span>
<a href="#l5.59"></a><span id="l5.59"> for (let name of Object.getOwnPropertyNames(Date.prototype)) {</span>
<a href="#l5.60"></a><span id="l5.60">   // Only copy getters, not setters or x.toString.</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineminus">-  if (!name.startsWith('get'))</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+  if (!name.startsWith(&quot;get&quot;))</span>
<a href="#l5.63"></a><span id="l5.63">     continue;</span>
<a href="#l5.64"></a><span id="l5.64">   // No redefining any other names on MockDate.</span>
<a href="#l5.65"></a><span id="l5.65">   if (MockDate.prototype.hasOwnProperty(name))</span>
<a href="#l5.66"></a><span id="l5.66">     continue;</span>
<a href="#l5.67"></a><span id="l5.67"> </span>
<a href="#l5.68"></a><span id="l5.68" class="difflineminus">-  if (name.includes('UTC')) {</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+  if (name.includes(&quot;UTC&quot;)) {</span>
<a href="#l5.70"></a><span id="l5.70">     // 'name' is already supposed to be freshly bound per newest ES6 drafts, but</span>
<a href="#l5.71"></a><span id="l5.71">     // current ES6 implementations reuse the bindings. Until implementations</span>
<a href="#l5.72"></a><span id="l5.72">     // catch up, use a new let to bind it freshly.</span>
<a href="#l5.73"></a><span id="l5.73">     let boundName = name;</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineminus">-    Object.defineProperty(MockDate.prototype, name, { value: function(...aArgs) {</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineminus">-      return Date.prototype[boundName].call(this._realDate, aArgs);</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineminus">-    }});</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+    Object.defineProperty(MockDate.prototype, name, {</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+      value(...aArgs) {</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+        return Date.prototype[boundName].call(this._realDate, aArgs);</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+      },</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+    });</span>
<a href="#l5.82"></a><span id="l5.82">   } else {</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineminus">-    let newName = 'getUTC' + name.substr(3);</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineminus">-    Object.defineProperty(MockDate.prototype, name, { value: function(...aArgs) {</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineminus">-      return Date.prototype[newName].call(this._shiftedDate, aArgs);</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineminus">-    }});</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+    let newName = &quot;getUTC&quot; + name.substr(3);</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+    Object.defineProperty(MockDate.prototype, name, {</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+      value(...aArgs) {</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+        return Date.prototype[newName].call(this._shiftedDate, aArgs);</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+      },</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+    });</span>
<a href="#l5.93"></a><span id="l5.93">   }</span>
<a href="#l5.94"></a><span id="l5.94"> }</span>
<a href="#l5.95"></a><span id="l5.95"> </span>
<a href="#l5.96"></a><span id="l5.96"> return MockDate;</span>
<a href="#l5.97"></a><span id="l5.97"> });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/mime/jsmime/test/test_custom_headers.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/mime/jsmime/test/test_custom_headers.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1,69 +1,36 @@</span>
<a href="#l6.4"></a><span id="l6.4"> &quot;use strict&quot;;</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineminus">-define(function (require) {</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineminus">-</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineminus">-var assert = require('assert');</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineminus">-var jsmime = require('jsmime');</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineminus">-</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineminus">-function arrayTest(data, fn) {</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineminus">-  fn.toString = function () {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-    let text = Function.prototype.toString.call(this);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-    text = text.replace(/data\[([0-9]*)\]/g, function (m, p) {</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-      return JSON.stringify(data[p]);</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-    });</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-    return text;</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-  };</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-  return test(data[0], fn);</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-}</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+define(function(require) {</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+var assert = require(&quot;assert&quot;);</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+var jsmime = require(&quot;jsmime&quot;);</span>
<a href="#l6.23"></a><span id="l6.23"> </span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-function testHeader(header, tests) {</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">-  suite(header, function () {</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">-    tests.forEach(function (data) {</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineminus">-      arrayTest(data, function () {</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineminus">-        array.deepEqual(headerparser.parseStructuredHeader(header,</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">-          data[0]), data[1]);</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-      });</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-    });</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-  });</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-}</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-function makeCT(media, sub, params) {</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-  var object = new Map();</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">-  object.mediatype = media;</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-  object.subtype = sub;</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">-  object.type = media + &quot;/&quot; + sub;</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineminus">-  for (let k in params)</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">-    object.set(k, params[k]);</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-  return object;</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-}</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-suite('Custom decoder support', function () {</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+suite(&quot;Custom decoder support&quot;, function() {</span>
<a href="#l6.46"></a><span id="l6.46">   function customDecoder(values) {</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-    let value = values.join('');</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+    let value = values.join(&quot;&quot;);</span>
<a href="#l6.49"></a><span id="l6.49">     return atob(value);</span>
<a href="#l6.50"></a><span id="l6.50">   }</span>
<a href="#l6.51"></a><span id="l6.51">   function customEncoder(value) {</span>
<a href="#l6.52"></a><span id="l6.52">     this.addText(btoa(value), true);</span>
<a href="#l6.53"></a><span id="l6.53">   }</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-  test('addStructuredEncoder', function () {</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-    assert.equal('X-Base64: String\r\n',</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-      jsmime.headeremitter.emitStructuredHeader('X-Base64', 'String', {}));</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-    jsmime.headeremitter.addStructuredEncoder('X-Base64', customEncoder);</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-    assert.equal('X-Base64: U3RyaW5n\r\n',</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineminus">-      jsmime.headeremitter.emitStructuredHeader('X-Base64', 'String', {}));</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineminus">-    assert.equal('X-Base64: U3RyaW5n\r\n',</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineminus">-      jsmime.headeremitter.emitStructuredHeader('x-bASe64', 'String', {}));</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+  test(&quot;addStructuredEncoder&quot;, function() {</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+    assert.equal(&quot;X-Base64: String\r\n&quot;,</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+      jsmime.headeremitter.emitStructuredHeader(&quot;X-Base64&quot;, &quot;String&quot;, {}));</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+    jsmime.headeremitter.addStructuredEncoder(&quot;X-Base64&quot;, customEncoder);</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+    assert.equal(&quot;X-Base64: U3RyaW5n\r\n&quot;,</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+      jsmime.headeremitter.emitStructuredHeader(&quot;X-Base64&quot;, &quot;String&quot;, {}));</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+    assert.equal(&quot;X-Base64: U3RyaW5n\r\n&quot;,</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+      jsmime.headeremitter.emitStructuredHeader(&quot;x-bASe64&quot;, &quot;String&quot;, {}));</span>
<a href="#l6.70"></a><span id="l6.70">   });</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineminus">-  test('addStructuredDecoder', function () {</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineminus">-    assert.throws(function () {</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineminus">-      jsmime.headerparser.parseStructuredHeader('X-Base64', 'U3RyaW5n');</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+  test(&quot;addStructuredDecoder&quot;, function() {</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+    assert.throws(function() {</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+      jsmime.headerparser.parseStructuredHeader(&quot;X-Base64&quot;, &quot;U3RyaW5n&quot;);</span>
<a href="#l6.77"></a><span id="l6.77">     }, /Unknown structured header/);</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineminus">-    jsmime.headerparser.addStructuredDecoder('X-Base64', customDecoder);</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineminus">-    assert.equal('String',</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">-      jsmime.headerparser.parseStructuredHeader('X-Base64', 'U3RyaW5n'));</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-    assert.throws(function () {</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineminus">-      jsmime.headerparser.addStructuredDecoder('To', customDecoder);</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineplus">+    jsmime.headerparser.addStructuredDecoder(&quot;X-Base64&quot;, customDecoder);</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineplus">+    assert.equal(&quot;String&quot;,</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+      jsmime.headerparser.parseStructuredHeader(&quot;X-Base64&quot;, &quot;U3RyaW5n&quot;));</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineplus">+    assert.throws(function() {</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+      jsmime.headerparser.addStructuredDecoder(&quot;To&quot;, customDecoder);</span>
<a href="#l6.88"></a><span id="l6.88">     }, /Cannot override header/);</span>
<a href="#l6.89"></a><span id="l6.89">   });</span>
<a href="#l6.90"></a><span id="l6.90"> });</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">-</span>
<a href="#l6.92"></a><span id="l6.92"> });</span>
<a href="#l6.93"></a><span id="l6.93"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/mime/jsmime/test/test_header.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/mime/jsmime/test/test_header.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1,53 +1,52 @@</span>
<a href="#l7.4"></a><span id="l7.4"> &quot;use strict&quot;;</span>
<a href="#l7.5"></a><span id="l7.5"> define(function(require) {</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineminus">-</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineminus">-var headerparser = require('jsmime').headerparser;</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineminus">-var assert = require('assert');</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+var headerparser = require(&quot;jsmime&quot;).headerparser;</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+var assert = require(&quot;assert&quot;);</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12"> function arrayTest(data, fn) {</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-  fn.toString = function () {</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+  fn.toString = function() {</span>
<a href="#l7.15"></a><span id="l7.15">     let text = Function.prototype.toString.call(this);</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-    text = text.replace(/data\[([0-9]*)\]/g, function (m, p) {</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+    text = text.replace(/data\[([0-9]*)\]/g, function(m, p) {</span>
<a href="#l7.18"></a><span id="l7.18">       return JSON.stringify(data[p]);</span>
<a href="#l7.19"></a><span id="l7.19">     });</span>
<a href="#l7.20"></a><span id="l7.20">     return text;</span>
<a href="#l7.21"></a><span id="l7.21">   };</span>
<a href="#l7.22"></a><span id="l7.22">   return test(data[0], fn);</span>
<a href="#l7.23"></a><span id="l7.23"> }</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-suite('headerparser', function () {</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-  suite('parseParameterHeader', function () {</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+suite(&quot;headerparser&quot;, function() {</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+  suite(&quot;parseParameterHeader&quot;, function() {</span>
<a href="#l7.28"></a><span id="l7.28">     let header_tests = [</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-      ['multipart/related', [&quot;multipart/related&quot;, {}]],</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+      [&quot;multipart/related&quot;, [&quot;multipart/related&quot;, {}]],</span>
<a href="#l7.31"></a><span id="l7.31">       [&quot;a ; b=v&quot;, [&quot;a&quot;, {&quot;b&quot;: &quot;v&quot;}]],</span>
<a href="#l7.32"></a><span id="l7.32">       [&quot;a ; b='v'&quot;, [&quot;a&quot;, {&quot;b&quot;: &quot;'v'&quot;}]],</span>
<a href="#l7.33"></a><span id="l7.33">       ['a; b = &quot;v&quot;', [&quot;a&quot;, {&quot;b&quot;: &quot;v&quot;}]],</span>
<a href="#l7.34"></a><span id="l7.34">       [&quot;a;b=1;b=2&quot;, [&quot;a&quot;, {&quot;b&quot;: &quot;1&quot;}]],</span>
<a href="#l7.35"></a><span id="l7.35">       [&quot;a;b=2;b=1&quot;, [&quot;a&quot;, {&quot;b&quot;: &quot;2&quot;}]],</span>
<a href="#l7.36"></a><span id="l7.36">       ['a;b=&quot;a;b&quot;', [&quot;a&quot;, {&quot;b&quot;: &quot;a;b&quot;}]],</span>
<a href="#l7.37"></a><span id="l7.37">       ['a;b=&quot;\\\\&quot;', [&quot;a&quot;, {&quot;b&quot;: &quot;\\&quot;}]],</span>
<a href="#l7.38"></a><span id="l7.38">       ['a;b=&quot;a\\b\\c&quot;', [&quot;a&quot;, {&quot;b&quot;: &quot;abc&quot;}]],</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-      ['a;b=1;c=2', [&quot;a&quot;, {&quot;b&quot;: &quot;1&quot;, &quot;c&quot;: &quot;2&quot;}]],</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+      [&quot;a;b=1;c=2&quot;, [&quot;a&quot;, {&quot;b&quot;: &quot;1&quot;, &quot;c&quot;: &quot;2&quot;}]],</span>
<a href="#l7.41"></a><span id="l7.41">       ['a;b=&quot;a\\', [&quot;a&quot;, {&quot;b&quot;: &quot;a&quot;}]],</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-      ['a;b', [&quot;a&quot;, {}]],</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-      ['a;b=&quot;;&quot;;c=d', [&quot;a&quot;, {&quot;b&quot;: ';', 'c': &quot;d&quot;}]],</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+      [&quot;a;b&quot;, [&quot;a&quot;, {}]],</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+      ['a;b=&quot;;&quot;;c=d', [&quot;a&quot;, {&quot;b&quot;: &quot;;&quot;, &quot;c&quot;: &quot;d&quot;}]],</span>
<a href="#l7.46"></a><span id="l7.46">     ];</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineminus">-    header_tests.forEach(function (data) {</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-      arrayTest(data, function () {</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+    header_tests.forEach(function(data) {</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+      arrayTest(data, function() {</span>
<a href="#l7.51"></a><span id="l7.51">         let testMap = new Map();</span>
<a href="#l7.52"></a><span id="l7.52">         for (let key in data[1][1])</span>
<a href="#l7.53"></a><span id="l7.53">           testMap.set(key, data[1][1][key]);</span>
<a href="#l7.54"></a><span id="l7.54">         testMap.preSemi = data[1][0];</span>
<a href="#l7.55"></a><span id="l7.55">         assert.deepEqual(headerparser.parseParameterHeader(data[0], false, false),</span>
<a href="#l7.56"></a><span id="l7.56">           testMap);</span>
<a href="#l7.57"></a><span id="l7.57">       });</span>
<a href="#l7.58"></a><span id="l7.58">     });</span>
<a href="#l7.59"></a><span id="l7.59">   });</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineminus">-  suite('parseParameterHeader (2231/2047 support)', function () {</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+  suite(&quot;parseParameterHeader (2231/2047 support)&quot;, function() {</span>
<a href="#l7.62"></a><span id="l7.62">     let header_tests = [</span>
<a href="#l7.63"></a><span id="l7.63">       // Copied from test_MIME_params.js and adapted</span>
<a href="#l7.64"></a><span id="l7.64">       [&quot;attachment;&quot;, [&quot;attachment&quot;, {}]],</span>
<a href="#l7.65"></a><span id="l7.65">       [&quot;attachment; filename=basic&quot;, [&quot;attachment&quot;, {filename: &quot;basic&quot;}]],</span>
<a href="#l7.66"></a><span id="l7.66">       [&quot;attachment; filename=\&quot;\\\&quot;\&quot;&quot;, [&quot;attachment&quot;, {filename: '&quot;'}]],</span>
<a href="#l7.67"></a><span id="l7.67">       [&quot;attachment; filename=\&quot;\\x\&quot;&quot;, [&quot;attachment&quot;, {filename: &quot;x&quot;}]],</span>
<a href="#l7.68"></a><span id="l7.68">       [&quot;attachment; filename=\&quot;\&quot;&quot;, [&quot;attachment&quot;, {filename: &quot;&quot;}]],</span>
<a href="#l7.69"></a><span id="l7.69">       [&quot;attachment; filename=&quot;, [&quot;attachment&quot;, {filename: &quot;&quot;}]],</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineat">@@ -173,28 +172,28 @@ suite('headerparser', function () {</span>
<a href="#l7.71"></a><span id="l7.71">         [&quot;attachment&quot;, {extension: &quot;bla&quot;}]],</span>
<a href="#l7.72"></a><span id="l7.72">       [&quot;attachment; filename==?ISO-8859-1?Q?foo-=E4.html?=&quot;,</span>
<a href="#l7.73"></a><span id="l7.73">         [&quot;attachment&quot;, {filename: &quot;foo-\u00e4.html&quot;}]],</span>
<a href="#l7.74"></a><span id="l7.74">       [&quot;attachment; filename=\&quot;=?ISO-8859-1?Q?foo-=E4.html?=\&quot;&quot;,</span>
<a href="#l7.75"></a><span id="l7.75">         [&quot;attachment&quot;, {filename: &quot;foo-\u00e4.html&quot;}]],</span>
<a href="#l7.76"></a><span id="l7.76">       [&quot;attachment; filename=\&quot;=?ISO-8859-1?Q?foo-=E4.html?=\&quot;; filename*=UTF&quot; +</span>
<a href="#l7.77"></a><span id="l7.77">         &quot;-8''5987&quot;, [&quot;attachment&quot;, {filename: &quot;5987&quot;}]],</span>
<a href="#l7.78"></a><span id="l7.78">     ];</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-    header_tests.forEach(function (data) {</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-      arrayTest(data, function () {</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+    header_tests.forEach(function(data) {</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+      arrayTest(data, function() {</span>
<a href="#l7.83"></a><span id="l7.83">         let testMap = new Map();</span>
<a href="#l7.84"></a><span id="l7.84">         for (let key in data[1][1])</span>
<a href="#l7.85"></a><span id="l7.85">           testMap.set(key, data[1][1][key]);</span>
<a href="#l7.86"></a><span id="l7.86">         testMap.preSemi = data[1][0];</span>
<a href="#l7.87"></a><span id="l7.87">         assert.deepEqual(headerparser.parseParameterHeader(data[0], true, true),</span>
<a href="#l7.88"></a><span id="l7.88">           testMap);</span>
<a href="#l7.89"></a><span id="l7.89">       });</span>
<a href="#l7.90"></a><span id="l7.90">     });</span>
<a href="#l7.91"></a><span id="l7.91">   });</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineminus">-  suite('parseAddressingHeader', function () {</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+  suite(&quot;parseAddressingHeader&quot;, function() {</span>
<a href="#l7.94"></a><span id="l7.94">     let header_tests = [</span>
<a href="#l7.95"></a><span id="l7.95">       [&quot;&quot;, []],</span>
<a href="#l7.96"></a><span id="l7.96">       [&quot;Joe Schmoe &lt;jschmoe@invalid.invalid&gt;&quot;,</span>
<a href="#l7.97"></a><span id="l7.97">         [{name: &quot;Joe Schmoe&quot;, email: &quot;jschmoe@invalid.invalid&quot;}]],</span>
<a href="#l7.98"></a><span id="l7.98">       [&quot;user@tinderbox.invalid&quot;,</span>
<a href="#l7.99"></a><span id="l7.99">         [{name: &quot;&quot;, email: &quot;user@tinderbox.invalid&quot;}]],</span>
<a href="#l7.100"></a><span id="l7.100">       [&quot;Hello Kitty &lt;a@b.c&gt;, No Kitty &lt;b@b.c&gt;&quot;,</span>
<a href="#l7.101"></a><span id="l7.101">         [{name: &quot;Hello Kitty&quot;, email: &quot;a@b.c&quot;},</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineat">@@ -235,17 +234,17 @@ suite('headerparser', function () {</span>
<a href="#l7.103"></a><span id="l7.103">          [{name: &quot;Joe Q. Public&quot;, email: &quot;john.q.public@example.com&quot;},</span>
<a href="#l7.104"></a><span id="l7.104">           {name: &quot;Test&quot;, email: &quot;\&quot;abc!x.yz\&quot;@foo.invalid&quot;},</span>
<a href="#l7.105"></a><span id="l7.105">           {name: &quot;Test&quot;, email: &quot;test@[xyz!]&quot;},</span>
<a href="#l7.106"></a><span id="l7.106">           {name: &quot;Giant; \&quot;Big\&quot; Box&quot;, email: &quot;sysservices@example.net&quot;}]],</span>
<a href="#l7.107"></a><span id="l7.107">       [&quot;Unfortunate breaking &lt; so . many . spaces @ here . invalid &gt;&quot;,</span>
<a href="#l7.108"></a><span id="l7.108">         [{name: &quot;Unfortunate breaking&quot;, email: &quot;so.many.spaces@here.invalid&quot;}]],</span>
<a href="#l7.109"></a><span id="l7.109">       [&quot;so . many . spaces @ here . invalid&quot;,</span>
<a href="#l7.110"></a><span id="l7.110">         [{name: &quot;&quot;, email: &quot;so.many.spaces@here.invalid&quot;}]],</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineminus">-      [&quot;abc@foo.invalid&quot;, [{name:&quot;&quot;, email: &quot;abc@foo.invalid&quot;}]],</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+      [&quot;abc@foo.invalid&quot;, [{name: &quot;&quot;, email: &quot;abc@foo.invalid&quot;}]],</span>
<a href="#l7.113"></a><span id="l7.113">       [&quot;foo &lt;ghj@foo.invalid&gt;&quot;, [{name: &quot;foo&quot;, email: &quot;ghj@foo.invalid&quot;}]],</span>
<a href="#l7.114"></a><span id="l7.114">       [&quot;abc@foo.invalid, foo &lt;ghj@foo.invalid&gt;&quot;,</span>
<a href="#l7.115"></a><span id="l7.115">         [{name: &quot;&quot;, email: &quot;abc@foo.invalid&quot;},</span>
<a href="#l7.116"></a><span id="l7.116">          {name: &quot;foo&quot;, email: &quot;ghj@foo.invalid&quot;}]],</span>
<a href="#l7.117"></a><span id="l7.117">       [&quot;foo bar &lt;foo@bar.invalid&gt;&quot;,</span>
<a href="#l7.118"></a><span id="l7.118">         [{name: &quot;foo bar&quot;, email: &quot;foo@bar.invalid&quot;}]],</span>
<a href="#l7.119"></a><span id="l7.119">       [&quot;foo bar &lt;foo@bar.invalid&gt;, abc@foo.invalid, foo &lt;ghj@foo.invalid&gt;&quot;,</span>
<a href="#l7.120"></a><span id="l7.120">         [{name: &quot;foo bar&quot;, email: &quot;foo@bar.invalid&quot;},</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineat">@@ -277,24 +276,24 @@ suite('headerparser', function () {</span>
<a href="#l7.122"></a><span id="l7.122">       ['&quot;foo bar&quot; &lt;me@foo.invalid&gt;, &quot;bar foo&quot; &lt;me2@foo.invalid&gt;',</span>
<a href="#l7.123"></a><span id="l7.123">         [{name: &quot;foo bar&quot;, email: &quot;me@foo.invalid&quot;},</span>
<a href="#l7.124"></a><span id="l7.124">          {name: &quot;bar foo&quot;, email: &quot;me2@foo.invalid&quot;}]],</span>
<a href="#l7.125"></a><span id="l7.125">       [&quot;A Group:Ed Jones &lt;c@a.invalid&gt;,joe@where.invalid,John &lt;jdoe@one.invalid&gt;;&quot;,</span>
<a href="#l7.126"></a><span id="l7.126">         [{name: &quot;A Group&quot;, group: [</span>
<a href="#l7.127"></a><span id="l7.127">           {name: &quot;Ed Jones&quot;, email: &quot;c@a.invalid&quot;},</span>
<a href="#l7.128"></a><span id="l7.128">           {name: &quot;&quot;, email: &quot;joe@where.invalid&quot;},</span>
<a href="#l7.129"></a><span id="l7.129">           {name: &quot;John&quot;, email: &quot;jdoe@one.invalid&quot;}]}]],</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineminus">-      ['mygroup:;, empty:;, foo@foo.invalid, othergroup:bar@foo.invalid, bar2' +</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineminus">-        '@foo.invalid;,       y@y.invalid, empty:;',</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineplus">+      [&quot;mygroup:;, empty:;, foo@foo.invalid, othergroup:bar@foo.invalid, bar2&quot; +</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineplus">+        &quot;@foo.invalid;,       y@y.invalid, empty:;&quot;,</span>
<a href="#l7.134"></a><span id="l7.134">         [{name: &quot;mygroup&quot;, group: []},</span>
<a href="#l7.135"></a><span id="l7.135">          {name: &quot;empty&quot;, group: []},</span>
<a href="#l7.136"></a><span id="l7.136">          {name: &quot;&quot;, email: &quot;foo@foo.invalid&quot;},</span>
<a href="#l7.137"></a><span id="l7.137">          {name: &quot;othergroup&quot;, group: [</span>
<a href="#l7.138"></a><span id="l7.138">            {name: &quot;&quot;, email: &quot;bar@foo.invalid&quot;},</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineminus">-           {name: &quot;&quot;, email: &quot;bar2@foo.invalid&quot;}</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineplus">+           {name: &quot;&quot;, email: &quot;bar2@foo.invalid&quot;},</span>
<a href="#l7.141"></a><span id="l7.141">          ]},</span>
<a href="#l7.142"></a><span id="l7.142">          {name: &quot;&quot;, email: &quot;y@y.invalid&quot;},</span>
<a href="#l7.143"></a><span id="l7.143">          {name: &quot;empty&quot;, group: []}]],</span>
<a href="#l7.144"></a><span id="l7.144">       [&quot;Undisclosed recipients:;;;;;;;;;;;;;;;;,,,,,,,,,,,,,,,,&quot;,</span>
<a href="#l7.145"></a><span id="l7.145">         [{name: &quot;Undisclosed recipients&quot;, group: []}]],</span>
<a href="#l7.146"></a><span id="l7.146">       [&quot;a@xxx.invalid; b@xxx.invalid&quot;,</span>
<a href="#l7.147"></a><span id="l7.147">         [{name: &quot;&quot;, email: &quot;a@xxx.invalid&quot;},</span>
<a href="#l7.148"></a><span id="l7.148">          {name: &quot;&quot;, email: &quot;b@xxx.invalid&quot;}]],</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineat">@@ -308,36 +307,36 @@ suite('headerparser', function () {</span>
<a href="#l7.150"></a><span id="l7.150">         [{name: &quot;A&quot;, email: &quot;a@xxx.invalid&quot;},</span>
<a href="#l7.151"></a><span id="l7.151">          {name: &quot;B&quot;, email: &quot;b@xxx.invalid&quot;}]],</span>
<a href="#l7.152"></a><span id="l7.152">       [&quot;A (this: is, a comment;) &lt;a.invalid&gt;; g:   (this: is, &lt;a&gt; comment;) C&quot; +</span>
<a href="#l7.153"></a><span id="l7.153">         &quot;&lt;c.invalid&gt;, d.invalid;&quot;,</span>
<a href="#l7.154"></a><span id="l7.154">         [{name: &quot;A (this: is, a comment;)&quot;, email: &quot;a.invalid&quot;},</span>
<a href="#l7.155"></a><span id="l7.155">          {name: &quot;g&quot;, group: [</span>
<a href="#l7.156"></a><span id="l7.156">            {name: &quot;(this: is, &lt;a&gt; comment;) C&quot;, email: &quot;c.invalid&quot;},</span>
<a href="#l7.157"></a><span id="l7.157">            {name: &quot;d.invalid&quot;, email: &quot;&quot;}]}]],</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineminus">-      ['Mary Smith &lt;mary@x.invalid&gt;, extra:;, group:jdoe@example.invalid; Who' +</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineplus">+      [&quot;Mary Smith &lt;mary@x.invalid&gt;, extra:;, group:jdoe@example.invalid; Who&quot; +</span>
<a href="#l7.160"></a><span id="l7.160">         '? &lt;one@y.invalid&gt;; &lt;boss@nil.invalid&gt;, &quot;Giant; \\&quot;Big\\&quot; Box&quot; &lt;sysse' +</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineminus">-        'rvices@example.invalid&gt;,         ',</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineplus">+        &quot;rvices@example.invalid&gt;,         &quot;,</span>
<a href="#l7.163"></a><span id="l7.163">         [{name: &quot;Mary Smith&quot;, email: &quot;mary@x.invalid&quot;},</span>
<a href="#l7.164"></a><span id="l7.164">          {name: &quot;extra&quot;, group: []},</span>
<a href="#l7.165"></a><span id="l7.165">          {name: &quot;group&quot;, group: [{name: &quot;&quot;, email: &quot;jdoe@example.invalid&quot;}]},</span>
<a href="#l7.166"></a><span id="l7.166">          {name: &quot;Who?&quot;, email: &quot;one@y.invalid&quot;},</span>
<a href="#l7.167"></a><span id="l7.167">          {name: &quot;&quot;, email: &quot;boss@nil.invalid&quot;},</span>
<a href="#l7.168"></a><span id="l7.168">          {name: &quot;Giant; \&quot;Big\&quot; Box&quot;, email: &quot;sysservices@example.invalid&quot;}]],</span>
<a href="#l7.169"></a><span id="l7.169">       [&quot;Undisclosed recipients: a@foo.invalid ;;extra:;&quot;,</span>
<a href="#l7.170"></a><span id="l7.170">         [{name: &quot;Undisclosed recipients&quot;, group: [</span>
<a href="#l7.171"></a><span id="l7.171">           {name: &quot;&quot;, email: &quot;a@foo.invalid&quot;}]},</span>
<a href="#l7.172"></a><span id="l7.172">          {name: &quot;extra&quot;, group: []}]],</span>
<a href="#l7.173"></a><span id="l7.173">       [&quot;Undisclosed recipients:;;extra:a@foo.invalid;&quot;,</span>
<a href="#l7.174"></a><span id="l7.174">         [{name: &quot;Undisclosed recipients&quot;, group: []},</span>
<a href="#l7.175"></a><span id="l7.175">          {name: &quot;extra&quot;, group: [{name: &quot;&quot;, email: &quot;a@foo.invalid&quot;}]}]],</span>
<a href="#l7.176"></a><span id="l7.176">       [&quot;a &lt; &lt;a@b.c&gt;&quot;, [{name: &quot;a&quot;, email: &quot;a@b.c&quot;}]],</span>
<a href="#l7.177"></a><span id="l7.177">       [&quot;Name &lt;incomplete@email&quot;, [{name: &quot;Name&quot;, email: &quot;incomplete@email&quot;}]],</span>
<a href="#l7.178"></a><span id="l7.178">       [&quot;Name &lt;space here@email.invalid&gt;&quot;,</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineminus">-        [{name: 'Name', email: '&quot;space here&quot;@email.invalid'}]],</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineplus">+        [{name: &quot;Name&quot;, email: '&quot;space here&quot;@email.invalid'}]],</span>
<a href="#l7.181"></a><span id="l7.181">       [&quot;Name &lt;not an email&gt;&quot;, [{name: &quot;Name&quot;, email: &quot;not an email&quot;}]],</span>
<a href="#l7.182"></a><span id="l7.182">       [&quot;=?UTF-8?Q?Simple?= &lt;a@b.c&gt;&quot;,</span>
<a href="#l7.183"></a><span id="l7.183">         [{name: &quot;=?UTF-8?Q?Simple?=&quot;, email: &quot;a@b.c&quot;}]],</span>
<a href="#l7.184"></a><span id="l7.184">       [&quot;No email address&quot;, [{name: &quot;No email address&quot;, email: &quot;&quot;}]],</span>
<a href="#l7.185"></a><span id="l7.185">       // Thought we were parsing an address, but it was a name.</span>
<a href="#l7.186"></a><span id="l7.186">       [&quot;name@example.com &lt;receiver@example.com&gt;&quot;,</span>
<a href="#l7.187"></a><span id="l7.187">         [{name: &quot;name@example.com&quot;, email: &quot;receiver@example.com&quot;}]],</span>
<a href="#l7.188"></a><span id="l7.188">       [&quot;name@huhu.com &lt;receiver@example.com&gt;&quot;,</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineat">@@ -360,24 +359,24 @@ suite('headerparser', function () {</span>
<a href="#l7.190"></a><span id="l7.190">         [{name: &quot;(c1) n (c2) (c9(c10)c11) (c12)&quot;, email: &quot;a@b.d&quot;}]],</span>
<a href="#l7.191"></a><span id="l7.191">       [&quot;&lt;(c3)a(c4)@(c5)b(c6).(c7)d(c8)&gt; (c9(c10)c11)(c12)&quot;,</span>
<a href="#l7.192"></a><span id="l7.192">         [{name: &quot;(c9(c10)c11) (c12)&quot;, email: &quot;a@b.d&quot;}]],</span>
<a href="#l7.193"></a><span id="l7.193">       [&quot;(c3)a(c4)@(c5)b(c6).(c7)d(c8)(c9(c10)c11)(c12)&quot;, [{name: &quot;c12&quot;, email: &quot;a@b.d&quot;}]],</span>
<a href="#l7.194"></a><span id="l7.194">       // Collapse extraneous whitespace.</span>
<a href="#l7.195"></a><span id="l7.195">       [&quot;Friend \&quot;&lt;friend@huhu.com&gt;\&quot;                                \t &lt;ws@example.com&gt;&quot;,</span>
<a href="#l7.196"></a><span id="l7.196">         [{name: &quot;Friend &lt;friend@huhu.com&gt;&quot;, email: &quot;ws@example.com&quot;}]],</span>
<a href="#l7.197"></a><span id="l7.197">     ];</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineminus">-    header_tests.forEach(function (data) {</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineminus">-      arrayTest(data, function () {</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineplus">+    header_tests.forEach(function(data) {</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineplus">+      arrayTest(data, function() {</span>
<a href="#l7.202"></a><span id="l7.202">         assert.deepEqual(headerparser.parseAddressingHeader(data[0], false),</span>
<a href="#l7.203"></a><span id="l7.203">           data[1]);</span>
<a href="#l7.204"></a><span id="l7.204">       });</span>
<a href="#l7.205"></a><span id="l7.205">     });</span>
<a href="#l7.206"></a><span id="l7.206">   });</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineminus">-  suite('parseAddressingHeader (RFC 2047 support)', function () {</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineplus">+  suite(&quot;parseAddressingHeader (RFC 2047 support)&quot;, function() {</span>
<a href="#l7.209"></a><span id="l7.209">     let header_tests = [</span>
<a href="#l7.210"></a><span id="l7.210">       [&quot;Simple &lt;a@b.c&gt;&quot;, [{name: &quot;Simple&quot;, email: &quot;a@b.c&quot;}]],</span>
<a href="#l7.211"></a><span id="l7.211">       [&quot;=?UTF-8?Q?Simple?= &lt;a@b.c&gt;&quot;, [{name: &quot;Simple&quot;, email: &quot;a@b.c&quot;}]],</span>
<a href="#l7.212"></a><span id="l7.212">       [&quot;=?UTF-8?Q?=3C@b.c?= &lt;a@b.c&gt;&quot;, [{name: &quot;&lt;@b.c&quot;, email: &quot;a@b.c&quot;}]],</span>
<a href="#l7.213"></a><span id="l7.213"> </span>
<a href="#l7.214"></a><span id="l7.214">       // RFC 2047 tokens should not interfere with lexical processing</span>
<a href="#l7.215"></a><span id="l7.215">       [&quot;=?UTF-8?Q?a@b.c,?= &lt;b@b.c&gt;&quot;, [{name: &quot;a@b.c,&quot;, email: &quot;b@b.c&quot;}]],</span>
<a href="#l7.216"></a><span id="l7.216">       [&quot;=?UTF-8?Q?a@b.c=2C?= &lt;b@b.c&gt;&quot;, [{name: &quot;a@b.c,&quot;, email: &quot;b@b.c&quot;}]],</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineat">@@ -392,45 +391,45 @@ suite('headerparser', function () {</span>
<a href="#l7.218"></a><span id="l7.218">       [&quot;=?ISO-8859-1?Q?Joe_L=F6we?= &lt;jl3@b.c&gt; (c2)&quot;, [{name: &quot;Joe Löwe (c2)&quot;, email: &quot;jl3@b.c&quot;}]],</span>
<a href="#l7.219"></a><span id="l7.219">       [&quot;(=?ISO-8859-1?Q?Joe_L=F6we?=) &lt;jl3@b.c&gt; (c2)&quot;, [{name: &quot;(Joe Löwe) (c2)&quot;, email: &quot;jl3@b.c&quot;}]],</span>
<a href="#l7.220"></a><span id="l7.220">       // Bug 1141446: Malformed From addresses with erroneous quotes,</span>
<a href="#l7.221"></a><span id="l7.221">       // note: acute accents: a \u00E1, e \u00E9, i \u00ED, o \u00F3, u \u00FA.</span>
<a href="#l7.222"></a><span id="l7.222">       [&quot;\&quot;=?UTF-8?Q?Jazzy_Fern=C3=A1ndez_Nunoz?= jazzy.f.nunoz@example.com &quot; +</span>
<a href="#l7.223"></a><span id="l7.223">         &quot;[BCN-FC]\&quot; &lt;Barcelona-Freecycle-noreply@yahoogroups.com&gt;&quot;,</span>
<a href="#l7.224"></a><span id="l7.224">         [{name: &quot;Jazzy Fern\u00E1ndez Nunoz jazzy.f.nunoz@example.com [BCN-FC]&quot;,</span>
<a href="#l7.225"></a><span id="l7.225">           email: &quot;Barcelona-Freecycle-noreply@yahoogroups.com&quot;}]],</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineminus">-      [&quot;\&quot;=?UTF-8?B?TWlyaWFtIEJlcm5hYsOpIFBlcmVsbMOz?= miriam@example.com &quot;+</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineplus">+      [&quot;\&quot;=?UTF-8?B?TWlyaWFtIEJlcm5hYsOpIFBlcmVsbMOz?= miriam@example.com &quot; +</span>
<a href="#l7.228"></a><span id="l7.228">         &quot;[BCN-FC]\&quot; &lt;Barcelona-Freecycle-noreply@yahoogroups.com&gt;&quot;,</span>
<a href="#l7.229"></a><span id="l7.229">         [{name: &quot;Miriam Bernab\u00E9 Perell\u00F3 miriam@example.com [BCN-FC]&quot;,</span>
<a href="#l7.230"></a><span id="l7.230">           email: &quot;Barcelona-Freecycle-noreply@yahoogroups.com&quot;}]],</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineminus">-      [&quot;\&quot;=?iso-8859-1?Q?First_Mar=EDa_Furi=F3_Gancho?= mail@yahoo.es &quot;+</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineplus">+      [&quot;\&quot;=?iso-8859-1?Q?First_Mar=EDa_Furi=F3_Gancho?= mail@yahoo.es &quot; +</span>
<a href="#l7.233"></a><span id="l7.233">         &quot;[BCN-FC]\&quot; &lt;Barcelona-Freecycle-noreply@yahoogroups.com&gt;&quot;,</span>
<a href="#l7.234"></a><span id="l7.234">         [{name: &quot;First Mar\u00EDa Furi\u00F3 Gancho mail@yahoo.es [BCN-FC]&quot;,</span>
<a href="#l7.235"></a><span id="l7.235">           email: &quot;Barcelona-Freecycle-noreply@yahoogroups.com&quot;}]],</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineminus">-      [&quot;\&quot;=?iso-8859-1?B?U29maWEgQ2FzdGVsbPMgUm9tZXJv?= sonia@example.com &quot;+</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineplus">+      [&quot;\&quot;=?iso-8859-1?B?U29maWEgQ2FzdGVsbPMgUm9tZXJv?= sonia@example.com &quot; +</span>
<a href="#l7.238"></a><span id="l7.238">         &quot;[BCN-FC]\&quot; &lt;Barcelona-Freecycle-noreply@yahoogroups.com&gt;&quot;,</span>
<a href="#l7.239"></a><span id="l7.239">         [{name: &quot;Sofia Castell\u00F3 Romero sonia@example.com [BCN-FC]&quot;,</span>
<a href="#l7.240"></a><span id="l7.240">           email: &quot;Barcelona-Freecycle-noreply@yahoogroups.com&quot;}]],</span>
<a href="#l7.241"></a><span id="l7.241">       [&quot;=?iso-8859-1?Q?Klaus_Eisschl=E4ger_=28k=2Eeisschlaeger=40t-onli?=&quot; +</span>
<a href="#l7.242"></a><span id="l7.242">         &quot;=?iso-8859-1?Q?ne=2Ede=29?= &lt;k.eisschlaeger@t-online.de&gt;&quot;,</span>
<a href="#l7.243"></a><span id="l7.243">         [{name: &quot;Klaus Eisschläger (k.eisschlaeger@t-online.de)&quot;,</span>
<a href="#l7.244"></a><span id="l7.244">           email: &quot;k.eisschlaeger@t-online.de&quot;}]],</span>
<a href="#l7.245"></a><span id="l7.245">       [&quot;\&quot;=?UTF-8?Q?=22Claudia_R=C3=B6hschicht=22?= Claudia_Roehschicht@web.de [freecycle-berlin]\&quot; &quot; +</span>
<a href="#l7.246"></a><span id="l7.246">         &quot;&lt;freecycle-berlin-noreply@yahoogroups.de&gt;&quot;,</span>
<a href="#l7.247"></a><span id="l7.247">         [{name: &quot;\&quot;Claudia Röhschicht\&quot; Claudia_Roehschicht@web.de [freecycle-berlin]&quot;,</span>
<a href="#l7.248"></a><span id="l7.248">           email: &quot;freecycle-berlin-noreply@yahoogroups.de&quot;}]],</span>
<a href="#l7.249"></a><span id="l7.249">     ];</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineminus">-    header_tests.forEach(function (data) {</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineminus">-      arrayTest(data, function () {</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineplus">+    header_tests.forEach(function(data) {</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineplus">+      arrayTest(data, function() {</span>
<a href="#l7.254"></a><span id="l7.254">         assert.deepEqual(headerparser.parseAddressingHeader(data[0], true),</span>
<a href="#l7.255"></a><span id="l7.255">           data[1]);</span>
<a href="#l7.256"></a><span id="l7.256">       });</span>
<a href="#l7.257"></a><span id="l7.257">     });</span>
<a href="#l7.258"></a><span id="l7.258">   });</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineminus">-  suite('parseDateHeader', function () {</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineplus">+  suite(&quot;parseDateHeader&quot;, function() {</span>
<a href="#l7.261"></a><span id="l7.261">     let header_tests = [</span>
<a href="#l7.262"></a><span id="l7.262">       // Some basic tests, derived from searching for Date headers in a mailing</span>
<a href="#l7.263"></a><span id="l7.263">       // list archive.</span>
<a href="#l7.264"></a><span id="l7.264">       [&quot;Thu, 06 Sep 2012 08:08:21 -0700&quot;, &quot;2012-09-06T08:08:21-0700&quot;],</span>
<a href="#l7.265"></a><span id="l7.265">       [&quot;Thu, 6 Sep 2012 14:49:05 -0400&quot;, &quot;2012-09-06T14:49:05-0400&quot;],</span>
<a href="#l7.266"></a><span id="l7.266">       [&quot;Fri, 07 Sep 2012 07:30:11 -0700 (PDT)&quot;, &quot;2012-09-07T07:30:11-0700&quot;],</span>
<a href="#l7.267"></a><span id="l7.267">       [&quot;9 Sep 2012 21:03:59 -0000&quot;, &quot;2012-09-09T21:03:59Z&quot;],</span>
<a href="#l7.268"></a><span id="l7.268">       [&quot;Sun, 09 Sep 2012 19:10:59 -0400&quot;, &quot;2012-09-09T19:10:59-0400&quot;],</span>
<a href="#l7.269"></a><span id="l7.269" class="difflineat">@@ -506,27 +505,27 @@ suite('headerparser', function () {</span>
<a href="#l7.270"></a><span id="l7.270">       [&quot;Lun, 01 Apr 2014 15:04:13 -0500&quot;, &quot;2014-04-01T15:04:13-0500&quot;],</span>
<a href="#l7.271"></a><span id="l7.271">       [&quot;Mar, 02 Apr 2014 15:04:13 -0500&quot;, &quot;2014-04-02T15:04:13-0500&quot;],</span>
<a href="#l7.272"></a><span id="l7.272">       [&quot;Mar, 02 April 2014 15:04:13 -0500&quot;, &quot;2014-04-02T15:04:13-0500&quot;],</span>
<a href="#l7.273"></a><span id="l7.273">       [&quot;Mar, 02 Avr 2014 15:04:13 -0500&quot;, NaN],</span>
<a href="#l7.274"></a><span id="l7.274">       [&quot;Tue, 02 A 2014 15:04:13 -0500&quot;, NaN],</span>
<a href="#l7.275"></a><span id="l7.275"> </span>
<a href="#l7.276"></a><span id="l7.276"> </span>
<a href="#l7.277"></a><span id="l7.277">       // A truly invalid date</span>
<a href="#l7.278"></a><span id="l7.278" class="difflineminus">-      [&quot;Coincident with the rapture&quot;, NaN]</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineplus">+      [&quot;Coincident with the rapture&quot;, NaN],</span>
<a href="#l7.280"></a><span id="l7.280">     ];</span>
<a href="#l7.281"></a><span id="l7.281" class="difflineminus">-    header_tests.forEach(function (data) {</span>
<a href="#l7.282"></a><span id="l7.282" class="difflineminus">-      arrayTest(data, function () {</span>
<a href="#l7.283"></a><span id="l7.283" class="difflineplus">+    header_tests.forEach(function(data) {</span>
<a href="#l7.284"></a><span id="l7.284" class="difflineplus">+      arrayTest(data, function() {</span>
<a href="#l7.285"></a><span id="l7.285">         assert.equal(headerparser.parseDateHeader(data[0]).toString(),</span>
<a href="#l7.286"></a><span id="l7.286">           new Date(data[1]).toString());</span>
<a href="#l7.287"></a><span id="l7.287">       });</span>
<a href="#l7.288"></a><span id="l7.288">     });</span>
<a href="#l7.289"></a><span id="l7.289">   });</span>
<a href="#l7.290"></a><span id="l7.290"> </span>
<a href="#l7.291"></a><span id="l7.291" class="difflineminus">-  suite('decodeRFC2047Words', function () {</span>
<a href="#l7.292"></a><span id="l7.292" class="difflineplus">+  suite(&quot;decodeRFC2047Words&quot;, function() {</span>
<a href="#l7.293"></a><span id="l7.293">     let header_tests = [</span>
<a href="#l7.294"></a><span id="l7.294">       // Some basic sanity tests for the test process</span>
<a href="#l7.295"></a><span id="l7.295">       [&quot;Test&quot;, &quot;Test&quot;],</span>
<a href="#l7.296"></a><span id="l7.296">       [&quot;Test 2&quot;, &quot;Test 2&quot;],</span>
<a href="#l7.297"></a><span id="l7.297">       [&quot;Basic  words&quot;, &quot;Basic  words&quot;],</span>
<a href="#l7.298"></a><span id="l7.298">       [&quot;Not a =? word&quot;, &quot;Not a =? word&quot;],</span>
<a href="#l7.299"></a><span id="l7.299"> </span>
<a href="#l7.300"></a><span id="l7.300">       // Simple 2047 decodings</span>
<a href="#l7.301"></a><span id="l7.301" class="difflineat">@@ -563,17 +562,17 @@ suite('headerparser', function () {</span>
<a href="#l7.302"></a><span id="l7.302">       [&quot;=?UTF-8?B?8J+SqQ==?=&quot;, &quot;\ud83d\udca9&quot;],</span>
<a href="#l7.303"></a><span id="l7.303">       // The goal for the next one is to be a non-BMP in a non-full-Unicode</span>
<a href="#l7.304"></a><span id="l7.304">       // charset. The only category where this exists is a small set of</span>
<a href="#l7.305"></a><span id="l7.305">       // characters in Big5, which were previously mapped to a PUA in an older</span>
<a href="#l7.306"></a><span id="l7.306">       // version but then reassigned to Plane 1. However, Big5 is really a set</span>
<a href="#l7.307"></a><span id="l7.307">       // of slightly different, slightly incompatible charsets.</span>
<a href="#l7.308"></a><span id="l7.308">       // TODO: This requires future investigation. Bug 912470 discusses the</span>
<a href="#l7.309"></a><span id="l7.309">       // changes to Big5 proposed within Mozilla.</span>
<a href="#l7.310"></a><span id="l7.310" class="difflineminus">-      //[&quot;=?Big5?Q?=87E?=&quot;, &quot;\ud85c\ude67&quot;],</span>
<a href="#l7.311"></a><span id="l7.311" class="difflineplus">+      // [&quot;=?Big5?Q?=87E?=&quot;, &quot;\ud85c\ude67&quot;],</span>
<a href="#l7.312"></a><span id="l7.312">       [&quot;=?GB18030?B?lDnaMw==?=&quot;, &quot;\ud83d\udca9&quot;],</span>
<a href="#l7.313"></a><span id="l7.313"> </span>
<a href="#l7.314"></a><span id="l7.314">       // How to handle breaks in multi-byte encoding</span>
<a href="#l7.315"></a><span id="l7.315">       [&quot;=?UTF-8?Q?=f0=9f?= =?UTF-8?Q?=92=a9?=&quot;, &quot;\ud83d\udca9&quot;],</span>
<a href="#l7.316"></a><span id="l7.316">       [&quot;=?UTF-8?B?8J+S?= =?UTF-8?B?qQ==?=&quot;, &quot;\ud83d\udca9&quot;],</span>
<a href="#l7.317"></a><span id="l7.317">       [&quot;=?UTF-8?B?8J+S?= =?UTF-8?Q?=a9?=&quot;, &quot;\ud83d\udca9&quot;],</span>
<a href="#l7.318"></a><span id="l7.318">       [&quot;=?UTF-8?B?8J+S?= =?ISO-8859-1?B?qQ==?=&quot;, &quot;\ufffd\u00a9&quot;],</span>
<a href="#l7.319"></a><span id="l7.319">       [&quot;=?UTF-8?Q?=f0?= =?UTF-8?Q?ab?=&quot;, &quot;\ufffdab&quot;],</span>
<a href="#l7.320"></a><span id="l7.320" class="difflineat">@@ -603,24 +602,24 @@ suite('headerparser', function () {</span>
<a href="#l7.321"></a><span id="l7.321">         &quot;==?=\n =?UTF-8?B?ICDiiIkgIOKIiiAg4oiLICDiiIwgIOKIjSAg4oiOICDiiI8=?=&quot;,</span>
<a href="#l7.322"></a><span id="l7.322">         &quot;\u2200  \u2201  \u2202  \u2203  \u2204  \u2205  \u2206  \u2207  &quot; +</span>
<a href="#l7.323"></a><span id="l7.323">         &quot;\u2208  \u2209  \u220a  \u220b  \u220c  \u220d  \u220e  \u220f&quot;],</span>
<a href="#l7.324"></a><span id="l7.324">       [&quot;=?UTF-8?b?4oiAICDiiIEgIOKIgiAg4oiDICDiiIQgIOKIhSAg4oiGICDiiIcgIOKIiA&quot; +</span>
<a href="#l7.325"></a><span id="l7.325">         &quot;==?=\n =?UTF-8?b?ICDiiIkgIOKIiiAg4oiLICDiiIwgIOKIjSAg4oiOICDiiI8=?=&quot;,</span>
<a href="#l7.326"></a><span id="l7.326">         &quot;\u2200  \u2201  \u2202  \u2203  \u2204  \u2205  \u2206  \u2207  &quot; +</span>
<a href="#l7.327"></a><span id="l7.327">         &quot;\u2208  \u2209  \u220a  \u220b  \u220c  \u220d  \u220e  \u220f&quot;],</span>
<a href="#l7.328"></a><span id="l7.328">       [&quot;=?utf-8?Q?=E2=88=80__=E2=88=81__=E2=88=82__=E2=88=83__=E2=88=84__?=\n&quot; +</span>
<a href="#l7.329"></a><span id="l7.329" class="difflineminus">-       &quot; =?utf-8?Q?=E2=88=85__=E2=88=86__=E2=88=87__=E2=88=88__=E2=88=89__?=\n&quot;+</span>
<a href="#l7.330"></a><span id="l7.330" class="difflineminus">-       &quot; =?utf-8?Q?=E2=88=8A__=E2=88=8B__=E2=88=8C__=E2=88=8D__=E2=88=8E__?=\n&quot;+</span>
<a href="#l7.331"></a><span id="l7.331" class="difflineplus">+       &quot; =?utf-8?Q?=E2=88=85__=E2=88=86__=E2=88=87__=E2=88=88__=E2=88=89__?=\n&quot; +</span>
<a href="#l7.332"></a><span id="l7.332" class="difflineplus">+       &quot; =?utf-8?Q?=E2=88=8A__=E2=88=8B__=E2=88=8C__=E2=88=8D__=E2=88=8E__?=\n&quot; +</span>
<a href="#l7.333"></a><span id="l7.333">        &quot; =?utf-8?Q?=E2=88=8F?=&quot;,</span>
<a href="#l7.334"></a><span id="l7.334">         &quot;\u2200  \u2201  \u2202  \u2203  \u2204  \u2205  \u2206  \u2207  &quot; +</span>
<a href="#l7.335"></a><span id="l7.335">         &quot;\u2208  \u2209  \u220a  \u220b  \u220c  \u220d  \u220e  \u220f&quot;],</span>
<a href="#l7.336"></a><span id="l7.336">       [&quot;=?utf-8?q?=E2=88=80__=E2=88=81__=E2=88=82__=E2=88=83__=E2=88=84__?=\n&quot; +</span>
<a href="#l7.337"></a><span id="l7.337" class="difflineminus">-       &quot; =?utf-8?q?=E2=88=85__=E2=88=86__=E2=88=87__=E2=88=88__=E2=88=89__?=\n&quot;+</span>
<a href="#l7.338"></a><span id="l7.338" class="difflineminus">-       &quot; =?utf-8?q?=E2=88=8A__=E2=88=8B__=E2=88=8C__=E2=88=8D__=E2=88=8E__?=\n&quot;+</span>
<a href="#l7.339"></a><span id="l7.339" class="difflineplus">+       &quot; =?utf-8?q?=E2=88=85__=E2=88=86__=E2=88=87__=E2=88=88__=E2=88=89__?=\n&quot; +</span>
<a href="#l7.340"></a><span id="l7.340" class="difflineplus">+       &quot; =?utf-8?q?=E2=88=8A__=E2=88=8B__=E2=88=8C__=E2=88=8D__=E2=88=8E__?=\n&quot; +</span>
<a href="#l7.341"></a><span id="l7.341">        &quot; =?utf-8?q?=E2=88=8F?=&quot;,</span>
<a href="#l7.342"></a><span id="l7.342">         &quot;\u2200  \u2201  \u2202  \u2203  \u2204  \u2205  \u2206  \u2207  &quot; +</span>
<a href="#l7.343"></a><span id="l7.343">         &quot;\u2208  \u2209  \u220a  \u220b  \u220c  \u220d  \u220e  \u220f&quot;],</span>
<a href="#l7.344"></a><span id="l7.344">       [&quot;=?UTF-8?B?4oiAICDiiIEgIOKIgiAg4oiDICDiiIQgIOKIhSAg4oiGICDiiIcgIOKIiA=&quot; +</span>
<a href="#l7.345"></a><span id="l7.345">         &quot;==?=\n =?UTF-8?B?ICDiiIkgIOKIiiAg4oiLICDiiIwgIOKIjSAg4oiOICDiiI8=?=&quot;,</span>
<a href="#l7.346"></a><span id="l7.346">         &quot;\u2200  \u2201  \u2202  \u2203  \u2204  \u2205  \u2206  \u2207  &quot; +</span>
<a href="#l7.347"></a><span id="l7.347">         &quot;\u2208  \u2209  \u220a  \u220b  \u220c  \u220d  \u220e  \u220f&quot;],</span>
<a href="#l7.348"></a><span id="l7.348"> </span>
<a href="#l7.349"></a><span id="l7.349" class="difflineat">@@ -661,23 +660,23 @@ suite('headerparser', function () {</span>
<a href="#l7.350"></a><span id="l7.350">       [&quot;=?us-ascii?B?VGVzdA====?=&quot;, &quot;Test&quot;],</span>
<a href="#l7.351"></a><span id="l7.351">       [&quot;=?us-ascii?B?VGVzdA=====?=&quot;, &quot;Test&quot;],</span>
<a href="#l7.352"></a><span id="l7.352">       [&quot;=?us-ascii?B?VGVzdA======?=&quot;, &quot;Test&quot;],</span>
<a href="#l7.353"></a><span id="l7.353">       [&quot;=?us-ascii?B?VGVzdA========?=&quot;, &quot;Test&quot;],</span>
<a href="#l7.354"></a><span id="l7.354">       [&quot;=?us-ascii?B?VGVzdA=========?=&quot;, &quot;Test&quot;],</span>
<a href="#l7.355"></a><span id="l7.355">       [&quot;=?us-ascii?B?VGVzdA==========?=&quot;, &quot;Test&quot;],</span>
<a href="#l7.356"></a><span id="l7.356">       [&quot;=?us-ascii?B?VGVzdA===========?=&quot;, &quot;Test&quot;],</span>
<a href="#l7.357"></a><span id="l7.357">     ];</span>
<a href="#l7.358"></a><span id="l7.358" class="difflineminus">-    header_tests.forEach(function (data) {</span>
<a href="#l7.359"></a><span id="l7.359" class="difflineminus">-      arrayTest(data, function () {</span>
<a href="#l7.360"></a><span id="l7.360" class="difflineplus">+    header_tests.forEach(function(data) {</span>
<a href="#l7.361"></a><span id="l7.361" class="difflineplus">+      arrayTest(data, function() {</span>
<a href="#l7.362"></a><span id="l7.362">         assert.deepEqual(headerparser.decodeRFC2047Words(data[0]), data[1]);</span>
<a href="#l7.363"></a><span id="l7.363">       });</span>
<a href="#l7.364"></a><span id="l7.364">     });</span>
<a href="#l7.365"></a><span id="l7.365">   });</span>
<a href="#l7.366"></a><span id="l7.366" class="difflineminus">-  suite('8-bit header processing', function () {</span>
<a href="#l7.367"></a><span id="l7.367" class="difflineplus">+  suite(&quot;8-bit header processing&quot;, function() {</span>
<a href="#l7.368"></a><span id="l7.368">     let header_tests = [</span>
<a href="#l7.369"></a><span id="l7.369">       // Non-ASCII header values</span>
<a href="#l7.370"></a><span id="l7.370">       [&quot;oxyg\xc3\xa8ne&quot;, &quot;oxyg\u00e8ne&quot;, &quot;UTF-8&quot;],</span>
<a href="#l7.371"></a><span id="l7.371">       [&quot;oxyg\xc3\xa8ne&quot;, &quot;oxyg\u00e8ne&quot;, &quot;ISO-8859-1&quot;], // UTF-8 overrides</span>
<a href="#l7.372"></a><span id="l7.372">       [&quot;oxyg\xc3\xa8ne&quot;, &quot;oxyg\u00e8ne&quot;], // default to UTF-8 if no charset</span>
<a href="#l7.373"></a><span id="l7.373">       [&quot;oxyg\xe8ne&quot;, &quot;oxyg\ufffdne&quot;, &quot;UTF-8&quot;],</span>
<a href="#l7.374"></a><span id="l7.374">       [&quot;oxyg\xe8ne&quot;, &quot;oxyg\u00e8ne&quot;, &quot;ISO-8859-1&quot;],</span>
<a href="#l7.375"></a><span id="l7.375">       [&quot;\xc3\xa8\xe8&quot;, &quot;\u00e8\ufffd&quot;, &quot;UTF-8&quot;],</span>
<a href="#l7.376"></a><span id="l7.376" class="difflineat">@@ -690,18 +689,17 @@ suite('headerparser', function () {</span>
<a href="#l7.377"></a><span id="l7.377">       [&quot;\xe8S!0&quot;, &quot;\ufffdS!0&quot;, &quot;utf-32&quot;],</span>
<a href="#l7.378"></a><span id="l7.378"> </span>
<a href="#l7.379"></a><span id="l7.379">       // Don't combine encoded-word and header charset decoding</span>
<a href="#l7.380"></a><span id="l7.380">       [&quot;=?UTF-8?Q?=c3?= \xa8&quot;, &quot;\ufffd \ufffd&quot;, &quot;UTF-8&quot;],</span>
<a href="#l7.381"></a><span id="l7.381">       [&quot;=?UTF-8?Q?=c3?= \xa8&quot;, &quot;\ufffd \u00a8&quot;, &quot;ISO-8859-1&quot;],</span>
<a href="#l7.382"></a><span id="l7.382">       [&quot;\xc3 =?UTF-8?Q?=a8?=&quot;, &quot;\ufffd \ufffd&quot;, &quot;UTF-8&quot;],</span>
<a href="#l7.383"></a><span id="l7.383">       [&quot;\xc3 =?UTF-8?Q?=a8?=&quot;, &quot;\u00c3 \ufffd&quot;, &quot;ISO-8859-1&quot;],</span>
<a href="#l7.384"></a><span id="l7.384">     ];</span>
<a href="#l7.385"></a><span id="l7.385" class="difflineminus">-    header_tests.forEach(function (data) {</span>
<a href="#l7.386"></a><span id="l7.386" class="difflineminus">-      arrayTest(data, function () {</span>
<a href="#l7.387"></a><span id="l7.387" class="difflineplus">+    header_tests.forEach(function(data) {</span>
<a href="#l7.388"></a><span id="l7.388" class="difflineplus">+      arrayTest(data, function() {</span>
<a href="#l7.389"></a><span id="l7.389">         assert.deepEqual(headerparser.decodeRFC2047Words(</span>
<a href="#l7.390"></a><span id="l7.390">           headerparser.convert8BitHeader(data[0], (data.length &gt; 2 ? data[2] : null))), data[1]);</span>
<a href="#l7.391"></a><span id="l7.391">       });</span>
<a href="#l7.392"></a><span id="l7.392">     });</span>
<a href="#l7.393"></a><span id="l7.393">   });</span>
<a href="#l7.394"></a><span id="l7.394"> });</span>
<a href="#l7.395"></a><span id="l7.395" class="difflineminus">-</span>
<a href="#l7.396"></a><span id="l7.396"> });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/mime/jsmime/test/test_header_emitter.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/mime/jsmime/test/test_header_emitter.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1,40 +1,39 @@</span>
<a href="#l8.4"></a><span id="l8.4"> &quot;use strict&quot;;</span>
<a href="#l8.5"></a><span id="l8.5"> define(function(require) {</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineminus">-</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineminus">-var assert = require('assert');</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineminus">-var jsmime = require('jsmime');</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+var assert = require(&quot;assert&quot;);</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+var jsmime = require(&quot;jsmime&quot;);</span>
<a href="#l8.11"></a><span id="l8.11"> var headeremitter = jsmime.headeremitter;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-var MockDate = require('test/mock_date');</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+var MockDate = require(&quot;test/mock_date&quot;);</span>
<a href="#l8.14"></a><span id="l8.14"> </span>
<a href="#l8.15"></a><span id="l8.15"> function arrayTest(data, fn) {</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-  fn.toString = function () {</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+  fn.toString = function() {</span>
<a href="#l8.18"></a><span id="l8.18">     let text = Function.prototype.toString.call(this);</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">-    text = text.replace(/data\[([0-9]*)\]/g, function (m, p) {</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+    text = text.replace(/data\[([0-9]*)\]/g, function(m, p) {</span>
<a href="#l8.21"></a><span id="l8.21">       return JSON.stringify(data[p]);</span>
<a href="#l8.22"></a><span id="l8.22">     });</span>
<a href="#l8.23"></a><span id="l8.23">     return text;</span>
<a href="#l8.24"></a><span id="l8.24">   };</span>
<a href="#l8.25"></a><span id="l8.25">   return test(JSON.stringify(data[0]), fn);</span>
<a href="#l8.26"></a><span id="l8.26"> }</span>
<a href="#l8.27"></a><span id="l8.27"> </span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-suite('headeremitter', function () {</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineminus">-  suite('addAddresses', function () {</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+suite(&quot;headeremitter&quot;, function() {</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+  suite(&quot;addAddresses&quot;, function() {</span>
<a href="#l8.32"></a><span id="l8.32">     let handler = {</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-      reset: function (expected) {</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-        this.output = '';</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+      reset(expected) {</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+        this.output = &quot;&quot;;</span>
<a href="#l8.37"></a><span id="l8.37">         this.expected = expected;</span>
<a href="#l8.38"></a><span id="l8.38">       },</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-      deliverData: function (data) { this.output += data; },</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineminus">-      deliverEOF: function () {</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-        assert.equal(this.output, this.expected + '\r\n');</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">-        for (let line of this.output.split('\r\n'))</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+      deliverData(data) { this.output += data; },</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+      deliverEOF() {</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+        assert.equal(this.output, this.expected + &quot;\r\n&quot;);</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+        for (let line of this.output.split(&quot;\r\n&quot;))</span>
<a href="#l8.47"></a><span id="l8.47">           assert.ok(line.length &lt;= 30, &quot;Line is too long&quot;);</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-      }</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+      },</span>
<a href="#l8.50"></a><span id="l8.50">     };</span>
<a href="#l8.51"></a><span id="l8.51">     let header_tests = [</span>
<a href="#l8.52"></a><span id="l8.52">       [[{name: &quot;&quot;, email: &quot;&quot;}], &quot;&quot;],</span>
<a href="#l8.53"></a><span id="l8.53">       [[{name: &quot;&quot;, email: &quot;a@example.com&quot;}], &quot;a@example.com&quot;],</span>
<a href="#l8.54"></a><span id="l8.54">       [[{name: &quot;John Doe&quot;, email: &quot;a@example.com&quot;}], &quot;John Doe &lt;a@example.com&gt;&quot;],</span>
<a href="#l8.55"></a><span id="l8.55">       [[{name: &quot;&quot;, email: &quot;a@b.c&quot;}, {name: &quot;&quot;, email: &quot;b@b.c&quot;}], &quot;a@b.c, b@b.c&quot;],</span>
<a href="#l8.56"></a><span id="l8.56">       [[{name: &quot;JD&quot;, email: &quot;a@a.c&quot;}, {name: &quot;SD&quot;, email: &quot;b@b.c&quot;}],</span>
<a href="#l8.57"></a><span id="l8.57">         &quot;JD &lt;a@a.c&gt;, SD &lt;b@b.c&gt;&quot;],</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineat">@@ -66,41 +65,41 @@ suite('headeremitter', function () {</span>
<a href="#l8.59"></a><span id="l8.59">                                 {name: &quot;]u[ c&quot;, email: &quot;b@b.c&quot;}]}],</span>
<a href="#l8.60"></a><span id="l8.60">         &quot;Group: \&quot;]u[ d\&quot; &lt;a@a.c&gt;,\r\n \&quot;]u[ c\&quot; &lt;b@b.c&gt;;&quot;],</span>
<a href="#l8.61"></a><span id="l8.61">       [[{ name: &quot;user@domain&quot;, email: &quot;user@d.com&quot; }],</span>
<a href="#l8.62"></a><span id="l8.62">         &quot;\&quot;user@domain\&quot; &lt;user@d.com&gt;&quot;],</span>
<a href="#l8.63"></a><span id="l8.63">       [[{ name: &quot;Group&quot;, group: [{ name: &quot;u@d&quot;, email: &quot;a@a.c&quot; },</span>
<a href="#l8.64"></a><span id="l8.64">                                  { name: &quot;u@c&quot;, email: &quot;b@b.c&quot; }]}],</span>
<a href="#l8.65"></a><span id="l8.65">         &quot;Group: \&quot;u@d\&quot; &lt;a@a.c&gt;,\r\n \&quot;u@c\&quot; &lt;b@b.c&gt;;&quot;],</span>
<a href="#l8.66"></a><span id="l8.66">     ];</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineminus">-    header_tests.forEach(function (data) {</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineminus">-      arrayTest(data, function () {</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+    header_tests.forEach(function(data) {</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+      arrayTest(data, function() {</span>
<a href="#l8.71"></a><span id="l8.71">         let emitter = headeremitter.makeStreamingEmitter(handler, {</span>
<a href="#l8.72"></a><span id="l8.72">           softMargin: 30,</span>
<a href="#l8.73"></a><span id="l8.73">           useASCII: false,</span>
<a href="#l8.74"></a><span id="l8.74">         });</span>
<a href="#l8.75"></a><span id="l8.75">         handler.reset(data[1]);</span>
<a href="#l8.76"></a><span id="l8.76">         emitter.addAddresses(data[0]);</span>
<a href="#l8.77"></a><span id="l8.77">         emitter.finish(true);</span>
<a href="#l8.78"></a><span id="l8.78">       });</span>
<a href="#l8.79"></a><span id="l8.79">     });</span>
<a href="#l8.80"></a><span id="l8.80">   });</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineminus">-  suite('addAddresses (RFC 2047)', function () {</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+  suite(&quot;addAddresses (RFC 2047)&quot;, function() {</span>
<a href="#l8.83"></a><span id="l8.83">     let handler = {</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineminus">-      reset: function (expected) {</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineminus">-        this.output = '';</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+      reset(expected) {</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+        this.output = &quot;&quot;;</span>
<a href="#l8.88"></a><span id="l8.88">         this.expected = expected;</span>
<a href="#l8.89"></a><span id="l8.89">       },</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineminus">-      deliverData: function (data) { this.output += data; },</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineminus">-      deliverEOF: function () {</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineminus">-        assert.equal(this.output, this.expected + '\r\n');</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineminus">-        for (let line of this.output.split('\r\n'))</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+      deliverData(data) { this.output += data; },</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+      deliverEOF() {</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+        assert.equal(this.output, this.expected + &quot;\r\n&quot;);</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+        for (let line of this.output.split(&quot;\r\n&quot;))</span>
<a href="#l8.98"></a><span id="l8.98">           assert.ok(line.length &lt;= 30, &quot;Line is too long&quot;);</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineminus">-      }</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineminus">-    }</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+      },</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+    };</span>
<a href="#l8.103"></a><span id="l8.103">     let header_tests = [</span>
<a href="#l8.104"></a><span id="l8.104">       [[{name: &quot;\u0436&quot;, email: &quot;a@a.c&quot;}], &quot;=?UTF-8?B?0LY=?= &lt;a@a.c&gt;&quot;],</span>
<a href="#l8.105"></a><span id="l8.105">       [[{name: &quot;dioxyg\u00e8ne&quot;, email: &quot;a@a.c&quot;}],</span>
<a href="#l8.106"></a><span id="l8.106">         &quot;=?UTF-8?Q?dioxyg=c3=a8ne?=\r\n &lt;a@a.c&gt;&quot;],</span>
<a href="#l8.107"></a><span id="l8.107">       // Prefer QP if base64 and QP are exactly the same length</span>
<a href="#l8.108"></a><span id="l8.108">       [[{name: &quot;oxyg\u00e8ne&quot;, email: &quot;a@a.c&quot;}],</span>
<a href="#l8.109"></a><span id="l8.109">       // =?UTF-8?B?b3h5Z8OobmU=?=</span>
<a href="#l8.110"></a><span id="l8.110">         &quot;=?UTF-8?Q?oxyg=c3=a8ne?=\r\n &lt;a@a.c&gt;&quot;],</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineat">@@ -108,41 +107,41 @@ suite('headeremitter', function () {</span>
<a href="#l8.112"></a><span id="l8.112">         email: &quot;a@a.c&quot;}],</span>
<a href="#l8.113"></a><span id="l8.113">         &quot;=?UTF-8?B?8J+SqfCfkqnwn5Kp?=\r\n =?UTF-8?B?8J+SqQ==?= &lt;a@a.c&gt;&quot;],</span>
<a href="#l8.114"></a><span id="l8.114">       // Bug 1088975: Since the encoded-word should be recognized as an atom,</span>
<a href="#l8.115"></a><span id="l8.115">       // encode commas.</span>
<a href="#l8.116"></a><span id="l8.116">       [[{name: &quot;B\u00fcg 1088975, FirstName&quot;, email: &quot;a@b.c&quot;}],</span>
<a href="#l8.117"></a><span id="l8.117">         &quot;=?UTF-8?Q?B=c3=bcg_1088975?=\r\n&quot; +</span>
<a href="#l8.118"></a><span id="l8.118">         &quot; =?UTF-8?Q?=2c_FirstName?=\r\n &lt;a@b.c&gt;&quot;],</span>
<a href="#l8.119"></a><span id="l8.119">     ];</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineminus">-    header_tests.forEach(function (data) {</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineminus">-      arrayTest(data, function () {</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+    header_tests.forEach(function(data) {</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+      arrayTest(data, function() {</span>
<a href="#l8.124"></a><span id="l8.124">         let emitter = headeremitter.makeStreamingEmitter(handler, {</span>
<a href="#l8.125"></a><span id="l8.125">           softMargin: 30,</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineminus">-          useASCII: true</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+          useASCII: true,</span>
<a href="#l8.128"></a><span id="l8.128">         });</span>
<a href="#l8.129"></a><span id="l8.129">         handler.reset(data[1]);</span>
<a href="#l8.130"></a><span id="l8.130">         emitter.addAddresses(data[0]);</span>
<a href="#l8.131"></a><span id="l8.131">         emitter.finish(true);</span>
<a href="#l8.132"></a><span id="l8.132">       });</span>
<a href="#l8.133"></a><span id="l8.133">     });</span>
<a href="#l8.134"></a><span id="l8.134">   });</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineminus">-  suite('addUnstructured (RFC 2047)', function () {</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+  suite(&quot;addUnstructured (RFC 2047)&quot;, function() {</span>
<a href="#l8.137"></a><span id="l8.137">     let handler = {</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineminus">-      reset: function (expected) {</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineminus">-        this.output = '';</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+      reset(expected) {</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineplus">+        this.output = &quot;&quot;;</span>
<a href="#l8.142"></a><span id="l8.142">         this.expected = expected;</span>
<a href="#l8.143"></a><span id="l8.143">       },</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineminus">-      deliverData: function (data) { this.output += data; },</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineminus">-      deliverEOF: function () {</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineminus">-        assert.equal(this.output, this.expected + '\r\n');</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineminus">-        for (let line of this.output.split('\r\n'))</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineplus">+      deliverData(data) { this.output += data; },</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+      deliverEOF() {</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineplus">+        assert.equal(this.output, this.expected + &quot;\r\n&quot;);</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineplus">+        for (let line of this.output.split(&quot;\r\n&quot;))</span>
<a href="#l8.152"></a><span id="l8.152">           assert.ok(line.length &lt;= 30, &quot;Line is too long&quot;);</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineminus">-      }</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineminus">-    }</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineplus">+      },</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineplus">+    };</span>
<a href="#l8.157"></a><span id="l8.157">     let header_tests = [</span>
<a href="#l8.158"></a><span id="l8.158">       [&quot;My house   burned down!&quot;, &quot;My house burned down!&quot;],</span>
<a href="#l8.159"></a><span id="l8.159"> </span>
<a href="#l8.160"></a><span id="l8.160">       // Which of the 32 &quot;special&quot; characters need to be encoded in QP encoding?</span>
<a href="#l8.161"></a><span id="l8.161">       // Note: Encoding is forced by adding a \x7f at the end.</span>
<a href="#l8.162"></a><span id="l8.162">       // These 5 don't need encoding:</span>
<a href="#l8.163"></a><span id="l8.163">       [&quot; ! * + - / \x7f&quot;, &quot;=?UTF-8?Q?_!_*_+_-_/_=7f?=&quot;],</span>
<a href="#l8.164"></a><span id="l8.164"> </span>
<a href="#l8.165"></a><span id="l8.165" class="difflineat">@@ -201,38 +200,38 @@ suite('headeremitter', function () {</span>
<a href="#l8.166"></a><span id="l8.166">       //          1         2         3</span>
<a href="#l8.167"></a><span id="l8.167">       // 123456789012345678901234567890</span>
<a href="#l8.168"></a><span id="l8.168">         &quot;=?UTF-8?B?TCdveHlnw6huZSBl?=\r\n&quot; +</span>
<a href="#l8.169"></a><span id="l8.169">         &quot; =?UTF-8?B?c3QgdW4gw6lsw6lt?=\r\n&quot; +</span>
<a href="#l8.170"></a><span id="l8.170">         &quot; =?UTF-8?Q?ent_chimique_du_g?=\r\n&quot; +</span>
<a href="#l8.171"></a><span id="l8.171">         &quot; =?UTF-8?Q?roupe_des_chalcog?=\r\n&quot; +</span>
<a href="#l8.172"></a><span id="l8.172">         &quot; =?UTF-8?B?w6huZXM=?=&quot;],</span>
<a href="#l8.173"></a><span id="l8.173">     ];</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineminus">-    header_tests.forEach(function (data) {</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineminus">-      arrayTest(data, function () {</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineplus">+    header_tests.forEach(function(data) {</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineplus">+      arrayTest(data, function() {</span>
<a href="#l8.178"></a><span id="l8.178">         let emitter = headeremitter.makeStreamingEmitter(handler, {</span>
<a href="#l8.179"></a><span id="l8.179">           softMargin: 30,</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineminus">-          useASCII: true</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineplus">+          useASCII: true,</span>
<a href="#l8.182"></a><span id="l8.182">         });</span>
<a href="#l8.183"></a><span id="l8.183">         handler.reset(data[1]);</span>
<a href="#l8.184"></a><span id="l8.184">         emitter.addUnstructured(data[0]);</span>
<a href="#l8.185"></a><span id="l8.185">         emitter.finish(true);</span>
<a href="#l8.186"></a><span id="l8.186">       });</span>
<a href="#l8.187"></a><span id="l8.187">     });</span>
<a href="#l8.188"></a><span id="l8.188">   });</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineminus">-  suite(&quot;addDate&quot;, function () {</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineplus">+  suite(&quot;addDate&quot;, function() {</span>
<a href="#l8.191"></a><span id="l8.191">     let handler = {</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineminus">-      reset: function (expected) {</span>
<a href="#l8.193"></a><span id="l8.193" class="difflineminus">-        this.output = '';</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineplus">+      reset(expected) {</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineplus">+        this.output = &quot;&quot;;</span>
<a href="#l8.196"></a><span id="l8.196">         this.expected = expected;</span>
<a href="#l8.197"></a><span id="l8.197">       },</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineminus">-      deliverData: function (data) { this.output += data; },</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineminus">-      deliverEOF: function () {</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineminus">-        assert.equal(this.output, this.expected + '\r\n');</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineminus">-      }</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineplus">+      deliverData(data) { this.output += data; },</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineplus">+      deliverEOF() {</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineplus">+        assert.equal(this.output, this.expected + &quot;\r\n&quot;);</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineplus">+      },</span>
<a href="#l8.206"></a><span id="l8.206">     };</span>
<a href="#l8.207"></a><span id="l8.207">     let header_tests = [</span>
<a href="#l8.208"></a><span id="l8.208">       // Test basic day/month names</span>
<a href="#l8.209"></a><span id="l8.209">       [&quot;2000-01-01T00:00:00Z&quot;, &quot;Sat, 1 Jan 2000 00:00:00 +0000&quot;],</span>
<a href="#l8.210"></a><span id="l8.210">       [&quot;2000-02-01T00:00:00Z&quot;, &quot;Tue, 1 Feb 2000 00:00:00 +0000&quot;],</span>
<a href="#l8.211"></a><span id="l8.211">       [&quot;2000-03-01T00:00:00Z&quot;, &quot;Wed, 1 Mar 2000 00:00:00 +0000&quot;],</span>
<a href="#l8.212"></a><span id="l8.212">       [&quot;2000-04-01T00:00:00Z&quot;, &quot;Sat, 1 Apr 2000 00:00:00 +0000&quot;],</span>
<a href="#l8.213"></a><span id="l8.213">       [&quot;2000-05-01T00:00:00Z&quot;, &quot;Mon, 1 May 2000 00:00:00 +0000&quot;],</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineat">@@ -291,94 +290,93 @@ suite('headeremitter', function () {</span>
<a href="#l8.215"></a><span id="l8.215">       // Tests that are not actually missing:</span>
<a href="#l8.216"></a><span id="l8.216">       // We don't actually need to test daylight savings time issues, so long as</span>
<a href="#l8.217"></a><span id="l8.217">       // getTimezoneOffset is correct. We've confirmed black-box that the value</span>
<a href="#l8.218"></a><span id="l8.218">       // is being directly queried on every instance, since we have tests that</span>
<a href="#l8.219"></a><span id="l8.219">       // make MockDate.getTimezoneOffset return different values.</span>
<a href="#l8.220"></a><span id="l8.220">       // In addition, ES6 Date objects don't support leap seconds. Invalid dates</span>
<a href="#l8.221"></a><span id="l8.221">       // per RFC 5322 are handled in a later run of code.</span>
<a href="#l8.222"></a><span id="l8.222">     ];</span>
<a href="#l8.223"></a><span id="l8.223" class="difflineminus">-    header_tests.forEach(function (data) {</span>
<a href="#l8.224"></a><span id="l8.224" class="difflineminus">-      arrayTest(data, function () {</span>
<a href="#l8.225"></a><span id="l8.225" class="difflineminus">-        let emitter = headeremitter.makeStreamingEmitter(handler, { });</span>
<a href="#l8.226"></a><span id="l8.226" class="difflineplus">+    header_tests.forEach(function(data) {</span>
<a href="#l8.227"></a><span id="l8.227" class="difflineplus">+      arrayTest(data, function() {</span>
<a href="#l8.228"></a><span id="l8.228" class="difflineplus">+        let emitter = headeremitter.makeStreamingEmitter(handler, {});</span>
<a href="#l8.229"></a><span id="l8.229">         handler.reset(data[1]);</span>
<a href="#l8.230"></a><span id="l8.230">         emitter.addDate(new MockDate(data[0]));</span>
<a href="#l8.231"></a><span id="l8.231">         emitter.finish(true);</span>
<a href="#l8.232"></a><span id="l8.232">       });</span>
<a href="#l8.233"></a><span id="l8.233">     });</span>
<a href="#l8.234"></a><span id="l8.234"> </span>
<a href="#l8.235"></a><span id="l8.235">     // An invalid date should throw an error instead of make a malformed header.</span>
<a href="#l8.236"></a><span id="l8.236" class="difflineminus">-    test('Invalid dates', function () {</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineminus">-      let emitter = headeremitter.makeStreamingEmitter(handler, { });</span>
<a href="#l8.238"></a><span id="l8.238" class="difflineminus">-      assert.throws(function () { emitter.addDate(new Date(NaN)); }, /Cannot encode an invalid date/);</span>
<a href="#l8.239"></a><span id="l8.239" class="difflineminus">-      assert.throws(function () { emitter.addDate(new Date(&quot;1850-01-01&quot;)); }, /Date year is out of encodable range/);</span>
<a href="#l8.240"></a><span id="l8.240" class="difflineminus">-      assert.throws(function () { emitter.addDate(new Date(&quot;10000-01-01&quot;)); }, /Cannot encode an invalid date/);</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineplus">+    test(&quot;Invalid dates&quot;, function() {</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineplus">+      let emitter = headeremitter.makeStreamingEmitter(handler, {});</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineplus">+      assert.throws(function() { emitter.addDate(new Date(NaN)); }, /Cannot encode an invalid date/);</span>
<a href="#l8.244"></a><span id="l8.244" class="difflineplus">+      assert.throws(function() { emitter.addDate(new Date(&quot;1850-01-01&quot;)); }, /Date year is out of encodable range/);</span>
<a href="#l8.245"></a><span id="l8.245" class="difflineplus">+      assert.throws(function() { emitter.addDate(new Date(&quot;10000-01-01&quot;)); }, /Cannot encode an invalid date/);</span>
<a href="#l8.246"></a><span id="l8.246">     });</span>
<a href="#l8.247"></a><span id="l8.247"> </span>
<a href="#l8.248"></a><span id="l8.248">     // Test preferred breaking for the date header.</span>
<a href="#l8.249"></a><span id="l8.249" class="difflineminus">-    test('Break spot', function () {</span>
<a href="#l8.250"></a><span id="l8.250" class="difflineplus">+    test(&quot;Break spot&quot;, function() {</span>
<a href="#l8.251"></a><span id="l8.251">       let emitter = headeremitter.makeStreamingEmitter(handler, {</span>
<a href="#l8.252"></a><span id="l8.252" class="difflineminus">-        softMargin: 30</span>
<a href="#l8.253"></a><span id="l8.253" class="difflineplus">+        softMargin: 30,</span>
<a href="#l8.254"></a><span id="l8.254">       });</span>
<a href="#l8.255"></a><span id="l8.255">       handler.reset(&quot;Overly-Long-Date:\r\n Sat, 1 Jan 2000 00:00:00 +0000&quot;);</span>
<a href="#l8.256"></a><span id="l8.256">       emitter.addHeaderName(&quot;Overly-Long-Date&quot;);</span>
<a href="#l8.257"></a><span id="l8.257">       emitter.addDate(new MockDate(&quot;2000-01-01T00:00:00Z&quot;));</span>
<a href="#l8.258"></a><span id="l8.258">       emitter.finish();</span>
<a href="#l8.259"></a><span id="l8.259">     });</span>
<a href="#l8.260"></a><span id="l8.260"> </span>
<a href="#l8.261"></a><span id="l8.261" class="difflineminus">-    test('Correctness of date', function () {</span>
<a href="#l8.262"></a><span id="l8.262" class="difflineminus">-      let emitter = headeremitter.makeStreamingEmitter(handler, { });</span>
<a href="#l8.263"></a><span id="l8.263" class="difflineplus">+    test(&quot;Correctness of date&quot;, function() {</span>
<a href="#l8.264"></a><span id="l8.264" class="difflineplus">+      let emitter = headeremitter.makeStreamingEmitter(handler, {});</span>
<a href="#l8.265"></a><span id="l8.265">       handler.reset();</span>
<a href="#l8.266"></a><span id="l8.266">       let now = new Date();</span>
<a href="#l8.267"></a><span id="l8.267">       emitter.addDate(now);</span>
<a href="#l8.268"></a><span id="l8.268">       emitter.finish();</span>
<a href="#l8.269"></a><span id="l8.269">       // All engines can parse the date strings we produce</span>
<a href="#l8.270"></a><span id="l8.270">       let reparsed = new Date(handler.output);</span>
<a href="#l8.271"></a><span id="l8.271"> </span>
<a href="#l8.272"></a><span id="l8.272">       // Now and reparsed should be correct to second-level precision.</span>
<a href="#l8.273"></a><span id="l8.273">       assert.equal(reparsed.getMilliseconds(), 0);</span>
<a href="#l8.274"></a><span id="l8.274">       assert.equal(now.getTime() - now.getMilliseconds(), reparsed.getTime());</span>
<a href="#l8.275"></a><span id="l8.275">     });</span>
<a href="#l8.276"></a><span id="l8.276">   });</span>
<a href="#l8.277"></a><span id="l8.277"> </span>
<a href="#l8.278"></a><span id="l8.278" class="difflineminus">-  suite(&quot;Header lengths&quot;, function () {</span>
<a href="#l8.279"></a><span id="l8.279" class="difflineplus">+  suite(&quot;Header lengths&quot;, function() {</span>
<a href="#l8.280"></a><span id="l8.280">     let handler = {</span>
<a href="#l8.281"></a><span id="l8.281" class="difflineminus">-      reset: function (expected) {</span>
<a href="#l8.282"></a><span id="l8.282" class="difflineminus">-        this.output = '';</span>
<a href="#l8.283"></a><span id="l8.283" class="difflineplus">+      reset(expected) {</span>
<a href="#l8.284"></a><span id="l8.284" class="difflineplus">+        this.output = &quot;&quot;;</span>
<a href="#l8.285"></a><span id="l8.285">         this.expected = expected;</span>
<a href="#l8.286"></a><span id="l8.286">       },</span>
<a href="#l8.287"></a><span id="l8.287" class="difflineminus">-      deliverData: function (data) { this.output += data; },</span>
<a href="#l8.288"></a><span id="l8.288" class="difflineminus">-      deliverEOF: function () {</span>
<a href="#l8.289"></a><span id="l8.289" class="difflineminus">-        assert.equal(this.output, this.expected + '\r\n');</span>
<a href="#l8.290"></a><span id="l8.290" class="difflineminus">-      }</span>
<a href="#l8.291"></a><span id="l8.291" class="difflineplus">+      deliverData(data) { this.output += data; },</span>
<a href="#l8.292"></a><span id="l8.292" class="difflineplus">+      deliverEOF() {</span>
<a href="#l8.293"></a><span id="l8.293" class="difflineplus">+        assert.equal(this.output, this.expected + &quot;\r\n&quot;);</span>
<a href="#l8.294"></a><span id="l8.294" class="difflineplus">+      },</span>
<a href="#l8.295"></a><span id="l8.295">     };</span>
<a href="#l8.296"></a><span id="l8.296">     let header_tests = [</span>
<a href="#l8.297"></a><span id="l8.297">       [[{name: &quot;Supercalifragilisticexpialidocious&quot;, email: &quot;a@b.c&quot;}],</span>
<a href="#l8.298"></a><span id="l8.298" class="difflineminus">-        'Supercalifragilisticexpialidocious\r\n &lt;a@b.c&gt;'],</span>
<a href="#l8.299"></a><span id="l8.299" class="difflineplus">+        &quot;Supercalifragilisticexpialidocious\r\n &lt;a@b.c&gt;&quot;],</span>
<a href="#l8.300"></a><span id="l8.300">       [[{email: &quot;supercalifragilisticexpialidocious@&quot; +</span>
<a href="#l8.301"></a><span id="l8.301">           &quot;the.longest.domain.name.in.the.world.invalid&quot;}],</span>
<a href="#l8.302"></a><span id="l8.302" class="difflineminus">-        'supercalifragilisticexpialidocious\r\n' +</span>
<a href="#l8.303"></a><span id="l8.303" class="difflineminus">-        ' @the.longest.domain.name.in.the.world.invalid'],</span>
<a href="#l8.304"></a><span id="l8.304" class="difflineplus">+        &quot;supercalifragilisticexpialidocious\r\n&quot; +</span>
<a href="#l8.305"></a><span id="l8.305" class="difflineplus">+        &quot; @the.longest.domain.name.in.the.world.invalid&quot;],</span>
<a href="#l8.306"></a><span id="l8.306">       [[{name: &quot;Lopadotemachoselachogaleokranioleipsanodrimhypotrimmatosilphi&quot; +</span>
<a href="#l8.307"></a><span id="l8.307">         &quot;paraomelitokatakechymenokichlepikossyphophattoperisteralektryonoptek&quot; +</span>
<a href="#l8.308"></a><span id="l8.308">         &quot;ephalliokigklopeleiolagoiosiraiobaphetraganopterygon&quot;, email: &quot;a@b.c&quot;}],</span>
<a href="#l8.309"></a><span id="l8.309">         new Error],</span>
<a href="#l8.310"></a><span id="l8.310">     ];</span>
<a href="#l8.311"></a><span id="l8.311" class="difflineminus">-    header_tests.forEach(function (data) {</span>
<a href="#l8.312"></a><span id="l8.312" class="difflineminus">-      arrayTest(data, function () {</span>
<a href="#l8.313"></a><span id="l8.313" class="difflineplus">+    header_tests.forEach(function(data) {</span>
<a href="#l8.314"></a><span id="l8.314" class="difflineplus">+      arrayTest(data, function() {</span>
<a href="#l8.315"></a><span id="l8.315">         let emitter = headeremitter.makeStreamingEmitter(handler, {</span>
<a href="#l8.316"></a><span id="l8.316">           softMargin: 30,</span>
<a href="#l8.317"></a><span id="l8.317">           hardMargin: 50,</span>
<a href="#l8.318"></a><span id="l8.318">           useASCII: false,</span>
<a href="#l8.319"></a><span id="l8.319">         });</span>
<a href="#l8.320"></a><span id="l8.320">         handler.reset(data[1]);</span>
<a href="#l8.321"></a><span id="l8.321" class="difflineminus">-        if (data[1] instanceof Error)</span>
<a href="#l8.322"></a><span id="l8.322" class="difflineminus">-          assert.throws(function () { emitter.addAddresses(data[0]); }, /Cannot encode/);</span>
<a href="#l8.323"></a><span id="l8.323" class="difflineminus">-        else {</span>
<a href="#l8.324"></a><span id="l8.324" class="difflineminus">-          assert.doesNotThrow(function () { emitter.addAddresses(data[0]); });</span>
<a href="#l8.325"></a><span id="l8.325" class="difflineplus">+        if (data[1] instanceof Error) {</span>
<a href="#l8.326"></a><span id="l8.326" class="difflineplus">+          assert.throws(function() { emitter.addAddresses(data[0]); }, /Cannot encode/);</span>
<a href="#l8.327"></a><span id="l8.327" class="difflineplus">+        } else {</span>
<a href="#l8.328"></a><span id="l8.328" class="difflineplus">+          assert.doesNotThrow(function() { emitter.addAddresses(data[0]); });</span>
<a href="#l8.329"></a><span id="l8.329">           emitter.finish(true);</span>
<a href="#l8.330"></a><span id="l8.330">         }</span>
<a href="#l8.331"></a><span id="l8.331">       });</span>
<a href="#l8.332"></a><span id="l8.332">     });</span>
<a href="#l8.333"></a><span id="l8.333">   });</span>
<a href="#l8.334"></a><span id="l8.334"> });</span>
<a href="#l8.335"></a><span id="l8.335" class="difflineminus">-</span>
<a href="#l8.336"></a><span id="l8.336"> });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/mime/jsmime/test/test_mime_tree.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/mime/jsmime/test/test_mime_tree.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,71 +1,70 @@</span>
<a href="#l9.4"></a><span id="l9.4"> &quot;use strict&quot;;</span>
<a href="#l9.5"></a><span id="l9.5"> define(function(require) {</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineminus">-</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineminus">-var assert = require('assert');</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineminus">-var jsmime = require('jsmime');</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineminus">-var fs = require('fs');</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+var assert = require(&quot;assert&quot;);</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineplus">+var jsmime = require(&quot;jsmime&quot;);</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+var fs = require(&quot;fs&quot;);</span>
<a href="#l9.13"></a><span id="l9.13"> </span>
<a href="#l9.14"></a><span id="l9.14"> function arrayTest(data, fn) {</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-  fn.toString = function () {</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+  fn.toString = function() {</span>
<a href="#l9.17"></a><span id="l9.17">     let text = Function.prototype.toString.call(this);</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-    text = text.replace(/data\[([0-9]*)\]/g, function (m, p) {</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+    text = text.replace(/data\[([0-9]*)\]/g, function(m, p) {</span>
<a href="#l9.20"></a><span id="l9.20">       return JSON.stringify(data[p]);</span>
<a href="#l9.21"></a><span id="l9.21">     });</span>
<a href="#l9.22"></a><span id="l9.22">     return text;</span>
<a href="#l9.23"></a><span id="l9.23">   };</span>
<a href="#l9.24"></a><span id="l9.24">   return test(data[0], fn);</span>
<a href="#l9.25"></a><span id="l9.25"> }</span>
<a href="#l9.26"></a><span id="l9.26"> </span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-/// Returns and deletes object[field] if present, or undefined if not.</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+// Returns and deletes object[field] if present, or undefined if not.</span>
<a href="#l9.29"></a><span id="l9.29"> function extract_field(object, field) {</span>
<a href="#l9.30"></a><span id="l9.30">   if (field in object) {</span>
<a href="#l9.31"></a><span id="l9.31">     var result = object[field];</span>
<a href="#l9.32"></a><span id="l9.32">     delete object[field];</span>
<a href="#l9.33"></a><span id="l9.33">     return result;</span>
<a href="#l9.34"></a><span id="l9.34">   }</span>
<a href="#l9.35"></a><span id="l9.35">   return undefined;</span>
<a href="#l9.36"></a><span id="l9.36"> }</span>
<a href="#l9.37"></a><span id="l9.37"> </span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">-/// A file cache for read_file.</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+// A file cache for read_file.</span>
<a href="#l9.40"></a><span id="l9.40"> var file_cache = {};</span>
<a href="#l9.41"></a><span id="l9.41"> </span>
<a href="#l9.42"></a><span id="l9.42"> /**</span>
<a href="#l9.43"></a><span id="l9.43">  * Read a file into a string (all line endings become CRLF).</span>
<a href="#l9.44"></a><span id="l9.44">  * @param file  The name of the file to read, relative to the data/ directory.</span>
<a href="#l9.45"></a><span id="l9.45">  * @param start The first line of the file to return, defaulting to 0</span>
<a href="#l9.46"></a><span id="l9.46">  * @param end   The last line of the file to return, defaulting to the number of</span>
<a href="#l9.47"></a><span id="l9.47">  *              lines in the file.</span>
<a href="#l9.48"></a><span id="l9.48">  * @return      Promise&lt;String&gt; The contents of the file as a binary string.</span>
<a href="#l9.49"></a><span id="l9.49">  */</span>
<a href="#l9.50"></a><span id="l9.50"> function read_file(file, start, end) {</span>
<a href="#l9.51"></a><span id="l9.51">   if (!(file in file_cache)) {</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineminus">-    var realFile = new Promise(function (resolve, reject) {</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineminus">-      fs.readFile(&quot;data/&quot; + file, function (err, data) {</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+    var realFile = new Promise(function(resolve, reject) {</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+      fs.readFile(&quot;data/&quot; + file, function(err, data) {</span>
<a href="#l9.56"></a><span id="l9.56">         if (err) reject(err);</span>
<a href="#l9.57"></a><span id="l9.57">         else resolve(data);</span>
<a href="#l9.58"></a><span id="l9.58">       });</span>
<a href="#l9.59"></a><span id="l9.59">     });</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">-    var loader = realFile.then(function (contents) {</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineminus">-      var inStrForm = '';</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineplus">+    var loader = realFile.then(function(contents) {</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+      var inStrForm = &quot;&quot;;</span>
<a href="#l9.64"></a><span id="l9.64">       while (contents.length &gt; 0) {</span>
<a href="#l9.65"></a><span id="l9.65">         inStrForm += String.fromCharCode.apply(null,</span>
<a href="#l9.66"></a><span id="l9.66">           contents.subarray(0, 1024));</span>
<a href="#l9.67"></a><span id="l9.67">         contents = contents.subarray(1024);</span>
<a href="#l9.68"></a><span id="l9.68">       }</span>
<a href="#l9.69"></a><span id="l9.69">       return inStrForm.split(/\r\n|[\r\n]/);</span>
<a href="#l9.70"></a><span id="l9.70">     });</span>
<a href="#l9.71"></a><span id="l9.71">     file_cache[file] = loader;</span>
<a href="#l9.72"></a><span id="l9.72">   }</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineminus">-  return file_cache[file].then(function (contents) {</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineplus">+  return file_cache[file].then(function(contents) {</span>
<a href="#l9.75"></a><span id="l9.75">     if (start !== undefined) {</span>
<a href="#l9.76"></a><span id="l9.76">       contents = contents.slice(start - 1, end - 1);</span>
<a href="#l9.77"></a><span id="l9.77">     }</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineminus">-    return contents.join('\r\n');</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineplus">+    return contents.join(&quot;\r\n&quot;);</span>
<a href="#l9.80"></a><span id="l9.80">   });</span>
<a href="#l9.81"></a><span id="l9.81"> }</span>
<a href="#l9.82"></a><span id="l9.82"> </span>
<a href="#l9.83"></a><span id="l9.83"> /**</span>
<a href="#l9.84"></a><span id="l9.84">  * Helper for body tests.</span>
<a href="#l9.85"></a><span id="l9.85">  *</span>
<a href="#l9.86"></a><span id="l9.86">  * Some extra options are listed too:</span>
<a href="#l9.87"></a><span id="l9.87">  * _split: The contents of the file will be passed in packets split by this</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineat">@@ -92,21 +91,21 @@ function make_body_test(test, file, opts</span>
<a href="#l9.89"></a><span id="l9.89">     if (packetize !== undefined)</span>
<a href="#l9.90"></a><span id="l9.90">       msgcontents = msgcontents.split(packetize);</span>
<a href="#l9.91"></a><span id="l9.91">     if (eol !== undefined) {</span>
<a href="#l9.92"></a><span id="l9.92">       msgcontents = msgcontents.replace(/\r\n/g, eol);</span>
<a href="#l9.93"></a><span id="l9.93">     }</span>
<a href="#l9.94"></a><span id="l9.94">     return msgcontents;</span>
<a href="#l9.95"></a><span id="l9.95">   });</span>
<a href="#l9.96"></a><span id="l9.96">   if (eol !== undefined) {</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineminus">-    results = results.then(function(results) {</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineminus">-      for (var part of results) {</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineplus">+    results = results.then(function(results_) {</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineplus">+      for (let part of results_) {</span>
<a href="#l9.101"></a><span id="l9.101">         part[1] = part[1].replace(/\r\n/g, eol);</span>
<a href="#l9.102"></a><span id="l9.102">       }</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineminus">-      return results;</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineplus">+      return results_;</span>
<a href="#l9.105"></a><span id="l9.105">     });</span>
<a href="#l9.106"></a><span id="l9.106">   }</span>
<a href="#l9.107"></a><span id="l9.107">   return [test, msgtext, opts, results];</span>
<a href="#l9.108"></a><span id="l9.108"> }</span>
<a href="#l9.109"></a><span id="l9.109"> </span>
<a href="#l9.110"></a><span id="l9.110"> /**</span>
<a href="#l9.111"></a><span id="l9.111">  * Execute a single MIME tree test.</span>
<a href="#l9.112"></a><span id="l9.112">  *</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineat">@@ -125,487 +124,486 @@ function testParser(message, opts, resul</span>
<a href="#l9.114"></a><span id="l9.114">   var checkingHeaders;</span>
<a href="#l9.115"></a><span id="l9.115">   var calls = 0;</span>
<a href="#l9.116"></a><span id="l9.116">   var fusingParts = extract_field(opts, &quot;_nofuseparts&quot;) === undefined;</span>
<a href="#l9.117"></a><span id="l9.117">   var emitter = {</span>
<a href="#l9.118"></a><span id="l9.118">     stack: [],</span>
<a href="#l9.119"></a><span id="l9.119">     startMessage: function emitter_startMsg() {</span>
<a href="#l9.120"></a><span id="l9.120">       assert.equal(this.stack.length, 0);</span>
<a href="#l9.121"></a><span id="l9.121">       calls++;</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineminus">-      this.partData = '';</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineplus">+      this.partData = &quot;&quot;;</span>
<a href="#l9.124"></a><span id="l9.124">     },</span>
<a href="#l9.125"></a><span id="l9.125">     endMessage: function emitter_endMsg() {</span>
<a href="#l9.126"></a><span id="l9.126">       assert.equal(this.stack.length, 0);</span>
<a href="#l9.127"></a><span id="l9.127">       calls++;</span>
<a href="#l9.128"></a><span id="l9.128">     },</span>
<a href="#l9.129"></a><span id="l9.129">     startPart: function emitter_startPart(partNum, headers) {</span>
<a href="#l9.130"></a><span id="l9.130">       this.stack.push(partNum);</span>
<a href="#l9.131"></a><span id="l9.131">       if (checkingHeaders) {</span>
<a href="#l9.132"></a><span id="l9.132">         assert.ok(partNum in uncheckedValues);</span>
<a href="#l9.133"></a><span id="l9.133">         // Headers is a map, convert it to an object.</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineminus">-        var objmap = new Object();</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineplus">+        var objmap = {};</span>
<a href="#l9.136"></a><span id="l9.136">         for (let pair of headers)</span>
<a href="#l9.137"></a><span id="l9.137">           objmap[pair[0]] = pair[1];</span>
<a href="#l9.138"></a><span id="l9.138">         var expected = uncheckedValues[partNum];</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineminus">-        var convresults = new Object();</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineplus">+        var convresults = {};</span>
<a href="#l9.141"></a><span id="l9.141">         for (let key in expected) {</span>
<a href="#l9.142"></a><span id="l9.142">           try {</span>
<a href="#l9.143"></a><span id="l9.143">             convresults[key] =</span>
<a href="#l9.144"></a><span id="l9.144">               jsmime.headerparser.parseStructuredHeader(key, expected[key]);</span>
<a href="#l9.145"></a><span id="l9.145">           } catch (e) {</span>
<a href="#l9.146"></a><span id="l9.146">             convresults[key] = expected[key];</span>
<a href="#l9.147"></a><span id="l9.147">           }</span>
<a href="#l9.148"></a><span id="l9.148">         }</span>
<a href="#l9.149"></a><span id="l9.149">         assert.deepEqual(objmap, convresults);</span>
<a href="#l9.150"></a><span id="l9.150">         if (fusingParts)</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineminus">-          assert.equal(this.partData, '');</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineplus">+          assert.equal(this.partData, &quot;&quot;);</span>
<a href="#l9.153"></a><span id="l9.153">         delete uncheckedValues[partNum];</span>
<a href="#l9.154"></a><span id="l9.154">       }</span>
<a href="#l9.155"></a><span id="l9.155">     },</span>
<a href="#l9.156"></a><span id="l9.156">     deliverPartData: function emitter_partData(partNum, data) {</span>
<a href="#l9.157"></a><span id="l9.157">       assert.equal(this.stack[this.stack.length - 1], partNum);</span>
<a href="#l9.158"></a><span id="l9.158">       if (!checkingHeaders) {</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineminus">-        if (fusingParts)</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineplus">+        if (fusingParts) {</span>
<a href="#l9.161"></a><span id="l9.161">           this.partData += data;</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineminus">-        else {</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineplus">+        } else {</span>
<a href="#l9.164"></a><span id="l9.164">           let check = uncheckedValues.shift();</span>
<a href="#l9.165"></a><span id="l9.165">           assert.equal(partNum, check[0]);</span>
<a href="#l9.166"></a><span id="l9.166">           assert.equal(data, check[1]);</span>
<a href="#l9.167"></a><span id="l9.167">         }</span>
<a href="#l9.168"></a><span id="l9.168">       }</span>
<a href="#l9.169"></a><span id="l9.169">     },</span>
<a href="#l9.170"></a><span id="l9.170">     endPart: function emitter_endPart(partNum) {</span>
<a href="#l9.171"></a><span id="l9.171" class="difflineminus">-      if (this.partData != '') {</span>
<a href="#l9.172"></a><span id="l9.172" class="difflineplus">+      if (this.partData != &quot;&quot;) {</span>
<a href="#l9.173"></a><span id="l9.173">         let check = uncheckedValues.shift();</span>
<a href="#l9.174"></a><span id="l9.174">         assert.equal(partNum, check[0]);</span>
<a href="#l9.175"></a><span id="l9.175">         assert.equal(this.partData, check[1]);</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineminus">-        this.partData = '';</span>
<a href="#l9.177"></a><span id="l9.177" class="difflineplus">+        this.partData = &quot;&quot;;</span>
<a href="#l9.178"></a><span id="l9.178">       }</span>
<a href="#l9.179"></a><span id="l9.179">       assert.equal(this.stack.pop(), partNum);</span>
<a href="#l9.180"></a><span id="l9.180" class="difflineminus">-    }</span>
<a href="#l9.181"></a><span id="l9.181" class="difflineplus">+    },</span>
<a href="#l9.182"></a><span id="l9.182">   };</span>
<a href="#l9.183"></a><span id="l9.183" class="difflineminus">-  opts.onerror = function (e) { throw e; };</span>
<a href="#l9.184"></a><span id="l9.184" class="difflineplus">+  opts.onerror = function(e) { throw e; };</span>
<a href="#l9.185"></a><span id="l9.185"> </span>
<a href="#l9.186"></a><span id="l9.186" class="difflineminus">-  return Promise.all([message, results]).then(function (vals) {</span>
<a href="#l9.187"></a><span id="l9.187" class="difflineminus">-    let [message, results] = vals;</span>
<a href="#l9.188"></a><span id="l9.188" class="difflineplus">+  return Promise.all([message, results]).then(function(vals) {</span>
<a href="#l9.189"></a><span id="l9.189" class="difflineplus">+    let [message_, results_] = vals;</span>
<a href="#l9.190"></a><span id="l9.190">     // Clone the results array into uncheckedValues</span>
<a href="#l9.191"></a><span id="l9.191" class="difflineminus">-    if (Array.isArray(results)) {</span>
<a href="#l9.192"></a><span id="l9.192" class="difflineminus">-      uncheckedValues = Array.from(results);</span>
<a href="#l9.193"></a><span id="l9.193" class="difflineplus">+    if (Array.isArray(results_)) {</span>
<a href="#l9.194"></a><span id="l9.194" class="difflineplus">+      uncheckedValues = Array.from(results_);</span>
<a href="#l9.195"></a><span id="l9.195">       checkingHeaders = false;</span>
<a href="#l9.196"></a><span id="l9.196">     } else {</span>
<a href="#l9.197"></a><span id="l9.197">       uncheckedValues = {};</span>
<a href="#l9.198"></a><span id="l9.198" class="difflineminus">-      for (let key in results) {</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineminus">-        uncheckedValues[key] = results[key];</span>
<a href="#l9.200"></a><span id="l9.200" class="difflineplus">+      for (let key in results_) {</span>
<a href="#l9.201"></a><span id="l9.201" class="difflineplus">+        uncheckedValues[key] = results_[key];</span>
<a href="#l9.202"></a><span id="l9.202">       }</span>
<a href="#l9.203"></a><span id="l9.203">       checkingHeaders = true;</span>
<a href="#l9.204"></a><span id="l9.204">     }</span>
<a href="#l9.205"></a><span id="l9.205" class="difflineminus">-    if (!Array.isArray(message))</span>
<a href="#l9.206"></a><span id="l9.206" class="difflineminus">-      message = [message];</span>
<a href="#l9.207"></a><span id="l9.207" class="difflineplus">+    if (!Array.isArray(message_))</span>
<a href="#l9.208"></a><span id="l9.208" class="difflineplus">+      message_ = [message_];</span>
<a href="#l9.209"></a><span id="l9.209">     var parser = new jsmime.MimeParser(emitter, opts);</span>
<a href="#l9.210"></a><span id="l9.210" class="difflineminus">-    message.forEach(function (packet) {</span>
<a href="#l9.211"></a><span id="l9.211" class="difflineplus">+    message_.forEach(function(packet) {</span>
<a href="#l9.212"></a><span id="l9.212">       parser.deliverData(packet);</span>
<a href="#l9.213"></a><span id="l9.213">     });</span>
<a href="#l9.214"></a><span id="l9.214">     parser.deliverEOF();</span>
<a href="#l9.215"></a><span id="l9.215">     assert.equal(calls, 2);</span>
<a href="#l9.216"></a><span id="l9.216">     if (!checkingHeaders)</span>
<a href="#l9.217"></a><span id="l9.217">       assert.equal(0, uncheckedValues.length);</span>
<a href="#l9.218"></a><span id="l9.218">     else</span>
<a href="#l9.219"></a><span id="l9.219">       assert.deepEqual({}, uncheckedValues);</span>
<a href="#l9.220"></a><span id="l9.220">   });</span>
<a href="#l9.221"></a><span id="l9.221"> }</span>
<a href="#l9.222"></a><span id="l9.222"> </span>
<a href="#l9.223"></a><span id="l9.223" class="difflineminus">-suite('MimeParser', function () {</span>
<a href="#l9.224"></a><span id="l9.224" class="difflineminus">-  /// This is the expected part specifier for the multipart-complex1 test file,</span>
<a href="#l9.225"></a><span id="l9.225" class="difflineminus">-  /// specified here because it is used in several cases.</span>
<a href="#l9.226"></a><span id="l9.226" class="difflineminus">-  let mpart_complex1 = [['1', 8, 10], ['2', 14, 16], ['3.1', 22, 24],</span>
<a href="#l9.227"></a><span id="l9.227" class="difflineminus">-      ['4', 29, 31], ['5', 33, 35]];</span>
<a href="#l9.228"></a><span id="l9.228" class="difflineplus">+suite(&quot;MimeParser&quot;, function() {</span>
<a href="#l9.229"></a><span id="l9.229" class="difflineplus">+  // This is the expected part specifier for the multipart-complex1 test file,</span>
<a href="#l9.230"></a><span id="l9.230" class="difflineplus">+  // specified here because it is used in several cases.</span>
<a href="#l9.231"></a><span id="l9.231" class="difflineplus">+  let mpart_complex1 = [[&quot;1&quot;, 8, 10], [&quot;2&quot;, 14, 16], [&quot;3.1&quot;, 22, 24],</span>
<a href="#l9.232"></a><span id="l9.232" class="difflineplus">+      [&quot;4&quot;, 29, 31], [&quot;5&quot;, 33, 35]];</span>
<a href="#l9.233"></a><span id="l9.233"> </span>
<a href="#l9.234"></a><span id="l9.234" class="difflineminus">-  suite('Simple tests', function () {</span>
<a href="#l9.235"></a><span id="l9.235" class="difflineplus">+  suite(&quot;Simple tests&quot;, function() {</span>
<a href="#l9.236"></a><span id="l9.236">     let parser_tests = [</span>
<a href="#l9.237"></a><span id="l9.237">       // The following tests are either degenerate or error cases that should</span>
<a href="#l9.238"></a><span id="l9.238">       // work</span>
<a href="#l9.239"></a><span id="l9.239" class="difflineminus">-      [&quot;Empty string&quot;, &quot;&quot;, {}, {'': {}}],</span>
<a href="#l9.240"></a><span id="l9.240" class="difflineminus">-      [&quot;No value for header&quot;, &quot;Header&quot;, {}, {'': {&quot;Header&quot;: ['']}}],</span>
<a href="#l9.241"></a><span id="l9.241" class="difflineplus">+      [&quot;Empty string&quot;, &quot;&quot;, {}, {&quot;&quot;: {}}],</span>
<a href="#l9.242"></a><span id="l9.242" class="difflineplus">+      [&quot;No value for header&quot;, &quot;Header&quot;, {}, {&quot;&quot;: {&quot;Header&quot;: [&quot;&quot;]}}],</span>
<a href="#l9.243"></a><span id="l9.243">       [&quot;No trailing newline&quot;, &quot;To: eof@example.net&quot;, {},</span>
<a href="#l9.244"></a><span id="l9.244" class="difflineminus">-        {'': {&quot;To&quot;: [&quot;eof@example.net&quot;]}}],</span>
<a href="#l9.245"></a><span id="l9.245" class="difflineplus">+        {&quot;&quot;: {&quot;To&quot;: [&quot;eof@example.net&quot;]}}],</span>
<a href="#l9.246"></a><span id="l9.246">       [&quot;Header no val&quot;, &quot;To: eof@example.net\r\n&quot;, {},</span>
<a href="#l9.247"></a><span id="l9.247" class="difflineminus">-        {'': {&quot;To&quot;: [&quot;eof@example.net&quot;]}}],</span>
<a href="#l9.248"></a><span id="l9.248" class="difflineminus">-      [&quot;No body no headers&quot;, &quot;\r\n\r\n&quot;, {}, {'': {}}],</span>
<a href="#l9.249"></a><span id="l9.249" class="difflineminus">-      [&quot;Body no headers&quot;, &quot;\r\n\r\nA&quot;, {}, {'': {}}],</span>
<a href="#l9.250"></a><span id="l9.250" class="difflineplus">+        {&quot;&quot;: {&quot;To&quot;: [&quot;eof@example.net&quot;]}}],</span>
<a href="#l9.251"></a><span id="l9.251" class="difflineplus">+      [&quot;No body no headers&quot;, &quot;\r\n\r\n&quot;, {}, {&quot;&quot;: {}}],</span>
<a href="#l9.252"></a><span id="l9.252" class="difflineplus">+      [&quot;Body no headers&quot;, &quot;\r\n\r\nA&quot;, {}, {&quot;&quot;: {}}],</span>
<a href="#l9.253"></a><span id="l9.253">       // Basic cases for headers</span>
<a href="#l9.254"></a><span id="l9.254" class="difflineminus">-      ['Multiparts get headers', read_file(&quot;multipart-complex1&quot;), {},</span>
<a href="#l9.255"></a><span id="l9.255" class="difflineminus">-        { '': {'Content-Type': ['multipart/mixed; boundary=&quot;boundary&quot;']},</span>
<a href="#l9.256"></a><span id="l9.256" class="difflineminus">-          '1': {'Content-Type': ['application/octet-stream'],</span>
<a href="#l9.257"></a><span id="l9.257" class="difflineminus">-                'Content-Transfer-Encoding': ['base64']},</span>
<a href="#l9.258"></a><span id="l9.258" class="difflineminus">-          '2': {'Content-Type': ['image/png'],</span>
<a href="#l9.259"></a><span id="l9.259" class="difflineminus">-                'Content-Transfer-Encoding': ['base64']},</span>
<a href="#l9.260"></a><span id="l9.260" class="difflineminus">-          '3': {'Content-Type': ['multipart/related; boundary=&quot;boundary2&quot;']},</span>
<a href="#l9.261"></a><span id="l9.261" class="difflineminus">-          '3.1': {'Content-Type': ['text/html']},</span>
<a href="#l9.262"></a><span id="l9.262" class="difflineminus">-          '4': {'Content-Type': ['text/plain']}, '5': {} }],</span>
<a href="#l9.263"></a><span id="l9.263" class="difflineplus">+      [&quot;Multiparts get headers&quot;, read_file(&quot;multipart-complex1&quot;), {},</span>
<a href="#l9.264"></a><span id="l9.264" class="difflineplus">+        { &quot;&quot;: {&quot;Content-Type&quot;: ['multipart/mixed; boundary=&quot;boundary&quot;']},</span>
<a href="#l9.265"></a><span id="l9.265" class="difflineplus">+          &quot;1&quot;: {&quot;Content-Type&quot;: [&quot;application/octet-stream&quot;],</span>
<a href="#l9.266"></a><span id="l9.266" class="difflineplus">+                &quot;Content-Transfer-Encoding&quot;: [&quot;base64&quot;]},</span>
<a href="#l9.267"></a><span id="l9.267" class="difflineplus">+          &quot;2&quot;: {&quot;Content-Type&quot;: [&quot;image/png&quot;],</span>
<a href="#l9.268"></a><span id="l9.268" class="difflineplus">+                &quot;Content-Transfer-Encoding&quot;: [&quot;base64&quot;]},</span>
<a href="#l9.269"></a><span id="l9.269" class="difflineplus">+          &quot;3&quot;: {&quot;Content-Type&quot;: ['multipart/related; boundary=&quot;boundary2&quot;']},</span>
<a href="#l9.270"></a><span id="l9.270" class="difflineplus">+          &quot;3.1&quot;: {&quot;Content-Type&quot;: [&quot;text/html&quot;]},</span>
<a href="#l9.271"></a><span id="l9.271" class="difflineplus">+          &quot;4&quot;: {&quot;Content-Type&quot;: [&quot;text/plain&quot;]}, &quot;5&quot;: {} }],</span>
<a href="#l9.272"></a><span id="l9.272">     ];</span>
<a href="#l9.273"></a><span id="l9.273" class="difflineminus">-    parser_tests.forEach(function (data) {</span>
<a href="#l9.274"></a><span id="l9.274" class="difflineminus">-      arrayTest(data, function () {</span>
<a href="#l9.275"></a><span id="l9.275" class="difflineplus">+    parser_tests.forEach(function(data) {</span>
<a href="#l9.276"></a><span id="l9.276" class="difflineplus">+      arrayTest(data, function() {</span>
<a href="#l9.277"></a><span id="l9.277">         return testParser(data[1], data[2], data[3]);</span>
<a href="#l9.278"></a><span id="l9.278">       });</span>
<a href="#l9.279"></a><span id="l9.279">     });</span>
<a href="#l9.280"></a><span id="l9.280">   });</span>
<a href="#l9.281"></a><span id="l9.281"> </span>
<a href="#l9.282"></a><span id="l9.282" class="difflineminus">-  suite('Body tests', function () {</span>
<a href="#l9.283"></a><span id="l9.283" class="difflineplus">+  suite(&quot;Body tests&quot;, function() {</span>
<a href="#l9.284"></a><span id="l9.284">     let parser_tests = [</span>
<a href="#l9.285"></a><span id="l9.285">       // Body tests from data</span>
<a href="#l9.286"></a><span id="l9.286">       // (Note: line numbers are 1-based. Also, to capture trailing EOF, add 2</span>
<a href="#l9.287"></a><span id="l9.287">       // to the last line number of the file).</span>
<a href="#l9.288"></a><span id="l9.288" class="difflineminus">-      make_body_test(&quot;Basic body&quot;, &quot;basic1&quot;, {}, [['', 3, 5]]),</span>
<a href="#l9.289"></a><span id="l9.289" class="difflineminus">-      make_body_test(&quot;Basic multipart&quot;, &quot;multipart1&quot;, {}, [['1', 10, 12]]),</span>
<a href="#l9.290"></a><span id="l9.290" class="difflineminus">-      make_body_test(&quot;Basic multipart&quot;, &quot;multipart2&quot;, {}, [['1', 8, 11]]),</span>
<a href="#l9.291"></a><span id="l9.291" class="difflineplus">+      make_body_test(&quot;Basic body&quot;, &quot;basic1&quot;, {}, [[&quot;&quot;, 3, 5]]),</span>
<a href="#l9.292"></a><span id="l9.292" class="difflineplus">+      make_body_test(&quot;Basic multipart&quot;, &quot;multipart1&quot;, {}, [[&quot;1&quot;, 10, 12]]),</span>
<a href="#l9.293"></a><span id="l9.293" class="difflineplus">+      make_body_test(&quot;Basic multipart&quot;, &quot;multipart2&quot;, {}, [[&quot;1&quot;, 8, 11]]),</span>
<a href="#l9.294"></a><span id="l9.294">       make_body_test(&quot;Complex multipart&quot;, &quot;multipart-complex1&quot;, {},</span>
<a href="#l9.295"></a><span id="l9.295">         mpart_complex1),</span>
<a href="#l9.296"></a><span id="l9.296">       make_body_test(&quot;Truncated multipart&quot;, &quot;multipart-complex2&quot;, {},</span>
<a href="#l9.297"></a><span id="l9.297" class="difflineminus">-        [['1.1.1.1', 21, 25], ['2', 27, 57], ['3', 60, 62]]),</span>
<a href="#l9.298"></a><span id="l9.298" class="difflineplus">+        [[&quot;1.1.1.1&quot;, 21, 25], [&quot;2&quot;, 27, 57], [&quot;3&quot;, 60, 62]]),</span>
<a href="#l9.299"></a><span id="l9.299">       make_body_test(&quot;No LF multipart&quot;, &quot;multipartmalt-detach&quot;, {},</span>
<a href="#l9.300"></a><span id="l9.300" class="difflineminus">-        [['1', 20, 21], ['2.1', 27, 38], ['2.2', 42, 43], ['2.3', 47, 48],</span>
<a href="#l9.301"></a><span id="l9.301" class="difflineminus">-         ['3', 53, 54]]),</span>
<a href="#l9.302"></a><span id="l9.302" class="difflineplus">+        [[&quot;1&quot;, 20, 21], [&quot;2.1&quot;, 27, 38], [&quot;2.2&quot;, 42, 43], [&quot;2.3&quot;, 47, 48],</span>
<a href="#l9.303"></a><span id="l9.303" class="difflineplus">+         [&quot;3&quot;, 53, 54]]),</span>
<a href="#l9.304"></a><span id="l9.304">       make_body_test(&quot;Raw body&quot;, &quot;multipart1&quot;, {bodyformat: &quot;raw&quot;},</span>
<a href="#l9.305"></a><span id="l9.305" class="difflineminus">-        [['', 4, 14]]),</span>
<a href="#l9.306"></a><span id="l9.306" class="difflineplus">+        [[&quot;&quot;, 4, 14]]),</span>
<a href="#l9.307"></a><span id="l9.307">       [&quot;Base64 decode 1&quot;, read_file(&quot;base64-1&quot;), {bodyformat: &quot;decode&quot;},</span>
<a href="#l9.308"></a><span id="l9.308" class="difflineminus">-        [['', &quot;\r\nHello, world! (Again...)\r\n\r\nLet's see how well base64 &quot; +</span>
<a href="#l9.309"></a><span id="l9.309" class="difflineplus">+        [[&quot;&quot;, &quot;\r\nHello, world! (Again...)\r\n\r\nLet's see how well base64 &quot; +</span>
<a href="#l9.310"></a><span id="l9.310">               &quot;text is handled.                            Yay, lots of space&quot; +</span>
<a href="#l9.311"></a><span id="l9.311">               &quot;s! There's even a CRLF at the end and one at the beginning, bu&quot; +</span>
<a href="#l9.312"></a><span id="l9.312">               &quot;t the output shouldn't have it.\r\n&quot;]]],</span>
<a href="#l9.313"></a><span id="l9.313">       [&quot;Base64 decode 2&quot;, read_file(&quot;base64-2&quot;), {bodyformat: &quot;decode&quot;},</span>
<a href="#l9.314"></a><span id="l9.314" class="difflineminus">-        [['', &quot;&lt;html&gt;&lt;body&gt;This is base64 encoded HTML text, and the tags sho&quot; +</span>
<a href="#l9.315"></a><span id="l9.315" class="difflineplus">+        [[&quot;&quot;, &quot;&lt;html&gt;&lt;body&gt;This is base64 encoded HTML text, and the tags sho&quot; +</span>
<a href="#l9.316"></a><span id="l9.316">               &quot;uldn't be stripped.\r\n&lt;b&gt;Bold text is bold!&lt;/b&gt;&lt;/body&gt;&lt;/html&gt;&quot; +</span>
<a href="#l9.317"></a><span id="l9.317">               &quot;\r\n&quot;]]],</span>
<a href="#l9.318"></a><span id="l9.318">       [&quot;Base64 decode line issues&quot;,</span>
<a href="#l9.319"></a><span id="l9.319" class="difflineminus">-        read_file(&quot;base64-2&quot;).then(function (s) { return s.split(/(\r\n)/) }),</span>
<a href="#l9.320"></a><span id="l9.320" class="difflineplus">+        read_file(&quot;base64-2&quot;).then(function(s) { return s.split(/(\r\n)/); }),</span>
<a href="#l9.321"></a><span id="l9.321">         {bodyformat: &quot;decode&quot;},</span>
<a href="#l9.322"></a><span id="l9.322" class="difflineminus">-        [['', &quot;&lt;html&gt;&lt;body&gt;This is base64 encoded HTML text, and the tags sho&quot; +</span>
<a href="#l9.323"></a><span id="l9.323" class="difflineplus">+        [[&quot;&quot;, &quot;&lt;html&gt;&lt;body&gt;This is base64 encoded HTML text, and the tags sho&quot; +</span>
<a href="#l9.324"></a><span id="l9.324">               &quot;uldn't be stripped.\r\n&lt;b&gt;Bold text is bold!&lt;/b&gt;&lt;/body&gt;&lt;/html&gt;&quot; +</span>
<a href="#l9.325"></a><span id="l9.325">               &quot;\r\n&quot;]]],</span>
<a href="#l9.326"></a><span id="l9.326" class="difflineminus">-      make_body_test(&quot;Base64 nodecode&quot;, &quot;base64-1&quot;, {}, [['', 4, 9]]),</span>
<a href="#l9.327"></a><span id="l9.327" class="difflineplus">+      make_body_test(&quot;Base64 nodecode&quot;, &quot;base64-1&quot;, {}, [[&quot;&quot;, 4, 9]]),</span>
<a href="#l9.328"></a><span id="l9.328">       [&quot;QP decode&quot;, read_file(&quot;bug505221&quot;),</span>
<a href="#l9.329"></a><span id="l9.329" class="difflineminus">-        {pruneat: '1', bodyformat: &quot;decode&quot;},</span>
<a href="#l9.330"></a><span id="l9.330" class="difflineminus">-        [['1', '&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.0 Transitional//EN&quot;' +</span>
<a href="#l9.331"></a><span id="l9.331" class="difflineplus">+        {pruneat: &quot;1&quot;, bodyformat: &quot;decode&quot;},</span>
<a href="#l9.332"></a><span id="l9.332" class="difflineplus">+        [[&quot;1&quot;, '&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.0 Transitional//EN&quot;' +</span>
<a href="#l9.333"></a><span id="l9.333">                '&gt;\r\n&lt;HTML&gt;&lt;HEAD&gt;\r\n&lt;META HTTP-EQUIV=&quot;Content-Type&quot; CONTENT=' +</span>
<a href="#l9.334"></a><span id="l9.334">                '&quot;text/html; charset=us-ascii&quot;&gt;\r\n\r\n\r\n&lt;META content=&quot;MSHT' +</span>
<a href="#l9.335"></a><span id="l9.335">                'ML 6.00.6000.16735&quot; name=GENERATOR&gt;&lt;/HEAD&gt;\r\n&lt;BODY&gt; bbb\r\n&lt;' +</span>
<a href="#l9.336"></a><span id="l9.336" class="difflineminus">-               '/BODY&gt;&lt;/HTML&gt;']]],</span>
<a href="#l9.337"></a><span id="l9.337" class="difflineplus">+               &quot;/BODY&gt;&lt;/HTML&gt;&quot;]]],</span>
<a href="#l9.338"></a><span id="l9.338">       [&quot;Nested messages&quot;, read_file(&quot;message-encoded&quot;), {bodyformat: &quot;decode&quot;},</span>
<a href="#l9.339"></a><span id="l9.339" class="difflineminus">-        [['1$', 'This is a plain-text message.'],</span>
<a href="#l9.340"></a><span id="l9.340" class="difflineminus">-         ['2$', 'I am a plain-text message.'],</span>
<a href="#l9.341"></a><span id="l9.341" class="difflineminus">-         ['3$', 'I am an encoded plain-text message.']]],</span>
<a href="#l9.342"></a><span id="l9.342" class="difflineplus">+        [[&quot;1$&quot;, &quot;This is a plain-text message.&quot;],</span>
<a href="#l9.343"></a><span id="l9.343" class="difflineplus">+         [&quot;2$&quot;, &quot;I am a plain-text message.&quot;],</span>
<a href="#l9.344"></a><span id="l9.344" class="difflineplus">+         [&quot;3$&quot;, &quot;I am an encoded plain-text message.&quot;]]],</span>
<a href="#l9.345"></a><span id="l9.345">       [&quot;Nested message headers&quot;, read_file(&quot;message-encoded&quot;), {},</span>
<a href="#l9.346"></a><span id="l9.346" class="difflineminus">-        {'': {'Content-Type': ['multipart/mixed; boundary=&quot;iamaboundary&quot;']},</span>
<a href="#l9.347"></a><span id="l9.347" class="difflineminus">-         '1': {'Content-Type': ['message/rfc822']},</span>
<a href="#l9.348"></a><span id="l9.348" class="difflineminus">-         '1$': {'Subject': ['I am a subject']},</span>
<a href="#l9.349"></a><span id="l9.349" class="difflineminus">-         '2': {'Content-Type': ['message/global'],</span>
<a href="#l9.350"></a><span id="l9.350" class="difflineminus">-               'Content-Transfer-Encoding': ['base64']},</span>
<a href="#l9.351"></a><span id="l9.351" class="difflineminus">-         '2$': {'Subject': ['\u79c1\u306f\u3001\u4ef6\u540d\u5348\u524d']},</span>
<a href="#l9.352"></a><span id="l9.352" class="difflineminus">-         '3': {'Content-Type': ['message/news'],</span>
<a href="#l9.353"></a><span id="l9.353" class="difflineminus">-               'Content-Transfer-Encoding': ['quoted-printable']},</span>
<a href="#l9.354"></a><span id="l9.354" class="difflineminus">-         '3$': {'Subject': ['\u79c1\u306f\u3001\u4ef6\u540d\u5348\u524d']}}],</span>
<a href="#l9.355"></a><span id="l9.355" class="difflineplus">+        {&quot;&quot;: {&quot;Content-Type&quot;: ['multipart/mixed; boundary=&quot;iamaboundary&quot;']},</span>
<a href="#l9.356"></a><span id="l9.356" class="difflineplus">+         &quot;1&quot;: {&quot;Content-Type&quot;: [&quot;message/rfc822&quot;]},</span>
<a href="#l9.357"></a><span id="l9.357" class="difflineplus">+         &quot;1$&quot;: {&quot;Subject&quot;: [&quot;I am a subject&quot;]},</span>
<a href="#l9.358"></a><span id="l9.358" class="difflineplus">+         &quot;2&quot;: {&quot;Content-Type&quot;: [&quot;message/global&quot;],</span>
<a href="#l9.359"></a><span id="l9.359" class="difflineplus">+               &quot;Content-Transfer-Encoding&quot;: [&quot;base64&quot;]},</span>
<a href="#l9.360"></a><span id="l9.360" class="difflineplus">+         &quot;2$&quot;: {&quot;Subject&quot;: [&quot;\u79c1\u306f\u3001\u4ef6\u540d\u5348\u524d&quot;]},</span>
<a href="#l9.361"></a><span id="l9.361" class="difflineplus">+         &quot;3&quot;: {&quot;Content-Type&quot;: [&quot;message/news&quot;],</span>
<a href="#l9.362"></a><span id="l9.362" class="difflineplus">+               &quot;Content-Transfer-Encoding&quot;: [&quot;quoted-printable&quot;]},</span>
<a href="#l9.363"></a><span id="l9.363" class="difflineplus">+         &quot;3$&quot;: {&quot;Subject&quot;: [&quot;\u79c1\u306f\u3001\u4ef6\u540d\u5348\u524d&quot;]}}],</span>
<a href="#l9.364"></a><span id="l9.364">     ];</span>
<a href="#l9.365"></a><span id="l9.365" class="difflineminus">-    parser_tests.forEach(function (data) {</span>
<a href="#l9.366"></a><span id="l9.366" class="difflineminus">-      arrayTest(data, function () {</span>
<a href="#l9.367"></a><span id="l9.367" class="difflineplus">+    parser_tests.forEach(function(data) {</span>
<a href="#l9.368"></a><span id="l9.368" class="difflineplus">+      arrayTest(data, function() {</span>
<a href="#l9.369"></a><span id="l9.369">         return testParser(data[1], data[2], data[3]);</span>
<a href="#l9.370"></a><span id="l9.370">       });</span>
<a href="#l9.371"></a><span id="l9.371">     });</span>
<a href="#l9.372"></a><span id="l9.372">   });</span>
<a href="#l9.373"></a><span id="l9.373"> </span>
<a href="#l9.374"></a><span id="l9.374" class="difflineminus">-  suite('Torture tests', function () {</span>
<a href="#l9.375"></a><span id="l9.375" class="difflineplus">+  suite(&quot;Torture tests&quot;, function() {</span>
<a href="#l9.376"></a><span id="l9.376">     // Generate a very long message for tests</span>
<a href="#l9.377"></a><span id="l9.377" class="difflineminus">-    let teststr = 'a';</span>
<a href="#l9.378"></a><span id="l9.378" class="difflineplus">+    let teststr = &quot;a&quot;;</span>
<a href="#l9.379"></a><span id="l9.379">     for (let i = 0; i &lt; 16; i++)</span>
<a href="#l9.380"></a><span id="l9.380">       teststr += teststr;</span>
<a href="#l9.381"></a><span id="l9.381">     let parser_tests = [</span>
<a href="#l9.382"></a><span id="l9.382">       [&quot;Base64 very long decode&quot;,</span>
<a href="#l9.383"></a><span id="l9.383">         &quot;Content-Transfer-Encoding: base64\r\n\r\n&quot; + btoa(teststr) + &quot;\r\n&quot;,</span>
<a href="#l9.384"></a><span id="l9.384" class="difflineminus">-        {bodyformat: &quot;decode&quot;}, [['', teststr]]],</span>
<a href="#l9.385"></a><span id="l9.385" class="difflineplus">+        {bodyformat: &quot;decode&quot;}, [[&quot;&quot;, teststr]]],</span>
<a href="#l9.386"></a><span id="l9.386">       make_body_test(&quot;Torture regular body&quot;, &quot;mime-torture&quot;, {}, [</span>
<a href="#l9.387"></a><span id="l9.387" class="difflineminus">-        ['1', 17, 21], ['2$.1', 58, 75], ['2$.2.1', 83, 97], ['2$.3', 102, 130],</span>
<a href="#l9.388"></a><span id="l9.388" class="difflineminus">-        ['3$', 155, 7742], ['4', 7747, 8213], ['5', 8218, 8242],</span>
<a href="#l9.389"></a><span id="l9.389" class="difflineminus">-        ['6$.1.1', 8284, 8301], ['6$.1.2', 8306, 8733], ['6$.2.1', 8742, 9095],</span>
<a href="#l9.390"></a><span id="l9.390" class="difflineminus">-        ['6$.2.2', 9100, 9354], ['6$.2.3', 9357, 11794],</span>
<a href="#l9.391"></a><span id="l9.391" class="difflineminus">-        ['6$.2.4', 11797, 12155], ['6$.3', 12161, 12809],</span>
<a href="#l9.392"></a><span id="l9.392" class="difflineminus">-        ['7$.1', 12844, 12845], ['7$.2', 12852, 13286],</span>
<a href="#l9.393"></a><span id="l9.393" class="difflineminus">-        ['7$.3', 13288, 13297], ['8$.1', 13331, 13358], ['8$.2', 13364, 13734],</span>
<a href="#l9.394"></a><span id="l9.394" class="difflineminus">-        ['9$', 13757, 20179], ['10', 20184, 21200], ['11$.1', 21223, 22031],</span>
<a href="#l9.395"></a><span id="l9.395" class="difflineminus">-        ['11$.2', 22036, 22586], ['12$.1', 22607, 23469],</span>
<a href="#l9.396"></a><span id="l9.396" class="difflineminus">-        ['12$.2', 23474, 23774], ['12$.3$.1', 23787, 23795],</span>
<a href="#l9.397"></a><span id="l9.397" class="difflineminus">-        ['12$.3$.2.1', 23803, 23820], ['12$.3$.2.2', 23825, 24633],</span>
<a href="#l9.398"></a><span id="l9.398" class="difflineminus">-        ['12$.3$.3', 24640, 24836], ['12$.3$.4$', 24848, 25872]]),</span>
<a href="#l9.399"></a><span id="l9.399" class="difflineminus">-      make_body_test(&quot;Torture pruneat&quot;, &quot;mime-torture&quot;, {&quot;pruneat&quot;: '4'},</span>
<a href="#l9.400"></a><span id="l9.400" class="difflineminus">-        [['4', 7747, 8213]]),</span>
<a href="#l9.401"></a><span id="l9.401" class="difflineplus">+        [&quot;1&quot;, 17, 21], [&quot;2$.1&quot;, 58, 75], [&quot;2$.2.1&quot;, 83, 97], [&quot;2$.3&quot;, 102, 130],</span>
<a href="#l9.402"></a><span id="l9.402" class="difflineplus">+        [&quot;3$&quot;, 155, 7742], [&quot;4&quot;, 7747, 8213], [&quot;5&quot;, 8218, 8242],</span>
<a href="#l9.403"></a><span id="l9.403" class="difflineplus">+        [&quot;6$.1.1&quot;, 8284, 8301], [&quot;6$.1.2&quot;, 8306, 8733], [&quot;6$.2.1&quot;, 8742, 9095],</span>
<a href="#l9.404"></a><span id="l9.404" class="difflineplus">+        [&quot;6$.2.2&quot;, 9100, 9354], [&quot;6$.2.3&quot;, 9357, 11794],</span>
<a href="#l9.405"></a><span id="l9.405" class="difflineplus">+        [&quot;6$.2.4&quot;, 11797, 12155], [&quot;6$.3&quot;, 12161, 12809],</span>
<a href="#l9.406"></a><span id="l9.406" class="difflineplus">+        [&quot;7$.1&quot;, 12844, 12845], [&quot;7$.2&quot;, 12852, 13286],</span>
<a href="#l9.407"></a><span id="l9.407" class="difflineplus">+        [&quot;7$.3&quot;, 13288, 13297], [&quot;8$.1&quot;, 13331, 13358], [&quot;8$.2&quot;, 13364, 13734],</span>
<a href="#l9.408"></a><span id="l9.408" class="difflineplus">+        [&quot;9$&quot;, 13757, 20179], [&quot;10&quot;, 20184, 21200], [&quot;11$.1&quot;, 21223, 22031],</span>
<a href="#l9.409"></a><span id="l9.409" class="difflineplus">+        [&quot;11$.2&quot;, 22036, 22586], [&quot;12$.1&quot;, 22607, 23469],</span>
<a href="#l9.410"></a><span id="l9.410" class="difflineplus">+        [&quot;12$.2&quot;, 23474, 23774], [&quot;12$.3$.1&quot;, 23787, 23795],</span>
<a href="#l9.411"></a><span id="l9.411" class="difflineplus">+        [&quot;12$.3$.2.1&quot;, 23803, 23820], [&quot;12$.3$.2.2&quot;, 23825, 24633],</span>
<a href="#l9.412"></a><span id="l9.412" class="difflineplus">+        [&quot;12$.3$.3&quot;, 24640, 24836], [&quot;12$.3$.4$&quot;, 24848, 25872]]),</span>
<a href="#l9.413"></a><span id="l9.413" class="difflineplus">+      make_body_test(&quot;Torture pruneat&quot;, &quot;mime-torture&quot;, {&quot;pruneat&quot;: &quot;4&quot;},</span>
<a href="#l9.414"></a><span id="l9.414" class="difflineplus">+        [[&quot;4&quot;, 7747, 8213]]),</span>
<a href="#l9.415"></a><span id="l9.415"> </span>
<a href="#l9.416"></a><span id="l9.416">       // Test packetization problems</span>
<a href="#l9.417"></a><span id="l9.417">       make_body_test(&quot;Large packets&quot;, &quot;multipart-complex1&quot;,</span>
<a href="#l9.418"></a><span id="l9.418">         {&quot;_split&quot;: /(.{30})/}, mpart_complex1),</span>
<a href="#l9.419"></a><span id="l9.419">       make_body_test(&quot;Split on newline&quot;, &quot;multipart-complex1&quot;,</span>
<a href="#l9.420"></a><span id="l9.420">         {&quot;_split&quot;: /(\r\n)/}, mpart_complex1),</span>
<a href="#l9.421"></a><span id="l9.421">       make_body_test(&quot;Pathological splitting&quot;, &quot;multipart-complex1&quot;,</span>
<a href="#l9.422"></a><span id="l9.422" class="difflineminus">-        {&quot;_split&quot;: ''}, mpart_complex1),</span>
<a href="#l9.423"></a><span id="l9.423" class="difflineplus">+        {&quot;_split&quot;: &quot;&quot;}, mpart_complex1),</span>
<a href="#l9.424"></a><span id="l9.424"> </span>
<a href="#l9.425"></a><span id="l9.425">       // Non-CLRF line endings?</span>
<a href="#l9.426"></a><span id="l9.426">       make_body_test(&quot;LF-based messages&quot;, &quot;multipart-complex1&quot;,</span>
<a href="#l9.427"></a><span id="l9.427">         {&quot;_eol&quot;: &quot;\n&quot;}, mpart_complex1),</span>
<a href="#l9.428"></a><span id="l9.428">       make_body_test(&quot;CR-based messages&quot;, &quot;multipart-complex1&quot;,</span>
<a href="#l9.429"></a><span id="l9.429">         {&quot;_eol&quot;: &quot;\r&quot;}, mpart_complex1),</span>
<a href="#l9.430"></a><span id="l9.430">     ];</span>
<a href="#l9.431"></a><span id="l9.431" class="difflineminus">-    parser_tests.forEach(function (data) {</span>
<a href="#l9.432"></a><span id="l9.432" class="difflineminus">-      arrayTest(data, function () {</span>
<a href="#l9.433"></a><span id="l9.433" class="difflineplus">+    parser_tests.forEach(function(data) {</span>
<a href="#l9.434"></a><span id="l9.434" class="difflineplus">+      arrayTest(data, function() {</span>
<a href="#l9.435"></a><span id="l9.435">         return testParser(data[1], data[2], data[3]);</span>
<a href="#l9.436"></a><span id="l9.436">       });</span>
<a href="#l9.437"></a><span id="l9.437">     });</span>
<a href="#l9.438"></a><span id="l9.438">   });</span>
<a href="#l9.439"></a><span id="l9.439"> </span>
<a href="#l9.440"></a><span id="l9.440" class="difflineminus">-  suite('Header tests', function () {</span>
<a href="#l9.441"></a><span id="l9.441" class="difflineplus">+  suite(&quot;Header tests&quot;, function() {</span>
<a href="#l9.442"></a><span id="l9.442">     let parser_tests = [</span>
<a href="#l9.443"></a><span id="l9.443">       // Basic cases for headers</span>
<a href="#l9.444"></a><span id="l9.444" class="difflineminus">-      ['Multiparts get headers', read_file(&quot;multipart-complex1&quot;), {},</span>
<a href="#l9.445"></a><span id="l9.445" class="difflineminus">-        { '': {'Content-Type': ['multipart/mixed; boundary=&quot;boundary&quot;']},</span>
<a href="#l9.446"></a><span id="l9.446" class="difflineminus">-          '1': {'Content-Type': ['application/octet-stream'],</span>
<a href="#l9.447"></a><span id="l9.447" class="difflineminus">-                'Content-Transfer-Encoding': ['base64']},</span>
<a href="#l9.448"></a><span id="l9.448" class="difflineminus">-          '2': {'Content-Type': ['image/png'],</span>
<a href="#l9.449"></a><span id="l9.449" class="difflineminus">-                'Content-Transfer-Encoding': ['base64']},</span>
<a href="#l9.450"></a><span id="l9.450" class="difflineminus">-          '3': {'Content-Type': ['multipart/related; boundary=&quot;boundary2&quot;']},</span>
<a href="#l9.451"></a><span id="l9.451" class="difflineminus">-          '3.1': {'Content-Type': ['text/html']},</span>
<a href="#l9.452"></a><span id="l9.452" class="difflineminus">-          '4': {'Content-Type': ['text/plain']}, '5': {} }],</span>
<a href="#l9.453"></a><span id="l9.453" class="difflineplus">+      [&quot;Multiparts get headers&quot;, read_file(&quot;multipart-complex1&quot;), {},</span>
<a href="#l9.454"></a><span id="l9.454" class="difflineplus">+        { &quot;&quot;: {&quot;Content-Type&quot;: ['multipart/mixed; boundary=&quot;boundary&quot;']},</span>
<a href="#l9.455"></a><span id="l9.455" class="difflineplus">+          &quot;1&quot;: {&quot;Content-Type&quot;: [&quot;application/octet-stream&quot;],</span>
<a href="#l9.456"></a><span id="l9.456" class="difflineplus">+                &quot;Content-Transfer-Encoding&quot;: [&quot;base64&quot;]},</span>
<a href="#l9.457"></a><span id="l9.457" class="difflineplus">+          &quot;2&quot;: {&quot;Content-Type&quot;: [&quot;image/png&quot;],</span>
<a href="#l9.458"></a><span id="l9.458" class="difflineplus">+                &quot;Content-Transfer-Encoding&quot;: [&quot;base64&quot;]},</span>
<a href="#l9.459"></a><span id="l9.459" class="difflineplus">+          &quot;3&quot;: {&quot;Content-Type&quot;: ['multipart/related; boundary=&quot;boundary2&quot;']},</span>
<a href="#l9.460"></a><span id="l9.460" class="difflineplus">+          &quot;3.1&quot;: {&quot;Content-Type&quot;: [&quot;text/html&quot;]},</span>
<a href="#l9.461"></a><span id="l9.461" class="difflineplus">+          &quot;4&quot;: {&quot;Content-Type&quot;: [&quot;text/plain&quot;]}, &quot;5&quot;: {} }],</span>
<a href="#l9.462"></a><span id="l9.462">       // 'From ' is not an [iterable] header</span>
<a href="#l9.463"></a><span id="l9.463" class="difflineminus">-      ['Exclude mbox delimiter', read_file('bugmail11'), {}, {'': {</span>
<a href="#l9.464"></a><span id="l9.464" class="difflineminus">-        'X-Mozilla-Status': ['0001'], 'X-Mozilla-Status2': ['00000000'],</span>
<a href="#l9.465"></a><span id="l9.465" class="difflineminus">-        'X-Mozilla-Keys': [''],</span>
<a href="#l9.466"></a><span id="l9.466" class="difflineminus">-        'Return-Path': ['&lt;example@example.com&gt;',</span>
<a href="#l9.467"></a><span id="l9.467" class="difflineminus">-           '&lt;bugzilla-daemon@mozilla.org&gt;'],</span>
<a href="#l9.468"></a><span id="l9.468" class="difflineminus">-        'Delivered-To': ['bugmail@example.org'],</span>
<a href="#l9.469"></a><span id="l9.469" class="difflineminus">-        'Received': ['by 10.114.166.12 with SMTP id o12cs163262wae;' +</span>
<a href="#l9.470"></a><span id="l9.470" class="difflineminus">-                     '        Fri, 11 Apr 2008 07:17:31 -0700 (PDT)',</span>
<a href="#l9.471"></a><span id="l9.471" class="difflineminus">-          'by 10.115.60.1 with SMTP id n1mr214763wak.181.1207923450166;' +</span>
<a href="#l9.472"></a><span id="l9.472" class="difflineminus">-          '        Fri, 11 Apr 2008 07:17:30 -0700 (PDT)',</span>
<a href="#l9.473"></a><span id="l9.473" class="difflineminus">-          'from webapp-out.mozilla.org (webapp01.sj.mozilla.com [63.245.208.1' +</span>
<a href="#l9.474"></a><span id="l9.474" class="difflineminus">-          '46])        by mx.google.com with ESMTP id n38si6807242wag.2.2008.' +</span>
<a href="#l9.475"></a><span id="l9.475" class="difflineminus">-          '04.11.07.17.29;        Fri, 11 Apr 2008 07:17:30 -0700 (PDT)',</span>
<a href="#l9.476"></a><span id="l9.476" class="difflineminus">-          'from mrapp51.mozilla.org (mrapp51.mozilla.org [127.0.0.1])' +</span>
<a href="#l9.477"></a><span id="l9.477" class="difflineminus">-          '\tby webapp-out.mozilla.org (8.13.8/8.13.8) with ESMTP id m3BEHTGU' +</span>
<a href="#l9.478"></a><span id="l9.478" class="difflineminus">-          '030132\tfor &lt;bugmail@example.org&gt;; Fri, 11 Apr 2008 07:17:29 -0700',</span>
<a href="#l9.479"></a><span id="l9.479" class="difflineminus">-          '(from root@localhost)' +</span>
<a href="#l9.480"></a><span id="l9.480" class="difflineminus">-          '\tby mrapp51.mozilla.org (8.13.8/8.13.8/Submit) id m3BEHTk4030129;' +</span>
<a href="#l9.481"></a><span id="l9.481" class="difflineminus">-          '\tFri, 11 Apr 2008 07:17:29 -0700'],</span>
<a href="#l9.482"></a><span id="l9.482" class="difflineminus">-        'Received-Spf': ['neutral (google.com: 63.245.208.146 is neither perm' +</span>
<a href="#l9.483"></a><span id="l9.483" class="difflineminus">-          'itted nor denied by best guess record for domain of bugzilla-daemo' +</span>
<a href="#l9.484"></a><span id="l9.484" class="difflineminus">-          'n@mozilla.org) client-ip=63.245.208.146;'],</span>
<a href="#l9.485"></a><span id="l9.485" class="difflineminus">-        'Authentication-Results': ['mx.google.com; spf=neutral (google.com: 6' +</span>
<a href="#l9.486"></a><span id="l9.486" class="difflineminus">-          '3.245.208.146 is neither permitted nor denied by best guess record' +</span>
<a href="#l9.487"></a><span id="l9.487" class="difflineminus">-          ' for domain of bugzilla-daemon@mozilla.org) smtp.mail=bugzilla-dae' +</span>
<a href="#l9.488"></a><span id="l9.488" class="difflineminus">-          'mon@mozilla.org'],</span>
<a href="#l9.489"></a><span id="l9.489" class="difflineminus">-        'Date': ['Fri, 11 Apr 2008 07:17:29 -0700'],</span>
<a href="#l9.490"></a><span id="l9.490" class="difflineminus">-        'Message-ID': ['&lt;200804111417.m3BEHTk4030129@mrapp51.mozilla.org&gt;'],</span>
<a href="#l9.491"></a><span id="l9.491" class="difflineminus">-        'From': ['bugzilla-daemon@mozilla.org'], 'To': ['bugmail@example.org'],</span>
<a href="#l9.492"></a><span id="l9.492" class="difflineminus">-        'Subject': ['Bugzilla: confirm account creation'],</span>
<a href="#l9.493"></a><span id="l9.493" class="difflineminus">-        'X-Bugzilla-Type': ['admin'],</span>
<a href="#l9.494"></a><span id="l9.494" class="difflineminus">-        'Content-Type': ['text/plain; charset=&quot;UTF-8&quot;'],</span>
<a href="#l9.495"></a><span id="l9.495" class="difflineminus">-        'MIME-Version': ['1.0']}}],</span>
<a href="#l9.496"></a><span id="l9.496" class="difflineplus">+      [&quot;Exclude mbox delimiter&quot;, read_file(&quot;bugmail11&quot;), {}, {&quot;&quot;: {</span>
<a href="#l9.497"></a><span id="l9.497" class="difflineplus">+        &quot;X-Mozilla-Status&quot;: [&quot;0001&quot;], &quot;X-Mozilla-Status2&quot;: [&quot;00000000&quot;],</span>
<a href="#l9.498"></a><span id="l9.498" class="difflineplus">+        &quot;X-Mozilla-Keys&quot;: [&quot;&quot;],</span>
<a href="#l9.499"></a><span id="l9.499" class="difflineplus">+        &quot;Return-Path&quot;: [&quot;&lt;example@example.com&gt;&quot;,</span>
<a href="#l9.500"></a><span id="l9.500" class="difflineplus">+           &quot;&lt;bugzilla-daemon@mozilla.org&gt;&quot;],</span>
<a href="#l9.501"></a><span id="l9.501" class="difflineplus">+        &quot;Delivered-To&quot;: [&quot;bugmail@example.org&quot;],</span>
<a href="#l9.502"></a><span id="l9.502" class="difflineplus">+        &quot;Received&quot;: [&quot;by 10.114.166.12 with SMTP id o12cs163262wae;&quot; +</span>
<a href="#l9.503"></a><span id="l9.503" class="difflineplus">+                     &quot;        Fri, 11 Apr 2008 07:17:31 -0700 (PDT)&quot;,</span>
<a href="#l9.504"></a><span id="l9.504" class="difflineplus">+          &quot;by 10.115.60.1 with SMTP id n1mr214763wak.181.1207923450166;&quot; +</span>
<a href="#l9.505"></a><span id="l9.505" class="difflineplus">+          &quot;        Fri, 11 Apr 2008 07:17:30 -0700 (PDT)&quot;,</span>
<a href="#l9.506"></a><span id="l9.506" class="difflineplus">+          &quot;from webapp-out.mozilla.org (webapp01.sj.mozilla.com [63.245.208.1&quot; +</span>
<a href="#l9.507"></a><span id="l9.507" class="difflineplus">+          &quot;46])        by mx.google.com with ESMTP id n38si6807242wag.2.2008.&quot; +</span>
<a href="#l9.508"></a><span id="l9.508" class="difflineplus">+          &quot;04.11.07.17.29;        Fri, 11 Apr 2008 07:17:30 -0700 (PDT)&quot;,</span>
<a href="#l9.509"></a><span id="l9.509" class="difflineplus">+          &quot;from mrapp51.mozilla.org (mrapp51.mozilla.org [127.0.0.1])&quot; +</span>
<a href="#l9.510"></a><span id="l9.510" class="difflineplus">+          &quot;\tby webapp-out.mozilla.org (8.13.8/8.13.8) with ESMTP id m3BEHTGU&quot; +</span>
<a href="#l9.511"></a><span id="l9.511" class="difflineplus">+          &quot;030132\tfor &lt;bugmail@example.org&gt;; Fri, 11 Apr 2008 07:17:29 -0700&quot;,</span>
<a href="#l9.512"></a><span id="l9.512" class="difflineplus">+          &quot;(from root@localhost)&quot; +</span>
<a href="#l9.513"></a><span id="l9.513" class="difflineplus">+          &quot;\tby mrapp51.mozilla.org (8.13.8/8.13.8/Submit) id m3BEHTk4030129;&quot; +</span>
<a href="#l9.514"></a><span id="l9.514" class="difflineplus">+          &quot;\tFri, 11 Apr 2008 07:17:29 -0700&quot;],</span>
<a href="#l9.515"></a><span id="l9.515" class="difflineplus">+        &quot;Received-Spf&quot;: [&quot;neutral (google.com: 63.245.208.146 is neither perm&quot; +</span>
<a href="#l9.516"></a><span id="l9.516" class="difflineplus">+          &quot;itted nor denied by best guess record for domain of bugzilla-daemo&quot; +</span>
<a href="#l9.517"></a><span id="l9.517" class="difflineplus">+          &quot;n@mozilla.org) client-ip=63.245.208.146;&quot;],</span>
<a href="#l9.518"></a><span id="l9.518" class="difflineplus">+        &quot;Authentication-Results&quot;: [&quot;mx.google.com; spf=neutral (google.com: 6&quot; +</span>
<a href="#l9.519"></a><span id="l9.519" class="difflineplus">+          &quot;3.245.208.146 is neither permitted nor denied by best guess record&quot; +</span>
<a href="#l9.520"></a><span id="l9.520" class="difflineplus">+          &quot; for domain of bugzilla-daemon@mozilla.org) smtp.mail=bugzilla-dae&quot; +</span>
<a href="#l9.521"></a><span id="l9.521" class="difflineplus">+          &quot;mon@mozilla.org&quot;],</span>
<a href="#l9.522"></a><span id="l9.522" class="difflineplus">+        &quot;Date&quot;: [&quot;Fri, 11 Apr 2008 07:17:29 -0700&quot;],</span>
<a href="#l9.523"></a><span id="l9.523" class="difflineplus">+        &quot;Message-ID&quot;: [&quot;&lt;200804111417.m3BEHTk4030129@mrapp51.mozilla.org&gt;&quot;],</span>
<a href="#l9.524"></a><span id="l9.524" class="difflineplus">+        &quot;From&quot;: [&quot;bugzilla-daemon@mozilla.org&quot;], &quot;To&quot;: [&quot;bugmail@example.org&quot;],</span>
<a href="#l9.525"></a><span id="l9.525" class="difflineplus">+        &quot;Subject&quot;: [&quot;Bugzilla: confirm account creation&quot;],</span>
<a href="#l9.526"></a><span id="l9.526" class="difflineplus">+        &quot;X-Bugzilla-Type&quot;: [&quot;admin&quot;],</span>
<a href="#l9.527"></a><span id="l9.527" class="difflineplus">+        &quot;Content-Type&quot;: ['text/plain; charset=&quot;UTF-8&quot;'],</span>
<a href="#l9.528"></a><span id="l9.528" class="difflineplus">+        &quot;MIME-Version&quot;: [&quot;1.0&quot;]}}],</span>
<a href="#l9.529"></a><span id="l9.529">     ];</span>
<a href="#l9.530"></a><span id="l9.530" class="difflineminus">-    parser_tests.forEach(function (data) {</span>
<a href="#l9.531"></a><span id="l9.531" class="difflineminus">-      arrayTest(data, function () {</span>
<a href="#l9.532"></a><span id="l9.532" class="difflineplus">+    parser_tests.forEach(function(data) {</span>
<a href="#l9.533"></a><span id="l9.533" class="difflineplus">+      arrayTest(data, function() {</span>
<a href="#l9.534"></a><span id="l9.534">         return testParser(data[1], data[2], data[3]);</span>
<a href="#l9.535"></a><span id="l9.535">       });</span>
<a href="#l9.536"></a><span id="l9.536">     });</span>
<a href="#l9.537"></a><span id="l9.537">   });</span>
<a href="#l9.538"></a><span id="l9.538"> </span>
<a href="#l9.539"></a><span id="l9.539" class="difflineminus">-  suite('Charset tests', function () {</span>
<a href="#l9.540"></a><span id="l9.540" class="difflineplus">+  suite(&quot;Charset tests&quot;, function() {</span>
<a href="#l9.541"></a><span id="l9.541">     function buildTree(file, options) {</span>
<a href="#l9.542"></a><span id="l9.542">       var tree = new Map();</span>
<a href="#l9.543"></a><span id="l9.543">       var emitter = {</span>
<a href="#l9.544"></a><span id="l9.544" class="difflineminus">-        startPart: function (part, headers) {</span>
<a href="#l9.545"></a><span id="l9.545" class="difflineminus">-          tree.set(part, {headers: headers, body: null});</span>
<a href="#l9.546"></a><span id="l9.546" class="difflineplus">+        startPart(part, headers) {</span>
<a href="#l9.547"></a><span id="l9.547" class="difflineplus">+          tree.set(part, {headers, body: null});</span>
<a href="#l9.548"></a><span id="l9.548">         },</span>
<a href="#l9.549"></a><span id="l9.549" class="difflineminus">-        deliverPartData: function (part, data) {</span>
<a href="#l9.550"></a><span id="l9.550" class="difflineplus">+        deliverPartData(part, data) {</span>
<a href="#l9.551"></a><span id="l9.551">           var obj = tree.get(part);</span>
<a href="#l9.552"></a><span id="l9.552" class="difflineminus">-          if (obj.body === null)</span>
<a href="#l9.553"></a><span id="l9.553" class="difflineplus">+          if (obj.body === null) {</span>
<a href="#l9.554"></a><span id="l9.554">             obj.body = data;</span>
<a href="#l9.555"></a><span id="l9.555" class="difflineminus">-          else if (typeof obj.body === &quot;string&quot;)</span>
<a href="#l9.556"></a><span id="l9.556" class="difflineplus">+          } else if (typeof obj.body === &quot;string&quot;) {</span>
<a href="#l9.557"></a><span id="l9.557">             obj.body += data;</span>
<a href="#l9.558"></a><span id="l9.558" class="difflineminus">-          else {</span>
<a href="#l9.559"></a><span id="l9.559" class="difflineplus">+          } else {</span>
<a href="#l9.560"></a><span id="l9.560">             var newData = new Uint8Array(obj.body.length + data.length);</span>
<a href="#l9.561"></a><span id="l9.561">             newData.set(obj.body);</span>
<a href="#l9.562"></a><span id="l9.562">             newData.subarray(obj.body.length).set(data);</span>
<a href="#l9.563"></a><span id="l9.563">             obj.body = newData;</span>
<a href="#l9.564"></a><span id="l9.564">           }</span>
<a href="#l9.565"></a><span id="l9.565" class="difflineminus">-        }</span>
<a href="#l9.566"></a><span id="l9.566" class="difflineplus">+        },</span>
<a href="#l9.567"></a><span id="l9.567">       };</span>
<a href="#l9.568"></a><span id="l9.568" class="difflineminus">-      return file.then(function (data) {</span>
<a href="#l9.569"></a><span id="l9.569" class="difflineplus">+      return file.then(function(data) {</span>
<a href="#l9.570"></a><span id="l9.570">         var parser = new jsmime.MimeParser(emitter, options);</span>
<a href="#l9.571"></a><span id="l9.571">         parser.deliverData(data);</span>
<a href="#l9.572"></a><span id="l9.572">         parser.deliverEOF();</span>
<a href="#l9.573"></a><span id="l9.573">         return tree;</span>
<a href="#l9.574"></a><span id="l9.574">       });</span>
<a href="#l9.575"></a><span id="l9.575">     }</span>
<a href="#l9.576"></a><span id="l9.576" class="difflineminus">-    test('Unicode decoding', function () {</span>
<a href="#l9.577"></a><span id="l9.577" class="difflineminus">-      return buildTree(read_file('shift-jis-image'), {</span>
<a href="#l9.578"></a><span id="l9.578" class="difflineplus">+    test(&quot;Unicode decoding&quot;, function() {</span>
<a href="#l9.579"></a><span id="l9.579" class="difflineplus">+      return buildTree(read_file(&quot;shift-jis-image&quot;), {</span>
<a href="#l9.580"></a><span id="l9.580">         strformat: &quot;unicode&quot;,</span>
<a href="#l9.581"></a><span id="l9.581" class="difflineminus">-        bodyformat: &quot;decode&quot;</span>
<a href="#l9.582"></a><span id="l9.582" class="difflineminus">-      }).then(function (tree) {</span>
<a href="#l9.583"></a><span id="l9.583" class="difflineplus">+        bodyformat: &quot;decode&quot;,</span>
<a href="#l9.584"></a><span id="l9.584" class="difflineplus">+      }).then(function(tree) {</span>
<a href="#l9.585"></a><span id="l9.585">         // text/plain should be transcoded...</span>
<a href="#l9.586"></a><span id="l9.586" class="difflineminus">-        assert.equal(tree.get('1').headers.get('Content-Type').get('charset'),</span>
<a href="#l9.587"></a><span id="l9.587" class="difflineminus">-          'Shift-JIS');</span>
<a href="#l9.588"></a><span id="l9.588" class="difflineminus">-        assert.equal(tree.get('1').headers.charset, 'Shift-JIS');</span>
<a href="#l9.589"></a><span id="l9.589" class="difflineminus">-        assert.equal(tree.get('1').headers.get('Content-Description'),</span>
<a href="#l9.590"></a><span id="l9.590" class="difflineminus">-          '\u30b1\u30c4\u30a1\u30eb\u30b3\u30a2\u30c8\u30eb');</span>
<a href="#l9.591"></a><span id="l9.591" class="difflineminus">-        assert.equal(tree.get('1').body, 'Portable Network Graphics\uff08' +</span>
<a href="#l9.592"></a><span id="l9.592" class="difflineminus">-          '\u30dd\u30fc\u30bf\u30d6\u30eb\u30fb\u30cd\u30c3\u30c8\u30ef\u30fc' +</span>
<a href="#l9.593"></a><span id="l9.593" class="difflineminus">-          '\u30af\u30fb\u30b0\u30e9\u30d5\u30a3\u30c3\u30af\u30b9\u3001PNG' +</span>
<a href="#l9.594"></a><span id="l9.594" class="difflineminus">-          '\uff09\u306f\u30b3\u30f3\u30d4\u30e5\u30fc\u30bf\u3067\u30d3\u30c3' +</span>
<a href="#l9.595"></a><span id="l9.595" class="difflineminus">-          '\u30c8\u30de\u30c3\u30d7\u753b\u50cf\u3092\u6271\u3046\u30d5\u30a1' +</span>
<a href="#l9.596"></a><span id="l9.596" class="difflineminus">-          '\u30a4\u30eb\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3067\u3042\u308b' +</span>
<a href="#l9.597"></a><span id="l9.597" class="difflineminus">-          '\u3002\u5727\u7e2e\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3068\u3057' +</span>
<a href="#l9.598"></a><span id="l9.598" class="difflineminus">-          '\u3066Deflate\u3092\u63a1\u7528\u3057\u3066\u3044\u308b\u3001' +</span>
<a href="#l9.599"></a><span id="l9.599" class="difflineminus">-          '\u5727\u7e2e\u306b\u3088\u308b\u753b\u8cea\u306e\u52a3\u5316\u306e' +</span>
<a href="#l9.600"></a><span id="l9.600" class="difflineminus">-          '\u306a\u3044\u53ef\u9006\u5727\u7e2e\u306e\u753b\u50cf\u30d5\u30a1' +</span>
<a href="#l9.601"></a><span id="l9.601" class="difflineminus">-          '\u30a4\u30eb\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3067\u3042\u308b' +</span>
<a href="#l9.602"></a><span id="l9.602" class="difflineminus">-          '\u3002\r\n');</span>
<a href="#l9.603"></a><span id="l9.603" class="difflineplus">+        assert.equal(tree.get(&quot;1&quot;).headers.get(&quot;Content-Type&quot;).get(&quot;charset&quot;),</span>
<a href="#l9.604"></a><span id="l9.604" class="difflineplus">+          &quot;Shift-JIS&quot;);</span>
<a href="#l9.605"></a><span id="l9.605" class="difflineplus">+        assert.equal(tree.get(&quot;1&quot;).headers.charset, &quot;Shift-JIS&quot;);</span>
<a href="#l9.606"></a><span id="l9.606" class="difflineplus">+        assert.equal(tree.get(&quot;1&quot;).headers.get(&quot;Content-Description&quot;),</span>
<a href="#l9.607"></a><span id="l9.607" class="difflineplus">+          &quot;\u30b1\u30c4\u30a1\u30eb\u30b3\u30a2\u30c8\u30eb&quot;);</span>
<a href="#l9.608"></a><span id="l9.608" class="difflineplus">+        assert.equal(tree.get(&quot;1&quot;).body, &quot;Portable Network Graphics\uff08&quot; +</span>
<a href="#l9.609"></a><span id="l9.609" class="difflineplus">+          &quot;\u30dd\u30fc\u30bf\u30d6\u30eb\u30fb\u30cd\u30c3\u30c8\u30ef\u30fc&quot; +</span>
<a href="#l9.610"></a><span id="l9.610" class="difflineplus">+          &quot;\u30af\u30fb\u30b0\u30e9\u30d5\u30a3\u30c3\u30af\u30b9\u3001PNG&quot; +</span>
<a href="#l9.611"></a><span id="l9.611" class="difflineplus">+          &quot;\uff09\u306f\u30b3\u30f3\u30d4\u30e5\u30fc\u30bf\u3067\u30d3\u30c3&quot; +</span>
<a href="#l9.612"></a><span id="l9.612" class="difflineplus">+          &quot;\u30c8\u30de\u30c3\u30d7\u753b\u50cf\u3092\u6271\u3046\u30d5\u30a1&quot; +</span>
<a href="#l9.613"></a><span id="l9.613" class="difflineplus">+          &quot;\u30a4\u30eb\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3067\u3042\u308b&quot; +</span>
<a href="#l9.614"></a><span id="l9.614" class="difflineplus">+          &quot;\u3002\u5727\u7e2e\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3068\u3057&quot; +</span>
<a href="#l9.615"></a><span id="l9.615" class="difflineplus">+          &quot;\u3066Deflate\u3092\u63a1\u7528\u3057\u3066\u3044\u308b\u3001&quot; +</span>
<a href="#l9.616"></a><span id="l9.616" class="difflineplus">+          &quot;\u5727\u7e2e\u306b\u3088\u308b\u753b\u8cea\u306e\u52a3\u5316\u306e&quot; +</span>
<a href="#l9.617"></a><span id="l9.617" class="difflineplus">+          &quot;\u306a\u3044\u53ef\u9006\u5727\u7e2e\u306e\u753b\u50cf\u30d5\u30a1&quot; +</span>
<a href="#l9.618"></a><span id="l9.618" class="difflineplus">+          &quot;\u30a4\u30eb\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3067\u3042\u308b&quot; +</span>
<a href="#l9.619"></a><span id="l9.619" class="difflineplus">+          &quot;\u3002\r\n&quot;);</span>
<a href="#l9.620"></a><span id="l9.620">         // ... but not image/png</span>
<a href="#l9.621"></a><span id="l9.621" class="difflineminus">-        assert.ok(!tree.get('2').headers.get('Content-Type').has('charset'));</span>
<a href="#l9.622"></a><span id="l9.622" class="difflineminus">-        assert.equal(tree.get('2').headers.charset, '');</span>
<a href="#l9.623"></a><span id="l9.623" class="difflineminus">-        assert.equal(tree.get('2').headers.get('Content-Description'),</span>
<a href="#l9.624"></a><span id="l9.624" class="difflineminus">-          '\ufffdP\ufffdc\ufffd@\ufffd\ufffd\ufffdR\ufffdA\ufffdg\ufffd\ufffd');</span>
<a href="#l9.625"></a><span id="l9.625" class="difflineminus">-        assert.equal(tree.get('2').headers.getRawHeader('Content-Description'),</span>
<a href="#l9.626"></a><span id="l9.626" class="difflineminus">-          '\x83\x50\x83\x63\x83\x40\x83\x8b\x83\x52\x83\x41\x83\x67\x83\x8b');</span>
<a href="#l9.627"></a><span id="l9.627" class="difflineminus">-        var imageData = 'iVBORw0KGgoAAAANSUhEUgAAAIAAAABECAIAAADGJao+AAAAwklE' +</span>
<a href="#l9.628"></a><span id="l9.628" class="difflineminus">-          'QVR4Xu3UgQbDMBRA0bc03f//b7N0VuqJEmwoc+KqNEkDh9b+2HuJu1KNO4f+AQCAAA' +</span>
<a href="#l9.629"></a><span id="l9.629" class="difflineminus">-          'AQAAACAEAAAAgAAAEAIAAABACAAAAQAAACAEAAAAgAAAEAIAAAANReamRLlPWYfNH0' +</span>
<a href="#l9.630"></a><span id="l9.630" class="difflineminus">-          'klxcPs+cP3NxWF+vi3lb7pa2R+vx6tHOtuN1O+a5lY3HzgM5ya/GM5N7ZjfPq7/5yS' +</span>
<a href="#l9.631"></a><span id="l9.631" class="difflineminus">-          '8IgAAAEAAAAgBAAAAIAAABACAAAAQAgAAAEAAAAgBAAAAIAAABACAAAIw322gDIPvt' +</span>
<a href="#l9.632"></a><span id="l9.632" class="difflineminus">-          'lmUAAAAASUVORK5CYII=';</span>
<a href="#l9.633"></a><span id="l9.633" class="difflineplus">+        assert.ok(!tree.get(&quot;2&quot;).headers.get(&quot;Content-Type&quot;).has(&quot;charset&quot;));</span>
<a href="#l9.634"></a><span id="l9.634" class="difflineplus">+        assert.equal(tree.get(&quot;2&quot;).headers.charset, &quot;&quot;);</span>
<a href="#l9.635"></a><span id="l9.635" class="difflineplus">+        assert.equal(tree.get(&quot;2&quot;).headers.get(&quot;Content-Description&quot;),</span>
<a href="#l9.636"></a><span id="l9.636" class="difflineplus">+          &quot;\ufffdP\ufffdc\ufffd@\ufffd\ufffd\ufffdR\ufffdA\ufffdg\ufffd\ufffd&quot;);</span>
<a href="#l9.637"></a><span id="l9.637" class="difflineplus">+        assert.equal(tree.get(&quot;2&quot;).headers.getRawHeader(&quot;Content-Description&quot;),</span>
<a href="#l9.638"></a><span id="l9.638" class="difflineplus">+          &quot;\x83\x50\x83\x63\x83\x40\x83\x8b\x83\x52\x83\x41\x83\x67\x83\x8b&quot;);</span>
<a href="#l9.639"></a><span id="l9.639" class="difflineplus">+        var imageData = &quot;iVBORw0KGgoAAAANSUhEUgAAAIAAAABECAIAAADGJao+AAAAwklE&quot; +</span>
<a href="#l9.640"></a><span id="l9.640" class="difflineplus">+          &quot;QVR4Xu3UgQbDMBRA0bc03f//b7N0VuqJEmwoc+KqNEkDh9b+2HuJu1KNO4f+AQCAAA&quot; +</span>
<a href="#l9.641"></a><span id="l9.641" class="difflineplus">+          &quot;AQAAACAEAAAAgAAAEAIAAABACAAAAQAAACAEAAAAgAAAEAIAAAANReamRLlPWYfNH0&quot; +</span>
<a href="#l9.642"></a><span id="l9.642" class="difflineplus">+          &quot;klxcPs+cP3NxWF+vi3lb7pa2R+vx6tHOtuN1O+a5lY3HzgM5ya/GM5N7ZjfPq7/5yS&quot; +</span>
<a href="#l9.643"></a><span id="l9.643" class="difflineplus">+          &quot;8IgAAAEAAAAgBAAAAIAAABACAAAAQAgAAAEAAAAgBAAAAIAAABACAAAIw322gDIPvt&quot; +</span>
<a href="#l9.644"></a><span id="l9.644" class="difflineplus">+          &quot;lmUAAAAASUVORK5CYII=&quot;;</span>
<a href="#l9.645"></a><span id="l9.645">         imageData = atob(imageData);</span>
<a href="#l9.646"></a><span id="l9.646">         var asArray = new Uint8Array(imageData.length);</span>
<a href="#l9.647"></a><span id="l9.647">         for (var i = 0; i &lt; asArray.length; i++)</span>
<a href="#l9.648"></a><span id="l9.648">           asArray[i] = imageData.charCodeAt(i);</span>
<a href="#l9.649"></a><span id="l9.649" class="difflineminus">-        assert.deepEqual(tree.get('2').body, asArray);</span>
<a href="#l9.650"></a><span id="l9.650" class="difflineplus">+        assert.deepEqual(tree.get(&quot;2&quot;).body, asArray);</span>
<a href="#l9.651"></a><span id="l9.651"> </span>
<a href="#l9.652"></a><span id="l9.652">         // Touching the header charset should change the interpretation.</span>
<a href="#l9.653"></a><span id="l9.653" class="difflineminus">-        tree.get('1').headers.charset = 'Shift-JIS';</span>
<a href="#l9.654"></a><span id="l9.654" class="difflineminus">-        assert.equal(tree.get('1').headers.charset, 'Shift-JIS');</span>
<a href="#l9.655"></a><span id="l9.655" class="difflineminus">-        assert.equal(tree.get('1').headers.get('Content-Description'),</span>
<a href="#l9.656"></a><span id="l9.656" class="difflineminus">-          '\u30b1\u30c4\u30a1\u30eb\u30b3\u30a2\u30c8\u30eb');</span>
<a href="#l9.657"></a><span id="l9.657" class="difflineplus">+        tree.get(&quot;1&quot;).headers.charset = &quot;Shift-JIS&quot;;</span>
<a href="#l9.658"></a><span id="l9.658" class="difflineplus">+        assert.equal(tree.get(&quot;1&quot;).headers.charset, &quot;Shift-JIS&quot;);</span>
<a href="#l9.659"></a><span id="l9.659" class="difflineplus">+        assert.equal(tree.get(&quot;1&quot;).headers.get(&quot;Content-Description&quot;),</span>
<a href="#l9.660"></a><span id="l9.660" class="difflineplus">+          &quot;\u30b1\u30c4\u30a1\u30eb\u30b3\u30a2\u30c8\u30eb&quot;);</span>
<a href="#l9.661"></a><span id="l9.661">       });</span>
<a href="#l9.662"></a><span id="l9.662">     });</span>
<a href="#l9.663"></a><span id="l9.663" class="difflineminus">-    test('Fallback charset decoding', function () {</span>
<a href="#l9.664"></a><span id="l9.664" class="difflineminus">-      return buildTree(read_file('shift-jis-image'), {</span>
<a href="#l9.665"></a><span id="l9.665" class="difflineplus">+    test(&quot;Fallback charset decoding&quot;, function() {</span>
<a href="#l9.666"></a><span id="l9.666" class="difflineplus">+      return buildTree(read_file(&quot;shift-jis-image&quot;), {</span>
<a href="#l9.667"></a><span id="l9.667">         strformat: &quot;unicode&quot;,</span>
<a href="#l9.668"></a><span id="l9.668">         charset: &quot;ISO-8859-1&quot;,</span>
<a href="#l9.669"></a><span id="l9.669" class="difflineminus">-        bodyformat: &quot;decode&quot;</span>
<a href="#l9.670"></a><span id="l9.670" class="difflineminus">-      }).then(function (tree) {</span>
<a href="#l9.671"></a><span id="l9.671" class="difflineplus">+        bodyformat: &quot;decode&quot;,</span>
<a href="#l9.672"></a><span id="l9.672" class="difflineplus">+      }).then(function(tree) {</span>
<a href="#l9.673"></a><span id="l9.673">         // text/plain should be transcoded...</span>
<a href="#l9.674"></a><span id="l9.674" class="difflineminus">-        assert.equal(tree.get('1').headers.get('Content-Type').get('charset'),</span>
<a href="#l9.675"></a><span id="l9.675" class="difflineminus">-          'Shift-JIS');</span>
<a href="#l9.676"></a><span id="l9.676" class="difflineminus">-        assert.equal(tree.get('1').headers.charset, 'Shift-JIS');</span>
<a href="#l9.677"></a><span id="l9.677" class="difflineminus">-        assert.equal(tree.get('1').headers.get('Content-Description'),</span>
<a href="#l9.678"></a><span id="l9.678" class="difflineminus">-          '\u30b1\u30c4\u30a1\u30eb\u30b3\u30a2\u30c8\u30eb');</span>
<a href="#l9.679"></a><span id="l9.679" class="difflineminus">-        assert.equal(tree.get('1').body, 'Portable Network Graphics\uff08' +</span>
<a href="#l9.680"></a><span id="l9.680" class="difflineminus">-          '\u30dd\u30fc\u30bf\u30d6\u30eb\u30fb\u30cd\u30c3\u30c8\u30ef\u30fc' +</span>
<a href="#l9.681"></a><span id="l9.681" class="difflineminus">-          '\u30af\u30fb\u30b0\u30e9\u30d5\u30a3\u30c3\u30af\u30b9\u3001PNG' +</span>
<a href="#l9.682"></a><span id="l9.682" class="difflineminus">-          '\uff09\u306f\u30b3\u30f3\u30d4\u30e5\u30fc\u30bf\u3067\u30d3\u30c3' +</span>
<a href="#l9.683"></a><span id="l9.683" class="difflineminus">-          '\u30c8\u30de\u30c3\u30d7\u753b\u50cf\u3092\u6271\u3046\u30d5\u30a1' +</span>
<a href="#l9.684"></a><span id="l9.684" class="difflineminus">-          '\u30a4\u30eb\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3067\u3042\u308b' +</span>
<a href="#l9.685"></a><span id="l9.685" class="difflineminus">-          '\u3002\u5727\u7e2e\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3068\u3057' +</span>
<a href="#l9.686"></a><span id="l9.686" class="difflineminus">-          '\u3066Deflate\u3092\u63a1\u7528\u3057\u3066\u3044\u308b\u3001' +</span>
<a href="#l9.687"></a><span id="l9.687" class="difflineminus">-          '\u5727\u7e2e\u306b\u3088\u308b\u753b\u8cea\u306e\u52a3\u5316\u306e' +</span>
<a href="#l9.688"></a><span id="l9.688" class="difflineminus">-          '\u306a\u3044\u53ef\u9006\u5727\u7e2e\u306e\u753b\u50cf\u30d5\u30a1' +</span>
<a href="#l9.689"></a><span id="l9.689" class="difflineminus">-          '\u30a4\u30eb\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3067\u3042\u308b' +</span>
<a href="#l9.690"></a><span id="l9.690" class="difflineminus">-          '\u3002\r\n');</span>
<a href="#l9.691"></a><span id="l9.691" class="difflineplus">+        assert.equal(tree.get(&quot;1&quot;).headers.get(&quot;Content-Type&quot;).get(&quot;charset&quot;),</span>
<a href="#l9.692"></a><span id="l9.692" class="difflineplus">+          &quot;Shift-JIS&quot;);</span>
<a href="#l9.693"></a><span id="l9.693" class="difflineplus">+        assert.equal(tree.get(&quot;1&quot;).headers.charset, &quot;Shift-JIS&quot;);</span>
<a href="#l9.694"></a><span id="l9.694" class="difflineplus">+        assert.equal(tree.get(&quot;1&quot;).headers.get(&quot;Content-Description&quot;),</span>
<a href="#l9.695"></a><span id="l9.695" class="difflineplus">+          &quot;\u30b1\u30c4\u30a1\u30eb\u30b3\u30a2\u30c8\u30eb&quot;);</span>
<a href="#l9.696"></a><span id="l9.696" class="difflineplus">+        assert.equal(tree.get(&quot;1&quot;).body, &quot;Portable Network Graphics\uff08&quot; +</span>
<a href="#l9.697"></a><span id="l9.697" class="difflineplus">+          &quot;\u30dd\u30fc\u30bf\u30d6\u30eb\u30fb\u30cd\u30c3\u30c8\u30ef\u30fc&quot; +</span>
<a href="#l9.698"></a><span id="l9.698" class="difflineplus">+          &quot;\u30af\u30fb\u30b0\u30e9\u30d5\u30a3\u30c3\u30af\u30b9\u3001PNG&quot; +</span>
<a href="#l9.699"></a><span id="l9.699" class="difflineplus">+          &quot;\uff09\u306f\u30b3\u30f3\u30d4\u30e5\u30fc\u30bf\u3067\u30d3\u30c3&quot; +</span>
<a href="#l9.700"></a><span id="l9.700" class="difflineplus">+          &quot;\u30c8\u30de\u30c3\u30d7\u753b\u50cf\u3092\u6271\u3046\u30d5\u30a1&quot; +</span>
<a href="#l9.701"></a><span id="l9.701" class="difflineplus">+          &quot;\u30a4\u30eb\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3067\u3042\u308b&quot; +</span>
<a href="#l9.702"></a><span id="l9.702" class="difflineplus">+          &quot;\u3002\u5727\u7e2e\u30a2\u30eb\u30b4\u30ea\u30ba\u30e0\u3068\u3057&quot; +</span>
<a href="#l9.703"></a><span id="l9.703" class="difflineplus">+          &quot;\u3066Deflate\u3092\u63a1\u7528\u3057\u3066\u3044\u308b\u3001&quot; +</span>
<a href="#l9.704"></a><span id="l9.704" class="difflineplus">+          &quot;\u5727\u7e2e\u306b\u3088\u308b\u753b\u8cea\u306e\u52a3\u5316\u306e&quot; +</span>
<a href="#l9.705"></a><span id="l9.705" class="difflineplus">+          &quot;\u306a\u3044\u53ef\u9006\u5727\u7e2e\u306e\u753b\u50cf\u30d5\u30a1&quot; +</span>
<a href="#l9.706"></a><span id="l9.706" class="difflineplus">+          &quot;\u30a4\u30eb\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3067\u3042\u308b&quot; +</span>
<a href="#l9.707"></a><span id="l9.707" class="difflineplus">+          &quot;\u3002\r\n&quot;);</span>
<a href="#l9.708"></a><span id="l9.708">         // ... but not image/png</span>
<a href="#l9.709"></a><span id="l9.709" class="difflineminus">-        assert.ok(!tree.get('2').headers.get('Content-Type').has('charset'));</span>
<a href="#l9.710"></a><span id="l9.710" class="difflineminus">-        assert.equal(tree.get('2').headers.charset, 'ISO-8859-1');</span>
<a href="#l9.711"></a><span id="l9.711" class="difflineminus">-        assert.equal(tree.get('2').headers.get('Content-Description'),</span>
<a href="#l9.712"></a><span id="l9.712" class="difflineminus">-          '\u0192P\u0192c\u0192@\u0192\u2039\u0192R\u0192A\u0192g\u0192\u2039');</span>
<a href="#l9.713"></a><span id="l9.713" class="difflineminus">-        assert.equal(tree.get('2').headers.getRawHeader('Content-Description'),</span>
<a href="#l9.714"></a><span id="l9.714" class="difflineminus">-          '\x83\x50\x83\x63\x83\x40\x83\x8b\x83\x52\x83\x41\x83\x67\x83\x8b');</span>
<a href="#l9.715"></a><span id="l9.715" class="difflineminus">-        var imageData = 'iVBORw0KGgoAAAANSUhEUgAAAIAAAABECAIAAADGJao+AAAAwklE' +</span>
<a href="#l9.716"></a><span id="l9.716" class="difflineminus">-          'QVR4Xu3UgQbDMBRA0bc03f//b7N0VuqJEmwoc+KqNEkDh9b+2HuJu1KNO4f+AQCAAA' +</span>
<a href="#l9.717"></a><span id="l9.717" class="difflineminus">-          'AQAAACAEAAAAgAAAEAIAAABACAAAAQAAACAEAAAAgAAAEAIAAAANReamRLlPWYfNH0' +</span>
<a href="#l9.718"></a><span id="l9.718" class="difflineminus">-          'klxcPs+cP3NxWF+vi3lb7pa2R+vx6tHOtuN1O+a5lY3HzgM5ya/GM5N7ZjfPq7/5yS' +</span>
<a href="#l9.719"></a><span id="l9.719" class="difflineminus">-          '8IgAAAEAAAAgBAAAAIAAABACAAAAQAgAAAEAAAAgBAAAAIAAABACAAAIw322gDIPvt' +</span>
<a href="#l9.720"></a><span id="l9.720" class="difflineminus">-          'lmUAAAAASUVORK5CYII=';</span>
<a href="#l9.721"></a><span id="l9.721" class="difflineplus">+        assert.ok(!tree.get(&quot;2&quot;).headers.get(&quot;Content-Type&quot;).has(&quot;charset&quot;));</span>
<a href="#l9.722"></a><span id="l9.722" class="difflineplus">+        assert.equal(tree.get(&quot;2&quot;).headers.charset, &quot;ISO-8859-1&quot;);</span>
<a href="#l9.723"></a><span id="l9.723" class="difflineplus">+        assert.equal(tree.get(&quot;2&quot;).headers.get(&quot;Content-Description&quot;),</span>
<a href="#l9.724"></a><span id="l9.724" class="difflineplus">+          &quot;\u0192P\u0192c\u0192@\u0192\u2039\u0192R\u0192A\u0192g\u0192\u2039&quot;);</span>
<a href="#l9.725"></a><span id="l9.725" class="difflineplus">+        assert.equal(tree.get(&quot;2&quot;).headers.getRawHeader(&quot;Content-Description&quot;),</span>
<a href="#l9.726"></a><span id="l9.726" class="difflineplus">+          &quot;\x83\x50\x83\x63\x83\x40\x83\x8b\x83\x52\x83\x41\x83\x67\x83\x8b&quot;);</span>
<a href="#l9.727"></a><span id="l9.727" class="difflineplus">+        var imageData = &quot;iVBORw0KGgoAAAANSUhEUgAAAIAAAABECAIAAADGJao+AAAAwklE&quot; +</span>
<a href="#l9.728"></a><span id="l9.728" class="difflineplus">+          &quot;QVR4Xu3UgQbDMBRA0bc03f//b7N0VuqJEmwoc+KqNEkDh9b+2HuJu1KNO4f+AQCAAA&quot; +</span>
<a href="#l9.729"></a><span id="l9.729" class="difflineplus">+          &quot;AQAAACAEAAAAgAAAEAIAAABACAAAAQAAACAEAAAAgAAAEAIAAAANReamRLlPWYfNH0&quot; +</span>
<a href="#l9.730"></a><span id="l9.730" class="difflineplus">+          &quot;klxcPs+cP3NxWF+vi3lb7pa2R+vx6tHOtuN1O+a5lY3HzgM5ya/GM5N7ZjfPq7/5yS&quot; +</span>
<a href="#l9.731"></a><span id="l9.731" class="difflineplus">+          &quot;8IgAAAEAAAAgBAAAAIAAABACAAAAQAgAAAEAAAAgBAAAAIAAABACAAAIw322gDIPvt&quot; +</span>
<a href="#l9.732"></a><span id="l9.732" class="difflineplus">+          &quot;lmUAAAAASUVORK5CYII=&quot;;</span>
<a href="#l9.733"></a><span id="l9.733">         imageData = atob(imageData);</span>
<a href="#l9.734"></a><span id="l9.734">         var asArray = new Uint8Array(imageData.length);</span>
<a href="#l9.735"></a><span id="l9.735">         for (var i = 0; i &lt; asArray.length; i++)</span>
<a href="#l9.736"></a><span id="l9.736">           asArray[i] = imageData.charCodeAt(i);</span>
<a href="#l9.737"></a><span id="l9.737" class="difflineminus">-        assert.deepEqual(tree.get('2').body, asArray);</span>
<a href="#l9.738"></a><span id="l9.738" class="difflineplus">+        assert.deepEqual(tree.get(&quot;2&quot;).body, asArray);</span>
<a href="#l9.739"></a><span id="l9.739"> </span>
<a href="#l9.740"></a><span id="l9.740">         // Touching the header charset should change the interpretation.</span>
<a href="#l9.741"></a><span id="l9.741" class="difflineminus">-        tree.get('1').headers.charset = 'Shift-JIS';</span>
<a href="#l9.742"></a><span id="l9.742" class="difflineminus">-        assert.equal(tree.get('1').headers.charset, 'Shift-JIS');</span>
<a href="#l9.743"></a><span id="l9.743" class="difflineminus">-        assert.equal(tree.get('1').headers.get('Content-Description'),</span>
<a href="#l9.744"></a><span id="l9.744" class="difflineminus">-          '\u30b1\u30c4\u30a1\u30eb\u30b3\u30a2\u30c8\u30eb');</span>
<a href="#l9.745"></a><span id="l9.745" class="difflineplus">+        tree.get(&quot;1&quot;).headers.charset = &quot;Shift-JIS&quot;;</span>
<a href="#l9.746"></a><span id="l9.746" class="difflineplus">+        assert.equal(tree.get(&quot;1&quot;).headers.charset, &quot;Shift-JIS&quot;);</span>
<a href="#l9.747"></a><span id="l9.747" class="difflineplus">+        assert.equal(tree.get(&quot;1&quot;).headers.get(&quot;Content-Description&quot;),</span>
<a href="#l9.748"></a><span id="l9.748" class="difflineplus">+          &quot;\u30b1\u30c4\u30a1\u30eb\u30b3\u30a2\u30c8\u30eb&quot;);</span>
<a href="#l9.749"></a><span id="l9.749">       });</span>
<a href="#l9.750"></a><span id="l9.750">     });</span>
<a href="#l9.751"></a><span id="l9.751" class="difflineminus">-    test('Forced charset decoding', function () {</span>
<a href="#l9.752"></a><span id="l9.752" class="difflineminus">-      return buildTree(read_file('shift-jis-image'), {</span>
<a href="#l9.753"></a><span id="l9.753" class="difflineplus">+    test(&quot;Forced charset decoding&quot;, function() {</span>
<a href="#l9.754"></a><span id="l9.754" class="difflineplus">+      return buildTree(read_file(&quot;shift-jis-image&quot;), {</span>
<a href="#l9.755"></a><span id="l9.755">         strformat: &quot;unicode&quot;,</span>
<a href="#l9.756"></a><span id="l9.756">         charset: &quot;ISO-8859-1&quot;,</span>
<a href="#l9.757"></a><span id="l9.757">         &quot;force-charset&quot;: true,</span>
<a href="#l9.758"></a><span id="l9.758" class="difflineminus">-        bodyformat: &quot;decode&quot;</span>
<a href="#l9.759"></a><span id="l9.759" class="difflineminus">-      }).then(function (tree) {</span>
<a href="#l9.760"></a><span id="l9.760" class="difflineplus">+        bodyformat: &quot;decode&quot;,</span>
<a href="#l9.761"></a><span id="l9.761" class="difflineplus">+      }).then(function(tree) {</span>
<a href="#l9.762"></a><span id="l9.762">         // text/plain should be transcoded...</span>
<a href="#l9.763"></a><span id="l9.763" class="difflineminus">-        assert.equal(tree.get('1').headers.get('Content-Type').get('charset'),</span>
<a href="#l9.764"></a><span id="l9.764" class="difflineminus">-          'Shift-JIS');</span>
<a href="#l9.765"></a><span id="l9.765" class="difflineminus">-        assert.equal(tree.get('1').headers.charset, 'ISO-8859-1');</span>
<a href="#l9.766"></a><span id="l9.766" class="difflineminus">-        assert.equal(tree.get('1').headers.get('Content-Description'),</span>
<a href="#l9.767"></a><span id="l9.767" class="difflineminus">-          '\u0192P\u0192c\u0192@\u0192\u2039\u0192R\u0192A\u0192g\u0192\u2039');</span>
<a href="#l9.768"></a><span id="l9.768" class="difflineminus">-        assert.equal(tree.get('1').body, 'Portable Network Graphics\u0081i' +</span>
<a href="#l9.769"></a><span id="l9.769" class="difflineminus">-          '\u0192|\u0081[\u0192^\u0192u\u0192\u2039\u0081E\u0192l\u0192b' +</span>
<a href="#l9.770"></a><span id="l9.770" class="difflineminus">-          '\u0192g\u0192\u008f\u0081[\u0192N\u0081E\u0192O\u0192\u2030\u0192t' +</span>
<a href="#l9.771"></a><span id="l9.771" class="difflineminus">-          '\u0192B\u0192b\u0192N\u0192X\u0081APNG\u0081j\u201a\u00cd\u0192R' +</span>
<a href="#l9.772"></a><span id="l9.772" class="difflineminus">-          '\u0192\u201c\u0192s\u0192\u2026\u0081[\u0192^\u201a\u00c5\u0192r' +</span>
<a href="#l9.773"></a><span id="l9.773" class="difflineminus">-          '\u0192b\u0192g\u0192}\u0192b\u0192v\u2030\u00e6\u2018\u0153\u201a' +</span>
<a href="#l9.774"></a><span id="l9.774" class="difflineminus">-          '\u00f0\u02c6\u00b5\u201a\u00a4\u0192t\u0192@\u0192C\u0192\u2039' +</span>
<a href="#l9.775"></a><span id="l9.775" class="difflineminus">-          '\u0192t\u0192H\u0081[\u0192}\u0192b\u0192g\u201a\u00c5\u201a\u00a0' +</span>
<a href="#l9.776"></a><span id="l9.776" class="difflineminus">-          '\u201a\u00e9\u0081B\u02c6\u00b3\u008fk\u0192A\u0192\u2039\u0192S' +</span>
<a href="#l9.777"></a><span id="l9.777" class="difflineminus">-          '\u0192\u0160\u0192Y\u0192\u20ac\u201a\u00c6\u201a\u00b5\u201a' +</span>
<a href="#l9.778"></a><span id="l9.778" class="difflineminus">-          '\u00c4Deflate\u201a\u00f0\u008d\u00cc\u2014p\u201a\u00b5\u201a' +</span>
<a href="#l9.779"></a><span id="l9.779" class="difflineminus">-          '\u00c4\u201a\u00a2\u201a\u00e9\u0081A\u02c6\u00b3\u008fk\u201a' +</span>
<a href="#l9.780"></a><span id="l9.780" class="difflineminus">-          '\u00c9\u201a\u00e6\u201a\u00e9\u2030\u00e6\u017d\u00bf\u201a\u00cc' +</span>
<a href="#l9.781"></a><span id="l9.781" class="difflineminus">-          '\u2014\u00f2\u2030\u00bb\u201a\u00cc\u201a\u00c8\u201a\u00a2\u2030' +</span>
<a href="#l9.782"></a><span id="l9.782" class="difflineminus">-          '\u00c2\u2039t\u02c6\u00b3\u008fk\u201a\u00cc\u2030\u00e6\u2018' +</span>
<a href="#l9.783"></a><span id="l9.783" class="difflineminus">-          '\u0153\u0192t\u0192@\u0192C\u0192\u2039\u0192t\u0192H\u0081[\u0192' +</span>
<a href="#l9.784"></a><span id="l9.784" class="difflineminus">-          '}\u0192b\u0192g\u201a\u00c5\u201a\u00a0\u201a\u00e9\u0081B\r\n');</span>
<a href="#l9.785"></a><span id="l9.785" class="difflineplus">+        assert.equal(tree.get(&quot;1&quot;).headers.get(&quot;Content-Type&quot;).get(&quot;charset&quot;),</span>
<a href="#l9.786"></a><span id="l9.786" class="difflineplus">+          &quot;Shift-JIS&quot;);</span>
<a href="#l9.787"></a><span id="l9.787" class="difflineplus">+        assert.equal(tree.get(&quot;1&quot;).headers.charset, &quot;ISO-8859-1&quot;);</span>
<a href="#l9.788"></a><span id="l9.788" class="difflineplus">+        assert.equal(tree.get(&quot;1&quot;).headers.get(&quot;Content-Description&quot;),</span>
<a href="#l9.789"></a><span id="l9.789" class="difflineplus">+          &quot;\u0192P\u0192c\u0192@\u0192\u2039\u0192R\u0192A\u0192g\u0192\u2039&quot;);</span>
<a href="#l9.790"></a><span id="l9.790" class="difflineplus">+        assert.equal(tree.get(&quot;1&quot;).body, &quot;Portable Network Graphics\u0081i&quot; +</span>
<a href="#l9.791"></a><span id="l9.791" class="difflineplus">+          &quot;\u0192|\u0081[\u0192^\u0192u\u0192\u2039\u0081E\u0192l\u0192b&quot; +</span>
<a href="#l9.792"></a><span id="l9.792" class="difflineplus">+          &quot;\u0192g\u0192\u008f\u0081[\u0192N\u0081E\u0192O\u0192\u2030\u0192t&quot; +</span>
<a href="#l9.793"></a><span id="l9.793" class="difflineplus">+          &quot;\u0192B\u0192b\u0192N\u0192X\u0081APNG\u0081j\u201a\u00cd\u0192R&quot; +</span>
<a href="#l9.794"></a><span id="l9.794" class="difflineplus">+          &quot;\u0192\u201c\u0192s\u0192\u2026\u0081[\u0192^\u201a\u00c5\u0192r&quot; +</span>
<a href="#l9.795"></a><span id="l9.795" class="difflineplus">+          &quot;\u0192b\u0192g\u0192}\u0192b\u0192v\u2030\u00e6\u2018\u0153\u201a&quot; +</span>
<a href="#l9.796"></a><span id="l9.796" class="difflineplus">+          &quot;\u00f0\u02c6\u00b5\u201a\u00a4\u0192t\u0192@\u0192C\u0192\u2039&quot; +</span>
<a href="#l9.797"></a><span id="l9.797" class="difflineplus">+          &quot;\u0192t\u0192H\u0081[\u0192}\u0192b\u0192g\u201a\u00c5\u201a\u00a0&quot; +</span>
<a href="#l9.798"></a><span id="l9.798" class="difflineplus">+          &quot;\u201a\u00e9\u0081B\u02c6\u00b3\u008fk\u0192A\u0192\u2039\u0192S&quot; +</span>
<a href="#l9.799"></a><span id="l9.799" class="difflineplus">+          &quot;\u0192\u0160\u0192Y\u0192\u20ac\u201a\u00c6\u201a\u00b5\u201a&quot; +</span>
<a href="#l9.800"></a><span id="l9.800" class="difflineplus">+          &quot;\u00c4Deflate\u201a\u00f0\u008d\u00cc\u2014p\u201a\u00b5\u201a&quot; +</span>
<a href="#l9.801"></a><span id="l9.801" class="difflineplus">+          &quot;\u00c4\u201a\u00a2\u201a\u00e9\u0081A\u02c6\u00b3\u008fk\u201a&quot; +</span>
<a href="#l9.802"></a><span id="l9.802" class="difflineplus">+          &quot;\u00c9\u201a\u00e6\u201a\u00e9\u2030\u00e6\u017d\u00bf\u201a\u00cc&quot; +</span>
<a href="#l9.803"></a><span id="l9.803" class="difflineplus">+          &quot;\u2014\u00f2\u2030\u00bb\u201a\u00cc\u201a\u00c8\u201a\u00a2\u2030&quot; +</span>
<a href="#l9.804"></a><span id="l9.804" class="difflineplus">+          &quot;\u00c2\u2039t\u02c6\u00b3\u008fk\u201a\u00cc\u2030\u00e6\u2018&quot; +</span>
<a href="#l9.805"></a><span id="l9.805" class="difflineplus">+          &quot;\u0153\u0192t\u0192@\u0192C\u0192\u2039\u0192t\u0192H\u0081[\u0192&quot; +</span>
<a href="#l9.806"></a><span id="l9.806" class="difflineplus">+          &quot;}\u0192b\u0192g\u201a\u00c5\u201a\u00a0\u201a\u00e9\u0081B\r\n&quot;);</span>
<a href="#l9.807"></a><span id="l9.807">         // ... but not image/png</span>
<a href="#l9.808"></a><span id="l9.808" class="difflineminus">-        assert.ok(!tree.get('2').headers.get('Content-Type').has('charset'));</span>
<a href="#l9.809"></a><span id="l9.809" class="difflineminus">-        assert.equal(tree.get('2').headers.charset, 'ISO-8859-1');</span>
<a href="#l9.810"></a><span id="l9.810" class="difflineminus">-        assert.equal(tree.get('2').headers.get('Content-Description'),</span>
<a href="#l9.811"></a><span id="l9.811" class="difflineminus">-          '\u0192P\u0192c\u0192@\u0192\u2039\u0192R\u0192A\u0192g\u0192\u2039');</span>
<a href="#l9.812"></a><span id="l9.812" class="difflineminus">-        assert.equal(tree.get('2').headers.getRawHeader('Content-Description'),</span>
<a href="#l9.813"></a><span id="l9.813" class="difflineminus">-          '\x83\x50\x83\x63\x83\x40\x83\x8b\x83\x52\x83\x41\x83\x67\x83\x8b');</span>
<a href="#l9.814"></a><span id="l9.814" class="difflineminus">-        var imageData = 'iVBORw0KGgoAAAANSUhEUgAAAIAAAABECAIAAADGJao+AAAAwklE' +</span>
<a href="#l9.815"></a><span id="l9.815" class="difflineminus">-          'QVR4Xu3UgQbDMBRA0bc03f//b7N0VuqJEmwoc+KqNEkDh9b+2HuJu1KNO4f+AQCAAA' +</span>
<a href="#l9.816"></a><span id="l9.816" class="difflineminus">-          'AQAAACAEAAAAgAAAEAIAAABACAAAAQAAACAEAAAAgAAAEAIAAAANReamRLlPWYfNH0' +</span>
<a href="#l9.817"></a><span id="l9.817" class="difflineminus">-          'klxcPs+cP3NxWF+vi3lb7pa2R+vx6tHOtuN1O+a5lY3HzgM5ya/GM5N7ZjfPq7/5yS' +</span>
<a href="#l9.818"></a><span id="l9.818" class="difflineminus">-          '8IgAAAEAAAAgBAAAAIAAABACAAAAQAgAAAEAAAAgBAAAAIAAABACAAAIw322gDIPvt' +</span>
<a href="#l9.819"></a><span id="l9.819" class="difflineminus">-          'lmUAAAAASUVORK5CYII=';</span>
<a href="#l9.820"></a><span id="l9.820" class="difflineplus">+        assert.ok(!tree.get(&quot;2&quot;).headers.get(&quot;Content-Type&quot;).has(&quot;charset&quot;));</span>
<a href="#l9.821"></a><span id="l9.821" class="difflineplus">+        assert.equal(tree.get(&quot;2&quot;).headers.charset, &quot;ISO-8859-1&quot;);</span>
<a href="#l9.822"></a><span id="l9.822" class="difflineplus">+        assert.equal(tree.get(&quot;2&quot;).headers.get(&quot;Content-Description&quot;),</span>
<a href="#l9.823"></a><span id="l9.823" class="difflineplus">+          &quot;\u0192P\u0192c\u0192@\u0192\u2039\u0192R\u0192A\u0192g\u0192\u2039&quot;);</span>
<a href="#l9.824"></a><span id="l9.824" class="difflineplus">+        assert.equal(tree.get(&quot;2&quot;).headers.getRawHeader(&quot;Content-Description&quot;),</span>
<a href="#l9.825"></a><span id="l9.825" class="difflineplus">+          &quot;\x83\x50\x83\x63\x83\x40\x83\x8b\x83\x52\x83\x41\x83\x67\x83\x8b&quot;);</span>
<a href="#l9.826"></a><span id="l9.826" class="difflineplus">+        var imageData = &quot;iVBORw0KGgoAAAANSUhEUgAAAIAAAABECAIAAADGJao+AAAAwklE&quot; +</span>
<a href="#l9.827"></a><span id="l9.827" class="difflineplus">+          &quot;QVR4Xu3UgQbDMBRA0bc03f//b7N0VuqJEmwoc+KqNEkDh9b+2HuJu1KNO4f+AQCAAA&quot; +</span>
<a href="#l9.828"></a><span id="l9.828" class="difflineplus">+          &quot;AQAAACAEAAAAgAAAEAIAAABACAAAAQAAACAEAAAAgAAAEAIAAAANReamRLlPWYfNH0&quot; +</span>
<a href="#l9.829"></a><span id="l9.829" class="difflineplus">+          &quot;klxcPs+cP3NxWF+vi3lb7pa2R+vx6tHOtuN1O+a5lY3HzgM5ya/GM5N7ZjfPq7/5yS&quot; +</span>
<a href="#l9.830"></a><span id="l9.830" class="difflineplus">+          &quot;8IgAAAEAAAAgBAAAAIAAABACAAAAQAgAAAEAAAAgBAAAAIAAABACAAAIw322gDIPvt&quot; +</span>
<a href="#l9.831"></a><span id="l9.831" class="difflineplus">+          &quot;lmUAAAAASUVORK5CYII=&quot;;</span>
<a href="#l9.832"></a><span id="l9.832">         imageData = atob(imageData);</span>
<a href="#l9.833"></a><span id="l9.833">         var asArray = new Uint8Array(imageData.length);</span>
<a href="#l9.834"></a><span id="l9.834">         for (var i = 0; i &lt; asArray.length; i++)</span>
<a href="#l9.835"></a><span id="l9.835">           asArray[i] = imageData.charCodeAt(i);</span>
<a href="#l9.836"></a><span id="l9.836" class="difflineminus">-        assert.deepEqual(tree.get('2').body, asArray);</span>
<a href="#l9.837"></a><span id="l9.837" class="difflineplus">+        assert.deepEqual(tree.get(&quot;2&quot;).body, asArray);</span>
<a href="#l9.838"></a><span id="l9.838"> </span>
<a href="#l9.839"></a><span id="l9.839">         // Touching the header charset should change the interpretation.</span>
<a href="#l9.840"></a><span id="l9.840" class="difflineminus">-        tree.get('1').headers.charset = 'Shift-JIS';</span>
<a href="#l9.841"></a><span id="l9.841" class="difflineminus">-        assert.equal(tree.get('1').headers.charset, 'Shift-JIS');</span>
<a href="#l9.842"></a><span id="l9.842" class="difflineminus">-        assert.equal(tree.get('1').headers.get('Content-Description'),</span>
<a href="#l9.843"></a><span id="l9.843" class="difflineminus">-          '\u30b1\u30c4\u30a1\u30eb\u30b3\u30a2\u30c8\u30eb');</span>
<a href="#l9.844"></a><span id="l9.844" class="difflineplus">+        tree.get(&quot;1&quot;).headers.charset = &quot;Shift-JIS&quot;;</span>
<a href="#l9.845"></a><span id="l9.845" class="difflineplus">+        assert.equal(tree.get(&quot;1&quot;).headers.charset, &quot;Shift-JIS&quot;);</span>
<a href="#l9.846"></a><span id="l9.846" class="difflineplus">+        assert.equal(tree.get(&quot;1&quot;).headers.get(&quot;Content-Description&quot;),</span>
<a href="#l9.847"></a><span id="l9.847" class="difflineplus">+          &quot;\u30b1\u30c4\u30a1\u30eb\u30b3\u30a2\u30c8\u30eb&quot;);</span>
<a href="#l9.848"></a><span id="l9.848">       });</span>
<a href="#l9.849"></a><span id="l9.849">     });</span>
<a href="#l9.850"></a><span id="l9.850" class="difflineminus">-    test('Charset conversion', function () {</span>
<a href="#l9.851"></a><span id="l9.851" class="difflineminus">-      return buildTree(read_file('charsets'), {</span>
<a href="#l9.852"></a><span id="l9.852" class="difflineplus">+    test(&quot;Charset conversion&quot;, function() {</span>
<a href="#l9.853"></a><span id="l9.853" class="difflineplus">+      return buildTree(read_file(&quot;charsets&quot;), {</span>
<a href="#l9.854"></a><span id="l9.854">         strformat: &quot;unicode&quot;,</span>
<a href="#l9.855"></a><span id="l9.855" class="difflineminus">-        bodyformat: &quot;decode&quot;</span>
<a href="#l9.856"></a><span id="l9.856" class="difflineminus">-      }).then(function (tree) {</span>
<a href="#l9.857"></a><span id="l9.857" class="difflineplus">+        bodyformat: &quot;decode&quot;,</span>
<a href="#l9.858"></a><span id="l9.858" class="difflineplus">+      }).then(function(tree) {</span>
<a href="#l9.859"></a><span id="l9.859">         var numParts = 12;</span>
<a href="#l9.860"></a><span id="l9.860" class="difflineminus">-        for (var i = 1; i &lt; numParts; i+= 2) {</span>
<a href="#l9.861"></a><span id="l9.861" class="difflineplus">+        for (let i = 1; i &lt; numParts; i += 2) {</span>
<a href="#l9.862"></a><span id="l9.862">           assert.equal(tree.get(&quot;&quot; + i).body, tree.get(&quot;&quot; + (i + 1)).body);</span>
<a href="#l9.863"></a><span id="l9.863">         }</span>
<a href="#l9.864"></a><span id="l9.864">         assert.ok(!tree.has(&quot;&quot; + (numParts + 1)));</span>
<a href="#l9.865"></a><span id="l9.865">       });</span>
<a href="#l9.866"></a><span id="l9.866">     });</span>
<a href="#l9.867"></a><span id="l9.867">   });</span>
<a href="#l9.868"></a><span id="l9.868"> });</span>
<a href="#l9.869"></a><span id="l9.869" class="difflineminus">-</span>
<a href="#l9.870"></a><span id="l9.870"> });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/mime/jsmime/test/test_structured_header_emitters.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/mime/jsmime/test/test_structured_header_emitters.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1,94 +1,92 @@</span>
<a href="#l10.4"></a><span id="l10.4"> &quot;use strict&quot;;</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineminus">-define(function (require) {</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineminus">-</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineminus">-var assert = require('assert');</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineminus">-var headeremitter = require('jsmime').headeremitter;</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineminus">-var MockDate = require('test/mock_date');</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineplus">+define(function(require) {</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+var assert = require(&quot;assert&quot;);</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+var headeremitter = require(&quot;jsmime&quot;).headeremitter;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+var MockDate = require(&quot;test/mock_date&quot;);</span>
<a href="#l10.14"></a><span id="l10.14"> </span>
<a href="#l10.15"></a><span id="l10.15"> function arrayTest(data, fn) {</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-  fn.toString = function () {</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+  fn.toString = function() {</span>
<a href="#l10.18"></a><span id="l10.18">     let text = Function.prototype.toString.call(this);</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-    text = text.replace(/data\[([0-9]*)\]/g, function (m, p) {</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+    text = text.replace(/data\[([0-9]*)\]/g, function(m, p) {</span>
<a href="#l10.21"></a><span id="l10.21">       return JSON.stringify(data[p]);</span>
<a href="#l10.22"></a><span id="l10.22">     });</span>
<a href="#l10.23"></a><span id="l10.23">     return text;</span>
<a href="#l10.24"></a><span id="l10.24">   };</span>
<a href="#l10.25"></a><span id="l10.25">   return test(JSON.stringify(data[0]), fn);</span>
<a href="#l10.26"></a><span id="l10.26"> }</span>
<a href="#l10.27"></a><span id="l10.27"> </span>
<a href="#l10.28"></a><span id="l10.28"> function testHeader(header, tests) {</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-  suite(header, function () {</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-    tests.forEach(function (data) {</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-      arrayTest(data, function () {</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+  suite(header, function() {</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+    tests.forEach(function(data) {</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+      arrayTest(data, function() {</span>
<a href="#l10.35"></a><span id="l10.35">         assert.deepEqual(headeremitter.emitStructuredHeader(header,</span>
<a href="#l10.36"></a><span id="l10.36">           data[0], {softMargin: 100, useASCII: true}),</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-          (header + &quot;: &quot; + data[1]).trim() + '\r\n');</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+          (header + &quot;: &quot; + data[1]).trim() + &quot;\r\n&quot;);</span>
<a href="#l10.39"></a><span id="l10.39">       });</span>
<a href="#l10.40"></a><span id="l10.40">     });</span>
<a href="#l10.41"></a><span id="l10.41">   });</span>
<a href="#l10.42"></a><span id="l10.42"> }</span>
<a href="#l10.43"></a><span id="l10.43"> </span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">-suite('Structured header emitters', function () {</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+suite(&quot;Structured header emitters&quot;, function() {</span>
<a href="#l10.46"></a><span id="l10.46">   // Ad-hoc header tests</span>
<a href="#l10.47"></a><span id="l10.47">   // TODO: add structured encoder tests for Content-Type when it is added.</span>
<a href="#l10.48"></a><span id="l10.48"> </span>
<a href="#l10.49"></a><span id="l10.49">   testHeader(&quot;Content-Transfer-Encoding&quot;, [</span>
<a href="#l10.50"></a><span id="l10.50">     [&quot;&quot;, &quot;&quot;],</span>
<a href="#l10.51"></a><span id="l10.51">     [&quot;8bit&quot;, &quot;8bit&quot;],</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-    [&quot;invalid&quot;, &quot;invalid&quot;]</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+    [&quot;invalid&quot;, &quot;invalid&quot;],</span>
<a href="#l10.54"></a><span id="l10.54">   ]);</span>
<a href="#l10.55"></a><span id="l10.55"> </span>
<a href="#l10.56"></a><span id="l10.56">   // Non-ad-hoc header tests</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineminus">-  let addressing_headers = ['From', 'To', 'Cc', 'Bcc', 'Sender', 'Reply-To',</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineminus">-    'Resent-Bcc', 'Resent-To', 'Resent-From', 'Resent-Cc', 'Resent-Sender',</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineminus">-    'Approved', 'Disposition-Notification-To', 'Delivered-To',</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineminus">-    'Return-Receipt-To', 'Resent-Reply-To', 'Mail-Reply-To', 'Mail-Followup-To'</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+  let addressing_headers = [&quot;From&quot;, &quot;To&quot;, &quot;Cc&quot;, &quot;Bcc&quot;, &quot;Sender&quot;, &quot;Reply-To&quot;,</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+    &quot;Resent-Bcc&quot;, &quot;Resent-To&quot;, &quot;Resent-From&quot;, &quot;Resent-Cc&quot;, &quot;Resent-Sender&quot;,</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineplus">+    &quot;Approved&quot;, &quot;Disposition-Notification-To&quot;, &quot;Delivered-To&quot;,</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+    &quot;Return-Receipt-To&quot;, &quot;Resent-Reply-To&quot;, &quot;Mail-Reply-To&quot;, &quot;Mail-Followup-To&quot;,</span>
<a href="#l10.65"></a><span id="l10.65">   ];</span>
<a href="#l10.66"></a><span id="l10.66">   let address_tests = [</span>
<a href="#l10.67"></a><span id="l10.67">     [{name: &quot;&quot;, email: &quot;&quot;}, &quot;&quot;],</span>
<a href="#l10.68"></a><span id="l10.68">     [{name: &quot;John Doe&quot;, email: &quot;john.doe@test.invalid&quot;},</span>
<a href="#l10.69"></a><span id="l10.69">       &quot;John Doe &lt;john.doe@test.invalid&gt;&quot;],</span>
<a href="#l10.70"></a><span id="l10.70">     [[{name: &quot;John Doe&quot;, email: &quot;john.doe@test.invalid&quot;}],</span>
<a href="#l10.71"></a><span id="l10.71">       &quot;John Doe &lt;john.doe@test.invalid&gt;&quot;],</span>
<a href="#l10.72"></a><span id="l10.72">     [{name: &quot;undisclosed-recipients&quot;, group: []},</span>
<a href="#l10.73"></a><span id="l10.73">       &quot;undisclosed-recipients: ;&quot;],</span>
<a href="#l10.74"></a><span id="l10.74">   ];</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineminus">-  addressing_headers.forEach(function (header) {</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineplus">+  addressing_headers.forEach(function(header) {</span>
<a href="#l10.77"></a><span id="l10.77">     testHeader(header, address_tests);</span>
<a href="#l10.78"></a><span id="l10.78">   });</span>
<a href="#l10.79"></a><span id="l10.79"> </span>
<a href="#l10.80"></a><span id="l10.80" class="difflineminus">-  let date_headers = ['Date', 'Expires', 'Injection-Date', 'NNTP-Posting-Date',</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineminus">-    'Resent-Date'];</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineplus">+  let date_headers = [&quot;Date&quot;, &quot;Expires&quot;, &quot;Injection-Date&quot;, &quot;NNTP-Posting-Date&quot;,</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineplus">+    &quot;Resent-Date&quot;];</span>
<a href="#l10.84"></a><span id="l10.84">   let date_tests = [</span>
<a href="#l10.85"></a><span id="l10.85">     [new MockDate(&quot;2012-09-06T08:08:21-0700&quot;), &quot;Thu, 6 Sep 2012 08:08:21 -0700&quot;],</span>
<a href="#l10.86"></a><span id="l10.86">   ];</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineminus">-  date_headers.forEach(function (header) {</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineplus">+  date_headers.forEach(function(header) {</span>
<a href="#l10.89"></a><span id="l10.89">     testHeader(header, date_tests);</span>
<a href="#l10.90"></a><span id="l10.90">   });</span>
<a href="#l10.91"></a><span id="l10.91"> </span>
<a href="#l10.92"></a><span id="l10.92" class="difflineminus">-  let unstructured_headers = ['Comments', 'Content-Description', 'Keywords',</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineminus">-    'Subject'];</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineplus">+  let unstructured_headers = [&quot;Comments&quot;, &quot;Content-Description&quot;, &quot;Keywords&quot;,</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineplus">+    &quot;Subject&quot;];</span>
<a href="#l10.96"></a><span id="l10.96">   let unstructured_tests = [</span>
<a href="#l10.97"></a><span id="l10.97">     [&quot;&quot;, &quot;&quot;],</span>
<a href="#l10.98"></a><span id="l10.98">     [&quot;This is a subject&quot;, &quot;This is a subject&quot;],</span>
<a href="#l10.99"></a><span id="l10.99">     [&quot;\u79c1\u306f\u4ef6\u540d\u5348\u524d&quot;,</span>
<a href="#l10.100"></a><span id="l10.100">       &quot;=?UTF-8?B?56eB44Gv5Lu25ZCN5Y2I5YmN?=&quot;],</span>
<a href="#l10.101"></a><span id="l10.101">   ];</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineminus">-  unstructured_headers.forEach(function (header) {</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineplus">+  unstructured_headers.forEach(function(header) {</span>
<a href="#l10.104"></a><span id="l10.104">     testHeader(header, unstructured_tests);</span>
<a href="#l10.105"></a><span id="l10.105">   });</span>
<a href="#l10.106"></a><span id="l10.106"> </span>
<a href="#l10.107"></a><span id="l10.107" class="difflineminus">-  test('emitStructuredHeaders', function () {</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineplus">+  test(&quot;emitStructuredHeaders&quot;, function() {</span>
<a href="#l10.109"></a><span id="l10.109">     let headers = new Map();</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineminus">-    headers.set('From', [{name:'', email: 'bugzilla-daemon@mozilla.org'}]);</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineminus">-    headers.set('subject', ['[Bug 939557] browsercomps.dll failed to build']);</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineminus">-    headers.set('x-capitalization-test', ['should capitalize']);</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineplus">+    headers.set(&quot;From&quot;, [{name: &quot;&quot;, email: &quot;bugzilla-daemon@mozilla.org&quot;}]);</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineplus">+    headers.set(&quot;subject&quot;, [&quot;[Bug 939557] browsercomps.dll failed to build&quot;]);</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineplus">+    headers.set(&quot;x-capitalization-test&quot;, [&quot;should capitalize&quot;]);</span>
<a href="#l10.116"></a><span id="l10.116">     let str = headeremitter.emitStructuredHeaders(headers, {});</span>
<a href="#l10.117"></a><span id="l10.117">     assert.equal(str,</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineminus">-      'From: bugzilla-daemon@mozilla.org\r\n' +</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineminus">-      'Subject: [Bug 939557] browsercomps.dll failed to build\r\n'+</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineminus">-      'X-Capitalization-Test: should capitalize\r\n');</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineplus">+      &quot;From: bugzilla-daemon@mozilla.org\r\n&quot; +</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineplus">+      &quot;Subject: [Bug 939557] browsercomps.dll failed to build\r\n&quot; +</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineplus">+      &quot;X-Capitalization-Test: should capitalize\r\n&quot;);</span>
<a href="#l10.124"></a><span id="l10.124">   });</span>
<a href="#l10.125"></a><span id="l10.125"> });</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineminus">-</span>
<a href="#l10.127"></a><span id="l10.127"> });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/mime/jsmime/test/test_structured_headers.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/mime/jsmime/test/test_structured_headers.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1,169 +1,167 @@</span>
<a href="#l11.4"></a><span id="l11.4"> &quot;use strict&quot;;</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineminus">-define(function (require) {</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineminus">-</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineminus">-var assert = require('assert');</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineminus">-var headerparser = require('jsmime').headerparser;</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineplus">+define(function(require) {</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+var assert = require(&quot;assert&quot;);</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineplus">+var headerparser = require(&quot;jsmime&quot;).headerparser;</span>
<a href="#l11.12"></a><span id="l11.12"> </span>
<a href="#l11.13"></a><span id="l11.13"> function smartDeepEqual(actual, expected) {</span>
<a href="#l11.14"></a><span id="l11.14">   assert.deepEqual(actual, expected);</span>
<a href="#l11.15"></a><span id="l11.15">   if (actual instanceof Map &amp;&amp; expected instanceof Map) {</span>
<a href="#l11.16"></a><span id="l11.16">     assert.deepEqual(Array.from(actual.entries()),</span>
<a href="#l11.17"></a><span id="l11.17">       Array.from(expected.entries()));</span>
<a href="#l11.18"></a><span id="l11.18">   }</span>
<a href="#l11.19"></a><span id="l11.19"> }</span>
<a href="#l11.20"></a><span id="l11.20"> </span>
<a href="#l11.21"></a><span id="l11.21"> function arrayTest(data, fn) {</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-  fn.toString = function () {</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+  fn.toString = function() {</span>
<a href="#l11.24"></a><span id="l11.24">     let text = Function.prototype.toString.call(this);</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-    text = text.replace(/data\[([0-9]*)\]/g, function (m, p) {</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+    text = text.replace(/data\[([0-9]*)\]/g, function(m, p) {</span>
<a href="#l11.27"></a><span id="l11.27">       return JSON.stringify(data[p]);</span>
<a href="#l11.28"></a><span id="l11.28">     });</span>
<a href="#l11.29"></a><span id="l11.29">     return text;</span>
<a href="#l11.30"></a><span id="l11.30">   };</span>
<a href="#l11.31"></a><span id="l11.31">   return test(data[0], fn);</span>
<a href="#l11.32"></a><span id="l11.32"> }</span>
<a href="#l11.33"></a><span id="l11.33"> </span>
<a href="#l11.34"></a><span id="l11.34"> function testHeader(header, tests) {</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">-  suite(header, function () {</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-    tests.forEach(function (data) {</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-      arrayTest(data, function () {</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+  suite(header, function() {</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+    tests.forEach(function(data) {</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+      arrayTest(data, function() {</span>
<a href="#l11.41"></a><span id="l11.41">         smartDeepEqual(headerparser.parseStructuredHeader(header,</span>
<a href="#l11.42"></a><span id="l11.42">           data[0]), data[1]);</span>
<a href="#l11.43"></a><span id="l11.43">       });</span>
<a href="#l11.44"></a><span id="l11.44">     });</span>
<a href="#l11.45"></a><span id="l11.45">   });</span>
<a href="#l11.46"></a><span id="l11.46"> }</span>
<a href="#l11.47"></a><span id="l11.47"> </span>
<a href="#l11.48"></a><span id="l11.48"> function makeCT(media, sub, params) {</span>
<a href="#l11.49"></a><span id="l11.49">   var object = new Map();</span>
<a href="#l11.50"></a><span id="l11.50">   object.mediatype = media;</span>
<a href="#l11.51"></a><span id="l11.51">   object.subtype = sub;</span>
<a href="#l11.52"></a><span id="l11.52">   object.type = media + &quot;/&quot; + sub;</span>
<a href="#l11.53"></a><span id="l11.53">   for (let k in params)</span>
<a href="#l11.54"></a><span id="l11.54">     object.set(k, params[k]);</span>
<a href="#l11.55"></a><span id="l11.55">   return object;</span>
<a href="#l11.56"></a><span id="l11.56"> }</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineminus">-suite('Structured headers', function () {</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+suite(&quot;Structured headers&quot;, function() {</span>
<a href="#l11.59"></a><span id="l11.59">   // Ad-hoc header tests</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineminus">-  testHeader('Content-Type', [</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-    ['text/plain', makeCT(&quot;text&quot;, &quot;plain&quot;, {})],</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-    ['text/html', makeCT(&quot;text&quot;, &quot;html&quot;, {})],</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+  testHeader(&quot;Content-Type&quot;, [</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+    [&quot;text/plain&quot;, makeCT(&quot;text&quot;, &quot;plain&quot;, {})],</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+    [&quot;text/html&quot;, makeCT(&quot;text&quot;, &quot;html&quot;, {})],</span>
<a href="#l11.66"></a><span id="l11.66">     ['text/plain; charset=&quot;UTF-8&quot;',</span>
<a href="#l11.67"></a><span id="l11.67">       makeCT(&quot;text&quot;, &quot;plain&quot;, {charset: &quot;UTF-8&quot;})],</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineminus">-    ['text/', makeCT(&quot;text&quot;, &quot;&quot;, {})],</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineminus">-    ['text', makeCT(&quot;text&quot;, &quot;plain&quot;, {})],</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineminus">-    ['image/', makeCT(&quot;image&quot;, &quot;&quot;, {})],</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineminus">-    ['image', makeCT(&quot;text&quot;, &quot;plain&quot;, {})],</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineminus">-    ['hacker/x-mailnews', makeCT(&quot;hacker&quot;, &quot;x-mailnews&quot;, {})],</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineminus">-    ['hacker/x-mailnews;', makeCT(&quot;hacker&quot;, &quot;x-mailnews&quot;, {})],</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineminus">-    ['HACKER/X-MAILNEWS', makeCT(&quot;hacker&quot;, &quot;x-mailnews&quot;, {})],</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineminus">-    ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+    [&quot;text/&quot;, makeCT(&quot;text&quot;, &quot;&quot;, {})],</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineplus">+    [&quot;text&quot;, makeCT(&quot;text&quot;, &quot;plain&quot;, {})],</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+    [&quot;image/&quot;, makeCT(&quot;image&quot;, &quot;&quot;, {})],</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+    [&quot;image&quot;, makeCT(&quot;text&quot;, &quot;plain&quot;, {})],</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+    [&quot;hacker/x-mailnews&quot;, makeCT(&quot;hacker&quot;, &quot;x-mailnews&quot;, {})],</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+    [&quot;hacker/x-mailnews;&quot;, makeCT(&quot;hacker&quot;, &quot;x-mailnews&quot;, {})],</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineplus">+    [&quot;HACKER/X-MAILNEWS&quot;, makeCT(&quot;hacker&quot;, &quot;x-mailnews&quot;, {})],</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineplus">+    [&quot;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&quot;,</span>
<a href="#l11.84"></a><span id="l11.84">       makeCT(&quot;application&quot;,</span>
<a href="#l11.85"></a><span id="l11.85">       &quot;vnd.openxmlformats-officedocument.spreadsheetml.sheet&quot;, {})],</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineminus">-    ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;\r' +</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineplus">+    [&quot;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;\r&quot; +</span>
<a href="#l11.88"></a><span id="l11.88">       '\n name=&quot;Presentation.pptx&quot;',</span>
<a href="#l11.89"></a><span id="l11.89">       makeCT(&quot;application&quot;,</span>
<a href="#l11.90"></a><span id="l11.90">       &quot;vnd.openxmlformats-officedocument.spreadsheetml.sheet&quot;,</span>
<a href="#l11.91"></a><span id="l11.91">       {name: &quot;Presentation.pptx&quot;})],</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineminus">-    ['', makeCT(&quot;text&quot;, &quot;plain&quot;, {})],</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineminus">-    ['                                        ', makeCT(&quot;text&quot;, &quot;plain&quot;, {})],</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineminus">-    ['text/plain; c', makeCT(&quot;text&quot;, &quot;plain&quot;, {})],</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineminus">-    ['text/plain; charset=', makeCT(&quot;text&quot;, &quot;plain&quot;, {charset: &quot;&quot;})],</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineplus">+    [&quot;&quot;, makeCT(&quot;text&quot;, &quot;plain&quot;, {})],</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineplus">+    [&quot;                                        &quot;, makeCT(&quot;text&quot;, &quot;plain&quot;, {})],</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineplus">+    [&quot;text/plain; c&quot;, makeCT(&quot;text&quot;, &quot;plain&quot;, {})],</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineplus">+    [&quot;text/plain; charset=&quot;, makeCT(&quot;text&quot;, &quot;plain&quot;, {charset: &quot;&quot;})],</span>
<a href="#l11.100"></a><span id="l11.100">     ['text/plain; charset=&quot;', makeCT(&quot;text&quot;, &quot;plain&quot;, {charset: &quot;&quot;})],</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineminus">-    ['text\\/enriched', makeCT(&quot;text\\&quot;, &quot;enriched&quot;, {})],</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineplus">+    [&quot;text\\/enriched&quot;, makeCT(&quot;text\\&quot;, &quot;enriched&quot;, {})],</span>
<a href="#l11.103"></a><span id="l11.103">     ['multipart/mixed &quot;;&quot; wtf=stupid', makeCT(&quot;multipart&quot;, &quot;mixed&quot;, {})],</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineminus">-    ['multipart/mixed; wtf=stupid',</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineplus">+    [&quot;multipart/mixed; wtf=stupid&quot;,</span>
<a href="#l11.106"></a><span id="l11.106">       makeCT(&quot;multipart&quot;, &quot;mixed&quot;, {wtf: &quot;stupid&quot;})],</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineminus">-    ['text/plain; CHARSET=Big5', makeCT(&quot;text&quot;, &quot;plain&quot;, {charset: &quot;Big5&quot;})],</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineplus">+    [&quot;text/plain; CHARSET=Big5&quot;, makeCT(&quot;text&quot;, &quot;plain&quot;, {charset: &quot;Big5&quot;})],</span>
<a href="#l11.109"></a><span id="l11.109">     ['text/html; CHARSET=&quot;Big5&quot;', makeCT(&quot;text&quot;, &quot;html&quot;, {charset: &quot;Big5&quot;})],</span>
<a href="#l11.110"></a><span id="l11.110">     ['text/html; CHARSET=&quot;Big5', makeCT(&quot;text&quot;, &quot;html&quot;, {charset: &quot;Big5&quot;})],</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineminus">-    [['text/html', 'multipart/mixed'], makeCT(&quot;text&quot;, &quot;html&quot;, {})],</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineplus">+    [[&quot;text/html&quot;, &quot;multipart/mixed&quot;], makeCT(&quot;text&quot;, &quot;html&quot;, {})],</span>
<a href="#l11.113"></a><span id="l11.113">   ]);</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineminus">-  testHeader('Content-Transfer-Encoding', [</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineminus">-    ['', ''],</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineminus">-    ['8bit', '8bit'],</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineminus">-    ['8BIT', '8bit'],</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineminus">-    ['QuOtEd-PrInTaBlE', 'quoted-printable'],</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineminus">-    ['Base64', 'base64'],</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineminus">-    ['7bit', '7bit'],</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineminus">-    [['7bit', '8bit'], '7bit'],</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineminus">-    ['x-uuencode', 'x-uuencode']</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineplus">+  testHeader(&quot;Content-Transfer-Encoding&quot;, [</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineplus">+    [&quot;&quot;, &quot;&quot;],</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineplus">+    [&quot;8bit&quot;, &quot;8bit&quot;],</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineplus">+    [&quot;8BIT&quot;, &quot;8bit&quot;],</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineplus">+    [&quot;QuOtEd-PrInTaBlE&quot;, &quot;quoted-printable&quot;],</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineplus">+    [&quot;Base64&quot;, &quot;base64&quot;],</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineplus">+    [&quot;7bit&quot;, &quot;7bit&quot;],</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineplus">+    [[&quot;7bit&quot;, &quot;8bit&quot;], &quot;7bit&quot;],</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineplus">+    [&quot;x-uuencode&quot;, &quot;x-uuencode&quot;],</span>
<a href="#l11.132"></a><span id="l11.132">   ]);</span>
<a href="#l11.133"></a><span id="l11.133"> </span>
<a href="#l11.134"></a><span id="l11.134">   // Non-ad-hoc header tests</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineminus">-  let addressing_headers = ['From', 'To', 'Cc', 'Bcc', 'Sender', 'Reply-To',</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineminus">-    'Resent-Bcc', 'Resent-To', 'Resent-From', 'Resent-Cc', 'Resent-Sender',</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineminus">-    'Approved', 'Disposition-Notification-To', 'Delivered-To',</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineminus">-    'Return-Receipt-To', 'Resent-Reply-To', 'Mail-Reply-To', 'Mail-Followup-To'</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineplus">+  let addressing_headers = [&quot;From&quot;, &quot;To&quot;, &quot;Cc&quot;, &quot;Bcc&quot;, &quot;Sender&quot;, &quot;Reply-To&quot;,</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineplus">+    &quot;Resent-Bcc&quot;, &quot;Resent-To&quot;, &quot;Resent-From&quot;, &quot;Resent-Cc&quot;, &quot;Resent-Sender&quot;,</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineplus">+    &quot;Approved&quot;, &quot;Disposition-Notification-To&quot;, &quot;Delivered-To&quot;,</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineplus">+    &quot;Return-Receipt-To&quot;, &quot;Resent-Reply-To&quot;, &quot;Mail-Reply-To&quot;, &quot;Mail-Followup-To&quot;,</span>
<a href="#l11.143"></a><span id="l11.143">   ];</span>
<a href="#l11.144"></a><span id="l11.144">   let address_tests = [</span>
<a href="#l11.145"></a><span id="l11.145">     [&quot;&quot;, []],</span>
<a href="#l11.146"></a><span id="l11.146">     [&quot;a@example.invalid&quot;, [{name: &quot;&quot;, email: &quot;a@example.invalid&quot;}]],</span>
<a href="#l11.147"></a><span id="l11.147">     [&quot;John Doe &lt;a@example.invalid&gt;&quot;,</span>
<a href="#l11.148"></a><span id="l11.148">       [{name: &quot;John Doe&quot;, email: &quot;a@example.invalid&quot;}]],</span>
<a href="#l11.149"></a><span id="l11.149">     [&quot;John Doe &lt;A@EXAMPLE.INVALID&gt;&quot;,</span>
<a href="#l11.150"></a><span id="l11.150">       [{name: &quot;John Doe&quot;, email: &quot;A@EXAMPLE.INVALID&quot;}]],</span>
<a href="#l11.151"></a><span id="l11.151">     [&quot;=?UTF-8?B?5bGx55Sw5aSq6YOO?= &lt;a@example.invalid&gt;&quot;,</span>
<a href="#l11.152"></a><span id="l11.152">       [{name: &quot;\u5c71\u7530\u592a\u90ce&quot;, email: &quot;a@example.invalid&quot;}]],</span>
<a href="#l11.153"></a><span id="l11.153">     [&quot;undisclosed-recipients:;&quot;, [{name: &quot;undisclosed-recipients&quot;, group: []}]],</span>
<a href="#l11.154"></a><span id="l11.154">     [&quot;world: a@example.invalid, b@example.invalid;&quot;,</span>
<a href="#l11.155"></a><span id="l11.155">       [{name: &quot;world&quot;, group: [</span>
<a href="#l11.156"></a><span id="l11.156">         {name: &quot;&quot;, email: &quot;a@example.invalid&quot;},</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineminus">-        {name: &quot;&quot;, email: &quot;b@example.invalid&quot;}</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineplus">+        {name: &quot;&quot;, email: &quot;b@example.invalid&quot;},</span>
<a href="#l11.159"></a><span id="l11.159">       ]}]],</span>
<a href="#l11.160"></a><span id="l11.160">     // TODO when we support IDN:</span>
<a href="#l11.161"></a><span id="l11.161">     // This should be \u4f8b.invalid instead (Japanese kanji for &quot;example&quot;)</span>
<a href="#l11.162"></a><span id="l11.162">     [&quot;\u5c71\u7530\u592a\u90ce &lt;a@xn--fsq.invalid&gt;&quot;,</span>
<a href="#l11.163"></a><span id="l11.163">       [{name: &quot;\u5c71\u7530\u592a\u90ce&quot;, email: &quot;a@xn--fsq.invalid&quot;}]],</span>
<a href="#l11.164"></a><span id="l11.164">     [&quot;\u5c71\u7530\u592a\u90ce &lt;a@\u4f8b.invalid&gt;&quot;,</span>
<a href="#l11.165"></a><span id="l11.165">       [{name: &quot;\u5c71\u7530\u592a\u90ce&quot;, email: &quot;a@\u4f8b.invalid&quot;}]],</span>
<a href="#l11.166"></a><span id="l11.166">     [&quot;\u30b1\u30c4\u30a1\u30eb\u30b3\u30a2\u30c8\u30eb@\u4f8b.invalid&quot;,</span>
<a href="#l11.167"></a><span id="l11.167">       [{name: &quot;&quot;, email:</span>
<a href="#l11.168"></a><span id="l11.168">          &quot;\u30b1\u30c4\u30a1\u30eb\u30b3\u30a2\u30c8\u30eb@\u4f8b.invalid&quot;}]],</span>
<a href="#l11.169"></a><span id="l11.169">     [[&quot;a@example.invalid&quot;, &quot;b@example.invalid&quot;],</span>
<a href="#l11.170"></a><span id="l11.170">       [{name: &quot;&quot;, email: &quot;a@example.invalid&quot;},</span>
<a href="#l11.171"></a><span id="l11.171">        {name: &quot;&quot;, email: &quot;b@example.invalid&quot;}]],</span>
<a href="#l11.172"></a><span id="l11.172">   ];</span>
<a href="#l11.173"></a><span id="l11.173" class="difflineminus">-  addressing_headers.forEach(function (header) {</span>
<a href="#l11.174"></a><span id="l11.174" class="difflineplus">+  addressing_headers.forEach(function(header) {</span>
<a href="#l11.175"></a><span id="l11.175">     testHeader(header, address_tests);</span>
<a href="#l11.176"></a><span id="l11.176">   });</span>
<a href="#l11.177"></a><span id="l11.177"> </span>
<a href="#l11.178"></a><span id="l11.178" class="difflineminus">-  let date_headers = ['Date', 'Expires', 'Injection-Date', 'NNTP-Posting-Date',</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineminus">-    'Resent-Date'];</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineplus">+  let date_headers = [&quot;Date&quot;, &quot;Expires&quot;, &quot;Injection-Date&quot;, &quot;NNTP-Posting-Date&quot;,</span>
<a href="#l11.181"></a><span id="l11.181" class="difflineplus">+    &quot;Resent-Date&quot;];</span>
<a href="#l11.182"></a><span id="l11.182">   let date_tests = [</span>
<a href="#l11.183"></a><span id="l11.183">     [&quot;Thu, 06 Sep 2012 08:08:21 -0700&quot;, new Date(&quot;2012-09-06T08:08:21-0700&quot;)],</span>
<a href="#l11.184"></a><span id="l11.184">     [&quot;This is so not a date&quot;, new Date(NaN)],</span>
<a href="#l11.185"></a><span id="l11.185">   ];</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineminus">-  date_headers.forEach(function (header) {</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineplus">+  date_headers.forEach(function(header) {</span>
<a href="#l11.188"></a><span id="l11.188">     testHeader(header, date_tests);</span>
<a href="#l11.189"></a><span id="l11.189">   });</span>
<a href="#l11.190"></a><span id="l11.190"> </span>
<a href="#l11.191"></a><span id="l11.191" class="difflineminus">-  let multiple_unstructured_headers = ['In-Reply-To', 'References'];</span>
<a href="#l11.192"></a><span id="l11.192" class="difflineplus">+  let multiple_unstructured_headers = [&quot;In-Reply-To&quot;, &quot;References&quot;];</span>
<a href="#l11.193"></a><span id="l11.193">   let multiple_unstructured_tests = [</span>
<a href="#l11.194"></a><span id="l11.194">     [&quot;&lt;asdasdasd@asdasdasd.com&gt;&quot;, &quot;&lt;asdasdasd@asdasdasd.com&gt;&quot;],</span>
<a href="#l11.195"></a><span id="l11.195">     [&quot;&lt;asd@asd.com&gt; &lt;asdf@asdf.com&gt;&quot;, &quot;&lt;asd@asd.com&gt; &lt;asdf@asdf.com&gt;&quot;],</span>
<a href="#l11.196"></a><span id="l11.196"> </span>
<a href="#l11.197"></a><span id="l11.197">     // This test is needed for clients sending non-compliant headers, see bug 1154521</span>
<a href="#l11.198"></a><span id="l11.198">     [&quot;&lt;asd@asd.com&gt;,&lt;asdf@asdf.com&gt;,&lt;asdfg@asdfg.com&gt;&quot;, &quot;&lt;asd@asd.com&gt; &lt;asdf@asdf.com&gt; &lt;asdfg@asdfg.com&gt;&quot;],</span>
<a href="#l11.199"></a><span id="l11.199">     // Test for bug 1197686</span>
<a href="#l11.200"></a><span id="l11.200">     [&quot;&lt;asd@asd.com&gt;&lt;asdf@asdf.com&gt;&lt;asdfg@asdfg.com&gt;&quot;, &quot;&lt;asd@asd.com&gt; &lt;asdf@asdf.com&gt; &lt;asdfg@asdfg.com&gt;&quot;],</span>
<a href="#l11.201"></a><span id="l11.201">   ];</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineminus">-  multiple_unstructured_headers.forEach(function (header) {</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineplus">+  multiple_unstructured_headers.forEach(function(header) {</span>
<a href="#l11.204"></a><span id="l11.204">     testHeader(header, multiple_unstructured_tests);</span>
<a href="#l11.205"></a><span id="l11.205">   });</span>
<a href="#l11.206"></a><span id="l11.206"> </span>
<a href="#l11.207"></a><span id="l11.207" class="difflineminus">-  let unstructured_headers = ['Comments', 'Content-Description', 'Keywords',</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineminus">-    'Subject'];</span>
<a href="#l11.209"></a><span id="l11.209" class="difflineplus">+  let unstructured_headers = [&quot;Comments&quot;, &quot;Content-Description&quot;, &quot;Keywords&quot;,</span>
<a href="#l11.210"></a><span id="l11.210" class="difflineplus">+    &quot;Subject&quot;];</span>
<a href="#l11.211"></a><span id="l11.211">   let unstructured_tests = [</span>
<a href="#l11.212"></a><span id="l11.212">     [&quot;&quot;, &quot;&quot;],</span>
<a href="#l11.213"></a><span id="l11.213">     [&quot;This is a subject&quot;, &quot;This is a subject&quot;],</span>
<a href="#l11.214"></a><span id="l11.214">     [[&quot;Subject 1&quot;, &quot;Subject 2&quot;], &quot;Subject 1&quot;],</span>
<a href="#l11.215"></a><span id="l11.215">     [&quot;=?UTF-8?B?56eB44Gv5Lu25ZCN5Y2I5YmN?=&quot;,</span>
<a href="#l11.216"></a><span id="l11.216">       &quot;\u79c1\u306f\u4ef6\u540d\u5348\u524d&quot;],</span>
<a href="#l11.217"></a><span id="l11.217">   ];</span>
<a href="#l11.218"></a><span id="l11.218" class="difflineminus">-  unstructured_headers.forEach(function (header) {</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineplus">+  unstructured_headers.forEach(function(header) {</span>
<a href="#l11.220"></a><span id="l11.220">     testHeader(header, unstructured_tests);</span>
<a href="#l11.221"></a><span id="l11.221">   });</span>
<a href="#l11.222"></a><span id="l11.222"> });</span>
<a href="#l11.223"></a><span id="l11.223" class="difflineminus">-</span>
<a href="#l11.224"></a><span id="l11.224"> });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/mime/src/extraMimeParsers.jsm</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/mime/src/extraMimeParsers.jsm</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -1,25 +1,27 @@</span>
<a href="#l12.4"></a><span id="l12.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.5"></a><span id="l12.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.6"></a><span id="l12.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+/* globals jsmime */</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+</span>
<a href="#l12.10"></a><span id="l12.10"> function parseNewsgroups(headers) {</span>
<a href="#l12.11"></a><span id="l12.11">   let ng = [];</span>
<a href="#l12.12"></a><span id="l12.12">   for (let header of headers) {</span>
<a href="#l12.13"></a><span id="l12.13">     ng = ng.concat(header.split(/\s*,\s*/));</span>
<a href="#l12.14"></a><span id="l12.14">   }</span>
<a href="#l12.15"></a><span id="l12.15">   return ng;</span>
<a href="#l12.16"></a><span id="l12.16"> }</span>
<a href="#l12.17"></a><span id="l12.17"> </span>
<a href="#l12.18"></a><span id="l12.18"> function emitNewsgroups(groups) {</span>
<a href="#l12.19"></a><span id="l12.19">   // Don't encode the newsgroups names in RFC 2047...</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineminus">-  if (groups.length == 1)</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+  if (groups.length == 1) {</span>
<a href="#l12.22"></a><span id="l12.22">     this.addText(groups[0], false);</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineminus">-  else {</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+  } else {</span>
<a href="#l12.25"></a><span id="l12.25">     this.addText(groups[0], false);</span>
<a href="#l12.26"></a><span id="l12.26">     for (let i = 1; i &lt; groups.length; i++) {</span>
<a href="#l12.27"></a><span id="l12.27">       this.addText(&quot;,&quot;, false); // only comma, no space!</span>
<a href="#l12.28"></a><span id="l12.28">       this.addText(groups[i], false);</span>
<a href="#l12.29"></a><span id="l12.29">     }</span>
<a href="#l12.30"></a><span id="l12.30">   }</span>
<a href="#l12.31"></a><span id="l12.31"> }</span>
<a href="#l12.32"></a><span id="l12.32"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/mime/src/jsmime.jsm</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/mime/src/jsmime.jsm</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -12,55 +12,56 @@ const {Services} = ChromeUtils.import(&quot;r</span>
<a href="#l13.4"></a><span id="l13.4"> </span>
<a href="#l13.5"></a><span id="l13.5"> // Load the core MIME parser. Since it doesn't define EXPORTED_SYMBOLS, we must</span>
<a href="#l13.6"></a><span id="l13.6"> // use the subscript loader instead.</span>
<a href="#l13.7"></a><span id="l13.7"> Services.scriptloader.loadSubScript(&quot;resource:///modules/jsmime/jsmime.js&quot;);</span>
<a href="#l13.8"></a><span id="l13.8"> </span>
<a href="#l13.9"></a><span id="l13.9"> var EXPORTED_SYMBOLS = [&quot;jsmime&quot;];</span>
<a href="#l13.10"></a><span id="l13.10"> </span>
<a href="#l13.11"></a><span id="l13.11"> function bytesToString(buffer) {</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-  var string = '';</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+  var string = &quot;&quot;;</span>
<a href="#l13.14"></a><span id="l13.14">   for (var i = 0; i &lt; buffer.length; i++)</span>
<a href="#l13.15"></a><span id="l13.15">     string += String.fromCharCode(buffer[i]);</span>
<a href="#l13.16"></a><span id="l13.16">   return string;</span>
<a href="#l13.17"></a><span id="l13.17"> }</span>
<a href="#l13.18"></a><span id="l13.18"> </span>
<a href="#l13.19"></a><span id="l13.19"> // Our UTF-7 decoder.</span>
<a href="#l13.20"></a><span id="l13.20"> function UTF7TextDecoder(options = {}, manager) {</span>
<a href="#l13.21"></a><span id="l13.21">   this.manager = manager;</span>
<a href="#l13.22"></a><span id="l13.22">   this.collectInput = &quot;&quot;;</span>
<a href="#l13.23"></a><span id="l13.23"> }</span>
<a href="#l13.24"></a><span id="l13.24"> UTF7TextDecoder.prototype = {</span>
<a href="#l13.25"></a><span id="l13.25">   // Since the constructor checked, this will only be called for UTF-7.</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineminus">-  decode: function (input, options = {}) {</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineminus">-    let more = 'stream' in options ? options.stream : false;</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+  decode(input, options = {}) {</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+    let more = &quot;stream&quot; in options ? options.stream : false;</span>
<a href="#l13.30"></a><span id="l13.30">     // There are cases where this is called without input.</span>
<a href="#l13.31"></a><span id="l13.31">     if (!input)</span>
<a href="#l13.32"></a><span id="l13.32">       return &quot;&quot;;</span>
<a href="#l13.33"></a><span id="l13.33">     this.collectInput += bytesToString(input);</span>
<a href="#l13.34"></a><span id="l13.34">     if (more)</span>
<a href="#l13.35"></a><span id="l13.35">       return &quot;&quot;;</span>
<a href="#l13.36"></a><span id="l13.36">     return this.manager.utf7ToUnicode(this.collectInput);</span>
<a href="#l13.37"></a><span id="l13.37">   },</span>
<a href="#l13.38"></a><span id="l13.38"> };</span>
<a href="#l13.39"></a><span id="l13.39"> </span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+/* exported MimeTextDecoder */</span>
<a href="#l13.41"></a><span id="l13.41"> function MimeTextDecoder(charset, options) {</span>
<a href="#l13.42"></a><span id="l13.42">   let manager = Cc[&quot;@mozilla.org/charset-converter-manager;1&quot;]</span>
<a href="#l13.43"></a><span id="l13.43">                   .createInstance(Ci.nsICharsetConverterManager);</span>
<a href="#l13.44"></a><span id="l13.44">   // The following will throw if the charset is unknown.</span>
<a href="#l13.45"></a><span id="l13.45">   let newCharset = manager.getCharsetAlias(charset);</span>
<a href="#l13.46"></a><span id="l13.46">   if (newCharset.toLowerCase() == &quot;utf-7&quot;)</span>
<a href="#l13.47"></a><span id="l13.47">     return new UTF7TextDecoder(options, manager);</span>
<a href="#l13.48"></a><span id="l13.48">   return new TextDecoder(newCharset, options);</span>
<a href="#l13.49"></a><span id="l13.49"> }</span>
<a href="#l13.50"></a><span id="l13.50"> </span>
<a href="#l13.51"></a><span id="l13.51"> </span>
<a href="#l13.52"></a><span id="l13.52"> // The following code loads custom MIME encoders.</span>
<a href="#l13.53"></a><span id="l13.53"> var CATEGORY_NAME = &quot;custom-mime-encoder&quot;;</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineminus">-Services.obs.addObserver(function (subject, topic, data) {</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+Services.obs.addObserver(function(subject, topic, data) {</span>
<a href="#l13.56"></a><span id="l13.56">   subject = subject.QueryInterface(Ci.nsISupportsCString)</span>
<a href="#l13.57"></a><span id="l13.57">                    .data;</span>
<a href="#l13.58"></a><span id="l13.58">   if (data == CATEGORY_NAME) {</span>
<a href="#l13.59"></a><span id="l13.59">     let url = Services.catMan.getCategoryEntry(CATEGORY_NAME, subject);</span>
<a href="#l13.60"></a><span id="l13.60">     Services.scriptloader.loadSubScript(url, {}, &quot;UTF-8&quot;);</span>
<a href="#l13.61"></a><span id="l13.61">   }</span>
<a href="#l13.62"></a><span id="l13.62"> }, &quot;xpcom-category-entry-added&quot;);</span>
<a href="#l13.63"></a><span id="l13.63"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/mime/src/mimeJSComponents.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/mime/src/mimeJSComponents.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -3,125 +3,124 @@</span>
<a href="#l14.4"></a><span id="l14.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.5"></a><span id="l14.5"> </span>
<a href="#l14.6"></a><span id="l14.6"> var {jsmime} = ChromeUtils.import(&quot;resource:///modules/jsmime.jsm&quot;);</span>
<a href="#l14.7"></a><span id="l14.7"> var {MimeParser} = ChromeUtils.import(&quot;resource:///modules/mimeParser.jsm&quot;);</span>
<a href="#l14.8"></a><span id="l14.8"> var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10"> function HeaderHandler() {</span>
<a href="#l14.11"></a><span id="l14.11">   this.value = &quot;&quot;;</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-  this.deliverData = function (str) { this.value += str; };</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-  this.deliverEOF = function () {};</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+  this.deliverData = function(str) { this.value += str; };</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+  this.deliverEOF = function() {};</span>
<a href="#l14.16"></a><span id="l14.16"> }</span>
<a href="#l14.17"></a><span id="l14.17"> </span>
<a href="#l14.18"></a><span id="l14.18"> function StringEnumerator(iterator) {</span>
<a href="#l14.19"></a><span id="l14.19">   this._iterator = iterator;</span>
<a href="#l14.20"></a><span id="l14.20">   this._next = undefined;</span>
<a href="#l14.21"></a><span id="l14.21"> }</span>
<a href="#l14.22"></a><span id="l14.22"> StringEnumerator.prototype = {</span>
<a href="#l14.23"></a><span id="l14.23">   QueryInterface: ChromeUtils.generateQI([Ci.nsIUTF8StringEnumerator]),</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineminus">-  [Symbol.iterator]: function () {</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+  [Symbol.iterator]() {</span>
<a href="#l14.26"></a><span id="l14.26">     return this._iterator;</span>
<a href="#l14.27"></a><span id="l14.27">   },</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">-  _setNext: function () {</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+  _setNext() {</span>
<a href="#l14.30"></a><span id="l14.30">     if (this._next !== undefined)</span>
<a href="#l14.31"></a><span id="l14.31">       return;</span>
<a href="#l14.32"></a><span id="l14.32">     this._next = this._iterator.next();</span>
<a href="#l14.33"></a><span id="l14.33">   },</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineminus">-  hasMore: function () {</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+  hasMore() {</span>
<a href="#l14.36"></a><span id="l14.36">     this._setNext();</span>
<a href="#l14.37"></a><span id="l14.37">     return !this._next.done;</span>
<a href="#l14.38"></a><span id="l14.38">   },</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineminus">-  getNext: function () {</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+  getNext() {</span>
<a href="#l14.41"></a><span id="l14.41">     this._setNext();</span>
<a href="#l14.42"></a><span id="l14.42">     let result = this._next;</span>
<a href="#l14.43"></a><span id="l14.43">     this._next = undefined;</span>
<a href="#l14.44"></a><span id="l14.44">     if (result.done)</span>
<a href="#l14.45"></a><span id="l14.45">       throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l14.46"></a><span id="l14.46">     return result.value;</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineminus">-  }</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+  },</span>
<a href="#l14.49"></a><span id="l14.49"> };</span>
<a href="#l14.50"></a><span id="l14.50"> </span>
<a href="#l14.51"></a><span id="l14.51"> /**</span>
<a href="#l14.52"></a><span id="l14.52">  * If we get XPConnect-wrapped objects for msgIAddressObjects, we will have</span>
<a href="#l14.53"></a><span id="l14.53">  * properties defined for 'group' that throws off jsmime. This function converts</span>
<a href="#l14.54"></a><span id="l14.54">  * the addresses into the form that jsmime expects.</span>
<a href="#l14.55"></a><span id="l14.55">  */</span>
<a href="#l14.56"></a><span id="l14.56"> function fixXpconnectAddresses(addrs) {</span>
<a href="#l14.57"></a><span id="l14.57">   return addrs.map((addr) =&gt; {</span>
<a href="#l14.58"></a><span id="l14.58">     // This is ideally !addr.group, but that causes a JS strict warning, if</span>
<a href="#l14.59"></a><span id="l14.59">     // group is not in addr, since that's enabled in all chrome code now.</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineminus">-    if (!('group' in addr) || addr.group === undefined || addr.group === null) {</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+    if (!(&quot;group&quot; in addr) || addr.group === undefined || addr.group === null) {</span>
<a href="#l14.62"></a><span id="l14.62">       return MimeAddressParser.prototype.makeMailboxObject(addr.name,</span>
<a href="#l14.63"></a><span id="l14.63">         addr.email);</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineminus">-    } else {</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineminus">-      return MimeAddressParser.prototype.makeGroupObject(addr.name,</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineminus">-        fixXpconnectAddresses(addr.group));</span>
<a href="#l14.67"></a><span id="l14.67">     }</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+    return MimeAddressParser.prototype.makeGroupObject(addr.name,</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+      fixXpconnectAddresses(addr.group));</span>
<a href="#l14.70"></a><span id="l14.70">   });</span>
<a href="#l14.71"></a><span id="l14.71"> }</span>
<a href="#l14.72"></a><span id="l14.72"> </span>
<a href="#l14.73"></a><span id="l14.73"> /**</span>
<a href="#l14.74"></a><span id="l14.74">  * This is a base handler for supporting msgIStructuredHeaders, since we have</span>
<a href="#l14.75"></a><span id="l14.75">  * two implementations that need the readable aspects of the interface.</span>
<a href="#l14.76"></a><span id="l14.76">  */</span>
<a href="#l14.77"></a><span id="l14.77"> function MimeStructuredHeaders() {</span>
<a href="#l14.78"></a><span id="l14.78"> }</span>
<a href="#l14.79"></a><span id="l14.79"> MimeStructuredHeaders.prototype = {</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineminus">-  getHeader: function (aHeaderName) {</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineplus">+  getHeader(aHeaderName) {</span>
<a href="#l14.82"></a><span id="l14.82">     let name = aHeaderName.toLowerCase();</span>
<a href="#l14.83"></a><span id="l14.83">     return this._headers.get(name);</span>
<a href="#l14.84"></a><span id="l14.84">   },</span>
<a href="#l14.85"></a><span id="l14.85"> </span>
<a href="#l14.86"></a><span id="l14.86" class="difflineminus">-  hasHeader: function (aHeaderName) {</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineplus">+  hasHeader(aHeaderName) {</span>
<a href="#l14.88"></a><span id="l14.88">     return this._headers.has(aHeaderName.toLowerCase());</span>
<a href="#l14.89"></a><span id="l14.89">   },</span>
<a href="#l14.90"></a><span id="l14.90"> </span>
<a href="#l14.91"></a><span id="l14.91" class="difflineminus">-  getUnstructuredHeader: function (aHeaderName) {</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineplus">+  getUnstructuredHeader(aHeaderName) {</span>
<a href="#l14.93"></a><span id="l14.93">     let result = this.getHeader(aHeaderName);</span>
<a href="#l14.94"></a><span id="l14.94">     if (result === undefined || typeof result == &quot;string&quot;)</span>
<a href="#l14.95"></a><span id="l14.95">       return result;</span>
<a href="#l14.96"></a><span id="l14.96">     throw Cr.NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l14.97"></a><span id="l14.97">   },</span>
<a href="#l14.98"></a><span id="l14.98"> </span>
<a href="#l14.99"></a><span id="l14.99" class="difflineminus">-  getAddressingHeader: function (aHeaderName, aPreserveGroups, count) {</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineplus">+  getAddressingHeader(aHeaderName, aPreserveGroups, count) {</span>
<a href="#l14.101"></a><span id="l14.101">     let addrs = this.getHeader(aHeaderName);</span>
<a href="#l14.102"></a><span id="l14.102">     if (addrs === undefined) {</span>
<a href="#l14.103"></a><span id="l14.103">       addrs = [];</span>
<a href="#l14.104"></a><span id="l14.104">     } else if (!Array.isArray(addrs)) {</span>
<a href="#l14.105"></a><span id="l14.105">       throw Cr.NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l14.106"></a><span id="l14.106">     }</span>
<a href="#l14.107"></a><span id="l14.107">     return fixArray(addrs, aPreserveGroups, count);</span>
<a href="#l14.108"></a><span id="l14.108">   },</span>
<a href="#l14.109"></a><span id="l14.109"> </span>
<a href="#l14.110"></a><span id="l14.110" class="difflineminus">-  getRawHeader: function (aHeaderName) {</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineplus">+  getRawHeader(aHeaderName) {</span>
<a href="#l14.112"></a><span id="l14.112">     let result = this.getHeader(aHeaderName);</span>
<a href="#l14.113"></a><span id="l14.113">     if (result === undefined)</span>
<a href="#l14.114"></a><span id="l14.114">       return result;</span>
<a href="#l14.115"></a><span id="l14.115"> </span>
<a href="#l14.116"></a><span id="l14.116">     let value = jsmime.headeremitter.emitStructuredHeader(aHeaderName,</span>
<a href="#l14.117"></a><span id="l14.117">       result, {});</span>
<a href="#l14.118"></a><span id="l14.118">     // Strip off the header name and trailing whitespace before returning...</span>
<a href="#l14.119"></a><span id="l14.119">     value = value.substring(aHeaderName.length + 2).trim();</span>
<a href="#l14.120"></a><span id="l14.120">     // ... as well as embedded newlines.</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineminus">-    value = value.replace(/\r\n/g, '');</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineplus">+    value = value.replace(/\r\n/g, &quot;&quot;);</span>
<a href="#l14.123"></a><span id="l14.123">     return value;</span>
<a href="#l14.124"></a><span id="l14.124">   },</span>
<a href="#l14.125"></a><span id="l14.125"> </span>
<a href="#l14.126"></a><span id="l14.126">   get headerNames() {</span>
<a href="#l14.127"></a><span id="l14.127">     return new StringEnumerator(this._headers.keys());</span>
<a href="#l14.128"></a><span id="l14.128">   },</span>
<a href="#l14.129"></a><span id="l14.129"> </span>
<a href="#l14.130"></a><span id="l14.130" class="difflineminus">-  buildMimeText: function () {</span>
<a href="#l14.131"></a><span id="l14.131" class="difflineplus">+  buildMimeText() {</span>
<a href="#l14.132"></a><span id="l14.132">     if (this._headers.size == 0) {</span>
<a href="#l14.133"></a><span id="l14.133">       return &quot;&quot;;</span>
<a href="#l14.134"></a><span id="l14.134">     }</span>
<a href="#l14.135"></a><span id="l14.135">     let handler = new HeaderHandler();</span>
<a href="#l14.136"></a><span id="l14.136">     let emitter = jsmime.headeremitter.makeStreamingEmitter(handler, {</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineminus">-      useASCII: true</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineplus">+      useASCII: true,</span>
<a href="#l14.139"></a><span id="l14.139">     });</span>
<a href="#l14.140"></a><span id="l14.140">     for (let [value, header] of this._headers) {</span>
<a href="#l14.141"></a><span id="l14.141">       emitter.addStructuredHeader(value, header);</span>
<a href="#l14.142"></a><span id="l14.142">     }</span>
<a href="#l14.143"></a><span id="l14.143">     emitter.finish();</span>
<a href="#l14.144"></a><span id="l14.144">     return handler.value;</span>
<a href="#l14.145"></a><span id="l14.145">   },</span>
<a href="#l14.146"></a><span id="l14.146"> };</span>
<a href="#l14.147"></a><span id="l14.147" class="difflineat">@@ -132,115 +131,115 @@ function MimeHeaders() {</span>
<a href="#l14.148"></a><span id="l14.148"> MimeHeaders.prototype = {</span>
<a href="#l14.149"></a><span id="l14.149">   __proto__: MimeStructuredHeaders.prototype,</span>
<a href="#l14.150"></a><span id="l14.150">   classDescription: &quot;Mime headers implementation&quot;,</span>
<a href="#l14.151"></a><span id="l14.151">   classID: Components.ID(&quot;d1258011-f391-44fd-992e-c6f4b461a42f&quot;),</span>
<a href="#l14.152"></a><span id="l14.152">   contractID: &quot;@mozilla.org/messenger/mimeheaders;1&quot;,</span>
<a href="#l14.153"></a><span id="l14.153">   QueryInterface: ChromeUtils.generateQI([Ci.nsIMimeHeaders,</span>
<a href="#l14.154"></a><span id="l14.154">     Ci.msgIStructuredHeaders]),</span>
<a href="#l14.155"></a><span id="l14.155"> </span>
<a href="#l14.156"></a><span id="l14.156" class="difflineminus">-  initialize: function MimeHeaders_initialize(allHeaders) {</span>
<a href="#l14.157"></a><span id="l14.157" class="difflineplus">+  initialize(allHeaders) {</span>
<a href="#l14.158"></a><span id="l14.158">     this._headers = MimeParser.extractHeaders(allHeaders);</span>
<a href="#l14.159"></a><span id="l14.159">   },</span>
<a href="#l14.160"></a><span id="l14.160"> </span>
<a href="#l14.161"></a><span id="l14.161" class="difflineminus">-  extractHeader: function MimeHeaders_extractHeader(header, getAll) {</span>
<a href="#l14.162"></a><span id="l14.162" class="difflineplus">+  extractHeader(header, getAll) {</span>
<a href="#l14.163"></a><span id="l14.163">     if (!this._headers)</span>
<a href="#l14.164"></a><span id="l14.164">       throw Cr.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l14.165"></a><span id="l14.165">     // Canonicalized to lower-case form</span>
<a href="#l14.166"></a><span id="l14.166">     header = header.toLowerCase();</span>
<a href="#l14.167"></a><span id="l14.167">     if (!this._headers.has(header))</span>
<a href="#l14.168"></a><span id="l14.168">       return null;</span>
<a href="#l14.169"></a><span id="l14.169">     var values = this._headers.getRawHeader(header);</span>
<a href="#l14.170"></a><span id="l14.170">     if (getAll)</span>
<a href="#l14.171"></a><span id="l14.171">       return values.join(&quot;,\r\n\t&quot;);</span>
<a href="#l14.172"></a><span id="l14.172" class="difflineminus">-    else</span>
<a href="#l14.173"></a><span id="l14.173" class="difflineminus">-      return values[0];</span>
<a href="#l14.174"></a><span id="l14.174" class="difflineplus">+    return values[0];</span>
<a href="#l14.175"></a><span id="l14.175">   },</span>
<a href="#l14.176"></a><span id="l14.176"> </span>
<a href="#l14.177"></a><span id="l14.177">   get allHeaders() {</span>
<a href="#l14.178"></a><span id="l14.178">     return this._headers.rawHeaderText;</span>
<a href="#l14.179"></a><span id="l14.179" class="difflineminus">-  }</span>
<a href="#l14.180"></a><span id="l14.180" class="difflineplus">+  },</span>
<a href="#l14.181"></a><span id="l14.181"> };</span>
<a href="#l14.182"></a><span id="l14.182"> </span>
<a href="#l14.183"></a><span id="l14.183"> function MimeWritableStructuredHeaders() {</span>
<a href="#l14.184"></a><span id="l14.184">   this._headers = new Map();</span>
<a href="#l14.185"></a><span id="l14.185"> }</span>
<a href="#l14.186"></a><span id="l14.186"> MimeWritableStructuredHeaders.prototype = {</span>
<a href="#l14.187"></a><span id="l14.187">   __proto__: MimeStructuredHeaders.prototype,</span>
<a href="#l14.188"></a><span id="l14.188">   classID: Components.ID(&quot;c560806a-425f-4f0f-bf69-397c58c599a7&quot;),</span>
<a href="#l14.189"></a><span id="l14.189">   QueryInterface: ChromeUtils.generateQI([</span>
<a href="#l14.190"></a><span id="l14.190">     Ci.msgIStructuredHeaders,</span>
<a href="#l14.191"></a><span id="l14.191">     Ci.msgIWritableStructuredHeaders]),</span>
<a href="#l14.192"></a><span id="l14.192"> </span>
<a href="#l14.193"></a><span id="l14.193" class="difflineminus">-  setHeader: function (aHeaderName, aValue) {</span>
<a href="#l14.194"></a><span id="l14.194" class="difflineplus">+  setHeader(aHeaderName, aValue) {</span>
<a href="#l14.195"></a><span id="l14.195">     this._headers.set(aHeaderName.toLowerCase(), aValue);</span>
<a href="#l14.196"></a><span id="l14.196">   },</span>
<a href="#l14.197"></a><span id="l14.197"> </span>
<a href="#l14.198"></a><span id="l14.198" class="difflineminus">-  deleteHeader: function (aHeaderName) {</span>
<a href="#l14.199"></a><span id="l14.199" class="difflineplus">+  deleteHeader(aHeaderName) {</span>
<a href="#l14.200"></a><span id="l14.200">     this._headers.delete(aHeaderName.toLowerCase());</span>
<a href="#l14.201"></a><span id="l14.201">   },</span>
<a href="#l14.202"></a><span id="l14.202"> </span>
<a href="#l14.203"></a><span id="l14.203" class="difflineminus">-  addAllHeaders: function (aHeaders) {</span>
<a href="#l14.204"></a><span id="l14.204" class="difflineplus">+  addAllHeaders(aHeaders) {</span>
<a href="#l14.205"></a><span id="l14.205">     for (let header of aHeaders.headerNames) {</span>
<a href="#l14.206"></a><span id="l14.206">       this.setHeader(header, aHeaders.getHeader(header));</span>
<a href="#l14.207"></a><span id="l14.207">     }</span>
<a href="#l14.208"></a><span id="l14.208">   },</span>
<a href="#l14.209"></a><span id="l14.209"> </span>
<a href="#l14.210"></a><span id="l14.210" class="difflineminus">-  setUnstructuredHeader: function (aHeaderName, aValue) {</span>
<a href="#l14.211"></a><span id="l14.211" class="difflineplus">+  setUnstructuredHeader(aHeaderName, aValue) {</span>
<a href="#l14.212"></a><span id="l14.212">     this.setHeader(aHeaderName, aValue);</span>
<a href="#l14.213"></a><span id="l14.213">   },</span>
<a href="#l14.214"></a><span id="l14.214"> </span>
<a href="#l14.215"></a><span id="l14.215" class="difflineminus">-  setAddressingHeader: function (aHeaderName, aAddresses, aCount) {</span>
<a href="#l14.216"></a><span id="l14.216" class="difflineplus">+  setAddressingHeader(aHeaderName, aAddresses, aCount) {</span>
<a href="#l14.217"></a><span id="l14.217">     this.setHeader(aHeaderName, fixXpconnectAddresses(aAddresses));</span>
<a href="#l14.218"></a><span id="l14.218">   },</span>
<a href="#l14.219"></a><span id="l14.219"> </span>
<a href="#l14.220"></a><span id="l14.220" class="difflineminus">-  setRawHeader: function (aHeaderName, aValue, aCharset) {</span>
<a href="#l14.221"></a><span id="l14.221" class="difflineplus">+  setRawHeader(aHeaderName, aValue, aCharset) {</span>
<a href="#l14.222"></a><span id="l14.222">     aValue = jsmime.headerparser.convert8BitHeader(aValue, aCharset);</span>
<a href="#l14.223"></a><span id="l14.223">     try {</span>
<a href="#l14.224"></a><span id="l14.224">       this.setHeader(aHeaderName,</span>
<a href="#l14.225"></a><span id="l14.225">         jsmime.headerparser.parseStructuredHeader(aHeaderName, aValue));</span>
<a href="#l14.226"></a><span id="l14.226">     } catch (e) {</span>
<a href="#l14.227"></a><span id="l14.227">       // This means we don't have a structured encoder. Just assume it's a raw</span>
<a href="#l14.228"></a><span id="l14.228">       // string value then.</span>
<a href="#l14.229"></a><span id="l14.229">       this.setHeader(aHeaderName, aValue);</span>
<a href="#l14.230"></a><span id="l14.230">     }</span>
<a href="#l14.231"></a><span id="l14.231" class="difflineminus">-  }</span>
<a href="#l14.232"></a><span id="l14.232" class="difflineplus">+  },</span>
<a href="#l14.233"></a><span id="l14.233"> };</span>
<a href="#l14.234"></a><span id="l14.234"> </span>
<a href="#l14.235"></a><span id="l14.235"> // These are prototypes for nsIMsgHeaderParser implementation</span>
<a href="#l14.236"></a><span id="l14.236"> var Mailbox = {</span>
<a href="#l14.237"></a><span id="l14.237" class="difflineminus">-  toString: function () {</span>
<a href="#l14.238"></a><span id="l14.238" class="difflineplus">+  toString() {</span>
<a href="#l14.239"></a><span id="l14.239">     return this.name ? this.name + &quot; &lt;&quot; + this.email + &quot;&gt;&quot; : this.email;</span>
<a href="#l14.240"></a><span id="l14.240" class="difflineminus">-  }</span>
<a href="#l14.241"></a><span id="l14.241" class="difflineplus">+  },</span>
<a href="#l14.242"></a><span id="l14.242"> };</span>
<a href="#l14.243"></a><span id="l14.243"> </span>
<a href="#l14.244"></a><span id="l14.244"> var EmailGroup = {</span>
<a href="#l14.245"></a><span id="l14.245" class="difflineminus">-  toString: function () {</span>
<a href="#l14.246"></a><span id="l14.246" class="difflineplus">+  toString() {</span>
<a href="#l14.247"></a><span id="l14.247">     return this.name + &quot;: &quot; + this.group.map(x =&gt; x.toString()).join(&quot;, &quot;);</span>
<a href="#l14.248"></a><span id="l14.248" class="difflineminus">-  }</span>
<a href="#l14.249"></a><span id="l14.249" class="difflineplus">+  },</span>
<a href="#l14.250"></a><span id="l14.250"> };</span>
<a href="#l14.251"></a><span id="l14.251"> </span>
<a href="#l14.252"></a><span id="l14.252"> // A helper method for parse*Header that takes into account the desire to</span>
<a href="#l14.253"></a><span id="l14.253"> // preserve group and also tweaks the output to support the prototypes for the</span>
<a href="#l14.254"></a><span id="l14.254"> // XPIDL output.</span>
<a href="#l14.255"></a><span id="l14.255"> function fixArray(addresses, preserveGroups, count) {</span>
<a href="#l14.256"></a><span id="l14.256">   function resetPrototype(obj, prototype) {</span>
<a href="#l14.257"></a><span id="l14.257">     let prototyped = Object.create(prototype);</span>
<a href="#l14.258"></a><span id="l14.258">     for (let key of Object.getOwnPropertyNames(obj)) {</span>
<a href="#l14.259"></a><span id="l14.259">       if (typeof obj[key] == &quot;string&quot;) {</span>
<a href="#l14.260"></a><span id="l14.260" class="difflineminus">-        prototyped[key] = obj[key].replace(/\x00/g, '');</span>
<a href="#l14.261"></a><span id="l14.261" class="difflineplus">+        // eslint-disable-next-line no-control-regex</span>
<a href="#l14.262"></a><span id="l14.262" class="difflineplus">+        prototyped[key] = obj[key].replace(/\x00/g, &quot;&quot;);</span>
<a href="#l14.263"></a><span id="l14.263">       } else {</span>
<a href="#l14.264"></a><span id="l14.264">         prototyped[key] = obj[key];</span>
<a href="#l14.265"></a><span id="l14.265">       }</span>
<a href="#l14.266"></a><span id="l14.266">     }</span>
<a href="#l14.267"></a><span id="l14.267">     return prototyped;</span>
<a href="#l14.268"></a><span id="l14.268">   }</span>
<a href="#l14.269"></a><span id="l14.269">   let outputArray = [];</span>
<a href="#l14.270"></a><span id="l14.270">   for (let element of addresses) {</span>
<a href="#l14.271"></a><span id="l14.271" class="difflineminus">-    if ('group' in element) {</span>
<a href="#l14.272"></a><span id="l14.272" class="difflineplus">+    if (&quot;group&quot; in element) {</span>
<a href="#l14.273"></a><span id="l14.273">       // Fix up the prototypes of the group and the list members</span>
<a href="#l14.274"></a><span id="l14.274">       element = resetPrototype(element, EmailGroup);</span>
<a href="#l14.275"></a><span id="l14.275">       element.group = element.group.map(e =&gt; resetPrototype(e, Mailbox));</span>
<a href="#l14.276"></a><span id="l14.276"> </span>
<a href="#l14.277"></a><span id="l14.277">       // Add to the output array</span>
<a href="#l14.278"></a><span id="l14.278">       if (preserveGroups)</span>
<a href="#l14.279"></a><span id="l14.279">         outputArray.push(element);</span>
<a href="#l14.280"></a><span id="l14.280">       else</span>
<a href="#l14.281"></a><span id="l14.281" class="difflineat">@@ -257,75 +256,75 @@ function fixArray(addresses, preserveGro</span>
<a href="#l14.282"></a><span id="l14.282"> }</span>
<a href="#l14.283"></a><span id="l14.283"> </span>
<a href="#l14.284"></a><span id="l14.284"> function MimeAddressParser() {</span>
<a href="#l14.285"></a><span id="l14.285"> }</span>
<a href="#l14.286"></a><span id="l14.286"> MimeAddressParser.prototype = {</span>
<a href="#l14.287"></a><span id="l14.287">   classID: Components.ID(&quot;96bd8769-2d0e-4440-963d-22b97fb3ba77&quot;),</span>
<a href="#l14.288"></a><span id="l14.288">   QueryInterface: ChromeUtils.generateQI([Ci.nsIMsgHeaderParser]),</span>
<a href="#l14.289"></a><span id="l14.289"> </span>
<a href="#l14.290"></a><span id="l14.290" class="difflineminus">-  parseEncodedHeader: function (aHeader, aCharset, aPreserveGroups, count) {</span>
<a href="#l14.291"></a><span id="l14.291" class="difflineplus">+  parseEncodedHeader(aHeader, aCharset, aPreserveGroups, count) {</span>
<a href="#l14.292"></a><span id="l14.292">     aHeader = aHeader || &quot;&quot;;</span>
<a href="#l14.293"></a><span id="l14.293">     let value = MimeParser.parseHeaderField(aHeader,</span>
<a href="#l14.294"></a><span id="l14.294">       MimeParser.HEADER_ADDRESS | MimeParser.HEADER_OPTION_ALL_I18N, aCharset);</span>
<a href="#l14.295"></a><span id="l14.295">     return fixArray(value, aPreserveGroups, count);</span>
<a href="#l14.296"></a><span id="l14.296">   },</span>
<a href="#l14.297"></a><span id="l14.297" class="difflineminus">-  parseEncodedHeaderW: function (aHeader, count) {</span>
<a href="#l14.298"></a><span id="l14.298" class="difflineplus">+  parseEncodedHeaderW(aHeader, count) {</span>
<a href="#l14.299"></a><span id="l14.299">     aHeader = aHeader || &quot;&quot;;</span>
<a href="#l14.300"></a><span id="l14.300">     let value = MimeParser.parseHeaderField(aHeader,</span>
<a href="#l14.301"></a><span id="l14.301">       MimeParser.HEADER_ADDRESS |</span>
<a href="#l14.302"></a><span id="l14.302">       MimeParser.HEADER_OPTION_DECODE_2231 |</span>
<a href="#l14.303"></a><span id="l14.303">       MimeParser.HEADER_OPTION_DECODE_2047,</span>
<a href="#l14.304"></a><span id="l14.304">       undefined);</span>
<a href="#l14.305"></a><span id="l14.305">     return fixArray(value, false, count);</span>
<a href="#l14.306"></a><span id="l14.306">   },</span>
<a href="#l14.307"></a><span id="l14.307" class="difflineminus">-  parseDecodedHeader: function (aHeader, aPreserveGroups, count) {</span>
<a href="#l14.308"></a><span id="l14.308" class="difflineplus">+  parseDecodedHeader(aHeader, aPreserveGroups, count) {</span>
<a href="#l14.309"></a><span id="l14.309">     aHeader = aHeader || &quot;&quot;;</span>
<a href="#l14.310"></a><span id="l14.310">     let value = MimeParser.parseHeaderField(aHeader, MimeParser.HEADER_ADDRESS);</span>
<a href="#l14.311"></a><span id="l14.311">     return fixArray(value, aPreserveGroups, count);</span>
<a href="#l14.312"></a><span id="l14.312">   },</span>
<a href="#l14.313"></a><span id="l14.313"> </span>
<a href="#l14.314"></a><span id="l14.314" class="difflineminus">-  makeMimeHeader: function (addresses, length) {</span>
<a href="#l14.315"></a><span id="l14.315" class="difflineplus">+  makeMimeHeader(addresses, length) {</span>
<a href="#l14.316"></a><span id="l14.316">     addresses = fixXpconnectAddresses(addresses);</span>
<a href="#l14.317"></a><span id="l14.317">     // Don't output any necessary continuations, so make line length as large as</span>
<a href="#l14.318"></a><span id="l14.318">     // possible first.</span>
<a href="#l14.319"></a><span id="l14.319">     let options = {</span>
<a href="#l14.320"></a><span id="l14.320">       softMargin: 900,</span>
<a href="#l14.321"></a><span id="l14.321">       hardMargin: 900,</span>
<a href="#l14.322"></a><span id="l14.322" class="difflineminus">-      useASCII: false // We don't want RFC 2047 encoding here.</span>
<a href="#l14.323"></a><span id="l14.323" class="difflineplus">+      useASCII: false, // We don't want RFC 2047 encoding here.</span>
<a href="#l14.324"></a><span id="l14.324">     };</span>
<a href="#l14.325"></a><span id="l14.325">     let handler = new HeaderHandler();</span>
<a href="#l14.326"></a><span id="l14.326">     let emitter = new jsmime.headeremitter.makeStreamingEmitter(handler,</span>
<a href="#l14.327"></a><span id="l14.327">       options);</span>
<a href="#l14.328"></a><span id="l14.328">     emitter.addAddresses(addresses);</span>
<a href="#l14.329"></a><span id="l14.329">     emitter.finish(true);</span>
<a href="#l14.330"></a><span id="l14.330" class="difflineminus">-    return handler.value.replace(/\r\n( |$)/g, '');</span>
<a href="#l14.331"></a><span id="l14.331" class="difflineplus">+    return handler.value.replace(/\r\n( |$)/g, &quot;&quot;);</span>
<a href="#l14.332"></a><span id="l14.332">   },</span>
<a href="#l14.333"></a><span id="l14.333"> </span>
<a href="#l14.334"></a><span id="l14.334" class="difflineminus">-  extractFirstName: function (aHeader) {</span>
<a href="#l14.335"></a><span id="l14.335" class="difflineplus">+  extractFirstName(aHeader) {</span>
<a href="#l14.336"></a><span id="l14.336">     let addresses = this.parseDecodedHeader(aHeader, false);</span>
<a href="#l14.337"></a><span id="l14.337">     return (addresses.length &gt; 0) ? (addresses[0].name || addresses[0].email) : &quot;&quot;;</span>
<a href="#l14.338"></a><span id="l14.338">   },</span>
<a href="#l14.339"></a><span id="l14.339"> </span>
<a href="#l14.340"></a><span id="l14.340" class="difflineminus">-  removeDuplicateAddresses: function (aAddrs, aOtherAddrs) {</span>
<a href="#l14.341"></a><span id="l14.341" class="difflineplus">+  removeDuplicateAddresses(aAddrs, aOtherAddrs) {</span>
<a href="#l14.342"></a><span id="l14.342">     // This is actually a rather complicated algorithm, especially if we want to</span>
<a href="#l14.343"></a><span id="l14.343">     // preserve group structure. Basically, we use a set to identify which</span>
<a href="#l14.344"></a><span id="l14.344">     // headers we have seen and therefore want to remove. To work in several</span>
<a href="#l14.345"></a><span id="l14.345">     // various forms of edge cases, we need to normalize the entries in that</span>
<a href="#l14.346"></a><span id="l14.346">     // structure.</span>
<a href="#l14.347"></a><span id="l14.347">     function normalize(email) {</span>
<a href="#l14.348"></a><span id="l14.348">       // XXX: This algorithm doesn't work with IDN yet. It looks like we have to</span>
<a href="#l14.349"></a><span id="l14.349">       // convert from IDN then do lower case, but I haven't confirmed yet.</span>
<a href="#l14.350"></a><span id="l14.350">       return email.toLowerCase();</span>
<a href="#l14.351"></a><span id="l14.351">     }</span>
<a href="#l14.352"></a><span id="l14.352"> </span>
<a href="#l14.353"></a><span id="l14.353">     // The filtration function, which removes email addresses that are</span>
<a href="#l14.354"></a><span id="l14.354">     // duplicates of those we have already seen.</span>
<a href="#l14.355"></a><span id="l14.355">     function filterAccept(e) {</span>
<a href="#l14.356"></a><span id="l14.356" class="difflineminus">-      if ('email' in e) {</span>
<a href="#l14.357"></a><span id="l14.357" class="difflineplus">+      if (&quot;email&quot; in e) {</span>
<a href="#l14.358"></a><span id="l14.358">         // If we've seen the address, don't keep this one; otherwise, add it to</span>
<a href="#l14.359"></a><span id="l14.359">         // the list.</span>
<a href="#l14.360"></a><span id="l14.360">         let key = normalize(e.email);</span>
<a href="#l14.361"></a><span id="l14.361">         if (allAddresses.has(key))</span>
<a href="#l14.362"></a><span id="l14.362">           return false;</span>
<a href="#l14.363"></a><span id="l14.363">         allAddresses.add(key);</span>
<a href="#l14.364"></a><span id="l14.364">       } else {</span>
<a href="#l14.365"></a><span id="l14.365">         // Groups -&gt; filter out all the member addresses.</span>
<a href="#l14.366"></a><span id="l14.366" class="difflineat">@@ -340,68 +339,67 @@ MimeAddressParser.prototype = {</span>
<a href="#l14.367"></a><span id="l14.367">       allAddresses.add(normalize(element.email));</span>
<a href="#l14.368"></a><span id="l14.368">     }</span>
<a href="#l14.369"></a><span id="l14.369"> </span>
<a href="#l14.370"></a><span id="l14.370">     // The actual data to filter</span>
<a href="#l14.371"></a><span id="l14.371">     let filtered = this.parseDecodedHeader(aAddrs, true).filter(filterAccept);</span>
<a href="#l14.372"></a><span id="l14.372">     return this.makeMimeHeader(filtered);</span>
<a href="#l14.373"></a><span id="l14.373">   },</span>
<a href="#l14.374"></a><span id="l14.374"> </span>
<a href="#l14.375"></a><span id="l14.375" class="difflineminus">-  makeMailboxObject: function (aName, aEmail) {</span>
<a href="#l14.376"></a><span id="l14.376" class="difflineplus">+  makeMailboxObject(aName, aEmail) {</span>
<a href="#l14.377"></a><span id="l14.377">     let object = Object.create(Mailbox);</span>
<a href="#l14.378"></a><span id="l14.378">     object.name = aName;</span>
<a href="#l14.379"></a><span id="l14.379">     object.email = aEmail ? aEmail.trim() : aEmail;</span>
<a href="#l14.380"></a><span id="l14.380">     return object;</span>
<a href="#l14.381"></a><span id="l14.381">   },</span>
<a href="#l14.382"></a><span id="l14.382"> </span>
<a href="#l14.383"></a><span id="l14.383" class="difflineminus">-  makeGroupObject: function (aName, aMembers) {</span>
<a href="#l14.384"></a><span id="l14.384" class="difflineplus">+  makeGroupObject(aName, aMembers) {</span>
<a href="#l14.385"></a><span id="l14.385">     let object = Object.create(EmailGroup);</span>
<a href="#l14.386"></a><span id="l14.386">     object.name = aName;</span>
<a href="#l14.387"></a><span id="l14.387">     object.group = aMembers;</span>
<a href="#l14.388"></a><span id="l14.388">     return object;</span>
<a href="#l14.389"></a><span id="l14.389">   },</span>
<a href="#l14.390"></a><span id="l14.390"> </span>
<a href="#l14.391"></a><span id="l14.391" class="difflineminus">-  makeFromDisplayAddress: function (aDisplay, count) {</span>
<a href="#l14.392"></a><span id="l14.392" class="difflineplus">+  makeFromDisplayAddress(aDisplay, count) {</span>
<a href="#l14.393"></a><span id="l14.393">     // The basic idea is to split on every comma, so long as there is a</span>
<a href="#l14.394"></a><span id="l14.394">     // preceding @.</span>
<a href="#l14.395"></a><span id="l14.395">     let output = [];</span>
<a href="#l14.396"></a><span id="l14.396">     while (aDisplay.length) {</span>
<a href="#l14.397"></a><span id="l14.397" class="difflineminus">-      let at = aDisplay.indexOf('@');</span>
<a href="#l14.398"></a><span id="l14.398" class="difflineminus">-      let comma = aDisplay.indexOf(',', at + 1);</span>
<a href="#l14.399"></a><span id="l14.399" class="difflineplus">+      let at = aDisplay.indexOf(&quot;@&quot;);</span>
<a href="#l14.400"></a><span id="l14.400" class="difflineplus">+      let comma = aDisplay.indexOf(&quot;,&quot;, at + 1);</span>
<a href="#l14.401"></a><span id="l14.401">       let addr;</span>
<a href="#l14.402"></a><span id="l14.402">       if (comma &gt; 0) {</span>
<a href="#l14.403"></a><span id="l14.403">         addr = aDisplay.substr(0, comma);</span>
<a href="#l14.404"></a><span id="l14.404">         aDisplay = aDisplay.substr(comma + 1);</span>
<a href="#l14.405"></a><span id="l14.405">       } else {</span>
<a href="#l14.406"></a><span id="l14.406">         addr = aDisplay;</span>
<a href="#l14.407"></a><span id="l14.407">         aDisplay = &quot;&quot;;</span>
<a href="#l14.408"></a><span id="l14.408">       }</span>
<a href="#l14.409"></a><span id="l14.409">       output.push(this._makeSingleAddress(addr.trimLeft()));</span>
<a href="#l14.410"></a><span id="l14.410">     }</span>
<a href="#l14.411"></a><span id="l14.411">     if (count)</span>
<a href="#l14.412"></a><span id="l14.412">       count.value = output.length;</span>
<a href="#l14.413"></a><span id="l14.413">     return output;</span>
<a href="#l14.414"></a><span id="l14.414">   },</span>
<a href="#l14.415"></a><span id="l14.415"> </span>
<a href="#l14.416"></a><span id="l14.416" class="difflineminus">-  /// Construct a single email address from a name &lt;local@domain&gt; token.</span>
<a href="#l14.417"></a><span id="l14.417" class="difflineminus">-  _makeSingleAddress: function (aDisplayName) {</span>
<a href="#l14.418"></a><span id="l14.418" class="difflineminus">-    if (aDisplayName.includes('&lt;')) {</span>
<a href="#l14.419"></a><span id="l14.419" class="difflineminus">-      let lbracket = aDisplayName.lastIndexOf('&lt;');</span>
<a href="#l14.420"></a><span id="l14.420" class="difflineminus">-      let rbracket = aDisplayName.lastIndexOf('&gt;');</span>
<a href="#l14.421"></a><span id="l14.421" class="difflineplus">+  // Construct a single email address from a name &lt;local@domain&gt; token.</span>
<a href="#l14.422"></a><span id="l14.422" class="difflineplus">+  _makeSingleAddress(aDisplayName) {</span>
<a href="#l14.423"></a><span id="l14.423" class="difflineplus">+    if (aDisplayName.includes(&quot;&lt;&quot;)) {</span>
<a href="#l14.424"></a><span id="l14.424" class="difflineplus">+      let lbracket = aDisplayName.lastIndexOf(&quot;&lt;&quot;);</span>
<a href="#l14.425"></a><span id="l14.425" class="difflineplus">+      let rbracket = aDisplayName.lastIndexOf(&quot;&gt;&quot;);</span>
<a href="#l14.426"></a><span id="l14.426">       return this.makeMailboxObject(</span>
<a href="#l14.427"></a><span id="l14.427" class="difflineminus">-        lbracket == 0 ? '' : aDisplayName.slice(0, lbracket).trim(),</span>
<a href="#l14.428"></a><span id="l14.428" class="difflineplus">+        lbracket == 0 ? &quot;&quot; : aDisplayName.slice(0, lbracket).trim(),</span>
<a href="#l14.429"></a><span id="l14.429">         aDisplayName.slice(lbracket + 1, rbracket));</span>
<a href="#l14.430"></a><span id="l14.430" class="difflineminus">-    } else {</span>
<a href="#l14.431"></a><span id="l14.431" class="difflineminus">-      return this.makeMailboxObject('', aDisplayName);</span>
<a href="#l14.432"></a><span id="l14.432">     }</span>
<a href="#l14.433"></a><span id="l14.433" class="difflineplus">+    return this.makeMailboxObject(&quot;&quot;, aDisplayName);</span>
<a href="#l14.434"></a><span id="l14.434">   },</span>
<a href="#l14.435"></a><span id="l14.435"> </span>
<a href="#l14.436"></a><span id="l14.436">   // What follows is the deprecated API that will be removed shortly.</span>
<a href="#l14.437"></a><span id="l14.437"> </span>
<a href="#l14.438"></a><span id="l14.438" class="difflineminus">-  parseHeadersWithArray: function (aHeader, aAddrs, aNames, aFullNames) {</span>
<a href="#l14.439"></a><span id="l14.439" class="difflineplus">+  parseHeadersWithArray(aHeader, aAddrs, aNames, aFullNames) {</span>
<a href="#l14.440"></a><span id="l14.440">     let addrs = [], names = [], fullNames = [];</span>
<a href="#l14.441"></a><span id="l14.441">     let allAddresses = this.parseEncodedHeader(aHeader, undefined, false);</span>
<a href="#l14.442"></a><span id="l14.442"> </span>
<a href="#l14.443"></a><span id="l14.443">     // Don't index the dummy empty address.</span>
<a href="#l14.444"></a><span id="l14.444">     if (aHeader.trim() == &quot;&quot;)</span>
<a href="#l14.445"></a><span id="l14.445">       allAddresses = [];</span>
<a href="#l14.446"></a><span id="l14.446">     for (let address of allAddresses) {</span>
<a href="#l14.447"></a><span id="l14.447">       addrs.push(address.email);</span>
<a href="#l14.448"></a><span id="l14.448" class="difflineat">@@ -410,39 +408,39 @@ MimeAddressParser.prototype = {</span>
<a href="#l14.449"></a><span id="l14.449">     }</span>
<a href="#l14.450"></a><span id="l14.450"> </span>
<a href="#l14.451"></a><span id="l14.451">     aAddrs.value = addrs;</span>
<a href="#l14.452"></a><span id="l14.452">     aNames.value = names;</span>
<a href="#l14.453"></a><span id="l14.453">     aFullNames.value = fullNames;</span>
<a href="#l14.454"></a><span id="l14.454">     return allAddresses.length;</span>
<a href="#l14.455"></a><span id="l14.455">   },</span>
<a href="#l14.456"></a><span id="l14.456"> </span>
<a href="#l14.457"></a><span id="l14.457" class="difflineminus">-  extractHeaderAddressMailboxes: function (aLine) {</span>
<a href="#l14.458"></a><span id="l14.458" class="difflineplus">+  extractHeaderAddressMailboxes(aLine) {</span>
<a href="#l14.459"></a><span id="l14.459">     return this.parseDecodedHeader(aLine).map(addr =&gt; addr.email).join(&quot;, &quot;);</span>
<a href="#l14.460"></a><span id="l14.460">   },</span>
<a href="#l14.461"></a><span id="l14.461"> </span>
<a href="#l14.462"></a><span id="l14.462" class="difflineminus">-  makeMimeAddress: function (aName, aEmail) {</span>
<a href="#l14.463"></a><span id="l14.463" class="difflineplus">+  makeMimeAddress(aName, aEmail) {</span>
<a href="#l14.464"></a><span id="l14.464">     let object = this.makeMailboxObject(aName, aEmail);</span>
<a href="#l14.465"></a><span id="l14.465">     return this.makeMimeHeader([object]);</span>
<a href="#l14.466"></a><span id="l14.466">   },</span>
<a href="#l14.467"></a><span id="l14.467"> };</span>
<a href="#l14.468"></a><span id="l14.468"> </span>
<a href="#l14.469"></a><span id="l14.469"> function MimeConverter() {</span>
<a href="#l14.470"></a><span id="l14.470"> }</span>
<a href="#l14.471"></a><span id="l14.471"> MimeConverter.prototype = {</span>
<a href="#l14.472"></a><span id="l14.472">   classID: Components.ID(&quot;93f8c049-80ed-4dda-9000-94ad8daba44c&quot;),</span>
<a href="#l14.473"></a><span id="l14.473">   QueryInterface: ChromeUtils.generateQI([Ci.nsIMimeConverter]),</span>
<a href="#l14.474"></a><span id="l14.474"> </span>
<a href="#l14.475"></a><span id="l14.475" class="difflineminus">-  encodeMimePartIIStr_UTF8: function (aHeader, aStructured,</span>
<a href="#l14.476"></a><span id="l14.476" class="difflineplus">+  encodeMimePartIIStr_UTF8(aHeader, aStructured,</span>
<a href="#l14.477"></a><span id="l14.477">       aFieldNameLen, aLineLength) {</span>
<a href="#l14.478"></a><span id="l14.478">     // Compute the encoding options. The way our API is structured in this</span>
<a href="#l14.479"></a><span id="l14.479">     // method is really horrendous and does not align with the way that JSMime</span>
<a href="#l14.480"></a><span id="l14.480">     // handles it. Instead, we'll need to create a fake header to take into</span>
<a href="#l14.481"></a><span id="l14.481">     // account the aFieldNameLen parameter.</span>
<a href="#l14.482"></a><span id="l14.482" class="difflineminus">-    let fakeHeader = '-'.repeat(aFieldNameLen);</span>
<a href="#l14.483"></a><span id="l14.483" class="difflineplus">+    let fakeHeader = &quot;-&quot;.repeat(aFieldNameLen);</span>
<a href="#l14.484"></a><span id="l14.484">     let options = {</span>
<a href="#l14.485"></a><span id="l14.485">       softMargin: aLineLength,</span>
<a href="#l14.486"></a><span id="l14.486">       useASCII: true,</span>
<a href="#l14.487"></a><span id="l14.487">     };</span>
<a href="#l14.488"></a><span id="l14.488">     let handler = new HeaderHandler();</span>
<a href="#l14.489"></a><span id="l14.489">     let emitter = new jsmime.headeremitter.makeStreamingEmitter(handler,</span>
<a href="#l14.490"></a><span id="l14.490">       options);</span>
<a href="#l14.491"></a><span id="l14.491"> </span>
<a href="#l14.492"></a><span id="l14.492" class="difflineat">@@ -468,29 +466,29 @@ MimeConverter.prototype = {</span>
<a href="#l14.493"></a><span id="l14.493">     // Compute the output. We need to strip off the fake prefix added earlier</span>
<a href="#l14.494"></a><span id="l14.494">     // and the extra CRLF at the end.</span>
<a href="#l14.495"></a><span id="l14.495">     emitter.finish(true);</span>
<a href="#l14.496"></a><span id="l14.496">     let value = handler.value;</span>
<a href="#l14.497"></a><span id="l14.497">     value = value.replace(new RegExp(fakeHeader + &quot;:\\s*&quot;), &quot;&quot;);</span>
<a href="#l14.498"></a><span id="l14.498">     return value.substring(0, value.length - 2);</span>
<a href="#l14.499"></a><span id="l14.499">   },</span>
<a href="#l14.500"></a><span id="l14.500"> </span>
<a href="#l14.501"></a><span id="l14.501" class="difflineminus">-  decodeMimeHeader: function (aHeader, aDefaultCharset, aOverride, aUnfold) {</span>
<a href="#l14.502"></a><span id="l14.502" class="difflineplus">+  decodeMimeHeader(aHeader, aDefaultCharset, aOverride, aUnfold) {</span>
<a href="#l14.503"></a><span id="l14.503">     let value = MimeParser.parseHeaderField(aHeader,</span>
<a href="#l14.504"></a><span id="l14.504">       MimeParser.HEADER_UNSTRUCTURED | MimeParser.HEADER_OPTION_ALL_I18N,</span>
<a href="#l14.505"></a><span id="l14.505">       aDefaultCharset);</span>
<a href="#l14.506"></a><span id="l14.506">     if (aUnfold) {</span>
<a href="#l14.507"></a><span id="l14.507" class="difflineminus">-      value = value.replace(/[\r\n]\t/g, ' ')</span>
<a href="#l14.508"></a><span id="l14.508" class="difflineminus">-                   .replace(/[\r\n]/g, '');</span>
<a href="#l14.509"></a><span id="l14.509" class="difflineplus">+      value = value.replace(/[\r\n]\t/g, &quot; &quot;)</span>
<a href="#l14.510"></a><span id="l14.510" class="difflineplus">+                   .replace(/[\r\n]/g, &quot;&quot;);</span>
<a href="#l14.511"></a><span id="l14.511">     }</span>
<a href="#l14.512"></a><span id="l14.512">     return value;</span>
<a href="#l14.513"></a><span id="l14.513">   },</span>
<a href="#l14.514"></a><span id="l14.514"> </span>
<a href="#l14.515"></a><span id="l14.515">   // This is identical to the above, except for factors that are handled by the</span>
<a href="#l14.516"></a><span id="l14.516">   // xpconnect conversion process</span>
<a href="#l14.517"></a><span id="l14.517" class="difflineminus">-  decodeMimeHeaderToUTF8: function (...aArgs) {</span>
<a href="#l14.518"></a><span id="l14.518" class="difflineplus">+  decodeMimeHeaderToUTF8(...aArgs) {</span>
<a href="#l14.519"></a><span id="l14.519">     return this.decodeMimeHeader(...aArgs);</span>
<a href="#l14.520"></a><span id="l14.520">   },</span>
<a href="#l14.521"></a><span id="l14.521"> };</span>
<a href="#l14.522"></a><span id="l14.522"> </span>
<a href="#l14.523"></a><span id="l14.523"> var components = [MimeHeaders, MimeWritableStructuredHeaders, MimeAddressParser,</span>
<a href="#l14.524"></a><span id="l14.524">   MimeConverter];</span>
<a href="#l14.525"></a><span id="l14.525"> var NSGetFactory = XPCOMUtils.generateNSGetFactory(components);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/mime/src/mimeParser.jsm</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/mime/src/mimeParser.jsm</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -1,38 +1,36 @@</span>
<a href="#l15.4"></a><span id="l15.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.5"></a><span id="l15.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l15.6"></a><span id="l15.6">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l15.7"></a><span id="l15.7"> // vim:set ts=2 sw=2 sts=2 et ft=javascript:</span>
<a href="#l15.8"></a><span id="l15.8"> </span>
<a href="#l15.9"></a><span id="l15.9" class="difflineminus">-var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l15.11"></a><span id="l15.11"> const {jsmime} = ChromeUtils.import(&quot;resource:///modules/jsmime.jsm&quot;);</span>
<a href="#l15.12"></a><span id="l15.12"> </span>
<a href="#l15.13"></a><span id="l15.13"> var EXPORTED_SYMBOLS = [&quot;MimeParser&quot;];</span>
<a href="#l15.14"></a><span id="l15.14"> </span>
<a href="#l15.15"></a><span id="l15.15"> // Emitter helpers, for internal functions later on.</span>
<a href="#l15.16"></a><span id="l15.16"> var ExtractHeadersEmitter = {</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">-  startPart: function (partNum, headers) {</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">-    if (partNum == '') {</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+  startPart(partNum, headers) {</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineplus">+    if (partNum == &quot;&quot;) {</span>
<a href="#l15.21"></a><span id="l15.21">       this.headers = headers;</span>
<a href="#l15.22"></a><span id="l15.22">     }</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineminus">-  }</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+  },</span>
<a href="#l15.25"></a><span id="l15.25"> };</span>
<a href="#l15.26"></a><span id="l15.26"> </span>
<a href="#l15.27"></a><span id="l15.27"> var ExtractHeadersAndBodyEmitter = {</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineminus">-  body: '',</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineplus">+  body: &quot;&quot;,</span>
<a href="#l15.30"></a><span id="l15.30">   startPart: ExtractHeadersEmitter.startPart,</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-  deliverPartData: function (partNum, data) {</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineminus">-    if (partNum == '')</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+  deliverPartData(partNum, data) {</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+    if (partNum == &quot;&quot;)</span>
<a href="#l15.35"></a><span id="l15.35">       this.body += data;</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineminus">-  }</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+  },</span>
<a href="#l15.38"></a><span id="l15.38"> };</span>
<a href="#l15.39"></a><span id="l15.39"> </span>
<a href="#l15.40"></a><span id="l15.40" class="difflineminus">-/// Sets appropriate default options for chrome-privileged environments</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineplus">+// Sets appropriate default options for chrome-privileged environments</span>
<a href="#l15.42"></a><span id="l15.42"> function setDefaultParserOptions(opts) {</span>
<a href="#l15.43"></a><span id="l15.43">   if (!(&quot;onerror&quot; in opts)) {</span>
<a href="#l15.44"></a><span id="l15.44">     opts.onerror = Cu.reportError;</span>
<a href="#l15.45"></a><span id="l15.45">   }</span>
<a href="#l15.46"></a><span id="l15.46"> }</span>
<a href="#l15.47"></a><span id="l15.47"> </span>
<a href="#l15.48"></a><span id="l15.48"> var MimeParser = {</span>
<a href="#l15.49"></a><span id="l15.49">   /**</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineat">@@ -42,17 +40,17 @@ var MimeParser = {</span>
<a href="#l15.51"></a><span id="l15.51">    * closed upon completion. Both blocking and nonblocking streams are</span>
<a href="#l15.52"></a><span id="l15.52">    * supported by this implementation, but it is still guaranteed that the first</span>
<a href="#l15.53"></a><span id="l15.53">    * callback will not happen before this method returns.</span>
<a href="#l15.54"></a><span id="l15.54">    *</span>
<a href="#l15.55"></a><span id="l15.55">    * @param input   An input stream of text to parse.</span>
<a href="#l15.56"></a><span id="l15.56">    * @param emitter The emitter to receive callbacks on.</span>
<a href="#l15.57"></a><span id="l15.57">    * @param opts    A set of options for the parser.</span>
<a href="#l15.58"></a><span id="l15.58">    */</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineminus">-  parseAsync: function MimeParser_parseAsync(input, emitter, opts) {</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineplus">+  parseAsync(input, emitter, opts) {</span>
<a href="#l15.61"></a><span id="l15.61">     // Normalize the input into an input stream.</span>
<a href="#l15.62"></a><span id="l15.62">     if (!(input instanceof Ci.nsIInputStream)) {</span>
<a href="#l15.63"></a><span id="l15.63">       throw new Error(&quot;input is not a recognizable type!&quot;);</span>
<a href="#l15.64"></a><span id="l15.64">     }</span>
<a href="#l15.65"></a><span id="l15.65"> </span>
<a href="#l15.66"></a><span id="l15.66">     // We need a pump for the listener</span>
<a href="#l15.67"></a><span id="l15.67">     var pump = Cc[&quot;@mozilla.org/network/input-stream-pump;1&quot;]</span>
<a href="#l15.68"></a><span id="l15.68">                  .createInstance(Ci.nsIInputStreamPump);</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineat">@@ -69,112 +67,110 @@ var MimeParser = {</span>
<a href="#l15.70"></a><span id="l15.70">    *</span>
<a href="#l15.71"></a><span id="l15.71">    * The input is a string that is immediately parsed, calling all functions on</span>
<a href="#l15.72"></a><span id="l15.72">    * the emitter before this function returns.</span>
<a href="#l15.73"></a><span id="l15.73">    *</span>
<a href="#l15.74"></a><span id="l15.74">    * @param input   A string or input stream of text to parse.</span>
<a href="#l15.75"></a><span id="l15.75">    * @param emitter The emitter to receive callbacks on.</span>
<a href="#l15.76"></a><span id="l15.76">    * @param opts    A set of options for the parser.</span>
<a href="#l15.77"></a><span id="l15.77">    */</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineminus">-  parseSync: function MimeParser_parseSync(input, emitter, opts) {</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineplus">+  parseSync(input, emitter, opts) {</span>
<a href="#l15.80"></a><span id="l15.80">     // We only support string parsing if we are trying to do this parse</span>
<a href="#l15.81"></a><span id="l15.81">     // synchronously.</span>
<a href="#l15.82"></a><span id="l15.82">     if (typeof input != &quot;string&quot;) {</span>
<a href="#l15.83"></a><span id="l15.83">       throw new Error(&quot;input is not a recognizable type!&quot;);</span>
<a href="#l15.84"></a><span id="l15.84">     }</span>
<a href="#l15.85"></a><span id="l15.85">     setDefaultParserOptions(opts);</span>
<a href="#l15.86"></a><span id="l15.86">     var parser = new jsmime.MimeParser(emitter, opts);</span>
<a href="#l15.87"></a><span id="l15.87">     parser.deliverData(input);</span>
<a href="#l15.88"></a><span id="l15.88">     parser.deliverEOF();</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineminus">-    return;</span>
<a href="#l15.90"></a><span id="l15.90">   },</span>
<a href="#l15.91"></a><span id="l15.91"> </span>
<a href="#l15.92"></a><span id="l15.92">   /**</span>
<a href="#l15.93"></a><span id="l15.93">    * Returns a stream listener that feeds data into a parser.</span>
<a href="#l15.94"></a><span id="l15.94">    *</span>
<a href="#l15.95"></a><span id="l15.95">    * In addition to the functions on the emitter that the parser may use, the</span>
<a href="#l15.96"></a><span id="l15.96">    * generated stream listener will also make calls to onStartRequest and</span>
<a href="#l15.97"></a><span id="l15.97">    * onStopRequest on the emitter (if they exist).</span>
<a href="#l15.98"></a><span id="l15.98">    *</span>
<a href="#l15.99"></a><span id="l15.99">    * @param emitter The emitter to receive callbacks on.</span>
<a href="#l15.100"></a><span id="l15.100">    * @param opts    A set of options for the parser.</span>
<a href="#l15.101"></a><span id="l15.101">    */</span>
<a href="#l15.102"></a><span id="l15.102" class="difflineminus">-  makeStreamListenerParser: function MimeParser_makeSLParser(emitter, opts) {</span>
<a href="#l15.103"></a><span id="l15.103" class="difflineplus">+  makeStreamListenerParser(emitter, opts) {</span>
<a href="#l15.104"></a><span id="l15.104">     var StreamListener = {</span>
<a href="#l15.105"></a><span id="l15.105" class="difflineminus">-      onStartRequest: function SLP_onStartRequest(aRequest) {</span>
<a href="#l15.106"></a><span id="l15.106" class="difflineplus">+      onStartRequest(aRequest) {</span>
<a href="#l15.107"></a><span id="l15.107">         try {</span>
<a href="#l15.108"></a><span id="l15.108">           if (&quot;onStartRequest&quot; in emitter)</span>
<a href="#l15.109"></a><span id="l15.109">             emitter.onStartRequest(aRequest);</span>
<a href="#l15.110"></a><span id="l15.110">         } finally {</span>
<a href="#l15.111"></a><span id="l15.111">           this._parser.resetParser();</span>
<a href="#l15.112"></a><span id="l15.112">         }</span>
<a href="#l15.113"></a><span id="l15.113">       },</span>
<a href="#l15.114"></a><span id="l15.114" class="difflineminus">-      onStopRequest: function SLP_onStopRequest(aRequest, aStatus) {</span>
<a href="#l15.115"></a><span id="l15.115" class="difflineplus">+      onStopRequest(aRequest, aStatus) {</span>
<a href="#l15.116"></a><span id="l15.116">         this._parser.deliverEOF();</span>
<a href="#l15.117"></a><span id="l15.117">         if (&quot;onStopRequest&quot; in emitter)</span>
<a href="#l15.118"></a><span id="l15.118">           emitter.onStopRequest(aRequest, aStatus);</span>
<a href="#l15.119"></a><span id="l15.119">       },</span>
<a href="#l15.120"></a><span id="l15.120" class="difflineminus">-      onDataAvailable: function SLP_onData(aRequest, aStream,</span>
<a href="#l15.121"></a><span id="l15.121" class="difflineminus">-                                           aOffset, aCount) {</span>
<a href="#l15.122"></a><span id="l15.122" class="difflineplus">+      onDataAvailable(aRequest, aStream, aOffset, aCount) {</span>
<a href="#l15.123"></a><span id="l15.123">         var scriptIn = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l15.124"></a><span id="l15.124">                          .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l15.125"></a><span id="l15.125">         scriptIn.init(aStream);</span>
<a href="#l15.126"></a><span id="l15.126">         // Use readBytes instead of read to handle embedded NULs properly.</span>
<a href="#l15.127"></a><span id="l15.127">         this._parser.deliverData(scriptIn.readBytes(aCount));</span>
<a href="#l15.128"></a><span id="l15.128">       },</span>
<a href="#l15.129"></a><span id="l15.129">       QueryInterface: ChromeUtils.generateQI([Ci.nsIStreamListener,</span>
<a href="#l15.130"></a><span id="l15.130" class="difflineminus">-        Ci.nsIRequestObserver])</span>
<a href="#l15.131"></a><span id="l15.131" class="difflineplus">+        Ci.nsIRequestObserver]),</span>
<a href="#l15.132"></a><span id="l15.132">     };</span>
<a href="#l15.133"></a><span id="l15.133">     setDefaultParserOptions(opts);</span>
<a href="#l15.134"></a><span id="l15.134">     StreamListener._parser = new jsmime.MimeParser(emitter, opts);</span>
<a href="#l15.135"></a><span id="l15.135">     return StreamListener;</span>
<a href="#l15.136"></a><span id="l15.136">   },</span>
<a href="#l15.137"></a><span id="l15.137"> </span>
<a href="#l15.138"></a><span id="l15.138">   /**</span>
<a href="#l15.139"></a><span id="l15.139">    * Returns a new raw MIME parser.</span>
<a href="#l15.140"></a><span id="l15.140">    *</span>
<a href="#l15.141"></a><span id="l15.141">    * Prefer one of the other methods where possible, since the input here must</span>
<a href="#l15.142"></a><span id="l15.142">    * be driven manually.</span>
<a href="#l15.143"></a><span id="l15.143">    *</span>
<a href="#l15.144"></a><span id="l15.144">    * @param emitter The emitter to receive callbacks on.</span>
<a href="#l15.145"></a><span id="l15.145">    * @param opts    A set of options for the parser.</span>
<a href="#l15.146"></a><span id="l15.146">    */</span>
<a href="#l15.147"></a><span id="l15.147" class="difflineminus">-  makeParser: function MimeParser_makeParser(emitter, opts) {</span>
<a href="#l15.148"></a><span id="l15.148" class="difflineplus">+  makeParser(emitter, opts) {</span>
<a href="#l15.149"></a><span id="l15.149">     setDefaultParserOptions(opts);</span>
<a href="#l15.150"></a><span id="l15.150">     return new jsmime.MimeParser(emitter, opts);</span>
<a href="#l15.151"></a><span id="l15.151">   },</span>
<a href="#l15.152"></a><span id="l15.152"> </span>
<a href="#l15.153"></a><span id="l15.153">   /**</span>
<a href="#l15.154"></a><span id="l15.154">    * Returns a dictionary of headers for the given input.</span>
<a href="#l15.155"></a><span id="l15.155">    *</span>
<a href="#l15.156"></a><span id="l15.156">    * The input is any type of input that would be accepted by parseSync. What</span>
<a href="#l15.157"></a><span id="l15.157">    * is returned is a JS object that represents the headers of the entire</span>
<a href="#l15.158"></a><span id="l15.158">    * envelope as would be received by startPart when partNum is the empty</span>
<a href="#l15.159"></a><span id="l15.159">    * string.</span>
<a href="#l15.160"></a><span id="l15.160">    *</span>
<a href="#l15.161"></a><span id="l15.161">    * @param input   A string of text to parse.</span>
<a href="#l15.162"></a><span id="l15.162">    */</span>
<a href="#l15.163"></a><span id="l15.163" class="difflineminus">-  extractHeaders: function MimeParser_extractHeaders(input) {</span>
<a href="#l15.164"></a><span id="l15.164" class="difflineplus">+  extractHeaders(input) {</span>
<a href="#l15.165"></a><span id="l15.165">     var emitter = Object.create(ExtractHeadersEmitter);</span>
<a href="#l15.166"></a><span id="l15.166" class="difflineminus">-    MimeParser.parseSync(input, emitter, {pruneat: '', bodyformat: 'none'});</span>
<a href="#l15.167"></a><span id="l15.167" class="difflineplus">+    MimeParser.parseSync(input, emitter, {pruneat: &quot;&quot;, bodyformat: &quot;none&quot;});</span>
<a href="#l15.168"></a><span id="l15.168">     return emitter.headers;</span>
<a href="#l15.169"></a><span id="l15.169">   },</span>
<a href="#l15.170"></a><span id="l15.170"> </span>
<a href="#l15.171"></a><span id="l15.171">   /**</span>
<a href="#l15.172"></a><span id="l15.172">    * Returns the headers and body for the given input message.</span>
<a href="#l15.173"></a><span id="l15.173">    *</span>
<a href="#l15.174"></a><span id="l15.174">    * The return value is an array whose first element is the dictionary of</span>
<a href="#l15.175"></a><span id="l15.175">    * headers (as would be returned by extractHeaders) and whose second element</span>
<a href="#l15.176"></a><span id="l15.176">    * is a binary string of the entire body of the message.</span>
<a href="#l15.177"></a><span id="l15.177">    *</span>
<a href="#l15.178"></a><span id="l15.178">    * @param input   A string of text to parse.</span>
<a href="#l15.179"></a><span id="l15.179">    */</span>
<a href="#l15.180"></a><span id="l15.180" class="difflineminus">-  extractHeadersAndBody: function MimeParser_extractHeaders(input) {</span>
<a href="#l15.181"></a><span id="l15.181" class="difflineplus">+  extractHeadersAndBody(input) {</span>
<a href="#l15.182"></a><span id="l15.182">     var emitter = Object.create(ExtractHeadersAndBodyEmitter);</span>
<a href="#l15.183"></a><span id="l15.183" class="difflineminus">-    MimeParser.parseSync(input, emitter, {pruneat: '', bodyformat: 'raw'});</span>
<a href="#l15.184"></a><span id="l15.184" class="difflineplus">+    MimeParser.parseSync(input, emitter, {pruneat: &quot;&quot;, bodyformat: &quot;raw&quot;});</span>
<a href="#l15.185"></a><span id="l15.185">     return [emitter.headers, emitter.body];</span>
<a href="#l15.186"></a><span id="l15.186">   },</span>
<a href="#l15.187"></a><span id="l15.187"> </span>
<a href="#l15.188"></a><span id="l15.188">   // Parameters for parseHeaderField</span>
<a href="#l15.189"></a><span id="l15.189"> </span>
<a href="#l15.190"></a><span id="l15.190">   /**</span>
<a href="#l15.191"></a><span id="l15.191">    * Parse the header as if it were unstructured.</span>
<a href="#l15.192"></a><span id="l15.192">    *</span>
<a href="#l15.193"></a><span id="l15.193" class="difflineat">@@ -204,17 +200,17 @@ var MimeParser = {</span>
<a href="#l15.194"></a><span id="l15.194">    * This decodes the inline encoded-words that are in RFC 2047.</span>
<a href="#l15.195"></a><span id="l15.195">    */</span>
<a href="#l15.196"></a><span id="l15.196">   HEADER_OPTION_DECODE_2047: 0x20,</span>
<a href="#l15.197"></a><span id="l15.197">   /**</span>
<a href="#l15.198"></a><span id="l15.198">    * This converts the header from a raw string to proper Unicode.</span>
<a href="#l15.199"></a><span id="l15.199">    */</span>
<a href="#l15.200"></a><span id="l15.200">   HEADER_OPTION_ALLOW_RAW:   0x40,</span>
<a href="#l15.201"></a><span id="l15.201"> </span>
<a href="#l15.202"></a><span id="l15.202" class="difflineminus">-  /// Convenience for all three of the above.</span>
<a href="#l15.203"></a><span id="l15.203" class="difflineplus">+  // Convenience for all three of the above.</span>
<a href="#l15.204"></a><span id="l15.204">   HEADER_OPTION_ALL_I18N:    0x70,</span>
<a href="#l15.205"></a><span id="l15.205"> </span>
<a href="#l15.206"></a><span id="l15.206">   /**</span>
<a href="#l15.207"></a><span id="l15.207">    * Parse a header field according to the specification given by flags.</span>
<a href="#l15.208"></a><span id="l15.208">    *</span>
<a href="#l15.209"></a><span id="l15.209">    * Permissible flags begin with one of the HEADER_* flags, which may be or'd</span>
<a href="#l15.210"></a><span id="l15.210">    * with any of the HEADER_OPTION_* flags to modify the result appropriately.</span>
<a href="#l15.211"></a><span id="l15.211">    *</span>
<a href="#l15.212"></a><span id="l15.212" class="difflineat">@@ -224,17 +220,17 @@ var MimeParser = {</span>
<a href="#l15.213"></a><span id="l15.213">    * is not provided, then no fallback decoding will be done. If</span>
<a href="#l15.214"></a><span id="l15.214">    * HEADER_OPTION_ALLOW_RAW is not passed, then no attempt will be made to</span>
<a href="#l15.215"></a><span id="l15.215">    * convert charsets.</span>
<a href="#l15.216"></a><span id="l15.216">    *</span>
<a href="#l15.217"></a><span id="l15.217">    * @param text    The value of a MIME or message header to parse.</span>
<a href="#l15.218"></a><span id="l15.218">    * @param flags   A set of flags that controls interpretation of the header.</span>
<a href="#l15.219"></a><span id="l15.219">    * @param charset A default charset to assume if no information may be found.</span>
<a href="#l15.220"></a><span id="l15.220">    */</span>
<a href="#l15.221"></a><span id="l15.221" class="difflineminus">-  parseHeaderField: function MimeParser_parseHeaderField(text, flags, charset) {</span>
<a href="#l15.222"></a><span id="l15.222" class="difflineplus">+  parseHeaderField(text, flags, charset) {</span>
<a href="#l15.223"></a><span id="l15.223">     // If we have a raw string, convert it to Unicode first</span>
<a href="#l15.224"></a><span id="l15.224">     if (flags &amp; MimeParser.HEADER_OPTION_ALLOW_RAW)</span>
<a href="#l15.225"></a><span id="l15.225">       text = jsmime.headerparser.convert8BitHeader(text, charset);</span>
<a href="#l15.226"></a><span id="l15.226"> </span>
<a href="#l15.227"></a><span id="l15.227">     // The low 4 bits indicate the type of the header we are parsing. All of the</span>
<a href="#l15.228"></a><span id="l15.228">     // higher-order bits are flags.</span>
<a href="#l15.229"></a><span id="l15.229">     switch (flags &amp; 0x0f) {</span>
<a href="#l15.230"></a><span id="l15.230">     case MimeParser.HEADER_UNSTRUCTURED:</span>
<a href="#l15.231"></a><span id="l15.231" class="difflineat">@@ -244,12 +240,12 @@ var MimeParser = {</span>
<a href="#l15.232"></a><span id="l15.232">     case MimeParser.HEADER_PARAMETER:</span>
<a href="#l15.233"></a><span id="l15.233">       return jsmime.headerparser.parseParameterHeader(text,</span>
<a href="#l15.234"></a><span id="l15.234">         (flags &amp; MimeParser.HEADER_OPTION_DECODE_2047) != 0,</span>
<a href="#l15.235"></a><span id="l15.235">         (flags &amp; MimeParser.HEADER_OPTION_DECODE_2231) != 0);</span>
<a href="#l15.236"></a><span id="l15.236">     case MimeParser.HEADER_ADDRESS:</span>
<a href="#l15.237"></a><span id="l15.237">       return jsmime.headerparser.parseAddressingHeader(text,</span>
<a href="#l15.238"></a><span id="l15.238">         (flags &amp; MimeParser.HEADER_OPTION_DECODE_2047) != 0);</span>
<a href="#l15.239"></a><span id="l15.239">     default:</span>
<a href="#l15.240"></a><span id="l15.240" class="difflineminus">-      throw &quot;Illegal type of header field&quot;;</span>
<a href="#l15.241"></a><span id="l15.241" class="difflineplus">+      throw new Error(&quot;Illegal type of header field&quot;);</span>
<a href="#l15.242"></a><span id="l15.242">     }</span>
<a href="#l15.243"></a><span id="l15.243">   },</span>
<a href="#l15.244"></a><span id="l15.244"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/mime/src/mimemcms.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/mime/src/mimemcms.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -87,17 +87,16 @@ typedef struct MimeMultCMSdata {</span>
<a href="#l16.4"></a><span id="l16.4">         self(nullptr),</span>
<a href="#l16.5"></a><span id="l16.5">         parent_is_encrypted_p(false),</span>
<a href="#l16.6"></a><span id="l16.6">         parent_holds_stamp_p(false) {}</span>
<a href="#l16.7"></a><span id="l16.7"> </span>
<a href="#l16.8"></a><span id="l16.8">   ~MimeMultCMSdata() {</span>
<a href="#l16.9"></a><span id="l16.9">     PR_FREEIF(sender_addr);</span>
<a href="#l16.10"></a><span id="l16.10"> </span>
<a href="#l16.11"></a><span id="l16.11">     // Do a graceful shutdown of the nsICMSDecoder and release the nsICMSMessage</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-    // //</span>
<a href="#l16.13"></a><span id="l16.13">     if (sig_decoder_context) {</span>
<a href="#l16.14"></a><span id="l16.14">       nsCOMPtr&lt;nsICMSMessage&gt; cinfo;</span>
<a href="#l16.15"></a><span id="l16.15">       sig_decoder_context-&gt;Finish(getter_AddRefs(cinfo));</span>
<a href="#l16.16"></a><span id="l16.16">     }</span>
<a href="#l16.17"></a><span id="l16.17"> </span>
<a href="#l16.18"></a><span id="l16.18">     delete[] item_data;</span>
<a href="#l16.19"></a><span id="l16.19">   }</span>
<a href="#l16.20"></a><span id="l16.20"> } MimeMultCMSdata;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1">new file mode 100644</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineminus">--- /dev/null</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineplus">+++ b/mailnews/mime/test/unit/.eslintrc.js</span>
<a href="#l17.4"></a><span id="l17.4" class="difflineat">@@ -0,0 +1,14 @@</span>
<a href="#l17.5"></a><span id="l17.5" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l17.6"></a><span id="l17.6" class="difflineplus">+</span>
<a href="#l17.7"></a><span id="l17.7" class="difflineplus">+module.exports = {</span>
<a href="#l17.8"></a><span id="l17.8" class="difflineplus">+  &quot;extends&quot;: &quot;plugin:mozilla/xpcshell-test&quot;,</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineplus">+</span>
<a href="#l17.10"></a><span id="l17.10" class="difflineplus">+  &quot;rules&quot;: {</span>
<a href="#l17.11"></a><span id="l17.11" class="difflineplus">+    &quot;func-names&quot;: &quot;off&quot;,</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+    &quot;mozilla/import-headjs-globals&quot;: &quot;error&quot;,</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+    &quot;no-unused-vars&quot;: [&quot;error&quot;, {</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+      &quot;args&quot;: &quot;none&quot;,</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+      &quot;vars&quot;: &quot;all&quot;,</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+    }],</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+  },</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/mime/test/unit/custom_header.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/mime/test/unit/custom_header.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -1,9 +1,11 @@</span>
<a href="#l18.4"></a><span id="l18.4"> // Custom header support for testing structured_headers.js</span>
<a href="#l18.5"></a><span id="l18.5"> </span>
<a href="#l18.6"></a><span id="l18.6" class="difflineminus">-jsmime.headerparser.addStructuredDecoder(&quot;X-Unusual&quot;, function (hdrs) {</span>
<a href="#l18.7"></a><span id="l18.7" class="difflineplus">+/* globals jsmime */</span>
<a href="#l18.8"></a><span id="l18.8" class="difflineplus">+</span>
<a href="#l18.9"></a><span id="l18.9" class="difflineplus">+jsmime.headerparser.addStructuredDecoder(&quot;X-Unusual&quot;, function(hdrs) {</span>
<a href="#l18.10"></a><span id="l18.10">   return Number.parseInt(hdrs[hdrs.length - 1], 16);</span>
<a href="#l18.11"></a><span id="l18.11"> });</span>
<a href="#l18.12"></a><span id="l18.12"> </span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-jsmime.headeremitter.addStructuredEncoder(&quot;X-Unusual&quot;, function (val) {</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+jsmime.headeremitter.addStructuredEncoder(&quot;X-Unusual&quot;, function(val) {</span>
<a href="#l18.15"></a><span id="l18.15">   this.addUnstructured(val.toString(16));</span>
<a href="#l18.16"></a><span id="l18.16"> });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/mime/test/unit/head_mime.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/mime/test/unit/head_mime.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -5,17 +5,17 @@</span>
<a href="#l19.4"></a><span id="l19.4"> /**</span>
<a href="#l19.5"></a><span id="l19.5">  * Utility code for converting encoded MIME data.</span>
<a href="#l19.6"></a><span id="l19.6">  */</span>
<a href="#l19.7"></a><span id="l19.7"> </span>
<a href="#l19.8"></a><span id="l19.8"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l19.9"></a><span id="l19.9"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l19.10"></a><span id="l19.10"> var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l19.11"></a><span id="l19.11"> var {mailTestUtils} = ChromeUtils.import(&quot;resource://testing-common/mailnews/mailTestUtils.js&quot;);</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-var {promiseTestUtils} = ChromeUtils.import(&quot;resource://testing-common/mailnews/PromiseTestUtils.jsm&quot;);</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+var {PromiseTestUtils} = ChromeUtils.import(&quot;resource://testing-common/mailnews/PromiseTestUtils.jsm&quot;);</span>
<a href="#l19.14"></a><span id="l19.14"> const {NetUtil} = ChromeUtils.import(&quot;resource://gre/modules/NetUtil.jsm&quot;);</span>
<a href="#l19.15"></a><span id="l19.15"> </span>
<a href="#l19.16"></a><span id="l19.16"> var CC = Components.Constructor;</span>
<a href="#l19.17"></a><span id="l19.17"> </span>
<a href="#l19.18"></a><span id="l19.18"> // Ensure the profile directory is set up</span>
<a href="#l19.19"></a><span id="l19.19"> do_get_profile();</span>
<a href="#l19.20"></a><span id="l19.20"> </span>
<a href="#l19.21"></a><span id="l19.21"> var gDEPTH = &quot;../../../../&quot;;</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineat">@@ -26,52 +26,52 @@ registerCleanupFunction(function() {</span>
<a href="#l19.23"></a><span id="l19.23"> </span>
<a href="#l19.24"></a><span id="l19.24"> class DummyMsgHeader {</span>
<a href="#l19.25"></a><span id="l19.25">   constructor() {</span>
<a href="#l19.26"></a><span id="l19.26">     this.mProperties = {};</span>
<a href="#l19.27"></a><span id="l19.27">     this.messageSize = 0;</span>
<a href="#l19.28"></a><span id="l19.28">     this.recipients = null;</span>
<a href="#l19.29"></a><span id="l19.29">     this.from = null;</span>
<a href="#l19.30"></a><span id="l19.30">     this.subject = &quot;&quot;;</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">-    this.ccList = null,</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineminus">-    this.messageId = null,</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineminus">-    this.listPost = null,</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineminus">-    this.date = 0,</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineminus">-    this.accountKey = &quot;&quot;,</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineminus">-    this.flags = 0,</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineminus">-    this.folder = null</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineplus">+    this.ccList = null;</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineplus">+    this.messageId = null;</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineplus">+    this.listPost = null;</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineplus">+    this.date = 0;</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineplus">+    this.accountKey = &quot;&quot;;</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineplus">+    this.flags = 0;</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineplus">+    this.folder = null;</span>
<a href="#l19.45"></a><span id="l19.45">   }</span>
<a href="#l19.46"></a><span id="l19.46">   getStringProperty(aProperty) { return this.mProperties[aProperty]; }</span>
<a href="#l19.47"></a><span id="l19.47">   setStringProperty(aProperty, aVal) { this.mProperties[aProperty] = aVal; }</span>
<a href="#l19.48"></a><span id="l19.48">   getUint32Property(aProperty) {</span>
<a href="#l19.49"></a><span id="l19.49">     if (aProperty in this.mProperties)</span>
<a href="#l19.50"></a><span id="l19.50">       return parseInt(this.mProperties[aProperty]);</span>
<a href="#l19.51"></a><span id="l19.51">     return 0;</span>
<a href="#l19.52"></a><span id="l19.52">   }</span>
<a href="#l19.53"></a><span id="l19.53">   setUint32Property(aProperty, aVal) {</span>
<a href="#l19.54"></a><span id="l19.54">     this.mProperties[aProperty] = aVal.toString();</span>
<a href="#l19.55"></a><span id="l19.55">   }</span>
<a href="#l19.56"></a><span id="l19.56">   markHasAttachments(hasAttachments) { }</span>
<a href="#l19.57"></a><span id="l19.57">   get mime2DecodedSubject() { return this.subject; }</span>
<a href="#l19.58"></a><span id="l19.58"> }</span>
<a href="#l19.59"></a><span id="l19.59"> </span>
<a href="#l19.60"></a><span id="l19.60" class="difflineminus">-function apply_mime_conversion(msgUri, headerSink={}) {</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineplus">+function apply_mime_conversion(msgUri, headerSink = {}) {</span>
<a href="#l19.62"></a><span id="l19.62">   let stubHeaderSink = {</span>
<a href="#l19.63"></a><span id="l19.63">     processHeaders(aHeaderNames, aHeaderValues, dontCollectAddress) {},</span>
<a href="#l19.64"></a><span id="l19.64">     handleAttachment(contentType, url, displayName, uri, aNotDownloaded) {},</span>
<a href="#l19.65"></a><span id="l19.65">     addAttachmentField(field, value) {},</span>
<a href="#l19.66"></a><span id="l19.66">     onEndAllAttachments() {},</span>
<a href="#l19.67"></a><span id="l19.67">     onEndMsgHeaders(url) {},</span>
<a href="#l19.68"></a><span id="l19.68">     onEndMsgDownload(url) {},</span>
<a href="#l19.69"></a><span id="l19.69">     securityInfo: null,</span>
<a href="#l19.70"></a><span id="l19.70">     onMsgHasRemoteContent(aMsgHdr, aContentURI) {},</span>
<a href="#l19.71"></a><span id="l19.71">     dummyMsgHeader: new DummyMsgHeader(),</span>
<a href="#l19.72"></a><span id="l19.72">     get properties() { return null; },</span>
<a href="#l19.73"></a><span id="l19.73">     resetProperties() {},</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineminus">-    QueryInterface: ChromeUtils.generateQI([Ci.nsIMsgHeaderSink])</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineplus">+    QueryInterface: ChromeUtils.generateQI([Ci.nsIMsgHeaderSink]),</span>
<a href="#l19.76"></a><span id="l19.76">   };</span>
<a href="#l19.77"></a><span id="l19.77"> </span>
<a href="#l19.78"></a><span id="l19.78">   // Copy the descriptors from headerSink to stubHeaderSink.</span>
<a href="#l19.79"></a><span id="l19.79">   let fullHeaderSink = Object.create(headerSink);</span>
<a href="#l19.80"></a><span id="l19.80">   for (let name of Object.getOwnPropertyNames(stubHeaderSink)) {</span>
<a href="#l19.81"></a><span id="l19.81">     if (!(name in headerSink)) {</span>
<a href="#l19.82"></a><span id="l19.82">       Object.defineProperty(fullHeaderSink, name,</span>
<a href="#l19.83"></a><span id="l19.83">         Object.getOwnPropertyDescriptor(stubHeaderSink, name));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/mime/test/unit/test_EncodeMimePartIIStr_UTF8.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/mime/test/unit/test_EncodeMimePartIIStr_UTF8.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -4,27 +4,25 @@</span>
<a href="#l20.4"></a><span id="l20.4"> </span>
<a href="#l20.5"></a><span id="l20.5"> // This tests minimal mime encoding fixed in bug 458685</span>
<a href="#l20.6"></a><span id="l20.6"> </span>
<a href="#l20.7"></a><span id="l20.7"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l20.8"></a><span id="l20.8"> </span>
<a href="#l20.9"></a><span id="l20.9"> function run_test() {</span>
<a href="#l20.10"></a><span id="l20.10">   var i;</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-  var checks =</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-  [</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+  var checks = [</span>
<a href="#l20.15"></a><span id="l20.15">     [&quot;&quot;, false, &quot;&quot;],</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineminus">-    [&quot;\u0436&quot;, false, &quot;=?UTF-8?B?0LY=?=&quot;], //CYRILLIC SMALL LETTER ZHE</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineplus">+    [&quot;\u0436&quot;, false, &quot;=?UTF-8?B?0LY=?=&quot;], // CYRILLIC SMALL LETTER ZHE</span>
<a href="#l20.18"></a><span id="l20.18">     [&quot;IamASCII&quot;, false, &quot;IamASCII&quot;],</span>
<a href="#l20.19"></a><span id="l20.19">     // Although an invalid email, we shouldn't crash on it (bug 479206)</span>
<a href="#l20.20"></a><span id="l20.20">     [&quot;crash test@foo.invalid&gt;&quot;, true, &quot;\&quot;crash test\&quot;@foo.invalid&quot;],</span>
<a href="#l20.21"></a><span id="l20.21">     [&quot;MXR now displays links to Github log &amp; Blame for\r\n Gaia/Rust/Servo&quot;, false,</span>
<a href="#l20.22"></a><span id="l20.22">      &quot;MXR now displays links to Github log &amp; Blame for\r\n Gaia/Rust/Servo&quot;],</span>
<a href="#l20.23"></a><span id="l20.23">     [&quot;-----------------------:&quot;, false, &quot;-----------------------:&quot;],</span>
<a href="#l20.24"></a><span id="l20.24">   ];</span>
<a href="#l20.25"></a><span id="l20.25"> </span>
<a href="#l20.26"></a><span id="l20.26" class="difflineminus">-  for (i = 0; i &lt; checks.length; ++i)</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineminus">-  {</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineplus">+  for (i = 0; i &lt; checks.length; ++i) {</span>
<a href="#l20.29"></a><span id="l20.29">     Assert.equal(</span>
<a href="#l20.30"></a><span id="l20.30">       MailServices.mimeConverter.encodeMimePartIIStr_UTF8(checks[i][0], checks[i][1], &quot;Subject&quot;.length, 72),</span>
<a href="#l20.31"></a><span id="l20.31">       checks[i][2]);</span>
<a href="#l20.32"></a><span id="l20.32">   }</span>
<a href="#l20.33"></a><span id="l20.33"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/mime/test/unit/test_alternate_p7m_handling.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/mime/test/unit/test_alternate_p7m_handling.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -1,50 +1,49 @@</span>
<a href="#l21.4"></a><span id="l21.4" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l21.5"></a><span id="l21.5" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l21.6"></a><span id="l21.6"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l21.7"></a><span id="l21.7"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l21.8"></a><span id="l21.8"> </span>
<a href="#l21.9"></a><span id="l21.9" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l21.10"></a><span id="l21.10" class="difflineplus">+/* import-globals-from ../../../test/resources/messageModifier.js */</span>
<a href="#l21.11"></a><span id="l21.11" class="difflineplus">+/* import-globals-from ../../../test/resources/messageInjection.js */</span>
<a href="#l21.12"></a><span id="l21.12"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l21.13"></a><span id="l21.13"> load(&quot;../../../resources/messageModifier.js&quot;);</span>
<a href="#l21.14"></a><span id="l21.14"> load(&quot;../../../resources/messageInjection.js&quot;);</span>
<a href="#l21.15"></a><span id="l21.15"> </span>
<a href="#l21.16"></a><span id="l21.16"> var {MsgHdrToMimeMessage} = ChromeUtils.import(&quot;resource:///modules/gloda/mimemsg.js&quot;);</span>
<a href="#l21.17"></a><span id="l21.17"> </span>
<a href="#l21.18"></a><span id="l21.18" class="difflineminus">-var gMessenger = Cc[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineminus">-                   .createInstance(Ci.nsIMessenger);</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineminus">-</span>
<a href="#l21.21"></a><span id="l21.21"> // Create a message generator</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineminus">-var msgGen = gMessageGenerator = new MessageGenerator();</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineplus">+var gMessageGenerator = new MessageGenerator();</span>
<a href="#l21.24"></a><span id="l21.24"> </span>
<a href="#l21.25"></a><span id="l21.25"> var p7mAttachment = &quot;dGhpcyBpcyBub3QgYSByZWFsIHMvbWltZSBwN20gZW50aXR5&quot;;</span>
<a href="#l21.26"></a><span id="l21.26"> </span>
<a href="#l21.27"></a><span id="l21.27"> // create a message with a p7m attachment</span>
<a href="#l21.28"></a><span id="l21.28"> var messages = {</span>
<a href="#l21.29"></a><span id="l21.29">   attachments: [{</span>
<a href="#l21.30"></a><span id="l21.30">     body: p7mAttachment,</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-    filename: 'test.txt.p7m',</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineminus">-    contentType: 'application/pkcs7-mime',</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineminus">-    format:'',</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineminus">-    encoding: &quot;base64&quot;</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineminus">-  }]</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineplus">+    filename: &quot;test.txt.p7m&quot;,</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineplus">+    contentType: &quot;application/pkcs7-mime&quot;,</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineplus">+    format: &quot;&quot;,</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineplus">+    encoding: &quot;base64&quot;,</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineplus">+  }],</span>
<a href="#l21.41"></a><span id="l21.41"> };</span>
<a href="#l21.42"></a><span id="l21.42"> </span>
<a href="#l21.43"></a><span id="l21.43" class="difflineminus">-var msgWindow = Cc[&quot;@mozilla.org/messenger/msgwindow;1&quot;]</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineminus">-                  .createInstance(Ci.nsIMsgWindow);</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineminus">-</span>
<a href="#l21.46"></a><span id="l21.46"> function* worker(params) {</span>
<a href="#l21.47"></a><span id="l21.47">   let synMsg = gMessageGenerator.makeMessage(params.messages);</span>
<a href="#l21.48"></a><span id="l21.48">   let synSet = new SyntheticMessageSet([synMsg]);</span>
<a href="#l21.49"></a><span id="l21.49">   yield add_sets_to_folder(gInbox, [synSet]);</span>
<a href="#l21.50"></a><span id="l21.50"> </span>
<a href="#l21.51"></a><span id="l21.51">   let msgHdr = synSet.getMsgHdr(0);</span>
<a href="#l21.52"></a><span id="l21.52"> </span>
<a href="#l21.53"></a><span id="l21.53">   Services.prefs.setBoolPref(&quot;mailnews.p7m_external&quot;, params.all_external);</span>
<a href="#l21.54"></a><span id="l21.54">   Services.prefs.setBoolPref(&quot;mailnews.p7m_subparts_external&quot;, params.subparts_external);</span>
<a href="#l21.55"></a><span id="l21.55"> </span>
<a href="#l21.56"></a><span id="l21.56" class="difflineminus">-  MsgHdrToMimeMessage(msgHdr, null, function (aMsgHdr, aMimeMsg) {</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineplus">+  MsgHdrToMimeMessage(msgHdr, null, function(aMsgHdr, aMimeMsg) {</span>
<a href="#l21.58"></a><span id="l21.58">     try {</span>
<a href="#l21.59"></a><span id="l21.59">       Assert.ok(aMimeMsg.allUserAttachments.length == params.count);</span>
<a href="#l21.60"></a><span id="l21.60">       async_driver();</span>
<a href="#l21.61"></a><span id="l21.61">     } catch (err) {</span>
<a href="#l21.62"></a><span id="l21.62">       do_throw(err);</span>
<a href="#l21.63"></a><span id="l21.63">     }</span>
<a href="#l21.64"></a><span id="l21.64">   });</span>
<a href="#l21.65"></a><span id="l21.65"> </span>
<a href="#l21.66"></a><span id="l21.66" class="difflineat">@@ -54,17 +53,17 @@ function* worker(params) {</span>
<a href="#l21.67"></a><span id="l21.67"> /* ===== Driver ===== */</span>
<a href="#l21.68"></a><span id="l21.68"> </span>
<a href="#l21.69"></a><span id="l21.69"> var tests = [</span>
<a href="#l21.70"></a><span id="l21.70">   parameterizeTest(worker, [{ messages, all_external: false, subparts_external: false, count: 0 }]),</span>
<a href="#l21.71"></a><span id="l21.71">   // We are only testing with a p7m attachment, so whether all parts or just subparts are</span>
<a href="#l21.72"></a><span id="l21.72">   // made external yields the same result: one attachment which is not inlined.</span>
<a href="#l21.73"></a><span id="l21.73">   parameterizeTest(worker, [{ messages, all_external: true,  subparts_external: false, count: 1 }]),</span>
<a href="#l21.74"></a><span id="l21.74">   parameterizeTest(worker, [{ messages, all_external: false, subparts_external: true,  count: 1 }]),</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineminus">-  parameterizeTest(worker, [{ messages, all_external: true,  subparts_external: true,  count: 1 }])</span>
<a href="#l21.76"></a><span id="l21.76" class="difflineplus">+  parameterizeTest(worker, [{ messages, all_external: true,  subparts_external: true,  count: 1 }]),</span>
<a href="#l21.77"></a><span id="l21.77"> ];</span>
<a href="#l21.78"></a><span id="l21.78"> </span>
<a href="#l21.79"></a><span id="l21.79"> var gInbox;</span>
<a href="#l21.80"></a><span id="l21.80"> </span>
<a href="#l21.81"></a><span id="l21.81"> function run_test() {</span>
<a href="#l21.82"></a><span id="l21.82">   gInbox = configure_message_injection({mode: &quot;local&quot;});</span>
<a href="#l21.83"></a><span id="l21.83">   async_run_tests(tests);</span>
<a href="#l21.84"></a><span id="l21.84"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/mime/test/unit/test_attachment_size.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/mime/test/unit/test_attachment_size.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -1,283 +1,309 @@</span>
<a href="#l22.4"></a><span id="l22.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l22.5"></a><span id="l22.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l22.6"></a><span id="l22.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l22.7"></a><span id="l22.7"> </span>
<a href="#l22.8"></a><span id="l22.8"> /**</span>
<a href="#l22.9"></a><span id="l22.9">  * This test creates some messages with attachments of different types and</span>
<a href="#l22.10"></a><span id="l22.10">  * checks that libmime reports the expected size for each of them.</span>
<a href="#l22.11"></a><span id="l22.11">  */</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineplus">+/* import-globals-from ../../../test/resources/messageModifier.js */</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineplus">+/* import-globals-from ../../../test/resources/messageInjection.js */</span>
<a href="#l22.17"></a><span id="l22.17"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l22.18"></a><span id="l22.18"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l22.19"></a><span id="l22.19"> </span>
<a href="#l22.20"></a><span id="l22.20"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l22.21"></a><span id="l22.21"> load(&quot;../../../resources/messageModifier.js&quot;);</span>
<a href="#l22.22"></a><span id="l22.22"> load(&quot;../../../resources/messageInjection.js&quot;);</span>
<a href="#l22.23"></a><span id="l22.23"> </span>
<a href="#l22.24"></a><span id="l22.24"> // Somehow we hit the blocklist service, and that needs appInfo defined</span>
<a href="#l22.25"></a><span id="l22.25"> const {updateAppInfo} = ChromeUtils.import(&quot;resource://testing-common/AppInfo.jsm&quot;);</span>
<a href="#l22.26"></a><span id="l22.26"> updateAppInfo();</span>
<a href="#l22.27"></a><span id="l22.27"> </span>
<a href="#l22.28"></a><span id="l22.28"> var gMessenger = Cc[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l22.29"></a><span id="l22.29">                    .createInstance(Ci.nsIMessenger);</span>
<a href="#l22.30"></a><span id="l22.30"> </span>
<a href="#l22.31"></a><span id="l22.31"> // Create a message generator</span>
<a href="#l22.32"></a><span id="l22.32"> var msgGen = gMessageGenerator = new MessageGenerator();</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineminus">-// Create a message scenario generator using that message generator</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineminus">-var scenarios = gMessageScenarioFactory = new MessageScenarioFactory(msgGen);</span>
<a href="#l22.35"></a><span id="l22.35"> </span>
<a href="#l22.36"></a><span id="l22.36"> /* Today's gory details (thanks to Jonathan Protzenko): libmime somehow</span>
<a href="#l22.37"></a><span id="l22.37">  * counts the trailing newline for an attachment MIME part. Most of the time,</span>
<a href="#l22.38"></a><span id="l22.38">  * assuming attachment has N bytes (no matter what's inside, newlines or</span>
<a href="#l22.39"></a><span id="l22.39">  * not), libmime will return N + 1 bytes. On Linux and Mac, this always</span>
<a href="#l22.40"></a><span id="l22.40">  * holds. However, on Windows, if the attachment is not encoded (that is, is</span>
<a href="#l22.41"></a><span id="l22.41">  * inline text), libmime will return N + 2 bytes.</span>
<a href="#l22.42"></a><span id="l22.42">  */</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineminus">-var epsilon = ('@mozilla.org/windows-registry-key;1' in Cc) ? 4 : 2;</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineplus">+var epsilon = (&quot;@mozilla.org/windows-registry-key;1&quot; in Cc) ? 4 : 2;</span>
<a href="#l22.45"></a><span id="l22.45"> </span>
<a href="#l22.46"></a><span id="l22.46"> var textAttachment =</span>
<a href="#l22.47"></a><span id="l22.47">   &quot;Can't make the frug contest, Helen; stomach's upset. I'll fix you, &quot; +</span>
<a href="#l22.48"></a><span id="l22.48">   &quot;Ubik! Ubik drops you back in the thick of things fast. Taken as &quot; +</span>
<a href="#l22.49"></a><span id="l22.49">   &quot;directed, Ubik speeds relief to head and stomach. Remember: Ubik is &quot; +</span>
<a href="#l22.50"></a><span id="l22.50">   &quot;only seconds away. Avoid prolonged use.&quot;;</span>
<a href="#l22.51"></a><span id="l22.51"> </span>
<a href="#l22.52"></a><span id="l22.52"> var binaryAttachment = textAttachment;</span>
<a href="#l22.53"></a><span id="l22.53"> </span>
<a href="#l22.54"></a><span id="l22.54"> var imageAttachment =</span>
<a href="#l22.55"></a><span id="l22.55" class="difflineminus">-  'iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAYAAABWdVznAAAABHNCSVQICAgIfAhkiAAAAAlwS' +</span>
<a href="#l22.56"></a><span id="l22.56" class="difflineminus">-  'FlzAAAN1wAADdcBQiibeAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAA' +</span>
<a href="#l22.57"></a><span id="l22.57" class="difflineminus">-  'A5SURBVCiRY/z//z8DKYCJJNXkaGBgYGD4D8NQ5zUgiTVAxeBqSLaBkVRPM0KtIhrQ3km0jwe' +</span>
<a href="#l22.58"></a><span id="l22.58" class="difflineminus">-  'SNQAAlmAY+71EgFoAAAAASUVORK5CYII=';</span>
<a href="#l22.59"></a><span id="l22.59" class="difflineplus">+  &quot;iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAYAAABWdVznAAAABHNCSVQICAgIfAhkiAAAAAlwS&quot; +</span>
<a href="#l22.60"></a><span id="l22.60" class="difflineplus">+  &quot;FlzAAAN1wAADdcBQiibeAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAA&quot; +</span>
<a href="#l22.61"></a><span id="l22.61" class="difflineplus">+  &quot;A5SURBVCiRY/z//z8DKYCJJNXkaGBgYGD4D8NQ5zUgiTVAxeBqSLaBkVRPM0KtIhrQ3km0jwe&quot; +</span>
<a href="#l22.62"></a><span id="l22.62" class="difflineplus">+  &quot;SNQAAlmAY+71EgFoAAAAASUVORK5CYII=&quot;;</span>
<a href="#l22.63"></a><span id="l22.63"> var imageSize = 188;</span>
<a href="#l22.64"></a><span id="l22.64"> </span>
<a href="#l22.65"></a><span id="l22.65"> var uuAttachment =</span>
<a href="#l22.66"></a><span id="l22.66" class="difflineminus">-  'begin 644 /home/jvporter/Desktop/out.txt\n' +</span>
<a href="#l22.67"></a><span id="l22.67" class="difflineplus">+  &quot;begin 644 /home/jvporter/Desktop/out.txt\n&quot; +</span>
<a href="#l22.68"></a><span id="l22.68">   'M0V%N)W0@;6%K92!T:&amp;4@9G)U9R!C;VYT97-T+&quot;!(96QE;CL@&lt;W1O;6%C:&quot;=S\n' +</span>
<a href="#l22.69"></a><span id="l22.69">   'M(\'5P&lt;V5T+B!))VQL(&amp;9I&gt;&quot;!Y;W4L(%5B:6LA(%5B:6L@9\')O&lt;\',@&gt;6]U(&amp;)A\n' +</span>
<a href="#l22.70"></a><span id="l22.70" class="difflineminus">-  'M8VL@:6X@=&amp;AE(\'1H:6-K(&amp;]F(\'1H:6YG&lt;R!F87-T+B!486ME;B!A&lt;R!D:7)E\n' +</span>
<a href="#l22.71"></a><span id="l22.71" class="difflineplus">+  &quot;M8VL@:6X@=&amp;AE('1H:6-K(&amp;]F('1H:6YG&lt;R!F87-T+B!486ME;B!A&lt;R!D:7)E\n&quot; +</span>
<a href="#l22.72"></a><span id="l22.72">   'M8W1E9&quot;P@56)I:R!S&lt;&amp;5E9\',@&lt;F5L:65F(\'1O(&amp;AE860@86YD(\'-T;VUA8V@N\n' +</span>
<a href="#l22.73"></a><span id="l22.73">   'M(%)E;65M8F5R.B!58FEK(&amp;ES(&amp;]N;\'D@&lt;V5C;VYD&lt;R!A=V%Y+B!!=F]I9&quot;!P\n' +</span>
<a href="#l22.74"></a><span id="l22.74" class="difflineminus">-  '.&lt;F]L;VYG960@=7-E+@H`\n' +</span>
<a href="#l22.75"></a><span id="l22.75" class="difflineminus">-  '`\n' +</span>
<a href="#l22.76"></a><span id="l22.76" class="difflineminus">-  'end';</span>
<a href="#l22.77"></a><span id="l22.77" class="difflineplus">+  &quot;.&lt;F]L;VYG960@=7-E+@H`\n&quot; +</span>
<a href="#l22.78"></a><span id="l22.78" class="difflineplus">+  &quot;`\n&quot; +</span>
<a href="#l22.79"></a><span id="l22.79" class="difflineplus">+  &quot;end&quot;;</span>
<a href="#l22.80"></a><span id="l22.80"> </span>
<a href="#l22.81"></a><span id="l22.81"> var yencText =</span>
<a href="#l22.82"></a><span id="l22.82" class="difflineminus">-  &quot;Hello there --\n&quot;+</span>
<a href="#l22.83"></a><span id="l22.83" class="difflineminus">-  &quot;=ybegin line=128 size=174 name=jane\n&quot;+</span>
<a href="#l22.84"></a><span id="l22.84" class="difflineminus">-  &quot;\x76\x99\x98\x91\x9e\x8f\x97\x9a\x9d\x56\x4a\x94\x8f\x4a\x97\x8f&quot;+</span>
<a href="#l22.85"></a><span id="l22.85" class="difflineminus">-  &quot;\x4a\x9d\x9f\x93\x9d\x4a\x8d\x99\x9f\x8d\x92\xed\xd3\x4a\x8e\x8f&quot;+</span>
<a href="#l22.86"></a><span id="l22.86" class="difflineminus">-  &quot;\x4a\x8c\x99\x98\x98\x8f\x4a\x92\x8f\x9f\x9c\x8f\x58\x4a\x7a\x8b&quot;+</span>
<a href="#l22.87"></a><span id="l22.87" class="difflineminus">-  &quot;\x9c\x90\x99\x93\x9d\x56\x4a\xed\xca\x4a\x9a\x8f\x93\x98\x8f\x4a&quot;+</span>
<a href="#l22.88"></a><span id="l22.88" class="difflineminus">-  &quot;\x97\x8b\x4a\x8c\x99\x9f\x91\x93\x8f\x4a\xed\xd3\x9e\x8f\x93\x98&quot;+</span>
<a href="#l22.89"></a><span id="l22.89" class="difflineminus">-  &quot;\x9e\x8f\x56\x4a\x97\x8f\x9d\x4a\xa3\x8f\x9f\xa2\x4a\x9d\x8f\x4a&quot;+</span>
<a href="#l22.90"></a><span id="l22.90" class="difflineminus">-  &quot;\x90\x8f\x9c\x97\x8b\x93\x8f\x98\x9e\x4a\x9d\x93\x4a\xa0\x93\x9e&quot;+</span>
<a href="#l22.91"></a><span id="l22.91" class="difflineminus">-  &quot;\x8f\x4a\x9b\x9f\x8f\x4a\x94\x8f\x4a\x98\x51\x8b\xa0\x8b\x93\x9d&quot;+</span>
<a href="#l22.92"></a><span id="l22.92" class="difflineminus">-  &quot;\x0d\x0a\x4a\x9a\x8b\x9d\x4a\x96\x8f\x4a\x9e\x8f\x97\x9a\x9d\x4a&quot;+</span>
<a href="#l22.93"></a><span id="l22.93" class="difflineminus">-  &quot;\x8e\x8f\x4a\x97\x8f\x4a\x8e\x93\x9c\x8f\x4a\x64\x4a\xec\xd5\x4a&quot;+</span>
<a href="#l22.94"></a><span id="l22.94" class="difflineminus">-  &quot;\x74\x8f\x4a\x97\x51\x8f\x98\x8e\x99\x9c\x9d\x58\x4a\xec\xe5\x34&quot;+</span>
<a href="#l22.95"></a><span id="l22.95" class="difflineminus">-  &quot;\x0d\x0a&quot;+</span>
<a href="#l22.96"></a><span id="l22.96" class="difflineplus">+  &quot;Hello there --\n&quot; +</span>
<a href="#l22.97"></a><span id="l22.97" class="difflineplus">+  &quot;=ybegin line=128 size=174 name=jane\n&quot; +</span>
<a href="#l22.98"></a><span id="l22.98" class="difflineplus">+  &quot;\x76\x99\x98\x91\x9e\x8f\x97\x9a\x9d\x56\x4a\x94\x8f\x4a\x97\x8f&quot; +</span>
<a href="#l22.99"></a><span id="l22.99" class="difflineplus">+  &quot;\x4a\x9d\x9f\x93\x9d\x4a\x8d\x99\x9f\x8d\x92\xed\xd3\x4a\x8e\x8f&quot; +</span>
<a href="#l22.100"></a><span id="l22.100" class="difflineplus">+  &quot;\x4a\x8c\x99\x98\x98\x8f\x4a\x92\x8f\x9f\x9c\x8f\x58\x4a\x7a\x8b&quot; +</span>
<a href="#l22.101"></a><span id="l22.101" class="difflineplus">+  &quot;\x9c\x90\x99\x93\x9d\x56\x4a\xed\xca\x4a\x9a\x8f\x93\x98\x8f\x4a&quot; +</span>
<a href="#l22.102"></a><span id="l22.102" class="difflineplus">+  &quot;\x97\x8b\x4a\x8c\x99\x9f\x91\x93\x8f\x4a\xed\xd3\x9e\x8f\x93\x98&quot; +</span>
<a href="#l22.103"></a><span id="l22.103" class="difflineplus">+  &quot;\x9e\x8f\x56\x4a\x97\x8f\x9d\x4a\xa3\x8f\x9f\xa2\x4a\x9d\x8f\x4a&quot; +</span>
<a href="#l22.104"></a><span id="l22.104" class="difflineplus">+  &quot;\x90\x8f\x9c\x97\x8b\x93\x8f\x98\x9e\x4a\x9d\x93\x4a\xa0\x93\x9e&quot; +</span>
<a href="#l22.105"></a><span id="l22.105" class="difflineplus">+  &quot;\x8f\x4a\x9b\x9f\x8f\x4a\x94\x8f\x4a\x98\x51\x8b\xa0\x8b\x93\x9d&quot; +</span>
<a href="#l22.106"></a><span id="l22.106" class="difflineplus">+  &quot;\x0d\x0a\x4a\x9a\x8b\x9d\x4a\x96\x8f\x4a\x9e\x8f\x97\x9a\x9d\x4a&quot; +</span>
<a href="#l22.107"></a><span id="l22.107" class="difflineplus">+  &quot;\x8e\x8f\x4a\x97\x8f\x4a\x8e\x93\x9c\x8f\x4a\x64\x4a\xec\xd5\x4a&quot; +</span>
<a href="#l22.108"></a><span id="l22.108" class="difflineplus">+  &quot;\x74\x8f\x4a\x97\x51\x8f\x98\x8e\x99\x9c\x9d\x58\x4a\xec\xe5\x34&quot; +</span>
<a href="#l22.109"></a><span id="l22.109" class="difflineplus">+  &quot;\x0d\x0a&quot; +</span>
<a href="#l22.110"></a><span id="l22.110">   &quot;=yend size=174 crc32=7efccd8e\n&quot;;</span>
<a href="#l22.111"></a><span id="l22.111"> var yencSize = 174;</span>
<a href="#l22.112"></a><span id="l22.112"> </span>
<a href="#l22.113"></a><span id="l22.113"> var partHtml = new SyntheticPartLeaf(</span>
<a href="#l22.114"></a><span id="l22.114">   &quot;&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;I am HTML! Woo! &lt;/body&gt;&lt;/html&gt;&quot;,</span>
<a href="#l22.115"></a><span id="l22.115" class="difflineminus">-  {</span>
<a href="#l22.116"></a><span id="l22.116" class="difflineminus">-    contentType: &quot;text/html&quot;</span>
<a href="#l22.117"></a><span id="l22.117" class="difflineminus">-  }</span>
<a href="#l22.118"></a><span id="l22.118" class="difflineplus">+  { contentType: &quot;text/html&quot; }</span>
<a href="#l22.119"></a><span id="l22.119"> );</span>
<a href="#l22.120"></a><span id="l22.120"> </span>
<a href="#l22.121"></a><span id="l22.121"> var attachedMessage1 = msgGen.makeMessage({ body: { body: textAttachment } });</span>
<a href="#l22.122"></a><span id="l22.122"> var attachedMessage2 = msgGen.makeMessage({</span>
<a href="#l22.123"></a><span id="l22.123">   body: { body: textAttachment },</span>
<a href="#l22.124"></a><span id="l22.124" class="difflineminus">-  attachments: [{ body: imageAttachment,</span>
<a href="#l22.125"></a><span id="l22.125" class="difflineminus">-                  contentType: 'application/x-ubik',</span>
<a href="#l22.126"></a><span id="l22.126" class="difflineminus">-                  filename: 'ubik',</span>
<a href="#l22.127"></a><span id="l22.127" class="difflineminus">-                  encoding: 'base64',</span>
<a href="#l22.128"></a><span id="l22.128" class="difflineminus">-                  format: '' }]</span>
<a href="#l22.129"></a><span id="l22.129" class="difflineplus">+  attachments: [{</span>
<a href="#l22.130"></a><span id="l22.130" class="difflineplus">+    body: imageAttachment,</span>
<a href="#l22.131"></a><span id="l22.131" class="difflineplus">+    contentType: &quot;application/x-ubik&quot;,</span>
<a href="#l22.132"></a><span id="l22.132" class="difflineplus">+    filename: &quot;ubik&quot;,</span>
<a href="#l22.133"></a><span id="l22.133" class="difflineplus">+    encoding: &quot;base64&quot;,</span>
<a href="#l22.134"></a><span id="l22.134" class="difflineplus">+    format: &quot;&quot;,</span>
<a href="#l22.135"></a><span id="l22.135" class="difflineplus">+  }],</span>
<a href="#l22.136"></a><span id="l22.136"> });</span>
<a href="#l22.137"></a><span id="l22.137"> </span>
<a href="#l22.138"></a><span id="l22.138"> /**</span>
<a href="#l22.139"></a><span id="l22.139">  * Return the size of a synthetic message. Much like the above comment, libmime</span>
<a href="#l22.140"></a><span id="l22.140">  * counts bytes differently on Windows, where it counts newlines (\r\n) as 2</span>
<a href="#l22.141"></a><span id="l22.141">  * bytes. Mac and Linux treats them as 1 byte.</span>
<a href="#l22.142"></a><span id="l22.142">  *</span>
<a href="#l22.143"></a><span id="l22.143">  * @param message a synthetic message from makeMessage()</span>
<a href="#l22.144"></a><span id="l22.144">  * @return the message's size in bytes</span>
<a href="#l22.145"></a><span id="l22.145">  */</span>
<a href="#l22.146"></a><span id="l22.146"> function get_message_size(message) {</span>
<a href="#l22.147"></a><span id="l22.147">   let messageString = message.toMessageString();</span>
<a href="#l22.148"></a><span id="l22.148">   if (epsilon == 4) // Windows</span>
<a href="#l22.149"></a><span id="l22.149">     return messageString.length;</span>
<a href="#l22.150"></a><span id="l22.150" class="difflineminus">-  else // Mac/Linux</span>
<a href="#l22.151"></a><span id="l22.151" class="difflineminus">-    return messageString.replace(/\r\n/g, &quot;\n&quot;).length;</span>
<a href="#l22.152"></a><span id="l22.152" class="difflineplus">+  return messageString.replace(/\r\n/g, &quot;\n&quot;).length;</span>
<a href="#l22.153"></a><span id="l22.153"> }</span>
<a href="#l22.154"></a><span id="l22.154"> </span>
<a href="#l22.155"></a><span id="l22.155"> // create some messages that have various types of attachments</span>
<a href="#l22.156"></a><span id="l22.156"> var messages = [</span>
<a href="#l22.157"></a><span id="l22.157" class="difflineminus">-  // text attachment</span>
<a href="#l22.158"></a><span id="l22.158" class="difflineminus">-  { attachments: [{ body: textAttachment,</span>
<a href="#l22.159"></a><span id="l22.159" class="difflineminus">-                    filename: 'ubik.txt',</span>
<a href="#l22.160"></a><span id="l22.160" class="difflineminus">-                    format: '' }],</span>
<a href="#l22.161"></a><span id="l22.161" class="difflineminus">-    size: textAttachment.length },</span>
<a href="#l22.162"></a><span id="l22.162" class="difflineminus">-  // (inline) image attachment</span>
<a href="#l22.163"></a><span id="l22.163" class="difflineminus">-  { attachments: [{ body: imageAttachment,</span>
<a href="#l22.164"></a><span id="l22.164" class="difflineminus">-                    contentType: 'image/png',</span>
<a href="#l22.165"></a><span id="l22.165" class="difflineminus">-                    filename: 'lines.png',</span>
<a href="#l22.166"></a><span id="l22.166" class="difflineminus">-                    encoding: 'base64',</span>
<a href="#l22.167"></a><span id="l22.167" class="difflineminus">-                    format: '' }],</span>
<a href="#l22.168"></a><span id="l22.168" class="difflineminus">-    size: imageSize },</span>
<a href="#l22.169"></a><span id="l22.169" class="difflineminus">-  // binary attachment, no encoding</span>
<a href="#l22.170"></a><span id="l22.170" class="difflineminus">-  { attachments: [{ body: binaryAttachment,</span>
<a href="#l22.171"></a><span id="l22.171" class="difflineminus">-                    contentType: 'application/x-ubik',</span>
<a href="#l22.172"></a><span id="l22.172" class="difflineminus">-                    filename: 'ubik',</span>
<a href="#l22.173"></a><span id="l22.173" class="difflineminus">-                    format: '' }],</span>
<a href="#l22.174"></a><span id="l22.174" class="difflineminus">-    size: binaryAttachment.length },</span>
<a href="#l22.175"></a><span id="l22.175" class="difflineminus">-  // binary attachment, b64 encoding</span>
<a href="#l22.176"></a><span id="l22.176" class="difflineminus">-  { attachments: [{ body: imageAttachment,</span>
<a href="#l22.177"></a><span id="l22.177" class="difflineminus">-                    contentType: 'application/x-ubik',</span>
<a href="#l22.178"></a><span id="l22.178" class="difflineminus">-                    filename: 'ubik',</span>
<a href="#l22.179"></a><span id="l22.179" class="difflineminus">-                    encoding: 'base64',</span>
<a href="#l22.180"></a><span id="l22.180" class="difflineminus">-                    format: '' }],</span>
<a href="#l22.181"></a><span id="l22.181" class="difflineminus">-    size: imageSize },</span>
<a href="#l22.182"></a><span id="l22.182" class="difflineminus">-  // uuencoded attachment</span>
<a href="#l22.183"></a><span id="l22.183" class="difflineminus">-  { attachments: [{ body: uuAttachment,</span>
<a href="#l22.184"></a><span id="l22.184" class="difflineminus">-                    contentType: 'application/x-uuencode',</span>
<a href="#l22.185"></a><span id="l22.185" class="difflineminus">-                    filename: 'ubik',</span>
<a href="#l22.186"></a><span id="l22.186" class="difflineminus">-                    format: '',</span>
<a href="#l22.187"></a><span id="l22.187" class="difflineminus">-                    encoding: 'uuencode' }],</span>
<a href="#l22.188"></a><span id="l22.188" class="difflineminus">-    size: textAttachment.length },</span>
<a href="#l22.189"></a><span id="l22.189" class="difflineminus">-  // yencoded attachment</span>
<a href="#l22.190"></a><span id="l22.190" class="difflineminus">-  { bodyPart: new SyntheticPartLeaf(&quot;I am text! Woo!\n\n&quot;+yencText,</span>
<a href="#l22.191"></a><span id="l22.191" class="difflineminus">-                                    { contentType: '' } ),</span>
<a href="#l22.192"></a><span id="l22.192" class="difflineplus">+  {</span>
<a href="#l22.193"></a><span id="l22.193" class="difflineplus">+    // text attachment</span>
<a href="#l22.194"></a><span id="l22.194" class="difflineplus">+    attachments: [{</span>
<a href="#l22.195"></a><span id="l22.195" class="difflineplus">+      body: textAttachment,</span>
<a href="#l22.196"></a><span id="l22.196" class="difflineplus">+      filename: &quot;ubik.txt&quot;,</span>
<a href="#l22.197"></a><span id="l22.197" class="difflineplus">+      format: &quot;&quot;,</span>
<a href="#l22.198"></a><span id="l22.198" class="difflineplus">+    }],</span>
<a href="#l22.199"></a><span id="l22.199" class="difflineplus">+    size: textAttachment.length,</span>
<a href="#l22.200"></a><span id="l22.200" class="difflineplus">+  }, {</span>
<a href="#l22.201"></a><span id="l22.201" class="difflineplus">+    // (inline) image attachment</span>
<a href="#l22.202"></a><span id="l22.202" class="difflineplus">+    attachments: [{</span>
<a href="#l22.203"></a><span id="l22.203" class="difflineplus">+      body: imageAttachment,</span>
<a href="#l22.204"></a><span id="l22.204" class="difflineplus">+      contentType: &quot;image/png&quot;,</span>
<a href="#l22.205"></a><span id="l22.205" class="difflineplus">+      filename: &quot;lines.png&quot;,</span>
<a href="#l22.206"></a><span id="l22.206" class="difflineplus">+      encoding: &quot;base64&quot;,</span>
<a href="#l22.207"></a><span id="l22.207" class="difflineplus">+      format: &quot;&quot;,</span>
<a href="#l22.208"></a><span id="l22.208" class="difflineplus">+    }],</span>
<a href="#l22.209"></a><span id="l22.209" class="difflineplus">+    size: imageSize,</span>
<a href="#l22.210"></a><span id="l22.210" class="difflineplus">+  }, {</span>
<a href="#l22.211"></a><span id="l22.211" class="difflineplus">+    // binary attachment, no encoding</span>
<a href="#l22.212"></a><span id="l22.212" class="difflineplus">+    attachments: [{</span>
<a href="#l22.213"></a><span id="l22.213" class="difflineplus">+      body: binaryAttachment,</span>
<a href="#l22.214"></a><span id="l22.214" class="difflineplus">+      contentType: &quot;application/x-ubik&quot;,</span>
<a href="#l22.215"></a><span id="l22.215" class="difflineplus">+      filename: &quot;ubik&quot;,</span>
<a href="#l22.216"></a><span id="l22.216" class="difflineplus">+      format: &quot;&quot;,</span>
<a href="#l22.217"></a><span id="l22.217" class="difflineplus">+    }],</span>
<a href="#l22.218"></a><span id="l22.218" class="difflineplus">+    size: binaryAttachment.length,</span>
<a href="#l22.219"></a><span id="l22.219" class="difflineplus">+  }, {</span>
<a href="#l22.220"></a><span id="l22.220" class="difflineplus">+    // binary attachment, b64 encoding</span>
<a href="#l22.221"></a><span id="l22.221" class="difflineplus">+    attachments: [{</span>
<a href="#l22.222"></a><span id="l22.222" class="difflineplus">+      body: imageAttachment,</span>
<a href="#l22.223"></a><span id="l22.223" class="difflineplus">+      contentType: &quot;application/x-ubik&quot;,</span>
<a href="#l22.224"></a><span id="l22.224" class="difflineplus">+      filename: &quot;ubik&quot;,</span>
<a href="#l22.225"></a><span id="l22.225" class="difflineplus">+      encoding: &quot;base64&quot;,</span>
<a href="#l22.226"></a><span id="l22.226" class="difflineplus">+      format: &quot;&quot;,</span>
<a href="#l22.227"></a><span id="l22.227" class="difflineplus">+    }],</span>
<a href="#l22.228"></a><span id="l22.228" class="difflineplus">+    size: imageSize,</span>
<a href="#l22.229"></a><span id="l22.229" class="difflineplus">+  }, {</span>
<a href="#l22.230"></a><span id="l22.230" class="difflineplus">+    // uuencoded attachment</span>
<a href="#l22.231"></a><span id="l22.231" class="difflineplus">+    attachments: [{</span>
<a href="#l22.232"></a><span id="l22.232" class="difflineplus">+      body: uuAttachment,</span>
<a href="#l22.233"></a><span id="l22.233" class="difflineplus">+      contentType: &quot;application/x-uuencode&quot;,</span>
<a href="#l22.234"></a><span id="l22.234" class="difflineplus">+      filename: &quot;ubik&quot;,</span>
<a href="#l22.235"></a><span id="l22.235" class="difflineplus">+      format: &quot;&quot;,</span>
<a href="#l22.236"></a><span id="l22.236" class="difflineplus">+      encoding: &quot;uuencode&quot;,</span>
<a href="#l22.237"></a><span id="l22.237" class="difflineplus">+    }],</span>
<a href="#l22.238"></a><span id="l22.238" class="difflineplus">+    size: textAttachment.length,</span>
<a href="#l22.239"></a><span id="l22.239" class="difflineplus">+  }, {</span>
<a href="#l22.240"></a><span id="l22.240" class="difflineplus">+    // yencoded attachment</span>
<a href="#l22.241"></a><span id="l22.241" class="difflineplus">+    bodyPart: new SyntheticPartLeaf(&quot;I am text! Woo!\n\n&quot; + yencText,</span>
<a href="#l22.242"></a><span id="l22.242" class="difflineplus">+                                    { contentType: &quot;&quot; }),</span>
<a href="#l22.243"></a><span id="l22.243">     subject: &quot;yEnc-Prefix: \&quot;jane\&quot; 174 yEnc bytes - yEnc test (1)&quot;,</span>
<a href="#l22.244"></a><span id="l22.244" class="difflineminus">-    size: yencSize },</span>
<a href="#l22.245"></a><span id="l22.245" class="difflineminus">-  // an attached eml that used to return a size that's -1</span>
<a href="#l22.246"></a><span id="l22.246" class="difflineminus">-  {</span>
<a href="#l22.247"></a><span id="l22.247" class="difflineplus">+    size: yencSize,</span>
<a href="#l22.248"></a><span id="l22.248" class="difflineplus">+  }, {</span>
<a href="#l22.249"></a><span id="l22.249" class="difflineplus">+    // an attached eml that used to return a size that's -1</span>
<a href="#l22.250"></a><span id="l22.250">     bodyPart: new SyntheticPartMultiMixed([</span>
<a href="#l22.251"></a><span id="l22.251">       partHtml,</span>
<a href="#l22.252"></a><span id="l22.252">       attachedMessage1,</span>
<a href="#l22.253"></a><span id="l22.253">     ]),</span>
<a href="#l22.254"></a><span id="l22.254">     size: get_message_size(attachedMessage1),</span>
<a href="#l22.255"></a><span id="l22.255" class="difflineminus">-  },</span>
<a href="#l22.256"></a><span id="l22.256" class="difflineminus">-  // this is an attached message that itself has an attachment</span>
<a href="#l22.257"></a><span id="l22.257" class="difflineminus">-  {</span>
<a href="#l22.258"></a><span id="l22.258" class="difflineplus">+  }, {</span>
<a href="#l22.259"></a><span id="l22.259" class="difflineplus">+    // this is an attached message that itself has an attachment</span>
<a href="#l22.260"></a><span id="l22.260">     bodyPart: new SyntheticPartMultiMixed([</span>
<a href="#l22.261"></a><span id="l22.261">       partHtml,</span>
<a href="#l22.262"></a><span id="l22.262">       attachedMessage2,</span>
<a href="#l22.263"></a><span id="l22.263">     ]),</span>
<a href="#l22.264"></a><span id="l22.264">     size: get_message_size(attachedMessage2),</span>
<a href="#l22.265"></a><span id="l22.265" class="difflineminus">-  },</span>
<a href="#l22.266"></a><span id="l22.266" class="difflineminus">-  // an &quot;attachment&quot; that's really the body of the message</span>
<a href="#l22.267"></a><span id="l22.267" class="difflineminus">-  { body: { body: textAttachment,</span>
<a href="#l22.268"></a><span id="l22.268" class="difflineminus">-            contentType: 'application/x-ubik; name=attachment.ubik' },</span>
<a href="#l22.269"></a><span id="l22.269" class="difflineplus">+  }, {</span>
<a href="#l22.270"></a><span id="l22.270" class="difflineplus">+    // an &quot;attachment&quot; that's really the body of the message</span>
<a href="#l22.271"></a><span id="l22.271" class="difflineplus">+    body: {</span>
<a href="#l22.272"></a><span id="l22.272" class="difflineplus">+      body: textAttachment,</span>
<a href="#l22.273"></a><span id="l22.273" class="difflineplus">+      contentType: &quot;application/x-ubik; name=attachment.ubik&quot;,</span>
<a href="#l22.274"></a><span id="l22.274" class="difflineplus">+    },</span>
<a href="#l22.275"></a><span id="l22.275">     size: textAttachment.length,</span>
<a href="#l22.276"></a><span id="l22.276" class="difflineminus">-  },</span>
<a href="#l22.277"></a><span id="l22.277" class="difflineminus">-  // a message/rfc822 &quot;attachment&quot; that's really the body of the message</span>
<a href="#l22.278"></a><span id="l22.278" class="difflineminus">-  { bodyPart: attachedMessage1,</span>
<a href="#l22.279"></a><span id="l22.279" class="difflineplus">+  }, {</span>
<a href="#l22.280"></a><span id="l22.280" class="difflineplus">+    // a message/rfc822 &quot;attachment&quot; that's really the body of the message</span>
<a href="#l22.281"></a><span id="l22.281" class="difflineplus">+    bodyPart: attachedMessage1,</span>
<a href="#l22.282"></a><span id="l22.282">     size: get_message_size(attachedMessage1),</span>
<a href="#l22.283"></a><span id="l22.283" class="difflineplus">+  }, {</span>
<a href="#l22.284"></a><span id="l22.284" class="difflineplus">+    // an external http link attachment (as constructed for feed enclosures) - no 'size' parm.</span>
<a href="#l22.285"></a><span id="l22.285" class="difflineplus">+    attachments: [{</span>
<a href="#l22.286"></a><span id="l22.286" class="difflineplus">+      body: &quot;This MIME attachment is stored separately from the message.&quot;,</span>
<a href="#l22.287"></a><span id="l22.287" class="difflineplus">+      contentType: 'application/unknown; name=&quot;somefile&quot;',</span>
<a href="#l22.288"></a><span id="l22.288" class="difflineplus">+      extraHeaders: {</span>
<a href="#l22.289"></a><span id="l22.289" class="difflineplus">+        &quot;X-Mozilla-External-Attachment-URL&quot;: &quot;http://myblog.com/somefile&quot;,</span>
<a href="#l22.290"></a><span id="l22.290" class="difflineplus">+      },</span>
<a href="#l22.291"></a><span id="l22.291" class="difflineplus">+      disposition: 'attachment; filename=&quot;somefile&quot;',</span>
<a href="#l22.292"></a><span id="l22.292" class="difflineplus">+    }],</span>
<a href="#l22.293"></a><span id="l22.293" class="difflineplus">+    size: -1,</span>
<a href="#l22.294"></a><span id="l22.294" class="difflineplus">+  }, {</span>
<a href="#l22.295"></a><span id="l22.295" class="difflineplus">+    // an external http link attachment (as constructed for feed enclosures) - file with 'size' parm.</span>
<a href="#l22.296"></a><span id="l22.296" class="difflineplus">+    attachments: [{</span>
<a href="#l22.297"></a><span id="l22.297" class="difflineplus">+      body: &quot;This MIME attachment is stored separately from the message.&quot;,</span>
<a href="#l22.298"></a><span id="l22.298" class="difflineplus">+      contentType: 'audio/mpeg; name=&quot;file.mp3&quot;; size=123456789',</span>
<a href="#l22.299"></a><span id="l22.299" class="difflineplus">+      extraHeaders: {</span>
<a href="#l22.300"></a><span id="l22.300" class="difflineplus">+        &quot;X-Mozilla-External-Attachment-URL&quot;: &quot;https://myblog.com/file.mp3&quot;,</span>
<a href="#l22.301"></a><span id="l22.301" class="difflineplus">+      },</span>
<a href="#l22.302"></a><span id="l22.302" class="difflineplus">+      disposition: 'attachment; name=&quot;file.mp3&quot;',</span>
<a href="#l22.303"></a><span id="l22.303" class="difflineplus">+    }],</span>
<a href="#l22.304"></a><span id="l22.304" class="difflineplus">+    size: 123456789,</span>
<a href="#l22.305"></a><span id="l22.305">   },</span>
<a href="#l22.306"></a><span id="l22.306" class="difflineminus">-  // an external http link attachment (as constructed for feed enclosures) - no 'size' parm.</span>
<a href="#l22.307"></a><span id="l22.307" class="difflineminus">-  { attachments: [{ body: 'This MIME attachment is stored separately from the message.',</span>
<a href="#l22.308"></a><span id="l22.308" class="difflineminus">-                    contentType: 'application/unknown; name=&quot;somefile&quot;',</span>
<a href="#l22.309"></a><span id="l22.309" class="difflineminus">-                    extraHeaders: {</span>
<a href="#l22.310"></a><span id="l22.310" class="difflineminus">-                      'X-Mozilla-External-Attachment-URL': 'http://myblog.com/somefile',</span>
<a href="#l22.311"></a><span id="l22.311" class="difflineminus">-                    },</span>
<a href="#l22.312"></a><span id="l22.312" class="difflineminus">-                    disposition: 'attachment; filename=&quot;somefile&quot;' }],</span>
<a href="#l22.313"></a><span id="l22.313" class="difflineminus">-    size: -1 },</span>
<a href="#l22.314"></a><span id="l22.314" class="difflineminus">-  // an external http link attachment (as constructed for feed enclosures) - file with 'size' parm.</span>
<a href="#l22.315"></a><span id="l22.315" class="difflineminus">-  { attachments: [{ body: 'This MIME attachment is stored separately from the message.',</span>
<a href="#l22.316"></a><span id="l22.316" class="difflineminus">-                    contentType: 'audio/mpeg; name=&quot;file.mp3&quot;; size=123456789',</span>
<a href="#l22.317"></a><span id="l22.317" class="difflineminus">-                    extraHeaders: {</span>
<a href="#l22.318"></a><span id="l22.318" class="difflineminus">-                      'X-Mozilla-External-Attachment-URL': 'https://myblog.com/file.mp3',</span>
<a href="#l22.319"></a><span id="l22.319" class="difflineminus">-                    },</span>
<a href="#l22.320"></a><span id="l22.320" class="difflineminus">-                    disposition: 'attachment; name=&quot;file.mp3&quot;' }],</span>
<a href="#l22.321"></a><span id="l22.321" class="difflineminus">-    size: 123456789 },</span>
<a href="#l22.322"></a><span id="l22.322"> ];</span>
<a href="#l22.323"></a><span id="l22.323"> </span>
<a href="#l22.324"></a><span id="l22.324"> </span>
<a href="#l22.325"></a><span id="l22.325"> var gStreamListener = {</span>
<a href="#l22.326"></a><span id="l22.326">   QueryInterface: ChromeUtils.generateQI([Ci.nsIStreamListener]),</span>
<a href="#l22.327"></a><span id="l22.327"> </span>
<a href="#l22.328"></a><span id="l22.328">   // nsIRequestObserver part</span>
<a href="#l22.329"></a><span id="l22.329" class="difflineminus">-  onStartRequest: function (aRequest) {</span>
<a href="#l22.330"></a><span id="l22.330" class="difflineplus">+  onStartRequest(aRequest) {</span>
<a href="#l22.331"></a><span id="l22.331">     // We reset the size here because we know that we only expect one attachment</span>
<a href="#l22.332"></a><span id="l22.332">     //  per test email. In the case of the attached .eml with nested</span>
<a href="#l22.333"></a><span id="l22.333">     //  attachments, this allows us to properly discard the nested attachment</span>
<a href="#l22.334"></a><span id="l22.334">     //  sizes.</span>
<a href="#l22.335"></a><span id="l22.335">     // msgHdrViewOverlay.js has a stack of attachment infos that properly</span>
<a href="#l22.336"></a><span id="l22.336">     //  handles this.</span>
<a href="#l22.337"></a><span id="l22.337">     gMessageHeaderSink.size = null;</span>
<a href="#l22.338"></a><span id="l22.338">   },</span>
<a href="#l22.339"></a><span id="l22.339" class="difflineminus">-  onStopRequest: function (aRequest, aStatusCode) {</span>
<a href="#l22.340"></a><span id="l22.340" class="difflineminus">-    dump(&quot;*** Size is &quot;+gMessageHeaderSink.size+&quot; (expecting &quot;+this.expectedSize+&quot;)\n\n&quot;);</span>
<a href="#l22.341"></a><span id="l22.341" class="difflineplus">+  onStopRequest(aRequest, aStatusCode) {</span>
<a href="#l22.342"></a><span id="l22.342" class="difflineplus">+    dump(&quot;*** Size is &quot; + gMessageHeaderSink.size + &quot; (expecting &quot; + this.expectedSize + &quot;)\n\n&quot;);</span>
<a href="#l22.343"></a><span id="l22.343">     Assert.ok(Math.abs(gMessageHeaderSink.size - this.expectedSize) &lt;= epsilon);</span>
<a href="#l22.344"></a><span id="l22.344">     this._stream = null;</span>
<a href="#l22.345"></a><span id="l22.345">     async_driver();</span>
<a href="#l22.346"></a><span id="l22.346">   },</span>
<a href="#l22.347"></a><span id="l22.347"> </span>
<a href="#l22.348"></a><span id="l22.348">   // nsIStreamListener part</span>
<a href="#l22.349"></a><span id="l22.349" class="difflineminus">-  _stream : null,</span>
<a href="#l22.350"></a><span id="l22.350" class="difflineplus">+  _stream: null,</span>
<a href="#l22.351"></a><span id="l22.351"> </span>
<a href="#l22.352"></a><span id="l22.352" class="difflineminus">-  onDataAvailable: function (aRequest, aInputStream, aOffset, aCount) {</span>
<a href="#l22.353"></a><span id="l22.353" class="difflineplus">+  onDataAvailable(aRequest, aInputStream, aOffset, aCount) {</span>
<a href="#l22.354"></a><span id="l22.354">     if (this._stream === null) {</span>
<a href="#l22.355"></a><span id="l22.355">       this._stream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;].</span>
<a href="#l22.356"></a><span id="l22.356">                     createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l22.357"></a><span id="l22.357">       this._stream.init(aInputStream);</span>
<a href="#l22.358"></a><span id="l22.358">     }</span>
<a href="#l22.359"></a><span id="l22.359">     this._stream.read(aCount);</span>
<a href="#l22.360"></a><span id="l22.360">   },</span>
<a href="#l22.361"></a><span id="l22.361"> };</span>
<a href="#l22.362"></a><span id="l22.362"> </span>
<a href="#l22.363"></a><span id="l22.363"> var gMessageHeaderSink = {</span>
<a href="#l22.364"></a><span id="l22.364" class="difflineminus">-  handleAttachment: function(aContentType, aUrl, aDisplayName, aUri,</span>
<a href="#l22.365"></a><span id="l22.365" class="difflineplus">+  handleAttachment(aContentType, aUrl, aDisplayName, aUri,</span>
<a href="#l22.366"></a><span id="l22.366">                              aIsExternalAttachment) {</span>
<a href="#l22.367"></a><span id="l22.367">   },</span>
<a href="#l22.368"></a><span id="l22.368" class="difflineminus">-  addAttachmentField: function(aName, aValue) {</span>
<a href="#l22.369"></a><span id="l22.369" class="difflineplus">+  addAttachmentField(aName, aValue) {</span>
<a href="#l22.370"></a><span id="l22.370">     // Only record the information for the first attachment.</span>
<a href="#l22.371"></a><span id="l22.371">     if (aName == &quot;X-Mozilla-PartSize&quot; &amp;&amp; (this.size == null))</span>
<a href="#l22.372"></a><span id="l22.372">       this.size = parseInt(aValue);</span>
<a href="#l22.373"></a><span id="l22.373">   },</span>
<a href="#l22.374"></a><span id="l22.374"> </span>
<a href="#l22.375"></a><span id="l22.375">   // stub functions from nsIMsgHeaderSink</span>
<a href="#l22.376"></a><span id="l22.376" class="difflineminus">-  onStartHeaders: function() {},</span>
<a href="#l22.377"></a><span id="l22.377" class="difflineminus">-  onEndHeaders: function() {},</span>
<a href="#l22.378"></a><span id="l22.378" class="difflineminus">-  processHeaders: function(aHeaderNames, aHeaderValues, dontCollectAddrs) {},</span>
<a href="#l22.379"></a><span id="l22.379" class="difflineminus">-  onEndAllAttachments: function() {},</span>
<a href="#l22.380"></a><span id="l22.380" class="difflineminus">-  onEndMsgDownload: function() {},</span>
<a href="#l22.381"></a><span id="l22.381" class="difflineminus">-  onEndMsgHeaders: function(aUrl) {},</span>
<a href="#l22.382"></a><span id="l22.382" class="difflineminus">-  onMsgHasRemoteContent: function(aMsgHdr, aContentURI) {},</span>
<a href="#l22.383"></a><span id="l22.383" class="difflineplus">+  onStartHeaders() {},</span>
<a href="#l22.384"></a><span id="l22.384" class="difflineplus">+  onEndHeaders() {},</span>
<a href="#l22.385"></a><span id="l22.385" class="difflineplus">+  processHeaders(aHeaderNames, aHeaderValues, dontCollectAddrs) {},</span>
<a href="#l22.386"></a><span id="l22.386" class="difflineplus">+  onEndAllAttachments() {},</span>
<a href="#l22.387"></a><span id="l22.387" class="difflineplus">+  onEndMsgDownload() {},</span>
<a href="#l22.388"></a><span id="l22.388" class="difflineplus">+  onEndMsgHeaders(aUrl) {},</span>
<a href="#l22.389"></a><span id="l22.389" class="difflineplus">+  onMsgHasRemoteContent(aMsgHdr, aContentURI) {},</span>
<a href="#l22.390"></a><span id="l22.390">   securityInfo: null,</span>
<a href="#l22.391"></a><span id="l22.391">   mDummyMsgHeader: null,</span>
<a href="#l22.392"></a><span id="l22.392">   properties: null,</span>
<a href="#l22.393"></a><span id="l22.393" class="difflineminus">-  resetProperties: function () {}</span>
<a href="#l22.394"></a><span id="l22.394" class="difflineplus">+  resetProperties() {},</span>
<a href="#l22.395"></a><span id="l22.395"> };</span>
<a href="#l22.396"></a><span id="l22.396"> </span>
<a href="#l22.397"></a><span id="l22.397"> var msgWindow = Cc[&quot;@mozilla.org/messenger/msgwindow;1&quot;]</span>
<a href="#l22.398"></a><span id="l22.398">                   .createInstance(Ci.nsIMsgWindow);</span>
<a href="#l22.399"></a><span id="l22.399"> msgWindow.msgHeaderSink = gMessageHeaderSink;</span>
<a href="#l22.400"></a><span id="l22.400"> </span>
<a href="#l22.401"></a><span id="l22.401"> function* test_message_attachments(info) {</span>
<a href="#l22.402"></a><span id="l22.402">   let synMsg = gMessageGenerator.makeMessage(info);</span>
<a href="#l22.403"></a><span id="l22.403">   let synSet = new SyntheticMessageSet([synMsg]);</span>
<a href="#l22.404"></a><span id="l22.404">   yield add_sets_to_folder(gInbox, [synSet]);</span>
<a href="#l22.405"></a><span id="l22.405"> </span>
<a href="#l22.406"></a><span id="l22.406">   let msgURI = synSet.getMsgURI(0);</span>
<a href="#l22.407"></a><span id="l22.407">   let msgService = gMessenger.messageServiceFromURI(msgURI);</span>
<a href="#l22.408"></a><span id="l22.408"> </span>
<a href="#l22.409"></a><span id="l22.409">   gStreamListener.expectedSize = info.size;</span>
<a href="#l22.410"></a><span id="l22.410" class="difflineminus">-  let streamURI = msgService.streamMessage(</span>
<a href="#l22.411"></a><span id="l22.411" class="difflineplus">+  msgService.streamMessage(</span>
<a href="#l22.412"></a><span id="l22.412">     msgURI,</span>
<a href="#l22.413"></a><span id="l22.413">     gStreamListener,</span>
<a href="#l22.414"></a><span id="l22.414">     msgWindow,</span>
<a href="#l22.415"></a><span id="l22.415">     null,</span>
<a href="#l22.416"></a><span id="l22.416">     true, // have them create the converter</span>
<a href="#l22.417"></a><span id="l22.417">     // additional uri payload, note that &quot;header=&quot; is prepended automatically</span>
<a href="#l22.418"></a><span id="l22.418">     &quot;filter&quot;,</span>
<a href="#l22.419"></a><span id="l22.419" class="difflineminus">-    false);</span>
<a href="#l22.420"></a><span id="l22.420" class="difflineplus">+    false</span>
<a href="#l22.421"></a><span id="l22.421" class="difflineplus">+  );</span>
<a href="#l22.422"></a><span id="l22.422"> </span>
<a href="#l22.423"></a><span id="l22.423">   yield false;</span>
<a href="#l22.424"></a><span id="l22.424"> }</span>
<a href="#l22.425"></a><span id="l22.425"> </span>
<a href="#l22.426"></a><span id="l22.426"> /* ===== Driver ===== */</span>
<a href="#l22.427"></a><span id="l22.427"> </span>
<a href="#l22.428"></a><span id="l22.428"> var tests = [</span>
<a href="#l22.429"></a><span id="l22.429">   parameterizeTest(test_message_attachments, messages),</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/mime/test/unit/test_badContentType.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/mime/test/unit/test_badContentType.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -2,104 +2,113 @@</span>
<a href="#l23.4"></a><span id="l23.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l23.5"></a><span id="l23.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l23.6"></a><span id="l23.6"> </span>
<a href="#l23.7"></a><span id="l23.7"> /**</span>
<a href="#l23.8"></a><span id="l23.8">  * This test checks handling of bad content type of the</span>
<a href="#l23.9"></a><span id="l23.9">  * type reported in bug 659355.</span>
<a href="#l23.10"></a><span id="l23.10">  * Adapted from test_attachment_size.js</span>
<a href="#l23.11"></a><span id="l23.11">  */</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l23.14"></a><span id="l23.14"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l23.15"></a><span id="l23.15"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l23.16"></a><span id="l23.16"> </span>
<a href="#l23.17"></a><span id="l23.17" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l23.18"></a><span id="l23.18" class="difflineplus">+/* import-globals-from ../../../test/resources/messageModifier.js */</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineplus">+/* import-globals-from ../../../test/resources/messageInjection.js */</span>
<a href="#l23.20"></a><span id="l23.20"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l23.21"></a><span id="l23.21"> load(&quot;../../../resources/messageModifier.js&quot;);</span>
<a href="#l23.22"></a><span id="l23.22"> load(&quot;../../../resources/messageInjection.js&quot;);</span>
<a href="#l23.23"></a><span id="l23.23"> </span>
<a href="#l23.24"></a><span id="l23.24"> var gMessenger = Cc[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l23.25"></a><span id="l23.25">                    .createInstance(Ci.nsIMessenger);</span>
<a href="#l23.26"></a><span id="l23.26"> </span>
<a href="#l23.27"></a><span id="l23.27"> // Create a message generator</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineminus">-var msgGen = gMessageGenerator = new MessageGenerator();</span>
<a href="#l23.29"></a><span id="l23.29" class="difflineminus">-// Create a message scenario generator using that message generator</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineminus">-var scenarios = gMessageScenarioFactory = new MessageScenarioFactory(msgGen);</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineplus">+var gMessageGenerator = new MessageGenerator();</span>
<a href="#l23.32"></a><span id="l23.32"> </span>
<a href="#l23.33"></a><span id="l23.33"> var imageAttachment =</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineminus">-  'iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAYAAABWdVznAAAABHNCSVQICAgIfAhkiAAAAAlwS' +</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineminus">-  'FlzAAAN1wAADdcBQiibeAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAA' +</span>
<a href="#l23.36"></a><span id="l23.36" class="difflineminus">-  'A5SURBVCiRY/z//z8DKYCJJNXkaGBgYGD4D8NQ5zUgiTVAxeBqSLaBkVRPM0KtIhrQ3km0jwe' +</span>
<a href="#l23.37"></a><span id="l23.37" class="difflineminus">-  'SNQAAlmAY+71EgFoAAAAASUVORK5CYII=';</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineplus">+  &quot;iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAYAAABWdVznAAAABHNCSVQICAgIfAhkiAAAAAlwS&quot; +</span>
<a href="#l23.39"></a><span id="l23.39" class="difflineplus">+  &quot;FlzAAAN1wAADdcBQiibeAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAA&quot; +</span>
<a href="#l23.40"></a><span id="l23.40" class="difflineplus">+  &quot;A5SURBVCiRY/z//z8DKYCJJNXkaGBgYGD4D8NQ5zUgiTVAxeBqSLaBkVRPM0KtIhrQ3km0jwe&quot; +</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineplus">+  &quot;SNQAAlmAY+71EgFoAAAAASUVORK5CYII=&quot;;</span>
<a href="#l23.42"></a><span id="l23.42"> </span>
<a href="#l23.43"></a><span id="l23.43"> // create some messages that have various types of attachments</span>
<a href="#l23.44"></a><span id="l23.44"> var messages = [</span>
<a href="#l23.45"></a><span id="l23.45">   // image attachment (normal content type sanity test)</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineminus">-  { attachments: [{ body: imageAttachment,</span>
<a href="#l23.47"></a><span id="l23.47" class="difflineminus">-                    contentType: 'image/png',</span>
<a href="#l23.48"></a><span id="l23.48" class="difflineminus">-                    filename: 'lines.png',</span>
<a href="#l23.49"></a><span id="l23.49" class="difflineminus">-                    encoding: 'base64',</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineminus">-                    format: '' }],</span>
<a href="#l23.51"></a><span id="l23.51" class="difflineminus">-    testContentType: &quot;image/png&quot; },</span>
<a href="#l23.52"></a><span id="l23.52" class="difflineminus">-  { attachments: [{ body: imageAttachment,</span>
<a href="#l23.53"></a><span id="l23.53" class="difflineminus">-                    contentType: '=?windows-1252?q?application/pdf',</span>
<a href="#l23.54"></a><span id="l23.54" class="difflineminus">-                    filename: 'lines.pdf',</span>
<a href="#l23.55"></a><span id="l23.55" class="difflineminus">-                    encoding: 'base64',</span>
<a href="#l23.56"></a><span id="l23.56" class="difflineminus">-                    format: '' }],</span>
<a href="#l23.57"></a><span id="l23.57" class="difflineminus">-    testContentType: &quot;application/pdf&quot; },</span>
<a href="#l23.58"></a><span id="l23.58" class="difflineplus">+  {</span>
<a href="#l23.59"></a><span id="l23.59" class="difflineplus">+    attachments: [{</span>
<a href="#l23.60"></a><span id="l23.60" class="difflineplus">+      body: imageAttachment,</span>
<a href="#l23.61"></a><span id="l23.61" class="difflineplus">+      contentType: &quot;image/png&quot;,</span>
<a href="#l23.62"></a><span id="l23.62" class="difflineplus">+      filename: &quot;lines.png&quot;,</span>
<a href="#l23.63"></a><span id="l23.63" class="difflineplus">+      encoding: &quot;base64&quot;,</span>
<a href="#l23.64"></a><span id="l23.64" class="difflineplus">+      format: &quot;&quot;,</span>
<a href="#l23.65"></a><span id="l23.65" class="difflineplus">+    }],</span>
<a href="#l23.66"></a><span id="l23.66" class="difflineplus">+    testContentType: &quot;image/png&quot;,</span>
<a href="#l23.67"></a><span id="l23.67" class="difflineplus">+  }, {</span>
<a href="#l23.68"></a><span id="l23.68" class="difflineplus">+    attachments: [{</span>
<a href="#l23.69"></a><span id="l23.69" class="difflineplus">+      body: imageAttachment,</span>
<a href="#l23.70"></a><span id="l23.70" class="difflineplus">+      contentType: &quot;=?windows-1252?q?application/pdf&quot;,</span>
<a href="#l23.71"></a><span id="l23.71" class="difflineplus">+      filename: &quot;lines.pdf&quot;,</span>
<a href="#l23.72"></a><span id="l23.72" class="difflineplus">+      encoding: &quot;base64&quot;,</span>
<a href="#l23.73"></a><span id="l23.73" class="difflineplus">+      format: &quot;&quot;,</span>
<a href="#l23.74"></a><span id="l23.74" class="difflineplus">+    }],</span>
<a href="#l23.75"></a><span id="l23.75" class="difflineplus">+    testContentType: &quot;application/pdf&quot;,</span>
<a href="#l23.76"></a><span id="l23.76" class="difflineplus">+  },</span>
<a href="#l23.77"></a><span id="l23.77"> ];</span>
<a href="#l23.78"></a><span id="l23.78"> </span>
<a href="#l23.79"></a><span id="l23.79"> var gStreamListener = {</span>
<a href="#l23.80"></a><span id="l23.80">   QueryInterface: ChromeUtils.generateQI([Ci.nsIStreamListener]),</span>
<a href="#l23.81"></a><span id="l23.81"> </span>
<a href="#l23.82"></a><span id="l23.82">   // nsIRequestObserver part</span>
<a href="#l23.83"></a><span id="l23.83" class="difflineminus">-  onStartRequest: function (aRequest) {</span>
<a href="#l23.84"></a><span id="l23.84" class="difflineplus">+  onStartRequest(aRequest) {</span>
<a href="#l23.85"></a><span id="l23.85">     // We reset the size here because we know that we only expect one attachment</span>
<a href="#l23.86"></a><span id="l23.86">     //  per test email</span>
<a href="#l23.87"></a><span id="l23.87">     // msgHdrViewOverlay.js has a stack of attachment infos that properly</span>
<a href="#l23.88"></a><span id="l23.88">     //  handles this.</span>
<a href="#l23.89"></a><span id="l23.89">     gMessageHeaderSink.size = null;</span>
<a href="#l23.90"></a><span id="l23.90">   },</span>
<a href="#l23.91"></a><span id="l23.91" class="difflineminus">-  onStopRequest: function (aRequest, aStatusCode) {</span>
<a href="#l23.92"></a><span id="l23.92" class="difflineminus">-    dump(&quot;*** ContentType is &quot;+gMessageHeaderSink.contentType+&quot; (expecting &quot;+this.expectedContentType+&quot;)\n\n&quot;);</span>
<a href="#l23.93"></a><span id="l23.93" class="difflineplus">+  onStopRequest(aRequest, aStatusCode) {</span>
<a href="#l23.94"></a><span id="l23.94" class="difflineplus">+    dump(&quot;*** ContentType is &quot; + gMessageHeaderSink.contentType + &quot; (expecting &quot; + this.expectedContentType + &quot;)\n\n&quot;);</span>
<a href="#l23.95"></a><span id="l23.95">     Assert.equal(gMessageHeaderSink.contentType, this.expectedContentType);</span>
<a href="#l23.96"></a><span id="l23.96">     this._stream = null;</span>
<a href="#l23.97"></a><span id="l23.97">     async_driver();</span>
<a href="#l23.98"></a><span id="l23.98">   },</span>
<a href="#l23.99"></a><span id="l23.99"> </span>
<a href="#l23.100"></a><span id="l23.100">   // nsIStreamListener part</span>
<a href="#l23.101"></a><span id="l23.101" class="difflineminus">-  _stream : null,</span>
<a href="#l23.102"></a><span id="l23.102" class="difflineplus">+  _stream: null,</span>
<a href="#l23.103"></a><span id="l23.103"> </span>
<a href="#l23.104"></a><span id="l23.104" class="difflineminus">-  onDataAvailable: function (aRequest, aInputStream, aOffset, aCount) {</span>
<a href="#l23.105"></a><span id="l23.105" class="difflineplus">+  onDataAvailable(aRequest, aInputStream, aOffset, aCount) {</span>
<a href="#l23.106"></a><span id="l23.106">     if (this._stream === null) {</span>
<a href="#l23.107"></a><span id="l23.107">       this._stream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;].</span>
<a href="#l23.108"></a><span id="l23.108">                     createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l23.109"></a><span id="l23.109">       this._stream.init(aInputStream);</span>
<a href="#l23.110"></a><span id="l23.110">     }</span>
<a href="#l23.111"></a><span id="l23.111">     this._stream.read(aCount);</span>
<a href="#l23.112"></a><span id="l23.112">   },</span>
<a href="#l23.113"></a><span id="l23.113"> };</span>
<a href="#l23.114"></a><span id="l23.114"> </span>
<a href="#l23.115"></a><span id="l23.115"> var gMessageHeaderSink = {</span>
<a href="#l23.116"></a><span id="l23.116" class="difflineminus">-  handleAttachment: function(aContentType, aUrl, aDisplayName, aUri,</span>
<a href="#l23.117"></a><span id="l23.117" class="difflineminus">-                             aIsExternalAttachment) {</span>
<a href="#l23.118"></a><span id="l23.118" class="difflineplus">+  handleAttachment(aContentType, aUrl, aDisplayName, aUri, aIsExternalAttachment) {</span>
<a href="#l23.119"></a><span id="l23.119">     gMessageHeaderSink.contentType = aContentType;</span>
<a href="#l23.120"></a><span id="l23.120">   },</span>
<a href="#l23.121"></a><span id="l23.121"> </span>
<a href="#l23.122"></a><span id="l23.122">   // stub functions from nsIMsgHeaderSink</span>
<a href="#l23.123"></a><span id="l23.123" class="difflineminus">-  addAttachmentField: function(aName, aValue) {},</span>
<a href="#l23.124"></a><span id="l23.124" class="difflineminus">-  onStartHeaders: function() {},</span>
<a href="#l23.125"></a><span id="l23.125" class="difflineminus">-  onEndHeaders: function() {},</span>
<a href="#l23.126"></a><span id="l23.126" class="difflineminus">-  processHeaders: function(aHeaderNames, aHeaderValues, dontCollectAddrs) {},</span>
<a href="#l23.127"></a><span id="l23.127" class="difflineminus">-  onEndAllAttachments: function() {},</span>
<a href="#l23.128"></a><span id="l23.128" class="difflineminus">-  onEndMsgDownload: function() {},</span>
<a href="#l23.129"></a><span id="l23.129" class="difflineminus">-  onEndMsgHeaders: function(aUrl) {},</span>
<a href="#l23.130"></a><span id="l23.130" class="difflineminus">-  onMsgHasRemoteContent: function(aMsgHdr, aContentURI) {},</span>
<a href="#l23.131"></a><span id="l23.131" class="difflineplus">+  addAttachmentField(aName, aValue) {},</span>
<a href="#l23.132"></a><span id="l23.132" class="difflineplus">+  onStartHeaders() {},</span>
<a href="#l23.133"></a><span id="l23.133" class="difflineplus">+  onEndHeaders() {},</span>
<a href="#l23.134"></a><span id="l23.134" class="difflineplus">+  processHeaders(aHeaderNames, aHeaderValues, dontCollectAddrs) {},</span>
<a href="#l23.135"></a><span id="l23.135" class="difflineplus">+  onEndAllAttachments() {},</span>
<a href="#l23.136"></a><span id="l23.136" class="difflineplus">+  onEndMsgDownload() {},</span>
<a href="#l23.137"></a><span id="l23.137" class="difflineplus">+  onEndMsgHeaders(aUrl) {},</span>
<a href="#l23.138"></a><span id="l23.138" class="difflineplus">+  onMsgHasRemoteContent(aMsgHdr, aContentURI) {},</span>
<a href="#l23.139"></a><span id="l23.139">   securityInfo: null,</span>
<a href="#l23.140"></a><span id="l23.140">   mDummyMsgHeader: null,</span>
<a href="#l23.141"></a><span id="l23.141">   properties: null,</span>
<a href="#l23.142"></a><span id="l23.142" class="difflineminus">-  resetProperties: function () {}</span>
<a href="#l23.143"></a><span id="l23.143" class="difflineplus">+  resetProperties() {},</span>
<a href="#l23.144"></a><span id="l23.144"> };</span>
<a href="#l23.145"></a><span id="l23.145"> </span>
<a href="#l23.146"></a><span id="l23.146"> var msgWindow = Cc[&quot;@mozilla.org/messenger/msgwindow;1&quot;]</span>
<a href="#l23.147"></a><span id="l23.147">                   .createInstance(Ci.nsIMsgWindow);</span>
<a href="#l23.148"></a><span id="l23.148"> msgWindow.msgHeaderSink = gMessageHeaderSink;</span>
<a href="#l23.149"></a><span id="l23.149"> </span>
<a href="#l23.150"></a><span id="l23.150"> function* test_message_attachments(info) {</span>
<a href="#l23.151"></a><span id="l23.151">   let synMsg = gMessageGenerator.makeMessage(info);</span>
<a href="#l23.152"></a><span id="l23.152" class="difflineat">@@ -107,17 +116,17 @@ function* test_message_attachments(info)</span>
<a href="#l23.153"></a><span id="l23.153">   yield add_sets_to_folder(gInbox, [synSet]);</span>
<a href="#l23.154"></a><span id="l23.154"> </span>
<a href="#l23.155"></a><span id="l23.155">   let msgURI = synSet.getMsgURI(0);</span>
<a href="#l23.156"></a><span id="l23.156">   let msgService = gMessenger.messageServiceFromURI(msgURI);</span>
<a href="#l23.157"></a><span id="l23.157"> </span>
<a href="#l23.158"></a><span id="l23.158">   gStreamListener.expectedContentType = info.testContentType;</span>
<a href="#l23.159"></a><span id="l23.159"> </span>
<a href="#l23.160"></a><span id="l23.160">   dump(&quot;*** original ContentType=&quot; + info.attachments[0].contentType + &quot;\n&quot;);</span>
<a href="#l23.161"></a><span id="l23.161" class="difflineminus">-  let streamURI = msgService.streamMessage(</span>
<a href="#l23.162"></a><span id="l23.162" class="difflineplus">+  msgService.streamMessage(</span>
<a href="#l23.163"></a><span id="l23.163">     msgURI,</span>
<a href="#l23.164"></a><span id="l23.164">     gStreamListener,</span>
<a href="#l23.165"></a><span id="l23.165">     msgWindow,</span>
<a href="#l23.166"></a><span id="l23.166">     null,</span>
<a href="#l23.167"></a><span id="l23.167">     true, // have them create the converter</span>
<a href="#l23.168"></a><span id="l23.168">     // additional uri payload, note that &quot;header=&quot; is prepended automatically</span>
<a href="#l23.169"></a><span id="l23.169">     &quot;filter&quot;,</span>
<a href="#l23.170"></a><span id="l23.170">     false);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/mime/test/unit/test_bug493544.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/mime/test/unit/test_bug493544.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -1,84 +1,92 @@</span>
<a href="#l24.4"></a><span id="l24.4"> //</span>
<a href="#l24.5"></a><span id="l24.5"> // Tests if a multi-line MIME header is parsed even if it violates RFC 2047</span>
<a href="#l24.6"></a><span id="l24.6"> //</span>
<a href="#l24.7"></a><span id="l24.7"> </span>
<a href="#l24.8"></a><span id="l24.8"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l24.9"></a><span id="l24.9"> </span>
<a href="#l24.10"></a><span id="l24.10"> function run_test() {</span>
<a href="#l24.11"></a><span id="l24.11">   const headers = [</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-    { encoded:</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineminus">-      &quot;Subject: AAA =?UTF-8?Q?bbb?= CCC =?UTF-8?Q?ddd?= EEE =?UTF-8?Q?fff?= GGG&quot;</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineminus">-    , defaultCharset: &quot;UTF-8&quot;</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineminus">-    , overrideCharset: false</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineminus">-    , eatContinuation: false</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineminus">-    , decoded: &quot;Subject: AAA bbb CCC ddd EEE fff GGG&quot;</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineminus">-    }, // Bug 833028</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineminus">-    { encoded:</span>
<a href="#l24.20"></a><span id="l24.20" class="difflineminus">-      &quot;Subject: =?UTF-8?B?4oiAICDiiIEgIOKIgiAg4oiDICDiiIQgIOKIhSAg4oiGICDiiIcgIOKIiCAg?=\n&quot;</span>
<a href="#l24.21"></a><span id="l24.21" class="difflineminus">-    + &quot; =?UTF-8?B?4oiJICDiiIogIOKIiyAg4oiMICDiiI0gIOKIjiAg4oiP?=&quot;</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineminus">-    , defaultCharset: &quot;UTF-8&quot;</span>
<a href="#l24.23"></a><span id="l24.23" class="difflineminus">-    , overrideCharset: false</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineminus">-    , eatContinuation: false</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineminus">-    , decoded: &quot;Subject: ∀  ∁  ∂  ∃  ∄  ∅  ∆  ∇  ∈  ∉  ∊  ∋  ∌  ∍  ∎  ∏&quot;</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineminus">-    }, // Bug 493544</span>
<a href="#l24.27"></a><span id="l24.27" class="difflineminus">-    { encoded:</span>
<a href="#l24.28"></a><span id="l24.28" class="difflineminus">-      &quot;Subject: =?utf-8?Q?=E2=88=80__=E2=88=81__=E2=88=82__=E2=88=83__=E2=88=84__=E2?=\n&quot;</span>
<a href="#l24.29"></a><span id="l24.29" class="difflineminus">-    + &quot; =?utf-8?Q?=88=85__=E2=88=86__=E2=88=87__=E2=88=88__=E2=88=89__=E2=88?=\n&quot;</span>
<a href="#l24.30"></a><span id="l24.30" class="difflineminus">-    + &quot; =?utf-8?Q?=8A__=E2=88=8B__=E2=88=8C__=E2=88=8D__=E2=88=8E__=E2=88=8F?=&quot;</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineminus">-    , defaultCharset: &quot;UTF-8&quot;</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineminus">-    , overrideCharset: false</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineminus">-    , eatContinuation: false</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineminus">-    , decoded: &quot;Subject: ∀  ∁  ∂  ∃  ∄  ∅  ∆  ∇  ∈  ∉  ∊  ∋  ∌  ∍  ∎  ∏&quot;</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineminus">-    }, // Bug 476741</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineminus">-    { encoded:</span>
<a href="#l24.37"></a><span id="l24.37" class="difflineminus">-      &quot;Subject: =?UTF-8?B?4oiAICDiiIEgIOKIgiAg4oiDICDiiIQgIOKIhSAg4oiGICDiiIcgIOKIiA==?=\n&quot;</span>
<a href="#l24.38"></a><span id="l24.38" class="difflineminus">-    + &quot; =?UTF-8?B?ICDiiIkgIOKIiiAg4oiLICDiiIwgIOKIjSAg4oiOICDiiI8=?=&quot;</span>
<a href="#l24.39"></a><span id="l24.39" class="difflineminus">-    , defaultCharset: &quot;UTF-8&quot;</span>
<a href="#l24.40"></a><span id="l24.40" class="difflineminus">-    , overrideCharset: false</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineminus">-    , eatContinuation: false</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineminus">-    , decoded: &quot;Subject: ∀  ∁  ∂  ∃  ∄  ∅  ∆  ∇  ∈  ∉  ∊  ∋  ∌  ∍  ∎  ∏&quot;</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineminus">-    }, // Normal case</span>
<a href="#l24.44"></a><span id="l24.44" class="difflineminus">-    { encoded:</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineminus">-      &quot;Subject: =?UTF-8?b?4oiAICDiiIEgIOKIgiAg4oiDICDiiIQgIOKIhSAg4oiGICDiiIcgIOKIiA==?=\n&quot;</span>
<a href="#l24.46"></a><span id="l24.46" class="difflineminus">-    + &quot; =?UTF-8?b?ICDiiIkgIOKIiiAg4oiLICDiiIwgIOKIjSAg4oiOICDiiI8=?=&quot;</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineminus">-    , defaultCharset: &quot;UTF-8&quot;</span>
<a href="#l24.48"></a><span id="l24.48" class="difflineminus">-    , overrideCharset: false</span>
<a href="#l24.49"></a><span id="l24.49" class="difflineminus">-    , eatContinuation: false</span>
<a href="#l24.50"></a><span id="l24.50" class="difflineminus">-    , decoded: &quot;Subject: ∀  ∁  ∂  ∃  ∄  ∅  ∆  ∇  ∈  ∉  ∊  ∋  ∌  ∍  ∎  ∏&quot;</span>
<a href="#l24.51"></a><span id="l24.51" class="difflineminus">-    }, // Normal case with the encoding character in lower case</span>
<a href="#l24.52"></a><span id="l24.52" class="difflineminus">-    { encoded:</span>
<a href="#l24.53"></a><span id="l24.53" class="difflineminus">-      &quot;Subject: =?utf-8?Q?=E2=88=80__=E2=88=81__=E2=88=82__=E2=88=83__=E2=88=84__?=\n&quot;</span>
<a href="#l24.54"></a><span id="l24.54" class="difflineminus">-    + &quot; =?utf-8?Q?=E2=88=85__=E2=88=86__=E2=88=87__=E2=88=88__=E2=88=89__?=\n&quot;</span>
<a href="#l24.55"></a><span id="l24.55" class="difflineminus">-    + &quot; =?utf-8?Q?=E2=88=8A__=E2=88=8B__=E2=88=8C__=E2=88=8D__=E2=88=8E__?=\n&quot;</span>
<a href="#l24.56"></a><span id="l24.56" class="difflineminus">-    + &quot; =?utf-8?Q?=E2=88=8F?=&quot;</span>
<a href="#l24.57"></a><span id="l24.57" class="difflineminus">-    , defaultCharset: &quot;UTF-8&quot;</span>
<a href="#l24.58"></a><span id="l24.58" class="difflineminus">-    , overrideCharset: false</span>
<a href="#l24.59"></a><span id="l24.59" class="difflineminus">-    , eatContinuation: false</span>
<a href="#l24.60"></a><span id="l24.60" class="difflineminus">-    , decoded: &quot;Subject: ∀  ∁  ∂  ∃  ∄  ∅  ∆  ∇  ∈  ∉  ∊  ∋  ∌  ∍  ∎  ∏&quot;</span>
<a href="#l24.61"></a><span id="l24.61" class="difflineminus">-    }, // Normal case</span>
<a href="#l24.62"></a><span id="l24.62" class="difflineminus">-    { encoded:</span>
<a href="#l24.63"></a><span id="l24.63" class="difflineminus">-      &quot;Subject: =?utf-8?q?=E2=88=80__=E2=88=81__=E2=88=82__=E2=88=83__=E2=88=84__?=\n&quot;</span>
<a href="#l24.64"></a><span id="l24.64" class="difflineminus">-    + &quot; =?utf-8?q?=E2=88=85__=E2=88=86__=E2=88=87__=E2=88=88__=E2=88=89__?=\n&quot;</span>
<a href="#l24.65"></a><span id="l24.65" class="difflineminus">-    + &quot; =?utf-8?q?=E2=88=8A__=E2=88=8B__=E2=88=8C__=E2=88=8D__=E2=88=8E__?=\n&quot;</span>
<a href="#l24.66"></a><span id="l24.66" class="difflineminus">-    + &quot; =?utf-8?q?=E2=88=8F?=&quot;</span>
<a href="#l24.67"></a><span id="l24.67" class="difflineminus">-    , defaultCharset: &quot;UTF-8&quot;</span>
<a href="#l24.68"></a><span id="l24.68" class="difflineminus">-    , overrideCharset: false</span>
<a href="#l24.69"></a><span id="l24.69" class="difflineminus">-    , eatContinuation: false</span>
<a href="#l24.70"></a><span id="l24.70" class="difflineminus">-    , decoded: &quot;Subject: ∀  ∁  ∂  ∃  ∄  ∅  ∆  ∇  ∈  ∉  ∊  ∋  ∌  ∍  ∎  ∏&quot;</span>
<a href="#l24.71"></a><span id="l24.71" class="difflineminus">-    }, // Normal case with the encoding character in lower case</span>
<a href="#l24.72"></a><span id="l24.72" class="difflineminus">-    { encoded:</span>
<a href="#l24.73"></a><span id="l24.73" class="difflineminus">-      &quot;Subject: =?UTF-8?B?4oiAICDiiIEgIOKIgiAg4oiDICDiiIQgIOKIhSAg4oiGICDiiIcgIOKIiA===?=\n&quot;</span>
<a href="#l24.74"></a><span id="l24.74" class="difflineminus">-    + &quot; =?UTF-8?B?ICDiiIkgIOKIiiAg4oiLICDiiIwgIOKIjSAg4oiOICDiiI8=?=&quot;</span>
<a href="#l24.75"></a><span id="l24.75" class="difflineminus">-    , defaultCharset: &quot;UTF-8&quot;</span>
<a href="#l24.76"></a><span id="l24.76" class="difflineminus">-    , overrideCharset: false</span>
<a href="#l24.77"></a><span id="l24.77" class="difflineminus">-    , eatContinuation: false</span>
<a href="#l24.78"></a><span id="l24.78" class="difflineminus">-    , decoded: &quot;Subject: ∀  ∁  ∂  ∃  ∄  ∅  ∆  ∇  ∈  ∉  ∊  ∋  ∌  ∍  ∎  ∏&quot;</span>
<a href="#l24.79"></a><span id="l24.79" class="difflineminus">-    }, // Regression test for bug 227290</span>
<a href="#l24.80"></a><span id="l24.80" class="difflineplus">+    {</span>
<a href="#l24.81"></a><span id="l24.81" class="difflineplus">+      // Bug 833028</span>
<a href="#l24.82"></a><span id="l24.82" class="difflineplus">+      encoded: &quot;Subject: AAA =?UTF-8?Q?bbb?= CCC =?UTF-8?Q?ddd?= EEE =?UTF-8?Q?fff?= GGG&quot;,</span>
<a href="#l24.83"></a><span id="l24.83" class="difflineplus">+      defaultCharset: &quot;UTF-8&quot;,</span>
<a href="#l24.84"></a><span id="l24.84" class="difflineplus">+      overrideCharset: false,</span>
<a href="#l24.85"></a><span id="l24.85" class="difflineplus">+      eatContinuation: false,</span>
<a href="#l24.86"></a><span id="l24.86" class="difflineplus">+      decoded: &quot;Subject: AAA bbb CCC ddd EEE fff GGG&quot;,</span>
<a href="#l24.87"></a><span id="l24.87" class="difflineplus">+    }, {</span>
<a href="#l24.88"></a><span id="l24.88" class="difflineplus">+      // Bug 493544</span>
<a href="#l24.89"></a><span id="l24.89" class="difflineplus">+      encoded:</span>
<a href="#l24.90"></a><span id="l24.90" class="difflineplus">+        &quot;Subject: =?UTF-8?B?4oiAICDiiIEgIOKIgiAg4oiDICDiiIQgIOKIhSAg4oiGICDiiIcgIOKIiCAg?=\n&quot; +</span>
<a href="#l24.91"></a><span id="l24.91" class="difflineplus">+        &quot; =?UTF-8?B?4oiJICDiiIogIOKIiyAg4oiMICDiiI0gIOKIjiAg4oiP?=&quot;,</span>
<a href="#l24.92"></a><span id="l24.92" class="difflineplus">+      defaultCharset: &quot;UTF-8&quot;,</span>
<a href="#l24.93"></a><span id="l24.93" class="difflineplus">+      overrideCharset: false,</span>
<a href="#l24.94"></a><span id="l24.94" class="difflineplus">+      eatContinuation: false,</span>
<a href="#l24.95"></a><span id="l24.95" class="difflineplus">+      decoded: &quot;Subject: ∀  ∁  ∂  ∃  ∄  ∅  ∆  ∇  ∈  ∉  ∊  ∋  ∌  ∍  ∎  ∏&quot;,</span>
<a href="#l24.96"></a><span id="l24.96" class="difflineplus">+    }, {</span>
<a href="#l24.97"></a><span id="l24.97" class="difflineplus">+      // Bug 476741</span>
<a href="#l24.98"></a><span id="l24.98" class="difflineplus">+      encoded:</span>
<a href="#l24.99"></a><span id="l24.99" class="difflineplus">+        &quot;Subject: =?utf-8?Q?=E2=88=80__=E2=88=81__=E2=88=82__=E2=88=83__=E2=88=84__=E2?=\n&quot; +</span>
<a href="#l24.100"></a><span id="l24.100" class="difflineplus">+        &quot; =?utf-8?Q?=88=85__=E2=88=86__=E2=88=87__=E2=88=88__=E2=88=89__=E2=88?=\n&quot; +</span>
<a href="#l24.101"></a><span id="l24.101" class="difflineplus">+        &quot; =?utf-8?Q?=8A__=E2=88=8B__=E2=88=8C__=E2=88=8D__=E2=88=8E__=E2=88=8F?=&quot;,</span>
<a href="#l24.102"></a><span id="l24.102" class="difflineplus">+      defaultCharset: &quot;UTF-8&quot;,</span>
<a href="#l24.103"></a><span id="l24.103" class="difflineplus">+      overrideCharset: false,</span>
<a href="#l24.104"></a><span id="l24.104" class="difflineplus">+      eatContinuation: false,</span>
<a href="#l24.105"></a><span id="l24.105" class="difflineplus">+      decoded: &quot;Subject: ∀  ∁  ∂  ∃  ∄  ∅  ∆  ∇  ∈  ∉  ∊  ∋  ∌  ∍  ∎  ∏&quot;,</span>
<a href="#l24.106"></a><span id="l24.106" class="difflineplus">+    }, {</span>
<a href="#l24.107"></a><span id="l24.107" class="difflineplus">+      // Normal case</span>
<a href="#l24.108"></a><span id="l24.108" class="difflineplus">+      encoded:</span>
<a href="#l24.109"></a><span id="l24.109" class="difflineplus">+        &quot;Subject: =?UTF-8?B?4oiAICDiiIEgIOKIgiAg4oiDICDiiIQgIOKIhSAg4oiGICDiiIcgIOKIiA==?=\n&quot; +</span>
<a href="#l24.110"></a><span id="l24.110" class="difflineplus">+        &quot; =?UTF-8?B?ICDiiIkgIOKIiiAg4oiLICDiiIwgIOKIjSAg4oiOICDiiI8=?=&quot;,</span>
<a href="#l24.111"></a><span id="l24.111" class="difflineplus">+      defaultCharset: &quot;UTF-8&quot;,</span>
<a href="#l24.112"></a><span id="l24.112" class="difflineplus">+      overrideCharset: false,</span>
<a href="#l24.113"></a><span id="l24.113" class="difflineplus">+      eatContinuation: false,</span>
<a href="#l24.114"></a><span id="l24.114" class="difflineplus">+      decoded: &quot;Subject: ∀  ∁  ∂  ∃  ∄  ∅  ∆  ∇  ∈  ∉  ∊  ∋  ∌  ∍  ∎  ∏&quot;,</span>
<a href="#l24.115"></a><span id="l24.115" class="difflineplus">+    }, {</span>
<a href="#l24.116"></a><span id="l24.116" class="difflineplus">+      // Normal case with the encoding character in lower case</span>
<a href="#l24.117"></a><span id="l24.117" class="difflineplus">+      encoded:</span>
<a href="#l24.118"></a><span id="l24.118" class="difflineplus">+        &quot;Subject: =?UTF-8?b?4oiAICDiiIEgIOKIgiAg4oiDICDiiIQgIOKIhSAg4oiGICDiiIcgIOKIiA==?=\n&quot; +</span>
<a href="#l24.119"></a><span id="l24.119" class="difflineplus">+        &quot; =?UTF-8?b?ICDiiIkgIOKIiiAg4oiLICDiiIwgIOKIjSAg4oiOICDiiI8=?=&quot;,</span>
<a href="#l24.120"></a><span id="l24.120" class="difflineplus">+      defaultCharset: &quot;UTF-8&quot;,</span>
<a href="#l24.121"></a><span id="l24.121" class="difflineplus">+      overrideCharset: false,</span>
<a href="#l24.122"></a><span id="l24.122" class="difflineplus">+      eatContinuation: false,</span>
<a href="#l24.123"></a><span id="l24.123" class="difflineplus">+      decoded: &quot;Subject: ∀  ∁  ∂  ∃  ∄  ∅  ∆  ∇  ∈  ∉  ∊  ∋  ∌  ∍  ∎  ∏&quot;,</span>
<a href="#l24.124"></a><span id="l24.124" class="difflineplus">+    }, {</span>
<a href="#l24.125"></a><span id="l24.125" class="difflineplus">+      // Normal case</span>
<a href="#l24.126"></a><span id="l24.126" class="difflineplus">+      encoded:</span>
<a href="#l24.127"></a><span id="l24.127" class="difflineplus">+        &quot;Subject: =?utf-8?Q?=E2=88=80__=E2=88=81__=E2=88=82__=E2=88=83__=E2=88=84__?=\n&quot; +</span>
<a href="#l24.128"></a><span id="l24.128" class="difflineplus">+        &quot; =?utf-8?Q?=E2=88=85__=E2=88=86__=E2=88=87__=E2=88=88__=E2=88=89__?=\n&quot; +</span>
<a href="#l24.129"></a><span id="l24.129" class="difflineplus">+        &quot; =?utf-8?Q?=E2=88=8A__=E2=88=8B__=E2=88=8C__=E2=88=8D__=E2=88=8E__?=\n&quot; +</span>
<a href="#l24.130"></a><span id="l24.130" class="difflineplus">+        &quot; =?utf-8?Q?=E2=88=8F?=&quot;,</span>
<a href="#l24.131"></a><span id="l24.131" class="difflineplus">+      defaultCharset: &quot;UTF-8&quot;,</span>
<a href="#l24.132"></a><span id="l24.132" class="difflineplus">+      overrideCharset: false,</span>
<a href="#l24.133"></a><span id="l24.133" class="difflineplus">+      eatContinuation: false,</span>
<a href="#l24.134"></a><span id="l24.134" class="difflineplus">+      decoded: &quot;Subject: ∀  ∁  ∂  ∃  ∄  ∅  ∆  ∇  ∈  ∉  ∊  ∋  ∌  ∍  ∎  ∏&quot;,</span>
<a href="#l24.135"></a><span id="l24.135" class="difflineplus">+    }, {</span>
<a href="#l24.136"></a><span id="l24.136" class="difflineplus">+      // Normal case with the encoding character in lower case</span>
<a href="#l24.137"></a><span id="l24.137" class="difflineplus">+      encoded:</span>
<a href="#l24.138"></a><span id="l24.138" class="difflineplus">+        &quot;Subject: =?utf-8?q?=E2=88=80__=E2=88=81__=E2=88=82__=E2=88=83__=E2=88=84__?=\n&quot; +</span>
<a href="#l24.139"></a><span id="l24.139" class="difflineplus">+        &quot; =?utf-8?q?=E2=88=85__=E2=88=86__=E2=88=87__=E2=88=88__=E2=88=89__?=\n&quot; +</span>
<a href="#l24.140"></a><span id="l24.140" class="difflineplus">+        &quot; =?utf-8?q?=E2=88=8A__=E2=88=8B__=E2=88=8C__=E2=88=8D__=E2=88=8E__?=\n&quot; +</span>
<a href="#l24.141"></a><span id="l24.141" class="difflineplus">+        &quot; =?utf-8?q?=E2=88=8F?=&quot;,</span>
<a href="#l24.142"></a><span id="l24.142" class="difflineplus">+      defaultCharset: &quot;UTF-8&quot;,</span>
<a href="#l24.143"></a><span id="l24.143" class="difflineplus">+      overrideCharset: false,</span>
<a href="#l24.144"></a><span id="l24.144" class="difflineplus">+      eatContinuation: false,</span>
<a href="#l24.145"></a><span id="l24.145" class="difflineplus">+      decoded: &quot;Subject: ∀  ∁  ∂  ∃  ∄  ∅  ∆  ∇  ∈  ∉  ∊  ∋  ∌  ∍  ∎  ∏&quot;,</span>
<a href="#l24.146"></a><span id="l24.146" class="difflineplus">+    }, {</span>
<a href="#l24.147"></a><span id="l24.147" class="difflineplus">+      // Regression test for bug 227290</span>
<a href="#l24.148"></a><span id="l24.148" class="difflineplus">+      encoded:</span>
<a href="#l24.149"></a><span id="l24.149" class="difflineplus">+        &quot;Subject: =?UTF-8?B?4oiAICDiiIEgIOKIgiAg4oiDICDiiIQgIOKIhSAg4oiGICDiiIcgIOKIiA===?=\n&quot; +</span>
<a href="#l24.150"></a><span id="l24.150" class="difflineplus">+        &quot; =?UTF-8?B?ICDiiIkgIOKIiiAg4oiLICDiiIwgIOKIjSAg4oiOICDiiI8=?=&quot;,</span>
<a href="#l24.151"></a><span id="l24.151" class="difflineplus">+      defaultCharset: &quot;UTF-8&quot;,</span>
<a href="#l24.152"></a><span id="l24.152" class="difflineplus">+      overrideCharset: false,</span>
<a href="#l24.153"></a><span id="l24.153" class="difflineplus">+      eatContinuation: false,</span>
<a href="#l24.154"></a><span id="l24.154" class="difflineplus">+      decoded: &quot;Subject: ∀  ∁  ∂  ∃  ∄  ∅  ∆  ∇  ∈  ∉  ∊  ∋  ∌  ∍  ∎  ∏&quot;,</span>
<a href="#l24.155"></a><span id="l24.155" class="difflineplus">+    },</span>
<a href="#l24.156"></a><span id="l24.156">   ];</span>
<a href="#l24.157"></a><span id="l24.157"> </span>
<a href="#l24.158"></a><span id="l24.158">   for (let i = 0; i &lt; headers.length; ++i) {</span>
<a href="#l24.159"></a><span id="l24.159">     let decoded = MailServices.mimeConverter.decodeMimeHeader(headers[i].encoded,</span>
<a href="#l24.160"></a><span id="l24.160">                                                               headers[i].defaultCharset,</span>
<a href="#l24.161"></a><span id="l24.161">                                                               headers[i].overrideCharset,</span>
<a href="#l24.162"></a><span id="l24.162">                                                               headers[i].eatContinuation);</span>
<a href="#l24.163"></a><span id="l24.163">     Assert.equal(decoded, headers[i].decoded);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/mime/test/unit/test_hidden_attachments.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/mime/test/unit/test_hidden_attachments.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -1,110 +1,131 @@</span>
<a href="#l25.4"></a><span id="l25.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l25.5"></a><span id="l25.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l25.6"></a><span id="l25.6">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l25.7"></a><span id="l25.7"> </span>
<a href="#l25.8"></a><span id="l25.8"> /**</span>
<a href="#l25.9"></a><span id="l25.9">  * This test creates some messages with attachments of different types and</span>
<a href="#l25.10"></a><span id="l25.10">  * checks that libmime emits (or doesn't emit) the attachments as appropriate.</span>
<a href="#l25.11"></a><span id="l25.11">  */</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineplus">+/* import-globals-from ../../../test/resources/messageModifier.js */</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineplus">+/* import-globals-from ../../../test/resources/messageInjection.js */</span>
<a href="#l25.17"></a><span id="l25.17"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l25.18"></a><span id="l25.18"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l25.19"></a><span id="l25.19"> </span>
<a href="#l25.20"></a><span id="l25.20"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l25.21"></a><span id="l25.21"> load(&quot;../../../resources/messageModifier.js&quot;);</span>
<a href="#l25.22"></a><span id="l25.22"> load(&quot;../../../resources/messageInjection.js&quot;);</span>
<a href="#l25.23"></a><span id="l25.23"> </span>
<a href="#l25.24"></a><span id="l25.24"> var gMessenger = Cc[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l25.25"></a><span id="l25.25">                    .createInstance(Ci.nsIMessenger);</span>
<a href="#l25.26"></a><span id="l25.26"> </span>
<a href="#l25.27"></a><span id="l25.27"> // Create a message generator</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineminus">-var msgGen = gMessageGenerator = new MessageGenerator();</span>
<a href="#l25.29"></a><span id="l25.29" class="difflineminus">-// Create a message scenario generator using that message generator</span>
<a href="#l25.30"></a><span id="l25.30" class="difflineminus">-var scenarios = gMessageScenarioFactory = new MessageScenarioFactory(msgGen);</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineplus">+var gMessageGenerator = new MessageGenerator();</span>
<a href="#l25.32"></a><span id="l25.32"> </span>
<a href="#l25.33"></a><span id="l25.33"> // create some messages that have various types of attachments</span>
<a href="#l25.34"></a><span id="l25.34"> var messages = [</span>
<a href="#l25.35"></a><span id="l25.35">   {},</span>
<a href="#l25.36"></a><span id="l25.36"> </span>
<a href="#l25.37"></a><span id="l25.37" class="difflineminus">-  /***** Attachments with Content-Disposition: attachment *****/</span>
<a href="#l25.38"></a><span id="l25.38" class="difflineplus">+  /* Attachments with Content-Disposition: attachment */</span>
<a href="#l25.39"></a><span id="l25.39"> </span>
<a href="#l25.40"></a><span id="l25.40" class="difflineminus">-  // inline-able attachment with a name</span>
<a href="#l25.41"></a><span id="l25.41" class="difflineminus">-  { attachments: [{ body: &quot;attachment&quot;,</span>
<a href="#l25.42"></a><span id="l25.42" class="difflineminus">-                    filename: &quot;ubik.txt&quot;,</span>
<a href="#l25.43"></a><span id="l25.43" class="difflineminus">-                    disposition: &quot;attachment&quot;,</span>
<a href="#l25.44"></a><span id="l25.44" class="difflineminus">-                    format: &quot;&quot;,</span>
<a href="#l25.45"></a><span id="l25.45" class="difflineminus">-                    shouldShow: true }],</span>
<a href="#l25.46"></a><span id="l25.46" class="difflineminus">-  },</span>
<a href="#l25.47"></a><span id="l25.47" class="difflineminus">-  // inline-able attachment with no name</span>
<a href="#l25.48"></a><span id="l25.48" class="difflineminus">-  { attachments: [{ body: &quot;attachment&quot;,</span>
<a href="#l25.49"></a><span id="l25.49" class="difflineminus">-                    filename: &quot;&quot;,</span>
<a href="#l25.50"></a><span id="l25.50" class="difflineminus">-                    disposition: &quot;attachment&quot;,</span>
<a href="#l25.51"></a><span id="l25.51" class="difflineminus">-                    format: &quot;&quot;,</span>
<a href="#l25.52"></a><span id="l25.52" class="difflineminus">-                    shouldShow: true }],</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineminus">-  },</span>
<a href="#l25.54"></a><span id="l25.54" class="difflineminus">-  // non-inline-able attachment with a name</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineminus">-  { attachments: [{ body: &quot;attachment&quot;,</span>
<a href="#l25.56"></a><span id="l25.56" class="difflineminus">-                    filename: &quot;ubik.ubk&quot;,</span>
<a href="#l25.57"></a><span id="l25.57" class="difflineminus">-                    disposition: &quot;attachment&quot;,</span>
<a href="#l25.58"></a><span id="l25.58" class="difflineminus">-                    contentType: &quot;application/x-ubik&quot;,</span>
<a href="#l25.59"></a><span id="l25.59" class="difflineminus">-                    format: &quot;&quot;,</span>
<a href="#l25.60"></a><span id="l25.60" class="difflineminus">-                    shouldShow: true }],</span>
<a href="#l25.61"></a><span id="l25.61" class="difflineminus">-  },</span>
<a href="#l25.62"></a><span id="l25.62" class="difflineminus">-  // non-inline-able attachment with no name</span>
<a href="#l25.63"></a><span id="l25.63" class="difflineminus">-  { attachments: [{ body: &quot;attachment&quot;,</span>
<a href="#l25.64"></a><span id="l25.64" class="difflineminus">-                    filename: &quot;&quot;,</span>
<a href="#l25.65"></a><span id="l25.65" class="difflineminus">-                    disposition: &quot;attachment&quot;,</span>
<a href="#l25.66"></a><span id="l25.66" class="difflineminus">-                    contentType: &quot;application/x-ubik&quot;,</span>
<a href="#l25.67"></a><span id="l25.67" class="difflineminus">-                    format: &quot;&quot;,</span>
<a href="#l25.68"></a><span id="l25.68" class="difflineminus">-                    shouldShow: true }],</span>
<a href="#l25.69"></a><span id="l25.69" class="difflineplus">+  {</span>
<a href="#l25.70"></a><span id="l25.70" class="difflineplus">+    // inline-able attachment with a name</span>
<a href="#l25.71"></a><span id="l25.71" class="difflineplus">+    attachments: [{</span>
<a href="#l25.72"></a><span id="l25.72" class="difflineplus">+      body: &quot;attachment&quot;,</span>
<a href="#l25.73"></a><span id="l25.73" class="difflineplus">+      filename: &quot;ubik.txt&quot;,</span>
<a href="#l25.74"></a><span id="l25.74" class="difflineplus">+      disposition: &quot;attachment&quot;,</span>
<a href="#l25.75"></a><span id="l25.75" class="difflineplus">+      format: &quot;&quot;,</span>
<a href="#l25.76"></a><span id="l25.76" class="difflineplus">+      shouldShow: true,</span>
<a href="#l25.77"></a><span id="l25.77" class="difflineplus">+    }],</span>
<a href="#l25.78"></a><span id="l25.78" class="difflineplus">+  }, {</span>
<a href="#l25.79"></a><span id="l25.79" class="difflineplus">+    // inline-able attachment with no name</span>
<a href="#l25.80"></a><span id="l25.80" class="difflineplus">+    attachments: [{</span>
<a href="#l25.81"></a><span id="l25.81" class="difflineplus">+      body: &quot;attachment&quot;,</span>
<a href="#l25.82"></a><span id="l25.82" class="difflineplus">+      filename: &quot;&quot;,</span>
<a href="#l25.83"></a><span id="l25.83" class="difflineplus">+      disposition: &quot;attachment&quot;,</span>
<a href="#l25.84"></a><span id="l25.84" class="difflineplus">+      format: &quot;&quot;,</span>
<a href="#l25.85"></a><span id="l25.85" class="difflineplus">+      shouldShow: true,</span>
<a href="#l25.86"></a><span id="l25.86" class="difflineplus">+    }],</span>
<a href="#l25.87"></a><span id="l25.87" class="difflineplus">+  }, {</span>
<a href="#l25.88"></a><span id="l25.88" class="difflineplus">+    // non-inline-able attachment with a name</span>
<a href="#l25.89"></a><span id="l25.89" class="difflineplus">+    attachments: [{</span>
<a href="#l25.90"></a><span id="l25.90" class="difflineplus">+      body: &quot;attachment&quot;,</span>
<a href="#l25.91"></a><span id="l25.91" class="difflineplus">+      filename: &quot;ubik.ubk&quot;,</span>
<a href="#l25.92"></a><span id="l25.92" class="difflineplus">+      disposition: &quot;attachment&quot;,</span>
<a href="#l25.93"></a><span id="l25.93" class="difflineplus">+      contentType: &quot;application/x-ubik&quot;,</span>
<a href="#l25.94"></a><span id="l25.94" class="difflineplus">+      format: &quot;&quot;,</span>
<a href="#l25.95"></a><span id="l25.95" class="difflineplus">+      shouldShow: true,</span>
<a href="#l25.96"></a><span id="l25.96" class="difflineplus">+    }],</span>
<a href="#l25.97"></a><span id="l25.97" class="difflineplus">+  }, {</span>
<a href="#l25.98"></a><span id="l25.98" class="difflineplus">+    // non-inline-able attachment with no name</span>
<a href="#l25.99"></a><span id="l25.99" class="difflineplus">+    attachments: [{</span>
<a href="#l25.100"></a><span id="l25.100" class="difflineplus">+      body: &quot;attachment&quot;,</span>
<a href="#l25.101"></a><span id="l25.101" class="difflineplus">+      filename: &quot;&quot;,</span>
<a href="#l25.102"></a><span id="l25.102" class="difflineplus">+      disposition: &quot;attachment&quot;,</span>
<a href="#l25.103"></a><span id="l25.103" class="difflineplus">+      contentType: &quot;application/x-ubik&quot;,</span>
<a href="#l25.104"></a><span id="l25.104" class="difflineplus">+      format: &quot;&quot;,</span>
<a href="#l25.105"></a><span id="l25.105" class="difflineplus">+      shouldShow: true,</span>
<a href="#l25.106"></a><span id="l25.106" class="difflineplus">+    }],</span>
<a href="#l25.107"></a><span id="l25.107">   },</span>
<a href="#l25.108"></a><span id="l25.108"> </span>
<a href="#l25.109"></a><span id="l25.109" class="difflineminus">-  /***** Attachments with Content-Disposition: inline *****/</span>
<a href="#l25.110"></a><span id="l25.110" class="difflineplus">+  /* Attachments with Content-Disposition: inline */</span>
<a href="#l25.111"></a><span id="l25.111"> </span>
<a href="#l25.112"></a><span id="l25.112" class="difflineminus">-  // inline-able attachment with a name</span>
<a href="#l25.113"></a><span id="l25.113" class="difflineminus">-  { attachments: [{ body: &quot;attachment&quot;,</span>
<a href="#l25.114"></a><span id="l25.114" class="difflineminus">-                    filename: &quot;ubik.txt&quot;,</span>
<a href="#l25.115"></a><span id="l25.115" class="difflineminus">-                    disposition: &quot;inline&quot;,</span>
<a href="#l25.116"></a><span id="l25.116" class="difflineminus">-                    format: &quot;&quot;,</span>
<a href="#l25.117"></a><span id="l25.117" class="difflineminus">-                    shouldShow: true }],</span>
<a href="#l25.118"></a><span id="l25.118" class="difflineminus">-  },</span>
<a href="#l25.119"></a><span id="l25.119" class="difflineminus">-  // inline-able attachment with no name</span>
<a href="#l25.120"></a><span id="l25.120" class="difflineminus">-  { attachments: [{ body: &quot;attachment&quot;,</span>
<a href="#l25.121"></a><span id="l25.121" class="difflineminus">-                    filename: &quot;&quot;,</span>
<a href="#l25.122"></a><span id="l25.122" class="difflineminus">-                    disposition: &quot;inline&quot;,</span>
<a href="#l25.123"></a><span id="l25.123" class="difflineminus">-                    format: &quot;&quot;,</span>
<a href="#l25.124"></a><span id="l25.124" class="difflineminus">-                    shouldShow: false }],</span>
<a href="#l25.125"></a><span id="l25.125" class="difflineminus">-  },</span>
<a href="#l25.126"></a><span id="l25.126" class="difflineminus">-  // non-inline-able attachment with a name</span>
<a href="#l25.127"></a><span id="l25.127" class="difflineminus">-  { attachments: [{ body: &quot;attachment&quot;,</span>
<a href="#l25.128"></a><span id="l25.128" class="difflineminus">-                    filename: &quot;ubik.ubk&quot;,</span>
<a href="#l25.129"></a><span id="l25.129" class="difflineminus">-                    disposition: &quot;inline&quot;,</span>
<a href="#l25.130"></a><span id="l25.130" class="difflineminus">-                    contentType: &quot;application/x-ubik&quot;,</span>
<a href="#l25.131"></a><span id="l25.131" class="difflineminus">-                    format: &quot;&quot;,</span>
<a href="#l25.132"></a><span id="l25.132" class="difflineminus">-                    shouldShow: true }],</span>
<a href="#l25.133"></a><span id="l25.133" class="difflineminus">-  },</span>
<a href="#l25.134"></a><span id="l25.134" class="difflineminus">-  // non-inline-able attachment with no name</span>
<a href="#l25.135"></a><span id="l25.135" class="difflineminus">-  { attachments: [{ body: &quot;attachment&quot;,</span>
<a href="#l25.136"></a><span id="l25.136" class="difflineminus">-                    filename: &quot;&quot;,</span>
<a href="#l25.137"></a><span id="l25.137" class="difflineminus">-                    disposition: &quot;inline&quot;,</span>
<a href="#l25.138"></a><span id="l25.138" class="difflineminus">-                    contentType: &quot;application/x-ubik&quot;,</span>
<a href="#l25.139"></a><span id="l25.139" class="difflineminus">-                    format: &quot;&quot;,</span>
<a href="#l25.140"></a><span id="l25.140" class="difflineminus">-                    shouldShow: true }],</span>
<a href="#l25.141"></a><span id="l25.141" class="difflineplus">+  {</span>
<a href="#l25.142"></a><span id="l25.142" class="difflineplus">+    // inline-able attachment with a name</span>
<a href="#l25.143"></a><span id="l25.143" class="difflineplus">+    attachments: [{</span>
<a href="#l25.144"></a><span id="l25.144" class="difflineplus">+      body: &quot;attachment&quot;,</span>
<a href="#l25.145"></a><span id="l25.145" class="difflineplus">+      filename: &quot;ubik.txt&quot;,</span>
<a href="#l25.146"></a><span id="l25.146" class="difflineplus">+      disposition: &quot;inline&quot;,</span>
<a href="#l25.147"></a><span id="l25.147" class="difflineplus">+      format: &quot;&quot;,</span>
<a href="#l25.148"></a><span id="l25.148" class="difflineplus">+      shouldShow: true,</span>
<a href="#l25.149"></a><span id="l25.149" class="difflineplus">+    }],</span>
<a href="#l25.150"></a><span id="l25.150" class="difflineplus">+  }, {</span>
<a href="#l25.151"></a><span id="l25.151" class="difflineplus">+    // inline-able attachment with no name</span>
<a href="#l25.152"></a><span id="l25.152" class="difflineplus">+    attachments: [{</span>
<a href="#l25.153"></a><span id="l25.153" class="difflineplus">+      body: &quot;attachment&quot;,</span>
<a href="#l25.154"></a><span id="l25.154" class="difflineplus">+      filename: &quot;&quot;,</span>
<a href="#l25.155"></a><span id="l25.155" class="difflineplus">+      disposition: &quot;inline&quot;,</span>
<a href="#l25.156"></a><span id="l25.156" class="difflineplus">+      format: &quot;&quot;,</span>
<a href="#l25.157"></a><span id="l25.157" class="difflineplus">+      shouldShow: false,</span>
<a href="#l25.158"></a><span id="l25.158" class="difflineplus">+    }],</span>
<a href="#l25.159"></a><span id="l25.159" class="difflineplus">+  }, {</span>
<a href="#l25.160"></a><span id="l25.160" class="difflineplus">+    // non-inline-able attachment with a name</span>
<a href="#l25.161"></a><span id="l25.161" class="difflineplus">+    attachments: [{</span>
<a href="#l25.162"></a><span id="l25.162" class="difflineplus">+      body: &quot;attachment&quot;,</span>
<a href="#l25.163"></a><span id="l25.163" class="difflineplus">+      filename: &quot;ubik.ubk&quot;,</span>
<a href="#l25.164"></a><span id="l25.164" class="difflineplus">+      disposition: &quot;inline&quot;,</span>
<a href="#l25.165"></a><span id="l25.165" class="difflineplus">+      contentType: &quot;application/x-ubik&quot;,</span>
<a href="#l25.166"></a><span id="l25.166" class="difflineplus">+      format: &quot;&quot;,</span>
<a href="#l25.167"></a><span id="l25.167" class="difflineplus">+      shouldShow: true,</span>
<a href="#l25.168"></a><span id="l25.168" class="difflineplus">+    }],</span>
<a href="#l25.169"></a><span id="l25.169" class="difflineplus">+  }, {</span>
<a href="#l25.170"></a><span id="l25.170" class="difflineplus">+    // non-inline-able attachment with no name</span>
<a href="#l25.171"></a><span id="l25.171" class="difflineplus">+    attachments: [{</span>
<a href="#l25.172"></a><span id="l25.172" class="difflineplus">+      body: &quot;attachment&quot;,</span>
<a href="#l25.173"></a><span id="l25.173" class="difflineplus">+      filename: &quot;&quot;,</span>
<a href="#l25.174"></a><span id="l25.174" class="difflineplus">+      disposition: &quot;inline&quot;,</span>
<a href="#l25.175"></a><span id="l25.175" class="difflineplus">+      contentType: &quot;application/x-ubik&quot;,</span>
<a href="#l25.176"></a><span id="l25.176" class="difflineplus">+      format: &quot;&quot;,</span>
<a href="#l25.177"></a><span id="l25.177" class="difflineplus">+      shouldShow: true,</span>
<a href="#l25.178"></a><span id="l25.178" class="difflineplus">+    }],</span>
<a href="#l25.179"></a><span id="l25.179">   },</span>
<a href="#l25.180"></a><span id="l25.180"> ];</span>
<a href="#l25.181"></a><span id="l25.181"> </span>
<a href="#l25.182"></a><span id="l25.182"> </span>
<a href="#l25.183"></a><span id="l25.183"> var gStreamListener = {</span>
<a href="#l25.184"></a><span id="l25.184">   QueryInterface: ChromeUtils.generateQI([Ci.nsIStreamListener]),</span>
<a href="#l25.185"></a><span id="l25.185"> </span>
<a href="#l25.186"></a><span id="l25.186">   // nsIRequestObserver part</span>
<a href="#l25.187"></a><span id="l25.187" class="difflineminus">-  onStartRequest: function (aRequest) {</span>
<a href="#l25.188"></a><span id="l25.188" class="difflineplus">+  onStartRequest(aRequest) {</span>
<a href="#l25.189"></a><span id="l25.189">   },</span>
<a href="#l25.190"></a><span id="l25.190" class="difflineminus">-  onStopRequest: function (aRequest, aStatusCode) {</span>
<a href="#l25.191"></a><span id="l25.191" class="difflineplus">+  onStopRequest(aRequest, aStatusCode) {</span>
<a href="#l25.192"></a><span id="l25.192">     let expectedAttachments = this.allAttachments.filter(i =&gt; i.shouldShow).</span>
<a href="#l25.193"></a><span id="l25.193">       map(i =&gt; i.filename);</span>
<a href="#l25.194"></a><span id="l25.194">     Assert.equal(expectedAttachments.length,</span>
<a href="#l25.195"></a><span id="l25.195">                  gMessageHeaderSink.attachments.length);</span>
<a href="#l25.196"></a><span id="l25.196"> </span>
<a href="#l25.197"></a><span id="l25.197">     for (let i = 0; i &lt; gMessageHeaderSink.attachments.length; i++) {</span>
<a href="#l25.198"></a><span id="l25.198">       // If the expected attachment's name is empty, we probably generated a</span>
<a href="#l25.199"></a><span id="l25.199">       // name like &quot;Part 1.2&quot;, so don't bother checking that the names match</span>
<a href="#l25.200"></a><span id="l25.200" class="difflineat">@@ -113,73 +134,73 @@ var gStreamListener = {</span>
<a href="#l25.201"></a><span id="l25.201">         Assert.equal(expectedAttachments[i], gMessageHeaderSink.attachments[i]);</span>
<a href="#l25.202"></a><span id="l25.202">     }</span>
<a href="#l25.203"></a><span id="l25.203">     this._stream = null;</span>
<a href="#l25.204"></a><span id="l25.204"> </span>
<a href="#l25.205"></a><span id="l25.205">     async_driver();</span>
<a href="#l25.206"></a><span id="l25.206">   },</span>
<a href="#l25.207"></a><span id="l25.207"> </span>
<a href="#l25.208"></a><span id="l25.208">   // nsIStreamListener part</span>
<a href="#l25.209"></a><span id="l25.209" class="difflineminus">-  _stream : null,</span>
<a href="#l25.210"></a><span id="l25.210" class="difflineplus">+  _stream: null,</span>
<a href="#l25.211"></a><span id="l25.211"> </span>
<a href="#l25.212"></a><span id="l25.212" class="difflineminus">-  onDataAvailable: function (aRequest, aInputStream, aOffset, aCount) {</span>
<a href="#l25.213"></a><span id="l25.213" class="difflineplus">+  onDataAvailable(aRequest, aInputStream, aOffset, aCount) {</span>
<a href="#l25.214"></a><span id="l25.214">     if (this._stream === null) {</span>
<a href="#l25.215"></a><span id="l25.215">       this._stream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;].</span>
<a href="#l25.216"></a><span id="l25.216">                     createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l25.217"></a><span id="l25.217">       this._stream.init(aInputStream);</span>
<a href="#l25.218"></a><span id="l25.218">     }</span>
<a href="#l25.219"></a><span id="l25.219">     this._stream.read(aCount);</span>
<a href="#l25.220"></a><span id="l25.220">   },</span>
<a href="#l25.221"></a><span id="l25.221"> };</span>
<a href="#l25.222"></a><span id="l25.222"> </span>
<a href="#l25.223"></a><span id="l25.223"> var gMessageHeaderSink = {</span>
<a href="#l25.224"></a><span id="l25.224" class="difflineminus">-  onEndMsgHeaders: function(aUrl) {</span>
<a href="#l25.225"></a><span id="l25.225" class="difflineplus">+  onEndMsgHeaders(aUrl) {</span>
<a href="#l25.226"></a><span id="l25.226">     this.attachments = [];</span>
<a href="#l25.227"></a><span id="l25.227">   },</span>
<a href="#l25.228"></a><span id="l25.228" class="difflineminus">-  handleAttachment: function(aContentType, aUrl, aDisplayName, aUri,</span>
<a href="#l25.229"></a><span id="l25.229" class="difflineminus">-                             aIsExternalAttachment) {</span>
<a href="#l25.230"></a><span id="l25.230" class="difflineplus">+  handleAttachment(aContentType, aUrl, aDisplayName, aUri, aIsExternalAttachment) {</span>
<a href="#l25.231"></a><span id="l25.231">     this.attachments.push(aDisplayName);</span>
<a href="#l25.232"></a><span id="l25.232">   },</span>
<a href="#l25.233"></a><span id="l25.233"> </span>
<a href="#l25.234"></a><span id="l25.234">   // stub functions from nsIMsgHeaderSink</span>
<a href="#l25.235"></a><span id="l25.235" class="difflineminus">-  onStartHeaders: function() {},</span>
<a href="#l25.236"></a><span id="l25.236" class="difflineminus">-  onEndHeaders: function() {},</span>
<a href="#l25.237"></a><span id="l25.237" class="difflineminus">-  processHeaders: function(aHeaderNames, aHeaderValues, dontCollectAddrs) {},</span>
<a href="#l25.238"></a><span id="l25.238" class="difflineminus">-  addAttachmentField: function(aName, aValue) {},</span>
<a href="#l25.239"></a><span id="l25.239" class="difflineminus">-  onEndAllAttachments: function() {},</span>
<a href="#l25.240"></a><span id="l25.240" class="difflineminus">-  onEndMsgDownload: function() {},</span>
<a href="#l25.241"></a><span id="l25.241" class="difflineminus">-  onMsgHasRemoteContent: function(aMsgHdr, aContentURI) {},</span>
<a href="#l25.242"></a><span id="l25.242" class="difflineplus">+  onStartHeaders() {},</span>
<a href="#l25.243"></a><span id="l25.243" class="difflineplus">+  onEndHeaders() {},</span>
<a href="#l25.244"></a><span id="l25.244" class="difflineplus">+  processHeaders(aHeaderNames, aHeaderValues, dontCollectAddrs) {},</span>
<a href="#l25.245"></a><span id="l25.245" class="difflineplus">+  addAttachmentField(aName, aValue) {},</span>
<a href="#l25.246"></a><span id="l25.246" class="difflineplus">+  onEndAllAttachments() {},</span>
<a href="#l25.247"></a><span id="l25.247" class="difflineplus">+  onEndMsgDownload() {},</span>
<a href="#l25.248"></a><span id="l25.248" class="difflineplus">+  onMsgHasRemoteContent(aMsgHdr, aContentURI) {},</span>
<a href="#l25.249"></a><span id="l25.249">   securityInfo: null,</span>
<a href="#l25.250"></a><span id="l25.250">   mDummyMsgHeader: null,</span>
<a href="#l25.251"></a><span id="l25.251">   properties: null,</span>
<a href="#l25.252"></a><span id="l25.252" class="difflineminus">-  resetProperties: function () {}</span>
<a href="#l25.253"></a><span id="l25.253" class="difflineplus">+  resetProperties() {},</span>
<a href="#l25.254"></a><span id="l25.254"> };</span>
<a href="#l25.255"></a><span id="l25.255"> </span>
<a href="#l25.256"></a><span id="l25.256"> var msgWindow = Cc[&quot;@mozilla.org/messenger/msgwindow;1&quot;]</span>
<a href="#l25.257"></a><span id="l25.257">                   .createInstance(Ci.nsIMsgWindow);</span>
<a href="#l25.258"></a><span id="l25.258"> msgWindow.msgHeaderSink = gMessageHeaderSink;</span>
<a href="#l25.259"></a><span id="l25.259"> </span>
<a href="#l25.260"></a><span id="l25.260"> function* test_message_attachments(info) {</span>
<a href="#l25.261"></a><span id="l25.261">   let synMsg = gMessageGenerator.makeMessage(info);</span>
<a href="#l25.262"></a><span id="l25.262">   let synSet = new SyntheticMessageSet([synMsg]);</span>
<a href="#l25.263"></a><span id="l25.263">   yield add_sets_to_folder(gInbox, [synSet]);</span>
<a href="#l25.264"></a><span id="l25.264"> </span>
<a href="#l25.265"></a><span id="l25.265">   let msgURI = synSet.getMsgURI(0);</span>
<a href="#l25.266"></a><span id="l25.266">   let msgService = gMessenger.messageServiceFromURI(msgURI);</span>
<a href="#l25.267"></a><span id="l25.267"> </span>
<a href="#l25.268"></a><span id="l25.268">   gStreamListener.allAttachments = info.attachments || [];</span>
<a href="#l25.269"></a><span id="l25.269" class="difflineminus">-  let streamURI = msgService.streamMessage(</span>
<a href="#l25.270"></a><span id="l25.270" class="difflineplus">+  msgService.streamMessage(</span>
<a href="#l25.271"></a><span id="l25.271">     msgURI,</span>
<a href="#l25.272"></a><span id="l25.272">     gStreamListener,</span>
<a href="#l25.273"></a><span id="l25.273">     msgWindow,</span>
<a href="#l25.274"></a><span id="l25.274">     null,</span>
<a href="#l25.275"></a><span id="l25.275">     true, // have them create the converter</span>
<a href="#l25.276"></a><span id="l25.276">     // additional uri payload, note that &quot;header=&quot; is prepended automatically</span>
<a href="#l25.277"></a><span id="l25.277">     &quot;filter&quot;,</span>
<a href="#l25.278"></a><span id="l25.278" class="difflineminus">-    false);</span>
<a href="#l25.279"></a><span id="l25.279" class="difflineplus">+    false</span>
<a href="#l25.280"></a><span id="l25.280" class="difflineplus">+  );</span>
<a href="#l25.281"></a><span id="l25.281"> </span>
<a href="#l25.282"></a><span id="l25.282">   yield false;</span>
<a href="#l25.283"></a><span id="l25.283"> }</span>
<a href="#l25.284"></a><span id="l25.284"> </span>
<a href="#l25.285"></a><span id="l25.285"> /* ===== Driver ===== */</span>
<a href="#l25.286"></a><span id="l25.286"> </span>
<a href="#l25.287"></a><span id="l25.287"> var tests = [</span>
<a href="#l25.288"></a><span id="l25.288">   parameterizeTest(test_message_attachments, messages),</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/mime/test/unit/test_jsmime_charset.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/mime/test/unit/test_jsmime_charset.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -22,13 +22,13 @@ var tests = [</span>
<a href="#l26.4"></a><span id="l26.4">   [&quot;=?cp932?B?grGCsYLJlnuVtoKqgquC3IK3gUI=?=&quot;, &quot;ここに本文がきます。&quot;],</span>
<a href="#l26.5"></a><span id="l26.5"> ];</span>
<a href="#l26.6"></a><span id="l26.6"> </span>
<a href="#l26.7"></a><span id="l26.7"> function run_test() {</span>
<a href="#l26.8"></a><span id="l26.8">   for (let test of tests) {</span>
<a href="#l26.9"></a><span id="l26.9">     dump(&quot;Testing message &quot; + test[0]);</span>
<a href="#l26.10"></a><span id="l26.10">     let value = test[0];</span>
<a href="#l26.11"></a><span id="l26.11">     if (test.length &gt; 2)</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-      value = jsmime.headerparser.convert8BitHeader(value, test[2])</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+      value = jsmime.headerparser.convert8BitHeader(value, test[2]);</span>
<a href="#l26.14"></a><span id="l26.14">     Assert.equal(jsmime.headerparser.parseStructuredHeader(&quot;Subject&quot;, value),</span>
<a href="#l26.15"></a><span id="l26.15">       test[1]);</span>
<a href="#l26.16"></a><span id="l26.16">   }</span>
<a href="#l26.17"></a><span id="l26.17"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/mime/test/unit/test_message_attachment.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/mime/test/unit/test_message_attachment.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -1,145 +1,163 @@</span>
<a href="#l27.4"></a><span id="l27.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l27.5"></a><span id="l27.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l27.6"></a><span id="l27.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l27.7"></a><span id="l27.7"> </span>
<a href="#l27.8"></a><span id="l27.8"> /**</span>
<a href="#l27.9"></a><span id="l27.9">  * This test verifies that we generate proper attachment filenames.</span>
<a href="#l27.10"></a><span id="l27.10">  */</span>
<a href="#l27.11"></a><span id="l27.11" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l27.13"></a><span id="l27.13"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l27.14"></a><span id="l27.14"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l27.15"></a><span id="l27.15"> </span>
<a href="#l27.16"></a><span id="l27.16" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l27.17"></a><span id="l27.17" class="difflineplus">+/* import-globals-from ../../../test/resources/messageModifier.js */</span>
<a href="#l27.18"></a><span id="l27.18" class="difflineplus">+/* import-globals-from ../../../test/resources/messageInjection.js */</span>
<a href="#l27.19"></a><span id="l27.19"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l27.20"></a><span id="l27.20"> load(&quot;../../../resources/messageModifier.js&quot;);</span>
<a href="#l27.21"></a><span id="l27.21"> load(&quot;../../../resources/messageInjection.js&quot;);</span>
<a href="#l27.22"></a><span id="l27.22"> </span>
<a href="#l27.23"></a><span id="l27.23"> var gMessenger = Cc[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l27.24"></a><span id="l27.24">                    .createInstance(Ci.nsIMessenger);</span>
<a href="#l27.25"></a><span id="l27.25"> </span>
<a href="#l27.26"></a><span id="l27.26"> // Create a message generator</span>
<a href="#l27.27"></a><span id="l27.27"> var msgGen = gMessageGenerator = new MessageGenerator();</span>
<a href="#l27.28"></a><span id="l27.28"> </span>
<a href="#l27.29"></a><span id="l27.29"> var textAttachment =</span>
<a href="#l27.30"></a><span id="l27.30">   &quot;inline text attachment&quot;;</span>
<a href="#l27.31"></a><span id="l27.31"> </span>
<a href="#l27.32"></a><span id="l27.32"> // create a message with a text attachment</span>
<a href="#l27.33"></a><span id="l27.33"> var messages = [</span>
<a href="#l27.34"></a><span id="l27.34" class="difflineminus">-  // unnamed email attachment</span>
<a href="#l27.35"></a><span id="l27.35" class="difflineminus">-  { attachments: [{ body: textAttachment,</span>
<a href="#l27.36"></a><span id="l27.36" class="difflineminus">-                    filename: 'test.txt',</span>
<a href="#l27.37"></a><span id="l27.37" class="difflineminus">-                    format: '' },</span>
<a href="#l27.38"></a><span id="l27.38" class="difflineminus">-                  { body: '',</span>
<a href="#l27.39"></a><span id="l27.39" class="difflineminus">-                    expectedFilename: 'ForwardedMessage.eml',</span>
<a href="#l27.40"></a><span id="l27.40" class="difflineminus">-                    contentType: 'message/rfc822', },</span>
<a href="#l27.41"></a><span id="l27.41" class="difflineminus">-                 ]},</span>
<a href="#l27.42"></a><span id="l27.42" class="difflineminus">-  // named email attachment</span>
<a href="#l27.43"></a><span id="l27.43" class="difflineminus">-  { attachments: [{ body: textAttachment,</span>
<a href="#l27.44"></a><span id="l27.44" class="difflineminus">-                    filename: 'test.txt',</span>
<a href="#l27.45"></a><span id="l27.45" class="difflineminus">-                    format: '' },</span>
<a href="#l27.46"></a><span id="l27.46" class="difflineminus">-                  { body: '',</span>
<a href="#l27.47"></a><span id="l27.47" class="difflineminus">-                    filename: 'Attached Message',</span>
<a href="#l27.48"></a><span id="l27.48" class="difflineminus">-                    contentType: 'message/rfc822', },</span>
<a href="#l27.49"></a><span id="l27.49" class="difflineminus">-                 ]},</span>
<a href="#l27.50"></a><span id="l27.50" class="difflineminus">-  { attachments: [{ body: textAttachment,</span>
<a href="#l27.51"></a><span id="l27.51" class="difflineminus">-                    filename: 'test.html',</span>
<a href="#l27.52"></a><span id="l27.52" class="difflineminus">-                    format: '' },</span>
<a href="#l27.53"></a><span id="l27.53" class="difflineminus">-                  { body: '',</span>
<a href="#l27.54"></a><span id="l27.54" class="difflineminus">-                    filename: '&lt;iframe src=&amp;quote;http://www.example.com&amp;quote&gt;&lt;/iframe&gt;.htm',</span>
<a href="#l27.55"></a><span id="l27.55" class="difflineminus">-                    expectedFilename: '&amp;lt;iframe src=&amp;amp;quote;http://www.example.com&amp;amp;quote&amp;gt;&amp;lt;/iframe&amp;gt;.htm',</span>
<a href="#l27.56"></a><span id="l27.56" class="difflineminus">-                    contentType: 'text/html;', },</span>
<a href="#l27.57"></a><span id="l27.57" class="difflineminus">-                 ]},</span>
<a href="#l27.58"></a><span id="l27.58" class="difflineminus">-  // no named email attachment with subject header</span>
<a href="#l27.59"></a><span id="l27.59" class="difflineminus">-  { attachments: [{ body: '', expectedFilename: 'testSubject.eml' }],</span>
<a href="#l27.60"></a><span id="l27.60" class="difflineplus">+  {</span>
<a href="#l27.61"></a><span id="l27.61" class="difflineplus">+    // unnamed email attachment</span>
<a href="#l27.62"></a><span id="l27.62" class="difflineplus">+    attachments: [{</span>
<a href="#l27.63"></a><span id="l27.63" class="difflineplus">+      body: textAttachment,</span>
<a href="#l27.64"></a><span id="l27.64" class="difflineplus">+      filename: &quot;test.txt&quot;,</span>
<a href="#l27.65"></a><span id="l27.65" class="difflineplus">+      format: &quot;&quot;,</span>
<a href="#l27.66"></a><span id="l27.66" class="difflineplus">+    }, {</span>
<a href="#l27.67"></a><span id="l27.67" class="difflineplus">+      body: &quot;&quot;,</span>
<a href="#l27.68"></a><span id="l27.68" class="difflineplus">+      expectedFilename: &quot;ForwardedMessage.eml&quot;,</span>
<a href="#l27.69"></a><span id="l27.69" class="difflineplus">+      contentType: &quot;message/rfc822&quot;,</span>
<a href="#l27.70"></a><span id="l27.70" class="difflineplus">+    }],</span>
<a href="#l27.71"></a><span id="l27.71" class="difflineplus">+  }, {</span>
<a href="#l27.72"></a><span id="l27.72" class="difflineplus">+    // named email attachment</span>
<a href="#l27.73"></a><span id="l27.73" class="difflineplus">+    attachments: [{</span>
<a href="#l27.74"></a><span id="l27.74" class="difflineplus">+      body: textAttachment,</span>
<a href="#l27.75"></a><span id="l27.75" class="difflineplus">+      filename: &quot;test.txt&quot;,</span>
<a href="#l27.76"></a><span id="l27.76" class="difflineplus">+      format: &quot;&quot;,</span>
<a href="#l27.77"></a><span id="l27.77" class="difflineplus">+    }, {</span>
<a href="#l27.78"></a><span id="l27.78" class="difflineplus">+      body: &quot;&quot;,</span>
<a href="#l27.79"></a><span id="l27.79" class="difflineplus">+      filename: &quot;Attached Message&quot;,</span>
<a href="#l27.80"></a><span id="l27.80" class="difflineplus">+      contentType: &quot;message/rfc822&quot;,</span>
<a href="#l27.81"></a><span id="l27.81" class="difflineplus">+    }],</span>
<a href="#l27.82"></a><span id="l27.82" class="difflineplus">+  }, {</span>
<a href="#l27.83"></a><span id="l27.83" class="difflineplus">+    attachments: [{</span>
<a href="#l27.84"></a><span id="l27.84" class="difflineplus">+      body: textAttachment,</span>
<a href="#l27.85"></a><span id="l27.85" class="difflineplus">+      filename: &quot;test.html&quot;,</span>
<a href="#l27.86"></a><span id="l27.86" class="difflineplus">+      format: &quot;&quot;,</span>
<a href="#l27.87"></a><span id="l27.87" class="difflineplus">+    }, {</span>
<a href="#l27.88"></a><span id="l27.88" class="difflineplus">+      body: &quot;&quot;,</span>
<a href="#l27.89"></a><span id="l27.89" class="difflineplus">+      filename: &quot;&lt;iframe src=&amp;quote;http://www.example.com&amp;quote&gt;&lt;/iframe&gt;.htm&quot;,</span>
<a href="#l27.90"></a><span id="l27.90" class="difflineplus">+      expectedFilename: &quot;&amp;lt;iframe src=&amp;amp;quote;http://www.example.com&amp;amp;quote&amp;gt;&amp;lt;/iframe&amp;gt;.htm&quot;,</span>
<a href="#l27.91"></a><span id="l27.91" class="difflineplus">+      contentType: &quot;text/html;&quot;,</span>
<a href="#l27.92"></a><span id="l27.92" class="difflineplus">+    }],</span>
<a href="#l27.93"></a><span id="l27.93" class="difflineplus">+  }, {</span>
<a href="#l27.94"></a><span id="l27.94" class="difflineplus">+    // no named email attachment with subject header</span>
<a href="#l27.95"></a><span id="l27.95" class="difflineplus">+    attachments: [{</span>
<a href="#l27.96"></a><span id="l27.96" class="difflineplus">+      body: &quot;&quot;,</span>
<a href="#l27.97"></a><span id="l27.97" class="difflineplus">+      expectedFilename: &quot;testSubject.eml&quot;,</span>
<a href="#l27.98"></a><span id="l27.98" class="difflineplus">+    }],</span>
<a href="#l27.99"></a><span id="l27.99">     bodyPart: new SyntheticPartMultiMixed([</span>
<a href="#l27.100"></a><span id="l27.100" class="difflineminus">-      new SyntheticPartLeaf('plain body text'),</span>
<a href="#l27.101"></a><span id="l27.101" class="difflineplus">+      new SyntheticPartLeaf(&quot;plain body text&quot;),</span>
<a href="#l27.102"></a><span id="l27.102">       msgGen.makeMessage({</span>
<a href="#l27.103"></a><span id="l27.103" class="difflineminus">-        subject: '=?UTF-8?B?dGVzdFN1YmplY3Q=?=', // This string is 'testSubject'.</span>
<a href="#l27.104"></a><span id="l27.104" class="difflineminus">-        charset: 'UTF-8',</span>
<a href="#l27.105"></a><span id="l27.105" class="difflineplus">+        subject: &quot;=?UTF-8?B?dGVzdFN1YmplY3Q=?=&quot;, // This string is 'testSubject'.</span>
<a href="#l27.106"></a><span id="l27.106" class="difflineplus">+        charset: &quot;UTF-8&quot;,</span>
<a href="#l27.107"></a><span id="l27.107">       }),</span>
<a href="#l27.108"></a><span id="l27.108" class="difflineminus">-    ])},</span>
<a href="#l27.109"></a><span id="l27.109" class="difflineplus">+    ]),</span>
<a href="#l27.110"></a><span id="l27.110" class="difflineplus">+  },</span>
<a href="#l27.111"></a><span id="l27.111"> ];</span>
<a href="#l27.112"></a><span id="l27.112"> </span>
<a href="#l27.113"></a><span id="l27.113" class="difflineminus">-</span>
<a href="#l27.114"></a><span id="l27.114"> var gStreamListener = {</span>
<a href="#l27.115"></a><span id="l27.115">   QueryInterface: ChromeUtils.generateQI([Ci.nsIStreamListener]),</span>
<a href="#l27.116"></a><span id="l27.116"> </span>
<a href="#l27.117"></a><span id="l27.117">   index: 0, // The index of the message we're currently looking at.</span>
<a href="#l27.118"></a><span id="l27.118"> </span>
<a href="#l27.119"></a><span id="l27.119">   // nsIRequestObserver part</span>
<a href="#l27.120"></a><span id="l27.120" class="difflineminus">-  onStartRequest: function (aRequest) {</span>
<a href="#l27.121"></a><span id="l27.121" class="difflineplus">+  onStartRequest(aRequest) {</span>
<a href="#l27.122"></a><span id="l27.122">     this.contents = &quot;&quot;;</span>
<a href="#l27.123"></a><span id="l27.123">     this.stream = null;</span>
<a href="#l27.124"></a><span id="l27.124">   },</span>
<a href="#l27.125"></a><span id="l27.125" class="difflineminus">-  onStopRequest: function (aRequest, aStatusCode) {</span>
<a href="#l27.126"></a><span id="l27.126" class="difflineplus">+  onStopRequest(aRequest, aStatusCode) {</span>
<a href="#l27.127"></a><span id="l27.127">     // Check that the attachments' filenames are as expected. Just use a regex</span>
<a href="#l27.128"></a><span id="l27.128">     // here because it's simple.</span>
<a href="#l27.129"></a><span id="l27.129">     let regex = /&lt;legend class=&quot;mimeAttachmentHeaderName&quot;&gt;(.*?)&lt;\/legend&gt;/gi;</span>
<a href="#l27.130"></a><span id="l27.130"> </span>
<a href="#l27.131"></a><span id="l27.131">     for (let attachment of messages[this.index].attachments) {</span>
<a href="#l27.132"></a><span id="l27.132">       let match = regex.exec(this.contents);</span>
<a href="#l27.133"></a><span id="l27.133">       Assert.notEqual(match, null);</span>
<a href="#l27.134"></a><span id="l27.134">       Assert.equal(match[1], attachment.expectedFilename || attachment.filename);</span>
<a href="#l27.135"></a><span id="l27.135">     }</span>
<a href="#l27.136"></a><span id="l27.136">     Assert.equal(regex.exec(this.contents), null);</span>
<a href="#l27.137"></a><span id="l27.137"> </span>
<a href="#l27.138"></a><span id="l27.138">     this.index++;</span>
<a href="#l27.139"></a><span id="l27.139">     async_driver();</span>
<a href="#l27.140"></a><span id="l27.140">   },</span>
<a href="#l27.141"></a><span id="l27.141"> </span>
<a href="#l27.142"></a><span id="l27.142">   // nsIStreamListener part</span>
<a href="#l27.143"></a><span id="l27.143" class="difflineminus">-  onDataAvailable: function (aRequest, aInputStream, aOffset, aCount) {</span>
<a href="#l27.144"></a><span id="l27.144" class="difflineplus">+  onDataAvailable(aRequest, aInputStream, aOffset, aCount) {</span>
<a href="#l27.145"></a><span id="l27.145">     if (this.stream === null) {</span>
<a href="#l27.146"></a><span id="l27.146">       this.stream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;].</span>
<a href="#l27.147"></a><span id="l27.147">                     createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l27.148"></a><span id="l27.148">       this.stream.init(aInputStream);</span>
<a href="#l27.149"></a><span id="l27.149">     }</span>
<a href="#l27.150"></a><span id="l27.150">     this.contents += this.stream.read(aCount);</span>
<a href="#l27.151"></a><span id="l27.151">   },</span>
<a href="#l27.152"></a><span id="l27.152"> };</span>
<a href="#l27.153"></a><span id="l27.153"> </span>
<a href="#l27.154"></a><span id="l27.154"> var gMessageHeaderSink = {</span>
<a href="#l27.155"></a><span id="l27.155" class="difflineminus">-  handleAttachment: function(aContentType, aUrl, aDisplayName, aUri,</span>
<a href="#l27.156"></a><span id="l27.156" class="difflineminus">-                             aIsExternalAttachment) {},</span>
<a href="#l27.157"></a><span id="l27.157" class="difflineminus">-  addAttachmentField: function(aName, aValue) {},</span>
<a href="#l27.158"></a><span id="l27.158" class="difflineplus">+  handleAttachment(aContentType, aUrl, aDisplayName, aUri, aIsExternalAttachment) {},</span>
<a href="#l27.159"></a><span id="l27.159" class="difflineplus">+  addAttachmentField(aName, aValue) {},</span>
<a href="#l27.160"></a><span id="l27.160"> </span>
<a href="#l27.161"></a><span id="l27.161">   // stub functions from nsIMsgHeaderSink</span>
<a href="#l27.162"></a><span id="l27.162" class="difflineminus">-  onStartHeaders: function() {},</span>
<a href="#l27.163"></a><span id="l27.163" class="difflineminus">-  onEndHeaders: function() {},</span>
<a href="#l27.164"></a><span id="l27.164" class="difflineminus">-  processHeaders: function(aHeaderNames, aHeaderValues, dontCollectAddrs) {},</span>
<a href="#l27.165"></a><span id="l27.165" class="difflineminus">-  onEndAllAttachments: function() {},</span>
<a href="#l27.166"></a><span id="l27.166" class="difflineminus">-  onEndMsgDownload: function() {},</span>
<a href="#l27.167"></a><span id="l27.167" class="difflineminus">-  onEndMsgHeaders: function(aUrl) {},</span>
<a href="#l27.168"></a><span id="l27.168" class="difflineminus">-  onMsgHasRemoteContent: function(aMsgHdr, aContentURI) {},</span>
<a href="#l27.169"></a><span id="l27.169" class="difflineplus">+  onStartHeaders() {},</span>
<a href="#l27.170"></a><span id="l27.170" class="difflineplus">+  onEndHeaders() {},</span>
<a href="#l27.171"></a><span id="l27.171" class="difflineplus">+  processHeaders(aHeaderNames, aHeaderValues, dontCollectAddrs) {},</span>
<a href="#l27.172"></a><span id="l27.172" class="difflineplus">+  onEndAllAttachments() {},</span>
<a href="#l27.173"></a><span id="l27.173" class="difflineplus">+  onEndMsgDownload() {},</span>
<a href="#l27.174"></a><span id="l27.174" class="difflineplus">+  onEndMsgHeaders(aUrl) {},</span>
<a href="#l27.175"></a><span id="l27.175" class="difflineplus">+  onMsgHasRemoteContent(aMsgHdr, aContentURI) {},</span>
<a href="#l27.176"></a><span id="l27.176">   securityInfo: null,</span>
<a href="#l27.177"></a><span id="l27.177">   mDummyMsgHeader: null,</span>
<a href="#l27.178"></a><span id="l27.178">   properties: null,</span>
<a href="#l27.179"></a><span id="l27.179" class="difflineminus">-  resetProperties: function () {}</span>
<a href="#l27.180"></a><span id="l27.180" class="difflineplus">+  resetProperties() {},</span>
<a href="#l27.181"></a><span id="l27.181"> };</span>
<a href="#l27.182"></a><span id="l27.182"> </span>
<a href="#l27.183"></a><span id="l27.183"> var msgWindow = Cc[&quot;@mozilla.org/messenger/msgwindow;1&quot;]</span>
<a href="#l27.184"></a><span id="l27.184">                   .createInstance(Ci.nsIMsgWindow);</span>
<a href="#l27.185"></a><span id="l27.185"> msgWindow.msgHeaderSink = gMessageHeaderSink;</span>
<a href="#l27.186"></a><span id="l27.186"> </span>
<a href="#l27.187"></a><span id="l27.187"> function* test_message_attachments(info) {</span>
<a href="#l27.188"></a><span id="l27.188">   let synMsg = gMessageGenerator.makeMessage(info);</span>
<a href="#l27.189"></a><span id="l27.189">   let synSet = new SyntheticMessageSet([synMsg]);</span>
<a href="#l27.190"></a><span id="l27.190">   yield add_sets_to_folder(gInbox, [synSet]);</span>
<a href="#l27.191"></a><span id="l27.191"> </span>
<a href="#l27.192"></a><span id="l27.192">   let msgURI = synSet.getMsgURI(0);</span>
<a href="#l27.193"></a><span id="l27.193">   let msgService = gMessenger.messageServiceFromURI(msgURI);</span>
<a href="#l27.194"></a><span id="l27.194"> </span>
<a href="#l27.195"></a><span id="l27.195" class="difflineminus">-  let streamURI = msgService.streamMessage(</span>
<a href="#l27.196"></a><span id="l27.196" class="difflineplus">+  msgService.streamMessage(</span>
<a href="#l27.197"></a><span id="l27.197">     msgURI,</span>
<a href="#l27.198"></a><span id="l27.198">     gStreamListener,</span>
<a href="#l27.199"></a><span id="l27.199">     msgWindow,</span>
<a href="#l27.200"></a><span id="l27.200">     null,</span>
<a href="#l27.201"></a><span id="l27.201">     true, // have them create the converter</span>
<a href="#l27.202"></a><span id="l27.202">     &quot;header=filter&quot;,</span>
<a href="#l27.203"></a><span id="l27.203" class="difflineminus">-    false);</span>
<a href="#l27.204"></a><span id="l27.204" class="difflineplus">+    false</span>
<a href="#l27.205"></a><span id="l27.205" class="difflineplus">+  );</span>
<a href="#l27.206"></a><span id="l27.206"> </span>
<a href="#l27.207"></a><span id="l27.207">   yield false;</span>
<a href="#l27.208"></a><span id="l27.208"> }</span>
<a href="#l27.209"></a><span id="l27.209"> </span>
<a href="#l27.210"></a><span id="l27.210"> /* ===== Driver ===== */</span>
<a href="#l27.211"></a><span id="l27.211"> </span>
<a href="#l27.212"></a><span id="l27.212"> var tests = [</span>
<a href="#l27.213"></a><span id="l27.213">   parameterizeTest(test_message_attachments, messages),</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/mime/test/unit/test_mimeContentType.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/mime/test/unit/test_mimeContentType.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -1,71 +1,70 @@</span>
<a href="#l28.4"></a><span id="l28.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l28.5"></a><span id="l28.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l28.6"></a><span id="l28.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l28.7"></a><span id="l28.7"> </span>
<a href="#l28.8"></a><span id="l28.8" class="difflineminus">-function run_test()</span>
<a href="#l28.9"></a><span id="l28.9" class="difflineminus">-{</span>
<a href="#l28.10"></a><span id="l28.10" class="difflineminus">-  const headers =</span>
<a href="#l28.11"></a><span id="l28.11" class="difflineminus">-  [</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-    { header:</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+function run_test() {</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineplus">+  const headers = [</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineplus">+    {</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineplus">+      header:</span>
<a href="#l28.17"></a><span id="l28.17">       &quot;Content-Type: text/plain\r\n&quot; +</span>
<a href="#l28.18"></a><span id="l28.18">       &quot;Content-Disposition: inline\r\n&quot; +</span>
<a href="#l28.19"></a><span id="l28.19">       &quot;\r\n&quot;,</span>
<a href="#l28.20"></a><span id="l28.20">       result:</span>
<a href="#l28.21"></a><span id="l28.21" class="difflineminus">-      &quot;text/plain&quot;</span>
<a href="#l28.22"></a><span id="l28.22" class="difflineminus">-    },</span>
<a href="#l28.23"></a><span id="l28.23" class="difflineminus">-    { header:</span>
<a href="#l28.24"></a><span id="l28.24" class="difflineplus">+      &quot;text/plain&quot;,</span>
<a href="#l28.25"></a><span id="l28.25" class="difflineplus">+    }, {</span>
<a href="#l28.26"></a><span id="l28.26" class="difflineplus">+      header:</span>
<a href="#l28.27"></a><span id="l28.27">       &quot;Content-Type:\r\n&quot; +</span>
<a href="#l28.28"></a><span id="l28.28">       &quot;\tapplication/vnd.openxmlformats-officedocument.spreadsheetml.sheet\r\n&quot; +</span>
<a href="#l28.29"></a><span id="l28.29">       &quot;Content-Transfer-Encoding: base64\r\n&quot; +</span>
<a href="#l28.30"></a><span id="l28.30">       &quot;Content-Disposition: attachment; filename=\&quot;List.xlsx\&quot;\r\n&quot; +</span>
<a href="#l28.31"></a><span id="l28.31">       &quot;\r\n&quot;,</span>
<a href="#l28.32"></a><span id="l28.32">       result:</span>
<a href="#l28.33"></a><span id="l28.33" class="difflineminus">-      &quot;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&quot;</span>
<a href="#l28.34"></a><span id="l28.34" class="difflineminus">-    },</span>
<a href="#l28.35"></a><span id="l28.35" class="difflineminus">-    { header:</span>
<a href="#l28.36"></a><span id="l28.36" class="difflineplus">+      &quot;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&quot;,</span>
<a href="#l28.37"></a><span id="l28.37" class="difflineplus">+    }, {</span>
<a href="#l28.38"></a><span id="l28.38" class="difflineplus">+      header:</span>
<a href="#l28.39"></a><span id="l28.39">       &quot;Content-Type: \r\n&quot; +</span>
<a href="#l28.40"></a><span id="l28.40">       &quot; application/vnd.openxmlformats-officedocument.presentationml.presentation;\r\n&quot; +</span>
<a href="#l28.41"></a><span id="l28.41">       &quot; name=\&quot;Presentation.pptx\&quot;\r\n&quot; +</span>
<a href="#l28.42"></a><span id="l28.42">       &quot;\r\n&quot;,</span>
<a href="#l28.43"></a><span id="l28.43">       result:</span>
<a href="#l28.44"></a><span id="l28.44">       &quot;application/vnd.openxmlformats-officedocument.presentationml.presentation;&quot; +</span>
<a href="#l28.45"></a><span id="l28.45" class="difflineminus">-      &quot; name=\&quot;Presentation.pptx\&quot;&quot;</span>
<a href="#l28.46"></a><span id="l28.46" class="difflineminus">-    },</span>
<a href="#l28.47"></a><span id="l28.47" class="difflineminus">-    { header:</span>
<a href="#l28.48"></a><span id="l28.48" class="difflineplus">+      &quot; name=\&quot;Presentation.pptx\&quot;&quot;,</span>
<a href="#l28.49"></a><span id="l28.49" class="difflineplus">+    }, {</span>
<a href="#l28.50"></a><span id="l28.50" class="difflineplus">+      header:</span>
<a href="#l28.51"></a><span id="l28.51">       &quot;Content-Type:\r\n&quot; +</span>
<a href="#l28.52"></a><span id="l28.52">       &quot;text/plain; charset=utf-8\r\n&quot; +</span>
<a href="#l28.53"></a><span id="l28.53">       &quot;Content-Transfer-Encoding: quoted-printable\r\n&quot; +</span>
<a href="#l28.54"></a><span id="l28.54">       &quot;Content-Disposition: inline\r\n&quot; +</span>
<a href="#l28.55"></a><span id="l28.55">       &quot;\r\n&quot;,</span>
<a href="#l28.56"></a><span id="l28.56">       result:</span>
<a href="#l28.57"></a><span id="l28.57" class="difflineminus">-      &quot;&quot;</span>
<a href="#l28.58"></a><span id="l28.58" class="difflineminus">-    },</span>
<a href="#l28.59"></a><span id="l28.59" class="difflineminus">-    { header:</span>
<a href="#l28.60"></a><span id="l28.60" class="difflineplus">+      &quot;&quot;,</span>
<a href="#l28.61"></a><span id="l28.61" class="difflineplus">+    }, {</span>
<a href="#l28.62"></a><span id="l28.62" class="difflineplus">+      header:</span>
<a href="#l28.63"></a><span id="l28.63">       &quot;Content-Type:\r\n&quot; +</span>
<a href="#l28.64"></a><span id="l28.64">       &quot;\r\n&quot;,</span>
<a href="#l28.65"></a><span id="l28.65">       result:</span>
<a href="#l28.66"></a><span id="l28.66" class="difflineminus">-      &quot;&quot;</span>
<a href="#l28.67"></a><span id="l28.67" class="difflineminus">-    },</span>
<a href="#l28.68"></a><span id="l28.68" class="difflineminus">-    /* possible crash case for Bug 574961 */</span>
<a href="#l28.69"></a><span id="l28.69" class="difflineminus">-    { header:</span>
<a href="#l28.70"></a><span id="l28.70" class="difflineplus">+      &quot;&quot;,</span>
<a href="#l28.71"></a><span id="l28.71" class="difflineplus">+    }, {</span>
<a href="#l28.72"></a><span id="l28.72" class="difflineplus">+      /* possible crash case for Bug 574961 */</span>
<a href="#l28.73"></a><span id="l28.73" class="difflineplus">+      header:</span>
<a href="#l28.74"></a><span id="l28.74">       &quot;Content-Type: \r\n&quot; +</span>
<a href="#l28.75"></a><span id="l28.75">       &quot;                                &quot; +</span>
<a href="#l28.76"></a><span id="l28.76">       &quot;                                &quot; +</span>
<a href="#l28.77"></a><span id="l28.77">       &quot;                                &quot; +</span>
<a href="#l28.78"></a><span id="l28.78">       &quot;                                &quot; +</span>
<a href="#l28.79"></a><span id="l28.79">       &quot;                                &quot; +</span>
<a href="#l28.80"></a><span id="l28.80">       &quot;                                &quot; +</span>
<a href="#l28.81"></a><span id="l28.81">       &quot;                                &quot; +</span>
<a href="#l28.82"></a><span id="l28.82">       &quot;                                &quot; +</span>
<a href="#l28.83"></a><span id="l28.83">       &quot;              \r\n&quot;,</span>
<a href="#l28.84"></a><span id="l28.84">       result:</span>
<a href="#l28.85"></a><span id="l28.85">       &quot;&quot;,</span>
<a href="#l28.86"></a><span id="l28.86" class="difflineminus">-    }</span>
<a href="#l28.87"></a><span id="l28.87" class="difflineplus">+    },</span>
<a href="#l28.88"></a><span id="l28.88">   ];</span>
<a href="#l28.89"></a><span id="l28.89"> </span>
<a href="#l28.90"></a><span id="l28.90">   let mimeHdr = Cc[&quot;@mozilla.org/messenger/mimeheaders;1&quot;]</span>
<a href="#l28.91"></a><span id="l28.91">                   .createInstance(Ci.nsIMimeHeaders);</span>
<a href="#l28.92"></a><span id="l28.92"> </span>
<a href="#l28.93"></a><span id="l28.93">   for (let i = 0; i &lt; headers.length; i++) {</span>
<a href="#l28.94"></a><span id="l28.94">     mimeHdr.initialize(headers[i].header);</span>
<a href="#l28.95"></a><span id="l28.95">     let receivedHeader = mimeHdr.extractHeader(&quot;Content-Type&quot;, false);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/mime/test/unit/test_mimeStreaming.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/mime/test/unit/test_mimeStreaming.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -4,78 +4,77 @@</span>
<a href="#l29.4"></a><span id="l29.4"> </span>
<a href="#l29.5"></a><span id="l29.5"> /**</span>
<a href="#l29.6"></a><span id="l29.6">  * This test iterates over the test files in gTestFiles, and streams</span>
<a href="#l29.7"></a><span id="l29.7">  * each as a message and makes sure the streaming doesn't assert or crash.</span>
<a href="#l29.8"></a><span id="l29.8">  */</span>
<a href="#l29.9"></a><span id="l29.9"> const {localAccountUtils} = ChromeUtils.import(&quot;resource://testing-common/mailnews/localAccountUtils.js&quot;);</span>
<a href="#l29.10"></a><span id="l29.10"> var {IOUtils} = ChromeUtils.import(&quot;resource:///modules/IOUtils.js&quot;);</span>
<a href="#l29.11"></a><span id="l29.11"> </span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-var gTestFiles =[</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+var gTestFiles = [</span>
<a href="#l29.14"></a><span id="l29.14">   &quot;../../../data/bug505221&quot;,</span>
<a href="#l29.15"></a><span id="l29.15">   &quot;../../../data/bug513543&quot;,</span>
<a href="#l29.16"></a><span id="l29.16"> ];</span>
<a href="#l29.17"></a><span id="l29.17"> </span>
<a href="#l29.18"></a><span id="l29.18"> var gMsgEnumerator;</span>
<a href="#l29.19"></a><span id="l29.19"> </span>
<a href="#l29.20"></a><span id="l29.20"> var gMessenger = Cc[&quot;@mozilla.org/messenger;1&quot;].</span>
<a href="#l29.21"></a><span id="l29.21">                    createInstance(Ci.nsIMessenger);</span>
<a href="#l29.22"></a><span id="l29.22"> </span>
<a href="#l29.23"></a><span id="l29.23"> var gUrlListener = {</span>
<a href="#l29.24"></a><span id="l29.24" class="difflineminus">-  OnStartRunningUrl: function (aUrl) {</span>
<a href="#l29.25"></a><span id="l29.25" class="difflineplus">+  OnStartRunningUrl(aUrl) {</span>
<a href="#l29.26"></a><span id="l29.26">   },</span>
<a href="#l29.27"></a><span id="l29.27" class="difflineminus">-  OnStopRunningUrl: function (aUrl, aExitCode) {</span>
<a href="#l29.28"></a><span id="l29.28" class="difflineplus">+  OnStopRunningUrl(aUrl, aExitCode) {</span>
<a href="#l29.29"></a><span id="l29.29">     do_test_finished();</span>
<a href="#l29.30"></a><span id="l29.30">   },</span>
<a href="#l29.31"></a><span id="l29.31"> };</span>
<a href="#l29.32"></a><span id="l29.32"> </span>
<a href="#l29.33"></a><span id="l29.33"> </span>
<a href="#l29.34"></a><span id="l29.34"> localAccountUtils.loadLocalMailAccount();</span>
<a href="#l29.35"></a><span id="l29.35"> </span>
<a href="#l29.36"></a><span id="l29.36" class="difflineminus">-function run_test()</span>
<a href="#l29.37"></a><span id="l29.37" class="difflineminus">-{</span>
<a href="#l29.38"></a><span id="l29.38" class="difflineplus">+function run_test() {</span>
<a href="#l29.39"></a><span id="l29.39">   do_test_pending();</span>
<a href="#l29.40"></a><span id="l29.40">   localAccountUtils.inboxFolder.QueryInterface(Ci.nsIMsgLocalMailFolder);</span>
<a href="#l29.41"></a><span id="l29.41">   for (let fileName of gTestFiles) {</span>
<a href="#l29.42"></a><span id="l29.42">     localAccountUtils.inboxFolder.addMessage(IOUtils.loadFileToString(do_get_file(fileName)));</span>
<a href="#l29.43"></a><span id="l29.43" class="difflineminus">-  };</span>
<a href="#l29.44"></a><span id="l29.44" class="difflineplus">+  }</span>
<a href="#l29.45"></a><span id="l29.45">   gMsgEnumerator = localAccountUtils.inboxFolder.msgDatabase.EnumerateMessages();</span>
<a href="#l29.46"></a><span id="l29.46">   doNextTest();</span>
<a href="#l29.47"></a><span id="l29.47"> }</span>
<a href="#l29.48"></a><span id="l29.48"> </span>
<a href="#l29.49"></a><span id="l29.49" class="difflineminus">-function streamMsg(msgHdr)</span>
<a href="#l29.50"></a><span id="l29.50" class="difflineminus">-{</span>
<a href="#l29.51"></a><span id="l29.51" class="difflineplus">+function streamMsg(msgHdr) {</span>
<a href="#l29.52"></a><span id="l29.52">   let msgURI = localAccountUtils.inboxFolder.getUriForMsg(msgHdr);</span>
<a href="#l29.53"></a><span id="l29.53">   let msgService = gMessenger.messageServiceFromURI(msgURI);</span>
<a href="#l29.54"></a><span id="l29.54" class="difflineminus">-  let streamURI = msgService.streamMessage(</span>
<a href="#l29.55"></a><span id="l29.55" class="difflineplus">+  msgService.streamMessage(</span>
<a href="#l29.56"></a><span id="l29.56">     msgURI,</span>
<a href="#l29.57"></a><span id="l29.57">     gStreamListener,</span>
<a href="#l29.58"></a><span id="l29.58">     null,</span>
<a href="#l29.59"></a><span id="l29.59">     gUrlListener,</span>
<a href="#l29.60"></a><span id="l29.60">     true, // have them create the converter</span>
<a href="#l29.61"></a><span id="l29.61">     // additional uri payload, note that &quot;header=&quot; is prepended automatically</span>
<a href="#l29.62"></a><span id="l29.62">     &quot;filter&quot;,</span>
<a href="#l29.63"></a><span id="l29.63" class="difflineminus">-    true);</span>
<a href="#l29.64"></a><span id="l29.64" class="difflineplus">+    true</span>
<a href="#l29.65"></a><span id="l29.65" class="difflineplus">+  );</span>
<a href="#l29.66"></a><span id="l29.66"> }</span>
<a href="#l29.67"></a><span id="l29.67"> </span>
<a href="#l29.68"></a><span id="l29.68"> var gStreamListener = {</span>
<a href="#l29.69"></a><span id="l29.69">   QueryInterface: ChromeUtils.generateQI([Ci.nsIStreamListener]),</span>
<a href="#l29.70"></a><span id="l29.70" class="difflineminus">-  _stream : null,</span>
<a href="#l29.71"></a><span id="l29.71" class="difflineplus">+  _stream: null,</span>
<a href="#l29.72"></a><span id="l29.72">   // nsIRequestObserver part</span>
<a href="#l29.73"></a><span id="l29.73" class="difflineminus">-  onStartRequest: function (aRequest) {</span>
<a href="#l29.74"></a><span id="l29.74" class="difflineplus">+  onStartRequest(aRequest) {</span>
<a href="#l29.75"></a><span id="l29.75">   },</span>
<a href="#l29.76"></a><span id="l29.76" class="difflineminus">-  onStopRequest: function (aRequest, aStatusCode) {</span>
<a href="#l29.77"></a><span id="l29.77" class="difflineplus">+  onStopRequest(aRequest, aStatusCode) {</span>
<a href="#l29.78"></a><span id="l29.78">     doNextTest();</span>
<a href="#l29.79"></a><span id="l29.79">   },</span>
<a href="#l29.80"></a><span id="l29.80"> </span>
<a href="#l29.81"></a><span id="l29.81">   /* okay, our onDataAvailable should actually never be called.  the stream</span>
<a href="#l29.82"></a><span id="l29.82">      converter is actually eating everything except the start and stop</span>
<a href="#l29.83"></a><span id="l29.83">      notification. */</span>
<a href="#l29.84"></a><span id="l29.84">   // nsIStreamListener part</span>
<a href="#l29.85"></a><span id="l29.85" class="difflineminus">-  onDataAvailable: function (aRequest, aInputStream, aOffset, aCount) {</span>
<a href="#l29.86"></a><span id="l29.86" class="difflineplus">+  onDataAvailable(aRequest, aInputStream, aOffset, aCount) {</span>
<a href="#l29.87"></a><span id="l29.87">     if (this._stream === null) {</span>
<a href="#l29.88"></a><span id="l29.88">       this._stream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;].</span>
<a href="#l29.89"></a><span id="l29.89">                     createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l29.90"></a><span id="l29.90">       this._stream.init(aInputStream);</span>
<a href="#l29.91"></a><span id="l29.91">     }</span>
<a href="#l29.92"></a><span id="l29.92">     this._stream.read(aCount);</span>
<a href="#l29.93"></a><span id="l29.93">   },</span>
<a href="#l29.94"></a><span id="l29.94"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/mime/test/unit/test_nsIMsgHeaderParser1.js</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/mime/test/unit/test_nsIMsgHeaderParser1.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -1,18 +1,17 @@</span>
<a href="#l30.4"></a><span id="l30.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l30.5"></a><span id="l30.5"> /*</span>
<a href="#l30.6"></a><span id="l30.6">  * Test suite for nsIMsgHeaderParser functions.</span>
<a href="#l30.7"></a><span id="l30.7">  */</span>
<a href="#l30.8"></a><span id="l30.8"> </span>
<a href="#l30.9"></a><span id="l30.9"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l30.10"></a><span id="l30.10"> </span>
<a href="#l30.11"></a><span id="l30.11"> function run_test() {</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-  var checks =</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineminus">-  [</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineplus">+  var checks = [</span>
<a href="#l30.15"></a><span id="l30.15">     [&quot;&quot;, &quot;test@foo.invalid&quot;, &quot;test@foo.invalid&quot;],</span>
<a href="#l30.16"></a><span id="l30.16">     [&quot;Test&quot;, &quot;test@foo.invalid&quot;, &quot;Test &lt;test@foo.invalid&gt;&quot;],</span>
<a href="#l30.17"></a><span id="l30.17">     [&quot;Test&quot;, &quot;\&quot;abc!x.yz\&quot;@foo.invalid&quot;, &quot;Test &lt;\&quot;abc!x.yz\&quot;@foo.invalid&gt;&quot;],</span>
<a href="#l30.18"></a><span id="l30.18">     [&quot;Test&quot;, &quot;test.user@foo.invalid&quot;, &quot;Test &lt;test.user@foo.invalid&gt;&quot;],</span>
<a href="#l30.19"></a><span id="l30.19">     [&quot;Test&quot;, &quot;test@[xyz!]&quot;, &quot;Test &lt;test@[xyz!]&gt;&quot;],</span>
<a href="#l30.20"></a><span id="l30.20">     // Based on RFC 2822 A.1.1</span>
<a href="#l30.21"></a><span id="l30.21">     [&quot;John Doe&quot;, &quot;jdoe@machine.example&quot;, &quot;John Doe &lt;jdoe@machine.example&gt;&quot;],</span>
<a href="#l30.22"></a><span id="l30.22">     // Next 2 tests Based on RFC 2822 A.1.2</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/mime/test/unit/test_nsIMsgHeaderParser2.js</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/mime/test/unit/test_nsIMsgHeaderParser2.js</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -9,18 +9,17 @@</span>
<a href="#l31.4"></a><span id="l31.4"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l31.5"></a><span id="l31.5"> </span>
<a href="#l31.6"></a><span id="l31.6"> function run_test() {</span>
<a href="#l31.7"></a><span id="l31.7">   // In this array, the sub arrays consist of the following elements:</span>
<a href="#l31.8"></a><span id="l31.8">   // 0: input string (a comma separated list of recipients)</span>
<a href="#l31.9"></a><span id="l31.9">   // 1: expected output from extractHeaderAddressMailboxes</span>
<a href="#l31.10"></a><span id="l31.10">   // 2: list of recipient names in the string</span>
<a href="#l31.11"></a><span id="l31.11">   // 3: first recipient name in the string</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-  const checks =</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineminus">-  [</span>
<a href="#l31.14"></a><span id="l31.14" class="difflineplus">+  const checks = [</span>
<a href="#l31.15"></a><span id="l31.15">     [&quot;abc@foo.invalid&quot;,</span>
<a href="#l31.16"></a><span id="l31.16">      &quot;abc@foo.invalid&quot;,</span>
<a href="#l31.17"></a><span id="l31.17">      &quot;abc@foo.invalid&quot;,</span>
<a href="#l31.18"></a><span id="l31.18">      &quot;abc@foo.invalid&quot; ],</span>
<a href="#l31.19"></a><span id="l31.19">     [&quot;foo &lt;ghj@foo.invalid&gt;&quot;,</span>
<a href="#l31.20"></a><span id="l31.20">      &quot;ghj@foo.invalid&quot;,</span>
<a href="#l31.21"></a><span id="l31.21">      &quot;foo&quot;,</span>
<a href="#l31.22"></a><span id="l31.22">      &quot;foo&quot; ],</span>
<a href="#l31.23"></a><span id="l31.23" class="difflineat">@@ -46,31 +45,31 @@ function run_test() {</span>
<a href="#l31.24"></a><span id="l31.24">      &quot;john.q.public@example.com, \&quot;abc!x.yz\&quot;@foo.invalid, test@[xyz!], sysservices@example.net&quot;,</span>
<a href="#l31.25"></a><span id="l31.25">      &quot;Joe Q. Public, Test, Test, Giant; \&quot;Big\&quot; Box&quot;,</span>
<a href="#l31.26"></a><span id="l31.26">      // extractFirstName returns unquoted names, hence the difference.</span>
<a href="#l31.27"></a><span id="l31.27">      &quot;Joe Q. Public&quot; ],</span>
<a href="#l31.28"></a><span id="l31.28">     // Bug 549931</span>
<a href="#l31.29"></a><span id="l31.29">     [&quot;Undisclosed recipients:;&quot;,</span>
<a href="#l31.30"></a><span id="l31.30">      &quot;&quot;, // Mailboxes</span>
<a href="#l31.31"></a><span id="l31.31">      &quot;&quot;, // Address Names</span>
<a href="#l31.32"></a><span id="l31.32" class="difflineminus">-     &quot;&quot;] // Address Name</span>
<a href="#l31.33"></a><span id="l31.33" class="difflineplus">+     &quot;&quot;], // Address Name</span>
<a href="#l31.34"></a><span id="l31.34">   ];</span>
<a href="#l31.35"></a><span id="l31.35"> </span>
<a href="#l31.36"></a><span id="l31.36">   // this used to cause memory read overruns</span>
<a href="#l31.37"></a><span id="l31.37">   let addresses = {}, names = {}, fullAddresses = {};</span>
<a href="#l31.38"></a><span id="l31.38">   MailServices.headerParser.parseHeadersWithArray(&quot;\&quot; \&quot;@a a;b&quot;, addresses, names, fullAddresses);</span>
<a href="#l31.39"></a><span id="l31.39"> </span>
<a href="#l31.40"></a><span id="l31.40">   // Test - empty strings</span>
<a href="#l31.41"></a><span id="l31.41"> </span>
<a href="#l31.42"></a><span id="l31.42">   Assert.equal(MailServices.headerParser.extractHeaderAddressMailboxes(&quot;&quot;), &quot;&quot;);</span>
<a href="#l31.43"></a><span id="l31.43">   Assert.equal(MailServices.headerParser.extractFirstName(&quot;&quot;), &quot;&quot;);</span>
<a href="#l31.44"></a><span id="l31.44"> </span>
<a href="#l31.45"></a><span id="l31.45">   // Test - extractHeaderAddressMailboxes</span>
<a href="#l31.46"></a><span id="l31.46"> </span>
<a href="#l31.47"></a><span id="l31.47">   for (let i = 0; i &lt; checks.length; ++i) {</span>
<a href="#l31.48"></a><span id="l31.48">     Assert.equal(MailServices.headerParser.extractHeaderAddressMailboxes(checks[i][0]), checks[i][1]);</span>
<a href="#l31.49"></a><span id="l31.49" class="difflineminus">-    let names = MailServices.headerParser.parseDecodedHeader(checks[i][0])</span>
<a href="#l31.50"></a><span id="l31.50" class="difflineminus">-                                         .map(addr =&gt; addr.name || addr.email)</span>
<a href="#l31.51"></a><span id="l31.51" class="difflineminus">-                                         .join(&quot;, &quot;);</span>
<a href="#l31.52"></a><span id="l31.52" class="difflineminus">-    Assert.equal(names, checks[i][2]);</span>
<a href="#l31.53"></a><span id="l31.53" class="difflineplus">+    let _names = MailServices.headerParser.parseDecodedHeader(checks[i][0])</span>
<a href="#l31.54"></a><span id="l31.54" class="difflineplus">+                                          .map(addr =&gt; addr.name || addr.email)</span>
<a href="#l31.55"></a><span id="l31.55" class="difflineplus">+                                          .join(&quot;, &quot;);</span>
<a href="#l31.56"></a><span id="l31.56" class="difflineplus">+    Assert.equal(_names, checks[i][2]);</span>
<a href="#l31.57"></a><span id="l31.57">     Assert.equal(MailServices.headerParser.extractFirstName(checks[i][0]), checks[i][3]);</span>
<a href="#l31.58"></a><span id="l31.58">   }</span>
<a href="#l31.59"></a><span id="l31.59"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/mime/test/unit/test_nsIMsgHeaderParser3.js</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/mime/test/unit/test_nsIMsgHeaderParser3.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -1,18 +1,17 @@</span>
<a href="#l32.4"></a><span id="l32.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l32.5"></a><span id="l32.5"> /*</span>
<a href="#l32.6"></a><span id="l32.6">  * Test suite for nsIMsgHeaderParser function removeDuplicateAddresses:</span>
<a href="#l32.7"></a><span id="l32.7">  */</span>
<a href="#l32.8"></a><span id="l32.8"> </span>
<a href="#l32.9"></a><span id="l32.9"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l32.10"></a><span id="l32.10"> </span>
<a href="#l32.11"></a><span id="l32.11"> function run_test() {</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-  const checks =</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineminus">-  [</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineplus">+  const checks = [</span>
<a href="#l32.15"></a><span id="l32.15">     { addrs: &quot;test@foo.invalid&quot;,</span>
<a href="#l32.16"></a><span id="l32.16">       otherAddrs: &quot;&quot;,</span>
<a href="#l32.17"></a><span id="l32.17">       expectedResult: &quot;test@foo.invalid&quot; },</span>
<a href="#l32.18"></a><span id="l32.18">     { addrs: &quot;foo bar &lt;test@foo.invalid&gt;&quot;,</span>
<a href="#l32.19"></a><span id="l32.19">       otherAddrs: &quot;&quot;,</span>
<a href="#l32.20"></a><span id="l32.20">       expectedResult: &quot;foo bar &lt;test@foo.invalid&gt;&quot; },</span>
<a href="#l32.21"></a><span id="l32.21">     { addrs: &quot;foo bar &lt;test@foo.invalid&gt;, abc@foo.invalid&quot;,</span>
<a href="#l32.22"></a><span id="l32.22">       otherAddrs: &quot;&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mailnews/mime/test/unit/test_nsIMsgHeaderParser4.js</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mailnews/mime/test/unit/test_nsIMsgHeaderParser4.js</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -1,18 +1,17 @@</span>
<a href="#l33.4"></a><span id="l33.4"> /* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l33.5"></a><span id="l33.5"> /*</span>
<a href="#l33.6"></a><span id="l33.6">  * Test suite for nsIMsgHeaderParser::makeFromDisplayAddress</span>
<a href="#l33.7"></a><span id="l33.7">  */</span>
<a href="#l33.8"></a><span id="l33.8"> </span>
<a href="#l33.9"></a><span id="l33.9"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l33.10"></a><span id="l33.10"> </span>
<a href="#l33.11"></a><span id="l33.11"> function run_test() {</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-  const checks =</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineminus">-  [</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineplus">+  const checks = [</span>
<a href="#l33.15"></a><span id="l33.15">     { displayString: &quot;&quot;,</span>
<a href="#l33.16"></a><span id="l33.16">       addresses: [] },</span>
<a href="#l33.17"></a><span id="l33.17">     { displayString: &quot;test@foo.invalid&quot;,</span>
<a href="#l33.18"></a><span id="l33.18">       addresses: [[&quot;&quot;, &quot;test@foo.invalid&quot;]] },</span>
<a href="#l33.19"></a><span id="l33.19">     { displayString: &quot;test@foo.invalid, test2@foo.invalid&quot;,</span>
<a href="#l33.20"></a><span id="l33.20">       addresses: [[&quot;&quot;, &quot;test@foo.invalid&quot;],</span>
<a href="#l33.21"></a><span id="l33.21">                   [&quot;&quot;, &quot;test2@foo.invalid&quot;]] },</span>
<a href="#l33.22"></a><span id="l33.22">     { displayString: &quot;John Doe &lt;test@foo.invalid&gt;&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mailnews/mime/test/unit/test_nsIMsgHeaderParser5.js</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mailnews/mime/test/unit/test_nsIMsgHeaderParser5.js</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -15,18 +15,17 @@ function equalArrays(arr1, arr2) {</span>
<a href="#l34.4"></a><span id="l34.4">   }</span>
<a href="#l34.5"></a><span id="l34.5"> }</span>
<a href="#l34.6"></a><span id="l34.6"> </span>
<a href="#l34.7"></a><span id="l34.7"> function run_test() {</span>
<a href="#l34.8"></a><span id="l34.8">   // In this array, the sub arrays consist of the following elements:</span>
<a href="#l34.9"></a><span id="l34.9">   // 0: input string</span>
<a href="#l34.10"></a><span id="l34.10">   // 1: expected output from parseDecodedHeader</span>
<a href="#l34.11"></a><span id="l34.11">   // 2: expected output from parseEncodedHeader</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-  const checks =</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineminus">-  [</span>
<a href="#l34.14"></a><span id="l34.14" class="difflineplus">+  const checks = [</span>
<a href="#l34.15"></a><span id="l34.15">     [&quot;abc@foo.invalid&quot;,</span>
<a href="#l34.16"></a><span id="l34.16">      [{name: &quot;&quot;, email: &quot;abc@foo.invalid&quot;}],</span>
<a href="#l34.17"></a><span id="l34.17">      [{name: &quot;&quot;, email: &quot;abc@foo.invalid&quot;}]],</span>
<a href="#l34.18"></a><span id="l34.18">     [&quot;foo &lt;ghj@foo.invalid&gt;&quot;,</span>
<a href="#l34.19"></a><span id="l34.19">      [{name: &quot;foo&quot;, email: &quot;ghj@foo.invalid&quot;}],</span>
<a href="#l34.20"></a><span id="l34.20">      [{name: &quot;foo&quot;, email: &quot;ghj@foo.invalid&quot;}]],</span>
<a href="#l34.21"></a><span id="l34.21">     [&quot;abc@foo.invalid, foo &lt;ghj@foo.invalid&gt;&quot;,</span>
<a href="#l34.22"></a><span id="l34.22">      [{name: &quot;&quot;, email: &quot;abc@foo.invalid&quot;},</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mailnews/mime/test/unit/test_parser.js</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mailnews/mime/test/unit/test_parser.js</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -5,17 +5,17 @@</span>
<a href="#l35.4"></a><span id="l35.4"> // This file is used to test the mime parser implemented in JS, mostly by means</span>
<a href="#l35.5"></a><span id="l35.5"> // of creating custom emitters and verifying that the methods on that emitter</span>
<a href="#l35.6"></a><span id="l35.6"> // are called in the correct order. This also tests that the various</span>
<a href="#l35.7"></a><span id="l35.7"> // HeaderParser methods are run correctly.</span>
<a href="#l35.8"></a><span id="l35.8"> </span>
<a href="#l35.9"></a><span id="l35.9"> const {MimeParser} = ChromeUtils.import(&quot;resource:///modules/mimeParser.jsm&quot;);</span>
<a href="#l35.10"></a><span id="l35.10"> var {IOUtils} = ChromeUtils.import(&quot;resource:///modules/IOUtils.js&quot;);</span>
<a href="#l35.11"></a><span id="l35.11"> </span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-/// Utility method to compare objects</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineplus">+// Utility method to compare objects</span>
<a href="#l35.14"></a><span id="l35.14"> function compare_objects(real, expected) {</span>
<a href="#l35.15"></a><span id="l35.15">   // real is a Map; convert it into an object for uneval purposes</span>
<a href="#l35.16"></a><span id="l35.16">   if (typeof real == &quot;object&quot;) {</span>
<a href="#l35.17"></a><span id="l35.17">     var newreal = {};</span>
<a href="#l35.18"></a><span id="l35.18">     for (let [k, v] of real) {</span>
<a href="#l35.19"></a><span id="l35.19">       newreal[k] = v;</span>
<a href="#l35.20"></a><span id="l35.20">     }</span>
<a href="#l35.21"></a><span id="l35.21">     real = newreal;</span>
<a href="#l35.22"></a><span id="l35.22" class="difflineat">@@ -23,42 +23,42 @@ function compare_objects(real, expected)</span>
<a href="#l35.23"></a><span id="l35.23">   var a = uneval(real), b = uneval(expected);</span>
<a href="#l35.24"></a><span id="l35.24">   // Very long strings don't get printed out fully (unless they're wrong)</span>
<a href="#l35.25"></a><span id="l35.25">   if ((a.length &gt; 100 || b.length &gt; 100) &amp;&amp; (a == b))</span>
<a href="#l35.26"></a><span id="l35.26">     Assert.ok(a == b);</span>
<a href="#l35.27"></a><span id="l35.27">   else</span>
<a href="#l35.28"></a><span id="l35.28">     Assert.equal(a, b);</span>
<a href="#l35.29"></a><span id="l35.29"> }</span>
<a href="#l35.30"></a><span id="l35.30"> </span>
<a href="#l35.31"></a><span id="l35.31" class="difflineminus">-/// Returns and deletes object[field] if present, or undefined if not.</span>
<a href="#l35.32"></a><span id="l35.32" class="difflineplus">+// Returns and deletes object[field] if present, or undefined if not.</span>
<a href="#l35.33"></a><span id="l35.33"> function extract_field(object, field) {</span>
<a href="#l35.34"></a><span id="l35.34">   if (field in object) {</span>
<a href="#l35.35"></a><span id="l35.35">     var result = object[field];</span>
<a href="#l35.36"></a><span id="l35.36">     delete object[field];</span>
<a href="#l35.37"></a><span id="l35.37">     return result;</span>
<a href="#l35.38"></a><span id="l35.38">   }</span>
<a href="#l35.39"></a><span id="l35.39">   return undefined;</span>
<a href="#l35.40"></a><span id="l35.40"> }</span>
<a href="#l35.41"></a><span id="l35.41"> </span>
<a href="#l35.42"></a><span id="l35.42" class="difflineminus">-/// A file cache for read_file.</span>
<a href="#l35.43"></a><span id="l35.43" class="difflineplus">+// A file cache for read_file.</span>
<a href="#l35.44"></a><span id="l35.44"> var file_cache = {};</span>
<a href="#l35.45"></a><span id="l35.45"> </span>
<a href="#l35.46"></a><span id="l35.46"> /**</span>
<a href="#l35.47"></a><span id="l35.47">  * Read a file into a string (all line endings become CRLF).</span>
<a href="#l35.48"></a><span id="l35.48">  */</span>
<a href="#l35.49"></a><span id="l35.49"> function read_file(file, start, end) {</span>
<a href="#l35.50"></a><span id="l35.50">   if (!(file in file_cache)) {</span>
<a href="#l35.51"></a><span id="l35.51">     var realFile = do_get_file(&quot;../../../data/&quot; + file);</span>
<a href="#l35.52"></a><span id="l35.52">     file_cache[file] = IOUtils.loadFileToString(realFile).split(/\r\n|[\r\n]/);</span>
<a href="#l35.53"></a><span id="l35.53">   }</span>
<a href="#l35.54"></a><span id="l35.54">   var contents = file_cache[file];</span>
<a href="#l35.55"></a><span id="l35.55">   if (start !== undefined) {</span>
<a href="#l35.56"></a><span id="l35.56">     contents = contents.slice(start - 1, end - 1);</span>
<a href="#l35.57"></a><span id="l35.57">   }</span>
<a href="#l35.58"></a><span id="l35.58" class="difflineminus">-  return contents.join('\r\n');</span>
<a href="#l35.59"></a><span id="l35.59" class="difflineplus">+  return contents.join(&quot;\r\n&quot;);</span>
<a href="#l35.60"></a><span id="l35.60"> }</span>
<a href="#l35.61"></a><span id="l35.61"> </span>
<a href="#l35.62"></a><span id="l35.62"> /**</span>
<a href="#l35.63"></a><span id="l35.63">  * Helper for body tests.</span>
<a href="#l35.64"></a><span id="l35.64">  *</span>
<a href="#l35.65"></a><span id="l35.65">  * Some extra options are listed too:</span>
<a href="#l35.66"></a><span id="l35.66">  * _split: The contents of the file will be passed in packets split by this</span>
<a href="#l35.67"></a><span id="l35.67">  *         regex. Be sure to include the split delimiter in a group so that they</span>
<a href="#l35.68"></a><span id="l35.68" class="difflineat">@@ -75,166 +75,165 @@ function read_file(file, start, end) {</span>
<a href="#l35.69"></a><span id="l35.69">  *                 of the file from [line start, line end) [1-based lines]</span>
<a href="#l35.70"></a><span id="l35.70">  */</span>
<a href="#l35.71"></a><span id="l35.71"> function make_body_test(test, file, opts, partspec) {</span>
<a href="#l35.72"></a><span id="l35.72">   var results = partspec.map(p =&gt; [p[0], read_file(file, p[1], p[2])]);</span>
<a href="#l35.73"></a><span id="l35.73">   var msgcontents = read_file(file);</span>
<a href="#l35.74"></a><span id="l35.74">   return [test, msgcontents, opts, results];</span>
<a href="#l35.75"></a><span id="l35.75"> }</span>
<a href="#l35.76"></a><span id="l35.76"> </span>
<a href="#l35.77"></a><span id="l35.77" class="difflineminus">-/// This is the expected part specifier for the multipart-complex1 test file,</span>
<a href="#l35.78"></a><span id="l35.78" class="difflineminus">-/// specified here because it is used in several cases.</span>
<a href="#l35.79"></a><span id="l35.79" class="difflineminus">-var mpart_complex1 = [['1', 8, 10], ['2', 14, 16], ['3.1', 22, 24],</span>
<a href="#l35.80"></a><span id="l35.80" class="difflineminus">-    ['4', 29, 31], ['5', 33, 35]];</span>
<a href="#l35.81"></a><span id="l35.81" class="difflineplus">+// This is the expected part specifier for the multipart-complex1 test file,</span>
<a href="#l35.82"></a><span id="l35.82" class="difflineplus">+// specified here because it is used in several cases.</span>
<a href="#l35.83"></a><span id="l35.83" class="difflineplus">+var mpart_complex1 = [[&quot;1&quot;, 8, 10], [&quot;2&quot;, 14, 16], [&quot;3.1&quot;, 22, 24],</span>
<a href="#l35.84"></a><span id="l35.84" class="difflineplus">+    [&quot;4&quot;, 29, 31], [&quot;5&quot;, 33, 35]];</span>
<a href="#l35.85"></a><span id="l35.85"> </span>
<a href="#l35.86"></a><span id="l35.86"> // Format of tests:</span>
<a href="#l35.87"></a><span id="l35.87"> // entry[0] = name of the test</span>
<a href="#l35.88"></a><span id="l35.88"> // entry[1] = message (a string or an array of packets)</span>
<a href="#l35.89"></a><span id="l35.89"> // entry[2] = options for the MIME parser</span>
<a href="#l35.90"></a><span id="l35.90"> // entry[3] = A checker result:</span>
<a href="#l35.91"></a><span id="l35.91"> //            either a {partnum: header object} (to check headers)</span>
<a href="#l35.92"></a><span id="l35.92"> //            or a [[partnum body], [partnum body], ...] (to check bodies)</span>
<a href="#l35.93"></a><span id="l35.93"> //            (the partnums refer to the expected part numbers of the MIME test)</span>
<a href="#l35.94"></a><span id="l35.94"> // Note that for body tests, unless you're testing decoding, it is preferable to</span>
<a href="#l35.95"></a><span id="l35.95"> // use make_body_test instead of writing the array yourself.</span>
<a href="#l35.96"></a><span id="l35.96"> var parser_tests = [</span>
<a href="#l35.97"></a><span id="l35.97">   // Body tests from data</span>
<a href="#l35.98"></a><span id="l35.98">   // (Note: line numbers are 1-based. Also, to capture trailing EOF, add 2 to</span>
<a href="#l35.99"></a><span id="l35.99">   // the last line number of the file).</span>
<a href="#l35.100"></a><span id="l35.100" class="difflineminus">-  make_body_test(&quot;Basic body&quot;, &quot;basic1&quot;, {}, [['', 3, 5]]),</span>
<a href="#l35.101"></a><span id="l35.101" class="difflineminus">-  make_body_test(&quot;Basic multipart&quot;, &quot;multipart1&quot;, {}, [['1', 10, 12]]),</span>
<a href="#l35.102"></a><span id="l35.102" class="difflineminus">-  make_body_test(&quot;Basic multipart&quot;, &quot;multipart2&quot;, {}, [['1', 8, 11]]),</span>
<a href="#l35.103"></a><span id="l35.103" class="difflineplus">+  make_body_test(&quot;Basic body&quot;, &quot;basic1&quot;, {}, [[&quot;&quot;, 3, 5]]),</span>
<a href="#l35.104"></a><span id="l35.104" class="difflineplus">+  make_body_test(&quot;Basic multipart&quot;, &quot;multipart1&quot;, {}, [[&quot;1&quot;, 10, 12]]),</span>
<a href="#l35.105"></a><span id="l35.105" class="difflineplus">+  make_body_test(&quot;Basic multipart&quot;, &quot;multipart2&quot;, {}, [[&quot;1&quot;, 8, 11]]),</span>
<a href="#l35.106"></a><span id="l35.106">   make_body_test(&quot;Complex multipart&quot;, &quot;multipart-complex1&quot;, {}, mpart_complex1),</span>
<a href="#l35.107"></a><span id="l35.107">   make_body_test(&quot;Truncated multipart&quot;, &quot;multipart-complex2&quot;, {},</span>
<a href="#l35.108"></a><span id="l35.108" class="difflineminus">-    [['1.1.1.1', 21, 25], ['2', 27, 57], ['3', 60, 62]]),</span>
<a href="#l35.109"></a><span id="l35.109" class="difflineplus">+    [[&quot;1.1.1.1&quot;, 21, 25], [&quot;2&quot;, 27, 57], [&quot;3&quot;, 60, 62]]),</span>
<a href="#l35.110"></a><span id="l35.110">   make_body_test(&quot;No LF multipart&quot;, &quot;multipartmalt-detach&quot;, {},</span>
<a href="#l35.111"></a><span id="l35.111" class="difflineminus">-    [['1', 20, 21], ['2.1', 27, 38], ['2.2', 42, 43], ['2.3', 47, 48]]),</span>
<a href="#l35.112"></a><span id="l35.112" class="difflineminus">-  make_body_test(&quot;Raw body&quot;, &quot;multipart1&quot;, {bodyformat: &quot;raw&quot;}, [['', 4, 14]]),</span>
<a href="#l35.113"></a><span id="l35.113" class="difflineplus">+    [[&quot;1&quot;, 20, 21], [&quot;2.1&quot;, 27, 38], [&quot;2.2&quot;, 42, 43], [&quot;2.3&quot;, 47, 48]]),</span>
<a href="#l35.114"></a><span id="l35.114" class="difflineplus">+  make_body_test(&quot;Raw body&quot;, &quot;multipart1&quot;, {bodyformat: &quot;raw&quot;}, [[&quot;&quot;, 4, 14]]),</span>
<a href="#l35.115"></a><span id="l35.115">   [&quot;Base64 decode 1&quot;, read_file(&quot;base64-1&quot;), {bodyformat: &quot;decode&quot;},</span>
<a href="#l35.116"></a><span id="l35.116" class="difflineminus">-    [['', &quot;\r\nHello, world! (Again...)\r\n\r\nLet's see how well base64 text&quot; +</span>
<a href="#l35.117"></a><span id="l35.117" class="difflineplus">+    [[&quot;&quot;, &quot;\r\nHello, world! (Again...)\r\n\r\nLet's see how well base64 text&quot; +</span>
<a href="#l35.118"></a><span id="l35.118">           &quot; is handled.                            Yay, lots of spaces! There&quot; +</span>
<a href="#l35.119"></a><span id="l35.119">           &quot;'s even a CRLF at the end and one at the beginning, but the output&quot; +</span>
<a href="#l35.120"></a><span id="l35.120">           &quot; shouldn't have it.\r\n&quot;]]],</span>
<a href="#l35.121"></a><span id="l35.121">   [&quot;Base64 decode 2&quot;, read_file(&quot;base64-2&quot;), {bodyformat: &quot;decode&quot;},</span>
<a href="#l35.122"></a><span id="l35.122" class="difflineminus">-    [['', &quot;&lt;html&gt;&lt;body&gt;This is base64 encoded HTML text, and the tags shouldn&quot; +</span>
<a href="#l35.123"></a><span id="l35.123" class="difflineplus">+    [[&quot;&quot;, &quot;&lt;html&gt;&lt;body&gt;This is base64 encoded HTML text, and the tags shouldn&quot; +</span>
<a href="#l35.124"></a><span id="l35.124">           &quot;'t be stripped.\r\n&lt;b&gt;Bold text is bold!&lt;/b&gt;&lt;/body&gt;&lt;/html&gt;\r\n&quot;]]],</span>
<a href="#l35.125"></a><span id="l35.125" class="difflineminus">-  make_body_test(&quot;Base64 nodecode&quot;, &quot;base64-1&quot;, {}, [['', 4, 9]]),</span>
<a href="#l35.126"></a><span id="l35.126" class="difflineminus">-  [&quot;QP decode&quot;, read_file(&quot;bug505221&quot;), {pruneat: '1', bodyformat: &quot;decode&quot;},</span>
<a href="#l35.127"></a><span id="l35.127" class="difflineminus">-    [['1', '&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.0 Transitional//EN&quot;&gt;\r'  +</span>
<a href="#l35.128"></a><span id="l35.128" class="difflineplus">+  make_body_test(&quot;Base64 nodecode&quot;, &quot;base64-1&quot;, {}, [[&quot;&quot;, 4, 9]]),</span>
<a href="#l35.129"></a><span id="l35.129" class="difflineplus">+  [&quot;QP decode&quot;, read_file(&quot;bug505221&quot;), {pruneat: &quot;1&quot;, bodyformat: &quot;decode&quot;},</span>
<a href="#l35.130"></a><span id="l35.130" class="difflineplus">+    [[&quot;1&quot;, '&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.0 Transitional//EN&quot;&gt;\r' +</span>
<a href="#l35.131"></a><span id="l35.131">            '\n&lt;HTML&gt;&lt;HEAD&gt;\r\n&lt;META HTTP-EQUIV=&quot;Content-Type&quot; CONTENT=&quot;text/h' +</span>
<a href="#l35.132"></a><span id="l35.132">            'tml; charset=us-ascii&quot;&gt;\r\n\r\n\r\n&lt;META content=&quot;MSHTML 6.00.600' +</span>
<a href="#l35.133"></a><span id="l35.133">            '0.16735&quot; name=GENERATOR&gt;&lt;/HEAD&gt;\r\n&lt;BODY&gt; bbb\r\n&lt;/BODY&gt;&lt;/HTML&gt;']]],</span>
<a href="#l35.134"></a><span id="l35.134"> </span>
<a href="#l35.135"></a><span id="l35.135">   // Comprehensive tests from the torture test</span>
<a href="#l35.136"></a><span id="l35.136">   make_body_test(&quot;Torture regular body&quot;, &quot;mime-torture&quot;, {}, [</span>
<a href="#l35.137"></a><span id="l35.137" class="difflineminus">-    ['1', 17, 21], ['2$.1', 58, 75], ['2$.2.1', 83, 97], ['2$.3', 102, 130],</span>
<a href="#l35.138"></a><span id="l35.138" class="difflineminus">-    ['3$', 155, 7742], ['4', 7747, 8213], ['5', 8218, 8242],</span>
<a href="#l35.139"></a><span id="l35.139" class="difflineminus">-    ['6$.1.1', 8284, 8301], ['6$.1.2', 8306, 8733], ['6$.2.1', 8742, 9095],</span>
<a href="#l35.140"></a><span id="l35.140" class="difflineminus">-    ['6$.2.2', 9100, 9354], ['6$.2.3', 9357, 11794], ['6$.2.4', 11797, 12155],</span>
<a href="#l35.141"></a><span id="l35.141" class="difflineminus">-    ['6$.3', 12161, 12809], ['7$.1', 12844, 12845], ['7$.2', 12852, 13286],</span>
<a href="#l35.142"></a><span id="l35.142" class="difflineminus">-    ['7$.3', 13288, 13297], ['8$.1', 13331, 13358], ['8$.2', 13364, 13734],</span>
<a href="#l35.143"></a><span id="l35.143" class="difflineminus">-    ['9$', 13757, 20179], ['10', 20184, 21200], ['11$.1', 21223, 22031],</span>
<a href="#l35.144"></a><span id="l35.144" class="difflineminus">-    ['11$.2', 22036, 22586], ['12$.1', 22607, 23469], ['12$.2', 23474, 23774],</span>
<a href="#l35.145"></a><span id="l35.145" class="difflineminus">-    ['12$.3$.1', 23787, 23795], ['12$.3$.2.1', 23803, 23820],</span>
<a href="#l35.146"></a><span id="l35.146" class="difflineminus">-    ['12$.3$.2.2', 23825, 24633], ['12$.3$.3', 24640, 24836],</span>
<a href="#l35.147"></a><span id="l35.147" class="difflineminus">-    ['12$.3$.4$', 24848, 25872]]),</span>
<a href="#l35.148"></a><span id="l35.148" class="difflineminus">-  make_body_test(&quot;Torture pruneat&quot;, &quot;mime-torture&quot;, {&quot;pruneat&quot;: '4'},</span>
<a href="#l35.149"></a><span id="l35.149" class="difflineminus">-    [['4', 7747, 8213]]),</span>
<a href="#l35.150"></a><span id="l35.150" class="difflineplus">+    [&quot;1&quot;, 17, 21], [&quot;2$.1&quot;, 58, 75], [&quot;2$.2.1&quot;, 83, 97], [&quot;2$.3&quot;, 102, 130],</span>
<a href="#l35.151"></a><span id="l35.151" class="difflineplus">+    [&quot;3$&quot;, 155, 7742], [&quot;4&quot;, 7747, 8213], [&quot;5&quot;, 8218, 8242],</span>
<a href="#l35.152"></a><span id="l35.152" class="difflineplus">+    [&quot;6$.1.1&quot;, 8284, 8301], [&quot;6$.1.2&quot;, 8306, 8733], [&quot;6$.2.1&quot;, 8742, 9095],</span>
<a href="#l35.153"></a><span id="l35.153" class="difflineplus">+    [&quot;6$.2.2&quot;, 9100, 9354], [&quot;6$.2.3&quot;, 9357, 11794], [&quot;6$.2.4&quot;, 11797, 12155],</span>
<a href="#l35.154"></a><span id="l35.154" class="difflineplus">+    [&quot;6$.3&quot;, 12161, 12809], [&quot;7$.1&quot;, 12844, 12845], [&quot;7$.2&quot;, 12852, 13286],</span>
<a href="#l35.155"></a><span id="l35.155" class="difflineplus">+    [&quot;7$.3&quot;, 13288, 13297], [&quot;8$.1&quot;, 13331, 13358], [&quot;8$.2&quot;, 13364, 13734],</span>
<a href="#l35.156"></a><span id="l35.156" class="difflineplus">+    [&quot;9$&quot;, 13757, 20179], [&quot;10&quot;, 20184, 21200], [&quot;11$.1&quot;, 21223, 22031],</span>
<a href="#l35.157"></a><span id="l35.157" class="difflineplus">+    [&quot;11$.2&quot;, 22036, 22586], [&quot;12$.1&quot;, 22607, 23469], [&quot;12$.2&quot;, 23474, 23774],</span>
<a href="#l35.158"></a><span id="l35.158" class="difflineplus">+    [&quot;12$.3$.1&quot;, 23787, 23795], [&quot;12$.3$.2.1&quot;, 23803, 23820],</span>
<a href="#l35.159"></a><span id="l35.159" class="difflineplus">+    [&quot;12$.3$.2.2&quot;, 23825, 24633], [&quot;12$.3$.3&quot;, 24640, 24836],</span>
<a href="#l35.160"></a><span id="l35.160" class="difflineplus">+    [&quot;12$.3$.4$&quot;, 24848, 25872]]),</span>
<a href="#l35.161"></a><span id="l35.161" class="difflineplus">+  make_body_test(&quot;Torture pruneat&quot;, &quot;mime-torture&quot;, {&quot;pruneat&quot;: &quot;4&quot;},</span>
<a href="#l35.162"></a><span id="l35.162" class="difflineplus">+    [[&quot;4&quot;, 7747, 8213]]),</span>
<a href="#l35.163"></a><span id="l35.163"> ];</span>
<a href="#l35.164"></a><span id="l35.164"> </span>
<a href="#l35.165"></a><span id="l35.165"> function test_parser(message, opts, results) {</span>
<a href="#l35.166"></a><span id="l35.166">   var checkingHeaders = !(results instanceof Array);</span>
<a href="#l35.167"></a><span id="l35.167">   var calls = 0, dataCalls = 0;</span>
<a href="#l35.168"></a><span id="l35.168">   var fusingParts = extract_field(opts, &quot;_nofuseparts&quot;) === undefined;</span>
<a href="#l35.169"></a><span id="l35.169">   var emitter = {</span>
<a href="#l35.170"></a><span id="l35.170">     stack: [],</span>
<a href="#l35.171"></a><span id="l35.171">     startMessage: function emitter_startMsg() {</span>
<a href="#l35.172"></a><span id="l35.172">       Assert.equal(this.stack.length, 0);</span>
<a href="#l35.173"></a><span id="l35.173">       calls++;</span>
<a href="#l35.174"></a><span id="l35.174" class="difflineminus">-      this.partData = '';</span>
<a href="#l35.175"></a><span id="l35.175" class="difflineplus">+      this.partData = &quot;&quot;;</span>
<a href="#l35.176"></a><span id="l35.176">     },</span>
<a href="#l35.177"></a><span id="l35.177">     endMessage: function emitter_endMsg() {</span>
<a href="#l35.178"></a><span id="l35.178">       Assert.equal(this.stack.length, 0);</span>
<a href="#l35.179"></a><span id="l35.179">       calls++;</span>
<a href="#l35.180"></a><span id="l35.180">     },</span>
<a href="#l35.181"></a><span id="l35.181">     startPart: function emitter_startPart(partNum, headers) {</span>
<a href="#l35.182"></a><span id="l35.182">       this.stack.push(partNum);</span>
<a href="#l35.183"></a><span id="l35.183">       if (checkingHeaders) {</span>
<a href="#l35.184"></a><span id="l35.184">         Assert.ok(partNum in results);</span>
<a href="#l35.185"></a><span id="l35.185">         compare_objects(headers, results[partNum]);</span>
<a href="#l35.186"></a><span id="l35.186">         if (fusingParts)</span>
<a href="#l35.187"></a><span id="l35.187" class="difflineminus">-          Assert.equal(this.partData, '');</span>
<a href="#l35.188"></a><span id="l35.188" class="difflineplus">+          Assert.equal(this.partData, &quot;&quot;);</span>
<a href="#l35.189"></a><span id="l35.189">       }</span>
<a href="#l35.190"></a><span id="l35.190">     },</span>
<a href="#l35.191"></a><span id="l35.191">     deliverPartData: function emitter_partData(partNum, data) {</span>
<a href="#l35.192"></a><span id="l35.192">       Assert.equal(this.stack[this.stack.length - 1], partNum);</span>
<a href="#l35.193"></a><span id="l35.193">       try {</span>
<a href="#l35.194"></a><span id="l35.194">         if (!checkingHeaders) {</span>
<a href="#l35.195"></a><span id="l35.195" class="difflineminus">-          if (fusingParts)</span>
<a href="#l35.196"></a><span id="l35.196" class="difflineplus">+          if (fusingParts) {</span>
<a href="#l35.197"></a><span id="l35.197">             this.partData += data;</span>
<a href="#l35.198"></a><span id="l35.198" class="difflineminus">-          else {</span>
<a href="#l35.199"></a><span id="l35.199" class="difflineplus">+          } else {</span>
<a href="#l35.200"></a><span id="l35.200">             Assert.equal(partNum, results[dataCalls][0]);</span>
<a href="#l35.201"></a><span id="l35.201">             compare_objects(data, results[dataCalls][1]);</span>
<a href="#l35.202"></a><span id="l35.202">           }</span>
<a href="#l35.203"></a><span id="l35.203">         }</span>
<a href="#l35.204"></a><span id="l35.204">       } finally {</span>
<a href="#l35.205"></a><span id="l35.205">         if (!fusingParts)</span>
<a href="#l35.206"></a><span id="l35.206">           dataCalls++;</span>
<a href="#l35.207"></a><span id="l35.207">       }</span>
<a href="#l35.208"></a><span id="l35.208">     },</span>
<a href="#l35.209"></a><span id="l35.209">     endPart: function emitter_endPart(partNum) {</span>
<a href="#l35.210"></a><span id="l35.210" class="difflineminus">-      if (this.partData != '') {</span>
<a href="#l35.211"></a><span id="l35.211" class="difflineplus">+      if (this.partData != &quot;&quot;) {</span>
<a href="#l35.212"></a><span id="l35.212">         Assert.equal(partNum, results[dataCalls][0]);</span>
<a href="#l35.213"></a><span id="l35.213">         compare_objects(this.partData, results[dataCalls][1]);</span>
<a href="#l35.214"></a><span id="l35.214">         dataCalls++;</span>
<a href="#l35.215"></a><span id="l35.215" class="difflineminus">-        this.partData = '';</span>
<a href="#l35.216"></a><span id="l35.216" class="difflineplus">+        this.partData = &quot;&quot;;</span>
<a href="#l35.217"></a><span id="l35.217">       }</span>
<a href="#l35.218"></a><span id="l35.218">       Assert.equal(this.stack.pop(), partNum);</span>
<a href="#l35.219"></a><span id="l35.219" class="difflineminus">-    }</span>
<a href="#l35.220"></a><span id="l35.220" class="difflineplus">+    },</span>
<a href="#l35.221"></a><span id="l35.221">   };</span>
<a href="#l35.222"></a><span id="l35.222" class="difflineminus">-  opts.onerror = function (e) { throw e; };</span>
<a href="#l35.223"></a><span id="l35.223" class="difflineplus">+  opts.onerror = function(e) { throw e; };</span>
<a href="#l35.224"></a><span id="l35.224">   MimeParser.parseSync(message, emitter, opts);</span>
<a href="#l35.225"></a><span id="l35.225">   Assert.equal(calls, 2);</span>
<a href="#l35.226"></a><span id="l35.226">   if (!checkingHeaders)</span>
<a href="#l35.227"></a><span id="l35.227">     Assert.equal(dataCalls, results.length);</span>
<a href="#l35.228"></a><span id="l35.228"> }</span>
<a href="#l35.229"></a><span id="l35.229"> </span>
<a href="#l35.230"></a><span id="l35.230" class="difflineminus">-var ATTACH = MimeParser.HEADER_PARAMETER;</span>
<a href="#l35.231"></a><span id="l35.231"> // Format of tests:</span>
<a href="#l35.232"></a><span id="l35.232"> // entry[0] = header</span>
<a href="#l35.233"></a><span id="l35.233"> // entry[1] = flags</span>
<a href="#l35.234"></a><span id="l35.234"> // entry[2] = result to match</span>
<a href="#l35.235"></a><span id="l35.235"> var header_tests = [</span>
<a href="#l35.236"></a><span id="l35.236">   // Parameter passing</span>
<a href="#l35.237"></a><span id="l35.237">   [&quot;multipart/related&quot;, MimeParser.HEADER_PARAMETER, [&quot;multipart/related&quot;, {}]],</span>
<a href="#l35.238"></a><span id="l35.238">   [&quot;a ; b=v&quot;, MimeParser.HEADER_PARAMETER, [&quot;a&quot;, {&quot;b&quot;: &quot;v&quot;}]],</span>
<a href="#l35.239"></a><span id="l35.239">   [&quot;a ; b='v'&quot;, MimeParser.HEADER_PARAMETER, [&quot;a&quot;, {&quot;b&quot;: &quot;'v'&quot;}]],</span>
<a href="#l35.240"></a><span id="l35.240">   ['a; b = &quot;v&quot;', MimeParser.HEADER_PARAMETER, [&quot;a&quot;, {&quot;b&quot;: &quot;v&quot;}]],</span>
<a href="#l35.241"></a><span id="l35.241">   [&quot;a;b=1;b=2&quot;, MimeParser.HEADER_PARAMETER, [&quot;a&quot;, {&quot;b&quot;: &quot;1&quot;}]],</span>
<a href="#l35.242"></a><span id="l35.242">   [&quot;a;b=2;b=1&quot;, MimeParser.HEADER_PARAMETER, [&quot;a&quot;, {&quot;b&quot;: &quot;2&quot;}]],</span>
<a href="#l35.243"></a><span id="l35.243">   ['a;b=&quot;a;b&quot;', MimeParser.HEADER_PARAMETER, [&quot;a&quot;, {&quot;b&quot;: &quot;a;b&quot;}]],</span>
<a href="#l35.244"></a><span id="l35.244">   ['a;b=&quot;\\\\&quot;', MimeParser.HEADER_PARAMETER, [&quot;a&quot;, {&quot;b&quot;: &quot;\\&quot;}]],</span>
<a href="#l35.245"></a><span id="l35.245">   ['a;b=&quot;a\\b\\c&quot;', MimeParser.HEADER_PARAMETER, [&quot;a&quot;, {&quot;b&quot;: &quot;abc&quot;}]],</span>
<a href="#l35.246"></a><span id="l35.246" class="difflineminus">-  ['a;b=1;c=2', MimeParser.HEADER_PARAMETER, [&quot;a&quot;, {&quot;b&quot;: &quot;1&quot;, &quot;c&quot;: &quot;2&quot;}]],</span>
<a href="#l35.247"></a><span id="l35.247" class="difflineplus">+  [&quot;a;b=1;c=2&quot;, MimeParser.HEADER_PARAMETER, [&quot;a&quot;, {&quot;b&quot;: &quot;1&quot;, &quot;c&quot;: &quot;2&quot;}]],</span>
<a href="#l35.248"></a><span id="l35.248">   ['a;b=&quot;a\\', MimeParser.HEADER_PARAMETER, [&quot;a&quot;, {&quot;b&quot;: &quot;a&quot;}]],</span>
<a href="#l35.249"></a><span id="l35.249" class="difflineminus">-  ['a;b', MimeParser.HEADER_PARAMETER, [&quot;a&quot;, {}]],</span>
<a href="#l35.250"></a><span id="l35.250" class="difflineminus">-  ['a;b=&quot;;&quot;;c=d', MimeParser.HEADER_PARAMETER, [&quot;a&quot;, {&quot;b&quot;: ';', 'c': &quot;d&quot;}]],</span>
<a href="#l35.251"></a><span id="l35.251" class="difflineplus">+  [&quot;a;b&quot;, MimeParser.HEADER_PARAMETER, [&quot;a&quot;, {}]],</span>
<a href="#l35.252"></a><span id="l35.252" class="difflineplus">+  ['a;b=&quot;;&quot;;c=d', MimeParser.HEADER_PARAMETER, [&quot;a&quot;, {&quot;b&quot;: &quot;;&quot;, &quot;c&quot;: &quot;d&quot;}]],</span>
<a href="#l35.253"></a><span id="l35.253"> ];</span>
<a href="#l35.254"></a><span id="l35.254"> </span>
<a href="#l35.255"></a><span id="l35.255"> function test_header(headerValue, flags, expected) {</span>
<a href="#l35.256"></a><span id="l35.256">   let result = MimeParser.parseHeaderField(headerValue, flags);</span>
<a href="#l35.257"></a><span id="l35.257">   Assert.equal(result.preSemi, expected[0]);</span>
<a href="#l35.258"></a><span id="l35.258">   compare_objects(result, expected[1]);</span>
<a href="#l35.259"></a><span id="l35.259"> }</span>
<a href="#l35.260"></a><span id="l35.260"> </span>
<a href="#l35.261"></a><span id="l35.261"> function run_test() {</span>
<a href="#l35.262"></a><span id="l35.262">   for (let test of parser_tests) {</span>
<a href="#l35.263"></a><span id="l35.263">     dump(&quot;Testing message &quot; + test[0]);</span>
<a href="#l35.264"></a><span id="l35.264">     if (test[1] instanceof Array)</span>
<a href="#l35.265"></a><span id="l35.265">       dump(&quot; using &quot; + test[1].length + &quot; packets&quot;);</span>
<a href="#l35.266"></a><span id="l35.266" class="difflineminus">-    dump('\n');</span>
<a href="#l35.267"></a><span id="l35.267" class="difflineplus">+    dump(&quot;\n&quot;);</span>
<a href="#l35.268"></a><span id="l35.268">     test_parser(test[1], test[2], test[3]);</span>
<a href="#l35.269"></a><span id="l35.269">   }</span>
<a href="#l35.270"></a><span id="l35.270">   for (let test of header_tests) {</span>
<a href="#l35.271"></a><span id="l35.271">     dump(&quot;Testing value -&gt;&quot; + test[0] + &quot;&lt;- with flags &quot; + test[1] + &quot;\n&quot;);</span>
<a href="#l35.272"></a><span id="l35.272">     test_header(test[0], test[1], test[2]);</span>
<a href="#l35.273"></a><span id="l35.273">   }</span>
<a href="#l35.274"></a><span id="l35.274"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mailnews/mime/test/unit/test_rfc822_body.js</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mailnews/mime/test/unit/test_rfc822_body.js</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -1,88 +1,95 @@</span>
<a href="#l36.4"></a><span id="l36.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l36.5"></a><span id="l36.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l36.6"></a><span id="l36.6">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l36.7"></a><span id="l36.7"> </span>
<a href="#l36.8"></a><span id="l36.8"> /**</span>
<a href="#l36.9"></a><span id="l36.9">  * This test verifies that we emit a message/rfc822 body part as an attachment</span>
<a href="#l36.10"></a><span id="l36.10">  * whether or not mail.inline_attachments is true.</span>
<a href="#l36.11"></a><span id="l36.11">  */</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l36.14"></a><span id="l36.14" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l36.15"></a><span id="l36.15" class="difflineplus">+/* import-globals-from ../../../test/resources/messageModifier.js */</span>
<a href="#l36.16"></a><span id="l36.16" class="difflineplus">+/* import-globals-from ../../../test/resources/messageInjection.js */</span>
<a href="#l36.17"></a><span id="l36.17"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l36.18"></a><span id="l36.18"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l36.19"></a><span id="l36.19"> </span>
<a href="#l36.20"></a><span id="l36.20"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l36.21"></a><span id="l36.21"> load(&quot;../../../resources/messageModifier.js&quot;);</span>
<a href="#l36.22"></a><span id="l36.22"> load(&quot;../../../resources/messageInjection.js&quot;);</span>
<a href="#l36.23"></a><span id="l36.23"> </span>
<a href="#l36.24"></a><span id="l36.24"> var gMessenger = Cc[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l36.25"></a><span id="l36.25">                    .createInstance(Ci.nsIMessenger);</span>
<a href="#l36.26"></a><span id="l36.26"> </span>
<a href="#l36.27"></a><span id="l36.27"> // Create a message generator</span>
<a href="#l36.28"></a><span id="l36.28"> var msgGen = gMessageGenerator = new MessageGenerator();</span>
<a href="#l36.29"></a><span id="l36.29"> </span>
<a href="#l36.30"></a><span id="l36.30"> var messages = [</span>
<a href="#l36.31"></a><span id="l36.31" class="difflineminus">-  // a message whose body is itself a message</span>
<a href="#l36.32"></a><span id="l36.32" class="difflineminus">-  { bodyPart: msgGen.makeMessage(),</span>
<a href="#l36.33"></a><span id="l36.33" class="difflineplus">+  {</span>
<a href="#l36.34"></a><span id="l36.34" class="difflineplus">+    // a message whose body is itself a message</span>
<a href="#l36.35"></a><span id="l36.35" class="difflineplus">+    bodyPart: msgGen.makeMessage(),</span>
<a href="#l36.36"></a><span id="l36.36">     attachmentCount: inline =&gt; 1,</span>
<a href="#l36.37"></a><span id="l36.37" class="difflineminus">-  },</span>
<a href="#l36.38"></a><span id="l36.38" class="difflineminus">-  // a message whose body is itself a message, and which has an attachment</span>
<a href="#l36.39"></a><span id="l36.39" class="difflineminus">-  { bodyPart: msgGen.makeMessage({</span>
<a href="#l36.40"></a><span id="l36.40" class="difflineminus">-      attachments: [{ body: &quot;I'm an attachment!&quot;,</span>
<a href="#l36.41"></a><span id="l36.41" class="difflineminus">-                      filename: &quot;attachment.txt&quot;,</span>
<a href="#l36.42"></a><span id="l36.42" class="difflineminus">-                      format: &quot;&quot; }]</span>
<a href="#l36.43"></a><span id="l36.43" class="difflineplus">+  }, {</span>
<a href="#l36.44"></a><span id="l36.44" class="difflineplus">+    // a message whose body is itself a message, and which has an attachment</span>
<a href="#l36.45"></a><span id="l36.45" class="difflineplus">+    bodyPart: msgGen.makeMessage({</span>
<a href="#l36.46"></a><span id="l36.46" class="difflineplus">+      attachments: [{</span>
<a href="#l36.47"></a><span id="l36.47" class="difflineplus">+        body: &quot;I'm an attachment!&quot;,</span>
<a href="#l36.48"></a><span id="l36.48" class="difflineplus">+        filename: &quot;attachment.txt&quot;,</span>
<a href="#l36.49"></a><span id="l36.49" class="difflineplus">+        format: &quot;&quot;,</span>
<a href="#l36.50"></a><span id="l36.50" class="difflineplus">+      }],</span>
<a href="#l36.51"></a><span id="l36.51">     }),</span>
<a href="#l36.52"></a><span id="l36.52">     attachmentCount: inline =&gt; inline ? 2 : 1,</span>
<a href="#l36.53"></a><span id="l36.53">   },</span>
<a href="#l36.54"></a><span id="l36.54"> ];</span>
<a href="#l36.55"></a><span id="l36.55"> </span>
<a href="#l36.56"></a><span id="l36.56"> var gStreamListener = {</span>
<a href="#l36.57"></a><span id="l36.57">   stream: null,</span>
<a href="#l36.58"></a><span id="l36.58">   QueryInterface: ChromeUtils.generateQI([Ci.nsIStreamListener]),</span>
<a href="#l36.59"></a><span id="l36.59"> </span>
<a href="#l36.60"></a><span id="l36.60">   // nsIRequestObserver part</span>
<a href="#l36.61"></a><span id="l36.61" class="difflineminus">-  onStartRequest: function (aRequest) {</span>
<a href="#l36.62"></a><span id="l36.62" class="difflineplus">+  onStartRequest(aRequest) {</span>
<a href="#l36.63"></a><span id="l36.63">   },</span>
<a href="#l36.64"></a><span id="l36.64" class="difflineminus">-  onStopRequest: function (aRequest, aStatusCode) {</span>
<a href="#l36.65"></a><span id="l36.65" class="difflineplus">+  onStopRequest(aRequest, aStatusCode) {</span>
<a href="#l36.66"></a><span id="l36.66">     Assert.equal(gMessageHeaderSink.attachmentCount,</span>
<a href="#l36.67"></a><span id="l36.67">                  this.expectedAttachmentCount);</span>
<a href="#l36.68"></a><span id="l36.68">     async_driver();</span>
<a href="#l36.69"></a><span id="l36.69">   },</span>
<a href="#l36.70"></a><span id="l36.70"> </span>
<a href="#l36.71"></a><span id="l36.71">   // nsIStreamListener part</span>
<a href="#l36.72"></a><span id="l36.72" class="difflineminus">-  onDataAvailable: function (aRequest, aInputStream, aOffset, aCount) {</span>
<a href="#l36.73"></a><span id="l36.73" class="difflineplus">+  onDataAvailable(aRequest, aInputStream, aOffset, aCount) {</span>
<a href="#l36.74"></a><span id="l36.74">     if (this.stream === null) {</span>
<a href="#l36.75"></a><span id="l36.75">       this.stream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;].</span>
<a href="#l36.76"></a><span id="l36.76">                     createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l36.77"></a><span id="l36.77">       this.stream.init(aInputStream);</span>
<a href="#l36.78"></a><span id="l36.78">     }</span>
<a href="#l36.79"></a><span id="l36.79" class="difflineminus">-  }</span>
<a href="#l36.80"></a><span id="l36.80" class="difflineplus">+  },</span>
<a href="#l36.81"></a><span id="l36.81"> };</span>
<a href="#l36.82"></a><span id="l36.82"> </span>
<a href="#l36.83"></a><span id="l36.83"> var gMessageHeaderSink = {</span>
<a href="#l36.84"></a><span id="l36.84">   attachmentCount: 0,</span>
<a href="#l36.85"></a><span id="l36.85"> </span>
<a href="#l36.86"></a><span id="l36.86" class="difflineminus">-  handleAttachment: function(aContentType, aUrl, aDisplayName, aUri,</span>
<a href="#l36.87"></a><span id="l36.87" class="difflineminus">-                             aIsExternalAttachment) {</span>
<a href="#l36.88"></a><span id="l36.88" class="difflineplus">+  handleAttachment(aContentType, aUrl, aDisplayName, aUri, aIsExternalAttachment) {</span>
<a href="#l36.89"></a><span id="l36.89">     this.attachmentCount++;</span>
<a href="#l36.90"></a><span id="l36.90">   },</span>
<a href="#l36.91"></a><span id="l36.91"> </span>
<a href="#l36.92"></a><span id="l36.92">   // stub functions from nsIMsgHeaderSink</span>
<a href="#l36.93"></a><span id="l36.93" class="difflineminus">-  addAttachmentField: function(aName, aValue) {},</span>
<a href="#l36.94"></a><span id="l36.94" class="difflineminus">-  onStartHeaders: function() {},</span>
<a href="#l36.95"></a><span id="l36.95" class="difflineminus">-  onEndHeaders: function() {},</span>
<a href="#l36.96"></a><span id="l36.96" class="difflineminus">-  processHeaders: function(aHeaderNames, aHeaderValues, dontCollectAddrs) {},</span>
<a href="#l36.97"></a><span id="l36.97" class="difflineminus">-  onEndAllAttachments: function() {},</span>
<a href="#l36.98"></a><span id="l36.98" class="difflineminus">-  onEndMsgDownload: function() {},</span>
<a href="#l36.99"></a><span id="l36.99" class="difflineminus">-  onEndMsgHeaders: function(aUrl) {},</span>
<a href="#l36.100"></a><span id="l36.100" class="difflineminus">-  onMsgHasRemoteContent: function(aMsgHdr, aContentURI) {},</span>
<a href="#l36.101"></a><span id="l36.101" class="difflineplus">+  addAttachmentField(aName, aValue) {},</span>
<a href="#l36.102"></a><span id="l36.102" class="difflineplus">+  onStartHeaders() {},</span>
<a href="#l36.103"></a><span id="l36.103" class="difflineplus">+  onEndHeaders() {},</span>
<a href="#l36.104"></a><span id="l36.104" class="difflineplus">+  processHeaders(aHeaderNames, aHeaderValues, dontCollectAddrs) {},</span>
<a href="#l36.105"></a><span id="l36.105" class="difflineplus">+  onEndAllAttachments() {},</span>
<a href="#l36.106"></a><span id="l36.106" class="difflineplus">+  onEndMsgDownload() {},</span>
<a href="#l36.107"></a><span id="l36.107" class="difflineplus">+  onEndMsgHeaders(aUrl) {},</span>
<a href="#l36.108"></a><span id="l36.108" class="difflineplus">+  onMsgHasRemoteContent(aMsgHdr, aContentURI) {},</span>
<a href="#l36.109"></a><span id="l36.109">   securityInfo: null,</span>
<a href="#l36.110"></a><span id="l36.110">   mDummyMsgHeader: null,</span>
<a href="#l36.111"></a><span id="l36.111">   properties: null,</span>
<a href="#l36.112"></a><span id="l36.112" class="difflineminus">-  resetProperties: function () {</span>
<a href="#l36.113"></a><span id="l36.113" class="difflineplus">+  resetProperties() {</span>
<a href="#l36.114"></a><span id="l36.114">     this.attachmentCount = 0;</span>
<a href="#l36.115"></a><span id="l36.115">   },</span>
<a href="#l36.116"></a><span id="l36.116"> };</span>
<a href="#l36.117"></a><span id="l36.117"> </span>
<a href="#l36.118"></a><span id="l36.118"> var msgWindow = Cc[&quot;@mozilla.org/messenger/msgwindow;1&quot;]</span>
<a href="#l36.119"></a><span id="l36.119">                   .createInstance(Ci.nsIMsgWindow);</span>
<a href="#l36.120"></a><span id="l36.120"> msgWindow.msgHeaderSink = gMessageHeaderSink;</span>
<a href="#l36.121"></a><span id="l36.121"> </span>
<a href="#l36.122"></a><span id="l36.122" class="difflineat">@@ -91,17 +98,17 @@ function* help_test_rfc822_body(info, in</span>
<a href="#l36.123"></a><span id="l36.123">   let synMsg = gMessageGenerator.makeMessage(info);</span>
<a href="#l36.124"></a><span id="l36.124">   let synSet = new SyntheticMessageSet([synMsg]);</span>
<a href="#l36.125"></a><span id="l36.125">   yield add_sets_to_folder(gInbox, [synSet]);</span>
<a href="#l36.126"></a><span id="l36.126"> </span>
<a href="#l36.127"></a><span id="l36.127">   let msgURI = synSet.getMsgURI(0);</span>
<a href="#l36.128"></a><span id="l36.128">   let msgService = gMessenger.messageServiceFromURI(msgURI);</span>
<a href="#l36.129"></a><span id="l36.129"> </span>
<a href="#l36.130"></a><span id="l36.130">   gStreamListener.expectedAttachmentCount = info.attachmentCount(inline);</span>
<a href="#l36.131"></a><span id="l36.131" class="difflineminus">-  let streamURI = msgService.streamMessage(</span>
<a href="#l36.132"></a><span id="l36.132" class="difflineplus">+  msgService.streamMessage(</span>
<a href="#l36.133"></a><span id="l36.133">     msgURI,</span>
<a href="#l36.134"></a><span id="l36.134">     gStreamListener,</span>
<a href="#l36.135"></a><span id="l36.135">     msgWindow,</span>
<a href="#l36.136"></a><span id="l36.136">     null,</span>
<a href="#l36.137"></a><span id="l36.137">     true, // have them create the converter</span>
<a href="#l36.138"></a><span id="l36.138">     // additional uri payload, note that &quot;header=&quot; is prepended automatically</span>
<a href="#l36.139"></a><span id="l36.139">     &quot;filter&quot;,</span>
<a href="#l36.140"></a><span id="l36.140">     false);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mailnews/mime/test/unit/test_smime_decrypt.js</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mailnews/mime/test/unit/test_smime_decrypt.js</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -5,23 +5,26 @@</span>
<a href="#l37.4"></a><span id="l37.4"> /**</span>
<a href="#l37.5"></a><span id="l37.5">  * Tests to ensure signed and/or encrypted S/MIME messages are</span>
<a href="#l37.6"></a><span id="l37.6">  * processed correctly, and the signature status is treated as good</span>
<a href="#l37.7"></a><span id="l37.7">  * or bad as expected.</span>
<a href="#l37.8"></a><span id="l37.8">  */</span>
<a href="#l37.9"></a><span id="l37.9"> </span>
<a href="#l37.10"></a><span id="l37.10"> var {PromiseTestUtils} = ChromeUtils.import(&quot;resource://testing-common/mailnews/PromiseTestUtils.jsm&quot;);</span>
<a href="#l37.11"></a><span id="l37.11"> var {PromiseUtils } = ChromeUtils.import(&quot;resource://gre/modules/PromiseUtils.jsm&quot;);</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-var {localAccountUtils} = ChromeUtils.import(&quot;resource://testing-common/mailnews/localAccountUtils.js&quot;);</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineminus">-var {IOUtils} = ChromeUtils.import(&quot;resource:///modules/IOUtils.js&quot;);</span>
<a href="#l37.14"></a><span id="l37.14"> var {SmimeUtils} = ChromeUtils.import(&quot;resource://testing-common/mailnews/smimeUtils.jsm&quot;);</span>
<a href="#l37.15"></a><span id="l37.15"> </span>
<a href="#l37.16"></a><span id="l37.16" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l37.17"></a><span id="l37.17" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l37.18"></a><span id="l37.18"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l37.19"></a><span id="l37.19"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l37.20"></a><span id="l37.20"> </span>
<a href="#l37.21"></a><span id="l37.21" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l37.22"></a><span id="l37.22" class="difflineplus">+/* import-globals-from ../../../test/resources/messageModifier.js */</span>
<a href="#l37.23"></a><span id="l37.23" class="difflineplus">+/* import-globals-from ../../../test/resources/messageInjection.js */</span>
<a href="#l37.24"></a><span id="l37.24"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l37.25"></a><span id="l37.25"> load(&quot;../../../resources/messageModifier.js&quot;);</span>
<a href="#l37.26"></a><span id="l37.26"> load(&quot;../../../resources/messageInjection.js&quot;);</span>
<a href="#l37.27"></a><span id="l37.27"> </span>
<a href="#l37.28"></a><span id="l37.28"> let gCertValidityResult = 0;</span>
<a href="#l37.29"></a><span id="l37.29"> </span>
<a href="#l37.30"></a><span id="l37.30"> /**</span>
<a href="#l37.31"></a><span id="l37.31">  * @implements nsICertVerificationCallback</span>
<a href="#l37.32"></a><span id="l37.32" class="difflineat">@@ -60,17 +63,17 @@ add_task(async function verifyTestCertsS</span>
<a href="#l37.33"></a><span id="l37.33">   let prom = testCertValidity(cert, now);</span>
<a href="#l37.34"></a><span id="l37.34">   await prom;</span>
<a href="#l37.35"></a><span id="l37.35"> </span>
<a href="#l37.36"></a><span id="l37.36">   if (gCertValidityResult != 0) {</span>
<a href="#l37.37"></a><span id="l37.37">     // Either certs have expired, or something else is going wrong.</span>
<a href="#l37.38"></a><span id="l37.38">     // Let's test if they were valid a week ago, for a better guess.</span>
<a href="#l37.39"></a><span id="l37.39"> </span>
<a href="#l37.40"></a><span id="l37.40">     let oneWeekAgo = now - (7 * 24 * 60 * 60);</span>
<a href="#l37.41"></a><span id="l37.41" class="difflineminus">-    let prom = testCertValidity(cert, oneWeekAgo);</span>
<a href="#l37.42"></a><span id="l37.42" class="difflineplus">+    prom = testCertValidity(cert, oneWeekAgo);</span>
<a href="#l37.43"></a><span id="l37.43">     await prom;</span>
<a href="#l37.44"></a><span id="l37.44"> </span>
<a href="#l37.45"></a><span id="l37.45">     if (gCertValidityResult == 0) {</span>
<a href="#l37.46"></a><span id="l37.46">       Assert.ok(false,</span>
<a href="#l37.47"></a><span id="l37.47">        &quot;The S/MIME test certificates are invalid today, but were valid one week ago. &quot; +</span>
<a href="#l37.48"></a><span id="l37.48">        &quot;Most likely they have expired and new certificates need to be generated and committed. &quot; +</span>
<a href="#l37.49"></a><span id="l37.49">        &quot;Follow the instructions in comm/mailnews/test/data/smime/README.md&quot;);</span>
<a href="#l37.50"></a><span id="l37.50">     } else {</span>
<a href="#l37.51"></a><span id="l37.51" class="difflineat">@@ -85,46 +88,46 @@ add_task(async function verifyTestCertsS</span>
<a href="#l37.52"></a><span id="l37.52"> });</span>
<a href="#l37.53"></a><span id="l37.53"> </span>
<a href="#l37.54"></a><span id="l37.54"> var gInbox;</span>
<a href="#l37.55"></a><span id="l37.55"> </span>
<a href="#l37.56"></a><span id="l37.56"> var smimeDataDirectory = &quot;../../../data/smime/&quot;;</span>
<a href="#l37.57"></a><span id="l37.57"> </span>
<a href="#l37.58"></a><span id="l37.58"> let smimeHeaderSink = {</span>
<a href="#l37.59"></a><span id="l37.59">   expectResults(maxLen) {</span>
<a href="#l37.60"></a><span id="l37.60" class="difflineminus">-    //dump(&quot;Restarting for next test\n&quot;);</span>
<a href="#l37.61"></a><span id="l37.61" class="difflineplus">+    // dump(&quot;Restarting for next test\n&quot;);</span>
<a href="#l37.62"></a><span id="l37.62">     this._deferred = PromiseUtils.defer();</span>
<a href="#l37.63"></a><span id="l37.63">     this._expectedLen = maxLen;</span>
<a href="#l37.64"></a><span id="l37.64">     this._results = [];</span>
<a href="#l37.65"></a><span id="l37.65">     return this._deferred.promise;</span>
<a href="#l37.66"></a><span id="l37.66">   },</span>
<a href="#l37.67"></a><span id="l37.67">   maxWantedNesting() { return 2; },</span>
<a href="#l37.68"></a><span id="l37.68">   signedStatus(aNestingLevel, aSignedStatus, aSignerCert) {</span>
<a href="#l37.69"></a><span id="l37.69" class="difflineminus">-    //dump(&quot;Signed message\n&quot;);</span>
<a href="#l37.70"></a><span id="l37.70" class="difflineplus">+    // dump(&quot;Signed message\n&quot;);</span>
<a href="#l37.71"></a><span id="l37.71">     Assert.equal(aNestingLevel, 1);</span>
<a href="#l37.72"></a><span id="l37.72">     this._results.push({</span>
<a href="#l37.73"></a><span id="l37.73">       type: &quot;signed&quot;,</span>
<a href="#l37.74"></a><span id="l37.74">       status: aSignedStatus,</span>
<a href="#l37.75"></a><span id="l37.75" class="difflineminus">-      certificate: aSignerCert</span>
<a href="#l37.76"></a><span id="l37.76" class="difflineplus">+      certificate: aSignerCert,</span>
<a href="#l37.77"></a><span id="l37.77">     });</span>
<a href="#l37.78"></a><span id="l37.78">     if (this._results.length == this._expectedLen)</span>
<a href="#l37.79"></a><span id="l37.79">       this._deferred.resolve(this._results);</span>
<a href="#l37.80"></a><span id="l37.80">   },</span>
<a href="#l37.81"></a><span id="l37.81">   encryptionStatus(aNestingLevel, aEncryptedStatus, aRecipientCert) {</span>
<a href="#l37.82"></a><span id="l37.82" class="difflineminus">-    //dump(&quot;Encrypted message\n&quot;);</span>
<a href="#l37.83"></a><span id="l37.83" class="difflineplus">+    // dump(&quot;Encrypted message\n&quot;);</span>
<a href="#l37.84"></a><span id="l37.84">     Assert.equal(aNestingLevel, 1);</span>
<a href="#l37.85"></a><span id="l37.85">     this._results.push({</span>
<a href="#l37.86"></a><span id="l37.86">       type: &quot;encrypted&quot;,</span>
<a href="#l37.87"></a><span id="l37.87">       status: aEncryptedStatus,</span>
<a href="#l37.88"></a><span id="l37.88" class="difflineminus">-      certificate: aRecipientCert</span>
<a href="#l37.89"></a><span id="l37.89" class="difflineplus">+      certificate: aRecipientCert,</span>
<a href="#l37.90"></a><span id="l37.90">     });</span>
<a href="#l37.91"></a><span id="l37.91">     if (this._results.length == this._expectedLen)</span>
<a href="#l37.92"></a><span id="l37.92">       this._deferred.resolve(this._results);</span>
<a href="#l37.93"></a><span id="l37.93">   },</span>
<a href="#l37.94"></a><span id="l37.94" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([Ci.nsIMsgSMIMEHeaderSink])</span>
<a href="#l37.95"></a><span id="l37.95" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([Ci.nsIMsgSMIMEHeaderSink]),</span>
<a href="#l37.96"></a><span id="l37.96"> };</span>
<a href="#l37.97"></a><span id="l37.97"> </span>
<a href="#l37.98"></a><span id="l37.98"> /**</span>
<a href="#l37.99"></a><span id="l37.99">  * Note on filenames taken from the NSS test suite:</span>
<a href="#l37.100"></a><span id="l37.100">  * - env: CMS enveloped (encrypted)</span>
<a href="#l37.101"></a><span id="l37.101">  * - dsig: CMS detached signature (with multipart MIME)</span>
<a href="#l37.102"></a><span id="l37.102">  * - sig: CMS opaque signature (content embedded inside signature)</span>
<a href="#l37.103"></a><span id="l37.103">  * - bad: message text does not match signature</span>
<a href="#l37.104"></a><span id="l37.104" class="difflineat">@@ -204,28 +207,28 @@ add_task(async function copy_messages() </span>
<a href="#l37.105"></a><span id="l37.105"> add_task(async function check_smime_message() {</span>
<a href="#l37.106"></a><span id="l37.106">   await gCopyWaiter.promise;</span>
<a href="#l37.107"></a><span id="l37.107"> </span>
<a href="#l37.108"></a><span id="l37.108">   let hdrIndex = 0;</span>
<a href="#l37.109"></a><span id="l37.109"> </span>
<a href="#l37.110"></a><span id="l37.110">   for (let msg of gMessages) {</span>
<a href="#l37.111"></a><span id="l37.111">     let numExpected = 1;</span>
<a href="#l37.112"></a><span id="l37.112">     if (msg.enc &amp;&amp; msg.sig) {</span>
<a href="#l37.113"></a><span id="l37.113" class="difflineminus">-      numExpected++</span>
<a href="#l37.114"></a><span id="l37.114" class="difflineplus">+      numExpected++;</span>
<a href="#l37.115"></a><span id="l37.115">     }</span>
<a href="#l37.116"></a><span id="l37.116"> </span>
<a href="#l37.117"></a><span id="l37.117">     let hdr = mailTestUtils.getMsgHdrN(gInbox, hdrIndex);</span>
<a href="#l37.118"></a><span id="l37.118">     let uri = hdr.folder.getUriForMsg(hdr);</span>
<a href="#l37.119"></a><span id="l37.119">     let sinkPromise = smimeHeaderSink.expectResults(numExpected);</span>
<a href="#l37.120"></a><span id="l37.120"> </span>
<a href="#l37.121"></a><span id="l37.121">     let conversion = apply_mime_conversion(uri, {securityInfo: smimeHeaderSink});</span>
<a href="#l37.122"></a><span id="l37.122">     await conversion.promise;</span>
<a href="#l37.123"></a><span id="l37.123"> </span>
<a href="#l37.124"></a><span id="l37.124">     let contents = conversion._data;</span>
<a href="#l37.125"></a><span id="l37.125" class="difflineminus">-    //dump(&quot;contents: &quot; + contents + &quot;\n&quot;);</span>
<a href="#l37.126"></a><span id="l37.126" class="difflineplus">+    // dump(&quot;contents: &quot; + contents + &quot;\n&quot;);</span>
<a href="#l37.127"></a><span id="l37.127"> </span>
<a href="#l37.128"></a><span id="l37.128">     if (!msg.sig || msg.sig_good) {</span>
<a href="#l37.129"></a><span id="l37.129">       // Check that the plaintext body is in there.</span>
<a href="#l37.130"></a><span id="l37.130">       Assert.ok(contents.includes(&quot;This is a test message from Alice to Bob.&quot;));</span>
<a href="#l37.131"></a><span id="l37.131">     }</span>
<a href="#l37.132"></a><span id="l37.132">     // Check that we're also using the display output.</span>
<a href="#l37.133"></a><span id="l37.133">     Assert.ok(contents.includes(&quot;&lt;html&gt;&quot;));</span>
<a href="#l37.134"></a><span id="l37.134"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/mailnews/mime/test/unit/test_structured_headers.js</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/mailnews/mime/test/unit/test_structured_headers.js</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -2,17 +2,17 @@</span>
<a href="#l38.4"></a><span id="l38.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l38.5"></a><span id="l38.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l38.6"></a><span id="l38.6"> </span>
<a href="#l38.7"></a><span id="l38.7"> // This tests the msgIStructuredHeaders and msgIWritableStructuredHeaders</span>
<a href="#l38.8"></a><span id="l38.8"> // interfaces.</span>
<a href="#l38.9"></a><span id="l38.9"> </span>
<a href="#l38.10"></a><span id="l38.10"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l38.11"></a><span id="l38.11"> </span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-/// Verify that a specific XPCOM error code is thrown.</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineplus">+// Verify that a specific XPCOM error code is thrown.</span>
<a href="#l38.14"></a><span id="l38.14"> function verifyError(block, errorCode) {</span>
<a href="#l38.15"></a><span id="l38.15">   let caught = undefined;</span>
<a href="#l38.16"></a><span id="l38.16">   try {</span>
<a href="#l38.17"></a><span id="l38.17">     block();</span>
<a href="#l38.18"></a><span id="l38.18">   } catch (actual) {</span>
<a href="#l38.19"></a><span id="l38.19">     caught = actual.result;</span>
<a href="#l38.20"></a><span id="l38.20">   }</span>
<a href="#l38.21"></a><span id="l38.21">   Assert.equal(caught, errorCode);</span>
<a href="#l38.22"></a><span id="l38.22" class="difflineat">@@ -127,17 +127,17 @@ add_task(async function check_raw() {</span>
<a href="#l38.23"></a><span id="l38.23">   // Check that copying works</span>
<a href="#l38.24"></a><span id="l38.24">   let moreHeaders = new StructuredHeaders();</span>
<a href="#l38.25"></a><span id="l38.25">   moreHeaders.addAllHeaders(headers);</span>
<a href="#l38.26"></a><span id="l38.26">   for (let value of headers.headerNames) {</span>
<a href="#l38.27"></a><span id="l38.27">     Assert.equal(moreHeaders.getHeader(value), headers.getHeader(value));</span>
<a href="#l38.28"></a><span id="l38.28">   }</span>
<a href="#l38.29"></a><span id="l38.29">   headers.deleteHeader(&quot;Date&quot;);</span>
<a href="#l38.30"></a><span id="l38.30">   Assert.ok(moreHeaders.hasHeader(&quot;Date&quot;));</span>
<a href="#l38.31"></a><span id="l38.31" class="difflineminus">-})</span>
<a href="#l38.32"></a><span id="l38.32" class="difflineplus">+});</span>
<a href="#l38.33"></a><span id="l38.33"> </span>
<a href="#l38.34"></a><span id="l38.34"> add_task(async function check_nsIMimeHeaders() {</span>
<a href="#l38.35"></a><span id="l38.35">   let headers = Cc[&quot;@mozilla.org/messenger/mimeheaders;1&quot;]</span>
<a href="#l38.36"></a><span id="l38.36">                   .createInstance(Ci.nsIMimeHeaders);</span>
<a href="#l38.37"></a><span id="l38.37">   Assert.ok(headers instanceof Ci.msgIStructuredHeaders);</span>
<a href="#l38.38"></a><span id="l38.38">   Assert.equal(false, headers instanceof Ci.msgIWritableStructuredHeaders);</span>
<a href="#l38.39"></a><span id="l38.39">   headers.initialize(mailTestUtils.loadFileToString(</span>
<a href="#l38.40"></a><span id="l38.40">     do_get_file(&quot;../../../data/draft1&quot;)));</span>
<a href="#l38.41"></a><span id="l38.41" class="difflineat">@@ -176,12 +176,8 @@ add_task(async function checkBuildMimeTe</span>
<a href="#l38.42"></a><span id="l38.42">   let utf8Text = mimeText.replace(&quot;☃&quot;, &quot;\xe2\x98\x83&quot;);</span>
<a href="#l38.43"></a><span id="l38.43">   let mimeHeaders = Cc[&quot;@mozilla.org/messenger/mimeheaders;1&quot;]</span>
<a href="#l38.44"></a><span id="l38.44">                       .createInstance(Ci.nsIMimeHeaders);</span>
<a href="#l38.45"></a><span id="l38.45">   mimeHeaders.initialize(utf8Text);</span>
<a href="#l38.46"></a><span id="l38.46">   Assert.equal(mimeHeaders.getHeader(&quot;To&quot;)[0].email, &quot;user@☃.invalid&quot;);</span>
<a href="#l38.47"></a><span id="l38.47">   Assert.equal(mimeHeaders.buildMimeText(), mimeText);</span>
<a href="#l38.48"></a><span id="l38.48">   Assert.equal(mimeHeaders.allHeaders, utf8Text);</span>
<a href="#l38.49"></a><span id="l38.49"> });</span>
<a href="#l38.50"></a><span id="l38.50" class="difflineminus">-</span>
<a href="#l38.51"></a><span id="l38.51" class="difflineminus">-function run_test() {</span>
<a href="#l38.52"></a><span id="l38.52" class="difflineminus">-  run_next_test();</span>
<a href="#l38.53"></a><span id="l38.53" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/mailnews/mime/test/unit/test_text_attachment.js</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/mailnews/mime/test/unit/test_text_attachment.js</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -1,63 +1,71 @@</span>
<a href="#l39.4"></a><span id="l39.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l39.5"></a><span id="l39.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l39.6"></a><span id="l39.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l39.7"></a><span id="l39.7"> </span>
<a href="#l39.8"></a><span id="l39.8"> /**</span>
<a href="#l39.9"></a><span id="l39.9">  * This test verifies that we don't display text attachments inline</span>
<a href="#l39.10"></a><span id="l39.10">  * when mail.inline_attachments is false.</span>
<a href="#l39.11"></a><span id="l39.11">  */</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l39.14"></a><span id="l39.14" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l39.15"></a><span id="l39.15" class="difflineplus">+/* import-globals-from ../../../test/resources/messageModifier.js */</span>
<a href="#l39.16"></a><span id="l39.16" class="difflineplus">+/* import-globals-from ../../../test/resources/messageInjection.js */</span>
<a href="#l39.17"></a><span id="l39.17"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l39.18"></a><span id="l39.18"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l39.19"></a><span id="l39.19"> </span>
<a href="#l39.20"></a><span id="l39.20"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l39.21"></a><span id="l39.21"> load(&quot;../../../resources/messageModifier.js&quot;);</span>
<a href="#l39.22"></a><span id="l39.22"> load(&quot;../../../resources/messageInjection.js&quot;);</span>
<a href="#l39.23"></a><span id="l39.23"> </span>
<a href="#l39.24"></a><span id="l39.24"> var gMessenger = Cc[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l39.25"></a><span id="l39.25">                    .createInstance(Ci.nsIMessenger);</span>
<a href="#l39.26"></a><span id="l39.26"> </span>
<a href="#l39.27"></a><span id="l39.27"> // Create a message generator</span>
<a href="#l39.28"></a><span id="l39.28" class="difflineminus">-var msgGen = gMessageGenerator = new MessageGenerator();</span>
<a href="#l39.29"></a><span id="l39.29" class="difflineplus">+var gMessageGenerator = new MessageGenerator();</span>
<a href="#l39.30"></a><span id="l39.30"> </span>
<a href="#l39.31"></a><span id="l39.31"> var textAttachment =</span>
<a href="#l39.32"></a><span id="l39.32">   &quot;inline text attachment&quot;;</span>
<a href="#l39.33"></a><span id="l39.33"> </span>
<a href="#l39.34"></a><span id="l39.34"> // create a message with a text attachment</span>
<a href="#l39.35"></a><span id="l39.35"> var messages = [</span>
<a href="#l39.36"></a><span id="l39.36" class="difflineminus">-  // text attachment</span>
<a href="#l39.37"></a><span id="l39.37" class="difflineminus">-  { attachments: [{ body: textAttachment,</span>
<a href="#l39.38"></a><span id="l39.38" class="difflineminus">-                    filename: 'test.txt',</span>
<a href="#l39.39"></a><span id="l39.39" class="difflineminus">-                    format: '' }]},</span>
<a href="#l39.40"></a><span id="l39.40" class="difflineminus">-  ];</span>
<a href="#l39.41"></a><span id="l39.41" class="difflineminus">-</span>
<a href="#l39.42"></a><span id="l39.42" class="difflineplus">+  {</span>
<a href="#l39.43"></a><span id="l39.43" class="difflineplus">+    // text attachment</span>
<a href="#l39.44"></a><span id="l39.44" class="difflineplus">+    attachments: [{</span>
<a href="#l39.45"></a><span id="l39.45" class="difflineplus">+      body: textAttachment,</span>
<a href="#l39.46"></a><span id="l39.46" class="difflineplus">+      filename: &quot;test.txt&quot;,</span>
<a href="#l39.47"></a><span id="l39.47" class="difflineplus">+      format: &quot;&quot;,</span>
<a href="#l39.48"></a><span id="l39.48" class="difflineplus">+    }],</span>
<a href="#l39.49"></a><span id="l39.49" class="difflineplus">+  },</span>
<a href="#l39.50"></a><span id="l39.50" class="difflineplus">+];</span>
<a href="#l39.51"></a><span id="l39.51"> </span>
<a href="#l39.52"></a><span id="l39.52"> var gStreamListener = {</span>
<a href="#l39.53"></a><span id="l39.53">   QueryInterface: ChromeUtils.generateQI([Ci.nsIStreamListener]),</span>
<a href="#l39.54"></a><span id="l39.54"> </span>
<a href="#l39.55"></a><span id="l39.55">   _str: &quot;&quot;,</span>
<a href="#l39.56"></a><span id="l39.56">   // nsIRequestObserver part</span>
<a href="#l39.57"></a><span id="l39.57" class="difflineminus">-  onStartRequest: function (aRequest) {</span>
<a href="#l39.58"></a><span id="l39.58" class="difflineplus">+  onStartRequest(aRequest) {</span>
<a href="#l39.59"></a><span id="l39.59">     this.str = &quot;&quot;;</span>
<a href="#l39.60"></a><span id="l39.60">     this._stream = null;</span>
<a href="#l39.61"></a><span id="l39.61">   },</span>
<a href="#l39.62"></a><span id="l39.62" class="difflineminus">-  onStopRequest: function (aRequest, aStatusCode) {</span>
<a href="#l39.63"></a><span id="l39.63" class="difflineplus">+  onStopRequest(aRequest, aStatusCode) {</span>
<a href="#l39.64"></a><span id="l39.64">     // check that text attachment contents didn't end up inline.</span>
<a href="#l39.65"></a><span id="l39.65">     Assert.ok(!this._str.includes(textAttachment));</span>
<a href="#l39.66"></a><span id="l39.66">     async_driver();</span>
<a href="#l39.67"></a><span id="l39.67">   },</span>
<a href="#l39.68"></a><span id="l39.68"> </span>
<a href="#l39.69"></a><span id="l39.69">   /* okay, our onDataAvailable should actually never be called.  the stream</span>
<a href="#l39.70"></a><span id="l39.70">      converter is actually eating everything except the start and stop</span>
<a href="#l39.71"></a><span id="l39.71">      notification. */</span>
<a href="#l39.72"></a><span id="l39.72">   // nsIStreamListener part</span>
<a href="#l39.73"></a><span id="l39.73" class="difflineminus">-  _stream : null,</span>
<a href="#l39.74"></a><span id="l39.74" class="difflineplus">+  _stream: null,</span>
<a href="#l39.75"></a><span id="l39.75"> </span>
<a href="#l39.76"></a><span id="l39.76" class="difflineminus">-  onDataAvailable: function (aRequest, aInputStream, aOffset, aCount) {</span>
<a href="#l39.77"></a><span id="l39.77" class="difflineplus">+  onDataAvailable(aRequest, aInputStream, aOffset, aCount) {</span>
<a href="#l39.78"></a><span id="l39.78">     if (this._stream === null) {</span>
<a href="#l39.79"></a><span id="l39.79">       this._stream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;].</span>
<a href="#l39.80"></a><span id="l39.80">                     createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l39.81"></a><span id="l39.81">       this._stream.init(aInputStream);</span>
<a href="#l39.82"></a><span id="l39.82">     }</span>
<a href="#l39.83"></a><span id="l39.83">     this._str += this._stream.read(aCount);</span>
<a href="#l39.84"></a><span id="l39.84">   },</span>
<a href="#l39.85"></a><span id="l39.85"> };</span>
<a href="#l39.86"></a><span id="l39.86" class="difflineat">@@ -70,17 +78,17 @@ function* test_message_attachments(info,</span>
<a href="#l39.87"></a><span id="l39.87">   Services.prefs.setBoolPref(&quot;mail.inline_attachments.text&quot;, inline_text);</span>
<a href="#l39.88"></a><span id="l39.88">   let synMsg = gMessageGenerator.makeMessage(info);</span>
<a href="#l39.89"></a><span id="l39.89">   let synSet = new SyntheticMessageSet([synMsg]);</span>
<a href="#l39.90"></a><span id="l39.90">   yield add_sets_to_folder(gInbox, [synSet]);</span>
<a href="#l39.91"></a><span id="l39.91"> </span>
<a href="#l39.92"></a><span id="l39.92">   let msgURI = synSet.getMsgURI(0);</span>
<a href="#l39.93"></a><span id="l39.93">   let msgService = gMessenger.messageServiceFromURI(msgURI);</span>
<a href="#l39.94"></a><span id="l39.94"> </span>
<a href="#l39.95"></a><span id="l39.95" class="difflineminus">-  let streamURI = msgService.streamMessage(</span>
<a href="#l39.96"></a><span id="l39.96" class="difflineplus">+  msgService.streamMessage(</span>
<a href="#l39.97"></a><span id="l39.97">     msgURI,</span>
<a href="#l39.98"></a><span id="l39.98">     gStreamListener,</span>
<a href="#l39.99"></a><span id="l39.99">     msgWindow,</span>
<a href="#l39.100"></a><span id="l39.100">     null,</span>
<a href="#l39.101"></a><span id="l39.101">     true, // have them create the converter</span>
<a href="#l39.102"></a><span id="l39.102">     // additional uri payload, note that &quot;header=&quot; is prepended automatically</span>
<a href="#l39.103"></a><span id="l39.103">     &quot;filter&quot;,</span>
<a href="#l39.104"></a><span id="l39.104">     false);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

