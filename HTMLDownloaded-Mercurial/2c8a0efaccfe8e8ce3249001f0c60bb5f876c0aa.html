<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 25251:2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa" />
<meta property="og:url" content="/comm-central/rev/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa" />
<meta property="og:description" content="Bug 453908 - Convert RDF consumers to use the folder-lookup service in JavaScript code. r=darktrojan,aceman" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa">shortlog</a> |
<a href="/comm-central/log/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa">files</a> |
changeset |
<a href="/comm-central/raw-rev/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa">raw</a>  | <a href="/comm-central/archive/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=453908">Bug 453908</a> - Convert RDF consumers to use the folder-lookup service in JavaScript code. r=darktrojan,aceman
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#66;&#101;&#110;&#32;&#67;&#97;&#109;&#112;&#98;&#101;&#108;&#108;&#32;&#60;&#98;&#101;&#110;&#99;&#64;&#116;&#104;&#117;&#110;&#100;&#101;&#114;&#98;&#105;&#114;&#100;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 20 Nov 2018 10:13:37 +1300</td></tr>

<tr>
 <td>changeset 25251</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa">2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa</a></td>
</tr>



<tr>
<td>parent 25250</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/cd6d89475b76f61404553532c8e8ca87d0307b5c">cd6d89475b76f61404553532c8e8ca87d0307b5c</a>
</td>
</tr>

<tr>
<td>child 25252</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/46fb423d7ced6a68bcc7bbb9b3a8e788a8a695cf">46fb423d7ced6a68bcc7bbb9b3a8e788a8a695cf</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa">15155</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 22 Nov 2018 10:45:39 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@46fb423d7ced [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=46fb423d7ced6a68bcc7bbb9b3a8e788a8a695cf">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=46fb423d7ced6a68bcc7bbb9b3a8e788a8a695cf&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=46fb423d7ced6a68bcc7bbb9b3a8e788a8a695cf&newProject=comm-central&newRevision=997a4690702341b8abdf046eb56f2ee03ade135d&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=46fb423d7ced6a68bcc7bbb9b3a8e788a8a695cf&newProject=comm-central&newRevision=997a4690702341b8abdf046eb56f2ee03ade135d&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=46fb423d7ced6a68bcc7bbb9b3a8e788a8a695cf&newProject=comm-central&newRevision=997a4690702341b8abdf046eb56f2ee03ade135d&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28darktrojan%29&revcount=50">darktrojan</a>, <a href="/comm-central/log?rev=reviewer%28aceman%29&revcount=50">aceman</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=453908">453908</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=453908">Bug 453908</a> - Convert RDF consumers to use the folder-lookup service in JavaScript code. r=darktrojan,aceman

Based originally on patches from jcranmer and aceman.
All folder lookups in JS now go through the MailUtil.jsm
functions getExistingFolder() and getOrCreateFolder()
instead of directly using the RDF service.
This is designed to make it really explicit when calling
code might be expected to be dealing with a detached folder,
so we can go through and remove all such cases.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/SearchDialog.js">mail/base/content/SearchDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/SearchDialog.js">file</a> |
<a href="/comm-central/annotate/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/SearchDialog.js">annotate</a> |
<a href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/SearchDialog.js">diff</a> |
<a href="/comm-central/comparison/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/SearchDialog.js">comparison</a> |
<a href="/comm-central/log/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/SearchDialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/folderDisplay.js">mail/base/content/folderDisplay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/folderDisplay.js">file</a> |
<a href="/comm-central/annotate/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/folderDisplay.js">annotate</a> |
<a href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/folderDisplay.js">diff</a> |
<a href="/comm-central/comparison/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/folderDisplay.js">comparison</a> |
<a href="/comm-central/log/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/folderDisplay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/mail3PaneWindowCommands.js">mail/base/content/mail3PaneWindowCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/mail3PaneWindowCommands.js">file</a> |
<a href="/comm-central/annotate/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/mail3PaneWindowCommands.js">annotate</a> |
<a href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/mail3PaneWindowCommands.js">diff</a> |
<a href="/comm-central/comparison/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/mail3PaneWindowCommands.js">comparison</a> |
<a href="/comm-central/log/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/mail3PaneWindowCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/mailCommands.js">mail/base/content/mailCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/mailCommands.js">file</a> |
<a href="/comm-central/annotate/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/mailCommands.js">annotate</a> |
<a href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/mailCommands.js">diff</a> |
<a href="/comm-central/comparison/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/mailCommands.js">comparison</a> |
<a href="/comm-central/log/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/mailCommands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/mailTabs.js">mail/base/content/mailTabs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/mailTabs.js">file</a> |
<a href="/comm-central/annotate/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/mailTabs.js">annotate</a> |
<a href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/mailTabs.js">diff</a> |
<a href="/comm-central/comparison/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/mailTabs.js">comparison</a> |
<a href="/comm-central/log/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/mailTabs.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/mailWindow.js">mail/base/content/mailWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/mailWindow.js">file</a> |
<a href="/comm-central/annotate/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/mailWindow.js">annotate</a> |
<a href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/mailWindow.js">diff</a> |
<a href="/comm-central/comparison/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/mailWindow.js">comparison</a> |
<a href="/comm-central/log/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/mailWindow.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/mailWindowOverlay.js">mail/base/content/mailWindowOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/mailWindowOverlay.js">file</a> |
<a href="/comm-central/annotate/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/mailWindowOverlay.js">annotate</a> |
<a href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/mailWindowOverlay.js">diff</a> |
<a href="/comm-central/comparison/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/mailWindowOverlay.js">comparison</a> |
<a href="/comm-central/log/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/mailWindowOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/messageWindow.js">mail/base/content/messageWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/messageWindow.js">file</a> |
<a href="/comm-central/annotate/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/messageWindow.js">annotate</a> |
<a href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/messageWindow.js">diff</a> |
<a href="/comm-central/comparison/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/messageWindow.js">comparison</a> |
<a href="/comm-central/log/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/messageWindow.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/msgMail3PaneWindow.js">mail/base/content/msgMail3PaneWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/msgMail3PaneWindow.js">file</a> |
<a href="/comm-central/annotate/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/msgMail3PaneWindow.js">annotate</a> |
<a href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/msgMail3PaneWindow.js">diff</a> |
<a href="/comm-central/comparison/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/msgMail3PaneWindow.js">comparison</a> |
<a href="/comm-central/log/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/content/msgMail3PaneWindow.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/modules/MailUtils.jsm">mail/base/modules/MailUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/modules/MailUtils.jsm">file</a> |
<a href="/comm-central/annotate/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/modules/MailUtils.jsm">annotate</a> |
<a href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/modules/MailUtils.jsm">diff</a> |
<a href="/comm-central/comparison/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/modules/MailUtils.jsm">comparison</a> |
<a href="/comm-central/log/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/base/modules/MailUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/components/compose/content/MsgComposeCommands.js">mail/components/compose/content/MsgComposeCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/components/compose/content/MsgComposeCommands.js">file</a> |
<a href="/comm-central/annotate/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/components/compose/content/MsgComposeCommands.js">annotate</a> |
<a href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/components/compose/content/MsgComposeCommands.js">diff</a> |
<a href="/comm-central/comparison/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/components/compose/content/MsgComposeCommands.js">comparison</a> |
<a href="/comm-central/log/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/components/compose/content/MsgComposeCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/test/mozmill/folder-display/test-message-commands.js">mail/test/mozmill/folder-display/test-message-commands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/test/mozmill/folder-display/test-message-commands.js">file</a> |
<a href="/comm-central/annotate/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/test/mozmill/folder-display/test-message-commands.js">annotate</a> |
<a href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/test/mozmill/folder-display/test-message-commands.js">diff</a> |
<a href="/comm-central/comparison/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/test/mozmill/folder-display/test-message-commands.js">comparison</a> |
<a href="/comm-central/log/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/test/mozmill/folder-display/test-message-commands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/test/mozmill/folder-pane/test-folder-pane.js">mail/test/mozmill/folder-pane/test-folder-pane.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/test/mozmill/folder-pane/test-folder-pane.js">file</a> |
<a href="/comm-central/annotate/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/test/mozmill/folder-pane/test-folder-pane.js">annotate</a> |
<a href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/test/mozmill/folder-pane/test-folder-pane.js">diff</a> |
<a href="/comm-central/comparison/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/test/mozmill/folder-pane/test-folder-pane.js">comparison</a> |
<a href="/comm-central/log/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mail/test/mozmill/folder-pane/test-folder-pane.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/content/junkCommands.js">mailnews/base/content/junkCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/content/junkCommands.js">file</a> |
<a href="/comm-central/annotate/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/content/junkCommands.js">annotate</a> |
<a href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/content/junkCommands.js">diff</a> |
<a href="/comm-central/comparison/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/content/junkCommands.js">comparison</a> |
<a href="/comm-central/log/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/content/junkCommands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/content/msgFolderPickerOverlay.js">mailnews/base/content/msgFolderPickerOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/content/msgFolderPickerOverlay.js">file</a> |
<a href="/comm-central/annotate/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/content/msgFolderPickerOverlay.js">annotate</a> |
<a href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/content/msgFolderPickerOverlay.js">diff</a> |
<a href="/comm-central/comparison/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/content/msgFolderPickerOverlay.js">comparison</a> |
<a href="/comm-central/log/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/content/msgFolderPickerOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/content/msgSynchronize.js">mailnews/base/content/msgSynchronize.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/content/msgSynchronize.js">file</a> |
<a href="/comm-central/annotate/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/content/msgSynchronize.js">annotate</a> |
<a href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/content/msgSynchronize.js">diff</a> |
<a href="/comm-central/comparison/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/content/msgSynchronize.js">comparison</a> |
<a href="/comm-central/log/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/content/msgSynchronize.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/content/subscribe.js">mailnews/base/content/subscribe.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/content/subscribe.js">file</a> |
<a href="/comm-central/annotate/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/content/subscribe.js">annotate</a> |
<a href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/content/subscribe.js">diff</a> |
<a href="/comm-central/comparison/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/content/subscribe.js">comparison</a> |
<a href="/comm-central/log/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/content/subscribe.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/content/virtualFolderListEdit.js">mailnews/base/content/virtualFolderListEdit.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/content/virtualFolderListEdit.js">file</a> |
<a href="/comm-central/annotate/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/content/virtualFolderListEdit.js">annotate</a> |
<a href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/content/virtualFolderListEdit.js">diff</a> |
<a href="/comm-central/comparison/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/content/virtualFolderListEdit.js">comparison</a> |
<a href="/comm-central/log/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/content/virtualFolderListEdit.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/content/virtualFolderProperties.js">mailnews/base/content/virtualFolderProperties.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/content/virtualFolderProperties.js">file</a> |
<a href="/comm-central/annotate/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/content/virtualFolderProperties.js">annotate</a> |
<a href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/content/virtualFolderProperties.js">diff</a> |
<a href="/comm-central/comparison/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/content/virtualFolderProperties.js">comparison</a> |
<a href="/comm-central/log/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/content/virtualFolderProperties.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/prefs/content/am-copies.js">mailnews/base/prefs/content/am-copies.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/prefs/content/am-copies.js">file</a> |
<a href="/comm-central/annotate/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/prefs/content/am-copies.js">annotate</a> |
<a href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/prefs/content/am-copies.js">diff</a> |
<a href="/comm-central/comparison/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/prefs/content/am-copies.js">comparison</a> |
<a href="/comm-central/log/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/prefs/content/am-copies.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/prefs/content/am-junk.js">mailnews/base/prefs/content/am-junk.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/prefs/content/am-junk.js">file</a> |
<a href="/comm-central/annotate/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/prefs/content/am-junk.js">annotate</a> |
<a href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/prefs/content/am-junk.js">diff</a> |
<a href="/comm-central/comparison/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/prefs/content/am-junk.js">comparison</a> |
<a href="/comm-central/log/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/prefs/content/am-junk.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/prefs/content/am-server.js">mailnews/base/prefs/content/am-server.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/prefs/content/am-server.js">file</a> |
<a href="/comm-central/annotate/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/prefs/content/am-server.js">annotate</a> |
<a href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/prefs/content/am-server.js">diff</a> |
<a href="/comm-central/comparison/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/prefs/content/am-server.js">comparison</a> |
<a href="/comm-central/log/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/prefs/content/am-server.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/prefs/content/amUtils.js">mailnews/base/prefs/content/amUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/prefs/content/amUtils.js">file</a> |
<a href="/comm-central/annotate/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/prefs/content/amUtils.js">annotate</a> |
<a href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/prefs/content/amUtils.js">diff</a> |
<a href="/comm-central/comparison/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/prefs/content/amUtils.js">comparison</a> |
<a href="/comm-central/log/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/prefs/content/amUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/public/nsIFolderLookupService.idl">mailnews/base/public/nsIFolderLookupService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/public/nsIFolderLookupService.idl">file</a> |
<a href="/comm-central/annotate/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/public/nsIFolderLookupService.idl">annotate</a> |
<a href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/public/nsIFolderLookupService.idl">diff</a> |
<a href="/comm-central/comparison/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/public/nsIFolderLookupService.idl">comparison</a> |
<a href="/comm-central/log/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/public/nsIFolderLookupService.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/search/content/FilterEditor.js">mailnews/base/search/content/FilterEditor.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/search/content/FilterEditor.js">file</a> |
<a href="/comm-central/annotate/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/search/content/FilterEditor.js">annotate</a> |
<a href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/search/content/FilterEditor.js">diff</a> |
<a href="/comm-central/comparison/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/search/content/FilterEditor.js">comparison</a> |
<a href="/comm-central/log/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/search/content/FilterEditor.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/search/content/searchWidgets.js">mailnews/base/search/content/searchWidgets.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/search/content/searchWidgets.js">file</a> |
<a href="/comm-central/annotate/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/search/content/searchWidgets.js">annotate</a> |
<a href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/search/content/searchWidgets.js">diff</a> |
<a href="/comm-central/comparison/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/search/content/searchWidgets.js">comparison</a> |
<a href="/comm-central/log/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/search/content/searchWidgets.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/search/content/searchWidgets.xml">mailnews/base/search/content/searchWidgets.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/search/content/searchWidgets.xml">file</a> |
<a href="/comm-central/annotate/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/search/content/searchWidgets.xml">annotate</a> |
<a href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/search/content/searchWidgets.xml">diff</a> |
<a href="/comm-central/comparison/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/search/content/searchWidgets.xml">comparison</a> |
<a href="/comm-central/log/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/search/content/searchWidgets.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/src/folderLookupService.js">mailnews/base/src/folderLookupService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/src/folderLookupService.js">file</a> |
<a href="/comm-central/annotate/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/src/folderLookupService.js">annotate</a> |
<a href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/src/folderLookupService.js">diff</a> |
<a href="/comm-central/comparison/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/src/folderLookupService.js">comparison</a> |
<a href="/comm-central/log/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/src/folderLookupService.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/src/nsMailNewsCommandLineHandler.js">mailnews/base/src/nsMailNewsCommandLineHandler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/src/nsMailNewsCommandLineHandler.js">file</a> |
<a href="/comm-central/annotate/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/src/nsMailNewsCommandLineHandler.js">annotate</a> |
<a href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/src/nsMailNewsCommandLineHandler.js">diff</a> |
<a href="/comm-central/comparison/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/src/nsMailNewsCommandLineHandler.js">comparison</a> |
<a href="/comm-central/log/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/src/nsMailNewsCommandLineHandler.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/src/virtualFolderWrapper.js">mailnews/base/src/virtualFolderWrapper.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/src/virtualFolderWrapper.js">file</a> |
<a href="/comm-central/annotate/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/src/virtualFolderWrapper.js">annotate</a> |
<a href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/src/virtualFolderWrapper.js">diff</a> |
<a href="/comm-central/comparison/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/src/virtualFolderWrapper.js">comparison</a> |
<a href="/comm-central/log/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/base/src/virtualFolderWrapper.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/db/gloda/modules/datamodel.js">mailnews/db/gloda/modules/datamodel.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/db/gloda/modules/datamodel.js">file</a> |
<a href="/comm-central/annotate/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/db/gloda/modules/datamodel.js">annotate</a> |
<a href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/db/gloda/modules/datamodel.js">diff</a> |
<a href="/comm-central/comparison/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/db/gloda/modules/datamodel.js">comparison</a> |
<a href="/comm-central/log/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/db/gloda/modules/datamodel.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/db/gloda/modules/index_msg.js">mailnews/db/gloda/modules/index_msg.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/db/gloda/modules/index_msg.js">file</a> |
<a href="/comm-central/annotate/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/db/gloda/modules/index_msg.js">annotate</a> |
<a href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/db/gloda/modules/index_msg.js">diff</a> |
<a href="/comm-central/comparison/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/db/gloda/modules/index_msg.js">comparison</a> |
<a href="/comm-central/log/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/db/gloda/modules/index_msg.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/db/gloda/test/unit/base_index_messages.js">mailnews/db/gloda/test/unit/base_index_messages.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/db/gloda/test/unit/base_index_messages.js">file</a> |
<a href="/comm-central/annotate/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/db/gloda/test/unit/base_index_messages.js">annotate</a> |
<a href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/db/gloda/test/unit/base_index_messages.js">diff</a> |
<a href="/comm-central/comparison/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/db/gloda/test/unit/base_index_messages.js">comparison</a> |
<a href="/comm-central/log/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/db/gloda/test/unit/base_index_messages.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/extensions/newsblog/content/FeedUtils.jsm">mailnews/extensions/newsblog/content/FeedUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/extensions/newsblog/content/FeedUtils.jsm">file</a> |
<a href="/comm-central/annotate/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/extensions/newsblog/content/FeedUtils.jsm">annotate</a> |
<a href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/extensions/newsblog/content/FeedUtils.jsm">diff</a> |
<a href="/comm-central/comparison/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/extensions/newsblog/content/FeedUtils.jsm">comparison</a> |
<a href="/comm-central/log/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/extensions/newsblog/content/FeedUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/imap/test/unit/test_saveTemplate.js">mailnews/imap/test/unit/test_saveTemplate.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/imap/test/unit/test_saveTemplate.js">file</a> |
<a href="/comm-central/annotate/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/imap/test/unit/test_saveTemplate.js">annotate</a> |
<a href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/imap/test/unit/test_saveTemplate.js">diff</a> |
<a href="/comm-central/comparison/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/imap/test/unit/test_saveTemplate.js">comparison</a> |
<a href="/comm-central/log/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/imap/test/unit/test_saveTemplate.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/jsaccount/test/unit/test_jaMsgFolder.js">mailnews/jsaccount/test/unit/test_jaMsgFolder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/jsaccount/test/unit/test_jaMsgFolder.js">file</a> |
<a href="/comm-central/annotate/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/jsaccount/test/unit/test_jaMsgFolder.js">annotate</a> |
<a href="/comm-central/diff/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/jsaccount/test/unit/test_jaMsgFolder.js">diff</a> |
<a href="/comm-central/comparison/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/jsaccount/test/unit/test_jaMsgFolder.js">comparison</a> |
<a href="/comm-central/log/2c8a0efaccfe8e8ce3249001f0c60bb5f876c0aa/mailnews/jsaccount/test/unit/test_jaMsgFolder.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/SearchDialog.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/SearchDialog.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -520,18 +520,17 @@ function MsgDeleteSelectedMessages(aComm</span>
<a href="#l1.4"></a><span id="l1.4"> function MoveMessageInSearch(destFolder) {</span>
<a href="#l1.5"></a><span id="l1.5">   // Get the msg folder we're moving messages into.</span>
<a href="#l1.6"></a><span id="l1.6">   // If the id (uri) is not set, use file-uri which is set for</span>
<a href="#l1.7"></a><span id="l1.7">   // &quot;File Here&quot;.</span>
<a href="#l1.8"></a><span id="l1.8">   let destUri = destFolder.getAttribute(&quot;id&quot;);</span>
<a href="#l1.9"></a><span id="l1.9">   if (destUri.length == 0)</span>
<a href="#l1.10"></a><span id="l1.10">     destUri = destFolder.getAttribute(&quot;file-uri&quot;);</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  let destMsgFolder = MailUtils.getFolderForURI(destUri)</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-    .QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+  let destMsgFolder = MailUtils.getOrCreateFolder(destUri);</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16">   gFolderDisplay.hintAboutToDeleteMessages();</span>
<a href="#l1.17"></a><span id="l1.17">   gFolderDisplay.doCommandWithFolder(nsMsgViewCommandType.moveMessages,</span>
<a href="#l1.18"></a><span id="l1.18">                                      destMsgFolder);</span>
<a href="#l1.19"></a><span id="l1.19"> }</span>
<a href="#l1.20"></a><span id="l1.20"> </span>
<a href="#l1.21"></a><span id="l1.21"> function OpenInFolder() {</span>
<a href="#l1.22"></a><span id="l1.22">   MailUtils.displayMessageInFolderTab(gFolderDisplay.selectedMessage);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/folderDisplay.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/folderDisplay.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -748,17 +748,17 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l2.4"></a><span id="l2.4">   // @}</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6">   /**</span>
<a href="#l2.7"></a><span id="l2.7">    * @name What To Display</span>
<a href="#l2.8"></a><span id="l2.8">    * @protected</span>
<a href="#l2.9"></a><span id="l2.9">    */</span>
<a href="#l2.10"></a><span id="l2.10">   // @{</span>
<a href="#l2.11"></a><span id="l2.11">   showFolderUri(aFolderURI) {</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    return this.show(MailUtils.getFolderForURI(aFolderURI));</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+    return this.show(MailUtils.getExistingFolder(aFolderURI));</span>
<a href="#l2.14"></a><span id="l2.14">   },</span>
<a href="#l2.15"></a><span id="l2.15"> </span>
<a href="#l2.16"></a><span id="l2.16">   /**</span>
<a href="#l2.17"></a><span id="l2.17">    * Invoked by showFolder when it turns out the folder is in fact a server.</span>
<a href="#l2.18"></a><span id="l2.18">    * @private</span>
<a href="#l2.19"></a><span id="l2.19">    */</span>
<a href="#l2.20"></a><span id="l2.20">   _showServer() {</span>
<a href="#l2.21"></a><span id="l2.21">     // currently nothing to do.  makeActive handles everything for us (because</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/content/mail3PaneWindowCommands.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/content/mail3PaneWindowCommands.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -545,19 +545,19 @@ var DefaultController = {</span>
<a href="#l3.4"></a><span id="l3.4">         if (Services.prefs.getBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;)) {</span>
<a href="#l3.5"></a><span id="l3.5">           let loadedFolder = gFolderTreeView.getSelectedFolders()[0];</span>
<a href="#l3.6"></a><span id="l3.6">           if (loadedFolder &amp;&amp; !loadedFolder.canDeleteMessages)</span>
<a href="#l3.7"></a><span id="l3.7">             return false;</span>
<a href="#l3.8"></a><span id="l3.8">         }</span>
<a href="#l3.9"></a><span id="l3.9">         let targetURI = Services.prefs.getCharPref(&quot;mail.last_msg_movecopy_target_uri&quot;);</span>
<a href="#l3.10"></a><span id="l3.10">         if (!targetURI)</span>
<a href="#l3.11"></a><span id="l3.11">           return false;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-        let targetFolder = MailUtils.getFolderForURI(targetURI);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-        // If parent is null, folder doesn't exist.</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-        return targetFolder &amp;&amp; targetFolder.parent &amp;&amp;</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+        let targetFolder = MailUtils.getExistingFolder(targetURI);</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+        // If null, folder doesn't exist.</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+        return (targetFolder !== null) &amp;&amp;</span>
<a href="#l3.18"></a><span id="l3.18">                gFolderDisplay.selectedCount &gt; 0;</span>
<a href="#l3.19"></a><span id="l3.19">       case &quot;cmd_fullZoomReduce&quot;:</span>
<a href="#l3.20"></a><span id="l3.20">       case &quot;cmd_fullZoomEnlarge&quot;:</span>
<a href="#l3.21"></a><span id="l3.21">       case &quot;cmd_fullZoomReset&quot;:</span>
<a href="#l3.22"></a><span id="l3.22">       case &quot;cmd_fullZoomToggle&quot;:</span>
<a href="#l3.23"></a><span id="l3.23">         // If we are a message tab, then we've got a message displayed, so</span>
<a href="#l3.24"></a><span id="l3.24">         // always allow zooming in the message</span>
<a href="#l3.25"></a><span id="l3.25">         if (document.getElementById(&quot;tabmail&quot;).selectedTab.mode.name == &quot;message&quot;)</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineat">@@ -940,17 +940,17 @@ var DefaultController = {</span>
<a href="#l3.27"></a><span id="l3.27">           break;</span>
<a href="#l3.28"></a><span id="l3.28">       case &quot;cmd_synchronizeOffline&quot;:</span>
<a href="#l3.29"></a><span id="l3.29">           MsgSynchronizeOffline();</span>
<a href="#l3.30"></a><span id="l3.30">           break;</span>
<a href="#l3.31"></a><span id="l3.31">       case &quot;cmd_settingsOffline&quot;:</span>
<a href="#l3.32"></a><span id="l3.32">           MailOfflineMgr.openOfflineAccountSettings();</span>
<a href="#l3.33"></a><span id="l3.33">           break;</span>
<a href="#l3.34"></a><span id="l3.34">       case &quot;cmd_moveToFolderAgain&quot;:</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-          var folder = MailUtils.getFolderForURI(</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+          var folder = MailUtils.getOrCreateFolder(</span>
<a href="#l3.37"></a><span id="l3.37">             Services.prefs.getCharPref(&quot;mail.last_msg_movecopy_target_uri&quot;));</span>
<a href="#l3.38"></a><span id="l3.38">           if (Services.prefs.getBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;))</span>
<a href="#l3.39"></a><span id="l3.39">             MsgMoveMessage(folder);</span>
<a href="#l3.40"></a><span id="l3.40">           else</span>
<a href="#l3.41"></a><span id="l3.41">             MsgCopyMessage(folder);</span>
<a href="#l3.42"></a><span id="l3.42">           break;</span>
<a href="#l3.43"></a><span id="l3.43">       case &quot;cmd_selectAll&quot;:</span>
<a href="#l3.44"></a><span id="l3.44">         // XXX If the message pane is selected but the tab focused, this ends</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/base/content/mailCommands.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/base/content/mailCommands.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -331,17 +331,17 @@ function Subscribe(preselectedMsgFolder)</span>
<a href="#l4.4"></a><span id="l4.4">                     {</span>
<a href="#l4.5"></a><span id="l4.5">                       folder: preselectedMsgFolder,</span>
<a href="#l4.6"></a><span id="l4.6">                       okCallback: SubscribeOKCallback,</span>
<a href="#l4.7"></a><span id="l4.7">                     });</span>
<a href="#l4.8"></a><span id="l4.8"> }</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10"> function SubscribeOKCallback(changeTable) {</span>
<a href="#l4.11"></a><span id="l4.11">   for (var serverURI in changeTable) {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    var folder = MailUtils.getFolderForURI(serverURI, true);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+    var folder = MailUtils.getExistingFolder(serverURI);</span>
<a href="#l4.14"></a><span id="l4.14">     var server = folder.server;</span>
<a href="#l4.15"></a><span id="l4.15">     var subscribableServer =</span>
<a href="#l4.16"></a><span id="l4.16">           server.QueryInterface(Ci.nsISubscribableServer);</span>
<a href="#l4.17"></a><span id="l4.17"> </span>
<a href="#l4.18"></a><span id="l4.18">     for (var name in changeTable[serverURI]) {</span>
<a href="#l4.19"></a><span id="l4.19">       if (changeTable[serverURI][name]) {</span>
<a href="#l4.20"></a><span id="l4.20">         try {</span>
<a href="#l4.21"></a><span id="l4.21">           subscribableServer.subscribe(name);</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -433,17 +433,17 @@ saveAsUrlListener.prototype = {</span>
<a href="#l4.23"></a><span id="l4.23">     messenger.saveAs(this.uri, false, this.identity, null);</span>
<a href="#l4.24"></a><span id="l4.24">   },</span>
<a href="#l4.25"></a><span id="l4.25"> };</span>
<a href="#l4.26"></a><span id="l4.26"> </span>
<a href="#l4.27"></a><span id="l4.27"> function SaveAsTemplate(uri) {</span>
<a href="#l4.28"></a><span id="l4.28">   if (uri) {</span>
<a href="#l4.29"></a><span id="l4.29">     let hdr = messenger.msgHdrFromURI(uri);</span>
<a href="#l4.30"></a><span id="l4.30">     let identity = getIdentityForHeader(hdr, Ci.nsIMsgCompType.Template);</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-    let templates = MailUtils.getFolderForURI(identity.stationeryFolder, false);</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+    let templates = MailUtils.getOrCreateFolder(identity.stationeryFolder);</span>
<a href="#l4.33"></a><span id="l4.33">     if (!templates.parent) {</span>
<a href="#l4.34"></a><span id="l4.34">       templates.setFlag(Ci.nsMsgFolderFlags.Templates);</span>
<a href="#l4.35"></a><span id="l4.35">       let isAsync = templates.server.protocolInfo.foldersCreatedAsync;</span>
<a href="#l4.36"></a><span id="l4.36">       templates.createStorageIfMissing(new saveAsUrlListener(uri, identity));</span>
<a href="#l4.37"></a><span id="l4.37">       if (isAsync)</span>
<a href="#l4.38"></a><span id="l4.38">         return;</span>
<a href="#l4.39"></a><span id="l4.39">     }</span>
<a href="#l4.40"></a><span id="l4.40">     messenger.saveAs(uri, false, identity, null);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/base/content/mailTabs.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/base/content/mailTabs.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,14 +1,15 @@</span>
<a href="#l5.4"></a><span id="l5.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.5"></a><span id="l5.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.6"></a><span id="l5.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> ChromeUtils.import(&quot;resource:///modules/MsgHdrSyntheticView.jsm&quot;);</span>
<a href="#l5.9"></a><span id="l5.9"> ChromeUtils.import(&quot;resource:///modules/errUtils.js&quot;);</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l5.11"></a><span id="l5.11"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l5.12"></a><span id="l5.12"> </span>
<a href="#l5.13"></a><span id="l5.13"> /**</span>
<a href="#l5.14"></a><span id="l5.14">  * Displays message &quot;folder&quot;s, mail &quot;message&quot;s, and &quot;glodaList&quot; results.  The</span>
<a href="#l5.15"></a><span id="l5.15">  *  commonality is that they all use the &quot;mailContent&quot; panel's folder tree,</span>
<a href="#l5.16"></a><span id="l5.16">  *  thread tree, and message pane objects.  This happens for historical reasons,</span>
<a href="#l5.17"></a><span id="l5.17">  *  likely involving the fact that prior to the introduction of this</span>
<a href="#l5.18"></a><span id="l5.18">  *  abstraction, everything was always stored in global objects.  For the 3.0</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineat">@@ -169,20 +170,17 @@ var mailTabType = {</span>
<a href="#l5.20"></a><span id="l5.20">           return retval;</span>
<a href="#l5.21"></a><span id="l5.21">         } catch (e) {</span>
<a href="#l5.22"></a><span id="l5.22">           logException(e);</span>
<a href="#l5.23"></a><span id="l5.23">           return null;</span>
<a href="#l5.24"></a><span id="l5.24">         }</span>
<a href="#l5.25"></a><span id="l5.25">       },</span>
<a href="#l5.26"></a><span id="l5.26">       restoreTab(aTabmail, aPersistedState) {</span>
<a href="#l5.27"></a><span id="l5.27">       try {</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-        let rdfService = Cc[&quot;@mozilla.org/rdf/rdf-service;1&quot;]</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">-                           .getService(Ci.nsIRDFService);</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-        let folder = rdfService.GetResource(aPersistedState.folderURI)</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-                       .QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+        let folder = MailUtils.getExistingFolder(aPersistedState.folderURI);</span>
<a href="#l5.33"></a><span id="l5.33">         // if the folder no longer exists, we can't restore the tab</span>
<a href="#l5.34"></a><span id="l5.34">         if (folder) {</span>
<a href="#l5.35"></a><span id="l5.35">           let folderPaneVisible = (&quot;folderPaneVisible&quot; in aPersistedState) ?</span>
<a href="#l5.36"></a><span id="l5.36">                                     aPersistedState.folderPaneVisible :</span>
<a href="#l5.37"></a><span id="l5.37">                                     true;</span>
<a href="#l5.38"></a><span id="l5.38">           // If we are talking about the first tab, it already exists and we</span>
<a href="#l5.39"></a><span id="l5.39">           //  should poke it.  We are assuming it is the currently displayed</span>
<a href="#l5.40"></a><span id="l5.40">           //  tab because we are privvy to the implementation details and know</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/base/content/mailWindow.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/base/content/mailWindow.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -471,17 +471,17 @@ nsMsgStatusFeedback.prototype = {</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5"> function nsMsgWindowCommands() {</span>
<a href="#l6.6"></a><span id="l6.6"> }</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8"> nsMsgWindowCommands.prototype = {</span>
<a href="#l6.9"></a><span id="l6.9">   QueryInterface: ChromeUtils.generateQI([&quot;nsIMsgWindowCommands&quot;]),</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11">   selectFolder(folderUri) {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-    gFolderTreeView.selectFolder(MailUtils.getFolderForURI(folderUri));</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+    gFolderTreeView.selectFolder(MailUtils.getOrCreateFolder(folderUri));</span>
<a href="#l6.14"></a><span id="l6.14">   },</span>
<a href="#l6.15"></a><span id="l6.15"> </span>
<a href="#l6.16"></a><span id="l6.16">   selectMessage(messageUri) {</span>
<a href="#l6.17"></a><span id="l6.17">     let msgHdr = messenger.msgHdrFromURI(messageUri);</span>
<a href="#l6.18"></a><span id="l6.18">     gFolderDisplay.selectMessage(msgHdr);</span>
<a href="#l6.19"></a><span id="l6.19">   },</span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21">   clearMsgPane() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -596,17 +596,17 @@ function showCommandInSpecialFolder(aCom</span>
<a href="#l7.4"></a><span id="l7.4">  * The menu item label and accesskey are adjusted to include the folder name.</span>
<a href="#l7.5"></a><span id="l7.5">  *</span>
<a href="#l7.6"></a><span id="l7.6">  * @param aMenuItem the menu item to adjust</span>
<a href="#l7.7"></a><span id="l7.7">  */</span>
<a href="#l7.8"></a><span id="l7.8"> function initMoveToFolderAgainMenu(aMenuItem) {</span>
<a href="#l7.9"></a><span id="l7.9">   var lastFolderURI = Services.prefs.getCharPref(&quot;mail.last_msg_movecopy_target_uri&quot;);</span>
<a href="#l7.10"></a><span id="l7.10">   var isMove = Services.prefs.getBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;);</span>
<a href="#l7.11"></a><span id="l7.11">   if (lastFolderURI) {</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-    var destMsgFolder = MailUtils.getFolderForURI(lastFolderURI);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+    var destMsgFolder = MailUtils.getOrCreateFolder(lastFolderURI);</span>
<a href="#l7.14"></a><span id="l7.14">     var bundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l7.15"></a><span id="l7.15">     var stringName = isMove ? &quot;moveToFolderAgain&quot; : &quot;copyToFolderAgain&quot;;</span>
<a href="#l7.16"></a><span id="l7.16">     aMenuItem.label = bundle.getFormattedString(stringName,</span>
<a href="#l7.17"></a><span id="l7.17">                                                 [destMsgFolder.prettyName], 1);</span>
<a href="#l7.18"></a><span id="l7.18">     // This gives us moveToFolderAgainAccessKey and copyToFolderAgainAccessKey.</span>
<a href="#l7.19"></a><span id="l7.19">     aMenuItem.accesskey = bundle.getString(stringName + &quot;AccessKey&quot;);</span>
<a href="#l7.20"></a><span id="l7.20">   }</span>
<a href="#l7.21"></a><span id="l7.21"> }</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineat">@@ -1066,17 +1066,17 @@ function populateHistoryMenu(menuPopup, </span>
<a href="#l7.23"></a><span id="l7.23">   }</span>
<a href="#l7.24"></a><span id="l7.24">   // For populating the back menu, we want the most recently visited</span>
<a href="#l7.25"></a><span id="l7.25">   // messages first in the menu. So we go backward from curPos to 0.</span>
<a href="#l7.26"></a><span id="l7.26">   // For the forward menu, we want to go forward from curPos to the end.</span>
<a href="#l7.27"></a><span id="l7.27">   var relPos = 0;</span>
<a href="#l7.28"></a><span id="l7.28">   for (var i = curPos.value; (isBackMenu) ? i &gt;= 0 : i &lt; historyArray.length; i += ((isBackMenu) ? -2 : 2)) {</span>
<a href="#l7.29"></a><span id="l7.29">     navDebug(&quot;history[&quot; + i + &quot;] = &quot; + historyArray[i] + &quot;\n&quot;);</span>
<a href="#l7.30"></a><span id="l7.30">     navDebug(&quot;history[&quot; + i + &quot;] = &quot; + historyArray[i + 1] + &quot;\n&quot;);</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-    folder = MailUtils.getFolderForURI(historyArray[i + 1]);</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+    folder = MailUtils.getOrCreateFolder(historyArray[i + 1]);</span>
<a href="#l7.33"></a><span id="l7.33">     navDebug(&quot;folder URI = &quot; + folder.URI + &quot;pretty name &quot; + folder.prettyName + &quot;\n&quot;);</span>
<a href="#l7.34"></a><span id="l7.34">     var menuText = &quot;&quot;;</span>
<a href="#l7.35"></a><span id="l7.35"> </span>
<a href="#l7.36"></a><span id="l7.36">     // If the message was not being displayed via the current folder, prepend</span>
<a href="#l7.37"></a><span id="l7.37">     //  the folder name.  We do not need to check underlying folders for</span>
<a href="#l7.38"></a><span id="l7.38">     //  virtual folders because 'folder' is the display folder, not the</span>
<a href="#l7.39"></a><span id="l7.39">     //  underlying one.</span>
<a href="#l7.40"></a><span id="l7.40">     if (folder != gFolderDisplay.displayedFolder)</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineat">@@ -1690,17 +1690,17 @@ BatchMessageMover.prototype = {</span>
<a href="#l7.42"></a><span id="l7.42">     this.continueBatch();</span>
<a href="#l7.43"></a><span id="l7.43">   },</span>
<a href="#l7.44"></a><span id="l7.44"> </span>
<a href="#l7.45"></a><span id="l7.45">   // continue processing of default archive operations</span>
<a href="#l7.46"></a><span id="l7.46">   continueBatch() {</span>
<a href="#l7.47"></a><span id="l7.47">       let batch = this._currentBatch;</span>
<a href="#l7.48"></a><span id="l7.48">       let srcFolder = batch.srcFolder;</span>
<a href="#l7.49"></a><span id="l7.49">       let archiveFolderURI = batch.archiveFolderURI;</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-      let archiveFolder = MailUtils.getFolderForURI(archiveFolderURI, false);</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+      let archiveFolder = MailUtils.getOrCreateFolder(archiveFolderURI);</span>
<a href="#l7.52"></a><span id="l7.52">       let dstFolder = archiveFolder;</span>
<a href="#l7.53"></a><span id="l7.53"> </span>
<a href="#l7.54"></a><span id="l7.54">       let moveArray = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l7.55"></a><span id="l7.55">                         .createInstance(Ci.nsIMutableArray);</span>
<a href="#l7.56"></a><span id="l7.56">       // Don't move any items that the filter moves or deleted</span>
<a href="#l7.57"></a><span id="l7.57">       for (let item of batch.messages) {</span>
<a href="#l7.58"></a><span id="l7.58">         if (srcFolder.msgDatabase.ContainsKey(item.messageKey) &amp;&amp;</span>
<a href="#l7.59"></a><span id="l7.59">             !(srcFolder.getProcessingFlags(item.messageKey) &amp;</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineat">@@ -1729,26 +1729,26 @@ BatchMessageMover.prototype = {</span>
<a href="#l7.61"></a><span id="l7.61">       if (!forceSingle &amp;&amp; (archiveFolder.server instanceof</span>
<a href="#l7.62"></a><span id="l7.62">                            Ci.nsIImapIncomingServer))</span>
<a href="#l7.63"></a><span id="l7.63">         forceSingle = archiveFolder.server.isGMailServer;</span>
<a href="#l7.64"></a><span id="l7.64">       if (forceSingle)</span>
<a href="#l7.65"></a><span id="l7.65">          granularity = Ci.nsIMsgIncomingServer.singleArchiveFolder;</span>
<a href="#l7.66"></a><span id="l7.66"> </span>
<a href="#l7.67"></a><span id="l7.67">       if (granularity &gt;= Ci.nsIMsgIdentity.perYearArchiveFolders) {</span>
<a href="#l7.68"></a><span id="l7.68">         archiveFolderURI += &quot;/&quot; + batch.yearFolderName;</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-        dstFolder = MailUtils.getFolderForURI(archiveFolderURI, false);</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+        dstFolder = MailUtils.getOrCreateFolder(archiveFolderURI);</span>
<a href="#l7.71"></a><span id="l7.71">         if (!dstFolder.parent) {</span>
<a href="#l7.72"></a><span id="l7.72">           dstFolder.createStorageIfMissing(this);</span>
<a href="#l7.73"></a><span id="l7.73">           if (isAsync)</span>
<a href="#l7.74"></a><span id="l7.74">             return; // continues with OnStopRunningUrl</span>
<a href="#l7.75"></a><span id="l7.75">         }</span>
<a href="#l7.76"></a><span id="l7.76">       }</span>
<a href="#l7.77"></a><span id="l7.77">       if (granularity &gt;= Ci.nsIMsgIdentity.perMonthArchiveFolders) {</span>
<a href="#l7.78"></a><span id="l7.78">         archiveFolderURI += &quot;/&quot; + batch.monthFolderName;</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-        dstFolder = MailUtils.getFolderForURI(archiveFolderURI, false);</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+        dstFolder = MailUtils.getOrCreateFolder(archiveFolderURI);</span>
<a href="#l7.81"></a><span id="l7.81">         if (!dstFolder.parent) {</span>
<a href="#l7.82"></a><span id="l7.82">           dstFolder.createStorageIfMissing(this);</span>
<a href="#l7.83"></a><span id="l7.83">           if (isAsync)</span>
<a href="#l7.84"></a><span id="l7.84">             return; // continues with OnStopRunningUrl</span>
<a href="#l7.85"></a><span id="l7.85">         }</span>
<a href="#l7.86"></a><span id="l7.86">       }</span>
<a href="#l7.87"></a><span id="l7.87"> </span>
<a href="#l7.88"></a><span id="l7.88">       // Create the folder structure in Archives.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/base/content/messageWindow.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/base/content/messageWindow.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1040,19 +1040,19 @@ var MessageWindowController = {</span>
<a href="#l8.4"></a><span id="l8.4">       case &quot;cmd_moveToFolderAgain&quot;:</span>
<a href="#l8.5"></a><span id="l8.5">         loadedFolder = gFolderDisplay.displayedFolder;</span>
<a href="#l8.6"></a><span id="l8.6">         if (!loadedFolder || (Services.prefs.getBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;) &amp;&amp;</span>
<a href="#l8.7"></a><span id="l8.7">             !loadedFolder.canDeleteMessages))</span>
<a href="#l8.8"></a><span id="l8.8">           return false;</span>
<a href="#l8.9"></a><span id="l8.9">         let targetURI = Services.prefs.getCharPref(&quot;mail.last_msg_movecopy_target_uri&quot;);</span>
<a href="#l8.10"></a><span id="l8.10">         if (!targetURI)</span>
<a href="#l8.11"></a><span id="l8.11">           return false;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-        let targetFolder = MailUtils.getFolderForURI(targetURI);</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-        // If parent is null, folder doesn't exist.</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-        return targetFolder &amp;&amp; targetFolder.parent;</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+        let targetFolder = MailUtils.getExistingFolder(targetURI);</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+        // If null, folder doesn't exist.</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+        return (targetFolder !== null);</span>
<a href="#l8.18"></a><span id="l8.18">       case &quot;cmd_applyFilters&quot;:</span>
<a href="#l8.19"></a><span id="l8.19">       case &quot;cmd_runJunkControls&quot;:</span>
<a href="#l8.20"></a><span id="l8.20">       case &quot;cmd_deleteJunk&quot;:</span>
<a href="#l8.21"></a><span id="l8.21">         return false;</span>
<a href="#l8.22"></a><span id="l8.22">       case &quot;cmd_chat&quot;:</span>
<a href="#l8.23"></a><span id="l8.23">         return true;</span>
<a href="#l8.24"></a><span id="l8.24">       default:</span>
<a href="#l8.25"></a><span id="l8.25">         return false;</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineat">@@ -1119,17 +1119,17 @@ var MessageWindowController = {</span>
<a href="#l8.27"></a><span id="l8.27">         break;</span>
<a href="#l8.28"></a><span id="l8.28">       case &quot;cmd_newMsgFromTemplate&quot;:</span>
<a href="#l8.29"></a><span id="l8.29">         MsgNewMessageFromTemplate(null);</span>
<a href="#l8.30"></a><span id="l8.30">         break;</span>
<a href="#l8.31"></a><span id="l8.31">       case &quot;cmd_editTemplateMsg&quot;:</span>
<a href="#l8.32"></a><span id="l8.32">         MsgEditTemplateMessage(null);</span>
<a href="#l8.33"></a><span id="l8.33">         break;</span>
<a href="#l8.34"></a><span id="l8.34">       case &quot;cmd_moveToFolderAgain&quot;:</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">-        var folder = MailUtils.getFolderForURI(</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+        var folder = MailUtils.getOrCreateFolder(</span>
<a href="#l8.37"></a><span id="l8.37">                        Services.prefs.getCharPref(&quot;mail.last_msg_movecopy_target_uri&quot;));</span>
<a href="#l8.38"></a><span id="l8.38">         if (Services.prefs.getBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;))</span>
<a href="#l8.39"></a><span id="l8.39">           MsgMoveMessage(folder);</span>
<a href="#l8.40"></a><span id="l8.40">         else</span>
<a href="#l8.41"></a><span id="l8.41">           MsgCopyMessage(folder);</span>
<a href="#l8.42"></a><span id="l8.42">         break;</span>
<a href="#l8.43"></a><span id="l8.43">       case &quot;cmd_createFilterFromPopup&quot;:</span>
<a href="#l8.44"></a><span id="l8.44">         break;// This does nothing because the createfilter is invoked from the popupnode oncommand.</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineat">@@ -1349,10 +1349,10 @@ function getMailToolbox() {</span>
<a href="#l8.46"></a><span id="l8.46"> function RestoreFocusAfterHdrButton() {</span>
<a href="#l8.47"></a><span id="l8.47">   // set focus to the message pane</span>
<a href="#l8.48"></a><span id="l8.48">   window.content.focus();</span>
<a href="#l8.49"></a><span id="l8.49"> }</span>
<a href="#l8.50"></a><span id="l8.50"> </span>
<a href="#l8.51"></a><span id="l8.51"> function SelectFolder(aFolderUri) {</span>
<a href="#l8.52"></a><span id="l8.52">   gFolderDisplay.clearSelection();</span>
<a href="#l8.53"></a><span id="l8.53">   gFolderDisplay.treeSelection.currentIndex = -1;</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-  gFolderDisplay.show(MailUtils.getFolderForURI(aFolderUri));</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+  gFolderDisplay.show(MailUtils.getExistingFolder(aFolderUri));</span>
<a href="#l8.56"></a><span id="l8.56"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -838,17 +838,17 @@ function loadStartFolder(initialUri) {</span>
<a href="#l9.4"></a><span id="l9.4">     let loadFolder = !atStartupRestoreTabs(!!initialUri);</span>
<a href="#l9.5"></a><span id="l9.5"> </span>
<a href="#l9.6"></a><span id="l9.6">     if (initialUri)</span>
<a href="#l9.7"></a><span id="l9.7">       loadFolder = true;</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9">     // First get default account</span>
<a href="#l9.10"></a><span id="l9.10">     try {</span>
<a href="#l9.11"></a><span id="l9.11">         if (initialUri) {</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-            startFolder = MailUtils.getFolderForURI(initialUri);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+            startFolder = MailUtils.getOrCreateFolder(initialUri);</span>
<a href="#l9.14"></a><span id="l9.14">         } else {</span>
<a href="#l9.15"></a><span id="l9.15">             let defaultAccount = accountManager.defaultAccount;</span>
<a href="#l9.16"></a><span id="l9.16">             if (!defaultAccount)</span>
<a href="#l9.17"></a><span id="l9.17">                 return;</span>
<a href="#l9.18"></a><span id="l9.18"> </span>
<a href="#l9.19"></a><span id="l9.19">             defaultServer = defaultAccount.incomingServer;</span>
<a href="#l9.20"></a><span id="l9.20">             var rootMsgFolder = defaultServer.rootMsgFolder;</span>
<a href="#l9.21"></a><span id="l9.21"> </span>
<a href="#l9.22"></a><span id="l9.22" class="difflineat">@@ -1185,17 +1185,17 @@ function ThreadTreeOnClick(event) {</span>
<a href="#l9.23"></a><span id="l9.23">   }</span>
<a href="#l9.24"></a><span id="l9.24"> }</span>
<a href="#l9.25"></a><span id="l9.25"> </span>
<a href="#l9.26"></a><span id="l9.26"> function GetSelectedMsgFolders() {</span>
<a href="#l9.27"></a><span id="l9.27">   return gFolderTreeView.getSelectedFolders();</span>
<a href="#l9.28"></a><span id="l9.28"> }</span>
<a href="#l9.29"></a><span id="l9.29"> </span>
<a href="#l9.30"></a><span id="l9.30"> function SelectFolder(folderUri) {</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-  gFolderTreeView.selectFolder(MailUtils.getFolderForURI(folderUri));</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+  gFolderTreeView.selectFolder(MailUtils.getOrCreateFolder(folderUri));</span>
<a href="#l9.33"></a><span id="l9.33"> }</span>
<a href="#l9.34"></a><span id="l9.34"> </span>
<a href="#l9.35"></a><span id="l9.35"> function ReloadMessage() {</span>
<a href="#l9.36"></a><span id="l9.36">   if (!gFolderDisplay.selectedMessage)</span>
<a href="#l9.37"></a><span id="l9.37">     return;</span>
<a href="#l9.38"></a><span id="l9.38"> </span>
<a href="#l9.39"></a><span id="l9.39">   let view = gFolderDisplay.view.dbView;</span>
<a href="#l9.40"></a><span id="l9.40">   if (view)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/base/modules/MailUtils.jsm</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/base/modules/MailUtils.jsm</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -58,40 +58,39 @@ var MailUtils = {</span>
<a href="#l10.4"></a><span id="l10.4">     for (let folder of fixIterator(folders, Ci.nsIMsgFolder)) {</span>
<a href="#l10.5"></a><span id="l10.5">       if (folder.filePath.equals(aFile))</span>
<a href="#l10.6"></a><span id="l10.6">         return folder;</span>
<a href="#l10.7"></a><span id="l10.7">     }</span>
<a href="#l10.8"></a><span id="l10.8">     return null;</span>
<a href="#l10.9"></a><span id="l10.9">   },</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11">   /**</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-   * Get the nsIMsgFolder corresponding to this URI. This uses the RDF service</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-   * to do the work.</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+   * Get the nsIMsgFolder corresponding to this URI.</span>
<a href="#l10.15"></a><span id="l10.15">    *</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-   * @param aFolderURI the URI to convert into a folder</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-   * @param aCheckFolderAttributes whether to check that the folder either has</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">-   *                              a parent or isn't a server</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-   * @returns the nsIMsgFolder corresponding to this URI, or null if</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-   *          aCheckFolderAttributes is true and the folder doesn't have a</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-   *          parent or is a server</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+   * @param aFolderURI the URI of the target folder</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+   * @returns {nsIMsgFolder} Folder corresponding to this URI, or null if</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+   *          the folder doesn't already exist.</span>
<a href="#l10.25"></a><span id="l10.25">    */</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-  getFolderForURI(aFolderURI, aCheckFolderAttributes) {</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineminus">-    let folder = null;</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-    let rdfService = Cc[&quot;@mozilla.org/rdf/rdf-service;1&quot;]</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-                       .getService(Ci.nsIRDFService);</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-    folder = rdfService.GetResource(aFolderURI);</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-    // This is going to QI the folder to an nsIMsgFolder as well</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-    if (folder &amp;&amp; folder instanceof Ci.nsIMsgFolder) {</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineminus">-      if (aCheckFolderAttributes &amp;&amp; !(folder.parent || folder.isServer))</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-        return null;</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-    } else {</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">-      return null;</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-    }</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+  getExistingFolder(aFolderURI) {</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+    let fls = Cc[&quot;@mozilla.org/mail/folder-lookup;1&quot;]</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+                .getService(Ci.nsIFolderLookupService);</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+    return fls.getFolderForURL(aFolderURI);</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+  },</span>
<a href="#l10.43"></a><span id="l10.43"> </span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">-    return folder;</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+  /**</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+   * Get the nsIMsgFolder corresponding to this URI, or create a detached</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+   * folder if it doesn't already exist.</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+   *</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+   * @param aFolderURI the URI of the target folder</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+   * @returns {nsIMsgFolder} Folder corresponding to this URI.</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+   */</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+  getOrCreateFolder(aFolderURI) {</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+    let fls = Cc[&quot;@mozilla.org/mail/folder-lookup;1&quot;]</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+                .getService(Ci.nsIFolderLookupService);</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+    return fls.getOrCreateFolderForURL(aFolderURI);</span>
<a href="#l10.56"></a><span id="l10.56">   },</span>
<a href="#l10.57"></a><span id="l10.57"> </span>
<a href="#l10.58"></a><span id="l10.58">   /**</span>
<a href="#l10.59"></a><span id="l10.59">    * Display this message header in a new tab, a new window or an existing</span>
<a href="#l10.60"></a><span id="l10.60">    * window, depending on the preference and whether a 3pane or standalone</span>
<a href="#l10.61"></a><span id="l10.61">    * window is already open. This function should be called when you'd like to</span>
<a href="#l10.62"></a><span id="l10.62">    * display a message to the user according to the pref set.</span>
<a href="#l10.63"></a><span id="l10.63">    *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -4108,17 +4108,17 @@ function ComposeCanClose() {</span>
<a href="#l11.4"></a><span id="l11.4">   }</span>
<a href="#l11.5"></a><span id="l11.5"> </span>
<a href="#l11.6"></a><span id="l11.6">   // Returns FALSE only if user cancels save action</span>
<a href="#l11.7"></a><span id="l11.7">   if (gContentChanged || gMsgCompose.bodyModified || gAutoSaveKickedIn) {</span>
<a href="#l11.8"></a><span id="l11.8">     // call window.focus, since we need to pop up a dialog</span>
<a href="#l11.9"></a><span id="l11.9">     // and therefore need to be visible (to prevent user confusion)</span>
<a href="#l11.10"></a><span id="l11.10">     window.focus();</span>
<a href="#l11.11"></a><span id="l11.11">     let draftFolderURI = gCurrentIdentity.draftFolder;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-    let draftFolderName = MailUtils.getFolderForURI(draftFolderURI).prettyName;</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+    let draftFolderName = MailUtils.getOrCreateFolder(draftFolderURI).prettyName;</span>
<a href="#l11.14"></a><span id="l11.14">     let result = Services.prompt</span>
<a href="#l11.15"></a><span id="l11.15">                          .confirmEx(window,</span>
<a href="#l11.16"></a><span id="l11.16">                                     getComposeBundle().getString(&quot;saveDlogTitle&quot;),</span>
<a href="#l11.17"></a><span id="l11.17">                                     getComposeBundle().getFormattedString(&quot;saveDlogMessages3&quot;, [draftFolderName]),</span>
<a href="#l11.18"></a><span id="l11.18">                                     (Services.prompt.BUTTON_TITLE_SAVE * Services.prompt.BUTTON_POS_0) +</span>
<a href="#l11.19"></a><span id="l11.19">                                     (Services.prompt.BUTTON_TITLE_CANCEL * Services.prompt.BUTTON_POS_1) +</span>
<a href="#l11.20"></a><span id="l11.20">                                     (Services.prompt.BUTTON_TITLE_IS_STRING * Services.prompt.BUTTON_POS_2),</span>
<a href="#l11.21"></a><span id="l11.21">                                     null,</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineat">@@ -4159,33 +4159,34 @@ function ComposeCanClose() {</span>
<a href="#l11.23"></a><span id="l11.23"> </span>
<a href="#l11.24"></a><span id="l11.24">   return true;</span>
<a href="#l11.25"></a><span id="l11.25"> }</span>
<a href="#l11.26"></a><span id="l11.26"> </span>
<a href="#l11.27"></a><span id="l11.27"> function RemoveDraft() {</span>
<a href="#l11.28"></a><span id="l11.28">   try {</span>
<a href="#l11.29"></a><span id="l11.29">     var draftUri = gMsgCompose.compFields.draftId;</span>
<a href="#l11.30"></a><span id="l11.30">     var msgKey = draftUri.substr(draftUri.indexOf(&quot;#&quot;) + 1);</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-    var rdf = Cc[&quot;@mozilla.org/rdf/rdf-service;1&quot;]</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-                .getService(Ci.nsIRDFService);</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-    var folder = rdf.GetResource(gMsgCompose.savedFolderURI)</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">-                    .QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+    let folder = MailUtils.getExistingFolder(gMsgCompose.savedFolderURI);</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+    if (!folder)</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+      return;</span>
<a href="#l11.39"></a><span id="l11.39">     try {</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">-      if (folder.flags &amp; Ci.nsMsgFolderFlags.Drafts) {</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+      if (folder.getFlag(Ci.nsMsgFolderFlags.Drafts)) {</span>
<a href="#l11.42"></a><span id="l11.42">         var msgs = Cc[&quot;@mozilla.org/array;1&quot;].</span>
<a href="#l11.43"></a><span id="l11.43">             createInstance(Ci.nsIMutableArray);</span>
<a href="#l11.44"></a><span id="l11.44">         msgs.appendElement(folder.GetMessageHeader(msgKey));</span>
<a href="#l11.45"></a><span id="l11.45">         folder.deleteMessages(msgs, null, true, false, null, false);</span>
<a href="#l11.46"></a><span id="l11.46">       }</span>
<a href="#l11.47"></a><span id="l11.47">     } catch (ex) { // couldn't find header - perhaps an imap folder.</span>
<a href="#l11.48"></a><span id="l11.48">       var imapFolder = folder.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineminus">-      var keyArray = [];</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-      keyArray[0] = msgKey;</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineminus">-      imapFolder.storeImapFlags(8, true, keyArray, 1, null);</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+      if (imapFolder) {</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+        let keyArray = [];</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+        keyArray[0] = msgKey;</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+        imapFolder.storeImapFlags(Ci.nsMsgFolderFlags.Expunged,</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+                                  true, keyArray, 1, null);</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+      }</span>
<a href="#l11.58"></a><span id="l11.58">     }</span>
<a href="#l11.59"></a><span id="l11.59">   } catch (ex) {}</span>
<a href="#l11.60"></a><span id="l11.60"> }</span>
<a href="#l11.61"></a><span id="l11.61"> </span>
<a href="#l11.62"></a><span id="l11.62"> function SetContentAndBodyAsUnmodified() {</span>
<a href="#l11.63"></a><span id="l11.63">   gMsgCompose.bodyModified = false;</span>
<a href="#l11.64"></a><span id="l11.64">   gContentChanged = false;</span>
<a href="#l11.65"></a><span id="l11.65"> }</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineat">@@ -5975,17 +5976,17 @@ var attachmentBucketDNDObserver = {</span>
<a href="#l11.67"></a><span id="l11.67"> function DisplaySaveFolderDlg(folderURI) {</span>
<a href="#l11.68"></a><span id="l11.68">   try {</span>
<a href="#l11.69"></a><span id="l11.69">     var showDialog = gCurrentIdentity.showSaveMsgDlg;</span>
<a href="#l11.70"></a><span id="l11.70">   } catch (e) {</span>
<a href="#l11.71"></a><span id="l11.71">     return;</span>
<a href="#l11.72"></a><span id="l11.72">   }</span>
<a href="#l11.73"></a><span id="l11.73"> </span>
<a href="#l11.74"></a><span id="l11.74">   if (showDialog) {</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineminus">-    let msgfolder = MailUtils.getFolderForURI(folderURI, true);</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+    let msgfolder = MailUtils.getExistingFolder(folderURI);</span>
<a href="#l11.77"></a><span id="l11.77">     if (!msgfolder)</span>
<a href="#l11.78"></a><span id="l11.78">       return;</span>
<a href="#l11.79"></a><span id="l11.79">     let checkbox = {value: 0};</span>
<a href="#l11.80"></a><span id="l11.80">     let bundle = getComposeBundle();</span>
<a href="#l11.81"></a><span id="l11.81">     let SaveDlgTitle = bundle.getString(&quot;SaveDialogTitle&quot;);</span>
<a href="#l11.82"></a><span id="l11.82">     let dlgMsg = bundle.getFormattedString(&quot;SaveDialogMsg&quot;,</span>
<a href="#l11.83"></a><span id="l11.83">                                            [msgfolder.name,</span>
<a href="#l11.84"></a><span id="l11.84">                                             msgfolder.server.prettyName]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-message-commands.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-message-commands.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -371,18 +371,18 @@ function yearly_archive(keep_structure) </span>
<a href="#l12.4"></a><span id="l12.4">   // Figure out where the messages should have gone.</span>
<a href="#l12.5"></a><span id="l12.5">   let archiveRoot = &quot;mailbox://nobody@Local%20Folders/Archives&quot;;</span>
<a href="#l12.6"></a><span id="l12.6">   let firstArchiveUri = archiveRoot + &quot;/&quot; + firstMsgYear;</span>
<a href="#l12.7"></a><span id="l12.7">   let lastArchiveUri = archiveRoot + &quot;/&quot; + lastMsgYear;</span>
<a href="#l12.8"></a><span id="l12.8">   if (keep_structure) {</span>
<a href="#l12.9"></a><span id="l12.9">     firstArchiveUri += &quot;/ArchiveSrc&quot;;</span>
<a href="#l12.10"></a><span id="l12.10">     lastArchiveUri += &quot;/ArchiveSrc&quot;;</span>
<a href="#l12.11"></a><span id="l12.11">   }</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-  let firstArchiveFolder =  MailUtils.getFolderForURI(firstArchiveUri);</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-  let lastArchiveFolder = MailUtils.getFolderForURI(lastArchiveUri);</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+  let firstArchiveFolder =  MailUtils.getOrCreateFolder(firstArchiveUri);</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+  let lastArchiveFolder = MailUtils.getOrCreateFolder(lastArchiveUri);</span>
<a href="#l12.16"></a><span id="l12.16">   be_in_folder(firstArchiveFolder);</span>
<a href="#l12.17"></a><span id="l12.17">   assert_true(mc.dbView.getMsgHdrAt(0).messageId == firstMsgHdrMsgId,</span>
<a href="#l12.18"></a><span id="l12.18">               &quot;Message should have been archived to &quot; + firstArchiveUri + &quot;, but it isn't present there&quot;);</span>
<a href="#l12.19"></a><span id="l12.19">   be_in_folder(lastArchiveFolder);</span>
<a href="#l12.20"></a><span id="l12.20"> </span>
<a href="#l12.21"></a><span id="l12.21">   assert_true(mc.dbView.getMsgHdrAt(0).messageId == lastMsgHdrMsgId,</span>
<a href="#l12.22"></a><span id="l12.22">               &quot;Message should have been archived to &quot; + lastArchiveUri + &quot;, but it isn't present there&quot;);</span>
<a href="#l12.23"></a><span id="l12.23"> }</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineat">@@ -419,18 +419,18 @@ function monthly_archive(keep_structure)</span>
<a href="#l12.25"></a><span id="l12.25">   let firstArchiveUri = archiveRoot + &quot;/&quot; + firstMsgYear +</span>
<a href="#l12.26"></a><span id="l12.26">                         &quot;/&quot; + firstMonthFolderName;</span>
<a href="#l12.27"></a><span id="l12.27">   let lastArchiveUri = archiveRoot + &quot;/&quot; + lastMsgYear +</span>
<a href="#l12.28"></a><span id="l12.28">                         &quot;/&quot; + lastMonthFolderName;</span>
<a href="#l12.29"></a><span id="l12.29">   if (keep_structure) {</span>
<a href="#l12.30"></a><span id="l12.30">     firstArchiveUri += &quot;/ArchiveSrc&quot;;</span>
<a href="#l12.31"></a><span id="l12.31">     lastArchiveUri += &quot;/ArchiveSrc&quot;;</span>
<a href="#l12.32"></a><span id="l12.32">   }</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-  let firstArchiveFolder =  MailUtils.getFolderForURI(firstArchiveUri);</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineminus">-  let lastArchiveFolder = MailUtils.getFolderForURI(lastArchiveUri);</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+  let firstArchiveFolder = MailUtils.getOrCreateFolder(firstArchiveUri);</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+  let lastArchiveFolder = MailUtils.getOrCreateFolder(lastArchiveUri);</span>
<a href="#l12.37"></a><span id="l12.37">   be_in_folder(firstArchiveFolder);</span>
<a href="#l12.38"></a><span id="l12.38">   assert_true(mc.dbView.getMsgHdrAt(0).messageId == firstMsgHdrMsgId,</span>
<a href="#l12.39"></a><span id="l12.39">               &quot;Message should have been archived to Local Folders/&quot; +</span>
<a href="#l12.40"></a><span id="l12.40">               firstMsgYear + &quot;/&quot; + firstMonthFolderName + &quot;/Archives, but it isn't present there&quot;);</span>
<a href="#l12.41"></a><span id="l12.41">   be_in_folder(lastArchiveFolder);</span>
<a href="#l12.42"></a><span id="l12.42">   assert_true(mc.dbView.getMsgHdrAt(0).messageId == lastMsgHdrMsgId,</span>
<a href="#l12.43"></a><span id="l12.43">               &quot;Message should have been archived to Local Folders/&quot; +</span>
<a href="#l12.44"></a><span id="l12.44">               lastMsgYear + &quot;/&quot; + lastMonthFolderName + &quot;/Archives, but it isn't present there&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/test/mozmill/folder-pane/test-folder-pane.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/test/mozmill/folder-pane/test-folder-pane.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -10,16 +10,17 @@</span>
<a href="#l13.4"></a><span id="l13.4"> </span>
<a href="#l13.5"></a><span id="l13.5"> &quot;use strict&quot;;</span>
<a href="#l13.6"></a><span id="l13.6"> </span>
<a href="#l13.7"></a><span id="l13.7"> var MODULE_NAME = 'test-folder-pane';</span>
<a href="#l13.8"></a><span id="l13.8"> </span>
<a href="#l13.9"></a><span id="l13.9"> var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l13.10"></a><span id="l13.10"> var MODULE_REQUIRES = ['folder-display-helpers'];</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l13.13"></a><span id="l13.13"> ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l13.14"></a><span id="l13.14"> </span>
<a href="#l13.15"></a><span id="l13.15"> function setupModule(module) {</span>
<a href="#l13.16"></a><span id="l13.16">   collector.getModule('folder-display-helpers').installInto(module);</span>
<a href="#l13.17"></a><span id="l13.17"> }</span>
<a href="#l13.18"></a><span id="l13.18"> </span>
<a href="#l13.19"></a><span id="l13.19"> /**</span>
<a href="#l13.20"></a><span id="l13.20">  * Assert the Folder Pane is in All Folder mode by default.  Check that the</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineat">@@ -46,20 +47,17 @@ function test_all_folders_toggle_folder_</span>
<a href="#l13.22"></a><span id="l13.22">   let archives = 1;</span>
<a href="#l13.23"></a><span id="l13.23">   let folderPaneA = 1;</span>
<a href="#l13.24"></a><span id="l13.24">   // Create archives folder - this is ugly, but essentially the same as</span>
<a href="#l13.25"></a><span id="l13.25">   // what mailWindowOverlay.js does. We can't use the built-in helper</span>
<a href="#l13.26"></a><span id="l13.26">   // method to create the folder because we need the archive flag to get</span>
<a href="#l13.27"></a><span id="l13.27">   // set before the folder added notification is sent out, which means</span>
<a href="#l13.28"></a><span id="l13.28">   // creating the folder object via RDF, setting the flag, and then</span>
<a href="#l13.29"></a><span id="l13.29">   // creating the storage, which sends the notification.</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">-  let rdfService = Cc['@mozilla.org/rdf/rdf-service;1']</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-                     .getService(Ci.nsIRDFService);</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-  let folder = rdfService.GetResource(pop3Server.rootFolder.URI + &quot;/Archives&quot;)</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-                         .QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+  let folder = MailUtils.getOrCreateFolder(pop3Server.rootFolder.URI + &quot;/Archives&quot;);</span>
<a href="#l13.35"></a><span id="l13.35">   folder.setFlag(Ci.nsMsgFolderFlags.Archive);</span>
<a href="#l13.36"></a><span id="l13.36">   folder.createStorageIfMissing(null);</span>
<a href="#l13.37"></a><span id="l13.37">   // After creating Archives, account should have expanded</span>
<a href="#l13.38"></a><span id="l13.38">   // so that we should have 5 rows visible</span>
<a href="#l13.39"></a><span id="l13.39">   assert_folder_tree_view_row_count(accounts + inbox + trash +</span>
<a href="#l13.40"></a><span id="l13.40">                                     archives);</span>
<a href="#l13.41"></a><span id="l13.41">   // close the tinderbox server.</span>
<a href="#l13.42"></a><span id="l13.42">   mc.folderTreeView.toggleOpenState(0)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/base/content/junkCommands.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/base/content/junkCommands.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -64,17 +64,17 @@ function determineActionsForJunkMsgs(aFo</span>
<a href="#l14.4"></a><span id="l14.4">     if (!spamFolderURI)</span>
<a href="#l14.5"></a><span id="l14.5">     {</span>
<a href="#l14.6"></a><span id="l14.6">       // XXX TODO</span>
<a href="#l14.7"></a><span id="l14.7">       // we should use nsIPromptService to inform the user of the problem,</span>
<a href="#l14.8"></a><span id="l14.8">       // e.g. when the junk folder was accidentally deleted.</span>
<a href="#l14.9"></a><span id="l14.9">       dump('determineActionsForJunkMsgs: no spam folder found, not moving.');</span>
<a href="#l14.10"></a><span id="l14.10">     }</span>
<a href="#l14.11"></a><span id="l14.11">     else</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-      actions.junkTargetFolder = MailUtils.getFolderForURI(spamFolderURI);</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+      actions.junkTargetFolder = MailUtils.getOrCreateFolder(spamFolderURI);</span>
<a href="#l14.14"></a><span id="l14.14">   }</span>
<a href="#l14.15"></a><span id="l14.15"> </span>
<a href="#l14.16"></a><span id="l14.16">   return actions;</span>
<a href="#l14.17"></a><span id="l14.17"> }</span>
<a href="#l14.18"></a><span id="l14.18"> </span>
<a href="#l14.19"></a><span id="l14.19"> /**</span>
<a href="#l14.20"></a><span id="l14.20">  * performActionsOnJunkMsgs</span>
<a href="#l14.21"></a><span id="l14.21">  *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/base/content/msgFolderPickerOverlay.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/base/content/msgFolderPickerOverlay.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -19,17 +19,17 @@ function MsgFolderPickerOnLoad(pickerID)</span>
<a href="#l15.4"></a><span id="l15.4">   }</span>
<a href="#l15.5"></a><span id="l15.5"> </span>
<a href="#l15.6"></a><span id="l15.6">   if (uri) {</span>
<a href="#l15.7"></a><span id="l15.7">     //dump(&quot;on loading, set titled button to &quot; + uri + &quot;\n&quot;);</span>
<a href="#l15.8"></a><span id="l15.8"> </span>
<a href="#l15.9"></a><span id="l15.9">     // verify that the value we are attempting to</span>
<a href="#l15.10"></a><span id="l15.10">     // pre-flight the menu with is valid for this</span>
<a href="#l15.11"></a><span id="l15.11">     // picker type</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-    var msgfolder = MailUtils.getFolderForURI(uri, true);</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+    var msgfolder = MailUtils.getExistingFolder(uri);</span>
<a href="#l15.14"></a><span id="l15.14">           if (!msgfolder) return;</span>
<a href="#l15.15"></a><span id="l15.15">     </span>
<a href="#l15.16"></a><span id="l15.16">     var verifyFunction = null;</span>
<a href="#l15.17"></a><span id="l15.17"> </span>
<a href="#l15.18"></a><span id="l15.18">     switch (pickerID) {</span>
<a href="#l15.19"></a><span id="l15.19">       case &quot;msgNewFolderPicker&quot;:</span>
<a href="#l15.20"></a><span id="l15.20">         verifyFunction = msgfolder.canCreateSubfolders;</span>
<a href="#l15.21"></a><span id="l15.21">         break;</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineat">@@ -50,17 +50,17 @@ function MsgFolderPickerOnLoad(pickerID)</span>
<a href="#l15.23"></a><span id="l15.23"> function PickedMsgFolder(selection,pickerID)</span>
<a href="#l15.24"></a><span id="l15.24"> {</span>
<a href="#l15.25"></a><span id="l15.25">   var selectedUri = selection.getAttribute('id');</span>
<a href="#l15.26"></a><span id="l15.26">   SetFolderPicker(selectedUri,pickerID);</span>
<a href="#l15.27"></a><span id="l15.27"> }</span>
<a href="#l15.28"></a><span id="l15.28"> </span>
<a href="#l15.29"></a><span id="l15.29"> function SetFolderPickerElement(uri, picker)</span>
<a href="#l15.30"></a><span id="l15.30"> {</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-  var msgfolder = MailUtils.getFolderForURI(uri, true);</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+  var msgfolder = MailUtils.getExistingFolder(uri);</span>
<a href="#l15.33"></a><span id="l15.33"> </span>
<a href="#l15.34"></a><span id="l15.34">   if (!msgfolder)</span>
<a href="#l15.35"></a><span id="l15.35">     return;</span>
<a href="#l15.36"></a><span id="l15.36"> </span>
<a href="#l15.37"></a><span id="l15.37">   var selectedValue = null;</span>
<a href="#l15.38"></a><span id="l15.38">   var serverName;</span>
<a href="#l15.39"></a><span id="l15.39"> </span>
<a href="#l15.40"></a><span id="l15.40">   if (msgfolder.isServer)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/base/content/msgSynchronize.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/base/content/msgSynchronize.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -1,13 +1,14 @@</span>
<a href="#l16.4"></a><span id="l16.4"> /* -*- Mode: Java; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l16.5"></a><span id="l16.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l16.6"></a><span id="l16.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.7"></a><span id="l16.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.8"></a><span id="l16.8"> </span>
<a href="#l16.9"></a><span id="l16.9" class="difflineplus">+ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l16.10"></a><span id="l16.10"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12"> var gSynchronizeTree = null;</span>
<a href="#l16.13"></a><span id="l16.13"> var gParentMsgWindow;</span>
<a href="#l16.14"></a><span id="l16.14"> var gMsgWindow;</span>
<a href="#l16.15"></a><span id="l16.15"> </span>
<a href="#l16.16"></a><span id="l16.16"> var gInitialFolderStates = {};</span>
<a href="#l16.17"></a><span id="l16.17"> </span>
<a href="#l16.18"></a><span id="l16.18" class="difflineat">@@ -64,21 +65,18 @@ function OnSelect()</span>
<a href="#l16.19"></a><span id="l16.19"> </span>
<a href="#l16.20"></a><span id="l16.20"> function selectOkButton()</span>
<a href="#l16.21"></a><span id="l16.21"> {</span>
<a href="#l16.22"></a><span id="l16.22">     return true;</span>
<a href="#l16.23"></a><span id="l16.23"> }</span>
<a href="#l16.24"></a><span id="l16.24"> </span>
<a href="#l16.25"></a><span id="l16.25"> function selectCancelButton()</span>
<a href="#l16.26"></a><span id="l16.26"> {</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineminus">-    var RDF = Cc[&quot;@mozilla.org/rdf/rdf-service;1&quot;]</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineminus">-                .getService(Ci.nsIRDFService);</span>
<a href="#l16.29"></a><span id="l16.29">     for (var resourceValue in gInitialFolderStates) {</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineminus">-      var resource = RDF.GetResource(resourceValue);</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-      var folder = resource.QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+      let folder = MailUtils.getExistingFolder(resourceValue);</span>
<a href="#l16.33"></a><span id="l16.33">       if (gInitialFolderStates[resourceValue])</span>
<a href="#l16.34"></a><span id="l16.34">         folder.setFlag(Ci.nsMsgFolderFlags.Offline);</span>
<a href="#l16.35"></a><span id="l16.35">       else</span>
<a href="#l16.36"></a><span id="l16.36">         folder.clearFlag(Ci.nsMsgFolderFlags.Offline);</span>
<a href="#l16.37"></a><span id="l16.37">     }</span>
<a href="#l16.38"></a><span id="l16.38">     return true;</span>
<a href="#l16.39"></a><span id="l16.39"> }</span>
<a href="#l16.40"></a><span id="l16.40"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/base/content/subscribe.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/base/content/subscribe.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -27,17 +27,17 @@ function Stop()</span>
<a href="#l17.4"></a><span id="l17.4">   }</span>
<a href="#l17.5"></a><span id="l17.5"> }</span>
<a href="#l17.6"></a><span id="l17.6"> </span>
<a href="#l17.7"></a><span id="l17.7"> function SetServerTypeSpecificTextValues()</span>
<a href="#l17.8"></a><span id="l17.8"> {</span>
<a href="#l17.9"></a><span id="l17.9">   if (!gServerURI)</span>
<a href="#l17.10"></a><span id="l17.10">     return;</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-  let serverType = MailUtils.getFolderForURI(gServerURI, true).server.type;</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+  let serverType = MailUtils.getExistingFolder(gServerURI).server.type;</span>
<a href="#l17.14"></a><span id="l17.14"> </span>
<a href="#l17.15"></a><span id="l17.15">   // set the server specific ui elements</span>
<a href="#l17.16"></a><span id="l17.16">   let subscribeLabelString = gSubscribeBundle.getString(&quot;subscribeLabel-&quot; + serverType);</span>
<a href="#l17.17"></a><span id="l17.17">   let currentListTab  = &quot;currentListTab-&quot; + serverType;</span>
<a href="#l17.18"></a><span id="l17.18">   let currentListTabLabel     = gSubscribeBundle.getString(currentListTab + &quot;.label&quot;);</span>
<a href="#l17.19"></a><span id="l17.19">   let currentListTabAccesskey = gSubscribeBundle.getString(currentListTab + &quot;.accesskey&quot;);</span>
<a href="#l17.20"></a><span id="l17.20"> </span>
<a href="#l17.21"></a><span id="l17.21">   document.getElementById(&quot;currentListTab&quot;).setAttribute(&quot;label&quot;, currentListTabLabel);</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineat">@@ -66,17 +66,17 @@ var MySubscribeListener = {</span>
<a href="#l17.23"></a><span id="l17.23">   }</span>
<a href="#l17.24"></a><span id="l17.24"> };</span>
<a href="#l17.25"></a><span id="l17.25"> </span>
<a href="#l17.26"></a><span id="l17.26"> function SetUpTree(forceToServer, getOnlyNew)</span>
<a href="#l17.27"></a><span id="l17.27"> {</span>
<a href="#l17.28"></a><span id="l17.28">   if (!gServerURI)</span>
<a href="#l17.29"></a><span id="l17.29">     return;</span>
<a href="#l17.30"></a><span id="l17.30"> </span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">-  var server = MailUtils.getFolderForURI(gServerURI, true).server;</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+  var server = MailUtils.getExistingFolder(gServerURI).server;</span>
<a href="#l17.33"></a><span id="l17.33">   try</span>
<a href="#l17.34"></a><span id="l17.34">   {</span>
<a href="#l17.35"></a><span id="l17.35">     CleanUpSearchView();</span>
<a href="#l17.36"></a><span id="l17.36">     gSubscribableServer = server.QueryInterface(Ci.nsISubscribableServer);</span>
<a href="#l17.37"></a><span id="l17.37"> </span>
<a href="#l17.38"></a><span id="l17.38">     // enable (or disable) the search related UI</span>
<a href="#l17.39"></a><span id="l17.39">     EnableSearchUI();</span>
<a href="#l17.40"></a><span id="l17.40"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/base/content/virtualFolderListEdit.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/base/content/virtualFolderListEdit.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -1,23 +1,23 @@</span>
<a href="#l18.4"></a><span id="l18.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l18.5"></a><span id="l18.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l18.6"></a><span id="l18.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l18.7"></a><span id="l18.7"> </span>
<a href="#l18.8"></a><span id="l18.8" class="difflineplus">+ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l18.9"></a><span id="l18.9" class="difflineplus">+</span>
<a href="#l18.10"></a><span id="l18.10"> var gSelectVirtual = {</span>
<a href="#l18.11"></a><span id="l18.11">   _treeElement: null,</span>
<a href="#l18.12"></a><span id="l18.12">   _selectedList: new Set(),</span>
<a href="#l18.13"></a><span id="l18.13"> </span>
<a href="#l18.14"></a><span id="l18.14">   load: function() {</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineminus">-    let folderLookup = Cc[&quot;@mozilla.org/mail/folder-lookup;1&quot;]</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineminus">-                         .getService(Ci.nsIFolderLookupService);</span>
<a href="#l18.17"></a><span id="l18.17">     if (window.arguments[0].searchFolderURIs) {</span>
<a href="#l18.18"></a><span id="l18.18">       let srchFolderUriArray = window.arguments[0].searchFolderURIs.split('|');</span>
<a href="#l18.19"></a><span id="l18.19">       for (let uri of srchFolderUriArray) {</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineminus">-        this._selectedList.add(folderLookup.getFolderForURL(uri));</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineplus">+        this._selectedList.add(MailUtils.getOrCreateFolder(uri));</span>
<a href="#l18.22"></a><span id="l18.22">       }</span>
<a href="#l18.23"></a><span id="l18.23">     }</span>
<a href="#l18.24"></a><span id="l18.24"> </span>
<a href="#l18.25"></a><span id="l18.25">     // Now tweak the folder tree for our purposes here.</span>
<a href="#l18.26"></a><span id="l18.26">     let oldProps = ftvItem.prototype.getProperties;</span>
<a href="#l18.27"></a><span id="l18.27">     ftvItem.prototype.getProperties = function(aColumn) {</span>
<a href="#l18.28"></a><span id="l18.28">       if (!aColumn || aColumn.id != &quot;selectedCol&quot;)</span>
<a href="#l18.29"></a><span id="l18.29">         return oldProps.call(this, aColumn);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/base/content/virtualFolderProperties.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/base/content/virtualFolderProperties.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -101,17 +101,17 @@ function setupSearchRows(aSearchTerms)</span>
<a href="#l19.4"></a><span id="l19.4"> function updateOnlineSearchState()</span>
<a href="#l19.5"></a><span id="l19.5"> {</span>
<a href="#l19.6"></a><span id="l19.6">   var enableCheckbox = false;</span>
<a href="#l19.7"></a><span id="l19.7">   var checkbox = document.getElementById('searchOnline');</span>
<a href="#l19.8"></a><span id="l19.8">   // only enable the checkbox for selection, for online servers</span>
<a href="#l19.9"></a><span id="l19.9">   var srchFolderUriArray = gSearchFolderURIs.split('|');</span>
<a href="#l19.10"></a><span id="l19.10">   if (srchFolderUriArray[0])</span>
<a href="#l19.11"></a><span id="l19.11">   {</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-    var realFolder = MailUtils.getFolderForURI(srchFolderUriArray[0]);</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+    var realFolder = MailUtils.getOrCreateFolder(srchFolderUriArray[0]);</span>
<a href="#l19.14"></a><span id="l19.14">     enableCheckbox =  realFolder.server.offlineSupportLevel; // anything greater than 0 is an online server like IMAP or news</span>
<a href="#l19.15"></a><span id="l19.15">   }</span>
<a href="#l19.16"></a><span id="l19.16"> </span>
<a href="#l19.17"></a><span id="l19.17">   if (enableCheckbox)</span>
<a href="#l19.18"></a><span id="l19.18">     checkbox.removeAttribute('disabled');</span>
<a href="#l19.19"></a><span id="l19.19">   else</span>
<a href="#l19.20"></a><span id="l19.20">   {</span>
<a href="#l19.21"></a><span id="l19.21">     checkbox.setAttribute('disabled', true);</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineat">@@ -181,17 +181,17 @@ function onOK()</span>
<a href="#l19.23"></a><span id="l19.23">     if (window.arguments[0].onOKCallback)</span>
<a href="#l19.24"></a><span id="l19.24">       window.arguments[0].onOKCallback(virtualFolderWrapper.virtualFolder.URI);</span>
<a href="#l19.25"></a><span id="l19.25">     return true;</span>
<a href="#l19.26"></a><span id="l19.26">   }</span>
<a href="#l19.27"></a><span id="l19.27">   var uri = gPickedFolder.URI;</span>
<a href="#l19.28"></a><span id="l19.28">   if (name &amp;&amp; uri) // create a new virtual folder</span>
<a href="#l19.29"></a><span id="l19.29">   {</span>
<a href="#l19.30"></a><span id="l19.30">     // check to see if we already have a folder with the same name and alert the user if so...</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">-    var parentFolder = MailUtils.getFolderForURI(uri);</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineplus">+    var parentFolder = MailUtils.getOrCreateFolder(uri);</span>
<a href="#l19.33"></a><span id="l19.33"> </span>
<a href="#l19.34"></a><span id="l19.34">     // sanity check the name based on the logic used by nsMsgBaseUtils.cpp. It can't start with a '.', it can't end with a '.', '~' or ' '.</span>
<a href="#l19.35"></a><span id="l19.35">     // it can't contain a ';' or '#'.</span>
<a href="#l19.36"></a><span id="l19.36">     if (/^\.|[\.\~ ]$|[\;\#]/.test(name))</span>
<a href="#l19.37"></a><span id="l19.37">     {</span>
<a href="#l19.38"></a><span id="l19.38">       Services.prompt.alert(window, null,</span>
<a href="#l19.39"></a><span id="l19.39">                             gMessengerBundle.getString(&quot;folderCreationFailed&quot;));</span>
<a href="#l19.40"></a><span id="l19.40">       return false;</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineat">@@ -243,17 +243,17 @@ function updateFoldersCount()</span>
<a href="#l19.42"></a><span id="l19.42">   let folderCount = gSearchFolderURIs ? srchFolderUriArray.length : 0;</span>
<a href="#l19.43"></a><span id="l19.43">   let foldersList = document.getElementById(&quot;chosenFoldersCount&quot;);</span>
<a href="#l19.44"></a><span id="l19.44">   foldersList.textContent =</span>
<a href="#l19.45"></a><span id="l19.45">     PluralForm.get(folderCount, gMessengerBundle.getString(&quot;virtualFolderSourcesChosen&quot;))</span>
<a href="#l19.46"></a><span id="l19.46">               .replace(&quot;#1&quot;, folderCount);</span>
<a href="#l19.47"></a><span id="l19.47">   if (folderCount &gt; 0) {</span>
<a href="#l19.48"></a><span id="l19.48">     let folderNames = [];</span>
<a href="#l19.49"></a><span id="l19.49">     for (let folderURI of srchFolderUriArray) {</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineminus">-      let folder = MailUtils.getFolderForURI(folderURI);</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineplus">+      let folder = MailUtils.getOrCreateFolder(folderURI);</span>
<a href="#l19.52"></a><span id="l19.52">       let name = this.gMessengerBundle.getFormattedString(&quot;verboseFolderFormat&quot;,</span>
<a href="#l19.53"></a><span id="l19.53">         [folder.prettyName, folder.server.prettyName]);</span>
<a href="#l19.54"></a><span id="l19.54">       folderNames.push(name);</span>
<a href="#l19.55"></a><span id="l19.55">     }</span>
<a href="#l19.56"></a><span id="l19.56">     foldersList.setAttribute(&quot;tooltiptext&quot;, folderNames.join(&quot;\n&quot;));</span>
<a href="#l19.57"></a><span id="l19.57">   } else {</span>
<a href="#l19.58"></a><span id="l19.58">     foldersList.removeAttribute(&quot;tooltiptext&quot;);</span>
<a href="#l19.59"></a><span id="l19.59">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-copies.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-copies.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -109,21 +109,21 @@ function SetFolderDisplay(pickerMode, di</span>
<a href="#l20.4"></a><span id="l20.4">     var selectAccountRadioElem = document.getElementById(selectAccountRadioId);</span>
<a href="#l20.5"></a><span id="l20.5">     var selectFolderRadioId = radioElemPrefix + &quot;_selectFolder&quot;;</span>
<a href="#l20.6"></a><span id="l20.6">     var selectFolderRadioElem = document.getElementById(selectFolderRadioId);</span>
<a href="#l20.7"></a><span id="l20.7">     var accountPicker = document.getElementById(accountPickerId);</span>
<a href="#l20.8"></a><span id="l20.8">     var folderPicker = document.getElementById(folderPickerId);</span>
<a href="#l20.9"></a><span id="l20.9">     var rg = selectAccountRadioElem.radioGroup;</span>
<a href="#l20.10"></a><span id="l20.10">     var folderPickedElement = document.getElementById(folderPickedField);</span>
<a href="#l20.11"></a><span id="l20.11">     var uri = folderPickedElement.getAttribute(&quot;value&quot;);</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-    // Get message folder from the given uri. Second argument (false) signifies</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-    // that there is no need to check for the existence of special folders as</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+    // Get message folder from the given uri.</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+    // There is no need to check for the existence of special folders as</span>
<a href="#l20.16"></a><span id="l20.16">     // these folders are created on demand at runtime in case of imap accounts.</span>
<a href="#l20.17"></a><span id="l20.17">     // For POP3 accounts, special folders are created at the account creation time.</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineminus">-    var msgFolder = MailUtils.getFolderForURI(uri, false);</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineplus">+    var msgFolder = MailUtils.getOrCreateFolder(uri);</span>
<a href="#l20.20"></a><span id="l20.20">     InitFolderDisplay(msgFolder.server.rootFolder, accountPicker);</span>
<a href="#l20.21"></a><span id="l20.21">     InitFolderDisplay(msgFolder, folderPicker);</span>
<a href="#l20.22"></a><span id="l20.22"> </span>
<a href="#l20.23"></a><span id="l20.23">     switch (pickerMode)</span>
<a href="#l20.24"></a><span id="l20.24">     {</span>
<a href="#l20.25"></a><span id="l20.25">         case &quot;0&quot; :</span>
<a href="#l20.26"></a><span id="l20.26">             rg.selectedItem = selectAccountRadioElem;</span>
<a href="#l20.27"></a><span id="l20.27">             SetPickerEnabling(accountPickerId, folderPickerId);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-junk.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-junk.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -33,27 +33,27 @@ function onInit(aPageId, aServerId)</span>
<a href="#l21.4"></a><span id="l21.4">   let moveOnSpamValue = moveOnSpamCheckbox.checked;</span>
<a href="#l21.5"></a><span id="l21.5"> </span>
<a href="#l21.6"></a><span id="l21.6">   // Check if there are any invalid junk targets and fix them.</span>
<a href="#l21.7"></a><span id="l21.7">   [ spamActionTargetAccount, spamActionTargetFolder, moveOnSpamValue ] =</span>
<a href="#l21.8"></a><span id="l21.8">     sanitizeJunkTargets(spamActionTargetAccount,</span>
<a href="#l21.9"></a><span id="l21.9">                         spamActionTargetFolder,</span>
<a href="#l21.10"></a><span id="l21.10">                         deferredToURI || aServerId,</span>
<a href="#l21.11"></a><span id="l21.11">                         document.getElementById(&quot;server.moveTargetMode&quot;).value,</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-                        MailUtils.getFolderForURI(aServerId, false).server.spamSettings,</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+                        MailUtils.getOrCreateFolder(aServerId).server.spamSettings,</span>
<a href="#l21.14"></a><span id="l21.14">                         moveOnSpamValue);</span>
<a href="#l21.15"></a><span id="l21.15"> </span>
<a href="#l21.16"></a><span id="l21.16">   spamActionTargetAccountElement.value = spamActionTargetAccount;</span>
<a href="#l21.17"></a><span id="l21.17">   spamActionTargetFolderElement.value = spamActionTargetFolder;</span>
<a href="#l21.18"></a><span id="l21.18">   moveOnSpamCheckbox.checked = moveOnSpamValue;</span>
<a href="#l21.19"></a><span id="l21.19"> </span>
<a href="#l21.20"></a><span id="l21.20" class="difflineminus">-  let server = MailUtils.getFolderForURI(spamActionTargetAccount, false);</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineplus">+  let server = MailUtils.getOrCreateFolder(spamActionTargetAccount);</span>
<a href="#l21.22"></a><span id="l21.22">   document.getElementById(&quot;actionAccountPopup&quot;).selectFolder(server);</span>
<a href="#l21.23"></a><span id="l21.23"> </span>
<a href="#l21.24"></a><span id="l21.24" class="difflineminus">-  let folder = MailUtils.getFolderForURI(spamActionTargetFolder, true);</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineplus">+  let folder = MailUtils.getExistingFolder(spamActionTargetFolder);</span>
<a href="#l21.26"></a><span id="l21.26">   document.getElementById(&quot;actionFolderPopup&quot;).selectFolder(folder);</span>
<a href="#l21.27"></a><span id="l21.27"> </span>
<a href="#l21.28"></a><span id="l21.28">   var currentArray = [];</span>
<a href="#l21.29"></a><span id="l21.29">   if (document.getElementById(&quot;server.useWhiteList&quot;).checked)</span>
<a href="#l21.30"></a><span id="l21.30">     currentArray = document.getElementById(&quot;server.whiteListAbURI&quot;).value.split(&quot; &quot;);</span>
<a href="#l21.31"></a><span id="l21.31"> </span>
<a href="#l21.32"></a><span id="l21.32">   // set up the whitelist UI</span>
<a href="#l21.33"></a><span id="l21.33">   var wList = document.getElementById(&quot;whiteListAbURI&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-server.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-server.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -373,27 +373,27 @@ function setupImapDeleteUI(aServerId)</span>
<a href="#l22.4"></a><span id="l22.4">   selectImapDeleteModel(deleteModel);</span>
<a href="#l22.5"></a><span id="l22.5"> </span>
<a href="#l22.6"></a><span id="l22.6">   // read trash folder path preference</span>
<a href="#l22.7"></a><span id="l22.7">   var trashFolderName = getTrashFolderName();</span>
<a href="#l22.8"></a><span id="l22.8"> </span>
<a href="#l22.9"></a><span id="l22.9">   // set folderPicker menulist</span>
<a href="#l22.10"></a><span id="l22.10">   var trashPopup = document.getElementById(&quot;msgTrashFolderPopup&quot;);</span>
<a href="#l22.11"></a><span id="l22.11">   trashPopup._teardown();</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-  trashPopup._parentFolder = MailUtils.getFolderForURI(aServerId);</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+  trashPopup._parentFolder = MailUtils.getOrCreateFolder(aServerId);</span>
<a href="#l22.14"></a><span id="l22.14">   trashPopup._ensureInitialized();</span>
<a href="#l22.15"></a><span id="l22.15"> </span>
<a href="#l22.16"></a><span id="l22.16">   // Convert the folder path in Unicode to MUTF-7.</span>
<a href="#l22.17"></a><span id="l22.17">   let manager = Cc['@mozilla.org/charset-converter-manager;1']</span>
<a href="#l22.18"></a><span id="l22.18">                   .getService(Ci.nsICharsetConverterManager);</span>
<a href="#l22.19"></a><span id="l22.19">   // Escape backslash and double-quote with another backslash before encoding.</span>
<a href="#l22.20"></a><span id="l22.20">   let trashMutf7 = manager.unicodeToMutf7(trashFolderName.replace(/([\\&quot;])/g, '\\$1'));</span>
<a href="#l22.21"></a><span id="l22.21">   // TODO: There is something wrong here, selectFolder() fails even if the</span>
<a href="#l22.22"></a><span id="l22.22">   // folder does exist. Try to fix in bug 802609.</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineminus">-  let trashFolder = MailUtils.getFolderForURI(aServerId + &quot;/&quot; + trashMutf7, false);</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineplus">+  let trashFolder = MailUtils.getOrCreateFolder(aServerId + &quot;/&quot; + trashMutf7);</span>
<a href="#l22.25"></a><span id="l22.25">   try {</span>
<a href="#l22.26"></a><span id="l22.26">     trashPopup.selectFolder(trashFolder);</span>
<a href="#l22.27"></a><span id="l22.27">   } catch(ex) {</span>
<a href="#l22.28"></a><span id="l22.28">     trashPopup.parentNode.setAttribute(&quot;label&quot;, trashFolder.prettyName);</span>
<a href="#l22.29"></a><span id="l22.29">   }</span>
<a href="#l22.30"></a><span id="l22.30">   trashPopup.parentNode.folder = trashFolder;</span>
<a href="#l22.31"></a><span id="l22.31"> }</span>
<a href="#l22.32"></a><span id="l22.32"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/base/prefs/content/amUtils.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/base/prefs/content/amUtils.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -67,18 +67,22 @@ function prettyFolderName(aTargetFolder)</span>
<a href="#l23.4"></a><span id="l23.4">  * @param aIsServer   true if the URI specifies only a server (without folder)</span>
<a href="#l23.5"></a><span id="l23.5">  *</span>
<a href="#l23.6"></a><span id="l23.6">  * @return  the value of aTargetURI if it is valid (usable), otherwise null</span>
<a href="#l23.7"></a><span id="l23.7">  */</span>
<a href="#l23.8"></a><span id="l23.8"> function checkJunkTargetFolder(aTargetURI, aIsServer)</span>
<a href="#l23.9"></a><span id="l23.9"> {</span>
<a href="#l23.10"></a><span id="l23.10">   try {</span>
<a href="#l23.11"></a><span id="l23.11">     // Does the target account exist?</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-    let targetServer = MailUtils.getFolderForURI(aTargetURI + (aIsServer ? &quot;/Junk&quot; : &quot;&quot;),</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-                                                 !aIsServer).server;</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineplus">+    let targetServer;</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineplus">+    if (aIsServer) {</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineplus">+      targetServer = MailUtils.getOrCreateFolder(aTargetURI + &quot;/Junk&quot;).server;</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineplus">+    } else {</span>
<a href="#l23.18"></a><span id="l23.18" class="difflineplus">+      targetServer = MailUtils.getExistingFolder(aTargetURI).server;</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineplus">+    }</span>
<a href="#l23.20"></a><span id="l23.20"> </span>
<a href="#l23.21"></a><span id="l23.21">     // If the target server has deferred storage, Junk can't be stored into it.</span>
<a href="#l23.22"></a><span id="l23.22">     if (targetServer.rootFolder != targetServer.rootMsgFolder)</span>
<a href="#l23.23"></a><span id="l23.23">       return null;</span>
<a href="#l23.24"></a><span id="l23.24">   } catch (e) {</span>
<a href="#l23.25"></a><span id="l23.25">     return null;</span>
<a href="#l23.26"></a><span id="l23.26">   }</span>
<a href="#l23.27"></a><span id="l23.27"> </span>
<a href="#l23.28"></a><span id="l23.28" class="difflineat">@@ -94,17 +98,17 @@ function checkJunkTargetFolder(aTargetUR</span>
<a href="#l23.29"></a><span id="l23.29">  *</span>
<a href="#l23.30"></a><span id="l23.30">  * @return  the server/folder URI of a usable target for storing Junk</span>
<a href="#l23.31"></a><span id="l23.31">  */</span>
<a href="#l23.32"></a><span id="l23.32"> function chooseJunkTargetFolder(aTargetURI, aIsServer)</span>
<a href="#l23.33"></a><span id="l23.33"> {</span>
<a href="#l23.34"></a><span id="l23.34">   let server = null;</span>
<a href="#l23.35"></a><span id="l23.35"> </span>
<a href="#l23.36"></a><span id="l23.36">   if (aTargetURI) {</span>
<a href="#l23.37"></a><span id="l23.37" class="difflineminus">-    server = MailUtils.getFolderForURI(aTargetURI, false).server;</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineplus">+    server = MailUtils.getOrCreateFolder(aTargetURI).server;</span>
<a href="#l23.39"></a><span id="l23.39">     if (!server.canCreateFoldersOnServer || !server.canSearchMessages ||</span>
<a href="#l23.40"></a><span id="l23.40">         (server.rootFolder != server.rootMsgFolder))</span>
<a href="#l23.41"></a><span id="l23.41">       server = null;</span>
<a href="#l23.42"></a><span id="l23.42">   }</span>
<a href="#l23.43"></a><span id="l23.43">   if (!server)</span>
<a href="#l23.44"></a><span id="l23.44">     server = MailServices.accounts.localFoldersServer;</span>
<a href="#l23.45"></a><span id="l23.45"> </span>
<a href="#l23.46"></a><span id="l23.46">   return server.serverURI + (!aIsServer ? &quot;/Junk&quot; : &quot;&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/base/public/nsIFolderLookupService.idl</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/base/public/nsIFolderLookupService.idl</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -23,13 +23,24 @@ interface nsIMsgFolder;</span>
<a href="#l24.4"></a><span id="l24.4"> interface nsIFolderLookupService : nsISupports</span>
<a href="#l24.5"></a><span id="l24.5"> {</span>
<a href="#l24.6"></a><span id="l24.6">   /**</span>
<a href="#l24.7"></a><span id="l24.7">    * Returns a folder with the given URL or null if no such folder exists.</span>
<a href="#l24.8"></a><span id="l24.8">    *</span>
<a href="#l24.9"></a><span id="l24.9">    * @param aUrl The folder URL</span>
<a href="#l24.10"></a><span id="l24.10">    */</span>
<a href="#l24.11"></a><span id="l24.11">   nsIMsgFolder getFolderForURL(in ACString aUrl);</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineplus">+</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+  /**</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineplus">+   * Returns a folder with the given URL.</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineplus">+   * Will happily create and return an invalid (unparented) folder.</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineplus">+   * Will return null if aUrl is not a folder url.</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineplus">+   * NOTE: don't use this for new code! It's here purely to help</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineplus">+   * transition away from RDF-based folder creation.</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineplus">+   *</span>
<a href="#l24.20"></a><span id="l24.20" class="difflineplus">+   * @param aUrl The folder URL</span>
<a href="#l24.21"></a><span id="l24.21" class="difflineplus">+   */</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineplus">+  nsIMsgFolder getOrCreateFolderForURL(in ACString aUrl);</span>
<a href="#l24.23"></a><span id="l24.23"> };</span>
<a href="#l24.24"></a><span id="l24.24"> </span>
<a href="#l24.25"></a><span id="l24.25"> %{C++</span>
<a href="#l24.26"></a><span id="l24.26"> #define NSIFLS_CONTRACTID &quot;@mozilla.org/mail/folder-lookup;1&quot;</span>
<a href="#l24.27"></a><span id="l24.27"> %}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/base/search/content/FilterEditor.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/base/search/content/FilterEditor.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -701,23 +701,23 @@ function AssignMeaningfulName()</span>
<a href="#l25.4"></a><span id="l25.4"> </span>
<a href="#l25.5"></a><span id="l25.5"> </span>
<a href="#l25.6"></a><span id="l25.6"> function GetFirstSelectedMsgFolder()</span>
<a href="#l25.7"></a><span id="l25.7"> {</span>
<a href="#l25.8"></a><span id="l25.8">   var selectedFolder = gActionTargetElement.getAttribute(&quot;uri&quot;);</span>
<a href="#l25.9"></a><span id="l25.9">   if (!selectedFolder)</span>
<a href="#l25.10"></a><span id="l25.10">     return null;</span>
<a href="#l25.11"></a><span id="l25.11"> </span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-  var msgFolder = MailUtils.getFolderForURI(selectedFolder, true);</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+  var msgFolder = MailUtils.getExistingFolder(selectedFolder);</span>
<a href="#l25.14"></a><span id="l25.14">   return msgFolder;</span>
<a href="#l25.15"></a><span id="l25.15"> }</span>
<a href="#l25.16"></a><span id="l25.16"> </span>
<a href="#l25.17"></a><span id="l25.17"> function SearchNewFolderOkCallback(name, uri)</span>
<a href="#l25.18"></a><span id="l25.18"> {</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineminus">-  var msgFolder = MailUtils.getFolderForURI(uri, true);</span>
<a href="#l25.20"></a><span id="l25.20" class="difflineplus">+  var msgFolder = MailUtils.getExistingFolder(uri);</span>
<a href="#l25.21"></a><span id="l25.21">   var imapFolder = null;</span>
<a href="#l25.22"></a><span id="l25.22">   try</span>
<a href="#l25.23"></a><span id="l25.23">   {</span>
<a href="#l25.24"></a><span id="l25.24">     imapFolder = msgFolder.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l25.25"></a><span id="l25.25">   }</span>
<a href="#l25.26"></a><span id="l25.26">   catch(ex) {}</span>
<a href="#l25.27"></a><span id="l25.27">   if (imapFolder) //imapFolder creation is asynchronous.</span>
<a href="#l25.28"></a><span id="l25.28">   {</span>
<a href="#l25.29"></a><span id="l25.29" class="difflineat">@@ -740,17 +740,17 @@ function SearchNewFolderOkCallback(name,</span>
<a href="#l25.30"></a><span id="l25.30">   if (imapFolder)</span>
<a href="#l25.31"></a><span id="l25.31">     SetBusyCursor(window, true);</span>
<a href="#l25.32"></a><span id="l25.32"> </span>
<a href="#l25.33"></a><span id="l25.33">   msgFolder.createSubfolder(name, msgWindow);</span>
<a href="#l25.34"></a><span id="l25.34"> </span>
<a href="#l25.35"></a><span id="l25.35">   if (!imapFolder)</span>
<a href="#l25.36"></a><span id="l25.36">   {</span>
<a href="#l25.37"></a><span id="l25.37">     var curFolder = uri+&quot;/&quot;+encodeURIComponent(name);</span>
<a href="#l25.38"></a><span id="l25.38" class="difflineminus">-    let folder = MailUtils.getFolderForURI(curFolder);</span>
<a href="#l25.39"></a><span id="l25.39" class="difflineplus">+    let folder = MailUtils.getOrCreateFolder(curFolder);</span>
<a href="#l25.40"></a><span id="l25.40">     gActionTargetElement.selectFolder(folder);</span>
<a href="#l25.41"></a><span id="l25.41">   }</span>
<a href="#l25.42"></a><span id="l25.42"> }</span>
<a href="#l25.43"></a><span id="l25.43"> </span>
<a href="#l25.44"></a><span id="l25.44"> function UpdateAfterCustomHeaderChange()</span>
<a href="#l25.45"></a><span id="l25.45"> {</span>
<a href="#l25.46"></a><span id="l25.46">   updateSearchAttributes();</span>
<a href="#l25.47"></a><span id="l25.47"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/base/search/content/searchWidgets.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/base/search/content/searchWidgets.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -126,17 +126,17 @@ class MozRuleactiontargetFolder extends </span>
<a href="#l26.4"></a><span id="l26.4"> </span>
<a href="#l26.5"></a><span id="l26.5">     this.menulist = this.querySelector(&quot;menulist&quot;);</span>
<a href="#l26.6"></a><span id="l26.6"> </span>
<a href="#l26.7"></a><span id="l26.7">     this.menulist.addEventListener(&quot;command&quot;, (event) =&gt; {</span>
<a href="#l26.8"></a><span id="l26.8">       this.setPicker(event);</span>
<a href="#l26.9"></a><span id="l26.9">     });</span>
<a href="#l26.10"></a><span id="l26.10"> </span>
<a href="#l26.11"></a><span id="l26.11">     let folder = this.menulist.value ?</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-      MailUtils.getFolderForURI(this.menulist.value) :</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+      MailUtils.getOrCreateFolder(this.menulist.value) :</span>
<a href="#l26.14"></a><span id="l26.14">       gFilterList.folder;</span>
<a href="#l26.15"></a><span id="l26.15"> </span>
<a href="#l26.16"></a><span id="l26.16">     // An account folder is not a move/copy target; show &quot;Choose Folder&quot;.</span>
<a href="#l26.17"></a><span id="l26.17">     folder = folder.isServer ? null : folder;</span>
<a href="#l26.18"></a><span id="l26.18"> </span>
<a href="#l26.19"></a><span id="l26.19">     // The menupopup constructor needs to finish first.</span>
<a href="#l26.20"></a><span id="l26.20">     this.menulist.menupopup.selectFolder(folder);</span>
<a href="#l26.21"></a><span id="l26.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/base/search/content/searchWidgets.xml</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/base/search/content/searchWidgets.xml</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -19,17 +19,16 @@</span>
<a href="#l27.4"></a><span id="l27.4"> %filterEditorDTD;</span>
<a href="#l27.5"></a><span id="l27.5">   &lt;!ENTITY % messengerDTD    SYSTEM &quot;chrome://messenger/locale/messenger.dtd&quot; &gt;</span>
<a href="#l27.6"></a><span id="l27.6"> %messengerDTD;</span>
<a href="#l27.7"></a><span id="l27.7"> ]&gt;</span>
<a href="#l27.8"></a><span id="l27.8"> </span>
<a href="#l27.9"></a><span id="l27.9"> &lt;bindings   id=&quot;filterBindings&quot;</span>
<a href="#l27.10"></a><span id="l27.10">             xmlns=&quot;http://www.mozilla.org/xbl&quot;</span>
<a href="#l27.11"></a><span id="l27.11">             xmlns:xul=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-            xmlns:nc=&quot;http://home.netscape.com/NC-rdf#&quot;</span>
<a href="#l27.13"></a><span id="l27.13">             xmlns:xbl=&quot;http://www.mozilla.org/xbl&quot;&gt;</span>
<a href="#l27.14"></a><span id="l27.14"> </span>
<a href="#l27.15"></a><span id="l27.15">   &lt;binding id=&quot;ruleactiontype-menulist&quot;&gt;</span>
<a href="#l27.16"></a><span id="l27.16">     &lt;content&gt;</span>
<a href="#l27.17"></a><span id="l27.17">       &lt;xul:menulist class=&quot;ruleaction-type&quot;&gt;</span>
<a href="#l27.18"></a><span id="l27.18">           &lt;xul:menupopup&gt;</span>
<a href="#l27.19"></a><span id="l27.19">             &lt;xul:menuitem label=&quot;&amp;moveMessage.label;&quot; value=&quot;movemessage&quot; enablefornews=&quot;false&quot;/&gt;</span>
<a href="#l27.20"></a><span id="l27.20">             &lt;xul:menuitem label=&quot;&amp;copyMessage.label;&quot; value=&quot;copymessage&quot;/&gt;</span>
<a href="#l27.21"></a><span id="l27.21" class="difflineat">@@ -216,45 +215,38 @@</span>
<a href="#l27.22"></a><span id="l27.22">         - @return  True if at least one template was found, otherwise false.</span>
<a href="#l27.23"></a><span id="l27.23">       --&gt;</span>
<a href="#l27.24"></a><span id="l27.24">       &lt;method name=&quot;getTemplates&quot;&gt;</span>
<a href="#l27.25"></a><span id="l27.25">         &lt;parameter name=&quot;populateTemplateList&quot;/&gt;</span>
<a href="#l27.26"></a><span id="l27.26">         &lt;parameter name=&quot;templateMenuList&quot;/&gt;</span>
<a href="#l27.27"></a><span id="l27.27">         &lt;body&gt;</span>
<a href="#l27.28"></a><span id="l27.28">           &lt;![CDATA[</span>
<a href="#l27.29"></a><span id="l27.29">             ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;, this);</span>
<a href="#l27.30"></a><span id="l27.30" class="difflineplus">+            ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;, this);</span>
<a href="#l27.31"></a><span id="l27.31">             let identitiesRaw = MailServices.accounts</span>
<a href="#l27.32"></a><span id="l27.32">               .getIdentitiesForServer(gFilterList.folder.server);</span>
<a href="#l27.33"></a><span id="l27.33">             let identities = Array.from(this.fixIterator(identitiesRaw,</span>
<a href="#l27.34"></a><span id="l27.34">                                                          Ci.nsIMsgIdentity));</span>
<a href="#l27.35"></a><span id="l27.35"> </span>
<a href="#l27.36"></a><span id="l27.36">             if (identities.length == 0) { // typically if this is Local Folders</span>
<a href="#l27.37"></a><span id="l27.37">               if (MailServices.accounts.defaultAccount)</span>
<a href="#l27.38"></a><span id="l27.38">                 identities.push(MailServices.accounts.defaultAccount.defaultIdentity);</span>
<a href="#l27.39"></a><span id="l27.39">             }</span>
<a href="#l27.40"></a><span id="l27.40"> </span>
<a href="#l27.41"></a><span id="l27.41">             let templateFound = false;</span>
<a href="#l27.42"></a><span id="l27.42">             let foldersScanned = [];</span>
<a href="#l27.43"></a><span id="l27.43"> </span>
<a href="#l27.44"></a><span id="l27.44">             for (let identity of identities) {</span>
<a href="#l27.45"></a><span id="l27.45">               let enumerator = null;</span>
<a href="#l27.46"></a><span id="l27.46" class="difflineminus">-              let msgFolder;</span>
<a href="#l27.47"></a><span id="l27.47" class="difflineminus">-              try {</span>
<a href="#l27.48"></a><span id="l27.48" class="difflineminus">-                msgFolder = Cc[&quot;@mozilla.org/rdf/rdf-service;1&quot;]</span>
<a href="#l27.49"></a><span id="l27.49" class="difflineminus">-                              .getService(Ci.nsIRDFService)</span>
<a href="#l27.50"></a><span id="l27.50" class="difflineminus">-                              .GetResource(identity.stationeryFolder)</span>
<a href="#l27.51"></a><span id="l27.51" class="difflineminus">-                              .QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l27.52"></a><span id="l27.52" class="difflineminus">-                // If we already processed this folder, do not set enumerator</span>
<a href="#l27.53"></a><span id="l27.53" class="difflineminus">-                // so that we skip this identity.</span>
<a href="#l27.54"></a><span id="l27.54" class="difflineminus">-                if (foldersScanned.indexOf(msgFolder) == -1) {</span>
<a href="#l27.55"></a><span id="l27.55" class="difflineminus">-                  foldersScanned.push(msgFolder);</span>
<a href="#l27.56"></a><span id="l27.56" class="difflineminus">-                  enumerator = msgFolder.msgDatabase.EnumerateMessages();</span>
<a href="#l27.57"></a><span id="l27.57" class="difflineminus">-                }</span>
<a href="#l27.58"></a><span id="l27.58" class="difflineminus">-              } catch (e) {</span>
<a href="#l27.59"></a><span id="l27.59" class="difflineminus">-                // The Templates folder may not exist, that is OK.</span>
<a href="#l27.60"></a><span id="l27.60" class="difflineplus">+              let msgFolder = this.MailUtils.getExistingFolder(identity.stationeryFolder);</span>
<a href="#l27.61"></a><span id="l27.61" class="difflineplus">+              // If we already processed this folder, do not set enumerator</span>
<a href="#l27.62"></a><span id="l27.62" class="difflineplus">+              // so that we skip this identity.</span>
<a href="#l27.63"></a><span id="l27.63" class="difflineplus">+              if (msgFolder &amp;&amp; !foldersScanned.includes(msgFolder)) {</span>
<a href="#l27.64"></a><span id="l27.64" class="difflineplus">+                foldersScanned.push(msgFolder);</span>
<a href="#l27.65"></a><span id="l27.65" class="difflineplus">+                enumerator = msgFolder.msgDatabase.EnumerateMessages();</span>
<a href="#l27.66"></a><span id="l27.66">               }</span>
<a href="#l27.67"></a><span id="l27.67"> </span>
<a href="#l27.68"></a><span id="l27.68">               if (!enumerator)</span>
<a href="#l27.69"></a><span id="l27.69">                 continue;</span>
<a href="#l27.70"></a><span id="l27.70"> </span>
<a href="#l27.71"></a><span id="l27.71">               while (enumerator.hasMoreElements()) {</span>
<a href="#l27.72"></a><span id="l27.72">                 let header = enumerator.getNext();</span>
<a href="#l27.73"></a><span id="l27.73">                 if (header instanceof Ci.nsIMsgDBHdr) {</span>
<a href="#l27.74"></a><span id="l27.74" class="difflineat">@@ -457,17 +449,17 @@</span>
<a href="#l27.75"></a><span id="l27.75">                                     actionTarget.ruleactiontargetElement.childNodes[0].value;</span>
<a href="#l27.76"></a><span id="l27.76">             var errorString, customError;</span>
<a href="#l27.77"></a><span id="l27.77"> </span>
<a href="#l27.78"></a><span id="l27.78">             switch (filterActionString)</span>
<a href="#l27.79"></a><span id="l27.79">             {</span>
<a href="#l27.80"></a><span id="l27.80">               case &quot;movemessage&quot;:</span>
<a href="#l27.81"></a><span id="l27.81">               case &quot;copymessage&quot;:</span>
<a href="#l27.82"></a><span id="l27.82">                 let msgFolder = actionTargetLabel ?</span>
<a href="#l27.83"></a><span id="l27.83" class="difflineminus">-                  this.MailUtils.getFolderForURI(actionTargetLabel) : null;</span>
<a href="#l27.84"></a><span id="l27.84" class="difflineplus">+                  this.MailUtils.getOrCreateFolder(actionTargetLabel) : null;</span>
<a href="#l27.85"></a><span id="l27.85">                 if (!msgFolder || !msgFolder.canFileMessages)</span>
<a href="#l27.86"></a><span id="l27.86">                   errorString = &quot;mustSelectFolder&quot;;</span>
<a href="#l27.87"></a><span id="l27.87">                 break;</span>
<a href="#l27.88"></a><span id="l27.88">               case &quot;forwardmessage&quot;:</span>
<a href="#l27.89"></a><span id="l27.89">                 if (actionTargetLabel.length &lt; 3 ||</span>
<a href="#l27.90"></a><span id="l27.90">                     actionTargetLabel.indexOf('@') &lt; 1)</span>
<a href="#l27.91"></a><span id="l27.91">                   errorString = &quot;enterValidEmailAddress&quot;;</span>
<a href="#l27.92"></a><span id="l27.92">                 break;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/base/src/folderLookupService.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/base/src/folderLookupService.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -44,16 +44,17 @@ folderLookupService.prototype = {</span>
<a href="#l28.4"></a><span id="l28.4">   // nsIFolderLookupService impl</span>
<a href="#l28.5"></a><span id="l28.5">   getFolderForURL: function (aUrl) {</span>
<a href="#l28.6"></a><span id="l28.6">     let folder = null;</span>
<a href="#l28.7"></a><span id="l28.7">     // First, see if the folder is in our cache.</span>
<a href="#l28.8"></a><span id="l28.8">     if (this._map.has(aUrl)) {</span>
<a href="#l28.9"></a><span id="l28.9">       let valid = false;</span>
<a href="#l28.10"></a><span id="l28.10">       try {</span>
<a href="#l28.11"></a><span id="l28.11">         folder = this._map.get(aUrl).QueryReferent(Ci.nsIMsgFolder);</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineplus">+        // We don't want to return &quot;dangling&quot; (parentless) folders.</span>
<a href="#l28.13"></a><span id="l28.13">         valid = isValidFolder(folder);</span>
<a href="#l28.14"></a><span id="l28.14">       } catch (e) {</span>
<a href="#l28.15"></a><span id="l28.15">         // The object was deleted, so it's not valid</span>
<a href="#l28.16"></a><span id="l28.16">       }</span>
<a href="#l28.17"></a><span id="l28.17"> </span>
<a href="#l28.18"></a><span id="l28.18">       if (valid)</span>
<a href="#l28.19"></a><span id="l28.19">         return folder;</span>
<a href="#l28.20"></a><span id="l28.20"> </span>
<a href="#l28.21"></a><span id="l28.21" class="difflineat">@@ -75,21 +76,37 @@ folderLookupService.prototype = {</span>
<a href="#l28.22"></a><span id="l28.22">         folder = rdf.GetResource(aUrl)</span>
<a href="#l28.23"></a><span id="l28.23">                     .QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l28.24"></a><span id="l28.24">       } catch (e) {</span>
<a href="#l28.25"></a><span id="l28.25">         // If the QI fails, then we somehow picked up an RDF resource that isn't</span>
<a href="#l28.26"></a><span id="l28.26">         // a folder. Return null in this case.</span>
<a href="#l28.27"></a><span id="l28.27">         return null;</span>
<a href="#l28.28"></a><span id="l28.28">       }</span>
<a href="#l28.29"></a><span id="l28.29">     }</span>
<a href="#l28.30"></a><span id="l28.30" class="difflineplus">+    // We don't want to return &quot;dangling&quot; (parentless) folders.</span>
<a href="#l28.31"></a><span id="l28.31">     if (!isValidFolder(folder))</span>
<a href="#l28.32"></a><span id="l28.32">       return null;</span>
<a href="#l28.33"></a><span id="l28.33"> </span>
<a href="#l28.34"></a><span id="l28.34">     // Add the new folder to our map. Store a weak reference instead, so that</span>
<a href="#l28.35"></a><span id="l28.35">     // the folder can be closed when necessary.</span>
<a href="#l28.36"></a><span id="l28.36">     let weakRef = folder.QueryInterface(Ci.nsISupportsWeakReference)</span>
<a href="#l28.37"></a><span id="l28.37">                         .GetWeakReference();</span>
<a href="#l28.38"></a><span id="l28.38">     this._map.set(aUrl, weakRef);</span>
<a href="#l28.39"></a><span id="l28.39">     return folder;</span>
<a href="#l28.40"></a><span id="l28.40">   },</span>
<a href="#l28.41"></a><span id="l28.41" class="difflineplus">+  getOrCreateFolderForURL: function (aUrl) {</span>
<a href="#l28.42"></a><span id="l28.42" class="difflineplus">+    // NOTE: this doesn't update _map, but it'll work fine and</span>
<a href="#l28.43"></a><span id="l28.43" class="difflineplus">+    // it's a transitional function we want deleted anyway.</span>
<a href="#l28.44"></a><span id="l28.44" class="difflineplus">+    let rdf = Cc[&quot;@mozilla.org/rdf/rdf-service;1&quot;]</span>
<a href="#l28.45"></a><span id="l28.45" class="difflineplus">+                .getService(Ci.nsIRDFService);</span>
<a href="#l28.46"></a><span id="l28.46" class="difflineplus">+    try {</span>
<a href="#l28.47"></a><span id="l28.47" class="difflineplus">+      let folder = rdf.GetResource(aUrl)</span>
<a href="#l28.48"></a><span id="l28.48" class="difflineplus">+                      .QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l28.49"></a><span id="l28.49" class="difflineplus">+      return folder;</span>
<a href="#l28.50"></a><span id="l28.50" class="difflineplus">+    } catch (e) {</span>
<a href="#l28.51"></a><span id="l28.51" class="difflineplus">+      // If the QI fails, then we somehow picked up an RDF resource that isn't</span>
<a href="#l28.52"></a><span id="l28.52" class="difflineplus">+      // a folder. Return null in this case.</span>
<a href="#l28.53"></a><span id="l28.53" class="difflineplus">+      return null;</span>
<a href="#l28.54"></a><span id="l28.54" class="difflineplus">+    }</span>
<a href="#l28.55"></a><span id="l28.55" class="difflineplus">+  }</span>
<a href="#l28.56"></a><span id="l28.56"> };</span>
<a href="#l28.57"></a><span id="l28.57"> </span>
<a href="#l28.58"></a><span id="l28.58"> var NSGetFactory = XPCOMUtils.generateNSGetFactory([folderLookupService]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/base/src/nsMailNewsCommandLineHandler.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/base/src/nsMailNewsCommandLineHandler.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -51,17 +51,17 @@ var nsMailNewsCommandLineHandler =</span>
<a href="#l29.4"></a><span id="l29.4">           // Convert the message URI into a folder URI</span>
<a href="#l29.5"></a><span id="l29.5">           let folderURI = mailURL.slice(0, messageIDIndex)</span>
<a href="#l29.6"></a><span id="l29.6">                                  .replace(&quot;-message&quot;, &quot;&quot;);</span>
<a href="#l29.7"></a><span id="l29.7">           // Get the message ID</span>
<a href="#l29.8"></a><span id="l29.8">           let messageID = mailURL.slice(messageIDIndex + MESSAGE_ID_PARAM.length);</span>
<a href="#l29.9"></a><span id="l29.9">           // Make sure the folder tree is initialized</span>
<a href="#l29.10"></a><span id="l29.10">           MailUtils.discoverFolders();</span>
<a href="#l29.11"></a><span id="l29.11"> </span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-          let folder = MailUtils.getFolderForURI(folderURI, true);</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+          let folder = MailUtils.getExistingFolder(folderURI);</span>
<a href="#l29.14"></a><span id="l29.14">           // The folder might not exist, so guard against that</span>
<a href="#l29.15"></a><span id="l29.15">           if (folder &amp;&amp; messageID.length &gt; 0)</span>
<a href="#l29.16"></a><span id="l29.16">             msgHdr = folder.msgDatabase.getMsgHdrForMessageID(messageID);</span>
<a href="#l29.17"></a><span id="l29.17">         }</span>
<a href="#l29.18"></a><span id="l29.18">         else {</span>
<a href="#l29.19"></a><span id="l29.19">           // message URI</span>
<a href="#l29.20"></a><span id="l29.20">           msgHdr = this._messenger.msgHdrFromURI(mailURL);</span>
<a href="#l29.21"></a><span id="l29.21">         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/base/src/virtualFolderWrapper.js</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/base/src/virtualFolderWrapper.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -4,16 +4,17 @@</span>
<a href="#l30.4"></a><span id="l30.4"> </span>
<a href="#l30.5"></a><span id="l30.5"> /*</span>
<a href="#l30.6"></a><span id="l30.6">  * Wrap everything about virtual folders.</span>
<a href="#l30.7"></a><span id="l30.7">  */</span>
<a href="#l30.8"></a><span id="l30.8"> </span>
<a href="#l30.9"></a><span id="l30.9"> this.EXPORTED_SYMBOLS = ['VirtualFolderHelper'];</span>
<a href="#l30.10"></a><span id="l30.10"> </span>
<a href="#l30.11"></a><span id="l30.11"> ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineplus">+ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l30.13"></a><span id="l30.13"> ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l30.14"></a><span id="l30.14"> </span>
<a href="#l30.15"></a><span id="l30.15"> var VirtualFolderHelper = {</span>
<a href="#l30.16"></a><span id="l30.16">   /**</span>
<a href="#l30.17"></a><span id="l30.17">    * Create a new virtual folder (an actual nsIMsgFolder that did not previously</span>
<a href="#l30.18"></a><span id="l30.18">    *  exist), wrapping it in a VirtualFolderWrapper, and returning that wrapper.</span>
<a href="#l30.19"></a><span id="l30.19">    *</span>
<a href="#l30.20"></a><span id="l30.20">    * If the call to addSubfolder fails (and therefore throws), we will NOT catch</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineat">@@ -106,25 +107,22 @@ function VirtualFolderWrapper(aVirtualFo</span>
<a href="#l30.22"></a><span id="l30.22">   this.virtualFolder = aVirtualFolder;</span>
<a href="#l30.23"></a><span id="l30.23"> };</span>
<a href="#l30.24"></a><span id="l30.24"> VirtualFolderWrapper.prototype = {</span>
<a href="#l30.25"></a><span id="l30.25">   /**</span>
<a href="#l30.26"></a><span id="l30.26">    * @return the list of nsIMsgFolders that this virtual folder is a</span>
<a href="#l30.27"></a><span id="l30.27">    *     search over.</span>
<a href="#l30.28"></a><span id="l30.28">    */</span>
<a href="#l30.29"></a><span id="l30.29">   get searchFolders() {</span>
<a href="#l30.30"></a><span id="l30.30" class="difflineminus">-    let rdfService = Cc['@mozilla.org/rdf/rdf-service;1']</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineminus">-                       .getService(Ci.nsIRDFService);</span>
<a href="#l30.32"></a><span id="l30.32">     let virtualFolderUris =</span>
<a href="#l30.33"></a><span id="l30.33">       this.dbFolderInfo.getCharProperty(&quot;searchFolderUri&quot;).split(&quot;|&quot;);</span>
<a href="#l30.34"></a><span id="l30.34">     let folders = [];</span>
<a href="#l30.35"></a><span id="l30.35">     for (let folderURI of virtualFolderUris) {</span>
<a href="#l30.36"></a><span id="l30.36">       if (folderURI)</span>
<a href="#l30.37"></a><span id="l30.37" class="difflineminus">-        folders.push(rdfService.GetResource(folderURI)</span>
<a href="#l30.38"></a><span id="l30.38" class="difflineminus">-                               .QueryInterface(Ci.nsIMsgFolder));</span>
<a href="#l30.39"></a><span id="l30.39" class="difflineplus">+        folders.push(MailUtils.getExistingFolder(folderURI));</span>
<a href="#l30.40"></a><span id="l30.40">     }</span>
<a href="#l30.41"></a><span id="l30.41">     return folders;</span>
<a href="#l30.42"></a><span id="l30.42">   },</span>
<a href="#l30.43"></a><span id="l30.43">   /**</span>
<a href="#l30.44"></a><span id="l30.44">    * Set the search folders that back this virtual folder.</span>
<a href="#l30.45"></a><span id="l30.45">    *</span>
<a href="#l30.46"></a><span id="l30.46">    * @param aFolders Either a &quot;|&quot;-delimited string of folder URIs or a list of</span>
<a href="#l30.47"></a><span id="l30.47">    *     nsIMsgFolders that fixIterator can traverse (JS array/nsIMutableArray).</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/db/gloda/modules/datamodel.js</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/datamodel.js</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -1,16 +1,17 @@</span>
<a href="#l31.4"></a><span id="l31.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l31.5"></a><span id="l31.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l31.6"></a><span id="l31.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l31.7"></a><span id="l31.7"> </span>
<a href="#l31.8"></a><span id="l31.8"> this.EXPORTED_SYMBOLS = [&quot;GlodaAttributeDBDef&quot;, &quot;GlodaAccount&quot;,</span>
<a href="#l31.9"></a><span id="l31.9">                     &quot;GlodaConversation&quot;, &quot;GlodaFolder&quot;, &quot;GlodaMessage&quot;,</span>
<a href="#l31.10"></a><span id="l31.10">                     &quot;GlodaContact&quot;, &quot;GlodaIdentity&quot;, &quot;GlodaAttachment&quot;];</span>
<a href="#l31.11"></a><span id="l31.11"> </span>
<a href="#l31.12"></a><span id="l31.12" class="difflineplus">+ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l31.13"></a><span id="l31.13"> ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l31.14"></a><span id="l31.14"> </span>
<a href="#l31.15"></a><span id="l31.15"> ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l31.16"></a><span id="l31.16"> var LOG = Log4Moz.repository.getLogger(&quot;gloda.datamodel&quot;);</span>
<a href="#l31.17"></a><span id="l31.17"> </span>
<a href="#l31.18"></a><span id="l31.18"> ChromeUtils.import(&quot;resource:///modules/gloda/utils.js&quot;);</span>
<a href="#l31.19"></a><span id="l31.19"> </span>
<a href="#l31.20"></a><span id="l31.20"> // Make it lazy.</span>
<a href="#l31.21"></a><span id="l31.21" class="difflineat">@@ -389,20 +390,17 @@ GlodaFolder.prototype = {</span>
<a href="#l31.22"></a><span id="l31.22">    *</span>
<a href="#l31.23"></a><span id="l31.23">    * @param aActivity One of the kActivity* constants.  If you pass</span>
<a href="#l31.24"></a><span id="l31.24">    *     kActivityIndexing, we will set indexing for you, but you will need to</span>
<a href="#l31.25"></a><span id="l31.25">    *     clear it when you are done.</span>
<a href="#l31.26"></a><span id="l31.26">    * @return The nsIMsgFolder if available, null on failure.</span>
<a href="#l31.27"></a><span id="l31.27">    */</span>
<a href="#l31.28"></a><span id="l31.28">   getXPCOMFolder: function gloda_folder_getXPCOMFolder(aActivity) {</span>
<a href="#l31.29"></a><span id="l31.29">     if (!this._xpcomFolder) {</span>
<a href="#l31.30"></a><span id="l31.30" class="difflineminus">-      let rdfService = Cc['@mozilla.org/rdf/rdf-service;1']</span>
<a href="#l31.31"></a><span id="l31.31" class="difflineminus">-                         .getService(Ci.nsIRDFService);</span>
<a href="#l31.32"></a><span id="l31.32" class="difflineminus">-      this._xpcomFolder = rdfService.GetResource(this.uri)</span>
<a href="#l31.33"></a><span id="l31.33" class="difflineminus">-                                    .QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l31.34"></a><span id="l31.34" class="difflineplus">+      this._xpcomFolder = MailUtils.getExistingFolder(this.uri);</span>
<a href="#l31.35"></a><span id="l31.35">     }</span>
<a href="#l31.36"></a><span id="l31.36">     switch (aActivity) {</span>
<a href="#l31.37"></a><span id="l31.37">       case this.kActivityIndexing:</span>
<a href="#l31.38"></a><span id="l31.38">         // mark us as indexing, but don't bother with live tracking.  we do</span>
<a href="#l31.39"></a><span id="l31.39">         //  that independently and only for header retrieval.</span>
<a href="#l31.40"></a><span id="l31.40">         this.indexing = true;</span>
<a href="#l31.41"></a><span id="l31.41">         break;</span>
<a href="#l31.42"></a><span id="l31.42">       case this.kActivityHeaderRetrieval:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/db/gloda/modules/index_msg.js</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/index_msg.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -2604,17 +2604,17 @@ var GlodaMsgIndexer = {</span>
<a href="#l32.4"></a><span id="l32.4">      *  all of which is actually done by the datastore for us.</span>
<a href="#l32.5"></a><span id="l32.5">      * This method needs to deal with the complexity where local folders will</span>
<a href="#l32.6"></a><span id="l32.6">      *  generate a rename notification for each sub-folder, but IMAP folders</span>
<a href="#l32.7"></a><span id="l32.7">      *  will generate only a single notification.  Our logic primarily handles</span>
<a href="#l32.8"></a><span id="l32.8">      *  this by not exploding if the original folder no longer exists.</span>
<a href="#l32.9"></a><span id="l32.9">      */</span>
<a href="#l32.10"></a><span id="l32.10">     _folderRenameHelper: function gloda_indexer_folderRenameHelper(aOrigFolder,</span>
<a href="#l32.11"></a><span id="l32.11">                                                                    aNewURI) {</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-      let newFolder = MailUtils.getFolderForURI(aNewURI);</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineplus">+      let newFolder = MailUtils.getOrCreateFolder(aNewURI);</span>
<a href="#l32.14"></a><span id="l32.14">       let specialFolderFlags = Ci.nsMsgFolderFlags.Trash | Ci.nsMsgFolderFlags.Junk;</span>
<a href="#l32.15"></a><span id="l32.15">       if (newFolder.isSpecialFolder(specialFolderFlags, true)) {</span>
<a href="#l32.16"></a><span id="l32.16">         let descendentFolders = newFolder.descendants;</span>
<a href="#l32.17"></a><span id="l32.17"> </span>
<a href="#l32.18"></a><span id="l32.18">         // First thing to do: make sure we don't index the resulting folder and</span>
<a href="#l32.19"></a><span id="l32.19">         //  its descendents.</span>
<a href="#l32.20"></a><span id="l32.20">         GlodaMsgIndexer.resetFolderIndexingPriority(newFolder);</span>
<a href="#l32.21"></a><span id="l32.21">         for (let folder of fixIterator(descendentFolders, Ci.nsIMsgFolder)) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mailnews/db/gloda/test/unit/base_index_messages.js</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/base_index_messages.js</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -1014,17 +1014,17 @@ function* test_folder_nuking_message_del</span>
<a href="#l33.4"></a><span id="l33.4">   queryExpect(msgPrivQuery, []);</span>
<a href="#l33.5"></a><span id="l33.5">   yield false; // queryExpect is async</span>
<a href="#l33.6"></a><span id="l33.6"> }</span>
<a href="#l33.7"></a><span id="l33.7"> </span>
<a href="#l33.8"></a><span id="l33.8"> /* ===== Folder Move/Rename/Copy (Single and Nested) ===== */</span>
<a href="#l33.9"></a><span id="l33.9"> </span>
<a href="#l33.10"></a><span id="l33.10"> function get_nsIMsgFolder(aFolder) {</span>
<a href="#l33.11"></a><span id="l33.11">   if (!(aFolder instanceof Ci.nsIMsgFolder))</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-    return MailUtils.getFolderForURI(aFolder);</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+    return MailUtils.getOrCreateFolder(aFolder);</span>
<a href="#l33.14"></a><span id="l33.14">   else</span>
<a href="#l33.15"></a><span id="l33.15">     return aFolder;</span>
<a href="#l33.16"></a><span id="l33.16"> }</span>
<a href="#l33.17"></a><span id="l33.17"> </span>
<a href="#l33.18"></a><span id="l33.18"> function get_testFolder(aFolder) {</span>
<a href="#l33.19"></a><span id="l33.19">   if ((typeof aFolder) != &quot;string&quot;)</span>
<a href="#l33.20"></a><span id="l33.20">     return aFolder.URI;</span>
<a href="#l33.21"></a><span id="l33.21">   else</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/FeedUtils.jsm</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/FeedUtils.jsm</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -1716,17 +1716,17 @@ var FeedUtils = {</span>
<a href="#l34.4"></a><span id="l34.4">    * Return a folder path string constructed from individual folder UTF8 names</span>
<a href="#l34.5"></a><span id="l34.5">    * stored as properties (not possible hashes used to construct disk foldername).</span>
<a href="#l34.6"></a><span id="l34.6">    *</span>
<a href="#l34.7"></a><span id="l34.7">    * @param {nsIMsgFolder} aFolder         - The folder.</span>
<a href="#l34.8"></a><span id="l34.8">    *</span>
<a href="#l34.9"></a><span id="l34.9">    * @returns {String} prettyName or null  - Name or null if not a disk folder.</span>
<a href="#l34.10"></a><span id="l34.10">    */</span>
<a href="#l34.11"></a><span id="l34.11">   getFolderPrettyPath(aFolder) {</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-    let msgFolder = MailUtils.getFolderForURI(aFolder.URI, true);</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+    let msgFolder = MailUtils.getExistingFolder(aFolder.URI);</span>
<a href="#l34.14"></a><span id="l34.14">     if (!msgFolder) {</span>
<a href="#l34.15"></a><span id="l34.15">       // Not a real folder uri.</span>
<a href="#l34.16"></a><span id="l34.16">       return null;</span>
<a href="#l34.17"></a><span id="l34.17">     }</span>
<a href="#l34.18"></a><span id="l34.18"> </span>
<a href="#l34.19"></a><span id="l34.19">     if (msgFolder.URI == msgFolder.server.serverURI) {</span>
<a href="#l34.20"></a><span id="l34.20">       return msgFolder.server.prettyName;</span>
<a href="#l34.21"></a><span id="l34.21">     }</span>
<a href="#l34.22"></a><span id="l34.22" class="difflineat">@@ -1734,17 +1734,17 @@ var FeedUtils = {</span>
<a href="#l34.23"></a><span id="l34.23">     // Server part first.</span>
<a href="#l34.24"></a><span id="l34.24">     let pathParts = [msgFolder.server.prettyName];</span>
<a href="#l34.25"></a><span id="l34.25">     let rawPathParts = msgFolder.URI.split(msgFolder.server.serverURI + &quot;/&quot;);</span>
<a href="#l34.26"></a><span id="l34.26">     let folderURI = msgFolder.server.serverURI;</span>
<a href="#l34.27"></a><span id="l34.27">     rawPathParts = rawPathParts[1].split(&quot;/&quot;);</span>
<a href="#l34.28"></a><span id="l34.28">     for (let i = 0; i &lt; rawPathParts.length - 1; i++) {</span>
<a href="#l34.29"></a><span id="l34.29">       // Two or more folders deep parts here.</span>
<a href="#l34.30"></a><span id="l34.30">       folderURI += &quot;/&quot; + rawPathParts[i];</span>
<a href="#l34.31"></a><span id="l34.31" class="difflineminus">-      msgFolder = MailUtils.getFolderForURI(folderURI, true);</span>
<a href="#l34.32"></a><span id="l34.32" class="difflineplus">+      msgFolder = MailUtils.getExistingFolder(folderURI);</span>
<a href="#l34.33"></a><span id="l34.33">       pathParts.push(msgFolder.name);</span>
<a href="#l34.34"></a><span id="l34.34">     }</span>
<a href="#l34.35"></a><span id="l34.35"> </span>
<a href="#l34.36"></a><span id="l34.36">     // Leaf folder last.</span>
<a href="#l34.37"></a><span id="l34.37">     pathParts.push(aFolder.name);</span>
<a href="#l34.38"></a><span id="l34.38">     return pathParts.join(&quot;/&quot;);</span>
<a href="#l34.39"></a><span id="l34.39">   },</span>
<a href="#l34.40"></a><span id="l34.40"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_saveTemplate.js</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_saveTemplate.js</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -69,17 +69,17 @@ saveAsUrlListener.prototype = {</span>
<a href="#l35.4"></a><span id="l35.4"> // This is similar to the method in mailCommands.js, to test the way that</span>
<a href="#l35.5"></a><span id="l35.5"> // it creates a new templates folder before saving the message as a template.</span>
<a href="#l35.6"></a><span id="l35.6"> function* saveAsTemplate() {</span>
<a href="#l35.7"></a><span id="l35.7">   let hdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l35.8"></a><span id="l35.8">   let uri = IMAPPump.inbox.getUriForMsg(hdr);</span>
<a href="#l35.9"></a><span id="l35.9">   let identity = MailServices.accounts</span>
<a href="#l35.10"></a><span id="l35.10">                   .getFirstIdentityForServer(IMAPPump.incomingServer);</span>
<a href="#l35.11"></a><span id="l35.11">   identity.stationeryFolder = IMAPPump.incomingServer.rootFolder.URI + &quot;/Templates&quot;;</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-  let templates = MailUtils.getFolderForURI(identity.stationeryFolder, false);</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineplus">+  let templates = MailUtils.getOrCreateFolder(identity.stationeryFolder);</span>
<a href="#l35.14"></a><span id="l35.14">   // Verify that Templates folder doesn't exist, and then create it.</span>
<a href="#l35.15"></a><span id="l35.15">   Assert.equal(templates.parent, null);</span>
<a href="#l35.16"></a><span id="l35.16">   templates.setFlag(Ci.nsMsgFolderFlags.Templates);</span>
<a href="#l35.17"></a><span id="l35.17">   templates.createStorageIfMissing(new saveAsUrlListener(uri, identity));</span>
<a href="#l35.18"></a><span id="l35.18">   yield false;</span>
<a href="#l35.19"></a><span id="l35.19"> }</span>
<a href="#l35.20"></a><span id="l35.20"> </span>
<a href="#l35.21"></a><span id="l35.21"> // listener for saveAsTemplate adding a message to the templates folder.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mailnews/jsaccount/test/unit/test_jaMsgFolder.js</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mailnews/jsaccount/test/unit/test_jaMsgFolder.js</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -4,29 +4,29 @@</span>
<a href="#l36.4"></a><span id="l36.4">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l36.5"></a><span id="l36.5"> </span>
<a href="#l36.6"></a><span id="l36.6"> // This tests the additional methods added to JaMsgFolder.cpp that are not</span>
<a href="#l36.7"></a><span id="l36.7"> // in nsMsgDBFolder.cpp  Although this code have been done creating the</span>
<a href="#l36.8"></a><span id="l36.8"> // delegator class directly, instead we use a JS component as a demo of</span>
<a href="#l36.9"></a><span id="l36.9"> // JS override classes.</span>
<a href="#l36.10"></a><span id="l36.10"> </span>
<a href="#l36.11"></a><span id="l36.11"> ChromeUtils.import(&quot;resource://testing-common/mailnews/testJaBaseMsgFolder.jsm&quot;);</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineplus">+ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l36.13"></a><span id="l36.13"> ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l36.14"></a><span id="l36.14"> </span>
<a href="#l36.15"></a><span id="l36.15"> var interfaces = JaBaseMsgFolderProperties.baseInterfaces;</span>
<a href="#l36.16"></a><span id="l36.16"> </span>
<a href="#l36.17"></a><span id="l36.17"> function run_test()</span>
<a href="#l36.18"></a><span id="l36.18"> {</span>
<a href="#l36.19"></a><span id="l36.19">   let server = MailServices.accounts.createIncomingServer(&quot;foouser&quot;, &quot;foohost&quot;, &quot;testja&quot;);</span>
<a href="#l36.20"></a><span id="l36.20">   Assert.ok(server instanceof Ci.msgIOverride);</span>
<a href="#l36.21"></a><span id="l36.21"> </span>
<a href="#l36.22"></a><span id="l36.22">   // If you create a folder object directly, it will complain about not being registered.</span>
<a href="#l36.23"></a><span id="l36.23" class="difflineminus">-  // Use RDF instead.</span>
<a href="#l36.24"></a><span id="l36.24" class="difflineminus">-  let rdfService = Cc['@mozilla.org/rdf/rdf-service;1'].getService(Ci.nsIRDFService);</span>
<a href="#l36.25"></a><span id="l36.25" class="difflineminus">-  let testJaMsgFolder = rdfService.GetResource(&quot;testja://foouser@foohost/somefolder&quot;);</span>
<a href="#l36.26"></a><span id="l36.26" class="difflineplus">+  // Use folder-lookup-service instead.</span>
<a href="#l36.27"></a><span id="l36.27" class="difflineplus">+  let testJaMsgFolder = MailUtils.getOrCreateFolder(&quot;testja://foouser@foohost/somefolder&quot;);</span>
<a href="#l36.28"></a><span id="l36.28">   //let testJaMsgFolder = Cc[JaBaseMsgFolderProperties.contractID]</span>
<a href="#l36.29"></a><span id="l36.29">   //                        .createInstance(Ci.msgIOverride);</span>
<a href="#l36.30"></a><span id="l36.30">   Assert.ok(testJaMsgFolder instanceof Ci.nsIMsgFolder);</span>
<a href="#l36.31"></a><span id="l36.31"> </span>
<a href="#l36.32"></a><span id="l36.32">   JaBaseMsgFolderProperties.baseInterfaces.forEach(iface =&gt; {</span>
<a href="#l36.33"></a><span id="l36.33">     dump('testing interface ' + iface + '(' + Ci[iface] + ')\n');</span>
<a href="#l36.34"></a><span id="l36.34">     testJaMsgFolder.QueryInterface(Ci[iface]);</span>
<a href="#l36.35"></a><span id="l36.35">   });</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

