<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 29300:ca5a694350fbe0f89b46a23caafb8ebf39363257</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ ca5a694350fbe0f89b46a23caafb8ebf39363257" />
<meta property="og:url" content="/comm-central/rev/ca5a694350fbe0f89b46a23caafb8ebf39363257" />
<meta property="og:description" content="Bug 1621785 - Compatibility headers for building RNP with clang-cl. r=kaie" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / ca5a694350fbe0f89b46a23caafb8ebf39363257 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/ca5a694350fbe0f89b46a23caafb8ebf39363257">shortlog</a> |
<a href="/comm-central/log/ca5a694350fbe0f89b46a23caafb8ebf39363257">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/ca5a694350fbe0f89b46a23caafb8ebf39363257">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/ca5a694350fbe0f89b46a23caafb8ebf39363257">files</a> |
changeset |
<a href="/comm-central/raw-rev/ca5a694350fbe0f89b46a23caafb8ebf39363257">raw</a>  | <a href="/comm-central/archive/ca5a694350fbe0f89b46a23caafb8ebf39363257.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1621785">Bug 1621785</a> - Compatibility headers for building RNP with clang-cl. r=kaie
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#82;&#111;&#98;&#32;&#76;&#101;&#109;&#108;&#101;&#121;&#32;&#60;&#114;&#111;&#98;&#64;&#116;&#104;&#117;&#110;&#100;&#101;&#114;&#98;&#105;&#114;&#100;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 14 Apr 2020 22:29:01 +0000</td></tr>

<tr>
 <td>changeset 29300</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/ca5a694350fbe0f89b46a23caafb8ebf39363257">ca5a694350fbe0f89b46a23caafb8ebf39363257</a></td>
</tr>



<tr>
<td>parent 29299</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/01043748e1e0d2792f8a4d1bf26038ddd82d054c">01043748e1e0d2792f8a4d1bf26038ddd82d054c</a>
</td>
</tr>

<tr>
<td>child 29301</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/a00ef189a6d32688c2e590aecf151e211e26666c">a00ef189a6d32688c2e590aecf151e211e26666c</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=ca5a694350fbe0f89b46a23caafb8ebf39363257">17301</a></td></tr>
<tr><td>push user</td><td>thunderbird@calypsoblue.org</td></tr>
<tr><td>push date</td><td class="date age">Wed, 15 Apr 2020 18:01:44 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@7c06681d8e9a [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7c06681d8e9a22d9226498c34b620cd4d3cf8ea3">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7c06681d8e9a22d9226498c34b620cd4d3cf8ea3&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7c06681d8e9a22d9226498c34b620cd4d3cf8ea3&newProject=comm-central&newRevision=46d32cfff30ff3d8ad4aeeb10f557283b44c10ee&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7c06681d8e9a22d9226498c34b620cd4d3cf8ea3&newProject=comm-central&newRevision=46d32cfff30ff3d8ad4aeeb10f557283b44c10ee&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7c06681d8e9a22d9226498c34b620cd4d3cf8ea3&newProject=comm-central&newRevision=46d32cfff30ff3d8ad4aeeb10f557283b44c10ee&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28kaie%29&revcount=50">kaie</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1621785">1621785</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1621785">Bug 1621785</a> - Compatibility headers for building RNP with clang-cl. r=kaie

These are missing defines and a few functions that are used by
the RNP library but are not part of the Microsoft runtime.

dirent.h is an MIT licensed &quot;header&quot; file that contains opendir(),
readdir(), and closedir() for Windows. Copyright and license are
included in the file itself.

sys/time.h contains an implementation of gettimeofday() for Windows
that's used in rnp/src/lib/crypto/s2k.cpp.

Differential Revision: <a href="https://phabricator.services.mozilla.com/D70739">https://phabricator.services.mozilla.com/D70739</a></div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ca5a694350fbe0f89b46a23caafb8ebf39363257/mail/base/content/overrides/app-license-body.html">mail/base/content/overrides/app-license-body.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ca5a694350fbe0f89b46a23caafb8ebf39363257/mail/base/content/overrides/app-license-body.html">file</a> |
<a href="/comm-central/annotate/ca5a694350fbe0f89b46a23caafb8ebf39363257/mail/base/content/overrides/app-license-body.html">annotate</a> |
<a href="/comm-central/diff/ca5a694350fbe0f89b46a23caafb8ebf39363257/mail/base/content/overrides/app-license-body.html">diff</a> |
<a href="/comm-central/comparison/ca5a694350fbe0f89b46a23caafb8ebf39363257/mail/base/content/overrides/app-license-body.html">comparison</a> |
<a href="/comm-central/log/ca5a694350fbe0f89b46a23caafb8ebf39363257/mail/base/content/overrides/app-license-body.html">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ca5a694350fbe0f89b46a23caafb8ebf39363257/mail/base/content/overrides/app-license-list.html">mail/base/content/overrides/app-license-list.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ca5a694350fbe0f89b46a23caafb8ebf39363257/mail/base/content/overrides/app-license-list.html">file</a> |
<a href="/comm-central/annotate/ca5a694350fbe0f89b46a23caafb8ebf39363257/mail/base/content/overrides/app-license-list.html">annotate</a> |
<a href="/comm-central/diff/ca5a694350fbe0f89b46a23caafb8ebf39363257/mail/base/content/overrides/app-license-list.html">diff</a> |
<a href="/comm-central/comparison/ca5a694350fbe0f89b46a23caafb8ebf39363257/mail/base/content/overrides/app-license-list.html">comparison</a> |
<a href="/comm-central/log/ca5a694350fbe0f89b46a23caafb8ebf39363257/mail/base/content/overrides/app-license-list.html">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ca5a694350fbe0f89b46a23caafb8ebf39363257/third_party/README.niwcompat">third_party/README.niwcompat</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ca5a694350fbe0f89b46a23caafb8ebf39363257/third_party/README.niwcompat">file</a> |
<a href="/comm-central/annotate/ca5a694350fbe0f89b46a23caafb8ebf39363257/third_party/README.niwcompat">annotate</a> |
<a href="/comm-central/diff/ca5a694350fbe0f89b46a23caafb8ebf39363257/third_party/README.niwcompat">diff</a> |
<a href="/comm-central/comparison/ca5a694350fbe0f89b46a23caafb8ebf39363257/third_party/README.niwcompat">comparison</a> |
<a href="/comm-central/log/ca5a694350fbe0f89b46a23caafb8ebf39363257/third_party/README.niwcompat">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ca5a694350fbe0f89b46a23caafb8ebf39363257/third_party/niwcompat/dirent.h">third_party/niwcompat/dirent.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ca5a694350fbe0f89b46a23caafb8ebf39363257/third_party/niwcompat/dirent.h">file</a> |
<a href="/comm-central/annotate/ca5a694350fbe0f89b46a23caafb8ebf39363257/third_party/niwcompat/dirent.h">annotate</a> |
<a href="/comm-central/diff/ca5a694350fbe0f89b46a23caafb8ebf39363257/third_party/niwcompat/dirent.h">diff</a> |
<a href="/comm-central/comparison/ca5a694350fbe0f89b46a23caafb8ebf39363257/third_party/niwcompat/dirent.h">comparison</a> |
<a href="/comm-central/log/ca5a694350fbe0f89b46a23caafb8ebf39363257/third_party/niwcompat/dirent.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ca5a694350fbe0f89b46a23caafb8ebf39363257/third_party/niwcompat/niw_compat.h">third_party/niwcompat/niw_compat.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ca5a694350fbe0f89b46a23caafb8ebf39363257/third_party/niwcompat/niw_compat.h">file</a> |
<a href="/comm-central/annotate/ca5a694350fbe0f89b46a23caafb8ebf39363257/third_party/niwcompat/niw_compat.h">annotate</a> |
<a href="/comm-central/diff/ca5a694350fbe0f89b46a23caafb8ebf39363257/third_party/niwcompat/niw_compat.h">diff</a> |
<a href="/comm-central/comparison/ca5a694350fbe0f89b46a23caafb8ebf39363257/third_party/niwcompat/niw_compat.h">comparison</a> |
<a href="/comm-central/log/ca5a694350fbe0f89b46a23caafb8ebf39363257/third_party/niwcompat/niw_compat.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ca5a694350fbe0f89b46a23caafb8ebf39363257/third_party/niwcompat/sys/param.h">third_party/niwcompat/sys/param.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ca5a694350fbe0f89b46a23caafb8ebf39363257/third_party/niwcompat/sys/param.h">file</a> |
<a href="/comm-central/annotate/ca5a694350fbe0f89b46a23caafb8ebf39363257/third_party/niwcompat/sys/param.h">annotate</a> |
<a href="/comm-central/diff/ca5a694350fbe0f89b46a23caafb8ebf39363257/third_party/niwcompat/sys/param.h">diff</a> |
<a href="/comm-central/comparison/ca5a694350fbe0f89b46a23caafb8ebf39363257/third_party/niwcompat/sys/param.h">comparison</a> |
<a href="/comm-central/log/ca5a694350fbe0f89b46a23caafb8ebf39363257/third_party/niwcompat/sys/param.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ca5a694350fbe0f89b46a23caafb8ebf39363257/third_party/niwcompat/sys/time.h">third_party/niwcompat/sys/time.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ca5a694350fbe0f89b46a23caafb8ebf39363257/third_party/niwcompat/sys/time.h">file</a> |
<a href="/comm-central/annotate/ca5a694350fbe0f89b46a23caafb8ebf39363257/third_party/niwcompat/sys/time.h">annotate</a> |
<a href="/comm-central/diff/ca5a694350fbe0f89b46a23caafb8ebf39363257/third_party/niwcompat/sys/time.h">diff</a> |
<a href="/comm-central/comparison/ca5a694350fbe0f89b46a23caafb8ebf39363257/third_party/niwcompat/sys/time.h">comparison</a> |
<a href="/comm-central/log/ca5a694350fbe0f89b46a23caafb8ebf39363257/third_party/niwcompat/sys/time.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ca5a694350fbe0f89b46a23caafb8ebf39363257/third_party/niwcompat/unistd.h">third_party/niwcompat/unistd.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ca5a694350fbe0f89b46a23caafb8ebf39363257/third_party/niwcompat/unistd.h">file</a> |
<a href="/comm-central/annotate/ca5a694350fbe0f89b46a23caafb8ebf39363257/third_party/niwcompat/unistd.h">annotate</a> |
<a href="/comm-central/diff/ca5a694350fbe0f89b46a23caafb8ebf39363257/third_party/niwcompat/unistd.h">diff</a> |
<a href="/comm-central/comparison/ca5a694350fbe0f89b46a23caafb8ebf39363257/third_party/niwcompat/unistd.h">comparison</a> |
<a href="/comm-central/log/ca5a694350fbe0f89b46a23caafb8ebf39363257/third_party/niwcompat/unistd.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/overrides/app-license-body.html</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/overrides/app-license-body.html</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -628,8 +628,36 @@ LIMITATION, DIRECT, INDIRECT, INCIDENTAL</span>
<a href="#l1.4"></a><span id="l1.4"> DAMAGES, EVEN IF LICENSOR HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGES</span>
<a href="#l1.5"></a><span id="l1.5"> PRIOR TO SUCH AN OCCURRENCE.</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> [SIGNATURE by Phillip Rogaway]</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> Date: August 28, 2017</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11">     &lt;/pre&gt;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    &lt;h1&gt;&lt;a id=&quot;tb-direntlicense&quot;&gt;&lt;/a&gt;Dirent License&lt;/h1&gt;</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+    &lt;p&gt;This license applies to &lt;code&gt;third_party/niwcompat/dirent.h&lt;/code&gt;.&lt;/p&gt;</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+    &lt;pre&gt;</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+The MIT License (MIT)</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+Copyright (c) 1998-2019 Toni Ronkko</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+in the Software without restriction, including without limitation the rights</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+copies of the Software, and to permit persons to whom the Software is</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+furnished to do so, subject to the following conditions:</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+The above copyright notice and this permission notice shall be included in all</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+copies or substantial portions of the Software.</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+SOFTWARE.</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+    &lt;/pre&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/overrides/app-license-list.html</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/overrides/app-license-list.html</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -4,9 +4,10 @@</span>
<a href="#l2.4"></a><span id="l2.4">       &lt;li&gt;&lt;a href=&quot;about:license#tb-bsd3clause&quot;&gt;BSD-3-Clause License&lt;/a&gt;&lt;/li&gt;</span>
<a href="#l2.5"></a><span id="l2.5">       &lt;li&gt;&lt;a href=&quot;about:license#tb-xlicense&quot;&gt;X License&lt;/a&gt;&lt;/li&gt;</span>
<a href="#l2.6"></a><span id="l2.6">       &lt;li&gt;&lt;a href=&quot;about:license#tb-publicdomain&quot;&gt;Public domain&lt;/a&gt;&lt;/li&gt;</span>
<a href="#l2.7"></a><span id="l2.7">       &lt;li&gt;&lt;a href=&quot;about:license#tb-ocblicense1&quot;&gt;OCB license 1&lt;/a&gt;&lt;/li&gt;</span>
<a href="#l2.8"></a><span id="l2.8">       &lt;li&gt;&lt;a href=&quot;about:license#tb-bzip2license&quot;&gt;Bzip2 License&lt;/a&gt;&lt;/li&gt;</span>
<a href="#l2.9"></a><span id="l2.9">       &lt;li&gt;&lt;a href=&quot;about:license#tb-jsonclicense&quot;&gt;Json-C License&lt;/a&gt;&lt;/li&gt;</span>
<a href="#l2.10"></a><span id="l2.10">       &lt;li&gt;&lt;a href=&quot;about:license#tb-botanlicense&quot;&gt;Botan License&lt;/a&gt;&lt;/li&gt;</span>
<a href="#l2.11"></a><span id="l2.11">       &lt;li&gt;&lt;a href=&quot;about:license#tb-rnplicense&quot;&gt;RNP Licenses&lt;/a&gt;&lt;/li&gt;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+      &lt;li&gt;&lt;a href=&quot;about:license#tb-direntlicense&quot;&gt;Dirent License&lt;/a&gt;&lt;/li&gt;</span>
<a href="#l2.13"></a><span id="l2.13">     &lt;/ul&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">new file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- /dev/null</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ b/third_party/README.niwcompat</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -0,0 +1,6 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineplus">+Directory ./niwcompat contains header files and some functionality used</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineplus">+to compile RNP with Clang-cl for Windows.</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineplus">+</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+niwcompat = wincompat where &quot;win&quot; is spelled backwards</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+For licensing information, please refer to the files within.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100755</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/third_party/niwcompat/dirent.h</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,1160 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+/*</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+ * Dirent interface for Microsoft Visual Studio</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+ *</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+ * Copyright (C) 1998-2019 Toni Ronkko</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+ * This file is part of dirent.  Dirent may be freely distributed</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+ * under the MIT license.  For all details and documentation, see</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+ * https://github.com/tronkko/dirent</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+ */</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+#ifndef DIRENT_H</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+#define DIRENT_H</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+/* Hide warnings about unreferenced local functions */</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+#if defined(__clang__)</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+#   pragma clang diagnostic ignored &quot;-Wunused-function&quot;</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+#elif defined(_MSC_VER)</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+#   pragma warning(disable:4505)</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+#elif defined(__GNUC__)</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+#   pragma GCC diagnostic ignored &quot;-Wunused-function&quot;</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+#endif</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+/*</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+ * Include windows.h without Windows Sockets 1.1 to prevent conflicts with</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+ * Windows Sockets 2.0.</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+ */</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+#ifndef WIN32_LEAN_AND_MEAN</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+#   define WIN32_LEAN_AND_MEAN</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+#endif</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+#include &lt;windows.h&gt;</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+#include &lt;stdio.h&gt;</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+#include &lt;stdarg.h&gt;</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+#include &lt;wchar.h&gt;</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+#include &lt;string.h&gt;</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+#include &lt;stdlib.h&gt;</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+#include &lt;malloc.h&gt;</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+#include &lt;sys/types.h&gt;</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+#include &lt;sys/stat.h&gt;</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+#include &lt;errno.h&gt;</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+/* Indicates that d_type field is available in dirent structure */</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+#define _DIRENT_HAVE_D_TYPE</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+/* Indicates that d_namlen field is available in dirent structure */</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+#define _DIRENT_HAVE_D_NAMLEN</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+/* Entries missing from MSVC 6.0 */</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+#if !defined(FILE_ATTRIBUTE_DEVICE)</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+#   define FILE_ATTRIBUTE_DEVICE 0x40</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+#endif</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+/* File type and permission flags for stat(), general mask */</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+#if !defined(S_IFMT)</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+#   define S_IFMT _S_IFMT</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+#endif</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+/* Directory bit */</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+#if !defined(S_IFDIR)</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+#   define S_IFDIR _S_IFDIR</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+#endif</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+/* Character device bit */</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+#if !defined(S_IFCHR)</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+#   define S_IFCHR _S_IFCHR</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+#endif</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+/* Pipe bit */</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+#if !defined(S_IFFIFO)</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+#   define S_IFFIFO _S_IFFIFO</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+#endif</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+/* Regular file bit */</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+#if !defined(S_IFREG)</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+#   define S_IFREG _S_IFREG</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+#endif</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+/* Read permission */</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+#if !defined(S_IREAD)</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+#   define S_IREAD _S_IREAD</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+#endif</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+/* Write permission */</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+#if !defined(S_IWRITE)</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+#   define S_IWRITE _S_IWRITE</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+#endif</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+/* Execute permission */</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+#if !defined(S_IEXEC)</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+#   define S_IEXEC _S_IEXEC</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+#endif</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+/* Pipe */</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+#if !defined(S_IFIFO)</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+#   define S_IFIFO _S_IFIFO</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+#endif</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+/* Block device */</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+#if !defined(S_IFBLK)</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+#   define S_IFBLK 0</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+#endif</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+/* Link */</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+#if !defined(S_IFLNK)</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+#   define S_IFLNK 0</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+#endif</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+/* Socket */</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+#if !defined(S_IFSOCK)</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+#   define S_IFSOCK 0</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+#endif</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+/* Read user permission */</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+#if !defined(S_IRUSR)</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+#   define S_IRUSR S_IREAD</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+#endif</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+/* Write user permission */</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+#if !defined(S_IWUSR)</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+#   define S_IWUSR S_IWRITE</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+#endif</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+/* Execute user permission */</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+#if !defined(S_IXUSR)</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineplus">+#   define S_IXUSR 0</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineplus">+#endif</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineplus">+/* Read group permission */</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineplus">+#if !defined(S_IRGRP)</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineplus">+#   define S_IRGRP 0</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineplus">+#endif</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineplus">+</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineplus">+/* Write group permission */</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+#if !defined(S_IWGRP)</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineplus">+#   define S_IWGRP 0</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineplus">+#endif</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineplus">+</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineplus">+/* Execute group permission */</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineplus">+#if !defined(S_IXGRP)</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineplus">+#   define S_IXGRP 0</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineplus">+#endif</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+/* Read others permission */</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineplus">+#if !defined(S_IROTH)</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineplus">+#   define S_IROTH 0</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineplus">+#endif</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineplus">+</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineplus">+/* Write others permission */</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineplus">+#if !defined(S_IWOTH)</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineplus">+#   define S_IWOTH 0</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineplus">+#endif</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineplus">+</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineplus">+/* Execute others permission */</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineplus">+#if !defined(S_IXOTH)</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineplus">+#   define S_IXOTH 0</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineplus">+#endif</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineplus">+</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineplus">+/* Maximum length of file name */</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineplus">+#if !defined(PATH_MAX)</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineplus">+#   define PATH_MAX MAX_PATH</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineplus">+#endif</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineplus">+#if !defined(FILENAME_MAX)</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineplus">+#   define FILENAME_MAX MAX_PATH</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineplus">+#endif</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineplus">+#if !defined(NAME_MAX)</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineplus">+#   define NAME_MAX FILENAME_MAX</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineplus">+#endif</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineplus">+</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineplus">+/* File type flags for d_type */</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineplus">+#define DT_UNKNOWN 0</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineplus">+#define DT_REG S_IFREG</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineplus">+#define DT_DIR S_IFDIR</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineplus">+#define DT_FIFO S_IFIFO</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineplus">+#define DT_SOCK S_IFSOCK</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineplus">+#define DT_CHR S_IFCHR</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineplus">+#define DT_BLK S_IFBLK</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineplus">+#define DT_LNK S_IFLNK</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineplus">+</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineplus">+/* Macros for converting between st_mode and d_type */</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineplus">+#define IFTODT(mode) ((mode) &amp; S_IFMT)</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineplus">+#define DTTOIF(type) (type)</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineplus">+</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineplus">+/*</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineplus">+ * File type macros.  Note that block devices, sockets and links cannot be</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineplus">+ * distinguished on Windows and the macros S_ISBLK, S_ISSOCK and S_ISLNK are</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineplus">+ * only defined for compatibility.  These macros should always return false</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineplus">+ * on Windows.</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineplus">+ */</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineplus">+#if !defined(S_ISFIFO)</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineplus">+#   define S_ISFIFO(mode) (((mode) &amp; S_IFMT) == S_IFIFO)</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineplus">+#endif</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineplus">+#if !defined(S_ISDIR)</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineplus">+#   define S_ISDIR(mode) (((mode) &amp; S_IFMT) == S_IFDIR)</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineplus">+#endif</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineplus">+#if !defined(S_ISREG)</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineplus">+#   define S_ISREG(mode) (((mode) &amp; S_IFMT) == S_IFREG)</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineplus">+#endif</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineplus">+#if !defined(S_ISLNK)</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineplus">+#   define S_ISLNK(mode) (((mode) &amp; S_IFMT) == S_IFLNK)</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineplus">+#endif</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineplus">+#if !defined(S_ISSOCK)</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineplus">+#   define S_ISSOCK(mode) (((mode) &amp; S_IFMT) == S_IFSOCK)</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineplus">+#endif</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineplus">+#if !defined(S_ISCHR)</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineplus">+#   define S_ISCHR(mode) (((mode) &amp; S_IFMT) == S_IFCHR)</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineplus">+#endif</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineplus">+#if !defined(S_ISBLK)</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineplus">+#   define S_ISBLK(mode) (((mode) &amp; S_IFMT) == S_IFBLK)</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineplus">+#endif</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineplus">+</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineplus">+/* Return the exact length of the file name without zero terminator */</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineplus">+#define _D_EXACT_NAMLEN(p) ((p)-&gt;d_namlen)</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineplus">+</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineplus">+/* Return the maximum size of a file name */</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineplus">+#define _D_ALLOC_NAMLEN(p) ((PATH_MAX)+1)</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineplus">+</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineplus">+</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineplus">+#ifdef __cplusplus</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineplus">+extern &quot;C&quot; {</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineplus">+#endif</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineplus">+</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineplus">+</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineplus">+/* Wide-character version */</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineplus">+struct _wdirent {</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineplus">+    /* Always zero */</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineplus">+    long d_ino;</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineplus">+</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineplus">+    /* File position within stream */</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineplus">+    long d_off;</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineplus">+</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineplus">+    /* Structure size */</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineplus">+    unsigned short d_reclen;</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineplus">+</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineplus">+    /* Length of name without \0 */</span>
<a href="#l4.237"></a><span id="l4.237" class="difflineplus">+    size_t d_namlen;</span>
<a href="#l4.238"></a><span id="l4.238" class="difflineplus">+</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineplus">+    /* File type */</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineplus">+    int d_type;</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineplus">+</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineplus">+    /* File name */</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineplus">+    wchar_t d_name[PATH_MAX+1];</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineplus">+};</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineplus">+typedef struct _wdirent _wdirent;</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineplus">+</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineplus">+struct _WDIR {</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineplus">+    /* Current directory entry */</span>
<a href="#l4.249"></a><span id="l4.249" class="difflineplus">+    struct _wdirent ent;</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineplus">+</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineplus">+    /* Private file data */</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineplus">+    WIN32_FIND_DATAW data;</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineplus">+</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineplus">+    /* True if data is valid */</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineplus">+    int cached;</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineplus">+</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineplus">+    /* Win32 search handle */</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineplus">+    HANDLE handle;</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineplus">+</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineplus">+    /* Initial directory name */</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineplus">+    wchar_t *patt;</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineplus">+};</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineplus">+typedef struct _WDIR _WDIR;</span>
<a href="#l4.264"></a><span id="l4.264" class="difflineplus">+</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineplus">+/* Multi-byte character version */</span>
<a href="#l4.266"></a><span id="l4.266" class="difflineplus">+struct dirent {</span>
<a href="#l4.267"></a><span id="l4.267" class="difflineplus">+    /* Always zero */</span>
<a href="#l4.268"></a><span id="l4.268" class="difflineplus">+    long d_ino;</span>
<a href="#l4.269"></a><span id="l4.269" class="difflineplus">+</span>
<a href="#l4.270"></a><span id="l4.270" class="difflineplus">+    /* File position within stream */</span>
<a href="#l4.271"></a><span id="l4.271" class="difflineplus">+    long d_off;</span>
<a href="#l4.272"></a><span id="l4.272" class="difflineplus">+</span>
<a href="#l4.273"></a><span id="l4.273" class="difflineplus">+    /* Structure size */</span>
<a href="#l4.274"></a><span id="l4.274" class="difflineplus">+    unsigned short d_reclen;</span>
<a href="#l4.275"></a><span id="l4.275" class="difflineplus">+</span>
<a href="#l4.276"></a><span id="l4.276" class="difflineplus">+    /* Length of name without \0 */</span>
<a href="#l4.277"></a><span id="l4.277" class="difflineplus">+    size_t d_namlen;</span>
<a href="#l4.278"></a><span id="l4.278" class="difflineplus">+</span>
<a href="#l4.279"></a><span id="l4.279" class="difflineplus">+    /* File type */</span>
<a href="#l4.280"></a><span id="l4.280" class="difflineplus">+    int d_type;</span>
<a href="#l4.281"></a><span id="l4.281" class="difflineplus">+</span>
<a href="#l4.282"></a><span id="l4.282" class="difflineplus">+    /* File name */</span>
<a href="#l4.283"></a><span id="l4.283" class="difflineplus">+    char d_name[PATH_MAX+1];</span>
<a href="#l4.284"></a><span id="l4.284" class="difflineplus">+};</span>
<a href="#l4.285"></a><span id="l4.285" class="difflineplus">+typedef struct dirent dirent;</span>
<a href="#l4.286"></a><span id="l4.286" class="difflineplus">+</span>
<a href="#l4.287"></a><span id="l4.287" class="difflineplus">+struct DIR {</span>
<a href="#l4.288"></a><span id="l4.288" class="difflineplus">+    struct dirent ent;</span>
<a href="#l4.289"></a><span id="l4.289" class="difflineplus">+    struct _WDIR *wdirp;</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineplus">+};</span>
<a href="#l4.291"></a><span id="l4.291" class="difflineplus">+typedef struct DIR DIR;</span>
<a href="#l4.292"></a><span id="l4.292" class="difflineplus">+</span>
<a href="#l4.293"></a><span id="l4.293" class="difflineplus">+</span>
<a href="#l4.294"></a><span id="l4.294" class="difflineplus">+/* Dirent functions */</span>
<a href="#l4.295"></a><span id="l4.295" class="difflineplus">+static DIR *opendir (const char *dirname);</span>
<a href="#l4.296"></a><span id="l4.296" class="difflineplus">+static _WDIR *_wopendir (const wchar_t *dirname);</span>
<a href="#l4.297"></a><span id="l4.297" class="difflineplus">+</span>
<a href="#l4.298"></a><span id="l4.298" class="difflineplus">+static struct dirent *readdir (DIR *dirp);</span>
<a href="#l4.299"></a><span id="l4.299" class="difflineplus">+static struct _wdirent *_wreaddir (_WDIR *dirp);</span>
<a href="#l4.300"></a><span id="l4.300" class="difflineplus">+</span>
<a href="#l4.301"></a><span id="l4.301" class="difflineplus">+static int readdir_r(</span>
<a href="#l4.302"></a><span id="l4.302" class="difflineplus">+    DIR *dirp, struct dirent *entry, struct dirent **result);</span>
<a href="#l4.303"></a><span id="l4.303" class="difflineplus">+static int _wreaddir_r(</span>
<a href="#l4.304"></a><span id="l4.304" class="difflineplus">+    _WDIR *dirp, struct _wdirent *entry, struct _wdirent **result);</span>
<a href="#l4.305"></a><span id="l4.305" class="difflineplus">+</span>
<a href="#l4.306"></a><span id="l4.306" class="difflineplus">+static int closedir (DIR *dirp);</span>
<a href="#l4.307"></a><span id="l4.307" class="difflineplus">+static int _wclosedir (_WDIR *dirp);</span>
<a href="#l4.308"></a><span id="l4.308" class="difflineplus">+</span>
<a href="#l4.309"></a><span id="l4.309" class="difflineplus">+static void rewinddir (DIR* dirp);</span>
<a href="#l4.310"></a><span id="l4.310" class="difflineplus">+static void _wrewinddir (_WDIR* dirp);</span>
<a href="#l4.311"></a><span id="l4.311" class="difflineplus">+</span>
<a href="#l4.312"></a><span id="l4.312" class="difflineplus">+static int scandir (const char *dirname, struct dirent ***namelist,</span>
<a href="#l4.313"></a><span id="l4.313" class="difflineplus">+    int (*filter)(const struct dirent*),</span>
<a href="#l4.314"></a><span id="l4.314" class="difflineplus">+    int (*compare)(const struct dirent**, const struct dirent**));</span>
<a href="#l4.315"></a><span id="l4.315" class="difflineplus">+</span>
<a href="#l4.316"></a><span id="l4.316" class="difflineplus">+static int alphasort (const struct dirent **a, const struct dirent **b);</span>
<a href="#l4.317"></a><span id="l4.317" class="difflineplus">+</span>
<a href="#l4.318"></a><span id="l4.318" class="difflineplus">+static int versionsort (const struct dirent **a, const struct dirent **b);</span>
<a href="#l4.319"></a><span id="l4.319" class="difflineplus">+</span>
<a href="#l4.320"></a><span id="l4.320" class="difflineplus">+</span>
<a href="#l4.321"></a><span id="l4.321" class="difflineplus">+/* For compatibility with Symbian */</span>
<a href="#l4.322"></a><span id="l4.322" class="difflineplus">+#define wdirent _wdirent</span>
<a href="#l4.323"></a><span id="l4.323" class="difflineplus">+#define WDIR _WDIR</span>
<a href="#l4.324"></a><span id="l4.324" class="difflineplus">+#define wopendir _wopendir</span>
<a href="#l4.325"></a><span id="l4.325" class="difflineplus">+#define wreaddir _wreaddir</span>
<a href="#l4.326"></a><span id="l4.326" class="difflineplus">+#define wclosedir _wclosedir</span>
<a href="#l4.327"></a><span id="l4.327" class="difflineplus">+#define wrewinddir _wrewinddir</span>
<a href="#l4.328"></a><span id="l4.328" class="difflineplus">+</span>
<a href="#l4.329"></a><span id="l4.329" class="difflineplus">+</span>
<a href="#l4.330"></a><span id="l4.330" class="difflineplus">+/* Internal utility functions */</span>
<a href="#l4.331"></a><span id="l4.331" class="difflineplus">+static WIN32_FIND_DATAW *dirent_first (_WDIR *dirp);</span>
<a href="#l4.332"></a><span id="l4.332" class="difflineplus">+static WIN32_FIND_DATAW *dirent_next (_WDIR *dirp);</span>
<a href="#l4.333"></a><span id="l4.333" class="difflineplus">+</span>
<a href="#l4.334"></a><span id="l4.334" class="difflineplus">+static int dirent_mbstowcs_s(</span>
<a href="#l4.335"></a><span id="l4.335" class="difflineplus">+    size_t *pReturnValue,</span>
<a href="#l4.336"></a><span id="l4.336" class="difflineplus">+    wchar_t *wcstr,</span>
<a href="#l4.337"></a><span id="l4.337" class="difflineplus">+    size_t sizeInWords,</span>
<a href="#l4.338"></a><span id="l4.338" class="difflineplus">+    const char *mbstr,</span>
<a href="#l4.339"></a><span id="l4.339" class="difflineplus">+    size_t count);</span>
<a href="#l4.340"></a><span id="l4.340" class="difflineplus">+</span>
<a href="#l4.341"></a><span id="l4.341" class="difflineplus">+static int dirent_wcstombs_s(</span>
<a href="#l4.342"></a><span id="l4.342" class="difflineplus">+    size_t *pReturnValue,</span>
<a href="#l4.343"></a><span id="l4.343" class="difflineplus">+    char *mbstr,</span>
<a href="#l4.344"></a><span id="l4.344" class="difflineplus">+    size_t sizeInBytes,</span>
<a href="#l4.345"></a><span id="l4.345" class="difflineplus">+    const wchar_t *wcstr,</span>
<a href="#l4.346"></a><span id="l4.346" class="difflineplus">+    size_t count);</span>
<a href="#l4.347"></a><span id="l4.347" class="difflineplus">+</span>
<a href="#l4.348"></a><span id="l4.348" class="difflineplus">+static void dirent_set_errno (int error);</span>
<a href="#l4.349"></a><span id="l4.349" class="difflineplus">+</span>
<a href="#l4.350"></a><span id="l4.350" class="difflineplus">+</span>
<a href="#l4.351"></a><span id="l4.351" class="difflineplus">+/*</span>
<a href="#l4.352"></a><span id="l4.352" class="difflineplus">+ * Open directory stream DIRNAME for read and return a pointer to the</span>
<a href="#l4.353"></a><span id="l4.353" class="difflineplus">+ * internal working area that is used to retrieve individual directory</span>
<a href="#l4.354"></a><span id="l4.354" class="difflineplus">+ * entries.</span>
<a href="#l4.355"></a><span id="l4.355" class="difflineplus">+ */</span>
<a href="#l4.356"></a><span id="l4.356" class="difflineplus">+static _WDIR*</span>
<a href="#l4.357"></a><span id="l4.357" class="difflineplus">+_wopendir(</span>
<a href="#l4.358"></a><span id="l4.358" class="difflineplus">+    const wchar_t *dirname)</span>
<a href="#l4.359"></a><span id="l4.359" class="difflineplus">+{</span>
<a href="#l4.360"></a><span id="l4.360" class="difflineplus">+    _WDIR *dirp;</span>
<a href="#l4.361"></a><span id="l4.361" class="difflineplus">+    DWORD n;</span>
<a href="#l4.362"></a><span id="l4.362" class="difflineplus">+    wchar_t *p;</span>
<a href="#l4.363"></a><span id="l4.363" class="difflineplus">+</span>
<a href="#l4.364"></a><span id="l4.364" class="difflineplus">+    /* Must have directory name */</span>
<a href="#l4.365"></a><span id="l4.365" class="difflineplus">+    if (dirname == NULL  ||  dirname[0] == '\0') {</span>
<a href="#l4.366"></a><span id="l4.366" class="difflineplus">+        dirent_set_errno (ENOENT);</span>
<a href="#l4.367"></a><span id="l4.367" class="difflineplus">+        return NULL;</span>
<a href="#l4.368"></a><span id="l4.368" class="difflineplus">+    }</span>
<a href="#l4.369"></a><span id="l4.369" class="difflineplus">+</span>
<a href="#l4.370"></a><span id="l4.370" class="difflineplus">+    /* Allocate new _WDIR structure */</span>
<a href="#l4.371"></a><span id="l4.371" class="difflineplus">+    dirp = (_WDIR*) malloc (sizeof (struct _WDIR));</span>
<a href="#l4.372"></a><span id="l4.372" class="difflineplus">+    if (!dirp) {</span>
<a href="#l4.373"></a><span id="l4.373" class="difflineplus">+        return NULL;</span>
<a href="#l4.374"></a><span id="l4.374" class="difflineplus">+    }</span>
<a href="#l4.375"></a><span id="l4.375" class="difflineplus">+</span>
<a href="#l4.376"></a><span id="l4.376" class="difflineplus">+    /* Reset _WDIR structure */</span>
<a href="#l4.377"></a><span id="l4.377" class="difflineplus">+    dirp-&gt;handle = INVALID_HANDLE_VALUE;</span>
<a href="#l4.378"></a><span id="l4.378" class="difflineplus">+    dirp-&gt;patt = NULL;</span>
<a href="#l4.379"></a><span id="l4.379" class="difflineplus">+    dirp-&gt;cached = 0;</span>
<a href="#l4.380"></a><span id="l4.380" class="difflineplus">+</span>
<a href="#l4.381"></a><span id="l4.381" class="difflineplus">+    /*</span>
<a href="#l4.382"></a><span id="l4.382" class="difflineplus">+     * Compute the length of full path plus zero terminator</span>
<a href="#l4.383"></a><span id="l4.383" class="difflineplus">+     *</span>
<a href="#l4.384"></a><span id="l4.384" class="difflineplus">+     * Note that on WinRT there's no way to convert relative paths</span>
<a href="#l4.385"></a><span id="l4.385" class="difflineplus">+     * into absolute paths, so just assume it is an absolute path.</span>
<a href="#l4.386"></a><span id="l4.386" class="difflineplus">+     */</span>
<a href="#l4.387"></a><span id="l4.387" class="difflineplus">+#if WINAPI_FAMILY_PARTITION(WINAPI_PARTITION_DESKTOP)</span>
<a href="#l4.388"></a><span id="l4.388" class="difflineplus">+    /* Desktop */</span>
<a href="#l4.389"></a><span id="l4.389" class="difflineplus">+    n = GetFullPathNameW (dirname, 0, NULL, NULL);</span>
<a href="#l4.390"></a><span id="l4.390" class="difflineplus">+#else</span>
<a href="#l4.391"></a><span id="l4.391" class="difflineplus">+    /* WinRT */</span>
<a href="#l4.392"></a><span id="l4.392" class="difflineplus">+    n = wcslen (dirname);</span>
<a href="#l4.393"></a><span id="l4.393" class="difflineplus">+#endif</span>
<a href="#l4.394"></a><span id="l4.394" class="difflineplus">+</span>
<a href="#l4.395"></a><span id="l4.395" class="difflineplus">+    /* Allocate room for absolute directory name and search pattern */</span>
<a href="#l4.396"></a><span id="l4.396" class="difflineplus">+    dirp-&gt;patt = (wchar_t*) malloc (sizeof (wchar_t) * n + 16);</span>
<a href="#l4.397"></a><span id="l4.397" class="difflineplus">+    if (dirp-&gt;patt == NULL) {</span>
<a href="#l4.398"></a><span id="l4.398" class="difflineplus">+        goto exit_closedir;</span>
<a href="#l4.399"></a><span id="l4.399" class="difflineplus">+    }</span>
<a href="#l4.400"></a><span id="l4.400" class="difflineplus">+</span>
<a href="#l4.401"></a><span id="l4.401" class="difflineplus">+    /*</span>
<a href="#l4.402"></a><span id="l4.402" class="difflineplus">+     * Convert relative directory name to an absolute one.  This</span>
<a href="#l4.403"></a><span id="l4.403" class="difflineplus">+     * allows rewinddir() to function correctly even when current</span>
<a href="#l4.404"></a><span id="l4.404" class="difflineplus">+     * working directory is changed between opendir() and rewinddir().</span>
<a href="#l4.405"></a><span id="l4.405" class="difflineplus">+     *</span>
<a href="#l4.406"></a><span id="l4.406" class="difflineplus">+     * Note that on WinRT there's no way to convert relative paths</span>
<a href="#l4.407"></a><span id="l4.407" class="difflineplus">+     * into absolute paths, so just assume it is an absolute path.</span>
<a href="#l4.408"></a><span id="l4.408" class="difflineplus">+     */</span>
<a href="#l4.409"></a><span id="l4.409" class="difflineplus">+#if WINAPI_FAMILY_PARTITION(WINAPI_PARTITION_DESKTOP)</span>
<a href="#l4.410"></a><span id="l4.410" class="difflineplus">+    /* Desktop */</span>
<a href="#l4.411"></a><span id="l4.411" class="difflineplus">+    n = GetFullPathNameW (dirname, n, dirp-&gt;patt, NULL);</span>
<a href="#l4.412"></a><span id="l4.412" class="difflineplus">+    if (n &lt;= 0) {</span>
<a href="#l4.413"></a><span id="l4.413" class="difflineplus">+        goto exit_closedir;</span>
<a href="#l4.414"></a><span id="l4.414" class="difflineplus">+    }</span>
<a href="#l4.415"></a><span id="l4.415" class="difflineplus">+#else</span>
<a href="#l4.416"></a><span id="l4.416" class="difflineplus">+    /* WinRT */</span>
<a href="#l4.417"></a><span id="l4.417" class="difflineplus">+    wcsncpy_s (dirp-&gt;patt, n+1, dirname, n);</span>
<a href="#l4.418"></a><span id="l4.418" class="difflineplus">+#endif</span>
<a href="#l4.419"></a><span id="l4.419" class="difflineplus">+</span>
<a href="#l4.420"></a><span id="l4.420" class="difflineplus">+    /* Append search pattern \* to the directory name */</span>
<a href="#l4.421"></a><span id="l4.421" class="difflineplus">+    p = dirp-&gt;patt + n;</span>
<a href="#l4.422"></a><span id="l4.422" class="difflineplus">+    switch (p[-1]) {</span>
<a href="#l4.423"></a><span id="l4.423" class="difflineplus">+    case '\\':</span>
<a href="#l4.424"></a><span id="l4.424" class="difflineplus">+    case '/':</span>
<a href="#l4.425"></a><span id="l4.425" class="difflineplus">+    case ':':</span>
<a href="#l4.426"></a><span id="l4.426" class="difflineplus">+        /* Directory ends in path separator, e.g. c:\temp\ */</span>
<a href="#l4.427"></a><span id="l4.427" class="difflineplus">+        /*NOP*/;</span>
<a href="#l4.428"></a><span id="l4.428" class="difflineplus">+        break;</span>
<a href="#l4.429"></a><span id="l4.429" class="difflineplus">+</span>
<a href="#l4.430"></a><span id="l4.430" class="difflineplus">+    default:</span>
<a href="#l4.431"></a><span id="l4.431" class="difflineplus">+        /* Directory name doesn't end in path separator */</span>
<a href="#l4.432"></a><span id="l4.432" class="difflineplus">+        *p++ = '\\';</span>
<a href="#l4.433"></a><span id="l4.433" class="difflineplus">+    }</span>
<a href="#l4.434"></a><span id="l4.434" class="difflineplus">+    *p++ = '*';</span>
<a href="#l4.435"></a><span id="l4.435" class="difflineplus">+    *p = '\0';</span>
<a href="#l4.436"></a><span id="l4.436" class="difflineplus">+</span>
<a href="#l4.437"></a><span id="l4.437" class="difflineplus">+    /* Open directory stream and retrieve the first entry */</span>
<a href="#l4.438"></a><span id="l4.438" class="difflineplus">+    if (!dirent_first (dirp)) {</span>
<a href="#l4.439"></a><span id="l4.439" class="difflineplus">+        goto exit_closedir;</span>
<a href="#l4.440"></a><span id="l4.440" class="difflineplus">+    }</span>
<a href="#l4.441"></a><span id="l4.441" class="difflineplus">+</span>
<a href="#l4.442"></a><span id="l4.442" class="difflineplus">+    /* Success */</span>
<a href="#l4.443"></a><span id="l4.443" class="difflineplus">+    return dirp;</span>
<a href="#l4.444"></a><span id="l4.444" class="difflineplus">+</span>
<a href="#l4.445"></a><span id="l4.445" class="difflineplus">+    /* Failure */</span>
<a href="#l4.446"></a><span id="l4.446" class="difflineplus">+exit_closedir:</span>
<a href="#l4.447"></a><span id="l4.447" class="difflineplus">+    _wclosedir (dirp);</span>
<a href="#l4.448"></a><span id="l4.448" class="difflineplus">+    return NULL;</span>
<a href="#l4.449"></a><span id="l4.449" class="difflineplus">+}</span>
<a href="#l4.450"></a><span id="l4.450" class="difflineplus">+</span>
<a href="#l4.451"></a><span id="l4.451" class="difflineplus">+/*</span>
<a href="#l4.452"></a><span id="l4.452" class="difflineplus">+ * Read next directory entry.</span>
<a href="#l4.453"></a><span id="l4.453" class="difflineplus">+ *</span>
<a href="#l4.454"></a><span id="l4.454" class="difflineplus">+ * Returns pointer to static directory entry which may be overwritten by</span>
<a href="#l4.455"></a><span id="l4.455" class="difflineplus">+ * subsequent calls to _wreaddir().</span>
<a href="#l4.456"></a><span id="l4.456" class="difflineplus">+ */</span>
<a href="#l4.457"></a><span id="l4.457" class="difflineplus">+static struct _wdirent*</span>
<a href="#l4.458"></a><span id="l4.458" class="difflineplus">+_wreaddir(</span>
<a href="#l4.459"></a><span id="l4.459" class="difflineplus">+    _WDIR *dirp)</span>
<a href="#l4.460"></a><span id="l4.460" class="difflineplus">+{</span>
<a href="#l4.461"></a><span id="l4.461" class="difflineplus">+    struct _wdirent *entry;</span>
<a href="#l4.462"></a><span id="l4.462" class="difflineplus">+</span>
<a href="#l4.463"></a><span id="l4.463" class="difflineplus">+    /*</span>
<a href="#l4.464"></a><span id="l4.464" class="difflineplus">+     * Read directory entry to buffer.  We can safely ignore the return value</span>
<a href="#l4.465"></a><span id="l4.465" class="difflineplus">+     * as entry will be set to NULL in case of error.</span>
<a href="#l4.466"></a><span id="l4.466" class="difflineplus">+     */</span>
<a href="#l4.467"></a><span id="l4.467" class="difflineplus">+    (void) _wreaddir_r (dirp, &amp;dirp-&gt;ent, &amp;entry);</span>
<a href="#l4.468"></a><span id="l4.468" class="difflineplus">+</span>
<a href="#l4.469"></a><span id="l4.469" class="difflineplus">+    /* Return pointer to statically allocated directory entry */</span>
<a href="#l4.470"></a><span id="l4.470" class="difflineplus">+    return entry;</span>
<a href="#l4.471"></a><span id="l4.471" class="difflineplus">+}</span>
<a href="#l4.472"></a><span id="l4.472" class="difflineplus">+</span>
<a href="#l4.473"></a><span id="l4.473" class="difflineplus">+/*</span>
<a href="#l4.474"></a><span id="l4.474" class="difflineplus">+ * Read next directory entry.</span>
<a href="#l4.475"></a><span id="l4.475" class="difflineplus">+ *</span>
<a href="#l4.476"></a><span id="l4.476" class="difflineplus">+ * Returns zero on success.  If end of directory stream is reached, then sets</span>
<a href="#l4.477"></a><span id="l4.477" class="difflineplus">+ * result to NULL and returns zero.</span>
<a href="#l4.478"></a><span id="l4.478" class="difflineplus">+ */</span>
<a href="#l4.479"></a><span id="l4.479" class="difflineplus">+static int</span>
<a href="#l4.480"></a><span id="l4.480" class="difflineplus">+_wreaddir_r(</span>
<a href="#l4.481"></a><span id="l4.481" class="difflineplus">+    _WDIR *dirp,</span>
<a href="#l4.482"></a><span id="l4.482" class="difflineplus">+    struct _wdirent *entry,</span>
<a href="#l4.483"></a><span id="l4.483" class="difflineplus">+    struct _wdirent **result)</span>
<a href="#l4.484"></a><span id="l4.484" class="difflineplus">+{</span>
<a href="#l4.485"></a><span id="l4.485" class="difflineplus">+    WIN32_FIND_DATAW *datap;</span>
<a href="#l4.486"></a><span id="l4.486" class="difflineplus">+</span>
<a href="#l4.487"></a><span id="l4.487" class="difflineplus">+    /* Read next directory entry */</span>
<a href="#l4.488"></a><span id="l4.488" class="difflineplus">+    datap = dirent_next (dirp);</span>
<a href="#l4.489"></a><span id="l4.489" class="difflineplus">+    if (datap) {</span>
<a href="#l4.490"></a><span id="l4.490" class="difflineplus">+        size_t n;</span>
<a href="#l4.491"></a><span id="l4.491" class="difflineplus">+        DWORD attr;</span>
<a href="#l4.492"></a><span id="l4.492" class="difflineplus">+</span>
<a href="#l4.493"></a><span id="l4.493" class="difflineplus">+        /*</span>
<a href="#l4.494"></a><span id="l4.494" class="difflineplus">+         * Copy file name as wide-character string.  If the file name is too</span>
<a href="#l4.495"></a><span id="l4.495" class="difflineplus">+         * long to fit in to the destination buffer, then truncate file name</span>
<a href="#l4.496"></a><span id="l4.496" class="difflineplus">+         * to PATH_MAX characters and zero-terminate the buffer.</span>
<a href="#l4.497"></a><span id="l4.497" class="difflineplus">+         */</span>
<a href="#l4.498"></a><span id="l4.498" class="difflineplus">+        n = 0;</span>
<a href="#l4.499"></a><span id="l4.499" class="difflineplus">+        while (n &lt; PATH_MAX  &amp;&amp;  datap-&gt;cFileName[n] != 0) {</span>
<a href="#l4.500"></a><span id="l4.500" class="difflineplus">+            entry-&gt;d_name[n] = datap-&gt;cFileName[n];</span>
<a href="#l4.501"></a><span id="l4.501" class="difflineplus">+            n++;</span>
<a href="#l4.502"></a><span id="l4.502" class="difflineplus">+        }</span>
<a href="#l4.503"></a><span id="l4.503" class="difflineplus">+        entry-&gt;d_name[n] = 0;</span>
<a href="#l4.504"></a><span id="l4.504" class="difflineplus">+</span>
<a href="#l4.505"></a><span id="l4.505" class="difflineplus">+        /* Length of file name excluding zero terminator */</span>
<a href="#l4.506"></a><span id="l4.506" class="difflineplus">+        entry-&gt;d_namlen = n;</span>
<a href="#l4.507"></a><span id="l4.507" class="difflineplus">+</span>
<a href="#l4.508"></a><span id="l4.508" class="difflineplus">+        /* File type */</span>
<a href="#l4.509"></a><span id="l4.509" class="difflineplus">+        attr = datap-&gt;dwFileAttributes;</span>
<a href="#l4.510"></a><span id="l4.510" class="difflineplus">+        if ((attr &amp; FILE_ATTRIBUTE_DEVICE) != 0) {</span>
<a href="#l4.511"></a><span id="l4.511" class="difflineplus">+            entry-&gt;d_type = DT_CHR;</span>
<a href="#l4.512"></a><span id="l4.512" class="difflineplus">+        } else if ((attr &amp; FILE_ATTRIBUTE_DIRECTORY) != 0) {</span>
<a href="#l4.513"></a><span id="l4.513" class="difflineplus">+            entry-&gt;d_type = DT_DIR;</span>
<a href="#l4.514"></a><span id="l4.514" class="difflineplus">+        } else {</span>
<a href="#l4.515"></a><span id="l4.515" class="difflineplus">+            entry-&gt;d_type = DT_REG;</span>
<a href="#l4.516"></a><span id="l4.516" class="difflineplus">+        }</span>
<a href="#l4.517"></a><span id="l4.517" class="difflineplus">+</span>
<a href="#l4.518"></a><span id="l4.518" class="difflineplus">+        /* Reset dummy fields */</span>
<a href="#l4.519"></a><span id="l4.519" class="difflineplus">+        entry-&gt;d_ino = 0;</span>
<a href="#l4.520"></a><span id="l4.520" class="difflineplus">+        entry-&gt;d_off = 0;</span>
<a href="#l4.521"></a><span id="l4.521" class="difflineplus">+        entry-&gt;d_reclen = sizeof (struct _wdirent);</span>
<a href="#l4.522"></a><span id="l4.522" class="difflineplus">+</span>
<a href="#l4.523"></a><span id="l4.523" class="difflineplus">+        /* Set result address */</span>
<a href="#l4.524"></a><span id="l4.524" class="difflineplus">+        *result = entry;</span>
<a href="#l4.525"></a><span id="l4.525" class="difflineplus">+</span>
<a href="#l4.526"></a><span id="l4.526" class="difflineplus">+    } else {</span>
<a href="#l4.527"></a><span id="l4.527" class="difflineplus">+</span>
<a href="#l4.528"></a><span id="l4.528" class="difflineplus">+        /* Return NULL to indicate end of directory */</span>
<a href="#l4.529"></a><span id="l4.529" class="difflineplus">+        *result = NULL;</span>
<a href="#l4.530"></a><span id="l4.530" class="difflineplus">+</span>
<a href="#l4.531"></a><span id="l4.531" class="difflineplus">+    }</span>
<a href="#l4.532"></a><span id="l4.532" class="difflineplus">+</span>
<a href="#l4.533"></a><span id="l4.533" class="difflineplus">+    return /*OK*/0;</span>
<a href="#l4.534"></a><span id="l4.534" class="difflineplus">+}</span>
<a href="#l4.535"></a><span id="l4.535" class="difflineplus">+</span>
<a href="#l4.536"></a><span id="l4.536" class="difflineplus">+/*</span>
<a href="#l4.537"></a><span id="l4.537" class="difflineplus">+ * Close directory stream opened by opendir() function.  This invalidates the</span>
<a href="#l4.538"></a><span id="l4.538" class="difflineplus">+ * DIR structure as well as any directory entry read previously by</span>
<a href="#l4.539"></a><span id="l4.539" class="difflineplus">+ * _wreaddir().</span>
<a href="#l4.540"></a><span id="l4.540" class="difflineplus">+ */</span>
<a href="#l4.541"></a><span id="l4.541" class="difflineplus">+static int</span>
<a href="#l4.542"></a><span id="l4.542" class="difflineplus">+_wclosedir(</span>
<a href="#l4.543"></a><span id="l4.543" class="difflineplus">+    _WDIR *dirp)</span>
<a href="#l4.544"></a><span id="l4.544" class="difflineplus">+{</span>
<a href="#l4.545"></a><span id="l4.545" class="difflineplus">+    int ok;</span>
<a href="#l4.546"></a><span id="l4.546" class="difflineplus">+    if (dirp) {</span>
<a href="#l4.547"></a><span id="l4.547" class="difflineplus">+</span>
<a href="#l4.548"></a><span id="l4.548" class="difflineplus">+        /* Release search handle */</span>
<a href="#l4.549"></a><span id="l4.549" class="difflineplus">+        if (dirp-&gt;handle != INVALID_HANDLE_VALUE) {</span>
<a href="#l4.550"></a><span id="l4.550" class="difflineplus">+            FindClose (dirp-&gt;handle);</span>
<a href="#l4.551"></a><span id="l4.551" class="difflineplus">+        }</span>
<a href="#l4.552"></a><span id="l4.552" class="difflineplus">+</span>
<a href="#l4.553"></a><span id="l4.553" class="difflineplus">+        /* Release search pattern */</span>
<a href="#l4.554"></a><span id="l4.554" class="difflineplus">+        free (dirp-&gt;patt);</span>
<a href="#l4.555"></a><span id="l4.555" class="difflineplus">+</span>
<a href="#l4.556"></a><span id="l4.556" class="difflineplus">+        /* Release directory structure */</span>
<a href="#l4.557"></a><span id="l4.557" class="difflineplus">+        free (dirp);</span>
<a href="#l4.558"></a><span id="l4.558" class="difflineplus">+        ok = /*success*/0;</span>
<a href="#l4.559"></a><span id="l4.559" class="difflineplus">+</span>
<a href="#l4.560"></a><span id="l4.560" class="difflineplus">+    } else {</span>
<a href="#l4.561"></a><span id="l4.561" class="difflineplus">+</span>
<a href="#l4.562"></a><span id="l4.562" class="difflineplus">+        /* Invalid directory stream */</span>
<a href="#l4.563"></a><span id="l4.563" class="difflineplus">+        dirent_set_errno (EBADF);</span>
<a href="#l4.564"></a><span id="l4.564" class="difflineplus">+        ok = /*failure*/-1;</span>
<a href="#l4.565"></a><span id="l4.565" class="difflineplus">+</span>
<a href="#l4.566"></a><span id="l4.566" class="difflineplus">+    }</span>
<a href="#l4.567"></a><span id="l4.567" class="difflineplus">+    return ok;</span>
<a href="#l4.568"></a><span id="l4.568" class="difflineplus">+}</span>
<a href="#l4.569"></a><span id="l4.569" class="difflineplus">+</span>
<a href="#l4.570"></a><span id="l4.570" class="difflineplus">+/*</span>
<a href="#l4.571"></a><span id="l4.571" class="difflineplus">+ * Rewind directory stream such that _wreaddir() returns the very first</span>
<a href="#l4.572"></a><span id="l4.572" class="difflineplus">+ * file name again.</span>
<a href="#l4.573"></a><span id="l4.573" class="difflineplus">+ */</span>
<a href="#l4.574"></a><span id="l4.574" class="difflineplus">+static void</span>
<a href="#l4.575"></a><span id="l4.575" class="difflineplus">+_wrewinddir(</span>
<a href="#l4.576"></a><span id="l4.576" class="difflineplus">+    _WDIR* dirp)</span>
<a href="#l4.577"></a><span id="l4.577" class="difflineplus">+{</span>
<a href="#l4.578"></a><span id="l4.578" class="difflineplus">+    if (dirp) {</span>
<a href="#l4.579"></a><span id="l4.579" class="difflineplus">+        /* Release existing search handle */</span>
<a href="#l4.580"></a><span id="l4.580" class="difflineplus">+        if (dirp-&gt;handle != INVALID_HANDLE_VALUE) {</span>
<a href="#l4.581"></a><span id="l4.581" class="difflineplus">+            FindClose (dirp-&gt;handle);</span>
<a href="#l4.582"></a><span id="l4.582" class="difflineplus">+        }</span>
<a href="#l4.583"></a><span id="l4.583" class="difflineplus">+</span>
<a href="#l4.584"></a><span id="l4.584" class="difflineplus">+        /* Open new search handle */</span>
<a href="#l4.585"></a><span id="l4.585" class="difflineplus">+        dirent_first (dirp);</span>
<a href="#l4.586"></a><span id="l4.586" class="difflineplus">+    }</span>
<a href="#l4.587"></a><span id="l4.587" class="difflineplus">+}</span>
<a href="#l4.588"></a><span id="l4.588" class="difflineplus">+</span>
<a href="#l4.589"></a><span id="l4.589" class="difflineplus">+/* Get first directory entry (internal) */</span>
<a href="#l4.590"></a><span id="l4.590" class="difflineplus">+static WIN32_FIND_DATAW*</span>
<a href="#l4.591"></a><span id="l4.591" class="difflineplus">+dirent_first(</span>
<a href="#l4.592"></a><span id="l4.592" class="difflineplus">+    _WDIR *dirp)</span>
<a href="#l4.593"></a><span id="l4.593" class="difflineplus">+{</span>
<a href="#l4.594"></a><span id="l4.594" class="difflineplus">+    WIN32_FIND_DATAW *datap;</span>
<a href="#l4.595"></a><span id="l4.595" class="difflineplus">+    DWORD error;</span>
<a href="#l4.596"></a><span id="l4.596" class="difflineplus">+</span>
<a href="#l4.597"></a><span id="l4.597" class="difflineplus">+    /* Open directory and retrieve the first entry */</span>
<a href="#l4.598"></a><span id="l4.598" class="difflineplus">+    dirp-&gt;handle = FindFirstFileExW(</span>
<a href="#l4.599"></a><span id="l4.599" class="difflineplus">+        dirp-&gt;patt, FindExInfoStandard, &amp;dirp-&gt;data,</span>
<a href="#l4.600"></a><span id="l4.600" class="difflineplus">+        FindExSearchNameMatch, NULL, 0);</span>
<a href="#l4.601"></a><span id="l4.601" class="difflineplus">+    if (dirp-&gt;handle != INVALID_HANDLE_VALUE) {</span>
<a href="#l4.602"></a><span id="l4.602" class="difflineplus">+</span>
<a href="#l4.603"></a><span id="l4.603" class="difflineplus">+        /* a directory entry is now waiting in memory */</span>
<a href="#l4.604"></a><span id="l4.604" class="difflineplus">+        datap = &amp;dirp-&gt;data;</span>
<a href="#l4.605"></a><span id="l4.605" class="difflineplus">+        dirp-&gt;cached = 1;</span>
<a href="#l4.606"></a><span id="l4.606" class="difflineplus">+</span>
<a href="#l4.607"></a><span id="l4.607" class="difflineplus">+    } else {</span>
<a href="#l4.608"></a><span id="l4.608" class="difflineplus">+</span>
<a href="#l4.609"></a><span id="l4.609" class="difflineplus">+        /* Failed to open directory: no directory entry in memory */</span>
<a href="#l4.610"></a><span id="l4.610" class="difflineplus">+        dirp-&gt;cached = 0;</span>
<a href="#l4.611"></a><span id="l4.611" class="difflineplus">+        datap = NULL;</span>
<a href="#l4.612"></a><span id="l4.612" class="difflineplus">+</span>
<a href="#l4.613"></a><span id="l4.613" class="difflineplus">+        /* Set error code */</span>
<a href="#l4.614"></a><span id="l4.614" class="difflineplus">+        error = GetLastError ();</span>
<a href="#l4.615"></a><span id="l4.615" class="difflineplus">+        switch (error) {</span>
<a href="#l4.616"></a><span id="l4.616" class="difflineplus">+        case ERROR_ACCESS_DENIED:</span>
<a href="#l4.617"></a><span id="l4.617" class="difflineplus">+            /* No read access to directory */</span>
<a href="#l4.618"></a><span id="l4.618" class="difflineplus">+            dirent_set_errno (EACCES);</span>
<a href="#l4.619"></a><span id="l4.619" class="difflineplus">+            break;</span>
<a href="#l4.620"></a><span id="l4.620" class="difflineplus">+</span>
<a href="#l4.621"></a><span id="l4.621" class="difflineplus">+        case ERROR_DIRECTORY:</span>
<a href="#l4.622"></a><span id="l4.622" class="difflineplus">+            /* Directory name is invalid */</span>
<a href="#l4.623"></a><span id="l4.623" class="difflineplus">+            dirent_set_errno (ENOTDIR);</span>
<a href="#l4.624"></a><span id="l4.624" class="difflineplus">+            break;</span>
<a href="#l4.625"></a><span id="l4.625" class="difflineplus">+</span>
<a href="#l4.626"></a><span id="l4.626" class="difflineplus">+        case ERROR_PATH_NOT_FOUND:</span>
<a href="#l4.627"></a><span id="l4.627" class="difflineplus">+        default:</span>
<a href="#l4.628"></a><span id="l4.628" class="difflineplus">+            /* Cannot find the file */</span>
<a href="#l4.629"></a><span id="l4.629" class="difflineplus">+            dirent_set_errno (ENOENT);</span>
<a href="#l4.630"></a><span id="l4.630" class="difflineplus">+        }</span>
<a href="#l4.631"></a><span id="l4.631" class="difflineplus">+</span>
<a href="#l4.632"></a><span id="l4.632" class="difflineplus">+    }</span>
<a href="#l4.633"></a><span id="l4.633" class="difflineplus">+    return datap;</span>
<a href="#l4.634"></a><span id="l4.634" class="difflineplus">+}</span>
<a href="#l4.635"></a><span id="l4.635" class="difflineplus">+</span>
<a href="#l4.636"></a><span id="l4.636" class="difflineplus">+/*</span>
<a href="#l4.637"></a><span id="l4.637" class="difflineplus">+ * Get next directory entry (internal).</span>
<a href="#l4.638"></a><span id="l4.638" class="difflineplus">+ *</span>
<a href="#l4.639"></a><span id="l4.639" class="difflineplus">+ * Returns</span>
<a href="#l4.640"></a><span id="l4.640" class="difflineplus">+ */</span>
<a href="#l4.641"></a><span id="l4.641" class="difflineplus">+static WIN32_FIND_DATAW*</span>
<a href="#l4.642"></a><span id="l4.642" class="difflineplus">+dirent_next(</span>
<a href="#l4.643"></a><span id="l4.643" class="difflineplus">+    _WDIR *dirp)</span>
<a href="#l4.644"></a><span id="l4.644" class="difflineplus">+{</span>
<a href="#l4.645"></a><span id="l4.645" class="difflineplus">+    WIN32_FIND_DATAW *p;</span>
<a href="#l4.646"></a><span id="l4.646" class="difflineplus">+</span>
<a href="#l4.647"></a><span id="l4.647" class="difflineplus">+    /* Get next directory entry */</span>
<a href="#l4.648"></a><span id="l4.648" class="difflineplus">+    if (dirp-&gt;cached != 0) {</span>
<a href="#l4.649"></a><span id="l4.649" class="difflineplus">+</span>
<a href="#l4.650"></a><span id="l4.650" class="difflineplus">+        /* A valid directory entry already in memory */</span>
<a href="#l4.651"></a><span id="l4.651" class="difflineplus">+        p = &amp;dirp-&gt;data;</span>
<a href="#l4.652"></a><span id="l4.652" class="difflineplus">+        dirp-&gt;cached = 0;</span>
<a href="#l4.653"></a><span id="l4.653" class="difflineplus">+</span>
<a href="#l4.654"></a><span id="l4.654" class="difflineplus">+    } else if (dirp-&gt;handle != INVALID_HANDLE_VALUE) {</span>
<a href="#l4.655"></a><span id="l4.655" class="difflineplus">+</span>
<a href="#l4.656"></a><span id="l4.656" class="difflineplus">+        /* Get the next directory entry from stream */</span>
<a href="#l4.657"></a><span id="l4.657" class="difflineplus">+        if (FindNextFileW (dirp-&gt;handle, &amp;dirp-&gt;data) != FALSE) {</span>
<a href="#l4.658"></a><span id="l4.658" class="difflineplus">+            /* Got a file */</span>
<a href="#l4.659"></a><span id="l4.659" class="difflineplus">+            p = &amp;dirp-&gt;data;</span>
<a href="#l4.660"></a><span id="l4.660" class="difflineplus">+        } else {</span>
<a href="#l4.661"></a><span id="l4.661" class="difflineplus">+            /* The very last entry has been processed or an error occurred */</span>
<a href="#l4.662"></a><span id="l4.662" class="difflineplus">+            FindClose (dirp-&gt;handle);</span>
<a href="#l4.663"></a><span id="l4.663" class="difflineplus">+            dirp-&gt;handle = INVALID_HANDLE_VALUE;</span>
<a href="#l4.664"></a><span id="l4.664" class="difflineplus">+            p = NULL;</span>
<a href="#l4.665"></a><span id="l4.665" class="difflineplus">+        }</span>
<a href="#l4.666"></a><span id="l4.666" class="difflineplus">+</span>
<a href="#l4.667"></a><span id="l4.667" class="difflineplus">+    } else {</span>
<a href="#l4.668"></a><span id="l4.668" class="difflineplus">+</span>
<a href="#l4.669"></a><span id="l4.669" class="difflineplus">+        /* End of directory stream reached */</span>
<a href="#l4.670"></a><span id="l4.670" class="difflineplus">+        p = NULL;</span>
<a href="#l4.671"></a><span id="l4.671" class="difflineplus">+</span>
<a href="#l4.672"></a><span id="l4.672" class="difflineplus">+    }</span>
<a href="#l4.673"></a><span id="l4.673" class="difflineplus">+</span>
<a href="#l4.674"></a><span id="l4.674" class="difflineplus">+    return p;</span>
<a href="#l4.675"></a><span id="l4.675" class="difflineplus">+}</span>
<a href="#l4.676"></a><span id="l4.676" class="difflineplus">+</span>
<a href="#l4.677"></a><span id="l4.677" class="difflineplus">+/*</span>
<a href="#l4.678"></a><span id="l4.678" class="difflineplus">+ * Open directory stream using plain old C-string.</span>
<a href="#l4.679"></a><span id="l4.679" class="difflineplus">+ */</span>
<a href="#l4.680"></a><span id="l4.680" class="difflineplus">+static DIR*</span>
<a href="#l4.681"></a><span id="l4.681" class="difflineplus">+opendir(</span>
<a href="#l4.682"></a><span id="l4.682" class="difflineplus">+    const char *dirname)</span>
<a href="#l4.683"></a><span id="l4.683" class="difflineplus">+{</span>
<a href="#l4.684"></a><span id="l4.684" class="difflineplus">+    struct DIR *dirp;</span>
<a href="#l4.685"></a><span id="l4.685" class="difflineplus">+</span>
<a href="#l4.686"></a><span id="l4.686" class="difflineplus">+    /* Must have directory name */</span>
<a href="#l4.687"></a><span id="l4.687" class="difflineplus">+    if (dirname == NULL  ||  dirname[0] == '\0') {</span>
<a href="#l4.688"></a><span id="l4.688" class="difflineplus">+        dirent_set_errno (ENOENT);</span>
<a href="#l4.689"></a><span id="l4.689" class="difflineplus">+        return NULL;</span>
<a href="#l4.690"></a><span id="l4.690" class="difflineplus">+    }</span>
<a href="#l4.691"></a><span id="l4.691" class="difflineplus">+</span>
<a href="#l4.692"></a><span id="l4.692" class="difflineplus">+    /* Allocate memory for DIR structure */</span>
<a href="#l4.693"></a><span id="l4.693" class="difflineplus">+    dirp = (DIR*) malloc (sizeof (struct DIR));</span>
<a href="#l4.694"></a><span id="l4.694" class="difflineplus">+    if (!dirp) {</span>
<a href="#l4.695"></a><span id="l4.695" class="difflineplus">+        return NULL;</span>
<a href="#l4.696"></a><span id="l4.696" class="difflineplus">+    }</span>
<a href="#l4.697"></a><span id="l4.697" class="difflineplus">+    {</span>
<a href="#l4.698"></a><span id="l4.698" class="difflineplus">+        int error;</span>
<a href="#l4.699"></a><span id="l4.699" class="difflineplus">+        wchar_t wname[PATH_MAX + 1];</span>
<a href="#l4.700"></a><span id="l4.700" class="difflineplus">+        size_t n;</span>
<a href="#l4.701"></a><span id="l4.701" class="difflineplus">+</span>
<a href="#l4.702"></a><span id="l4.702" class="difflineplus">+        /* Convert directory name to wide-character string */</span>
<a href="#l4.703"></a><span id="l4.703" class="difflineplus">+        error = dirent_mbstowcs_s(</span>
<a href="#l4.704"></a><span id="l4.704" class="difflineplus">+            &amp;n, wname, PATH_MAX + 1, dirname, PATH_MAX + 1);</span>
<a href="#l4.705"></a><span id="l4.705" class="difflineplus">+        if (error) {</span>
<a href="#l4.706"></a><span id="l4.706" class="difflineplus">+            /*</span>
<a href="#l4.707"></a><span id="l4.707" class="difflineplus">+             * Cannot convert file name to wide-character string.  This</span>
<a href="#l4.708"></a><span id="l4.708" class="difflineplus">+             * occurs if the string contains invalid multi-byte sequences or</span>
<a href="#l4.709"></a><span id="l4.709" class="difflineplus">+             * the output buffer is too small to contain the resulting</span>
<a href="#l4.710"></a><span id="l4.710" class="difflineplus">+             * string.</span>
<a href="#l4.711"></a><span id="l4.711" class="difflineplus">+             */</span>
<a href="#l4.712"></a><span id="l4.712" class="difflineplus">+            goto exit_free;</span>
<a href="#l4.713"></a><span id="l4.713" class="difflineplus">+        }</span>
<a href="#l4.714"></a><span id="l4.714" class="difflineplus">+</span>
<a href="#l4.715"></a><span id="l4.715" class="difflineplus">+</span>
<a href="#l4.716"></a><span id="l4.716" class="difflineplus">+        /* Open directory stream using wide-character name */</span>
<a href="#l4.717"></a><span id="l4.717" class="difflineplus">+        dirp-&gt;wdirp = _wopendir (wname);</span>
<a href="#l4.718"></a><span id="l4.718" class="difflineplus">+        if (!dirp-&gt;wdirp) {</span>
<a href="#l4.719"></a><span id="l4.719" class="difflineplus">+            goto exit_free;</span>
<a href="#l4.720"></a><span id="l4.720" class="difflineplus">+        }</span>
<a href="#l4.721"></a><span id="l4.721" class="difflineplus">+</span>
<a href="#l4.722"></a><span id="l4.722" class="difflineplus">+    }</span>
<a href="#l4.723"></a><span id="l4.723" class="difflineplus">+</span>
<a href="#l4.724"></a><span id="l4.724" class="difflineplus">+    /* Success */</span>
<a href="#l4.725"></a><span id="l4.725" class="difflineplus">+    return dirp;</span>
<a href="#l4.726"></a><span id="l4.726" class="difflineplus">+</span>
<a href="#l4.727"></a><span id="l4.727" class="difflineplus">+    /* Failure */</span>
<a href="#l4.728"></a><span id="l4.728" class="difflineplus">+exit_free:</span>
<a href="#l4.729"></a><span id="l4.729" class="difflineplus">+    free (dirp);</span>
<a href="#l4.730"></a><span id="l4.730" class="difflineplus">+    return NULL;</span>
<a href="#l4.731"></a><span id="l4.731" class="difflineplus">+}</span>
<a href="#l4.732"></a><span id="l4.732" class="difflineplus">+</span>
<a href="#l4.733"></a><span id="l4.733" class="difflineplus">+/*</span>
<a href="#l4.734"></a><span id="l4.734" class="difflineplus">+ * Read next directory entry.</span>
<a href="#l4.735"></a><span id="l4.735" class="difflineplus">+ */</span>
<a href="#l4.736"></a><span id="l4.736" class="difflineplus">+static struct dirent*</span>
<a href="#l4.737"></a><span id="l4.737" class="difflineplus">+readdir(</span>
<a href="#l4.738"></a><span id="l4.738" class="difflineplus">+    DIR *dirp)</span>
<a href="#l4.739"></a><span id="l4.739" class="difflineplus">+{</span>
<a href="#l4.740"></a><span id="l4.740" class="difflineplus">+    struct dirent *entry;</span>
<a href="#l4.741"></a><span id="l4.741" class="difflineplus">+</span>
<a href="#l4.742"></a><span id="l4.742" class="difflineplus">+    /*</span>
<a href="#l4.743"></a><span id="l4.743" class="difflineplus">+     * Read directory entry to buffer.  We can safely ignore the return value</span>
<a href="#l4.744"></a><span id="l4.744" class="difflineplus">+     * as entry will be set to NULL in case of error.</span>
<a href="#l4.745"></a><span id="l4.745" class="difflineplus">+     */</span>
<a href="#l4.746"></a><span id="l4.746" class="difflineplus">+    (void) readdir_r (dirp, &amp;dirp-&gt;ent, &amp;entry);</span>
<a href="#l4.747"></a><span id="l4.747" class="difflineplus">+</span>
<a href="#l4.748"></a><span id="l4.748" class="difflineplus">+    /* Return pointer to statically allocated directory entry */</span>
<a href="#l4.749"></a><span id="l4.749" class="difflineplus">+    return entry;</span>
<a href="#l4.750"></a><span id="l4.750" class="difflineplus">+}</span>
<a href="#l4.751"></a><span id="l4.751" class="difflineplus">+</span>
<a href="#l4.752"></a><span id="l4.752" class="difflineplus">+/*</span>
<a href="#l4.753"></a><span id="l4.753" class="difflineplus">+ * Read next directory entry into called-allocated buffer.</span>
<a href="#l4.754"></a><span id="l4.754" class="difflineplus">+ *</span>
<a href="#l4.755"></a><span id="l4.755" class="difflineplus">+ * Returns zero on success.  If the end of directory stream is reached, then</span>
<a href="#l4.756"></a><span id="l4.756" class="difflineplus">+ * sets result to NULL and returns zero.</span>
<a href="#l4.757"></a><span id="l4.757" class="difflineplus">+ */</span>
<a href="#l4.758"></a><span id="l4.758" class="difflineplus">+static int</span>
<a href="#l4.759"></a><span id="l4.759" class="difflineplus">+readdir_r(</span>
<a href="#l4.760"></a><span id="l4.760" class="difflineplus">+    DIR *dirp,</span>
<a href="#l4.761"></a><span id="l4.761" class="difflineplus">+    struct dirent *entry,</span>
<a href="#l4.762"></a><span id="l4.762" class="difflineplus">+    struct dirent **result)</span>
<a href="#l4.763"></a><span id="l4.763" class="difflineplus">+{</span>
<a href="#l4.764"></a><span id="l4.764" class="difflineplus">+    WIN32_FIND_DATAW *datap;</span>
<a href="#l4.765"></a><span id="l4.765" class="difflineplus">+</span>
<a href="#l4.766"></a><span id="l4.766" class="difflineplus">+    /* Read next directory entry */</span>
<a href="#l4.767"></a><span id="l4.767" class="difflineplus">+    datap = dirent_next (dirp-&gt;wdirp);</span>
<a href="#l4.768"></a><span id="l4.768" class="difflineplus">+    if (datap) {</span>
<a href="#l4.769"></a><span id="l4.769" class="difflineplus">+        size_t n;</span>
<a href="#l4.770"></a><span id="l4.770" class="difflineplus">+        int error;</span>
<a href="#l4.771"></a><span id="l4.771" class="difflineplus">+</span>
<a href="#l4.772"></a><span id="l4.772" class="difflineplus">+        /* Attempt to convert file name to multi-byte string */</span>
<a href="#l4.773"></a><span id="l4.773" class="difflineplus">+        error = dirent_wcstombs_s(</span>
<a href="#l4.774"></a><span id="l4.774" class="difflineplus">+            &amp;n, entry-&gt;d_name, PATH_MAX + 1, datap-&gt;cFileName, PATH_MAX + 1);</span>
<a href="#l4.775"></a><span id="l4.775" class="difflineplus">+</span>
<a href="#l4.776"></a><span id="l4.776" class="difflineplus">+        /*</span>
<a href="#l4.777"></a><span id="l4.777" class="difflineplus">+         * If the file name cannot be represented by a multi-byte string,</span>
<a href="#l4.778"></a><span id="l4.778" class="difflineplus">+         * then attempt to use old 8+3 file name.  This allows traditional</span>
<a href="#l4.779"></a><span id="l4.779" class="difflineplus">+         * Unix-code to access some file names despite of unicode</span>
<a href="#l4.780"></a><span id="l4.780" class="difflineplus">+         * characters, although file names may seem unfamiliar to the user.</span>
<a href="#l4.781"></a><span id="l4.781" class="difflineplus">+         *</span>
<a href="#l4.782"></a><span id="l4.782" class="difflineplus">+         * Be ware that the code below cannot come up with a short file</span>
<a href="#l4.783"></a><span id="l4.783" class="difflineplus">+         * name unless the file system provides one.  At least</span>
<a href="#l4.784"></a><span id="l4.784" class="difflineplus">+         * VirtualBox shared folders fail to do this.</span>
<a href="#l4.785"></a><span id="l4.785" class="difflineplus">+         */</span>
<a href="#l4.786"></a><span id="l4.786" class="difflineplus">+        if (error  &amp;&amp;  datap-&gt;cAlternateFileName[0] != '\0') {</span>
<a href="#l4.787"></a><span id="l4.787" class="difflineplus">+            error = dirent_wcstombs_s(</span>
<a href="#l4.788"></a><span id="l4.788" class="difflineplus">+                &amp;n, entry-&gt;d_name, PATH_MAX + 1,</span>
<a href="#l4.789"></a><span id="l4.789" class="difflineplus">+                datap-&gt;cAlternateFileName, PATH_MAX + 1);</span>
<a href="#l4.790"></a><span id="l4.790" class="difflineplus">+        }</span>
<a href="#l4.791"></a><span id="l4.791" class="difflineplus">+</span>
<a href="#l4.792"></a><span id="l4.792" class="difflineplus">+        if (!error) {</span>
<a href="#l4.793"></a><span id="l4.793" class="difflineplus">+            DWORD attr;</span>
<a href="#l4.794"></a><span id="l4.794" class="difflineplus">+</span>
<a href="#l4.795"></a><span id="l4.795" class="difflineplus">+            /* Length of file name excluding zero terminator */</span>
<a href="#l4.796"></a><span id="l4.796" class="difflineplus">+            entry-&gt;d_namlen = n - 1;</span>
<a href="#l4.797"></a><span id="l4.797" class="difflineplus">+</span>
<a href="#l4.798"></a><span id="l4.798" class="difflineplus">+            /* File attributes */</span>
<a href="#l4.799"></a><span id="l4.799" class="difflineplus">+            attr = datap-&gt;dwFileAttributes;</span>
<a href="#l4.800"></a><span id="l4.800" class="difflineplus">+            if ((attr &amp; FILE_ATTRIBUTE_DEVICE) != 0) {</span>
<a href="#l4.801"></a><span id="l4.801" class="difflineplus">+                entry-&gt;d_type = DT_CHR;</span>
<a href="#l4.802"></a><span id="l4.802" class="difflineplus">+            } else if ((attr &amp; FILE_ATTRIBUTE_DIRECTORY) != 0) {</span>
<a href="#l4.803"></a><span id="l4.803" class="difflineplus">+                entry-&gt;d_type = DT_DIR;</span>
<a href="#l4.804"></a><span id="l4.804" class="difflineplus">+            } else {</span>
<a href="#l4.805"></a><span id="l4.805" class="difflineplus">+                entry-&gt;d_type = DT_REG;</span>
<a href="#l4.806"></a><span id="l4.806" class="difflineplus">+            }</span>
<a href="#l4.807"></a><span id="l4.807" class="difflineplus">+</span>
<a href="#l4.808"></a><span id="l4.808" class="difflineplus">+            /* Reset dummy fields */</span>
<a href="#l4.809"></a><span id="l4.809" class="difflineplus">+            entry-&gt;d_ino = 0;</span>
<a href="#l4.810"></a><span id="l4.810" class="difflineplus">+            entry-&gt;d_off = 0;</span>
<a href="#l4.811"></a><span id="l4.811" class="difflineplus">+            entry-&gt;d_reclen = sizeof (struct dirent);</span>
<a href="#l4.812"></a><span id="l4.812" class="difflineplus">+</span>
<a href="#l4.813"></a><span id="l4.813" class="difflineplus">+        } else {</span>
<a href="#l4.814"></a><span id="l4.814" class="difflineplus">+</span>
<a href="#l4.815"></a><span id="l4.815" class="difflineplus">+            /*</span>
<a href="#l4.816"></a><span id="l4.816" class="difflineplus">+             * Cannot convert file name to multi-byte string so construct</span>
<a href="#l4.817"></a><span id="l4.817" class="difflineplus">+             * an erroneous directory entry and return that.  Note that</span>
<a href="#l4.818"></a><span id="l4.818" class="difflineplus">+             * we cannot return NULL as that would stop the processing</span>
<a href="#l4.819"></a><span id="l4.819" class="difflineplus">+             * of directory entries completely.</span>
<a href="#l4.820"></a><span id="l4.820" class="difflineplus">+             */</span>
<a href="#l4.821"></a><span id="l4.821" class="difflineplus">+            entry-&gt;d_name[0] = '?';</span>
<a href="#l4.822"></a><span id="l4.822" class="difflineplus">+            entry-&gt;d_name[1] = '\0';</span>
<a href="#l4.823"></a><span id="l4.823" class="difflineplus">+            entry-&gt;d_namlen = 1;</span>
<a href="#l4.824"></a><span id="l4.824" class="difflineplus">+            entry-&gt;d_type = DT_UNKNOWN;</span>
<a href="#l4.825"></a><span id="l4.825" class="difflineplus">+            entry-&gt;d_ino = 0;</span>
<a href="#l4.826"></a><span id="l4.826" class="difflineplus">+            entry-&gt;d_off = -1;</span>
<a href="#l4.827"></a><span id="l4.827" class="difflineplus">+            entry-&gt;d_reclen = 0;</span>
<a href="#l4.828"></a><span id="l4.828" class="difflineplus">+</span>
<a href="#l4.829"></a><span id="l4.829" class="difflineplus">+        }</span>
<a href="#l4.830"></a><span id="l4.830" class="difflineplus">+</span>
<a href="#l4.831"></a><span id="l4.831" class="difflineplus">+        /* Return pointer to directory entry */</span>
<a href="#l4.832"></a><span id="l4.832" class="difflineplus">+        *result = entry;</span>
<a href="#l4.833"></a><span id="l4.833" class="difflineplus">+</span>
<a href="#l4.834"></a><span id="l4.834" class="difflineplus">+    } else {</span>
<a href="#l4.835"></a><span id="l4.835" class="difflineplus">+</span>
<a href="#l4.836"></a><span id="l4.836" class="difflineplus">+        /* No more directory entries */</span>
<a href="#l4.837"></a><span id="l4.837" class="difflineplus">+        *result = NULL;</span>
<a href="#l4.838"></a><span id="l4.838" class="difflineplus">+</span>
<a href="#l4.839"></a><span id="l4.839" class="difflineplus">+    }</span>
<a href="#l4.840"></a><span id="l4.840" class="difflineplus">+</span>
<a href="#l4.841"></a><span id="l4.841" class="difflineplus">+    return /*OK*/0;</span>
<a href="#l4.842"></a><span id="l4.842" class="difflineplus">+}</span>
<a href="#l4.843"></a><span id="l4.843" class="difflineplus">+</span>
<a href="#l4.844"></a><span id="l4.844" class="difflineplus">+/*</span>
<a href="#l4.845"></a><span id="l4.845" class="difflineplus">+ * Close directory stream.</span>
<a href="#l4.846"></a><span id="l4.846" class="difflineplus">+ */</span>
<a href="#l4.847"></a><span id="l4.847" class="difflineplus">+static int</span>
<a href="#l4.848"></a><span id="l4.848" class="difflineplus">+closedir(</span>
<a href="#l4.849"></a><span id="l4.849" class="difflineplus">+    DIR *dirp)</span>
<a href="#l4.850"></a><span id="l4.850" class="difflineplus">+{</span>
<a href="#l4.851"></a><span id="l4.851" class="difflineplus">+    int ok;</span>
<a href="#l4.852"></a><span id="l4.852" class="difflineplus">+    if (dirp) {</span>
<a href="#l4.853"></a><span id="l4.853" class="difflineplus">+</span>
<a href="#l4.854"></a><span id="l4.854" class="difflineplus">+        /* Close wide-character directory stream */</span>
<a href="#l4.855"></a><span id="l4.855" class="difflineplus">+        ok = _wclosedir (dirp-&gt;wdirp);</span>
<a href="#l4.856"></a><span id="l4.856" class="difflineplus">+        dirp-&gt;wdirp = NULL;</span>
<a href="#l4.857"></a><span id="l4.857" class="difflineplus">+</span>
<a href="#l4.858"></a><span id="l4.858" class="difflineplus">+        /* Release multi-byte character version */</span>
<a href="#l4.859"></a><span id="l4.859" class="difflineplus">+        free (dirp);</span>
<a href="#l4.860"></a><span id="l4.860" class="difflineplus">+</span>
<a href="#l4.861"></a><span id="l4.861" class="difflineplus">+    } else {</span>
<a href="#l4.862"></a><span id="l4.862" class="difflineplus">+</span>
<a href="#l4.863"></a><span id="l4.863" class="difflineplus">+        /* Invalid directory stream */</span>
<a href="#l4.864"></a><span id="l4.864" class="difflineplus">+        dirent_set_errno (EBADF);</span>
<a href="#l4.865"></a><span id="l4.865" class="difflineplus">+        ok = /*failure*/-1;</span>
<a href="#l4.866"></a><span id="l4.866" class="difflineplus">+</span>
<a href="#l4.867"></a><span id="l4.867" class="difflineplus">+    }</span>
<a href="#l4.868"></a><span id="l4.868" class="difflineplus">+    return ok;</span>
<a href="#l4.869"></a><span id="l4.869" class="difflineplus">+}</span>
<a href="#l4.870"></a><span id="l4.870" class="difflineplus">+</span>
<a href="#l4.871"></a><span id="l4.871" class="difflineplus">+/*</span>
<a href="#l4.872"></a><span id="l4.872" class="difflineplus">+ * Rewind directory stream to beginning.</span>
<a href="#l4.873"></a><span id="l4.873" class="difflineplus">+ */</span>
<a href="#l4.874"></a><span id="l4.874" class="difflineplus">+static void</span>
<a href="#l4.875"></a><span id="l4.875" class="difflineplus">+rewinddir(</span>
<a href="#l4.876"></a><span id="l4.876" class="difflineplus">+    DIR* dirp)</span>
<a href="#l4.877"></a><span id="l4.877" class="difflineplus">+{</span>
<a href="#l4.878"></a><span id="l4.878" class="difflineplus">+    /* Rewind wide-character string directory stream */</span>
<a href="#l4.879"></a><span id="l4.879" class="difflineplus">+    _wrewinddir (dirp-&gt;wdirp);</span>
<a href="#l4.880"></a><span id="l4.880" class="difflineplus">+}</span>
<a href="#l4.881"></a><span id="l4.881" class="difflineplus">+</span>
<a href="#l4.882"></a><span id="l4.882" class="difflineplus">+/*</span>
<a href="#l4.883"></a><span id="l4.883" class="difflineplus">+ * Scan directory for entries.</span>
<a href="#l4.884"></a><span id="l4.884" class="difflineplus">+ */</span>
<a href="#l4.885"></a><span id="l4.885" class="difflineplus">+static int</span>
<a href="#l4.886"></a><span id="l4.886" class="difflineplus">+scandir(</span>
<a href="#l4.887"></a><span id="l4.887" class="difflineplus">+    const char *dirname,</span>
<a href="#l4.888"></a><span id="l4.888" class="difflineplus">+    struct dirent ***namelist,</span>
<a href="#l4.889"></a><span id="l4.889" class="difflineplus">+    int (*filter)(const struct dirent*),</span>
<a href="#l4.890"></a><span id="l4.890" class="difflineplus">+    int (*compare)(const struct dirent**, const struct dirent**))</span>
<a href="#l4.891"></a><span id="l4.891" class="difflineplus">+{</span>
<a href="#l4.892"></a><span id="l4.892" class="difflineplus">+    struct dirent **files = NULL;</span>
<a href="#l4.893"></a><span id="l4.893" class="difflineplus">+    size_t size = 0;</span>
<a href="#l4.894"></a><span id="l4.894" class="difflineplus">+    size_t allocated = 0;</span>
<a href="#l4.895"></a><span id="l4.895" class="difflineplus">+    const size_t init_size = 1;</span>
<a href="#l4.896"></a><span id="l4.896" class="difflineplus">+    DIR *dir = NULL;</span>
<a href="#l4.897"></a><span id="l4.897" class="difflineplus">+    struct dirent *entry;</span>
<a href="#l4.898"></a><span id="l4.898" class="difflineplus">+    struct dirent *tmp = NULL;</span>
<a href="#l4.899"></a><span id="l4.899" class="difflineplus">+    size_t i;</span>
<a href="#l4.900"></a><span id="l4.900" class="difflineplus">+    int result = 0;</span>
<a href="#l4.901"></a><span id="l4.901" class="difflineplus">+</span>
<a href="#l4.902"></a><span id="l4.902" class="difflineplus">+    /* Open directory stream */</span>
<a href="#l4.903"></a><span id="l4.903" class="difflineplus">+    dir = opendir (dirname);</span>
<a href="#l4.904"></a><span id="l4.904" class="difflineplus">+    if (dir) {</span>
<a href="#l4.905"></a><span id="l4.905" class="difflineplus">+</span>
<a href="#l4.906"></a><span id="l4.906" class="difflineplus">+        /* Read directory entries to memory */</span>
<a href="#l4.907"></a><span id="l4.907" class="difflineplus">+        while (1) {</span>
<a href="#l4.908"></a><span id="l4.908" class="difflineplus">+</span>
<a href="#l4.909"></a><span id="l4.909" class="difflineplus">+            /* Enlarge pointer table to make room for another pointer */</span>
<a href="#l4.910"></a><span id="l4.910" class="difflineplus">+            if (size &gt;= allocated) {</span>
<a href="#l4.911"></a><span id="l4.911" class="difflineplus">+                void *p;</span>
<a href="#l4.912"></a><span id="l4.912" class="difflineplus">+                size_t num_entries;</span>
<a href="#l4.913"></a><span id="l4.913" class="difflineplus">+</span>
<a href="#l4.914"></a><span id="l4.914" class="difflineplus">+                /* Compute number of entries in the enlarged pointer table */</span>
<a href="#l4.915"></a><span id="l4.915" class="difflineplus">+                if (size &lt; init_size) {</span>
<a href="#l4.916"></a><span id="l4.916" class="difflineplus">+                    /* Allocate initial pointer table */</span>
<a href="#l4.917"></a><span id="l4.917" class="difflineplus">+                    num_entries = init_size;</span>
<a href="#l4.918"></a><span id="l4.918" class="difflineplus">+                } else {</span>
<a href="#l4.919"></a><span id="l4.919" class="difflineplus">+                    /* Double the size */</span>
<a href="#l4.920"></a><span id="l4.920" class="difflineplus">+                    num_entries = size * 2;</span>
<a href="#l4.921"></a><span id="l4.921" class="difflineplus">+                }</span>
<a href="#l4.922"></a><span id="l4.922" class="difflineplus">+</span>
<a href="#l4.923"></a><span id="l4.923" class="difflineplus">+                /* Allocate first pointer table or enlarge existing table */</span>
<a href="#l4.924"></a><span id="l4.924" class="difflineplus">+                p = realloc (files, sizeof (void*) * num_entries);</span>
<a href="#l4.925"></a><span id="l4.925" class="difflineplus">+                if (p != NULL) {</span>
<a href="#l4.926"></a><span id="l4.926" class="difflineplus">+                    /* Got the memory */</span>
<a href="#l4.927"></a><span id="l4.927" class="difflineplus">+                    files = (dirent**) p;</span>
<a href="#l4.928"></a><span id="l4.928" class="difflineplus">+                    allocated = num_entries;</span>
<a href="#l4.929"></a><span id="l4.929" class="difflineplus">+                } else {</span>
<a href="#l4.930"></a><span id="l4.930" class="difflineplus">+                    /* Out of memory */</span>
<a href="#l4.931"></a><span id="l4.931" class="difflineplus">+                    result = -1;</span>
<a href="#l4.932"></a><span id="l4.932" class="difflineplus">+                    break;</span>
<a href="#l4.933"></a><span id="l4.933" class="difflineplus">+                }</span>
<a href="#l4.934"></a><span id="l4.934" class="difflineplus">+</span>
<a href="#l4.935"></a><span id="l4.935" class="difflineplus">+            }</span>
<a href="#l4.936"></a><span id="l4.936" class="difflineplus">+</span>
<a href="#l4.937"></a><span id="l4.937" class="difflineplus">+            /* Allocate room for temporary directory entry */</span>
<a href="#l4.938"></a><span id="l4.938" class="difflineplus">+            if (tmp == NULL) {</span>
<a href="#l4.939"></a><span id="l4.939" class="difflineplus">+                tmp = (struct dirent*) malloc (sizeof (struct dirent));</span>
<a href="#l4.940"></a><span id="l4.940" class="difflineplus">+                if (tmp == NULL) {</span>
<a href="#l4.941"></a><span id="l4.941" class="difflineplus">+                    /* Cannot allocate temporary directory entry */</span>
<a href="#l4.942"></a><span id="l4.942" class="difflineplus">+                    result = -1;</span>
<a href="#l4.943"></a><span id="l4.943" class="difflineplus">+                    break;</span>
<a href="#l4.944"></a><span id="l4.944" class="difflineplus">+                }</span>
<a href="#l4.945"></a><span id="l4.945" class="difflineplus">+            }</span>
<a href="#l4.946"></a><span id="l4.946" class="difflineplus">+</span>
<a href="#l4.947"></a><span id="l4.947" class="difflineplus">+            /* Read directory entry to temporary area */</span>
<a href="#l4.948"></a><span id="l4.948" class="difflineplus">+            if (readdir_r (dir, tmp, &amp;entry) == /*OK*/0) {</span>
<a href="#l4.949"></a><span id="l4.949" class="difflineplus">+</span>
<a href="#l4.950"></a><span id="l4.950" class="difflineplus">+                /* Did we get an entry? */</span>
<a href="#l4.951"></a><span id="l4.951" class="difflineplus">+                if (entry != NULL) {</span>
<a href="#l4.952"></a><span id="l4.952" class="difflineplus">+                    int pass;</span>
<a href="#l4.953"></a><span id="l4.953" class="difflineplus">+</span>
<a href="#l4.954"></a><span id="l4.954" class="difflineplus">+                    /* Determine whether to include the entry in result */</span>
<a href="#l4.955"></a><span id="l4.955" class="difflineplus">+                    if (filter) {</span>
<a href="#l4.956"></a><span id="l4.956" class="difflineplus">+                        /* Let the filter function decide */</span>
<a href="#l4.957"></a><span id="l4.957" class="difflineplus">+                        pass = filter (tmp);</span>
<a href="#l4.958"></a><span id="l4.958" class="difflineplus">+                    } else {</span>
<a href="#l4.959"></a><span id="l4.959" class="difflineplus">+                        /* No filter function, include everything */</span>
<a href="#l4.960"></a><span id="l4.960" class="difflineplus">+                        pass = 1;</span>
<a href="#l4.961"></a><span id="l4.961" class="difflineplus">+                    }</span>
<a href="#l4.962"></a><span id="l4.962" class="difflineplus">+</span>
<a href="#l4.963"></a><span id="l4.963" class="difflineplus">+                    if (pass) {</span>
<a href="#l4.964"></a><span id="l4.964" class="difflineplus">+                        /* Store the temporary entry to pointer table */</span>
<a href="#l4.965"></a><span id="l4.965" class="difflineplus">+                        files[size++] = tmp;</span>
<a href="#l4.966"></a><span id="l4.966" class="difflineplus">+                        tmp = NULL;</span>
<a href="#l4.967"></a><span id="l4.967" class="difflineplus">+</span>
<a href="#l4.968"></a><span id="l4.968" class="difflineplus">+                        /* Keep up with the number of files */</span>
<a href="#l4.969"></a><span id="l4.969" class="difflineplus">+                        result++;</span>
<a href="#l4.970"></a><span id="l4.970" class="difflineplus">+                    }</span>
<a href="#l4.971"></a><span id="l4.971" class="difflineplus">+</span>
<a href="#l4.972"></a><span id="l4.972" class="difflineplus">+                } else {</span>
<a href="#l4.973"></a><span id="l4.973" class="difflineplus">+</span>
<a href="#l4.974"></a><span id="l4.974" class="difflineplus">+                    /*</span>
<a href="#l4.975"></a><span id="l4.975" class="difflineplus">+                     * End of directory stream reached =&gt; sort entries and</span>
<a href="#l4.976"></a><span id="l4.976" class="difflineplus">+                     * exit.</span>
<a href="#l4.977"></a><span id="l4.977" class="difflineplus">+                     */</span>
<a href="#l4.978"></a><span id="l4.978" class="difflineplus">+                    qsort (files, size, sizeof (void*),</span>
<a href="#l4.979"></a><span id="l4.979" class="difflineplus">+                        (int (*) (const void*, const void*)) compare);</span>
<a href="#l4.980"></a><span id="l4.980" class="difflineplus">+                    break;</span>
<a href="#l4.981"></a><span id="l4.981" class="difflineplus">+</span>
<a href="#l4.982"></a><span id="l4.982" class="difflineplus">+                }</span>
<a href="#l4.983"></a><span id="l4.983" class="difflineplus">+</span>
<a href="#l4.984"></a><span id="l4.984" class="difflineplus">+            } else {</span>
<a href="#l4.985"></a><span id="l4.985" class="difflineplus">+                /* Error reading directory entry */</span>
<a href="#l4.986"></a><span id="l4.986" class="difflineplus">+                result = /*Error*/ -1;</span>
<a href="#l4.987"></a><span id="l4.987" class="difflineplus">+                break;</span>
<a href="#l4.988"></a><span id="l4.988" class="difflineplus">+            }</span>
<a href="#l4.989"></a><span id="l4.989" class="difflineplus">+</span>
<a href="#l4.990"></a><span id="l4.990" class="difflineplus">+        }</span>
<a href="#l4.991"></a><span id="l4.991" class="difflineplus">+</span>
<a href="#l4.992"></a><span id="l4.992" class="difflineplus">+    } else {</span>
<a href="#l4.993"></a><span id="l4.993" class="difflineplus">+        /* Cannot open directory */</span>
<a href="#l4.994"></a><span id="l4.994" class="difflineplus">+        result = /*Error*/ -1;</span>
<a href="#l4.995"></a><span id="l4.995" class="difflineplus">+    }</span>
<a href="#l4.996"></a><span id="l4.996" class="difflineplus">+</span>
<a href="#l4.997"></a><span id="l4.997" class="difflineplus">+    /* Release temporary directory entry */</span>
<a href="#l4.998"></a><span id="l4.998" class="difflineplus">+    free (tmp);</span>
<a href="#l4.999"></a><span id="l4.999" class="difflineplus">+</span>
<a href="#l4.1000"></a><span id="l4.1000" class="difflineplus">+    /* Release allocated memory on error */</span>
<a href="#l4.1001"></a><span id="l4.1001" class="difflineplus">+    if (result &lt; 0) {</span>
<a href="#l4.1002"></a><span id="l4.1002" class="difflineplus">+        for (i = 0; i &lt; size; i++) {</span>
<a href="#l4.1003"></a><span id="l4.1003" class="difflineplus">+            free (files[i]);</span>
<a href="#l4.1004"></a><span id="l4.1004" class="difflineplus">+        }</span>
<a href="#l4.1005"></a><span id="l4.1005" class="difflineplus">+        free (files);</span>
<a href="#l4.1006"></a><span id="l4.1006" class="difflineplus">+        files = NULL;</span>
<a href="#l4.1007"></a><span id="l4.1007" class="difflineplus">+    }</span>
<a href="#l4.1008"></a><span id="l4.1008" class="difflineplus">+</span>
<a href="#l4.1009"></a><span id="l4.1009" class="difflineplus">+    /* Close directory stream */</span>
<a href="#l4.1010"></a><span id="l4.1010" class="difflineplus">+    if (dir) {</span>
<a href="#l4.1011"></a><span id="l4.1011" class="difflineplus">+        closedir (dir);</span>
<a href="#l4.1012"></a><span id="l4.1012" class="difflineplus">+    }</span>
<a href="#l4.1013"></a><span id="l4.1013" class="difflineplus">+</span>
<a href="#l4.1014"></a><span id="l4.1014" class="difflineplus">+    /* Pass pointer table to caller */</span>
<a href="#l4.1015"></a><span id="l4.1015" class="difflineplus">+    if (namelist) {</span>
<a href="#l4.1016"></a><span id="l4.1016" class="difflineplus">+        *namelist = files;</span>
<a href="#l4.1017"></a><span id="l4.1017" class="difflineplus">+    }</span>
<a href="#l4.1018"></a><span id="l4.1018" class="difflineplus">+    return result;</span>
<a href="#l4.1019"></a><span id="l4.1019" class="difflineplus">+}</span>
<a href="#l4.1020"></a><span id="l4.1020" class="difflineplus">+</span>
<a href="#l4.1021"></a><span id="l4.1021" class="difflineplus">+/* Alphabetical sorting */</span>
<a href="#l4.1022"></a><span id="l4.1022" class="difflineplus">+static int</span>
<a href="#l4.1023"></a><span id="l4.1023" class="difflineplus">+alphasort(</span>
<a href="#l4.1024"></a><span id="l4.1024" class="difflineplus">+    const struct dirent **a, const struct dirent **b)</span>
<a href="#l4.1025"></a><span id="l4.1025" class="difflineplus">+{</span>
<a href="#l4.1026"></a><span id="l4.1026" class="difflineplus">+    return strcoll ((*a)-&gt;d_name, (*b)-&gt;d_name);</span>
<a href="#l4.1027"></a><span id="l4.1027" class="difflineplus">+}</span>
<a href="#l4.1028"></a><span id="l4.1028" class="difflineplus">+</span>
<a href="#l4.1029"></a><span id="l4.1029" class="difflineplus">+/* Sort versions */</span>
<a href="#l4.1030"></a><span id="l4.1030" class="difflineplus">+static int</span>
<a href="#l4.1031"></a><span id="l4.1031" class="difflineplus">+versionsort(</span>
<a href="#l4.1032"></a><span id="l4.1032" class="difflineplus">+    const struct dirent **a, const struct dirent **b)</span>
<a href="#l4.1033"></a><span id="l4.1033" class="difflineplus">+{</span>
<a href="#l4.1034"></a><span id="l4.1034" class="difflineplus">+    /* FIXME: implement strverscmp and use that */</span>
<a href="#l4.1035"></a><span id="l4.1035" class="difflineplus">+    return alphasort (a, b);</span>
<a href="#l4.1036"></a><span id="l4.1036" class="difflineplus">+}</span>
<a href="#l4.1037"></a><span id="l4.1037" class="difflineplus">+</span>
<a href="#l4.1038"></a><span id="l4.1038" class="difflineplus">+/* Convert multi-byte string to wide character string */</span>
<a href="#l4.1039"></a><span id="l4.1039" class="difflineplus">+static int</span>
<a href="#l4.1040"></a><span id="l4.1040" class="difflineplus">+dirent_mbstowcs_s(</span>
<a href="#l4.1041"></a><span id="l4.1041" class="difflineplus">+    size_t *pReturnValue,</span>
<a href="#l4.1042"></a><span id="l4.1042" class="difflineplus">+    wchar_t *wcstr,</span>
<a href="#l4.1043"></a><span id="l4.1043" class="difflineplus">+    size_t sizeInWords,</span>
<a href="#l4.1044"></a><span id="l4.1044" class="difflineplus">+    const char *mbstr,</span>
<a href="#l4.1045"></a><span id="l4.1045" class="difflineplus">+    size_t count)</span>
<a href="#l4.1046"></a><span id="l4.1046" class="difflineplus">+{</span>
<a href="#l4.1047"></a><span id="l4.1047" class="difflineplus">+    int error;</span>
<a href="#l4.1048"></a><span id="l4.1048" class="difflineplus">+</span>
<a href="#l4.1049"></a><span id="l4.1049" class="difflineplus">+#if defined(_MSC_VER)  &amp;&amp;  _MSC_VER &gt;= 1400</span>
<a href="#l4.1050"></a><span id="l4.1050" class="difflineplus">+</span>
<a href="#l4.1051"></a><span id="l4.1051" class="difflineplus">+    /* Microsoft Visual Studio 2005 or later */</span>
<a href="#l4.1052"></a><span id="l4.1052" class="difflineplus">+    error = mbstowcs_s (pReturnValue, wcstr, sizeInWords, mbstr, count);</span>
<a href="#l4.1053"></a><span id="l4.1053" class="difflineplus">+</span>
<a href="#l4.1054"></a><span id="l4.1054" class="difflineplus">+#else</span>
<a href="#l4.1055"></a><span id="l4.1055" class="difflineplus">+</span>
<a href="#l4.1056"></a><span id="l4.1056" class="difflineplus">+    /* Older Visual Studio or non-Microsoft compiler */</span>
<a href="#l4.1057"></a><span id="l4.1057" class="difflineplus">+    size_t n;</span>
<a href="#l4.1058"></a><span id="l4.1058" class="difflineplus">+</span>
<a href="#l4.1059"></a><span id="l4.1059" class="difflineplus">+    /* Convert to wide-character string (or count characters) */</span>
<a href="#l4.1060"></a><span id="l4.1060" class="difflineplus">+    n = mbstowcs (wcstr, mbstr, sizeInWords);</span>
<a href="#l4.1061"></a><span id="l4.1061" class="difflineplus">+    if (!wcstr  ||  n &lt; count) {</span>
<a href="#l4.1062"></a><span id="l4.1062" class="difflineplus">+</span>
<a href="#l4.1063"></a><span id="l4.1063" class="difflineplus">+        /* Zero-terminate output buffer */</span>
<a href="#l4.1064"></a><span id="l4.1064" class="difflineplus">+        if (wcstr  &amp;&amp;  sizeInWords) {</span>
<a href="#l4.1065"></a><span id="l4.1065" class="difflineplus">+            if (n &gt;= sizeInWords) {</span>
<a href="#l4.1066"></a><span id="l4.1066" class="difflineplus">+                n = sizeInWords - 1;</span>
<a href="#l4.1067"></a><span id="l4.1067" class="difflineplus">+            }</span>
<a href="#l4.1068"></a><span id="l4.1068" class="difflineplus">+            wcstr[n] = 0;</span>
<a href="#l4.1069"></a><span id="l4.1069" class="difflineplus">+        }</span>
<a href="#l4.1070"></a><span id="l4.1070" class="difflineplus">+</span>
<a href="#l4.1071"></a><span id="l4.1071" class="difflineplus">+        /* Length of resulting multi-byte string WITH zero terminator */</span>
<a href="#l4.1072"></a><span id="l4.1072" class="difflineplus">+        if (pReturnValue) {</span>
<a href="#l4.1073"></a><span id="l4.1073" class="difflineplus">+            *pReturnValue = n + 1;</span>
<a href="#l4.1074"></a><span id="l4.1074" class="difflineplus">+        }</span>
<a href="#l4.1075"></a><span id="l4.1075" class="difflineplus">+</span>
<a href="#l4.1076"></a><span id="l4.1076" class="difflineplus">+        /* Success */</span>
<a href="#l4.1077"></a><span id="l4.1077" class="difflineplus">+        error = 0;</span>
<a href="#l4.1078"></a><span id="l4.1078" class="difflineplus">+</span>
<a href="#l4.1079"></a><span id="l4.1079" class="difflineplus">+    } else {</span>
<a href="#l4.1080"></a><span id="l4.1080" class="difflineplus">+</span>
<a href="#l4.1081"></a><span id="l4.1081" class="difflineplus">+        /* Could not convert string */</span>
<a href="#l4.1082"></a><span id="l4.1082" class="difflineplus">+        error = 1;</span>
<a href="#l4.1083"></a><span id="l4.1083" class="difflineplus">+</span>
<a href="#l4.1084"></a><span id="l4.1084" class="difflineplus">+    }</span>
<a href="#l4.1085"></a><span id="l4.1085" class="difflineplus">+</span>
<a href="#l4.1086"></a><span id="l4.1086" class="difflineplus">+#endif</span>
<a href="#l4.1087"></a><span id="l4.1087" class="difflineplus">+    return error;</span>
<a href="#l4.1088"></a><span id="l4.1088" class="difflineplus">+}</span>
<a href="#l4.1089"></a><span id="l4.1089" class="difflineplus">+</span>
<a href="#l4.1090"></a><span id="l4.1090" class="difflineplus">+/* Convert wide-character string to multi-byte string */</span>
<a href="#l4.1091"></a><span id="l4.1091" class="difflineplus">+static int</span>
<a href="#l4.1092"></a><span id="l4.1092" class="difflineplus">+dirent_wcstombs_s(</span>
<a href="#l4.1093"></a><span id="l4.1093" class="difflineplus">+    size_t *pReturnValue,</span>
<a href="#l4.1094"></a><span id="l4.1094" class="difflineplus">+    char *mbstr,</span>
<a href="#l4.1095"></a><span id="l4.1095" class="difflineplus">+    size_t sizeInBytes, /* max size of mbstr */</span>
<a href="#l4.1096"></a><span id="l4.1096" class="difflineplus">+    const wchar_t *wcstr,</span>
<a href="#l4.1097"></a><span id="l4.1097" class="difflineplus">+    size_t count)</span>
<a href="#l4.1098"></a><span id="l4.1098" class="difflineplus">+{</span>
<a href="#l4.1099"></a><span id="l4.1099" class="difflineplus">+    int error;</span>
<a href="#l4.1100"></a><span id="l4.1100" class="difflineplus">+</span>
<a href="#l4.1101"></a><span id="l4.1101" class="difflineplus">+#if defined(_MSC_VER)  &amp;&amp;  _MSC_VER &gt;= 1400</span>
<a href="#l4.1102"></a><span id="l4.1102" class="difflineplus">+</span>
<a href="#l4.1103"></a><span id="l4.1103" class="difflineplus">+    /* Microsoft Visual Studio 2005 or later */</span>
<a href="#l4.1104"></a><span id="l4.1104" class="difflineplus">+    error = wcstombs_s (pReturnValue, mbstr, sizeInBytes, wcstr, count);</span>
<a href="#l4.1105"></a><span id="l4.1105" class="difflineplus">+</span>
<a href="#l4.1106"></a><span id="l4.1106" class="difflineplus">+#else</span>
<a href="#l4.1107"></a><span id="l4.1107" class="difflineplus">+</span>
<a href="#l4.1108"></a><span id="l4.1108" class="difflineplus">+    /* Older Visual Studio or non-Microsoft compiler */</span>
<a href="#l4.1109"></a><span id="l4.1109" class="difflineplus">+    size_t n;</span>
<a href="#l4.1110"></a><span id="l4.1110" class="difflineplus">+</span>
<a href="#l4.1111"></a><span id="l4.1111" class="difflineplus">+    /* Convert to multi-byte string (or count the number of bytes needed) */</span>
<a href="#l4.1112"></a><span id="l4.1112" class="difflineplus">+    n = wcstombs (mbstr, wcstr, sizeInBytes);</span>
<a href="#l4.1113"></a><span id="l4.1113" class="difflineplus">+    if (!mbstr  ||  n &lt; count) {</span>
<a href="#l4.1114"></a><span id="l4.1114" class="difflineplus">+</span>
<a href="#l4.1115"></a><span id="l4.1115" class="difflineplus">+        /* Zero-terminate output buffer */</span>
<a href="#l4.1116"></a><span id="l4.1116" class="difflineplus">+        if (mbstr  &amp;&amp;  sizeInBytes) {</span>
<a href="#l4.1117"></a><span id="l4.1117" class="difflineplus">+            if (n &gt;= sizeInBytes) {</span>
<a href="#l4.1118"></a><span id="l4.1118" class="difflineplus">+                n = sizeInBytes - 1;</span>
<a href="#l4.1119"></a><span id="l4.1119" class="difflineplus">+            }</span>
<a href="#l4.1120"></a><span id="l4.1120" class="difflineplus">+            mbstr[n] = '\0';</span>
<a href="#l4.1121"></a><span id="l4.1121" class="difflineplus">+        }</span>
<a href="#l4.1122"></a><span id="l4.1122" class="difflineplus">+</span>
<a href="#l4.1123"></a><span id="l4.1123" class="difflineplus">+        /* Length of resulting multi-bytes string WITH zero-terminator */</span>
<a href="#l4.1124"></a><span id="l4.1124" class="difflineplus">+        if (pReturnValue) {</span>
<a href="#l4.1125"></a><span id="l4.1125" class="difflineplus">+            *pReturnValue = n + 1;</span>
<a href="#l4.1126"></a><span id="l4.1126" class="difflineplus">+        }</span>
<a href="#l4.1127"></a><span id="l4.1127" class="difflineplus">+</span>
<a href="#l4.1128"></a><span id="l4.1128" class="difflineplus">+        /* Success */</span>
<a href="#l4.1129"></a><span id="l4.1129" class="difflineplus">+        error = 0;</span>
<a href="#l4.1130"></a><span id="l4.1130" class="difflineplus">+</span>
<a href="#l4.1131"></a><span id="l4.1131" class="difflineplus">+    } else {</span>
<a href="#l4.1132"></a><span id="l4.1132" class="difflineplus">+</span>
<a href="#l4.1133"></a><span id="l4.1133" class="difflineplus">+        /* Cannot convert string */</span>
<a href="#l4.1134"></a><span id="l4.1134" class="difflineplus">+        error = 1;</span>
<a href="#l4.1135"></a><span id="l4.1135" class="difflineplus">+</span>
<a href="#l4.1136"></a><span id="l4.1136" class="difflineplus">+    }</span>
<a href="#l4.1137"></a><span id="l4.1137" class="difflineplus">+</span>
<a href="#l4.1138"></a><span id="l4.1138" class="difflineplus">+#endif</span>
<a href="#l4.1139"></a><span id="l4.1139" class="difflineplus">+    return error;</span>
<a href="#l4.1140"></a><span id="l4.1140" class="difflineplus">+}</span>
<a href="#l4.1141"></a><span id="l4.1141" class="difflineplus">+</span>
<a href="#l4.1142"></a><span id="l4.1142" class="difflineplus">+/* Set errno variable */</span>
<a href="#l4.1143"></a><span id="l4.1143" class="difflineplus">+static void</span>
<a href="#l4.1144"></a><span id="l4.1144" class="difflineplus">+dirent_set_errno(</span>
<a href="#l4.1145"></a><span id="l4.1145" class="difflineplus">+    int error)</span>
<a href="#l4.1146"></a><span id="l4.1146" class="difflineplus">+{</span>
<a href="#l4.1147"></a><span id="l4.1147" class="difflineplus">+#if defined(_MSC_VER)  &amp;&amp;  _MSC_VER &gt;= 1400</span>
<a href="#l4.1148"></a><span id="l4.1148" class="difflineplus">+</span>
<a href="#l4.1149"></a><span id="l4.1149" class="difflineplus">+    /* Microsoft Visual Studio 2005 and later */</span>
<a href="#l4.1150"></a><span id="l4.1150" class="difflineplus">+    _set_errno (error);</span>
<a href="#l4.1151"></a><span id="l4.1151" class="difflineplus">+</span>
<a href="#l4.1152"></a><span id="l4.1152" class="difflineplus">+#else</span>
<a href="#l4.1153"></a><span id="l4.1153" class="difflineplus">+</span>
<a href="#l4.1154"></a><span id="l4.1154" class="difflineplus">+    /* Non-Microsoft compiler or older Microsoft compiler */</span>
<a href="#l4.1155"></a><span id="l4.1155" class="difflineplus">+    errno = error;</span>
<a href="#l4.1156"></a><span id="l4.1156" class="difflineplus">+</span>
<a href="#l4.1157"></a><span id="l4.1157" class="difflineplus">+#endif</span>
<a href="#l4.1158"></a><span id="l4.1158" class="difflineplus">+}</span>
<a href="#l4.1159"></a><span id="l4.1159" class="difflineplus">+</span>
<a href="#l4.1160"></a><span id="l4.1160" class="difflineplus">+</span>
<a href="#l4.1161"></a><span id="l4.1161" class="difflineplus">+#ifdef __cplusplus</span>
<a href="#l4.1162"></a><span id="l4.1162" class="difflineplus">+}</span>
<a href="#l4.1163"></a><span id="l4.1163" class="difflineplus">+#endif</span>
<a href="#l4.1164"></a><span id="l4.1164" class="difflineplus">+#endif /*DIRENT_H*/</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">new file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- /dev/null</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ b/third_party/niwcompat/niw_compat.h</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -0,0 +1,65 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineplus">+/* niw_compat.h</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineplus">+ * Any copyright is dedicated to the Public Domain.</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+ * https://creativecommons.org/publicdomain/zero/1.0/</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+ */</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+#ifdef _WIN32</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+#ifndef _NIWCOMPAT_H</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+#define _NIWCOMPAT_H 1</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+#ifdef __cplusplus</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+extern &quot;C&quot; {</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+#endif</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+/* MS Header */</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+#include &lt;stdio.h&gt;</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+#include &lt;io.h&gt;</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+#include &lt;direct.h&gt;</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+#include &lt;ctype.h&gt;</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+typedef unsigned int ssize_t;</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+/* The POSIX names for the following are deprecated by MSVC */</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+#define write _write</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+#define unlink _unlink</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+#define rmdir _rmdir</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+#define read _read</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+#define lseek _lseek</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+#define isatty _isatty</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+#define getcwd _getcwd</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+#define dup2 _dup2</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+#define dup _dup</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+#define close _close</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+#define chdir _chdir</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+#define STDIN_FILENO 0</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+#define STDOUT_FILENO 1</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+#define STDERR_FILENO 2</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+/* String compare */</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+#ifndef strcasecmp</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+#define strcasecmp _stricmp</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+#endif</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+#define strncasecmp _strnicmp</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+/* From sys/stat.h */</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+#ifndef S_ISREG</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+#define S_ISREG(x) (_S_IFREG &amp; x)</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+#endif</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+#ifndef S_ISDIR</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+#define S_ISDIR(x) (_S_IFDIR &amp; x)</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+#endif</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+#define PATH_MAX FILENAME_MAX</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+#define MAXPATHLEN FILENAME_MAX</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+#ifdef __cplusplus</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+}</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+#endif</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+#endif    /* _NIWCOMPAT_H */</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+#endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">new file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- /dev/null</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ b/third_party/niwcompat/sys/param.h</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -0,0 +1,15 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineplus">+/* sys/param.h</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineplus">+ * Any copyright is dedicated to the Public Domain.</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineplus">+ * https://creativecommons.org/publicdomain/zero/1.0/</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineplus">+*/</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+#ifdef __cplusplus</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+extern &quot;C&quot; {</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+#endif</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+#include &quot;../niw_compat.h&quot;</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+#ifdef __cplusplus</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+}</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+#endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">new file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- /dev/null</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ b/third_party/niwcompat/sys/time.h</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -0,0 +1,48 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineplus">+/* sys/time.h</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineplus">+ * Any copyright is dedicated to the Public Domain.</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineplus">+ * https://creativecommons.org/publicdomain/zero/1.0/</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineplus">+ */</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+#ifndef _NIW_SYS_TIME_H</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+#define _NIW_SYS_TIME_H 1</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+#ifdef __cplusplus</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+extern &quot;C&quot; {</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+#endif</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+/* MS Win SDK Headers */</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+#include &lt;sys/timeb.h&gt; /* For _ftime_s */</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+#include &lt;time.h&gt;</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+#ifndef _TIMEVAL_DEFINED</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+#define _TIMEVAL_DEFINED</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+struct timeval {</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+  long tv_sec;</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+  long tv_usec;</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+};</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+#endif</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+int gettimeofday(struct timeval* tp, void* tzp) {</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+  struct _timeb timebuffer;</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+  if (tzp != NULL) {</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+    errno = EINVAL;</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+    return -1;</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+  }</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+  errno_t rv = _ftime_s(&amp;timebuffer);</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+  if (rv != 0) {</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+    errno = rv;</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+    return -1;</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+  }</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+  tp-&gt;tv_sec = timebuffer.time;</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+  tp-&gt;tv_usec = timebuffer.millitm * 1000;</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+  return 0;</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+}</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+#ifdef __cplusplus</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+}</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+#endif</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+#endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">new file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- /dev/null</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ b/third_party/niwcompat/unistd.h</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -0,0 +1,15 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineplus">+/* unistd.h</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineplus">+ * Any copyright is dedicated to the Public Domain.</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineplus">+ * https://creativecommons.org/publicdomain/zero/1.0/</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+*/</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+#ifdef __cplusplus</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+extern &quot;C&quot; {</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+#endif</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+#include &quot;niw_compat.h&quot;</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+#ifdef __cplusplus</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+}</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+#endif</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

