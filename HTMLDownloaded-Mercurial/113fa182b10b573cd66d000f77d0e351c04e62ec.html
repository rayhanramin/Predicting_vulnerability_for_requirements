<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 23231:113fa182b10b573cd66d000f77d0e351c04e62ec</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 113fa182b10b573cd66d000f77d0e351c04e62ec" />
<meta property="og:url" content="/comm-central/rev/113fa182b10b573cd66d000f77d0e351c04e62ec" />
<meta property="og:description" content="Bug 1435093 - Port bug 1421084 to mailnews: remove nsNSSShutDownPreventionLock, isAlreadyShutDown, shutdown, virtualDestroyNSSReference, nsNSSShutDown.h from mailnews. rs=bustage-fix" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 113fa182b10b573cd66d000f77d0e351c04e62ec 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/113fa182b10b573cd66d000f77d0e351c04e62ec">shortlog</a> |
<a href="/comm-central/log/113fa182b10b573cd66d000f77d0e351c04e62ec">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/113fa182b10b573cd66d000f77d0e351c04e62ec">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/113fa182b10b573cd66d000f77d0e351c04e62ec">files</a> |
changeset |
<a href="/comm-central/raw-rev/113fa182b10b573cd66d000f77d0e351c04e62ec">raw</a>  | <a href="/comm-central/archive/113fa182b10b573cd66d000f77d0e351c04e62ec.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1435093">Bug 1435093</a> - Port <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1421084">bug 1421084</a> to mailnews: remove nsNSSShutDownPreventionLock, isAlreadyShutDown, shutdown, virtualDestroyNSSReference, nsNSSShutDown.h from mailnews. rs=bustage-fix
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 02 Feb 2018 01:03:12 +0100</td></tr>

<tr>
 <td>changeset 23231</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/113fa182b10b573cd66d000f77d0e351c04e62ec">113fa182b10b573cd66d000f77d0e351c04e62ec</a></td>
</tr>



<tr>
<td>parent 23230</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8439e50b3e6c94f1891b1e67364da5b0a1778e69">8439e50b3e6c94f1891b1e67364da5b0a1778e69</a>
</td>
</tr>

<tr>
<td>child 23232</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/e62f73758e138743a47f2682f721862f09cd89c4">e62f73758e138743a47f2682f721862f09cd89c4</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=113fa182b10b573cd66d000f77d0e351c04e62ec">14042</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 02 Feb 2018 08:29:22 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@113fa182b10b [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=113fa182b10b573cd66d000f77d0e351c04e62ec">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=113fa182b10b573cd66d000f77d0e351c04e62ec&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=113fa182b10b573cd66d000f77d0e351c04e62ec&newProject=comm-central&newRevision=113fa182b10b573cd66d000f77d0e351c04e62ec&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=113fa182b10b573cd66d000f77d0e351c04e62ec&newProject=comm-central&newRevision=113fa182b10b573cd66d000f77d0e351c04e62ec&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=113fa182b10b573cd66d000f77d0e351c04e62ec&newProject=comm-central&newRevision=113fa182b10b573cd66d000f77d0e351c04e62ec&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28bustage-fix%29&revcount=50">bustage-fix</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1435093">1435093</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1421084">1421084</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1435093">Bug 1435093</a> - Port <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1421084">bug 1421084</a> to mailnews: remove nsNSSShutDownPreventionLock, isAlreadyShutDown, shutdown, virtualDestroyNSSReference, nsNSSShutDown.h from mailnews. rs=bustage-fix</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/113fa182b10b573cd66d000f77d0e351c04e62ec/mailnews/extensions/smime/src/nsCertPicker.cpp">mailnews/extensions/smime/src/nsCertPicker.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/113fa182b10b573cd66d000f77d0e351c04e62ec/mailnews/extensions/smime/src/nsCertPicker.cpp">file</a> |
<a href="/comm-central/annotate/113fa182b10b573cd66d000f77d0e351c04e62ec/mailnews/extensions/smime/src/nsCertPicker.cpp">annotate</a> |
<a href="/comm-central/diff/113fa182b10b573cd66d000f77d0e351c04e62ec/mailnews/extensions/smime/src/nsCertPicker.cpp">diff</a> |
<a href="/comm-central/comparison/113fa182b10b573cd66d000f77d0e351c04e62ec/mailnews/extensions/smime/src/nsCertPicker.cpp">comparison</a> |
<a href="/comm-central/log/113fa182b10b573cd66d000f77d0e351c04e62ec/mailnews/extensions/smime/src/nsCertPicker.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/113fa182b10b573cd66d000f77d0e351c04e62ec/mailnews/extensions/smime/src/nsCertPicker.h">mailnews/extensions/smime/src/nsCertPicker.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/113fa182b10b573cd66d000f77d0e351c04e62ec/mailnews/extensions/smime/src/nsCertPicker.h">file</a> |
<a href="/comm-central/annotate/113fa182b10b573cd66d000f77d0e351c04e62ec/mailnews/extensions/smime/src/nsCertPicker.h">annotate</a> |
<a href="/comm-central/diff/113fa182b10b573cd66d000f77d0e351c04e62ec/mailnews/extensions/smime/src/nsCertPicker.h">diff</a> |
<a href="/comm-central/comparison/113fa182b10b573cd66d000f77d0e351c04e62ec/mailnews/extensions/smime/src/nsCertPicker.h">comparison</a> |
<a href="/comm-central/log/113fa182b10b573cd66d000f77d0e351c04e62ec/mailnews/extensions/smime/src/nsCertPicker.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/113fa182b10b573cd66d000f77d0e351c04e62ec/mailnews/mime/src/nsCMS.cpp">mailnews/mime/src/nsCMS.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/113fa182b10b573cd66d000f77d0e351c04e62ec/mailnews/mime/src/nsCMS.cpp">file</a> |
<a href="/comm-central/annotate/113fa182b10b573cd66d000f77d0e351c04e62ec/mailnews/mime/src/nsCMS.cpp">annotate</a> |
<a href="/comm-central/diff/113fa182b10b573cd66d000f77d0e351c04e62ec/mailnews/mime/src/nsCMS.cpp">diff</a> |
<a href="/comm-central/comparison/113fa182b10b573cd66d000f77d0e351c04e62ec/mailnews/mime/src/nsCMS.cpp">comparison</a> |
<a href="/comm-central/log/113fa182b10b573cd66d000f77d0e351c04e62ec/mailnews/mime/src/nsCMS.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/113fa182b10b573cd66d000f77d0e351c04e62ec/mailnews/mime/src/nsCMS.h">mailnews/mime/src/nsCMS.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/113fa182b10b573cd66d000f77d0e351c04e62ec/mailnews/mime/src/nsCMS.h">file</a> |
<a href="/comm-central/annotate/113fa182b10b573cd66d000f77d0e351c04e62ec/mailnews/mime/src/nsCMS.h">annotate</a> |
<a href="/comm-central/diff/113fa182b10b573cd66d000f77d0e351c04e62ec/mailnews/mime/src/nsCMS.h">diff</a> |
<a href="/comm-central/comparison/113fa182b10b573cd66d000f77d0e351c04e62ec/mailnews/mime/src/nsCMS.h">comparison</a> |
<a href="/comm-central/log/113fa182b10b573cd66d000f77d0e351c04e62ec/mailnews/mime/src/nsCMS.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/113fa182b10b573cd66d000f77d0e351c04e62ec/mailnews/mime/src/nsCMSSecureMessage.cpp">mailnews/mime/src/nsCMSSecureMessage.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/113fa182b10b573cd66d000f77d0e351c04e62ec/mailnews/mime/src/nsCMSSecureMessage.cpp">file</a> |
<a href="/comm-central/annotate/113fa182b10b573cd66d000f77d0e351c04e62ec/mailnews/mime/src/nsCMSSecureMessage.cpp">annotate</a> |
<a href="/comm-central/diff/113fa182b10b573cd66d000f77d0e351c04e62ec/mailnews/mime/src/nsCMSSecureMessage.cpp">diff</a> |
<a href="/comm-central/comparison/113fa182b10b573cd66d000f77d0e351c04e62ec/mailnews/mime/src/nsCMSSecureMessage.cpp">comparison</a> |
<a href="/comm-central/log/113fa182b10b573cd66d000f77d0e351c04e62ec/mailnews/mime/src/nsCMSSecureMessage.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/extensions/smime/src/nsCertPicker.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/extensions/smime/src/nsCertPicker.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -17,17 +17,16 @@</span>
<a href="#l1.4"></a><span id="l1.4"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l1.5"></a><span id="l1.5"> #include &quot;nsIX509CertValidity.h&quot;</span>
<a href="#l1.6"></a><span id="l1.6"> #include &quot;nsMemory.h&quot;</span>
<a href="#l1.7"></a><span id="l1.7"> #include &quot;nsMsgComposeSecure.h&quot;</span>
<a href="#l1.8"></a><span id="l1.8"> #include &quot;nsNSSCertificate.h&quot;</span>
<a href="#l1.9"></a><span id="l1.9"> #include &quot;nsNSSComponent.h&quot;</span>
<a href="#l1.10"></a><span id="l1.10"> #include &quot;nsNSSDialogHelper.h&quot;</span>
<a href="#l1.11"></a><span id="l1.11"> #include &quot;nsNSSHelper.h&quot;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-#include &quot;nsNSSShutDown.h&quot;</span>
<a href="#l1.13"></a><span id="l1.13"> #include &quot;nsReadableUtils.h&quot;</span>
<a href="#l1.14"></a><span id="l1.14"> #include &quot;nsString.h&quot;</span>
<a href="#l1.15"></a><span id="l1.15"> #include &quot;pkix/pkixtypes.h&quot;</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17"> using namespace mozilla;</span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19"> MOZ_TYPE_SPECIFIC_UNIQUE_PTR_TEMPLATE(UniqueCERTCertNicknames,</span>
<a href="#l1.20"></a><span id="l1.20">                                       CERTCertNicknames,</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineat">@@ -227,22 +226,16 @@ FormatUIStrings(nsIX509Cert* cert, const</span>
<a href="#l1.22"></a><span id="l1.22"> NS_IMPL_ISUPPORTS(nsCertPicker, nsICertPickDialogs, nsIUserCertPicker)</span>
<a href="#l1.23"></a><span id="l1.23"> </span>
<a href="#l1.24"></a><span id="l1.24"> nsCertPicker::nsCertPicker()</span>
<a href="#l1.25"></a><span id="l1.25"> {</span>
<a href="#l1.26"></a><span id="l1.26"> }</span>
<a href="#l1.27"></a><span id="l1.27"> </span>
<a href="#l1.28"></a><span id="l1.28"> nsCertPicker::~nsCertPicker()</span>
<a href="#l1.29"></a><span id="l1.29"> {</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-  nsNSSShutDownPreventionLock locker;</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-  if (isAlreadyShutDown()) {</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-    return;</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-  }</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-  shutdown(ShutdownCalledFrom::Object);</span>
<a href="#l1.36"></a><span id="l1.36"> }</span>
<a href="#l1.37"></a><span id="l1.37"> </span>
<a href="#l1.38"></a><span id="l1.38"> nsresult</span>
<a href="#l1.39"></a><span id="l1.39"> nsCertPicker::Init()</span>
<a href="#l1.40"></a><span id="l1.40"> {</span>
<a href="#l1.41"></a><span id="l1.41">   nsresult rv;</span>
<a href="#l1.42"></a><span id="l1.42">   nsCOMPtr&lt;nsISupports&gt; psm = do_GetService(&quot;@mozilla.org/psm;1&quot;, &amp;rv);</span>
<a href="#l1.43"></a><span id="l1.43">   return rv;</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineat">@@ -304,21 +297,16 @@ NS_IMETHODIMP nsCertPicker::PickByUsage(</span>
<a href="#l1.45"></a><span id="l1.45">                                         const char16_t *selectedNickname,</span>
<a href="#l1.46"></a><span id="l1.46">                                         int32_t certUsage,</span>
<a href="#l1.47"></a><span id="l1.47">                                         bool allowInvalid,</span>
<a href="#l1.48"></a><span id="l1.48">                                         bool allowDuplicateNicknames,</span>
<a href="#l1.49"></a><span id="l1.49">                                         const nsAString &amp;emailAddress,</span>
<a href="#l1.50"></a><span id="l1.50">                                         bool *canceled,</span>
<a href="#l1.51"></a><span id="l1.51">                                         nsIX509Cert **_retval)</span>
<a href="#l1.52"></a><span id="l1.52"> {</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-  nsNSSShutDownPreventionLock locker;</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-  if (isAlreadyShutDown()) {</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineminus">-    return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineminus">-  }</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-</span>
<a href="#l1.58"></a><span id="l1.58">   int32_t selectedIndex = -1;</span>
<a href="#l1.59"></a><span id="l1.59">   bool selectionFound = false;</span>
<a href="#l1.60"></a><span id="l1.60">   char16_t **certNicknameList = nullptr;</span>
<a href="#l1.61"></a><span id="l1.61">   char16_t **certDetailsList = nullptr;</span>
<a href="#l1.62"></a><span id="l1.62">   CERTCertListNode* node = nullptr;</span>
<a href="#l1.63"></a><span id="l1.63">   nsresult rv = NS_OK;</span>
<a href="#l1.64"></a><span id="l1.64"> </span>
<a href="#l1.65"></a><span id="l1.65">   {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/extensions/smime/src/nsCertPicker.h</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/extensions/smime/src/nsCertPicker.h</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -3,34 +3,28 @@</span>
<a href="#l2.4"></a><span id="l2.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.5"></a><span id="l2.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> #ifndef nsCertPicker_h</span>
<a href="#l2.8"></a><span id="l2.8"> #define nsCertPicker_h</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> #include &quot;nsICertPickDialogs.h&quot;</span>
<a href="#l2.11"></a><span id="l2.11"> #include &quot;nsIUserCertPicker.h&quot;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-#include &quot;nsNSSShutDown.h&quot;</span>
<a href="#l2.13"></a><span id="l2.13"> </span>
<a href="#l2.14"></a><span id="l2.14"> #define NS_CERT_PICKER_CID \</span>
<a href="#l2.15"></a><span id="l2.15">   { 0x735959a1, 0xaf01, 0x447e, { 0xb0, 0x2d, 0x56, 0xe9, 0x68, 0xfa, 0x52, 0xb4 } }</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17"> class nsCertPicker : public nsICertPickDialogs</span>
<a href="#l2.18"></a><span id="l2.18">                    , public nsIUserCertPicker</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-                   , public nsNSSShutDownObject</span>
<a href="#l2.20"></a><span id="l2.20"> {</span>
<a href="#l2.21"></a><span id="l2.21"> public:</span>
<a href="#l2.22"></a><span id="l2.22">   NS_DECL_ISUPPORTS</span>
<a href="#l2.23"></a><span id="l2.23">   NS_DECL_NSICERTPICKDIALOGS</span>
<a href="#l2.24"></a><span id="l2.24">   NS_DECL_NSIUSERCERTPICKER</span>
<a href="#l2.25"></a><span id="l2.25"> </span>
<a href="#l2.26"></a><span id="l2.26">   nsCertPicker();</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineminus">-</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">-  // Nothing to actually release.</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">-  virtual void virtualDestroyNSSReference() override {}</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-</span>
<a href="#l2.31"></a><span id="l2.31">   nsresult Init();</span>
<a href="#l2.32"></a><span id="l2.32"> </span>
<a href="#l2.33"></a><span id="l2.33"> protected:</span>
<a href="#l2.34"></a><span id="l2.34">   virtual ~nsCertPicker();</span>
<a href="#l2.35"></a><span id="l2.35"> };</span>
<a href="#l2.36"></a><span id="l2.36"> </span>
<a href="#l2.37"></a><span id="l2.37"> #endif // nsCertPicker_h</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/mime/src/nsCMS.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/mime/src/nsCMS.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -42,54 +42,40 @@ nsCMSMessage::nsCMSMessage()</span>
<a href="#l3.4"></a><span id="l3.4"> }</span>
<a href="#l3.5"></a><span id="l3.5"> nsCMSMessage::nsCMSMessage(NSSCMSMessage *aCMSMsg)</span>
<a href="#l3.6"></a><span id="l3.6"> {</span>
<a href="#l3.7"></a><span id="l3.7">   m_cmsMsg = aCMSMsg;</span>
<a href="#l3.8"></a><span id="l3.8"> }</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> nsCMSMessage::~nsCMSMessage()</span>
<a href="#l3.11"></a><span id="l3.11"> {</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  nsNSSShutDownPreventionLock locker;</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-  if (isAlreadyShutDown()) {</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-    return;</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-  }</span>
<a href="#l3.16"></a><span id="l3.16">   destructorSafeDestroyNSSReference();</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-  shutdown(ShutdownCalledFrom::Object);</span>
<a href="#l3.18"></a><span id="l3.18"> }</span>
<a href="#l3.19"></a><span id="l3.19"> </span>
<a href="#l3.20"></a><span id="l3.20"> nsresult nsCMSMessage::Init()</span>
<a href="#l3.21"></a><span id="l3.21"> {</span>
<a href="#l3.22"></a><span id="l3.22">   nsresult rv;</span>
<a href="#l3.23"></a><span id="l3.23">   nsCOMPtr&lt;nsISupports&gt; nssInitialized = do_GetService(&quot;@mozilla.org/psm;1&quot;, &amp;rv);</span>
<a href="#l3.24"></a><span id="l3.24">   return rv;</span>
<a href="#l3.25"></a><span id="l3.25"> }</span>
<a href="#l3.26"></a><span id="l3.26"> </span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-void nsCMSMessage::virtualDestroyNSSReference()</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-{</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-  destructorSafeDestroyNSSReference();</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-}</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-</span>
<a href="#l3.32"></a><span id="l3.32"> void nsCMSMessage::destructorSafeDestroyNSSReference()</span>
<a href="#l3.33"></a><span id="l3.33"> {</span>
<a href="#l3.34"></a><span id="l3.34">   if (m_cmsMsg) {</span>
<a href="#l3.35"></a><span id="l3.35">     NSS_CMSMessage_Destroy(m_cmsMsg);</span>
<a href="#l3.36"></a><span id="l3.36">   }</span>
<a href="#l3.37"></a><span id="l3.37"> }</span>
<a href="#l3.38"></a><span id="l3.38"> </span>
<a href="#l3.39"></a><span id="l3.39"> NS_IMETHODIMP nsCMSMessage::VerifySignature()</span>
<a href="#l3.40"></a><span id="l3.40"> {</span>
<a href="#l3.41"></a><span id="l3.41">   return CommonVerifySignature(nullptr, 0);</span>
<a href="#l3.42"></a><span id="l3.42"> }</span>
<a href="#l3.43"></a><span id="l3.43"> </span>
<a href="#l3.44"></a><span id="l3.44"> NSSCMSSignerInfo* nsCMSMessage::GetTopLevelSignerInfo()</span>
<a href="#l3.45"></a><span id="l3.45"> {</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-  nsNSSShutDownPreventionLock locker;</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-  if (isAlreadyShutDown())</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-    return nullptr;</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-</span>
<a href="#l3.50"></a><span id="l3.50">   if (!m_cmsMsg)</span>
<a href="#l3.51"></a><span id="l3.51">     return nullptr;</span>
<a href="#l3.52"></a><span id="l3.52"> </span>
<a href="#l3.53"></a><span id="l3.53">   if (!NSS_CMSMessage_IsSigned(m_cmsMsg))</span>
<a href="#l3.54"></a><span id="l3.54">     return nullptr;</span>
<a href="#l3.55"></a><span id="l3.55"> </span>
<a href="#l3.56"></a><span id="l3.56">   NSSCMSContentInfo *cinfo = NSS_CMSMessage_ContentLevel(m_cmsMsg, 0);</span>
<a href="#l3.57"></a><span id="l3.57">   if (!cinfo)</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineat">@@ -100,88 +86,68 @@ NSSCMSSignerInfo* nsCMSMessage::GetTopLe</span>
<a href="#l3.59"></a><span id="l3.59">     return nullptr;</span>
<a href="#l3.60"></a><span id="l3.60"> </span>
<a href="#l3.61"></a><span id="l3.61">   PR_ASSERT(NSS_CMSSignedData_SignerInfoCount(sigd) &gt; 0);</span>
<a href="#l3.62"></a><span id="l3.62">   return NSS_CMSSignedData_GetSignerInfo(sigd, 0);</span>
<a href="#l3.63"></a><span id="l3.63"> }</span>
<a href="#l3.64"></a><span id="l3.64"> </span>
<a href="#l3.65"></a><span id="l3.65"> NS_IMETHODIMP nsCMSMessage::GetSignerEmailAddress(char * * aEmail)</span>
<a href="#l3.66"></a><span id="l3.66"> {</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-  nsNSSShutDownPreventionLock locker;</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineminus">-  if (isAlreadyShutDown())</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-    return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-</span>
<a href="#l3.71"></a><span id="l3.71">   MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::GetSignerEmailAddress\n&quot;));</span>
<a href="#l3.72"></a><span id="l3.72">   NS_ENSURE_ARG(aEmail);</span>
<a href="#l3.73"></a><span id="l3.73"> </span>
<a href="#l3.74"></a><span id="l3.74">   NSSCMSSignerInfo *si = GetTopLevelSignerInfo();</span>
<a href="#l3.75"></a><span id="l3.75">   if (!si)</span>
<a href="#l3.76"></a><span id="l3.76">     return NS_ERROR_FAILURE;</span>
<a href="#l3.77"></a><span id="l3.77"> </span>
<a href="#l3.78"></a><span id="l3.78">   *aEmail = NSS_CMSSignerInfo_GetSignerEmailAddress(si);</span>
<a href="#l3.79"></a><span id="l3.79">   return NS_OK;</span>
<a href="#l3.80"></a><span id="l3.80"> }</span>
<a href="#l3.81"></a><span id="l3.81"> </span>
<a href="#l3.82"></a><span id="l3.82"> NS_IMETHODIMP nsCMSMessage::GetSignerCommonName(char ** aName)</span>
<a href="#l3.83"></a><span id="l3.83"> {</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-  nsNSSShutDownPreventionLock locker;</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-  if (isAlreadyShutDown())</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineminus">-    return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineminus">-</span>
<a href="#l3.88"></a><span id="l3.88">   MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::GetSignerCommonName\n&quot;));</span>
<a href="#l3.89"></a><span id="l3.89">   NS_ENSURE_ARG(aName);</span>
<a href="#l3.90"></a><span id="l3.90"> </span>
<a href="#l3.91"></a><span id="l3.91">   NSSCMSSignerInfo *si = GetTopLevelSignerInfo();</span>
<a href="#l3.92"></a><span id="l3.92">   if (!si)</span>
<a href="#l3.93"></a><span id="l3.93">     return NS_ERROR_FAILURE;</span>
<a href="#l3.94"></a><span id="l3.94"> </span>
<a href="#l3.95"></a><span id="l3.95">   *aName = NSS_CMSSignerInfo_GetSignerCommonName(si);</span>
<a href="#l3.96"></a><span id="l3.96">   return NS_OK;</span>
<a href="#l3.97"></a><span id="l3.97"> }</span>
<a href="#l3.98"></a><span id="l3.98"> </span>
<a href="#l3.99"></a><span id="l3.99"> NS_IMETHODIMP nsCMSMessage::ContentIsEncrypted(bool *isEncrypted)</span>
<a href="#l3.100"></a><span id="l3.100"> {</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-  nsNSSShutDownPreventionLock locker;</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineminus">-  if (isAlreadyShutDown())</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineminus">-    return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineminus">-</span>
<a href="#l3.105"></a><span id="l3.105">   MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::ContentIsEncrypted\n&quot;));</span>
<a href="#l3.106"></a><span id="l3.106">   NS_ENSURE_ARG(isEncrypted);</span>
<a href="#l3.107"></a><span id="l3.107"> </span>
<a href="#l3.108"></a><span id="l3.108">   if (!m_cmsMsg)</span>
<a href="#l3.109"></a><span id="l3.109">     return NS_ERROR_FAILURE;</span>
<a href="#l3.110"></a><span id="l3.110"> </span>
<a href="#l3.111"></a><span id="l3.111">   *isEncrypted = NSS_CMSMessage_IsEncrypted(m_cmsMsg);</span>
<a href="#l3.112"></a><span id="l3.112"> </span>
<a href="#l3.113"></a><span id="l3.113">   return NS_OK;</span>
<a href="#l3.114"></a><span id="l3.114"> }</span>
<a href="#l3.115"></a><span id="l3.115"> </span>
<a href="#l3.116"></a><span id="l3.116"> NS_IMETHODIMP nsCMSMessage::ContentIsSigned(bool *isSigned)</span>
<a href="#l3.117"></a><span id="l3.117"> {</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineminus">-  nsNSSShutDownPreventionLock locker;</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineminus">-  if (isAlreadyShutDown())</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineminus">-    return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineminus">-</span>
<a href="#l3.122"></a><span id="l3.122">   MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::ContentIsSigned\n&quot;));</span>
<a href="#l3.123"></a><span id="l3.123">   NS_ENSURE_ARG(isSigned);</span>
<a href="#l3.124"></a><span id="l3.124"> </span>
<a href="#l3.125"></a><span id="l3.125">   if (!m_cmsMsg)</span>
<a href="#l3.126"></a><span id="l3.126">     return NS_ERROR_FAILURE;</span>
<a href="#l3.127"></a><span id="l3.127"> </span>
<a href="#l3.128"></a><span id="l3.128">   *isSigned = NSS_CMSMessage_IsSigned(m_cmsMsg);</span>
<a href="#l3.129"></a><span id="l3.129"> </span>
<a href="#l3.130"></a><span id="l3.130">   return NS_OK;</span>
<a href="#l3.131"></a><span id="l3.131"> }</span>
<a href="#l3.132"></a><span id="l3.132"> </span>
<a href="#l3.133"></a><span id="l3.133"> NS_IMETHODIMP nsCMSMessage::GetSignerCert(nsIX509Cert **scert)</span>
<a href="#l3.134"></a><span id="l3.134"> {</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineminus">-  nsNSSShutDownPreventionLock locker;</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineminus">-  if (isAlreadyShutDown())</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineminus">-    return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineminus">-</span>
<a href="#l3.139"></a><span id="l3.139">   NSSCMSSignerInfo *si = GetTopLevelSignerInfo();</span>
<a href="#l3.140"></a><span id="l3.140">   if (!si)</span>
<a href="#l3.141"></a><span id="l3.141">     return NS_ERROR_FAILURE;</span>
<a href="#l3.142"></a><span id="l3.142"> </span>
<a href="#l3.143"></a><span id="l3.143">   nsCOMPtr&lt;nsIX509Cert&gt; cert;</span>
<a href="#l3.144"></a><span id="l3.144">   if (si-&gt;cert) {</span>
<a href="#l3.145"></a><span id="l3.145">     MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::GetSignerCert got signer cert\n&quot;));</span>
<a href="#l3.146"></a><span id="l3.146"> </span>
<a href="#l3.147"></a><span id="l3.147" class="difflineat">@@ -214,20 +180,16 @@ NS_IMETHODIMP nsCMSMessage::VerifyDetach</span>
<a href="#l3.148"></a><span id="l3.148">   if (!aDigestData || !aDigestDataLen)</span>
<a href="#l3.149"></a><span id="l3.149">     return NS_ERROR_FAILURE;</span>
<a href="#l3.150"></a><span id="l3.150"> </span>
<a href="#l3.151"></a><span id="l3.151">   return CommonVerifySignature(aDigestData, aDigestDataLen);</span>
<a href="#l3.152"></a><span id="l3.152"> }</span>
<a href="#l3.153"></a><span id="l3.153"> </span>
<a href="#l3.154"></a><span id="l3.154"> nsresult nsCMSMessage::CommonVerifySignature(unsigned char* aDigestData, uint32_t aDigestDataLen)</span>
<a href="#l3.155"></a><span id="l3.155"> {</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineminus">-  nsNSSShutDownPreventionLock locker;</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineminus">-  if (isAlreadyShutDown())</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineminus">-    return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineminus">-</span>
<a href="#l3.160"></a><span id="l3.160">   MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CommonVerifySignature, content level count %d\n&quot;, NSS_CMSMessage_ContentLevelCount(m_cmsMsg)));</span>
<a href="#l3.161"></a><span id="l3.161">   NSSCMSContentInfo *cinfo = nullptr;</span>
<a href="#l3.162"></a><span id="l3.162">   NSSCMSSignedData *sigd = nullptr;</span>
<a href="#l3.163"></a><span id="l3.163">   NSSCMSSignerInfo *si;</span>
<a href="#l3.164"></a><span id="l3.164">   int32_t nsigners;</span>
<a href="#l3.165"></a><span id="l3.165">   RefPtr&lt;SharedCertVerifier&gt; certVerifier;</span>
<a href="#l3.166"></a><span id="l3.166">   nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l3.167"></a><span id="l3.167"> </span>
<a href="#l3.168"></a><span id="l3.168" class="difflineat">@@ -378,17 +340,16 @@ public:</span>
<a href="#l3.169"></a><span id="l3.169">   {</span>
<a href="#l3.170"></a><span id="l3.170">     MOZ_ASSERT(NS_IsMainThread());</span>
<a href="#l3.171"></a><span id="l3.171">     mMessage = aMessage;</span>
<a href="#l3.172"></a><span id="l3.172">     mListener = aListener;</span>
<a href="#l3.173"></a><span id="l3.173">     mDigestData.Assign(reinterpret_cast&lt;char *&gt;(aDigestData), aDigestDataLen);</span>
<a href="#l3.174"></a><span id="l3.174">   }</span>
<a href="#l3.175"></a><span id="l3.175"> </span>
<a href="#l3.176"></a><span id="l3.176"> private:</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineminus">-  virtual void ReleaseNSSResources() override {}</span>
<a href="#l3.178"></a><span id="l3.178">   virtual nsresult CalculateResult() override</span>
<a href="#l3.179"></a><span id="l3.179">   {</span>
<a href="#l3.180"></a><span id="l3.180">     MOZ_ASSERT(!NS_IsMainThread());</span>
<a href="#l3.181"></a><span id="l3.181"> </span>
<a href="#l3.182"></a><span id="l3.182">     nsresult rv;</span>
<a href="#l3.183"></a><span id="l3.183">     if (!mDigestData.IsEmpty()) {</span>
<a href="#l3.184"></a><span id="l3.184">       rv = mMessage-&gt;VerifyDetachedSignature(</span>
<a href="#l3.185"></a><span id="l3.185">         reinterpret_cast&lt;uint8_t*&gt;(const_cast&lt;char *&gt;(mDigestData.get())),</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineat">@@ -414,36 +375,26 @@ private:</span>
<a href="#l3.187"></a><span id="l3.187"> </span>
<a href="#l3.188"></a><span id="l3.188"> nsresult nsCMSMessage::CommonAsyncVerifySignature(nsISMimeVerificationListener *aListener,</span>
<a href="#l3.189"></a><span id="l3.189">                                                   unsigned char* aDigestData, uint32_t aDigestDataLen)</span>
<a href="#l3.190"></a><span id="l3.190"> {</span>
<a href="#l3.191"></a><span id="l3.191">   RefPtr&lt;CryptoTask&gt; task = new SMimeVerificationTask(this, aListener, aDigestData, aDigestDataLen);</span>
<a href="#l3.192"></a><span id="l3.192">   return task-&gt;Dispatch(&quot;SMimeVerify&quot;);</span>
<a href="#l3.193"></a><span id="l3.193"> }</span>
<a href="#l3.194"></a><span id="l3.194"> </span>
<a href="#l3.195"></a><span id="l3.195" class="difflineminus">-class nsZeroTerminatedCertArray : public nsNSSShutDownObject</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineplus">+class nsZeroTerminatedCertArray</span>
<a href="#l3.197"></a><span id="l3.197"> {</span>
<a href="#l3.198"></a><span id="l3.198"> public:</span>
<a href="#l3.199"></a><span id="l3.199">   nsZeroTerminatedCertArray()</span>
<a href="#l3.200"></a><span id="l3.200">   :mCerts(nullptr), mPoolp(nullptr), mSize(0)</span>
<a href="#l3.201"></a><span id="l3.201">   {</span>
<a href="#l3.202"></a><span id="l3.202">   }</span>
<a href="#l3.203"></a><span id="l3.203"> </span>
<a href="#l3.204"></a><span id="l3.204">   ~nsZeroTerminatedCertArray()</span>
<a href="#l3.205"></a><span id="l3.205">   {</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineminus">-    nsNSSShutDownPreventionLock locker;</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineminus">-    if (isAlreadyShutDown()) {</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineminus">-      return;</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineminus">-    }</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineminus">-    destructorSafeDestroyNSSReference();</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineminus">-    shutdown(ShutdownCalledFrom::Object);</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineminus">-  }</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineminus">-</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineminus">-  void virtualDestroyNSSReference()</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineminus">-  {</span>
<a href="#l3.216"></a><span id="l3.216">     destructorSafeDestroyNSSReference();</span>
<a href="#l3.217"></a><span id="l3.217">   }</span>
<a href="#l3.218"></a><span id="l3.218"> </span>
<a href="#l3.219"></a><span id="l3.219">   void destructorSafeDestroyNSSReference()</span>
<a href="#l3.220"></a><span id="l3.220">   {</span>
<a href="#l3.221"></a><span id="l3.221">     if (mCerts)</span>
<a href="#l3.222"></a><span id="l3.222">     {</span>
<a href="#l3.223"></a><span id="l3.223">       for (uint32_t i=0; i &lt; mSize; i++) {</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineat">@@ -483,63 +434,47 @@ public:</span>
<a href="#l3.225"></a><span id="l3.225">       mCerts[i] = nullptr;</span>
<a href="#l3.226"></a><span id="l3.226">     }</span>
<a href="#l3.227"></a><span id="l3.227"> </span>
<a href="#l3.228"></a><span id="l3.228">     return true;</span>
<a href="#l3.229"></a><span id="l3.229">   }</span>
<a href="#l3.230"></a><span id="l3.230"> </span>
<a href="#l3.231"></a><span id="l3.231">   void set(uint32_t i, CERTCertificate *c)</span>
<a href="#l3.232"></a><span id="l3.232">   {</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineminus">-    nsNSSShutDownPreventionLock locker;</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineminus">-    if (isAlreadyShutDown())</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineminus">-      return;</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineminus">-</span>
<a href="#l3.237"></a><span id="l3.237">     if (i &gt;= mSize)</span>
<a href="#l3.238"></a><span id="l3.238">       return;</span>
<a href="#l3.239"></a><span id="l3.239"> </span>
<a href="#l3.240"></a><span id="l3.240">     if (mCerts[i]) {</span>
<a href="#l3.241"></a><span id="l3.241">       CERT_DestroyCertificate(mCerts[i]);</span>
<a href="#l3.242"></a><span id="l3.242">     }</span>
<a href="#l3.243"></a><span id="l3.243"> </span>
<a href="#l3.244"></a><span id="l3.244">     mCerts[i] = CERT_DupCertificate(c);</span>
<a href="#l3.245"></a><span id="l3.245">   }</span>
<a href="#l3.246"></a><span id="l3.246"> </span>
<a href="#l3.247"></a><span id="l3.247">   CERTCertificate *get(uint32_t i)</span>
<a href="#l3.248"></a><span id="l3.248">   {</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineminus">-    nsNSSShutDownPreventionLock locker;</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineminus">-    if (isAlreadyShutDown())</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineminus">-      return nullptr;</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineminus">-</span>
<a href="#l3.253"></a><span id="l3.253">     if (i &gt;= mSize)</span>
<a href="#l3.254"></a><span id="l3.254">       return nullptr;</span>
<a href="#l3.255"></a><span id="l3.255"> </span>
<a href="#l3.256"></a><span id="l3.256">     return CERT_DupCertificate(mCerts[i]);</span>
<a href="#l3.257"></a><span id="l3.257">   }</span>
<a href="#l3.258"></a><span id="l3.258"> </span>
<a href="#l3.259"></a><span id="l3.259">   CERTCertificate **getRawArray()</span>
<a href="#l3.260"></a><span id="l3.260">   {</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineminus">-    nsNSSShutDownPreventionLock locker;</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineminus">-    if (isAlreadyShutDown())</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineminus">-      return nullptr;</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineminus">-</span>
<a href="#l3.265"></a><span id="l3.265">     return mCerts;</span>
<a href="#l3.266"></a><span id="l3.266">   }</span>
<a href="#l3.267"></a><span id="l3.267"> </span>
<a href="#l3.268"></a><span id="l3.268"> private:</span>
<a href="#l3.269"></a><span id="l3.269">   CERTCertificate **mCerts;</span>
<a href="#l3.270"></a><span id="l3.270">   PLArenaPool *mPoolp;</span>
<a href="#l3.271"></a><span id="l3.271">   uint32_t mSize;</span>
<a href="#l3.272"></a><span id="l3.272"> };</span>
<a href="#l3.273"></a><span id="l3.273"> </span>
<a href="#l3.274"></a><span id="l3.274"> NS_IMETHODIMP nsCMSMessage::CreateEncrypted(nsIArray * aRecipientCerts)</span>
<a href="#l3.275"></a><span id="l3.275"> {</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineminus">-  nsNSSShutDownPreventionLock locker;</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineminus">-  if (isAlreadyShutDown())</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineminus">-    return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineminus">-</span>
<a href="#l3.280"></a><span id="l3.280">   MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateEncrypted\n&quot;));</span>
<a href="#l3.281"></a><span id="l3.281">   NSSCMSContentInfo *cinfo;</span>
<a href="#l3.282"></a><span id="l3.282">   NSSCMSEnvelopedData *envd;</span>
<a href="#l3.283"></a><span id="l3.283">   NSSCMSRecipientInfo *recipientInfo;</span>
<a href="#l3.284"></a><span id="l3.284">   nsZeroTerminatedCertArray recipientCerts;</span>
<a href="#l3.285"></a><span id="l3.285">   SECOidTag bulkAlgTag;</span>
<a href="#l3.286"></a><span id="l3.286">   int keySize;</span>
<a href="#l3.287"></a><span id="l3.287">   uint32_t i;</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineat">@@ -620,20 +555,16 @@ loser:</span>
<a href="#l3.289"></a><span id="l3.289"> }</span>
<a href="#l3.290"></a><span id="l3.290"> </span>
<a href="#l3.291"></a><span id="l3.291"> NS_IMETHODIMP</span>
<a href="#l3.292"></a><span id="l3.292"> nsCMSMessage::CreateSigned(nsIX509Cert* aSigningCert, nsIX509Cert* aEncryptCert,</span>
<a href="#l3.293"></a><span id="l3.293">                            unsigned char* aDigestData, uint32_t aDigestDataLen,</span>
<a href="#l3.294"></a><span id="l3.294">                            int16_t aDigestType)</span>
<a href="#l3.295"></a><span id="l3.295"> {</span>
<a href="#l3.296"></a><span id="l3.296">   NS_ENSURE_ARG(aSigningCert);</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineminus">-  nsNSSShutDownPreventionLock locker;</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineminus">-  if (isAlreadyShutDown())</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineminus">-    return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineminus">-</span>
<a href="#l3.301"></a><span id="l3.301">   MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSMessage::CreateSigned\n&quot;));</span>
<a href="#l3.302"></a><span id="l3.302">   NSSCMSContentInfo *cinfo;</span>
<a href="#l3.303"></a><span id="l3.303">   NSSCMSSignedData *sigd;</span>
<a href="#l3.304"></a><span id="l3.304">   NSSCMSSignerInfo *signerinfo;</span>
<a href="#l3.305"></a><span id="l3.305">   UniqueCERTCertificate scert(aSigningCert-&gt;GetCert());</span>
<a href="#l3.306"></a><span id="l3.306">   UniqueCERTCertificate ecert;</span>
<a href="#l3.307"></a><span id="l3.307">   nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l3.308"></a><span id="l3.308"> </span>
<a href="#l3.309"></a><span id="l3.309" class="difflineat">@@ -781,81 +712,59 @@ NS_IMPL_ISUPPORTS(nsCMSDecoder, nsICMSDe</span>
<a href="#l3.310"></a><span id="l3.310"> </span>
<a href="#l3.311"></a><span id="l3.311"> nsCMSDecoder::nsCMSDecoder()</span>
<a href="#l3.312"></a><span id="l3.312"> : m_dcx(nullptr)</span>
<a href="#l3.313"></a><span id="l3.313"> {</span>
<a href="#l3.314"></a><span id="l3.314"> }</span>
<a href="#l3.315"></a><span id="l3.315"> </span>
<a href="#l3.316"></a><span id="l3.316"> nsCMSDecoder::~nsCMSDecoder()</span>
<a href="#l3.317"></a><span id="l3.317"> {</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineminus">-  nsNSSShutDownPreventionLock locker;</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineminus">-  if (isAlreadyShutDown()) {</span>
<a href="#l3.320"></a><span id="l3.320" class="difflineminus">-    return;</span>
<a href="#l3.321"></a><span id="l3.321" class="difflineminus">-  }</span>
<a href="#l3.322"></a><span id="l3.322">   destructorSafeDestroyNSSReference();</span>
<a href="#l3.323"></a><span id="l3.323" class="difflineminus">-  shutdown(ShutdownCalledFrom::Object);</span>
<a href="#l3.324"></a><span id="l3.324"> }</span>
<a href="#l3.325"></a><span id="l3.325"> </span>
<a href="#l3.326"></a><span id="l3.326"> nsresult nsCMSDecoder::Init()</span>
<a href="#l3.327"></a><span id="l3.327"> {</span>
<a href="#l3.328"></a><span id="l3.328">   nsresult rv;</span>
<a href="#l3.329"></a><span id="l3.329">   nsCOMPtr&lt;nsISupports&gt; nssInitialized = do_GetService(&quot;@mozilla.org/psm;1&quot;, &amp;rv);</span>
<a href="#l3.330"></a><span id="l3.330">   return rv;</span>
<a href="#l3.331"></a><span id="l3.331"> }</span>
<a href="#l3.332"></a><span id="l3.332"> </span>
<a href="#l3.333"></a><span id="l3.333" class="difflineminus">-void nsCMSDecoder::virtualDestroyNSSReference()</span>
<a href="#l3.334"></a><span id="l3.334" class="difflineminus">-{</span>
<a href="#l3.335"></a><span id="l3.335" class="difflineminus">-  destructorSafeDestroyNSSReference();</span>
<a href="#l3.336"></a><span id="l3.336" class="difflineminus">-}</span>
<a href="#l3.337"></a><span id="l3.337" class="difflineminus">-</span>
<a href="#l3.338"></a><span id="l3.338"> void nsCMSDecoder::destructorSafeDestroyNSSReference()</span>
<a href="#l3.339"></a><span id="l3.339"> {</span>
<a href="#l3.340"></a><span id="l3.340">   if (m_dcx) {</span>
<a href="#l3.341"></a><span id="l3.341">     NSS_CMSDecoder_Cancel(m_dcx);</span>
<a href="#l3.342"></a><span id="l3.342">     m_dcx = nullptr;</span>
<a href="#l3.343"></a><span id="l3.343">   }</span>
<a href="#l3.344"></a><span id="l3.344"> }</span>
<a href="#l3.345"></a><span id="l3.345"> </span>
<a href="#l3.346"></a><span id="l3.346"> /* void start (in NSSCMSContentCallback cb, in voidPtr arg); */</span>
<a href="#l3.347"></a><span id="l3.347"> NS_IMETHODIMP nsCMSDecoder::Start(NSSCMSContentCallback cb, void * arg)</span>
<a href="#l3.348"></a><span id="l3.348"> {</span>
<a href="#l3.349"></a><span id="l3.349" class="difflineminus">-  nsNSSShutDownPreventionLock locker;</span>
<a href="#l3.350"></a><span id="l3.350" class="difflineminus">-  if (isAlreadyShutDown())</span>
<a href="#l3.351"></a><span id="l3.351" class="difflineminus">-    return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l3.352"></a><span id="l3.352" class="difflineminus">-</span>
<a href="#l3.353"></a><span id="l3.353">   MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSDecoder::Start\n&quot;));</span>
<a href="#l3.354"></a><span id="l3.354">   m_ctx = new PipUIContext();</span>
<a href="#l3.355"></a><span id="l3.355"> </span>
<a href="#l3.356"></a><span id="l3.356">   m_dcx = NSS_CMSDecoder_Start(0, cb, arg, 0, m_ctx, 0, 0);</span>
<a href="#l3.357"></a><span id="l3.357">   if (!m_dcx) {</span>
<a href="#l3.358"></a><span id="l3.358">     MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSDecoder::Start - can't start decoder\n&quot;));</span>
<a href="#l3.359"></a><span id="l3.359">     return NS_ERROR_FAILURE;</span>
<a href="#l3.360"></a><span id="l3.360">   }</span>
<a href="#l3.361"></a><span id="l3.361">   return NS_OK;</span>
<a href="#l3.362"></a><span id="l3.362"> }</span>
<a href="#l3.363"></a><span id="l3.363"> </span>
<a href="#l3.364"></a><span id="l3.364"> /* void update (in string bug, in long len); */</span>
<a href="#l3.365"></a><span id="l3.365"> NS_IMETHODIMP nsCMSDecoder::Update(const char *buf, int32_t len)</span>
<a href="#l3.366"></a><span id="l3.366"> {</span>
<a href="#l3.367"></a><span id="l3.367" class="difflineminus">-  nsNSSShutDownPreventionLock locker;</span>
<a href="#l3.368"></a><span id="l3.368" class="difflineminus">-  if (isAlreadyShutDown())</span>
<a href="#l3.369"></a><span id="l3.369" class="difflineminus">-    return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l3.370"></a><span id="l3.370" class="difflineminus">-</span>
<a href="#l3.371"></a><span id="l3.371">   MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSDecoder::Update\n&quot;));</span>
<a href="#l3.372"></a><span id="l3.372">   NSS_CMSDecoder_Update(m_dcx, (char *)buf, len);</span>
<a href="#l3.373"></a><span id="l3.373">   return NS_OK;</span>
<a href="#l3.374"></a><span id="l3.374"> }</span>
<a href="#l3.375"></a><span id="l3.375"> </span>
<a href="#l3.376"></a><span id="l3.376"> /* void finish (); */</span>
<a href="#l3.377"></a><span id="l3.377"> NS_IMETHODIMP nsCMSDecoder::Finish(nsICMSMessage ** aCMSMsg)</span>
<a href="#l3.378"></a><span id="l3.378"> {</span>
<a href="#l3.379"></a><span id="l3.379" class="difflineminus">-  nsNSSShutDownPreventionLock locker;</span>
<a href="#l3.380"></a><span id="l3.380" class="difflineminus">-  if (isAlreadyShutDown())</span>
<a href="#l3.381"></a><span id="l3.381" class="difflineminus">-    return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l3.382"></a><span id="l3.382" class="difflineminus">-</span>
<a href="#l3.383"></a><span id="l3.383">   MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSDecoder::Finish\n&quot;));</span>
<a href="#l3.384"></a><span id="l3.384">   NSSCMSMessage *cmsMsg;</span>
<a href="#l3.385"></a><span id="l3.385">   cmsMsg = NSS_CMSDecoder_Finish(m_dcx);</span>
<a href="#l3.386"></a><span id="l3.386">   m_dcx = nullptr;</span>
<a href="#l3.387"></a><span id="l3.387">   if (cmsMsg) {</span>
<a href="#l3.388"></a><span id="l3.388">     nsCMSMessage *obj = new nsCMSMessage(cmsMsg);</span>
<a href="#l3.389"></a><span id="l3.389">     // The NSS object cmsMsg still carries a reference to the context</span>
<a href="#l3.390"></a><span id="l3.390">     // we gave it on construction.</span>
<a href="#l3.391"></a><span id="l3.391" class="difflineat">@@ -870,95 +779,69 @@ NS_IMPL_ISUPPORTS(nsCMSEncoder, nsICMSEn</span>
<a href="#l3.392"></a><span id="l3.392"> </span>
<a href="#l3.393"></a><span id="l3.393"> nsCMSEncoder::nsCMSEncoder()</span>
<a href="#l3.394"></a><span id="l3.394"> : m_ecx(nullptr)</span>
<a href="#l3.395"></a><span id="l3.395"> {</span>
<a href="#l3.396"></a><span id="l3.396"> }</span>
<a href="#l3.397"></a><span id="l3.397"> </span>
<a href="#l3.398"></a><span id="l3.398"> nsCMSEncoder::~nsCMSEncoder()</span>
<a href="#l3.399"></a><span id="l3.399"> {</span>
<a href="#l3.400"></a><span id="l3.400" class="difflineminus">-  nsNSSShutDownPreventionLock locker;</span>
<a href="#l3.401"></a><span id="l3.401" class="difflineminus">-  if (isAlreadyShutDown()) {</span>
<a href="#l3.402"></a><span id="l3.402" class="difflineminus">-    return;</span>
<a href="#l3.403"></a><span id="l3.403" class="difflineminus">-  }</span>
<a href="#l3.404"></a><span id="l3.404">   destructorSafeDestroyNSSReference();</span>
<a href="#l3.405"></a><span id="l3.405" class="difflineminus">-  shutdown(ShutdownCalledFrom::Object);</span>
<a href="#l3.406"></a><span id="l3.406"> }</span>
<a href="#l3.407"></a><span id="l3.407"> </span>
<a href="#l3.408"></a><span id="l3.408"> nsresult nsCMSEncoder::Init()</span>
<a href="#l3.409"></a><span id="l3.409"> {</span>
<a href="#l3.410"></a><span id="l3.410">   nsresult rv;</span>
<a href="#l3.411"></a><span id="l3.411">   nsCOMPtr&lt;nsISupports&gt; nssInitialized = do_GetService(&quot;@mozilla.org/psm;1&quot;, &amp;rv);</span>
<a href="#l3.412"></a><span id="l3.412">   return rv;</span>
<a href="#l3.413"></a><span id="l3.413"> }</span>
<a href="#l3.414"></a><span id="l3.414"> </span>
<a href="#l3.415"></a><span id="l3.415" class="difflineminus">-void nsCMSEncoder::virtualDestroyNSSReference()</span>
<a href="#l3.416"></a><span id="l3.416" class="difflineminus">-{</span>
<a href="#l3.417"></a><span id="l3.417" class="difflineminus">-  destructorSafeDestroyNSSReference();</span>
<a href="#l3.418"></a><span id="l3.418" class="difflineminus">-}</span>
<a href="#l3.419"></a><span id="l3.419" class="difflineminus">-</span>
<a href="#l3.420"></a><span id="l3.420"> void nsCMSEncoder::destructorSafeDestroyNSSReference()</span>
<a href="#l3.421"></a><span id="l3.421"> {</span>
<a href="#l3.422"></a><span id="l3.422">   if (m_ecx)</span>
<a href="#l3.423"></a><span id="l3.423">     NSS_CMSEncoder_Cancel(m_ecx);</span>
<a href="#l3.424"></a><span id="l3.424"> }</span>
<a href="#l3.425"></a><span id="l3.425"> </span>
<a href="#l3.426"></a><span id="l3.426"> /* void start (); */</span>
<a href="#l3.427"></a><span id="l3.427"> NS_IMETHODIMP nsCMSEncoder::Start(nsICMSMessage *aMsg, NSSCMSContentCallback cb, void * arg)</span>
<a href="#l3.428"></a><span id="l3.428"> {</span>
<a href="#l3.429"></a><span id="l3.429" class="difflineminus">-  nsNSSShutDownPreventionLock locker;</span>
<a href="#l3.430"></a><span id="l3.430" class="difflineminus">-  if (isAlreadyShutDown())</span>
<a href="#l3.431"></a><span id="l3.431" class="difflineminus">-    return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l3.432"></a><span id="l3.432" class="difflineminus">-</span>
<a href="#l3.433"></a><span id="l3.433">   MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSEncoder::Start\n&quot;));</span>
<a href="#l3.434"></a><span id="l3.434">   nsCMSMessage *cmsMsg = static_cast&lt;nsCMSMessage*&gt;(aMsg);</span>
<a href="#l3.435"></a><span id="l3.435">   m_ctx = new PipUIContext();</span>
<a href="#l3.436"></a><span id="l3.436"> </span>
<a href="#l3.437"></a><span id="l3.437">   m_ecx = NSS_CMSEncoder_Start(cmsMsg-&gt;getCMS(), cb, arg, 0, 0, 0, m_ctx, 0, 0, 0, 0);</span>
<a href="#l3.438"></a><span id="l3.438">   if (!m_ecx) {</span>
<a href="#l3.439"></a><span id="l3.439">     MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSEncoder::Start - can't start encoder\n&quot;));</span>
<a href="#l3.440"></a><span id="l3.440">     return NS_ERROR_FAILURE;</span>
<a href="#l3.441"></a><span id="l3.441">   }</span>
<a href="#l3.442"></a><span id="l3.442">   return NS_OK;</span>
<a href="#l3.443"></a><span id="l3.443"> }</span>
<a href="#l3.444"></a><span id="l3.444"> </span>
<a href="#l3.445"></a><span id="l3.445"> /* void update (in string aBuf, in long aLen); */</span>
<a href="#l3.446"></a><span id="l3.446"> NS_IMETHODIMP nsCMSEncoder::Update(const char *aBuf, int32_t aLen)</span>
<a href="#l3.447"></a><span id="l3.447"> {</span>
<a href="#l3.448"></a><span id="l3.448" class="difflineminus">-  nsNSSShutDownPreventionLock locker;</span>
<a href="#l3.449"></a><span id="l3.449" class="difflineminus">-  if (isAlreadyShutDown())</span>
<a href="#l3.450"></a><span id="l3.450" class="difflineminus">-    return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l3.451"></a><span id="l3.451" class="difflineminus">-</span>
<a href="#l3.452"></a><span id="l3.452">   MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSEncoder::Update\n&quot;));</span>
<a href="#l3.453"></a><span id="l3.453">   if (!m_ecx || NSS_CMSEncoder_Update(m_ecx, aBuf, aLen) != SECSuccess) {</span>
<a href="#l3.454"></a><span id="l3.454">     MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSEncoder::Update - can't update encoder\n&quot;));</span>
<a href="#l3.455"></a><span id="l3.455">     return NS_ERROR_FAILURE;</span>
<a href="#l3.456"></a><span id="l3.456">   }</span>
<a href="#l3.457"></a><span id="l3.457">   return NS_OK;</span>
<a href="#l3.458"></a><span id="l3.458"> }</span>
<a href="#l3.459"></a><span id="l3.459"> </span>
<a href="#l3.460"></a><span id="l3.460"> /* void finish (); */</span>
<a href="#l3.461"></a><span id="l3.461"> NS_IMETHODIMP nsCMSEncoder::Finish()</span>
<a href="#l3.462"></a><span id="l3.462"> {</span>
<a href="#l3.463"></a><span id="l3.463" class="difflineminus">-  nsNSSShutDownPreventionLock locker;</span>
<a href="#l3.464"></a><span id="l3.464" class="difflineminus">-  if (isAlreadyShutDown())</span>
<a href="#l3.465"></a><span id="l3.465" class="difflineminus">-    return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l3.466"></a><span id="l3.466" class="difflineminus">-</span>
<a href="#l3.467"></a><span id="l3.467">   nsresult rv = NS_OK;</span>
<a href="#l3.468"></a><span id="l3.468">   MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSEncoder::Finish\n&quot;));</span>
<a href="#l3.469"></a><span id="l3.469">   if (!m_ecx || NSS_CMSEncoder_Finish(m_ecx) != SECSuccess) {</span>
<a href="#l3.470"></a><span id="l3.470">     MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSEncoder::Finish - can't finish encoder\n&quot;));</span>
<a href="#l3.471"></a><span id="l3.471">     rv = NS_ERROR_FAILURE;</span>
<a href="#l3.472"></a><span id="l3.472">   }</span>
<a href="#l3.473"></a><span id="l3.473">   m_ecx = nullptr;</span>
<a href="#l3.474"></a><span id="l3.474">   return rv;</span>
<a href="#l3.475"></a><span id="l3.475"> }</span>
<a href="#l3.476"></a><span id="l3.476"> </span>
<a href="#l3.477"></a><span id="l3.477"> /* void encode (in nsICMSMessage aMsg); */</span>
<a href="#l3.478"></a><span id="l3.478"> NS_IMETHODIMP nsCMSEncoder::Encode(nsICMSMessage *aMsg)</span>
<a href="#l3.479"></a><span id="l3.479"> {</span>
<a href="#l3.480"></a><span id="l3.480" class="difflineminus">-  nsNSSShutDownPreventionLock locker;</span>
<a href="#l3.481"></a><span id="l3.481" class="difflineminus">-  if (isAlreadyShutDown())</span>
<a href="#l3.482"></a><span id="l3.482" class="difflineminus">-    return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l3.483"></a><span id="l3.483" class="difflineminus">-</span>
<a href="#l3.484"></a><span id="l3.484">   MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSEncoder::Encode\n&quot;));</span>
<a href="#l3.485"></a><span id="l3.485">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l3.486"></a><span id="l3.486"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/mime/src/nsCMS.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/mime/src/nsCMS.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -11,24 +11,22 @@</span>
<a href="#l4.4"></a><span id="l4.4"> #include &quot;nsIInterfaceRequestor.h&quot;</span>
<a href="#l4.5"></a><span id="l4.5"> #include &quot;nsICMSMessage.h&quot;</span>
<a href="#l4.6"></a><span id="l4.6"> #include &quot;nsICMSMessage2.h&quot;</span>
<a href="#l4.7"></a><span id="l4.7"> #include &quot;nsIX509Cert.h&quot;</span>
<a href="#l4.8"></a><span id="l4.8"> #include &quot;nsICMSEncoder.h&quot;</span>
<a href="#l4.9"></a><span id="l4.9"> #include &quot;nsICMSDecoder.h&quot;</span>
<a href="#l4.10"></a><span id="l4.10"> #include &quot;sechash.h&quot;</span>
<a href="#l4.11"></a><span id="l4.11"> #include &quot;cms.h&quot;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-#include &quot;nsNSSShutDown.h&quot;</span>
<a href="#l4.13"></a><span id="l4.13"> </span>
<a href="#l4.14"></a><span id="l4.14"> #define NS_CMSMESSAGE_CID \</span>
<a href="#l4.15"></a><span id="l4.15">   { 0xa4557478, 0xae16, 0x11d5, { 0xba,0x4b,0x00,0x10,0x83,0x03,0xb1,0x17 } }</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17"> class nsCMSMessage : public nsICMSMessage,</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-                     public nsICMSMessage2,</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-                     public nsNSSShutDownObject</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+                     public nsICMSMessage2</span>
<a href="#l4.21"></a><span id="l4.21"> {</span>
<a href="#l4.22"></a><span id="l4.22"> public:</span>
<a href="#l4.23"></a><span id="l4.23">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l4.24"></a><span id="l4.24">   NS_DECL_NSICMSMESSAGE</span>
<a href="#l4.25"></a><span id="l4.25">   NS_DECL_NSICMSMESSAGE2</span>
<a href="#l4.26"></a><span id="l4.26"> </span>
<a href="#l4.27"></a><span id="l4.27">   nsCMSMessage();</span>
<a href="#l4.28"></a><span id="l4.28">   nsCMSMessage(NSSCMSMessage* aCMSMsg);</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineat">@@ -41,63 +39,58 @@ private:</span>
<a href="#l4.30"></a><span id="l4.30">   nsCOMPtr&lt;nsIInterfaceRequestor&gt; m_ctx;</span>
<a href="#l4.31"></a><span id="l4.31">   NSSCMSMessage * m_cmsMsg;</span>
<a href="#l4.32"></a><span id="l4.32">   NSSCMSSignerInfo* GetTopLevelSignerInfo();</span>
<a href="#l4.33"></a><span id="l4.33">   nsresult CommonVerifySignature(unsigned char* aDigestData, uint32_t aDigestDataLen);</span>
<a href="#l4.34"></a><span id="l4.34"> </span>
<a href="#l4.35"></a><span id="l4.35">   nsresult CommonAsyncVerifySignature(nsISMimeVerificationListener *aListener,</span>
<a href="#l4.36"></a><span id="l4.36">                                       unsigned char* aDigestData, uint32_t aDigestDataLen);</span>
<a href="#l4.37"></a><span id="l4.37"> </span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-  virtual void virtualDestroyNSSReference() override;</span>
<a href="#l4.39"></a><span id="l4.39">   void destructorSafeDestroyNSSReference();</span>
<a href="#l4.40"></a><span id="l4.40"> </span>
<a href="#l4.41"></a><span id="l4.41"> };</span>
<a href="#l4.42"></a><span id="l4.42"> </span>
<a href="#l4.43"></a><span id="l4.43"> // ===============================================</span>
<a href="#l4.44"></a><span id="l4.44"> // nsCMSDecoder - implementation of nsICMSDecoder</span>
<a href="#l4.45"></a><span id="l4.45"> // ===============================================</span>
<a href="#l4.46"></a><span id="l4.46"> </span>
<a href="#l4.47"></a><span id="l4.47"> #define NS_CMSDECODER_CID \</span>
<a href="#l4.48"></a><span id="l4.48">   { 0x9dcef3a4, 0xa3bc, 0x11d5, { 0xba, 0x47, 0x00, 0x10, 0x83, 0x03, 0xb1, 0x17 } }</span>
<a href="#l4.49"></a><span id="l4.49"> </span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-class nsCMSDecoder : public nsICMSDecoder,</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-                     public nsNSSShutDownObject</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+class nsCMSDecoder : public nsICMSDecoder</span>
<a href="#l4.53"></a><span id="l4.53"> {</span>
<a href="#l4.54"></a><span id="l4.54"> public:</span>
<a href="#l4.55"></a><span id="l4.55">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l4.56"></a><span id="l4.56">   NS_DECL_NSICMSDECODER</span>
<a href="#l4.57"></a><span id="l4.57"> </span>
<a href="#l4.58"></a><span id="l4.58">   nsCMSDecoder();</span>
<a href="#l4.59"></a><span id="l4.59">   nsresult Init();</span>
<a href="#l4.60"></a><span id="l4.60"> </span>
<a href="#l4.61"></a><span id="l4.61"> private:</span>
<a href="#l4.62"></a><span id="l4.62">   virtual ~nsCMSDecoder();</span>
<a href="#l4.63"></a><span id="l4.63">   nsCOMPtr&lt;nsIInterfaceRequestor&gt; m_ctx;</span>
<a href="#l4.64"></a><span id="l4.64">   NSSCMSDecoderContext *m_dcx;</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineminus">-  virtual void virtualDestroyNSSReference() override;</span>
<a href="#l4.66"></a><span id="l4.66">   void destructorSafeDestroyNSSReference();</span>
<a href="#l4.67"></a><span id="l4.67"> };</span>
<a href="#l4.68"></a><span id="l4.68"> </span>
<a href="#l4.69"></a><span id="l4.69"> // ===============================================</span>
<a href="#l4.70"></a><span id="l4.70"> // nsCMSEncoder - implementation of nsICMSEncoder</span>
<a href="#l4.71"></a><span id="l4.71"> // ===============================================</span>
<a href="#l4.72"></a><span id="l4.72"> </span>
<a href="#l4.73"></a><span id="l4.73"> #define NS_CMSENCODER_CID \</span>
<a href="#l4.74"></a><span id="l4.74">   { 0xa15789aa, 0x8903, 0x462b, { 0x81, 0xe9, 0x4a, 0xa2, 0xcf, 0xf4, 0xd5, 0xcb } }</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineminus">-class nsCMSEncoder : public nsICMSEncoder,</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineminus">-                     public nsNSSShutDownObject</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+class nsCMSEncoder : public nsICMSEncoder</span>
<a href="#l4.78"></a><span id="l4.78"> {</span>
<a href="#l4.79"></a><span id="l4.79"> public:</span>
<a href="#l4.80"></a><span id="l4.80">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l4.81"></a><span id="l4.81">   NS_DECL_NSICMSENCODER</span>
<a href="#l4.82"></a><span id="l4.82"> </span>
<a href="#l4.83"></a><span id="l4.83">   nsCMSEncoder();</span>
<a href="#l4.84"></a><span id="l4.84">   nsresult Init();</span>
<a href="#l4.85"></a><span id="l4.85"> </span>
<a href="#l4.86"></a><span id="l4.86"> private:</span>
<a href="#l4.87"></a><span id="l4.87">   virtual ~nsCMSEncoder();</span>
<a href="#l4.88"></a><span id="l4.88">   nsCOMPtr&lt;nsIInterfaceRequestor&gt; m_ctx;</span>
<a href="#l4.89"></a><span id="l4.89">   NSSCMSEncoderContext *m_ecx;</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineminus">-  virtual void virtualDestroyNSSReference() override;</span>
<a href="#l4.91"></a><span id="l4.91">   void destructorSafeDestroyNSSReference();</span>
<a href="#l4.92"></a><span id="l4.92"> };</span>
<a href="#l4.93"></a><span id="l4.93"> </span>
<a href="#l4.94"></a><span id="l4.94"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/mime/src/nsCMSSecureMessage.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/mime/src/nsCMSSecureMessage.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -16,17 +16,16 @@</span>
<a href="#l5.4"></a><span id="l5.4"> #include &quot;nsDependentSubstring.h&quot;</span>
<a href="#l5.5"></a><span id="l5.5"> #include &quot;nsIInterfaceRequestor.h&quot;</span>
<a href="#l5.6"></a><span id="l5.6"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l5.7"></a><span id="l5.7"> #include &quot;nsISupports.h&quot;</span>
<a href="#l5.8"></a><span id="l5.8"> #include &quot;nsIX509Cert.h&quot;</span>
<a href="#l5.9"></a><span id="l5.9"> #include &quot;nsIX509CertDB.h&quot;</span>
<a href="#l5.10"></a><span id="l5.10"> #include &quot;nsNSSComponent.h&quot;</span>
<a href="#l5.11"></a><span id="l5.11"> #include &quot;nsNSSHelper.h&quot;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-#include &quot;nsNSSShutDown.h&quot;</span>
<a href="#l5.13"></a><span id="l5.13"> #include &quot;plbase64.h&quot;</span>
<a href="#l5.14"></a><span id="l5.14"> </span>
<a href="#l5.15"></a><span id="l5.15"> #ifdef PR_LOGGING</span>
<a href="#l5.16"></a><span id="l5.16"> extern mozilla::LazyLogModule gPIPNSSLog;</span>
<a href="#l5.17"></a><span id="l5.17"> #endif</span>
<a href="#l5.18"></a><span id="l5.18"> </span>
<a href="#l5.19"></a><span id="l5.19"> using namespace mozilla;</span>
<a href="#l5.20"></a><span id="l5.20"> using namespace mozilla::psm;</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineat">@@ -92,17 +91,16 @@ NS_IMETHODIMP nsCMSSecureMessage::CanBeU</span>
<a href="#l5.22"></a><span id="l5.22"> NS_IMETHODIMP nsCMSSecureMessage::CanBeUsedForEmailSigning(nsIX509Cert* aCert, bool* aCanBeUsed) {</span>
<a href="#l5.23"></a><span id="l5.23">   return CheckUsageOk(aCert, certificateUsageEmailSigner, aCanBeUsed);</span>
<a href="#l5.24"></a><span id="l5.24"> }</span>
<a href="#l5.25"></a><span id="l5.25"> </span>
<a href="#l5.26"></a><span id="l5.26"> // nsCMSSecureMessage::DecodeCert</span>
<a href="#l5.27"></a><span id="l5.27"> NS_IMETHODIMP nsCMSSecureMessage::</span>
<a href="#l5.28"></a><span id="l5.28"> DecodeCert(const char *value, nsIX509Cert ** _retval)</span>
<a href="#l5.29"></a><span id="l5.29"> {</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-  nsNSSShutDownPreventionLock locker;</span>
<a href="#l5.31"></a><span id="l5.31">   MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSSecureMessage::DecodeCert\n&quot;));</span>
<a href="#l5.32"></a><span id="l5.32">   nsresult rv = NS_OK;</span>
<a href="#l5.33"></a><span id="l5.33">   int32_t length;</span>
<a href="#l5.34"></a><span id="l5.34">   unsigned char *data = 0;</span>
<a href="#l5.35"></a><span id="l5.35"> </span>
<a href="#l5.36"></a><span id="l5.36">   *_retval = 0;</span>
<a href="#l5.37"></a><span id="l5.37"> </span>
<a href="#l5.38"></a><span id="l5.38">   if (!value) { return NS_ERROR_FAILURE; }</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineat">@@ -132,17 +130,16 @@ DecodeCert(const char *value, nsIX509Cer</span>
<a href="#l5.40"></a><span id="l5.40"> // nsCMSSecureMessage::SendMessage</span>
<a href="#l5.41"></a><span id="l5.41"> // Don't clash with Bill's versions SendMessageA or SendMessageW.</span>
<a href="#l5.42"></a><span id="l5.42"> #if defined (_MSC_VER)</span>
<a href="#l5.43"></a><span id="l5.43"> #undef SendMessage</span>
<a href="#l5.44"></a><span id="l5.44"> #endif</span>
<a href="#l5.45"></a><span id="l5.45"> NS_IMETHODIMP nsCMSSecureMessage::</span>
<a href="#l5.46"></a><span id="l5.46"> SendMessage(const char *msg, const char *base64Cert, char ** _retval)</span>
<a href="#l5.47"></a><span id="l5.47"> {</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">-  nsNSSShutDownPreventionLock locker;</span>
<a href="#l5.49"></a><span id="l5.49">   MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSSecureMessage::SendMessage\n&quot;));</span>
<a href="#l5.50"></a><span id="l5.50">   nsresult rv = NS_OK;</span>
<a href="#l5.51"></a><span id="l5.51">   CERTCertificate *cert = 0;</span>
<a href="#l5.52"></a><span id="l5.52">   NSSCMSMessage *cmsMsg = 0;</span>
<a href="#l5.53"></a><span id="l5.53">   unsigned char *certDER = 0;</span>
<a href="#l5.54"></a><span id="l5.54">   int32_t derLen;</span>
<a href="#l5.55"></a><span id="l5.55">   NSSCMSEnvelopedData *env;</span>
<a href="#l5.56"></a><span id="l5.56">   NSSCMSContentInfo *cinfo;</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineat">@@ -256,17 +253,16 @@ done:</span>
<a href="#l5.58"></a><span id="l5.58"> }</span>
<a href="#l5.59"></a><span id="l5.59"> </span>
<a href="#l5.60"></a><span id="l5.60"> /*</span>
<a href="#l5.61"></a><span id="l5.61">  * nsCMSSecureMessage::ReceiveMessage</span>
<a href="#l5.62"></a><span id="l5.62">  */</span>
<a href="#l5.63"></a><span id="l5.63"> NS_IMETHODIMP nsCMSSecureMessage::</span>
<a href="#l5.64"></a><span id="l5.64"> ReceiveMessage(const char *msg, char **_retval)</span>
<a href="#l5.65"></a><span id="l5.65"> {</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineminus">-  nsNSSShutDownPreventionLock locker;</span>
<a href="#l5.67"></a><span id="l5.67">   MOZ_LOG(gPIPNSSLog, LogLevel::Debug, (&quot;nsCMSSecureMessage::ReceiveMessage\n&quot;));</span>
<a href="#l5.68"></a><span id="l5.68">   nsresult rv = NS_OK;</span>
<a href="#l5.69"></a><span id="l5.69">   NSSCMSDecoderContext *dcx;</span>
<a href="#l5.70"></a><span id="l5.70">   unsigned char *der = 0;</span>
<a href="#l5.71"></a><span id="l5.71">   int32_t derLen;</span>
<a href="#l5.72"></a><span id="l5.72">   NSSCMSMessage *cmsMsg = 0;</span>
<a href="#l5.73"></a><span id="l5.73">   SECItem *content;</span>
<a href="#l5.74"></a><span id="l5.74">   nsCOMPtr&lt;nsIInterfaceRequestor&gt; ctx = new PipUIContext();</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

