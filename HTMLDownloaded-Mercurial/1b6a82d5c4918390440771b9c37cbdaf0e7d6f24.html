<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26423:1b6a82d5c4918390440771b9c37cbdaf0e7d6f24</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 1b6a82d5c4918390440771b9c37cbdaf0e7d6f24" />
<meta property="og:url" content="/comm-central/rev/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24" />
<meta property="og:description" content="Bug 1546364 - Reformat to Google coding style in mailnews/extensions. rs=reformat" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 1b6a82d5c4918390440771b9c37cbdaf0e7d6f24 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24">shortlog</a> |
<a href="/comm-central/log/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24">files</a> |
changeset |
<a href="/comm-central/raw-rev/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24">raw</a>  | <a href="/comm-central/archive/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mailnews/extensions. rs=reformat
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 24 Apr 2019 10:34:36 +0200</td></tr>

<tr>
 <td>changeset 26423</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24">1b6a82d5c4918390440771b9c37cbdaf0e7d6f24</a></td>
</tr>



<tr>
<td>parent 26422</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/9d2f71d5e74d14a10a5432b7a17fe6949964ca90">9d2f71d5e74d14a10a5432b7a17fe6949964ca90</a>
</td>
</tr>

<tr>
<td>child 26424</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/4965f8d61f03bad242a90df92454e5fd52763f4f">4965f8d61f03bad242a90df92454e5fd52763f4f</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=1b6a82d5c4918390440771b9c37cbdaf0e7d6f24">15829</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 24 Apr 2019 08:37:09 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@4965f8d61f03 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4965f8d61f03bad242a90df92454e5fd52763f4f">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4965f8d61f03bad242a90df92454e5fd52763f4f&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4965f8d61f03bad242a90df92454e5fd52763f4f&newProject=comm-central&newRevision=a7efaecb39ccf179d84a3375da8609698435ef58&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4965f8d61f03bad242a90df92454e5fd52763f4f&newProject=comm-central&newRevision=a7efaecb39ccf179d84a3375da8609698435ef58&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4965f8d61f03bad242a90df92454e5fd52763f4f&newProject=comm-central&newRevision=a7efaecb39ccf179d84a3375da8609698435ef58&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28reformat%29&revcount=50">reformat</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">1546364</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mailnews/extensions. rs=reformat
# ignore-this-changeset</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/base/public/nsIMsgMdnGenerator.idl">mailnews/base/public/nsIMsgMdnGenerator.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/base/public/nsIMsgMdnGenerator.idl">file</a> |
<a href="/comm-central/annotate/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/base/public/nsIMsgMdnGenerator.idl">annotate</a> |
<a href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/base/public/nsIMsgMdnGenerator.idl">diff</a> |
<a href="/comm-central/comparison/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/base/public/nsIMsgMdnGenerator.idl">comparison</a> |
<a href="/comm-central/log/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/base/public/nsIMsgMdnGenerator.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">file</a> |
<a href="/comm-central/annotate/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">annotate</a> |
<a href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">diff</a> |
<a href="/comm-central/comparison/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">comparison</a> |
<a href="/comm-central/log/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.h">mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.h">file</a> |
<a href="/comm-central/annotate/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.h">annotate</a> |
<a href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.h">diff</a> |
<a href="/comm-central/comparison/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.h">comparison</a> |
<a href="/comm-central/log/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilterCID.h">mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilterCID.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilterCID.h">file</a> |
<a href="/comm-central/annotate/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilterCID.h">annotate</a> |
<a href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilterCID.h">diff</a> |
<a href="/comm-central/comparison/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilterCID.h">comparison</a> |
<a href="/comm-central/log/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilterCID.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/bayesian-spam-filter/src/nsIncompleteGamma.h">mailnews/extensions/bayesian-spam-filter/src/nsIncompleteGamma.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/bayesian-spam-filter/src/nsIncompleteGamma.h">file</a> |
<a href="/comm-central/annotate/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/bayesian-spam-filter/src/nsIncompleteGamma.h">annotate</a> |
<a href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/bayesian-spam-filter/src/nsIncompleteGamma.h">diff</a> |
<a href="/comm-central/comparison/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/bayesian-spam-filter/src/nsIncompleteGamma.h">comparison</a> |
<a href="/comm-central/log/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/bayesian-spam-filter/src/nsIncompleteGamma.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/Normalize.c">mailnews/extensions/fts3/src/Normalize.c</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/Normalize.c">file</a> |
<a href="/comm-central/annotate/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/Normalize.c">annotate</a> |
<a href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/Normalize.c">diff</a> |
<a href="/comm-central/comparison/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/Normalize.c">comparison</a> |
<a href="/comm-central/log/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/Normalize.c">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/fts3_porter.c">mailnews/extensions/fts3/src/fts3_porter.c</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/fts3_porter.c">file</a> |
<a href="/comm-central/annotate/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/fts3_porter.c">annotate</a> |
<a href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/fts3_porter.c">diff</a> |
<a href="/comm-central/comparison/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/fts3_porter.c">comparison</a> |
<a href="/comm-central/log/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/fts3_porter.c">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/fts3_tokenizer.h">mailnews/extensions/fts3/src/fts3_tokenizer.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/fts3_tokenizer.h">file</a> |
<a href="/comm-central/annotate/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/fts3_tokenizer.h">annotate</a> |
<a href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/fts3_tokenizer.h">diff</a> |
<a href="/comm-central/comparison/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/fts3_tokenizer.h">comparison</a> |
<a href="/comm-central/log/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/fts3_tokenizer.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/nsFts3Tokenizer.cpp">mailnews/extensions/fts3/src/nsFts3Tokenizer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/nsFts3Tokenizer.cpp">file</a> |
<a href="/comm-central/annotate/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/nsFts3Tokenizer.cpp">annotate</a> |
<a href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/nsFts3Tokenizer.cpp">diff</a> |
<a href="/comm-central/comparison/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/nsFts3Tokenizer.cpp">comparison</a> |
<a href="/comm-central/log/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/nsFts3Tokenizer.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/nsFts3Tokenizer.h">mailnews/extensions/fts3/src/nsFts3Tokenizer.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/nsFts3Tokenizer.h">file</a> |
<a href="/comm-central/annotate/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/nsFts3Tokenizer.h">annotate</a> |
<a href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/nsFts3Tokenizer.h">diff</a> |
<a href="/comm-central/comparison/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/nsFts3Tokenizer.h">comparison</a> |
<a href="/comm-central/log/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/nsFts3Tokenizer.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/nsFts3TokenizerCID.h">mailnews/extensions/fts3/src/nsFts3TokenizerCID.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/nsFts3TokenizerCID.h">file</a> |
<a href="/comm-central/annotate/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/nsFts3TokenizerCID.h">annotate</a> |
<a href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/nsFts3TokenizerCID.h">diff</a> |
<a href="/comm-central/comparison/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/nsFts3TokenizerCID.h">comparison</a> |
<a href="/comm-central/log/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/nsFts3TokenizerCID.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/nsGlodaRankerFunction.cpp">mailnews/extensions/fts3/src/nsGlodaRankerFunction.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/nsGlodaRankerFunction.cpp">file</a> |
<a href="/comm-central/annotate/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/nsGlodaRankerFunction.cpp">annotate</a> |
<a href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/nsGlodaRankerFunction.cpp">diff</a> |
<a href="/comm-central/comparison/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/nsGlodaRankerFunction.cpp">comparison</a> |
<a href="/comm-central/log/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/nsGlodaRankerFunction.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/nsGlodaRankerFunction.h">mailnews/extensions/fts3/src/nsGlodaRankerFunction.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/nsGlodaRankerFunction.h">file</a> |
<a href="/comm-central/annotate/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/nsGlodaRankerFunction.h">annotate</a> |
<a href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/nsGlodaRankerFunction.h">diff</a> |
<a href="/comm-central/comparison/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/nsGlodaRankerFunction.h">comparison</a> |
<a href="/comm-central/log/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/fts3/src/nsGlodaRankerFunction.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/mailviews/src/nsMsgMailViewList.cpp">mailnews/extensions/mailviews/src/nsMsgMailViewList.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/mailviews/src/nsMsgMailViewList.cpp">file</a> |
<a href="/comm-central/annotate/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/mailviews/src/nsMsgMailViewList.cpp">annotate</a> |
<a href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/mailviews/src/nsMsgMailViewList.cpp">diff</a> |
<a href="/comm-central/comparison/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/mailviews/src/nsMsgMailViewList.cpp">comparison</a> |
<a href="/comm-central/log/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/mailviews/src/nsMsgMailViewList.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/mailviews/src/nsMsgMailViewList.h">mailnews/extensions/mailviews/src/nsMsgMailViewList.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/mailviews/src/nsMsgMailViewList.h">file</a> |
<a href="/comm-central/annotate/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/mailviews/src/nsMsgMailViewList.h">annotate</a> |
<a href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/mailviews/src/nsMsgMailViewList.h">diff</a> |
<a href="/comm-central/comparison/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/mailviews/src/nsMsgMailViewList.h">comparison</a> |
<a href="/comm-central/log/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/mailviews/src/nsMsgMailViewList.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/mailviews/src/nsMsgMailViewsCID.h">mailnews/extensions/mailviews/src/nsMsgMailViewsCID.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/mailviews/src/nsMsgMailViewsCID.h">file</a> |
<a href="/comm-central/annotate/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/mailviews/src/nsMsgMailViewsCID.h">annotate</a> |
<a href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/mailviews/src/nsMsgMailViewsCID.h">diff</a> |
<a href="/comm-central/comparison/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/mailviews/src/nsMsgMailViewsCID.h">comparison</a> |
<a href="/comm-central/log/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/mailviews/src/nsMsgMailViewsCID.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/mdn/src/nsMsgMdnCID.h">mailnews/extensions/mdn/src/nsMsgMdnCID.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/mdn/src/nsMsgMdnCID.h">file</a> |
<a href="/comm-central/annotate/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/mdn/src/nsMsgMdnCID.h">annotate</a> |
<a href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/mdn/src/nsMsgMdnCID.h">diff</a> |
<a href="/comm-central/comparison/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/mdn/src/nsMsgMdnCID.h">comparison</a> |
<a href="/comm-central/log/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/mdn/src/nsMsgMdnCID.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp">mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp">file</a> |
<a href="/comm-central/annotate/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp">annotate</a> |
<a href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp">diff</a> |
<a href="/comm-central/comparison/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp">comparison</a> |
<a href="/comm-central/log/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/mdn/src/nsMsgMdnGenerator.h">mailnews/extensions/mdn/src/nsMsgMdnGenerator.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/mdn/src/nsMsgMdnGenerator.h">file</a> |
<a href="/comm-central/annotate/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/mdn/src/nsMsgMdnGenerator.h">annotate</a> |
<a href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/mdn/src/nsMsgMdnGenerator.h">diff</a> |
<a href="/comm-central/comparison/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/mdn/src/nsMsgMdnGenerator.h">comparison</a> |
<a href="/comm-central/log/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/mdn/src/nsMsgMdnGenerator.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsCertPicker.cpp">mailnews/extensions/smime/src/nsCertPicker.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsCertPicker.cpp">file</a> |
<a href="/comm-central/annotate/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsCertPicker.cpp">annotate</a> |
<a href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsCertPicker.cpp">diff</a> |
<a href="/comm-central/comparison/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsCertPicker.cpp">comparison</a> |
<a href="/comm-central/log/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsCertPicker.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsCertPicker.h">mailnews/extensions/smime/src/nsCertPicker.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsCertPicker.h">file</a> |
<a href="/comm-central/annotate/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsCertPicker.h">annotate</a> |
<a href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsCertPicker.h">diff</a> |
<a href="/comm-central/comparison/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsCertPicker.h">comparison</a> |
<a href="/comm-central/log/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsCertPicker.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsEncryptedSMIMEURIsService.cpp">mailnews/extensions/smime/src/nsEncryptedSMIMEURIsService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsEncryptedSMIMEURIsService.cpp">file</a> |
<a href="/comm-central/annotate/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsEncryptedSMIMEURIsService.cpp">annotate</a> |
<a href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsEncryptedSMIMEURIsService.cpp">diff</a> |
<a href="/comm-central/comparison/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsEncryptedSMIMEURIsService.cpp">comparison</a> |
<a href="/comm-central/log/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsEncryptedSMIMEURIsService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsEncryptedSMIMEURIsService.h">mailnews/extensions/smime/src/nsEncryptedSMIMEURIsService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsEncryptedSMIMEURIsService.h">file</a> |
<a href="/comm-central/annotate/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsEncryptedSMIMEURIsService.h">annotate</a> |
<a href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsEncryptedSMIMEURIsService.h">diff</a> |
<a href="/comm-central/comparison/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsEncryptedSMIMEURIsService.h">comparison</a> |
<a href="/comm-central/log/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsEncryptedSMIMEURIsService.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsMsgComposeSecure.cpp">mailnews/extensions/smime/src/nsMsgComposeSecure.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsMsgComposeSecure.cpp">file</a> |
<a href="/comm-central/annotate/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsMsgComposeSecure.cpp">annotate</a> |
<a href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsMsgComposeSecure.cpp">diff</a> |
<a href="/comm-central/comparison/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsMsgComposeSecure.cpp">comparison</a> |
<a href="/comm-central/log/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsMsgComposeSecure.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsMsgComposeSecure.h">mailnews/extensions/smime/src/nsMsgComposeSecure.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsMsgComposeSecure.h">file</a> |
<a href="/comm-central/annotate/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsMsgComposeSecure.h">annotate</a> |
<a href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsMsgComposeSecure.h">diff</a> |
<a href="/comm-central/comparison/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsMsgComposeSecure.h">comparison</a> |
<a href="/comm-central/log/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsMsgComposeSecure.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsMsgSMIMECID.h">mailnews/extensions/smime/src/nsMsgSMIMECID.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsMsgSMIMECID.h">file</a> |
<a href="/comm-central/annotate/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsMsgSMIMECID.h">annotate</a> |
<a href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsMsgSMIMECID.h">diff</a> |
<a href="/comm-central/comparison/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsMsgSMIMECID.h">comparison</a> |
<a href="/comm-central/log/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsMsgSMIMECID.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsSMimeJSHelper.cpp">mailnews/extensions/smime/src/nsSMimeJSHelper.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsSMimeJSHelper.cpp">file</a> |
<a href="/comm-central/annotate/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsSMimeJSHelper.cpp">annotate</a> |
<a href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsSMimeJSHelper.cpp">diff</a> |
<a href="/comm-central/comparison/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsSMimeJSHelper.cpp">comparison</a> |
<a href="/comm-central/log/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsSMimeJSHelper.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsSMimeJSHelper.h">mailnews/extensions/smime/src/nsSMimeJSHelper.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsSMimeJSHelper.h">file</a> |
<a href="/comm-central/annotate/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsSMimeJSHelper.h">annotate</a> |
<a href="/comm-central/diff/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsSMimeJSHelper.h">diff</a> |
<a href="/comm-central/comparison/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsSMimeJSHelper.h">comparison</a> |
<a href="/comm-central/log/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24/mailnews/extensions/smime/src/nsSMimeJSHelper.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgMdnGenerator.idl</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgMdnGenerator.idl</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -9,26 +9,16 @@</span>
<a href="#l1.4"></a><span id="l1.4"> interface nsIMsgWindow;</span>
<a href="#l1.5"></a><span id="l1.5"> interface nsIMsgFolder;</span>
<a href="#l1.6"></a><span id="l1.6"> interface nsIMimeHeaders;</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> typedef long EDisposeType;</span>
<a href="#l1.9"></a><span id="l1.9"> typedef long ReceiptHdrType;</span>
<a href="#l1.10"></a><span id="l1.10"> typedef long MDNIncorporateType;</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-%{C++</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-#define NS_MSGMDNGENERATOR_CONTRACTID \</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-  &quot;@mozilla.org/messenger-mdn/generator;1&quot;</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-#define NS_MSGMDNGENERATOR_CID                    \</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-{ /* ec917b13-8f73-4d4d-9146-d7f7aafe9076 */      \</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">- 0xec917b13, 0x8f73, 0x4d4d,                      \</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">- { 0x91, 0x46, 0xd7, 0xf7, 0xaa, 0xfe, 0x90, 0x76 }}</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-%}</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-</span>
<a href="#l1.22"></a><span id="l1.22"> [scriptable, uuid(440EA3DE-DACA-4886-9875-84E6CD7D7927)]</span>
<a href="#l1.23"></a><span id="l1.23"> interface nsIMsgMdnGenerator : nsISupports</span>
<a href="#l1.24"></a><span id="l1.24"> {</span>
<a href="#l1.25"></a><span id="l1.25">     const EDisposeType eDisplayed = 0;</span>
<a href="#l1.26"></a><span id="l1.26">     const EDisposeType eDispatched = 1;</span>
<a href="#l1.27"></a><span id="l1.27">     const EDisposeType eProcessed = 2;</span>
<a href="#l1.28"></a><span id="l1.28">     const EDisposeType eDeleted = 3;</span>
<a href="#l1.29"></a><span id="l1.29">     const EDisposeType eDenied = 4;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -4,17 +4,17 @@</span>
<a href="#l2.4"></a><span id="l2.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6"> #include &quot;nsBayesianFilter.h&quot;</span>
<a href="#l2.7"></a><span id="l2.7"> #include &quot;nsIInputStream.h&quot;</span>
<a href="#l2.8"></a><span id="l2.8"> #include &quot;nsIStreamListener.h&quot;</span>
<a href="#l2.9"></a><span id="l2.9"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l2.10"></a><span id="l2.10"> #include &quot;nsQuickSort.h&quot;</span>
<a href="#l2.11"></a><span id="l2.11"> #include &quot;nsIMsgMessageService.h&quot;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-#include &quot;nsMsgUtils.h&quot; // for GetMessageServiceFromURI</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+#include &quot;nsMsgUtils.h&quot;  // for GetMessageServiceFromURI</span>
<a href="#l2.14"></a><span id="l2.14"> #include &quot;prnetdb.h&quot;</span>
<a href="#l2.15"></a><span id="l2.15"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l2.16"></a><span id="l2.16"> #include &quot;mozilla/Logging.h&quot;</span>
<a href="#l2.17"></a><span id="l2.17"> #include &quot;nsAppDirectoryServiceDefs.h&quot;</span>
<a href="#l2.18"></a><span id="l2.18"> #include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l2.19"></a><span id="l2.19"> #include &quot;nsDirectoryServiceUtils.h&quot;</span>
<a href="#l2.20"></a><span id="l2.20"> #include &quot;nsIMIMEHeaderParam.h&quot;</span>
<a href="#l2.21"></a><span id="l2.21"> #include &quot;nsNetCID.h&quot;</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -24,17 +24,17 @@</span>
<a href="#l2.23"></a><span id="l2.23"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l2.24"></a><span id="l2.24"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l2.25"></a><span id="l2.25"> #include &quot;nsIStringEnumerator.h&quot;</span>
<a href="#l2.26"></a><span id="l2.26"> #include &quot;nsIObserverService.h&quot;</span>
<a href="#l2.27"></a><span id="l2.27"> #include &quot;nsIChannel.h&quot;</span>
<a href="#l2.28"></a><span id="l2.28"> #include &quot;nsDependentSubstring.h&quot;</span>
<a href="#l2.29"></a><span id="l2.29"> #include &quot;nsMemory.h&quot;</span>
<a href="#l2.30"></a><span id="l2.30"> </span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-#include &quot;mozilla/ArenaAllocatorExtensions.h&quot; // for ArenaStrdup</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+#include &quot;mozilla/ArenaAllocatorExtensions.h&quot;  // for ArenaStrdup</span>
<a href="#l2.33"></a><span id="l2.33"> </span>
<a href="#l2.34"></a><span id="l2.34"> using namespace mozilla;</span>
<a href="#l2.35"></a><span id="l2.35"> </span>
<a href="#l2.36"></a><span id="l2.36"> // needed to mark attachment flag on the db hdr</span>
<a href="#l2.37"></a><span id="l2.37"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l2.38"></a><span id="l2.38"> </span>
<a href="#l2.39"></a><span id="l2.39"> // needed to strip html out of the body</span>
<a href="#l2.40"></a><span id="l2.40"> #include &quot;nsLayoutCID.h&quot;</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineat">@@ -42,231 +42,208 @@ using namespace mozilla;</span>
<a href="#l2.42"></a><span id="l2.42"> #include &quot;nsIDocumentEncoder.h&quot;</span>
<a href="#l2.43"></a><span id="l2.43"> </span>
<a href="#l2.44"></a><span id="l2.44"> #include &quot;nsIncompleteGamma.h&quot;</span>
<a href="#l2.45"></a><span id="l2.45"> #include &lt;math.h&gt;</span>
<a href="#l2.46"></a><span id="l2.46"> #include &lt;prmem.h&gt;</span>
<a href="#l2.47"></a><span id="l2.47"> #include &quot;nsIMsgTraitService.h&quot;</span>
<a href="#l2.48"></a><span id="l2.48"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l2.49"></a><span id="l2.49"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-#include &lt;cstdlib&gt; // for std::abs(int/long)</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-#include &lt;cmath&gt; // for std::abs(float/double)</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+#include &lt;cstdlib&gt;  // for std::abs(int/long)</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+#include &lt;cmath&gt;    // for std::abs(float/double)</span>
<a href="#l2.54"></a><span id="l2.54"> </span>
<a href="#l2.55"></a><span id="l2.55"> static mozilla::LazyLogModule BayesianFilterLogModule(&quot;BayesianFilter&quot;);</span>
<a href="#l2.56"></a><span id="l2.56"> </span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-#define kDefaultJunkThreshold .99 // we override this value via a pref</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+#define kDefaultJunkThreshold .99  // we override this value via a pref</span>
<a href="#l2.59"></a><span id="l2.59"> static const char* kBayesianFilterTokenDelimiters = &quot; \t\n\r\f.&quot;;</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineminus">-static unsigned int kMinLengthForToken = 3; // lower bound on the number of characters in a word before we treat it as a token</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineminus">-static unsigned int kMaxLengthForToken = 12; // upper bound on the number of characters in a word to be declared as a token</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+static unsigned int kMinLengthForToken =</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+    3;  // lower bound on the number of characters in a word before we treat it</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+        // as a token</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+static unsigned int kMaxLengthForToken =</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+    12;  // upper bound on the number of characters in a word to be declared as</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+         // a token</span>
<a href="#l2.68"></a><span id="l2.68"> </span>
<a href="#l2.69"></a><span id="l2.69"> #define FORGED_RECEIVED_HEADER_HINT NS_LITERAL_CSTRING(&quot;may be forged&quot;)</span>
<a href="#l2.70"></a><span id="l2.70"> </span>
<a href="#l2.71"></a><span id="l2.71"> #ifndef M_LN2</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineminus">-#define M_LN2 0.69314718055994530942</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+#  define M_LN2 0.69314718055994530942</span>
<a href="#l2.74"></a><span id="l2.74"> #endif</span>
<a href="#l2.75"></a><span id="l2.75"> </span>
<a href="#l2.76"></a><span id="l2.76"> #ifndef M_E</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-#define M_E   2.7182818284590452354</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+#  define M_E 2.7182818284590452354</span>
<a href="#l2.79"></a><span id="l2.79"> #endif</span>
<a href="#l2.80"></a><span id="l2.80"> </span>
<a href="#l2.81"></a><span id="l2.81"> // provide base implementation of hash lookup of a string</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineminus">-struct BaseToken : public PLDHashEntryHdr</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-{</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-    const char* mWord;</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+struct BaseToken : public PLDHashEntryHdr {</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+  const char* mWord;</span>
<a href="#l2.87"></a><span id="l2.87"> };</span>
<a href="#l2.88"></a><span id="l2.88"> </span>
<a href="#l2.89"></a><span id="l2.89"> // token for a particular message</span>
<a href="#l2.90"></a><span id="l2.90"> // mCount, mAnalysisLink are initialized to zero by the hash code</span>
<a href="#l2.91"></a><span id="l2.91"> struct Token : public BaseToken {</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineminus">-    uint32_t mCount;</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineminus">-    uint32_t mAnalysisLink; // index in mAnalysisStore of the AnalysisPerToken</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineminus">-                            // object for the first trait for this token</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineminus">-    // Helper to support Tokenizer::copyTokens()</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineminus">-    void clone(const Token&amp; other) {</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineminus">-      mWord = other.mWord;</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineminus">-      mCount = other.mCount;</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineminus">-      mAnalysisLink = other.mAnalysisLink;</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineminus">-    }</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineplus">+  uint32_t mCount;</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineplus">+  uint32_t mAnalysisLink;  // index in mAnalysisStore of the AnalysisPerToken</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineplus">+                           // object for the first trait for this token</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineplus">+  // Helper to support Tokenizer::copyTokens()</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineplus">+  void clone(const Token&amp; other) {</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineplus">+    mWord = other.mWord;</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineplus">+    mCount = other.mCount;</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineplus">+    mAnalysisLink = other.mAnalysisLink;</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineplus">+  }</span>
<a href="#l2.110"></a><span id="l2.110"> };</span>
<a href="#l2.111"></a><span id="l2.111"> </span>
<a href="#l2.112"></a><span id="l2.112"> // token stored in a training file for a group of messages</span>
<a href="#l2.113"></a><span id="l2.113"> // mTraitLink is initialized to 0 by the hash code</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineminus">-struct CorpusToken : public BaseToken</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineminus">-{</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineminus">-    uint32_t mTraitLink;    // index in mTraitStore of the TraitPerToken</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineminus">-                            // object for the first trait for this token</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineplus">+struct CorpusToken : public BaseToken {</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineplus">+  uint32_t mTraitLink;  // index in mTraitStore of the TraitPerToken</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineplus">+                        // object for the first trait for this token</span>
<a href="#l2.121"></a><span id="l2.121"> };</span>
<a href="#l2.122"></a><span id="l2.122"> </span>
<a href="#l2.123"></a><span id="l2.123"> // set the value of a TraitPerToken object</span>
<a href="#l2.124"></a><span id="l2.124"> TraitPerToken::TraitPerToken(uint32_t aTraitId, uint32_t aCount)</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineminus">-  :  mId(aTraitId), mCount(aCount), mNextLink(0)</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineminus">-{</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineminus">-}</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineplus">+    : mId(aTraitId), mCount(aCount), mNextLink(0) {}</span>
<a href="#l2.129"></a><span id="l2.129"> </span>
<a href="#l2.130"></a><span id="l2.130"> // shorthand representations of trait ids for junk and good</span>
<a href="#l2.131"></a><span id="l2.131"> static const uint32_t kJunkTrait = nsIJunkMailPlugin::JUNK_TRAIT;</span>
<a href="#l2.132"></a><span id="l2.132"> static const uint32_t kGoodTrait = nsIJunkMailPlugin::GOOD_TRAIT;</span>
<a href="#l2.133"></a><span id="l2.133"> </span>
<a href="#l2.134"></a><span id="l2.134"> // set the value of an AnalysisPerToken object</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineminus">-AnalysisPerToken::AnalysisPerToken(</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineminus">-  uint32_t aTraitIndex, double aDistance, double aProbability) :</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineminus">-    mTraitIndex(aTraitIndex),</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineminus">-    mDistance(aDistance),</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineminus">-    mProbability(aProbability),</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineminus">-    mNextLink(0)</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineminus">-{</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineminus">-}</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineplus">+AnalysisPerToken::AnalysisPerToken(uint32_t aTraitIndex, double aDistance,</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineplus">+                                   double aProbability)</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineplus">+    : mTraitIndex(aTraitIndex),</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineplus">+      mDistance(aDistance),</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineplus">+      mProbability(aProbability),</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineplus">+      mNextLink(0) {}</span>
<a href="#l2.149"></a><span id="l2.149"> </span>
<a href="#l2.150"></a><span id="l2.150"> // the initial size of the AnalysisPerToken linked list storage</span>
<a href="#l2.151"></a><span id="l2.151"> const uint32_t kAnalysisStoreCapacity = 2048;</span>
<a href="#l2.152"></a><span id="l2.152"> </span>
<a href="#l2.153"></a><span id="l2.153"> // the initial size of the TraitPerToken linked list storage</span>
<a href="#l2.154"></a><span id="l2.154"> const uint32_t kTraitStoreCapacity = 16384;</span>
<a href="#l2.155"></a><span id="l2.155"> </span>
<a href="#l2.156"></a><span id="l2.156"> // Size of Auto arrays representing per trait information</span>
<a href="#l2.157"></a><span id="l2.157"> const uint32_t kTraitAutoCapacity = 10;</span>
<a href="#l2.158"></a><span id="l2.158"> </span>
<a href="#l2.159"></a><span id="l2.159"> TokenEnumeration::TokenEnumeration(PLDHashTable* table)</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineminus">-    :   mIterator(table-&gt;Iter())</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineminus">-{</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineminus">-}</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineplus">+    : mIterator(table-&gt;Iter()) {}</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineplus">+</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineplus">+inline bool TokenEnumeration::hasMoreTokens() { return !mIterator.Done(); }</span>
<a href="#l2.166"></a><span id="l2.166"> </span>
<a href="#l2.167"></a><span id="l2.167" class="difflineminus">-inline bool TokenEnumeration::hasMoreTokens()</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineminus">-{</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineminus">-    return !mIterator.Done();</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineminus">-}</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineminus">-</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineminus">-inline BaseToken* TokenEnumeration::nextToken()</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineminus">-{</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineminus">-    auto token = static_cast&lt;BaseToken*&gt;(mIterator.Get());</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineminus">-    mIterator.Next();</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineminus">-    return token;</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineplus">+inline BaseToken* TokenEnumeration::nextToken() {</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineplus">+  auto token = static_cast&lt;BaseToken*&gt;(mIterator.Get());</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineplus">+  mIterator.Next();</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineplus">+  return token;</span>
<a href="#l2.181"></a><span id="l2.181"> }</span>
<a href="#l2.182"></a><span id="l2.182"> </span>
<a href="#l2.183"></a><span id="l2.183"> // member variables</span>
<a href="#l2.184"></a><span id="l2.184"> static const PLDHashTableOps gTokenTableOps = {</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineminus">-    PLDHashTable::HashStringKey,</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineminus">-    PLDHashTable::MatchStringKey,</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineminus">-    PLDHashTable::MoveEntryStub,</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineminus">-    PLDHashTable::ClearEntryStub,</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineminus">-    nullptr</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineminus">-};</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineplus">+    PLDHashTable::HashStringKey, PLDHashTable::MatchStringKey,</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineplus">+    PLDHashTable::MoveEntryStub, PLDHashTable::ClearEntryStub, nullptr};</span>
<a href="#l2.193"></a><span id="l2.193"> </span>
<a href="#l2.194"></a><span id="l2.194"> TokenHash::TokenHash(uint32_t aEntrySize)</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineminus">-  : mTokenTable(&amp;gTokenTableOps, aEntrySize, 128)</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineminus">-{</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineminus">-    mEntrySize = aEntrySize;</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineplus">+    : mTokenTable(&amp;gTokenTableOps, aEntrySize, 128) {</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineplus">+  mEntrySize = aEntrySize;</span>
<a href="#l2.200"></a><span id="l2.200"> }</span>
<a href="#l2.201"></a><span id="l2.201"> </span>
<a href="#l2.202"></a><span id="l2.202" class="difflineminus">-TokenHash::~TokenHash()</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineminus">-{</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineplus">+TokenHash::~TokenHash() {}</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineplus">+</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineplus">+nsresult TokenHash::clearTokens() {</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineplus">+  // we re-use the tokenizer when classifying multiple messages,</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineplus">+  // so this gets called after every message classification.</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineplus">+  mTokenTable.ClearAndPrepareForLength(128);</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineplus">+  mWordPool.Clear();</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineplus">+  return NS_OK;</span>
<a href="#l2.212"></a><span id="l2.212"> }</span>
<a href="#l2.213"></a><span id="l2.213"> </span>
<a href="#l2.214"></a><span id="l2.214" class="difflineminus">-nsresult TokenHash::clearTokens()</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineminus">-{</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineminus">-    // we re-use the tokenizer when classifying multiple messages,</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineminus">-    // so this gets called after every message classification.</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineminus">-    mTokenTable.ClearAndPrepareForLength(128);</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineminus">-    mWordPool.Clear();</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineplus">+char* TokenHash::copyWord(const char* word, uint32_t len) {</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineplus">+  return ArenaStrdup(Substring(word, len), mWordPool);</span>
<a href="#l2.223"></a><span id="l2.223"> }</span>
<a href="#l2.224"></a><span id="l2.224"> </span>
<a href="#l2.225"></a><span id="l2.225" class="difflineminus">-char* TokenHash::copyWord(const char* word, uint32_t len)</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineminus">-{</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineminus">-    return ArenaStrdup(Substring(word, len), mWordPool);</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineplus">+inline BaseToken* TokenHash::get(const char* word) {</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineplus">+  PLDHashEntryHdr* entry = mTokenTable.Search(word);</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineplus">+  if (entry) return static_cast&lt;BaseToken*&gt;(entry);</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineplus">+  return NULL;</span>
<a href="#l2.232"></a><span id="l2.232"> }</span>
<a href="#l2.233"></a><span id="l2.233"> </span>
<a href="#l2.234"></a><span id="l2.234" class="difflineminus">-inline BaseToken* TokenHash::get(const char* word)</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineminus">-{</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineminus">-    PLDHashEntryHdr* entry = mTokenTable.Search(word);</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineminus">-    if (entry)</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineminus">-        return static_cast&lt;BaseToken*&gt;(entry);</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineminus">-    return NULL;</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineplus">+BaseToken* TokenHash::add(const char* word) {</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineplus">+  if (!word || !*word) {</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineplus">+    NS_ERROR(&quot;Trying to add a null word&quot;);</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineplus">+    return nullptr;</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineplus">+  }</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineplus">+</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineplus">+  MOZ_LOG(BayesianFilterLogModule, LogLevel::Debug, (&quot;add word: %s&quot;, word));</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineplus">+</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineplus">+  PLDHashEntryHdr* entry = mTokenTable.Add(word, mozilla::fallible);</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineplus">+  BaseToken* token = static_cast&lt;BaseToken*&gt;(entry);</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineplus">+  if (token) {</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineplus">+    if (token-&gt;mWord == NULL) {</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineplus">+      uint32_t len = strlen(word);</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineplus">+      NS_ASSERTION(len != 0, &quot;adding zero length word to tokenizer&quot;);</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineplus">+      if (!len)</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineplus">+        MOZ_LOG(BayesianFilterLogModule, LogLevel::Debug,</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineplus">+                (&quot;adding zero length word to tokenizer&quot;));</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineplus">+      token-&gt;mWord = copyWord(word, len);</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineplus">+      NS_ASSERTION(token-&gt;mWord, &quot;copyWord failed&quot;);</span>
<a href="#l2.259"></a><span id="l2.259" class="difflineplus">+      if (!token-&gt;mWord) {</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineplus">+        MOZ_LOG(BayesianFilterLogModule, LogLevel::Error,</span>
<a href="#l2.261"></a><span id="l2.261" class="difflineplus">+                (&quot;copyWord failed: %s (%d)&quot;, word, len));</span>
<a href="#l2.262"></a><span id="l2.262" class="difflineplus">+        mTokenTable.RawRemove(entry);</span>
<a href="#l2.263"></a><span id="l2.263" class="difflineplus">+        return NULL;</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineplus">+      }</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineplus">+    }</span>
<a href="#l2.266"></a><span id="l2.266" class="difflineplus">+  }</span>
<a href="#l2.267"></a><span id="l2.267" class="difflineplus">+  return token;</span>
<a href="#l2.268"></a><span id="l2.268"> }</span>
<a href="#l2.269"></a><span id="l2.269"> </span>
<a href="#l2.270"></a><span id="l2.270" class="difflineminus">-BaseToken* TokenHash::add(const char* word)</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineminus">-{</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineminus">-    if (!word || !*word)</span>
<a href="#l2.273"></a><span id="l2.273" class="difflineminus">-    {</span>
<a href="#l2.274"></a><span id="l2.274" class="difflineminus">-      NS_ERROR(&quot;Trying to add a null word&quot;);</span>
<a href="#l2.275"></a><span id="l2.275" class="difflineminus">-      return nullptr;</span>
<a href="#l2.276"></a><span id="l2.276" class="difflineminus">-    }</span>
<a href="#l2.277"></a><span id="l2.277" class="difflineminus">-</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineminus">-    MOZ_LOG(BayesianFilterLogModule, LogLevel::Debug, (&quot;add word: %s&quot;, word));</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineplus">+inline uint32_t TokenHash::countTokens() { return mTokenTable.EntryCount(); }</span>
<a href="#l2.280"></a><span id="l2.280"> </span>
<a href="#l2.281"></a><span id="l2.281" class="difflineminus">-    PLDHashEntryHdr* entry = mTokenTable.Add(word, mozilla::fallible);</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineminus">-    BaseToken* token = static_cast&lt;BaseToken*&gt;(entry);</span>
<a href="#l2.283"></a><span id="l2.283" class="difflineminus">-    if (token) {</span>
<a href="#l2.284"></a><span id="l2.284" class="difflineminus">-        if (token-&gt;mWord == NULL) {</span>
<a href="#l2.285"></a><span id="l2.285" class="difflineminus">-            uint32_t len = strlen(word);</span>
<a href="#l2.286"></a><span id="l2.286" class="difflineminus">-            NS_ASSERTION(len != 0, &quot;adding zero length word to tokenizer&quot;);</span>
<a href="#l2.287"></a><span id="l2.287" class="difflineminus">-            if (!len)</span>
<a href="#l2.288"></a><span id="l2.288" class="difflineminus">-              MOZ_LOG(BayesianFilterLogModule, LogLevel::Debug, (&quot;adding zero length word to tokenizer&quot;));</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineminus">-            token-&gt;mWord = copyWord(word, len);</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineminus">-            NS_ASSERTION(token-&gt;mWord, &quot;copyWord failed&quot;);</span>
<a href="#l2.291"></a><span id="l2.291" class="difflineminus">-            if (!token-&gt;mWord) {</span>
<a href="#l2.292"></a><span id="l2.292" class="difflineminus">-                MOZ_LOG(BayesianFilterLogModule, LogLevel::Error, (&quot;copyWord failed: %s (%d)&quot;, word, len));</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineminus">-                mTokenTable.RawRemove(entry);</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineminus">-                return NULL;</span>
<a href="#l2.295"></a><span id="l2.295" class="difflineminus">-            }</span>
<a href="#l2.296"></a><span id="l2.296" class="difflineminus">-        }</span>
<a href="#l2.297"></a><span id="l2.297" class="difflineminus">-    }</span>
<a href="#l2.298"></a><span id="l2.298" class="difflineminus">-    return token;</span>
<a href="#l2.299"></a><span id="l2.299" class="difflineminus">-}</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineminus">-</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineminus">-inline uint32_t TokenHash::countTokens()</span>
<a href="#l2.302"></a><span id="l2.302" class="difflineminus">-{</span>
<a href="#l2.303"></a><span id="l2.303" class="difflineminus">-  return mTokenTable.EntryCount();</span>
<a href="#l2.304"></a><span id="l2.304" class="difflineminus">-}</span>
<a href="#l2.305"></a><span id="l2.305" class="difflineminus">-</span>
<a href="#l2.306"></a><span id="l2.306" class="difflineminus">-inline TokenEnumeration TokenHash::getTokens()</span>
<a href="#l2.307"></a><span id="l2.307" class="difflineminus">-{</span>
<a href="#l2.308"></a><span id="l2.308" class="difflineplus">+inline TokenEnumeration TokenHash::getTokens() {</span>
<a href="#l2.309"></a><span id="l2.309">   return TokenEnumeration(&amp;mTokenTable);</span>
<a href="#l2.310"></a><span id="l2.310"> }</span>
<a href="#l2.311"></a><span id="l2.311"> </span>
<a href="#l2.312"></a><span id="l2.312" class="difflineminus">-Tokenizer::Tokenizer() :</span>
<a href="#l2.313"></a><span id="l2.313" class="difflineminus">-  TokenHash(sizeof(Token)),</span>
<a href="#l2.314"></a><span id="l2.314" class="difflineminus">-  mBodyDelimiters(kBayesianFilterTokenDelimiters),</span>
<a href="#l2.315"></a><span id="l2.315" class="difflineminus">-  mHeaderDelimiters(kBayesianFilterTokenDelimiters),</span>
<a href="#l2.316"></a><span id="l2.316" class="difflineminus">-  mCustomHeaderTokenization(false),</span>
<a href="#l2.317"></a><span id="l2.317" class="difflineminus">-  mMaxLengthForToken(kMaxLengthForToken),</span>
<a href="#l2.318"></a><span id="l2.318" class="difflineminus">-  mIframeToDiv(false)</span>
<a href="#l2.319"></a><span id="l2.319" class="difflineminus">-{</span>
<a href="#l2.320"></a><span id="l2.320" class="difflineplus">+Tokenizer::Tokenizer()</span>
<a href="#l2.321"></a><span id="l2.321" class="difflineplus">+    : TokenHash(sizeof(Token)),</span>
<a href="#l2.322"></a><span id="l2.322" class="difflineplus">+      mBodyDelimiters(kBayesianFilterTokenDelimiters),</span>
<a href="#l2.323"></a><span id="l2.323" class="difflineplus">+      mHeaderDelimiters(kBayesianFilterTokenDelimiters),</span>
<a href="#l2.324"></a><span id="l2.324" class="difflineplus">+      mCustomHeaderTokenization(false),</span>
<a href="#l2.325"></a><span id="l2.325" class="difflineplus">+      mMaxLengthForToken(kMaxLengthForToken),</span>
<a href="#l2.326"></a><span id="l2.326" class="difflineplus">+      mIframeToDiv(false) {</span>
<a href="#l2.327"></a><span id="l2.327">   nsresult rv;</span>
<a href="#l2.328"></a><span id="l2.328" class="difflineminus">-  nsCOMPtr&lt;nsIPrefService&gt; prefs = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l2.329"></a><span id="l2.329" class="difflineplus">+  nsCOMPtr&lt;nsIPrefService&gt; prefs =</span>
<a href="#l2.330"></a><span id="l2.330" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l2.331"></a><span id="l2.331">   NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l2.332"></a><span id="l2.332"> </span>
<a href="#l2.333"></a><span id="l2.333">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch;</span>
<a href="#l2.334"></a><span id="l2.334" class="difflineminus">-  rv = prefs-&gt;GetBranch(&quot;mailnews.bayesian_spam_filter.&quot;, getter_AddRefs(prefBranch));</span>
<a href="#l2.335"></a><span id="l2.335" class="difflineminus">-  NS_ENSURE_SUCCESS_VOID(rv); // no branch defined, just use defaults</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineplus">+  rv = prefs-&gt;GetBranch(&quot;mailnews.bayesian_spam_filter.&quot;,</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineplus">+                        getter_AddRefs(prefBranch));</span>
<a href="#l2.338"></a><span id="l2.338" class="difflineplus">+  NS_ENSURE_SUCCESS_VOID(rv);  // no branch defined, just use defaults</span>
<a href="#l2.339"></a><span id="l2.339"> </span>
<a href="#l2.340"></a><span id="l2.340">   /*</span>
<a href="#l2.341"></a><span id="l2.341">    * RSS feeds store their summary as alternate content of an iframe. But due</span>
<a href="#l2.342"></a><span id="l2.342">    * to bug 365953, this is not seen by the serializer. As a workaround, allow</span>
<a href="#l2.343"></a><span id="l2.343">    * the tokenizer to replace the iframe with div for tokenization.</span>
<a href="#l2.344"></a><span id="l2.344">    */</span>
<a href="#l2.345"></a><span id="l2.345">   rv = prefBranch-&gt;GetBoolPref(&quot;iframe_to_div&quot;, &amp;mIframeToDiv);</span>
<a href="#l2.346"></a><span id="l2.346" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l2.347"></a><span id="l2.347" class="difflineminus">-    mIframeToDiv = false;</span>
<a href="#l2.348"></a><span id="l2.348" class="difflineplus">+  if (NS_FAILED(rv)) mIframeToDiv = false;</span>
<a href="#l2.349"></a><span id="l2.349"> </span>
<a href="#l2.350"></a><span id="l2.350">   /*</span>
<a href="#l2.351"></a><span id="l2.351">    * the list of delimiters used to tokenize the message and body</span>
<a href="#l2.352"></a><span id="l2.352">    * defaults to the value in kBayesianFilterTokenDelimiters, but may be</span>
<a href="#l2.353"></a><span id="l2.353">    * set with the following preferences for the body and header</span>
<a href="#l2.354"></a><span id="l2.354">    * separately.</span>
<a href="#l2.355"></a><span id="l2.355">    *</span>
<a href="#l2.356"></a><span id="l2.356">    * \t, \n, \v, \f, \r, and \\ will be escaped to their normal</span>
<a href="#l2.357"></a><span id="l2.357">    * C-library values, all other two-letter combinations beginning with \</span>
<a href="#l2.358"></a><span id="l2.358">    * will be ignored.</span>
<a href="#l2.359"></a><span id="l2.359">    */</span>
<a href="#l2.360"></a><span id="l2.360"> </span>
<a href="#l2.361"></a><span id="l2.361">   prefBranch-&gt;GetCharPref(&quot;body_delimiters&quot;, mBodyDelimiters);</span>
<a href="#l2.362"></a><span id="l2.362">   if (!mBodyDelimiters.IsEmpty())</span>
<a href="#l2.363"></a><span id="l2.363">     UnescapeCString(mBodyDelimiters);</span>
<a href="#l2.364"></a><span id="l2.364" class="difflineminus">-  else // prefBranch empties the result when it fails :(</span>
<a href="#l2.365"></a><span id="l2.365" class="difflineplus">+  else  // prefBranch empties the result when it fails :(</span>
<a href="#l2.366"></a><span id="l2.366">     mBodyDelimiters.Assign(kBayesianFilterTokenDelimiters);</span>
<a href="#l2.367"></a><span id="l2.367"> </span>
<a href="#l2.368"></a><span id="l2.368">   prefBranch-&gt;GetCharPref(&quot;header_delimiters&quot;, mHeaderDelimiters);</span>
<a href="#l2.369"></a><span id="l2.369">   if (!mHeaderDelimiters.IsEmpty())</span>
<a href="#l2.370"></a><span id="l2.370">     UnescapeCString(mHeaderDelimiters);</span>
<a href="#l2.371"></a><span id="l2.371">   else</span>
<a href="#l2.372"></a><span id="l2.372">     mHeaderDelimiters.Assign(kBayesianFilterTokenDelimiters);</span>
<a href="#l2.373"></a><span id="l2.373"> </span>
<a href="#l2.374"></a><span id="l2.374" class="difflineat">@@ -301,578 +278,550 @@ Tokenizer::Tokenizer() :</span>
<a href="#l2.375"></a><span id="l2.375">    */</span>
<a href="#l2.376"></a><span id="l2.376"> </span>
<a href="#l2.377"></a><span id="l2.377">   char** headers;</span>
<a href="#l2.378"></a><span id="l2.378">   uint32_t count;</span>
<a href="#l2.379"></a><span id="l2.379"> </span>
<a href="#l2.380"></a><span id="l2.380">   // get customized maximum token length</span>
<a href="#l2.381"></a><span id="l2.381">   int32_t maxLengthForToken;</span>
<a href="#l2.382"></a><span id="l2.382">   rv = prefBranch-&gt;GetIntPref(&quot;maxlengthfortoken&quot;, &amp;maxLengthForToken);</span>
<a href="#l2.383"></a><span id="l2.383" class="difflineminus">-  mMaxLengthForToken = NS_SUCCEEDED(rv) ? uint32_t(maxLengthForToken) : kMaxLengthForToken;</span>
<a href="#l2.384"></a><span id="l2.384" class="difflineminus">-</span>
<a href="#l2.385"></a><span id="l2.385" class="difflineminus">-  rv = prefs-&gt;GetBranch(&quot;mailnews.bayesian_spam_filter.tokenizeheader.&quot;, getter_AddRefs(prefBranch));</span>
<a href="#l2.386"></a><span id="l2.386" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l2.387"></a><span id="l2.387" class="difflineminus">-    rv = prefBranch-&gt;GetChildList(&quot;&quot;, &amp;count, &amp;headers);</span>
<a href="#l2.388"></a><span id="l2.388" class="difflineplus">+  mMaxLengthForToken =</span>
<a href="#l2.389"></a><span id="l2.389" class="difflineplus">+      NS_SUCCEEDED(rv) ? uint32_t(maxLengthForToken) : kMaxLengthForToken;</span>
<a href="#l2.390"></a><span id="l2.390"> </span>
<a href="#l2.391"></a><span id="l2.391" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l2.392"></a><span id="l2.392" class="difflineminus">-  {</span>
<a href="#l2.393"></a><span id="l2.393" class="difflineplus">+  rv = prefs-&gt;GetBranch(&quot;mailnews.bayesian_spam_filter.tokenizeheader.&quot;,</span>
<a href="#l2.394"></a><span id="l2.394" class="difflineplus">+                        getter_AddRefs(prefBranch));</span>
<a href="#l2.395"></a><span id="l2.395" class="difflineplus">+  if (NS_SUCCEEDED(rv)) rv = prefBranch-&gt;GetChildList(&quot;&quot;, &amp;count, &amp;headers);</span>
<a href="#l2.396"></a><span id="l2.396" class="difflineplus">+</span>
<a href="#l2.397"></a><span id="l2.397" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l2.398"></a><span id="l2.398">     mCustomHeaderTokenization = true;</span>
<a href="#l2.399"></a><span id="l2.399" class="difflineminus">-    for (uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l2.400"></a><span id="l2.400" class="difflineminus">-    {</span>
<a href="#l2.401"></a><span id="l2.401" class="difflineplus">+    for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l2.402"></a><span id="l2.402">       nsCString value;</span>
<a href="#l2.403"></a><span id="l2.403">       prefBranch-&gt;GetCharPref(headers[i], value);</span>
<a href="#l2.404"></a><span id="l2.404" class="difflineminus">-      if (value.EqualsLiteral(&quot;false&quot;))</span>
<a href="#l2.405"></a><span id="l2.405" class="difflineminus">-      {</span>
<a href="#l2.406"></a><span id="l2.406" class="difflineplus">+      if (value.EqualsLiteral(&quot;false&quot;)) {</span>
<a href="#l2.407"></a><span id="l2.407">         mDisabledHeaders.AppendElement(headers[i]);</span>
<a href="#l2.408"></a><span id="l2.408">         continue;</span>
<a href="#l2.409"></a><span id="l2.409">       }</span>
<a href="#l2.410"></a><span id="l2.410">       mEnabledHeaders.AppendElement(headers[i]);</span>
<a href="#l2.411"></a><span id="l2.411">       if (value.EqualsLiteral(&quot;standard&quot;))</span>
<a href="#l2.412"></a><span id="l2.412" class="difflineminus">-        value.SetIsVoid(true); // Void means use default delimiter</span>
<a href="#l2.413"></a><span id="l2.413" class="difflineplus">+        value.SetIsVoid(true);  // Void means use default delimiter</span>
<a href="#l2.414"></a><span id="l2.414">       else if (value.EqualsLiteral(&quot;full&quot;))</span>
<a href="#l2.415"></a><span id="l2.415" class="difflineminus">-        value.Truncate(); // Empty means add full header</span>
<a href="#l2.416"></a><span id="l2.416" class="difflineplus">+        value.Truncate();  // Empty means add full header</span>
<a href="#l2.417"></a><span id="l2.417">       else</span>
<a href="#l2.418"></a><span id="l2.418">         UnescapeCString(value);</span>
<a href="#l2.419"></a><span id="l2.419">       mEnabledHeadersDelimiters.AppendElement(value);</span>
<a href="#l2.420"></a><span id="l2.420">     }</span>
<a href="#l2.421"></a><span id="l2.421">     NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(count, headers);</span>
<a href="#l2.422"></a><span id="l2.422">   }</span>
<a href="#l2.423"></a><span id="l2.423"> }</span>
<a href="#l2.424"></a><span id="l2.424"> </span>
<a href="#l2.425"></a><span id="l2.425" class="difflineminus">-Tokenizer::~Tokenizer()</span>
<a href="#l2.426"></a><span id="l2.426" class="difflineminus">-{</span>
<a href="#l2.427"></a><span id="l2.427" class="difflineminus">-}</span>
<a href="#l2.428"></a><span id="l2.428" class="difflineplus">+Tokenizer::~Tokenizer() {}</span>
<a href="#l2.429"></a><span id="l2.429"> </span>
<a href="#l2.430"></a><span id="l2.430" class="difflineminus">-inline Token* Tokenizer::get(const char* word)</span>
<a href="#l2.431"></a><span id="l2.431" class="difflineminus">-{</span>
<a href="#l2.432"></a><span id="l2.432" class="difflineplus">+inline Token* Tokenizer::get(const char* word) {</span>
<a href="#l2.433"></a><span id="l2.433">   return static_cast&lt;Token*&gt;(TokenHash::get(word));</span>
<a href="#l2.434"></a><span id="l2.434"> }</span>
<a href="#l2.435"></a><span id="l2.435"> </span>
<a href="#l2.436"></a><span id="l2.436" class="difflineminus">-Token* Tokenizer::add(const char* word, uint32_t count)</span>
<a href="#l2.437"></a><span id="l2.437" class="difflineminus">-{</span>
<a href="#l2.438"></a><span id="l2.438" class="difflineminus">-  MOZ_LOG(BayesianFilterLogModule, LogLevel::Debug, (&quot;add word: %s (count=%d)&quot;,</span>
<a href="#l2.439"></a><span id="l2.439" class="difflineminus">-         word, count));</span>
<a href="#l2.440"></a><span id="l2.440" class="difflineplus">+Token* Tokenizer::add(const char* word, uint32_t count) {</span>
<a href="#l2.441"></a><span id="l2.441" class="difflineplus">+  MOZ_LOG(BayesianFilterLogModule, LogLevel::Debug,</span>
<a href="#l2.442"></a><span id="l2.442" class="difflineplus">+          (&quot;add word: %s (count=%d)&quot;, word, count));</span>
<a href="#l2.443"></a><span id="l2.443"> </span>
<a href="#l2.444"></a><span id="l2.444">   Token* token = static_cast&lt;Token*&gt;(TokenHash::add(word));</span>
<a href="#l2.445"></a><span id="l2.445" class="difflineminus">-  if (token)</span>
<a href="#l2.446"></a><span id="l2.446" class="difflineminus">-  {</span>
<a href="#l2.447"></a><span id="l2.447" class="difflineminus">-    token-&gt;mCount += count; // hash code initializes this to zero</span>
<a href="#l2.448"></a><span id="l2.448" class="difflineplus">+  if (token) {</span>
<a href="#l2.449"></a><span id="l2.449" class="difflineplus">+    token-&gt;mCount += count;  // hash code initializes this to zero</span>
<a href="#l2.450"></a><span id="l2.450">     MOZ_LOG(BayesianFilterLogModule, LogLevel::Debug,</span>
<a href="#l2.451"></a><span id="l2.451" class="difflineminus">-           (&quot;adding word to tokenizer: %s (count=%d) (mCount=%d)&quot;,</span>
<a href="#l2.452"></a><span id="l2.452" class="difflineminus">-           word, count, token-&gt;mCount));</span>
<a href="#l2.453"></a><span id="l2.453" class="difflineplus">+            (&quot;adding word to tokenizer: %s (count=%d) (mCount=%d)&quot;, word, count,</span>
<a href="#l2.454"></a><span id="l2.454" class="difflineplus">+             token-&gt;mCount));</span>
<a href="#l2.455"></a><span id="l2.455">   }</span>
<a href="#l2.456"></a><span id="l2.456">   return token;</span>
<a href="#l2.457"></a><span id="l2.457"> }</span>
<a href="#l2.458"></a><span id="l2.458"> </span>
<a href="#l2.459"></a><span id="l2.459" class="difflineminus">-static bool isDecimalNumber(const char* word)</span>
<a href="#l2.460"></a><span id="l2.460" class="difflineminus">-{</span>
<a href="#l2.461"></a><span id="l2.461" class="difflineminus">-    const char* p = word;</span>
<a href="#l2.462"></a><span id="l2.462" class="difflineminus">-    if (*p == '-') ++p;</span>
<a href="#l2.463"></a><span id="l2.463" class="difflineminus">-    char c;</span>
<a href="#l2.464"></a><span id="l2.464" class="difflineminus">-    while ((c = *p++)) {</span>
<a href="#l2.465"></a><span id="l2.465" class="difflineminus">-        if (!isdigit((unsigned char) c))</span>
<a href="#l2.466"></a><span id="l2.466" class="difflineminus">-            return false;</span>
<a href="#l2.467"></a><span id="l2.467" class="difflineminus">-    }</span>
<a href="#l2.468"></a><span id="l2.468" class="difflineminus">-    return true;</span>
<a href="#l2.469"></a><span id="l2.469" class="difflineplus">+static bool isDecimalNumber(const char* word) {</span>
<a href="#l2.470"></a><span id="l2.470" class="difflineplus">+  const char* p = word;</span>
<a href="#l2.471"></a><span id="l2.471" class="difflineplus">+  if (*p == '-') ++p;</span>
<a href="#l2.472"></a><span id="l2.472" class="difflineplus">+  char c;</span>
<a href="#l2.473"></a><span id="l2.473" class="difflineplus">+  while ((c = *p++)) {</span>
<a href="#l2.474"></a><span id="l2.474" class="difflineplus">+    if (!isdigit((unsigned char)c)) return false;</span>
<a href="#l2.475"></a><span id="l2.475" class="difflineplus">+  }</span>
<a href="#l2.476"></a><span id="l2.476" class="difflineplus">+  return true;</span>
<a href="#l2.477"></a><span id="l2.477"> }</span>
<a href="#l2.478"></a><span id="l2.478"> </span>
<a href="#l2.479"></a><span id="l2.479" class="difflineminus">-static bool isASCII(const char* word)</span>
<a href="#l2.480"></a><span id="l2.480" class="difflineminus">-{</span>
<a href="#l2.481"></a><span id="l2.481" class="difflineminus">-    const unsigned char* p = (const unsigned char*)word;</span>
<a href="#l2.482"></a><span id="l2.482" class="difflineminus">-    unsigned char c;</span>
<a href="#l2.483"></a><span id="l2.483" class="difflineminus">-    while ((c = *p++)) {</span>
<a href="#l2.484"></a><span id="l2.484" class="difflineminus">-        if (c &gt; 127)</span>
<a href="#l2.485"></a><span id="l2.485" class="difflineminus">-            return false;</span>
<a href="#l2.486"></a><span id="l2.486" class="difflineminus">-    }</span>
<a href="#l2.487"></a><span id="l2.487" class="difflineminus">-    return true;</span>
<a href="#l2.488"></a><span id="l2.488" class="difflineplus">+static bool isASCII(const char* word) {</span>
<a href="#l2.489"></a><span id="l2.489" class="difflineplus">+  const unsigned char* p = (const unsigned char*)word;</span>
<a href="#l2.490"></a><span id="l2.490" class="difflineplus">+  unsigned char c;</span>
<a href="#l2.491"></a><span id="l2.491" class="difflineplus">+  while ((c = *p++)) {</span>
<a href="#l2.492"></a><span id="l2.492" class="difflineplus">+    if (c &gt; 127) return false;</span>
<a href="#l2.493"></a><span id="l2.493" class="difflineplus">+  }</span>
<a href="#l2.494"></a><span id="l2.494" class="difflineplus">+  return true;</span>
<a href="#l2.495"></a><span id="l2.495"> }</span>
<a href="#l2.496"></a><span id="l2.496"> </span>
<a href="#l2.497"></a><span id="l2.497"> inline bool isUpperCase(char c) { return ('A' &lt;= c) &amp;&amp; (c &lt;= 'Z'); }</span>
<a href="#l2.498"></a><span id="l2.498"> </span>
<a href="#l2.499"></a><span id="l2.499" class="difflineminus">-static char* toLowerCase(char* str)</span>
<a href="#l2.500"></a><span id="l2.500" class="difflineminus">-{</span>
<a href="#l2.501"></a><span id="l2.501" class="difflineminus">-    char c, *p = str;</span>
<a href="#l2.502"></a><span id="l2.502" class="difflineminus">-    while ((c = *p++)) {</span>
<a href="#l2.503"></a><span id="l2.503" class="difflineminus">-        if (isUpperCase(c))</span>
<a href="#l2.504"></a><span id="l2.504" class="difflineminus">-            p[-1] = c + ('a' - 'A');</span>
<a href="#l2.505"></a><span id="l2.505" class="difflineminus">-    }</span>
<a href="#l2.506"></a><span id="l2.506" class="difflineminus">-    return str;</span>
<a href="#l2.507"></a><span id="l2.507" class="difflineplus">+static char* toLowerCase(char* str) {</span>
<a href="#l2.508"></a><span id="l2.508" class="difflineplus">+  char c, *p = str;</span>
<a href="#l2.509"></a><span id="l2.509" class="difflineplus">+  while ((c = *p++)) {</span>
<a href="#l2.510"></a><span id="l2.510" class="difflineplus">+    if (isUpperCase(c)) p[-1] = c + ('a' - 'A');</span>
<a href="#l2.511"></a><span id="l2.511" class="difflineplus">+  }</span>
<a href="#l2.512"></a><span id="l2.512" class="difflineplus">+  return str;</span>
<a href="#l2.513"></a><span id="l2.513"> }</span>
<a href="#l2.514"></a><span id="l2.514"> </span>
<a href="#l2.515"></a><span id="l2.515" class="difflineminus">-void Tokenizer::addTokenForHeader(const char * aTokenPrefix, nsACString&amp; aValue,</span>
<a href="#l2.516"></a><span id="l2.516" class="difflineminus">-                                  bool aTokenizeValue, const char* aDelimiters)</span>
<a href="#l2.517"></a><span id="l2.517" class="difflineminus">-{</span>
<a href="#l2.518"></a><span id="l2.518" class="difflineminus">-  if (aValue.Length())</span>
<a href="#l2.519"></a><span id="l2.519" class="difflineminus">-  {</span>
<a href="#l2.520"></a><span id="l2.520" class="difflineplus">+void Tokenizer::addTokenForHeader(const char* aTokenPrefix, nsACString&amp; aValue,</span>
<a href="#l2.521"></a><span id="l2.521" class="difflineplus">+                                  bool aTokenizeValue,</span>
<a href="#l2.522"></a><span id="l2.522" class="difflineplus">+                                  const char* aDelimiters) {</span>
<a href="#l2.523"></a><span id="l2.523" class="difflineplus">+  if (aValue.Length()) {</span>
<a href="#l2.524"></a><span id="l2.524">     ToLowerCase(aValue);</span>
<a href="#l2.525"></a><span id="l2.525" class="difflineminus">-    if (!aTokenizeValue)</span>
<a href="#l2.526"></a><span id="l2.526" class="difflineminus">-    {</span>
<a href="#l2.527"></a><span id="l2.527" class="difflineplus">+    if (!aTokenizeValue) {</span>
<a href="#l2.528"></a><span id="l2.528">       nsCString tmpStr;</span>
<a href="#l2.529"></a><span id="l2.529">       tmpStr.Assign(aTokenPrefix);</span>
<a href="#l2.530"></a><span id="l2.530">       tmpStr.Append(':');</span>
<a href="#l2.531"></a><span id="l2.531">       tmpStr.Append(aValue);</span>
<a href="#l2.532"></a><span id="l2.532"> </span>
<a href="#l2.533"></a><span id="l2.533">       add(tmpStr.get());</span>
<a href="#l2.534"></a><span id="l2.534" class="difflineminus">-    }</span>
<a href="#l2.535"></a><span id="l2.535" class="difflineminus">-    else</span>
<a href="#l2.536"></a><span id="l2.536" class="difflineminus">-    {</span>
<a href="#l2.537"></a><span id="l2.537" class="difflineplus">+    } else {</span>
<a href="#l2.538"></a><span id="l2.538">       char* word;</span>
<a href="#l2.539"></a><span id="l2.539">       nsCString str(aValue);</span>
<a href="#l2.540"></a><span id="l2.540" class="difflineminus">-      char *next = str.BeginWriting();</span>
<a href="#l2.541"></a><span id="l2.541" class="difflineminus">-      const char* delimiters = !aDelimiters ?</span>
<a href="#l2.542"></a><span id="l2.542" class="difflineminus">-          mHeaderDelimiters.get() : aDelimiters;</span>
<a href="#l2.543"></a><span id="l2.543" class="difflineminus">-      while ((word = NS_strtok(delimiters, &amp;next)) != NULL)</span>
<a href="#l2.544"></a><span id="l2.544" class="difflineminus">-      {</span>
<a href="#l2.545"></a><span id="l2.545" class="difflineminus">-        if (strlen(word) &lt; kMinLengthForToken)</span>
<a href="#l2.546"></a><span id="l2.546" class="difflineminus">-          continue;</span>
<a href="#l2.547"></a><span id="l2.547" class="difflineminus">-        if (isDecimalNumber(word))</span>
<a href="#l2.548"></a><span id="l2.548" class="difflineminus">-          continue;</span>
<a href="#l2.549"></a><span id="l2.549" class="difflineminus">-        if (isASCII(word))</span>
<a href="#l2.550"></a><span id="l2.550" class="difflineminus">-        {</span>
<a href="#l2.551"></a><span id="l2.551" class="difflineplus">+      char* next = str.BeginWriting();</span>
<a href="#l2.552"></a><span id="l2.552" class="difflineplus">+      const char* delimiters =</span>
<a href="#l2.553"></a><span id="l2.553" class="difflineplus">+          !aDelimiters ? mHeaderDelimiters.get() : aDelimiters;</span>
<a href="#l2.554"></a><span id="l2.554" class="difflineplus">+      while ((word = NS_strtok(delimiters, &amp;next)) != NULL) {</span>
<a href="#l2.555"></a><span id="l2.555" class="difflineplus">+        if (strlen(word) &lt; kMinLengthForToken) continue;</span>
<a href="#l2.556"></a><span id="l2.556" class="difflineplus">+        if (isDecimalNumber(word)) continue;</span>
<a href="#l2.557"></a><span id="l2.557" class="difflineplus">+        if (isASCII(word)) {</span>
<a href="#l2.558"></a><span id="l2.558">           nsCString tmpStr;</span>
<a href="#l2.559"></a><span id="l2.559">           tmpStr.Assign(aTokenPrefix);</span>
<a href="#l2.560"></a><span id="l2.560">           tmpStr.Append(':');</span>
<a href="#l2.561"></a><span id="l2.561">           tmpStr.Append(word);</span>
<a href="#l2.562"></a><span id="l2.562">           add(tmpStr.get());</span>
<a href="#l2.563"></a><span id="l2.563">         }</span>
<a href="#l2.564"></a><span id="l2.564">       }</span>
<a href="#l2.565"></a><span id="l2.565">     }</span>
<a href="#l2.566"></a><span id="l2.566">   }</span>
<a href="#l2.567"></a><span id="l2.567"> }</span>
<a href="#l2.568"></a><span id="l2.568"> </span>
<a href="#l2.569"></a><span id="l2.569" class="difflineminus">-void Tokenizer::tokenizeAttachment(const char * aContentType, const char * aFileName)</span>
<a href="#l2.570"></a><span id="l2.570" class="difflineminus">-{</span>
<a href="#l2.571"></a><span id="l2.571" class="difflineplus">+void Tokenizer::tokenizeAttachment(const char* aContentType,</span>
<a href="#l2.572"></a><span id="l2.572" class="difflineplus">+                                   const char* aFileName) {</span>
<a href="#l2.573"></a><span id="l2.573">   nsAutoCString contentType;</span>
<a href="#l2.574"></a><span id="l2.574">   nsAutoCString fileName;</span>
<a href="#l2.575"></a><span id="l2.575">   fileName.Assign(aFileName);</span>
<a href="#l2.576"></a><span id="l2.576">   contentType.Assign(aContentType);</span>
<a href="#l2.577"></a><span id="l2.577"> </span>
<a href="#l2.578"></a><span id="l2.578">   // normalize the content type and the file name</span>
<a href="#l2.579"></a><span id="l2.579">   ToLowerCase(fileName);</span>
<a href="#l2.580"></a><span id="l2.580">   ToLowerCase(contentType);</span>
<a href="#l2.581"></a><span id="l2.581">   addTokenForHeader(&quot;attachment/filename&quot;, fileName);</span>
<a href="#l2.582"></a><span id="l2.582"> </span>
<a href="#l2.583"></a><span id="l2.583">   addTokenForHeader(&quot;attachment/content-type&quot;, contentType);</span>
<a href="#l2.584"></a><span id="l2.584"> }</span>
<a href="#l2.585"></a><span id="l2.585"> </span>
<a href="#l2.586"></a><span id="l2.586" class="difflineminus">-void Tokenizer::tokenizeHeaders(nsIUTF8StringEnumerator * aHeaderNames, nsIUTF8StringEnumerator * aHeaderValues)</span>
<a href="#l2.587"></a><span id="l2.587" class="difflineminus">-{</span>
<a href="#l2.588"></a><span id="l2.588" class="difflineplus">+void Tokenizer::tokenizeHeaders(nsIUTF8StringEnumerator* aHeaderNames,</span>
<a href="#l2.589"></a><span id="l2.589" class="difflineplus">+                                nsIUTF8StringEnumerator* aHeaderValues) {</span>
<a href="#l2.590"></a><span id="l2.590">   nsCString headerValue;</span>
<a href="#l2.591"></a><span id="l2.591" class="difflineminus">-  nsAutoCString headerName; // we'll be normalizing all header names to lower case</span>
<a href="#l2.592"></a><span id="l2.592" class="difflineplus">+  nsAutoCString</span>
<a href="#l2.593"></a><span id="l2.593" class="difflineplus">+      headerName;  // we'll be normalizing all header names to lower case</span>
<a href="#l2.594"></a><span id="l2.594">   bool hasMore;</span>
<a href="#l2.595"></a><span id="l2.595"> </span>
<a href="#l2.596"></a><span id="l2.596" class="difflineminus">-  while (NS_SUCCEEDED(aHeaderNames-&gt;HasMore(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l2.597"></a><span id="l2.597" class="difflineminus">-  {</span>
<a href="#l2.598"></a><span id="l2.598" class="difflineplus">+  while (NS_SUCCEEDED(aHeaderNames-&gt;HasMore(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l2.599"></a><span id="l2.599">     aHeaderNames-&gt;GetNext(headerName);</span>
<a href="#l2.600"></a><span id="l2.600">     ToLowerCase(headerName);</span>
<a href="#l2.601"></a><span id="l2.601">     aHeaderValues-&gt;GetNext(headerValue);</span>
<a href="#l2.602"></a><span id="l2.602"> </span>
<a href="#l2.603"></a><span id="l2.603">     bool headerProcessed = false;</span>
<a href="#l2.604"></a><span id="l2.604" class="difflineminus">-    if (mCustomHeaderTokenization)</span>
<a href="#l2.605"></a><span id="l2.605" class="difflineminus">-    {</span>
<a href="#l2.606"></a><span id="l2.606" class="difflineplus">+    if (mCustomHeaderTokenization) {</span>
<a href="#l2.607"></a><span id="l2.607">       // Process any exceptions set from preferences</span>
<a href="#l2.608"></a><span id="l2.608">       for (uint32_t i = 0; i &lt; mEnabledHeaders.Length(); i++)</span>
<a href="#l2.609"></a><span id="l2.609" class="difflineminus">-        if (headerName.Equals(mEnabledHeaders[i]))</span>
<a href="#l2.610"></a><span id="l2.610" class="difflineminus">-        {</span>
<a href="#l2.611"></a><span id="l2.611" class="difflineplus">+        if (headerName.Equals(mEnabledHeaders[i])) {</span>
<a href="#l2.612"></a><span id="l2.612">           if (mEnabledHeadersDelimiters[i].IsVoid())</span>
<a href="#l2.613"></a><span id="l2.613">             // tokenize with standard delimiters for all headers</span>
<a href="#l2.614"></a><span id="l2.614">             addTokenForHeader(headerName.get(), headerValue, true);</span>
<a href="#l2.615"></a><span id="l2.615">           else if (mEnabledHeadersDelimiters[i].IsEmpty())</span>
<a href="#l2.616"></a><span id="l2.616">             // do not break the header into tokens</span>
<a href="#l2.617"></a><span id="l2.617">             addTokenForHeader(headerName.get(), headerValue);</span>
<a href="#l2.618"></a><span id="l2.618">           else</span>
<a href="#l2.619"></a><span id="l2.619">             // use the delimiter in mEnabledHeadersDelimiters</span>
<a href="#l2.620"></a><span id="l2.620">             addTokenForHeader(headerName.get(), headerValue, true,</span>
<a href="#l2.621"></a><span id="l2.621">                               mEnabledHeadersDelimiters[i].get());</span>
<a href="#l2.622"></a><span id="l2.622">           headerProcessed = true;</span>
<a href="#l2.623"></a><span id="l2.623" class="difflineminus">-          break; // we found the header, no need to look for more custom values</span>
<a href="#l2.624"></a><span id="l2.624" class="difflineplus">+          break;  // we found the header, no need to look for more custom values</span>
<a href="#l2.625"></a><span id="l2.625">         }</span>
<a href="#l2.626"></a><span id="l2.626"> </span>
<a href="#l2.627"></a><span id="l2.627" class="difflineminus">-      for (uint32_t i = 0; i &lt; mDisabledHeaders.Length(); i++)</span>
<a href="#l2.628"></a><span id="l2.628" class="difflineminus">-      {</span>
<a href="#l2.629"></a><span id="l2.629" class="difflineminus">-        if (headerName.Equals(mDisabledHeaders[i]))</span>
<a href="#l2.630"></a><span id="l2.630" class="difflineminus">-        {</span>
<a href="#l2.631"></a><span id="l2.631" class="difflineplus">+      for (uint32_t i = 0; i &lt; mDisabledHeaders.Length(); i++) {</span>
<a href="#l2.632"></a><span id="l2.632" class="difflineplus">+        if (headerName.Equals(mDisabledHeaders[i])) {</span>
<a href="#l2.633"></a><span id="l2.633">           headerProcessed = true;</span>
<a href="#l2.634"></a><span id="l2.634">           break;</span>
<a href="#l2.635"></a><span id="l2.635">         }</span>
<a href="#l2.636"></a><span id="l2.636">       }</span>
<a href="#l2.637"></a><span id="l2.637"> </span>
<a href="#l2.638"></a><span id="l2.638" class="difflineminus">-      if (headerProcessed)</span>
<a href="#l2.639"></a><span id="l2.639" class="difflineminus">-        continue;</span>
<a href="#l2.640"></a><span id="l2.640" class="difflineplus">+      if (headerProcessed) continue;</span>
<a href="#l2.641"></a><span id="l2.641">     }</span>
<a href="#l2.642"></a><span id="l2.642"> </span>
<a href="#l2.643"></a><span id="l2.643" class="difflineminus">-    switch (headerName.First())</span>
<a href="#l2.644"></a><span id="l2.644" class="difflineminus">-    {</span>
<a href="#l2.645"></a><span id="l2.645" class="difflineminus">-    case 'c':</span>
<a href="#l2.646"></a><span id="l2.646" class="difflineminus">-        if (headerName.EqualsLiteral(&quot;content-type&quot;))</span>
<a href="#l2.647"></a><span id="l2.647" class="difflineminus">-        {</span>
<a href="#l2.648"></a><span id="l2.648" class="difflineplus">+    switch (headerName.First()) {</span>
<a href="#l2.649"></a><span id="l2.649" class="difflineplus">+      case 'c':</span>
<a href="#l2.650"></a><span id="l2.650" class="difflineplus">+        if (headerName.EqualsLiteral(&quot;content-type&quot;)) {</span>
<a href="#l2.651"></a><span id="l2.651">           nsresult rv;</span>
<a href="#l2.652"></a><span id="l2.652" class="difflineminus">-          nsCOMPtr&lt;nsIMIMEHeaderParam&gt; mimehdrpar = do_GetService(NS_MIMEHEADERPARAM_CONTRACTID, &amp;rv);</span>
<a href="#l2.653"></a><span id="l2.653" class="difflineminus">-          if (NS_FAILED(rv))</span>
<a href="#l2.654"></a><span id="l2.654" class="difflineminus">-            break;</span>
<a href="#l2.655"></a><span id="l2.655" class="difflineplus">+          nsCOMPtr&lt;nsIMIMEHeaderParam&gt; mimehdrpar =</span>
<a href="#l2.656"></a><span id="l2.656" class="difflineplus">+              do_GetService(NS_MIMEHEADERPARAM_CONTRACTID, &amp;rv);</span>
<a href="#l2.657"></a><span id="l2.657" class="difflineplus">+          if (NS_FAILED(rv)) break;</span>
<a href="#l2.658"></a><span id="l2.658"> </span>
<a href="#l2.659"></a><span id="l2.659">           // extract the charset parameter</span>
<a href="#l2.660"></a><span id="l2.660">           nsCString parameterValue;</span>
<a href="#l2.661"></a><span id="l2.661" class="difflineminus">-          mimehdrpar-&gt;GetParameterInternal(headerValue.get(), &quot;charset&quot;, nullptr, nullptr, getter_Copies(parameterValue));</span>
<a href="#l2.662"></a><span id="l2.662" class="difflineplus">+          mimehdrpar-&gt;GetParameterInternal(headerValue.get(), &quot;charset&quot;,</span>
<a href="#l2.663"></a><span id="l2.663" class="difflineplus">+                                           nullptr, nullptr,</span>
<a href="#l2.664"></a><span id="l2.664" class="difflineplus">+                                           getter_Copies(parameterValue));</span>
<a href="#l2.665"></a><span id="l2.665">           addTokenForHeader(&quot;charset&quot;, parameterValue);</span>
<a href="#l2.666"></a><span id="l2.666"> </span>
<a href="#l2.667"></a><span id="l2.667">           // create a token containing just the content type</span>
<a href="#l2.668"></a><span id="l2.668" class="difflineminus">-          mimehdrpar-&gt;GetParameterInternal(headerValue.get(), &quot;type&quot;, nullptr, nullptr, getter_Copies(parameterValue));</span>
<a href="#l2.669"></a><span id="l2.669" class="difflineplus">+          mimehdrpar-&gt;GetParameterInternal(headerValue.get(), &quot;type&quot;, nullptr,</span>
<a href="#l2.670"></a><span id="l2.670" class="difflineplus">+                                           nullptr,</span>
<a href="#l2.671"></a><span id="l2.671" class="difflineplus">+                                           getter_Copies(parameterValue));</span>
<a href="#l2.672"></a><span id="l2.672">           if (!parameterValue.Length())</span>
<a href="#l2.673"></a><span id="l2.673" class="difflineminus">-            mimehdrpar-&gt;GetParameterInternal(headerValue.get(), nullptr /* use first unnamed param */, nullptr, nullptr, getter_Copies(parameterValue));</span>
<a href="#l2.674"></a><span id="l2.674" class="difflineplus">+            mimehdrpar-&gt;GetParameterInternal(</span>
<a href="#l2.675"></a><span id="l2.675" class="difflineplus">+                headerValue.get(), nullptr /* use first unnamed param */,</span>
<a href="#l2.676"></a><span id="l2.676" class="difflineplus">+                nullptr, nullptr, getter_Copies(parameterValue));</span>
<a href="#l2.677"></a><span id="l2.677">           addTokenForHeader(&quot;content-type/type&quot;, parameterValue);</span>
<a href="#l2.678"></a><span id="l2.678"> </span>
<a href="#l2.679"></a><span id="l2.679" class="difflineminus">-          // XXX: should we add a token for the entire content-type header as well or just these parts we have extracted?</span>
<a href="#l2.680"></a><span id="l2.680" class="difflineplus">+          // XXX: should we add a token for the entire content-type header as</span>
<a href="#l2.681"></a><span id="l2.681" class="difflineplus">+          // well or just these parts we have extracted?</span>
<a href="#l2.682"></a><span id="l2.682">         }</span>
<a href="#l2.683"></a><span id="l2.683">         break;</span>
<a href="#l2.684"></a><span id="l2.684" class="difflineminus">-    case 'r':</span>
<a href="#l2.685"></a><span id="l2.685" class="difflineminus">-      if (headerName.EqualsLiteral(&quot;received&quot;))</span>
<a href="#l2.686"></a><span id="l2.686" class="difflineminus">-      {</span>
<a href="#l2.687"></a><span id="l2.687" class="difflineminus">-        // look for the string &quot;may be forged&quot; in the received headers. sendmail sometimes adds this hint</span>
<a href="#l2.688"></a><span id="l2.688" class="difflineminus">-        // This does not compile on linux yet. Need to figure out why. Commenting out for now</span>
<a href="#l2.689"></a><span id="l2.689" class="difflineminus">-        // if (FindInReadable(FORGED_RECEIVED_HEADER_HINT, headerValue))</span>
<a href="#l2.690"></a><span id="l2.690" class="difflineminus">-        //   addTokenForHeader(headerName.get(), FORGED_RECEIVED_HEADER_HINT);</span>
<a href="#l2.691"></a><span id="l2.691" class="difflineminus">-      }</span>
<a href="#l2.692"></a><span id="l2.692" class="difflineplus">+      case 'r':</span>
<a href="#l2.693"></a><span id="l2.693" class="difflineplus">+        if (headerName.EqualsLiteral(&quot;received&quot;)) {</span>
<a href="#l2.694"></a><span id="l2.694" class="difflineplus">+          // look for the string &quot;may be forged&quot; in the received headers.</span>
<a href="#l2.695"></a><span id="l2.695" class="difflineplus">+          // sendmail sometimes adds this hint This does not compile on linux</span>
<a href="#l2.696"></a><span id="l2.696" class="difflineplus">+          // yet. Need to figure out why. Commenting out for now if</span>
<a href="#l2.697"></a><span id="l2.697" class="difflineplus">+          // (FindInReadable(FORGED_RECEIVED_HEADER_HINT, headerValue))</span>
<a href="#l2.698"></a><span id="l2.698" class="difflineplus">+          //   addTokenForHeader(headerName.get(), FORGED_RECEIVED_HEADER_HINT);</span>
<a href="#l2.699"></a><span id="l2.699" class="difflineplus">+        }</span>
<a href="#l2.700"></a><span id="l2.700"> </span>
<a href="#l2.701"></a><span id="l2.701" class="difflineminus">-      // leave out reply-to</span>
<a href="#l2.702"></a><span id="l2.702" class="difflineminus">-      break;</span>
<a href="#l2.703"></a><span id="l2.703" class="difflineminus">-    case 's':</span>
<a href="#l2.704"></a><span id="l2.704" class="difflineminus">-        if (headerName.EqualsLiteral(&quot;subject&quot;))</span>
<a href="#l2.705"></a><span id="l2.705" class="difflineminus">-        {</span>
<a href="#l2.706"></a><span id="l2.706" class="difflineplus">+        // leave out reply-to</span>
<a href="#l2.707"></a><span id="l2.707" class="difflineplus">+        break;</span>
<a href="#l2.708"></a><span id="l2.708" class="difflineplus">+      case 's':</span>
<a href="#l2.709"></a><span id="l2.709" class="difflineplus">+        if (headerName.EqualsLiteral(&quot;subject&quot;)) {</span>
<a href="#l2.710"></a><span id="l2.710">           // we want to tokenize the subject</span>
<a href="#l2.711"></a><span id="l2.711">           addTokenForHeader(headerName.get(), headerValue, true);</span>
<a href="#l2.712"></a><span id="l2.712">         }</span>
<a href="#l2.713"></a><span id="l2.713"> </span>
<a href="#l2.714"></a><span id="l2.714">         // important: leave out sender field. Too strong of an indicator</span>
<a href="#l2.715"></a><span id="l2.715">         break;</span>
<a href="#l2.716"></a><span id="l2.716" class="difflineminus">-    case 'x': // (2) X-Mailer / user-agent works best if it is untokenized, just fold the case and any leading/trailing white space</span>
<a href="#l2.717"></a><span id="l2.717" class="difflineminus">-        // all headers beginning with x-mozilla are being changed by us, so ignore</span>
<a href="#l2.718"></a><span id="l2.718" class="difflineplus">+      case 'x':  // (2) X-Mailer / user-agent works best if it is untokenized,</span>
<a href="#l2.719"></a><span id="l2.719" class="difflineplus">+                 // just fold the case and any leading/trailing white space</span>
<a href="#l2.720"></a><span id="l2.720" class="difflineplus">+        // all headers beginning with x-mozilla are being changed by us, so</span>
<a href="#l2.721"></a><span id="l2.721" class="difflineplus">+        // ignore</span>
<a href="#l2.722"></a><span id="l2.722">         if (StringBeginsWith(headerName, NS_LITERAL_CSTRING(&quot;x-mozilla&quot;)))</span>
<a href="#l2.723"></a><span id="l2.723">           break;</span>
<a href="#l2.724"></a><span id="l2.724">         // fall through</span>
<a href="#l2.725"></a><span id="l2.725">         MOZ_FALLTHROUGH;</span>
<a href="#l2.726"></a><span id="l2.726" class="difflineminus">-    case 'u':</span>
<a href="#l2.727"></a><span id="l2.727" class="difflineplus">+      case 'u':</span>
<a href="#l2.728"></a><span id="l2.728">         addTokenForHeader(headerName.get(), headerValue);</span>
<a href="#l2.729"></a><span id="l2.729">         break;</span>
<a href="#l2.730"></a><span id="l2.730" class="difflineminus">-    default:</span>
<a href="#l2.731"></a><span id="l2.731" class="difflineplus">+      default:</span>
<a href="#l2.732"></a><span id="l2.732">         addTokenForHeader(headerName.get(), headerValue);</span>
<a href="#l2.733"></a><span id="l2.733">         break;</span>
<a href="#l2.734"></a><span id="l2.734" class="difflineminus">-    } // end switch</span>
<a href="#l2.735"></a><span id="l2.735" class="difflineminus">-</span>
<a href="#l2.736"></a><span id="l2.736" class="difflineplus">+    }  // end switch</span>
<a href="#l2.737"></a><span id="l2.737">   }</span>
<a href="#l2.738"></a><span id="l2.738"> }</span>
<a href="#l2.739"></a><span id="l2.739"> </span>
<a href="#l2.740"></a><span id="l2.740" class="difflineminus">-void Tokenizer::tokenize_ascii_word(char * aWord)</span>
<a href="#l2.741"></a><span id="l2.741" class="difflineminus">-{</span>
<a href="#l2.742"></a><span id="l2.742" class="difflineplus">+void Tokenizer::tokenize_ascii_word(char* aWord) {</span>
<a href="#l2.743"></a><span id="l2.743">   // always deal with normalized lower case strings</span>
<a href="#l2.744"></a><span id="l2.744">   toLowerCase(aWord);</span>
<a href="#l2.745"></a><span id="l2.745">   uint32_t wordLength = strlen(aWord);</span>
<a href="#l2.746"></a><span id="l2.746"> </span>
<a href="#l2.747"></a><span id="l2.747">   // if the wordLength is within our accepted token limit, then add it</span>
<a href="#l2.748"></a><span id="l2.748">   if (wordLength &gt;= kMinLengthForToken &amp;&amp; wordLength &lt;= mMaxLengthForToken)</span>
<a href="#l2.749"></a><span id="l2.749">     add(aWord);</span>
<a href="#l2.750"></a><span id="l2.750" class="difflineminus">-  else if (wordLength &gt; mMaxLengthForToken)</span>
<a href="#l2.751"></a><span id="l2.751" class="difflineminus">-  {</span>
<a href="#l2.752"></a><span id="l2.752" class="difflineplus">+  else if (wordLength &gt; mMaxLengthForToken) {</span>
<a href="#l2.753"></a><span id="l2.753">     // don't skip over the word if it looks like an email address,</span>
<a href="#l2.754"></a><span id="l2.754">     // there is value in adding tokens for addresses</span>
<a href="#l2.755"></a><span id="l2.755" class="difflineminus">-    nsDependentCString word (aWord, wordLength); // CHEAP, no allocation occurs here...</span>
<a href="#l2.756"></a><span id="l2.756" class="difflineplus">+    nsDependentCString word(aWord,</span>
<a href="#l2.757"></a><span id="l2.757" class="difflineplus">+                            wordLength);  // CHEAP, no allocation occurs here...</span>
<a href="#l2.758"></a><span id="l2.758"> </span>
<a href="#l2.759"></a><span id="l2.759" class="difflineminus">-    // XXX: i think the 40 byte check is just for perf reasons...if the email address is longer than that then forget about it.</span>
<a href="#l2.760"></a><span id="l2.760" class="difflineminus">-    const char *atSign = strchr(aWord, '@');</span>
<a href="#l2.761"></a><span id="l2.761" class="difflineminus">-    if (wordLength &lt; 40 &amp;&amp; strchr(aWord, '.') &amp;&amp; atSign &amp;&amp; !strchr(atSign + 1, '@'))</span>
<a href="#l2.762"></a><span id="l2.762" class="difflineminus">-    {</span>
<a href="#l2.763"></a><span id="l2.763" class="difflineplus">+    // XXX: i think the 40 byte check is just for perf reasons...if the email</span>
<a href="#l2.764"></a><span id="l2.764" class="difflineplus">+    // address is longer than that then forget about it.</span>
<a href="#l2.765"></a><span id="l2.765" class="difflineplus">+    const char* atSign = strchr(aWord, '@');</span>
<a href="#l2.766"></a><span id="l2.766" class="difflineplus">+    if (wordLength &lt; 40 &amp;&amp; strchr(aWord, '.') &amp;&amp; atSign &amp;&amp;</span>
<a href="#l2.767"></a><span id="l2.767" class="difflineplus">+        !strchr(atSign + 1, '@')) {</span>
<a href="#l2.768"></a><span id="l2.768">       uint32_t numBytesToSep = atSign - aWord;</span>
<a href="#l2.769"></a><span id="l2.769" class="difflineminus">-      if (numBytesToSep &lt; wordLength - 1) // if the @ sign is the last character, it must not be an email address</span>
<a href="#l2.770"></a><span id="l2.770" class="difflineplus">+      if (numBytesToSep &lt;</span>
<a href="#l2.771"></a><span id="l2.771" class="difflineplus">+          wordLength - 1)  // if the @ sign is the last character, it must not</span>
<a href="#l2.772"></a><span id="l2.772" class="difflineplus">+                           // be an email address</span>
<a href="#l2.773"></a><span id="l2.773">       {</span>
<a href="#l2.774"></a><span id="l2.774" class="difflineminus">-        // split the john@foo.com into john and foo.com, treat them as separate tokens</span>
<a href="#l2.775"></a><span id="l2.775" class="difflineplus">+        // split the john@foo.com into john and foo.com, treat them as separate</span>
<a href="#l2.776"></a><span id="l2.776" class="difflineplus">+        // tokens</span>
<a href="#l2.777"></a><span id="l2.777">         nsCString emailNameToken;</span>
<a href="#l2.778"></a><span id="l2.778">         emailNameToken.AssignLiteral(&quot;email name:&quot;);</span>
<a href="#l2.779"></a><span id="l2.779">         emailNameToken.Append(Substring(word, 0, numBytesToSep++));</span>
<a href="#l2.780"></a><span id="l2.780">         add(emailNameToken.get());</span>
<a href="#l2.781"></a><span id="l2.781">         nsCString emailAddrToken;</span>
<a href="#l2.782"></a><span id="l2.782">         emailAddrToken.AssignLiteral(&quot;email addr:&quot;);</span>
<a href="#l2.783"></a><span id="l2.783" class="difflineminus">-        emailAddrToken.Append(Substring(word, numBytesToSep, wordLength - numBytesToSep));</span>
<a href="#l2.784"></a><span id="l2.784" class="difflineplus">+        emailAddrToken.Append(</span>
<a href="#l2.785"></a><span id="l2.785" class="difflineplus">+            Substring(word, numBytesToSep, wordLength - numBytesToSep));</span>
<a href="#l2.786"></a><span id="l2.786">         add(emailAddrToken.get());</span>
<a href="#l2.787"></a><span id="l2.787">         return;</span>
<a href="#l2.788"></a><span id="l2.788">       }</span>
<a href="#l2.789"></a><span id="l2.789">     }</span>
<a href="#l2.790"></a><span id="l2.790"> </span>
<a href="#l2.791"></a><span id="l2.791">     // there is value in generating a token indicating the number</span>
<a href="#l2.792"></a><span id="l2.792">     // of characters we are skipping. We'll round to the nearest 10</span>
<a href="#l2.793"></a><span id="l2.793">     nsCString skipToken;</span>
<a href="#l2.794"></a><span id="l2.794">     skipToken.AssignLiteral(&quot;skip:&quot;);</span>
<a href="#l2.795"></a><span id="l2.795">     skipToken.Append(word[0]);</span>
<a href="#l2.796"></a><span id="l2.796">     skipToken.Append(' ');</span>
<a href="#l2.797"></a><span id="l2.797" class="difflineminus">-    skipToken.AppendInt((wordLength/10) * 10);</span>
<a href="#l2.798"></a><span id="l2.798" class="difflineplus">+    skipToken.AppendInt((wordLength / 10) * 10);</span>
<a href="#l2.799"></a><span id="l2.799">     add(skipToken.get());</span>
<a href="#l2.800"></a><span id="l2.800">   }</span>
<a href="#l2.801"></a><span id="l2.801"> }</span>
<a href="#l2.802"></a><span id="l2.802"> </span>
<a href="#l2.803"></a><span id="l2.803" class="difflineminus">-// one subtract and one conditional jump should be faster than two conditional jump on most recent system.</span>
<a href="#l2.804"></a><span id="l2.804" class="difflineminus">-#define IN_RANGE(x, low, high)  ((uint16_t)((x)-(low)) &lt;= (high)-(low))</span>
<a href="#l2.805"></a><span id="l2.805" class="difflineminus">-</span>
<a href="#l2.806"></a><span id="l2.806" class="difflineminus">-#define IS_JA_HIRAGANA(x)   IN_RANGE(x, 0x3040, 0x309F)</span>
<a href="#l2.807"></a><span id="l2.807" class="difflineminus">-// swapping the range using xor operation to reduce conditional jump.</span>
<a href="#l2.808"></a><span id="l2.808" class="difflineminus">-#define IS_JA_KATAKANA(x)   (IN_RANGE(x^0x0004, 0x30A0, 0x30FE)||(IN_RANGE(x, 0xFF66, 0xFF9F)))</span>
<a href="#l2.809"></a><span id="l2.809" class="difflineminus">-#define IS_JA_KANJI(x)      (IN_RANGE(x, 0x2E80, 0x2FDF)||IN_RANGE(x, 0x4E00, 0x9FAF))</span>
<a href="#l2.810"></a><span id="l2.810" class="difflineminus">-#define IS_JA_KUTEN(x)      (((x)==0x3001)||((x)==0xFF64)||((x)==0xFF0E))</span>
<a href="#l2.811"></a><span id="l2.811" class="difflineminus">-#define IS_JA_TOUTEN(x)     (((x)==0x3002)||((x)==0xFF61)||((x)==0xFF0C))</span>
<a href="#l2.812"></a><span id="l2.812" class="difflineminus">-#define IS_JA_SPACE(x)      ((x)==0x3000)</span>
<a href="#l2.813"></a><span id="l2.813" class="difflineminus">-#define IS_JA_FWLATAIN(x)   IN_RANGE(x, 0xFF01, 0xFF5E)</span>
<a href="#l2.814"></a><span id="l2.814" class="difflineminus">-#define IS_JA_FWNUMERAL(x)  IN_RANGE(x, 0xFF10, 0xFF19)</span>
<a href="#l2.815"></a><span id="l2.815" class="difflineplus">+// one subtract and one conditional jump should be faster than two conditional</span>
<a href="#l2.816"></a><span id="l2.816" class="difflineplus">+// jump on most recent system.</span>
<a href="#l2.817"></a><span id="l2.817" class="difflineplus">+#define IN_RANGE(x, low, high) ((uint16_t)((x) - (low)) &lt;= (high) - (low))</span>
<a href="#l2.818"></a><span id="l2.818"> </span>
<a href="#l2.819"></a><span id="l2.819" class="difflineminus">-#define IS_JAPANESE_SPECIFIC(x) (IN_RANGE(x, 0x3040, 0x30FF)||IN_RANGE(x, 0xFF01, 0xFF9F))</span>
<a href="#l2.820"></a><span id="l2.820" class="difflineplus">+#define IS_JA_HIRAGANA(x) IN_RANGE(x, 0x3040, 0x309F)</span>
<a href="#l2.821"></a><span id="l2.821" class="difflineplus">+// swapping the range using xor operation to reduce conditional jump.</span>
<a href="#l2.822"></a><span id="l2.822" class="difflineplus">+#define IS_JA_KATAKANA(x) \</span>
<a href="#l2.823"></a><span id="l2.823" class="difflineplus">+  (IN_RANGE(x ^ 0x0004, 0x30A0, 0x30FE) || (IN_RANGE(x, 0xFF66, 0xFF9F)))</span>
<a href="#l2.824"></a><span id="l2.824" class="difflineplus">+#define IS_JA_KANJI(x) \</span>
<a href="#l2.825"></a><span id="l2.825" class="difflineplus">+  (IN_RANGE(x, 0x2E80, 0x2FDF) || IN_RANGE(x, 0x4E00, 0x9FAF))</span>
<a href="#l2.826"></a><span id="l2.826" class="difflineplus">+#define IS_JA_KUTEN(x) (((x) == 0x3001) || ((x) == 0xFF64) || ((x) == 0xFF0E))</span>
<a href="#l2.827"></a><span id="l2.827" class="difflineplus">+#define IS_JA_TOUTEN(x) (((x) == 0x3002) || ((x) == 0xFF61) || ((x) == 0xFF0C))</span>
<a href="#l2.828"></a><span id="l2.828" class="difflineplus">+#define IS_JA_SPACE(x) ((x) == 0x3000)</span>
<a href="#l2.829"></a><span id="l2.829" class="difflineplus">+#define IS_JA_FWLATAIN(x) IN_RANGE(x, 0xFF01, 0xFF5E)</span>
<a href="#l2.830"></a><span id="l2.830" class="difflineplus">+#define IS_JA_FWNUMERAL(x) IN_RANGE(x, 0xFF10, 0xFF19)</span>
<a href="#l2.831"></a><span id="l2.831"> </span>
<a href="#l2.832"></a><span id="l2.832" class="difflineminus">-enum char_class{</span>
<a href="#l2.833"></a><span id="l2.833" class="difflineminus">-    others = 0,</span>
<a href="#l2.834"></a><span id="l2.834" class="difflineminus">-    space,</span>
<a href="#l2.835"></a><span id="l2.835" class="difflineminus">-    hiragana,</span>
<a href="#l2.836"></a><span id="l2.836" class="difflineminus">-    katakana,</span>
<a href="#l2.837"></a><span id="l2.837" class="difflineminus">-    kanji,</span>
<a href="#l2.838"></a><span id="l2.838" class="difflineminus">-    kuten,</span>
<a href="#l2.839"></a><span id="l2.839" class="difflineminus">-    touten,</span>
<a href="#l2.840"></a><span id="l2.840" class="difflineminus">-    kigou,</span>
<a href="#l2.841"></a><span id="l2.841" class="difflineminus">-    fwlatain,</span>
<a href="#l2.842"></a><span id="l2.842" class="difflineminus">-    ascii</span>
<a href="#l2.843"></a><span id="l2.843" class="difflineplus">+#define IS_JAPANESE_SPECIFIC(x) \</span>
<a href="#l2.844"></a><span id="l2.844" class="difflineplus">+  (IN_RANGE(x, 0x3040, 0x30FF) || IN_RANGE(x, 0xFF01, 0xFF9F))</span>
<a href="#l2.845"></a><span id="l2.845" class="difflineplus">+</span>
<a href="#l2.846"></a><span id="l2.846" class="difflineplus">+enum char_class {</span>
<a href="#l2.847"></a><span id="l2.847" class="difflineplus">+  others = 0,</span>
<a href="#l2.848"></a><span id="l2.848" class="difflineplus">+  space,</span>
<a href="#l2.849"></a><span id="l2.849" class="difflineplus">+  hiragana,</span>
<a href="#l2.850"></a><span id="l2.850" class="difflineplus">+  katakana,</span>
<a href="#l2.851"></a><span id="l2.851" class="difflineplus">+  kanji,</span>
<a href="#l2.852"></a><span id="l2.852" class="difflineplus">+  kuten,</span>
<a href="#l2.853"></a><span id="l2.853" class="difflineplus">+  touten,</span>
<a href="#l2.854"></a><span id="l2.854" class="difflineplus">+  kigou,</span>
<a href="#l2.855"></a><span id="l2.855" class="difflineplus">+  fwlatain,</span>
<a href="#l2.856"></a><span id="l2.856" class="difflineplus">+  ascii</span>
<a href="#l2.857"></a><span id="l2.857"> };</span>
<a href="#l2.858"></a><span id="l2.858"> </span>
<a href="#l2.859"></a><span id="l2.859" class="difflineminus">-static char_class getCharClass(char16_t c)</span>
<a href="#l2.860"></a><span id="l2.860" class="difflineminus">-{</span>
<a href="#l2.861"></a><span id="l2.861" class="difflineplus">+static char_class getCharClass(char16_t c) {</span>
<a href="#l2.862"></a><span id="l2.862">   char_class charClass = others;</span>
<a href="#l2.863"></a><span id="l2.863"> </span>
<a href="#l2.864"></a><span id="l2.864" class="difflineminus">-  if(IS_JA_HIRAGANA(c))</span>
<a href="#l2.865"></a><span id="l2.865" class="difflineplus">+  if (IS_JA_HIRAGANA(c))</span>
<a href="#l2.866"></a><span id="l2.866">     charClass = hiragana;</span>
<a href="#l2.867"></a><span id="l2.867" class="difflineminus">-  else if(IS_JA_KATAKANA(c))</span>
<a href="#l2.868"></a><span id="l2.868" class="difflineplus">+  else if (IS_JA_KATAKANA(c))</span>
<a href="#l2.869"></a><span id="l2.869">     charClass = katakana;</span>
<a href="#l2.870"></a><span id="l2.870" class="difflineminus">-  else if(IS_JA_KANJI(c))</span>
<a href="#l2.871"></a><span id="l2.871" class="difflineplus">+  else if (IS_JA_KANJI(c))</span>
<a href="#l2.872"></a><span id="l2.872">     charClass = kanji;</span>
<a href="#l2.873"></a><span id="l2.873" class="difflineminus">-  else if(IS_JA_KUTEN(c))</span>
<a href="#l2.874"></a><span id="l2.874" class="difflineplus">+  else if (IS_JA_KUTEN(c))</span>
<a href="#l2.875"></a><span id="l2.875">     charClass = kuten;</span>
<a href="#l2.876"></a><span id="l2.876" class="difflineminus">-  else if(IS_JA_TOUTEN(c))</span>
<a href="#l2.877"></a><span id="l2.877" class="difflineplus">+  else if (IS_JA_TOUTEN(c))</span>
<a href="#l2.878"></a><span id="l2.878">     charClass = touten;</span>
<a href="#l2.879"></a><span id="l2.879" class="difflineminus">-  else if(IS_JA_FWLATAIN(c))</span>
<a href="#l2.880"></a><span id="l2.880" class="difflineplus">+  else if (IS_JA_FWLATAIN(c))</span>
<a href="#l2.881"></a><span id="l2.881">     charClass = fwlatain;</span>
<a href="#l2.882"></a><span id="l2.882"> </span>
<a href="#l2.883"></a><span id="l2.883">   return charClass;</span>
<a href="#l2.884"></a><span id="l2.884"> }</span>
<a href="#l2.885"></a><span id="l2.885"> </span>
<a href="#l2.886"></a><span id="l2.886" class="difflineminus">-static bool isJapanese(const char* word)</span>
<a href="#l2.887"></a><span id="l2.887" class="difflineminus">-{</span>
<a href="#l2.888"></a><span id="l2.888" class="difflineplus">+static bool isJapanese(const char* word) {</span>
<a href="#l2.889"></a><span id="l2.889">   nsString text = NS_ConvertUTF8toUTF16(word);</span>
<a href="#l2.890"></a><span id="l2.890">   char16_t* p = (char16_t*)text.get();</span>
<a href="#l2.891"></a><span id="l2.891">   char16_t c;</span>
<a href="#l2.892"></a><span id="l2.892"> </span>
<a href="#l2.893"></a><span id="l2.893">   // it is japanese chunk if it contains any hiragana or katakana.</span>
<a href="#l2.894"></a><span id="l2.894" class="difflineminus">-  while((c = *p++))</span>
<a href="#l2.895"></a><span id="l2.895" class="difflineminus">-    if( IS_JAPANESE_SPECIFIC(c))</span>
<a href="#l2.896"></a><span id="l2.896" class="difflineminus">-      return true;</span>
<a href="#l2.897"></a><span id="l2.897" class="difflineplus">+  while ((c = *p++))</span>
<a href="#l2.898"></a><span id="l2.898" class="difflineplus">+    if (IS_JAPANESE_SPECIFIC(c)) return true;</span>
<a href="#l2.899"></a><span id="l2.899"> </span>
<a href="#l2.900"></a><span id="l2.900">   return false;</span>
<a href="#l2.901"></a><span id="l2.901"> }</span>
<a href="#l2.902"></a><span id="l2.902"> </span>
<a href="#l2.903"></a><span id="l2.903" class="difflineminus">-static bool isFWNumeral(const char16_t* p1, const char16_t* p2)</span>
<a href="#l2.904"></a><span id="l2.904" class="difflineminus">-{</span>
<a href="#l2.905"></a><span id="l2.905" class="difflineminus">-  for(;p1&lt;p2;p1++)</span>
<a href="#l2.906"></a><span id="l2.906" class="difflineminus">-    if(!IS_JA_FWNUMERAL(*p1))</span>
<a href="#l2.907"></a><span id="l2.907" class="difflineminus">-      return false;</span>
<a href="#l2.908"></a><span id="l2.908" class="difflineplus">+static bool isFWNumeral(const char16_t* p1, const char16_t* p2) {</span>
<a href="#l2.909"></a><span id="l2.909" class="difflineplus">+  for (; p1 &lt; p2; p1++)</span>
<a href="#l2.910"></a><span id="l2.910" class="difflineplus">+    if (!IS_JA_FWNUMERAL(*p1)) return false;</span>
<a href="#l2.911"></a><span id="l2.911"> </span>
<a href="#l2.912"></a><span id="l2.912">   return true;</span>
<a href="#l2.913"></a><span id="l2.913"> }</span>
<a href="#l2.914"></a><span id="l2.914"> </span>
<a href="#l2.915"></a><span id="l2.915"> // The japanese tokenizer was added as part of Bug #277354</span>
<a href="#l2.916"></a><span id="l2.916" class="difflineminus">-void Tokenizer::tokenize_japanese_word(char* chunk)</span>
<a href="#l2.917"></a><span id="l2.917" class="difflineminus">-{</span>
<a href="#l2.918"></a><span id="l2.918" class="difflineminus">-  MOZ_LOG(BayesianFilterLogModule, LogLevel::Debug, (&quot;entering tokenize_japanese_word(%s)&quot;, chunk));</span>
<a href="#l2.919"></a><span id="l2.919" class="difflineplus">+void Tokenizer::tokenize_japanese_word(char* chunk) {</span>
<a href="#l2.920"></a><span id="l2.920" class="difflineplus">+  MOZ_LOG(BayesianFilterLogModule, LogLevel::Debug,</span>
<a href="#l2.921"></a><span id="l2.921" class="difflineplus">+          (&quot;entering tokenize_japanese_word(%s)&quot;, chunk));</span>
<a href="#l2.922"></a><span id="l2.922"> </span>
<a href="#l2.923"></a><span id="l2.923">   nsString srcStr = NS_ConvertUTF8toUTF16(chunk);</span>
<a href="#l2.924"></a><span id="l2.924">   const char16_t* p1 = srcStr.get();</span>
<a href="#l2.925"></a><span id="l2.925">   const char16_t* p2 = p1;</span>
<a href="#l2.926"></a><span id="l2.926" class="difflineminus">-  if(!*p2) return;</span>
<a href="#l2.927"></a><span id="l2.927" class="difflineplus">+  if (!*p2) return;</span>
<a href="#l2.928"></a><span id="l2.928"> </span>
<a href="#l2.929"></a><span id="l2.929">   char_class cc = getCharClass(*p2);</span>
<a href="#l2.930"></a><span id="l2.930" class="difflineminus">-  while(*(++p2))</span>
<a href="#l2.931"></a><span id="l2.931" class="difflineminus">-  {</span>
<a href="#l2.932"></a><span id="l2.932" class="difflineminus">-    if(cc == getCharClass(*p2))</span>
<a href="#l2.933"></a><span id="l2.933" class="difflineminus">-      continue;</span>
<a href="#l2.934"></a><span id="l2.934" class="difflineplus">+  while (*(++p2)) {</span>
<a href="#l2.935"></a><span id="l2.935" class="difflineplus">+    if (cc == getCharClass(*p2)) continue;</span>
<a href="#l2.936"></a><span id="l2.936"> </span>
<a href="#l2.937"></a><span id="l2.937" class="difflineminus">-    nsCString token = NS_ConvertUTF16toUTF8(p1, p2-p1);</span>
<a href="#l2.938"></a><span id="l2.938" class="difflineminus">-    if( (!isDecimalNumber(token.get())) &amp;&amp; (!isFWNumeral(p1, p2)))</span>
<a href="#l2.939"></a><span id="l2.939" class="difflineminus">-    {</span>
<a href="#l2.940"></a><span id="l2.940" class="difflineplus">+    nsCString token = NS_ConvertUTF16toUTF8(p1, p2 - p1);</span>
<a href="#l2.941"></a><span id="l2.941" class="difflineplus">+    if ((!isDecimalNumber(token.get())) &amp;&amp; (!isFWNumeral(p1, p2))) {</span>
<a href="#l2.942"></a><span id="l2.942">       nsCString tmpStr;</span>
<a href="#l2.943"></a><span id="l2.943">       tmpStr.AppendLiteral(&quot;JA:&quot;);</span>
<a href="#l2.944"></a><span id="l2.944">       tmpStr.Append(token);</span>
<a href="#l2.945"></a><span id="l2.945">       add(tmpStr.get());</span>
<a href="#l2.946"></a><span id="l2.946">     }</span>
<a href="#l2.947"></a><span id="l2.947"> </span>
<a href="#l2.948"></a><span id="l2.948">     cc = getCharClass(*p2);</span>
<a href="#l2.949"></a><span id="l2.949">     p1 = p2;</span>
<a href="#l2.950"></a><span id="l2.950">   }</span>
<a href="#l2.951"></a><span id="l2.951"> }</span>
<a href="#l2.952"></a><span id="l2.952"> </span>
<a href="#l2.953"></a><span id="l2.953" class="difflineminus">-nsresult Tokenizer::stripHTML(const nsAString&amp; inString, nsAString&amp; outString)</span>
<a href="#l2.954"></a><span id="l2.954" class="difflineminus">-{</span>
<a href="#l2.955"></a><span id="l2.955" class="difflineminus">-  uint32_t flags = nsIDocumentEncoder::OutputLFLineBreak</span>
<a href="#l2.956"></a><span id="l2.956" class="difflineminus">-                 | nsIDocumentEncoder::OutputNoScriptContent</span>
<a href="#l2.957"></a><span id="l2.957" class="difflineminus">-                 | nsIDocumentEncoder::OutputNoFramesContent</span>
<a href="#l2.958"></a><span id="l2.958" class="difflineminus">-                 | nsIDocumentEncoder::OutputBodyOnly;</span>
<a href="#l2.959"></a><span id="l2.959" class="difflineminus">-  nsCOMPtr&lt;nsIParserUtils&gt; utils =</span>
<a href="#l2.960"></a><span id="l2.960" class="difflineminus">-    do_GetService(NS_PARSERUTILS_CONTRACTID);</span>
<a href="#l2.961"></a><span id="l2.961" class="difflineplus">+nsresult Tokenizer::stripHTML(const nsAString&amp; inString, nsAString&amp; outString) {</span>
<a href="#l2.962"></a><span id="l2.962" class="difflineplus">+  uint32_t flags = nsIDocumentEncoder::OutputLFLineBreak |</span>
<a href="#l2.963"></a><span id="l2.963" class="difflineplus">+                   nsIDocumentEncoder::OutputNoScriptContent |</span>
<a href="#l2.964"></a><span id="l2.964" class="difflineplus">+                   nsIDocumentEncoder::OutputNoFramesContent |</span>
<a href="#l2.965"></a><span id="l2.965" class="difflineplus">+                   nsIDocumentEncoder::OutputBodyOnly;</span>
<a href="#l2.966"></a><span id="l2.966" class="difflineplus">+  nsCOMPtr&lt;nsIParserUtils&gt; utils = do_GetService(NS_PARSERUTILS_CONTRACTID);</span>
<a href="#l2.967"></a><span id="l2.967">   return utils-&gt;ConvertToPlainText(inString, flags, 80, outString);</span>
<a href="#l2.968"></a><span id="l2.968"> }</span>
<a href="#l2.969"></a><span id="l2.969"> </span>
<a href="#l2.970"></a><span id="l2.970"> // Copied from nsSemanticUnitScanner.cpp which was removed in bug 1368418.</span>
<a href="#l2.971"></a><span id="l2.971" class="difflineminus">-nsresult Tokenizer::ScannerNext(const char16_t *text, int32_t length, int32_t pos, bool isLastBuffer, int32_t *begin, int32_t *end, bool *_retval)</span>
<a href="#l2.972"></a><span id="l2.972" class="difflineminus">-{</span>
<a href="#l2.973"></a><span id="l2.973" class="difflineminus">-    if (!mWordBreaker) {</span>
<a href="#l2.974"></a><span id="l2.974" class="difflineminus">-      mWordBreaker = mozilla::intl::WordBreaker::Create();</span>
<a href="#l2.975"></a><span id="l2.975" class="difflineminus">-    }</span>
<a href="#l2.976"></a><span id="l2.976" class="difflineminus">-</span>
<a href="#l2.977"></a><span id="l2.977" class="difflineminus">-    // if we reach the end, just return</span>
<a href="#l2.978"></a><span id="l2.978" class="difflineminus">-    if (pos &gt;= length) {</span>
<a href="#l2.979"></a><span id="l2.979" class="difflineminus">-       *begin = pos;</span>
<a href="#l2.980"></a><span id="l2.980" class="difflineminus">-       *end = pos;</span>
<a href="#l2.981"></a><span id="l2.981" class="difflineminus">-       *_retval = false;</span>
<a href="#l2.982"></a><span id="l2.982" class="difflineminus">-       return NS_OK;</span>
<a href="#l2.983"></a><span id="l2.983" class="difflineminus">-    }</span>
<a href="#l2.984"></a><span id="l2.984" class="difflineminus">-</span>
<a href="#l2.985"></a><span id="l2.985" class="difflineminus">-    mozilla::intl::WordBreakClass char_class = mozilla::intl::WordBreaker::GetClass(text[pos]);</span>
<a href="#l2.986"></a><span id="l2.986" class="difflineplus">+nsresult Tokenizer::ScannerNext(const char16_t* text, int32_t length,</span>
<a href="#l2.987"></a><span id="l2.987" class="difflineplus">+                                int32_t pos, bool isLastBuffer, int32_t* begin,</span>
<a href="#l2.988"></a><span id="l2.988" class="difflineplus">+                                int32_t* end, bool* _retval) {</span>
<a href="#l2.989"></a><span id="l2.989" class="difflineplus">+  if (!mWordBreaker) {</span>
<a href="#l2.990"></a><span id="l2.990" class="difflineplus">+    mWordBreaker = mozilla::intl::WordBreaker::Create();</span>
<a href="#l2.991"></a><span id="l2.991" class="difflineplus">+  }</span>
<a href="#l2.992"></a><span id="l2.992"> </span>
<a href="#l2.993"></a><span id="l2.993" class="difflineminus">-    // If we are in Chinese mode, return one Han letter at a time.</span>
<a href="#l2.994"></a><span id="l2.994" class="difflineminus">-    // We should not do this if we are in Japanese or Korean mode.</span>
<a href="#l2.995"></a><span id="l2.995" class="difflineminus">-    if (mozilla::intl::kWbClassHanLetter == char_class) {</span>
<a href="#l2.996"></a><span id="l2.996" class="difflineminus">-       *begin = pos;</span>
<a href="#l2.997"></a><span id="l2.997" class="difflineminus">-       *end = pos+1;</span>
<a href="#l2.998"></a><span id="l2.998" class="difflineminus">-       *_retval = true;</span>
<a href="#l2.999"></a><span id="l2.999" class="difflineminus">-       return NS_OK;</span>
<a href="#l2.1000"></a><span id="l2.1000" class="difflineminus">-    }</span>
<a href="#l2.1001"></a><span id="l2.1001" class="difflineminus">-</span>
<a href="#l2.1002"></a><span id="l2.1002" class="difflineminus">-    int32_t next;</span>
<a href="#l2.1003"></a><span id="l2.1003" class="difflineminus">-    // Find the next &quot;word&quot;.</span>
<a href="#l2.1004"></a><span id="l2.1004" class="difflineminus">-    next = mWordBreaker-&gt;NextWord(text, (uint32_t) length, (uint32_t) pos);</span>
<a href="#l2.1005"></a><span id="l2.1005" class="difflineplus">+  // if we reach the end, just return</span>
<a href="#l2.1006"></a><span id="l2.1006" class="difflineplus">+  if (pos &gt;= length) {</span>
<a href="#l2.1007"></a><span id="l2.1007" class="difflineplus">+    *begin = pos;</span>
<a href="#l2.1008"></a><span id="l2.1008" class="difflineplus">+    *end = pos;</span>
<a href="#l2.1009"></a><span id="l2.1009" class="difflineplus">+    *_retval = false;</span>
<a href="#l2.1010"></a><span id="l2.1010" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.1011"></a><span id="l2.1011" class="difflineplus">+  }</span>
<a href="#l2.1012"></a><span id="l2.1012"> </span>
<a href="#l2.1013"></a><span id="l2.1013" class="difflineminus">-    // If we don't have enough text to make decision, return.</span>
<a href="#l2.1014"></a><span id="l2.1014" class="difflineminus">-    if (next == NS_WORDBREAKER_NEED_MORE_TEXT) {</span>
<a href="#l2.1015"></a><span id="l2.1015" class="difflineminus">-       *begin = pos;</span>
<a href="#l2.1016"></a><span id="l2.1016" class="difflineminus">-       *end = isLastBuffer ? length : pos;</span>
<a href="#l2.1017"></a><span id="l2.1017" class="difflineminus">-       *_retval = isLastBuffer;</span>
<a href="#l2.1018"></a><span id="l2.1018" class="difflineminus">-       return NS_OK;</span>
<a href="#l2.1019"></a><span id="l2.1019" class="difflineminus">-    }</span>
<a href="#l2.1020"></a><span id="l2.1020" class="difflineplus">+  mozilla::intl::WordBreakClass char_class =</span>
<a href="#l2.1021"></a><span id="l2.1021" class="difflineplus">+      mozilla::intl::WordBreaker::GetClass(text[pos]);</span>
<a href="#l2.1022"></a><span id="l2.1022"> </span>
<a href="#l2.1023"></a><span id="l2.1023" class="difflineminus">-    // If what we got is space or punct, look at the next break.</span>
<a href="#l2.1024"></a><span id="l2.1024" class="difflineminus">-    if (char_class == mozilla::intl::kWbClassSpace ||</span>
<a href="#l2.1025"></a><span id="l2.1025" class="difflineminus">-        char_class == mozilla::intl::kWbClassPunct) {</span>
<a href="#l2.1026"></a><span id="l2.1026" class="difflineminus">-        // If the next &quot;word&quot; is not letters,</span>
<a href="#l2.1027"></a><span id="l2.1027" class="difflineminus">-        // call itself recursively with the new pos.</span>
<a href="#l2.1028"></a><span id="l2.1028" class="difflineminus">-        return ScannerNext(text, length, next, isLastBuffer, begin, end, _retval);</span>
<a href="#l2.1029"></a><span id="l2.1029" class="difflineminus">-    }</span>
<a href="#l2.1030"></a><span id="l2.1030" class="difflineminus">-</span>
<a href="#l2.1031"></a><span id="l2.1031" class="difflineminus">-    // For the rest, return.</span>
<a href="#l2.1032"></a><span id="l2.1032" class="difflineplus">+  // If we are in Chinese mode, return one Han letter at a time.</span>
<a href="#l2.1033"></a><span id="l2.1033" class="difflineplus">+  // We should not do this if we are in Japanese or Korean mode.</span>
<a href="#l2.1034"></a><span id="l2.1034" class="difflineplus">+  if (mozilla::intl::kWbClassHanLetter == char_class) {</span>
<a href="#l2.1035"></a><span id="l2.1035">     *begin = pos;</span>
<a href="#l2.1036"></a><span id="l2.1036" class="difflineminus">-    *end = next;</span>
<a href="#l2.1037"></a><span id="l2.1037" class="difflineplus">+    *end = pos + 1;</span>
<a href="#l2.1038"></a><span id="l2.1038">     *_retval = true;</span>
<a href="#l2.1039"></a><span id="l2.1039">     return NS_OK;</span>
<a href="#l2.1040"></a><span id="l2.1040" class="difflineplus">+  }</span>
<a href="#l2.1041"></a><span id="l2.1041" class="difflineplus">+</span>
<a href="#l2.1042"></a><span id="l2.1042" class="difflineplus">+  int32_t next;</span>
<a href="#l2.1043"></a><span id="l2.1043" class="difflineplus">+  // Find the next &quot;word&quot;.</span>
<a href="#l2.1044"></a><span id="l2.1044" class="difflineplus">+  next = mWordBreaker-&gt;NextWord(text, (uint32_t)length, (uint32_t)pos);</span>
<a href="#l2.1045"></a><span id="l2.1045" class="difflineplus">+</span>
<a href="#l2.1046"></a><span id="l2.1046" class="difflineplus">+  // If we don't have enough text to make decision, return.</span>
<a href="#l2.1047"></a><span id="l2.1047" class="difflineplus">+  if (next == NS_WORDBREAKER_NEED_MORE_TEXT) {</span>
<a href="#l2.1048"></a><span id="l2.1048" class="difflineplus">+    *begin = pos;</span>
<a href="#l2.1049"></a><span id="l2.1049" class="difflineplus">+    *end = isLastBuffer ? length : pos;</span>
<a href="#l2.1050"></a><span id="l2.1050" class="difflineplus">+    *_retval = isLastBuffer;</span>
<a href="#l2.1051"></a><span id="l2.1051" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.1052"></a><span id="l2.1052" class="difflineplus">+  }</span>
<a href="#l2.1053"></a><span id="l2.1053" class="difflineplus">+</span>
<a href="#l2.1054"></a><span id="l2.1054" class="difflineplus">+  // If what we got is space or punct, look at the next break.</span>
<a href="#l2.1055"></a><span id="l2.1055" class="difflineplus">+  if (char_class == mozilla::intl::kWbClassSpace ||</span>
<a href="#l2.1056"></a><span id="l2.1056" class="difflineplus">+      char_class == mozilla::intl::kWbClassPunct) {</span>
<a href="#l2.1057"></a><span id="l2.1057" class="difflineplus">+    // If the next &quot;word&quot; is not letters,</span>
<a href="#l2.1058"></a><span id="l2.1058" class="difflineplus">+    // call itself recursively with the new pos.</span>
<a href="#l2.1059"></a><span id="l2.1059" class="difflineplus">+    return ScannerNext(text, length, next, isLastBuffer, begin, end, _retval);</span>
<a href="#l2.1060"></a><span id="l2.1060" class="difflineplus">+  }</span>
<a href="#l2.1061"></a><span id="l2.1061" class="difflineplus">+</span>
<a href="#l2.1062"></a><span id="l2.1062" class="difflineplus">+  // For the rest, return.</span>
<a href="#l2.1063"></a><span id="l2.1063" class="difflineplus">+  *begin = pos;</span>
<a href="#l2.1064"></a><span id="l2.1064" class="difflineplus">+  *end = next;</span>
<a href="#l2.1065"></a><span id="l2.1065" class="difflineplus">+  *_retval = true;</span>
<a href="#l2.1066"></a><span id="l2.1066" class="difflineplus">+  return NS_OK;</span>
<a href="#l2.1067"></a><span id="l2.1067"> }</span>
<a href="#l2.1068"></a><span id="l2.1068"> </span>
<a href="#l2.1069"></a><span id="l2.1069" class="difflineminus">-void Tokenizer::tokenize(const char* aText)</span>
<a href="#l2.1070"></a><span id="l2.1070" class="difflineminus">-{</span>
<a href="#l2.1071"></a><span id="l2.1071" class="difflineplus">+void Tokenizer::tokenize(const char* aText) {</span>
<a href="#l2.1072"></a><span id="l2.1072">   MOZ_LOG(BayesianFilterLogModule, LogLevel::Debug, (&quot;tokenize: %s&quot;, aText));</span>
<a href="#l2.1073"></a><span id="l2.1073"> </span>
<a href="#l2.1074"></a><span id="l2.1074">   // strip out HTML tags before we begin processing</span>
<a href="#l2.1075"></a><span id="l2.1075">   // uggh but first we have to blow up our string into UCS2</span>
<a href="#l2.1076"></a><span id="l2.1076">   // since that's what the document encoder wants. UTF8/UCS2, I wish we all</span>
<a href="#l2.1077"></a><span id="l2.1077">   // spoke the same language here..</span>
<a href="#l2.1078"></a><span id="l2.1078">   nsString text = NS_ConvertUTF8toUTF16(aText);</span>
<a href="#l2.1079"></a><span id="l2.1079">   nsString strippedUCS2;</span>
<a href="#l2.1080"></a><span id="l2.1080"> </span>
<a href="#l2.1081"></a><span id="l2.1081">   // RSS feeds store their summary information as an iframe. But due to</span>
<a href="#l2.1082"></a><span id="l2.1082">   // bug 365953, we can't see those in the plaintext serializer. As a</span>
<a href="#l2.1083"></a><span id="l2.1083">   // workaround, allow an option to replace iframe with div in the message</span>
<a href="#l2.1084"></a><span id="l2.1084">   // text. We disable by default, since most people won't be applying bayes</span>
<a href="#l2.1085"></a><span id="l2.1085">   // to RSS</span>
<a href="#l2.1086"></a><span id="l2.1086"> </span>
<a href="#l2.1087"></a><span id="l2.1087" class="difflineminus">-  if (mIframeToDiv)</span>
<a href="#l2.1088"></a><span id="l2.1088" class="difflineminus">-  {</span>
<a href="#l2.1089"></a><span id="l2.1089" class="difflineplus">+  if (mIframeToDiv) {</span>
<a href="#l2.1090"></a><span id="l2.1090">     MsgReplaceSubstring(text, NS_LITERAL_STRING(&quot;&lt;iframe&quot;),</span>
<a href="#l2.1091"></a><span id="l2.1091">                         NS_LITERAL_STRING(&quot;&lt;div&quot;));</span>
<a href="#l2.1092"></a><span id="l2.1092">     MsgReplaceSubstring(text, NS_LITERAL_STRING(&quot;/iframe&gt;&quot;),</span>
<a href="#l2.1093"></a><span id="l2.1093">                         NS_LITERAL_STRING(&quot;/div&gt;&quot;));</span>
<a href="#l2.1094"></a><span id="l2.1094">   }</span>
<a href="#l2.1095"></a><span id="l2.1095"> </span>
<a href="#l2.1096"></a><span id="l2.1096">   stripHTML(text, strippedUCS2);</span>
<a href="#l2.1097"></a><span id="l2.1097"> </span>
<a href="#l2.1098"></a><span id="l2.1098">   // convert 0x3000(full width space) into 0x0020</span>
<a href="#l2.1099"></a><span id="l2.1099" class="difflineminus">-  char16_t * substr_start = strippedUCS2.BeginWriting();</span>
<a href="#l2.1100"></a><span id="l2.1100" class="difflineminus">-  char16_t * substr_end = strippedUCS2.EndWriting();</span>
<a href="#l2.1101"></a><span id="l2.1101" class="difflineplus">+  char16_t* substr_start = strippedUCS2.BeginWriting();</span>
<a href="#l2.1102"></a><span id="l2.1102" class="difflineplus">+  char16_t* substr_end = strippedUCS2.EndWriting();</span>
<a href="#l2.1103"></a><span id="l2.1103">   while (substr_start != substr_end) {</span>
<a href="#l2.1104"></a><span id="l2.1104" class="difflineminus">-    if (*substr_start == 0x3000)</span>
<a href="#l2.1105"></a><span id="l2.1105" class="difflineminus">-        *substr_start = 0x0020;</span>
<a href="#l2.1106"></a><span id="l2.1106" class="difflineplus">+    if (*substr_start == 0x3000) *substr_start = 0x0020;</span>
<a href="#l2.1107"></a><span id="l2.1107">     ++substr_start;</span>
<a href="#l2.1108"></a><span id="l2.1108">   }</span>
<a href="#l2.1109"></a><span id="l2.1109"> </span>
<a href="#l2.1110"></a><span id="l2.1110">   nsCString strippedStr = NS_ConvertUTF16toUTF8(strippedUCS2);</span>
<a href="#l2.1111"></a><span id="l2.1111" class="difflineminus">-  char * strippedText = strippedStr.BeginWriting();</span>
<a href="#l2.1112"></a><span id="l2.1112" class="difflineminus">-  MOZ_LOG(BayesianFilterLogModule, LogLevel::Debug, (&quot;tokenize stripped html: %s&quot;, strippedText));</span>
<a href="#l2.1113"></a><span id="l2.1113" class="difflineplus">+  char* strippedText = strippedStr.BeginWriting();</span>
<a href="#l2.1114"></a><span id="l2.1114" class="difflineplus">+  MOZ_LOG(BayesianFilterLogModule, LogLevel::Debug,</span>
<a href="#l2.1115"></a><span id="l2.1115" class="difflineplus">+          (&quot;tokenize stripped html: %s&quot;, strippedText));</span>
<a href="#l2.1116"></a><span id="l2.1116"> </span>
<a href="#l2.1117"></a><span id="l2.1117">   char* word;</span>
<a href="#l2.1118"></a><span id="l2.1118">   char* next = strippedText;</span>
<a href="#l2.1119"></a><span id="l2.1119">   while ((word = NS_strtok(mBodyDelimiters.get(), &amp;next)) != NULL) {</span>
<a href="#l2.1120"></a><span id="l2.1120">     if (!*word) continue;</span>
<a href="#l2.1121"></a><span id="l2.1121">     if (isDecimalNumber(word)) continue;</span>
<a href="#l2.1122"></a><span id="l2.1122">     if (isASCII(word))</span>
<a href="#l2.1123"></a><span id="l2.1123" class="difflineminus">-        tokenize_ascii_word(word);</span>
<a href="#l2.1124"></a><span id="l2.1124" class="difflineplus">+      tokenize_ascii_word(word);</span>
<a href="#l2.1125"></a><span id="l2.1125">     else if (isJapanese(word))</span>
<a href="#l2.1126"></a><span id="l2.1126" class="difflineminus">-        tokenize_japanese_word(word);</span>
<a href="#l2.1127"></a><span id="l2.1127" class="difflineplus">+      tokenize_japanese_word(word);</span>
<a href="#l2.1128"></a><span id="l2.1128">     else {</span>
<a href="#l2.1129"></a><span id="l2.1129" class="difflineminus">-        nsresult rv;</span>
<a href="#l2.1130"></a><span id="l2.1130" class="difflineminus">-        // Convert this word from UTF-8 into UCS2.</span>
<a href="#l2.1131"></a><span id="l2.1131" class="difflineminus">-        NS_ConvertUTF8toUTF16 uword(word);</span>
<a href="#l2.1132"></a><span id="l2.1132" class="difflineminus">-        ToLowerCase(uword);</span>
<a href="#l2.1133"></a><span id="l2.1133" class="difflineminus">-        const char16_t* utext = uword.get();</span>
<a href="#l2.1134"></a><span id="l2.1134" class="difflineminus">-        int32_t len = uword.Length(), pos = 0, begin, end;</span>
<a href="#l2.1135"></a><span id="l2.1135" class="difflineminus">-        bool gotUnit;</span>
<a href="#l2.1136"></a><span id="l2.1136" class="difflineminus">-        while (pos &lt; len) {</span>
<a href="#l2.1137"></a><span id="l2.1137" class="difflineminus">-            rv = ScannerNext(utext, len, pos, true, &amp;begin, &amp;end, &amp;gotUnit);</span>
<a href="#l2.1138"></a><span id="l2.1138" class="difflineminus">-            if (NS_SUCCEEDED(rv) &amp;&amp; gotUnit) {</span>
<a href="#l2.1139"></a><span id="l2.1139" class="difflineminus">-                NS_ConvertUTF16toUTF8 utfUnit(utext + begin, end - begin);</span>
<a href="#l2.1140"></a><span id="l2.1140" class="difflineminus">-                add(utfUnit.get());</span>
<a href="#l2.1141"></a><span id="l2.1141" class="difflineminus">-                // Advance to end of current unit.</span>
<a href="#l2.1142"></a><span id="l2.1142" class="difflineminus">-                pos = end;</span>
<a href="#l2.1143"></a><span id="l2.1143" class="difflineminus">-            } else {</span>
<a href="#l2.1144"></a><span id="l2.1144" class="difflineminus">-                break;</span>
<a href="#l2.1145"></a><span id="l2.1145" class="difflineminus">-            }</span>
<a href="#l2.1146"></a><span id="l2.1146" class="difflineplus">+      nsresult rv;</span>
<a href="#l2.1147"></a><span id="l2.1147" class="difflineplus">+      // Convert this word from UTF-8 into UCS2.</span>
<a href="#l2.1148"></a><span id="l2.1148" class="difflineplus">+      NS_ConvertUTF8toUTF16 uword(word);</span>
<a href="#l2.1149"></a><span id="l2.1149" class="difflineplus">+      ToLowerCase(uword);</span>
<a href="#l2.1150"></a><span id="l2.1150" class="difflineplus">+      const char16_t* utext = uword.get();</span>
<a href="#l2.1151"></a><span id="l2.1151" class="difflineplus">+      int32_t len = uword.Length(), pos = 0, begin, end;</span>
<a href="#l2.1152"></a><span id="l2.1152" class="difflineplus">+      bool gotUnit;</span>
<a href="#l2.1153"></a><span id="l2.1153" class="difflineplus">+      while (pos &lt; len) {</span>
<a href="#l2.1154"></a><span id="l2.1154" class="difflineplus">+        rv = ScannerNext(utext, len, pos, true, &amp;begin, &amp;end, &amp;gotUnit);</span>
<a href="#l2.1155"></a><span id="l2.1155" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; gotUnit) {</span>
<a href="#l2.1156"></a><span id="l2.1156" class="difflineplus">+          NS_ConvertUTF16toUTF8 utfUnit(utext + begin, end - begin);</span>
<a href="#l2.1157"></a><span id="l2.1157" class="difflineplus">+          add(utfUnit.get());</span>
<a href="#l2.1158"></a><span id="l2.1158" class="difflineplus">+          // Advance to end of current unit.</span>
<a href="#l2.1159"></a><span id="l2.1159" class="difflineplus">+          pos = end;</span>
<a href="#l2.1160"></a><span id="l2.1160" class="difflineplus">+        } else {</span>
<a href="#l2.1161"></a><span id="l2.1161" class="difflineplus">+          break;</span>
<a href="#l2.1162"></a><span id="l2.1162">         }</span>
<a href="#l2.1163"></a><span id="l2.1163" class="difflineplus">+      }</span>
<a href="#l2.1164"></a><span id="l2.1164">     }</span>
<a href="#l2.1165"></a><span id="l2.1165">   }</span>
<a href="#l2.1166"></a><span id="l2.1166"> }</span>
<a href="#l2.1167"></a><span id="l2.1167"> </span>
<a href="#l2.1168"></a><span id="l2.1168"> // helper function to un-escape \n, \t, etc from a CString</span>
<a href="#l2.1169"></a><span id="l2.1169" class="difflineminus">-void Tokenizer::UnescapeCString(nsCString&amp; aCString)</span>
<a href="#l2.1170"></a><span id="l2.1170" class="difflineminus">-{</span>
<a href="#l2.1171"></a><span id="l2.1171" class="difflineplus">+void Tokenizer::UnescapeCString(nsCString&amp; aCString) {</span>
<a href="#l2.1172"></a><span id="l2.1172">   nsAutoCString result;</span>
<a href="#l2.1173"></a><span id="l2.1173"> </span>
<a href="#l2.1174"></a><span id="l2.1174">   const char* readEnd = aCString.EndReading();</span>
<a href="#l2.1175"></a><span id="l2.1175">   result.SetLength(aCString.Length());</span>
<a href="#l2.1176"></a><span id="l2.1176">   char* writeStart = result.BeginWriting();</span>
<a href="#l2.1177"></a><span id="l2.1177">   char* writeIter = writeStart;</span>
<a href="#l2.1178"></a><span id="l2.1178"> </span>
<a href="#l2.1179"></a><span id="l2.1179">   bool inEscape = false;</span>
<a href="#l2.1180"></a><span id="l2.1180" class="difflineminus">-  for (const char* readIter = aCString.BeginReading(); readIter != readEnd; readIter++)</span>
<a href="#l2.1181"></a><span id="l2.1181" class="difflineminus">-  {</span>
<a href="#l2.1182"></a><span id="l2.1182" class="difflineminus">-    if (!inEscape)</span>
<a href="#l2.1183"></a><span id="l2.1183" class="difflineminus">-    {</span>
<a href="#l2.1184"></a><span id="l2.1184" class="difflineplus">+  for (const char* readIter = aCString.BeginReading(); readIter != readEnd;</span>
<a href="#l2.1185"></a><span id="l2.1185" class="difflineplus">+       readIter++) {</span>
<a href="#l2.1186"></a><span id="l2.1186" class="difflineplus">+    if (!inEscape) {</span>
<a href="#l2.1187"></a><span id="l2.1187">       if (*readIter == '\\')</span>
<a href="#l2.1188"></a><span id="l2.1188">         inEscape = true;</span>
<a href="#l2.1189"></a><span id="l2.1189">       else</span>
<a href="#l2.1190"></a><span id="l2.1190">         *(writeIter++) = *readIter;</span>
<a href="#l2.1191"></a><span id="l2.1191" class="difflineminus">-    }</span>
<a href="#l2.1192"></a><span id="l2.1192" class="difflineminus">-    else</span>
<a href="#l2.1193"></a><span id="l2.1193" class="difflineminus">-    {</span>
<a href="#l2.1194"></a><span id="l2.1194" class="difflineplus">+    } else {</span>
<a href="#l2.1195"></a><span id="l2.1195">       inEscape = false;</span>
<a href="#l2.1196"></a><span id="l2.1196" class="difflineminus">-      switch (*readIter)</span>
<a href="#l2.1197"></a><span id="l2.1197" class="difflineminus">-      {</span>
<a href="#l2.1198"></a><span id="l2.1198" class="difflineplus">+      switch (*readIter) {</span>
<a href="#l2.1199"></a><span id="l2.1199">         case '\\':</span>
<a href="#l2.1200"></a><span id="l2.1200">           *(writeIter++) = '\\';</span>
<a href="#l2.1201"></a><span id="l2.1201">           break;</span>
<a href="#l2.1202"></a><span id="l2.1202">         case 't':</span>
<a href="#l2.1203"></a><span id="l2.1203">           *(writeIter++) = '\t';</span>
<a href="#l2.1204"></a><span id="l2.1204">           break;</span>
<a href="#l2.1205"></a><span id="l2.1205">         case 'n':</span>
<a href="#l2.1206"></a><span id="l2.1206">           *(writeIter++) = '\n';</span>
<a href="#l2.1207"></a><span id="l2.1207" class="difflineat">@@ -891,18 +840,17 @@ void Tokenizer::UnescapeCString(nsCStrin</span>
<a href="#l2.1208"></a><span id="l2.1208">           break;</span>
<a href="#l2.1209"></a><span id="l2.1209">       }</span>
<a href="#l2.1210"></a><span id="l2.1210">     }</span>
<a href="#l2.1211"></a><span id="l2.1211">   }</span>
<a href="#l2.1212"></a><span id="l2.1212">   result.Truncate(writeIter - writeStart);</span>
<a href="#l2.1213"></a><span id="l2.1213">   aCString.Assign(result);</span>
<a href="#l2.1214"></a><span id="l2.1214"> }</span>
<a href="#l2.1215"></a><span id="l2.1215"> </span>
<a href="#l2.1216"></a><span id="l2.1216" class="difflineminus">-Token* Tokenizer::copyTokens()</span>
<a href="#l2.1217"></a><span id="l2.1217" class="difflineminus">-{</span>
<a href="#l2.1218"></a><span id="l2.1218" class="difflineplus">+Token* Tokenizer::copyTokens() {</span>
<a href="#l2.1219"></a><span id="l2.1219">   uint32_t count = countTokens();</span>
<a href="#l2.1220"></a><span id="l2.1220">   if (count &gt; 0) {</span>
<a href="#l2.1221"></a><span id="l2.1221">     Token* tokens = new Token[count];</span>
<a href="#l2.1222"></a><span id="l2.1222">     if (tokens) {</span>
<a href="#l2.1223"></a><span id="l2.1223">       Token* tp = tokens;</span>
<a href="#l2.1224"></a><span id="l2.1224">       TokenEnumeration e(&amp;mTokenTable);</span>
<a href="#l2.1225"></a><span id="l2.1225">       while (e.hasMoreTokens()) {</span>
<a href="#l2.1226"></a><span id="l2.1226">         Token* src = static_cast&lt;Token*&gt;(e.nextToken());</span>
<a href="#l2.1227"></a><span id="l2.1227" class="difflineat">@@ -911,488 +859,465 @@ Token* Tokenizer::copyTokens()</span>
<a href="#l2.1228"></a><span id="l2.1228">       }</span>
<a href="#l2.1229"></a><span id="l2.1229">     }</span>
<a href="#l2.1230"></a><span id="l2.1230">     return tokens;</span>
<a href="#l2.1231"></a><span id="l2.1231">   }</span>
<a href="#l2.1232"></a><span id="l2.1232">   return NULL;</span>
<a href="#l2.1233"></a><span id="l2.1233"> }</span>
<a href="#l2.1234"></a><span id="l2.1234"> </span>
<a href="#l2.1235"></a><span id="l2.1235"> class TokenAnalyzer {</span>
<a href="#l2.1236"></a><span id="l2.1236" class="difflineminus">-public:</span>
<a href="#l2.1237"></a><span id="l2.1237" class="difflineminus">-    virtual ~TokenAnalyzer() {}</span>
<a href="#l2.1238"></a><span id="l2.1238" class="difflineplus">+ public:</span>
<a href="#l2.1239"></a><span id="l2.1239" class="difflineplus">+  virtual ~TokenAnalyzer() {}</span>
<a href="#l2.1240"></a><span id="l2.1240"> </span>
<a href="#l2.1241"></a><span id="l2.1241" class="difflineminus">-    virtual void analyzeTokens(Tokenizer&amp; tokenizer) = 0;</span>
<a href="#l2.1242"></a><span id="l2.1242" class="difflineminus">-    void setTokenListener(nsIStreamListener *aTokenListener)</span>
<a href="#l2.1243"></a><span id="l2.1243" class="difflineminus">-    {</span>
<a href="#l2.1244"></a><span id="l2.1244" class="difflineminus">-      mTokenListener = aTokenListener;</span>
<a href="#l2.1245"></a><span id="l2.1245" class="difflineminus">-    }</span>
<a href="#l2.1246"></a><span id="l2.1246" class="difflineplus">+  virtual void analyzeTokens(Tokenizer&amp; tokenizer) = 0;</span>
<a href="#l2.1247"></a><span id="l2.1247" class="difflineplus">+  void setTokenListener(nsIStreamListener* aTokenListener) {</span>
<a href="#l2.1248"></a><span id="l2.1248" class="difflineplus">+    mTokenListener = aTokenListener;</span>
<a href="#l2.1249"></a><span id="l2.1249" class="difflineplus">+  }</span>
<a href="#l2.1250"></a><span id="l2.1250"> </span>
<a href="#l2.1251"></a><span id="l2.1251" class="difflineminus">-    void setSource(const char *sourceURI) {mTokenSource = sourceURI;}</span>
<a href="#l2.1252"></a><span id="l2.1252" class="difflineplus">+  void setSource(const char* sourceURI) { mTokenSource = sourceURI; }</span>
<a href="#l2.1253"></a><span id="l2.1253"> </span>
<a href="#l2.1254"></a><span id="l2.1254" class="difflineminus">-    nsCOMPtr&lt;nsIStreamListener&gt; mTokenListener;</span>
<a href="#l2.1255"></a><span id="l2.1255" class="difflineminus">-    nsCString mTokenSource;</span>
<a href="#l2.1256"></a><span id="l2.1256" class="difflineminus">-</span>
<a href="#l2.1257"></a><span id="l2.1257" class="difflineplus">+  nsCOMPtr&lt;nsIStreamListener&gt; mTokenListener;</span>
<a href="#l2.1258"></a><span id="l2.1258" class="difflineplus">+  nsCString mTokenSource;</span>
<a href="#l2.1259"></a><span id="l2.1259"> };</span>
<a href="#l2.1260"></a><span id="l2.1260"> </span>
<a href="#l2.1261"></a><span id="l2.1261"> /**</span>
<a href="#l2.1262"></a><span id="l2.1262">  * This class downloads the raw content of an email message, buffering until</span>
<a href="#l2.1263"></a><span id="l2.1263">  * complete segments are seen, that is until a linefeed is seen, although</span>
<a href="#l2.1264"></a><span id="l2.1264">  * any of the valid token separators would do. This could be a further</span>
<a href="#l2.1265"></a><span id="l2.1265">  * refinement.</span>
<a href="#l2.1266"></a><span id="l2.1266">  */</span>
<a href="#l2.1267"></a><span id="l2.1267"> class TokenStreamListener : public nsIStreamListener, nsIMsgHeaderSink {</span>
<a href="#l2.1268"></a><span id="l2.1268" class="difflineminus">-public:</span>
<a href="#l2.1269"></a><span id="l2.1269" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l2.1270"></a><span id="l2.1270" class="difflineminus">-    NS_DECL_NSIREQUESTOBSERVER</span>
<a href="#l2.1271"></a><span id="l2.1271" class="difflineminus">-    NS_DECL_NSISTREAMLISTENER</span>
<a href="#l2.1272"></a><span id="l2.1272" class="difflineminus">-    NS_DECL_NSIMSGHEADERSINK</span>
<a href="#l2.1273"></a><span id="l2.1273" class="difflineplus">+ public:</span>
<a href="#l2.1274"></a><span id="l2.1274" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l2.1275"></a><span id="l2.1275" class="difflineplus">+  NS_DECL_NSIREQUESTOBSERVER</span>
<a href="#l2.1276"></a><span id="l2.1276" class="difflineplus">+  NS_DECL_NSISTREAMLISTENER</span>
<a href="#l2.1277"></a><span id="l2.1277" class="difflineplus">+  NS_DECL_NSIMSGHEADERSINK</span>
<a href="#l2.1278"></a><span id="l2.1278" class="difflineplus">+</span>
<a href="#l2.1279"></a><span id="l2.1279" class="difflineplus">+  explicit TokenStreamListener(TokenAnalyzer* analyzer);</span>
<a href="#l2.1280"></a><span id="l2.1280"> </span>
<a href="#l2.1281"></a><span id="l2.1281" class="difflineminus">-    explicit TokenStreamListener(TokenAnalyzer* analyzer);</span>
<a href="#l2.1282"></a><span id="l2.1282" class="difflineminus">-protected:</span>
<a href="#l2.1283"></a><span id="l2.1283" class="difflineminus">-    virtual ~TokenStreamListener();</span>
<a href="#l2.1284"></a><span id="l2.1284" class="difflineminus">-    TokenAnalyzer* mAnalyzer;</span>
<a href="#l2.1285"></a><span id="l2.1285" class="difflineminus">-    char* mBuffer;</span>
<a href="#l2.1286"></a><span id="l2.1286" class="difflineminus">-    uint32_t mBufferSize;</span>
<a href="#l2.1287"></a><span id="l2.1287" class="difflineminus">-    uint32_t mLeftOverCount;</span>
<a href="#l2.1288"></a><span id="l2.1288" class="difflineminus">-    Tokenizer mTokenizer;</span>
<a href="#l2.1289"></a><span id="l2.1289" class="difflineminus">-    bool mSetAttachmentFlag;</span>
<a href="#l2.1290"></a><span id="l2.1290" class="difflineplus">+ protected:</span>
<a href="#l2.1291"></a><span id="l2.1291" class="difflineplus">+  virtual ~TokenStreamListener();</span>
<a href="#l2.1292"></a><span id="l2.1292" class="difflineplus">+  TokenAnalyzer* mAnalyzer;</span>
<a href="#l2.1293"></a><span id="l2.1293" class="difflineplus">+  char* mBuffer;</span>
<a href="#l2.1294"></a><span id="l2.1294" class="difflineplus">+  uint32_t mBufferSize;</span>
<a href="#l2.1295"></a><span id="l2.1295" class="difflineplus">+  uint32_t mLeftOverCount;</span>
<a href="#l2.1296"></a><span id="l2.1296" class="difflineplus">+  Tokenizer mTokenizer;</span>
<a href="#l2.1297"></a><span id="l2.1297" class="difflineplus">+  bool mSetAttachmentFlag;</span>
<a href="#l2.1298"></a><span id="l2.1298"> };</span>
<a href="#l2.1299"></a><span id="l2.1299"> </span>
<a href="#l2.1300"></a><span id="l2.1300"> const uint32_t kBufferSize = 16384;</span>
<a href="#l2.1301"></a><span id="l2.1301"> </span>
<a href="#l2.1302"></a><span id="l2.1302"> TokenStreamListener::TokenStreamListener(TokenAnalyzer* analyzer)</span>
<a href="#l2.1303"></a><span id="l2.1303" class="difflineminus">-    :   mAnalyzer(analyzer),</span>
<a href="#l2.1304"></a><span id="l2.1304" class="difflineminus">-        mBuffer(NULL), mBufferSize(kBufferSize), mLeftOverCount(0),</span>
<a href="#l2.1305"></a><span id="l2.1305" class="difflineminus">-        mSetAttachmentFlag(false)</span>
<a href="#l2.1306"></a><span id="l2.1306" class="difflineminus">-{</span>
<a href="#l2.1307"></a><span id="l2.1307" class="difflineminus">-}</span>
<a href="#l2.1308"></a><span id="l2.1308" class="difflineplus">+    : mAnalyzer(analyzer),</span>
<a href="#l2.1309"></a><span id="l2.1309" class="difflineplus">+      mBuffer(NULL),</span>
<a href="#l2.1310"></a><span id="l2.1310" class="difflineplus">+      mBufferSize(kBufferSize),</span>
<a href="#l2.1311"></a><span id="l2.1311" class="difflineplus">+      mLeftOverCount(0),</span>
<a href="#l2.1312"></a><span id="l2.1312" class="difflineplus">+      mSetAttachmentFlag(false) {}</span>
<a href="#l2.1313"></a><span id="l2.1313"> </span>
<a href="#l2.1314"></a><span id="l2.1314" class="difflineminus">-TokenStreamListener::~TokenStreamListener()</span>
<a href="#l2.1315"></a><span id="l2.1315" class="difflineminus">-{</span>
<a href="#l2.1316"></a><span id="l2.1316" class="difflineminus">-    delete[] mBuffer;</span>
<a href="#l2.1317"></a><span id="l2.1317" class="difflineminus">-    delete mAnalyzer;</span>
<a href="#l2.1318"></a><span id="l2.1318" class="difflineplus">+TokenStreamListener::~TokenStreamListener() {</span>
<a href="#l2.1319"></a><span id="l2.1319" class="difflineplus">+  delete[] mBuffer;</span>
<a href="#l2.1320"></a><span id="l2.1320" class="difflineplus">+  delete mAnalyzer;</span>
<a href="#l2.1321"></a><span id="l2.1321"> }</span>
<a href="#l2.1322"></a><span id="l2.1322"> </span>
<a href="#l2.1323"></a><span id="l2.1323" class="difflineminus">-NS_IMPL_ISUPPORTS(TokenStreamListener, nsIRequestObserver, nsIStreamListener, nsIMsgHeaderSink)</span>
<a href="#l2.1324"></a><span id="l2.1324" class="difflineplus">+NS_IMPL_ISUPPORTS(TokenStreamListener, nsIRequestObserver, nsIStreamListener,</span>
<a href="#l2.1325"></a><span id="l2.1325" class="difflineplus">+                  nsIMsgHeaderSink)</span>
<a href="#l2.1326"></a><span id="l2.1326"> </span>
<a href="#l2.1327"></a><span id="l2.1327" class="difflineminus">-NS_IMETHODIMP TokenStreamListener::ProcessHeaders(nsIUTF8StringEnumerator *aHeaderNames, nsIUTF8StringEnumerator *aHeaderValues, bool dontCollectAddress)</span>
<a href="#l2.1328"></a><span id="l2.1328" class="difflineminus">-{</span>
<a href="#l2.1329"></a><span id="l2.1329" class="difflineminus">-    mTokenizer.tokenizeHeaders(aHeaderNames, aHeaderValues);</span>
<a href="#l2.1330"></a><span id="l2.1330" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.1331"></a><span id="l2.1331" class="difflineplus">+NS_IMETHODIMP TokenStreamListener::ProcessHeaders(</span>
<a href="#l2.1332"></a><span id="l2.1332" class="difflineplus">+    nsIUTF8StringEnumerator* aHeaderNames,</span>
<a href="#l2.1333"></a><span id="l2.1333" class="difflineplus">+    nsIUTF8StringEnumerator* aHeaderValues, bool dontCollectAddress) {</span>
<a href="#l2.1334"></a><span id="l2.1334" class="difflineplus">+  mTokenizer.tokenizeHeaders(aHeaderNames, aHeaderValues);</span>
<a href="#l2.1335"></a><span id="l2.1335" class="difflineplus">+  return NS_OK;</span>
<a href="#l2.1336"></a><span id="l2.1336"> }</span>
<a href="#l2.1337"></a><span id="l2.1337"> </span>
<a href="#l2.1338"></a><span id="l2.1338" class="difflineminus">-NS_IMETHODIMP TokenStreamListener::HandleAttachment(const char *contentType, const char *url, const char16_t *displayName, const char *uri, bool aIsExternalAttachment)</span>
<a href="#l2.1339"></a><span id="l2.1339" class="difflineminus">-{</span>
<a href="#l2.1340"></a><span id="l2.1340" class="difflineminus">-    mTokenizer.tokenizeAttachment(contentType, NS_ConvertUTF16toUTF8(displayName).get());</span>
<a href="#l2.1341"></a><span id="l2.1341" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.1342"></a><span id="l2.1342" class="difflineminus">-}</span>
<a href="#l2.1343"></a><span id="l2.1343" class="difflineminus">-</span>
<a href="#l2.1344"></a><span id="l2.1344" class="difflineminus">-NS_IMETHODIMP TokenStreamListener::AddAttachmentField(const char *field, const char *value)</span>
<a href="#l2.1345"></a><span id="l2.1345" class="difflineminus">-{</span>
<a href="#l2.1346"></a><span id="l2.1346" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.1347"></a><span id="l2.1347" class="difflineplus">+NS_IMETHODIMP TokenStreamListener::HandleAttachment(</span>
<a href="#l2.1348"></a><span id="l2.1348" class="difflineplus">+    const char* contentType, const char* url, const char16_t* displayName,</span>
<a href="#l2.1349"></a><span id="l2.1349" class="difflineplus">+    const char* uri, bool aIsExternalAttachment) {</span>
<a href="#l2.1350"></a><span id="l2.1350" class="difflineplus">+  mTokenizer.tokenizeAttachment(contentType,</span>
<a href="#l2.1351"></a><span id="l2.1351" class="difflineplus">+                                NS_ConvertUTF16toUTF8(displayName).get());</span>
<a href="#l2.1352"></a><span id="l2.1352" class="difflineplus">+  return NS_OK;</span>
<a href="#l2.1353"></a><span id="l2.1353"> }</span>
<a href="#l2.1354"></a><span id="l2.1354"> </span>
<a href="#l2.1355"></a><span id="l2.1355" class="difflineminus">-NS_IMETHODIMP TokenStreamListener::OnEndAllAttachments()</span>
<a href="#l2.1356"></a><span id="l2.1356" class="difflineminus">-{</span>
<a href="#l2.1357"></a><span id="l2.1357" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.1358"></a><span id="l2.1358" class="difflineplus">+NS_IMETHODIMP TokenStreamListener::AddAttachmentField(const char* field,</span>
<a href="#l2.1359"></a><span id="l2.1359" class="difflineplus">+                                                      const char* value) {</span>
<a href="#l2.1360"></a><span id="l2.1360" class="difflineplus">+  return NS_OK;</span>
<a href="#l2.1361"></a><span id="l2.1361"> }</span>
<a href="#l2.1362"></a><span id="l2.1362"> </span>
<a href="#l2.1363"></a><span id="l2.1363" class="difflineminus">-NS_IMETHODIMP TokenStreamListener::OnEndMsgDownload(nsIMsgMailNewsUrl *url)</span>
<a href="#l2.1364"></a><span id="l2.1364" class="difflineminus">-{</span>
<a href="#l2.1365"></a><span id="l2.1365" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.1366"></a><span id="l2.1366" class="difflineminus">-}</span>
<a href="#l2.1367"></a><span id="l2.1367" class="difflineminus">-</span>
<a href="#l2.1368"></a><span id="l2.1368" class="difflineplus">+NS_IMETHODIMP TokenStreamListener::OnEndAllAttachments() { return NS_OK; }</span>
<a href="#l2.1369"></a><span id="l2.1369"> </span>
<a href="#l2.1370"></a><span id="l2.1370" class="difflineminus">-NS_IMETHODIMP TokenStreamListener::OnMsgHasRemoteContent(nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l2.1371"></a><span id="l2.1371" class="difflineminus">-                                                         nsIURI *aContentURI,</span>
<a href="#l2.1372"></a><span id="l2.1372" class="difflineminus">-                                                         bool aCanOverride)</span>
<a href="#l2.1373"></a><span id="l2.1373" class="difflineminus">-{</span>
<a href="#l2.1374"></a><span id="l2.1374" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.1375"></a><span id="l2.1375" class="difflineplus">+NS_IMETHODIMP TokenStreamListener::OnEndMsgDownload(nsIMsgMailNewsUrl* url) {</span>
<a href="#l2.1376"></a><span id="l2.1376" class="difflineplus">+  return NS_OK;</span>
<a href="#l2.1377"></a><span id="l2.1377"> }</span>
<a href="#l2.1378"></a><span id="l2.1378"> </span>
<a href="#l2.1379"></a><span id="l2.1379" class="difflineminus">-NS_IMETHODIMP TokenStreamListener::OnEndMsgHeaders(nsIMsgMailNewsUrl *url)</span>
<a href="#l2.1380"></a><span id="l2.1380" class="difflineminus">-{</span>
<a href="#l2.1381"></a><span id="l2.1381" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.1382"></a><span id="l2.1382" class="difflineplus">+NS_IMETHODIMP TokenStreamListener::OnMsgHasRemoteContent(nsIMsgDBHdr* aMsgHdr,</span>
<a href="#l2.1383"></a><span id="l2.1383" class="difflineplus">+                                                         nsIURI* aContentURI,</span>
<a href="#l2.1384"></a><span id="l2.1384" class="difflineplus">+                                                         bool aCanOverride) {</span>
<a href="#l2.1385"></a><span id="l2.1385" class="difflineplus">+  return NS_OK;</span>
<a href="#l2.1386"></a><span id="l2.1386" class="difflineplus">+}</span>
<a href="#l2.1387"></a><span id="l2.1387" class="difflineplus">+</span>
<a href="#l2.1388"></a><span id="l2.1388" class="difflineplus">+NS_IMETHODIMP TokenStreamListener::OnEndMsgHeaders(nsIMsgMailNewsUrl* url) {</span>
<a href="#l2.1389"></a><span id="l2.1389" class="difflineplus">+  return NS_OK;</span>
<a href="#l2.1390"></a><span id="l2.1390"> }</span>
<a href="#l2.1391"></a><span id="l2.1391"> </span>
<a href="#l2.1392"></a><span id="l2.1392" class="difflineminus">-</span>
<a href="#l2.1393"></a><span id="l2.1393" class="difflineminus">-NS_IMETHODIMP TokenStreamListener::GetSecurityInfo(nsISupports * *aSecurityInfo)</span>
<a href="#l2.1394"></a><span id="l2.1394" class="difflineminus">-{</span>
<a href="#l2.1395"></a><span id="l2.1395" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.1396"></a><span id="l2.1396" class="difflineplus">+NS_IMETHODIMP TokenStreamListener::GetSecurityInfo(</span>
<a href="#l2.1397"></a><span id="l2.1397" class="difflineplus">+    nsISupports** aSecurityInfo) {</span>
<a href="#l2.1398"></a><span id="l2.1398" class="difflineplus">+  return NS_OK;</span>
<a href="#l2.1399"></a><span id="l2.1399"> }</span>
<a href="#l2.1400"></a><span id="l2.1400" class="difflineminus">-NS_IMETHODIMP TokenStreamListener::SetSecurityInfo(nsISupports * aSecurityInfo)</span>
<a href="#l2.1401"></a><span id="l2.1401" class="difflineminus">-{</span>
<a href="#l2.1402"></a><span id="l2.1402" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.1403"></a><span id="l2.1403" class="difflineplus">+NS_IMETHODIMP TokenStreamListener::SetSecurityInfo(nsISupports* aSecurityInfo) {</span>
<a href="#l2.1404"></a><span id="l2.1404" class="difflineplus">+  return NS_OK;</span>
<a href="#l2.1405"></a><span id="l2.1405"> }</span>
<a href="#l2.1406"></a><span id="l2.1406"> </span>
<a href="#l2.1407"></a><span id="l2.1407" class="difflineminus">-NS_IMETHODIMP TokenStreamListener::GetDummyMsgHeader(nsIMsgDBHdr **aMsgDBHdr)</span>
<a href="#l2.1408"></a><span id="l2.1408" class="difflineminus">-{</span>
<a href="#l2.1409"></a><span id="l2.1409" class="difflineplus">+NS_IMETHODIMP TokenStreamListener::GetDummyMsgHeader(nsIMsgDBHdr** aMsgDBHdr) {</span>
<a href="#l2.1410"></a><span id="l2.1410">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l2.1411"></a><span id="l2.1411"> }</span>
<a href="#l2.1412"></a><span id="l2.1412"> </span>
<a href="#l2.1413"></a><span id="l2.1413" class="difflineminus">-NS_IMETHODIMP TokenStreamListener::ResetProperties()</span>
<a href="#l2.1414"></a><span id="l2.1414" class="difflineminus">-{</span>
<a href="#l2.1415"></a><span id="l2.1415" class="difflineminus">-  return NS_OK;</span>
<a href="#l2.1416"></a><span id="l2.1416" class="difflineminus">-}</span>
<a href="#l2.1417"></a><span id="l2.1417" class="difflineplus">+NS_IMETHODIMP TokenStreamListener::ResetProperties() { return NS_OK; }</span>
<a href="#l2.1418"></a><span id="l2.1418"> </span>
<a href="#l2.1419"></a><span id="l2.1419" class="difflineminus">-NS_IMETHODIMP TokenStreamListener::GetProperties(nsIWritablePropertyBag2 * *aProperties)</span>
<a href="#l2.1420"></a><span id="l2.1420" class="difflineminus">-{</span>
<a href="#l2.1421"></a><span id="l2.1421" class="difflineplus">+NS_IMETHODIMP TokenStreamListener::GetProperties(</span>
<a href="#l2.1422"></a><span id="l2.1422" class="difflineplus">+    nsIWritablePropertyBag2** aProperties) {</span>
<a href="#l2.1423"></a><span id="l2.1423">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l2.1424"></a><span id="l2.1424"> }</span>
<a href="#l2.1425"></a><span id="l2.1425"> </span>
<a href="#l2.1426"></a><span id="l2.1426"> /* void onStartRequest (in nsIRequest aRequest); */</span>
<a href="#l2.1427"></a><span id="l2.1427" class="difflineminus">-NS_IMETHODIMP TokenStreamListener::OnStartRequest(nsIRequest *aRequest)</span>
<a href="#l2.1428"></a><span id="l2.1428" class="difflineminus">-{</span>
<a href="#l2.1429"></a><span id="l2.1429" class="difflineminus">-    mLeftOverCount = 0;</span>
<a href="#l2.1430"></a><span id="l2.1430" class="difflineminus">-    if (!mBuffer)</span>
<a href="#l2.1431"></a><span id="l2.1431" class="difflineminus">-    {</span>
<a href="#l2.1432"></a><span id="l2.1432" class="difflineminus">-        mBuffer = new char[mBufferSize];</span>
<a href="#l2.1433"></a><span id="l2.1433" class="difflineminus">-        NS_ENSURE_TRUE(mBuffer, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l2.1434"></a><span id="l2.1434" class="difflineminus">-    }</span>
<a href="#l2.1435"></a><span id="l2.1435" class="difflineplus">+NS_IMETHODIMP TokenStreamListener::OnStartRequest(nsIRequest* aRequest) {</span>
<a href="#l2.1436"></a><span id="l2.1436" class="difflineplus">+  mLeftOverCount = 0;</span>
<a href="#l2.1437"></a><span id="l2.1437" class="difflineplus">+  if (!mBuffer) {</span>
<a href="#l2.1438"></a><span id="l2.1438" class="difflineplus">+    mBuffer = new char[mBufferSize];</span>
<a href="#l2.1439"></a><span id="l2.1439" class="difflineplus">+    NS_ENSURE_TRUE(mBuffer, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l2.1440"></a><span id="l2.1440" class="difflineplus">+  }</span>
<a href="#l2.1441"></a><span id="l2.1441"> </span>
<a href="#l2.1442"></a><span id="l2.1442" class="difflineminus">-    // get the url for the channel and set our nsIMsgHeaderSink on it so we get notified</span>
<a href="#l2.1443"></a><span id="l2.1443" class="difflineminus">-    // about the headers and attachments</span>
<a href="#l2.1444"></a><span id="l2.1444" class="difflineplus">+  // get the url for the channel and set our nsIMsgHeaderSink on it so we get</span>
<a href="#l2.1445"></a><span id="l2.1445" class="difflineplus">+  // notified about the headers and attachments</span>
<a href="#l2.1446"></a><span id="l2.1446"> </span>
<a href="#l2.1447"></a><span id="l2.1447" class="difflineminus">-    nsCOMPtr&lt;nsIChannel&gt; channel (do_QueryInterface(aRequest));</span>
<a href="#l2.1448"></a><span id="l2.1448" class="difflineminus">-    if (channel)</span>
<a href="#l2.1449"></a><span id="l2.1449" class="difflineminus">-    {</span>
<a href="#l2.1450"></a><span id="l2.1450" class="difflineminus">-        nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l2.1451"></a><span id="l2.1451" class="difflineminus">-        channel-&gt;GetURI(getter_AddRefs(uri));</span>
<a href="#l2.1452"></a><span id="l2.1452" class="difflineminus">-        nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailUrl = do_QueryInterface(uri);</span>
<a href="#l2.1453"></a><span id="l2.1453" class="difflineminus">-        if (mailUrl)</span>
<a href="#l2.1454"></a><span id="l2.1454" class="difflineminus">-            mailUrl-&gt;SetMsgHeaderSink(static_cast&lt;nsIMsgHeaderSink*&gt;(this));</span>
<a href="#l2.1455"></a><span id="l2.1455" class="difflineminus">-    }</span>
<a href="#l2.1456"></a><span id="l2.1456" class="difflineplus">+  nsCOMPtr&lt;nsIChannel&gt; channel(do_QueryInterface(aRequest));</span>
<a href="#l2.1457"></a><span id="l2.1457" class="difflineplus">+  if (channel) {</span>
<a href="#l2.1458"></a><span id="l2.1458" class="difflineplus">+    nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l2.1459"></a><span id="l2.1459" class="difflineplus">+    channel-&gt;GetURI(getter_AddRefs(uri));</span>
<a href="#l2.1460"></a><span id="l2.1460" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailUrl = do_QueryInterface(uri);</span>
<a href="#l2.1461"></a><span id="l2.1461" class="difflineplus">+    if (mailUrl)</span>
<a href="#l2.1462"></a><span id="l2.1462" class="difflineplus">+      mailUrl-&gt;SetMsgHeaderSink(static_cast&lt;nsIMsgHeaderSink*&gt;(this));</span>
<a href="#l2.1463"></a><span id="l2.1463" class="difflineplus">+  }</span>
<a href="#l2.1464"></a><span id="l2.1464"> </span>
<a href="#l2.1465"></a><span id="l2.1465" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.1466"></a><span id="l2.1466" class="difflineplus">+  return NS_OK;</span>
<a href="#l2.1467"></a><span id="l2.1467"> }</span>
<a href="#l2.1468"></a><span id="l2.1468"> </span>
<a href="#l2.1469"></a><span id="l2.1469" class="difflineminus">-/* void onDataAvailable (in nsIRequest aRequest, in nsIInputStream aInputStream, in unsigned long long aOffset, in unsigned long aCount); */</span>
<a href="#l2.1470"></a><span id="l2.1470" class="difflineminus">-NS_IMETHODIMP TokenStreamListener::OnDataAvailable(nsIRequest *aRequest, nsIInputStream *aInputStream, uint64_t aOffset, uint32_t aCount)</span>
<a href="#l2.1471"></a><span id="l2.1471" class="difflineminus">-{</span>
<a href="#l2.1472"></a><span id="l2.1472" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l2.1473"></a><span id="l2.1473" class="difflineminus">-</span>
<a href="#l2.1474"></a><span id="l2.1474" class="difflineminus">-    while (aCount &gt; 0) {</span>
<a href="#l2.1475"></a><span id="l2.1475" class="difflineminus">-        uint32_t readCount, totalCount = (aCount + mLeftOverCount);</span>
<a href="#l2.1476"></a><span id="l2.1476" class="difflineminus">-        if (totalCount &gt;= mBufferSize) {</span>
<a href="#l2.1477"></a><span id="l2.1477" class="difflineminus">-            readCount = mBufferSize - mLeftOverCount - 1;</span>
<a href="#l2.1478"></a><span id="l2.1478" class="difflineminus">-        } else {</span>
<a href="#l2.1479"></a><span id="l2.1479" class="difflineminus">-            readCount = aCount;</span>
<a href="#l2.1480"></a><span id="l2.1480" class="difflineminus">-        }</span>
<a href="#l2.1481"></a><span id="l2.1481" class="difflineplus">+/* void onDataAvailable (in nsIRequest aRequest, in nsIInputStream aInputStream,</span>
<a href="#l2.1482"></a><span id="l2.1482" class="difflineplus">+ * in unsigned long long aOffset, in unsigned long aCount); */</span>
<a href="#l2.1483"></a><span id="l2.1483" class="difflineplus">+NS_IMETHODIMP TokenStreamListener::OnDataAvailable(nsIRequest* aRequest,</span>
<a href="#l2.1484"></a><span id="l2.1484" class="difflineplus">+                                                   nsIInputStream* aInputStream,</span>
<a href="#l2.1485"></a><span id="l2.1485" class="difflineplus">+                                                   uint64_t aOffset,</span>
<a href="#l2.1486"></a><span id="l2.1486" class="difflineplus">+                                                   uint32_t aCount) {</span>
<a href="#l2.1487"></a><span id="l2.1487" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l2.1488"></a><span id="l2.1488"> </span>
<a href="#l2.1489"></a><span id="l2.1489" class="difflineminus">-        // mBuffer is supposed to be allocated in onStartRequest. But something</span>
<a href="#l2.1490"></a><span id="l2.1490" class="difflineminus">-        // is causing that to not happen, so as a last-ditch attempt we'll</span>
<a href="#l2.1491"></a><span id="l2.1491" class="difflineminus">-        // do it here.</span>
<a href="#l2.1492"></a><span id="l2.1492" class="difflineminus">-        if (!mBuffer)</span>
<a href="#l2.1493"></a><span id="l2.1493" class="difflineminus">-        {</span>
<a href="#l2.1494"></a><span id="l2.1494" class="difflineminus">-          mBuffer = new char[mBufferSize];</span>
<a href="#l2.1495"></a><span id="l2.1495" class="difflineminus">-          NS_ENSURE_TRUE(mBuffer, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l2.1496"></a><span id="l2.1496" class="difflineminus">-        }</span>
<a href="#l2.1497"></a><span id="l2.1497" class="difflineminus">-</span>
<a href="#l2.1498"></a><span id="l2.1498" class="difflineminus">-        char* buffer = mBuffer;</span>
<a href="#l2.1499"></a><span id="l2.1499" class="difflineminus">-        rv = aInputStream-&gt;Read(buffer + mLeftOverCount, readCount, &amp;readCount);</span>
<a href="#l2.1500"></a><span id="l2.1500" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l2.1501"></a><span id="l2.1501" class="difflineminus">-            break;</span>
<a href="#l2.1502"></a><span id="l2.1502" class="difflineminus">-</span>
<a href="#l2.1503"></a><span id="l2.1503" class="difflineminus">-        if (readCount == 0) {</span>
<a href="#l2.1504"></a><span id="l2.1504" class="difflineminus">-            rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l2.1505"></a><span id="l2.1505" class="difflineminus">-            NS_WARNING(&quot;failed to tokenize&quot;);</span>
<a href="#l2.1506"></a><span id="l2.1506" class="difflineminus">-            break;</span>
<a href="#l2.1507"></a><span id="l2.1507" class="difflineminus">-        }</span>
<a href="#l2.1508"></a><span id="l2.1508" class="difflineplus">+  while (aCount &gt; 0) {</span>
<a href="#l2.1509"></a><span id="l2.1509" class="difflineplus">+    uint32_t readCount, totalCount = (aCount + mLeftOverCount);</span>
<a href="#l2.1510"></a><span id="l2.1510" class="difflineplus">+    if (totalCount &gt;= mBufferSize) {</span>
<a href="#l2.1511"></a><span id="l2.1511" class="difflineplus">+      readCount = mBufferSize - mLeftOverCount - 1;</span>
<a href="#l2.1512"></a><span id="l2.1512" class="difflineplus">+    } else {</span>
<a href="#l2.1513"></a><span id="l2.1513" class="difflineplus">+      readCount = aCount;</span>
<a href="#l2.1514"></a><span id="l2.1514" class="difflineplus">+    }</span>
<a href="#l2.1515"></a><span id="l2.1515"> </span>
<a href="#l2.1516"></a><span id="l2.1516" class="difflineminus">-        aCount -= readCount;</span>
<a href="#l2.1517"></a><span id="l2.1517" class="difflineminus">-</span>
<a href="#l2.1518"></a><span id="l2.1518" class="difflineminus">-        /* consume the tokens up to the last legal token delimiter in the buffer. */</span>
<a href="#l2.1519"></a><span id="l2.1519" class="difflineminus">-        totalCount = (readCount + mLeftOverCount);</span>
<a href="#l2.1520"></a><span id="l2.1520" class="difflineminus">-        buffer[totalCount] = '\0';</span>
<a href="#l2.1521"></a><span id="l2.1521" class="difflineminus">-        char* lastDelimiter = NULL;</span>
<a href="#l2.1522"></a><span id="l2.1522" class="difflineminus">-        char* scan = buffer + totalCount;</span>
<a href="#l2.1523"></a><span id="l2.1523" class="difflineminus">-        while (scan &gt; buffer) {</span>
<a href="#l2.1524"></a><span id="l2.1524" class="difflineminus">-            if (strchr(mTokenizer.mBodyDelimiters.get(), *--scan)) {</span>
<a href="#l2.1525"></a><span id="l2.1525" class="difflineminus">-                lastDelimiter = scan;</span>
<a href="#l2.1526"></a><span id="l2.1526" class="difflineminus">-                break;</span>
<a href="#l2.1527"></a><span id="l2.1527" class="difflineminus">-            }</span>
<a href="#l2.1528"></a><span id="l2.1528" class="difflineminus">-        }</span>
<a href="#l2.1529"></a><span id="l2.1529" class="difflineminus">-</span>
<a href="#l2.1530"></a><span id="l2.1530" class="difflineminus">-        if (lastDelimiter) {</span>
<a href="#l2.1531"></a><span id="l2.1531" class="difflineminus">-            *lastDelimiter = '\0';</span>
<a href="#l2.1532"></a><span id="l2.1532" class="difflineminus">-            mTokenizer.tokenize(buffer);</span>
<a href="#l2.1533"></a><span id="l2.1533" class="difflineplus">+    // mBuffer is supposed to be allocated in onStartRequest. But something</span>
<a href="#l2.1534"></a><span id="l2.1534" class="difflineplus">+    // is causing that to not happen, so as a last-ditch attempt we'll</span>
<a href="#l2.1535"></a><span id="l2.1535" class="difflineplus">+    // do it here.</span>
<a href="#l2.1536"></a><span id="l2.1536" class="difflineplus">+    if (!mBuffer) {</span>
<a href="#l2.1537"></a><span id="l2.1537" class="difflineplus">+      mBuffer = new char[mBufferSize];</span>
<a href="#l2.1538"></a><span id="l2.1538" class="difflineplus">+      NS_ENSURE_TRUE(mBuffer, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l2.1539"></a><span id="l2.1539" class="difflineplus">+    }</span>
<a href="#l2.1540"></a><span id="l2.1540"> </span>
<a href="#l2.1541"></a><span id="l2.1541" class="difflineminus">-            uint32_t consumedCount = 1 + (lastDelimiter - buffer);</span>
<a href="#l2.1542"></a><span id="l2.1542" class="difflineminus">-            mLeftOverCount = totalCount - consumedCount;</span>
<a href="#l2.1543"></a><span id="l2.1543" class="difflineminus">-            if (mLeftOverCount)</span>
<a href="#l2.1544"></a><span id="l2.1544" class="difflineminus">-                memmove(buffer, buffer + consumedCount, mLeftOverCount);</span>
<a href="#l2.1545"></a><span id="l2.1545" class="difflineminus">-        } else {</span>
<a href="#l2.1546"></a><span id="l2.1546" class="difflineminus">-            /* didn't find a delimiter, keep the whole buffer around. */</span>
<a href="#l2.1547"></a><span id="l2.1547" class="difflineminus">-            mLeftOverCount = totalCount;</span>
<a href="#l2.1548"></a><span id="l2.1548" class="difflineminus">-            if (totalCount &gt;= (mBufferSize / 2)) {</span>
<a href="#l2.1549"></a><span id="l2.1549" class="difflineminus">-                uint32_t newBufferSize = mBufferSize * 2;</span>
<a href="#l2.1550"></a><span id="l2.1550" class="difflineminus">-                char* newBuffer = new char[newBufferSize];</span>
<a href="#l2.1551"></a><span id="l2.1551" class="difflineminus">-                NS_ENSURE_TRUE(newBuffer, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l2.1552"></a><span id="l2.1552" class="difflineminus">-                memcpy(newBuffer, mBuffer, mLeftOverCount);</span>
<a href="#l2.1553"></a><span id="l2.1553" class="difflineminus">-                delete[] mBuffer;</span>
<a href="#l2.1554"></a><span id="l2.1554" class="difflineminus">-                mBuffer = newBuffer;</span>
<a href="#l2.1555"></a><span id="l2.1555" class="difflineminus">-                mBufferSize = newBufferSize;</span>
<a href="#l2.1556"></a><span id="l2.1556" class="difflineminus">-            }</span>
<a href="#l2.1557"></a><span id="l2.1557" class="difflineminus">-        }</span>
<a href="#l2.1558"></a><span id="l2.1558" class="difflineplus">+    char* buffer = mBuffer;</span>
<a href="#l2.1559"></a><span id="l2.1559" class="difflineplus">+    rv = aInputStream-&gt;Read(buffer + mLeftOverCount, readCount, &amp;readCount);</span>
<a href="#l2.1560"></a><span id="l2.1560" class="difflineplus">+    if (NS_FAILED(rv)) break;</span>
<a href="#l2.1561"></a><span id="l2.1561" class="difflineplus">+</span>
<a href="#l2.1562"></a><span id="l2.1562" class="difflineplus">+    if (readCount == 0) {</span>
<a href="#l2.1563"></a><span id="l2.1563" class="difflineplus">+      rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l2.1564"></a><span id="l2.1564" class="difflineplus">+      NS_WARNING(&quot;failed to tokenize&quot;);</span>
<a href="#l2.1565"></a><span id="l2.1565" class="difflineplus">+      break;</span>
<a href="#l2.1566"></a><span id="l2.1566">     }</span>
<a href="#l2.1567"></a><span id="l2.1567"> </span>
<a href="#l2.1568"></a><span id="l2.1568" class="difflineminus">-    return rv;</span>
<a href="#l2.1569"></a><span id="l2.1569" class="difflineplus">+    aCount -= readCount;</span>
<a href="#l2.1570"></a><span id="l2.1570" class="difflineplus">+</span>
<a href="#l2.1571"></a><span id="l2.1571" class="difflineplus">+    /* consume the tokens up to the last legal token delimiter in the buffer. */</span>
<a href="#l2.1572"></a><span id="l2.1572" class="difflineplus">+    totalCount = (readCount + mLeftOverCount);</span>
<a href="#l2.1573"></a><span id="l2.1573" class="difflineplus">+    buffer[totalCount] = '\0';</span>
<a href="#l2.1574"></a><span id="l2.1574" class="difflineplus">+    char* lastDelimiter = NULL;</span>
<a href="#l2.1575"></a><span id="l2.1575" class="difflineplus">+    char* scan = buffer + totalCount;</span>
<a href="#l2.1576"></a><span id="l2.1576" class="difflineplus">+    while (scan &gt; buffer) {</span>
<a href="#l2.1577"></a><span id="l2.1577" class="difflineplus">+      if (strchr(mTokenizer.mBodyDelimiters.get(), *--scan)) {</span>
<a href="#l2.1578"></a><span id="l2.1578" class="difflineplus">+        lastDelimiter = scan;</span>
<a href="#l2.1579"></a><span id="l2.1579" class="difflineplus">+        break;</span>
<a href="#l2.1580"></a><span id="l2.1580" class="difflineplus">+      }</span>
<a href="#l2.1581"></a><span id="l2.1581" class="difflineplus">+    }</span>
<a href="#l2.1582"></a><span id="l2.1582" class="difflineplus">+</span>
<a href="#l2.1583"></a><span id="l2.1583" class="difflineplus">+    if (lastDelimiter) {</span>
<a href="#l2.1584"></a><span id="l2.1584" class="difflineplus">+      *lastDelimiter = '\0';</span>
<a href="#l2.1585"></a><span id="l2.1585" class="difflineplus">+      mTokenizer.tokenize(buffer);</span>
<a href="#l2.1586"></a><span id="l2.1586" class="difflineplus">+</span>
<a href="#l2.1587"></a><span id="l2.1587" class="difflineplus">+      uint32_t consumedCount = 1 + (lastDelimiter - buffer);</span>
<a href="#l2.1588"></a><span id="l2.1588" class="difflineplus">+      mLeftOverCount = totalCount - consumedCount;</span>
<a href="#l2.1589"></a><span id="l2.1589" class="difflineplus">+      if (mLeftOverCount)</span>
<a href="#l2.1590"></a><span id="l2.1590" class="difflineplus">+        memmove(buffer, buffer + consumedCount, mLeftOverCount);</span>
<a href="#l2.1591"></a><span id="l2.1591" class="difflineplus">+    } else {</span>
<a href="#l2.1592"></a><span id="l2.1592" class="difflineplus">+      /* didn't find a delimiter, keep the whole buffer around. */</span>
<a href="#l2.1593"></a><span id="l2.1593" class="difflineplus">+      mLeftOverCount = totalCount;</span>
<a href="#l2.1594"></a><span id="l2.1594" class="difflineplus">+      if (totalCount &gt;= (mBufferSize / 2)) {</span>
<a href="#l2.1595"></a><span id="l2.1595" class="difflineplus">+        uint32_t newBufferSize = mBufferSize * 2;</span>
<a href="#l2.1596"></a><span id="l2.1596" class="difflineplus">+        char* newBuffer = new char[newBufferSize];</span>
<a href="#l2.1597"></a><span id="l2.1597" class="difflineplus">+        NS_ENSURE_TRUE(newBuffer, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l2.1598"></a><span id="l2.1598" class="difflineplus">+        memcpy(newBuffer, mBuffer, mLeftOverCount);</span>
<a href="#l2.1599"></a><span id="l2.1599" class="difflineplus">+        delete[] mBuffer;</span>
<a href="#l2.1600"></a><span id="l2.1600" class="difflineplus">+        mBuffer = newBuffer;</span>
<a href="#l2.1601"></a><span id="l2.1601" class="difflineplus">+        mBufferSize = newBufferSize;</span>
<a href="#l2.1602"></a><span id="l2.1602" class="difflineplus">+      }</span>
<a href="#l2.1603"></a><span id="l2.1603" class="difflineplus">+    }</span>
<a href="#l2.1604"></a><span id="l2.1604" class="difflineplus">+  }</span>
<a href="#l2.1605"></a><span id="l2.1605" class="difflineplus">+</span>
<a href="#l2.1606"></a><span id="l2.1606" class="difflineplus">+  return rv;</span>
<a href="#l2.1607"></a><span id="l2.1607"> }</span>
<a href="#l2.1608"></a><span id="l2.1608"> </span>
<a href="#l2.1609"></a><span id="l2.1609"> /* void onStopRequest (in nsIRequest aRequest, in nsresult aStatusCode); */</span>
<a href="#l2.1610"></a><span id="l2.1610" class="difflineminus">-NS_IMETHODIMP TokenStreamListener::OnStopRequest(nsIRequest *aRequest, nsresult aStatusCode)</span>
<a href="#l2.1611"></a><span id="l2.1611" class="difflineminus">-{</span>
<a href="#l2.1612"></a><span id="l2.1612" class="difflineminus">-    if (mLeftOverCount) {</span>
<a href="#l2.1613"></a><span id="l2.1613" class="difflineminus">-        /* assume final buffer is complete. */</span>
<a href="#l2.1614"></a><span id="l2.1614" class="difflineminus">-        mBuffer[mLeftOverCount] = '\0';</span>
<a href="#l2.1615"></a><span id="l2.1615" class="difflineminus">-        mTokenizer.tokenize(mBuffer);</span>
<a href="#l2.1616"></a><span id="l2.1616" class="difflineminus">-    }</span>
<a href="#l2.1617"></a><span id="l2.1617" class="difflineplus">+NS_IMETHODIMP TokenStreamListener::OnStopRequest(nsIRequest* aRequest,</span>
<a href="#l2.1618"></a><span id="l2.1618" class="difflineplus">+                                                 nsresult aStatusCode) {</span>
<a href="#l2.1619"></a><span id="l2.1619" class="difflineplus">+  if (mLeftOverCount) {</span>
<a href="#l2.1620"></a><span id="l2.1620" class="difflineplus">+    /* assume final buffer is complete. */</span>
<a href="#l2.1621"></a><span id="l2.1621" class="difflineplus">+    mBuffer[mLeftOverCount] = '\0';</span>
<a href="#l2.1622"></a><span id="l2.1622" class="difflineplus">+    mTokenizer.tokenize(mBuffer);</span>
<a href="#l2.1623"></a><span id="l2.1623" class="difflineplus">+  }</span>
<a href="#l2.1624"></a><span id="l2.1624"> </span>
<a href="#l2.1625"></a><span id="l2.1625" class="difflineminus">-    /* finally, analyze the tokenized message. */</span>
<a href="#l2.1626"></a><span id="l2.1626" class="difflineminus">-    MOZ_LOG(BayesianFilterLogModule, LogLevel::Debug, (&quot;analyze the tokenized message&quot;));</span>
<a href="#l2.1627"></a><span id="l2.1627" class="difflineminus">-    if (mAnalyzer)</span>
<a href="#l2.1628"></a><span id="l2.1628" class="difflineminus">-        mAnalyzer-&gt;analyzeTokens(mTokenizer);</span>
<a href="#l2.1629"></a><span id="l2.1629" class="difflineplus">+  /* finally, analyze the tokenized message. */</span>
<a href="#l2.1630"></a><span id="l2.1630" class="difflineplus">+  MOZ_LOG(BayesianFilterLogModule, LogLevel::Debug,</span>
<a href="#l2.1631"></a><span id="l2.1631" class="difflineplus">+          (&quot;analyze the tokenized message&quot;));</span>
<a href="#l2.1632"></a><span id="l2.1632" class="difflineplus">+  if (mAnalyzer) mAnalyzer-&gt;analyzeTokens(mTokenizer);</span>
<a href="#l2.1633"></a><span id="l2.1633"> </span>
<a href="#l2.1634"></a><span id="l2.1634" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.1635"></a><span id="l2.1635" class="difflineplus">+  return NS_OK;</span>
<a href="#l2.1636"></a><span id="l2.1636"> }</span>
<a href="#l2.1637"></a><span id="l2.1637"> </span>
<a href="#l2.1638"></a><span id="l2.1638"> /* Implementation file */</span>
<a href="#l2.1639"></a><span id="l2.1639"> </span>
<a href="#l2.1640"></a><span id="l2.1640" class="difflineminus">-NS_IMPL_ISUPPORTS(nsBayesianFilter, nsIMsgFilterPlugin,</span>
<a href="#l2.1641"></a><span id="l2.1641" class="difflineminus">-                   nsIJunkMailPlugin, nsIMsgCorpus, nsISupportsWeakReference,</span>
<a href="#l2.1642"></a><span id="l2.1642" class="difflineminus">-                   nsIObserver)</span>
<a href="#l2.1643"></a><span id="l2.1643" class="difflineplus">+NS_IMPL_ISUPPORTS(nsBayesianFilter, nsIMsgFilterPlugin, nsIJunkMailPlugin,</span>
<a href="#l2.1644"></a><span id="l2.1644" class="difflineplus">+                  nsIMsgCorpus, nsISupportsWeakReference, nsIObserver)</span>
<a href="#l2.1645"></a><span id="l2.1645" class="difflineplus">+</span>
<a href="#l2.1646"></a><span id="l2.1646" class="difflineplus">+nsBayesianFilter::nsBayesianFilter() : mTrainingDataDirty(false) {</span>
<a href="#l2.1647"></a><span id="l2.1647" class="difflineplus">+  int32_t junkThreshold = 0;</span>
<a href="#l2.1648"></a><span id="l2.1648" class="difflineplus">+  nsresult rv;</span>
<a href="#l2.1649"></a><span id="l2.1649" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(</span>
<a href="#l2.1650"></a><span id="l2.1650" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l2.1651"></a><span id="l2.1651" class="difflineplus">+  if (pPrefBranch)</span>
<a href="#l2.1652"></a><span id="l2.1652" class="difflineplus">+    pPrefBranch-&gt;GetIntPref(&quot;mail.adaptivefilters.junk_threshold&quot;,</span>
<a href="#l2.1653"></a><span id="l2.1653" class="difflineplus">+                            &amp;junkThreshold);</span>
<a href="#l2.1654"></a><span id="l2.1654"> </span>
<a href="#l2.1655"></a><span id="l2.1655" class="difflineminus">-nsBayesianFilter::nsBayesianFilter()</span>
<a href="#l2.1656"></a><span id="l2.1656" class="difflineminus">-    :   mTrainingDataDirty(false)</span>
<a href="#l2.1657"></a><span id="l2.1657" class="difflineminus">-{</span>
<a href="#l2.1658"></a><span id="l2.1658" class="difflineminus">-    int32_t junkThreshold = 0;</span>
<a href="#l2.1659"></a><span id="l2.1659" class="difflineminus">-    nsresult rv;</span>
<a href="#l2.1660"></a><span id="l2.1660" class="difflineminus">-    nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l2.1661"></a><span id="l2.1661" class="difflineminus">-    if (pPrefBranch)</span>
<a href="#l2.1662"></a><span id="l2.1662" class="difflineminus">-      pPrefBranch-&gt;GetIntPref(&quot;mail.adaptivefilters.junk_threshold&quot;, &amp;junkThreshold);</span>
<a href="#l2.1663"></a><span id="l2.1663" class="difflineplus">+  mJunkProbabilityThreshold = (static_cast&lt;double&gt;(junkThreshold)) / 100.0;</span>
<a href="#l2.1664"></a><span id="l2.1664" class="difflineplus">+  if (mJunkProbabilityThreshold == 0 || mJunkProbabilityThreshold &gt;= 1)</span>
<a href="#l2.1665"></a><span id="l2.1665" class="difflineplus">+    mJunkProbabilityThreshold = kDefaultJunkThreshold;</span>
<a href="#l2.1666"></a><span id="l2.1666" class="difflineplus">+</span>
<a href="#l2.1667"></a><span id="l2.1667" class="difflineplus">+  MOZ_LOG(BayesianFilterLogModule, LogLevel::Warning,</span>
<a href="#l2.1668"></a><span id="l2.1668" class="difflineplus">+          (&quot;junk probability threshold: %f&quot;, mJunkProbabilityThreshold));</span>
<a href="#l2.1669"></a><span id="l2.1669" class="difflineplus">+</span>
<a href="#l2.1670"></a><span id="l2.1670" class="difflineplus">+  mCorpus.readTrainingData();</span>
<a href="#l2.1671"></a><span id="l2.1671"> </span>
<a href="#l2.1672"></a><span id="l2.1672" class="difflineminus">-    mJunkProbabilityThreshold = (static_cast&lt;double&gt;(junkThreshold)) / 100.0;</span>
<a href="#l2.1673"></a><span id="l2.1673" class="difflineminus">-    if (mJunkProbabilityThreshold == 0 || mJunkProbabilityThreshold &gt;= 1)</span>
<a href="#l2.1674"></a><span id="l2.1674" class="difflineminus">-      mJunkProbabilityThreshold = kDefaultJunkThreshold;</span>
<a href="#l2.1675"></a><span id="l2.1675" class="difflineplus">+  // get parameters for training data flushing, from the prefs</span>
<a href="#l2.1676"></a><span id="l2.1676"> </span>
<a href="#l2.1677"></a><span id="l2.1677" class="difflineminus">-    MOZ_LOG(BayesianFilterLogModule, LogLevel::Warning, (&quot;junk probability threshold: %f&quot;, mJunkProbabilityThreshold));</span>
<a href="#l2.1678"></a><span id="l2.1678" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch;</span>
<a href="#l2.1679"></a><span id="l2.1679"> </span>
<a href="#l2.1680"></a><span id="l2.1680" class="difflineminus">-    mCorpus.readTrainingData();</span>
<a href="#l2.1681"></a><span id="l2.1681" class="difflineminus">-</span>
<a href="#l2.1682"></a><span id="l2.1682" class="difflineminus">-    // get parameters for training data flushing, from the prefs</span>
<a href="#l2.1683"></a><span id="l2.1683" class="difflineminus">-</span>
<a href="#l2.1684"></a><span id="l2.1684" class="difflineminus">-    nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch;</span>
<a href="#l2.1685"></a><span id="l2.1685" class="difflineplus">+  nsCOMPtr&lt;nsIPrefService&gt; prefs =</span>
<a href="#l2.1686"></a><span id="l2.1686" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l2.1687"></a><span id="l2.1687" class="difflineplus">+  NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed accessing preferences service&quot;);</span>
<a href="#l2.1688"></a><span id="l2.1688" class="difflineplus">+  rv = prefs-&gt;GetBranch(nullptr, getter_AddRefs(prefBranch));</span>
<a href="#l2.1689"></a><span id="l2.1689" class="difflineplus">+  NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed getting preferences branch&quot;);</span>
<a href="#l2.1690"></a><span id="l2.1690"> </span>
<a href="#l2.1691"></a><span id="l2.1691" class="difflineminus">-    nsCOMPtr&lt;nsIPrefService&gt; prefs = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l2.1692"></a><span id="l2.1692" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed accessing preferences service&quot;);</span>
<a href="#l2.1693"></a><span id="l2.1693" class="difflineminus">-    rv = prefs-&gt;GetBranch(nullptr, getter_AddRefs(prefBranch));</span>
<a href="#l2.1694"></a><span id="l2.1694" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed getting preferences branch&quot;);</span>
<a href="#l2.1695"></a><span id="l2.1695" class="difflineplus">+  rv = prefBranch-&gt;GetIntPref(</span>
<a href="#l2.1696"></a><span id="l2.1696" class="difflineplus">+      &quot;mailnews.bayesian_spam_filter.flush.minimum_interval&quot;,</span>
<a href="#l2.1697"></a><span id="l2.1697" class="difflineplus">+      &amp;mMinFlushInterval);</span>
<a href="#l2.1698"></a><span id="l2.1698" class="difflineplus">+  // it is not a good idea to allow a minimum interval of under 1 second</span>
<a href="#l2.1699"></a><span id="l2.1699" class="difflineplus">+  if (NS_FAILED(rv) || (mMinFlushInterval &lt;= 1000))</span>
<a href="#l2.1700"></a><span id="l2.1700" class="difflineplus">+    mMinFlushInterval = DEFAULT_MIN_INTERVAL_BETWEEN_WRITES;</span>
<a href="#l2.1701"></a><span id="l2.1701"> </span>
<a href="#l2.1702"></a><span id="l2.1702" class="difflineminus">-    rv = prefBranch-&gt;GetIntPref(&quot;mailnews.bayesian_spam_filter.flush.minimum_interval&quot;,&amp;mMinFlushInterval);</span>
<a href="#l2.1703"></a><span id="l2.1703" class="difflineminus">-    // it is not a good idea to allow a minimum interval of under 1 second</span>
<a href="#l2.1704"></a><span id="l2.1704" class="difflineminus">-    if (NS_FAILED(rv) || (mMinFlushInterval &lt;= 1000) )</span>
<a href="#l2.1705"></a><span id="l2.1705" class="difflineminus">-        mMinFlushInterval = DEFAULT_MIN_INTERVAL_BETWEEN_WRITES;</span>
<a href="#l2.1706"></a><span id="l2.1706" class="difflineminus">-</span>
<a href="#l2.1707"></a><span id="l2.1707" class="difflineminus">-    rv = prefBranch-&gt;GetIntPref(&quot;mailnews.bayesian_spam_filter.junk_maxtokens&quot;, &amp;mMaximumTokenCount);</span>
<a href="#l2.1708"></a><span id="l2.1708" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.1709"></a><span id="l2.1709" class="difflineminus">-      mMaximumTokenCount = 0; // which means do not limit token counts</span>
<a href="#l2.1710"></a><span id="l2.1710" class="difflineminus">-    MOZ_LOG(BayesianFilterLogModule, LogLevel::Warning, (&quot;maximum junk tokens: %d&quot;, mMaximumTokenCount));</span>
<a href="#l2.1711"></a><span id="l2.1711" class="difflineplus">+  rv = prefBranch-&gt;GetIntPref(&quot;mailnews.bayesian_spam_filter.junk_maxtokens&quot;,</span>
<a href="#l2.1712"></a><span id="l2.1712" class="difflineplus">+                              &amp;mMaximumTokenCount);</span>
<a href="#l2.1713"></a><span id="l2.1713" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l2.1714"></a><span id="l2.1714" class="difflineplus">+    mMaximumTokenCount = 0;  // which means do not limit token counts</span>
<a href="#l2.1715"></a><span id="l2.1715" class="difflineplus">+  MOZ_LOG(BayesianFilterLogModule, LogLevel::Warning,</span>
<a href="#l2.1716"></a><span id="l2.1716" class="difflineplus">+          (&quot;maximum junk tokens: %d&quot;, mMaximumTokenCount));</span>
<a href="#l2.1717"></a><span id="l2.1717"> </span>
<a href="#l2.1718"></a><span id="l2.1718" class="difflineminus">-    mTimer = do_CreateInstance(NS_TIMER_CONTRACTID, &amp;rv);</span>
<a href="#l2.1719"></a><span id="l2.1719" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;unable to create a timer; training data will only be written on exit&quot;);</span>
<a href="#l2.1720"></a><span id="l2.1720" class="difflineplus">+  mTimer = do_CreateInstance(NS_TIMER_CONTRACTID, &amp;rv);</span>
<a href="#l2.1721"></a><span id="l2.1721" class="difflineplus">+  NS_ASSERTION(</span>
<a href="#l2.1722"></a><span id="l2.1722" class="difflineplus">+      NS_SUCCEEDED(rv),</span>
<a href="#l2.1723"></a><span id="l2.1723" class="difflineplus">+      &quot;unable to create a timer; training data will only be written on exit&quot;);</span>
<a href="#l2.1724"></a><span id="l2.1724"> </span>
<a href="#l2.1725"></a><span id="l2.1725" class="difflineminus">-    // the timer is not used on object construction, since for</span>
<a href="#l2.1726"></a><span id="l2.1726" class="difflineminus">-    // the time being there are no dirying messages</span>
<a href="#l2.1727"></a><span id="l2.1727" class="difflineplus">+  // the timer is not used on object construction, since for</span>
<a href="#l2.1728"></a><span id="l2.1728" class="difflineplus">+  // the time being there are no dirying messages</span>
<a href="#l2.1729"></a><span id="l2.1729"> </span>
<a href="#l2.1730"></a><span id="l2.1730" class="difflineminus">-    // give a default capacity to the memory structure used to store</span>
<a href="#l2.1731"></a><span id="l2.1731" class="difflineminus">-    // per-message/per-trait token data</span>
<a href="#l2.1732"></a><span id="l2.1732" class="difflineminus">-    mAnalysisStore.SetCapacity(kAnalysisStoreCapacity);</span>
<a href="#l2.1733"></a><span id="l2.1733" class="difflineplus">+  // give a default capacity to the memory structure used to store</span>
<a href="#l2.1734"></a><span id="l2.1734" class="difflineplus">+  // per-message/per-trait token data</span>
<a href="#l2.1735"></a><span id="l2.1735" class="difflineplus">+  mAnalysisStore.SetCapacity(kAnalysisStoreCapacity);</span>
<a href="#l2.1736"></a><span id="l2.1736"> </span>
<a href="#l2.1737"></a><span id="l2.1737" class="difflineminus">-    // dummy 0th element. Index 0 means &quot;end of list&quot; so we need to</span>
<a href="#l2.1738"></a><span id="l2.1738" class="difflineminus">-    // start from 1</span>
<a href="#l2.1739"></a><span id="l2.1739" class="difflineminus">-    AnalysisPerToken analysisPT(0, 0.0, 0.0);</span>
<a href="#l2.1740"></a><span id="l2.1740" class="difflineminus">-    mAnalysisStore.AppendElement(analysisPT);</span>
<a href="#l2.1741"></a><span id="l2.1741" class="difflineminus">-    mNextAnalysisIndex = 1;</span>
<a href="#l2.1742"></a><span id="l2.1742" class="difflineplus">+  // dummy 0th element. Index 0 means &quot;end of list&quot; so we need to</span>
<a href="#l2.1743"></a><span id="l2.1743" class="difflineplus">+  // start from 1</span>
<a href="#l2.1744"></a><span id="l2.1744" class="difflineplus">+  AnalysisPerToken analysisPT(0, 0.0, 0.0);</span>
<a href="#l2.1745"></a><span id="l2.1745" class="difflineplus">+  mAnalysisStore.AppendElement(analysisPT);</span>
<a href="#l2.1746"></a><span id="l2.1746" class="difflineplus">+  mNextAnalysisIndex = 1;</span>
<a href="#l2.1747"></a><span id="l2.1747"> }</span>
<a href="#l2.1748"></a><span id="l2.1748"> </span>
<a href="#l2.1749"></a><span id="l2.1749" class="difflineminus">-nsresult nsBayesianFilter::Init()</span>
<a href="#l2.1750"></a><span id="l2.1750" class="difflineminus">-{</span>
<a href="#l2.1751"></a><span id="l2.1751" class="difflineplus">+nsresult nsBayesianFilter::Init() {</span>
<a href="#l2.1752"></a><span id="l2.1752">   nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l2.1753"></a><span id="l2.1753" class="difflineminus">-    mozilla::services::GetObserverService();</span>
<a href="#l2.1754"></a><span id="l2.1754" class="difflineplus">+      mozilla::services::GetObserverService();</span>
<a href="#l2.1755"></a><span id="l2.1755">   if (observerService)</span>
<a href="#l2.1756"></a><span id="l2.1756">     observerService-&gt;AddObserver(this, &quot;profile-before-change&quot;, true);</span>
<a href="#l2.1757"></a><span id="l2.1757">   return NS_OK;</span>
<a href="#l2.1758"></a><span id="l2.1758"> }</span>
<a href="#l2.1759"></a><span id="l2.1759"> </span>
<a href="#l2.1760"></a><span id="l2.1760" class="difflineminus">-void</span>
<a href="#l2.1761"></a><span id="l2.1761" class="difflineminus">-nsBayesianFilter::TimerCallback(nsITimer* aTimer, void* aClosure)</span>
<a href="#l2.1762"></a><span id="l2.1762" class="difflineminus">-{</span>
<a href="#l2.1763"></a><span id="l2.1763" class="difflineminus">-    // we will flush the training data to disk after enough time has passed</span>
<a href="#l2.1764"></a><span id="l2.1764" class="difflineminus">-    // since the first time a message has been classified after the last flush</span>
<a href="#l2.1765"></a><span id="l2.1765" class="difflineplus">+void nsBayesianFilter::TimerCallback(nsITimer* aTimer, void* aClosure) {</span>
<a href="#l2.1766"></a><span id="l2.1766" class="difflineplus">+  // we will flush the training data to disk after enough time has passed</span>
<a href="#l2.1767"></a><span id="l2.1767" class="difflineplus">+  // since the first time a message has been classified after the last flush</span>
<a href="#l2.1768"></a><span id="l2.1768"> </span>
<a href="#l2.1769"></a><span id="l2.1769" class="difflineminus">-    nsBayesianFilter *filter = static_cast&lt;nsBayesianFilter *&gt;(aClosure);</span>
<a href="#l2.1770"></a><span id="l2.1770" class="difflineminus">-    filter-&gt;mCorpus.writeTrainingData(filter-&gt;mMaximumTokenCount);</span>
<a href="#l2.1771"></a><span id="l2.1771" class="difflineminus">-    filter-&gt;mTrainingDataDirty = false;</span>
<a href="#l2.1772"></a><span id="l2.1772" class="difflineplus">+  nsBayesianFilter* filter = static_cast&lt;nsBayesianFilter*&gt;(aClosure);</span>
<a href="#l2.1773"></a><span id="l2.1773" class="difflineplus">+  filter-&gt;mCorpus.writeTrainingData(filter-&gt;mMaximumTokenCount);</span>
<a href="#l2.1774"></a><span id="l2.1774" class="difflineplus">+  filter-&gt;mTrainingDataDirty = false;</span>
<a href="#l2.1775"></a><span id="l2.1775"> }</span>
<a href="#l2.1776"></a><span id="l2.1776"> </span>
<a href="#l2.1777"></a><span id="l2.1777" class="difflineminus">-nsBayesianFilter::~nsBayesianFilter()</span>
<a href="#l2.1778"></a><span id="l2.1778" class="difflineminus">-{</span>
<a href="#l2.1779"></a><span id="l2.1779" class="difflineminus">-    if (mTimer)</span>
<a href="#l2.1780"></a><span id="l2.1780" class="difflineminus">-    {</span>
<a href="#l2.1781"></a><span id="l2.1781" class="difflineminus">-        mTimer-&gt;Cancel();</span>
<a href="#l2.1782"></a><span id="l2.1782" class="difflineminus">-        mTimer = nullptr;</span>
<a href="#l2.1783"></a><span id="l2.1783" class="difflineminus">-    }</span>
<a href="#l2.1784"></a><span id="l2.1784" class="difflineminus">-    // call shutdown when we are going away in case we need</span>
<a href="#l2.1785"></a><span id="l2.1785" class="difflineminus">-    // to flush the training set to disk</span>
<a href="#l2.1786"></a><span id="l2.1786" class="difflineminus">-    Shutdown();</span>
<a href="#l2.1787"></a><span id="l2.1787" class="difflineplus">+nsBayesianFilter::~nsBayesianFilter() {</span>
<a href="#l2.1788"></a><span id="l2.1788" class="difflineplus">+  if (mTimer) {</span>
<a href="#l2.1789"></a><span id="l2.1789" class="difflineplus">+    mTimer-&gt;Cancel();</span>
<a href="#l2.1790"></a><span id="l2.1790" class="difflineplus">+    mTimer = nullptr;</span>
<a href="#l2.1791"></a><span id="l2.1791" class="difflineplus">+  }</span>
<a href="#l2.1792"></a><span id="l2.1792" class="difflineplus">+  // call shutdown when we are going away in case we need</span>
<a href="#l2.1793"></a><span id="l2.1793" class="difflineplus">+  // to flush the training set to disk</span>
<a href="#l2.1794"></a><span id="l2.1794" class="difflineplus">+  Shutdown();</span>
<a href="#l2.1795"></a><span id="l2.1795"> }</span>
<a href="#l2.1796"></a><span id="l2.1796"> </span>
<a href="#l2.1797"></a><span id="l2.1797"> // this object is used for one call to classifyMessage or classifyMessages().</span>
<a href="#l2.1798"></a><span id="l2.1798" class="difflineminus">-// So if we're classifying multiple messages, this object will be used for each message.</span>
<a href="#l2.1799"></a><span id="l2.1799" class="difflineminus">-// It's going to hold a reference to itself, basically, to stay in memory.</span>
<a href="#l2.1800"></a><span id="l2.1800" class="difflineplus">+// So if we're classifying multiple messages, this object will be used for each</span>
<a href="#l2.1801"></a><span id="l2.1801" class="difflineplus">+// message. It's going to hold a reference to itself, basically, to stay in</span>
<a href="#l2.1802"></a><span id="l2.1802" class="difflineplus">+// memory.</span>
<a href="#l2.1803"></a><span id="l2.1803"> class MessageClassifier : public TokenAnalyzer {</span>
<a href="#l2.1804"></a><span id="l2.1804" class="difflineminus">-public:</span>
<a href="#l2.1805"></a><span id="l2.1805" class="difflineminus">-    // full classifier with arbitrary traits</span>
<a href="#l2.1806"></a><span id="l2.1806" class="difflineminus">-    MessageClassifier(nsBayesianFilter* aFilter,</span>
<a href="#l2.1807"></a><span id="l2.1807" class="difflineminus">-                      nsIJunkMailClassificationListener* aJunkListener,</span>
<a href="#l2.1808"></a><span id="l2.1808" class="difflineminus">-                      nsIMsgTraitClassificationListener* aTraitListener,</span>
<a href="#l2.1809"></a><span id="l2.1809" class="difflineminus">-                      nsIMsgTraitDetailListener* aDetailListener,</span>
<a href="#l2.1810"></a><span id="l2.1810" class="difflineminus">-                      nsTArray&lt;uint32_t&gt;&amp; aProTraits,</span>
<a href="#l2.1811"></a><span id="l2.1811" class="difflineminus">-                      nsTArray&lt;uint32_t&gt;&amp; aAntiTraits,</span>
<a href="#l2.1812"></a><span id="l2.1812" class="difflineminus">-                      nsIMsgWindow *aMsgWindow,</span>
<a href="#l2.1813"></a><span id="l2.1813" class="difflineminus">-                      uint32_t aNumMessagesToClassify,</span>
<a href="#l2.1814"></a><span id="l2.1814" class="difflineminus">-                      const char **aMessageURIs)</span>
<a href="#l2.1815"></a><span id="l2.1815" class="difflineminus">-    :   mFilter(aFilter),</span>
<a href="#l2.1816"></a><span id="l2.1816" class="difflineplus">+ public:</span>
<a href="#l2.1817"></a><span id="l2.1817" class="difflineplus">+  // full classifier with arbitrary traits</span>
<a href="#l2.1818"></a><span id="l2.1818" class="difflineplus">+  MessageClassifier(nsBayesianFilter* aFilter,</span>
<a href="#l2.1819"></a><span id="l2.1819" class="difflineplus">+                    nsIJunkMailClassificationListener* aJunkListener,</span>
<a href="#l2.1820"></a><span id="l2.1820" class="difflineplus">+                    nsIMsgTraitClassificationListener* aTraitListener,</span>
<a href="#l2.1821"></a><span id="l2.1821" class="difflineplus">+                    nsIMsgTraitDetailListener* aDetailListener,</span>
<a href="#l2.1822"></a><span id="l2.1822" class="difflineplus">+                    nsTArray&lt;uint32_t&gt;&amp; aProTraits,</span>
<a href="#l2.1823"></a><span id="l2.1823" class="difflineplus">+                    nsTArray&lt;uint32_t&gt;&amp; aAntiTraits, nsIMsgWindow* aMsgWindow,</span>
<a href="#l2.1824"></a><span id="l2.1824" class="difflineplus">+                    uint32_t aNumMessagesToClassify, const char** aMessageURIs)</span>
<a href="#l2.1825"></a><span id="l2.1825" class="difflineplus">+      : mFilter(aFilter),</span>
<a href="#l2.1826"></a><span id="l2.1826">         mJunkMailPlugin(aFilter),</span>
<a href="#l2.1827"></a><span id="l2.1827">         mJunkListener(aJunkListener),</span>
<a href="#l2.1828"></a><span id="l2.1828">         mTraitListener(aTraitListener),</span>
<a href="#l2.1829"></a><span id="l2.1829">         mDetailListener(aDetailListener),</span>
<a href="#l2.1830"></a><span id="l2.1830">         mProTraits(aProTraits),</span>
<a href="#l2.1831"></a><span id="l2.1831">         mAntiTraits(aAntiTraits),</span>
<a href="#l2.1832"></a><span id="l2.1832" class="difflineminus">-        mMsgWindow(aMsgWindow)</span>
<a href="#l2.1833"></a><span id="l2.1833" class="difflineminus">-    {</span>
<a href="#l2.1834"></a><span id="l2.1834" class="difflineminus">-      mCurMessageToClassify = 0;</span>
<a href="#l2.1835"></a><span id="l2.1835" class="difflineminus">-      mNumMessagesToClassify = aNumMessagesToClassify;</span>
<a href="#l2.1836"></a><span id="l2.1836" class="difflineminus">-      mMessageURIs = (char **) moz_xmalloc(sizeof(char *) * aNumMessagesToClassify);</span>
<a href="#l2.1837"></a><span id="l2.1837" class="difflineminus">-      for (uint32_t i = 0; i &lt; aNumMessagesToClassify; i++)</span>
<a href="#l2.1838"></a><span id="l2.1838" class="difflineminus">-        mMessageURIs[i] = PL_strdup(aMessageURIs[i]);</span>
<a href="#l2.1839"></a><span id="l2.1839" class="difflineplus">+        mMsgWindow(aMsgWindow) {</span>
<a href="#l2.1840"></a><span id="l2.1840" class="difflineplus">+    mCurMessageToClassify = 0;</span>
<a href="#l2.1841"></a><span id="l2.1841" class="difflineplus">+    mNumMessagesToClassify = aNumMessagesToClassify;</span>
<a href="#l2.1842"></a><span id="l2.1842" class="difflineplus">+    mMessageURIs = (char**)moz_xmalloc(sizeof(char*) * aNumMessagesToClassify);</span>
<a href="#l2.1843"></a><span id="l2.1843" class="difflineplus">+    for (uint32_t i = 0; i &lt; aNumMessagesToClassify; i++)</span>
<a href="#l2.1844"></a><span id="l2.1844" class="difflineplus">+      mMessageURIs[i] = PL_strdup(aMessageURIs[i]);</span>
<a href="#l2.1845"></a><span id="l2.1845" class="difflineplus">+  }</span>
<a href="#l2.1846"></a><span id="l2.1846"> </span>
<a href="#l2.1847"></a><span id="l2.1847" class="difflineminus">-    }</span>
<a href="#l2.1848"></a><span id="l2.1848" class="difflineminus">-</span>
<a href="#l2.1849"></a><span id="l2.1849" class="difflineminus">-    // junk-only classifier</span>
<a href="#l2.1850"></a><span id="l2.1850" class="difflineminus">-    MessageClassifier(nsBayesianFilter* aFilter,</span>
<a href="#l2.1851"></a><span id="l2.1851" class="difflineminus">-                      nsIJunkMailClassificationListener* aJunkListener,</span>
<a href="#l2.1852"></a><span id="l2.1852" class="difflineminus">-                      nsIMsgWindow *aMsgWindow,</span>
<a href="#l2.1853"></a><span id="l2.1853" class="difflineminus">-                      uint32_t aNumMessagesToClassify,</span>
<a href="#l2.1854"></a><span id="l2.1854" class="difflineminus">-                      const char **aMessageURIs)</span>
<a href="#l2.1855"></a><span id="l2.1855" class="difflineminus">-    :   mFilter(aFilter),</span>
<a href="#l2.1856"></a><span id="l2.1856" class="difflineplus">+  // junk-only classifier</span>
<a href="#l2.1857"></a><span id="l2.1857" class="difflineplus">+  MessageClassifier(nsBayesianFilter* aFilter,</span>
<a href="#l2.1858"></a><span id="l2.1858" class="difflineplus">+                    nsIJunkMailClassificationListener* aJunkListener,</span>
<a href="#l2.1859"></a><span id="l2.1859" class="difflineplus">+                    nsIMsgWindow* aMsgWindow, uint32_t aNumMessagesToClassify,</span>
<a href="#l2.1860"></a><span id="l2.1860" class="difflineplus">+                    const char** aMessageURIs)</span>
<a href="#l2.1861"></a><span id="l2.1861" class="difflineplus">+      : mFilter(aFilter),</span>
<a href="#l2.1862"></a><span id="l2.1862">         mJunkMailPlugin(aFilter),</span>
<a href="#l2.1863"></a><span id="l2.1863">         mJunkListener(aJunkListener),</span>
<a href="#l2.1864"></a><span id="l2.1864">         mTraitListener(nullptr),</span>
<a href="#l2.1865"></a><span id="l2.1865">         mDetailListener(nullptr),</span>
<a href="#l2.1866"></a><span id="l2.1866" class="difflineminus">-        mMsgWindow(aMsgWindow)</span>
<a href="#l2.1867"></a><span id="l2.1867" class="difflineminus">-    {</span>
<a href="#l2.1868"></a><span id="l2.1868" class="difflineminus">-      mCurMessageToClassify = 0;</span>
<a href="#l2.1869"></a><span id="l2.1869" class="difflineminus">-      mNumMessagesToClassify = aNumMessagesToClassify;</span>
<a href="#l2.1870"></a><span id="l2.1870" class="difflineminus">-      mMessageURIs = (char **) moz_xmalloc(sizeof(char *) * aNumMessagesToClassify);</span>
<a href="#l2.1871"></a><span id="l2.1871" class="difflineminus">-      for (uint32_t i = 0; i &lt; aNumMessagesToClassify; i++)</span>
<a href="#l2.1872"></a><span id="l2.1872" class="difflineminus">-        mMessageURIs[i] = PL_strdup(aMessageURIs[i]);</span>
<a href="#l2.1873"></a><span id="l2.1873" class="difflineminus">-      mProTraits.AppendElement(kJunkTrait);</span>
<a href="#l2.1874"></a><span id="l2.1874" class="difflineminus">-      mAntiTraits.AppendElement(kGoodTrait);</span>
<a href="#l2.1875"></a><span id="l2.1875" class="difflineminus">-</span>
<a href="#l2.1876"></a><span id="l2.1876" class="difflineminus">-    }</span>
<a href="#l2.1877"></a><span id="l2.1877" class="difflineplus">+        mMsgWindow(aMsgWindow) {</span>
<a href="#l2.1878"></a><span id="l2.1878" class="difflineplus">+    mCurMessageToClassify = 0;</span>
<a href="#l2.1879"></a><span id="l2.1879" class="difflineplus">+    mNumMessagesToClassify = aNumMessagesToClassify;</span>
<a href="#l2.1880"></a><span id="l2.1880" class="difflineplus">+    mMessageURIs = (char**)moz_xmalloc(sizeof(char*) * aNumMessagesToClassify);</span>
<a href="#l2.1881"></a><span id="l2.1881" class="difflineplus">+    for (uint32_t i = 0; i &lt; aNumMessagesToClassify; i++)</span>
<a href="#l2.1882"></a><span id="l2.1882" class="difflineplus">+      mMessageURIs[i] = PL_strdup(aMessageURIs[i]);</span>
<a href="#l2.1883"></a><span id="l2.1883" class="difflineplus">+    mProTraits.AppendElement(kJunkTrait);</span>
<a href="#l2.1884"></a><span id="l2.1884" class="difflineplus">+    mAntiTraits.AppendElement(kGoodTrait);</span>
<a href="#l2.1885"></a><span id="l2.1885" class="difflineplus">+  }</span>
<a href="#l2.1886"></a><span id="l2.1886"> </span>
<a href="#l2.1887"></a><span id="l2.1887" class="difflineminus">-    virtual ~MessageClassifier()</span>
<a href="#l2.1888"></a><span id="l2.1888" class="difflineminus">-    {</span>
<a href="#l2.1889"></a><span id="l2.1889" class="difflineminus">-       if (mMessageURIs)</span>
<a href="#l2.1890"></a><span id="l2.1890" class="difflineminus">-       {</span>
<a href="#l2.1891"></a><span id="l2.1891" class="difflineminus">-         NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(mNumMessagesToClassify, mMessageURIs);</span>
<a href="#l2.1892"></a><span id="l2.1892" class="difflineminus">-       }</span>
<a href="#l2.1893"></a><span id="l2.1893" class="difflineplus">+  virtual ~MessageClassifier() {</span>
<a href="#l2.1894"></a><span id="l2.1894" class="difflineplus">+    if (mMessageURIs) {</span>
<a href="#l2.1895"></a><span id="l2.1895" class="difflineplus">+      NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(mNumMessagesToClassify,</span>
<a href="#l2.1896"></a><span id="l2.1896" class="difflineplus">+                                            mMessageURIs);</span>
<a href="#l2.1897"></a><span id="l2.1897">     }</span>
<a href="#l2.1898"></a><span id="l2.1898" class="difflineminus">-    virtual void analyzeTokens(Tokenizer&amp; tokenizer)</span>
<a href="#l2.1899"></a><span id="l2.1899" class="difflineminus">-    {</span>
<a href="#l2.1900"></a><span id="l2.1900" class="difflineminus">-        mFilter-&gt;classifyMessage(tokenizer,</span>
<a href="#l2.1901"></a><span id="l2.1901" class="difflineminus">-                                 mTokenSource.get(),</span>
<a href="#l2.1902"></a><span id="l2.1902" class="difflineminus">-                                 mProTraits,</span>
<a href="#l2.1903"></a><span id="l2.1903" class="difflineminus">-                                 mAntiTraits,</span>
<a href="#l2.1904"></a><span id="l2.1904" class="difflineminus">-                                 mJunkListener,</span>
<a href="#l2.1905"></a><span id="l2.1905" class="difflineminus">-                                 mTraitListener,</span>
<a href="#l2.1906"></a><span id="l2.1906" class="difflineminus">-                                 mDetailListener);</span>
<a href="#l2.1907"></a><span id="l2.1907" class="difflineminus">-        tokenizer.clearTokens();</span>
<a href="#l2.1908"></a><span id="l2.1908" class="difflineminus">-        classifyNextMessage();</span>
<a href="#l2.1909"></a><span id="l2.1909" class="difflineminus">-    }</span>
<a href="#l2.1910"></a><span id="l2.1910" class="difflineplus">+  }</span>
<a href="#l2.1911"></a><span id="l2.1911" class="difflineplus">+  virtual void analyzeTokens(Tokenizer&amp; tokenizer) {</span>
<a href="#l2.1912"></a><span id="l2.1912" class="difflineplus">+    mFilter-&gt;classifyMessage(tokenizer, mTokenSource.get(), mProTraits,</span>
<a href="#l2.1913"></a><span id="l2.1913" class="difflineplus">+                             mAntiTraits, mJunkListener, mTraitListener,</span>
<a href="#l2.1914"></a><span id="l2.1914" class="difflineplus">+                             mDetailListener);</span>
<a href="#l2.1915"></a><span id="l2.1915" class="difflineplus">+    tokenizer.clearTokens();</span>
<a href="#l2.1916"></a><span id="l2.1916" class="difflineplus">+    classifyNextMessage();</span>
<a href="#l2.1917"></a><span id="l2.1917" class="difflineplus">+  }</span>
<a href="#l2.1918"></a><span id="l2.1918"> </span>
<a href="#l2.1919"></a><span id="l2.1919" class="difflineminus">-    virtual void classifyNextMessage()</span>
<a href="#l2.1920"></a><span id="l2.1920" class="difflineminus">-    {</span>
<a href="#l2.1921"></a><span id="l2.1921" class="difflineplus">+  virtual void classifyNextMessage() {</span>
<a href="#l2.1922"></a><span id="l2.1922" class="difflineplus">+    if (++mCurMessageToClassify &lt; mNumMessagesToClassify &amp;&amp;</span>
<a href="#l2.1923"></a><span id="l2.1923" class="difflineplus">+        mMessageURIs[mCurMessageToClassify]) {</span>
<a href="#l2.1924"></a><span id="l2.1924" class="difflineplus">+      MOZ_LOG(BayesianFilterLogModule, LogLevel::Warning,</span>
<a href="#l2.1925"></a><span id="l2.1925" class="difflineplus">+              (&quot;classifyNextMessage(%s)&quot;, mMessageURIs[mCurMessageToClassify]));</span>
<a href="#l2.1926"></a><span id="l2.1926" class="difflineplus">+      mFilter-&gt;tokenizeMessage(mMessageURIs[mCurMessageToClassify], mMsgWindow,</span>
<a href="#l2.1927"></a><span id="l2.1927" class="difflineplus">+                               this);</span>
<a href="#l2.1928"></a><span id="l2.1928" class="difflineplus">+    } else {</span>
<a href="#l2.1929"></a><span id="l2.1929" class="difflineplus">+      // call all listeners with null parameters to signify end of batch</span>
<a href="#l2.1930"></a><span id="l2.1930" class="difflineplus">+      if (mJunkListener)</span>
<a href="#l2.1931"></a><span id="l2.1931" class="difflineplus">+        mJunkListener-&gt;OnMessageClassified(nullptr,</span>
<a href="#l2.1932"></a><span id="l2.1932" class="difflineplus">+                                           nsIJunkMailPlugin::UNCLASSIFIED, 0);</span>
<a href="#l2.1933"></a><span id="l2.1933" class="difflineplus">+      if (mTraitListener)</span>
<a href="#l2.1934"></a><span id="l2.1934" class="difflineplus">+        mTraitListener-&gt;OnMessageTraitsClassified(nullptr, 0, nullptr, nullptr);</span>
<a href="#l2.1935"></a><span id="l2.1935" class="difflineplus">+      mTokenListener =</span>
<a href="#l2.1936"></a><span id="l2.1936" class="difflineplus">+          nullptr;  // this breaks the circular ref that keeps this object alive</span>
<a href="#l2.1937"></a><span id="l2.1937" class="difflineplus">+                    // so we will be destroyed as a result.</span>
<a href="#l2.1938"></a><span id="l2.1938" class="difflineplus">+    }</span>
<a href="#l2.1939"></a><span id="l2.1939" class="difflineplus">+  }</span>
<a href="#l2.1940"></a><span id="l2.1940"> </span>
<a href="#l2.1941"></a><span id="l2.1941" class="difflineminus">-      if (++mCurMessageToClassify &lt; mNumMessagesToClassify &amp;&amp; mMessageURIs[mCurMessageToClassify]) {</span>
<a href="#l2.1942"></a><span id="l2.1942" class="difflineminus">-        MOZ_LOG(BayesianFilterLogModule, LogLevel::Warning, (&quot;classifyNextMessage(%s)&quot;, mMessageURIs[mCurMessageToClassify]));</span>
<a href="#l2.1943"></a><span id="l2.1943" class="difflineminus">-        mFilter-&gt;tokenizeMessage(mMessageURIs[mCurMessageToClassify], mMsgWindow, this);</span>
<a href="#l2.1944"></a><span id="l2.1944" class="difflineminus">-      }</span>
<a href="#l2.1945"></a><span id="l2.1945" class="difflineminus">-      else</span>
<a href="#l2.1946"></a><span id="l2.1946" class="difflineminus">-      {</span>
<a href="#l2.1947"></a><span id="l2.1947" class="difflineminus">-        // call all listeners with null parameters to signify end of batch</span>
<a href="#l2.1948"></a><span id="l2.1948" class="difflineminus">-        if (mJunkListener)</span>
<a href="#l2.1949"></a><span id="l2.1949" class="difflineminus">-          mJunkListener-&gt;OnMessageClassified(nullptr, nsIJunkMailPlugin::UNCLASSIFIED, 0);</span>
<a href="#l2.1950"></a><span id="l2.1950" class="difflineminus">-        if (mTraitListener)</span>
<a href="#l2.1951"></a><span id="l2.1951" class="difflineminus">-          mTraitListener-&gt;OnMessageTraitsClassified(nullptr, 0, nullptr, nullptr);</span>
<a href="#l2.1952"></a><span id="l2.1952" class="difflineminus">-        mTokenListener = nullptr; // this breaks the circular ref that keeps this object alive</span>
<a href="#l2.1953"></a><span id="l2.1953" class="difflineminus">-                                 // so we will be destroyed as a result.</span>
<a href="#l2.1954"></a><span id="l2.1954" class="difflineminus">-      }</span>
<a href="#l2.1955"></a><span id="l2.1955" class="difflineminus">-    }</span>
<a href="#l2.1956"></a><span id="l2.1956" class="difflineminus">-</span>
<a href="#l2.1957"></a><span id="l2.1957" class="difflineminus">-private:</span>
<a href="#l2.1958"></a><span id="l2.1958" class="difflineminus">-    nsBayesianFilter* mFilter;</span>
<a href="#l2.1959"></a><span id="l2.1959" class="difflineminus">-    nsCOMPtr&lt;nsIJunkMailPlugin&gt; mJunkMailPlugin;</span>
<a href="#l2.1960"></a><span id="l2.1960" class="difflineminus">-    nsCOMPtr&lt;nsIJunkMailClassificationListener&gt; mJunkListener;</span>
<a href="#l2.1961"></a><span id="l2.1961" class="difflineminus">-    nsCOMPtr&lt;nsIMsgTraitClassificationListener&gt; mTraitListener;</span>
<a href="#l2.1962"></a><span id="l2.1962" class="difflineminus">-    nsCOMPtr&lt;nsIMsgTraitDetailListener&gt; mDetailListener;</span>
<a href="#l2.1963"></a><span id="l2.1963" class="difflineminus">-    nsTArray&lt;uint32_t&gt; mProTraits;</span>
<a href="#l2.1964"></a><span id="l2.1964" class="difflineminus">-    nsTArray&lt;uint32_t&gt; mAntiTraits;</span>
<a href="#l2.1965"></a><span id="l2.1965" class="difflineminus">-    nsCOMPtr&lt;nsIMsgWindow&gt; mMsgWindow;</span>
<a href="#l2.1966"></a><span id="l2.1966" class="difflineminus">-    int32_t mNumMessagesToClassify;</span>
<a href="#l2.1967"></a><span id="l2.1967" class="difflineminus">-    int32_t mCurMessageToClassify; // 0-based index</span>
<a href="#l2.1968"></a><span id="l2.1968" class="difflineminus">-    char **mMessageURIs;</span>
<a href="#l2.1969"></a><span id="l2.1969" class="difflineplus">+ private:</span>
<a href="#l2.1970"></a><span id="l2.1970" class="difflineplus">+  nsBayesianFilter* mFilter;</span>
<a href="#l2.1971"></a><span id="l2.1971" class="difflineplus">+  nsCOMPtr&lt;nsIJunkMailPlugin&gt; mJunkMailPlugin;</span>
<a href="#l2.1972"></a><span id="l2.1972" class="difflineplus">+  nsCOMPtr&lt;nsIJunkMailClassificationListener&gt; mJunkListener;</span>
<a href="#l2.1973"></a><span id="l2.1973" class="difflineplus">+  nsCOMPtr&lt;nsIMsgTraitClassificationListener&gt; mTraitListener;</span>
<a href="#l2.1974"></a><span id="l2.1974" class="difflineplus">+  nsCOMPtr&lt;nsIMsgTraitDetailListener&gt; mDetailListener;</span>
<a href="#l2.1975"></a><span id="l2.1975" class="difflineplus">+  nsTArray&lt;uint32_t&gt; mProTraits;</span>
<a href="#l2.1976"></a><span id="l2.1976" class="difflineplus">+  nsTArray&lt;uint32_t&gt; mAntiTraits;</span>
<a href="#l2.1977"></a><span id="l2.1977" class="difflineplus">+  nsCOMPtr&lt;nsIMsgWindow&gt; mMsgWindow;</span>
<a href="#l2.1978"></a><span id="l2.1978" class="difflineplus">+  int32_t mNumMessagesToClassify;</span>
<a href="#l2.1979"></a><span id="l2.1979" class="difflineplus">+  int32_t mCurMessageToClassify;  // 0-based index</span>
<a href="#l2.1980"></a><span id="l2.1980" class="difflineplus">+  char** mMessageURIs;</span>
<a href="#l2.1981"></a><span id="l2.1981"> };</span>
<a href="#l2.1982"></a><span id="l2.1982"> </span>
<a href="#l2.1983"></a><span id="l2.1983" class="difflineminus">-nsresult nsBayesianFilter::tokenizeMessage(const char* aMessageURI, nsIMsgWindow *aMsgWindow, TokenAnalyzer* aAnalyzer)</span>
<a href="#l2.1984"></a><span id="l2.1984" class="difflineminus">-{</span>
<a href="#l2.1985"></a><span id="l2.1985" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aMessageURI);</span>
<a href="#l2.1986"></a><span id="l2.1986" class="difflineplus">+nsresult nsBayesianFilter::tokenizeMessage(const char* aMessageURI,</span>
<a href="#l2.1987"></a><span id="l2.1987" class="difflineplus">+                                           nsIMsgWindow* aMsgWindow,</span>
<a href="#l2.1988"></a><span id="l2.1988" class="difflineplus">+                                           TokenAnalyzer* aAnalyzer) {</span>
<a href="#l2.1989"></a><span id="l2.1989" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aMessageURI);</span>
<a href="#l2.1990"></a><span id="l2.1990"> </span>
<a href="#l2.1991"></a><span id="l2.1991" class="difflineminus">-    nsCOMPtr &lt;nsIMsgMessageService&gt; msgService;</span>
<a href="#l2.1992"></a><span id="l2.1992" class="difflineminus">-    nsresult rv = GetMessageServiceFromURI(nsDependentCString(aMessageURI), getter_AddRefs(msgService));</span>
<a href="#l2.1993"></a><span id="l2.1993" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.1994"></a><span id="l2.1994" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMessageService&gt; msgService;</span>
<a href="#l2.1995"></a><span id="l2.1995" class="difflineplus">+  nsresult rv = GetMessageServiceFromURI(nsDependentCString(aMessageURI),</span>
<a href="#l2.1996"></a><span id="l2.1996" class="difflineplus">+                                         getter_AddRefs(msgService));</span>
<a href="#l2.1997"></a><span id="l2.1997" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.1998"></a><span id="l2.1998"> </span>
<a href="#l2.1999"></a><span id="l2.1999" class="difflineminus">-    aAnalyzer-&gt;setSource(aMessageURI);</span>
<a href="#l2.2000"></a><span id="l2.2000" class="difflineminus">-    nsCOMPtr&lt;nsIURI&gt; dummyNull;</span>
<a href="#l2.2001"></a><span id="l2.2001" class="difflineminus">-    return msgService-&gt;StreamMessage(aMessageURI, aAnalyzer-&gt;mTokenListener,</span>
<a href="#l2.2002"></a><span id="l2.2002" class="difflineminus">-                                     aMsgWindow, nullptr, true /* convert data */,</span>
<a href="#l2.2003"></a><span id="l2.2003" class="difflineminus">-                                     NS_LITERAL_CSTRING(&quot;filter&quot;), false, getter_AddRefs(dummyNull));</span>
<a href="#l2.2004"></a><span id="l2.2004" class="difflineplus">+  aAnalyzer-&gt;setSource(aMessageURI);</span>
<a href="#l2.2005"></a><span id="l2.2005" class="difflineplus">+  nsCOMPtr&lt;nsIURI&gt; dummyNull;</span>
<a href="#l2.2006"></a><span id="l2.2006" class="difflineplus">+  return msgService-&gt;StreamMessage(aMessageURI, aAnalyzer-&gt;mTokenListener,</span>
<a href="#l2.2007"></a><span id="l2.2007" class="difflineplus">+                                   aMsgWindow, nullptr, true /* convert data */,</span>
<a href="#l2.2008"></a><span id="l2.2008" class="difflineplus">+                                   NS_LITERAL_CSTRING(&quot;filter&quot;), false,</span>
<a href="#l2.2009"></a><span id="l2.2009" class="difflineplus">+                                   getter_AddRefs(dummyNull));</span>
<a href="#l2.2010"></a><span id="l2.2010"> }</span>
<a href="#l2.2011"></a><span id="l2.2011"> </span>
<a href="#l2.2012"></a><span id="l2.2012"> // a TraitAnalysis is the per-token representation of the statistical</span>
<a href="#l2.2013"></a><span id="l2.2013"> // calculations, basically created to group information that is then</span>
<a href="#l2.2014"></a><span id="l2.2014"> // sorted by mDistance</span>
<a href="#l2.2015"></a><span id="l2.2015" class="difflineminus">-struct TraitAnalysis</span>
<a href="#l2.2016"></a><span id="l2.2016" class="difflineminus">-{</span>
<a href="#l2.2017"></a><span id="l2.2017" class="difflineplus">+struct TraitAnalysis {</span>
<a href="#l2.2018"></a><span id="l2.2018">   uint32_t mTokenIndex;</span>
<a href="#l2.2019"></a><span id="l2.2019">   double mDistance;</span>
<a href="#l2.2020"></a><span id="l2.2020">   double mProbability;</span>
<a href="#l2.2021"></a><span id="l2.2021"> };</span>
<a href="#l2.2022"></a><span id="l2.2022"> </span>
<a href="#l2.2023"></a><span id="l2.2023"> // comparator required to sort an nsTArray</span>
<a href="#l2.2024"></a><span id="l2.2024" class="difflineminus">-class compareTraitAnalysis</span>
<a href="#l2.2025"></a><span id="l2.2025" class="difflineminus">-{</span>
<a href="#l2.2026"></a><span id="l2.2026" class="difflineminus">-public:</span>
<a href="#l2.2027"></a><span id="l2.2027" class="difflineminus">-  bool Equals(const TraitAnalysis&amp; a, const TraitAnalysis&amp; b) const</span>
<a href="#l2.2028"></a><span id="l2.2028" class="difflineminus">-  {</span>
<a href="#l2.2029"></a><span id="l2.2029" class="difflineplus">+class compareTraitAnalysis {</span>
<a href="#l2.2030"></a><span id="l2.2030" class="difflineplus">+ public:</span>
<a href="#l2.2031"></a><span id="l2.2031" class="difflineplus">+  bool Equals(const TraitAnalysis&amp; a, const TraitAnalysis&amp; b) const {</span>
<a href="#l2.2032"></a><span id="l2.2032">     return a.mDistance == b.mDistance;</span>
<a href="#l2.2033"></a><span id="l2.2033">   }</span>
<a href="#l2.2034"></a><span id="l2.2034" class="difflineminus">-  bool LessThan(const TraitAnalysis&amp; a, const TraitAnalysis&amp; b) const</span>
<a href="#l2.2035"></a><span id="l2.2035" class="difflineminus">-  {</span>
<a href="#l2.2036"></a><span id="l2.2036" class="difflineplus">+  bool LessThan(const TraitAnalysis&amp; a, const TraitAnalysis&amp; b) const {</span>
<a href="#l2.2037"></a><span id="l2.2037">     return a.mDistance &lt; b.mDistance;</span>
<a href="#l2.2038"></a><span id="l2.2038">   }</span>
<a href="#l2.2039"></a><span id="l2.2039"> };</span>
<a href="#l2.2040"></a><span id="l2.2040"> </span>
<a href="#l2.2041"></a><span id="l2.2041"> inline double dmax(double x, double y) { return (x &gt; y ? x : y); }</span>
<a href="#l2.2042"></a><span id="l2.2042"> inline double dmin(double x, double y) { return (x &lt; y ? x : y); }</span>
<a href="#l2.2043"></a><span id="l2.2043"> </span>
<a href="#l2.2044"></a><span id="l2.2044"> // Chi square functions are implemented by an incomplete gamma function.</span>
<a href="#l2.2045"></a><span id="l2.2045" class="difflineat">@@ -1402,800 +1327,727 @@ inline double dmin(double x, double y) {</span>
<a href="#l2.2046"></a><span id="l2.2046"> </span>
<a href="#l2.2047"></a><span id="l2.2047"> // Both chi2P and nsIncompleteGammaP set *error negative on domain</span>
<a href="#l2.2048"></a><span id="l2.2048"> // errors and nsIncompleteGammaP sets it posivive on internal errors.</span>
<a href="#l2.2049"></a><span id="l2.2049"> // This may be useful but the chi2P callers treat any error as fatal.</span>
<a href="#l2.2050"></a><span id="l2.2050"> </span>
<a href="#l2.2051"></a><span id="l2.2051"> // Note that converting unsigned ints to floating point can be slow on</span>
<a href="#l2.2052"></a><span id="l2.2052"> // some platforms (like Intel) so use signed quantities for the numeric</span>
<a href="#l2.2053"></a><span id="l2.2053"> // routines.</span>
<a href="#l2.2054"></a><span id="l2.2054" class="difflineminus">-static inline double chi2P (double chi2, double nu, int32_t *error)</span>
<a href="#l2.2055"></a><span id="l2.2055" class="difflineminus">-{</span>
<a href="#l2.2056"></a><span id="l2.2056" class="difflineminus">-    // domain checks; set error and return a dummy value</span>
<a href="#l2.2057"></a><span id="l2.2057" class="difflineminus">-    if (chi2 &lt; 0.0 || nu &lt;= 0.0)</span>
<a href="#l2.2058"></a><span id="l2.2058" class="difflineminus">-    {</span>
<a href="#l2.2059"></a><span id="l2.2059" class="difflineminus">-        *error = -1;</span>
<a href="#l2.2060"></a><span id="l2.2060" class="difflineminus">-        return 0.0;</span>
<a href="#l2.2061"></a><span id="l2.2061" class="difflineminus">-    }</span>
<a href="#l2.2062"></a><span id="l2.2062" class="difflineminus">-    // reversing the arguments is intentional</span>
<a href="#l2.2063"></a><span id="l2.2063" class="difflineminus">-    return nsIncompleteGammaP (nu/2.0, chi2/2.0, error);</span>
<a href="#l2.2064"></a><span id="l2.2064" class="difflineplus">+static inline double chi2P(double chi2, double nu, int32_t* error) {</span>
<a href="#l2.2065"></a><span id="l2.2065" class="difflineplus">+  // domain checks; set error and return a dummy value</span>
<a href="#l2.2066"></a><span id="l2.2066" class="difflineplus">+  if (chi2 &lt; 0.0 || nu &lt;= 0.0) {</span>
<a href="#l2.2067"></a><span id="l2.2067" class="difflineplus">+    *error = -1;</span>
<a href="#l2.2068"></a><span id="l2.2068" class="difflineplus">+    return 0.0;</span>
<a href="#l2.2069"></a><span id="l2.2069" class="difflineplus">+  }</span>
<a href="#l2.2070"></a><span id="l2.2070" class="difflineplus">+  // reversing the arguments is intentional</span>
<a href="#l2.2071"></a><span id="l2.2071" class="difflineplus">+  return nsIncompleteGammaP(nu / 2.0, chi2 / 2.0, error);</span>
<a href="#l2.2072"></a><span id="l2.2072"> }</span>
<a href="#l2.2073"></a><span id="l2.2073"> </span>
<a href="#l2.2074"></a><span id="l2.2074"> void nsBayesianFilter::classifyMessage(</span>
<a href="#l2.2075"></a><span id="l2.2075" class="difflineminus">-  Tokenizer&amp; tokenizer,</span>
<a href="#l2.2076"></a><span id="l2.2076" class="difflineminus">-  const char* messageURI,</span>
<a href="#l2.2077"></a><span id="l2.2077" class="difflineminus">-  nsTArray&lt;uint32_t&gt;&amp; aProTraits,</span>
<a href="#l2.2078"></a><span id="l2.2078" class="difflineminus">-  nsTArray&lt;uint32_t&gt;&amp; aAntiTraits,</span>
<a href="#l2.2079"></a><span id="l2.2079" class="difflineminus">-  nsIJunkMailClassificationListener* listener,</span>
<a href="#l2.2080"></a><span id="l2.2080" class="difflineminus">-  nsIMsgTraitClassificationListener* aTraitListener,</span>
<a href="#l2.2081"></a><span id="l2.2081" class="difflineminus">-  nsIMsgTraitDetailListener* aDetailListener)</span>
<a href="#l2.2082"></a><span id="l2.2082" class="difflineminus">-{</span>
<a href="#l2.2083"></a><span id="l2.2083" class="difflineminus">-    Token* tokens = tokenizer.copyTokens();</span>
<a href="#l2.2084"></a><span id="l2.2084" class="difflineminus">-    uint32_t tokenCount;</span>
<a href="#l2.2085"></a><span id="l2.2085" class="difflineminus">-    if (!tokens)</span>
<a href="#l2.2086"></a><span id="l2.2086" class="difflineminus">-    {</span>
<a href="#l2.2087"></a><span id="l2.2087" class="difflineminus">-      // This can happen with problems with UTF conversion</span>
<a href="#l2.2088"></a><span id="l2.2088" class="difflineminus">-      NS_ERROR(&quot;Trying to classify a null or invalid message&quot;);</span>
<a href="#l2.2089"></a><span id="l2.2089" class="difflineminus">-      tokenCount = 0;</span>
<a href="#l2.2090"></a><span id="l2.2090" class="difflineminus">-      // don't return so that we still call the listeners</span>
<a href="#l2.2091"></a><span id="l2.2091" class="difflineminus">-    }</span>
<a href="#l2.2092"></a><span id="l2.2092" class="difflineminus">-    else</span>
<a href="#l2.2093"></a><span id="l2.2093" class="difflineminus">-    {</span>
<a href="#l2.2094"></a><span id="l2.2094" class="difflineminus">-      tokenCount = tokenizer.countTokens();</span>
<a href="#l2.2095"></a><span id="l2.2095" class="difflineminus">-    }</span>
<a href="#l2.2096"></a><span id="l2.2096" class="difflineplus">+    Tokenizer&amp; tokenizer, const char* messageURI,</span>
<a href="#l2.2097"></a><span id="l2.2097" class="difflineplus">+    nsTArray&lt;uint32_t&gt;&amp; aProTraits, nsTArray&lt;uint32_t&gt;&amp; aAntiTraits,</span>
<a href="#l2.2098"></a><span id="l2.2098" class="difflineplus">+    nsIJunkMailClassificationListener* listener,</span>
<a href="#l2.2099"></a><span id="l2.2099" class="difflineplus">+    nsIMsgTraitClassificationListener* aTraitListener,</span>
<a href="#l2.2100"></a><span id="l2.2100" class="difflineplus">+    nsIMsgTraitDetailListener* aDetailListener) {</span>
<a href="#l2.2101"></a><span id="l2.2101" class="difflineplus">+  Token* tokens = tokenizer.copyTokens();</span>
<a href="#l2.2102"></a><span id="l2.2102" class="difflineplus">+  uint32_t tokenCount;</span>
<a href="#l2.2103"></a><span id="l2.2103" class="difflineplus">+  if (!tokens) {</span>
<a href="#l2.2104"></a><span id="l2.2104" class="difflineplus">+    // This can happen with problems with UTF conversion</span>
<a href="#l2.2105"></a><span id="l2.2105" class="difflineplus">+    NS_ERROR(&quot;Trying to classify a null or invalid message&quot;);</span>
<a href="#l2.2106"></a><span id="l2.2106" class="difflineplus">+    tokenCount = 0;</span>
<a href="#l2.2107"></a><span id="l2.2107" class="difflineplus">+    // don't return so that we still call the listeners</span>
<a href="#l2.2108"></a><span id="l2.2108" class="difflineplus">+  } else {</span>
<a href="#l2.2109"></a><span id="l2.2109" class="difflineplus">+    tokenCount = tokenizer.countTokens();</span>
<a href="#l2.2110"></a><span id="l2.2110" class="difflineplus">+  }</span>
<a href="#l2.2111"></a><span id="l2.2111"> </span>
<a href="#l2.2112"></a><span id="l2.2112" class="difflineminus">-    if (aProTraits.Length() != aAntiTraits.Length())</span>
<a href="#l2.2113"></a><span id="l2.2113" class="difflineminus">-    {</span>
<a href="#l2.2114"></a><span id="l2.2114" class="difflineminus">-      NS_ERROR(&quot;Each Pro trait needs a matching Anti trait&quot;);</span>
<a href="#l2.2115"></a><span id="l2.2115" class="difflineminus">-      return;</span>
<a href="#l2.2116"></a><span id="l2.2116" class="difflineminus">-    }</span>
<a href="#l2.2117"></a><span id="l2.2117" class="difflineplus">+  if (aProTraits.Length() != aAntiTraits.Length()) {</span>
<a href="#l2.2118"></a><span id="l2.2118" class="difflineplus">+    NS_ERROR(&quot;Each Pro trait needs a matching Anti trait&quot;);</span>
<a href="#l2.2119"></a><span id="l2.2119" class="difflineplus">+    return;</span>
<a href="#l2.2120"></a><span id="l2.2120" class="difflineplus">+  }</span>
<a href="#l2.2121"></a><span id="l2.2121"> </span>
<a href="#l2.2122"></a><span id="l2.2122" class="difflineminus">-    /* this part is similar to the Graham algorithm with some adjustments. */</span>
<a href="#l2.2123"></a><span id="l2.2123" class="difflineminus">-    uint32_t traitCount = aProTraits.Length();</span>
<a href="#l2.2124"></a><span id="l2.2124" class="difflineplus">+  /* this part is similar to the Graham algorithm with some adjustments. */</span>
<a href="#l2.2125"></a><span id="l2.2125" class="difflineplus">+  uint32_t traitCount = aProTraits.Length();</span>
<a href="#l2.2126"></a><span id="l2.2126"> </span>
<a href="#l2.2127"></a><span id="l2.2127" class="difflineminus">-    // pro message counts per trait index</span>
<a href="#l2.2128"></a><span id="l2.2128" class="difflineminus">-    AutoTArray&lt;uint32_t, kTraitAutoCapacity&gt; numProMessages;</span>
<a href="#l2.2129"></a><span id="l2.2129" class="difflineminus">-    // anti message counts per trait index</span>
<a href="#l2.2130"></a><span id="l2.2130" class="difflineminus">-    AutoTArray&lt;uint32_t, kTraitAutoCapacity&gt; numAntiMessages;</span>
<a href="#l2.2131"></a><span id="l2.2131" class="difflineminus">-    // array of pro aliases per trait index</span>
<a href="#l2.2132"></a><span id="l2.2132" class="difflineminus">-    AutoTArray&lt;uint32_t*, kTraitAutoCapacity &gt; proAliasArrays;</span>
<a href="#l2.2133"></a><span id="l2.2133" class="difflineminus">-    // number of pro aliases per trait index</span>
<a href="#l2.2134"></a><span id="l2.2134" class="difflineminus">-    AutoTArray&lt;uint32_t, kTraitAutoCapacity &gt; proAliasesLengths;</span>
<a href="#l2.2135"></a><span id="l2.2135" class="difflineminus">-    // array of anti aliases per trait index</span>
<a href="#l2.2136"></a><span id="l2.2136" class="difflineminus">-    AutoTArray&lt;uint32_t*, kTraitAutoCapacity&gt; antiAliasArrays;</span>
<a href="#l2.2137"></a><span id="l2.2137" class="difflineminus">-    // number of anti aliases per trait index</span>
<a href="#l2.2138"></a><span id="l2.2138" class="difflineminus">-    AutoTArray&lt;uint32_t, kTraitAutoCapacity &gt; antiAliasesLengths;</span>
<a href="#l2.2139"></a><span id="l2.2139" class="difflineminus">-    // construct the outgoing listener arrays</span>
<a href="#l2.2140"></a><span id="l2.2140" class="difflineminus">-    AutoTArray&lt;uint32_t, kTraitAutoCapacity&gt; traits;</span>
<a href="#l2.2141"></a><span id="l2.2141" class="difflineminus">-    AutoTArray&lt;uint32_t, kTraitAutoCapacity&gt; percents;</span>
<a href="#l2.2142"></a><span id="l2.2142" class="difflineminus">-    if (traitCount &gt; kTraitAutoCapacity)</span>
<a href="#l2.2143"></a><span id="l2.2143" class="difflineminus">-    {</span>
<a href="#l2.2144"></a><span id="l2.2144" class="difflineminus">-      traits.SetCapacity(traitCount);</span>
<a href="#l2.2145"></a><span id="l2.2145" class="difflineminus">-      percents.SetCapacity(traitCount);</span>
<a href="#l2.2146"></a><span id="l2.2146" class="difflineminus">-      numProMessages.SetCapacity(traitCount);</span>
<a href="#l2.2147"></a><span id="l2.2147" class="difflineminus">-      numAntiMessages.SetCapacity(traitCount);</span>
<a href="#l2.2148"></a><span id="l2.2148" class="difflineminus">-      proAliasesLengths.SetCapacity(traitCount);</span>
<a href="#l2.2149"></a><span id="l2.2149" class="difflineminus">-      antiAliasesLengths.SetCapacity(traitCount);</span>
<a href="#l2.2150"></a><span id="l2.2150" class="difflineminus">-      proAliasArrays.SetCapacity(traitCount);</span>
<a href="#l2.2151"></a><span id="l2.2151" class="difflineminus">-      antiAliasArrays.SetCapacity(traitCount);</span>
<a href="#l2.2152"></a><span id="l2.2152" class="difflineminus">-    }</span>
<a href="#l2.2153"></a><span id="l2.2153" class="difflineplus">+  // pro message counts per trait index</span>
<a href="#l2.2154"></a><span id="l2.2154" class="difflineplus">+  AutoTArray&lt;uint32_t, kTraitAutoCapacity&gt; numProMessages;</span>
<a href="#l2.2155"></a><span id="l2.2155" class="difflineplus">+  // anti message counts per trait index</span>
<a href="#l2.2156"></a><span id="l2.2156" class="difflineplus">+  AutoTArray&lt;uint32_t, kTraitAutoCapacity&gt; numAntiMessages;</span>
<a href="#l2.2157"></a><span id="l2.2157" class="difflineplus">+  // array of pro aliases per trait index</span>
<a href="#l2.2158"></a><span id="l2.2158" class="difflineplus">+  AutoTArray&lt;uint32_t*, kTraitAutoCapacity&gt; proAliasArrays;</span>
<a href="#l2.2159"></a><span id="l2.2159" class="difflineplus">+  // number of pro aliases per trait index</span>
<a href="#l2.2160"></a><span id="l2.2160" class="difflineplus">+  AutoTArray&lt;uint32_t, kTraitAutoCapacity&gt; proAliasesLengths;</span>
<a href="#l2.2161"></a><span id="l2.2161" class="difflineplus">+  // array of anti aliases per trait index</span>
<a href="#l2.2162"></a><span id="l2.2162" class="difflineplus">+  AutoTArray&lt;uint32_t*, kTraitAutoCapacity&gt; antiAliasArrays;</span>
<a href="#l2.2163"></a><span id="l2.2163" class="difflineplus">+  // number of anti aliases per trait index</span>
<a href="#l2.2164"></a><span id="l2.2164" class="difflineplus">+  AutoTArray&lt;uint32_t, kTraitAutoCapacity&gt; antiAliasesLengths;</span>
<a href="#l2.2165"></a><span id="l2.2165" class="difflineplus">+  // construct the outgoing listener arrays</span>
<a href="#l2.2166"></a><span id="l2.2166" class="difflineplus">+  AutoTArray&lt;uint32_t, kTraitAutoCapacity&gt; traits;</span>
<a href="#l2.2167"></a><span id="l2.2167" class="difflineplus">+  AutoTArray&lt;uint32_t, kTraitAutoCapacity&gt; percents;</span>
<a href="#l2.2168"></a><span id="l2.2168" class="difflineplus">+  if (traitCount &gt; kTraitAutoCapacity) {</span>
<a href="#l2.2169"></a><span id="l2.2169" class="difflineplus">+    traits.SetCapacity(traitCount);</span>
<a href="#l2.2170"></a><span id="l2.2170" class="difflineplus">+    percents.SetCapacity(traitCount);</span>
<a href="#l2.2171"></a><span id="l2.2171" class="difflineplus">+    numProMessages.SetCapacity(traitCount);</span>
<a href="#l2.2172"></a><span id="l2.2172" class="difflineplus">+    numAntiMessages.SetCapacity(traitCount);</span>
<a href="#l2.2173"></a><span id="l2.2173" class="difflineplus">+    proAliasesLengths.SetCapacity(traitCount);</span>
<a href="#l2.2174"></a><span id="l2.2174" class="difflineplus">+    antiAliasesLengths.SetCapacity(traitCount);</span>
<a href="#l2.2175"></a><span id="l2.2175" class="difflineplus">+    proAliasArrays.SetCapacity(traitCount);</span>
<a href="#l2.2176"></a><span id="l2.2176" class="difflineplus">+    antiAliasArrays.SetCapacity(traitCount);</span>
<a href="#l2.2177"></a><span id="l2.2177" class="difflineplus">+  }</span>
<a href="#l2.2178"></a><span id="l2.2178"> </span>
<a href="#l2.2179"></a><span id="l2.2179" class="difflineplus">+  nsresult rv;</span>
<a href="#l2.2180"></a><span id="l2.2180" class="difflineplus">+  nsCOMPtr&lt;nsIMsgTraitService&gt; traitService(</span>
<a href="#l2.2181"></a><span id="l2.2181" class="difflineplus">+      do_GetService(&quot;@mozilla.org/msg-trait-service;1&quot;, &amp;rv));</span>
<a href="#l2.2182"></a><span id="l2.2182" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l2.2183"></a><span id="l2.2183" class="difflineplus">+    NS_ERROR(&quot;Failed to get trait service&quot;);</span>
<a href="#l2.2184"></a><span id="l2.2184" class="difflineplus">+    MOZ_LOG(BayesianFilterLogModule, LogLevel::Error,</span>
<a href="#l2.2185"></a><span id="l2.2185" class="difflineplus">+            (&quot;Failed to get trait service&quot;));</span>
<a href="#l2.2186"></a><span id="l2.2186" class="difflineplus">+  }</span>
<a href="#l2.2187"></a><span id="l2.2187" class="difflineplus">+</span>
<a href="#l2.2188"></a><span id="l2.2188" class="difflineplus">+  // get aliases and message counts for the pro and anti traits</span>
<a href="#l2.2189"></a><span id="l2.2189" class="difflineplus">+  for (uint32_t traitIndex = 0; traitIndex &lt; traitCount; traitIndex++) {</span>
<a href="#l2.2190"></a><span id="l2.2190">     nsresult rv;</span>
<a href="#l2.2191"></a><span id="l2.2191" class="difflineminus">-    nsCOMPtr&lt;nsIMsgTraitService&gt; traitService(do_GetService(&quot;@mozilla.org/msg-trait-service;1&quot;, &amp;rv));</span>
<a href="#l2.2192"></a><span id="l2.2192" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.2193"></a><span id="l2.2193" class="difflineminus">-    {</span>
<a href="#l2.2194"></a><span id="l2.2194" class="difflineminus">-      NS_ERROR(&quot;Failed to get trait service&quot;);</span>
<a href="#l2.2195"></a><span id="l2.2195" class="difflineminus">-      MOZ_LOG(BayesianFilterLogModule, LogLevel::Error, (&quot;Failed to get trait service&quot;));</span>
<a href="#l2.2196"></a><span id="l2.2196" class="difflineminus">-    }</span>
<a href="#l2.2197"></a><span id="l2.2197" class="difflineminus">-</span>
<a href="#l2.2198"></a><span id="l2.2198" class="difflineminus">-    // get aliases and message counts for the pro and anti traits</span>
<a href="#l2.2199"></a><span id="l2.2199" class="difflineminus">-    for (uint32_t traitIndex = 0; traitIndex &lt; traitCount; traitIndex++)</span>
<a href="#l2.2200"></a><span id="l2.2200" class="difflineminus">-    {</span>
<a href="#l2.2201"></a><span id="l2.2201" class="difflineminus">-      nsresult rv;</span>
<a href="#l2.2202"></a><span id="l2.2202"> </span>
<a href="#l2.2203"></a><span id="l2.2203" class="difflineminus">-      // pro trait</span>
<a href="#l2.2204"></a><span id="l2.2204" class="difflineminus">-      uint32_t proAliasesLength = 0;</span>
<a href="#l2.2205"></a><span id="l2.2205" class="difflineminus">-      uint32_t* proAliases = nullptr;</span>
<a href="#l2.2206"></a><span id="l2.2206" class="difflineminus">-      uint32_t proTrait = aProTraits[traitIndex];</span>
<a href="#l2.2207"></a><span id="l2.2207" class="difflineminus">-      if (traitService)</span>
<a href="#l2.2208"></a><span id="l2.2208" class="difflineminus">-      {</span>
<a href="#l2.2209"></a><span id="l2.2209" class="difflineminus">-        rv = traitService-&gt;GetAliases(proTrait, &amp;proAliasesLength, &amp;proAliases);</span>
<a href="#l2.2210"></a><span id="l2.2210" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l2.2211"></a><span id="l2.2211" class="difflineminus">-        {</span>
<a href="#l2.2212"></a><span id="l2.2212" class="difflineminus">-          NS_ERROR(&quot;trait service failed to get aliases&quot;);</span>
<a href="#l2.2213"></a><span id="l2.2213" class="difflineminus">-          MOZ_LOG(BayesianFilterLogModule, LogLevel::Error, (&quot;trait service failed to get aliases&quot;));</span>
<a href="#l2.2214"></a><span id="l2.2214" class="difflineminus">-        }</span>
<a href="#l2.2215"></a><span id="l2.2215" class="difflineplus">+    // pro trait</span>
<a href="#l2.2216"></a><span id="l2.2216" class="difflineplus">+    uint32_t proAliasesLength = 0;</span>
<a href="#l2.2217"></a><span id="l2.2217" class="difflineplus">+    uint32_t* proAliases = nullptr;</span>
<a href="#l2.2218"></a><span id="l2.2218" class="difflineplus">+    uint32_t proTrait = aProTraits[traitIndex];</span>
<a href="#l2.2219"></a><span id="l2.2219" class="difflineplus">+    if (traitService) {</span>
<a href="#l2.2220"></a><span id="l2.2220" class="difflineplus">+      rv = traitService-&gt;GetAliases(proTrait, &amp;proAliasesLength, &amp;proAliases);</span>
<a href="#l2.2221"></a><span id="l2.2221" class="difflineplus">+      if (NS_FAILED(rv)) {</span>
<a href="#l2.2222"></a><span id="l2.2222" class="difflineplus">+        NS_ERROR(&quot;trait service failed to get aliases&quot;);</span>
<a href="#l2.2223"></a><span id="l2.2223" class="difflineplus">+        MOZ_LOG(BayesianFilterLogModule, LogLevel::Error,</span>
<a href="#l2.2224"></a><span id="l2.2224" class="difflineplus">+                (&quot;trait service failed to get aliases&quot;));</span>
<a href="#l2.2225"></a><span id="l2.2225">       }</span>
<a href="#l2.2226"></a><span id="l2.2226" class="difflineminus">-      proAliasesLengths.AppendElement(proAliasesLength);</span>
<a href="#l2.2227"></a><span id="l2.2227" class="difflineminus">-      proAliasArrays.AppendElement(proAliases);</span>
<a href="#l2.2228"></a><span id="l2.2228" class="difflineminus">-      uint32_t proMessageCount = mCorpus.getMessageCount(proTrait);</span>
<a href="#l2.2229"></a><span id="l2.2229" class="difflineminus">-      for (uint32_t aliasIndex = 0; aliasIndex &lt; proAliasesLength; aliasIndex++)</span>
<a href="#l2.2230"></a><span id="l2.2230" class="difflineminus">-        proMessageCount += mCorpus.getMessageCount(proAliases[aliasIndex]);</span>
<a href="#l2.2231"></a><span id="l2.2231" class="difflineminus">-      numProMessages.AppendElement(proMessageCount);</span>
<a href="#l2.2232"></a><span id="l2.2232" class="difflineplus">+    }</span>
<a href="#l2.2233"></a><span id="l2.2233" class="difflineplus">+    proAliasesLengths.AppendElement(proAliasesLength);</span>
<a href="#l2.2234"></a><span id="l2.2234" class="difflineplus">+    proAliasArrays.AppendElement(proAliases);</span>
<a href="#l2.2235"></a><span id="l2.2235" class="difflineplus">+    uint32_t proMessageCount = mCorpus.getMessageCount(proTrait);</span>
<a href="#l2.2236"></a><span id="l2.2236" class="difflineplus">+    for (uint32_t aliasIndex = 0; aliasIndex &lt; proAliasesLength; aliasIndex++)</span>
<a href="#l2.2237"></a><span id="l2.2237" class="difflineplus">+      proMessageCount += mCorpus.getMessageCount(proAliases[aliasIndex]);</span>
<a href="#l2.2238"></a><span id="l2.2238" class="difflineplus">+    numProMessages.AppendElement(proMessageCount);</span>
<a href="#l2.2239"></a><span id="l2.2239"> </span>
<a href="#l2.2240"></a><span id="l2.2240" class="difflineminus">-      // anti trait</span>
<a href="#l2.2241"></a><span id="l2.2241" class="difflineminus">-      uint32_t antiAliasesLength = 0;</span>
<a href="#l2.2242"></a><span id="l2.2242" class="difflineminus">-      uint32_t* antiAliases = nullptr;</span>
<a href="#l2.2243"></a><span id="l2.2243" class="difflineminus">-      uint32_t antiTrait = aAntiTraits[traitIndex];</span>
<a href="#l2.2244"></a><span id="l2.2244" class="difflineminus">-      if (traitService)</span>
<a href="#l2.2245"></a><span id="l2.2245" class="difflineminus">-      {</span>
<a href="#l2.2246"></a><span id="l2.2246" class="difflineminus">-        rv = traitService-&gt;GetAliases(antiTrait, &amp;antiAliasesLength, &amp;antiAliases);</span>
<a href="#l2.2247"></a><span id="l2.2247" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l2.2248"></a><span id="l2.2248" class="difflineminus">-        {</span>
<a href="#l2.2249"></a><span id="l2.2249" class="difflineminus">-          NS_ERROR(&quot;trait service failed to get aliases&quot;);</span>
<a href="#l2.2250"></a><span id="l2.2250" class="difflineminus">-          MOZ_LOG(BayesianFilterLogModule, LogLevel::Error, (&quot;trait service failed to get aliases&quot;));</span>
<a href="#l2.2251"></a><span id="l2.2251" class="difflineminus">-        }</span>
<a href="#l2.2252"></a><span id="l2.2252" class="difflineplus">+    // anti trait</span>
<a href="#l2.2253"></a><span id="l2.2253" class="difflineplus">+    uint32_t antiAliasesLength = 0;</span>
<a href="#l2.2254"></a><span id="l2.2254" class="difflineplus">+    uint32_t* antiAliases = nullptr;</span>
<a href="#l2.2255"></a><span id="l2.2255" class="difflineplus">+    uint32_t antiTrait = aAntiTraits[traitIndex];</span>
<a href="#l2.2256"></a><span id="l2.2256" class="difflineplus">+    if (traitService) {</span>
<a href="#l2.2257"></a><span id="l2.2257" class="difflineplus">+      rv =</span>
<a href="#l2.2258"></a><span id="l2.2258" class="difflineplus">+          traitService-&gt;GetAliases(antiTrait, &amp;antiAliasesLength, &amp;antiAliases);</span>
<a href="#l2.2259"></a><span id="l2.2259" class="difflineplus">+      if (NS_FAILED(rv)) {</span>
<a href="#l2.2260"></a><span id="l2.2260" class="difflineplus">+        NS_ERROR(&quot;trait service failed to get aliases&quot;);</span>
<a href="#l2.2261"></a><span id="l2.2261" class="difflineplus">+        MOZ_LOG(BayesianFilterLogModule, LogLevel::Error,</span>
<a href="#l2.2262"></a><span id="l2.2262" class="difflineplus">+                (&quot;trait service failed to get aliases&quot;));</span>
<a href="#l2.2263"></a><span id="l2.2263">       }</span>
<a href="#l2.2264"></a><span id="l2.2264" class="difflineminus">-      antiAliasesLengths.AppendElement(antiAliasesLength);</span>
<a href="#l2.2265"></a><span id="l2.2265" class="difflineminus">-      antiAliasArrays.AppendElement(antiAliases);</span>
<a href="#l2.2266"></a><span id="l2.2266" class="difflineminus">-      uint32_t antiMessageCount = mCorpus.getMessageCount(antiTrait);</span>
<a href="#l2.2267"></a><span id="l2.2267" class="difflineminus">-      for (uint32_t aliasIndex = 0; aliasIndex &lt; antiAliasesLength; aliasIndex++)</span>
<a href="#l2.2268"></a><span id="l2.2268" class="difflineminus">-        antiMessageCount += mCorpus.getMessageCount(antiAliases[aliasIndex]);</span>
<a href="#l2.2269"></a><span id="l2.2269" class="difflineminus">-      numAntiMessages.AppendElement(antiMessageCount);</span>
<a href="#l2.2270"></a><span id="l2.2270">     }</span>
<a href="#l2.2271"></a><span id="l2.2271" class="difflineplus">+    antiAliasesLengths.AppendElement(antiAliasesLength);</span>
<a href="#l2.2272"></a><span id="l2.2272" class="difflineplus">+    antiAliasArrays.AppendElement(antiAliases);</span>
<a href="#l2.2273"></a><span id="l2.2273" class="difflineplus">+    uint32_t antiMessageCount = mCorpus.getMessageCount(antiTrait);</span>
<a href="#l2.2274"></a><span id="l2.2274" class="difflineplus">+    for (uint32_t aliasIndex = 0; aliasIndex &lt; antiAliasesLength; aliasIndex++)</span>
<a href="#l2.2275"></a><span id="l2.2275" class="difflineplus">+      antiMessageCount += mCorpus.getMessageCount(antiAliases[aliasIndex]);</span>
<a href="#l2.2276"></a><span id="l2.2276" class="difflineplus">+    numAntiMessages.AppendElement(antiMessageCount);</span>
<a href="#l2.2277"></a><span id="l2.2277" class="difflineplus">+  }</span>
<a href="#l2.2278"></a><span id="l2.2278"> </span>
<a href="#l2.2279"></a><span id="l2.2279" class="difflineminus">-    for (uint32_t i = 0; i &lt; tokenCount; ++i)</span>
<a href="#l2.2280"></a><span id="l2.2280" class="difflineminus">-    {</span>
<a href="#l2.2281"></a><span id="l2.2281" class="difflineminus">-      Token&amp; token = tokens[i];</span>
<a href="#l2.2282"></a><span id="l2.2282" class="difflineminus">-      CorpusToken* t = mCorpus.get(token.mWord);</span>
<a href="#l2.2283"></a><span id="l2.2283" class="difflineminus">-      if (!t)</span>
<a href="#l2.2284"></a><span id="l2.2284" class="difflineminus">-        continue;</span>
<a href="#l2.2285"></a><span id="l2.2285" class="difflineminus">-      for (uint32_t traitIndex = 0; traitIndex &lt; traitCount; traitIndex++)</span>
<a href="#l2.2286"></a><span id="l2.2286" class="difflineminus">-      {</span>
<a href="#l2.2287"></a><span id="l2.2287" class="difflineminus">-        uint32_t iProCount = mCorpus.getTraitCount(t, aProTraits[traitIndex]);</span>
<a href="#l2.2288"></a><span id="l2.2288" class="difflineminus">-        // add in any counts for aliases to proTrait</span>
<a href="#l2.2289"></a><span id="l2.2289" class="difflineminus">-        for (uint32_t aliasIndex = 0; aliasIndex &lt; proAliasesLengths[traitIndex]; aliasIndex++)</span>
<a href="#l2.2290"></a><span id="l2.2290" class="difflineminus">-          iProCount += mCorpus.getTraitCount(t, proAliasArrays[traitIndex][aliasIndex]);</span>
<a href="#l2.2291"></a><span id="l2.2291" class="difflineminus">-        double proCount = static_cast&lt;double&gt;(iProCount);</span>
<a href="#l2.2292"></a><span id="l2.2292" class="difflineplus">+  for (uint32_t i = 0; i &lt; tokenCount; ++i) {</span>
<a href="#l2.2293"></a><span id="l2.2293" class="difflineplus">+    Token&amp; token = tokens[i];</span>
<a href="#l2.2294"></a><span id="l2.2294" class="difflineplus">+    CorpusToken* t = mCorpus.get(token.mWord);</span>
<a href="#l2.2295"></a><span id="l2.2295" class="difflineplus">+    if (!t) continue;</span>
<a href="#l2.2296"></a><span id="l2.2296" class="difflineplus">+    for (uint32_t traitIndex = 0; traitIndex &lt; traitCount; traitIndex++) {</span>
<a href="#l2.2297"></a><span id="l2.2297" class="difflineplus">+      uint32_t iProCount = mCorpus.getTraitCount(t, aProTraits[traitIndex]);</span>
<a href="#l2.2298"></a><span id="l2.2298" class="difflineplus">+      // add in any counts for aliases to proTrait</span>
<a href="#l2.2299"></a><span id="l2.2299" class="difflineplus">+      for (uint32_t aliasIndex = 0; aliasIndex &lt; proAliasesLengths[traitIndex];</span>
<a href="#l2.2300"></a><span id="l2.2300" class="difflineplus">+           aliasIndex++)</span>
<a href="#l2.2301"></a><span id="l2.2301" class="difflineplus">+        iProCount +=</span>
<a href="#l2.2302"></a><span id="l2.2302" class="difflineplus">+            mCorpus.getTraitCount(t, proAliasArrays[traitIndex][aliasIndex]);</span>
<a href="#l2.2303"></a><span id="l2.2303" class="difflineplus">+      double proCount = static_cast&lt;double&gt;(iProCount);</span>
<a href="#l2.2304"></a><span id="l2.2304"> </span>
<a href="#l2.2305"></a><span id="l2.2305" class="difflineminus">-        uint32_t iAntiCount = mCorpus.getTraitCount(t, aAntiTraits[traitIndex]);</span>
<a href="#l2.2306"></a><span id="l2.2306" class="difflineminus">-        // add in any counts for aliases to antiTrait</span>
<a href="#l2.2307"></a><span id="l2.2307" class="difflineminus">-        for (uint32_t aliasIndex = 0; aliasIndex &lt; antiAliasesLengths[traitIndex]; aliasIndex++)</span>
<a href="#l2.2308"></a><span id="l2.2308" class="difflineminus">-          iAntiCount += mCorpus.getTraitCount(t, antiAliasArrays[traitIndex][aliasIndex]);</span>
<a href="#l2.2309"></a><span id="l2.2309" class="difflineminus">-        double antiCount = static_cast&lt;double&gt;(iAntiCount);</span>
<a href="#l2.2310"></a><span id="l2.2310" class="difflineplus">+      uint32_t iAntiCount = mCorpus.getTraitCount(t, aAntiTraits[traitIndex]);</span>
<a href="#l2.2311"></a><span id="l2.2311" class="difflineplus">+      // add in any counts for aliases to antiTrait</span>
<a href="#l2.2312"></a><span id="l2.2312" class="difflineplus">+      for (uint32_t aliasIndex = 0; aliasIndex &lt; antiAliasesLengths[traitIndex];</span>
<a href="#l2.2313"></a><span id="l2.2313" class="difflineplus">+           aliasIndex++)</span>
<a href="#l2.2314"></a><span id="l2.2314" class="difflineplus">+        iAntiCount +=</span>
<a href="#l2.2315"></a><span id="l2.2315" class="difflineplus">+            mCorpus.getTraitCount(t, antiAliasArrays[traitIndex][aliasIndex]);</span>
<a href="#l2.2316"></a><span id="l2.2316" class="difflineplus">+      double antiCount = static_cast&lt;double&gt;(iAntiCount);</span>
<a href="#l2.2317"></a><span id="l2.2317"> </span>
<a href="#l2.2318"></a><span id="l2.2318" class="difflineminus">-        double prob, denom;</span>
<a href="#l2.2319"></a><span id="l2.2319" class="difflineminus">-        // Prevent a divide by zero error by setting defaults for prob</span>
<a href="#l2.2320"></a><span id="l2.2320" class="difflineplus">+      double prob, denom;</span>
<a href="#l2.2321"></a><span id="l2.2321" class="difflineplus">+      // Prevent a divide by zero error by setting defaults for prob</span>
<a href="#l2.2322"></a><span id="l2.2322"> </span>
<a href="#l2.2323"></a><span id="l2.2323" class="difflineminus">-        // If there are no matching tokens at all, ignore.</span>
<a href="#l2.2324"></a><span id="l2.2324" class="difflineminus">-        if (antiCount == 0.0 &amp;&amp; proCount == 0.0)</span>
<a href="#l2.2325"></a><span id="l2.2325" class="difflineminus">-          continue;</span>
<a href="#l2.2326"></a><span id="l2.2326" class="difflineminus">-        // if only anti match, set probability to 0%</span>
<a href="#l2.2327"></a><span id="l2.2327" class="difflineminus">-        if (proCount == 0.0)</span>
<a href="#l2.2328"></a><span id="l2.2328" class="difflineminus">-          prob = 0.0;</span>
<a href="#l2.2329"></a><span id="l2.2329" class="difflineminus">-        // if only pro match, set probability to 100%</span>
<a href="#l2.2330"></a><span id="l2.2330" class="difflineminus">-        else if (antiCount == 0.0)</span>
<a href="#l2.2331"></a><span id="l2.2331" class="difflineminus">-          prob = 1.0;</span>
<a href="#l2.2332"></a><span id="l2.2332" class="difflineminus">-        // not really needed, but just to be sure check the denom as well</span>
<a href="#l2.2333"></a><span id="l2.2333" class="difflineminus">-        else if ((denom = proCount * numAntiMessages[traitIndex] +</span>
<a href="#l2.2334"></a><span id="l2.2334" class="difflineminus">-                          antiCount * numProMessages[traitIndex]) == 0.0)</span>
<a href="#l2.2335"></a><span id="l2.2335" class="difflineminus">-          continue;</span>
<a href="#l2.2336"></a><span id="l2.2336" class="difflineminus">-        else</span>
<a href="#l2.2337"></a><span id="l2.2337" class="difflineminus">-          prob = (proCount * numAntiMessages[traitIndex]) / denom;</span>
<a href="#l2.2338"></a><span id="l2.2338" class="difflineplus">+      // If there are no matching tokens at all, ignore.</span>
<a href="#l2.2339"></a><span id="l2.2339" class="difflineplus">+      if (antiCount == 0.0 &amp;&amp; proCount == 0.0) continue;</span>
<a href="#l2.2340"></a><span id="l2.2340" class="difflineplus">+      // if only anti match, set probability to 0%</span>
<a href="#l2.2341"></a><span id="l2.2341" class="difflineplus">+      if (proCount == 0.0) prob = 0.0;</span>
<a href="#l2.2342"></a><span id="l2.2342" class="difflineplus">+      // if only pro match, set probability to 100%</span>
<a href="#l2.2343"></a><span id="l2.2343" class="difflineplus">+      else if (antiCount == 0.0)</span>
<a href="#l2.2344"></a><span id="l2.2344" class="difflineplus">+        prob = 1.0;</span>
<a href="#l2.2345"></a><span id="l2.2345" class="difflineplus">+      // not really needed, but just to be sure check the denom as well</span>
<a href="#l2.2346"></a><span id="l2.2346" class="difflineplus">+      else if ((denom = proCount * numAntiMessages[traitIndex] +</span>
<a href="#l2.2347"></a><span id="l2.2347" class="difflineplus">+                        antiCount * numProMessages[traitIndex]) == 0.0)</span>
<a href="#l2.2348"></a><span id="l2.2348" class="difflineplus">+        continue;</span>
<a href="#l2.2349"></a><span id="l2.2349" class="difflineplus">+      else</span>
<a href="#l2.2350"></a><span id="l2.2350" class="difflineplus">+        prob = (proCount * numAntiMessages[traitIndex]) / denom;</span>
<a href="#l2.2351"></a><span id="l2.2351"> </span>
<a href="#l2.2352"></a><span id="l2.2352" class="difflineminus">-        double n = proCount + antiCount;</span>
<a href="#l2.2353"></a><span id="l2.2353" class="difflineminus">-        prob =  (0.225 + n * prob) / (.45 + n);</span>
<a href="#l2.2354"></a><span id="l2.2354" class="difflineminus">-        double distance = std::abs(prob - 0.5);</span>
<a href="#l2.2355"></a><span id="l2.2355" class="difflineminus">-        if (distance &gt;= .1)</span>
<a href="#l2.2356"></a><span id="l2.2356" class="difflineminus">-        {</span>
<a href="#l2.2357"></a><span id="l2.2357" class="difflineminus">-          mozilla::DebugOnly&lt;nsresult&gt; rv = setAnalysis(token, traitIndex, distance, prob);</span>
<a href="#l2.2358"></a><span id="l2.2358" class="difflineminus">-          NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Problem in setAnalysis&quot;);</span>
<a href="#l2.2359"></a><span id="l2.2359" class="difflineminus">-        }</span>
<a href="#l2.2360"></a><span id="l2.2360" class="difflineplus">+      double n = proCount + antiCount;</span>
<a href="#l2.2361"></a><span id="l2.2361" class="difflineplus">+      prob = (0.225 + n * prob) / (.45 + n);</span>
<a href="#l2.2362"></a><span id="l2.2362" class="difflineplus">+      double distance = std::abs(prob - 0.5);</span>
<a href="#l2.2363"></a><span id="l2.2363" class="difflineplus">+      if (distance &gt;= .1) {</span>
<a href="#l2.2364"></a><span id="l2.2364" class="difflineplus">+        mozilla::DebugOnly&lt;nsresult&gt; rv =</span>
<a href="#l2.2365"></a><span id="l2.2365" class="difflineplus">+            setAnalysis(token, traitIndex, distance, prob);</span>
<a href="#l2.2366"></a><span id="l2.2366" class="difflineplus">+        NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Problem in setAnalysis&quot;);</span>
<a href="#l2.2367"></a><span id="l2.2367" class="difflineplus">+      }</span>
<a href="#l2.2368"></a><span id="l2.2368" class="difflineplus">+    }</span>
<a href="#l2.2369"></a><span id="l2.2369" class="difflineplus">+  }</span>
<a href="#l2.2370"></a><span id="l2.2370" class="difflineplus">+</span>
<a href="#l2.2371"></a><span id="l2.2371" class="difflineplus">+  for (uint32_t traitIndex = 0; traitIndex &lt; traitCount; traitIndex++) {</span>
<a href="#l2.2372"></a><span id="l2.2372" class="difflineplus">+    AutoTArray&lt;TraitAnalysis, 1024&gt; traitAnalyses;</span>
<a href="#l2.2373"></a><span id="l2.2373" class="difflineplus">+    // copy valid tokens into an array to sort</span>
<a href="#l2.2374"></a><span id="l2.2374" class="difflineplus">+    for (uint32_t tokenIndex = 0; tokenIndex &lt; tokenCount; tokenIndex++) {</span>
<a href="#l2.2375"></a><span id="l2.2375" class="difflineplus">+      uint32_t storeIndex = getAnalysisIndex(tokens[tokenIndex], traitIndex);</span>
<a href="#l2.2376"></a><span id="l2.2376" class="difflineplus">+      if (storeIndex) {</span>
<a href="#l2.2377"></a><span id="l2.2377" class="difflineplus">+        TraitAnalysis ta = {tokenIndex, mAnalysisStore[storeIndex].mDistance,</span>
<a href="#l2.2378"></a><span id="l2.2378" class="difflineplus">+                            mAnalysisStore[storeIndex].mProbability};</span>
<a href="#l2.2379"></a><span id="l2.2379" class="difflineplus">+        traitAnalyses.AppendElement(ta);</span>
<a href="#l2.2380"></a><span id="l2.2380">       }</span>
<a href="#l2.2381"></a><span id="l2.2381">     }</span>
<a href="#l2.2382"></a><span id="l2.2382"> </span>
<a href="#l2.2383"></a><span id="l2.2383" class="difflineminus">-    for (uint32_t traitIndex = 0; traitIndex &lt; traitCount; traitIndex++)</span>
<a href="#l2.2384"></a><span id="l2.2384" class="difflineminus">-    {</span>
<a href="#l2.2385"></a><span id="l2.2385" class="difflineminus">-      AutoTArray&lt;TraitAnalysis, 1024&gt; traitAnalyses;</span>
<a href="#l2.2386"></a><span id="l2.2386" class="difflineminus">-      // copy valid tokens into an array to sort</span>
<a href="#l2.2387"></a><span id="l2.2387" class="difflineminus">-      for (uint32_t tokenIndex = 0; tokenIndex &lt; tokenCount; tokenIndex++)</span>
<a href="#l2.2388"></a><span id="l2.2388" class="difflineminus">-      {</span>
<a href="#l2.2389"></a><span id="l2.2389" class="difflineminus">-        uint32_t storeIndex = getAnalysisIndex(tokens[tokenIndex], traitIndex);</span>
<a href="#l2.2390"></a><span id="l2.2390" class="difflineminus">-        if (storeIndex)</span>
<a href="#l2.2391"></a><span id="l2.2391" class="difflineminus">-        {</span>
<a href="#l2.2392"></a><span id="l2.2392" class="difflineminus">-          TraitAnalysis ta =</span>
<a href="#l2.2393"></a><span id="l2.2393" class="difflineminus">-            {tokenIndex,</span>
<a href="#l2.2394"></a><span id="l2.2394" class="difflineminus">-             mAnalysisStore[storeIndex].mDistance,</span>
<a href="#l2.2395"></a><span id="l2.2395" class="difflineminus">-             mAnalysisStore[storeIndex].mProbability};</span>
<a href="#l2.2396"></a><span id="l2.2396" class="difflineminus">-          traitAnalyses.AppendElement(ta);</span>
<a href="#l2.2397"></a><span id="l2.2397" class="difflineminus">-        }</span>
<a href="#l2.2398"></a><span id="l2.2398" class="difflineminus">-      }</span>
<a href="#l2.2399"></a><span id="l2.2399" class="difflineplus">+    // sort the array by the distances</span>
<a href="#l2.2400"></a><span id="l2.2400" class="difflineplus">+    traitAnalyses.Sort(compareTraitAnalysis());</span>
<a href="#l2.2401"></a><span id="l2.2401" class="difflineplus">+    uint32_t count = traitAnalyses.Length();</span>
<a href="#l2.2402"></a><span id="l2.2402" class="difflineplus">+    uint32_t first, last = count;</span>
<a href="#l2.2403"></a><span id="l2.2403" class="difflineplus">+    const uint32_t kMaxTokens = 150;</span>
<a href="#l2.2404"></a><span id="l2.2404" class="difflineplus">+    first = (count &gt; kMaxTokens) ? count - kMaxTokens : 0;</span>
<a href="#l2.2405"></a><span id="l2.2405"> </span>
<a href="#l2.2406"></a><span id="l2.2406" class="difflineminus">-      // sort the array by the distances</span>
<a href="#l2.2407"></a><span id="l2.2407" class="difflineminus">-      traitAnalyses.Sort(compareTraitAnalysis());</span>
<a href="#l2.2408"></a><span id="l2.2408" class="difflineminus">-      uint32_t count = traitAnalyses.Length();</span>
<a href="#l2.2409"></a><span id="l2.2409" class="difflineminus">-      uint32_t first, last = count;</span>
<a href="#l2.2410"></a><span id="l2.2410" class="difflineminus">-      const uint32_t kMaxTokens = 150;</span>
<a href="#l2.2411"></a><span id="l2.2411" class="difflineminus">-      first = ( count &gt; kMaxTokens) ? count - kMaxTokens : 0;</span>
<a href="#l2.2412"></a><span id="l2.2412" class="difflineplus">+    // Setup the arrays to save details if needed</span>
<a href="#l2.2413"></a><span id="l2.2413" class="difflineplus">+    nsTArray&lt;double&gt; sArray;</span>
<a href="#l2.2414"></a><span id="l2.2414" class="difflineplus">+    nsTArray&lt;double&gt; hArray;</span>
<a href="#l2.2415"></a><span id="l2.2415" class="difflineplus">+    uint32_t usedTokenCount = (count &gt; kMaxTokens) ? kMaxTokens : count;</span>
<a href="#l2.2416"></a><span id="l2.2416" class="difflineplus">+    if (aDetailListener) {</span>
<a href="#l2.2417"></a><span id="l2.2417" class="difflineplus">+      sArray.SetCapacity(usedTokenCount);</span>
<a href="#l2.2418"></a><span id="l2.2418" class="difflineplus">+      hArray.SetCapacity(usedTokenCount);</span>
<a href="#l2.2419"></a><span id="l2.2419" class="difflineplus">+    }</span>
<a href="#l2.2420"></a><span id="l2.2420"> </span>
<a href="#l2.2421"></a><span id="l2.2421" class="difflineminus">-      // Setup the arrays to save details if needed</span>
<a href="#l2.2422"></a><span id="l2.2422" class="difflineminus">-      nsTArray&lt;double&gt; sArray;</span>
<a href="#l2.2423"></a><span id="l2.2423" class="difflineminus">-      nsTArray&lt;double&gt; hArray;</span>
<a href="#l2.2424"></a><span id="l2.2424" class="difflineminus">-      uint32_t usedTokenCount = ( count &gt; kMaxTokens) ? kMaxTokens : count;</span>
<a href="#l2.2425"></a><span id="l2.2425" class="difflineminus">-      if (aDetailListener)</span>
<a href="#l2.2426"></a><span id="l2.2426" class="difflineminus">-      {</span>
<a href="#l2.2427"></a><span id="l2.2427" class="difflineminus">-        sArray.SetCapacity(usedTokenCount);</span>
<a href="#l2.2428"></a><span id="l2.2428" class="difflineminus">-        hArray.SetCapacity(usedTokenCount);</span>
<a href="#l2.2429"></a><span id="l2.2429" class="difflineminus">-      }</span>
<a href="#l2.2430"></a><span id="l2.2430" class="difflineplus">+    double H = 1.0, S = 1.0;</span>
<a href="#l2.2431"></a><span id="l2.2431" class="difflineplus">+    int32_t Hexp = 0, Sexp = 0;</span>
<a href="#l2.2432"></a><span id="l2.2432" class="difflineplus">+    uint32_t goodclues = 0;</span>
<a href="#l2.2433"></a><span id="l2.2433" class="difflineplus">+    int e;</span>
<a href="#l2.2434"></a><span id="l2.2434"> </span>
<a href="#l2.2435"></a><span id="l2.2435" class="difflineminus">-      double H = 1.0, S = 1.0;</span>
<a href="#l2.2436"></a><span id="l2.2436" class="difflineminus">-      int32_t Hexp = 0, Sexp = 0;</span>
<a href="#l2.2437"></a><span id="l2.2437" class="difflineminus">-      uint32_t goodclues=0;</span>
<a href="#l2.2438"></a><span id="l2.2438" class="difflineminus">-      int e;</span>
<a href="#l2.2439"></a><span id="l2.2439" class="difflineplus">+    // index from end to analyze most significant first</span>
<a href="#l2.2440"></a><span id="l2.2440" class="difflineplus">+    for (uint32_t ip1 = last; ip1 != first; --ip1) {</span>
<a href="#l2.2441"></a><span id="l2.2441" class="difflineplus">+      TraitAnalysis&amp; ta = traitAnalyses[ip1 - 1];</span>
<a href="#l2.2442"></a><span id="l2.2442" class="difflineplus">+      if (ta.mDistance &gt; 0.0) {</span>
<a href="#l2.2443"></a><span id="l2.2443" class="difflineplus">+        goodclues++;</span>
<a href="#l2.2444"></a><span id="l2.2444" class="difflineplus">+        double value = ta.mProbability;</span>
<a href="#l2.2445"></a><span id="l2.2445" class="difflineplus">+        S *= (1.0 - value);</span>
<a href="#l2.2446"></a><span id="l2.2446" class="difflineplus">+        H *= value;</span>
<a href="#l2.2447"></a><span id="l2.2447" class="difflineplus">+        if (S &lt; 1e-200) {</span>
<a href="#l2.2448"></a><span id="l2.2448" class="difflineplus">+          S = frexp(S, &amp;e);</span>
<a href="#l2.2449"></a><span id="l2.2449" class="difflineplus">+          Sexp += e;</span>
<a href="#l2.2450"></a><span id="l2.2450" class="difflineplus">+        }</span>
<a href="#l2.2451"></a><span id="l2.2451" class="difflineplus">+        if (H &lt; 1e-200) {</span>
<a href="#l2.2452"></a><span id="l2.2452" class="difflineplus">+          H = frexp(H, &amp;e);</span>
<a href="#l2.2453"></a><span id="l2.2453" class="difflineplus">+          Hexp += e;</span>
<a href="#l2.2454"></a><span id="l2.2454" class="difflineplus">+        }</span>
<a href="#l2.2455"></a><span id="l2.2455" class="difflineplus">+        MOZ_LOG(BayesianFilterLogModule, LogLevel::Warning,</span>
<a href="#l2.2456"></a><span id="l2.2456" class="difflineplus">+                (&quot;token probability (%s) is %f&quot;, tokens[ta.mTokenIndex].mWord,</span>
<a href="#l2.2457"></a><span id="l2.2457" class="difflineplus">+                 ta.mProbability));</span>
<a href="#l2.2458"></a><span id="l2.2458" class="difflineplus">+      }</span>
<a href="#l2.2459"></a><span id="l2.2459" class="difflineplus">+      if (aDetailListener) {</span>
<a href="#l2.2460"></a><span id="l2.2460" class="difflineplus">+        sArray.AppendElement(log(S) + Sexp * M_LN2);</span>
<a href="#l2.2461"></a><span id="l2.2461" class="difflineplus">+        hArray.AppendElement(log(H) + Hexp * M_LN2);</span>
<a href="#l2.2462"></a><span id="l2.2462" class="difflineplus">+      }</span>
<a href="#l2.2463"></a><span id="l2.2463" class="difflineplus">+    }</span>
<a href="#l2.2464"></a><span id="l2.2464" class="difflineplus">+</span>
<a href="#l2.2465"></a><span id="l2.2465" class="difflineplus">+    S = log(S) + Sexp * M_LN2;</span>
<a href="#l2.2466"></a><span id="l2.2466" class="difflineplus">+    H = log(H) + Hexp * M_LN2;</span>
<a href="#l2.2467"></a><span id="l2.2467"> </span>
<a href="#l2.2468"></a><span id="l2.2468" class="difflineminus">-      // index from end to analyze most significant first</span>
<a href="#l2.2469"></a><span id="l2.2469" class="difflineminus">-      for (uint32_t ip1 = last; ip1 != first; --ip1)</span>
<a href="#l2.2470"></a><span id="l2.2470" class="difflineminus">-      {</span>
<a href="#l2.2471"></a><span id="l2.2471" class="difflineminus">-        TraitAnalysis&amp; ta = traitAnalyses[ip1 - 1];</span>
<a href="#l2.2472"></a><span id="l2.2472" class="difflineminus">-        if (ta.mDistance &gt; 0.0)</span>
<a href="#l2.2473"></a><span id="l2.2473" class="difflineminus">-        {</span>
<a href="#l2.2474"></a><span id="l2.2474" class="difflineminus">-          goodclues++;</span>
<a href="#l2.2475"></a><span id="l2.2475" class="difflineminus">-          double value = ta.mProbability;</span>
<a href="#l2.2476"></a><span id="l2.2476" class="difflineminus">-          S *= (1.0 - value);</span>
<a href="#l2.2477"></a><span id="l2.2477" class="difflineminus">-          H *= value;</span>
<a href="#l2.2478"></a><span id="l2.2478" class="difflineminus">-          if ( S &lt; 1e-200 )</span>
<a href="#l2.2479"></a><span id="l2.2479" class="difflineminus">-          {</span>
<a href="#l2.2480"></a><span id="l2.2480" class="difflineminus">-            S = frexp(S, &amp;e);</span>
<a href="#l2.2481"></a><span id="l2.2481" class="difflineminus">-            Sexp += e;</span>
<a href="#l2.2482"></a><span id="l2.2482" class="difflineminus">-          }</span>
<a href="#l2.2483"></a><span id="l2.2483" class="difflineminus">-          if ( H &lt; 1e-200 )</span>
<a href="#l2.2484"></a><span id="l2.2484" class="difflineminus">-          {</span>
<a href="#l2.2485"></a><span id="l2.2485" class="difflineminus">-            H = frexp(H, &amp;e);</span>
<a href="#l2.2486"></a><span id="l2.2486" class="difflineminus">-            Hexp += e;</span>
<a href="#l2.2487"></a><span id="l2.2487" class="difflineminus">-          }</span>
<a href="#l2.2488"></a><span id="l2.2488" class="difflineminus">-          MOZ_LOG(BayesianFilterLogModule, LogLevel::Warning,</span>
<a href="#l2.2489"></a><span id="l2.2489" class="difflineminus">-                 (&quot;token probability (%s) is %f&quot;,</span>
<a href="#l2.2490"></a><span id="l2.2490" class="difflineminus">-                  tokens[ta.mTokenIndex].mWord, ta.mProbability));</span>
<a href="#l2.2491"></a><span id="l2.2491" class="difflineminus">-        }</span>
<a href="#l2.2492"></a><span id="l2.2492" class="difflineminus">-        if (aDetailListener)</span>
<a href="#l2.2493"></a><span id="l2.2493" class="difflineminus">-        {</span>
<a href="#l2.2494"></a><span id="l2.2494" class="difflineminus">-          sArray.AppendElement(log(S) + Sexp * M_LN2);</span>
<a href="#l2.2495"></a><span id="l2.2495" class="difflineminus">-          hArray.AppendElement(log(H) + Hexp * M_LN2);</span>
<a href="#l2.2496"></a><span id="l2.2496" class="difflineminus">-        }</span>
<a href="#l2.2497"></a><span id="l2.2497" class="difflineplus">+    double prob;</span>
<a href="#l2.2498"></a><span id="l2.2498" class="difflineplus">+    if (goodclues &gt; 0) {</span>
<a href="#l2.2499"></a><span id="l2.2499" class="difflineplus">+      int32_t chi_error;</span>
<a href="#l2.2500"></a><span id="l2.2500" class="difflineplus">+      S = chi2P(-2.0 * S, 2.0 * goodclues, &amp;chi_error);</span>
<a href="#l2.2501"></a><span id="l2.2501" class="difflineplus">+      if (!chi_error) H = chi2P(-2.0 * H, 2.0 * goodclues, &amp;chi_error);</span>
<a href="#l2.2502"></a><span id="l2.2502" class="difflineplus">+      // if any error toss the entire calculation</span>
<a href="#l2.2503"></a><span id="l2.2503" class="difflineplus">+      if (!chi_error)</span>
<a href="#l2.2504"></a><span id="l2.2504" class="difflineplus">+        prob = (S - H + 1.0) / 2.0;</span>
<a href="#l2.2505"></a><span id="l2.2505" class="difflineplus">+      else</span>
<a href="#l2.2506"></a><span id="l2.2506" class="difflineplus">+        prob = 0.5;</span>
<a href="#l2.2507"></a><span id="l2.2507" class="difflineplus">+    } else</span>
<a href="#l2.2508"></a><span id="l2.2508" class="difflineplus">+      prob = 0.5;</span>
<a href="#l2.2509"></a><span id="l2.2509" class="difflineplus">+</span>
<a href="#l2.2510"></a><span id="l2.2510" class="difflineplus">+    if (aDetailListener) {</span>
<a href="#l2.2511"></a><span id="l2.2511" class="difflineplus">+      // Prepare output arrays</span>
<a href="#l2.2512"></a><span id="l2.2512" class="difflineplus">+      nsTArray&lt;uint32_t&gt; tokenPercents(usedTokenCount);</span>
<a href="#l2.2513"></a><span id="l2.2513" class="difflineplus">+      nsTArray&lt;uint32_t&gt; runningPercents(usedTokenCount);</span>
<a href="#l2.2514"></a><span id="l2.2514" class="difflineplus">+      nsTArray&lt;char16_t*&gt; tokenStrings(usedTokenCount);</span>
<a href="#l2.2515"></a><span id="l2.2515" class="difflineplus">+</span>
<a href="#l2.2516"></a><span id="l2.2516" class="difflineplus">+      double clueCount = 1.0;</span>
<a href="#l2.2517"></a><span id="l2.2517" class="difflineplus">+      for (uint32_t tokenIndex = 0; tokenIndex &lt; usedTokenCount; tokenIndex++) {</span>
<a href="#l2.2518"></a><span id="l2.2518" class="difflineplus">+        TraitAnalysis&amp; ta = traitAnalyses[last - 1 - tokenIndex];</span>
<a href="#l2.2519"></a><span id="l2.2519" class="difflineplus">+        int32_t chi_error;</span>
<a href="#l2.2520"></a><span id="l2.2520" class="difflineplus">+        S = chi2P(-2.0 * sArray[tokenIndex], 2.0 * clueCount, &amp;chi_error);</span>
<a href="#l2.2521"></a><span id="l2.2521" class="difflineplus">+        if (!chi_error)</span>
<a href="#l2.2522"></a><span id="l2.2522" class="difflineplus">+          H = chi2P(-2.0 * hArray[tokenIndex], 2.0 * clueCount, &amp;chi_error);</span>
<a href="#l2.2523"></a><span id="l2.2523" class="difflineplus">+        clueCount += 1.0;</span>
<a href="#l2.2524"></a><span id="l2.2524" class="difflineplus">+        double runningProb;</span>
<a href="#l2.2525"></a><span id="l2.2525" class="difflineplus">+        if (!chi_error)</span>
<a href="#l2.2526"></a><span id="l2.2526" class="difflineplus">+          runningProb = (S - H + 1.0) / 2.0;</span>
<a href="#l2.2527"></a><span id="l2.2527" class="difflineplus">+        else</span>
<a href="#l2.2528"></a><span id="l2.2528" class="difflineplus">+          runningProb = 0.5;</span>
<a href="#l2.2529"></a><span id="l2.2529" class="difflineplus">+        runningPercents.AppendElement(</span>
<a href="#l2.2530"></a><span id="l2.2530" class="difflineplus">+            static_cast&lt;uint32_t&gt;(runningProb * 100. + .5));</span>
<a href="#l2.2531"></a><span id="l2.2531" class="difflineplus">+        tokenPercents.AppendElement(</span>
<a href="#l2.2532"></a><span id="l2.2532" class="difflineplus">+            static_cast&lt;uint32_t&gt;(ta.mProbability * 100. + .5));</span>
<a href="#l2.2533"></a><span id="l2.2533" class="difflineplus">+        tokenStrings.AppendElement(</span>
<a href="#l2.2534"></a><span id="l2.2534" class="difflineplus">+            ToNewUnicode(NS_ConvertUTF8toUTF16(tokens[ta.mTokenIndex].mWord)));</span>
<a href="#l2.2535"></a><span id="l2.2535">       }</span>
<a href="#l2.2536"></a><span id="l2.2536"> </span>
<a href="#l2.2537"></a><span id="l2.2537" class="difflineminus">-      S = log(S) + Sexp * M_LN2;</span>
<a href="#l2.2538"></a><span id="l2.2538" class="difflineminus">-      H = log(H) + Hexp * M_LN2;</span>
<a href="#l2.2539"></a><span id="l2.2539" class="difflineminus">-</span>
<a href="#l2.2540"></a><span id="l2.2540" class="difflineminus">-      double prob;</span>
<a href="#l2.2541"></a><span id="l2.2541" class="difflineminus">-      if (goodclues &gt; 0)</span>
<a href="#l2.2542"></a><span id="l2.2542" class="difflineminus">-      {</span>
<a href="#l2.2543"></a><span id="l2.2543" class="difflineminus">-          int32_t chi_error;</span>
<a href="#l2.2544"></a><span id="l2.2544" class="difflineminus">-          S = chi2P(-2.0 * S, 2.0 * goodclues, &amp;chi_error);</span>
<a href="#l2.2545"></a><span id="l2.2545" class="difflineminus">-          if (!chi_error)</span>
<a href="#l2.2546"></a><span id="l2.2546" class="difflineminus">-              H = chi2P(-2.0 * H, 2.0 * goodclues, &amp;chi_error);</span>
<a href="#l2.2547"></a><span id="l2.2547" class="difflineminus">-          // if any error toss the entire calculation</span>
<a href="#l2.2548"></a><span id="l2.2548" class="difflineminus">-          if (!chi_error)</span>
<a href="#l2.2549"></a><span id="l2.2549" class="difflineminus">-              prob = (S-H +1.0) / 2.0;</span>
<a href="#l2.2550"></a><span id="l2.2550" class="difflineminus">-          else</span>
<a href="#l2.2551"></a><span id="l2.2551" class="difflineminus">-              prob = 0.5;</span>
<a href="#l2.2552"></a><span id="l2.2552" class="difflineminus">-      }</span>
<a href="#l2.2553"></a><span id="l2.2553" class="difflineminus">-      else</span>
<a href="#l2.2554"></a><span id="l2.2554" class="difflineminus">-          prob = 0.5;</span>
<a href="#l2.2555"></a><span id="l2.2555" class="difflineminus">-</span>
<a href="#l2.2556"></a><span id="l2.2556" class="difflineminus">-      if (aDetailListener)</span>
<a href="#l2.2557"></a><span id="l2.2557" class="difflineminus">-      {</span>
<a href="#l2.2558"></a><span id="l2.2558" class="difflineminus">-        // Prepare output arrays</span>
<a href="#l2.2559"></a><span id="l2.2559" class="difflineminus">-        nsTArray&lt;uint32_t&gt; tokenPercents(usedTokenCount);</span>
<a href="#l2.2560"></a><span id="l2.2560" class="difflineminus">-        nsTArray&lt;uint32_t&gt; runningPercents(usedTokenCount);</span>
<a href="#l2.2561"></a><span id="l2.2561" class="difflineminus">-        nsTArray&lt;char16_t*&gt; tokenStrings(usedTokenCount);</span>
<a href="#l2.2562"></a><span id="l2.2562" class="difflineminus">-</span>
<a href="#l2.2563"></a><span id="l2.2563" class="difflineminus">-        double clueCount = 1.0;</span>
<a href="#l2.2564"></a><span id="l2.2564" class="difflineminus">-        for (uint32_t tokenIndex = 0; tokenIndex &lt; usedTokenCount; tokenIndex++)</span>
<a href="#l2.2565"></a><span id="l2.2565" class="difflineminus">-        {</span>
<a href="#l2.2566"></a><span id="l2.2566" class="difflineminus">-          TraitAnalysis&amp; ta = traitAnalyses[last - 1 - tokenIndex];</span>
<a href="#l2.2567"></a><span id="l2.2567" class="difflineminus">-          int32_t chi_error;</span>
<a href="#l2.2568"></a><span id="l2.2568" class="difflineminus">-          S = chi2P(-2.0 * sArray[tokenIndex], 2.0 * clueCount, &amp;chi_error);</span>
<a href="#l2.2569"></a><span id="l2.2569" class="difflineminus">-          if (!chi_error)</span>
<a href="#l2.2570"></a><span id="l2.2570" class="difflineminus">-            H = chi2P(-2.0 * hArray[tokenIndex], 2.0 * clueCount, &amp;chi_error);</span>
<a href="#l2.2571"></a><span id="l2.2571" class="difflineminus">-          clueCount += 1.0;</span>
<a href="#l2.2572"></a><span id="l2.2572" class="difflineminus">-          double runningProb;</span>
<a href="#l2.2573"></a><span id="l2.2573" class="difflineminus">-          if (!chi_error)</span>
<a href="#l2.2574"></a><span id="l2.2574" class="difflineminus">-            runningProb = (S - H + 1.0) / 2.0;</span>
<a href="#l2.2575"></a><span id="l2.2575" class="difflineminus">-          else</span>
<a href="#l2.2576"></a><span id="l2.2576" class="difflineminus">-            runningProb = 0.5;</span>
<a href="#l2.2577"></a><span id="l2.2577" class="difflineminus">-          runningPercents.AppendElement(static_cast&lt;uint32_t&gt;(runningProb *</span>
<a href="#l2.2578"></a><span id="l2.2578" class="difflineminus">-              100. + .5));</span>
<a href="#l2.2579"></a><span id="l2.2579" class="difflineminus">-          tokenPercents.AppendElement(static_cast&lt;uint32_t&gt;(ta.mProbability *</span>
<a href="#l2.2580"></a><span id="l2.2580" class="difflineminus">-              100. + .5));</span>
<a href="#l2.2581"></a><span id="l2.2581" class="difflineminus">-          tokenStrings.AppendElement(ToNewUnicode(NS_ConvertUTF8toUTF16(</span>
<a href="#l2.2582"></a><span id="l2.2582" class="difflineminus">-              tokens[ta.mTokenIndex].mWord)));</span>
<a href="#l2.2583"></a><span id="l2.2583" class="difflineminus">-        }</span>
<a href="#l2.2584"></a><span id="l2.2584" class="difflineminus">-</span>
<a href="#l2.2585"></a><span id="l2.2585" class="difflineminus">-        aDetailListener-&gt;OnMessageTraitDetails(messageURI, aProTraits[traitIndex],</span>
<a href="#l2.2586"></a><span id="l2.2586" class="difflineminus">-            usedTokenCount, (const char16_t**)tokenStrings.Elements(),</span>
<a href="#l2.2587"></a><span id="l2.2587" class="difflineminus">-            tokenPercents.Elements(), runningPercents.Elements());</span>
<a href="#l2.2588"></a><span id="l2.2588" class="difflineminus">-        for (uint32_t tokenIndex = 0; tokenIndex &lt; usedTokenCount; tokenIndex++)</span>
<a href="#l2.2589"></a><span id="l2.2589" class="difflineminus">-          free(tokenStrings[tokenIndex]);</span>
<a href="#l2.2590"></a><span id="l2.2590" class="difflineminus">-      }</span>
<a href="#l2.2591"></a><span id="l2.2591" class="difflineminus">-</span>
<a href="#l2.2592"></a><span id="l2.2592" class="difflineminus">-      uint32_t proPercent = static_cast&lt;uint32_t&gt;(prob*100. + .5);</span>
<a href="#l2.2593"></a><span id="l2.2593" class="difflineminus">-</span>
<a href="#l2.2594"></a><span id="l2.2594" class="difflineminus">-      // directly classify junk to maintain backwards compatibility</span>
<a href="#l2.2595"></a><span id="l2.2595" class="difflineminus">-      if (aProTraits[traitIndex] == kJunkTrait)</span>
<a href="#l2.2596"></a><span id="l2.2596" class="difflineminus">-      {</span>
<a href="#l2.2597"></a><span id="l2.2597" class="difflineminus">-        bool isJunk = (prob &gt;= mJunkProbabilityThreshold);</span>
<a href="#l2.2598"></a><span id="l2.2598" class="difflineminus">-        MOZ_LOG(BayesianFilterLogModule, LogLevel::Info,</span>
<a href="#l2.2599"></a><span id="l2.2599" class="difflineminus">-               (&quot;%s is junk probability = (%f)  HAM SCORE:%f SPAM SCORE:%f&quot;,</span>
<a href="#l2.2600"></a><span id="l2.2600" class="difflineminus">-                messageURI, prob,H,S));</span>
<a href="#l2.2601"></a><span id="l2.2601" class="difflineminus">-</span>
<a href="#l2.2602"></a><span id="l2.2602" class="difflineminus">-        // the algorithm in &quot;A Plan For Spam&quot; assumes that you have a large good</span>
<a href="#l2.2603"></a><span id="l2.2603" class="difflineminus">-        // corpus and a large junk corpus.</span>
<a href="#l2.2604"></a><span id="l2.2604" class="difflineminus">-        // that won't be the case with users who first use the junk mail trait</span>
<a href="#l2.2605"></a><span id="l2.2605" class="difflineminus">-        // so, we do certain things to encourage them to train.</span>
<a href="#l2.2606"></a><span id="l2.2606" class="difflineminus">-        //</span>
<a href="#l2.2607"></a><span id="l2.2607" class="difflineminus">-        // if there are no good tokens, assume the message is junk</span>
<a href="#l2.2608"></a><span id="l2.2608" class="difflineminus">-        // this will &quot;encourage&quot; the user to train</span>
<a href="#l2.2609"></a><span id="l2.2609" class="difflineminus">-        // and if there are no bad tokens, assume the message is not junk</span>
<a href="#l2.2610"></a><span id="l2.2610" class="difflineminus">-        // this will also &quot;encourage&quot; the user to train</span>
<a href="#l2.2611"></a><span id="l2.2611" class="difflineminus">-        // see bug #194238</span>
<a href="#l2.2612"></a><span id="l2.2612" class="difflineminus">-</span>
<a href="#l2.2613"></a><span id="l2.2613" class="difflineminus">-        if (listener &amp;&amp; !mCorpus.getMessageCount(kGoodTrait))</span>
<a href="#l2.2614"></a><span id="l2.2614" class="difflineminus">-          isJunk = true;</span>
<a href="#l2.2615"></a><span id="l2.2615" class="difflineminus">-        else if (listener &amp;&amp; !mCorpus.getMessageCount(kJunkTrait))</span>
<a href="#l2.2616"></a><span id="l2.2616" class="difflineminus">-          isJunk = false;</span>
<a href="#l2.2617"></a><span id="l2.2617" class="difflineminus">-</span>
<a href="#l2.2618"></a><span id="l2.2618" class="difflineminus">-        if (listener)</span>
<a href="#l2.2619"></a><span id="l2.2619" class="difflineminus">-          listener-&gt;OnMessageClassified(messageURI, isJunk ?</span>
<a href="#l2.2620"></a><span id="l2.2620" class="difflineminus">-            nsMsgJunkStatus(nsIJunkMailPlugin::JUNK) :</span>
<a href="#l2.2621"></a><span id="l2.2621" class="difflineminus">-            nsMsgJunkStatus(nsIJunkMailPlugin::GOOD), proPercent);</span>
<a href="#l2.2622"></a><span id="l2.2622" class="difflineminus">-      }</span>
<a href="#l2.2623"></a><span id="l2.2623" class="difflineminus">-</span>
<a href="#l2.2624"></a><span id="l2.2624" class="difflineminus">-      if (aTraitListener)</span>
<a href="#l2.2625"></a><span id="l2.2625" class="difflineminus">-      {</span>
<a href="#l2.2626"></a><span id="l2.2626" class="difflineminus">-        traits.AppendElement(aProTraits[traitIndex]);</span>
<a href="#l2.2627"></a><span id="l2.2627" class="difflineminus">-        percents.AppendElement(proPercent);</span>
<a href="#l2.2628"></a><span id="l2.2628" class="difflineminus">-      }</span>
<a href="#l2.2629"></a><span id="l2.2629" class="difflineminus">-</span>
<a href="#l2.2630"></a><span id="l2.2630" class="difflineminus">-      // free aliases arrays returned from XPCOM</span>
<a href="#l2.2631"></a><span id="l2.2631" class="difflineminus">-      if (proAliasesLengths[traitIndex])</span>
<a href="#l2.2632"></a><span id="l2.2632" class="difflineminus">-        free(proAliasArrays[traitIndex]);</span>
<a href="#l2.2633"></a><span id="l2.2633" class="difflineminus">-      if (antiAliasesLengths[traitIndex])</span>
<a href="#l2.2634"></a><span id="l2.2634" class="difflineminus">-        free(antiAliasArrays[traitIndex]);</span>
<a href="#l2.2635"></a><span id="l2.2635" class="difflineplus">+      aDetailListener-&gt;OnMessageTraitDetails(</span>
<a href="#l2.2636"></a><span id="l2.2636" class="difflineplus">+          messageURI, aProTraits[traitIndex], usedTokenCount,</span>
<a href="#l2.2637"></a><span id="l2.2637" class="difflineplus">+          (const char16_t**)tokenStrings.Elements(), tokenPercents.Elements(),</span>
<a href="#l2.2638"></a><span id="l2.2638" class="difflineplus">+          runningPercents.Elements());</span>
<a href="#l2.2639"></a><span id="l2.2639" class="difflineplus">+      for (uint32_t tokenIndex = 0; tokenIndex &lt; usedTokenCount; tokenIndex++)</span>
<a href="#l2.2640"></a><span id="l2.2640" class="difflineplus">+        free(tokenStrings[tokenIndex]);</span>
<a href="#l2.2641"></a><span id="l2.2641">     }</span>
<a href="#l2.2642"></a><span id="l2.2642"> </span>
<a href="#l2.2643"></a><span id="l2.2643" class="difflineminus">-    if (aTraitListener)</span>
<a href="#l2.2644"></a><span id="l2.2644" class="difflineminus">-      aTraitListener-&gt;OnMessageTraitsClassified(messageURI,</span>
<a href="#l2.2645"></a><span id="l2.2645" class="difflineminus">-          traits.Length(), traits.Elements(), percents.Elements());</span>
<a href="#l2.2646"></a><span id="l2.2646" class="difflineplus">+    uint32_t proPercent = static_cast&lt;uint32_t&gt;(prob * 100. + .5);</span>
<a href="#l2.2647"></a><span id="l2.2647" class="difflineplus">+</span>
<a href="#l2.2648"></a><span id="l2.2648" class="difflineplus">+    // directly classify junk to maintain backwards compatibility</span>
<a href="#l2.2649"></a><span id="l2.2649" class="difflineplus">+    if (aProTraits[traitIndex] == kJunkTrait) {</span>
<a href="#l2.2650"></a><span id="l2.2650" class="difflineplus">+      bool isJunk = (prob &gt;= mJunkProbabilityThreshold);</span>
<a href="#l2.2651"></a><span id="l2.2651" class="difflineplus">+      MOZ_LOG(BayesianFilterLogModule, LogLevel::Info,</span>
<a href="#l2.2652"></a><span id="l2.2652" class="difflineplus">+              (&quot;%s is junk probability = (%f)  HAM SCORE:%f SPAM SCORE:%f&quot;,</span>
<a href="#l2.2653"></a><span id="l2.2653" class="difflineplus">+               messageURI, prob, H, S));</span>
<a href="#l2.2654"></a><span id="l2.2654" class="difflineplus">+</span>
<a href="#l2.2655"></a><span id="l2.2655" class="difflineplus">+      // the algorithm in &quot;A Plan For Spam&quot; assumes that you have a large good</span>
<a href="#l2.2656"></a><span id="l2.2656" class="difflineplus">+      // corpus and a large junk corpus.</span>
<a href="#l2.2657"></a><span id="l2.2657" class="difflineplus">+      // that won't be the case with users who first use the junk mail trait</span>
<a href="#l2.2658"></a><span id="l2.2658" class="difflineplus">+      // so, we do certain things to encourage them to train.</span>
<a href="#l2.2659"></a><span id="l2.2659" class="difflineplus">+      //</span>
<a href="#l2.2660"></a><span id="l2.2660" class="difflineplus">+      // if there are no good tokens, assume the message is junk</span>
<a href="#l2.2661"></a><span id="l2.2661" class="difflineplus">+      // this will &quot;encourage&quot; the user to train</span>
<a href="#l2.2662"></a><span id="l2.2662" class="difflineplus">+      // and if there are no bad tokens, assume the message is not junk</span>
<a href="#l2.2663"></a><span id="l2.2663" class="difflineplus">+      // this will also &quot;encourage&quot; the user to train</span>
<a href="#l2.2664"></a><span id="l2.2664" class="difflineplus">+      // see bug #194238</span>
<a href="#l2.2665"></a><span id="l2.2665" class="difflineplus">+</span>
<a href="#l2.2666"></a><span id="l2.2666" class="difflineplus">+      if (listener &amp;&amp; !mCorpus.getMessageCount(kGoodTrait))</span>
<a href="#l2.2667"></a><span id="l2.2667" class="difflineplus">+        isJunk = true;</span>
<a href="#l2.2668"></a><span id="l2.2668" class="difflineplus">+      else if (listener &amp;&amp; !mCorpus.getMessageCount(kJunkTrait))</span>
<a href="#l2.2669"></a><span id="l2.2669" class="difflineplus">+        isJunk = false;</span>
<a href="#l2.2670"></a><span id="l2.2670"> </span>
<a href="#l2.2671"></a><span id="l2.2671" class="difflineminus">-    delete[] tokens;</span>
<a href="#l2.2672"></a><span id="l2.2672" class="difflineminus">-    // reuse mAnalysisStore without clearing memory</span>
<a href="#l2.2673"></a><span id="l2.2673" class="difflineminus">-    mNextAnalysisIndex = 1;</span>
<a href="#l2.2674"></a><span id="l2.2674" class="difflineminus">-    // but shrink it back to the default size</span>
<a href="#l2.2675"></a><span id="l2.2675" class="difflineminus">-    if (mAnalysisStore.Length() &gt; kAnalysisStoreCapacity)</span>
<a href="#l2.2676"></a><span id="l2.2676" class="difflineminus">-      mAnalysisStore.RemoveElementsAt(kAnalysisStoreCapacity,</span>
<a href="#l2.2677"></a><span id="l2.2677" class="difflineminus">-          mAnalysisStore.Length() - kAnalysisStoreCapacity);</span>
<a href="#l2.2678"></a><span id="l2.2678" class="difflineminus">-    mAnalysisStore.Compact();</span>
<a href="#l2.2679"></a><span id="l2.2679" class="difflineplus">+      if (listener)</span>
<a href="#l2.2680"></a><span id="l2.2680" class="difflineplus">+        listener-&gt;OnMessageClassified(</span>
<a href="#l2.2681"></a><span id="l2.2681" class="difflineplus">+            messageURI,</span>
<a href="#l2.2682"></a><span id="l2.2682" class="difflineplus">+            isJunk ? nsMsgJunkStatus(nsIJunkMailPlugin::JUNK)</span>
<a href="#l2.2683"></a><span id="l2.2683" class="difflineplus">+                   : nsMsgJunkStatus(nsIJunkMailPlugin::GOOD),</span>
<a href="#l2.2684"></a><span id="l2.2684" class="difflineplus">+            proPercent);</span>
<a href="#l2.2685"></a><span id="l2.2685" class="difflineplus">+    }</span>
<a href="#l2.2686"></a><span id="l2.2686" class="difflineplus">+</span>
<a href="#l2.2687"></a><span id="l2.2687" class="difflineplus">+    if (aTraitListener) {</span>
<a href="#l2.2688"></a><span id="l2.2688" class="difflineplus">+      traits.AppendElement(aProTraits[traitIndex]);</span>
<a href="#l2.2689"></a><span id="l2.2689" class="difflineplus">+      percents.AppendElement(proPercent);</span>
<a href="#l2.2690"></a><span id="l2.2690" class="difflineplus">+    }</span>
<a href="#l2.2691"></a><span id="l2.2691" class="difflineplus">+</span>
<a href="#l2.2692"></a><span id="l2.2692" class="difflineplus">+    // free aliases arrays returned from XPCOM</span>
<a href="#l2.2693"></a><span id="l2.2693" class="difflineplus">+    if (proAliasesLengths[traitIndex]) free(proAliasArrays[traitIndex]);</span>
<a href="#l2.2694"></a><span id="l2.2694" class="difflineplus">+    if (antiAliasesLengths[traitIndex]) free(antiAliasArrays[traitIndex]);</span>
<a href="#l2.2695"></a><span id="l2.2695" class="difflineplus">+  }</span>
<a href="#l2.2696"></a><span id="l2.2696" class="difflineplus">+</span>
<a href="#l2.2697"></a><span id="l2.2697" class="difflineplus">+  if (aTraitListener)</span>
<a href="#l2.2698"></a><span id="l2.2698" class="difflineplus">+    aTraitListener-&gt;OnMessageTraitsClassified(</span>
<a href="#l2.2699"></a><span id="l2.2699" class="difflineplus">+        messageURI, traits.Length(), traits.Elements(), percents.Elements());</span>
<a href="#l2.2700"></a><span id="l2.2700" class="difflineplus">+</span>
<a href="#l2.2701"></a><span id="l2.2701" class="difflineplus">+  delete[] tokens;</span>
<a href="#l2.2702"></a><span id="l2.2702" class="difflineplus">+  // reuse mAnalysisStore without clearing memory</span>
<a href="#l2.2703"></a><span id="l2.2703" class="difflineplus">+  mNextAnalysisIndex = 1;</span>
<a href="#l2.2704"></a><span id="l2.2704" class="difflineplus">+  // but shrink it back to the default size</span>
<a href="#l2.2705"></a><span id="l2.2705" class="difflineplus">+  if (mAnalysisStore.Length() &gt; kAnalysisStoreCapacity)</span>
<a href="#l2.2706"></a><span id="l2.2706" class="difflineplus">+    mAnalysisStore.RemoveElementsAt(</span>
<a href="#l2.2707"></a><span id="l2.2707" class="difflineplus">+        kAnalysisStoreCapacity,</span>
<a href="#l2.2708"></a><span id="l2.2708" class="difflineplus">+        mAnalysisStore.Length() - kAnalysisStoreCapacity);</span>
<a href="#l2.2709"></a><span id="l2.2709" class="difflineplus">+  mAnalysisStore.Compact();</span>
<a href="#l2.2710"></a><span id="l2.2710"> }</span>
<a href="#l2.2711"></a><span id="l2.2711"> </span>
<a href="#l2.2712"></a><span id="l2.2712"> void nsBayesianFilter::classifyMessage(</span>
<a href="#l2.2713"></a><span id="l2.2713" class="difflineminus">-  Tokenizer&amp; tokens,</span>
<a href="#l2.2714"></a><span id="l2.2714" class="difflineminus">-  const char* messageURI,</span>
<a href="#l2.2715"></a><span id="l2.2715" class="difflineminus">-  nsIJunkMailClassificationListener* aJunkListener)</span>
<a href="#l2.2716"></a><span id="l2.2716" class="difflineminus">-{</span>
<a href="#l2.2717"></a><span id="l2.2717" class="difflineplus">+    Tokenizer&amp; tokens, const char* messageURI,</span>
<a href="#l2.2718"></a><span id="l2.2718" class="difflineplus">+    nsIJunkMailClassificationListener* aJunkListener) {</span>
<a href="#l2.2719"></a><span id="l2.2719">   AutoTArray&lt;uint32_t, 1&gt; proTraits;</span>
<a href="#l2.2720"></a><span id="l2.2720">   AutoTArray&lt;uint32_t, 1&gt; antiTraits;</span>
<a href="#l2.2721"></a><span id="l2.2721">   proTraits.AppendElement(kJunkTrait);</span>
<a href="#l2.2722"></a><span id="l2.2722">   antiTraits.AppendElement(kGoodTrait);</span>
<a href="#l2.2723"></a><span id="l2.2723" class="difflineminus">-  classifyMessage(tokens, messageURI, proTraits, antiTraits,</span>
<a href="#l2.2724"></a><span id="l2.2724" class="difflineminus">-    aJunkListener, nullptr, nullptr);</span>
<a href="#l2.2725"></a><span id="l2.2725" class="difflineplus">+  classifyMessage(tokens, messageURI, proTraits, antiTraits, aJunkListener,</span>
<a href="#l2.2726"></a><span id="l2.2726" class="difflineplus">+                  nullptr, nullptr);</span>
<a href="#l2.2727"></a><span id="l2.2727"> }</span>
<a href="#l2.2728"></a><span id="l2.2728"> </span>
<a href="#l2.2729"></a><span id="l2.2729"> NS_IMETHODIMP</span>
<a href="#l2.2730"></a><span id="l2.2730" class="difflineminus">-nsBayesianFilter::Observe(nsISupports *aSubject, const char *aTopic,</span>
<a href="#l2.2731"></a><span id="l2.2731" class="difflineminus">-                          const char16_t *someData)</span>
<a href="#l2.2732"></a><span id="l2.2732" class="difflineminus">-{</span>
<a href="#l2.2733"></a><span id="l2.2733" class="difflineminus">-  if (!strcmp(aTopic, &quot;profile-before-change&quot;))</span>
<a href="#l2.2734"></a><span id="l2.2734" class="difflineminus">-    Shutdown();</span>
<a href="#l2.2735"></a><span id="l2.2735" class="difflineplus">+nsBayesianFilter::Observe(nsISupports* aSubject, const char* aTopic,</span>
<a href="#l2.2736"></a><span id="l2.2736" class="difflineplus">+                          const char16_t* someData) {</span>
<a href="#l2.2737"></a><span id="l2.2737" class="difflineplus">+  if (!strcmp(aTopic, &quot;profile-before-change&quot;)) Shutdown();</span>
<a href="#l2.2738"></a><span id="l2.2738">   return NS_OK;</span>
<a href="#l2.2739"></a><span id="l2.2739"> }</span>
<a href="#l2.2740"></a><span id="l2.2740"> </span>
<a href="#l2.2741"></a><span id="l2.2741"> /* void shutdown (); */</span>
<a href="#l2.2742"></a><span id="l2.2742" class="difflineminus">-NS_IMETHODIMP nsBayesianFilter::Shutdown()</span>
<a href="#l2.2743"></a><span id="l2.2743" class="difflineminus">-{</span>
<a href="#l2.2744"></a><span id="l2.2744" class="difflineminus">-  if (mTrainingDataDirty)</span>
<a href="#l2.2745"></a><span id="l2.2745" class="difflineminus">-    mCorpus.writeTrainingData(mMaximumTokenCount);</span>
<a href="#l2.2746"></a><span id="l2.2746" class="difflineplus">+NS_IMETHODIMP nsBayesianFilter::Shutdown() {</span>
<a href="#l2.2747"></a><span id="l2.2747" class="difflineplus">+  if (mTrainingDataDirty) mCorpus.writeTrainingData(mMaximumTokenCount);</span>
<a href="#l2.2748"></a><span id="l2.2748">   mTrainingDataDirty = false;</span>
<a href="#l2.2749"></a><span id="l2.2749"> </span>
<a href="#l2.2750"></a><span id="l2.2750">   return NS_OK;</span>
<a href="#l2.2751"></a><span id="l2.2751"> }</span>
<a href="#l2.2752"></a><span id="l2.2752"> </span>
<a href="#l2.2753"></a><span id="l2.2753"> /* readonly attribute boolean shouldDownloadAllHeaders; */</span>
<a href="#l2.2754"></a><span id="l2.2754" class="difflineminus">-NS_IMETHODIMP nsBayesianFilter::GetShouldDownloadAllHeaders(bool *aShouldDownloadAllHeaders)</span>
<a href="#l2.2755"></a><span id="l2.2755" class="difflineminus">-{</span>
<a href="#l2.2756"></a><span id="l2.2756" class="difflineminus">-    // bayesian filters work on the whole msg body currently.</span>
<a href="#l2.2757"></a><span id="l2.2757" class="difflineminus">-    *aShouldDownloadAllHeaders = false;</span>
<a href="#l2.2758"></a><span id="l2.2758" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.2759"></a><span id="l2.2759" class="difflineplus">+NS_IMETHODIMP nsBayesianFilter::GetShouldDownloadAllHeaders(</span>
<a href="#l2.2760"></a><span id="l2.2760" class="difflineplus">+    bool* aShouldDownloadAllHeaders) {</span>
<a href="#l2.2761"></a><span id="l2.2761" class="difflineplus">+  // bayesian filters work on the whole msg body currently.</span>
<a href="#l2.2762"></a><span id="l2.2762" class="difflineplus">+  *aShouldDownloadAllHeaders = false;</span>
<a href="#l2.2763"></a><span id="l2.2763" class="difflineplus">+  return NS_OK;</span>
<a href="#l2.2764"></a><span id="l2.2764"> }</span>
<a href="#l2.2765"></a><span id="l2.2765"> </span>
<a href="#l2.2766"></a><span id="l2.2766" class="difflineminus">-/* void classifyMessage (in string aMsgURL, in nsIJunkMailClassificationListener aListener); */</span>
<a href="#l2.2767"></a><span id="l2.2767" class="difflineminus">-NS_IMETHODIMP nsBayesianFilter::ClassifyMessage(const char *aMessageURL, nsIMsgWindow *aMsgWindow, nsIJunkMailClassificationListener *aListener)</span>
<a href="#l2.2768"></a><span id="l2.2768" class="difflineminus">-{</span>
<a href="#l2.2769"></a><span id="l2.2769" class="difflineminus">-    MessageClassifier* analyzer = new MessageClassifier(this, aListener, aMsgWindow, 1, &amp;aMessageURL);</span>
<a href="#l2.2770"></a><span id="l2.2770" class="difflineminus">-    NS_ENSURE_TRUE(analyzer, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l2.2771"></a><span id="l2.2771" class="difflineminus">-    TokenStreamListener *tokenListener = new TokenStreamListener(analyzer);</span>
<a href="#l2.2772"></a><span id="l2.2772" class="difflineminus">-    NS_ENSURE_TRUE(tokenListener, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l2.2773"></a><span id="l2.2773" class="difflineminus">-    analyzer-&gt;setTokenListener(tokenListener);</span>
<a href="#l2.2774"></a><span id="l2.2774" class="difflineminus">-    return tokenizeMessage(aMessageURL, aMsgWindow, analyzer);</span>
<a href="#l2.2775"></a><span id="l2.2775" class="difflineplus">+/* void classifyMessage (in string aMsgURL, in nsIJunkMailClassificationListener</span>
<a href="#l2.2776"></a><span id="l2.2776" class="difflineplus">+ * aListener); */</span>
<a href="#l2.2777"></a><span id="l2.2777" class="difflineplus">+NS_IMETHODIMP nsBayesianFilter::ClassifyMessage(</span>
<a href="#l2.2778"></a><span id="l2.2778" class="difflineplus">+    const char* aMessageURL, nsIMsgWindow* aMsgWindow,</span>
<a href="#l2.2779"></a><span id="l2.2779" class="difflineplus">+    nsIJunkMailClassificationListener* aListener) {</span>
<a href="#l2.2780"></a><span id="l2.2780" class="difflineplus">+  MessageClassifier* analyzer =</span>
<a href="#l2.2781"></a><span id="l2.2781" class="difflineplus">+      new MessageClassifier(this, aListener, aMsgWindow, 1, &amp;aMessageURL);</span>
<a href="#l2.2782"></a><span id="l2.2782" class="difflineplus">+  NS_ENSURE_TRUE(analyzer, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l2.2783"></a><span id="l2.2783" class="difflineplus">+  TokenStreamListener* tokenListener = new TokenStreamListener(analyzer);</span>
<a href="#l2.2784"></a><span id="l2.2784" class="difflineplus">+  NS_ENSURE_TRUE(tokenListener, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l2.2785"></a><span id="l2.2785" class="difflineplus">+  analyzer-&gt;setTokenListener(tokenListener);</span>
<a href="#l2.2786"></a><span id="l2.2786" class="difflineplus">+  return tokenizeMessage(aMessageURL, aMsgWindow, analyzer);</span>
<a href="#l2.2787"></a><span id="l2.2787"> }</span>
<a href="#l2.2788"></a><span id="l2.2788"> </span>
<a href="#l2.2789"></a><span id="l2.2789" class="difflineminus">-/* void classifyMessages (in unsigned long aCount, [array, size_is (aCount)] in string aMsgURLs, in nsIJunkMailClassificationListener aListener); */</span>
<a href="#l2.2790"></a><span id="l2.2790" class="difflineminus">-NS_IMETHODIMP nsBayesianFilter::ClassifyMessages(uint32_t aCount, const char **aMsgURLs, nsIMsgWindow *aMsgWindow, nsIJunkMailClassificationListener *aListener)</span>
<a href="#l2.2791"></a><span id="l2.2791" class="difflineminus">-{</span>
<a href="#l2.2792"></a><span id="l2.2792" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aMsgURLs);</span>
<a href="#l2.2793"></a><span id="l2.2793" class="difflineplus">+/* void classifyMessages (in unsigned long aCount, [array, size_is (aCount)] in</span>
<a href="#l2.2794"></a><span id="l2.2794" class="difflineplus">+ * string aMsgURLs, in nsIJunkMailClassificationListener aListener); */</span>
<a href="#l2.2795"></a><span id="l2.2795" class="difflineplus">+NS_IMETHODIMP nsBayesianFilter::ClassifyMessages(</span>
<a href="#l2.2796"></a><span id="l2.2796" class="difflineplus">+    uint32_t aCount, const char** aMsgURLs, nsIMsgWindow* aMsgWindow,</span>
<a href="#l2.2797"></a><span id="l2.2797" class="difflineplus">+    nsIJunkMailClassificationListener* aListener) {</span>
<a href="#l2.2798"></a><span id="l2.2798" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aMsgURLs);</span>
<a href="#l2.2799"></a><span id="l2.2799"> </span>
<a href="#l2.2800"></a><span id="l2.2800" class="difflineminus">-    TokenAnalyzer* analyzer = new MessageClassifier(this, aListener, aMsgWindow, aCount, aMsgURLs);</span>
<a href="#l2.2801"></a><span id="l2.2801" class="difflineminus">-    NS_ENSURE_TRUE(analyzer, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l2.2802"></a><span id="l2.2802" class="difflineminus">-    TokenStreamListener *tokenListener = new TokenStreamListener(analyzer);</span>
<a href="#l2.2803"></a><span id="l2.2803" class="difflineminus">-    NS_ENSURE_TRUE(tokenListener, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l2.2804"></a><span id="l2.2804" class="difflineminus">-    analyzer-&gt;setTokenListener(tokenListener);</span>
<a href="#l2.2805"></a><span id="l2.2805" class="difflineminus">-    return tokenizeMessage(aMsgURLs[0], aMsgWindow, analyzer);</span>
<a href="#l2.2806"></a><span id="l2.2806" class="difflineplus">+  TokenAnalyzer* analyzer =</span>
<a href="#l2.2807"></a><span id="l2.2807" class="difflineplus">+      new MessageClassifier(this, aListener, aMsgWindow, aCount, aMsgURLs);</span>
<a href="#l2.2808"></a><span id="l2.2808" class="difflineplus">+  NS_ENSURE_TRUE(analyzer, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l2.2809"></a><span id="l2.2809" class="difflineplus">+  TokenStreamListener* tokenListener = new TokenStreamListener(analyzer);</span>
<a href="#l2.2810"></a><span id="l2.2810" class="difflineplus">+  NS_ENSURE_TRUE(tokenListener, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l2.2811"></a><span id="l2.2811" class="difflineplus">+  analyzer-&gt;setTokenListener(tokenListener);</span>
<a href="#l2.2812"></a><span id="l2.2812" class="difflineplus">+  return tokenizeMessage(aMsgURLs[0], aMsgWindow, analyzer);</span>
<a href="#l2.2813"></a><span id="l2.2813"> }</span>
<a href="#l2.2814"></a><span id="l2.2814"> </span>
<a href="#l2.2815"></a><span id="l2.2815"> nsresult nsBayesianFilter::setAnalysis(Token&amp; token, uint32_t aTraitIndex,</span>
<a href="#l2.2816"></a><span id="l2.2816" class="difflineminus">-  double aDistance, double aProbability)</span>
<a href="#l2.2817"></a><span id="l2.2817" class="difflineminus">-{</span>
<a href="#l2.2818"></a><span id="l2.2818" class="difflineplus">+                                       double aDistance, double aProbability) {</span>
<a href="#l2.2819"></a><span id="l2.2819">   uint32_t nextLink = token.mAnalysisLink;</span>
<a href="#l2.2820"></a><span id="l2.2820">   uint32_t lastLink = 0;</span>
<a href="#l2.2821"></a><span id="l2.2821">   uint32_t linkCount = 0, maxLinks = 100;</span>
<a href="#l2.2822"></a><span id="l2.2822"> </span>
<a href="#l2.2823"></a><span id="l2.2823">   // try to find an existing element. Limit the search to maxLinks</span>
<a href="#l2.2824"></a><span id="l2.2824">   // as a precaution</span>
<a href="#l2.2825"></a><span id="l2.2825" class="difflineminus">-  for (linkCount = 0; nextLink &amp;&amp; linkCount &lt; maxLinks; linkCount++)</span>
<a href="#l2.2826"></a><span id="l2.2826" class="difflineminus">-  {</span>
<a href="#l2.2827"></a><span id="l2.2827" class="difflineminus">-    AnalysisPerToken &amp;rAnalysis = mAnalysisStore[nextLink];</span>
<a href="#l2.2828"></a><span id="l2.2828" class="difflineminus">-    if (rAnalysis.mTraitIndex == aTraitIndex)</span>
<a href="#l2.2829"></a><span id="l2.2829" class="difflineminus">-    {</span>
<a href="#l2.2830"></a><span id="l2.2830" class="difflineplus">+  for (linkCount = 0; nextLink &amp;&amp; linkCount &lt; maxLinks; linkCount++) {</span>
<a href="#l2.2831"></a><span id="l2.2831" class="difflineplus">+    AnalysisPerToken&amp; rAnalysis = mAnalysisStore[nextLink];</span>
<a href="#l2.2832"></a><span id="l2.2832" class="difflineplus">+    if (rAnalysis.mTraitIndex == aTraitIndex) {</span>
<a href="#l2.2833"></a><span id="l2.2833">       rAnalysis.mDistance = aDistance;</span>
<a href="#l2.2834"></a><span id="l2.2834">       rAnalysis.mProbability = aProbability;</span>
<a href="#l2.2835"></a><span id="l2.2835">       return NS_OK;</span>
<a href="#l2.2836"></a><span id="l2.2836">     }</span>
<a href="#l2.2837"></a><span id="l2.2837">     lastLink = nextLink;</span>
<a href="#l2.2838"></a><span id="l2.2838">     nextLink = rAnalysis.mNextLink;</span>
<a href="#l2.2839"></a><span id="l2.2839">   }</span>
<a href="#l2.2840"></a><span id="l2.2840" class="difflineminus">-  if (linkCount &gt;= maxLinks)</span>
<a href="#l2.2841"></a><span id="l2.2841" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l2.2842"></a><span id="l2.2842" class="difflineplus">+  if (linkCount &gt;= maxLinks) return NS_ERROR_FAILURE;</span>
<a href="#l2.2843"></a><span id="l2.2843"> </span>
<a href="#l2.2844"></a><span id="l2.2844">   // trait does not exist, so add it</span>
<a href="#l2.2845"></a><span id="l2.2845"> </span>
<a href="#l2.2846"></a><span id="l2.2846">   AnalysisPerToken analysis(aTraitIndex, aDistance, aProbability);</span>
<a href="#l2.2847"></a><span id="l2.2847">   if (mAnalysisStore.Length() == mNextAnalysisIndex)</span>
<a href="#l2.2848"></a><span id="l2.2848">     mAnalysisStore.InsertElementAt(mNextAnalysisIndex, analysis);</span>
<a href="#l2.2849"></a><span id="l2.2849">   else if (mAnalysisStore.Length() &gt; mNextAnalysisIndex)</span>
<a href="#l2.2850"></a><span id="l2.2850">     mAnalysisStore.ReplaceElementsAt(mNextAnalysisIndex, 1, analysis);</span>
<a href="#l2.2851"></a><span id="l2.2851" class="difflineminus">-  else // we can only insert at the end of the array</span>
<a href="#l2.2852"></a><span id="l2.2852" class="difflineplus">+  else  // we can only insert at the end of the array</span>
<a href="#l2.2853"></a><span id="l2.2853">     return NS_ERROR_FAILURE;</span>
<a href="#l2.2854"></a><span id="l2.2854"> </span>
<a href="#l2.2855"></a><span id="l2.2855">   if (lastLink)</span>
<a href="#l2.2856"></a><span id="l2.2856">     // the token had at least one link, so update the last link to point to</span>
<a href="#l2.2857"></a><span id="l2.2857">     // the new item</span>
<a href="#l2.2858"></a><span id="l2.2858">     mAnalysisStore[lastLink].mNextLink = mNextAnalysisIndex;</span>
<a href="#l2.2859"></a><span id="l2.2859">   else</span>
<a href="#l2.2860"></a><span id="l2.2860">     // need to update the token's first link</span>
<a href="#l2.2861"></a><span id="l2.2861">     token.mAnalysisLink = mNextAnalysisIndex;</span>
<a href="#l2.2862"></a><span id="l2.2862">   mNextAnalysisIndex++;</span>
<a href="#l2.2863"></a><span id="l2.2863">   return NS_OK;</span>
<a href="#l2.2864"></a><span id="l2.2864"> }</span>
<a href="#l2.2865"></a><span id="l2.2865"> </span>
<a href="#l2.2866"></a><span id="l2.2866" class="difflineminus">-uint32_t nsBayesianFilter::getAnalysisIndex(Token&amp; token, uint32_t aTraitIndex)</span>
<a href="#l2.2867"></a><span id="l2.2867" class="difflineminus">-{</span>
<a href="#l2.2868"></a><span id="l2.2868" class="difflineplus">+uint32_t nsBayesianFilter::getAnalysisIndex(Token&amp; token,</span>
<a href="#l2.2869"></a><span id="l2.2869" class="difflineplus">+                                            uint32_t aTraitIndex) {</span>
<a href="#l2.2870"></a><span id="l2.2870">   uint32_t nextLink;</span>
<a href="#l2.2871"></a><span id="l2.2871">   uint32_t linkCount = 0, maxLinks = 100;</span>
<a href="#l2.2872"></a><span id="l2.2872" class="difflineminus">-  for (nextLink = token.mAnalysisLink; nextLink &amp;&amp; linkCount &lt; maxLinks; linkCount++)</span>
<a href="#l2.2873"></a><span id="l2.2873" class="difflineminus">-  {</span>
<a href="#l2.2874"></a><span id="l2.2874" class="difflineminus">-    AnalysisPerToken &amp;rAnalysis = mAnalysisStore[nextLink];</span>
<a href="#l2.2875"></a><span id="l2.2875" class="difflineminus">-    if (rAnalysis.mTraitIndex == aTraitIndex)</span>
<a href="#l2.2876"></a><span id="l2.2876" class="difflineminus">-      return nextLink;</span>
<a href="#l2.2877"></a><span id="l2.2877" class="difflineplus">+  for (nextLink = token.mAnalysisLink; nextLink &amp;&amp; linkCount &lt; maxLinks;</span>
<a href="#l2.2878"></a><span id="l2.2878" class="difflineplus">+       linkCount++) {</span>
<a href="#l2.2879"></a><span id="l2.2879" class="difflineplus">+    AnalysisPerToken&amp; rAnalysis = mAnalysisStore[nextLink];</span>
<a href="#l2.2880"></a><span id="l2.2880" class="difflineplus">+    if (rAnalysis.mTraitIndex == aTraitIndex) return nextLink;</span>
<a href="#l2.2881"></a><span id="l2.2881">     nextLink = rAnalysis.mNextLink;</span>
<a href="#l2.2882"></a><span id="l2.2882">   }</span>
<a href="#l2.2883"></a><span id="l2.2883">   NS_ASSERTION(linkCount &lt; maxLinks, &quot;corrupt analysis store&quot;);</span>
<a href="#l2.2884"></a><span id="l2.2884"> </span>
<a href="#l2.2885"></a><span id="l2.2885">   // Trait not found, indicate by zero</span>
<a href="#l2.2886"></a><span id="l2.2886">   return 0;</span>
<a href="#l2.2887"></a><span id="l2.2887"> }</span>
<a href="#l2.2888"></a><span id="l2.2888"> </span>
<a href="#l2.2889"></a><span id="l2.2889"> NS_IMETHODIMP nsBayesianFilter::ClassifyTraitsInMessage(</span>
<a href="#l2.2890"></a><span id="l2.2890" class="difflineminus">-  const char *aMsgURI,</span>
<a href="#l2.2891"></a><span id="l2.2891" class="difflineminus">-  uint32_t aTraitCount,</span>
<a href="#l2.2892"></a><span id="l2.2892" class="difflineminus">-  uint32_t *aProTraits,</span>
<a href="#l2.2893"></a><span id="l2.2893" class="difflineminus">-  uint32_t *aAntiTraits,</span>
<a href="#l2.2894"></a><span id="l2.2894" class="difflineminus">-  nsIMsgTraitClassificationListener *aTraitListener,</span>
<a href="#l2.2895"></a><span id="l2.2895" class="difflineminus">-  nsIMsgWindow *aMsgWindow,</span>
<a href="#l2.2896"></a><span id="l2.2896" class="difflineminus">-  nsIJunkMailClassificationListener *aJunkListener)</span>
<a href="#l2.2897"></a><span id="l2.2897" class="difflineminus">-{</span>
<a href="#l2.2898"></a><span id="l2.2898" class="difflineplus">+    const char* aMsgURI, uint32_t aTraitCount, uint32_t* aProTraits,</span>
<a href="#l2.2899"></a><span id="l2.2899" class="difflineplus">+    uint32_t* aAntiTraits, nsIMsgTraitClassificationListener* aTraitListener,</span>
<a href="#l2.2900"></a><span id="l2.2900" class="difflineplus">+    nsIMsgWindow* aMsgWindow,</span>
<a href="#l2.2901"></a><span id="l2.2901" class="difflineplus">+    nsIJunkMailClassificationListener* aJunkListener) {</span>
<a href="#l2.2902"></a><span id="l2.2902">   return ClassifyTraitsInMessages(1, &amp;aMsgURI, aTraitCount, aProTraits,</span>
<a href="#l2.2903"></a><span id="l2.2903" class="difflineminus">-    aAntiTraits, aTraitListener, aMsgWindow, aJunkListener);</span>
<a href="#l2.2904"></a><span id="l2.2904" class="difflineplus">+                                  aAntiTraits, aTraitListener, aMsgWindow,</span>
<a href="#l2.2905"></a><span id="l2.2905" class="difflineplus">+                                  aJunkListener);</span>
<a href="#l2.2906"></a><span id="l2.2906"> }</span>
<a href="#l2.2907"></a><span id="l2.2907"> </span>
<a href="#l2.2908"></a><span id="l2.2908"> NS_IMETHODIMP nsBayesianFilter::ClassifyTraitsInMessages(</span>
<a href="#l2.2909"></a><span id="l2.2909" class="difflineminus">-  uint32_t aCount,</span>
<a href="#l2.2910"></a><span id="l2.2910" class="difflineminus">-  const char **aMsgURIs,</span>
<a href="#l2.2911"></a><span id="l2.2911" class="difflineminus">-  uint32_t aTraitCount,</span>
<a href="#l2.2912"></a><span id="l2.2912" class="difflineminus">-  uint32_t *aProTraits,</span>
<a href="#l2.2913"></a><span id="l2.2913" class="difflineminus">-  uint32_t *aAntiTraits,</span>
<a href="#l2.2914"></a><span id="l2.2914" class="difflineminus">-  nsIMsgTraitClassificationListener *aTraitListener,</span>
<a href="#l2.2915"></a><span id="l2.2915" class="difflineminus">-  nsIMsgWindow *aMsgWindow,</span>
<a href="#l2.2916"></a><span id="l2.2916" class="difflineminus">-  nsIJunkMailClassificationListener *aJunkListener)</span>
<a href="#l2.2917"></a><span id="l2.2917" class="difflineminus">-{</span>
<a href="#l2.2918"></a><span id="l2.2918" class="difflineplus">+    uint32_t aCount, const char** aMsgURIs, uint32_t aTraitCount,</span>
<a href="#l2.2919"></a><span id="l2.2919" class="difflineplus">+    uint32_t* aProTraits, uint32_t* aAntiTraits,</span>
<a href="#l2.2920"></a><span id="l2.2920" class="difflineplus">+    nsIMsgTraitClassificationListener* aTraitListener, nsIMsgWindow* aMsgWindow,</span>
<a href="#l2.2921"></a><span id="l2.2921" class="difflineplus">+    nsIJunkMailClassificationListener* aJunkListener) {</span>
<a href="#l2.2922"></a><span id="l2.2922">   AutoTArray&lt;uint32_t, kTraitAutoCapacity&gt; proTraits;</span>
<a href="#l2.2923"></a><span id="l2.2923">   AutoTArray&lt;uint32_t, kTraitAutoCapacity&gt; antiTraits;</span>
<a href="#l2.2924"></a><span id="l2.2924" class="difflineminus">-  if (aTraitCount &gt; kTraitAutoCapacity)</span>
<a href="#l2.2925"></a><span id="l2.2925" class="difflineminus">-  {</span>
<a href="#l2.2926"></a><span id="l2.2926" class="difflineplus">+  if (aTraitCount &gt; kTraitAutoCapacity) {</span>
<a href="#l2.2927"></a><span id="l2.2927">     proTraits.SetCapacity(aTraitCount);</span>
<a href="#l2.2928"></a><span id="l2.2928">     antiTraits.SetCapacity(aTraitCount);</span>
<a href="#l2.2929"></a><span id="l2.2929">   }</span>
<a href="#l2.2930"></a><span id="l2.2930">   proTraits.AppendElements(aProTraits, aTraitCount);</span>
<a href="#l2.2931"></a><span id="l2.2931">   antiTraits.AppendElements(aAntiTraits, aTraitCount);</span>
<a href="#l2.2932"></a><span id="l2.2932"> </span>
<a href="#l2.2933"></a><span id="l2.2933" class="difflineminus">-  MessageClassifier* analyzer = new MessageClassifier(this, aJunkListener,</span>
<a href="#l2.2934"></a><span id="l2.2934" class="difflineminus">-    aTraitListener, nullptr, proTraits, antiTraits, aMsgWindow, aCount, aMsgURIs);</span>
<a href="#l2.2935"></a><span id="l2.2935" class="difflineplus">+  MessageClassifier* analyzer = new MessageClassifier(</span>
<a href="#l2.2936"></a><span id="l2.2936" class="difflineplus">+      this, aJunkListener, aTraitListener, nullptr, proTraits, antiTraits,</span>
<a href="#l2.2937"></a><span id="l2.2937" class="difflineplus">+      aMsgWindow, aCount, aMsgURIs);</span>
<a href="#l2.2938"></a><span id="l2.2938">   NS_ENSURE_TRUE(analyzer, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l2.2939"></a><span id="l2.2939"> </span>
<a href="#l2.2940"></a><span id="l2.2940" class="difflineminus">-  TokenStreamListener *tokenListener = new TokenStreamListener(analyzer);</span>
<a href="#l2.2941"></a><span id="l2.2941" class="difflineplus">+  TokenStreamListener* tokenListener = new TokenStreamListener(analyzer);</span>
<a href="#l2.2942"></a><span id="l2.2942">   NS_ENSURE_TRUE(tokenListener, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l2.2943"></a><span id="l2.2943"> </span>
<a href="#l2.2944"></a><span id="l2.2944">   analyzer-&gt;setTokenListener(tokenListener);</span>
<a href="#l2.2945"></a><span id="l2.2945">   return tokenizeMessage(aMsgURIs[0], aMsgWindow, analyzer);</span>
<a href="#l2.2946"></a><span id="l2.2946"> }</span>
<a href="#l2.2947"></a><span id="l2.2947"> </span>
<a href="#l2.2948"></a><span id="l2.2948"> class MessageObserver : public TokenAnalyzer {</span>
<a href="#l2.2949"></a><span id="l2.2949" class="difflineminus">-public:</span>
<a href="#l2.2950"></a><span id="l2.2950" class="difflineplus">+ public:</span>
<a href="#l2.2951"></a><span id="l2.2951">   MessageObserver(nsBayesianFilter* filter,</span>
<a href="#l2.2952"></a><span id="l2.2952">                   nsTArray&lt;uint32_t&gt;&amp; aOldClassifications,</span>
<a href="#l2.2953"></a><span id="l2.2953">                   nsTArray&lt;uint32_t&gt;&amp; aNewClassifications,</span>
<a href="#l2.2954"></a><span id="l2.2954">                   nsIJunkMailClassificationListener* aJunkListener,</span>
<a href="#l2.2955"></a><span id="l2.2955">                   nsIMsgTraitClassificationListener* aTraitListener)</span>
<a href="#l2.2956"></a><span id="l2.2956" class="difflineminus">-      :   mFilter(filter), mJunkMailPlugin(filter), mJunkListener(aJunkListener),</span>
<a href="#l2.2957"></a><span id="l2.2957" class="difflineminus">-          mTraitListener(aTraitListener),</span>
<a href="#l2.2958"></a><span id="l2.2958" class="difflineminus">-          mOldClassifications(aOldClassifications),</span>
<a href="#l2.2959"></a><span id="l2.2959" class="difflineminus">-          mNewClassifications(aNewClassifications)</span>
<a href="#l2.2960"></a><span id="l2.2960" class="difflineminus">-  {</span>
<a href="#l2.2961"></a><span id="l2.2961" class="difflineminus">-  }</span>
<a href="#l2.2962"></a><span id="l2.2962" class="difflineplus">+      : mFilter(filter),</span>
<a href="#l2.2963"></a><span id="l2.2963" class="difflineplus">+        mJunkMailPlugin(filter),</span>
<a href="#l2.2964"></a><span id="l2.2964" class="difflineplus">+        mJunkListener(aJunkListener),</span>
<a href="#l2.2965"></a><span id="l2.2965" class="difflineplus">+        mTraitListener(aTraitListener),</span>
<a href="#l2.2966"></a><span id="l2.2966" class="difflineplus">+        mOldClassifications(aOldClassifications),</span>
<a href="#l2.2967"></a><span id="l2.2967" class="difflineplus">+        mNewClassifications(aNewClassifications) {}</span>
<a href="#l2.2968"></a><span id="l2.2968"> </span>
<a href="#l2.2969"></a><span id="l2.2969" class="difflineminus">-  virtual void analyzeTokens(Tokenizer&amp; tokenizer)</span>
<a href="#l2.2970"></a><span id="l2.2970" class="difflineminus">-  {</span>
<a href="#l2.2971"></a><span id="l2.2971" class="difflineplus">+  virtual void analyzeTokens(Tokenizer&amp; tokenizer) {</span>
<a href="#l2.2972"></a><span id="l2.2972">     mFilter-&gt;observeMessage(tokenizer, mTokenSource.get(), mOldClassifications,</span>
<a href="#l2.2973"></a><span id="l2.2973">                             mNewClassifications, mJunkListener, mTraitListener);</span>
<a href="#l2.2974"></a><span id="l2.2974">     // release reference to listener, which will allow us to go away as well.</span>
<a href="#l2.2975"></a><span id="l2.2975">     mTokenListener = nullptr;</span>
<a href="#l2.2976"></a><span id="l2.2976">   }</span>
<a href="#l2.2977"></a><span id="l2.2977"> </span>
<a href="#l2.2978"></a><span id="l2.2978" class="difflineminus">-private:</span>
<a href="#l2.2979"></a><span id="l2.2979" class="difflineplus">+ private:</span>
<a href="#l2.2980"></a><span id="l2.2980">   nsBayesianFilter* mFilter;</span>
<a href="#l2.2981"></a><span id="l2.2981">   nsCOMPtr&lt;nsIJunkMailPlugin&gt; mJunkMailPlugin;</span>
<a href="#l2.2982"></a><span id="l2.2982">   nsCOMPtr&lt;nsIJunkMailClassificationListener&gt; mJunkListener;</span>
<a href="#l2.2983"></a><span id="l2.2983">   nsCOMPtr&lt;nsIMsgTraitClassificationListener&gt; mTraitListener;</span>
<a href="#l2.2984"></a><span id="l2.2984">   nsTArray&lt;uint32_t&gt; mOldClassifications;</span>
<a href="#l2.2985"></a><span id="l2.2985">   nsTArray&lt;uint32_t&gt; mNewClassifications;</span>
<a href="#l2.2986"></a><span id="l2.2986"> };</span>
<a href="#l2.2987"></a><span id="l2.2987"> </span>
<a href="#l2.2988"></a><span id="l2.2988"> NS_IMETHODIMP nsBayesianFilter::SetMsgTraitClassification(</span>
<a href="#l2.2989"></a><span id="l2.2989" class="difflineminus">-    const char *aMsgURI,</span>
<a href="#l2.2990"></a><span id="l2.2990" class="difflineminus">-    uint32_t aOldCount,</span>
<a href="#l2.2991"></a><span id="l2.2991" class="difflineminus">-    uint32_t *aOldTraits,</span>
<a href="#l2.2992"></a><span id="l2.2992" class="difflineminus">-    uint32_t aNewCount,</span>
<a href="#l2.2993"></a><span id="l2.2993" class="difflineminus">-    uint32_t *aNewTraits,</span>
<a href="#l2.2994"></a><span id="l2.2994" class="difflineminus">-    nsIMsgTraitClassificationListener *aTraitListener,</span>
<a href="#l2.2995"></a><span id="l2.2995" class="difflineminus">-    nsIMsgWindow *aMsgWindow,</span>
<a href="#l2.2996"></a><span id="l2.2996" class="difflineminus">-    nsIJunkMailClassificationListener *aJunkListener)</span>
<a href="#l2.2997"></a><span id="l2.2997" class="difflineminus">-{</span>
<a href="#l2.2998"></a><span id="l2.2998" class="difflineplus">+    const char* aMsgURI, uint32_t aOldCount, uint32_t* aOldTraits,</span>
<a href="#l2.2999"></a><span id="l2.2999" class="difflineplus">+    uint32_t aNewCount, uint32_t* aNewTraits,</span>
<a href="#l2.3000"></a><span id="l2.3000" class="difflineplus">+    nsIMsgTraitClassificationListener* aTraitListener, nsIMsgWindow* aMsgWindow,</span>
<a href="#l2.3001"></a><span id="l2.3001" class="difflineplus">+    nsIJunkMailClassificationListener* aJunkListener) {</span>
<a href="#l2.3002"></a><span id="l2.3002">   AutoTArray&lt;uint32_t, kTraitAutoCapacity&gt; oldTraits;</span>
<a href="#l2.3003"></a><span id="l2.3003">   AutoTArray&lt;uint32_t, kTraitAutoCapacity&gt; newTraits;</span>
<a href="#l2.3004"></a><span id="l2.3004" class="difflineminus">-  if (aOldCount &gt; kTraitAutoCapacity)</span>
<a href="#l2.3005"></a><span id="l2.3005" class="difflineminus">-    oldTraits.SetCapacity(aOldCount);</span>
<a href="#l2.3006"></a><span id="l2.3006" class="difflineminus">-  if (aNewCount &gt; kTraitAutoCapacity)</span>
<a href="#l2.3007"></a><span id="l2.3007" class="difflineminus">-    newTraits.SetCapacity(aNewCount);</span>
<a href="#l2.3008"></a><span id="l2.3008" class="difflineplus">+  if (aOldCount &gt; kTraitAutoCapacity) oldTraits.SetCapacity(aOldCount);</span>
<a href="#l2.3009"></a><span id="l2.3009" class="difflineplus">+  if (aNewCount &gt; kTraitAutoCapacity) newTraits.SetCapacity(aNewCount);</span>
<a href="#l2.3010"></a><span id="l2.3010">   oldTraits.AppendElements(aOldTraits, aOldCount);</span>
<a href="#l2.3011"></a><span id="l2.3011">   newTraits.AppendElements(aNewTraits, aNewCount);</span>
<a href="#l2.3012"></a><span id="l2.3012"> </span>
<a href="#l2.3013"></a><span id="l2.3013" class="difflineminus">-  MessageObserver* analyzer = new MessageObserver(this, oldTraits,</span>
<a href="#l2.3014"></a><span id="l2.3014" class="difflineminus">-    newTraits, aJunkListener, aTraitListener);</span>
<a href="#l2.3015"></a><span id="l2.3015" class="difflineplus">+  MessageObserver* analyzer = new MessageObserver(</span>
<a href="#l2.3016"></a><span id="l2.3016" class="difflineplus">+      this, oldTraits, newTraits, aJunkListener, aTraitListener);</span>
<a href="#l2.3017"></a><span id="l2.3017">   NS_ENSURE_TRUE(analyzer, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l2.3018"></a><span id="l2.3018"> </span>
<a href="#l2.3019"></a><span id="l2.3019" class="difflineminus">-  TokenStreamListener *tokenListener = new TokenStreamListener(analyzer);</span>
<a href="#l2.3020"></a><span id="l2.3020" class="difflineplus">+  TokenStreamListener* tokenListener = new TokenStreamListener(analyzer);</span>
<a href="#l2.3021"></a><span id="l2.3021">   NS_ENSURE_TRUE(tokenListener, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l2.3022"></a><span id="l2.3022"> </span>
<a href="#l2.3023"></a><span id="l2.3023">   analyzer-&gt;setTokenListener(tokenListener);</span>
<a href="#l2.3024"></a><span id="l2.3024">   return tokenizeMessage(aMsgURI, aMsgWindow, analyzer);</span>
<a href="#l2.3025"></a><span id="l2.3025"> }</span>
<a href="#l2.3026"></a><span id="l2.3026"> </span>
<a href="#l2.3027"></a><span id="l2.3027"> // set new message classifications for a message</span>
<a href="#l2.3028"></a><span id="l2.3028"> void nsBayesianFilter::observeMessage(</span>
<a href="#l2.3029"></a><span id="l2.3029" class="difflineminus">-    Tokenizer&amp; tokenizer,</span>
<a href="#l2.3030"></a><span id="l2.3030" class="difflineminus">-    const char* messageURL,</span>
<a href="#l2.3031"></a><span id="l2.3031" class="difflineplus">+    Tokenizer&amp; tokenizer, const char* messageURL,</span>
<a href="#l2.3032"></a><span id="l2.3032">     nsTArray&lt;uint32_t&gt;&amp; oldClassifications,</span>
<a href="#l2.3033"></a><span id="l2.3033">     nsTArray&lt;uint32_t&gt;&amp; newClassifications,</span>
<a href="#l2.3034"></a><span id="l2.3034">     nsIJunkMailClassificationListener* aJunkListener,</span>
<a href="#l2.3035"></a><span id="l2.3035" class="difflineminus">-    nsIMsgTraitClassificationListener* aTraitListener)</span>
<a href="#l2.3036"></a><span id="l2.3036" class="difflineminus">-{</span>
<a href="#l2.3037"></a><span id="l2.3037" class="difflineminus">-</span>
<a href="#l2.3038"></a><span id="l2.3038" class="difflineminus">-    bool trainingDataWasDirty = mTrainingDataDirty;</span>
<a href="#l2.3039"></a><span id="l2.3039" class="difflineplus">+    nsIMsgTraitClassificationListener* aTraitListener) {</span>
<a href="#l2.3040"></a><span id="l2.3040" class="difflineplus">+  bool trainingDataWasDirty = mTrainingDataDirty;</span>
<a href="#l2.3041"></a><span id="l2.3041"> </span>
<a href="#l2.3042"></a><span id="l2.3042" class="difflineminus">-    // Uhoh...if the user is re-training then the message may already be classified and we are classifying it again with the same classification.</span>
<a href="#l2.3043"></a><span id="l2.3043" class="difflineminus">-    // the old code would have removed the tokens for this message then added them back. But this really hurts the message occurrence</span>
<a href="#l2.3044"></a><span id="l2.3044" class="difflineminus">-    // count for tokens if you just removed training.dat and are re-training. See Bug #237095 for more details.</span>
<a href="#l2.3045"></a><span id="l2.3045" class="difflineminus">-    // What can we do here? Well we can skip the token removal step if the classifications are the same and assume the user is</span>
<a href="#l2.3046"></a><span id="l2.3046" class="difflineminus">-    // just re-training. But this then allows users to re-classify the same message on the same training set over and over again</span>
<a href="#l2.3047"></a><span id="l2.3047" class="difflineminus">-    // leading to data skew. But that's all I can think to do right now to address this.....</span>
<a href="#l2.3048"></a><span id="l2.3048" class="difflineminus">-    uint32_t oldLength = oldClassifications.Length();</span>
<a href="#l2.3049"></a><span id="l2.3049" class="difflineminus">-    for (uint32_t index = 0; index &lt; oldLength; index++)</span>
<a href="#l2.3050"></a><span id="l2.3050" class="difflineminus">-    {</span>
<a href="#l2.3051"></a><span id="l2.3051" class="difflineminus">-      uint32_t trait = oldClassifications.ElementAt(index);</span>
<a href="#l2.3052"></a><span id="l2.3052" class="difflineminus">-      // skip removing if trait is also in the new set</span>
<a href="#l2.3053"></a><span id="l2.3053" class="difflineminus">-      if (newClassifications.Contains(trait))</span>
<a href="#l2.3054"></a><span id="l2.3054" class="difflineminus">-        continue;</span>
<a href="#l2.3055"></a><span id="l2.3055" class="difflineminus">-      // remove the tokens from the token set it is currently in</span>
<a href="#l2.3056"></a><span id="l2.3056" class="difflineminus">-      uint32_t messageCount;</span>
<a href="#l2.3057"></a><span id="l2.3057" class="difflineminus">-      messageCount = mCorpus.getMessageCount(trait);</span>
<a href="#l2.3058"></a><span id="l2.3058" class="difflineminus">-      if (messageCount &gt; 0)</span>
<a href="#l2.3059"></a><span id="l2.3059" class="difflineminus">-      {</span>
<a href="#l2.3060"></a><span id="l2.3060" class="difflineminus">-        mCorpus.setMessageCount(trait, messageCount - 1);</span>
<a href="#l2.3061"></a><span id="l2.3061" class="difflineminus">-        mCorpus.forgetTokens(tokenizer, trait, 1);</span>
<a href="#l2.3062"></a><span id="l2.3062" class="difflineminus">-        mTrainingDataDirty = true;</span>
<a href="#l2.3063"></a><span id="l2.3063" class="difflineplus">+  // Uhoh...if the user is re-training then the message may already be</span>
<a href="#l2.3064"></a><span id="l2.3064" class="difflineplus">+  // classified and we are classifying it again with the same classification.</span>
<a href="#l2.3065"></a><span id="l2.3065" class="difflineplus">+  // the old code would have removed the tokens for this message then added them</span>
<a href="#l2.3066"></a><span id="l2.3066" class="difflineplus">+  // back. But this really hurts the message occurrence count for tokens if you</span>
<a href="#l2.3067"></a><span id="l2.3067" class="difflineplus">+  // just removed training.dat and are re-training. See Bug #237095 for more</span>
<a href="#l2.3068"></a><span id="l2.3068" class="difflineplus">+  // details. What can we do here? Well we can skip the token removal step if</span>
<a href="#l2.3069"></a><span id="l2.3069" class="difflineplus">+  // the classifications are the same and assume the user is just re-training.</span>
<a href="#l2.3070"></a><span id="l2.3070" class="difflineplus">+  // But this then allows users to re-classify the same message on the same</span>
<a href="#l2.3071"></a><span id="l2.3071" class="difflineplus">+  // training set over and over again leading to data skew. But that's all I can</span>
<a href="#l2.3072"></a><span id="l2.3072" class="difflineplus">+  // think to do right now to address this.....</span>
<a href="#l2.3073"></a><span id="l2.3073" class="difflineplus">+  uint32_t oldLength = oldClassifications.Length();</span>
<a href="#l2.3074"></a><span id="l2.3074" class="difflineplus">+  for (uint32_t index = 0; index &lt; oldLength; index++) {</span>
<a href="#l2.3075"></a><span id="l2.3075" class="difflineplus">+    uint32_t trait = oldClassifications.ElementAt(index);</span>
<a href="#l2.3076"></a><span id="l2.3076" class="difflineplus">+    // skip removing if trait is also in the new set</span>
<a href="#l2.3077"></a><span id="l2.3077" class="difflineplus">+    if (newClassifications.Contains(trait)) continue;</span>
<a href="#l2.3078"></a><span id="l2.3078" class="difflineplus">+    // remove the tokens from the token set it is currently in</span>
<a href="#l2.3079"></a><span id="l2.3079" class="difflineplus">+    uint32_t messageCount;</span>
<a href="#l2.3080"></a><span id="l2.3080" class="difflineplus">+    messageCount = mCorpus.getMessageCount(trait);</span>
<a href="#l2.3081"></a><span id="l2.3081" class="difflineplus">+    if (messageCount &gt; 0) {</span>
<a href="#l2.3082"></a><span id="l2.3082" class="difflineplus">+      mCorpus.setMessageCount(trait, messageCount - 1);</span>
<a href="#l2.3083"></a><span id="l2.3083" class="difflineplus">+      mCorpus.forgetTokens(tokenizer, trait, 1);</span>
<a href="#l2.3084"></a><span id="l2.3084" class="difflineplus">+      mTrainingDataDirty = true;</span>
<a href="#l2.3085"></a><span id="l2.3085" class="difflineplus">+    }</span>
<a href="#l2.3086"></a><span id="l2.3086" class="difflineplus">+  }</span>
<a href="#l2.3087"></a><span id="l2.3087" class="difflineplus">+</span>
<a href="#l2.3088"></a><span id="l2.3088" class="difflineplus">+  nsMsgJunkStatus newClassification = nsIJunkMailPlugin::UNCLASSIFIED;</span>
<a href="#l2.3089"></a><span id="l2.3089" class="difflineplus">+  uint32_t junkPercent =</span>
<a href="#l2.3090"></a><span id="l2.3090" class="difflineplus">+      0;  // 0 here is no possibility of meeting the classification</span>
<a href="#l2.3091"></a><span id="l2.3091" class="difflineplus">+  uint32_t newLength = newClassifications.Length();</span>
<a href="#l2.3092"></a><span id="l2.3092" class="difflineplus">+  for (uint32_t index = 0; index &lt; newLength; index++) {</span>
<a href="#l2.3093"></a><span id="l2.3093" class="difflineplus">+    uint32_t trait = newClassifications.ElementAt(index);</span>
<a href="#l2.3094"></a><span id="l2.3094" class="difflineplus">+    mCorpus.setMessageCount(trait, mCorpus.getMessageCount(trait) + 1);</span>
<a href="#l2.3095"></a><span id="l2.3095" class="difflineplus">+    mCorpus.rememberTokens(tokenizer, trait, 1);</span>
<a href="#l2.3096"></a><span id="l2.3096" class="difflineplus">+    mTrainingDataDirty = true;</span>
<a href="#l2.3097"></a><span id="l2.3097" class="difflineplus">+</span>
<a href="#l2.3098"></a><span id="l2.3098" class="difflineplus">+    if (aJunkListener) {</span>
<a href="#l2.3099"></a><span id="l2.3099" class="difflineplus">+      if (trait == kJunkTrait) {</span>
<a href="#l2.3100"></a><span id="l2.3100" class="difflineplus">+        junkPercent = nsIJunkMailPlugin::IS_SPAM_SCORE;</span>
<a href="#l2.3101"></a><span id="l2.3101" class="difflineplus">+        newClassification = nsIJunkMailPlugin::JUNK;</span>
<a href="#l2.3102"></a><span id="l2.3102" class="difflineplus">+      } else if (trait == kGoodTrait) {</span>
<a href="#l2.3103"></a><span id="l2.3103" class="difflineplus">+        junkPercent = nsIJunkMailPlugin::IS_HAM_SCORE;</span>
<a href="#l2.3104"></a><span id="l2.3104" class="difflineplus">+        newClassification = nsIJunkMailPlugin::GOOD;</span>
<a href="#l2.3105"></a><span id="l2.3105">       }</span>
<a href="#l2.3106"></a><span id="l2.3106">     }</span>
<a href="#l2.3107"></a><span id="l2.3107" class="difflineminus">-</span>
<a href="#l2.3108"></a><span id="l2.3108" class="difflineminus">-    nsMsgJunkStatus newClassification = nsIJunkMailPlugin::UNCLASSIFIED;</span>
<a href="#l2.3109"></a><span id="l2.3109" class="difflineminus">-    uint32_t junkPercent = 0; // 0 here is no possibility of meeting the classification</span>
<a href="#l2.3110"></a><span id="l2.3110" class="difflineminus">-    uint32_t newLength = newClassifications.Length();</span>
<a href="#l2.3111"></a><span id="l2.3111" class="difflineminus">-    for (uint32_t index = 0; index &lt; newLength; index++)</span>
<a href="#l2.3112"></a><span id="l2.3112" class="difflineminus">-    {</span>
<a href="#l2.3113"></a><span id="l2.3113" class="difflineminus">-      uint32_t trait = newClassifications.ElementAt(index);</span>
<a href="#l2.3114"></a><span id="l2.3114" class="difflineminus">-      mCorpus.setMessageCount(trait, mCorpus.getMessageCount(trait) + 1);</span>
<a href="#l2.3115"></a><span id="l2.3115" class="difflineminus">-      mCorpus.rememberTokens(tokenizer, trait, 1);</span>
<a href="#l2.3116"></a><span id="l2.3116" class="difflineminus">-      mTrainingDataDirty = true;</span>
<a href="#l2.3117"></a><span id="l2.3117" class="difflineplus">+  }</span>
<a href="#l2.3118"></a><span id="l2.3118"> </span>
<a href="#l2.3119"></a><span id="l2.3119" class="difflineminus">-      if (aJunkListener)</span>
<a href="#l2.3120"></a><span id="l2.3120" class="difflineminus">-      {</span>
<a href="#l2.3121"></a><span id="l2.3121" class="difflineminus">-        if (trait == kJunkTrait)</span>
<a href="#l2.3122"></a><span id="l2.3122" class="difflineminus">-        {</span>
<a href="#l2.3123"></a><span id="l2.3123" class="difflineminus">-          junkPercent = nsIJunkMailPlugin::IS_SPAM_SCORE;</span>
<a href="#l2.3124"></a><span id="l2.3124" class="difflineminus">-          newClassification = nsIJunkMailPlugin::JUNK;</span>
<a href="#l2.3125"></a><span id="l2.3125" class="difflineminus">-        }</span>
<a href="#l2.3126"></a><span id="l2.3126" class="difflineminus">-        else if (trait == kGoodTrait)</span>
<a href="#l2.3127"></a><span id="l2.3127" class="difflineminus">-        {</span>
<a href="#l2.3128"></a><span id="l2.3128" class="difflineminus">-          junkPercent = nsIJunkMailPlugin::IS_HAM_SCORE;</span>
<a href="#l2.3129"></a><span id="l2.3129" class="difflineminus">-          newClassification = nsIJunkMailPlugin::GOOD;</span>
<a href="#l2.3130"></a><span id="l2.3130" class="difflineminus">-        }</span>
<a href="#l2.3131"></a><span id="l2.3131" class="difflineminus">-      }</span>
<a href="#l2.3132"></a><span id="l2.3132" class="difflineminus">-    }</span>
<a href="#l2.3133"></a><span id="l2.3133" class="difflineminus">-</span>
<a href="#l2.3134"></a><span id="l2.3134" class="difflineminus">-    if (aJunkListener)</span>
<a href="#l2.3135"></a><span id="l2.3135" class="difflineminus">-      aJunkListener-&gt;OnMessageClassified(messageURL, newClassification, junkPercent);</span>
<a href="#l2.3136"></a><span id="l2.3136" class="difflineplus">+  if (aJunkListener)</span>
<a href="#l2.3137"></a><span id="l2.3137" class="difflineplus">+    aJunkListener-&gt;OnMessageClassified(messageURL, newClassification,</span>
<a href="#l2.3138"></a><span id="l2.3138" class="difflineplus">+                                       junkPercent);</span>
<a href="#l2.3139"></a><span id="l2.3139"> </span>
<a href="#l2.3140"></a><span id="l2.3140" class="difflineminus">-    if (aTraitListener)</span>
<a href="#l2.3141"></a><span id="l2.3141" class="difflineminus">-    {</span>
<a href="#l2.3142"></a><span id="l2.3142" class="difflineminus">-      // construct the outgoing listener arrays</span>
<a href="#l2.3143"></a><span id="l2.3143" class="difflineminus">-      AutoTArray&lt;uint32_t, kTraitAutoCapacity&gt; traits;</span>
<a href="#l2.3144"></a><span id="l2.3144" class="difflineminus">-      AutoTArray&lt;uint32_t, kTraitAutoCapacity&gt; percents;</span>
<a href="#l2.3145"></a><span id="l2.3145" class="difflineminus">-      uint32_t newLength = newClassifications.Length();</span>
<a href="#l2.3146"></a><span id="l2.3146" class="difflineminus">-      if (newLength &gt; kTraitAutoCapacity)</span>
<a href="#l2.3147"></a><span id="l2.3147" class="difflineminus">-      {</span>
<a href="#l2.3148"></a><span id="l2.3148" class="difflineminus">-        traits.SetCapacity(newLength);</span>
<a href="#l2.3149"></a><span id="l2.3149" class="difflineminus">-        percents.SetCapacity(newLength);</span>
<a href="#l2.3150"></a><span id="l2.3150" class="difflineminus">-      }</span>
<a href="#l2.3151"></a><span id="l2.3151" class="difflineminus">-      traits.AppendElements(newClassifications);</span>
<a href="#l2.3152"></a><span id="l2.3152" class="difflineminus">-      for (uint32_t index = 0; index &lt; newLength; index++)</span>
<a href="#l2.3153"></a><span id="l2.3153" class="difflineminus">-        percents.AppendElement(100); // This is 100 percent, or certainty</span>
<a href="#l2.3154"></a><span id="l2.3154" class="difflineminus">-      aTraitListener-&gt;OnMessageTraitsClassified(messageURL,</span>
<a href="#l2.3155"></a><span id="l2.3155" class="difflineminus">-          traits.Length(), traits.Elements(), percents.Elements());</span>
<a href="#l2.3156"></a><span id="l2.3156" class="difflineplus">+  if (aTraitListener) {</span>
<a href="#l2.3157"></a><span id="l2.3157" class="difflineplus">+    // construct the outgoing listener arrays</span>
<a href="#l2.3158"></a><span id="l2.3158" class="difflineplus">+    AutoTArray&lt;uint32_t, kTraitAutoCapacity&gt; traits;</span>
<a href="#l2.3159"></a><span id="l2.3159" class="difflineplus">+    AutoTArray&lt;uint32_t, kTraitAutoCapacity&gt; percents;</span>
<a href="#l2.3160"></a><span id="l2.3160" class="difflineplus">+    uint32_t newLength = newClassifications.Length();</span>
<a href="#l2.3161"></a><span id="l2.3161" class="difflineplus">+    if (newLength &gt; kTraitAutoCapacity) {</span>
<a href="#l2.3162"></a><span id="l2.3162" class="difflineplus">+      traits.SetCapacity(newLength);</span>
<a href="#l2.3163"></a><span id="l2.3163" class="difflineplus">+      percents.SetCapacity(newLength);</span>
<a href="#l2.3164"></a><span id="l2.3164">     }</span>
<a href="#l2.3165"></a><span id="l2.3165" class="difflineplus">+    traits.AppendElements(newClassifications);</span>
<a href="#l2.3166"></a><span id="l2.3166" class="difflineplus">+    for (uint32_t index = 0; index &lt; newLength; index++)</span>
<a href="#l2.3167"></a><span id="l2.3167" class="difflineplus">+      percents.AppendElement(100);  // This is 100 percent, or certainty</span>
<a href="#l2.3168"></a><span id="l2.3168" class="difflineplus">+    aTraitListener-&gt;OnMessageTraitsClassified(</span>
<a href="#l2.3169"></a><span id="l2.3169" class="difflineplus">+        messageURL, traits.Length(), traits.Elements(), percents.Elements());</span>
<a href="#l2.3170"></a><span id="l2.3170" class="difflineplus">+  }</span>
<a href="#l2.3171"></a><span id="l2.3171"> </span>
<a href="#l2.3172"></a><span id="l2.3172" class="difflineminus">-    if (mTrainingDataDirty &amp;&amp; !trainingDataWasDirty &amp;&amp; ( mTimer != nullptr ))</span>
<a href="#l2.3173"></a><span id="l2.3173" class="difflineminus">-    {</span>
<a href="#l2.3174"></a><span id="l2.3174" class="difflineminus">-        // if training data became dirty just now, schedule flush</span>
<a href="#l2.3175"></a><span id="l2.3175" class="difflineminus">-        // mMinFlushInterval msec from now</span>
<a href="#l2.3176"></a><span id="l2.3176" class="difflineminus">-        MOZ_LOG(</span>
<a href="#l2.3177"></a><span id="l2.3177" class="difflineminus">-            BayesianFilterLogModule, LogLevel::Debug,</span>
<a href="#l2.3178"></a><span id="l2.3178" class="difflineplus">+  if (mTrainingDataDirty &amp;&amp; !trainingDataWasDirty &amp;&amp; (mTimer != nullptr)) {</span>
<a href="#l2.3179"></a><span id="l2.3179" class="difflineplus">+    // if training data became dirty just now, schedule flush</span>
<a href="#l2.3180"></a><span id="l2.3180" class="difflineplus">+    // mMinFlushInterval msec from now</span>
<a href="#l2.3181"></a><span id="l2.3181" class="difflineplus">+    MOZ_LOG(BayesianFilterLogModule, LogLevel::Debug,</span>
<a href="#l2.3182"></a><span id="l2.3182">             (&quot;starting training data flush timer %i msec&quot;, mMinFlushInterval));</span>
<a href="#l2.3183"></a><span id="l2.3183" class="difflineminus">-        mTimer-&gt;InitWithNamedFuncCallback(nsBayesianFilter::TimerCallback,</span>
<a href="#l2.3184"></a><span id="l2.3184" class="difflineminus">-                                          this, mMinFlushInterval,</span>
<a href="#l2.3185"></a><span id="l2.3185" class="difflineminus">-                                          nsITimer::TYPE_ONE_SHOT,</span>
<a href="#l2.3186"></a><span id="l2.3186" class="difflineminus">-                                          &quot;nsBayesianFilter::TimerCallback&quot;);</span>
<a href="#l2.3187"></a><span id="l2.3187" class="difflineminus">-    }</span>
<a href="#l2.3188"></a><span id="l2.3188" class="difflineplus">+    mTimer-&gt;InitWithNamedFuncCallback(</span>
<a href="#l2.3189"></a><span id="l2.3189" class="difflineplus">+        nsBayesianFilter::TimerCallback, this, mMinFlushInterval,</span>
<a href="#l2.3190"></a><span id="l2.3190" class="difflineplus">+        nsITimer::TYPE_ONE_SHOT, &quot;nsBayesianFilter::TimerCallback&quot;);</span>
<a href="#l2.3191"></a><span id="l2.3191" class="difflineplus">+  }</span>
<a href="#l2.3192"></a><span id="l2.3192"> }</span>
<a href="#l2.3193"></a><span id="l2.3193"> </span>
<a href="#l2.3194"></a><span id="l2.3194" class="difflineminus">-NS_IMETHODIMP nsBayesianFilter::GetUserHasClassified(bool *aResult)</span>
<a href="#l2.3195"></a><span id="l2.3195" class="difflineminus">-{</span>
<a href="#l2.3196"></a><span id="l2.3196" class="difflineminus">-  *aResult = (  (mCorpus.getMessageCount(kGoodTrait) +</span>
<a href="#l2.3197"></a><span id="l2.3197" class="difflineminus">-                 mCorpus.getMessageCount(kJunkTrait)) &amp;&amp;</span>
<a href="#l2.3198"></a><span id="l2.3198" class="difflineminus">-                 mCorpus.countTokens());</span>
<a href="#l2.3199"></a><span id="l2.3199" class="difflineplus">+NS_IMETHODIMP nsBayesianFilter::GetUserHasClassified(bool* aResult) {</span>
<a href="#l2.3200"></a><span id="l2.3200" class="difflineplus">+  *aResult = ((mCorpus.getMessageCount(kGoodTrait) +</span>
<a href="#l2.3201"></a><span id="l2.3201" class="difflineplus">+               mCorpus.getMessageCount(kJunkTrait)) &amp;&amp;</span>
<a href="#l2.3202"></a><span id="l2.3202" class="difflineplus">+              mCorpus.countTokens());</span>
<a href="#l2.3203"></a><span id="l2.3203">   return NS_OK;</span>
<a href="#l2.3204"></a><span id="l2.3204"> }</span>
<a href="#l2.3205"></a><span id="l2.3205"> </span>
<a href="#l2.3206"></a><span id="l2.3206"> // Set message classification (only allows junk and good)</span>
<a href="#l2.3207"></a><span id="l2.3207"> NS_IMETHODIMP nsBayesianFilter::SetMessageClassification(</span>
<a href="#l2.3208"></a><span id="l2.3208" class="difflineminus">-    const char *aMsgURL,</span>
<a href="#l2.3209"></a><span id="l2.3209" class="difflineminus">-    nsMsgJunkStatus aOldClassification,</span>
<a href="#l2.3210"></a><span id="l2.3210" class="difflineminus">-    nsMsgJunkStatus aNewClassification,</span>
<a href="#l2.3211"></a><span id="l2.3211" class="difflineminus">-    nsIMsgWindow *aMsgWindow,</span>
<a href="#l2.3212"></a><span id="l2.3212" class="difflineminus">-    nsIJunkMailClassificationListener *aListener)</span>
<a href="#l2.3213"></a><span id="l2.3213" class="difflineminus">-{</span>
<a href="#l2.3214"></a><span id="l2.3214" class="difflineplus">+    const char* aMsgURL, nsMsgJunkStatus aOldClassification,</span>
<a href="#l2.3215"></a><span id="l2.3215" class="difflineplus">+    nsMsgJunkStatus aNewClassification, nsIMsgWindow* aMsgWindow,</span>
<a href="#l2.3216"></a><span id="l2.3216" class="difflineplus">+    nsIJunkMailClassificationListener* aListener) {</span>
<a href="#l2.3217"></a><span id="l2.3217">   AutoTArray&lt;uint32_t, 1&gt; oldClassifications;</span>
<a href="#l2.3218"></a><span id="l2.3218">   AutoTArray&lt;uint32_t, 1&gt; newClassifications;</span>
<a href="#l2.3219"></a><span id="l2.3219"> </span>
<a href="#l2.3220"></a><span id="l2.3220">   // convert between classifications and trait</span>
<a href="#l2.3221"></a><span id="l2.3221">   if (aOldClassification == nsIJunkMailPlugin::JUNK)</span>
<a href="#l2.3222"></a><span id="l2.3222">     oldClassifications.AppendElement(kJunkTrait);</span>
<a href="#l2.3223"></a><span id="l2.3223">   else if (aOldClassification == nsIJunkMailPlugin::GOOD)</span>
<a href="#l2.3224"></a><span id="l2.3224">     oldClassifications.AppendElement(kGoodTrait);</span>
<a href="#l2.3225"></a><span id="l2.3225">   if (aNewClassification == nsIJunkMailPlugin::JUNK)</span>
<a href="#l2.3226"></a><span id="l2.3226">     newClassifications.AppendElement(kJunkTrait);</span>
<a href="#l2.3227"></a><span id="l2.3227">   else if (aNewClassification == nsIJunkMailPlugin::GOOD)</span>
<a href="#l2.3228"></a><span id="l2.3228">     newClassifications.AppendElement(kGoodTrait);</span>
<a href="#l2.3229"></a><span id="l2.3229"> </span>
<a href="#l2.3230"></a><span id="l2.3230" class="difflineminus">-  MessageObserver* analyzer = new MessageObserver(this, oldClassifications,</span>
<a href="#l2.3231"></a><span id="l2.3231" class="difflineminus">-    newClassifications, aListener, nullptr);</span>
<a href="#l2.3232"></a><span id="l2.3232" class="difflineplus">+  MessageObserver* analyzer = new MessageObserver(</span>
<a href="#l2.3233"></a><span id="l2.3233" class="difflineplus">+      this, oldClassifications, newClassifications, aListener, nullptr);</span>
<a href="#l2.3234"></a><span id="l2.3234">   NS_ENSURE_TRUE(analyzer, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l2.3235"></a><span id="l2.3235"> </span>
<a href="#l2.3236"></a><span id="l2.3236" class="difflineminus">-  TokenStreamListener *tokenListener = new TokenStreamListener(analyzer);</span>
<a href="#l2.3237"></a><span id="l2.3237" class="difflineplus">+  TokenStreamListener* tokenListener = new TokenStreamListener(analyzer);</span>
<a href="#l2.3238"></a><span id="l2.3238">   NS_ENSURE_TRUE(tokenListener, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l2.3239"></a><span id="l2.3239"> </span>
<a href="#l2.3240"></a><span id="l2.3240">   analyzer-&gt;setTokenListener(tokenListener);</span>
<a href="#l2.3241"></a><span id="l2.3241">   return tokenizeMessage(aMsgURL, aMsgWindow, analyzer);</span>
<a href="#l2.3242"></a><span id="l2.3242"> }</span>
<a href="#l2.3243"></a><span id="l2.3243"> </span>
<a href="#l2.3244"></a><span id="l2.3244" class="difflineminus">-NS_IMETHODIMP nsBayesianFilter::ResetTrainingData()</span>
<a href="#l2.3245"></a><span id="l2.3245" class="difflineminus">-{</span>
<a href="#l2.3246"></a><span id="l2.3246" class="difflineplus">+NS_IMETHODIMP nsBayesianFilter::ResetTrainingData() {</span>
<a href="#l2.3247"></a><span id="l2.3247">   return mCorpus.resetTrainingData();</span>
<a href="#l2.3248"></a><span id="l2.3248"> }</span>
<a href="#l2.3249"></a><span id="l2.3249"> </span>
<a href="#l2.3250"></a><span id="l2.3250" class="difflineminus">-NS_IMETHODIMP nsBayesianFilter::DetailMessage(const char *aMsgURI,</span>
<a href="#l2.3251"></a><span id="l2.3251" class="difflineminus">-    uint32_t aProTrait, uint32_t aAntiTrait,</span>
<a href="#l2.3252"></a><span id="l2.3252" class="difflineminus">-    nsIMsgTraitDetailListener *aDetailListener, nsIMsgWindow *aMsgWindow)</span>
<a href="#l2.3253"></a><span id="l2.3253" class="difflineminus">-{</span>
<a href="#l2.3254"></a><span id="l2.3254" class="difflineplus">+NS_IMETHODIMP nsBayesianFilter::DetailMessage(</span>
<a href="#l2.3255"></a><span id="l2.3255" class="difflineplus">+    const char* aMsgURI, uint32_t aProTrait, uint32_t aAntiTrait,</span>
<a href="#l2.3256"></a><span id="l2.3256" class="difflineplus">+    nsIMsgTraitDetailListener* aDetailListener, nsIMsgWindow* aMsgWindow) {</span>
<a href="#l2.3257"></a><span id="l2.3257">   AutoTArray&lt;uint32_t, 1&gt; proTraits;</span>
<a href="#l2.3258"></a><span id="l2.3258">   AutoTArray&lt;uint32_t, 1&gt; antiTraits;</span>
<a href="#l2.3259"></a><span id="l2.3259">   proTraits.AppendElement(aProTrait);</span>
<a href="#l2.3260"></a><span id="l2.3260">   antiTraits.AppendElement(aAntiTrait);</span>
<a href="#l2.3261"></a><span id="l2.3261"> </span>
<a href="#l2.3262"></a><span id="l2.3262" class="difflineminus">-  MessageClassifier* analyzer = new MessageClassifier(this, nullptr,</span>
<a href="#l2.3263"></a><span id="l2.3263" class="difflineminus">-    nullptr, aDetailListener, proTraits, antiTraits, aMsgWindow, 1, &amp;aMsgURI);</span>
<a href="#l2.3264"></a><span id="l2.3264" class="difflineplus">+  MessageClassifier* analyzer =</span>
<a href="#l2.3265"></a><span id="l2.3265" class="difflineplus">+      new MessageClassifier(this, nullptr, nullptr, aDetailListener, proTraits,</span>
<a href="#l2.3266"></a><span id="l2.3266" class="difflineplus">+                            antiTraits, aMsgWindow, 1, &amp;aMsgURI);</span>
<a href="#l2.3267"></a><span id="l2.3267">   NS_ENSURE_TRUE(analyzer, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l2.3268"></a><span id="l2.3268"> </span>
<a href="#l2.3269"></a><span id="l2.3269" class="difflineminus">-  TokenStreamListener *tokenListener = new TokenStreamListener(analyzer);</span>
<a href="#l2.3270"></a><span id="l2.3270" class="difflineplus">+  TokenStreamListener* tokenListener = new TokenStreamListener(analyzer);</span>
<a href="#l2.3271"></a><span id="l2.3271">   NS_ENSURE_TRUE(tokenListener, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l2.3272"></a><span id="l2.3272"> </span>
<a href="#l2.3273"></a><span id="l2.3273">   analyzer-&gt;setTokenListener(tokenListener);</span>
<a href="#l2.3274"></a><span id="l2.3274">   return tokenizeMessage(aMsgURI, aMsgWindow, analyzer);</span>
<a href="#l2.3275"></a><span id="l2.3275"> }</span>
<a href="#l2.3276"></a><span id="l2.3276"> </span>
<a href="#l2.3277"></a><span id="l2.3277"> // nsIMsgCorpus implementation</span>
<a href="#l2.3278"></a><span id="l2.3278"> </span>
<a href="#l2.3279"></a><span id="l2.3279"> NS_IMETHODIMP nsBayesianFilter::CorpusCounts(uint32_t aTrait,</span>
<a href="#l2.3280"></a><span id="l2.3280" class="difflineminus">-                                             uint32_t *aMessageCount,</span>
<a href="#l2.3281"></a><span id="l2.3281" class="difflineminus">-                                             uint32_t *aTokenCount)</span>
<a href="#l2.3282"></a><span id="l2.3282" class="difflineminus">-{</span>
<a href="#l2.3283"></a><span id="l2.3283" class="difflineplus">+                                             uint32_t* aMessageCount,</span>
<a href="#l2.3284"></a><span id="l2.3284" class="difflineplus">+                                             uint32_t* aTokenCount) {</span>
<a href="#l2.3285"></a><span id="l2.3285">   NS_ENSURE_ARG_POINTER(aTokenCount);</span>
<a href="#l2.3286"></a><span id="l2.3286">   *aTokenCount = mCorpus.countTokens();</span>
<a href="#l2.3287"></a><span id="l2.3287" class="difflineminus">-  if (aTrait &amp;&amp; aMessageCount)</span>
<a href="#l2.3288"></a><span id="l2.3288" class="difflineminus">-    *aMessageCount = mCorpus.getMessageCount(aTrait);</span>
<a href="#l2.3289"></a><span id="l2.3289" class="difflineplus">+  if (aTrait &amp;&amp; aMessageCount) *aMessageCount = mCorpus.getMessageCount(aTrait);</span>
<a href="#l2.3290"></a><span id="l2.3290">   return NS_OK;</span>
<a href="#l2.3291"></a><span id="l2.3291"> }</span>
<a href="#l2.3292"></a><span id="l2.3292"> </span>
<a href="#l2.3293"></a><span id="l2.3293" class="difflineminus">-NS_IMETHODIMP nsBayesianFilter::ClearTrait(uint32_t aTrait)</span>
<a href="#l2.3294"></a><span id="l2.3294" class="difflineminus">-{</span>
<a href="#l2.3295"></a><span id="l2.3295" class="difflineminus">-    return mCorpus.ClearTrait(aTrait);</span>
<a href="#l2.3296"></a><span id="l2.3296" class="difflineplus">+NS_IMETHODIMP nsBayesianFilter::ClearTrait(uint32_t aTrait) {</span>
<a href="#l2.3297"></a><span id="l2.3297" class="difflineplus">+  return mCorpus.ClearTrait(aTrait);</span>
<a href="#l2.3298"></a><span id="l2.3298"> }</span>
<a href="#l2.3299"></a><span id="l2.3299"> </span>
<a href="#l2.3300"></a><span id="l2.3300"> NS_IMETHODIMP</span>
<a href="#l2.3301"></a><span id="l2.3301" class="difflineminus">-nsBayesianFilter::UpdateData(nsIFile *aFile,</span>
<a href="#l2.3302"></a><span id="l2.3302" class="difflineminus">-                             bool aIsAdd,</span>
<a href="#l2.3303"></a><span id="l2.3303" class="difflineminus">-                             uint32_t aRemapCount,</span>
<a href="#l2.3304"></a><span id="l2.3304" class="difflineminus">-                             uint32_t *aFromTraits,</span>
<a href="#l2.3305"></a><span id="l2.3305" class="difflineminus">-                             uint32_t *aToTraits)</span>
<a href="#l2.3306"></a><span id="l2.3306" class="difflineminus">-{</span>
<a href="#l2.3307"></a><span id="l2.3307" class="difflineplus">+nsBayesianFilter::UpdateData(nsIFile* aFile, bool aIsAdd, uint32_t aRemapCount,</span>
<a href="#l2.3308"></a><span id="l2.3308" class="difflineplus">+                             uint32_t* aFromTraits, uint32_t* aToTraits) {</span>
<a href="#l2.3309"></a><span id="l2.3309">   return mCorpus.UpdateData(aFile, aIsAdd, aRemapCount, aFromTraits, aToTraits);</span>
<a href="#l2.3310"></a><span id="l2.3310"> }</span>
<a href="#l2.3311"></a><span id="l2.3311"> </span>
<a href="#l2.3312"></a><span id="l2.3312"> NS_IMETHODIMP</span>
<a href="#l2.3313"></a><span id="l2.3313" class="difflineminus">-nsBayesianFilter::GetTokenCount(const nsACString &amp;aWord,</span>
<a href="#l2.3314"></a><span id="l2.3314" class="difflineminus">-                                uint32_t aTrait,</span>
<a href="#l2.3315"></a><span id="l2.3315" class="difflineminus">-                                uint32_t *aCount)</span>
<a href="#l2.3316"></a><span id="l2.3316" class="difflineminus">-{</span>
<a href="#l2.3317"></a><span id="l2.3317" class="difflineplus">+nsBayesianFilter::GetTokenCount(const nsACString&amp; aWord, uint32_t aTrait,</span>
<a href="#l2.3318"></a><span id="l2.3318" class="difflineplus">+                                uint32_t* aCount) {</span>
<a href="#l2.3319"></a><span id="l2.3319">   NS_ENSURE_ARG_POINTER(aCount);</span>
<a href="#l2.3320"></a><span id="l2.3320">   CorpusToken* t = mCorpus.get(PromiseFlatCString(aWord).get());</span>
<a href="#l2.3321"></a><span id="l2.3321">   uint32_t count = mCorpus.getTraitCount(t, aTrait);</span>
<a href="#l2.3322"></a><span id="l2.3322">   *aCount = count;</span>
<a href="#l2.3323"></a><span id="l2.3323">   return NS_OK;</span>
<a href="#l2.3324"></a><span id="l2.3324"> }</span>
<a href="#l2.3325"></a><span id="l2.3325"> </span>
<a href="#l2.3326"></a><span id="l2.3326"> /* Corpus Store */</span>
<a href="#l2.3327"></a><span id="l2.3327" class="difflineat">@@ -2216,432 +2068,376 @@ nsBayesianFilter::GetTokenCount(const ns</span>
<a href="#l2.3328"></a><span id="l2.3328">     for each trait to write</span>
<a href="#l2.3329"></a><span id="l2.3329">       [id of trait to write] (0 means end of list)</span>
<a href="#l2.3330"></a><span id="l2.3330">       [number of messages per trait]</span>
<a href="#l2.3331"></a><span id="l2.3331">       for each token with non-zero count</span>
<a href="#l2.3332"></a><span id="l2.3332">         [count]</span>
<a href="#l2.3333"></a><span id="l2.3333">         [length of word]word</span>
<a href="#l2.3334"></a><span id="l2.3334"> */</span>
<a href="#l2.3335"></a><span id="l2.3335"> </span>
<a href="#l2.3336"></a><span id="l2.3336" class="difflineminus">-CorpusStore::CorpusStore() :</span>
<a href="#l2.3337"></a><span id="l2.3337" class="difflineminus">-  TokenHash(sizeof(CorpusToken)),</span>
<a href="#l2.3338"></a><span id="l2.3338" class="difflineminus">-  mNextTraitIndex(1) // skip 0 since index=0 will mean end of linked list</span>
<a href="#l2.3339"></a><span id="l2.3339" class="difflineplus">+CorpusStore::CorpusStore()</span>
<a href="#l2.3340"></a><span id="l2.3340" class="difflineplus">+    : TokenHash(sizeof(CorpusToken)),</span>
<a href="#l2.3341"></a><span id="l2.3341" class="difflineplus">+      mNextTraitIndex(1)  // skip 0 since index=0 will mean end of linked list</span>
<a href="#l2.3342"></a><span id="l2.3342"> {</span>
<a href="#l2.3343"></a><span id="l2.3343">   getTrainingFile(getter_AddRefs(mTrainingFile));</span>
<a href="#l2.3344"></a><span id="l2.3344">   mTraitStore.SetCapacity(kTraitStoreCapacity);</span>
<a href="#l2.3345"></a><span id="l2.3345">   TraitPerToken traitPT(0, 0);</span>
<a href="#l2.3346"></a><span id="l2.3346" class="difflineminus">-  mTraitStore.AppendElement(traitPT); // dummy 0th element</span>
<a href="#l2.3347"></a><span id="l2.3347" class="difflineplus">+  mTraitStore.AppendElement(traitPT);  // dummy 0th element</span>
<a href="#l2.3348"></a><span id="l2.3348"> }</span>
<a href="#l2.3349"></a><span id="l2.3349"> </span>
<a href="#l2.3350"></a><span id="l2.3350" class="difflineminus">-CorpusStore::~CorpusStore()</span>
<a href="#l2.3351"></a><span id="l2.3351" class="difflineminus">-{</span>
<a href="#l2.3352"></a><span id="l2.3352" class="difflineminus">-}</span>
<a href="#l2.3353"></a><span id="l2.3353" class="difflineplus">+CorpusStore::~CorpusStore() {}</span>
<a href="#l2.3354"></a><span id="l2.3354"> </span>
<a href="#l2.3355"></a><span id="l2.3355" class="difflineminus">-inline int writeUInt32(FILE* stream, uint32_t value)</span>
<a href="#l2.3356"></a><span id="l2.3356" class="difflineminus">-{</span>
<a href="#l2.3357"></a><span id="l2.3357" class="difflineminus">-    value = PR_htonl(value);</span>
<a href="#l2.3358"></a><span id="l2.3358" class="difflineminus">-    return fwrite(&amp;value, sizeof(uint32_t), 1, stream);</span>
<a href="#l2.3359"></a><span id="l2.3359" class="difflineplus">+inline int writeUInt32(FILE* stream, uint32_t value) {</span>
<a href="#l2.3360"></a><span id="l2.3360" class="difflineplus">+  value = PR_htonl(value);</span>
<a href="#l2.3361"></a><span id="l2.3361" class="difflineplus">+  return fwrite(&amp;value, sizeof(uint32_t), 1, stream);</span>
<a href="#l2.3362"></a><span id="l2.3362"> }</span>
<a href="#l2.3363"></a><span id="l2.3363"> </span>
<a href="#l2.3364"></a><span id="l2.3364" class="difflineminus">-inline int readUInt32(FILE* stream, uint32_t* value)</span>
<a href="#l2.3365"></a><span id="l2.3365" class="difflineminus">-{</span>
<a href="#l2.3366"></a><span id="l2.3366" class="difflineminus">-    int n = fread(value, sizeof(uint32_t), 1, stream);</span>
<a href="#l2.3367"></a><span id="l2.3367" class="difflineminus">-    if (n == 1) {</span>
<a href="#l2.3368"></a><span id="l2.3368" class="difflineminus">-        *value = PR_ntohl(*value);</span>
<a href="#l2.3369"></a><span id="l2.3369" class="difflineminus">-    }</span>
<a href="#l2.3370"></a><span id="l2.3370" class="difflineminus">-    return n;</span>
<a href="#l2.3371"></a><span id="l2.3371" class="difflineplus">+inline int readUInt32(FILE* stream, uint32_t* value) {</span>
<a href="#l2.3372"></a><span id="l2.3372" class="difflineplus">+  int n = fread(value, sizeof(uint32_t), 1, stream);</span>
<a href="#l2.3373"></a><span id="l2.3373" class="difflineplus">+  if (n == 1) {</span>
<a href="#l2.3374"></a><span id="l2.3374" class="difflineplus">+    *value = PR_ntohl(*value);</span>
<a href="#l2.3375"></a><span id="l2.3375" class="difflineplus">+  }</span>
<a href="#l2.3376"></a><span id="l2.3376" class="difflineplus">+  return n;</span>
<a href="#l2.3377"></a><span id="l2.3377"> }</span>
<a href="#l2.3378"></a><span id="l2.3378"> </span>
<a href="#l2.3379"></a><span id="l2.3379" class="difflineminus">-void CorpusStore::forgetTokens(Tokenizer&amp; aTokenizer,</span>
<a href="#l2.3380"></a><span id="l2.3380" class="difflineminus">-                    uint32_t aTraitId, uint32_t aCount)</span>
<a href="#l2.3381"></a><span id="l2.3381" class="difflineminus">-{</span>
<a href="#l2.3382"></a><span id="l2.3382" class="difflineplus">+void CorpusStore::forgetTokens(Tokenizer&amp; aTokenizer, uint32_t aTraitId,</span>
<a href="#l2.3383"></a><span id="l2.3383" class="difflineplus">+                               uint32_t aCount) {</span>
<a href="#l2.3384"></a><span id="l2.3384">   // if we are forgetting the tokens for a message, should only</span>
<a href="#l2.3385"></a><span id="l2.3385">   // subtract 1 from the occurrence count for that token in the training set</span>
<a href="#l2.3386"></a><span id="l2.3386">   // because we assume we only bumped the training set count once per messages</span>
<a href="#l2.3387"></a><span id="l2.3387">   // containing the token.</span>
<a href="#l2.3388"></a><span id="l2.3388">   TokenEnumeration tokens = aTokenizer.getTokens();</span>
<a href="#l2.3389"></a><span id="l2.3389" class="difflineminus">-  while (tokens.hasMoreTokens())</span>
<a href="#l2.3390"></a><span id="l2.3390" class="difflineminus">-  {</span>
<a href="#l2.3391"></a><span id="l2.3391" class="difflineplus">+  while (tokens.hasMoreTokens()) {</span>
<a href="#l2.3392"></a><span id="l2.3392">     CorpusToken* token = static_cast&lt;CorpusToken*&gt;(tokens.nextToken());</span>
<a href="#l2.3393"></a><span id="l2.3393">     remove(token-&gt;mWord, aTraitId, aCount);</span>
<a href="#l2.3394"></a><span id="l2.3394">   }</span>
<a href="#l2.3395"></a><span id="l2.3395"> }</span>
<a href="#l2.3396"></a><span id="l2.3396"> </span>
<a href="#l2.3397"></a><span id="l2.3397" class="difflineminus">-void CorpusStore::rememberTokens(Tokenizer&amp; aTokenizer,</span>
<a href="#l2.3398"></a><span id="l2.3398" class="difflineminus">-                    uint32_t aTraitId, uint32_t aCount)</span>
<a href="#l2.3399"></a><span id="l2.3399" class="difflineminus">-{</span>
<a href="#l2.3400"></a><span id="l2.3400" class="difflineplus">+void CorpusStore::rememberTokens(Tokenizer&amp; aTokenizer, uint32_t aTraitId,</span>
<a href="#l2.3401"></a><span id="l2.3401" class="difflineplus">+                                 uint32_t aCount) {</span>
<a href="#l2.3402"></a><span id="l2.3402">   TokenEnumeration tokens = aTokenizer.getTokens();</span>
<a href="#l2.3403"></a><span id="l2.3403" class="difflineminus">-  while (tokens.hasMoreTokens())</span>
<a href="#l2.3404"></a><span id="l2.3404" class="difflineminus">-  {</span>
<a href="#l2.3405"></a><span id="l2.3405" class="difflineplus">+  while (tokens.hasMoreTokens()) {</span>
<a href="#l2.3406"></a><span id="l2.3406">     CorpusToken* token = static_cast&lt;CorpusToken*&gt;(tokens.nextToken());</span>
<a href="#l2.3407"></a><span id="l2.3407" class="difflineminus">-    if (!token)</span>
<a href="#l2.3408"></a><span id="l2.3408" class="difflineminus">-    {</span>
<a href="#l2.3409"></a><span id="l2.3409" class="difflineplus">+    if (!token) {</span>
<a href="#l2.3410"></a><span id="l2.3410">       NS_ERROR(&quot;null token&quot;);</span>
<a href="#l2.3411"></a><span id="l2.3411">       continue;</span>
<a href="#l2.3412"></a><span id="l2.3412">     }</span>
<a href="#l2.3413"></a><span id="l2.3413">     add(token-&gt;mWord, aTraitId, aCount);</span>
<a href="#l2.3414"></a><span id="l2.3414">   }</span>
<a href="#l2.3415"></a><span id="l2.3415"> }</span>
<a href="#l2.3416"></a><span id="l2.3416"> </span>
<a href="#l2.3417"></a><span id="l2.3417" class="difflineminus">-bool CorpusStore::writeTokens(FILE* stream, bool shrink, uint32_t aTraitId)</span>
<a href="#l2.3418"></a><span id="l2.3418" class="difflineminus">-{</span>
<a href="#l2.3419"></a><span id="l2.3419" class="difflineplus">+bool CorpusStore::writeTokens(FILE* stream, bool shrink, uint32_t aTraitId) {</span>
<a href="#l2.3420"></a><span id="l2.3420">   uint32_t tokenCount = countTokens();</span>
<a href="#l2.3421"></a><span id="l2.3421">   uint32_t newTokenCount = 0;</span>
<a href="#l2.3422"></a><span id="l2.3422"> </span>
<a href="#l2.3423"></a><span id="l2.3423">   // calculate the tokens for this trait to write</span>
<a href="#l2.3424"></a><span id="l2.3424"> </span>
<a href="#l2.3425"></a><span id="l2.3425">   TokenEnumeration tokens = getTokens();</span>
<a href="#l2.3426"></a><span id="l2.3426" class="difflineminus">-  for (uint32_t i = 0; i &lt; tokenCount; ++i)</span>
<a href="#l2.3427"></a><span id="l2.3427" class="difflineminus">-  {</span>
<a href="#l2.3428"></a><span id="l2.3428" class="difflineplus">+  for (uint32_t i = 0; i &lt; tokenCount; ++i) {</span>
<a href="#l2.3429"></a><span id="l2.3429">     CorpusToken* token = static_cast&lt;CorpusToken*&gt;(tokens.nextToken());</span>
<a href="#l2.3430"></a><span id="l2.3430">     uint32_t count = getTraitCount(token, aTraitId);</span>
<a href="#l2.3431"></a><span id="l2.3431" class="difflineminus">-    // Shrinking the token database is accomplished by dividing all token counts by 2.</span>
<a href="#l2.3432"></a><span id="l2.3432" class="difflineminus">-    // If shrinking, we'll ignore counts &lt; 2, otherwise only ignore counts of &lt; 1</span>
<a href="#l2.3433"></a><span id="l2.3433" class="difflineminus">-    if ((shrink &amp;&amp; count &gt; 1) || (!shrink &amp;&amp; count))</span>
<a href="#l2.3434"></a><span id="l2.3434" class="difflineminus">-      newTokenCount++;</span>
<a href="#l2.3435"></a><span id="l2.3435" class="difflineplus">+    // Shrinking the token database is accomplished by dividing all token counts</span>
<a href="#l2.3436"></a><span id="l2.3436" class="difflineplus">+    // by 2. If shrinking, we'll ignore counts &lt; 2, otherwise only ignore counts</span>
<a href="#l2.3437"></a><span id="l2.3437" class="difflineplus">+    // of &lt; 1</span>
<a href="#l2.3438"></a><span id="l2.3438" class="difflineplus">+    if ((shrink &amp;&amp; count &gt; 1) || (!shrink &amp;&amp; count)) newTokenCount++;</span>
<a href="#l2.3439"></a><span id="l2.3439">   }</span>
<a href="#l2.3440"></a><span id="l2.3440"> </span>
<a href="#l2.3441"></a><span id="l2.3441" class="difflineminus">-  if (writeUInt32(stream, newTokenCount) != 1)</span>
<a href="#l2.3442"></a><span id="l2.3442" class="difflineminus">-    return false;</span>
<a href="#l2.3443"></a><span id="l2.3443" class="difflineplus">+  if (writeUInt32(stream, newTokenCount) != 1) return false;</span>
<a href="#l2.3444"></a><span id="l2.3444"> </span>
<a href="#l2.3445"></a><span id="l2.3445" class="difflineminus">-  if (newTokenCount &gt; 0)</span>
<a href="#l2.3446"></a><span id="l2.3446" class="difflineminus">-  {</span>
<a href="#l2.3447"></a><span id="l2.3447" class="difflineplus">+  if (newTokenCount &gt; 0) {</span>
<a href="#l2.3448"></a><span id="l2.3448">     TokenEnumeration tokens = getTokens();</span>
<a href="#l2.3449"></a><span id="l2.3449" class="difflineminus">-    for (uint32_t i = 0; i &lt; tokenCount; ++i)</span>
<a href="#l2.3450"></a><span id="l2.3450" class="difflineminus">-    {</span>
<a href="#l2.3451"></a><span id="l2.3451" class="difflineplus">+    for (uint32_t i = 0; i &lt; tokenCount; ++i) {</span>
<a href="#l2.3452"></a><span id="l2.3452">       CorpusToken* token = static_cast&lt;CorpusToken*&gt;(tokens.nextToken());</span>
<a href="#l2.3453"></a><span id="l2.3453">       uint32_t wordCount = getTraitCount(token, aTraitId);</span>
<a href="#l2.3454"></a><span id="l2.3454" class="difflineminus">-      if (shrink)</span>
<a href="#l2.3455"></a><span id="l2.3455" class="difflineminus">-        wordCount /= 2;</span>
<a href="#l2.3456"></a><span id="l2.3456" class="difflineminus">-      if (!wordCount)</span>
<a href="#l2.3457"></a><span id="l2.3457" class="difflineminus">-        continue; // Don't output zero count words</span>
<a href="#l2.3458"></a><span id="l2.3458" class="difflineminus">-      if (writeUInt32(stream, wordCount) != 1)</span>
<a href="#l2.3459"></a><span id="l2.3459" class="difflineminus">-        return false;</span>
<a href="#l2.3460"></a><span id="l2.3460" class="difflineplus">+      if (shrink) wordCount /= 2;</span>
<a href="#l2.3461"></a><span id="l2.3461" class="difflineplus">+      if (!wordCount) continue;  // Don't output zero count words</span>
<a href="#l2.3462"></a><span id="l2.3462" class="difflineplus">+      if (writeUInt32(stream, wordCount) != 1) return false;</span>
<a href="#l2.3463"></a><span id="l2.3463">       uint32_t tokenLength = strlen(token-&gt;mWord);</span>
<a href="#l2.3464"></a><span id="l2.3464" class="difflineminus">-      if (writeUInt32(stream, tokenLength) != 1)</span>
<a href="#l2.3465"></a><span id="l2.3465" class="difflineminus">-        return false;</span>
<a href="#l2.3466"></a><span id="l2.3466" class="difflineminus">-      if (fwrite(token-&gt;mWord, tokenLength, 1, stream) != 1)</span>
<a href="#l2.3467"></a><span id="l2.3467" class="difflineminus">-        return false;</span>
<a href="#l2.3468"></a><span id="l2.3468" class="difflineplus">+      if (writeUInt32(stream, tokenLength) != 1) return false;</span>
<a href="#l2.3469"></a><span id="l2.3469" class="difflineplus">+      if (fwrite(token-&gt;mWord, tokenLength, 1, stream) != 1) return false;</span>
<a href="#l2.3470"></a><span id="l2.3470">     }</span>
<a href="#l2.3471"></a><span id="l2.3471">   }</span>
<a href="#l2.3472"></a><span id="l2.3472">   return true;</span>
<a href="#l2.3473"></a><span id="l2.3473"> }</span>
<a href="#l2.3474"></a><span id="l2.3474"> </span>
<a href="#l2.3475"></a><span id="l2.3475" class="difflineminus">-bool CorpusStore::readTokens(FILE* stream, int64_t fileSize,</span>
<a href="#l2.3476"></a><span id="l2.3476" class="difflineminus">-                               uint32_t aTraitId, bool aIsAdd)</span>
<a href="#l2.3477"></a><span id="l2.3477" class="difflineminus">-{</span>
<a href="#l2.3478"></a><span id="l2.3478" class="difflineminus">-    uint32_t tokenCount;</span>
<a href="#l2.3479"></a><span id="l2.3479" class="difflineminus">-    if (readUInt32(stream, &amp;tokenCount) != 1)</span>
<a href="#l2.3480"></a><span id="l2.3480" class="difflineminus">-        return false;</span>
<a href="#l2.3481"></a><span id="l2.3481" class="difflineplus">+bool CorpusStore::readTokens(FILE* stream, int64_t fileSize, uint32_t aTraitId,</span>
<a href="#l2.3482"></a><span id="l2.3482" class="difflineplus">+                             bool aIsAdd) {</span>
<a href="#l2.3483"></a><span id="l2.3483" class="difflineplus">+  uint32_t tokenCount;</span>
<a href="#l2.3484"></a><span id="l2.3484" class="difflineplus">+  if (readUInt32(stream, &amp;tokenCount) != 1) return false;</span>
<a href="#l2.3485"></a><span id="l2.3485"> </span>
<a href="#l2.3486"></a><span id="l2.3486" class="difflineminus">-    int64_t fpos = ftell(stream);</span>
<a href="#l2.3487"></a><span id="l2.3487" class="difflineminus">-    if (fpos &lt; 0)</span>
<a href="#l2.3488"></a><span id="l2.3488" class="difflineminus">-        return false;</span>
<a href="#l2.3489"></a><span id="l2.3489" class="difflineplus">+  int64_t fpos = ftell(stream);</span>
<a href="#l2.3490"></a><span id="l2.3490" class="difflineplus">+  if (fpos &lt; 0) return false;</span>
<a href="#l2.3491"></a><span id="l2.3491"> </span>
<a href="#l2.3492"></a><span id="l2.3492" class="difflineminus">-    uint32_t bufferSize = 4096;</span>
<a href="#l2.3493"></a><span id="l2.3493" class="difflineminus">-    char* buffer = new char[bufferSize];</span>
<a href="#l2.3494"></a><span id="l2.3494" class="difflineminus">-    if (!buffer) return false;</span>
<a href="#l2.3495"></a><span id="l2.3495" class="difflineplus">+  uint32_t bufferSize = 4096;</span>
<a href="#l2.3496"></a><span id="l2.3496" class="difflineplus">+  char* buffer = new char[bufferSize];</span>
<a href="#l2.3497"></a><span id="l2.3497" class="difflineplus">+  if (!buffer) return false;</span>
<a href="#l2.3498"></a><span id="l2.3498"> </span>
<a href="#l2.3499"></a><span id="l2.3499" class="difflineminus">-    for (uint32_t i = 0; i &lt; tokenCount; ++i) {</span>
<a href="#l2.3500"></a><span id="l2.3500" class="difflineminus">-        uint32_t count;</span>
<a href="#l2.3501"></a><span id="l2.3501" class="difflineminus">-        if (readUInt32(stream, &amp;count) != 1)</span>
<a href="#l2.3502"></a><span id="l2.3502" class="difflineminus">-            break;</span>
<a href="#l2.3503"></a><span id="l2.3503" class="difflineminus">-        uint32_t size;</span>
<a href="#l2.3504"></a><span id="l2.3504" class="difflineminus">-        if (readUInt32(stream, &amp;size) != 1)</span>
<a href="#l2.3505"></a><span id="l2.3505" class="difflineminus">-            break;</span>
<a href="#l2.3506"></a><span id="l2.3506" class="difflineminus">-        fpos += 8;</span>
<a href="#l2.3507"></a><span id="l2.3507" class="difflineminus">-        if (fpos + size &gt; fileSize) {</span>
<a href="#l2.3508"></a><span id="l2.3508" class="difflineminus">-            delete[] buffer;</span>
<a href="#l2.3509"></a><span id="l2.3509" class="difflineminus">-            return false;</span>
<a href="#l2.3510"></a><span id="l2.3510" class="difflineminus">-        }</span>
<a href="#l2.3511"></a><span id="l2.3511" class="difflineminus">-        if (size &gt;= bufferSize) {</span>
<a href="#l2.3512"></a><span id="l2.3512" class="difflineminus">-            delete[] buffer;</span>
<a href="#l2.3513"></a><span id="l2.3513" class="difflineminus">-            while (size &gt;= bufferSize) {</span>
<a href="#l2.3514"></a><span id="l2.3514" class="difflineminus">-                bufferSize *= 2;</span>
<a href="#l2.3515"></a><span id="l2.3515" class="difflineminus">-                if (bufferSize == 0)</span>
<a href="#l2.3516"></a><span id="l2.3516" class="difflineminus">-                    return false;</span>
<a href="#l2.3517"></a><span id="l2.3517" class="difflineminus">-            }</span>
<a href="#l2.3518"></a><span id="l2.3518" class="difflineminus">-            buffer = new char[bufferSize];</span>
<a href="#l2.3519"></a><span id="l2.3519" class="difflineminus">-            if (!buffer) return false;</span>
<a href="#l2.3520"></a><span id="l2.3520" class="difflineminus">-        }</span>
<a href="#l2.3521"></a><span id="l2.3521" class="difflineminus">-        if (fread(buffer, size, 1, stream) != 1)</span>
<a href="#l2.3522"></a><span id="l2.3522" class="difflineminus">-            break;</span>
<a href="#l2.3523"></a><span id="l2.3523" class="difflineminus">-        fpos += size;</span>
<a href="#l2.3524"></a><span id="l2.3524" class="difflineminus">-        buffer[size] = '\0';</span>
<a href="#l2.3525"></a><span id="l2.3525" class="difflineminus">-        if (aIsAdd)</span>
<a href="#l2.3526"></a><span id="l2.3526" class="difflineminus">-          add(buffer, aTraitId, count);</span>
<a href="#l2.3527"></a><span id="l2.3527" class="difflineminus">-        else</span>
<a href="#l2.3528"></a><span id="l2.3528" class="difflineminus">-          remove(buffer, aTraitId, count);</span>
<a href="#l2.3529"></a><span id="l2.3529" class="difflineplus">+  for (uint32_t i = 0; i &lt; tokenCount; ++i) {</span>
<a href="#l2.3530"></a><span id="l2.3530" class="difflineplus">+    uint32_t count;</span>
<a href="#l2.3531"></a><span id="l2.3531" class="difflineplus">+    if (readUInt32(stream, &amp;count) != 1) break;</span>
<a href="#l2.3532"></a><span id="l2.3532" class="difflineplus">+    uint32_t size;</span>
<a href="#l2.3533"></a><span id="l2.3533" class="difflineplus">+    if (readUInt32(stream, &amp;size) != 1) break;</span>
<a href="#l2.3534"></a><span id="l2.3534" class="difflineplus">+    fpos += 8;</span>
<a href="#l2.3535"></a><span id="l2.3535" class="difflineplus">+    if (fpos + size &gt; fileSize) {</span>
<a href="#l2.3536"></a><span id="l2.3536" class="difflineplus">+      delete[] buffer;</span>
<a href="#l2.3537"></a><span id="l2.3537" class="difflineplus">+      return false;</span>
<a href="#l2.3538"></a><span id="l2.3538">     }</span>
<a href="#l2.3539"></a><span id="l2.3539" class="difflineplus">+    if (size &gt;= bufferSize) {</span>
<a href="#l2.3540"></a><span id="l2.3540" class="difflineplus">+      delete[] buffer;</span>
<a href="#l2.3541"></a><span id="l2.3541" class="difflineplus">+      while (size &gt;= bufferSize) {</span>
<a href="#l2.3542"></a><span id="l2.3542" class="difflineplus">+        bufferSize *= 2;</span>
<a href="#l2.3543"></a><span id="l2.3543" class="difflineplus">+        if (bufferSize == 0) return false;</span>
<a href="#l2.3544"></a><span id="l2.3544" class="difflineplus">+      }</span>
<a href="#l2.3545"></a><span id="l2.3545" class="difflineplus">+      buffer = new char[bufferSize];</span>
<a href="#l2.3546"></a><span id="l2.3546" class="difflineplus">+      if (!buffer) return false;</span>
<a href="#l2.3547"></a><span id="l2.3547" class="difflineplus">+    }</span>
<a href="#l2.3548"></a><span id="l2.3548" class="difflineplus">+    if (fread(buffer, size, 1, stream) != 1) break;</span>
<a href="#l2.3549"></a><span id="l2.3549" class="difflineplus">+    fpos += size;</span>
<a href="#l2.3550"></a><span id="l2.3550" class="difflineplus">+    buffer[size] = '\0';</span>
<a href="#l2.3551"></a><span id="l2.3551" class="difflineplus">+    if (aIsAdd)</span>
<a href="#l2.3552"></a><span id="l2.3552" class="difflineplus">+      add(buffer, aTraitId, count);</span>
<a href="#l2.3553"></a><span id="l2.3553" class="difflineplus">+    else</span>
<a href="#l2.3554"></a><span id="l2.3554" class="difflineplus">+      remove(buffer, aTraitId, count);</span>
<a href="#l2.3555"></a><span id="l2.3555" class="difflineplus">+  }</span>
<a href="#l2.3556"></a><span id="l2.3556"> </span>
<a href="#l2.3557"></a><span id="l2.3557" class="difflineminus">-    delete[] buffer;</span>
<a href="#l2.3558"></a><span id="l2.3558" class="difflineplus">+  delete[] buffer;</span>
<a href="#l2.3559"></a><span id="l2.3559"> </span>
<a href="#l2.3560"></a><span id="l2.3560" class="difflineminus">-    return true;</span>
<a href="#l2.3561"></a><span id="l2.3561" class="difflineplus">+  return true;</span>
<a href="#l2.3562"></a><span id="l2.3562"> }</span>
<a href="#l2.3563"></a><span id="l2.3563"> </span>
<a href="#l2.3564"></a><span id="l2.3564" class="difflineminus">-nsresult CorpusStore::getTrainingFile(nsIFile ** aTrainingFile)</span>
<a href="#l2.3565"></a><span id="l2.3565" class="difflineminus">-{</span>
<a href="#l2.3566"></a><span id="l2.3566" class="difflineplus">+nsresult CorpusStore::getTrainingFile(nsIFile** aTrainingFile) {</span>
<a href="#l2.3567"></a><span id="l2.3567">   // should we cache the profile manager's directory?</span>
<a href="#l2.3568"></a><span id="l2.3568">   nsCOMPtr&lt;nsIFile&gt; profileDir;</span>
<a href="#l2.3569"></a><span id="l2.3569"> </span>
<a href="#l2.3570"></a><span id="l2.3570" class="difflineminus">-  nsresult rv = NS_GetSpecialDirectory(NS_APP_USER_PROFILE_50_DIR, getter_AddRefs(profileDir));</span>
<a href="#l2.3571"></a><span id="l2.3571" class="difflineplus">+  nsresult rv = NS_GetSpecialDirectory(NS_APP_USER_PROFILE_50_DIR,</span>
<a href="#l2.3572"></a><span id="l2.3572" class="difflineplus">+                                       getter_AddRefs(profileDir));</span>
<a href="#l2.3573"></a><span id="l2.3573">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.3574"></a><span id="l2.3574">   rv = profileDir-&gt;Append(NS_LITERAL_STRING(&quot;training.dat&quot;));</span>
<a href="#l2.3575"></a><span id="l2.3575">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.3576"></a><span id="l2.3576"> </span>
<a href="#l2.3577"></a><span id="l2.3577" class="difflineminus">-  return profileDir-&gt;QueryInterface(NS_GET_IID(nsIFile), (void **) aTrainingFile);</span>
<a href="#l2.3578"></a><span id="l2.3578" class="difflineplus">+  return profileDir-&gt;QueryInterface(NS_GET_IID(nsIFile), (void**)aTrainingFile);</span>
<a href="#l2.3579"></a><span id="l2.3579"> }</span>
<a href="#l2.3580"></a><span id="l2.3580"> </span>
<a href="#l2.3581"></a><span id="l2.3581" class="difflineminus">-nsresult CorpusStore::getTraitFile(nsIFile ** aTraitFile)</span>
<a href="#l2.3582"></a><span id="l2.3582" class="difflineminus">-{</span>
<a href="#l2.3583"></a><span id="l2.3583" class="difflineplus">+nsresult CorpusStore::getTraitFile(nsIFile** aTraitFile) {</span>
<a href="#l2.3584"></a><span id="l2.3584">   // should we cache the profile manager's directory?</span>
<a href="#l2.3585"></a><span id="l2.3585">   nsCOMPtr&lt;nsIFile&gt; profileDir;</span>
<a href="#l2.3586"></a><span id="l2.3586"> </span>
<a href="#l2.3587"></a><span id="l2.3587" class="difflineminus">-  nsresult rv = NS_GetSpecialDirectory(NS_APP_USER_PROFILE_50_DIR, getter_AddRefs(profileDir));</span>
<a href="#l2.3588"></a><span id="l2.3588" class="difflineplus">+  nsresult rv = NS_GetSpecialDirectory(NS_APP_USER_PROFILE_50_DIR,</span>
<a href="#l2.3589"></a><span id="l2.3589" class="difflineplus">+                                       getter_AddRefs(profileDir));</span>
<a href="#l2.3590"></a><span id="l2.3590">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.3591"></a><span id="l2.3591"> </span>
<a href="#l2.3592"></a><span id="l2.3592">   rv = profileDir-&gt;Append(NS_LITERAL_STRING(&quot;traits.dat&quot;));</span>
<a href="#l2.3593"></a><span id="l2.3593">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.3594"></a><span id="l2.3594"> </span>
<a href="#l2.3595"></a><span id="l2.3595" class="difflineminus">-  return profileDir-&gt;QueryInterface(NS_GET_IID(nsIFile), (void **) aTraitFile);</span>
<a href="#l2.3596"></a><span id="l2.3596" class="difflineplus">+  return profileDir-&gt;QueryInterface(NS_GET_IID(nsIFile), (void**)aTraitFile);</span>
<a href="#l2.3597"></a><span id="l2.3597"> }</span>
<a href="#l2.3598"></a><span id="l2.3598"> </span>
<a href="#l2.3599"></a><span id="l2.3599" class="difflineminus">-static const char kMagicCookie[] = { '\xFE', '\xED', '\xFA', '\xCE' };</span>
<a href="#l2.3600"></a><span id="l2.3600" class="difflineplus">+static const char kMagicCookie[] = {'\xFE', '\xED', '\xFA', '\xCE'};</span>
<a href="#l2.3601"></a><span id="l2.3601"> </span>
<a href="#l2.3602"></a><span id="l2.3602"> // random string used to identify trait file and version (last byte is version)</span>
<a href="#l2.3603"></a><span id="l2.3603" class="difflineminus">-static const char kTraitCookie[] = { '\xFC', '\xA9', '\x36', '\x01' };</span>
<a href="#l2.3604"></a><span id="l2.3604" class="difflineplus">+static const char kTraitCookie[] = {'\xFC', '\xA9', '\x36', '\x01'};</span>
<a href="#l2.3605"></a><span id="l2.3605"> </span>
<a href="#l2.3606"></a><span id="l2.3606" class="difflineminus">-void CorpusStore::writeTrainingData(uint32_t aMaximumTokenCount)</span>
<a href="#l2.3607"></a><span id="l2.3607" class="difflineminus">-{</span>
<a href="#l2.3608"></a><span id="l2.3608" class="difflineminus">-  MOZ_LOG(BayesianFilterLogModule, LogLevel::Debug, (&quot;writeTrainingData() entered&quot;));</span>
<a href="#l2.3609"></a><span id="l2.3609" class="difflineminus">-  if (!mTrainingFile)</span>
<a href="#l2.3610"></a><span id="l2.3610" class="difflineminus">-    return;</span>
<a href="#l2.3611"></a><span id="l2.3611" class="difflineplus">+void CorpusStore::writeTrainingData(uint32_t aMaximumTokenCount) {</span>
<a href="#l2.3612"></a><span id="l2.3612" class="difflineplus">+  MOZ_LOG(BayesianFilterLogModule, LogLevel::Debug,</span>
<a href="#l2.3613"></a><span id="l2.3613" class="difflineplus">+          (&quot;writeTrainingData() entered&quot;));</span>
<a href="#l2.3614"></a><span id="l2.3614" class="difflineplus">+  if (!mTrainingFile) return;</span>
<a href="#l2.3615"></a><span id="l2.3615"> </span>
<a href="#l2.3616"></a><span id="l2.3616">   /*</span>
<a href="#l2.3617"></a><span id="l2.3617">    * For backwards compatibility, write the good and junk tokens to</span>
<a href="#l2.3618"></a><span id="l2.3618">    * training.dat; additional traits are added to a different file</span>
<a href="#l2.3619"></a><span id="l2.3619">    */</span>
<a href="#l2.3620"></a><span id="l2.3620"> </span>
<a href="#l2.3621"></a><span id="l2.3621">   // open the file, and write out training data</span>
<a href="#l2.3622"></a><span id="l2.3622">   FILE* stream;</span>
<a href="#l2.3623"></a><span id="l2.3623">   nsresult rv = mTrainingFile-&gt;OpenANSIFileDesc(&quot;wb&quot;, &amp;stream);</span>
<a href="#l2.3624"></a><span id="l2.3624" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l2.3625"></a><span id="l2.3625" class="difflineminus">-    return;</span>
<a href="#l2.3626"></a><span id="l2.3626" class="difflineplus">+  if (NS_FAILED(rv)) return;</span>
<a href="#l2.3627"></a><span id="l2.3627"> </span>
<a href="#l2.3628"></a><span id="l2.3628">   // If the number of tokens exceeds our limit, set the shrink flag</span>
<a href="#l2.3629"></a><span id="l2.3629">   bool shrink = false;</span>
<a href="#l2.3630"></a><span id="l2.3630" class="difflineminus">-  if ((aMaximumTokenCount &gt; 0) &amp;&amp; // if 0, do not limit tokens</span>
<a href="#l2.3631"></a><span id="l2.3631" class="difflineminus">-      (countTokens() &gt; aMaximumTokenCount))</span>
<a href="#l2.3632"></a><span id="l2.3632" class="difflineminus">-  {</span>
<a href="#l2.3633"></a><span id="l2.3633" class="difflineplus">+  if ((aMaximumTokenCount &gt; 0) &amp;&amp;  // if 0, do not limit tokens</span>
<a href="#l2.3634"></a><span id="l2.3634" class="difflineplus">+      (countTokens() &gt; aMaximumTokenCount)) {</span>
<a href="#l2.3635"></a><span id="l2.3635">     shrink = true;</span>
<a href="#l2.3636"></a><span id="l2.3636" class="difflineminus">-    MOZ_LOG(BayesianFilterLogModule, LogLevel::Warning, (&quot;shrinking token data file&quot;));</span>
<a href="#l2.3637"></a><span id="l2.3637" class="difflineplus">+    MOZ_LOG(BayesianFilterLogModule, LogLevel::Warning,</span>
<a href="#l2.3638"></a><span id="l2.3638" class="difflineplus">+            (&quot;shrinking token data file&quot;));</span>
<a href="#l2.3639"></a><span id="l2.3639">   }</span>
<a href="#l2.3640"></a><span id="l2.3640"> </span>
<a href="#l2.3641"></a><span id="l2.3641">   // We implement shrink by dividing counts by two</span>
<a href="#l2.3642"></a><span id="l2.3642">   uint32_t shrinkFactor = shrink ? 2 : 1;</span>
<a href="#l2.3643"></a><span id="l2.3643"> </span>
<a href="#l2.3644"></a><span id="l2.3644">   if (!((fwrite(kMagicCookie, sizeof(kMagicCookie), 1, stream) == 1) &amp;&amp;</span>
<a href="#l2.3645"></a><span id="l2.3645" class="difflineminus">-      (writeUInt32(stream, getMessageCount(kGoodTrait) / shrinkFactor)) &amp;&amp;</span>
<a href="#l2.3646"></a><span id="l2.3646" class="difflineminus">-      (writeUInt32(stream, getMessageCount(kJunkTrait) / shrinkFactor)) &amp;&amp;</span>
<a href="#l2.3647"></a><span id="l2.3647" class="difflineminus">-       writeTokens(stream, shrink, kGoodTrait) &amp;&amp;</span>
<a href="#l2.3648"></a><span id="l2.3648" class="difflineminus">-       writeTokens(stream, shrink, kJunkTrait)))</span>
<a href="#l2.3649"></a><span id="l2.3649" class="difflineminus">-  {</span>
<a href="#l2.3650"></a><span id="l2.3650" class="difflineplus">+        (writeUInt32(stream, getMessageCount(kGoodTrait) / shrinkFactor)) &amp;&amp;</span>
<a href="#l2.3651"></a><span id="l2.3651" class="difflineplus">+        (writeUInt32(stream, getMessageCount(kJunkTrait) / shrinkFactor)) &amp;&amp;</span>
<a href="#l2.3652"></a><span id="l2.3652" class="difflineplus">+        writeTokens(stream, shrink, kGoodTrait) &amp;&amp;</span>
<a href="#l2.3653"></a><span id="l2.3653" class="difflineplus">+        writeTokens(stream, shrink, kJunkTrait))) {</span>
<a href="#l2.3654"></a><span id="l2.3654">     NS_WARNING(&quot;failed to write training data.&quot;);</span>
<a href="#l2.3655"></a><span id="l2.3655">     fclose(stream);</span>
<a href="#l2.3656"></a><span id="l2.3656">     // delete the training data file, since it is potentially corrupt.</span>
<a href="#l2.3657"></a><span id="l2.3657">     mTrainingFile-&gt;Remove(false);</span>
<a href="#l2.3658"></a><span id="l2.3658" class="difflineminus">-  }</span>
<a href="#l2.3659"></a><span id="l2.3659" class="difflineminus">-  else</span>
<a href="#l2.3660"></a><span id="l2.3660" class="difflineminus">-  {</span>
<a href="#l2.3661"></a><span id="l2.3661" class="difflineplus">+  } else {</span>
<a href="#l2.3662"></a><span id="l2.3662">     fclose(stream);</span>
<a href="#l2.3663"></a><span id="l2.3663">   }</span>
<a href="#l2.3664"></a><span id="l2.3664"> </span>
<a href="#l2.3665"></a><span id="l2.3665">   /*</span>
<a href="#l2.3666"></a><span id="l2.3666">    * Write the remaining data to a second file traits.dat</span>
<a href="#l2.3667"></a><span id="l2.3667">    */</span>
<a href="#l2.3668"></a><span id="l2.3668"> </span>
<a href="#l2.3669"></a><span id="l2.3669" class="difflineminus">-  if (!mTraitFile)</span>
<a href="#l2.3670"></a><span id="l2.3670" class="difflineminus">-  {</span>
<a href="#l2.3671"></a><span id="l2.3671" class="difflineplus">+  if (!mTraitFile) {</span>
<a href="#l2.3672"></a><span id="l2.3672">     getTraitFile(getter_AddRefs(mTraitFile));</span>
<a href="#l2.3673"></a><span id="l2.3673" class="difflineminus">-    if (!mTraitFile)</span>
<a href="#l2.3674"></a><span id="l2.3674" class="difflineminus">-     return;</span>
<a href="#l2.3675"></a><span id="l2.3675" class="difflineplus">+    if (!mTraitFile) return;</span>
<a href="#l2.3676"></a><span id="l2.3676">   }</span>
<a href="#l2.3677"></a><span id="l2.3677"> </span>
<a href="#l2.3678"></a><span id="l2.3678">   // open the file, and write out training data</span>
<a href="#l2.3679"></a><span id="l2.3679">   rv = mTraitFile-&gt;OpenANSIFileDesc(&quot;wb&quot;, &amp;stream);</span>
<a href="#l2.3680"></a><span id="l2.3680" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l2.3681"></a><span id="l2.3681" class="difflineminus">-    return;</span>
<a href="#l2.3682"></a><span id="l2.3682" class="difflineplus">+  if (NS_FAILED(rv)) return;</span>
<a href="#l2.3683"></a><span id="l2.3683"> </span>
<a href="#l2.3684"></a><span id="l2.3684">   uint32_t numberOfTraits = mMessageCounts.Length();</span>
<a href="#l2.3685"></a><span id="l2.3685">   bool error;</span>
<a href="#l2.3686"></a><span id="l2.3686" class="difflineminus">-  while (1) // break on error or done</span>
<a href="#l2.3687"></a><span id="l2.3687" class="difflineplus">+  while (1)  // break on error or done</span>
<a href="#l2.3688"></a><span id="l2.3688">   {</span>
<a href="#l2.3689"></a><span id="l2.3689">     if ((error = (fwrite(kTraitCookie, sizeof(kTraitCookie), 1, stream) != 1)))</span>
<a href="#l2.3690"></a><span id="l2.3690">       break;</span>
<a href="#l2.3691"></a><span id="l2.3691"> </span>
<a href="#l2.3692"></a><span id="l2.3692" class="difflineminus">-    for (uint32_t index = 0; index &lt; numberOfTraits; index++)</span>
<a href="#l2.3693"></a><span id="l2.3693" class="difflineminus">-    {</span>
<a href="#l2.3694"></a><span id="l2.3694" class="difflineplus">+    for (uint32_t index = 0; index &lt; numberOfTraits; index++) {</span>
<a href="#l2.3695"></a><span id="l2.3695">       uint32_t trait = mMessageCountsId[index];</span>
<a href="#l2.3696"></a><span id="l2.3696">       if (trait == 1 || trait == 2)</span>
<a href="#l2.3697"></a><span id="l2.3697" class="difflineminus">-        continue; // junk traits are stored in training.dat</span>
<a href="#l2.3698"></a><span id="l2.3698" class="difflineminus">-      if ((error = (writeUInt32(stream, trait) != 1)))</span>
<a href="#l2.3699"></a><span id="l2.3699" class="difflineplus">+        continue;  // junk traits are stored in training.dat</span>
<a href="#l2.3700"></a><span id="l2.3700" class="difflineplus">+      if ((error = (writeUInt32(stream, trait) != 1))) break;</span>
<a href="#l2.3701"></a><span id="l2.3701" class="difflineplus">+      if ((error = (writeUInt32(stream, mMessageCounts[index] / shrinkFactor) !=</span>
<a href="#l2.3702"></a><span id="l2.3702" class="difflineplus">+                    1)))</span>
<a href="#l2.3703"></a><span id="l2.3703">         break;</span>
<a href="#l2.3704"></a><span id="l2.3704" class="difflineminus">-      if ((error = (writeUInt32(stream, mMessageCounts[index] / shrinkFactor) != 1)))</span>
<a href="#l2.3705"></a><span id="l2.3705" class="difflineminus">-        break;</span>
<a href="#l2.3706"></a><span id="l2.3706" class="difflineminus">-      if ((error = !writeTokens(stream, shrink, trait)))</span>
<a href="#l2.3707"></a><span id="l2.3707" class="difflineminus">-        break;</span>
<a href="#l2.3708"></a><span id="l2.3708" class="difflineplus">+      if ((error = !writeTokens(stream, shrink, trait))) break;</span>
<a href="#l2.3709"></a><span id="l2.3709">     }</span>
<a href="#l2.3710"></a><span id="l2.3710">     break;</span>
<a href="#l2.3711"></a><span id="l2.3711">   }</span>
<a href="#l2.3712"></a><span id="l2.3712">   // we add a 0 at the end to represent end of trait list</span>
<a href="#l2.3713"></a><span id="l2.3713">   error = writeUInt32(stream, 0) != 1;</span>
<a href="#l2.3714"></a><span id="l2.3714"> </span>
<a href="#l2.3715"></a><span id="l2.3715">   fclose(stream);</span>
<a href="#l2.3716"></a><span id="l2.3716" class="difflineminus">-  if (error)</span>
<a href="#l2.3717"></a><span id="l2.3717" class="difflineminus">-  {</span>
<a href="#l2.3718"></a><span id="l2.3718" class="difflineplus">+  if (error) {</span>
<a href="#l2.3719"></a><span id="l2.3719">     NS_WARNING(&quot;failed to write trait data.&quot;);</span>
<a href="#l2.3720"></a><span id="l2.3720">     // delete the trait data file, since it is probably corrupt.</span>
<a href="#l2.3721"></a><span id="l2.3721">     mTraitFile-&gt;Remove(false);</span>
<a href="#l2.3722"></a><span id="l2.3722">   }</span>
<a href="#l2.3723"></a><span id="l2.3723"> </span>
<a href="#l2.3724"></a><span id="l2.3724" class="difflineminus">-  if (shrink)</span>
<a href="#l2.3725"></a><span id="l2.3725" class="difflineminus">-  {</span>
<a href="#l2.3726"></a><span id="l2.3726" class="difflineplus">+  if (shrink) {</span>
<a href="#l2.3727"></a><span id="l2.3727">     // We'll clear the tokens, and read them back in from the file.</span>
<a href="#l2.3728"></a><span id="l2.3728">     // Yes this is slower than in place, but this is a rare event.</span>
<a href="#l2.3729"></a><span id="l2.3729"> </span>
<a href="#l2.3730"></a><span id="l2.3730" class="difflineminus">-    if (countTokens())</span>
<a href="#l2.3731"></a><span id="l2.3731" class="difflineminus">-    {</span>
<a href="#l2.3732"></a><span id="l2.3732" class="difflineplus">+    if (countTokens()) {</span>
<a href="#l2.3733"></a><span id="l2.3733">       clearTokens();</span>
<a href="#l2.3734"></a><span id="l2.3734">       for (uint32_t index = 0; index &lt; numberOfTraits; index++)</span>
<a href="#l2.3735"></a><span id="l2.3735">         mMessageCounts[index] = 0;</span>
<a href="#l2.3736"></a><span id="l2.3736">     }</span>
<a href="#l2.3737"></a><span id="l2.3737"> </span>
<a href="#l2.3738"></a><span id="l2.3738" class="difflineminus">-  readTrainingData();</span>
<a href="#l2.3739"></a><span id="l2.3739" class="difflineplus">+    readTrainingData();</span>
<a href="#l2.3740"></a><span id="l2.3740">   }</span>
<a href="#l2.3741"></a><span id="l2.3741"> }</span>
<a href="#l2.3742"></a><span id="l2.3742"> </span>
<a href="#l2.3743"></a><span id="l2.3743" class="difflineminus">-void CorpusStore::readTrainingData()</span>
<a href="#l2.3744"></a><span id="l2.3744" class="difflineminus">-{</span>
<a href="#l2.3745"></a><span id="l2.3745" class="difflineminus">-</span>
<a href="#l2.3746"></a><span id="l2.3746" class="difflineplus">+void CorpusStore::readTrainingData() {</span>
<a href="#l2.3747"></a><span id="l2.3747">   /*</span>
<a href="#l2.3748"></a><span id="l2.3748">    * To maintain backwards compatibility, good and junk traits</span>
<a href="#l2.3749"></a><span id="l2.3749">    * are stored in a file &quot;training.dat&quot;</span>
<a href="#l2.3750"></a><span id="l2.3750">    */</span>
<a href="#l2.3751"></a><span id="l2.3751" class="difflineminus">-  if (!mTrainingFile)</span>
<a href="#l2.3752"></a><span id="l2.3752" class="difflineminus">-    return;</span>
<a href="#l2.3753"></a><span id="l2.3753" class="difflineplus">+  if (!mTrainingFile) return;</span>
<a href="#l2.3754"></a><span id="l2.3754"> </span>
<a href="#l2.3755"></a><span id="l2.3755">   bool exists;</span>
<a href="#l2.3756"></a><span id="l2.3756">   nsresult rv = mTrainingFile-&gt;Exists(&amp;exists);</span>
<a href="#l2.3757"></a><span id="l2.3757" class="difflineminus">-  if (NS_FAILED(rv) || !exists)</span>
<a href="#l2.3758"></a><span id="l2.3758" class="difflineminus">-    return;</span>
<a href="#l2.3759"></a><span id="l2.3759" class="difflineplus">+  if (NS_FAILED(rv) || !exists) return;</span>
<a href="#l2.3760"></a><span id="l2.3760"> </span>
<a href="#l2.3761"></a><span id="l2.3761">   FILE* stream;</span>
<a href="#l2.3762"></a><span id="l2.3762">   rv = mTrainingFile-&gt;OpenANSIFileDesc(&quot;rb&quot;, &amp;stream);</span>
<a href="#l2.3763"></a><span id="l2.3763" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l2.3764"></a><span id="l2.3764" class="difflineminus">-    return;</span>
<a href="#l2.3765"></a><span id="l2.3765" class="difflineplus">+  if (NS_FAILED(rv)) return;</span>
<a href="#l2.3766"></a><span id="l2.3766"> </span>
<a href="#l2.3767"></a><span id="l2.3767">   int64_t fileSize;</span>
<a href="#l2.3768"></a><span id="l2.3768">   rv = mTrainingFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l2.3769"></a><span id="l2.3769" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l2.3770"></a><span id="l2.3770" class="difflineminus">-    return;</span>
<a href="#l2.3771"></a><span id="l2.3771" class="difflineplus">+  if (NS_FAILED(rv)) return;</span>
<a href="#l2.3772"></a><span id="l2.3772"> </span>
<a href="#l2.3773"></a><span id="l2.3773">   // FIXME:  should make sure that the tokenizers are empty.</span>
<a href="#l2.3774"></a><span id="l2.3774">   char cookie[4];</span>
<a href="#l2.3775"></a><span id="l2.3775">   uint32_t goodMessageCount = 0, junkMessageCount = 0;</span>
<a href="#l2.3776"></a><span id="l2.3776">   if (!((fread(cookie, sizeof(cookie), 1, stream) == 1) &amp;&amp;</span>
<a href="#l2.3777"></a><span id="l2.3777">         (memcmp(cookie, kMagicCookie, sizeof(cookie)) == 0) &amp;&amp;</span>
<a href="#l2.3778"></a><span id="l2.3778">         (readUInt32(stream, &amp;goodMessageCount) == 1) &amp;&amp;</span>
<a href="#l2.3779"></a><span id="l2.3779">         (readUInt32(stream, &amp;junkMessageCount) == 1) &amp;&amp;</span>
<a href="#l2.3780"></a><span id="l2.3780" class="difflineminus">-         readTokens(stream, fileSize, kGoodTrait, true) &amp;&amp;</span>
<a href="#l2.3781"></a><span id="l2.3781" class="difflineminus">-         readTokens(stream, fileSize, kJunkTrait, true))) {</span>
<a href="#l2.3782"></a><span id="l2.3782" class="difflineminus">-      NS_WARNING(&quot;failed to read training data.&quot;);</span>
<a href="#l2.3783"></a><span id="l2.3783" class="difflineminus">-      MOZ_LOG(BayesianFilterLogModule, LogLevel::Error, (&quot;failed to read training data.&quot;));</span>
<a href="#l2.3784"></a><span id="l2.3784" class="difflineplus">+        readTokens(stream, fileSize, kGoodTrait, true) &amp;&amp;</span>
<a href="#l2.3785"></a><span id="l2.3785" class="difflineplus">+        readTokens(stream, fileSize, kJunkTrait, true))) {</span>
<a href="#l2.3786"></a><span id="l2.3786" class="difflineplus">+    NS_WARNING(&quot;failed to read training data.&quot;);</span>
<a href="#l2.3787"></a><span id="l2.3787" class="difflineplus">+    MOZ_LOG(BayesianFilterLogModule, LogLevel::Error,</span>
<a href="#l2.3788"></a><span id="l2.3788" class="difflineplus">+            (&quot;failed to read training data.&quot;));</span>
<a href="#l2.3789"></a><span id="l2.3789">   }</span>
<a href="#l2.3790"></a><span id="l2.3790">   setMessageCount(kGoodTrait, goodMessageCount);</span>
<a href="#l2.3791"></a><span id="l2.3791">   setMessageCount(kJunkTrait, junkMessageCount);</span>
<a href="#l2.3792"></a><span id="l2.3792"> </span>
<a href="#l2.3793"></a><span id="l2.3793">   fclose(stream);</span>
<a href="#l2.3794"></a><span id="l2.3794"> </span>
<a href="#l2.3795"></a><span id="l2.3795">   /*</span>
<a href="#l2.3796"></a><span id="l2.3796">    * Additional traits are stored in traits.dat</span>
<a href="#l2.3797"></a><span id="l2.3797">    */</span>
<a href="#l2.3798"></a><span id="l2.3798"> </span>
<a href="#l2.3799"></a><span id="l2.3799" class="difflineminus">-  if (!mTraitFile)</span>
<a href="#l2.3800"></a><span id="l2.3800" class="difflineminus">-  {</span>
<a href="#l2.3801"></a><span id="l2.3801" class="difflineplus">+  if (!mTraitFile) {</span>
<a href="#l2.3802"></a><span id="l2.3802">     getTraitFile(getter_AddRefs(mTraitFile));</span>
<a href="#l2.3803"></a><span id="l2.3803" class="difflineminus">-    if (!mTraitFile)</span>
<a href="#l2.3804"></a><span id="l2.3804" class="difflineminus">-     return;</span>
<a href="#l2.3805"></a><span id="l2.3805" class="difflineplus">+    if (!mTraitFile) return;</span>
<a href="#l2.3806"></a><span id="l2.3806">   }</span>
<a href="#l2.3807"></a><span id="l2.3807"> </span>
<a href="#l2.3808"></a><span id="l2.3808">   rv = mTraitFile-&gt;Exists(&amp;exists);</span>
<a href="#l2.3809"></a><span id="l2.3809" class="difflineminus">-  if (NS_FAILED(rv) || !exists)</span>
<a href="#l2.3810"></a><span id="l2.3810" class="difflineminus">-    return;</span>
<a href="#l2.3811"></a><span id="l2.3811" class="difflineplus">+  if (NS_FAILED(rv) || !exists) return;</span>
<a href="#l2.3812"></a><span id="l2.3812"> </span>
<a href="#l2.3813"></a><span id="l2.3813">   rv = UpdateData(mTraitFile, true, 0, nullptr, nullptr);</span>
<a href="#l2.3814"></a><span id="l2.3814"> </span>
<a href="#l2.3815"></a><span id="l2.3815" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l2.3816"></a><span id="l2.3816" class="difflineminus">-  {</span>
<a href="#l2.3817"></a><span id="l2.3817" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l2.3818"></a><span id="l2.3818">     NS_WARNING(&quot;failed to read training data.&quot;);</span>
<a href="#l2.3819"></a><span id="l2.3819" class="difflineminus">-    MOZ_LOG(BayesianFilterLogModule, LogLevel::Error, (&quot;failed to read training data.&quot;));</span>
<a href="#l2.3820"></a><span id="l2.3820" class="difflineplus">+    MOZ_LOG(BayesianFilterLogModule, LogLevel::Error,</span>
<a href="#l2.3821"></a><span id="l2.3821" class="difflineplus">+            (&quot;failed to read training data.&quot;));</span>
<a href="#l2.3822"></a><span id="l2.3822">   }</span>
<a href="#l2.3823"></a><span id="l2.3823">   return;</span>
<a href="#l2.3824"></a><span id="l2.3824"> }</span>
<a href="#l2.3825"></a><span id="l2.3825"> </span>
<a href="#l2.3826"></a><span id="l2.3826" class="difflineminus">-nsresult CorpusStore::resetTrainingData()</span>
<a href="#l2.3827"></a><span id="l2.3827" class="difflineminus">-{</span>
<a href="#l2.3828"></a><span id="l2.3828" class="difflineplus">+nsresult CorpusStore::resetTrainingData() {</span>
<a href="#l2.3829"></a><span id="l2.3829">   // clear out our in memory training tokens...</span>
<a href="#l2.3830"></a><span id="l2.3830" class="difflineminus">-  if (countTokens())</span>
<a href="#l2.3831"></a><span id="l2.3831" class="difflineminus">-    clearTokens();</span>
<a href="#l2.3832"></a><span id="l2.3832" class="difflineplus">+  if (countTokens()) clearTokens();</span>
<a href="#l2.3833"></a><span id="l2.3833"> </span>
<a href="#l2.3834"></a><span id="l2.3834">   uint32_t length = mMessageCounts.Length();</span>
<a href="#l2.3835"></a><span id="l2.3835" class="difflineminus">-  for (uint32_t index = 0 ; index &lt; length; index++)</span>
<a href="#l2.3836"></a><span id="l2.3836" class="difflineminus">-    mMessageCounts[index] = 0;</span>
<a href="#l2.3837"></a><span id="l2.3837" class="difflineplus">+  for (uint32_t index = 0; index &lt; length; index++) mMessageCounts[index] = 0;</span>
<a href="#l2.3838"></a><span id="l2.3838"> </span>
<a href="#l2.3839"></a><span id="l2.3839" class="difflineminus">-  if (mTrainingFile)</span>
<a href="#l2.3840"></a><span id="l2.3840" class="difflineminus">-    mTrainingFile-&gt;Remove(false);</span>
<a href="#l2.3841"></a><span id="l2.3841" class="difflineminus">-  if (mTraitFile)</span>
<a href="#l2.3842"></a><span id="l2.3842" class="difflineminus">-    mTraitFile-&gt;Remove(false);</span>
<a href="#l2.3843"></a><span id="l2.3843" class="difflineplus">+  if (mTrainingFile) mTrainingFile-&gt;Remove(false);</span>
<a href="#l2.3844"></a><span id="l2.3844" class="difflineplus">+  if (mTraitFile) mTraitFile-&gt;Remove(false);</span>
<a href="#l2.3845"></a><span id="l2.3845">   return NS_OK;</span>
<a href="#l2.3846"></a><span id="l2.3846"> }</span>
<a href="#l2.3847"></a><span id="l2.3847"> </span>
<a href="#l2.3848"></a><span id="l2.3848" class="difflineminus">-inline CorpusToken* CorpusStore::get(const char* word)</span>
<a href="#l2.3849"></a><span id="l2.3849" class="difflineminus">-{</span>
<a href="#l2.3850"></a><span id="l2.3850" class="difflineplus">+inline CorpusToken* CorpusStore::get(const char* word) {</span>
<a href="#l2.3851"></a><span id="l2.3851">   return static_cast&lt;CorpusToken*&gt;(TokenHash::get(word));</span>
<a href="#l2.3852"></a><span id="l2.3852"> }</span>
<a href="#l2.3853"></a><span id="l2.3853"> </span>
<a href="#l2.3854"></a><span id="l2.3854"> nsresult CorpusStore::updateTrait(CorpusToken* token, uint32_t aTraitId,</span>
<a href="#l2.3855"></a><span id="l2.3855" class="difflineminus">-                                  int32_t aCountChange)</span>
<a href="#l2.3856"></a><span id="l2.3856" class="difflineminus">-{</span>
<a href="#l2.3857"></a><span id="l2.3857" class="difflineplus">+                                  int32_t aCountChange) {</span>
<a href="#l2.3858"></a><span id="l2.3858">   NS_ENSURE_ARG_POINTER(token);</span>
<a href="#l2.3859"></a><span id="l2.3859">   uint32_t nextLink = token-&gt;mTraitLink;</span>
<a href="#l2.3860"></a><span id="l2.3860">   uint32_t lastLink = 0;</span>
<a href="#l2.3861"></a><span id="l2.3861"> </span>
<a href="#l2.3862"></a><span id="l2.3862" class="difflineminus">-  uint32_t linkCount, maxLinks = 100; //sanity check</span>
<a href="#l2.3863"></a><span id="l2.3863" class="difflineminus">-  for (linkCount = 0; nextLink &amp;&amp; linkCount &lt; maxLinks; linkCount++)</span>
<a href="#l2.3864"></a><span id="l2.3864" class="difflineminus">-  {</span>
<a href="#l2.3865"></a><span id="l2.3865" class="difflineplus">+  uint32_t linkCount, maxLinks = 100;  // sanity check</span>
<a href="#l2.3866"></a><span id="l2.3866" class="difflineplus">+  for (linkCount = 0; nextLink &amp;&amp; linkCount &lt; maxLinks; linkCount++) {</span>
<a href="#l2.3867"></a><span id="l2.3867">     TraitPerToken&amp; traitPT = mTraitStore[nextLink];</span>
<a href="#l2.3868"></a><span id="l2.3868" class="difflineminus">-    if (traitPT.mId == aTraitId)</span>
<a href="#l2.3869"></a><span id="l2.3869" class="difflineminus">-    {</span>
<a href="#l2.3870"></a><span id="l2.3870" class="difflineplus">+    if (traitPT.mId == aTraitId) {</span>
<a href="#l2.3871"></a><span id="l2.3871">       // be careful with signed versus unsigned issues here</span>
<a href="#l2.3872"></a><span id="l2.3872">       if (static_cast&lt;int32_t&gt;(traitPT.mCount) + aCountChange &gt; 0)</span>
<a href="#l2.3873"></a><span id="l2.3873">         traitPT.mCount += aCountChange;</span>
<a href="#l2.3874"></a><span id="l2.3874">       else</span>
<a href="#l2.3875"></a><span id="l2.3875">         traitPT.mCount = 0;</span>
<a href="#l2.3876"></a><span id="l2.3876" class="difflineminus">-      // we could delete zero count traits here, but let's not. It's rare anyway.</span>
<a href="#l2.3877"></a><span id="l2.3877" class="difflineplus">+      // we could delete zero count traits here, but let's not. It's rare</span>
<a href="#l2.3878"></a><span id="l2.3878" class="difflineplus">+      // anyway.</span>
<a href="#l2.3879"></a><span id="l2.3879">       return NS_OK;</span>
<a href="#l2.3880"></a><span id="l2.3880">     }</span>
<a href="#l2.3881"></a><span id="l2.3881">     lastLink = nextLink;</span>
<a href="#l2.3882"></a><span id="l2.3882">     nextLink = traitPT.mNextLink;</span>
<a href="#l2.3883"></a><span id="l2.3883">   }</span>
<a href="#l2.3884"></a><span id="l2.3884" class="difflineminus">-  if (linkCount &gt;= maxLinks)</span>
<a href="#l2.3885"></a><span id="l2.3885" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l2.3886"></a><span id="l2.3886" class="difflineplus">+  if (linkCount &gt;= maxLinks) return NS_ERROR_FAILURE;</span>
<a href="#l2.3887"></a><span id="l2.3887"> </span>
<a href="#l2.3888"></a><span id="l2.3888">   // trait does not exist, so add it</span>
<a href="#l2.3889"></a><span id="l2.3889"> </span>
<a href="#l2.3890"></a><span id="l2.3890" class="difflineminus">-  if (aCountChange &gt; 0) // don't set a negative count</span>
<a href="#l2.3891"></a><span id="l2.3891" class="difflineplus">+  if (aCountChange &gt; 0)  // don't set a negative count</span>
<a href="#l2.3892"></a><span id="l2.3892">   {</span>
<a href="#l2.3893"></a><span id="l2.3893">     TraitPerToken traitPT(aTraitId, aCountChange);</span>
<a href="#l2.3894"></a><span id="l2.3894">     if (mTraitStore.Length() == mNextTraitIndex)</span>
<a href="#l2.3895"></a><span id="l2.3895">       mTraitStore.InsertElementAt(mNextTraitIndex, traitPT);</span>
<a href="#l2.3896"></a><span id="l2.3896">     else if (mTraitStore.Length() &gt; mNextTraitIndex)</span>
<a href="#l2.3897"></a><span id="l2.3897">       mTraitStore.ReplaceElementsAt(mNextTraitIndex, 1, traitPT);</span>
<a href="#l2.3898"></a><span id="l2.3898">     else</span>
<a href="#l2.3899"></a><span id="l2.3899">       return NS_ERROR_FAILURE;</span>
<a href="#l2.3900"></a><span id="l2.3900" class="difflineat">@@ -2651,155 +2447,127 @@ nsresult CorpusStore::updateTrait(Corpus</span>
<a href="#l2.3901"></a><span id="l2.3901">     else</span>
<a href="#l2.3902"></a><span id="l2.3902">       // need to update the token's root link</span>
<a href="#l2.3903"></a><span id="l2.3903">       token-&gt;mTraitLink = mNextTraitIndex;</span>
<a href="#l2.3904"></a><span id="l2.3904">     mNextTraitIndex++;</span>
<a href="#l2.3905"></a><span id="l2.3905">   }</span>
<a href="#l2.3906"></a><span id="l2.3906">   return NS_OK;</span>
<a href="#l2.3907"></a><span id="l2.3907"> }</span>
<a href="#l2.3908"></a><span id="l2.3908"> </span>
<a href="#l2.3909"></a><span id="l2.3909" class="difflineminus">-uint32_t CorpusStore::getTraitCount(CorpusToken* token, uint32_t aTraitId)</span>
<a href="#l2.3910"></a><span id="l2.3910" class="difflineminus">-{</span>
<a href="#l2.3911"></a><span id="l2.3911" class="difflineplus">+uint32_t CorpusStore::getTraitCount(CorpusToken* token, uint32_t aTraitId) {</span>
<a href="#l2.3912"></a><span id="l2.3912">   uint32_t nextLink;</span>
<a href="#l2.3913"></a><span id="l2.3913" class="difflineminus">-  if (!token || !(nextLink = token-&gt;mTraitLink))</span>
<a href="#l2.3914"></a><span id="l2.3914" class="difflineminus">-    return 0;</span>
<a href="#l2.3915"></a><span id="l2.3915" class="difflineplus">+  if (!token || !(nextLink = token-&gt;mTraitLink)) return 0;</span>
<a href="#l2.3916"></a><span id="l2.3916"> </span>
<a href="#l2.3917"></a><span id="l2.3917" class="difflineminus">-  uint32_t linkCount, maxLinks = 100; //sanity check</span>
<a href="#l2.3918"></a><span id="l2.3918" class="difflineminus">-  for (linkCount = 0; nextLink &amp;&amp; linkCount &lt; maxLinks; linkCount++)</span>
<a href="#l2.3919"></a><span id="l2.3919" class="difflineminus">-  {</span>
<a href="#l2.3920"></a><span id="l2.3920" class="difflineplus">+  uint32_t linkCount, maxLinks = 100;  // sanity check</span>
<a href="#l2.3921"></a><span id="l2.3921" class="difflineplus">+  for (linkCount = 0; nextLink &amp;&amp; linkCount &lt; maxLinks; linkCount++) {</span>
<a href="#l2.3922"></a><span id="l2.3922">     TraitPerToken&amp; traitPT = mTraitStore[nextLink];</span>
<a href="#l2.3923"></a><span id="l2.3923" class="difflineminus">-    if (traitPT.mId == aTraitId)</span>
<a href="#l2.3924"></a><span id="l2.3924" class="difflineminus">-      return traitPT.mCount;</span>
<a href="#l2.3925"></a><span id="l2.3925" class="difflineplus">+    if (traitPT.mId == aTraitId) return traitPT.mCount;</span>
<a href="#l2.3926"></a><span id="l2.3926">     nextLink = traitPT.mNextLink;</span>
<a href="#l2.3927"></a><span id="l2.3927">   }</span>
<a href="#l2.3928"></a><span id="l2.3928">   NS_ASSERTION(linkCount &lt; maxLinks, &quot;Corrupt trait count store&quot;);</span>
<a href="#l2.3929"></a><span id="l2.3929"> </span>
<a href="#l2.3930"></a><span id="l2.3930">   // trait not found (or error), so count is zero</span>
<a href="#l2.3931"></a><span id="l2.3931">   return 0;</span>
<a href="#l2.3932"></a><span id="l2.3932"> }</span>
<a href="#l2.3933"></a><span id="l2.3933"> </span>
<a href="#l2.3934"></a><span id="l2.3934" class="difflineminus">-CorpusToken* CorpusStore::add(const char* word, uint32_t aTraitId, uint32_t aCount)</span>
<a href="#l2.3935"></a><span id="l2.3935" class="difflineminus">-{</span>
<a href="#l2.3936"></a><span id="l2.3936" class="difflineplus">+CorpusToken* CorpusStore::add(const char* word, uint32_t aTraitId,</span>
<a href="#l2.3937"></a><span id="l2.3937" class="difflineplus">+                              uint32_t aCount) {</span>
<a href="#l2.3938"></a><span id="l2.3938">   CorpusToken* token = static_cast&lt;CorpusToken*&gt;(TokenHash::add(word));</span>
<a href="#l2.3939"></a><span id="l2.3939">   if (token) {</span>
<a href="#l2.3940"></a><span id="l2.3940">     MOZ_LOG(BayesianFilterLogModule, LogLevel::Debug,</span>
<a href="#l2.3941"></a><span id="l2.3941" class="difflineminus">-           (&quot;adding word to corpus store: %s (Trait=%d) (deltaCount=%d)&quot;,</span>
<a href="#l2.3942"></a><span id="l2.3942" class="difflineminus">-            word, aTraitId, aCount));</span>
<a href="#l2.3943"></a><span id="l2.3943" class="difflineplus">+            (&quot;adding word to corpus store: %s (Trait=%d) (deltaCount=%d)&quot;, word,</span>
<a href="#l2.3944"></a><span id="l2.3944" class="difflineplus">+             aTraitId, aCount));</span>
<a href="#l2.3945"></a><span id="l2.3945">     updateTrait(token, aTraitId, aCount);</span>
<a href="#l2.3946"></a><span id="l2.3946">   }</span>
<a href="#l2.3947"></a><span id="l2.3947">   return token;</span>
<a href="#l2.3948"></a><span id="l2.3948" class="difflineminus">- }</span>
<a href="#l2.3949"></a><span id="l2.3949" class="difflineminus">-</span>
<a href="#l2.3950"></a><span id="l2.3950" class="difflineminus">-void CorpusStore::remove(const char* word, uint32_t aTraitId, uint32_t aCount)</span>
<a href="#l2.3951"></a><span id="l2.3951" class="difflineminus">-{</span>
<a href="#l2.3952"></a><span id="l2.3952" class="difflineminus">-  MOZ_LOG(BayesianFilterLogModule, LogLevel::Debug,</span>
<a href="#l2.3953"></a><span id="l2.3953" class="difflineminus">-         (&quot;remove word: %s (TraitId=%d) (Count=%d)&quot;,</span>
<a href="#l2.3954"></a><span id="l2.3954" class="difflineminus">-         word, aTraitId, aCount));</span>
<a href="#l2.3955"></a><span id="l2.3955" class="difflineminus">-  CorpusToken* token = get(word);</span>
<a href="#l2.3956"></a><span id="l2.3956" class="difflineminus">-  if (token)</span>
<a href="#l2.3957"></a><span id="l2.3957" class="difflineminus">-    updateTrait(token, aTraitId, -static_cast&lt;int32_t&gt;(aCount));</span>
<a href="#l2.3958"></a><span id="l2.3958"> }</span>
<a href="#l2.3959"></a><span id="l2.3959"> </span>
<a href="#l2.3960"></a><span id="l2.3960" class="difflineminus">-uint32_t CorpusStore::getMessageCount(uint32_t aTraitId)</span>
<a href="#l2.3961"></a><span id="l2.3961" class="difflineminus">-{</span>
<a href="#l2.3962"></a><span id="l2.3962" class="difflineplus">+void CorpusStore::remove(const char* word, uint32_t aTraitId, uint32_t aCount) {</span>
<a href="#l2.3963"></a><span id="l2.3963" class="difflineplus">+  MOZ_LOG(BayesianFilterLogModule, LogLevel::Debug,</span>
<a href="#l2.3964"></a><span id="l2.3964" class="difflineplus">+          (&quot;remove word: %s (TraitId=%d) (Count=%d)&quot;, word, aTraitId, aCount));</span>
<a href="#l2.3965"></a><span id="l2.3965" class="difflineplus">+  CorpusToken* token = get(word);</span>
<a href="#l2.3966"></a><span id="l2.3966" class="difflineplus">+  if (token) updateTrait(token, aTraitId, -static_cast&lt;int32_t&gt;(aCount));</span>
<a href="#l2.3967"></a><span id="l2.3967" class="difflineplus">+}</span>
<a href="#l2.3968"></a><span id="l2.3968" class="difflineplus">+</span>
<a href="#l2.3969"></a><span id="l2.3969" class="difflineplus">+uint32_t CorpusStore::getMessageCount(uint32_t aTraitId) {</span>
<a href="#l2.3970"></a><span id="l2.3970">   size_t index = mMessageCountsId.IndexOf(aTraitId);</span>
<a href="#l2.3971"></a><span id="l2.3971" class="difflineminus">-  if (index == mMessageCountsId.NoIndex)</span>
<a href="#l2.3972"></a><span id="l2.3972" class="difflineminus">-    return 0;</span>
<a href="#l2.3973"></a><span id="l2.3973" class="difflineplus">+  if (index == mMessageCountsId.NoIndex) return 0;</span>
<a href="#l2.3974"></a><span id="l2.3974">   return mMessageCounts.ElementAt(index);</span>
<a href="#l2.3975"></a><span id="l2.3975"> }</span>
<a href="#l2.3976"></a><span id="l2.3976"> </span>
<a href="#l2.3977"></a><span id="l2.3977" class="difflineminus">-void CorpusStore::setMessageCount(uint32_t aTraitId, uint32_t aCount)</span>
<a href="#l2.3978"></a><span id="l2.3978" class="difflineminus">-{</span>
<a href="#l2.3979"></a><span id="l2.3979" class="difflineplus">+void CorpusStore::setMessageCount(uint32_t aTraitId, uint32_t aCount) {</span>
<a href="#l2.3980"></a><span id="l2.3980">   size_t index = mMessageCountsId.IndexOf(aTraitId);</span>
<a href="#l2.3981"></a><span id="l2.3981" class="difflineminus">-  if (index == mMessageCountsId.NoIndex)</span>
<a href="#l2.3982"></a><span id="l2.3982" class="difflineminus">-  {</span>
<a href="#l2.3983"></a><span id="l2.3983" class="difflineplus">+  if (index == mMessageCountsId.NoIndex) {</span>
<a href="#l2.3984"></a><span id="l2.3984">     mMessageCounts.AppendElement(aCount);</span>
<a href="#l2.3985"></a><span id="l2.3985">     mMessageCountsId.AppendElement(aTraitId);</span>
<a href="#l2.3986"></a><span id="l2.3986" class="difflineminus">-  }</span>
<a href="#l2.3987"></a><span id="l2.3987" class="difflineminus">-  else</span>
<a href="#l2.3988"></a><span id="l2.3988" class="difflineminus">-  {</span>
<a href="#l2.3989"></a><span id="l2.3989" class="difflineplus">+  } else {</span>
<a href="#l2.3990"></a><span id="l2.3990">     mMessageCounts[index] = aCount;</span>
<a href="#l2.3991"></a><span id="l2.3991">   }</span>
<a href="#l2.3992"></a><span id="l2.3992"> }</span>
<a href="#l2.3993"></a><span id="l2.3993"> </span>
<a href="#l2.3994"></a><span id="l2.3994" class="difflineminus">-nsresult</span>
<a href="#l2.3995"></a><span id="l2.3995" class="difflineminus">-CorpusStore::UpdateData(nsIFile *aFile,</span>
<a href="#l2.3996"></a><span id="l2.3996" class="difflineminus">-                        bool aIsAdd,</span>
<a href="#l2.3997"></a><span id="l2.3997" class="difflineminus">-                        uint32_t aRemapCount,</span>
<a href="#l2.3998"></a><span id="l2.3998" class="difflineminus">-                        uint32_t *aFromTraits,</span>
<a href="#l2.3999"></a><span id="l2.3999" class="difflineminus">-                        uint32_t *aToTraits)</span>
<a href="#l2.4000"></a><span id="l2.4000" class="difflineminus">-{</span>
<a href="#l2.4001"></a><span id="l2.4001" class="difflineplus">+nsresult CorpusStore::UpdateData(nsIFile* aFile, bool aIsAdd,</span>
<a href="#l2.4002"></a><span id="l2.4002" class="difflineplus">+                                 uint32_t aRemapCount, uint32_t* aFromTraits,</span>
<a href="#l2.4003"></a><span id="l2.4003" class="difflineplus">+                                 uint32_t* aToTraits) {</span>
<a href="#l2.4004"></a><span id="l2.4004">   NS_ENSURE_ARG_POINTER(aFile);</span>
<a href="#l2.4005"></a><span id="l2.4005" class="difflineminus">-  if (aRemapCount)</span>
<a href="#l2.4006"></a><span id="l2.4006" class="difflineminus">-  {</span>
<a href="#l2.4007"></a><span id="l2.4007" class="difflineplus">+  if (aRemapCount) {</span>
<a href="#l2.4008"></a><span id="l2.4008">     NS_ENSURE_ARG_POINTER(aFromTraits);</span>
<a href="#l2.4009"></a><span id="l2.4009">     NS_ENSURE_ARG_POINTER(aToTraits);</span>
<a href="#l2.4010"></a><span id="l2.4010">   }</span>
<a href="#l2.4011"></a><span id="l2.4011"> </span>
<a href="#l2.4012"></a><span id="l2.4012">   int64_t fileSize;</span>
<a href="#l2.4013"></a><span id="l2.4013">   nsresult rv = aFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l2.4014"></a><span id="l2.4014">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4015"></a><span id="l2.4015"> </span>
<a href="#l2.4016"></a><span id="l2.4016">   FILE* stream;</span>
<a href="#l2.4017"></a><span id="l2.4017">   rv = aFile-&gt;OpenANSIFileDesc(&quot;rb&quot;, &amp;stream);</span>
<a href="#l2.4018"></a><span id="l2.4018">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4019"></a><span id="l2.4019"> </span>
<a href="#l2.4020"></a><span id="l2.4020">   bool error;</span>
<a href="#l2.4021"></a><span id="l2.4021" class="difflineminus">-  do // break on error or done</span>
<a href="#l2.4022"></a><span id="l2.4022" class="difflineplus">+  do  // break on error or done</span>
<a href="#l2.4023"></a><span id="l2.4023">   {</span>
<a href="#l2.4024"></a><span id="l2.4024">     char cookie[4];</span>
<a href="#l2.4025"></a><span id="l2.4025" class="difflineminus">-    if ((error = (fread(cookie, sizeof(cookie), 1, stream) != 1)))</span>
<a href="#l2.4026"></a><span id="l2.4026" class="difflineminus">-      break;</span>
<a href="#l2.4027"></a><span id="l2.4027" class="difflineplus">+    if ((error = (fread(cookie, sizeof(cookie), 1, stream) != 1))) break;</span>
<a href="#l2.4028"></a><span id="l2.4028"> </span>
<a href="#l2.4029"></a><span id="l2.4029" class="difflineminus">-    if ((error = memcmp(cookie, kTraitCookie, sizeof(cookie))))</span>
<a href="#l2.4030"></a><span id="l2.4030" class="difflineminus">-      break;</span>
<a href="#l2.4031"></a><span id="l2.4031" class="difflineplus">+    if ((error = memcmp(cookie, kTraitCookie, sizeof(cookie)))) break;</span>
<a href="#l2.4032"></a><span id="l2.4032"> </span>
<a href="#l2.4033"></a><span id="l2.4033">     uint32_t fileTrait;</span>
<a href="#l2.4034"></a><span id="l2.4034" class="difflineminus">-    while ( !(error = (readUInt32(stream, &amp;fileTrait) != 1)) &amp;&amp; fileTrait)</span>
<a href="#l2.4035"></a><span id="l2.4035" class="difflineminus">-    {</span>
<a href="#l2.4036"></a><span id="l2.4036" class="difflineplus">+    while (!(error = (readUInt32(stream, &amp;fileTrait) != 1)) &amp;&amp; fileTrait) {</span>
<a href="#l2.4037"></a><span id="l2.4037">       uint32_t count;</span>
<a href="#l2.4038"></a><span id="l2.4038" class="difflineminus">-      if ((error = (readUInt32(stream, &amp;count) != 1)))</span>
<a href="#l2.4039"></a><span id="l2.4039" class="difflineminus">-        break;</span>
<a href="#l2.4040"></a><span id="l2.4040" class="difflineplus">+      if ((error = (readUInt32(stream, &amp;count) != 1))) break;</span>
<a href="#l2.4041"></a><span id="l2.4041"> </span>
<a href="#l2.4042"></a><span id="l2.4042">       uint32_t localTrait = fileTrait;</span>
<a href="#l2.4043"></a><span id="l2.4043">       // remap the trait</span>
<a href="#l2.4044"></a><span id="l2.4044" class="difflineminus">-      for (uint32_t i = 0; i &lt; aRemapCount; i++)</span>
<a href="#l2.4045"></a><span id="l2.4045" class="difflineminus">-      {</span>
<a href="#l2.4046"></a><span id="l2.4046" class="difflineminus">-        if (aFromTraits[i] == fileTrait)</span>
<a href="#l2.4047"></a><span id="l2.4047" class="difflineminus">-          localTrait = aToTraits[i];</span>
<a href="#l2.4048"></a><span id="l2.4048" class="difflineplus">+      for (uint32_t i = 0; i &lt; aRemapCount; i++) {</span>
<a href="#l2.4049"></a><span id="l2.4049" class="difflineplus">+        if (aFromTraits[i] == fileTrait) localTrait = aToTraits[i];</span>
<a href="#l2.4050"></a><span id="l2.4050">       }</span>
<a href="#l2.4051"></a><span id="l2.4051"> </span>
<a href="#l2.4052"></a><span id="l2.4052">       uint32_t messageCount = getMessageCount(localTrait);</span>
<a href="#l2.4053"></a><span id="l2.4053">       if (aIsAdd)</span>
<a href="#l2.4054"></a><span id="l2.4054">         messageCount += count;</span>
<a href="#l2.4055"></a><span id="l2.4055">       else if (count &gt; messageCount)</span>
<a href="#l2.4056"></a><span id="l2.4056">         messageCount = 0;</span>
<a href="#l2.4057"></a><span id="l2.4057">       else</span>
<a href="#l2.4058"></a><span id="l2.4058">         messageCount -= count;</span>
<a href="#l2.4059"></a><span id="l2.4059">       setMessageCount(localTrait, messageCount);</span>
<a href="#l2.4060"></a><span id="l2.4060"> </span>
<a href="#l2.4061"></a><span id="l2.4061" class="difflineminus">-      if ((error = !readTokens(stream, fileSize, localTrait, aIsAdd)))</span>
<a href="#l2.4062"></a><span id="l2.4062" class="difflineminus">-        break;</span>
<a href="#l2.4063"></a><span id="l2.4063" class="difflineplus">+      if ((error = !readTokens(stream, fileSize, localTrait, aIsAdd))) break;</span>
<a href="#l2.4064"></a><span id="l2.4064">     }</span>
<a href="#l2.4065"></a><span id="l2.4065">     break;</span>
<a href="#l2.4066"></a><span id="l2.4066">   } while (0);</span>
<a href="#l2.4067"></a><span id="l2.4067"> </span>
<a href="#l2.4068"></a><span id="l2.4068">   fclose(stream);</span>
<a href="#l2.4069"></a><span id="l2.4069"> </span>
<a href="#l2.4070"></a><span id="l2.4070" class="difflineminus">-  if (error)</span>
<a href="#l2.4071"></a><span id="l2.4071" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l2.4072"></a><span id="l2.4072" class="difflineplus">+  if (error) return NS_ERROR_FAILURE;</span>
<a href="#l2.4073"></a><span id="l2.4073">   return NS_OK;</span>
<a href="#l2.4074"></a><span id="l2.4074"> }</span>
<a href="#l2.4075"></a><span id="l2.4075"> </span>
<a href="#l2.4076"></a><span id="l2.4076" class="difflineminus">-nsresult CorpusStore::ClearTrait(uint32_t aTrait)</span>
<a href="#l2.4077"></a><span id="l2.4077" class="difflineminus">-{</span>
<a href="#l2.4078"></a><span id="l2.4078" class="difflineplus">+nsresult CorpusStore::ClearTrait(uint32_t aTrait) {</span>
<a href="#l2.4079"></a><span id="l2.4079">   // clear message counts</span>
<a href="#l2.4080"></a><span id="l2.4080">   setMessageCount(aTrait, 0);</span>
<a href="#l2.4081"></a><span id="l2.4081"> </span>
<a href="#l2.4082"></a><span id="l2.4082">   TokenEnumeration tokens = getTokens();</span>
<a href="#l2.4083"></a><span id="l2.4083" class="difflineminus">-  while (tokens.hasMoreTokens())</span>
<a href="#l2.4084"></a><span id="l2.4084" class="difflineminus">-  {</span>
<a href="#l2.4085"></a><span id="l2.4085" class="difflineplus">+  while (tokens.hasMoreTokens()) {</span>
<a href="#l2.4086"></a><span id="l2.4086">     CorpusToken* token = static_cast&lt;CorpusToken*&gt;(tokens.nextToken());</span>
<a href="#l2.4087"></a><span id="l2.4087">     int32_t wordCount = static_cast&lt;int32_t&gt;(getTraitCount(token, aTrait));</span>
<a href="#l2.4088"></a><span id="l2.4088">     updateTrait(token, aTrait, -wordCount);</span>
<a href="#l2.4089"></a><span id="l2.4089">   }</span>
<a href="#l2.4090"></a><span id="l2.4090">   return NS_OK;</span>
<a href="#l2.4091"></a><span id="l2.4091"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.h</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.h</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -14,388 +14,389 @@</span>
<a href="#l3.4"></a><span id="l3.4"> #include &quot;nsTArray.h&quot;</span>
<a href="#l3.5"></a><span id="l3.5"> #include &quot;nsString.h&quot;</span>
<a href="#l3.6"></a><span id="l3.6"> #include &quot;nsWeakReference.h&quot;</span>
<a href="#l3.7"></a><span id="l3.7"> #include &quot;nsIObserver.h&quot;</span>
<a href="#l3.8"></a><span id="l3.8"> #include &quot;mozilla/intl/WordBreaker.h&quot;</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> #include &quot;mozilla/ArenaAllocator.h&quot;</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-#define DEFAULT_MIN_INTERVAL_BETWEEN_WRITES             15*60*1000</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+#define DEFAULT_MIN_INTERVAL_BETWEEN_WRITES 15 * 60 * 1000</span>
<a href="#l3.14"></a><span id="l3.14"> </span>
<a href="#l3.15"></a><span id="l3.15"> struct Token;</span>
<a href="#l3.16"></a><span id="l3.16"> class TokenEnumeration;</span>
<a href="#l3.17"></a><span id="l3.17"> class TokenAnalyzer;</span>
<a href="#l3.18"></a><span id="l3.18"> class nsIMsgWindow;</span>
<a href="#l3.19"></a><span id="l3.19"> class nsIUTF8StringEnumerator;</span>
<a href="#l3.20"></a><span id="l3.20"> struct BaseToken;</span>
<a href="#l3.21"></a><span id="l3.21"> struct CorpusToken;</span>
<a href="#l3.22"></a><span id="l3.22"> </span>
<a href="#l3.23"></a><span id="l3.23"> /**</span>
<a href="#l3.24"></a><span id="l3.24">  * Helper class to enumerate Token objects in a PLDHashTable</span>
<a href="#l3.25"></a><span id="l3.25">  * safely and without copying (see bugzilla #174859). The</span>
<a href="#l3.26"></a><span id="l3.26">  * enumeration is safe to use until an Add()</span>
<a href="#l3.27"></a><span id="l3.27">  * or Remove() is performed on the table.</span>
<a href="#l3.28"></a><span id="l3.28">  */</span>
<a href="#l3.29"></a><span id="l3.29"> class TokenEnumeration {</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-public:</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-    explicit TokenEnumeration(PLDHashTable* table);</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-    bool hasMoreTokens();</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-    BaseToken* nextToken();</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+ public:</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+  explicit TokenEnumeration(PLDHashTable* table);</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+  bool hasMoreTokens();</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+  BaseToken* nextToken();</span>
<a href="#l3.38"></a><span id="l3.38"> </span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-private:</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-    PLDHashTable::Iterator mIterator;</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+ private:</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+  PLDHashTable::Iterator mIterator;</span>
<a href="#l3.43"></a><span id="l3.43"> };</span>
<a href="#l3.44"></a><span id="l3.44"> </span>
<a href="#l3.45"></a><span id="l3.45"> // A trait is some aspect of a message, like being junk or tagged as</span>
<a href="#l3.46"></a><span id="l3.46"> // Personal, that the statistical classifier should track. The Trait</span>
<a href="#l3.47"></a><span id="l3.47"> // structure is a per-token representation of information pertaining to</span>
<a href="#l3.48"></a><span id="l3.48"> // a message trait.</span>
<a href="#l3.49"></a><span id="l3.49"> //</span>
<a href="#l3.50"></a><span id="l3.50"> // Traits per token are maintained as a linked list.</span>
<a href="#l3.51"></a><span id="l3.51"> //</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-struct TraitPerToken</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-{</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-  uint32_t mId;          // identifying number for a trait</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-  uint32_t mCount;       // count of messages with this token and trait</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-  uint32_t mNextLink;    // index in mTraitStore for the next trait, or 0</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-                         // for none</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-  TraitPerToken(uint32_t aId, uint32_t aCount); // inititializer</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+struct TraitPerToken {</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+  uint32_t mId;        // identifying number for a trait</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+  uint32_t mCount;     // count of messages with this token and trait</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+  uint32_t mNextLink;  // index in mTraitStore for the next trait, or 0</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+                       // for none</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+  TraitPerToken(uint32_t aId, uint32_t aCount);  // inititializer</span>
<a href="#l3.65"></a><span id="l3.65"> };</span>
<a href="#l3.66"></a><span id="l3.66"> </span>
<a href="#l3.67"></a><span id="l3.67"> // An Analysis is the statistical results for a particular message, a</span>
<a href="#l3.68"></a><span id="l3.68"> // particular token, and for a particular pair of trait/antitrait, that</span>
<a href="#l3.69"></a><span id="l3.69"> // is then used in subsequent analysis to score the message.</span>
<a href="#l3.70"></a><span id="l3.70"> //</span>
<a href="#l3.71"></a><span id="l3.71"> // Analyses per token are maintained as a linked list.</span>
<a href="#l3.72"></a><span id="l3.72"> //</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-struct AnalysisPerToken</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-{</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-  uint32_t mTraitIndex;    // index representing a protrait/antitrait pair.</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-                           // So if we are analyzing 3 different traits, then</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-                           // the first trait is 0, the second 1, etc.</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-  double mDistance;        // absolute value of mProbability - 0.5</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-  double mProbability;     // relative indicator of match of trait to token</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineminus">-  uint32_t mNextLink;      // index in mAnalysisStore for the Analysis object</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-                           // for the next trait index, or 0 for none.</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+struct AnalysisPerToken {</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+  uint32_t mTraitIndex;  // index representing a protrait/antitrait pair.</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+                         // So if we are analyzing 3 different traits, then</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+                         // the first trait is 0, the second 1, etc.</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+  double mDistance;      // absolute value of mProbability - 0.5</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+  double mProbability;   // relative indicator of match of trait to token</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+  uint32_t mNextLink;    // index in mAnalysisStore for the Analysis object</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+                         // for the next trait index, or 0 for none.</span>
<a href="#l3.90"></a><span id="l3.90">   // initializer</span>
<a href="#l3.91"></a><span id="l3.91">   AnalysisPerToken(uint32_t aTraitIndex, double aDistance, double aProbability);</span>
<a href="#l3.92"></a><span id="l3.92"> };</span>
<a href="#l3.93"></a><span id="l3.93"> </span>
<a href="#l3.94"></a><span id="l3.94"> class TokenHash {</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineminus">-public:</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+ public:</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+  virtual ~TokenHash();</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+  /**</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+   * Clears out the previous message tokens.</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+   */</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+  nsresult clearTokens();</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+  uint32_t countTokens();</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+  TokenEnumeration getTokens();</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+  BaseToken* add(const char* word);</span>
<a href="#l3.105"></a><span id="l3.105"> </span>
<a href="#l3.106"></a><span id="l3.106" class="difflineminus">-    virtual ~TokenHash();</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineminus">-    /**</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineminus">-     * Clears out the previous message tokens.</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineminus">-     */</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineminus">-    nsresult clearTokens();</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineminus">-    uint32_t countTokens();</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineminus">-    TokenEnumeration getTokens();</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineminus">-    BaseToken* add(const char* word);</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineminus">-</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineminus">-protected:</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineminus">-    explicit TokenHash(uint32_t entrySize);</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineminus">-    mozilla::ArenaAllocator&lt;16384, 2&gt; mWordPool;</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineminus">-    uint32_t mEntrySize;</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineminus">-    PLDHashTable mTokenTable;</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineminus">-    char* copyWord(const char* word, uint32_t len);</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineminus">-    BaseToken* get(const char* word);</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+ protected:</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineplus">+  explicit TokenHash(uint32_t entrySize);</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+  mozilla::ArenaAllocator&lt;16384, 2&gt; mWordPool;</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineplus">+  uint32_t mEntrySize;</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineplus">+  PLDHashTable mTokenTable;</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineplus">+  char* copyWord(const char* word, uint32_t len);</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineplus">+  BaseToken* get(const char* word);</span>
<a href="#l3.129"></a><span id="l3.129"> };</span>
<a href="#l3.130"></a><span id="l3.130"> </span>
<a href="#l3.131"></a><span id="l3.131" class="difflineminus">-class Tokenizer: public TokenHash {</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineminus">-public:</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineminus">-    Tokenizer();</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineminus">-    ~Tokenizer();</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+class Tokenizer : public TokenHash {</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+ public:</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineplus">+  Tokenizer();</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+  ~Tokenizer();</span>
<a href="#l3.139"></a><span id="l3.139"> </span>
<a href="#l3.140"></a><span id="l3.140" class="difflineminus">-    Token* get(const char* word);</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineplus">+  Token* get(const char* word);</span>
<a href="#l3.142"></a><span id="l3.142"> </span>
<a href="#l3.143"></a><span id="l3.143" class="difflineminus">-    // The training set keeps an occurrence count on each word. This count</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineminus">-    // is supposed to count the # of messages it occurs in.</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineminus">-    // When add/remove is called while tokenizing a message and NOT the training set,</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineminus">-    //</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineminus">-    Token* add(const char* word, uint32_t count = 1);</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineplus">+  // The training set keeps an occurrence count on each word. This count</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineplus">+  // is supposed to count the # of messages it occurs in.</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineplus">+  // When add/remove is called while tokenizing a message and NOT the training</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineplus">+  // set,</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineplus">+  //</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineplus">+  Token* add(const char* word, uint32_t count = 1);</span>
<a href="#l3.154"></a><span id="l3.154"> </span>
<a href="#l3.155"></a><span id="l3.155" class="difflineminus">-    Token* copyTokens();</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineplus">+  Token* copyTokens();</span>
<a href="#l3.157"></a><span id="l3.157"> </span>
<a href="#l3.158"></a><span id="l3.158" class="difflineminus">-    void tokenize(const char* text);</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineplus">+  void tokenize(const char* text);</span>
<a href="#l3.160"></a><span id="l3.160"> </span>
<a href="#l3.161"></a><span id="l3.161" class="difflineminus">-    /**</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineminus">-     *  Creates specific tokens based on the mime headers for the message being tokenized</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineminus">-     */</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineminus">-    void tokenizeHeaders(nsIUTF8StringEnumerator * aHeaderNames, nsIUTF8StringEnumerator * aHeaderValues);</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineplus">+  /**</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineplus">+   *  Creates specific tokens based on the mime headers for the message being</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineplus">+   * tokenized</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineplus">+   */</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineplus">+  void tokenizeHeaders(nsIUTF8StringEnumerator* aHeaderNames,</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineplus">+                       nsIUTF8StringEnumerator* aHeaderValues);</span>
<a href="#l3.171"></a><span id="l3.171"> </span>
<a href="#l3.172"></a><span id="l3.172" class="difflineminus">-    void tokenizeAttachment(const char * aContentType, const char * aFileName);</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineplus">+  void tokenizeAttachment(const char* aContentType, const char* aFileName);</span>
<a href="#l3.174"></a><span id="l3.174"> </span>
<a href="#l3.175"></a><span id="l3.175" class="difflineminus">-    nsCString mBodyDelimiters; // delimiters for body tokenization</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineminus">-    nsCString mHeaderDelimiters; // delimiters for header tokenization</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineplus">+  nsCString mBodyDelimiters;    // delimiters for body tokenization</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineplus">+  nsCString mHeaderDelimiters;  // delimiters for header tokenization</span>
<a href="#l3.179"></a><span id="l3.179"> </span>
<a href="#l3.180"></a><span id="l3.180" class="difflineminus">-    // arrays of extra headers to tokenize / to not tokenize</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineminus">-    nsTArray&lt;nsCString&gt; mEnabledHeaders;</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineminus">-    nsTArray&lt;nsCString&gt; mDisabledHeaders;</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineminus">-    // Delimiters used in tokenizing a particular header.</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineminus">-    // Parallel array to mEnabledHeaders</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineminus">-    nsTArray&lt;nsCString&gt; mEnabledHeadersDelimiters;</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineminus">-    bool mCustomHeaderTokenization; // Are there any preference-set tokenization customizations?</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineminus">-    uint32_t mMaxLengthForToken; // maximum length of a token</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineminus">-    // should we convert iframe to div during tokenization?</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineminus">-    bool mIframeToDiv;</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineplus">+  // arrays of extra headers to tokenize / to not tokenize</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineplus">+  nsTArray&lt;nsCString&gt; mEnabledHeaders;</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineplus">+  nsTArray&lt;nsCString&gt; mDisabledHeaders;</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineplus">+  // Delimiters used in tokenizing a particular header.</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineplus">+  // Parallel array to mEnabledHeaders</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineplus">+  nsTArray&lt;nsCString&gt; mEnabledHeadersDelimiters;</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineplus">+  bool mCustomHeaderTokenization;  // Are there any preference-set tokenization</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineplus">+                                   // customizations?</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineplus">+  uint32_t mMaxLengthForToken;     // maximum length of a token</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineplus">+  // should we convert iframe to div during tokenization?</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineplus">+  bool mIframeToDiv;</span>
<a href="#l3.201"></a><span id="l3.201"> </span>
<a href="#l3.202"></a><span id="l3.202" class="difflineminus">-private:</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineminus">-</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineminus">-    void tokenize_ascii_word(char * word);</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineminus">-    void tokenize_japanese_word(char* chunk);</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineminus">-    inline void addTokenForHeader(const char * aTokenPrefix, nsACString&amp; aValue,</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineminus">-        bool aTokenizeValue = false, const char* aDelimiters = nullptr);</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineminus">-    nsresult stripHTML(const nsAString&amp; inString, nsAString&amp; outString);</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineminus">-    // helper function to escape \n, \t, etc from a CString</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineminus">-    void UnescapeCString(nsCString&amp; aCString);</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineminus">-    nsresult ScannerNext(const char16_t *text, int32_t length, int32_t pos,</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineminus">-                         bool isLastBuffer, int32_t *begin, int32_t *end, bool *_retval);</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineminus">-    RefPtr&lt;mozilla::intl::WordBreaker&gt; mWordBreaker;</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineplus">+ private:</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineplus">+  void tokenize_ascii_word(char* word);</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineplus">+  void tokenize_japanese_word(char* chunk);</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineplus">+  inline void addTokenForHeader(const char* aTokenPrefix, nsACString&amp; aValue,</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineplus">+                                bool aTokenizeValue = false,</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineplus">+                                const char* aDelimiters = nullptr);</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineplus">+  nsresult stripHTML(const nsAString&amp; inString, nsAString&amp; outString);</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineplus">+  // helper function to escape \n, \t, etc from a CString</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineplus">+  void UnescapeCString(nsCString&amp; aCString);</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineplus">+  nsresult ScannerNext(const char16_t* text, int32_t length, int32_t pos,</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineplus">+                       bool isLastBuffer, int32_t* begin, int32_t* end,</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineplus">+                       bool* _retval);</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineplus">+  RefPtr&lt;mozilla::intl::WordBreaker&gt; mWordBreaker;</span>
<a href="#l3.227"></a><span id="l3.227"> };</span>
<a href="#l3.228"></a><span id="l3.228"> </span>
<a href="#l3.229"></a><span id="l3.229"> /**</span>
<a href="#l3.230"></a><span id="l3.230">  * Implements storage of a collection of message tokens and counts for</span>
<a href="#l3.231"></a><span id="l3.231">  * a corpus of classified messages</span>
<a href="#l3.232"></a><span id="l3.232">  */</span>
<a href="#l3.233"></a><span id="l3.233"> </span>
<a href="#l3.234"></a><span id="l3.234" class="difflineminus">-class CorpusStore: public TokenHash {</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineminus">-public:</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineminus">-    CorpusStore();</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineminus">-    ~CorpusStore();</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineplus">+class CorpusStore : public TokenHash {</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineplus">+ public:</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineplus">+  CorpusStore();</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineplus">+  ~CorpusStore();</span>
<a href="#l3.242"></a><span id="l3.242"> </span>
<a href="#l3.243"></a><span id="l3.243" class="difflineminus">-    /**</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineminus">-     * retrieve the token structure for a particular string</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineminus">-     *</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineminus">-     * @param word  the character representation of the token</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineminus">-     *</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineminus">-     * @return      token structure containing counts, null if not found</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineminus">-     */</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineminus">-    CorpusToken* get(const char* word);</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineplus">+  /**</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineplus">+   * retrieve the token structure for a particular string</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineplus">+   *</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineplus">+   * @param word  the character representation of the token</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineplus">+   *</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineplus">+   * @return      token structure containing counts, null if not found</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineplus">+   */</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineplus">+  CorpusToken* get(const char* word);</span>
<a href="#l3.259"></a><span id="l3.259"> </span>
<a href="#l3.260"></a><span id="l3.260" class="difflineminus">-    /**</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineminus">-     * add tokens to the storage, or increment counts if already exists.</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineminus">-     *</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineminus">-     * @param aTokenizer tokenizer for the list of tokens to remember</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineminus">-     * @param aTraitId   id for the trait whose counts will be remembered</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineminus">-     * @param aCount     number of new messages represented by the token list</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineminus">-     */</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineminus">-    void rememberTokens(Tokenizer&amp; aTokenizer, uint32_t aTraitId, uint32_t aCount);</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineplus">+  /**</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineplus">+   * add tokens to the storage, or increment counts if already exists.</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineplus">+   *</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineplus">+   * @param aTokenizer tokenizer for the list of tokens to remember</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineplus">+   * @param aTraitId   id for the trait whose counts will be remembered</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineplus">+   * @param aCount     number of new messages represented by the token list</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineplus">+   */</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineplus">+  void rememberTokens(Tokenizer&amp; aTokenizer, uint32_t aTraitId,</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineplus">+                      uint32_t aCount);</span>
<a href="#l3.277"></a><span id="l3.277"> </span>
<a href="#l3.278"></a><span id="l3.278" class="difflineminus">-    /**</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineminus">-     * decrement counts for tokens in the storage, removing if all counts</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineminus">-     * are zero</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineminus">-     *</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineminus">-     * @param aTokenizer tokenizer for the list of tokens to forget</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineminus">-     * @param aTraitId   id for the trait whose counts will be removed</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineminus">-     * @param aCount     number of messages represented by the token list</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineminus">-     */</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineminus">-    void forgetTokens(Tokenizer&amp; aTokenizer, uint32_t aTraitId, uint32_t aCount);</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineplus">+  /**</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineplus">+   * decrement counts for tokens in the storage, removing if all counts</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineplus">+   * are zero</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineplus">+   *</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineplus">+   * @param aTokenizer tokenizer for the list of tokens to forget</span>
<a href="#l3.292"></a><span id="l3.292" class="difflineplus">+   * @param aTraitId   id for the trait whose counts will be removed</span>
<a href="#l3.293"></a><span id="l3.293" class="difflineplus">+   * @param aCount     number of messages represented by the token list</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineplus">+   */</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineplus">+  void forgetTokens(Tokenizer&amp; aTokenizer, uint32_t aTraitId, uint32_t aCount);</span>
<a href="#l3.296"></a><span id="l3.296"> </span>
<a href="#l3.297"></a><span id="l3.297" class="difflineminus">-    /**</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineminus">-     * write the corpus information to file storage</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineminus">-     *</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineminus">-     * @param aMaximumTokenCount  prune tokens if number of tokens exceeds</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineminus">-     *                            this value.  == 0  for no pruning</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineminus">-     */</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineminus">-    void writeTrainingData(uint32_t aMaximumTokenCount);</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineplus">+  /**</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineplus">+   * write the corpus information to file storage</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineplus">+   *</span>
<a href="#l3.307"></a><span id="l3.307" class="difflineplus">+   * @param aMaximumTokenCount  prune tokens if number of tokens exceeds</span>
<a href="#l3.308"></a><span id="l3.308" class="difflineplus">+   *                            this value.  == 0  for no pruning</span>
<a href="#l3.309"></a><span id="l3.309" class="difflineplus">+   */</span>
<a href="#l3.310"></a><span id="l3.310" class="difflineplus">+  void writeTrainingData(uint32_t aMaximumTokenCount);</span>
<a href="#l3.311"></a><span id="l3.311"> </span>
<a href="#l3.312"></a><span id="l3.312" class="difflineminus">-    /**</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineminus">-     * read the corpus information from file storage</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineminus">-     */</span>
<a href="#l3.315"></a><span id="l3.315" class="difflineminus">-    void readTrainingData();</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineplus">+  /**</span>
<a href="#l3.317"></a><span id="l3.317" class="difflineplus">+   * read the corpus information from file storage</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineplus">+   */</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineplus">+  void readTrainingData();</span>
<a href="#l3.320"></a><span id="l3.320"> </span>
<a href="#l3.321"></a><span id="l3.321" class="difflineminus">-    /**</span>
<a href="#l3.322"></a><span id="l3.322" class="difflineminus">-     * delete the local corpus storage file and data</span>
<a href="#l3.323"></a><span id="l3.323" class="difflineminus">-     */</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineminus">-    nsresult resetTrainingData();</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineplus">+  /**</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineplus">+   * delete the local corpus storage file and data</span>
<a href="#l3.327"></a><span id="l3.327" class="difflineplus">+   */</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineplus">+  nsresult resetTrainingData();</span>
<a href="#l3.329"></a><span id="l3.329"> </span>
<a href="#l3.330"></a><span id="l3.330" class="difflineminus">-    /**</span>
<a href="#l3.331"></a><span id="l3.331" class="difflineminus">-     * get the count of messages whose tokens are stored that are associated</span>
<a href="#l3.332"></a><span id="l3.332" class="difflineminus">-     * with a trait</span>
<a href="#l3.333"></a><span id="l3.333" class="difflineminus">-     *</span>
<a href="#l3.334"></a><span id="l3.334" class="difflineminus">-     * @param aTraitId  identifier for the trait</span>
<a href="#l3.335"></a><span id="l3.335" class="difflineminus">-     * @return          number of messages for that trait</span>
<a href="#l3.336"></a><span id="l3.336" class="difflineminus">-     */</span>
<a href="#l3.337"></a><span id="l3.337" class="difflineminus">-    uint32_t getMessageCount(uint32_t aTraitId);</span>
<a href="#l3.338"></a><span id="l3.338" class="difflineplus">+  /**</span>
<a href="#l3.339"></a><span id="l3.339" class="difflineplus">+   * get the count of messages whose tokens are stored that are associated</span>
<a href="#l3.340"></a><span id="l3.340" class="difflineplus">+   * with a trait</span>
<a href="#l3.341"></a><span id="l3.341" class="difflineplus">+   *</span>
<a href="#l3.342"></a><span id="l3.342" class="difflineplus">+   * @param aTraitId  identifier for the trait</span>
<a href="#l3.343"></a><span id="l3.343" class="difflineplus">+   * @return          number of messages for that trait</span>
<a href="#l3.344"></a><span id="l3.344" class="difflineplus">+   */</span>
<a href="#l3.345"></a><span id="l3.345" class="difflineplus">+  uint32_t getMessageCount(uint32_t aTraitId);</span>
<a href="#l3.346"></a><span id="l3.346"> </span>
<a href="#l3.347"></a><span id="l3.347" class="difflineminus">-    /**</span>
<a href="#l3.348"></a><span id="l3.348" class="difflineminus">-     * set the count of messages whose tokens are stored that are associated</span>
<a href="#l3.349"></a><span id="l3.349" class="difflineminus">-     * with a trait</span>
<a href="#l3.350"></a><span id="l3.350" class="difflineminus">-     *</span>
<a href="#l3.351"></a><span id="l3.351" class="difflineminus">-     * @param aTraitId  identifier for the trait</span>
<a href="#l3.352"></a><span id="l3.352" class="difflineminus">-     * @param aCount    number of messages for that trait</span>
<a href="#l3.353"></a><span id="l3.353" class="difflineminus">-     */</span>
<a href="#l3.354"></a><span id="l3.354" class="difflineminus">-    void setMessageCount(uint32_t aTraitId, uint32_t aCount);</span>
<a href="#l3.355"></a><span id="l3.355" class="difflineplus">+  /**</span>
<a href="#l3.356"></a><span id="l3.356" class="difflineplus">+   * set the count of messages whose tokens are stored that are associated</span>
<a href="#l3.357"></a><span id="l3.357" class="difflineplus">+   * with a trait</span>
<a href="#l3.358"></a><span id="l3.358" class="difflineplus">+   *</span>
<a href="#l3.359"></a><span id="l3.359" class="difflineplus">+   * @param aTraitId  identifier for the trait</span>
<a href="#l3.360"></a><span id="l3.360" class="difflineplus">+   * @param aCount    number of messages for that trait</span>
<a href="#l3.361"></a><span id="l3.361" class="difflineplus">+   */</span>
<a href="#l3.362"></a><span id="l3.362" class="difflineplus">+  void setMessageCount(uint32_t aTraitId, uint32_t aCount);</span>
<a href="#l3.363"></a><span id="l3.363"> </span>
<a href="#l3.364"></a><span id="l3.364" class="difflineminus">-    /**</span>
<a href="#l3.365"></a><span id="l3.365" class="difflineminus">-     * get the count of messages associated with a particular token and trait</span>
<a href="#l3.366"></a><span id="l3.366" class="difflineminus">-     *</span>
<a href="#l3.367"></a><span id="l3.367" class="difflineminus">-     * @param  token     the token string and associated counts</span>
<a href="#l3.368"></a><span id="l3.368" class="difflineminus">-     * @param  aTraitId  identifier for the trait</span>
<a href="#l3.369"></a><span id="l3.369" class="difflineminus">-     */</span>
<a href="#l3.370"></a><span id="l3.370" class="difflineminus">-    uint32_t getTraitCount(CorpusToken *token, uint32_t aTraitId);</span>
<a href="#l3.371"></a><span id="l3.371" class="difflineplus">+  /**</span>
<a href="#l3.372"></a><span id="l3.372" class="difflineplus">+   * get the count of messages associated with a particular token and trait</span>
<a href="#l3.373"></a><span id="l3.373" class="difflineplus">+   *</span>
<a href="#l3.374"></a><span id="l3.374" class="difflineplus">+   * @param  token     the token string and associated counts</span>
<a href="#l3.375"></a><span id="l3.375" class="difflineplus">+   * @param  aTraitId  identifier for the trait</span>
<a href="#l3.376"></a><span id="l3.376" class="difflineplus">+   */</span>
<a href="#l3.377"></a><span id="l3.377" class="difflineplus">+  uint32_t getTraitCount(CorpusToken* token, uint32_t aTraitId);</span>
<a href="#l3.378"></a><span id="l3.378"> </span>
<a href="#l3.379"></a><span id="l3.379" class="difflineminus">-    /**</span>
<a href="#l3.380"></a><span id="l3.380" class="difflineminus">-     * Add (or remove) data from a particular file to the corpus data.</span>
<a href="#l3.381"></a><span id="l3.381" class="difflineminus">-     *</span>
<a href="#l3.382"></a><span id="l3.382" class="difflineminus">-     * @param aFile       the file with the data, in the format:</span>
<a href="#l3.383"></a><span id="l3.383" class="difflineminus">-     *</span>
<a href="#l3.384"></a><span id="l3.384" class="difflineminus">-     *                    Format of the trait file for version 1:</span>
<a href="#l3.385"></a><span id="l3.385" class="difflineminus">-     *                    [0xFCA93601]  (the 01 is the version)</span>
<a href="#l3.386"></a><span id="l3.386" class="difflineminus">-     *                    for each trait to write:</span>
<a href="#l3.387"></a><span id="l3.387" class="difflineminus">-     *                    [id of trait to write] (0 means end of list)</span>
<a href="#l3.388"></a><span id="l3.388" class="difflineminus">-     *                    [number of messages per trait]</span>
<a href="#l3.389"></a><span id="l3.389" class="difflineminus">-     *                    for each token with non-zero count</span>
<a href="#l3.390"></a><span id="l3.390" class="difflineminus">-     *                    [count]</span>
<a href="#l3.391"></a><span id="l3.391" class="difflineminus">-     *                    [length of word]word</span>
<a href="#l3.392"></a><span id="l3.392" class="difflineminus">-     *</span>
<a href="#l3.393"></a><span id="l3.393" class="difflineminus">-     * @param aIsAdd      should the data be added, or removed? true if adding,</span>
<a href="#l3.394"></a><span id="l3.394" class="difflineminus">-     *                    else removing.</span>
<a href="#l3.395"></a><span id="l3.395" class="difflineminus">-     *</span>
<a href="#l3.396"></a><span id="l3.396" class="difflineminus">-     * @param aRemapCount number of items in the parallel arrays aFromTraits,</span>
<a href="#l3.397"></a><span id="l3.397" class="difflineminus">-     *                    aToTraits. These arrays allow conversion of the</span>
<a href="#l3.398"></a><span id="l3.398" class="difflineminus">-     *                    trait id stored in the file (which may be originated</span>
<a href="#l3.399"></a><span id="l3.399" class="difflineminus">-     *                    externally) to the trait id used in the local corpus</span>
<a href="#l3.400"></a><span id="l3.400" class="difflineminus">-     *                    (which is defined locally using nsIMsgTraitService).</span>
<a href="#l3.401"></a><span id="l3.401" class="difflineminus">-     *</span>
<a href="#l3.402"></a><span id="l3.402" class="difflineminus">-     * @param aFromTraits array of trait ids used in aFile. If aFile contains</span>
<a href="#l3.403"></a><span id="l3.403" class="difflineminus">-     *                    trait ids that are not in this array, they are not</span>
<a href="#l3.404"></a><span id="l3.404" class="difflineminus">-     *                    remapped, but assumed to be local trait ids.</span>
<a href="#l3.405"></a><span id="l3.405" class="difflineminus">-     *</span>
<a href="#l3.406"></a><span id="l3.406" class="difflineminus">-     * @param aToTraits   array of trait ids, corresponding to elements of</span>
<a href="#l3.407"></a><span id="l3.407" class="difflineminus">-     *                    aFromTraits, that represent the local trait ids to be</span>
<a href="#l3.408"></a><span id="l3.408" class="difflineminus">-     *                    used in storing data from aFile into the local corpus.</span>
<a href="#l3.409"></a><span id="l3.409" class="difflineminus">-     *</span>
<a href="#l3.410"></a><span id="l3.410" class="difflineminus">-     */</span>
<a href="#l3.411"></a><span id="l3.411" class="difflineminus">-    nsresult UpdateData(nsIFile *aFile, bool aIsAdd,</span>
<a href="#l3.412"></a><span id="l3.412" class="difflineminus">-                        uint32_t aRemapCount, uint32_t *aFromTraits,</span>
<a href="#l3.413"></a><span id="l3.413" class="difflineminus">-                        uint32_t *aToTraits);</span>
<a href="#l3.414"></a><span id="l3.414" class="difflineplus">+  /**</span>
<a href="#l3.415"></a><span id="l3.415" class="difflineplus">+   * Add (or remove) data from a particular file to the corpus data.</span>
<a href="#l3.416"></a><span id="l3.416" class="difflineplus">+   *</span>
<a href="#l3.417"></a><span id="l3.417" class="difflineplus">+   * @param aFile       the file with the data, in the format:</span>
<a href="#l3.418"></a><span id="l3.418" class="difflineplus">+   *</span>
<a href="#l3.419"></a><span id="l3.419" class="difflineplus">+   *                    Format of the trait file for version 1:</span>
<a href="#l3.420"></a><span id="l3.420" class="difflineplus">+   *                    [0xFCA93601]  (the 01 is the version)</span>
<a href="#l3.421"></a><span id="l3.421" class="difflineplus">+   *                    for each trait to write:</span>
<a href="#l3.422"></a><span id="l3.422" class="difflineplus">+   *                    [id of trait to write] (0 means end of list)</span>
<a href="#l3.423"></a><span id="l3.423" class="difflineplus">+   *                    [number of messages per trait]</span>
<a href="#l3.424"></a><span id="l3.424" class="difflineplus">+   *                    for each token with non-zero count</span>
<a href="#l3.425"></a><span id="l3.425" class="difflineplus">+   *                    [count]</span>
<a href="#l3.426"></a><span id="l3.426" class="difflineplus">+   *                    [length of word]word</span>
<a href="#l3.427"></a><span id="l3.427" class="difflineplus">+   *</span>
<a href="#l3.428"></a><span id="l3.428" class="difflineplus">+   * @param aIsAdd      should the data be added, or removed? true if adding,</span>
<a href="#l3.429"></a><span id="l3.429" class="difflineplus">+   *                    else removing.</span>
<a href="#l3.430"></a><span id="l3.430" class="difflineplus">+   *</span>
<a href="#l3.431"></a><span id="l3.431" class="difflineplus">+   * @param aRemapCount number of items in the parallel arrays aFromTraits,</span>
<a href="#l3.432"></a><span id="l3.432" class="difflineplus">+   *                    aToTraits. These arrays allow conversion of the</span>
<a href="#l3.433"></a><span id="l3.433" class="difflineplus">+   *                    trait id stored in the file (which may be originated</span>
<a href="#l3.434"></a><span id="l3.434" class="difflineplus">+   *                    externally) to the trait id used in the local corpus</span>
<a href="#l3.435"></a><span id="l3.435" class="difflineplus">+   *                    (which is defined locally using nsIMsgTraitService).</span>
<a href="#l3.436"></a><span id="l3.436" class="difflineplus">+   *</span>
<a href="#l3.437"></a><span id="l3.437" class="difflineplus">+   * @param aFromTraits array of trait ids used in aFile. If aFile contains</span>
<a href="#l3.438"></a><span id="l3.438" class="difflineplus">+   *                    trait ids that are not in this array, they are not</span>
<a href="#l3.439"></a><span id="l3.439" class="difflineplus">+   *                    remapped, but assumed to be local trait ids.</span>
<a href="#l3.440"></a><span id="l3.440" class="difflineplus">+   *</span>
<a href="#l3.441"></a><span id="l3.441" class="difflineplus">+   * @param aToTraits   array of trait ids, corresponding to elements of</span>
<a href="#l3.442"></a><span id="l3.442" class="difflineplus">+   *                    aFromTraits, that represent the local trait ids to be</span>
<a href="#l3.443"></a><span id="l3.443" class="difflineplus">+   *                    used in storing data from aFile into the local corpus.</span>
<a href="#l3.444"></a><span id="l3.444" class="difflineplus">+   *</span>
<a href="#l3.445"></a><span id="l3.445" class="difflineplus">+   */</span>
<a href="#l3.446"></a><span id="l3.446" class="difflineplus">+  nsresult UpdateData(nsIFile* aFile, bool aIsAdd, uint32_t aRemapCount,</span>
<a href="#l3.447"></a><span id="l3.447" class="difflineplus">+                      uint32_t* aFromTraits, uint32_t* aToTraits);</span>
<a href="#l3.448"></a><span id="l3.448"> </span>
<a href="#l3.449"></a><span id="l3.449" class="difflineminus">-    /**</span>
<a href="#l3.450"></a><span id="l3.450" class="difflineminus">-     * remove all counts (message and tokens) for a trait id</span>
<a href="#l3.451"></a><span id="l3.451" class="difflineminus">-     *</span>
<a href="#l3.452"></a><span id="l3.452" class="difflineminus">-     * @param aTrait  trait id for the trait to remove</span>
<a href="#l3.453"></a><span id="l3.453" class="difflineminus">-     */</span>
<a href="#l3.454"></a><span id="l3.454" class="difflineminus">-    nsresult ClearTrait(uint32_t aTrait);</span>
<a href="#l3.455"></a><span id="l3.455" class="difflineplus">+  /**</span>
<a href="#l3.456"></a><span id="l3.456" class="difflineplus">+   * remove all counts (message and tokens) for a trait id</span>
<a href="#l3.457"></a><span id="l3.457" class="difflineplus">+   *</span>
<a href="#l3.458"></a><span id="l3.458" class="difflineplus">+   * @param aTrait  trait id for the trait to remove</span>
<a href="#l3.459"></a><span id="l3.459" class="difflineplus">+   */</span>
<a href="#l3.460"></a><span id="l3.460" class="difflineplus">+  nsresult ClearTrait(uint32_t aTrait);</span>
<a href="#l3.461"></a><span id="l3.461"> </span>
<a href="#l3.462"></a><span id="l3.462" class="difflineminus">-protected:</span>
<a href="#l3.463"></a><span id="l3.463" class="difflineplus">+ protected:</span>
<a href="#l3.464"></a><span id="l3.464" class="difflineplus">+  /**</span>
<a href="#l3.465"></a><span id="l3.465" class="difflineplus">+   * return the local corpus storage file for junk traits</span>
<a href="#l3.466"></a><span id="l3.466" class="difflineplus">+   */</span>
<a href="#l3.467"></a><span id="l3.467" class="difflineplus">+  nsresult getTrainingFile(nsIFile** aFile);</span>
<a href="#l3.468"></a><span id="l3.468"> </span>
<a href="#l3.469"></a><span id="l3.469" class="difflineminus">-    /**</span>
<a href="#l3.470"></a><span id="l3.470" class="difflineminus">-     * return the local corpus storage file for junk traits</span>
<a href="#l3.471"></a><span id="l3.471" class="difflineminus">-     */</span>
<a href="#l3.472"></a><span id="l3.472" class="difflineminus">-    nsresult getTrainingFile(nsIFile ** aFile);</span>
<a href="#l3.473"></a><span id="l3.473" class="difflineminus">-</span>
<a href="#l3.474"></a><span id="l3.474" class="difflineminus">-    /**</span>
<a href="#l3.475"></a><span id="l3.475" class="difflineminus">-     * return the local corpus storage file for non-junk traits</span>
<a href="#l3.476"></a><span id="l3.476" class="difflineminus">-     */</span>
<a href="#l3.477"></a><span id="l3.477" class="difflineminus">-    nsresult getTraitFile(nsIFile ** aFile);</span>
<a href="#l3.478"></a><span id="l3.478" class="difflineplus">+  /**</span>
<a href="#l3.479"></a><span id="l3.479" class="difflineplus">+   * return the local corpus storage file for non-junk traits</span>
<a href="#l3.480"></a><span id="l3.480" class="difflineplus">+   */</span>
<a href="#l3.481"></a><span id="l3.481" class="difflineplus">+  nsresult getTraitFile(nsIFile** aFile);</span>
<a href="#l3.482"></a><span id="l3.482"> </span>
<a href="#l3.483"></a><span id="l3.483" class="difflineminus">-    /**</span>
<a href="#l3.484"></a><span id="l3.484" class="difflineminus">-     * read token strings from the data file</span>
<a href="#l3.485"></a><span id="l3.485" class="difflineminus">-     *</span>
<a href="#l3.486"></a><span id="l3.486" class="difflineminus">-     * @param stream     file stream with token data</span>
<a href="#l3.487"></a><span id="l3.487" class="difflineminus">-     * @param fileSize   file size</span>
<a href="#l3.488"></a><span id="l3.488" class="difflineminus">-     * @param aTraitId   id for the trait whose counts will be read</span>
<a href="#l3.489"></a><span id="l3.489" class="difflineminus">-     * @param aIsAdd     true to add the counts, false to remove them</span>
<a href="#l3.490"></a><span id="l3.490" class="difflineminus">-     *</span>
<a href="#l3.491"></a><span id="l3.491" class="difflineminus">-     * @return           true if successful, false if error</span>
<a href="#l3.492"></a><span id="l3.492" class="difflineminus">-     */</span>
<a href="#l3.493"></a><span id="l3.493" class="difflineminus">-    bool readTokens(FILE* stream, int64_t fileSize, uint32_t aTraitId,</span>
<a href="#l3.494"></a><span id="l3.494" class="difflineminus">-                      bool aIsAdd);</span>
<a href="#l3.495"></a><span id="l3.495" class="difflineplus">+  /**</span>
<a href="#l3.496"></a><span id="l3.496" class="difflineplus">+   * read token strings from the data file</span>
<a href="#l3.497"></a><span id="l3.497" class="difflineplus">+   *</span>
<a href="#l3.498"></a><span id="l3.498" class="difflineplus">+   * @param stream     file stream with token data</span>
<a href="#l3.499"></a><span id="l3.499" class="difflineplus">+   * @param fileSize   file size</span>
<a href="#l3.500"></a><span id="l3.500" class="difflineplus">+   * @param aTraitId   id for the trait whose counts will be read</span>
<a href="#l3.501"></a><span id="l3.501" class="difflineplus">+   * @param aIsAdd     true to add the counts, false to remove them</span>
<a href="#l3.502"></a><span id="l3.502" class="difflineplus">+   *</span>
<a href="#l3.503"></a><span id="l3.503" class="difflineplus">+   * @return           true if successful, false if error</span>
<a href="#l3.504"></a><span id="l3.504" class="difflineplus">+   */</span>
<a href="#l3.505"></a><span id="l3.505" class="difflineplus">+  bool readTokens(FILE* stream, int64_t fileSize, uint32_t aTraitId,</span>
<a href="#l3.506"></a><span id="l3.506" class="difflineplus">+                  bool aIsAdd);</span>
<a href="#l3.507"></a><span id="l3.507" class="difflineplus">+</span>
<a href="#l3.508"></a><span id="l3.508" class="difflineplus">+  /**</span>
<a href="#l3.509"></a><span id="l3.509" class="difflineplus">+   * write token strings to the data file</span>
<a href="#l3.510"></a><span id="l3.510" class="difflineplus">+   */</span>
<a href="#l3.511"></a><span id="l3.511" class="difflineplus">+  bool writeTokens(FILE* stream, bool shrink, uint32_t aTraitId);</span>
<a href="#l3.512"></a><span id="l3.512"> </span>
<a href="#l3.513"></a><span id="l3.513" class="difflineminus">-    /**</span>
<a href="#l3.514"></a><span id="l3.514" class="difflineminus">-     * write token strings to the data file</span>
<a href="#l3.515"></a><span id="l3.515" class="difflineminus">-     */</span>
<a href="#l3.516"></a><span id="l3.516" class="difflineminus">-    bool writeTokens(FILE* stream, bool shrink, uint32_t aTraitId);</span>
<a href="#l3.517"></a><span id="l3.517" class="difflineplus">+  /**</span>
<a href="#l3.518"></a><span id="l3.518" class="difflineplus">+   * remove counts for a token string</span>
<a href="#l3.519"></a><span id="l3.519" class="difflineplus">+   */</span>
<a href="#l3.520"></a><span id="l3.520" class="difflineplus">+  void remove(const char* word, uint32_t aTraitId, uint32_t aCount);</span>
<a href="#l3.521"></a><span id="l3.521"> </span>
<a href="#l3.522"></a><span id="l3.522" class="difflineminus">-    /**</span>
<a href="#l3.523"></a><span id="l3.523" class="difflineminus">-     * remove counts for a token string</span>
<a href="#l3.524"></a><span id="l3.524" class="difflineminus">-     */</span>
<a href="#l3.525"></a><span id="l3.525" class="difflineminus">-    void remove(const char* word, uint32_t aTraitId, uint32_t aCount);</span>
<a href="#l3.526"></a><span id="l3.526" class="difflineminus">-</span>
<a href="#l3.527"></a><span id="l3.527" class="difflineminus">-    /**</span>
<a href="#l3.528"></a><span id="l3.528" class="difflineminus">-     * add counts for a token string, adding the token string if new</span>
<a href="#l3.529"></a><span id="l3.529" class="difflineminus">-     */</span>
<a href="#l3.530"></a><span id="l3.530" class="difflineminus">-    CorpusToken* add(const char* word, uint32_t aTraitId, uint32_t aCount);</span>
<a href="#l3.531"></a><span id="l3.531" class="difflineplus">+  /**</span>
<a href="#l3.532"></a><span id="l3.532" class="difflineplus">+   * add counts for a token string, adding the token string if new</span>
<a href="#l3.533"></a><span id="l3.533" class="difflineplus">+   */</span>
<a href="#l3.534"></a><span id="l3.534" class="difflineplus">+  CorpusToken* add(const char* word, uint32_t aTraitId, uint32_t aCount);</span>
<a href="#l3.535"></a><span id="l3.535"> </span>
<a href="#l3.536"></a><span id="l3.536" class="difflineminus">-    /**</span>
<a href="#l3.537"></a><span id="l3.537" class="difflineminus">-     * change counts in a trait in the traits array, adding the trait if needed</span>
<a href="#l3.538"></a><span id="l3.538" class="difflineminus">-     */</span>
<a href="#l3.539"></a><span id="l3.539" class="difflineminus">-    nsresult updateTrait(CorpusToken* token, uint32_t aTraitId,</span>
<a href="#l3.540"></a><span id="l3.540" class="difflineminus">-      int32_t aCountChange);</span>
<a href="#l3.541"></a><span id="l3.541" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; mTrainingFile;  // file used to store junk training data</span>
<a href="#l3.542"></a><span id="l3.542" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; mTraitFile;     // file used to store non-junk</span>
<a href="#l3.543"></a><span id="l3.543" class="difflineminus">-                                           // training data</span>
<a href="#l3.544"></a><span id="l3.544" class="difflineminus">-    nsTArray&lt;TraitPerToken&gt; mTraitStore;   // memory for linked-list of counts</span>
<a href="#l3.545"></a><span id="l3.545" class="difflineminus">-    uint32_t mNextTraitIndex;              // index in mTraitStore to first empty</span>
<a href="#l3.546"></a><span id="l3.546" class="difflineminus">-                                           // TraitPerToken</span>
<a href="#l3.547"></a><span id="l3.547" class="difflineminus">-    nsTArray&lt;uint32_t&gt; mMessageCounts;     // count of messages per trait</span>
<a href="#l3.548"></a><span id="l3.548" class="difflineminus">-                                           // represented in the store</span>
<a href="#l3.549"></a><span id="l3.549" class="difflineminus">-    nsTArray&lt;uint32_t&gt; mMessageCountsId;   // Parallel array to mMessageCounts, with</span>
<a href="#l3.550"></a><span id="l3.550" class="difflineminus">-                                           // the corresponding trait ID</span>
<a href="#l3.551"></a><span id="l3.551" class="difflineplus">+  /**</span>
<a href="#l3.552"></a><span id="l3.552" class="difflineplus">+   * change counts in a trait in the traits array, adding the trait if needed</span>
<a href="#l3.553"></a><span id="l3.553" class="difflineplus">+   */</span>
<a href="#l3.554"></a><span id="l3.554" class="difflineplus">+  nsresult updateTrait(CorpusToken* token, uint32_t aTraitId,</span>
<a href="#l3.555"></a><span id="l3.555" class="difflineplus">+                       int32_t aCountChange);</span>
<a href="#l3.556"></a><span id="l3.556" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; mTrainingFile;      // file used to store junk training data</span>
<a href="#l3.557"></a><span id="l3.557" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; mTraitFile;         // file used to store non-junk</span>
<a href="#l3.558"></a><span id="l3.558" class="difflineplus">+                                        // training data</span>
<a href="#l3.559"></a><span id="l3.559" class="difflineplus">+  nsTArray&lt;TraitPerToken&gt; mTraitStore;  // memory for linked-list of counts</span>
<a href="#l3.560"></a><span id="l3.560" class="difflineplus">+  uint32_t mNextTraitIndex;             // index in mTraitStore to first empty</span>
<a href="#l3.561"></a><span id="l3.561" class="difflineplus">+                                        // TraitPerToken</span>
<a href="#l3.562"></a><span id="l3.562" class="difflineplus">+  nsTArray&lt;uint32_t&gt; mMessageCounts;    // count of messages per trait</span>
<a href="#l3.563"></a><span id="l3.563" class="difflineplus">+                                        // represented in the store</span>
<a href="#l3.564"></a><span id="l3.564" class="difflineplus">+  nsTArray&lt;uint32_t&gt; mMessageCountsId;  // Parallel array to mMessageCounts,</span>
<a href="#l3.565"></a><span id="l3.565" class="difflineplus">+                                        // with the corresponding trait ID</span>
<a href="#l3.566"></a><span id="l3.566"> };</span>
<a href="#l3.567"></a><span id="l3.567"> </span>
<a href="#l3.568"></a><span id="l3.568" class="difflineminus">-class nsBayesianFilter : public nsIJunkMailPlugin, nsIMsgCorpus,</span>
<a href="#l3.569"></a><span id="l3.569" class="difflineminus">-                         nsIObserver, nsSupportsWeakReference {</span>
<a href="#l3.570"></a><span id="l3.570" class="difflineminus">-public:</span>
<a href="#l3.571"></a><span id="l3.571" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l3.572"></a><span id="l3.572" class="difflineminus">-    NS_DECL_NSIMSGFILTERPLUGIN</span>
<a href="#l3.573"></a><span id="l3.573" class="difflineminus">-    NS_DECL_NSIJUNKMAILPLUGIN</span>
<a href="#l3.574"></a><span id="l3.574" class="difflineminus">-    NS_DECL_NSIMSGCORPUS</span>
<a href="#l3.575"></a><span id="l3.575" class="difflineminus">-    NS_DECL_NSIOBSERVER</span>
<a href="#l3.576"></a><span id="l3.576" class="difflineplus">+class nsBayesianFilter : public nsIJunkMailPlugin,</span>
<a href="#l3.577"></a><span id="l3.577" class="difflineplus">+                         nsIMsgCorpus,</span>
<a href="#l3.578"></a><span id="l3.578" class="difflineplus">+                         nsIObserver,</span>
<a href="#l3.579"></a><span id="l3.579" class="difflineplus">+                         nsSupportsWeakReference {</span>
<a href="#l3.580"></a><span id="l3.580" class="difflineplus">+ public:</span>
<a href="#l3.581"></a><span id="l3.581" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l3.582"></a><span id="l3.582" class="difflineplus">+  NS_DECL_NSIMSGFILTERPLUGIN</span>
<a href="#l3.583"></a><span id="l3.583" class="difflineplus">+  NS_DECL_NSIJUNKMAILPLUGIN</span>
<a href="#l3.584"></a><span id="l3.584" class="difflineplus">+  NS_DECL_NSIMSGCORPUS</span>
<a href="#l3.585"></a><span id="l3.585" class="difflineplus">+  NS_DECL_NSIOBSERVER</span>
<a href="#l3.586"></a><span id="l3.586"> </span>
<a href="#l3.587"></a><span id="l3.587" class="difflineminus">-    nsBayesianFilter();</span>
<a href="#l3.588"></a><span id="l3.588" class="difflineminus">-</span>
<a href="#l3.589"></a><span id="l3.589" class="difflineminus">-    nsresult Init();</span>
<a href="#l3.590"></a><span id="l3.590" class="difflineplus">+  nsBayesianFilter();</span>
<a href="#l3.591"></a><span id="l3.591"> </span>
<a href="#l3.592"></a><span id="l3.592" class="difflineminus">-    nsresult tokenizeMessage(const char* messageURI, nsIMsgWindow *aMsgWindow, TokenAnalyzer* analyzer);</span>
<a href="#l3.593"></a><span id="l3.593" class="difflineminus">-    void classifyMessage(Tokenizer&amp; tokens, const char* messageURI,</span>
<a href="#l3.594"></a><span id="l3.594" class="difflineminus">-                        nsIJunkMailClassificationListener* listener);</span>
<a href="#l3.595"></a><span id="l3.595" class="difflineplus">+  nsresult Init();</span>
<a href="#l3.596"></a><span id="l3.596" class="difflineplus">+</span>
<a href="#l3.597"></a><span id="l3.597" class="difflineplus">+  nsresult tokenizeMessage(const char* messageURI, nsIMsgWindow* aMsgWindow,</span>
<a href="#l3.598"></a><span id="l3.598" class="difflineplus">+                           TokenAnalyzer* analyzer);</span>
<a href="#l3.599"></a><span id="l3.599" class="difflineplus">+  void classifyMessage(Tokenizer&amp; tokens, const char* messageURI,</span>
<a href="#l3.600"></a><span id="l3.600" class="difflineplus">+                       nsIJunkMailClassificationListener* listener);</span>
<a href="#l3.601"></a><span id="l3.601"> </span>
<a href="#l3.602"></a><span id="l3.602" class="difflineminus">-    void classifyMessage(</span>
<a href="#l3.603"></a><span id="l3.603" class="difflineminus">-      Tokenizer&amp; tokenizer,</span>
<a href="#l3.604"></a><span id="l3.604" class="difflineminus">-      const char* messageURI,</span>
<a href="#l3.605"></a><span id="l3.605" class="difflineminus">-      nsTArray&lt;uint32_t&gt;&amp; aProTraits,</span>
<a href="#l3.606"></a><span id="l3.606" class="difflineminus">-      nsTArray&lt;uint32_t&gt;&amp; aAntiTraits,</span>
<a href="#l3.607"></a><span id="l3.607" class="difflineminus">-      nsIJunkMailClassificationListener* listener,</span>
<a href="#l3.608"></a><span id="l3.608" class="difflineminus">-      nsIMsgTraitClassificationListener* aTraitListener,</span>
<a href="#l3.609"></a><span id="l3.609" class="difflineminus">-      nsIMsgTraitDetailListener* aDetailListener);</span>
<a href="#l3.610"></a><span id="l3.610" class="difflineplus">+  void classifyMessage(Tokenizer&amp; tokenizer, const char* messageURI,</span>
<a href="#l3.611"></a><span id="l3.611" class="difflineplus">+                       nsTArray&lt;uint32_t&gt;&amp; aProTraits,</span>
<a href="#l3.612"></a><span id="l3.612" class="difflineplus">+                       nsTArray&lt;uint32_t&gt;&amp; aAntiTraits,</span>
<a href="#l3.613"></a><span id="l3.613" class="difflineplus">+                       nsIJunkMailClassificationListener* listener,</span>
<a href="#l3.614"></a><span id="l3.614" class="difflineplus">+                       nsIMsgTraitClassificationListener* aTraitListener,</span>
<a href="#l3.615"></a><span id="l3.615" class="difflineplus">+                       nsIMsgTraitDetailListener* aDetailListener);</span>
<a href="#l3.616"></a><span id="l3.616"> </span>
<a href="#l3.617"></a><span id="l3.617" class="difflineminus">-    void observeMessage(Tokenizer&amp; tokens, const char* messageURI,</span>
<a href="#l3.618"></a><span id="l3.618" class="difflineminus">-                        nsTArray&lt;uint32_t&gt;&amp; oldClassifications,</span>
<a href="#l3.619"></a><span id="l3.619" class="difflineminus">-                        nsTArray&lt;uint32_t&gt;&amp; newClassifications,</span>
<a href="#l3.620"></a><span id="l3.620" class="difflineminus">-                        nsIJunkMailClassificationListener* listener,</span>
<a href="#l3.621"></a><span id="l3.621" class="difflineminus">-                        nsIMsgTraitClassificationListener* aTraitListener);</span>
<a href="#l3.622"></a><span id="l3.622" class="difflineplus">+  void observeMessage(Tokenizer&amp; tokens, const char* messageURI,</span>
<a href="#l3.623"></a><span id="l3.623" class="difflineplus">+                      nsTArray&lt;uint32_t&gt;&amp; oldClassifications,</span>
<a href="#l3.624"></a><span id="l3.624" class="difflineplus">+                      nsTArray&lt;uint32_t&gt;&amp; newClassifications,</span>
<a href="#l3.625"></a><span id="l3.625" class="difflineplus">+                      nsIJunkMailClassificationListener* listener,</span>
<a href="#l3.626"></a><span id="l3.626" class="difflineplus">+                      nsIMsgTraitClassificationListener* aTraitListener);</span>
<a href="#l3.627"></a><span id="l3.627"> </span>
<a href="#l3.628"></a><span id="l3.628" class="difflineplus">+ protected:</span>
<a href="#l3.629"></a><span id="l3.629" class="difflineplus">+  virtual ~nsBayesianFilter();</span>
<a href="#l3.630"></a><span id="l3.630"> </span>
<a href="#l3.631"></a><span id="l3.631" class="difflineminus">-protected:</span>
<a href="#l3.632"></a><span id="l3.632" class="difflineminus">-    virtual ~nsBayesianFilter();</span>
<a href="#l3.633"></a><span id="l3.633" class="difflineminus">-</span>
<a href="#l3.634"></a><span id="l3.634" class="difflineminus">-    static void TimerCallback(nsITimer* aTimer, void* aClosure);</span>
<a href="#l3.635"></a><span id="l3.635" class="difflineplus">+  static void TimerCallback(nsITimer* aTimer, void* aClosure);</span>
<a href="#l3.636"></a><span id="l3.636"> </span>
<a href="#l3.637"></a><span id="l3.637" class="difflineminus">-    CorpusStore mCorpus;</span>
<a href="#l3.638"></a><span id="l3.638" class="difflineminus">-    double   mJunkProbabilityThreshold;</span>
<a href="#l3.639"></a><span id="l3.639" class="difflineminus">-    int32_t mMaximumTokenCount;</span>
<a href="#l3.640"></a><span id="l3.640" class="difflineminus">-    bool mTrainingDataDirty;</span>
<a href="#l3.641"></a><span id="l3.641" class="difflineminus">-    int32_t mMinFlushInterval; // in milliseconds, must be positive</span>
<a href="#l3.642"></a><span id="l3.642" class="difflineminus">-                               //and not too close to 0</span>
<a href="#l3.643"></a><span id="l3.643" class="difflineminus">-    nsCOMPtr&lt;nsITimer&gt; mTimer;</span>
<a href="#l3.644"></a><span id="l3.644" class="difflineplus">+  CorpusStore mCorpus;</span>
<a href="#l3.645"></a><span id="l3.645" class="difflineplus">+  double mJunkProbabilityThreshold;</span>
<a href="#l3.646"></a><span id="l3.646" class="difflineplus">+  int32_t mMaximumTokenCount;</span>
<a href="#l3.647"></a><span id="l3.647" class="difflineplus">+  bool mTrainingDataDirty;</span>
<a href="#l3.648"></a><span id="l3.648" class="difflineplus">+  int32_t mMinFlushInterval;  // in milliseconds, must be positive</span>
<a href="#l3.649"></a><span id="l3.649" class="difflineplus">+                              // and not too close to 0</span>
<a href="#l3.650"></a><span id="l3.650" class="difflineplus">+  nsCOMPtr&lt;nsITimer&gt; mTimer;</span>
<a href="#l3.651"></a><span id="l3.651"> </span>
<a href="#l3.652"></a><span id="l3.652" class="difflineminus">-    // index in mAnalysisStore for first empty AnalysisPerToken</span>
<a href="#l3.653"></a><span id="l3.653" class="difflineminus">-    uint32_t mNextAnalysisIndex;</span>
<a href="#l3.654"></a><span id="l3.654" class="difflineminus">-     // memory for linked list of AnalysisPerToken objects</span>
<a href="#l3.655"></a><span id="l3.655" class="difflineminus">-    nsTArray&lt;AnalysisPerToken&gt; mAnalysisStore;</span>
<a href="#l3.656"></a><span id="l3.656" class="difflineminus">-    /**</span>
<a href="#l3.657"></a><span id="l3.657" class="difflineminus">-     * Determine the location in mAnalysisStore where the AnalysisPerToken</span>
<a href="#l3.658"></a><span id="l3.658" class="difflineminus">-     * object for a particular token and trait is stored</span>
<a href="#l3.659"></a><span id="l3.659" class="difflineminus">-     */</span>
<a href="#l3.660"></a><span id="l3.660" class="difflineminus">-    uint32_t getAnalysisIndex(Token&amp; token, uint32_t aTraitIndex);</span>
<a href="#l3.661"></a><span id="l3.661" class="difflineminus">-    /**</span>
<a href="#l3.662"></a><span id="l3.662" class="difflineminus">-     * Set the value of the AnalysisPerToken object for a particular</span>
<a href="#l3.663"></a><span id="l3.663" class="difflineminus">-     * token and trait</span>
<a href="#l3.664"></a><span id="l3.664" class="difflineminus">-     */</span>
<a href="#l3.665"></a><span id="l3.665" class="difflineminus">-    nsresult setAnalysis(Token&amp; token, uint32_t aTraitIndex,</span>
<a href="#l3.666"></a><span id="l3.666" class="difflineminus">-                         double aDistance, double aProbability);</span>
<a href="#l3.667"></a><span id="l3.667" class="difflineplus">+  // index in mAnalysisStore for first empty AnalysisPerToken</span>
<a href="#l3.668"></a><span id="l3.668" class="difflineplus">+  uint32_t mNextAnalysisIndex;</span>
<a href="#l3.669"></a><span id="l3.669" class="difflineplus">+  // memory for linked list of AnalysisPerToken objects</span>
<a href="#l3.670"></a><span id="l3.670" class="difflineplus">+  nsTArray&lt;AnalysisPerToken&gt; mAnalysisStore;</span>
<a href="#l3.671"></a><span id="l3.671" class="difflineplus">+  /**</span>
<a href="#l3.672"></a><span id="l3.672" class="difflineplus">+   * Determine the location in mAnalysisStore where the AnalysisPerToken</span>
<a href="#l3.673"></a><span id="l3.673" class="difflineplus">+   * object for a particular token and trait is stored</span>
<a href="#l3.674"></a><span id="l3.674" class="difflineplus">+   */</span>
<a href="#l3.675"></a><span id="l3.675" class="difflineplus">+  uint32_t getAnalysisIndex(Token&amp; token, uint32_t aTraitIndex);</span>
<a href="#l3.676"></a><span id="l3.676" class="difflineplus">+  /**</span>
<a href="#l3.677"></a><span id="l3.677" class="difflineplus">+   * Set the value of the AnalysisPerToken object for a particular</span>
<a href="#l3.678"></a><span id="l3.678" class="difflineplus">+   * token and trait</span>
<a href="#l3.679"></a><span id="l3.679" class="difflineplus">+   */</span>
<a href="#l3.680"></a><span id="l3.680" class="difflineplus">+  nsresult setAnalysis(Token&amp; token, uint32_t aTraitIndex, double aDistance,</span>
<a href="#l3.681"></a><span id="l3.681" class="difflineplus">+                       double aProbability);</span>
<a href="#l3.682"></a><span id="l3.682"> };</span>
<a href="#l3.683"></a><span id="l3.683"> </span>
<a href="#l3.684"></a><span id="l3.684" class="difflineminus">-#endif // _nsBayesianFilter_h__</span>
<a href="#l3.685"></a><span id="l3.685" class="difflineplus">+#endif  // _nsBayesianFilter_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilterCID.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilterCID.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -3,14 +3,16 @@</span>
<a href="#l4.4"></a><span id="l4.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.5"></a><span id="l4.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7"> #ifndef nsBayesianFilterCID_h__</span>
<a href="#l4.8"></a><span id="l4.8"> #define nsBayesianFilterCID_h__</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10"> #define NS_BAYESIANFILTER_CONTRACTID \</span>
<a href="#l4.11"></a><span id="l4.11">   &quot;@mozilla.org/messenger/filter-plugin;1?name=bayesianfilter&quot;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-#define NS_BAYESIANFILTER_CID                    \</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-{ /* F1070BFA-D539-11D6-90CA-00039310A47A */      \</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">- 0xF1070BFA, 0xD539, 0x11D6,                      \</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">- { 0x90, 0xCA, 0x00, 0x03, 0x93, 0x10, 0xA4, 0x7A }}</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+#define NS_BAYESIANFILTER_CID                        \</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+  { /* F1070BFA-D539-11D6-90CA-00039310A47A */       \</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+    0xF1070BFA, 0xD539, 0x11D6, {                    \</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+      0x90, 0xCA, 0x00, 0x03, 0x93, 0x10, 0xA4, 0x7A \</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+    }                                                \</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+  }</span>
<a href="#l4.22"></a><span id="l4.22"> </span>
<a href="#l4.23"></a><span id="l4.23"> #endif /* nsBayesianFilterCID_h__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/extensions/bayesian-spam-filter/src/nsIncompleteGamma.h</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/extensions/bayesian-spam-filter/src/nsIncompleteGamma.h</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -51,47 +51,54 @@</span>
<a href="#l5.4"></a><span id="l5.4">    convergence. A value is always returned, though.</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6">  */</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> #include &lt;math.h&gt;</span>
<a href="#l5.9"></a><span id="l5.9"> #include &lt;float.h&gt;</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11"> // the main routine</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-static double nsIncompleteGammaP (double a, double x, int *error);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+static double nsIncompleteGammaP(double a, double x, int *error);</span>
<a href="#l5.14"></a><span id="l5.14"> </span>
<a href="#l5.15"></a><span id="l5.15"> // nsLnGamma(z): either a wrapper around lgamma_r or the internal function.</span>
<a href="#l5.16"></a><span id="l5.16"> // C_m = B[2*m]/(2*m*(2*m-1)) where B is a Bernoulli number</span>
<a href="#l5.17"></a><span id="l5.17"> static const double C_1 = 1.0 / 12.0;</span>
<a href="#l5.18"></a><span id="l5.18"> static const double C_2 = -1.0 / 360.0;</span>
<a href="#l5.19"></a><span id="l5.19"> static const double C_3 = 1.0 / 1260.0;</span>
<a href="#l5.20"></a><span id="l5.20"> static const double C_4 = -1.0 / 1680.0;</span>
<a href="#l5.21"></a><span id="l5.21"> static const double C_5 = 1.0 / 1188.0;</span>
<a href="#l5.22"></a><span id="l5.22"> static const double C_6 = -691.0 / 360360.0;</span>
<a href="#l5.23"></a><span id="l5.23"> static const double C_7 = 1.0 / 156.0;</span>
<a href="#l5.24"></a><span id="l5.24"> static const double C_8 = -3617.0 / 122400.0;</span>
<a href="#l5.25"></a><span id="l5.25"> static const double C_9 = 43867.0 / 244188.0;</span>
<a href="#l5.26"></a><span id="l5.26"> static const double C_10 = -174611.0 / 125400.0;</span>
<a href="#l5.27"></a><span id="l5.27"> static const double C_11 = 77683.0 / 5796.0;</span>
<a href="#l5.28"></a><span id="l5.28"> </span>
<a href="#l5.29"></a><span id="l5.29"> // truncated asymptotic series in 1/z</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-static inline double lngamma_asymp (double z)</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-{</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+static inline double lngamma_asymp(double z) {</span>
<a href="#l5.33"></a><span id="l5.33">   double w, w2, sum;</span>
<a href="#l5.34"></a><span id="l5.34">   w = 1.0 / z;</span>
<a href="#l5.35"></a><span id="l5.35">   w2 = w * w;</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-  sum = w * (w2 * (w2 * (w2 * (w2 * (w2 * (w2 * (w2 * (w2 * (w2</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-        * (C_11 * w2 + C_10) + C_9) + C_8) + C_7) + C_6)</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-        + C_5) + C_4) + C_3) + C_2) + C_1);</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+  sum =</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+      w *</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+      (w2 * (w2 * (w2 * (w2 * (w2 * (w2 * (w2 * (w2 * (w2 * (C_11 * w2 + C_10) +</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+                                                       C_9) +</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+                                                 C_8) +</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+                                           C_7) +</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+                                     C_6) +</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+                               C_5) +</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+                         C_4) +</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+                   C_3) +</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+             C_2) +</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+       C_1);</span>
<a href="#l5.51"></a><span id="l5.51"> </span>
<a href="#l5.52"></a><span id="l5.52">   return sum;</span>
<a href="#l5.53"></a><span id="l5.53"> }</span>
<a href="#l5.54"></a><span id="l5.54"> </span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-struct fact_table_s</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-{</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+struct fact_table_s {</span>
<a href="#l5.58"></a><span id="l5.58">   double fact;</span>
<a href="#l5.59"></a><span id="l5.59">   double lnfact;</span>
<a href="#l5.60"></a><span id="l5.60"> };</span>
<a href="#l5.61"></a><span id="l5.61"> </span>
<a href="#l5.62"></a><span id="l5.62"> // for speed and accuracy</span>
<a href="#l5.63"></a><span id="l5.63"> static const struct fact_table_s FactTable[] = {</span>
<a href="#l5.64"></a><span id="l5.64">     {1.000000000000000, 0.0000000000000000000000e+00},</span>
<a href="#l5.65"></a><span id="l5.65">     {1.000000000000000, 0.0000000000000000000000e+00},</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineat">@@ -106,154 +113,127 @@ static const struct fact_table_s FactTab</span>
<a href="#l5.67"></a><span id="l5.67">     {3628800.000000000, 1.5104412573075515295248e+01},</span>
<a href="#l5.68"></a><span id="l5.68">     {39916800.00000000, 1.7502307845873885839769e+01},</span>
<a href="#l5.69"></a><span id="l5.69">     {479001600.0000000, 1.9987214495661886149228e+01},</span>
<a href="#l5.70"></a><span id="l5.70">     {6227020800.000000, 2.2552163853123422886104e+01},</span>
<a href="#l5.71"></a><span id="l5.71">     {87178291200.00000, 2.5191221182738681499610e+01},</span>
<a href="#l5.72"></a><span id="l5.72">     {1307674368000.000, 2.7899271383840891566988e+01},</span>
<a href="#l5.73"></a><span id="l5.73">     {20922789888000.00, 3.0671860106080672803835e+01},</span>
<a href="#l5.74"></a><span id="l5.74">     {355687428096000.0, 3.3505073450136888885825e+01},</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineminus">-    {6402373705728000., 3.6395445208033053576674e+01}</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineminus">-};</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineminus">-#define FactTableLength (int)(sizeof(FactTable)/sizeof(FactTable[0]))</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+    {6402373705728000., 3.6395445208033053576674e+01}};</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+#define FactTableLength (int)(sizeof(FactTable) / sizeof(FactTable[0]))</span>
<a href="#l5.80"></a><span id="l5.80"> </span>
<a href="#l5.81"></a><span id="l5.81"> // for speed</span>
<a href="#l5.82"></a><span id="l5.82"> static const double ln_2pi_2 = 0.918938533204672741803;  // log(2*PI)/2</span>
<a href="#l5.83"></a><span id="l5.83"> </span>
<a href="#l5.84"></a><span id="l5.84"> /* A simple lgamma function, not very robust.</span>
<a href="#l5.85"></a><span id="l5.85"> </span>
<a href="#l5.86"></a><span id="l5.86">    Valid for z_in &gt; 0 ONLY.</span>
<a href="#l5.87"></a><span id="l5.87"> </span>
<a href="#l5.88"></a><span id="l5.88">    For z_in &gt; 8 precision is quite good, relative errors &lt; 1e-14 and</span>
<a href="#l5.89"></a><span id="l5.89">    usually better. For z_in &lt; 8 relative errors increase but are usually</span>
<a href="#l5.90"></a><span id="l5.90">    &lt; 1e-10. In two small regions, 1 +/- .001 and 2 +/- .001 errors</span>
<a href="#l5.91"></a><span id="l5.91">    increase quickly.</span>
<a href="#l5.92"></a><span id="l5.92"> */</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineminus">-static double nsLnGamma (double z_in, int *gsign)</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineminus">-{</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+static double nsLnGamma(double z_in, int *gsign) {</span>
<a href="#l5.96"></a><span id="l5.96">   double scale, z, sum, result;</span>
<a href="#l5.97"></a><span id="l5.97">   *gsign = 1;</span>
<a href="#l5.98"></a><span id="l5.98"> </span>
<a href="#l5.99"></a><span id="l5.99" class="difflineminus">-  int zi = (int) z_in;</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineminus">-  if (z_in == (double) zi)</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineminus">-  {</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+  int zi = (int)z_in;</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+  if (z_in == (double)zi) {</span>
<a href="#l5.104"></a><span id="l5.104">     if (0 &lt; zi &amp;&amp; zi &lt;= FactTableLength)</span>
<a href="#l5.105"></a><span id="l5.105">       return FactTable[zi - 1].lnfact;  // gamma(z) = (z-1)!</span>
<a href="#l5.106"></a><span id="l5.106">   }</span>
<a href="#l5.107"></a><span id="l5.107"> </span>
<a href="#l5.108"></a><span id="l5.108" class="difflineminus">-  for (scale = 1.0, z = z_in; z &lt; 8.0; ++z)</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineminus">-    scale *= z;</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+  for (scale = 1.0, z = z_in; z &lt; 8.0; ++z) scale *= z;</span>
<a href="#l5.111"></a><span id="l5.111"> </span>
<a href="#l5.112"></a><span id="l5.112" class="difflineminus">-  sum = lngamma_asymp (z);</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineminus">-  result = (z - 0.5) * log (z) - z + ln_2pi_2 - log (scale);</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+  sum = lngamma_asymp(z);</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+  result = (z - 0.5) * log(z) - z + ln_2pi_2 - log(scale);</span>
<a href="#l5.116"></a><span id="l5.116">   result += sum;</span>
<a href="#l5.117"></a><span id="l5.117">   return result;</span>
<a href="#l5.118"></a><span id="l5.118"> }</span>
<a href="#l5.119"></a><span id="l5.119"> </span>
<a href="#l5.120"></a><span id="l5.120"> // log( e^(-x)*x^a/Gamma(a) )</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineminus">-static inline double lnPQfactor (double a, double x)</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineminus">-{</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+static inline double lnPQfactor(double a, double x) {</span>
<a href="#l5.124"></a><span id="l5.124">   int gsign;  // ignored because a &gt; 0</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineminus">-  return a * log (x) - x - nsLnGamma (a, &amp;gsign);</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+  return a * log(x) - x - nsLnGamma(a, &amp;gsign);</span>
<a href="#l5.127"></a><span id="l5.127"> }</span>
<a href="#l5.128"></a><span id="l5.128"> </span>
<a href="#l5.129"></a><span id="l5.129" class="difflineminus">-static double Pseries (double a, double x, int *error)</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineminus">-{</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineplus">+static double Pseries(double a, double x, int *error) {</span>
<a href="#l5.132"></a><span id="l5.132">   double sum, term;</span>
<a href="#l5.133"></a><span id="l5.133">   const double eps = 2.0 * DBL_EPSILON;</span>
<a href="#l5.134"></a><span id="l5.134">   const int imax = 5000;</span>
<a href="#l5.135"></a><span id="l5.135">   int i;</span>
<a href="#l5.136"></a><span id="l5.136"> </span>
<a href="#l5.137"></a><span id="l5.137">   sum = term = 1.0 / a;</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineminus">-  for (i = 1; i &lt; imax; ++i)</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineminus">-  {</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineplus">+  for (i = 1; i &lt; imax; ++i) {</span>
<a href="#l5.141"></a><span id="l5.141">     term *= x / (a + i);</span>
<a href="#l5.142"></a><span id="l5.142">     sum += term;</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineminus">-    if (fabs (term) &lt; eps * fabs (sum))</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineminus">-      break;</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+    if (fabs(term) &lt; eps * fabs(sum)) break;</span>
<a href="#l5.146"></a><span id="l5.146">   }</span>
<a href="#l5.147"></a><span id="l5.147"> </span>
<a href="#l5.148"></a><span id="l5.148" class="difflineminus">-  if (i &gt;= imax)</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineminus">-    *error = 1;</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineplus">+  if (i &gt;= imax) *error = 1;</span>
<a href="#l5.151"></a><span id="l5.151"> </span>
<a href="#l5.152"></a><span id="l5.152">   return sum;</span>
<a href="#l5.153"></a><span id="l5.153"> }</span>
<a href="#l5.154"></a><span id="l5.154"> </span>
<a href="#l5.155"></a><span id="l5.155" class="difflineminus">-static double Qcontfrac (double a, double x, int *error)</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineminus">-{</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineplus">+static double Qcontfrac(double a, double x, int *error) {</span>
<a href="#l5.158"></a><span id="l5.158">   double result, D, C, e, f, term;</span>
<a href="#l5.159"></a><span id="l5.159">   const double eps = 2.0 * DBL_EPSILON;</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineminus">-  const double small =</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineminus">-  DBL_EPSILON * DBL_EPSILON * DBL_EPSILON * DBL_EPSILON;</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineplus">+  const double small = DBL_EPSILON * DBL_EPSILON * DBL_EPSILON * DBL_EPSILON;</span>
<a href="#l5.163"></a><span id="l5.163">   const int imax = 5000;</span>
<a href="#l5.164"></a><span id="l5.164">   int i;</span>
<a href="#l5.165"></a><span id="l5.165"> </span>
<a href="#l5.166"></a><span id="l5.166">   // modified Lentz method</span>
<a href="#l5.167"></a><span id="l5.167">   f = x - a + 1.0;</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineminus">-  if (fabs (f) &lt; small)</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineminus">-    f = small;</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineplus">+  if (fabs(f) &lt; small) f = small;</span>
<a href="#l5.171"></a><span id="l5.171">   C = f + 1.0 / small;</span>
<a href="#l5.172"></a><span id="l5.172">   D = 1.0 / f;</span>
<a href="#l5.173"></a><span id="l5.173">   result = D;</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineminus">-  for (i = 1; i &lt; imax; ++i)</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineminus">-  {</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineplus">+  for (i = 1; i &lt; imax; ++i) {</span>
<a href="#l5.177"></a><span id="l5.177">     e = i * (a - i);</span>
<a href="#l5.178"></a><span id="l5.178">     f += 2.0;</span>
<a href="#l5.179"></a><span id="l5.179">     D = f + e * D;</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineminus">-    if (fabs (D) &lt; small)</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineminus">-      D = small;</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineplus">+    if (fabs(D) &lt; small) D = small;</span>
<a href="#l5.183"></a><span id="l5.183">     D = 1.0 / D;</span>
<a href="#l5.184"></a><span id="l5.184">     C = f + e / C;</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineminus">-    if (fabs (C) &lt; small)</span>
<a href="#l5.186"></a><span id="l5.186" class="difflineminus">-      C = small;</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineplus">+    if (fabs(C) &lt; small) C = small;</span>
<a href="#l5.188"></a><span id="l5.188">     term = C * D;</span>
<a href="#l5.189"></a><span id="l5.189">     result *= term;</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineminus">-    if (fabs (term - 1.0) &lt; eps)</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineminus">-      break;</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineplus">+    if (fabs(term - 1.0) &lt; eps) break;</span>
<a href="#l5.193"></a><span id="l5.193">   }</span>
<a href="#l5.194"></a><span id="l5.194"> </span>
<a href="#l5.195"></a><span id="l5.195" class="difflineminus">-  if (i &gt;= imax)</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineminus">-    *error = 1;</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineplus">+  if (i &gt;= imax) *error = 1;</span>
<a href="#l5.198"></a><span id="l5.198">   return result;</span>
<a href="#l5.199"></a><span id="l5.199"> }</span>
<a href="#l5.200"></a><span id="l5.200"> </span>
<a href="#l5.201"></a><span id="l5.201" class="difflineminus">-static double nsIncompleteGammaP (double a, double x, int *error)</span>
<a href="#l5.202"></a><span id="l5.202" class="difflineminus">-{</span>
<a href="#l5.203"></a><span id="l5.203" class="difflineplus">+static double nsIncompleteGammaP(double a, double x, int *error) {</span>
<a href="#l5.204"></a><span id="l5.204">   double result, dom, ldom;</span>
<a href="#l5.205"></a><span id="l5.205">   //  domain errors. the return values are meaningless but have</span>
<a href="#l5.206"></a><span id="l5.206">   //  to return something.</span>
<a href="#l5.207"></a><span id="l5.207">   *error = -1;</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineminus">-  if (a &lt;= 0.0)</span>
<a href="#l5.209"></a><span id="l5.209" class="difflineminus">-    return 1.0;</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineminus">-  if (x &lt; 0.0)</span>
<a href="#l5.211"></a><span id="l5.211" class="difflineminus">-    return 0.0;</span>
<a href="#l5.212"></a><span id="l5.212" class="difflineplus">+  if (a &lt;= 0.0) return 1.0;</span>
<a href="#l5.213"></a><span id="l5.213" class="difflineplus">+  if (x &lt; 0.0) return 0.0;</span>
<a href="#l5.214"></a><span id="l5.214">   *error = 0;</span>
<a href="#l5.215"></a><span id="l5.215" class="difflineminus">-  if (x == 0.0)</span>
<a href="#l5.216"></a><span id="l5.216" class="difflineminus">-    return 0.0;</span>
<a href="#l5.217"></a><span id="l5.217" class="difflineplus">+  if (x == 0.0) return 0.0;</span>
<a href="#l5.218"></a><span id="l5.218"> </span>
<a href="#l5.219"></a><span id="l5.219" class="difflineminus">-  ldom = lnPQfactor (a, x);</span>
<a href="#l5.220"></a><span id="l5.220" class="difflineminus">-  dom = exp (ldom);</span>
<a href="#l5.221"></a><span id="l5.221" class="difflineplus">+  ldom = lnPQfactor(a, x);</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineplus">+  dom = exp(ldom);</span>
<a href="#l5.223"></a><span id="l5.223">   // might need to adjust the crossover point</span>
<a href="#l5.224"></a><span id="l5.224" class="difflineminus">-  if (a &lt;= 0.5)</span>
<a href="#l5.225"></a><span id="l5.225" class="difflineminus">-  {</span>
<a href="#l5.226"></a><span id="l5.226" class="difflineplus">+  if (a &lt;= 0.5) {</span>
<a href="#l5.227"></a><span id="l5.227">     if (x &lt; a + 1.0)</span>
<a href="#l5.228"></a><span id="l5.228" class="difflineminus">-      result = dom * Pseries (a, x, error);</span>
<a href="#l5.229"></a><span id="l5.229" class="difflineplus">+      result = dom * Pseries(a, x, error);</span>
<a href="#l5.230"></a><span id="l5.230">     else</span>
<a href="#l5.231"></a><span id="l5.231" class="difflineminus">-      result = 1.0 - dom * Qcontfrac (a, x, error);</span>
<a href="#l5.232"></a><span id="l5.232" class="difflineminus">-  }</span>
<a href="#l5.233"></a><span id="l5.233" class="difflineminus">-  else</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineminus">-  {</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineplus">+      result = 1.0 - dom * Qcontfrac(a, x, error);</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineplus">+  } else {</span>
<a href="#l5.237"></a><span id="l5.237">     if (x &lt; a)</span>
<a href="#l5.238"></a><span id="l5.238" class="difflineminus">-      result = dom * Pseries (a, x, error);</span>
<a href="#l5.239"></a><span id="l5.239" class="difflineplus">+      result = dom * Pseries(a, x, error);</span>
<a href="#l5.240"></a><span id="l5.240">     else</span>
<a href="#l5.241"></a><span id="l5.241" class="difflineminus">-      result = 1.0 - dom * Qcontfrac (a, x, error);</span>
<a href="#l5.242"></a><span id="l5.242" class="difflineplus">+      result = 1.0 - dom * Qcontfrac(a, x, error);</span>
<a href="#l5.243"></a><span id="l5.243">   }</span>
<a href="#l5.244"></a><span id="l5.244"> </span>
<a href="#l5.245"></a><span id="l5.245">   // not clear if this can ever happen</span>
<a href="#l5.246"></a><span id="l5.246" class="difflineminus">-  if (result &gt; 1.0)</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineminus">-    result = 1.0;</span>
<a href="#l5.248"></a><span id="l5.248" class="difflineminus">-  if (result &lt; 0.0)</span>
<a href="#l5.249"></a><span id="l5.249" class="difflineminus">-    result = 0.0;</span>
<a href="#l5.250"></a><span id="l5.250" class="difflineplus">+  if (result &gt; 1.0) result = 1.0;</span>
<a href="#l5.251"></a><span id="l5.251" class="difflineplus">+  if (result &lt; 0.0) result = 0.0;</span>
<a href="#l5.252"></a><span id="l5.252">   return result;</span>
<a href="#l5.253"></a><span id="l5.253"> }</span>
<a href="#l5.254"></a><span id="l5.254"> </span>
<a href="#l5.255"></a><span id="l5.255"> #endif</span>
<a href="#l5.256"></a><span id="l5.256" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/extensions/fts3/src/Normalize.c</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/extensions/fts3/src/Normalize.c</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1,1929 +1,2694 @@</span>
<a href="#l6.4"></a><span id="l6.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l6.5"></a><span id="l6.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.6"></a><span id="l6.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.7"></a><span id="l6.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9"> /* THIS FILE IS GENERATED BY generate_table.py.  DON'T EDIT THIS */</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11"> static const unsigned short gNormalizeTable0040[] = {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-	/* U+0040 */</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-	0x0040, 0x0061, 0x0062, 0x0063, 0x0064, 0x0065, 0x0066, 0x0067, </span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-	0x0068, 0x0069, 0x006a, 0x006b, 0x006c, 0x006d, 0x006e, 0x006f, </span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-	0x0070, 0x0071, 0x0072, 0x0073, 0x0074, 0x0075, 0x0076, 0x0077, </span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-	0x0078, 0x0079, 0x007a, 0x005b, 0x005c, 0x005d, 0x005e, 0x005f, </span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-	0x0060, 0x0061, 0x0062, 0x0063, 0x0064, 0x0065, 0x0066, 0x0067, </span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-	0x0068, 0x0069, 0x006a, 0x006b, 0x006c, 0x006d, 0x006e, 0x006f, </span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-	0x0070, 0x0071, 0x0072, 0x0073, 0x0074, 0x0075, 0x0076, 0x0077, </span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-	0x0078, 0x0079, 0x007a, 0x007b, 0x007c, 0x007d, 0x007e, 0x007f, </span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-	};</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+    /* U+0040 */</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+    0x0040, 0x0061, 0x0062, 0x0063, 0x0064, 0x0065, 0x0066, 0x0067,</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+    0x0068, 0x0069, 0x006a, 0x006b, 0x006c, 0x006d, 0x006e, 0x006f,</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+    0x0070, 0x0071, 0x0072, 0x0073, 0x0074, 0x0075, 0x0076, 0x0077,</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+    0x0078, 0x0079, 0x007a, 0x005b, 0x005c, 0x005d, 0x005e, 0x005f,</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+    0x0060, 0x0061, 0x0062, 0x0063, 0x0064, 0x0065, 0x0066, 0x0067,</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+    0x0068, 0x0069, 0x006a, 0x006b, 0x006c, 0x006d, 0x006e, 0x006f,</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+    0x0070, 0x0071, 0x0072, 0x0073, 0x0074, 0x0075, 0x0076, 0x0077,</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+    0x0078, 0x0079, 0x007a, 0x007b, 0x007c, 0x007d, 0x007e, 0x007f,</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+};</span>
<a href="#l6.32"></a><span id="l6.32"> </span>
<a href="#l6.33"></a><span id="l6.33"> static const unsigned short gNormalizeTable0080[] = {</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-	/* U+0080 */</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-	0x0080, 0x0081, 0x0082, 0x0083, 0x0084, 0x0085, 0x0086, 0x0087, </span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-	0x0088, 0x0089, 0x008a, 0x008b, 0x008c, 0x008d, 0x008e, 0x008f, </span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">-	0x0090, 0x0091, 0x0092, 0x0093, 0x0094, 0x0095, 0x0096, 0x0097, </span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-	0x0098, 0x0099, 0x009a, 0x009b, 0x009c, 0x009d, 0x009e, 0x009f, </span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">-	0x0020, 0x00a1, 0x00a2, 0x00a3, 0x00a4, 0x00a5, 0x00a6, 0x00a7, </span>
<a href="#l6.40"></a><span id="l6.40" class="difflineminus">-	0x0020, 0x00a9, 0x0061, 0x00ab, 0x00ac, 0x0020, 0x00ae, 0x0020, </span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">-	0x00b0, 0x00b1, 0x0032, 0x0033, 0x0020, 0x03bc, 0x00b6, 0x00b7, </span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-	0x0020, 0x0031, 0x006f, 0x00bb, 0x0031, 0x0031, 0x0033, 0x00bf, </span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-	};</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+    /* U+0080 */</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+    0x0080, 0x0081, 0x0082, 0x0083, 0x0084, 0x0085, 0x0086, 0x0087,</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+    0x0088, 0x0089, 0x008a, 0x008b, 0x008c, 0x008d, 0x008e, 0x008f,</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+    0x0090, 0x0091, 0x0092, 0x0093, 0x0094, 0x0095, 0x0096, 0x0097,</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+    0x0098, 0x0099, 0x009a, 0x009b, 0x009c, 0x009d, 0x009e, 0x009f,</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+    0x0020, 0x00a1, 0x00a2, 0x00a3, 0x00a4, 0x00a5, 0x00a6, 0x00a7,</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+    0x0020, 0x00a9, 0x0061, 0x00ab, 0x00ac, 0x0020, 0x00ae, 0x0020,</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+    0x00b0, 0x00b1, 0x0032, 0x0033, 0x0020, 0x03bc, 0x00b6, 0x00b7,</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+    0x0020, 0x0031, 0x006f, 0x00bb, 0x0031, 0x0031, 0x0033, 0x00bf,</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+};</span>
<a href="#l6.54"></a><span id="l6.54"> </span>
<a href="#l6.55"></a><span id="l6.55"> static const unsigned short gNormalizeTable00c0[] = {</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-	/* U+00c0 */</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-	0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x00e6, 0x0063, </span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-	0x0065, 0x0065, 0x0065, 0x0065, 0x0069, 0x0069, 0x0069, 0x0069, </span>
<a href="#l6.59"></a><span id="l6.59" class="difflineminus">-	0x00f0, 0x006e, 0x006f, 0x006f, 0x006f, 0x006f, 0x006f, 0x00d7, </span>
<a href="#l6.60"></a><span id="l6.60" class="difflineminus">-	0x00f8, 0x0075, 0x0075, 0x0075, 0x0075, 0x0079, 0x00fe, 0x0073, </span>
<a href="#l6.61"></a><span id="l6.61" class="difflineminus">-	0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x00e6, 0x0063, </span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-	0x0065, 0x0065, 0x0065, 0x0065, 0x0069, 0x0069, 0x0069, 0x0069, </span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-	0x00f0, 0x006e, 0x006f, 0x006f, 0x006f, 0x006f, 0x006f, 0x00f7, </span>
<a href="#l6.64"></a><span id="l6.64" class="difflineminus">-	0x00f8, 0x0075, 0x0075, 0x0075, 0x0075, 0x0079, 0x00fe, 0x0079, </span>
<a href="#l6.65"></a><span id="l6.65" class="difflineminus">-	};</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+    /* U+00c0 */</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+    0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x00e6, 0x0063,</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+    0x0065, 0x0065, 0x0065, 0x0065, 0x0069, 0x0069, 0x0069, 0x0069,</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+    0x00f0, 0x006e, 0x006f, 0x006f, 0x006f, 0x006f, 0x006f, 0x00d7,</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+    0x00f8, 0x0075, 0x0075, 0x0075, 0x0075, 0x0079, 0x00fe, 0x0073,</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+    0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x00e6, 0x0063,</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+    0x0065, 0x0065, 0x0065, 0x0065, 0x0069, 0x0069, 0x0069, 0x0069,</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+    0x00f0, 0x006e, 0x006f, 0x006f, 0x006f, 0x006f, 0x006f, 0x00f7,</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+    0x00f8, 0x0075, 0x0075, 0x0075, 0x0075, 0x0079, 0x00fe, 0x0079,</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+};</span>
<a href="#l6.76"></a><span id="l6.76"> </span>
<a href="#l6.77"></a><span id="l6.77"> static const unsigned short gNormalizeTable0100[] = {</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineminus">-	/* U+0100 */</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineminus">-	0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x0063, 0x0063, </span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">-	0x0063, 0x0063, 0x0063, 0x0063, 0x0063, 0x0063, 0x0064, 0x0064, </span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-	0x0111, 0x0111, 0x0065, 0x0065, 0x0065, 0x0065, 0x0065, 0x0065, </span>
<a href="#l6.82"></a><span id="l6.82" class="difflineminus">-	0x0065, 0x0065, 0x0065, 0x0065, 0x0067, 0x0067, 0x0067, 0x0067, </span>
<a href="#l6.83"></a><span id="l6.83" class="difflineminus">-	0x0067, 0x0067, 0x0067, 0x0067, 0x0068, 0x0068, 0x0127, 0x0127, </span>
<a href="#l6.84"></a><span id="l6.84" class="difflineminus">-	0x0069, 0x0069, 0x0069, 0x0069, 0x0069, 0x0069, 0x0069, 0x0069, </span>
<a href="#l6.85"></a><span id="l6.85" class="difflineminus">-	0x0069, 0x0131, 0x0069, 0x0069, 0x006a, 0x006a, 0x006b, 0x006b, </span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-	0x0138, 0x006c, 0x006c, 0x006c, 0x006c, 0x006c, 0x006c, 0x006c, </span>
<a href="#l6.87"></a><span id="l6.87" class="difflineminus">-	};</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineplus">+    /* U+0100 */</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineplus">+    0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x0063, 0x0063,</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineplus">+    0x0063, 0x0063, 0x0063, 0x0063, 0x0063, 0x0063, 0x0064, 0x0064,</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineplus">+    0x0111, 0x0111, 0x0065, 0x0065, 0x0065, 0x0065, 0x0065, 0x0065,</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+    0x0065, 0x0065, 0x0065, 0x0065, 0x0067, 0x0067, 0x0067, 0x0067,</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineplus">+    0x0067, 0x0067, 0x0067, 0x0067, 0x0068, 0x0068, 0x0127, 0x0127,</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+    0x0069, 0x0069, 0x0069, 0x0069, 0x0069, 0x0069, 0x0069, 0x0069,</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+    0x0069, 0x0131, 0x0069, 0x0069, 0x006a, 0x006a, 0x006b, 0x006b,</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+    0x0138, 0x006c, 0x006c, 0x006c, 0x006c, 0x006c, 0x006c, 0x006c,</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+};</span>
<a href="#l6.98"></a><span id="l6.98"> </span>
<a href="#l6.99"></a><span id="l6.99"> static const unsigned short gNormalizeTable0140[] = {</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineminus">-	/* U+0140 */</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineminus">-	0x006c, 0x0142, 0x0142, 0x006e, 0x006e, 0x006e, 0x006e, 0x006e, </span>
<a href="#l6.102"></a><span id="l6.102" class="difflineminus">-	0x006e, 0x02bc, 0x014b, 0x014b, 0x006f, 0x006f, 0x006f, 0x006f, </span>
<a href="#l6.103"></a><span id="l6.103" class="difflineminus">-	0x006f, 0x006f, 0x0153, 0x0153, 0x0072, 0x0072, 0x0072, 0x0072, </span>
<a href="#l6.104"></a><span id="l6.104" class="difflineminus">-	0x0072, 0x0072, 0x0073, 0x0073, 0x0073, 0x0073, 0x0073, 0x0073, </span>
<a href="#l6.105"></a><span id="l6.105" class="difflineminus">-	0x0073, 0x0073, 0x0074, 0x0074, 0x0074, 0x0074, 0x0167, 0x0167, </span>
<a href="#l6.106"></a><span id="l6.106" class="difflineminus">-	0x0075, 0x0075, 0x0075, 0x0075, 0x0075, 0x0075, 0x0075, 0x0075, </span>
<a href="#l6.107"></a><span id="l6.107" class="difflineminus">-	0x0075, 0x0075, 0x0075, 0x0075, 0x0077, 0x0077, 0x0079, 0x0079, </span>
<a href="#l6.108"></a><span id="l6.108" class="difflineminus">-	0x0079, 0x007a, 0x007a, 0x007a, 0x007a, 0x007a, 0x007a, 0x0073, </span>
<a href="#l6.109"></a><span id="l6.109" class="difflineminus">-	};</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineplus">+    /* U+0140 */</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+    0x006c, 0x0142, 0x0142, 0x006e, 0x006e, 0x006e, 0x006e, 0x006e,</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+    0x006e, 0x02bc, 0x014b, 0x014b, 0x006f, 0x006f, 0x006f, 0x006f,</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+    0x006f, 0x006f, 0x0153, 0x0153, 0x0072, 0x0072, 0x0072, 0x0072,</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineplus">+    0x0072, 0x0072, 0x0073, 0x0073, 0x0073, 0x0073, 0x0073, 0x0073,</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineplus">+    0x0073, 0x0073, 0x0074, 0x0074, 0x0074, 0x0074, 0x0167, 0x0167,</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineplus">+    0x0075, 0x0075, 0x0075, 0x0075, 0x0075, 0x0075, 0x0075, 0x0075,</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineplus">+    0x0075, 0x0075, 0x0075, 0x0075, 0x0077, 0x0077, 0x0079, 0x0079,</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineplus">+    0x0079, 0x007a, 0x007a, 0x007a, 0x007a, 0x007a, 0x007a, 0x0073,</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineplus">+};</span>
<a href="#l6.120"></a><span id="l6.120"> </span>
<a href="#l6.121"></a><span id="l6.121"> static const unsigned short gNormalizeTable0180[] = {</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineminus">-	/* U+0180 */</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineminus">-	0x0180, 0x0253, 0x0183, 0x0183, 0x0185, 0x0185, 0x0254, 0x0188, </span>
<a href="#l6.124"></a><span id="l6.124" class="difflineminus">-	0x0188, 0x0256, 0x0257, 0x018c, 0x018c, 0x018d, 0x01dd, 0x0259, </span>
<a href="#l6.125"></a><span id="l6.125" class="difflineminus">-	0x025b, 0x0192, 0x0192, 0x0260, 0x0263, 0x0195, 0x0269, 0x0268, </span>
<a href="#l6.126"></a><span id="l6.126" class="difflineminus">-	0x0199, 0x0199, 0x019a, 0x019b, 0x026f, 0x0272, 0x019e, 0x0275, </span>
<a href="#l6.127"></a><span id="l6.127" class="difflineminus">-	0x006f, 0x006f, 0x01a3, 0x01a3, 0x01a5, 0x01a5, 0x0280, 0x01a8, </span>
<a href="#l6.128"></a><span id="l6.128" class="difflineminus">-	0x01a8, 0x0283, 0x01aa, 0x01ab, 0x01ad, 0x01ad, 0x0288, 0x0075, </span>
<a href="#l6.129"></a><span id="l6.129" class="difflineminus">-	0x0075, 0x028a, 0x028b, 0x01b4, 0x01b4, 0x01b6, 0x01b6, 0x0292, </span>
<a href="#l6.130"></a><span id="l6.130" class="difflineminus">-	0x01b9, 0x01b9, 0x01ba, 0x01bb, 0x01bd, 0x01bd, 0x01be, 0x01bf, </span>
<a href="#l6.131"></a><span id="l6.131" class="difflineminus">-	};</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineplus">+    /* U+0180 */</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineplus">+    0x0180, 0x0253, 0x0183, 0x0183, 0x0185, 0x0185, 0x0254, 0x0188,</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineplus">+    0x0188, 0x0256, 0x0257, 0x018c, 0x018c, 0x018d, 0x01dd, 0x0259,</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineplus">+    0x025b, 0x0192, 0x0192, 0x0260, 0x0263, 0x0195, 0x0269, 0x0268,</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineplus">+    0x0199, 0x0199, 0x019a, 0x019b, 0x026f, 0x0272, 0x019e, 0x0275,</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineplus">+    0x006f, 0x006f, 0x01a3, 0x01a3, 0x01a5, 0x01a5, 0x0280, 0x01a8,</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineplus">+    0x01a8, 0x0283, 0x01aa, 0x01ab, 0x01ad, 0x01ad, 0x0288, 0x0075,</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineplus">+    0x0075, 0x028a, 0x028b, 0x01b4, 0x01b4, 0x01b6, 0x01b6, 0x0292,</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineplus">+    0x01b9, 0x01b9, 0x01ba, 0x01bb, 0x01bd, 0x01bd, 0x01be, 0x01bf,</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineplus">+};</span>
<a href="#l6.142"></a><span id="l6.142"> </span>
<a href="#l6.143"></a><span id="l6.143"> static const unsigned short gNormalizeTable01c0[] = {</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineminus">-	/* U+01c0 */</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineminus">-	0x01c0, 0x01c1, 0x01c2, 0x01c3, 0x0064, 0x0064, 0x0064, 0x006c, </span>
<a href="#l6.146"></a><span id="l6.146" class="difflineminus">-	0x006c, 0x006c, 0x006e, 0x006e, 0x006e, 0x0061, 0x0061, 0x0069, </span>
<a href="#l6.147"></a><span id="l6.147" class="difflineminus">-	0x0069, 0x006f, 0x006f, 0x0075, 0x0075, 0x0075, 0x0075, 0x0075, </span>
<a href="#l6.148"></a><span id="l6.148" class="difflineminus">-	0x0075, 0x0075, 0x0075, 0x0075, 0x0075, 0x01dd, 0x0061, 0x0061, </span>
<a href="#l6.149"></a><span id="l6.149" class="difflineminus">-	0x0061, 0x0061, 0x00e6, 0x00e6, 0x01e5, 0x01e5, 0x0067, 0x0067, </span>
<a href="#l6.150"></a><span id="l6.150" class="difflineminus">-	0x006b, 0x006b, 0x006f, 0x006f, 0x006f, 0x006f, 0x0292, 0x0292, </span>
<a href="#l6.151"></a><span id="l6.151" class="difflineminus">-	0x006a, 0x0064, 0x0064, 0x0064, 0x0067, 0x0067, 0x0195, 0x01bf, </span>
<a href="#l6.152"></a><span id="l6.152" class="difflineminus">-	0x006e, 0x006e, 0x0061, 0x0061, 0x00e6, 0x00e6, 0x00f8, 0x00f8, </span>
<a href="#l6.153"></a><span id="l6.153" class="difflineminus">-	};</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineplus">+    /* U+01c0 */</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineplus">+    0x01c0, 0x01c1, 0x01c2, 0x01c3, 0x0064, 0x0064, 0x0064, 0x006c,</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineplus">+    0x006c, 0x006c, 0x006e, 0x006e, 0x006e, 0x0061, 0x0061, 0x0069,</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineplus">+    0x0069, 0x006f, 0x006f, 0x0075, 0x0075, 0x0075, 0x0075, 0x0075,</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineplus">+    0x0075, 0x0075, 0x0075, 0x0075, 0x0075, 0x01dd, 0x0061, 0x0061,</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineplus">+    0x0061, 0x0061, 0x00e6, 0x00e6, 0x01e5, 0x01e5, 0x0067, 0x0067,</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineplus">+    0x006b, 0x006b, 0x006f, 0x006f, 0x006f, 0x006f, 0x0292, 0x0292,</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineplus">+    0x006a, 0x0064, 0x0064, 0x0064, 0x0067, 0x0067, 0x0195, 0x01bf,</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineplus">+    0x006e, 0x006e, 0x0061, 0x0061, 0x00e6, 0x00e6, 0x00f8, 0x00f8,</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineplus">+};</span>
<a href="#l6.164"></a><span id="l6.164"> </span>
<a href="#l6.165"></a><span id="l6.165"> static const unsigned short gNormalizeTable0200[] = {</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineminus">-	/* U+0200 */</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineminus">-	0x0061, 0x0061, 0x0061, 0x0061, 0x0065, 0x0065, 0x0065, 0x0065, </span>
<a href="#l6.168"></a><span id="l6.168" class="difflineminus">-	0x0069, 0x0069, 0x0069, 0x0069, 0x006f, 0x006f, 0x006f, 0x006f, </span>
<a href="#l6.169"></a><span id="l6.169" class="difflineminus">-	0x0072, 0x0072, 0x0072, 0x0072, 0x0075, 0x0075, 0x0075, 0x0075, </span>
<a href="#l6.170"></a><span id="l6.170" class="difflineminus">-	0x0073, 0x0073, 0x0074, 0x0074, 0x021d, 0x021d, 0x0068, 0x0068, </span>
<a href="#l6.171"></a><span id="l6.171" class="difflineminus">-	0x019e, 0x0221, 0x0223, 0x0223, 0x0225, 0x0225, 0x0061, 0x0061, </span>
<a href="#l6.172"></a><span id="l6.172" class="difflineminus">-	0x0065, 0x0065, 0x006f, 0x006f, 0x006f, 0x006f, 0x006f, 0x006f, </span>
<a href="#l6.173"></a><span id="l6.173" class="difflineminus">-	0x006f, 0x006f, 0x0079, 0x0079, 0x0234, 0x0235, 0x0236, 0x0237, </span>
<a href="#l6.174"></a><span id="l6.174" class="difflineminus">-	0x0238, 0x0239, 0x2c65, 0x023c, 0x023c, 0x019a, 0x2c66, 0x023f, </span>
<a href="#l6.175"></a><span id="l6.175" class="difflineminus">-	};</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineplus">+    /* U+0200 */</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineplus">+    0x0061, 0x0061, 0x0061, 0x0061, 0x0065, 0x0065, 0x0065, 0x0065,</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineplus">+    0x0069, 0x0069, 0x0069, 0x0069, 0x006f, 0x006f, 0x006f, 0x006f,</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineplus">+    0x0072, 0x0072, 0x0072, 0x0072, 0x0075, 0x0075, 0x0075, 0x0075,</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineplus">+    0x0073, 0x0073, 0x0074, 0x0074, 0x021d, 0x021d, 0x0068, 0x0068,</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineplus">+    0x019e, 0x0221, 0x0223, 0x0223, 0x0225, 0x0225, 0x0061, 0x0061,</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineplus">+    0x0065, 0x0065, 0x006f, 0x006f, 0x006f, 0x006f, 0x006f, 0x006f,</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineplus">+    0x006f, 0x006f, 0x0079, 0x0079, 0x0234, 0x0235, 0x0236, 0x0237,</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineplus">+    0x0238, 0x0239, 0x2c65, 0x023c, 0x023c, 0x019a, 0x2c66, 0x023f,</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineplus">+};</span>
<a href="#l6.186"></a><span id="l6.186"> </span>
<a href="#l6.187"></a><span id="l6.187"> static const unsigned short gNormalizeTable0240[] = {</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineminus">-	/* U+0240 */</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineminus">-	0x0240, 0x0242, 0x0242, 0x0180, 0x0289, 0x028c, 0x0247, 0x0247, </span>
<a href="#l6.190"></a><span id="l6.190" class="difflineminus">-	0x0249, 0x0249, 0x024b, 0x024b, 0x024d, 0x024d, 0x024f, 0x024f, </span>
<a href="#l6.191"></a><span id="l6.191" class="difflineminus">-	0x0250, 0x0251, 0x0252, 0x0253, 0x0254, 0x0255, 0x0256, 0x0257, </span>
<a href="#l6.192"></a><span id="l6.192" class="difflineminus">-	0x0258, 0x0259, 0x025a, 0x025b, 0x025c, 0x025d, 0x025e, 0x025f, </span>
<a href="#l6.193"></a><span id="l6.193" class="difflineminus">-	0x0260, 0x0261, 0x0262, 0x0263, 0x0264, 0x0265, 0x0266, 0x0267, </span>
<a href="#l6.194"></a><span id="l6.194" class="difflineminus">-	0x0268, 0x0269, 0x026a, 0x026b, 0x026c, 0x026d, 0x026e, 0x026f, </span>
<a href="#l6.195"></a><span id="l6.195" class="difflineminus">-	0x0270, 0x0271, 0x0272, 0x0273, 0x0274, 0x0275, 0x0276, 0x0277, </span>
<a href="#l6.196"></a><span id="l6.196" class="difflineminus">-	0x0278, 0x0279, 0x027a, 0x027b, 0x027c, 0x027d, 0x027e, 0x027f, </span>
<a href="#l6.197"></a><span id="l6.197" class="difflineminus">-	};</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineplus">+    /* U+0240 */</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineplus">+    0x0240, 0x0242, 0x0242, 0x0180, 0x0289, 0x028c, 0x0247, 0x0247,</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineplus">+    0x0249, 0x0249, 0x024b, 0x024b, 0x024d, 0x024d, 0x024f, 0x024f,</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineplus">+    0x0250, 0x0251, 0x0252, 0x0253, 0x0254, 0x0255, 0x0256, 0x0257,</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineplus">+    0x0258, 0x0259, 0x025a, 0x025b, 0x025c, 0x025d, 0x025e, 0x025f,</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineplus">+    0x0260, 0x0261, 0x0262, 0x0263, 0x0264, 0x0265, 0x0266, 0x0267,</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineplus">+    0x0268, 0x0269, 0x026a, 0x026b, 0x026c, 0x026d, 0x026e, 0x026f,</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineplus">+    0x0270, 0x0271, 0x0272, 0x0273, 0x0274, 0x0275, 0x0276, 0x0277,</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineplus">+    0x0278, 0x0279, 0x027a, 0x027b, 0x027c, 0x027d, 0x027e, 0x027f,</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineplus">+};</span>
<a href="#l6.208"></a><span id="l6.208"> </span>
<a href="#l6.209"></a><span id="l6.209"> static const unsigned short gNormalizeTable0280[] = {</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineminus">-	/* U+0280 */</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineminus">-	0x0280, 0x0281, 0x0282, 0x0283, 0x0284, 0x0285, 0x0286, 0x0287, </span>
<a href="#l6.212"></a><span id="l6.212" class="difflineminus">-	0x0288, 0x0289, 0x028a, 0x028b, 0x028c, 0x028d, 0x028e, 0x028f, </span>
<a href="#l6.213"></a><span id="l6.213" class="difflineminus">-	0x0290, 0x0291, 0x0292, 0x0293, 0x0294, 0x0295, 0x0296, 0x0297, </span>
<a href="#l6.214"></a><span id="l6.214" class="difflineminus">-	0x0298, 0x0299, 0x029a, 0x029b, 0x029c, 0x029d, 0x029e, 0x029f, </span>
<a href="#l6.215"></a><span id="l6.215" class="difflineminus">-	0x02a0, 0x02a1, 0x02a2, 0x02a3, 0x02a4, 0x02a5, 0x02a6, 0x02a7, </span>
<a href="#l6.216"></a><span id="l6.216" class="difflineminus">-	0x02a8, 0x02a9, 0x02aa, 0x02ab, 0x02ac, 0x02ad, 0x02ae, 0x02af, </span>
<a href="#l6.217"></a><span id="l6.217" class="difflineminus">-	0x0068, 0x0266, 0x006a, 0x0072, 0x0279, 0x027b, 0x0281, 0x0077, </span>
<a href="#l6.218"></a><span id="l6.218" class="difflineminus">-	0x0079, 0x02b9, 0x02ba, 0x02bb, 0x02bc, 0x02bd, 0x02be, 0x02bf, </span>
<a href="#l6.219"></a><span id="l6.219" class="difflineminus">-	};</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineplus">+    /* U+0280 */</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineplus">+    0x0280, 0x0281, 0x0282, 0x0283, 0x0284, 0x0285, 0x0286, 0x0287,</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineplus">+    0x0288, 0x0289, 0x028a, 0x028b, 0x028c, 0x028d, 0x028e, 0x028f,</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineplus">+    0x0290, 0x0291, 0x0292, 0x0293, 0x0294, 0x0295, 0x0296, 0x0297,</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineplus">+    0x0298, 0x0299, 0x029a, 0x029b, 0x029c, 0x029d, 0x029e, 0x029f,</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineplus">+    0x02a0, 0x02a1, 0x02a2, 0x02a3, 0x02a4, 0x02a5, 0x02a6, 0x02a7,</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineplus">+    0x02a8, 0x02a9, 0x02aa, 0x02ab, 0x02ac, 0x02ad, 0x02ae, 0x02af,</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineplus">+    0x0068, 0x0266, 0x006a, 0x0072, 0x0279, 0x027b, 0x0281, 0x0077,</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineplus">+    0x0079, 0x02b9, 0x02ba, 0x02bb, 0x02bc, 0x02bd, 0x02be, 0x02bf,</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineplus">+};</span>
<a href="#l6.230"></a><span id="l6.230"> </span>
<a href="#l6.231"></a><span id="l6.231"> static const unsigned short gNormalizeTable02c0[] = {</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineminus">-	/* U+02c0 */</span>
<a href="#l6.233"></a><span id="l6.233" class="difflineminus">-	0x02c0, 0x02c1, 0x02c2, 0x02c3, 0x02c4, 0x02c5, 0x02c6, 0x02c7, </span>
<a href="#l6.234"></a><span id="l6.234" class="difflineminus">-	0x02c8, 0x02c9, 0x02ca, 0x02cb, 0x02cc, 0x02cd, 0x02ce, 0x02cf, </span>
<a href="#l6.235"></a><span id="l6.235" class="difflineminus">-	0x02d0, 0x02d1, 0x02d2, 0x02d3, 0x02d4, 0x02d5, 0x02d6, 0x02d7, </span>
<a href="#l6.236"></a><span id="l6.236" class="difflineminus">-	0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x02de, 0x02df, </span>
<a href="#l6.237"></a><span id="l6.237" class="difflineminus">-	0x0263, 0x006c, 0x0073, 0x0078, 0x0295, 0x02e5, 0x02e6, 0x02e7, </span>
<a href="#l6.238"></a><span id="l6.238" class="difflineminus">-	0x02e8, 0x02e9, 0x02ea, 0x02eb, 0x02ec, 0x02ed, 0x02ee, 0x02ef, </span>
<a href="#l6.239"></a><span id="l6.239" class="difflineminus">-	0x02f0, 0x02f1, 0x02f2, 0x02f3, 0x02f4, 0x02f5, 0x02f6, 0x02f7, </span>
<a href="#l6.240"></a><span id="l6.240" class="difflineminus">-	0x02f8, 0x02f9, 0x02fa, 0x02fb, 0x02fc, 0x02fd, 0x02fe, 0x02ff, </span>
<a href="#l6.241"></a><span id="l6.241" class="difflineminus">-	};</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineplus">+    /* U+02c0 */</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineplus">+    0x02c0, 0x02c1, 0x02c2, 0x02c3, 0x02c4, 0x02c5, 0x02c6, 0x02c7,</span>
<a href="#l6.244"></a><span id="l6.244" class="difflineplus">+    0x02c8, 0x02c9, 0x02ca, 0x02cb, 0x02cc, 0x02cd, 0x02ce, 0x02cf,</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineplus">+    0x02d0, 0x02d1, 0x02d2, 0x02d3, 0x02d4, 0x02d5, 0x02d6, 0x02d7,</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineplus">+    0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x02de, 0x02df,</span>
<a href="#l6.247"></a><span id="l6.247" class="difflineplus">+    0x0263, 0x006c, 0x0073, 0x0078, 0x0295, 0x02e5, 0x02e6, 0x02e7,</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineplus">+    0x02e8, 0x02e9, 0x02ea, 0x02eb, 0x02ec, 0x02ed, 0x02ee, 0x02ef,</span>
<a href="#l6.249"></a><span id="l6.249" class="difflineplus">+    0x02f0, 0x02f1, 0x02f2, 0x02f3, 0x02f4, 0x02f5, 0x02f6, 0x02f7,</span>
<a href="#l6.250"></a><span id="l6.250" class="difflineplus">+    0x02f8, 0x02f9, 0x02fa, 0x02fb, 0x02fc, 0x02fd, 0x02fe, 0x02ff,</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineplus">+};</span>
<a href="#l6.252"></a><span id="l6.252"> </span>
<a href="#l6.253"></a><span id="l6.253"> static const unsigned short gNormalizeTable0340[] = {</span>
<a href="#l6.254"></a><span id="l6.254" class="difflineminus">-	/* U+0340 */</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineminus">-	0x0300, 0x0301, 0x0342, 0x0313, 0x0308, 0x03b9, 0x0346, 0x0347, </span>
<a href="#l6.256"></a><span id="l6.256" class="difflineminus">-	0x0348, 0x0349, 0x034a, 0x034b, 0x034c, 0x034d, 0x034e, 0x0020, </span>
<a href="#l6.257"></a><span id="l6.257" class="difflineminus">-	0x0350, 0x0351, 0x0352, 0x0353, 0x0354, 0x0355, 0x0356, 0x0357, </span>
<a href="#l6.258"></a><span id="l6.258" class="difflineminus">-	0x0358, 0x0359, 0x035a, 0x035b, 0x035c, 0x035d, 0x035e, 0x035f, </span>
<a href="#l6.259"></a><span id="l6.259" class="difflineminus">-	0x0360, 0x0361, 0x0362, 0x0363, 0x0364, 0x0365, 0x0366, 0x0367, </span>
<a href="#l6.260"></a><span id="l6.260" class="difflineminus">-	0x0368, 0x0369, 0x036a, 0x036b, 0x036c, 0x036d, 0x036e, 0x036f, </span>
<a href="#l6.261"></a><span id="l6.261" class="difflineminus">-	0x0371, 0x0371, 0x0373, 0x0373, 0x02b9, 0x0375, 0x0377, 0x0377, </span>
<a href="#l6.262"></a><span id="l6.262" class="difflineminus">-	0x0378, 0x0379, 0x0020, 0x037b, 0x037c, 0x037d, 0x003b, 0x037f, </span>
<a href="#l6.263"></a><span id="l6.263" class="difflineminus">-	};</span>
<a href="#l6.264"></a><span id="l6.264" class="difflineplus">+    /* U+0340 */</span>
<a href="#l6.265"></a><span id="l6.265" class="difflineplus">+    0x0300, 0x0301, 0x0342, 0x0313, 0x0308, 0x03b9, 0x0346, 0x0347,</span>
<a href="#l6.266"></a><span id="l6.266" class="difflineplus">+    0x0348, 0x0349, 0x034a, 0x034b, 0x034c, 0x034d, 0x034e, 0x0020,</span>
<a href="#l6.267"></a><span id="l6.267" class="difflineplus">+    0x0350, 0x0351, 0x0352, 0x0353, 0x0354, 0x0355, 0x0356, 0x0357,</span>
<a href="#l6.268"></a><span id="l6.268" class="difflineplus">+    0x0358, 0x0359, 0x035a, 0x035b, 0x035c, 0x035d, 0x035e, 0x035f,</span>
<a href="#l6.269"></a><span id="l6.269" class="difflineplus">+    0x0360, 0x0361, 0x0362, 0x0363, 0x0364, 0x0365, 0x0366, 0x0367,</span>
<a href="#l6.270"></a><span id="l6.270" class="difflineplus">+    0x0368, 0x0369, 0x036a, 0x036b, 0x036c, 0x036d, 0x036e, 0x036f,</span>
<a href="#l6.271"></a><span id="l6.271" class="difflineplus">+    0x0371, 0x0371, 0x0373, 0x0373, 0x02b9, 0x0375, 0x0377, 0x0377,</span>
<a href="#l6.272"></a><span id="l6.272" class="difflineplus">+    0x0378, 0x0379, 0x0020, 0x037b, 0x037c, 0x037d, 0x003b, 0x037f,</span>
<a href="#l6.273"></a><span id="l6.273" class="difflineplus">+};</span>
<a href="#l6.274"></a><span id="l6.274"> </span>
<a href="#l6.275"></a><span id="l6.275"> static const unsigned short gNormalizeTable0380[] = {</span>
<a href="#l6.276"></a><span id="l6.276" class="difflineminus">-	/* U+0380 */</span>
<a href="#l6.277"></a><span id="l6.277" class="difflineminus">-	0x0380, 0x0381, 0x0382, 0x0383, 0x0020, 0x0020, 0x03b1, 0x00b7, </span>
<a href="#l6.278"></a><span id="l6.278" class="difflineminus">-	0x03b5, 0x03b7, 0x03b9, 0x038b, 0x03bf, 0x038d, 0x03c5, 0x03c9, </span>
<a href="#l6.279"></a><span id="l6.279" class="difflineminus">-	0x03b9, 0x03b1, 0x03b2, 0x03b3, 0x03b4, 0x03b5, 0x03b6, 0x03b7, </span>
<a href="#l6.280"></a><span id="l6.280" class="difflineminus">-	0x03b8, 0x03b9, 0x03ba, 0x03bb, 0x03bc, 0x03bd, 0x03be, 0x03bf, </span>
<a href="#l6.281"></a><span id="l6.281" class="difflineminus">-	0x03c0, 0x03c1, 0x03a2, 0x03c3, 0x03c4, 0x03c5, 0x03c6, 0x03c7, </span>
<a href="#l6.282"></a><span id="l6.282" class="difflineminus">-	0x03c8, 0x03c9, 0x03b9, 0x03c5, 0x03b1, 0x03b5, 0x03b7, 0x03b9, </span>
<a href="#l6.283"></a><span id="l6.283" class="difflineminus">-	0x03c5, 0x03b1, 0x03b2, 0x03b3, 0x03b4, 0x03b5, 0x03b6, 0x03b7, </span>
<a href="#l6.284"></a><span id="l6.284" class="difflineminus">-	0x03b8, 0x03b9, 0x03ba, 0x03bb, 0x03bc, 0x03bd, 0x03be, 0x03bf, </span>
<a href="#l6.285"></a><span id="l6.285" class="difflineminus">-	};</span>
<a href="#l6.286"></a><span id="l6.286" class="difflineplus">+    /* U+0380 */</span>
<a href="#l6.287"></a><span id="l6.287" class="difflineplus">+    0x0380, 0x0381, 0x0382, 0x0383, 0x0020, 0x0020, 0x03b1, 0x00b7,</span>
<a href="#l6.288"></a><span id="l6.288" class="difflineplus">+    0x03b5, 0x03b7, 0x03b9, 0x038b, 0x03bf, 0x038d, 0x03c5, 0x03c9,</span>
<a href="#l6.289"></a><span id="l6.289" class="difflineplus">+    0x03b9, 0x03b1, 0x03b2, 0x03b3, 0x03b4, 0x03b5, 0x03b6, 0x03b7,</span>
<a href="#l6.290"></a><span id="l6.290" class="difflineplus">+    0x03b8, 0x03b9, 0x03ba, 0x03bb, 0x03bc, 0x03bd, 0x03be, 0x03bf,</span>
<a href="#l6.291"></a><span id="l6.291" class="difflineplus">+    0x03c0, 0x03c1, 0x03a2, 0x03c3, 0x03c4, 0x03c5, 0x03c6, 0x03c7,</span>
<a href="#l6.292"></a><span id="l6.292" class="difflineplus">+    0x03c8, 0x03c9, 0x03b9, 0x03c5, 0x03b1, 0x03b5, 0x03b7, 0x03b9,</span>
<a href="#l6.293"></a><span id="l6.293" class="difflineplus">+    0x03c5, 0x03b1, 0x03b2, 0x03b3, 0x03b4, 0x03b5, 0x03b6, 0x03b7,</span>
<a href="#l6.294"></a><span id="l6.294" class="difflineplus">+    0x03b8, 0x03b9, 0x03ba, 0x03bb, 0x03bc, 0x03bd, 0x03be, 0x03bf,</span>
<a href="#l6.295"></a><span id="l6.295" class="difflineplus">+};</span>
<a href="#l6.296"></a><span id="l6.296"> </span>
<a href="#l6.297"></a><span id="l6.297"> static const unsigned short gNormalizeTable03c0[] = {</span>
<a href="#l6.298"></a><span id="l6.298" class="difflineminus">-	/* U+03c0 */</span>
<a href="#l6.299"></a><span id="l6.299" class="difflineminus">-	0x03c0, 0x03c1, 0x03c3, 0x03c3, 0x03c4, 0x03c5, 0x03c6, 0x03c7, </span>
<a href="#l6.300"></a><span id="l6.300" class="difflineminus">-	0x03c8, 0x03c9, 0x03b9, 0x03c5, 0x03bf, 0x03c5, 0x03c9, 0x03d7, </span>
<a href="#l6.301"></a><span id="l6.301" class="difflineminus">-	0x03b2, 0x03b8, 0x03c5, 0x03c5, 0x03c5, 0x03c6, 0x03c0, 0x03d7, </span>
<a href="#l6.302"></a><span id="l6.302" class="difflineminus">-	0x03d9, 0x03d9, 0x03db, 0x03db, 0x03dd, 0x03dd, 0x03df, 0x03df, </span>
<a href="#l6.303"></a><span id="l6.303" class="difflineminus">-	0x03e1, 0x03e1, 0x03e3, 0x03e3, 0x03e5, 0x03e5, 0x03e7, 0x03e7, </span>
<a href="#l6.304"></a><span id="l6.304" class="difflineminus">-	0x03e9, 0x03e9, 0x03eb, 0x03eb, 0x03ed, 0x03ed, 0x03ef, 0x03ef, </span>
<a href="#l6.305"></a><span id="l6.305" class="difflineminus">-	0x03ba, 0x03c1, 0x03c3, 0x03f3, 0x03b8, 0x03b5, 0x03f6, 0x03f8, </span>
<a href="#l6.306"></a><span id="l6.306" class="difflineminus">-	0x03f8, 0x03c3, 0x03fb, 0x03fb, 0x03fc, 0x037b, 0x037c, 0x037d, </span>
<a href="#l6.307"></a><span id="l6.307" class="difflineminus">-	};</span>
<a href="#l6.308"></a><span id="l6.308" class="difflineplus">+    /* U+03c0 */</span>
<a href="#l6.309"></a><span id="l6.309" class="difflineplus">+    0x03c0, 0x03c1, 0x03c3, 0x03c3, 0x03c4, 0x03c5, 0x03c6, 0x03c7,</span>
<a href="#l6.310"></a><span id="l6.310" class="difflineplus">+    0x03c8, 0x03c9, 0x03b9, 0x03c5, 0x03bf, 0x03c5, 0x03c9, 0x03d7,</span>
<a href="#l6.311"></a><span id="l6.311" class="difflineplus">+    0x03b2, 0x03b8, 0x03c5, 0x03c5, 0x03c5, 0x03c6, 0x03c0, 0x03d7,</span>
<a href="#l6.312"></a><span id="l6.312" class="difflineplus">+    0x03d9, 0x03d9, 0x03db, 0x03db, 0x03dd, 0x03dd, 0x03df, 0x03df,</span>
<a href="#l6.313"></a><span id="l6.313" class="difflineplus">+    0x03e1, 0x03e1, 0x03e3, 0x03e3, 0x03e5, 0x03e5, 0x03e7, 0x03e7,</span>
<a href="#l6.314"></a><span id="l6.314" class="difflineplus">+    0x03e9, 0x03e9, 0x03eb, 0x03eb, 0x03ed, 0x03ed, 0x03ef, 0x03ef,</span>
<a href="#l6.315"></a><span id="l6.315" class="difflineplus">+    0x03ba, 0x03c1, 0x03c3, 0x03f3, 0x03b8, 0x03b5, 0x03f6, 0x03f8,</span>
<a href="#l6.316"></a><span id="l6.316" class="difflineplus">+    0x03f8, 0x03c3, 0x03fb, 0x03fb, 0x03fc, 0x037b, 0x037c, 0x037d,</span>
<a href="#l6.317"></a><span id="l6.317" class="difflineplus">+};</span>
<a href="#l6.318"></a><span id="l6.318"> </span>
<a href="#l6.319"></a><span id="l6.319"> static const unsigned short gNormalizeTable0400[] = {</span>
<a href="#l6.320"></a><span id="l6.320" class="difflineminus">-	/* U+0400 */</span>
<a href="#l6.321"></a><span id="l6.321" class="difflineminus">-	0x0435, 0x0435, 0x0452, 0x0433, 0x0454, 0x0455, 0x0456, 0x0456, </span>
<a href="#l6.322"></a><span id="l6.322" class="difflineminus">-	0x0458, 0x0459, 0x045a, 0x045b, 0x043a, 0x0438, 0x0443, 0x045f, </span>
<a href="#l6.323"></a><span id="l6.323" class="difflineminus">-	0x0430, 0x0431, 0x0432, 0x0433, 0x0434, 0x0435, 0x0436, 0x0437, </span>
<a href="#l6.324"></a><span id="l6.324" class="difflineminus">-	0x0438, 0x0438, 0x043a, 0x043b, 0x043c, 0x043d, 0x043e, 0x043f, </span>
<a href="#l6.325"></a><span id="l6.325" class="difflineminus">-	0x0440, 0x0441, 0x0442, 0x0443, 0x0444, 0x0445, 0x0446, 0x0447, </span>
<a href="#l6.326"></a><span id="l6.326" class="difflineminus">-	0x0448, 0x0449, 0x044a, 0x044b, 0x044c, 0x044d, 0x044e, 0x044f, </span>
<a href="#l6.327"></a><span id="l6.327" class="difflineminus">-	0x0430, 0x0431, 0x0432, 0x0433, 0x0434, 0x0435, 0x0436, 0x0437, </span>
<a href="#l6.328"></a><span id="l6.328" class="difflineminus">-	0x0438, 0x0438, 0x043a, 0x043b, 0x043c, 0x043d, 0x043e, 0x043f, </span>
<a href="#l6.329"></a><span id="l6.329" class="difflineminus">-	};</span>
<a href="#l6.330"></a><span id="l6.330" class="difflineplus">+    /* U+0400 */</span>
<a href="#l6.331"></a><span id="l6.331" class="difflineplus">+    0x0435, 0x0435, 0x0452, 0x0433, 0x0454, 0x0455, 0x0456, 0x0456,</span>
<a href="#l6.332"></a><span id="l6.332" class="difflineplus">+    0x0458, 0x0459, 0x045a, 0x045b, 0x043a, 0x0438, 0x0443, 0x045f,</span>
<a href="#l6.333"></a><span id="l6.333" class="difflineplus">+    0x0430, 0x0431, 0x0432, 0x0433, 0x0434, 0x0435, 0x0436, 0x0437,</span>
<a href="#l6.334"></a><span id="l6.334" class="difflineplus">+    0x0438, 0x0438, 0x043a, 0x043b, 0x043c, 0x043d, 0x043e, 0x043f,</span>
<a href="#l6.335"></a><span id="l6.335" class="difflineplus">+    0x0440, 0x0441, 0x0442, 0x0443, 0x0444, 0x0445, 0x0446, 0x0447,</span>
<a href="#l6.336"></a><span id="l6.336" class="difflineplus">+    0x0448, 0x0449, 0x044a, 0x044b, 0x044c, 0x044d, 0x044e, 0x044f,</span>
<a href="#l6.337"></a><span id="l6.337" class="difflineplus">+    0x0430, 0x0431, 0x0432, 0x0433, 0x0434, 0x0435, 0x0436, 0x0437,</span>
<a href="#l6.338"></a><span id="l6.338" class="difflineplus">+    0x0438, 0x0438, 0x043a, 0x043b, 0x043c, 0x043d, 0x043e, 0x043f,</span>
<a href="#l6.339"></a><span id="l6.339" class="difflineplus">+};</span>
<a href="#l6.340"></a><span id="l6.340"> </span>
<a href="#l6.341"></a><span id="l6.341"> static const unsigned short gNormalizeTable0440[] = {</span>
<a href="#l6.342"></a><span id="l6.342" class="difflineminus">-	/* U+0440 */</span>
<a href="#l6.343"></a><span id="l6.343" class="difflineminus">-	0x0440, 0x0441, 0x0442, 0x0443, 0x0444, 0x0445, 0x0446, 0x0447, </span>
<a href="#l6.344"></a><span id="l6.344" class="difflineminus">-	0x0448, 0x0449, 0x044a, 0x044b, 0x044c, 0x044d, 0x044e, 0x044f, </span>
<a href="#l6.345"></a><span id="l6.345" class="difflineminus">-	0x0435, 0x0435, 0x0452, 0x0433, 0x0454, 0x0455, 0x0456, 0x0456, </span>
<a href="#l6.346"></a><span id="l6.346" class="difflineminus">-	0x0458, 0x0459, 0x045a, 0x045b, 0x043a, 0x0438, 0x0443, 0x045f, </span>
<a href="#l6.347"></a><span id="l6.347" class="difflineminus">-	0x0461, 0x0461, 0x0463, 0x0463, 0x0465, 0x0465, 0x0467, 0x0467, </span>
<a href="#l6.348"></a><span id="l6.348" class="difflineminus">-	0x0469, 0x0469, 0x046b, 0x046b, 0x046d, 0x046d, 0x046f, 0x046f, </span>
<a href="#l6.349"></a><span id="l6.349" class="difflineminus">-	0x0471, 0x0471, 0x0473, 0x0473, 0x0475, 0x0475, 0x0475, 0x0475, </span>
<a href="#l6.350"></a><span id="l6.350" class="difflineminus">-	0x0479, 0x0479, 0x047b, 0x047b, 0x047d, 0x047d, 0x047f, 0x047f, </span>
<a href="#l6.351"></a><span id="l6.351" class="difflineminus">-	};</span>
<a href="#l6.352"></a><span id="l6.352" class="difflineplus">+    /* U+0440 */</span>
<a href="#l6.353"></a><span id="l6.353" class="difflineplus">+    0x0440, 0x0441, 0x0442, 0x0443, 0x0444, 0x0445, 0x0446, 0x0447,</span>
<a href="#l6.354"></a><span id="l6.354" class="difflineplus">+    0x0448, 0x0449, 0x044a, 0x044b, 0x044c, 0x044d, 0x044e, 0x044f,</span>
<a href="#l6.355"></a><span id="l6.355" class="difflineplus">+    0x0435, 0x0435, 0x0452, 0x0433, 0x0454, 0x0455, 0x0456, 0x0456,</span>
<a href="#l6.356"></a><span id="l6.356" class="difflineplus">+    0x0458, 0x0459, 0x045a, 0x045b, 0x043a, 0x0438, 0x0443, 0x045f,</span>
<a href="#l6.357"></a><span id="l6.357" class="difflineplus">+    0x0461, 0x0461, 0x0463, 0x0463, 0x0465, 0x0465, 0x0467, 0x0467,</span>
<a href="#l6.358"></a><span id="l6.358" class="difflineplus">+    0x0469, 0x0469, 0x046b, 0x046b, 0x046d, 0x046d, 0x046f, 0x046f,</span>
<a href="#l6.359"></a><span id="l6.359" class="difflineplus">+    0x0471, 0x0471, 0x0473, 0x0473, 0x0475, 0x0475, 0x0475, 0x0475,</span>
<a href="#l6.360"></a><span id="l6.360" class="difflineplus">+    0x0479, 0x0479, 0x047b, 0x047b, 0x047d, 0x047d, 0x047f, 0x047f,</span>
<a href="#l6.361"></a><span id="l6.361" class="difflineplus">+};</span>
<a href="#l6.362"></a><span id="l6.362"> </span>
<a href="#l6.363"></a><span id="l6.363"> static const unsigned short gNormalizeTable0480[] = {</span>
<a href="#l6.364"></a><span id="l6.364" class="difflineminus">-	/* U+0480 */</span>
<a href="#l6.365"></a><span id="l6.365" class="difflineminus">-	0x0481, 0x0481, 0x0482, 0x0483, 0x0484, 0x0485, 0x0486, 0x0487, </span>
<a href="#l6.366"></a><span id="l6.366" class="difflineminus">-	0x0488, 0x0489, 0x048b, 0x048b, 0x048d, 0x048d, 0x048f, 0x048f, </span>
<a href="#l6.367"></a><span id="l6.367" class="difflineminus">-	0x0491, 0x0491, 0x0493, 0x0493, 0x0495, 0x0495, 0x0497, 0x0497, </span>
<a href="#l6.368"></a><span id="l6.368" class="difflineminus">-	0x0499, 0x0499, 0x049b, 0x049b, 0x049d, 0x049d, 0x049f, 0x049f, </span>
<a href="#l6.369"></a><span id="l6.369" class="difflineminus">-	0x04a1, 0x04a1, 0x04a3, 0x04a3, 0x04a5, 0x04a5, 0x04a7, 0x04a7, </span>
<a href="#l6.370"></a><span id="l6.370" class="difflineminus">-	0x04a9, 0x04a9, 0x04ab, 0x04ab, 0x04ad, 0x04ad, 0x04af, 0x04af, </span>
<a href="#l6.371"></a><span id="l6.371" class="difflineminus">-	0x04b1, 0x04b1, 0x04b3, 0x04b3, 0x04b5, 0x04b5, 0x04b7, 0x04b7, </span>
<a href="#l6.372"></a><span id="l6.372" class="difflineminus">-	0x04b9, 0x04b9, 0x04bb, 0x04bb, 0x04bd, 0x04bd, 0x04bf, 0x04bf, </span>
<a href="#l6.373"></a><span id="l6.373" class="difflineminus">-	};</span>
<a href="#l6.374"></a><span id="l6.374" class="difflineplus">+    /* U+0480 */</span>
<a href="#l6.375"></a><span id="l6.375" class="difflineplus">+    0x0481, 0x0481, 0x0482, 0x0483, 0x0484, 0x0485, 0x0486, 0x0487,</span>
<a href="#l6.376"></a><span id="l6.376" class="difflineplus">+    0x0488, 0x0489, 0x048b, 0x048b, 0x048d, 0x048d, 0x048f, 0x048f,</span>
<a href="#l6.377"></a><span id="l6.377" class="difflineplus">+    0x0491, 0x0491, 0x0493, 0x0493, 0x0495, 0x0495, 0x0497, 0x0497,</span>
<a href="#l6.378"></a><span id="l6.378" class="difflineplus">+    0x0499, 0x0499, 0x049b, 0x049b, 0x049d, 0x049d, 0x049f, 0x049f,</span>
<a href="#l6.379"></a><span id="l6.379" class="difflineplus">+    0x04a1, 0x04a1, 0x04a3, 0x04a3, 0x04a5, 0x04a5, 0x04a7, 0x04a7,</span>
<a href="#l6.380"></a><span id="l6.380" class="difflineplus">+    0x04a9, 0x04a9, 0x04ab, 0x04ab, 0x04ad, 0x04ad, 0x04af, 0x04af,</span>
<a href="#l6.381"></a><span id="l6.381" class="difflineplus">+    0x04b1, 0x04b1, 0x04b3, 0x04b3, 0x04b5, 0x04b5, 0x04b7, 0x04b7,</span>
<a href="#l6.382"></a><span id="l6.382" class="difflineplus">+    0x04b9, 0x04b9, 0x04bb, 0x04bb, 0x04bd, 0x04bd, 0x04bf, 0x04bf,</span>
<a href="#l6.383"></a><span id="l6.383" class="difflineplus">+};</span>
<a href="#l6.384"></a><span id="l6.384"> </span>
<a href="#l6.385"></a><span id="l6.385"> static const unsigned short gNormalizeTable04c0[] = {</span>
<a href="#l6.386"></a><span id="l6.386" class="difflineminus">-	/* U+04c0 */</span>
<a href="#l6.387"></a><span id="l6.387" class="difflineminus">-	0x04cf, 0x0436, 0x0436, 0x04c4, 0x04c4, 0x04c6, 0x04c6, 0x04c8, </span>
<a href="#l6.388"></a><span id="l6.388" class="difflineminus">-	0x04c8, 0x04ca, 0x04ca, 0x04cc, 0x04cc, 0x04ce, 0x04ce, 0x04cf, </span>
<a href="#l6.389"></a><span id="l6.389" class="difflineminus">-	0x0430, 0x0430, 0x0430, 0x0430, 0x04d5, 0x04d5, 0x0435, 0x0435, </span>
<a href="#l6.390"></a><span id="l6.390" class="difflineminus">-	0x04d9, 0x04d9, 0x04d9, 0x04d9, 0x0436, 0x0436, 0x0437, 0x0437, </span>
<a href="#l6.391"></a><span id="l6.391" class="difflineminus">-	0x04e1, 0x04e1, 0x0438, 0x0438, 0x0438, 0x0438, 0x043e, 0x043e, </span>
<a href="#l6.392"></a><span id="l6.392" class="difflineminus">-	0x04e9, 0x04e9, 0x04e9, 0x04e9, 0x044d, 0x044d, 0x0443, 0x0443, </span>
<a href="#l6.393"></a><span id="l6.393" class="difflineminus">-	0x0443, 0x0443, 0x0443, 0x0443, 0x0447, 0x0447, 0x04f7, 0x04f7, </span>
<a href="#l6.394"></a><span id="l6.394" class="difflineminus">-	0x044b, 0x044b, 0x04fb, 0x04fb, 0x04fd, 0x04fd, 0x04ff, 0x04ff, </span>
<a href="#l6.395"></a><span id="l6.395" class="difflineminus">-	};</span>
<a href="#l6.396"></a><span id="l6.396" class="difflineplus">+    /* U+04c0 */</span>
<a href="#l6.397"></a><span id="l6.397" class="difflineplus">+    0x04cf, 0x0436, 0x0436, 0x04c4, 0x04c4, 0x04c6, 0x04c6, 0x04c8,</span>
<a href="#l6.398"></a><span id="l6.398" class="difflineplus">+    0x04c8, 0x04ca, 0x04ca, 0x04cc, 0x04cc, 0x04ce, 0x04ce, 0x04cf,</span>
<a href="#l6.399"></a><span id="l6.399" class="difflineplus">+    0x0430, 0x0430, 0x0430, 0x0430, 0x04d5, 0x04d5, 0x0435, 0x0435,</span>
<a href="#l6.400"></a><span id="l6.400" class="difflineplus">+    0x04d9, 0x04d9, 0x04d9, 0x04d9, 0x0436, 0x0436, 0x0437, 0x0437,</span>
<a href="#l6.401"></a><span id="l6.401" class="difflineplus">+    0x04e1, 0x04e1, 0x0438, 0x0438, 0x0438, 0x0438, 0x043e, 0x043e,</span>
<a href="#l6.402"></a><span id="l6.402" class="difflineplus">+    0x04e9, 0x04e9, 0x04e9, 0x04e9, 0x044d, 0x044d, 0x0443, 0x0443,</span>
<a href="#l6.403"></a><span id="l6.403" class="difflineplus">+    0x0443, 0x0443, 0x0443, 0x0443, 0x0447, 0x0447, 0x04f7, 0x04f7,</span>
<a href="#l6.404"></a><span id="l6.404" class="difflineplus">+    0x044b, 0x044b, 0x04fb, 0x04fb, 0x04fd, 0x04fd, 0x04ff, 0x04ff,</span>
<a href="#l6.405"></a><span id="l6.405" class="difflineplus">+};</span>
<a href="#l6.406"></a><span id="l6.406"> </span>
<a href="#l6.407"></a><span id="l6.407"> static const unsigned short gNormalizeTable0500[] = {</span>
<a href="#l6.408"></a><span id="l6.408" class="difflineminus">-	/* U+0500 */</span>
<a href="#l6.409"></a><span id="l6.409" class="difflineminus">-	0x0501, 0x0501, 0x0503, 0x0503, 0x0505, 0x0505, 0x0507, 0x0507, </span>
<a href="#l6.410"></a><span id="l6.410" class="difflineminus">-	0x0509, 0x0509, 0x050b, 0x050b, 0x050d, 0x050d, 0x050f, 0x050f, </span>
<a href="#l6.411"></a><span id="l6.411" class="difflineminus">-	0x0511, 0x0511, 0x0513, 0x0513, 0x0515, 0x0515, 0x0517, 0x0517, </span>
<a href="#l6.412"></a><span id="l6.412" class="difflineminus">-	0x0519, 0x0519, 0x051b, 0x051b, 0x051d, 0x051d, 0x051f, 0x051f, </span>
<a href="#l6.413"></a><span id="l6.413" class="difflineminus">-	0x0521, 0x0521, 0x0523, 0x0523, 0x0525, 0x0525, 0x0526, 0x0527, </span>
<a href="#l6.414"></a><span id="l6.414" class="difflineminus">-	0x0528, 0x0529, 0x052a, 0x052b, 0x052c, 0x052d, 0x052e, 0x052f, </span>
<a href="#l6.415"></a><span id="l6.415" class="difflineminus">-	0x0530, 0x0561, 0x0562, 0x0563, 0x0564, 0x0565, 0x0566, 0x0567, </span>
<a href="#l6.416"></a><span id="l6.416" class="difflineminus">-	0x0568, 0x0569, 0x056a, 0x056b, 0x056c, 0x056d, 0x056e, 0x056f, </span>
<a href="#l6.417"></a><span id="l6.417" class="difflineminus">-	};</span>
<a href="#l6.418"></a><span id="l6.418" class="difflineplus">+    /* U+0500 */</span>
<a href="#l6.419"></a><span id="l6.419" class="difflineplus">+    0x0501, 0x0501, 0x0503, 0x0503, 0x0505, 0x0505, 0x0507, 0x0507,</span>
<a href="#l6.420"></a><span id="l6.420" class="difflineplus">+    0x0509, 0x0509, 0x050b, 0x050b, 0x050d, 0x050d, 0x050f, 0x050f,</span>
<a href="#l6.421"></a><span id="l6.421" class="difflineplus">+    0x0511, 0x0511, 0x0513, 0x0513, 0x0515, 0x0515, 0x0517, 0x0517,</span>
<a href="#l6.422"></a><span id="l6.422" class="difflineplus">+    0x0519, 0x0519, 0x051b, 0x051b, 0x051d, 0x051d, 0x051f, 0x051f,</span>
<a href="#l6.423"></a><span id="l6.423" class="difflineplus">+    0x0521, 0x0521, 0x0523, 0x0523, 0x0525, 0x0525, 0x0526, 0x0527,</span>
<a href="#l6.424"></a><span id="l6.424" class="difflineplus">+    0x0528, 0x0529, 0x052a, 0x052b, 0x052c, 0x052d, 0x052e, 0x052f,</span>
<a href="#l6.425"></a><span id="l6.425" class="difflineplus">+    0x0530, 0x0561, 0x0562, 0x0563, 0x0564, 0x0565, 0x0566, 0x0567,</span>
<a href="#l6.426"></a><span id="l6.426" class="difflineplus">+    0x0568, 0x0569, 0x056a, 0x056b, 0x056c, 0x056d, 0x056e, 0x056f,</span>
<a href="#l6.427"></a><span id="l6.427" class="difflineplus">+};</span>
<a href="#l6.428"></a><span id="l6.428"> </span>
<a href="#l6.429"></a><span id="l6.429"> static const unsigned short gNormalizeTable0540[] = {</span>
<a href="#l6.430"></a><span id="l6.430" class="difflineminus">-	/* U+0540 */</span>
<a href="#l6.431"></a><span id="l6.431" class="difflineminus">-	0x0570, 0x0571, 0x0572, 0x0573, 0x0574, 0x0575, 0x0576, 0x0577, </span>
<a href="#l6.432"></a><span id="l6.432" class="difflineminus">-	0x0578, 0x0579, 0x057a, 0x057b, 0x057c, 0x057d, 0x057e, 0x057f, </span>
<a href="#l6.433"></a><span id="l6.433" class="difflineminus">-	0x0580, 0x0581, 0x0582, 0x0583, 0x0584, 0x0585, 0x0586, 0x0557, </span>
<a href="#l6.434"></a><span id="l6.434" class="difflineminus">-	0x0558, 0x0559, 0x055a, 0x055b, 0x055c, 0x055d, 0x055e, 0x055f, </span>
<a href="#l6.435"></a><span id="l6.435" class="difflineminus">-	0x0560, 0x0561, 0x0562, 0x0563, 0x0564, 0x0565, 0x0566, 0x0567, </span>
<a href="#l6.436"></a><span id="l6.436" class="difflineminus">-	0x0568, 0x0569, 0x056a, 0x056b, 0x056c, 0x056d, 0x056e, 0x056f, </span>
<a href="#l6.437"></a><span id="l6.437" class="difflineminus">-	0x0570, 0x0571, 0x0572, 0x0573, 0x0574, 0x0575, 0x0576, 0x0577, </span>
<a href="#l6.438"></a><span id="l6.438" class="difflineminus">-	0x0578, 0x0579, 0x057a, 0x057b, 0x057c, 0x057d, 0x057e, 0x057f, </span>
<a href="#l6.439"></a><span id="l6.439" class="difflineminus">-	};</span>
<a href="#l6.440"></a><span id="l6.440" class="difflineplus">+    /* U+0540 */</span>
<a href="#l6.441"></a><span id="l6.441" class="difflineplus">+    0x0570, 0x0571, 0x0572, 0x0573, 0x0574, 0x0575, 0x0576, 0x0577,</span>
<a href="#l6.442"></a><span id="l6.442" class="difflineplus">+    0x0578, 0x0579, 0x057a, 0x057b, 0x057c, 0x057d, 0x057e, 0x057f,</span>
<a href="#l6.443"></a><span id="l6.443" class="difflineplus">+    0x0580, 0x0581, 0x0582, 0x0583, 0x0584, 0x0585, 0x0586, 0x0557,</span>
<a href="#l6.444"></a><span id="l6.444" class="difflineplus">+    0x0558, 0x0559, 0x055a, 0x055b, 0x055c, 0x055d, 0x055e, 0x055f,</span>
<a href="#l6.445"></a><span id="l6.445" class="difflineplus">+    0x0560, 0x0561, 0x0562, 0x0563, 0x0564, 0x0565, 0x0566, 0x0567,</span>
<a href="#l6.446"></a><span id="l6.446" class="difflineplus">+    0x0568, 0x0569, 0x056a, 0x056b, 0x056c, 0x056d, 0x056e, 0x056f,</span>
<a href="#l6.447"></a><span id="l6.447" class="difflineplus">+    0x0570, 0x0571, 0x0572, 0x0573, 0x0574, 0x0575, 0x0576, 0x0577,</span>
<a href="#l6.448"></a><span id="l6.448" class="difflineplus">+    0x0578, 0x0579, 0x057a, 0x057b, 0x057c, 0x057d, 0x057e, 0x057f,</span>
<a href="#l6.449"></a><span id="l6.449" class="difflineplus">+};</span>
<a href="#l6.450"></a><span id="l6.450"> </span>
<a href="#l6.451"></a><span id="l6.451"> static const unsigned short gNormalizeTable0580[] = {</span>
<a href="#l6.452"></a><span id="l6.452" class="difflineminus">-	/* U+0580 */</span>
<a href="#l6.453"></a><span id="l6.453" class="difflineminus">-	0x0580, 0x0581, 0x0582, 0x0583, 0x0584, 0x0585, 0x0586, 0x0565, </span>
<a href="#l6.454"></a><span id="l6.454" class="difflineminus">-	0x0588, 0x0589, 0x058a, 0x058b, 0x058c, 0x058d, 0x058e, 0x058f, </span>
<a href="#l6.455"></a><span id="l6.455" class="difflineminus">-	0x0590, 0x0591, 0x0592, 0x0593, 0x0594, 0x0595, 0x0596, 0x0597, </span>
<a href="#l6.456"></a><span id="l6.456" class="difflineminus">-	0x0598, 0x0599, 0x059a, 0x059b, 0x059c, 0x059d, 0x059e, 0x059f, </span>
<a href="#l6.457"></a><span id="l6.457" class="difflineminus">-	0x05a0, 0x05a1, 0x05a2, 0x05a3, 0x05a4, 0x05a5, 0x05a6, 0x05a7, </span>
<a href="#l6.458"></a><span id="l6.458" class="difflineminus">-	0x05a8, 0x05a9, 0x05aa, 0x05ab, 0x05ac, 0x05ad, 0x05ae, 0x05af, </span>
<a href="#l6.459"></a><span id="l6.459" class="difflineminus">-	0x05b0, 0x05b1, 0x05b2, 0x05b3, 0x05b4, 0x05b5, 0x05b6, 0x05b7, </span>
<a href="#l6.460"></a><span id="l6.460" class="difflineminus">-	0x05b8, 0x05b9, 0x05ba, 0x05bb, 0x05bc, 0x05bd, 0x05be, 0x05bf, </span>
<a href="#l6.461"></a><span id="l6.461" class="difflineminus">-	};</span>
<a href="#l6.462"></a><span id="l6.462" class="difflineplus">+    /* U+0580 */</span>
<a href="#l6.463"></a><span id="l6.463" class="difflineplus">+    0x0580, 0x0581, 0x0582, 0x0583, 0x0584, 0x0585, 0x0586, 0x0565,</span>
<a href="#l6.464"></a><span id="l6.464" class="difflineplus">+    0x0588, 0x0589, 0x058a, 0x058b, 0x058c, 0x058d, 0x058e, 0x058f,</span>
<a href="#l6.465"></a><span id="l6.465" class="difflineplus">+    0x0590, 0x0591, 0x0592, 0x0593, 0x0594, 0x0595, 0x0596, 0x0597,</span>
<a href="#l6.466"></a><span id="l6.466" class="difflineplus">+    0x0598, 0x0599, 0x059a, 0x059b, 0x059c, 0x059d, 0x059e, 0x059f,</span>
<a href="#l6.467"></a><span id="l6.467" class="difflineplus">+    0x05a0, 0x05a1, 0x05a2, 0x05a3, 0x05a4, 0x05a5, 0x05a6, 0x05a7,</span>
<a href="#l6.468"></a><span id="l6.468" class="difflineplus">+    0x05a8, 0x05a9, 0x05aa, 0x05ab, 0x05ac, 0x05ad, 0x05ae, 0x05af,</span>
<a href="#l6.469"></a><span id="l6.469" class="difflineplus">+    0x05b0, 0x05b1, 0x05b2, 0x05b3, 0x05b4, 0x05b5, 0x05b6, 0x05b7,</span>
<a href="#l6.470"></a><span id="l6.470" class="difflineplus">+    0x05b8, 0x05b9, 0x05ba, 0x05bb, 0x05bc, 0x05bd, 0x05be, 0x05bf,</span>
<a href="#l6.471"></a><span id="l6.471" class="difflineplus">+};</span>
<a href="#l6.472"></a><span id="l6.472"> </span>
<a href="#l6.473"></a><span id="l6.473"> static const unsigned short gNormalizeTable0600[] = {</span>
<a href="#l6.474"></a><span id="l6.474" class="difflineminus">-	/* U+0600 */</span>
<a href="#l6.475"></a><span id="l6.475" class="difflineminus">-	0x0600, 0x0601, 0x0602, 0x0603, 0x0604, 0x0605, 0x0606, 0x0607, </span>
<a href="#l6.476"></a><span id="l6.476" class="difflineminus">-	0x0608, 0x0609, 0x060a, 0x060b, 0x060c, 0x060d, 0x060e, 0x060f, </span>
<a href="#l6.477"></a><span id="l6.477" class="difflineminus">-	0x0610, 0x0611, 0x0612, 0x0613, 0x0614, 0x0615, 0x0616, 0x0617, </span>
<a href="#l6.478"></a><span id="l6.478" class="difflineminus">-	0x0618, 0x0619, 0x061a, 0x061b, 0x061c, 0x061d, 0x061e, 0x061f, </span>
<a href="#l6.479"></a><span id="l6.479" class="difflineminus">-	0x0620, 0x0621, 0x0627, 0x0627, 0x0648, 0x0627, 0x064a, 0x0627, </span>
<a href="#l6.480"></a><span id="l6.480" class="difflineminus">-	0x0628, 0x0629, 0x062a, 0x062b, 0x062c, 0x062d, 0x062e, 0x062f, </span>
<a href="#l6.481"></a><span id="l6.481" class="difflineminus">-	0x0630, 0x0631, 0x0632, 0x0633, 0x0634, 0x0635, 0x0636, 0x0637, </span>
<a href="#l6.482"></a><span id="l6.482" class="difflineminus">-	0x0638, 0x0639, 0x063a, 0x063b, 0x063c, 0x063d, 0x063e, 0x063f, </span>
<a href="#l6.483"></a><span id="l6.483" class="difflineminus">-	};</span>
<a href="#l6.484"></a><span id="l6.484" class="difflineplus">+    /* U+0600 */</span>
<a href="#l6.485"></a><span id="l6.485" class="difflineplus">+    0x0600, 0x0601, 0x0602, 0x0603, 0x0604, 0x0605, 0x0606, 0x0607,</span>
<a href="#l6.486"></a><span id="l6.486" class="difflineplus">+    0x0608, 0x0609, 0x060a, 0x060b, 0x060c, 0x060d, 0x060e, 0x060f,</span>
<a href="#l6.487"></a><span id="l6.487" class="difflineplus">+    0x0610, 0x0611, 0x0612, 0x0613, 0x0614, 0x0615, 0x0616, 0x0617,</span>
<a href="#l6.488"></a><span id="l6.488" class="difflineplus">+    0x0618, 0x0619, 0x061a, 0x061b, 0x061c, 0x061d, 0x061e, 0x061f,</span>
<a href="#l6.489"></a><span id="l6.489" class="difflineplus">+    0x0620, 0x0621, 0x0627, 0x0627, 0x0648, 0x0627, 0x064a, 0x0627,</span>
<a href="#l6.490"></a><span id="l6.490" class="difflineplus">+    0x0628, 0x0629, 0x062a, 0x062b, 0x062c, 0x062d, 0x062e, 0x062f,</span>
<a href="#l6.491"></a><span id="l6.491" class="difflineplus">+    0x0630, 0x0631, 0x0632, 0x0633, 0x0634, 0x0635, 0x0636, 0x0637,</span>
<a href="#l6.492"></a><span id="l6.492" class="difflineplus">+    0x0638, 0x0639, 0x063a, 0x063b, 0x063c, 0x063d, 0x063e, 0x063f,</span>
<a href="#l6.493"></a><span id="l6.493" class="difflineplus">+};</span>
<a href="#l6.494"></a><span id="l6.494"> </span>
<a href="#l6.495"></a><span id="l6.495"> static const unsigned short gNormalizeTable0640[] = {</span>
<a href="#l6.496"></a><span id="l6.496" class="difflineminus">-	/* U+0640 */</span>
<a href="#l6.497"></a><span id="l6.497" class="difflineminus">-	0x0640, 0x0641, 0x0642, 0x0643, 0x0644, 0x0645, 0x0646, 0x0647, </span>
<a href="#l6.498"></a><span id="l6.498" class="difflineminus">-	0x0648, 0x0649, 0x064a, 0x064b, 0x064c, 0x064d, 0x064e, 0x064f, </span>
<a href="#l6.499"></a><span id="l6.499" class="difflineminus">-	0x0650, 0x0651, 0x0652, 0x0653, 0x0654, 0x0655, 0x0656, 0x0657, </span>
<a href="#l6.500"></a><span id="l6.500" class="difflineminus">-	0x0658, 0x0659, 0x065a, 0x065b, 0x065c, 0x065d, 0x065e, 0x065f, </span>
<a href="#l6.501"></a><span id="l6.501" class="difflineminus">-	0x0660, 0x0661, 0x0662, 0x0663, 0x0664, 0x0665, 0x0666, 0x0667, </span>
<a href="#l6.502"></a><span id="l6.502" class="difflineminus">-	0x0668, 0x0669, 0x066a, 0x066b, 0x066c, 0x066d, 0x066e, 0x066f, </span>
<a href="#l6.503"></a><span id="l6.503" class="difflineminus">-	0x0670, 0x0671, 0x0672, 0x0673, 0x0674, 0x0627, 0x0648, 0x06c7, </span>
<a href="#l6.504"></a><span id="l6.504" class="difflineminus">-	0x064a, 0x0679, 0x067a, 0x067b, 0x067c, 0x067d, 0x067e, 0x067f, </span>
<a href="#l6.505"></a><span id="l6.505" class="difflineminus">-	};</span>
<a href="#l6.506"></a><span id="l6.506" class="difflineplus">+    /* U+0640 */</span>
<a href="#l6.507"></a><span id="l6.507" class="difflineplus">+    0x0640, 0x0641, 0x0642, 0x0643, 0x0644, 0x0645, 0x0646, 0x0647,</span>
<a href="#l6.508"></a><span id="l6.508" class="difflineplus">+    0x0648, 0x0649, 0x064a, 0x064b, 0x064c, 0x064d, 0x064e, 0x064f,</span>
<a href="#l6.509"></a><span id="l6.509" class="difflineplus">+    0x0650, 0x0651, 0x0652, 0x0653, 0x0654, 0x0655, 0x0656, 0x0657,</span>
<a href="#l6.510"></a><span id="l6.510" class="difflineplus">+    0x0658, 0x0659, 0x065a, 0x065b, 0x065c, 0x065d, 0x065e, 0x065f,</span>
<a href="#l6.511"></a><span id="l6.511" class="difflineplus">+    0x0660, 0x0661, 0x0662, 0x0663, 0x0664, 0x0665, 0x0666, 0x0667,</span>
<a href="#l6.512"></a><span id="l6.512" class="difflineplus">+    0x0668, 0x0669, 0x066a, 0x066b, 0x066c, 0x066d, 0x066e, 0x066f,</span>
<a href="#l6.513"></a><span id="l6.513" class="difflineplus">+    0x0670, 0x0671, 0x0672, 0x0673, 0x0674, 0x0627, 0x0648, 0x06c7,</span>
<a href="#l6.514"></a><span id="l6.514" class="difflineplus">+    0x064a, 0x0679, 0x067a, 0x067b, 0x067c, 0x067d, 0x067e, 0x067f,</span>
<a href="#l6.515"></a><span id="l6.515" class="difflineplus">+};</span>
<a href="#l6.516"></a><span id="l6.516"> </span>
<a href="#l6.517"></a><span id="l6.517"> static const unsigned short gNormalizeTable06c0[] = {</span>
<a href="#l6.518"></a><span id="l6.518" class="difflineminus">-	/* U+06c0 */</span>
<a href="#l6.519"></a><span id="l6.519" class="difflineminus">-	0x06d5, 0x06c1, 0x06c1, 0x06c3, 0x06c4, 0x06c5, 0x06c6, 0x06c7, </span>
<a href="#l6.520"></a><span id="l6.520" class="difflineminus">-	0x06c8, 0x06c9, 0x06ca, 0x06cb, 0x06cc, 0x06cd, 0x06ce, 0x06cf, </span>
<a href="#l6.521"></a><span id="l6.521" class="difflineminus">-	0x06d0, 0x06d1, 0x06d2, 0x06d2, 0x06d4, 0x06d5, 0x06d6, 0x06d7, </span>
<a href="#l6.522"></a><span id="l6.522" class="difflineminus">-	0x06d8, 0x06d9, 0x06da, 0x06db, 0x06dc, 0x06dd, 0x06de, 0x06df, </span>
<a href="#l6.523"></a><span id="l6.523" class="difflineminus">-	0x06e0, 0x06e1, 0x06e2, 0x06e3, 0x06e4, 0x06e5, 0x06e6, 0x06e7, </span>
<a href="#l6.524"></a><span id="l6.524" class="difflineminus">-	0x06e8, 0x06e9, 0x06ea, 0x06eb, 0x06ec, 0x06ed, 0x06ee, 0x06ef, </span>
<a href="#l6.525"></a><span id="l6.525" class="difflineminus">-	0x06f0, 0x06f1, 0x06f2, 0x06f3, 0x06f4, 0x06f5, 0x06f6, 0x06f7, </span>
<a href="#l6.526"></a><span id="l6.526" class="difflineminus">-	0x06f8, 0x06f9, 0x06fa, 0x06fb, 0x06fc, 0x06fd, 0x06fe, 0x06ff, </span>
<a href="#l6.527"></a><span id="l6.527" class="difflineminus">-	};</span>
<a href="#l6.528"></a><span id="l6.528" class="difflineplus">+    /* U+06c0 */</span>
<a href="#l6.529"></a><span id="l6.529" class="difflineplus">+    0x06d5, 0x06c1, 0x06c1, 0x06c3, 0x06c4, 0x06c5, 0x06c6, 0x06c7,</span>
<a href="#l6.530"></a><span id="l6.530" class="difflineplus">+    0x06c8, 0x06c9, 0x06ca, 0x06cb, 0x06cc, 0x06cd, 0x06ce, 0x06cf,</span>
<a href="#l6.531"></a><span id="l6.531" class="difflineplus">+    0x06d0, 0x06d1, 0x06d2, 0x06d2, 0x06d4, 0x06d5, 0x06d6, 0x06d7,</span>
<a href="#l6.532"></a><span id="l6.532" class="difflineplus">+    0x06d8, 0x06d9, 0x06da, 0x06db, 0x06dc, 0x06dd, 0x06de, 0x06df,</span>
<a href="#l6.533"></a><span id="l6.533" class="difflineplus">+    0x06e0, 0x06e1, 0x06e2, 0x06e3, 0x06e4, 0x06e5, 0x06e6, 0x06e7,</span>
<a href="#l6.534"></a><span id="l6.534" class="difflineplus">+    0x06e8, 0x06e9, 0x06ea, 0x06eb, 0x06ec, 0x06ed, 0x06ee, 0x06ef,</span>
<a href="#l6.535"></a><span id="l6.535" class="difflineplus">+    0x06f0, 0x06f1, 0x06f2, 0x06f3, 0x06f4, 0x06f5, 0x06f6, 0x06f7,</span>
<a href="#l6.536"></a><span id="l6.536" class="difflineplus">+    0x06f8, 0x06f9, 0x06fa, 0x06fb, 0x06fc, 0x06fd, 0x06fe, 0x06ff,</span>
<a href="#l6.537"></a><span id="l6.537" class="difflineplus">+};</span>
<a href="#l6.538"></a><span id="l6.538"> </span>
<a href="#l6.539"></a><span id="l6.539"> static const unsigned short gNormalizeTable0900[] = {</span>
<a href="#l6.540"></a><span id="l6.540" class="difflineminus">-	/* U+0900 */</span>
<a href="#l6.541"></a><span id="l6.541" class="difflineminus">-	0x0900, 0x0901, 0x0902, 0x0903, 0x0904, 0x0905, 0x0906, 0x0907, </span>
<a href="#l6.542"></a><span id="l6.542" class="difflineminus">-	0x0908, 0x0909, 0x090a, 0x090b, 0x090c, 0x090d, 0x090e, 0x090f, </span>
<a href="#l6.543"></a><span id="l6.543" class="difflineminus">-	0x0910, 0x0911, 0x0912, 0x0913, 0x0914, 0x0915, 0x0916, 0x0917, </span>
<a href="#l6.544"></a><span id="l6.544" class="difflineminus">-	0x0918, 0x0919, 0x091a, 0x091b, 0x091c, 0x091d, 0x091e, 0x091f, </span>
<a href="#l6.545"></a><span id="l6.545" class="difflineminus">-	0x0920, 0x0921, 0x0922, 0x0923, 0x0924, 0x0925, 0x0926, 0x0927, </span>
<a href="#l6.546"></a><span id="l6.546" class="difflineminus">-	0x0928, 0x0928, 0x092a, 0x092b, 0x092c, 0x092d, 0x092e, 0x092f, </span>
<a href="#l6.547"></a><span id="l6.547" class="difflineminus">-	0x0930, 0x0930, 0x0932, 0x0933, 0x0933, 0x0935, 0x0936, 0x0937, </span>
<a href="#l6.548"></a><span id="l6.548" class="difflineminus">-	0x0938, 0x0939, 0x093a, 0x093b, 0x093c, 0x093d, 0x093e, 0x093f, </span>
<a href="#l6.549"></a><span id="l6.549" class="difflineminus">-	};</span>
<a href="#l6.550"></a><span id="l6.550" class="difflineplus">+    /* U+0900 */</span>
<a href="#l6.551"></a><span id="l6.551" class="difflineplus">+    0x0900, 0x0901, 0x0902, 0x0903, 0x0904, 0x0905, 0x0906, 0x0907,</span>
<a href="#l6.552"></a><span id="l6.552" class="difflineplus">+    0x0908, 0x0909, 0x090a, 0x090b, 0x090c, 0x090d, 0x090e, 0x090f,</span>
<a href="#l6.553"></a><span id="l6.553" class="difflineplus">+    0x0910, 0x0911, 0x0912, 0x0913, 0x0914, 0x0915, 0x0916, 0x0917,</span>
<a href="#l6.554"></a><span id="l6.554" class="difflineplus">+    0x0918, 0x0919, 0x091a, 0x091b, 0x091c, 0x091d, 0x091e, 0x091f,</span>
<a href="#l6.555"></a><span id="l6.555" class="difflineplus">+    0x0920, 0x0921, 0x0922, 0x0923, 0x0924, 0x0925, 0x0926, 0x0927,</span>
<a href="#l6.556"></a><span id="l6.556" class="difflineplus">+    0x0928, 0x0928, 0x092a, 0x092b, 0x092c, 0x092d, 0x092e, 0x092f,</span>
<a href="#l6.557"></a><span id="l6.557" class="difflineplus">+    0x0930, 0x0930, 0x0932, 0x0933, 0x0933, 0x0935, 0x0936, 0x0937,</span>
<a href="#l6.558"></a><span id="l6.558" class="difflineplus">+    0x0938, 0x0939, 0x093a, 0x093b, 0x093c, 0x093d, 0x093e, 0x093f,</span>
<a href="#l6.559"></a><span id="l6.559" class="difflineplus">+};</span>
<a href="#l6.560"></a><span id="l6.560"> </span>
<a href="#l6.561"></a><span id="l6.561"> static const unsigned short gNormalizeTable0940[] = {</span>
<a href="#l6.562"></a><span id="l6.562" class="difflineminus">-	/* U+0940 */</span>
<a href="#l6.563"></a><span id="l6.563" class="difflineminus">-	0x0940, 0x0941, 0x0942, 0x0943, 0x0944, 0x0945, 0x0946, 0x0947, </span>
<a href="#l6.564"></a><span id="l6.564" class="difflineminus">-	0x0948, 0x0949, 0x094a, 0x094b, 0x094c, 0x094d, 0x094e, 0x094f, </span>
<a href="#l6.565"></a><span id="l6.565" class="difflineminus">-	0x0950, 0x0951, 0x0952, 0x0953, 0x0954, 0x0955, 0x0956, 0x0957, </span>
<a href="#l6.566"></a><span id="l6.566" class="difflineminus">-	0x0915, 0x0916, 0x0917, 0x091c, 0x0921, 0x0922, 0x092b, 0x092f, </span>
<a href="#l6.567"></a><span id="l6.567" class="difflineminus">-	0x0960, 0x0961, 0x0962, 0x0963, 0x0964, 0x0965, 0x0966, 0x0967, </span>
<a href="#l6.568"></a><span id="l6.568" class="difflineminus">-	0x0968, 0x0969, 0x096a, 0x096b, 0x096c, 0x096d, 0x096e, 0x096f, </span>
<a href="#l6.569"></a><span id="l6.569" class="difflineminus">-	0x0970, 0x0971, 0x0972, 0x0973, 0x0974, 0x0975, 0x0976, 0x0977, </span>
<a href="#l6.570"></a><span id="l6.570" class="difflineminus">-	0x0978, 0x0979, 0x097a, 0x097b, 0x097c, 0x097d, 0x097e, 0x097f, </span>
<a href="#l6.571"></a><span id="l6.571" class="difflineminus">-	};</span>
<a href="#l6.572"></a><span id="l6.572" class="difflineplus">+    /* U+0940 */</span>
<a href="#l6.573"></a><span id="l6.573" class="difflineplus">+    0x0940, 0x0941, 0x0942, 0x0943, 0x0944, 0x0945, 0x0946, 0x0947,</span>
<a href="#l6.574"></a><span id="l6.574" class="difflineplus">+    0x0948, 0x0949, 0x094a, 0x094b, 0x094c, 0x094d, 0x094e, 0x094f,</span>
<a href="#l6.575"></a><span id="l6.575" class="difflineplus">+    0x0950, 0x0951, 0x0952, 0x0953, 0x0954, 0x0955, 0x0956, 0x0957,</span>
<a href="#l6.576"></a><span id="l6.576" class="difflineplus">+    0x0915, 0x0916, 0x0917, 0x091c, 0x0921, 0x0922, 0x092b, 0x092f,</span>
<a href="#l6.577"></a><span id="l6.577" class="difflineplus">+    0x0960, 0x0961, 0x0962, 0x0963, 0x0964, 0x0965, 0x0966, 0x0967,</span>
<a href="#l6.578"></a><span id="l6.578" class="difflineplus">+    0x0968, 0x0969, 0x096a, 0x096b, 0x096c, 0x096d, 0x096e, 0x096f,</span>
<a href="#l6.579"></a><span id="l6.579" class="difflineplus">+    0x0970, 0x0971, 0x0972, 0x0973, 0x0974, 0x0975, 0x0976, 0x0977,</span>
<a href="#l6.580"></a><span id="l6.580" class="difflineplus">+    0x0978, 0x0979, 0x097a, 0x097b, 0x097c, 0x097d, 0x097e, 0x097f,</span>
<a href="#l6.581"></a><span id="l6.581" class="difflineplus">+};</span>
<a href="#l6.582"></a><span id="l6.582"> </span>
<a href="#l6.583"></a><span id="l6.583"> static const unsigned short gNormalizeTable09c0[] = {</span>
<a href="#l6.584"></a><span id="l6.584" class="difflineminus">-	/* U+09c0 */</span>
<a href="#l6.585"></a><span id="l6.585" class="difflineminus">-	0x09c0, 0x09c1, 0x09c2, 0x09c3, 0x09c4, 0x09c5, 0x09c6, 0x09c7, </span>
<a href="#l6.586"></a><span id="l6.586" class="difflineminus">-	0x09c8, 0x09c9, 0x09ca, 0x09c7, 0x09c7, 0x09cd, 0x09ce, 0x09cf, </span>
<a href="#l6.587"></a><span id="l6.587" class="difflineminus">-	0x09d0, 0x09d1, 0x09d2, 0x09d3, 0x09d4, 0x09d5, 0x09d6, 0x09d7, </span>
<a href="#l6.588"></a><span id="l6.588" class="difflineminus">-	0x09d8, 0x09d9, 0x09da, 0x09db, 0x09a1, 0x09a2, 0x09de, 0x09af, </span>
<a href="#l6.589"></a><span id="l6.589" class="difflineminus">-	0x09e0, 0x09e1, 0x09e2, 0x09e3, 0x09e4, 0x09e5, 0x09e6, 0x09e7, </span>
<a href="#l6.590"></a><span id="l6.590" class="difflineminus">-	0x09e8, 0x09e9, 0x09ea, 0x09eb, 0x09ec, 0x09ed, 0x09ee, 0x09ef, </span>
<a href="#l6.591"></a><span id="l6.591" class="difflineminus">-	0x09f0, 0x09f1, 0x09f2, 0x09f3, 0x09f4, 0x09f5, 0x09f6, 0x09f7, </span>
<a href="#l6.592"></a><span id="l6.592" class="difflineminus">-	0x09f8, 0x09f9, 0x09fa, 0x09fb, 0x09fc, 0x09fd, 0x09fe, 0x09ff, </span>
<a href="#l6.593"></a><span id="l6.593" class="difflineminus">-	};</span>
<a href="#l6.594"></a><span id="l6.594" class="difflineplus">+    /* U+09c0 */</span>
<a href="#l6.595"></a><span id="l6.595" class="difflineplus">+    0x09c0, 0x09c1, 0x09c2, 0x09c3, 0x09c4, 0x09c5, 0x09c6, 0x09c7,</span>
<a href="#l6.596"></a><span id="l6.596" class="difflineplus">+    0x09c8, 0x09c9, 0x09ca, 0x09c7, 0x09c7, 0x09cd, 0x09ce, 0x09cf,</span>
<a href="#l6.597"></a><span id="l6.597" class="difflineplus">+    0x09d0, 0x09d1, 0x09d2, 0x09d3, 0x09d4, 0x09d5, 0x09d6, 0x09d7,</span>
<a href="#l6.598"></a><span id="l6.598" class="difflineplus">+    0x09d8, 0x09d9, 0x09da, 0x09db, 0x09a1, 0x09a2, 0x09de, 0x09af,</span>
<a href="#l6.599"></a><span id="l6.599" class="difflineplus">+    0x09e0, 0x09e1, 0x09e2, 0x09e3, 0x09e4, 0x09e5, 0x09e6, 0x09e7,</span>
<a href="#l6.600"></a><span id="l6.600" class="difflineplus">+    0x09e8, 0x09e9, 0x09ea, 0x09eb, 0x09ec, 0x09ed, 0x09ee, 0x09ef,</span>
<a href="#l6.601"></a><span id="l6.601" class="difflineplus">+    0x09f0, 0x09f1, 0x09f2, 0x09f3, 0x09f4, 0x09f5, 0x09f6, 0x09f7,</span>
<a href="#l6.602"></a><span id="l6.602" class="difflineplus">+    0x09f8, 0x09f9, 0x09fa, 0x09fb, 0x09fc, 0x09fd, 0x09fe, 0x09ff,</span>
<a href="#l6.603"></a><span id="l6.603" class="difflineplus">+};</span>
<a href="#l6.604"></a><span id="l6.604"> </span>
<a href="#l6.605"></a><span id="l6.605"> static const unsigned short gNormalizeTable0a00[] = {</span>
<a href="#l6.606"></a><span id="l6.606" class="difflineminus">-	/* U+0a00 */</span>
<a href="#l6.607"></a><span id="l6.607" class="difflineminus">-	0x0a00, 0x0a01, 0x0a02, 0x0a03, 0x0a04, 0x0a05, 0x0a06, 0x0a07, </span>
<a href="#l6.608"></a><span id="l6.608" class="difflineminus">-	0x0a08, 0x0a09, 0x0a0a, 0x0a0b, 0x0a0c, 0x0a0d, 0x0a0e, 0x0a0f, </span>
<a href="#l6.609"></a><span id="l6.609" class="difflineminus">-	0x0a10, 0x0a11, 0x0a12, 0x0a13, 0x0a14, 0x0a15, 0x0a16, 0x0a17, </span>
<a href="#l6.610"></a><span id="l6.610" class="difflineminus">-	0x0a18, 0x0a19, 0x0a1a, 0x0a1b, 0x0a1c, 0x0a1d, 0x0a1e, 0x0a1f, </span>
<a href="#l6.611"></a><span id="l6.611" class="difflineminus">-	0x0a20, 0x0a21, 0x0a22, 0x0a23, 0x0a24, 0x0a25, 0x0a26, 0x0a27, </span>
<a href="#l6.612"></a><span id="l6.612" class="difflineminus">-	0x0a28, 0x0a29, 0x0a2a, 0x0a2b, 0x0a2c, 0x0a2d, 0x0a2e, 0x0a2f, </span>
<a href="#l6.613"></a><span id="l6.613" class="difflineminus">-	0x0a30, 0x0a31, 0x0a32, 0x0a32, 0x0a34, 0x0a35, 0x0a38, 0x0a37, </span>
<a href="#l6.614"></a><span id="l6.614" class="difflineminus">-	0x0a38, 0x0a39, 0x0a3a, 0x0a3b, 0x0a3c, 0x0a3d, 0x0a3e, 0x0a3f, </span>
<a href="#l6.615"></a><span id="l6.615" class="difflineminus">-	};</span>
<a href="#l6.616"></a><span id="l6.616" class="difflineplus">+    /* U+0a00 */</span>
<a href="#l6.617"></a><span id="l6.617" class="difflineplus">+    0x0a00, 0x0a01, 0x0a02, 0x0a03, 0x0a04, 0x0a05, 0x0a06, 0x0a07,</span>
<a href="#l6.618"></a><span id="l6.618" class="difflineplus">+    0x0a08, 0x0a09, 0x0a0a, 0x0a0b, 0x0a0c, 0x0a0d, 0x0a0e, 0x0a0f,</span>
<a href="#l6.619"></a><span id="l6.619" class="difflineplus">+    0x0a10, 0x0a11, 0x0a12, 0x0a13, 0x0a14, 0x0a15, 0x0a16, 0x0a17,</span>
<a href="#l6.620"></a><span id="l6.620" class="difflineplus">+    0x0a18, 0x0a19, 0x0a1a, 0x0a1b, 0x0a1c, 0x0a1d, 0x0a1e, 0x0a1f,</span>
<a href="#l6.621"></a><span id="l6.621" class="difflineplus">+    0x0a20, 0x0a21, 0x0a22, 0x0a23, 0x0a24, 0x0a25, 0x0a26, 0x0a27,</span>
<a href="#l6.622"></a><span id="l6.622" class="difflineplus">+    0x0a28, 0x0a29, 0x0a2a, 0x0a2b, 0x0a2c, 0x0a2d, 0x0a2e, 0x0a2f,</span>
<a href="#l6.623"></a><span id="l6.623" class="difflineplus">+    0x0a30, 0x0a31, 0x0a32, 0x0a32, 0x0a34, 0x0a35, 0x0a38, 0x0a37,</span>
<a href="#l6.624"></a><span id="l6.624" class="difflineplus">+    0x0a38, 0x0a39, 0x0a3a, 0x0a3b, 0x0a3c, 0x0a3d, 0x0a3e, 0x0a3f,</span>
<a href="#l6.625"></a><span id="l6.625" class="difflineplus">+};</span>
<a href="#l6.626"></a><span id="l6.626"> </span>
<a href="#l6.627"></a><span id="l6.627"> static const unsigned short gNormalizeTable0a40[] = {</span>
<a href="#l6.628"></a><span id="l6.628" class="difflineminus">-	/* U+0a40 */</span>
<a href="#l6.629"></a><span id="l6.629" class="difflineminus">-	0x0a40, 0x0a41, 0x0a42, 0x0a43, 0x0a44, 0x0a45, 0x0a46, 0x0a47, </span>
<a href="#l6.630"></a><span id="l6.630" class="difflineminus">-	0x0a48, 0x0a49, 0x0a4a, 0x0a4b, 0x0a4c, 0x0a4d, 0x0a4e, 0x0a4f, </span>
<a href="#l6.631"></a><span id="l6.631" class="difflineminus">-	0x0a50, 0x0a51, 0x0a52, 0x0a53, 0x0a54, 0x0a55, 0x0a56, 0x0a57, </span>
<a href="#l6.632"></a><span id="l6.632" class="difflineminus">-	0x0a58, 0x0a16, 0x0a17, 0x0a1c, 0x0a5c, 0x0a5d, 0x0a2b, 0x0a5f, </span>
<a href="#l6.633"></a><span id="l6.633" class="difflineminus">-	0x0a60, 0x0a61, 0x0a62, 0x0a63, 0x0a64, 0x0a65, 0x0a66, 0x0a67, </span>
<a href="#l6.634"></a><span id="l6.634" class="difflineminus">-	0x0a68, 0x0a69, 0x0a6a, 0x0a6b, 0x0a6c, 0x0a6d, 0x0a6e, 0x0a6f, </span>
<a href="#l6.635"></a><span id="l6.635" class="difflineminus">-	0x0a70, 0x0a71, 0x0a72, 0x0a73, 0x0a74, 0x0a75, 0x0a76, 0x0a77, </span>
<a href="#l6.636"></a><span id="l6.636" class="difflineminus">-	0x0a78, 0x0a79, 0x0a7a, 0x0a7b, 0x0a7c, 0x0a7d, 0x0a7e, 0x0a7f, </span>
<a href="#l6.637"></a><span id="l6.637" class="difflineminus">-	};</span>
<a href="#l6.638"></a><span id="l6.638" class="difflineplus">+    /* U+0a40 */</span>
<a href="#l6.639"></a><span id="l6.639" class="difflineplus">+    0x0a40, 0x0a41, 0x0a42, 0x0a43, 0x0a44, 0x0a45, 0x0a46, 0x0a47,</span>
<a href="#l6.640"></a><span id="l6.640" class="difflineplus">+    0x0a48, 0x0a49, 0x0a4a, 0x0a4b, 0x0a4c, 0x0a4d, 0x0a4e, 0x0a4f,</span>
<a href="#l6.641"></a><span id="l6.641" class="difflineplus">+    0x0a50, 0x0a51, 0x0a52, 0x0a53, 0x0a54, 0x0a55, 0x0a56, 0x0a57,</span>
<a href="#l6.642"></a><span id="l6.642" class="difflineplus">+    0x0a58, 0x0a16, 0x0a17, 0x0a1c, 0x0a5c, 0x0a5d, 0x0a2b, 0x0a5f,</span>
<a href="#l6.643"></a><span id="l6.643" class="difflineplus">+    0x0a60, 0x0a61, 0x0a62, 0x0a63, 0x0a64, 0x0a65, 0x0a66, 0x0a67,</span>
<a href="#l6.644"></a><span id="l6.644" class="difflineplus">+    0x0a68, 0x0a69, 0x0a6a, 0x0a6b, 0x0a6c, 0x0a6d, 0x0a6e, 0x0a6f,</span>
<a href="#l6.645"></a><span id="l6.645" class="difflineplus">+    0x0a70, 0x0a71, 0x0a72, 0x0a73, 0x0a74, 0x0a75, 0x0a76, 0x0a77,</span>
<a href="#l6.646"></a><span id="l6.646" class="difflineplus">+    0x0a78, 0x0a79, 0x0a7a, 0x0a7b, 0x0a7c, 0x0a7d, 0x0a7e, 0x0a7f,</span>
<a href="#l6.647"></a><span id="l6.647" class="difflineplus">+};</span>
<a href="#l6.648"></a><span id="l6.648"> </span>
<a href="#l6.649"></a><span id="l6.649"> static const unsigned short gNormalizeTable0b40[] = {</span>
<a href="#l6.650"></a><span id="l6.650" class="difflineminus">-	/* U+0b40 */</span>
<a href="#l6.651"></a><span id="l6.651" class="difflineminus">-	0x0b40, 0x0b41, 0x0b42, 0x0b43, 0x0b44, 0x0b45, 0x0b46, 0x0b47, </span>
<a href="#l6.652"></a><span id="l6.652" class="difflineminus">-	0x0b47, 0x0b49, 0x0b4a, 0x0b47, 0x0b47, 0x0b4d, 0x0b4e, 0x0b4f, </span>
<a href="#l6.653"></a><span id="l6.653" class="difflineminus">-	0x0b50, 0x0b51, 0x0b52, 0x0b53, 0x0b54, 0x0b55, 0x0b56, 0x0b57, </span>
<a href="#l6.654"></a><span id="l6.654" class="difflineminus">-	0x0b58, 0x0b59, 0x0b5a, 0x0b5b, 0x0b21, 0x0b22, 0x0b5e, 0x0b5f, </span>
<a href="#l6.655"></a><span id="l6.655" class="difflineminus">-	0x0b60, 0x0b61, 0x0b62, 0x0b63, 0x0b64, 0x0b65, 0x0b66, 0x0b67, </span>
<a href="#l6.656"></a><span id="l6.656" class="difflineminus">-	0x0b68, 0x0b69, 0x0b6a, 0x0b6b, 0x0b6c, 0x0b6d, 0x0b6e, 0x0b6f, </span>
<a href="#l6.657"></a><span id="l6.657" class="difflineminus">-	0x0b70, 0x0b71, 0x0b72, 0x0b73, 0x0b74, 0x0b75, 0x0b76, 0x0b77, </span>
<a href="#l6.658"></a><span id="l6.658" class="difflineminus">-	0x0b78, 0x0b79, 0x0b7a, 0x0b7b, 0x0b7c, 0x0b7d, 0x0b7e, 0x0b7f, </span>
<a href="#l6.659"></a><span id="l6.659" class="difflineminus">-	};</span>
<a href="#l6.660"></a><span id="l6.660" class="difflineplus">+    /* U+0b40 */</span>
<a href="#l6.661"></a><span id="l6.661" class="difflineplus">+    0x0b40, 0x0b41, 0x0b42, 0x0b43, 0x0b44, 0x0b45, 0x0b46, 0x0b47,</span>
<a href="#l6.662"></a><span id="l6.662" class="difflineplus">+    0x0b47, 0x0b49, 0x0b4a, 0x0b47, 0x0b47, 0x0b4d, 0x0b4e, 0x0b4f,</span>
<a href="#l6.663"></a><span id="l6.663" class="difflineplus">+    0x0b50, 0x0b51, 0x0b52, 0x0b53, 0x0b54, 0x0b55, 0x0b56, 0x0b57,</span>
<a href="#l6.664"></a><span id="l6.664" class="difflineplus">+    0x0b58, 0x0b59, 0x0b5a, 0x0b5b, 0x0b21, 0x0b22, 0x0b5e, 0x0b5f,</span>
<a href="#l6.665"></a><span id="l6.665" class="difflineplus">+    0x0b60, 0x0b61, 0x0b62, 0x0b63, 0x0b64, 0x0b65, 0x0b66, 0x0b67,</span>
<a href="#l6.666"></a><span id="l6.666" class="difflineplus">+    0x0b68, 0x0b69, 0x0b6a, 0x0b6b, 0x0b6c, 0x0b6d, 0x0b6e, 0x0b6f,</span>
<a href="#l6.667"></a><span id="l6.667" class="difflineplus">+    0x0b70, 0x0b71, 0x0b72, 0x0b73, 0x0b74, 0x0b75, 0x0b76, 0x0b77,</span>
<a href="#l6.668"></a><span id="l6.668" class="difflineplus">+    0x0b78, 0x0b79, 0x0b7a, 0x0b7b, 0x0b7c, 0x0b7d, 0x0b7e, 0x0b7f,</span>
<a href="#l6.669"></a><span id="l6.669" class="difflineplus">+};</span>
<a href="#l6.670"></a><span id="l6.670"> </span>
<a href="#l6.671"></a><span id="l6.671"> static const unsigned short gNormalizeTable0b80[] = {</span>
<a href="#l6.672"></a><span id="l6.672" class="difflineminus">-	/* U+0b80 */</span>
<a href="#l6.673"></a><span id="l6.673" class="difflineminus">-	0x0b80, 0x0b81, 0x0b82, 0x0b83, 0x0b84, 0x0b85, 0x0b86, 0x0b87, </span>
<a href="#l6.674"></a><span id="l6.674" class="difflineminus">-	0x0b88, 0x0b89, 0x0b8a, 0x0b8b, 0x0b8c, 0x0b8d, 0x0b8e, 0x0b8f, </span>
<a href="#l6.675"></a><span id="l6.675" class="difflineminus">-	0x0b90, 0x0b91, 0x0b92, 0x0b93, 0x0b92, 0x0b95, 0x0b96, 0x0b97, </span>
<a href="#l6.676"></a><span id="l6.676" class="difflineminus">-	0x0b98, 0x0b99, 0x0b9a, 0x0b9b, 0x0b9c, 0x0b9d, 0x0b9e, 0x0b9f, </span>
<a href="#l6.677"></a><span id="l6.677" class="difflineminus">-	0x0ba0, 0x0ba1, 0x0ba2, 0x0ba3, 0x0ba4, 0x0ba5, 0x0ba6, 0x0ba7, </span>
<a href="#l6.678"></a><span id="l6.678" class="difflineminus">-	0x0ba8, 0x0ba9, 0x0baa, 0x0bab, 0x0bac, 0x0bad, 0x0bae, 0x0baf, </span>
<a href="#l6.679"></a><span id="l6.679" class="difflineminus">-	0x0bb0, 0x0bb1, 0x0bb2, 0x0bb3, 0x0bb4, 0x0bb5, 0x0bb6, 0x0bb7, </span>
<a href="#l6.680"></a><span id="l6.680" class="difflineminus">-	0x0bb8, 0x0bb9, 0x0bba, 0x0bbb, 0x0bbc, 0x0bbd, 0x0bbe, 0x0bbf, </span>
<a href="#l6.681"></a><span id="l6.681" class="difflineminus">-	};</span>
<a href="#l6.682"></a><span id="l6.682" class="difflineplus">+    /* U+0b80 */</span>
<a href="#l6.683"></a><span id="l6.683" class="difflineplus">+    0x0b80, 0x0b81, 0x0b82, 0x0b83, 0x0b84, 0x0b85, 0x0b86, 0x0b87,</span>
<a href="#l6.684"></a><span id="l6.684" class="difflineplus">+    0x0b88, 0x0b89, 0x0b8a, 0x0b8b, 0x0b8c, 0x0b8d, 0x0b8e, 0x0b8f,</span>
<a href="#l6.685"></a><span id="l6.685" class="difflineplus">+    0x0b90, 0x0b91, 0x0b92, 0x0b93, 0x0b92, 0x0b95, 0x0b96, 0x0b97,</span>
<a href="#l6.686"></a><span id="l6.686" class="difflineplus">+    0x0b98, 0x0b99, 0x0b9a, 0x0b9b, 0x0b9c, 0x0b9d, 0x0b9e, 0x0b9f,</span>
<a href="#l6.687"></a><span id="l6.687" class="difflineplus">+    0x0ba0, 0x0ba1, 0x0ba2, 0x0ba3, 0x0ba4, 0x0ba5, 0x0ba6, 0x0ba7,</span>
<a href="#l6.688"></a><span id="l6.688" class="difflineplus">+    0x0ba8, 0x0ba9, 0x0baa, 0x0bab, 0x0bac, 0x0bad, 0x0bae, 0x0baf,</span>
<a href="#l6.689"></a><span id="l6.689" class="difflineplus">+    0x0bb0, 0x0bb1, 0x0bb2, 0x0bb3, 0x0bb4, 0x0bb5, 0x0bb6, 0x0bb7,</span>
<a href="#l6.690"></a><span id="l6.690" class="difflineplus">+    0x0bb8, 0x0bb9, 0x0bba, 0x0bbb, 0x0bbc, 0x0bbd, 0x0bbe, 0x0bbf,</span>
<a href="#l6.691"></a><span id="l6.691" class="difflineplus">+};</span>
<a href="#l6.692"></a><span id="l6.692"> </span>
<a href="#l6.693"></a><span id="l6.693"> static const unsigned short gNormalizeTable0bc0[] = {</span>
<a href="#l6.694"></a><span id="l6.694" class="difflineminus">-	/* U+0bc0 */</span>
<a href="#l6.695"></a><span id="l6.695" class="difflineminus">-	0x0bc0, 0x0bc1, 0x0bc2, 0x0bc3, 0x0bc4, 0x0bc5, 0x0bc6, 0x0bc7, </span>
<a href="#l6.696"></a><span id="l6.696" class="difflineminus">-	0x0bc8, 0x0bc9, 0x0bc6, 0x0bc7, 0x0bc6, 0x0bcd, 0x0bce, 0x0bcf, </span>
<a href="#l6.697"></a><span id="l6.697" class="difflineminus">-	0x0bd0, 0x0bd1, 0x0bd2, 0x0bd3, 0x0bd4, 0x0bd5, 0x0bd6, 0x0bd7, </span>
<a href="#l6.698"></a><span id="l6.698" class="difflineminus">-	0x0bd8, 0x0bd9, 0x0bda, 0x0bdb, 0x0bdc, 0x0bdd, 0x0bde, 0x0bdf, </span>
<a href="#l6.699"></a><span id="l6.699" class="difflineminus">-	0x0be0, 0x0be1, 0x0be2, 0x0be3, 0x0be4, 0x0be5, 0x0be6, 0x0be7, </span>
<a href="#l6.700"></a><span id="l6.700" class="difflineminus">-	0x0be8, 0x0be9, 0x0bea, 0x0beb, 0x0bec, 0x0bed, 0x0bee, 0x0bef, </span>
<a href="#l6.701"></a><span id="l6.701" class="difflineminus">-	0x0bf0, 0x0bf1, 0x0bf2, 0x0bf3, 0x0bf4, 0x0bf5, 0x0bf6, 0x0bf7, </span>
<a href="#l6.702"></a><span id="l6.702" class="difflineminus">-	0x0bf8, 0x0bf9, 0x0bfa, 0x0bfb, 0x0bfc, 0x0bfd, 0x0bfe, 0x0bff, </span>
<a href="#l6.703"></a><span id="l6.703" class="difflineminus">-	};</span>
<a href="#l6.704"></a><span id="l6.704" class="difflineplus">+    /* U+0bc0 */</span>
<a href="#l6.705"></a><span id="l6.705" class="difflineplus">+    0x0bc0, 0x0bc1, 0x0bc2, 0x0bc3, 0x0bc4, 0x0bc5, 0x0bc6, 0x0bc7,</span>
<a href="#l6.706"></a><span id="l6.706" class="difflineplus">+    0x0bc8, 0x0bc9, 0x0bc6, 0x0bc7, 0x0bc6, 0x0bcd, 0x0bce, 0x0bcf,</span>
<a href="#l6.707"></a><span id="l6.707" class="difflineplus">+    0x0bd0, 0x0bd1, 0x0bd2, 0x0bd3, 0x0bd4, 0x0bd5, 0x0bd6, 0x0bd7,</span>
<a href="#l6.708"></a><span id="l6.708" class="difflineplus">+    0x0bd8, 0x0bd9, 0x0bda, 0x0bdb, 0x0bdc, 0x0bdd, 0x0bde, 0x0bdf,</span>
<a href="#l6.709"></a><span id="l6.709" class="difflineplus">+    0x0be0, 0x0be1, 0x0be2, 0x0be3, 0x0be4, 0x0be5, 0x0be6, 0x0be7,</span>
<a href="#l6.710"></a><span id="l6.710" class="difflineplus">+    0x0be8, 0x0be9, 0x0bea, 0x0beb, 0x0bec, 0x0bed, 0x0bee, 0x0bef,</span>
<a href="#l6.711"></a><span id="l6.711" class="difflineplus">+    0x0bf0, 0x0bf1, 0x0bf2, 0x0bf3, 0x0bf4, 0x0bf5, 0x0bf6, 0x0bf7,</span>
<a href="#l6.712"></a><span id="l6.712" class="difflineplus">+    0x0bf8, 0x0bf9, 0x0bfa, 0x0bfb, 0x0bfc, 0x0bfd, 0x0bfe, 0x0bff,</span>
<a href="#l6.713"></a><span id="l6.713" class="difflineplus">+};</span>
<a href="#l6.714"></a><span id="l6.714"> </span>
<a href="#l6.715"></a><span id="l6.715"> static const unsigned short gNormalizeTable0c40[] = {</span>
<a href="#l6.716"></a><span id="l6.716" class="difflineminus">-	/* U+0c40 */</span>
<a href="#l6.717"></a><span id="l6.717" class="difflineminus">-	0x0c40, 0x0c41, 0x0c42, 0x0c43, 0x0c44, 0x0c45, 0x0c46, 0x0c47, </span>
<a href="#l6.718"></a><span id="l6.718" class="difflineminus">-	0x0c46, 0x0c49, 0x0c4a, 0x0c4b, 0x0c4c, 0x0c4d, 0x0c4e, 0x0c4f, </span>
<a href="#l6.719"></a><span id="l6.719" class="difflineminus">-	0x0c50, 0x0c51, 0x0c52, 0x0c53, 0x0c54, 0x0c55, 0x0c56, 0x0c57, </span>
<a href="#l6.720"></a><span id="l6.720" class="difflineminus">-	0x0c58, 0x0c59, 0x0c5a, 0x0c5b, 0x0c5c, 0x0c5d, 0x0c5e, 0x0c5f, </span>
<a href="#l6.721"></a><span id="l6.721" class="difflineminus">-	0x0c60, 0x0c61, 0x0c62, 0x0c63, 0x0c64, 0x0c65, 0x0c66, 0x0c67, </span>
<a href="#l6.722"></a><span id="l6.722" class="difflineminus">-	0x0c68, 0x0c69, 0x0c6a, 0x0c6b, 0x0c6c, 0x0c6d, 0x0c6e, 0x0c6f, </span>
<a href="#l6.723"></a><span id="l6.723" class="difflineminus">-	0x0c70, 0x0c71, 0x0c72, 0x0c73, 0x0c74, 0x0c75, 0x0c76, 0x0c77, </span>
<a href="#l6.724"></a><span id="l6.724" class="difflineminus">-	0x0c78, 0x0c79, 0x0c7a, 0x0c7b, 0x0c7c, 0x0c7d, 0x0c7e, 0x0c7f, </span>
<a href="#l6.725"></a><span id="l6.725" class="difflineminus">-	};</span>
<a href="#l6.726"></a><span id="l6.726" class="difflineplus">+    /* U+0c40 */</span>
<a href="#l6.727"></a><span id="l6.727" class="difflineplus">+    0x0c40, 0x0c41, 0x0c42, 0x0c43, 0x0c44, 0x0c45, 0x0c46, 0x0c47,</span>
<a href="#l6.728"></a><span id="l6.728" class="difflineplus">+    0x0c46, 0x0c49, 0x0c4a, 0x0c4b, 0x0c4c, 0x0c4d, 0x0c4e, 0x0c4f,</span>
<a href="#l6.729"></a><span id="l6.729" class="difflineplus">+    0x0c50, 0x0c51, 0x0c52, 0x0c53, 0x0c54, 0x0c55, 0x0c56, 0x0c57,</span>
<a href="#l6.730"></a><span id="l6.730" class="difflineplus">+    0x0c58, 0x0c59, 0x0c5a, 0x0c5b, 0x0c5c, 0x0c5d, 0x0c5e, 0x0c5f,</span>
<a href="#l6.731"></a><span id="l6.731" class="difflineplus">+    0x0c60, 0x0c61, 0x0c62, 0x0c63, 0x0c64, 0x0c65, 0x0c66, 0x0c67,</span>
<a href="#l6.732"></a><span id="l6.732" class="difflineplus">+    0x0c68, 0x0c69, 0x0c6a, 0x0c6b, 0x0c6c, 0x0c6d, 0x0c6e, 0x0c6f,</span>
<a href="#l6.733"></a><span id="l6.733" class="difflineplus">+    0x0c70, 0x0c71, 0x0c72, 0x0c73, 0x0c74, 0x0c75, 0x0c76, 0x0c77,</span>
<a href="#l6.734"></a><span id="l6.734" class="difflineplus">+    0x0c78, 0x0c79, 0x0c7a, 0x0c7b, 0x0c7c, 0x0c7d, 0x0c7e, 0x0c7f,</span>
<a href="#l6.735"></a><span id="l6.735" class="difflineplus">+};</span>
<a href="#l6.736"></a><span id="l6.736"> </span>
<a href="#l6.737"></a><span id="l6.737"> static const unsigned short gNormalizeTable0cc0[] = {</span>
<a href="#l6.738"></a><span id="l6.738" class="difflineminus">-	/* U+0cc0 */</span>
<a href="#l6.739"></a><span id="l6.739" class="difflineminus">-	0x0cbf, 0x0cc1, 0x0cc2, 0x0cc3, 0x0cc4, 0x0cc5, 0x0cc6, 0x0cc6, </span>
<a href="#l6.740"></a><span id="l6.740" class="difflineminus">-	0x0cc6, 0x0cc9, 0x0cc6, 0x0cc6, 0x0ccc, 0x0ccd, 0x0cce, 0x0ccf, </span>
<a href="#l6.741"></a><span id="l6.741" class="difflineminus">-	0x0cd0, 0x0cd1, 0x0cd2, 0x0cd3, 0x0cd4, 0x0cd5, 0x0cd6, 0x0cd7, </span>
<a href="#l6.742"></a><span id="l6.742" class="difflineminus">-	0x0cd8, 0x0cd9, 0x0cda, 0x0cdb, 0x0cdc, 0x0cdd, 0x0cde, 0x0cdf, </span>
<a href="#l6.743"></a><span id="l6.743" class="difflineminus">-	0x0ce0, 0x0ce1, 0x0ce2, 0x0ce3, 0x0ce4, 0x0ce5, 0x0ce6, 0x0ce7, </span>
<a href="#l6.744"></a><span id="l6.744" class="difflineminus">-	0x0ce8, 0x0ce9, 0x0cea, 0x0ceb, 0x0cec, 0x0ced, 0x0cee, 0x0cef, </span>
<a href="#l6.745"></a><span id="l6.745" class="difflineminus">-	0x0cf0, 0x0cf1, 0x0cf2, 0x0cf3, 0x0cf4, 0x0cf5, 0x0cf6, 0x0cf7, </span>
<a href="#l6.746"></a><span id="l6.746" class="difflineminus">-	0x0cf8, 0x0cf9, 0x0cfa, 0x0cfb, 0x0cfc, 0x0cfd, 0x0cfe, 0x0cff, </span>
<a href="#l6.747"></a><span id="l6.747" class="difflineminus">-	};</span>
<a href="#l6.748"></a><span id="l6.748" class="difflineplus">+    /* U+0cc0 */</span>
<a href="#l6.749"></a><span id="l6.749" class="difflineplus">+    0x0cbf, 0x0cc1, 0x0cc2, 0x0cc3, 0x0cc4, 0x0cc5, 0x0cc6, 0x0cc6,</span>
<a href="#l6.750"></a><span id="l6.750" class="difflineplus">+    0x0cc6, 0x0cc9, 0x0cc6, 0x0cc6, 0x0ccc, 0x0ccd, 0x0cce, 0x0ccf,</span>
<a href="#l6.751"></a><span id="l6.751" class="difflineplus">+    0x0cd0, 0x0cd1, 0x0cd2, 0x0cd3, 0x0cd4, 0x0cd5, 0x0cd6, 0x0cd7,</span>
<a href="#l6.752"></a><span id="l6.752" class="difflineplus">+    0x0cd8, 0x0cd9, 0x0cda, 0x0cdb, 0x0cdc, 0x0cdd, 0x0cde, 0x0cdf,</span>
<a href="#l6.753"></a><span id="l6.753" class="difflineplus">+    0x0ce0, 0x0ce1, 0x0ce2, 0x0ce3, 0x0ce4, 0x0ce5, 0x0ce6, 0x0ce7,</span>
<a href="#l6.754"></a><span id="l6.754" class="difflineplus">+    0x0ce8, 0x0ce9, 0x0cea, 0x0ceb, 0x0cec, 0x0ced, 0x0cee, 0x0cef,</span>
<a href="#l6.755"></a><span id="l6.755" class="difflineplus">+    0x0cf0, 0x0cf1, 0x0cf2, 0x0cf3, 0x0cf4, 0x0cf5, 0x0cf6, 0x0cf7,</span>
<a href="#l6.756"></a><span id="l6.756" class="difflineplus">+    0x0cf8, 0x0cf9, 0x0cfa, 0x0cfb, 0x0cfc, 0x0cfd, 0x0cfe, 0x0cff,</span>
<a href="#l6.757"></a><span id="l6.757" class="difflineplus">+};</span>
<a href="#l6.758"></a><span id="l6.758"> </span>
<a href="#l6.759"></a><span id="l6.759"> static const unsigned short gNormalizeTable0d40[] = {</span>
<a href="#l6.760"></a><span id="l6.760" class="difflineminus">-	/* U+0d40 */</span>
<a href="#l6.761"></a><span id="l6.761" class="difflineminus">-	0x0d40, 0x0d41, 0x0d42, 0x0d43, 0x0d44, 0x0d45, 0x0d46, 0x0d47, </span>
<a href="#l6.762"></a><span id="l6.762" class="difflineminus">-	0x0d48, 0x0d49, 0x0d46, 0x0d47, 0x0d46, 0x0d4d, 0x0d4e, 0x0d4f, </span>
<a href="#l6.763"></a><span id="l6.763" class="difflineminus">-	0x0d50, 0x0d51, 0x0d52, 0x0d53, 0x0d54, 0x0d55, 0x0d56, 0x0d57, </span>
<a href="#l6.764"></a><span id="l6.764" class="difflineminus">-	0x0d58, 0x0d59, 0x0d5a, 0x0d5b, 0x0d5c, 0x0d5d, 0x0d5e, 0x0d5f, </span>
<a href="#l6.765"></a><span id="l6.765" class="difflineminus">-	0x0d60, 0x0d61, 0x0d62, 0x0d63, 0x0d64, 0x0d65, 0x0d66, 0x0d67, </span>
<a href="#l6.766"></a><span id="l6.766" class="difflineminus">-	0x0d68, 0x0d69, 0x0d6a, 0x0d6b, 0x0d6c, 0x0d6d, 0x0d6e, 0x0d6f, </span>
<a href="#l6.767"></a><span id="l6.767" class="difflineminus">-	0x0d70, 0x0d71, 0x0d72, 0x0d73, 0x0d74, 0x0d75, 0x0d76, 0x0d77, </span>
<a href="#l6.768"></a><span id="l6.768" class="difflineminus">-	0x0d78, 0x0d79, 0x0d7a, 0x0d7b, 0x0d7c, 0x0d7d, 0x0d7e, 0x0d7f, </span>
<a href="#l6.769"></a><span id="l6.769" class="difflineminus">-	};</span>
<a href="#l6.770"></a><span id="l6.770" class="difflineplus">+    /* U+0d40 */</span>
<a href="#l6.771"></a><span id="l6.771" class="difflineplus">+    0x0d40, 0x0d41, 0x0d42, 0x0d43, 0x0d44, 0x0d45, 0x0d46, 0x0d47,</span>
<a href="#l6.772"></a><span id="l6.772" class="difflineplus">+    0x0d48, 0x0d49, 0x0d46, 0x0d47, 0x0d46, 0x0d4d, 0x0d4e, 0x0d4f,</span>
<a href="#l6.773"></a><span id="l6.773" class="difflineplus">+    0x0d50, 0x0d51, 0x0d52, 0x0d53, 0x0d54, 0x0d55, 0x0d56, 0x0d57,</span>
<a href="#l6.774"></a><span id="l6.774" class="difflineplus">+    0x0d58, 0x0d59, 0x0d5a, 0x0d5b, 0x0d5c, 0x0d5d, 0x0d5e, 0x0d5f,</span>
<a href="#l6.775"></a><span id="l6.775" class="difflineplus">+    0x0d60, 0x0d61, 0x0d62, 0x0d63, 0x0d64, 0x0d65, 0x0d66, 0x0d67,</span>
<a href="#l6.776"></a><span id="l6.776" class="difflineplus">+    0x0d68, 0x0d69, 0x0d6a, 0x0d6b, 0x0d6c, 0x0d6d, 0x0d6e, 0x0d6f,</span>
<a href="#l6.777"></a><span id="l6.777" class="difflineplus">+    0x0d70, 0x0d71, 0x0d72, 0x0d73, 0x0d74, 0x0d75, 0x0d76, 0x0d77,</span>
<a href="#l6.778"></a><span id="l6.778" class="difflineplus">+    0x0d78, 0x0d79, 0x0d7a, 0x0d7b, 0x0d7c, 0x0d7d, 0x0d7e, 0x0d7f,</span>
<a href="#l6.779"></a><span id="l6.779" class="difflineplus">+};</span>
<a href="#l6.780"></a><span id="l6.780"> </span>
<a href="#l6.781"></a><span id="l6.781"> static const unsigned short gNormalizeTable0dc0[] = {</span>
<a href="#l6.782"></a><span id="l6.782" class="difflineminus">-	/* U+0dc0 */</span>
<a href="#l6.783"></a><span id="l6.783" class="difflineminus">-	0x0dc0, 0x0dc1, 0x0dc2, 0x0dc3, 0x0dc4, 0x0dc5, 0x0dc6, 0x0dc7, </span>
<a href="#l6.784"></a><span id="l6.784" class="difflineminus">-	0x0dc8, 0x0dc9, 0x0dca, 0x0dcb, 0x0dcc, 0x0dcd, 0x0dce, 0x0dcf, </span>
<a href="#l6.785"></a><span id="l6.785" class="difflineminus">-	0x0dd0, 0x0dd1, 0x0dd2, 0x0dd3, 0x0dd4, 0x0dd5, 0x0dd6, 0x0dd7, </span>
<a href="#l6.786"></a><span id="l6.786" class="difflineminus">-	0x0dd8, 0x0dd9, 0x0dd9, 0x0ddb, 0x0dd9, 0x0dd9, 0x0dd9, 0x0ddf, </span>
<a href="#l6.787"></a><span id="l6.787" class="difflineminus">-	0x0de0, 0x0de1, 0x0de2, 0x0de3, 0x0de4, 0x0de5, 0x0de6, 0x0de7, </span>
<a href="#l6.788"></a><span id="l6.788" class="difflineminus">-	0x0de8, 0x0de9, 0x0dea, 0x0deb, 0x0dec, 0x0ded, 0x0dee, 0x0def, </span>
<a href="#l6.789"></a><span id="l6.789" class="difflineminus">-	0x0df0, 0x0df1, 0x0df2, 0x0df3, 0x0df4, 0x0df5, 0x0df6, 0x0df7, </span>
<a href="#l6.790"></a><span id="l6.790" class="difflineminus">-	0x0df8, 0x0df9, 0x0dfa, 0x0dfb, 0x0dfc, 0x0dfd, 0x0dfe, 0x0dff, </span>
<a href="#l6.791"></a><span id="l6.791" class="difflineminus">-	};</span>
<a href="#l6.792"></a><span id="l6.792" class="difflineplus">+    /* U+0dc0 */</span>
<a href="#l6.793"></a><span id="l6.793" class="difflineplus">+    0x0dc0, 0x0dc1, 0x0dc2, 0x0dc3, 0x0dc4, 0x0dc5, 0x0dc6, 0x0dc7,</span>
<a href="#l6.794"></a><span id="l6.794" class="difflineplus">+    0x0dc8, 0x0dc9, 0x0dca, 0x0dcb, 0x0dcc, 0x0dcd, 0x0dce, 0x0dcf,</span>
<a href="#l6.795"></a><span id="l6.795" class="difflineplus">+    0x0dd0, 0x0dd1, 0x0dd2, 0x0dd3, 0x0dd4, 0x0dd5, 0x0dd6, 0x0dd7,</span>
<a href="#l6.796"></a><span id="l6.796" class="difflineplus">+    0x0dd8, 0x0dd9, 0x0dd9, 0x0ddb, 0x0dd9, 0x0dd9, 0x0dd9, 0x0ddf,</span>
<a href="#l6.797"></a><span id="l6.797" class="difflineplus">+    0x0de0, 0x0de1, 0x0de2, 0x0de3, 0x0de4, 0x0de5, 0x0de6, 0x0de7,</span>
<a href="#l6.798"></a><span id="l6.798" class="difflineplus">+    0x0de8, 0x0de9, 0x0dea, 0x0deb, 0x0dec, 0x0ded, 0x0dee, 0x0def,</span>
<a href="#l6.799"></a><span id="l6.799" class="difflineplus">+    0x0df0, 0x0df1, 0x0df2, 0x0df3, 0x0df4, 0x0df5, 0x0df6, 0x0df7,</span>
<a href="#l6.800"></a><span id="l6.800" class="difflineplus">+    0x0df8, 0x0df9, 0x0dfa, 0x0dfb, 0x0dfc, 0x0dfd, 0x0dfe, 0x0dff,</span>
<a href="#l6.801"></a><span id="l6.801" class="difflineplus">+};</span>
<a href="#l6.802"></a><span id="l6.802"> </span>
<a href="#l6.803"></a><span id="l6.803"> static const unsigned short gNormalizeTable0e00[] = {</span>
<a href="#l6.804"></a><span id="l6.804" class="difflineminus">-	/* U+0e00 */</span>
<a href="#l6.805"></a><span id="l6.805" class="difflineminus">-	0x0e00, 0x0e01, 0x0e02, 0x0e03, 0x0e04, 0x0e05, 0x0e06, 0x0e07, </span>
<a href="#l6.806"></a><span id="l6.806" class="difflineminus">-	0x0e08, 0x0e09, 0x0e0a, 0x0e0b, 0x0e0c, 0x0e0d, 0x0e0e, 0x0e0f, </span>
<a href="#l6.807"></a><span id="l6.807" class="difflineminus">-	0x0e10, 0x0e11, 0x0e12, 0x0e13, 0x0e14, 0x0e15, 0x0e16, 0x0e17, </span>
<a href="#l6.808"></a><span id="l6.808" class="difflineminus">-	0x0e18, 0x0e19, 0x0e1a, 0x0e1b, 0x0e1c, 0x0e1d, 0x0e1e, 0x0e1f, </span>
<a href="#l6.809"></a><span id="l6.809" class="difflineminus">-	0x0e20, 0x0e21, 0x0e22, 0x0e23, 0x0e24, 0x0e25, 0x0e26, 0x0e27, </span>
<a href="#l6.810"></a><span id="l6.810" class="difflineminus">-	0x0e28, 0x0e29, 0x0e2a, 0x0e2b, 0x0e2c, 0x0e2d, 0x0e2e, 0x0e2f, </span>
<a href="#l6.811"></a><span id="l6.811" class="difflineminus">-	0x0e30, 0x0e31, 0x0e32, 0x0e4d, 0x0e34, 0x0e35, 0x0e36, 0x0e37, </span>
<a href="#l6.812"></a><span id="l6.812" class="difflineminus">-	0x0e38, 0x0e39, 0x0e3a, 0x0e3b, 0x0e3c, 0x0e3d, 0x0e3e, 0x0e3f, </span>
<a href="#l6.813"></a><span id="l6.813" class="difflineminus">-	};</span>
<a href="#l6.814"></a><span id="l6.814" class="difflineplus">+    /* U+0e00 */</span>
<a href="#l6.815"></a><span id="l6.815" class="difflineplus">+    0x0e00, 0x0e01, 0x0e02, 0x0e03, 0x0e04, 0x0e05, 0x0e06, 0x0e07,</span>
<a href="#l6.816"></a><span id="l6.816" class="difflineplus">+    0x0e08, 0x0e09, 0x0e0a, 0x0e0b, 0x0e0c, 0x0e0d, 0x0e0e, 0x0e0f,</span>
<a href="#l6.817"></a><span id="l6.817" class="difflineplus">+    0x0e10, 0x0e11, 0x0e12, 0x0e13, 0x0e14, 0x0e15, 0x0e16, 0x0e17,</span>
<a href="#l6.818"></a><span id="l6.818" class="difflineplus">+    0x0e18, 0x0e19, 0x0e1a, 0x0e1b, 0x0e1c, 0x0e1d, 0x0e1e, 0x0e1f,</span>
<a href="#l6.819"></a><span id="l6.819" class="difflineplus">+    0x0e20, 0x0e21, 0x0e22, 0x0e23, 0x0e24, 0x0e25, 0x0e26, 0x0e27,</span>
<a href="#l6.820"></a><span id="l6.820" class="difflineplus">+    0x0e28, 0x0e29, 0x0e2a, 0x0e2b, 0x0e2c, 0x0e2d, 0x0e2e, 0x0e2f,</span>
<a href="#l6.821"></a><span id="l6.821" class="difflineplus">+    0x0e30, 0x0e31, 0x0e32, 0x0e4d, 0x0e34, 0x0e35, 0x0e36, 0x0e37,</span>
<a href="#l6.822"></a><span id="l6.822" class="difflineplus">+    0x0e38, 0x0e39, 0x0e3a, 0x0e3b, 0x0e3c, 0x0e3d, 0x0e3e, 0x0e3f,</span>
<a href="#l6.823"></a><span id="l6.823" class="difflineplus">+};</span>
<a href="#l6.824"></a><span id="l6.824"> </span>
<a href="#l6.825"></a><span id="l6.825"> static const unsigned short gNormalizeTable0e80[] = {</span>
<a href="#l6.826"></a><span id="l6.826" class="difflineminus">-	/* U+0e80 */</span>
<a href="#l6.827"></a><span id="l6.827" class="difflineminus">-	0x0e80, 0x0e81, 0x0e82, 0x0e83, 0x0e84, 0x0e85, 0x0e86, 0x0e87, </span>
<a href="#l6.828"></a><span id="l6.828" class="difflineminus">-	0x0e88, 0x0e89, 0x0e8a, 0x0e8b, 0x0e8c, 0x0e8d, 0x0e8e, 0x0e8f, </span>
<a href="#l6.829"></a><span id="l6.829" class="difflineminus">-	0x0e90, 0x0e91, 0x0e92, 0x0e93, 0x0e94, 0x0e95, 0x0e96, 0x0e97, </span>
<a href="#l6.830"></a><span id="l6.830" class="difflineminus">-	0x0e98, 0x0e99, 0x0e9a, 0x0e9b, 0x0e9c, 0x0e9d, 0x0e9e, 0x0e9f, </span>
<a href="#l6.831"></a><span id="l6.831" class="difflineminus">-	0x0ea0, 0x0ea1, 0x0ea2, 0x0ea3, 0x0ea4, 0x0ea5, 0x0ea6, 0x0ea7, </span>
<a href="#l6.832"></a><span id="l6.832" class="difflineminus">-	0x0ea8, 0x0ea9, 0x0eaa, 0x0eab, 0x0eac, 0x0ead, 0x0eae, 0x0eaf, </span>
<a href="#l6.833"></a><span id="l6.833" class="difflineminus">-	0x0eb0, 0x0eb1, 0x0eb2, 0x0ecd, 0x0eb4, 0x0eb5, 0x0eb6, 0x0eb7, </span>
<a href="#l6.834"></a><span id="l6.834" class="difflineminus">-	0x0eb8, 0x0eb9, 0x0eba, 0x0ebb, 0x0ebc, 0x0ebd, 0x0ebe, 0x0ebf, </span>
<a href="#l6.835"></a><span id="l6.835" class="difflineminus">-	};</span>
<a href="#l6.836"></a><span id="l6.836" class="difflineplus">+    /* U+0e80 */</span>
<a href="#l6.837"></a><span id="l6.837" class="difflineplus">+    0x0e80, 0x0e81, 0x0e82, 0x0e83, 0x0e84, 0x0e85, 0x0e86, 0x0e87,</span>
<a href="#l6.838"></a><span id="l6.838" class="difflineplus">+    0x0e88, 0x0e89, 0x0e8a, 0x0e8b, 0x0e8c, 0x0e8d, 0x0e8e, 0x0e8f,</span>
<a href="#l6.839"></a><span id="l6.839" class="difflineplus">+    0x0e90, 0x0e91, 0x0e92, 0x0e93, 0x0e94, 0x0e95, 0x0e96, 0x0e97,</span>
<a href="#l6.840"></a><span id="l6.840" class="difflineplus">+    0x0e98, 0x0e99, 0x0e9a, 0x0e9b, 0x0e9c, 0x0e9d, 0x0e9e, 0x0e9f,</span>
<a href="#l6.841"></a><span id="l6.841" class="difflineplus">+    0x0ea0, 0x0ea1, 0x0ea2, 0x0ea3, 0x0ea4, 0x0ea5, 0x0ea6, 0x0ea7,</span>
<a href="#l6.842"></a><span id="l6.842" class="difflineplus">+    0x0ea8, 0x0ea9, 0x0eaa, 0x0eab, 0x0eac, 0x0ead, 0x0eae, 0x0eaf,</span>
<a href="#l6.843"></a><span id="l6.843" class="difflineplus">+    0x0eb0, 0x0eb1, 0x0eb2, 0x0ecd, 0x0eb4, 0x0eb5, 0x0eb6, 0x0eb7,</span>
<a href="#l6.844"></a><span id="l6.844" class="difflineplus">+    0x0eb8, 0x0eb9, 0x0eba, 0x0ebb, 0x0ebc, 0x0ebd, 0x0ebe, 0x0ebf,</span>
<a href="#l6.845"></a><span id="l6.845" class="difflineplus">+};</span>
<a href="#l6.846"></a><span id="l6.846"> </span>
<a href="#l6.847"></a><span id="l6.847"> static const unsigned short gNormalizeTable0ec0[] = {</span>
<a href="#l6.848"></a><span id="l6.848" class="difflineminus">-	/* U+0ec0 */</span>
<a href="#l6.849"></a><span id="l6.849" class="difflineminus">-	0x0ec0, 0x0ec1, 0x0ec2, 0x0ec3, 0x0ec4, 0x0ec5, 0x0ec6, 0x0ec7, </span>
<a href="#l6.850"></a><span id="l6.850" class="difflineminus">-	0x0ec8, 0x0ec9, 0x0eca, 0x0ecb, 0x0ecc, 0x0ecd, 0x0ece, 0x0ecf, </span>
<a href="#l6.851"></a><span id="l6.851" class="difflineminus">-	0x0ed0, 0x0ed1, 0x0ed2, 0x0ed3, 0x0ed4, 0x0ed5, 0x0ed6, 0x0ed7, </span>
<a href="#l6.852"></a><span id="l6.852" class="difflineminus">-	0x0ed8, 0x0ed9, 0x0eda, 0x0edb, 0x0eab, 0x0eab, 0x0ede, 0x0edf, </span>
<a href="#l6.853"></a><span id="l6.853" class="difflineminus">-	0x0ee0, 0x0ee1, 0x0ee2, 0x0ee3, 0x0ee4, 0x0ee5, 0x0ee6, 0x0ee7, </span>
<a href="#l6.854"></a><span id="l6.854" class="difflineminus">-	0x0ee8, 0x0ee9, 0x0eea, 0x0eeb, 0x0eec, 0x0eed, 0x0eee, 0x0eef, </span>
<a href="#l6.855"></a><span id="l6.855" class="difflineminus">-	0x0ef0, 0x0ef1, 0x0ef2, 0x0ef3, 0x0ef4, 0x0ef5, 0x0ef6, 0x0ef7, </span>
<a href="#l6.856"></a><span id="l6.856" class="difflineminus">-	0x0ef8, 0x0ef9, 0x0efa, 0x0efb, 0x0efc, 0x0efd, 0x0efe, 0x0eff, </span>
<a href="#l6.857"></a><span id="l6.857" class="difflineminus">-	};</span>
<a href="#l6.858"></a><span id="l6.858" class="difflineplus">+    /* U+0ec0 */</span>
<a href="#l6.859"></a><span id="l6.859" class="difflineplus">+    0x0ec0, 0x0ec1, 0x0ec2, 0x0ec3, 0x0ec4, 0x0ec5, 0x0ec6, 0x0ec7,</span>
<a href="#l6.860"></a><span id="l6.860" class="difflineplus">+    0x0ec8, 0x0ec9, 0x0eca, 0x0ecb, 0x0ecc, 0x0ecd, 0x0ece, 0x0ecf,</span>
<a href="#l6.861"></a><span id="l6.861" class="difflineplus">+    0x0ed0, 0x0ed1, 0x0ed2, 0x0ed3, 0x0ed4, 0x0ed5, 0x0ed6, 0x0ed7,</span>
<a href="#l6.862"></a><span id="l6.862" class="difflineplus">+    0x0ed8, 0x0ed9, 0x0eda, 0x0edb, 0x0eab, 0x0eab, 0x0ede, 0x0edf,</span>
<a href="#l6.863"></a><span id="l6.863" class="difflineplus">+    0x0ee0, 0x0ee1, 0x0ee2, 0x0ee3, 0x0ee4, 0x0ee5, 0x0ee6, 0x0ee7,</span>
<a href="#l6.864"></a><span id="l6.864" class="difflineplus">+    0x0ee8, 0x0ee9, 0x0eea, 0x0eeb, 0x0eec, 0x0eed, 0x0eee, 0x0eef,</span>
<a href="#l6.865"></a><span id="l6.865" class="difflineplus">+    0x0ef0, 0x0ef1, 0x0ef2, 0x0ef3, 0x0ef4, 0x0ef5, 0x0ef6, 0x0ef7,</span>
<a href="#l6.866"></a><span id="l6.866" class="difflineplus">+    0x0ef8, 0x0ef9, 0x0efa, 0x0efb, 0x0efc, 0x0efd, 0x0efe, 0x0eff,</span>
<a href="#l6.867"></a><span id="l6.867" class="difflineplus">+};</span>
<a href="#l6.868"></a><span id="l6.868"> </span>
<a href="#l6.869"></a><span id="l6.869"> static const unsigned short gNormalizeTable0f00[] = {</span>
<a href="#l6.870"></a><span id="l6.870" class="difflineminus">-	/* U+0f00 */</span>
<a href="#l6.871"></a><span id="l6.871" class="difflineminus">-	0x0f00, 0x0f01, 0x0f02, 0x0f03, 0x0f04, 0x0f05, 0x0f06, 0x0f07, </span>
<a href="#l6.872"></a><span id="l6.872" class="difflineminus">-	0x0f08, 0x0f09, 0x0f0a, 0x0f0b, 0x0f0b, 0x0f0d, 0x0f0e, 0x0f0f, </span>
<a href="#l6.873"></a><span id="l6.873" class="difflineminus">-	0x0f10, 0x0f11, 0x0f12, 0x0f13, 0x0f14, 0x0f15, 0x0f16, 0x0f17, </span>
<a href="#l6.874"></a><span id="l6.874" class="difflineminus">-	0x0f18, 0x0f19, 0x0f1a, 0x0f1b, 0x0f1c, 0x0f1d, 0x0f1e, 0x0f1f, </span>
<a href="#l6.875"></a><span id="l6.875" class="difflineminus">-	0x0f20, 0x0f21, 0x0f22, 0x0f23, 0x0f24, 0x0f25, 0x0f26, 0x0f27, </span>
<a href="#l6.876"></a><span id="l6.876" class="difflineminus">-	0x0f28, 0x0f29, 0x0f2a, 0x0f2b, 0x0f2c, 0x0f2d, 0x0f2e, 0x0f2f, </span>
<a href="#l6.877"></a><span id="l6.877" class="difflineminus">-	0x0f30, 0x0f31, 0x0f32, 0x0f33, 0x0f34, 0x0f35, 0x0f36, 0x0f37, </span>
<a href="#l6.878"></a><span id="l6.878" class="difflineminus">-	0x0f38, 0x0f39, 0x0f3a, 0x0f3b, 0x0f3c, 0x0f3d, 0x0f3e, 0x0f3f, </span>
<a href="#l6.879"></a><span id="l6.879" class="difflineminus">-	};</span>
<a href="#l6.880"></a><span id="l6.880" class="difflineplus">+    /* U+0f00 */</span>
<a href="#l6.881"></a><span id="l6.881" class="difflineplus">+    0x0f00, 0x0f01, 0x0f02, 0x0f03, 0x0f04, 0x0f05, 0x0f06, 0x0f07,</span>
<a href="#l6.882"></a><span id="l6.882" class="difflineplus">+    0x0f08, 0x0f09, 0x0f0a, 0x0f0b, 0x0f0b, 0x0f0d, 0x0f0e, 0x0f0f,</span>
<a href="#l6.883"></a><span id="l6.883" class="difflineplus">+    0x0f10, 0x0f11, 0x0f12, 0x0f13, 0x0f14, 0x0f15, 0x0f16, 0x0f17,</span>
<a href="#l6.884"></a><span id="l6.884" class="difflineplus">+    0x0f18, 0x0f19, 0x0f1a, 0x0f1b, 0x0f1c, 0x0f1d, 0x0f1e, 0x0f1f,</span>
<a href="#l6.885"></a><span id="l6.885" class="difflineplus">+    0x0f20, 0x0f21, 0x0f22, 0x0f23, 0x0f24, 0x0f25, 0x0f26, 0x0f27,</span>
<a href="#l6.886"></a><span id="l6.886" class="difflineplus">+    0x0f28, 0x0f29, 0x0f2a, 0x0f2b, 0x0f2c, 0x0f2d, 0x0f2e, 0x0f2f,</span>
<a href="#l6.887"></a><span id="l6.887" class="difflineplus">+    0x0f30, 0x0f31, 0x0f32, 0x0f33, 0x0f34, 0x0f35, 0x0f36, 0x0f37,</span>
<a href="#l6.888"></a><span id="l6.888" class="difflineplus">+    0x0f38, 0x0f39, 0x0f3a, 0x0f3b, 0x0f3c, 0x0f3d, 0x0f3e, 0x0f3f,</span>
<a href="#l6.889"></a><span id="l6.889" class="difflineplus">+};</span>
<a href="#l6.890"></a><span id="l6.890"> </span>
<a href="#l6.891"></a><span id="l6.891"> static const unsigned short gNormalizeTable0f40[] = {</span>
<a href="#l6.892"></a><span id="l6.892" class="difflineminus">-	/* U+0f40 */</span>
<a href="#l6.893"></a><span id="l6.893" class="difflineminus">-	0x0f40, 0x0f41, 0x0f42, 0x0f42, 0x0f44, 0x0f45, 0x0f46, 0x0f47, </span>
<a href="#l6.894"></a><span id="l6.894" class="difflineminus">-	0x0f48, 0x0f49, 0x0f4a, 0x0f4b, 0x0f4c, 0x0f4c, 0x0f4e, 0x0f4f, </span>
<a href="#l6.895"></a><span id="l6.895" class="difflineminus">-	0x0f50, 0x0f51, 0x0f51, 0x0f53, 0x0f54, 0x0f55, 0x0f56, 0x0f56, </span>
<a href="#l6.896"></a><span id="l6.896" class="difflineminus">-	0x0f58, 0x0f59, 0x0f5a, 0x0f5b, 0x0f5b, 0x0f5d, 0x0f5e, 0x0f5f, </span>
<a href="#l6.897"></a><span id="l6.897" class="difflineminus">-	0x0f60, 0x0f61, 0x0f62, 0x0f63, 0x0f64, 0x0f65, 0x0f66, 0x0f67, </span>
<a href="#l6.898"></a><span id="l6.898" class="difflineminus">-	0x0f68, 0x0f40, 0x0f6a, 0x0f6b, 0x0f6c, 0x0f6d, 0x0f6e, 0x0f6f, </span>
<a href="#l6.899"></a><span id="l6.899" class="difflineminus">-	0x0f70, 0x0f71, 0x0f72, 0x0f71, 0x0f74, 0x0f71, 0x0fb2, 0x0fb2, </span>
<a href="#l6.900"></a><span id="l6.900" class="difflineminus">-	0x0fb3, 0x0fb3, 0x0f7a, 0x0f7b, 0x0f7c, 0x0f7d, 0x0f7e, 0x0f7f, </span>
<a href="#l6.901"></a><span id="l6.901" class="difflineminus">-	};</span>
<a href="#l6.902"></a><span id="l6.902" class="difflineplus">+    /* U+0f40 */</span>
<a href="#l6.903"></a><span id="l6.903" class="difflineplus">+    0x0f40, 0x0f41, 0x0f42, 0x0f42, 0x0f44, 0x0f45, 0x0f46, 0x0f47,</span>
<a href="#l6.904"></a><span id="l6.904" class="difflineplus">+    0x0f48, 0x0f49, 0x0f4a, 0x0f4b, 0x0f4c, 0x0f4c, 0x0f4e, 0x0f4f,</span>
<a href="#l6.905"></a><span id="l6.905" class="difflineplus">+    0x0f50, 0x0f51, 0x0f51, 0x0f53, 0x0f54, 0x0f55, 0x0f56, 0x0f56,</span>
<a href="#l6.906"></a><span id="l6.906" class="difflineplus">+    0x0f58, 0x0f59, 0x0f5a, 0x0f5b, 0x0f5b, 0x0f5d, 0x0f5e, 0x0f5f,</span>
<a href="#l6.907"></a><span id="l6.907" class="difflineplus">+    0x0f60, 0x0f61, 0x0f62, 0x0f63, 0x0f64, 0x0f65, 0x0f66, 0x0f67,</span>
<a href="#l6.908"></a><span id="l6.908" class="difflineplus">+    0x0f68, 0x0f40, 0x0f6a, 0x0f6b, 0x0f6c, 0x0f6d, 0x0f6e, 0x0f6f,</span>
<a href="#l6.909"></a><span id="l6.909" class="difflineplus">+    0x0f70, 0x0f71, 0x0f72, 0x0f71, 0x0f74, 0x0f71, 0x0fb2, 0x0fb2,</span>
<a href="#l6.910"></a><span id="l6.910" class="difflineplus">+    0x0fb3, 0x0fb3, 0x0f7a, 0x0f7b, 0x0f7c, 0x0f7d, 0x0f7e, 0x0f7f,</span>
<a href="#l6.911"></a><span id="l6.911" class="difflineplus">+};</span>
<a href="#l6.912"></a><span id="l6.912"> </span>
<a href="#l6.913"></a><span id="l6.913"> static const unsigned short gNormalizeTable0f80[] = {</span>
<a href="#l6.914"></a><span id="l6.914" class="difflineminus">-	/* U+0f80 */</span>
<a href="#l6.915"></a><span id="l6.915" class="difflineminus">-	0x0f80, 0x0f71, 0x0f82, 0x0f83, 0x0f84, 0x0f85, 0x0f86, 0x0f87, </span>
<a href="#l6.916"></a><span id="l6.916" class="difflineminus">-	0x0f88, 0x0f89, 0x0f8a, 0x0f8b, 0x0f8c, 0x0f8d, 0x0f8e, 0x0f8f, </span>
<a href="#l6.917"></a><span id="l6.917" class="difflineminus">-	0x0f90, 0x0f91, 0x0f92, 0x0f92, 0x0f94, 0x0f95, 0x0f96, 0x0f97, </span>
<a href="#l6.918"></a><span id="l6.918" class="difflineminus">-	0x0f98, 0x0f99, 0x0f9a, 0x0f9b, 0x0f9c, 0x0f9c, 0x0f9e, 0x0f9f, </span>
<a href="#l6.919"></a><span id="l6.919" class="difflineminus">-	0x0fa0, 0x0fa1, 0x0fa1, 0x0fa3, 0x0fa4, 0x0fa5, 0x0fa6, 0x0fa6, </span>
<a href="#l6.920"></a><span id="l6.920" class="difflineminus">-	0x0fa8, 0x0fa9, 0x0faa, 0x0fab, 0x0fab, 0x0fad, 0x0fae, 0x0faf, </span>
<a href="#l6.921"></a><span id="l6.921" class="difflineminus">-	0x0fb0, 0x0fb1, 0x0fb2, 0x0fb3, 0x0fb4, 0x0fb5, 0x0fb6, 0x0fb7, </span>
<a href="#l6.922"></a><span id="l6.922" class="difflineminus">-	0x0fb8, 0x0f90, 0x0fba, 0x0fbb, 0x0fbc, 0x0fbd, 0x0fbe, 0x0fbf, </span>
<a href="#l6.923"></a><span id="l6.923" class="difflineminus">-	};</span>
<a href="#l6.924"></a><span id="l6.924" class="difflineplus">+    /* U+0f80 */</span>
<a href="#l6.925"></a><span id="l6.925" class="difflineplus">+    0x0f80, 0x0f71, 0x0f82, 0x0f83, 0x0f84, 0x0f85, 0x0f86, 0x0f87,</span>
<a href="#l6.926"></a><span id="l6.926" class="difflineplus">+    0x0f88, 0x0f89, 0x0f8a, 0x0f8b, 0x0f8c, 0x0f8d, 0x0f8e, 0x0f8f,</span>
<a href="#l6.927"></a><span id="l6.927" class="difflineplus">+    0x0f90, 0x0f91, 0x0f92, 0x0f92, 0x0f94, 0x0f95, 0x0f96, 0x0f97,</span>
<a href="#l6.928"></a><span id="l6.928" class="difflineplus">+    0x0f98, 0x0f99, 0x0f9a, 0x0f9b, 0x0f9c, 0x0f9c, 0x0f9e, 0x0f9f,</span>
<a href="#l6.929"></a><span id="l6.929" class="difflineplus">+    0x0fa0, 0x0fa1, 0x0fa1, 0x0fa3, 0x0fa4, 0x0fa5, 0x0fa6, 0x0fa6,</span>
<a href="#l6.930"></a><span id="l6.930" class="difflineplus">+    0x0fa8, 0x0fa9, 0x0faa, 0x0fab, 0x0fab, 0x0fad, 0x0fae, 0x0faf,</span>
<a href="#l6.931"></a><span id="l6.931" class="difflineplus">+    0x0fb0, 0x0fb1, 0x0fb2, 0x0fb3, 0x0fb4, 0x0fb5, 0x0fb6, 0x0fb7,</span>
<a href="#l6.932"></a><span id="l6.932" class="difflineplus">+    0x0fb8, 0x0f90, 0x0fba, 0x0fbb, 0x0fbc, 0x0fbd, 0x0fbe, 0x0fbf,</span>
<a href="#l6.933"></a><span id="l6.933" class="difflineplus">+};</span>
<a href="#l6.934"></a><span id="l6.934"> </span>
<a href="#l6.935"></a><span id="l6.935"> static const unsigned short gNormalizeTable1000[] = {</span>
<a href="#l6.936"></a><span id="l6.936" class="difflineminus">-	/* U+1000 */</span>
<a href="#l6.937"></a><span id="l6.937" class="difflineminus">-	0x1000, 0x1001, 0x1002, 0x1003, 0x1004, 0x1005, 0x1006, 0x1007, </span>
<a href="#l6.938"></a><span id="l6.938" class="difflineminus">-	0x1008, 0x1009, 0x100a, 0x100b, 0x100c, 0x100d, 0x100e, 0x100f, </span>
<a href="#l6.939"></a><span id="l6.939" class="difflineminus">-	0x1010, 0x1011, 0x1012, 0x1013, 0x1014, 0x1015, 0x1016, 0x1017, </span>
<a href="#l6.940"></a><span id="l6.940" class="difflineminus">-	0x1018, 0x1019, 0x101a, 0x101b, 0x101c, 0x101d, 0x101e, 0x101f, </span>
<a href="#l6.941"></a><span id="l6.941" class="difflineminus">-	0x1020, 0x1021, 0x1022, 0x1023, 0x1024, 0x1025, 0x1025, 0x1027, </span>
<a href="#l6.942"></a><span id="l6.942" class="difflineminus">-	0x1028, 0x1029, 0x102a, 0x102b, 0x102c, 0x102d, 0x102e, 0x102f, </span>
<a href="#l6.943"></a><span id="l6.943" class="difflineminus">-	0x1030, 0x1031, 0x1032, 0x1033, 0x1034, 0x1035, 0x1036, 0x1037, </span>
<a href="#l6.944"></a><span id="l6.944" class="difflineminus">-	0x1038, 0x1039, 0x103a, 0x103b, 0x103c, 0x103d, 0x103e, 0x103f, </span>
<a href="#l6.945"></a><span id="l6.945" class="difflineminus">-	};</span>
<a href="#l6.946"></a><span id="l6.946" class="difflineplus">+    /* U+1000 */</span>
<a href="#l6.947"></a><span id="l6.947" class="difflineplus">+    0x1000, 0x1001, 0x1002, 0x1003, 0x1004, 0x1005, 0x1006, 0x1007,</span>
<a href="#l6.948"></a><span id="l6.948" class="difflineplus">+    0x1008, 0x1009, 0x100a, 0x100b, 0x100c, 0x100d, 0x100e, 0x100f,</span>
<a href="#l6.949"></a><span id="l6.949" class="difflineplus">+    0x1010, 0x1011, 0x1012, 0x1013, 0x1014, 0x1015, 0x1016, 0x1017,</span>
<a href="#l6.950"></a><span id="l6.950" class="difflineplus">+    0x1018, 0x1019, 0x101a, 0x101b, 0x101c, 0x101d, 0x101e, 0x101f,</span>
<a href="#l6.951"></a><span id="l6.951" class="difflineplus">+    0x1020, 0x1021, 0x1022, 0x1023, 0x1024, 0x1025, 0x1025, 0x1027,</span>
<a href="#l6.952"></a><span id="l6.952" class="difflineplus">+    0x1028, 0x1029, 0x102a, 0x102b, 0x102c, 0x102d, 0x102e, 0x102f,</span>
<a href="#l6.953"></a><span id="l6.953" class="difflineplus">+    0x1030, 0x1031, 0x1032, 0x1033, 0x1034, 0x1035, 0x1036, 0x1037,</span>
<a href="#l6.954"></a><span id="l6.954" class="difflineplus">+    0x1038, 0x1039, 0x103a, 0x103b, 0x103c, 0x103d, 0x103e, 0x103f,</span>
<a href="#l6.955"></a><span id="l6.955" class="difflineplus">+};</span>
<a href="#l6.956"></a><span id="l6.956"> </span>
<a href="#l6.957"></a><span id="l6.957"> static const unsigned short gNormalizeTable1080[] = {</span>
<a href="#l6.958"></a><span id="l6.958" class="difflineminus">-	/* U+1080 */</span>
<a href="#l6.959"></a><span id="l6.959" class="difflineminus">-	0x1080, 0x1081, 0x1082, 0x1083, 0x1084, 0x1085, 0x1086, 0x1087, </span>
<a href="#l6.960"></a><span id="l6.960" class="difflineminus">-	0x1088, 0x1089, 0x108a, 0x108b, 0x108c, 0x108d, 0x108e, 0x108f, </span>
<a href="#l6.961"></a><span id="l6.961" class="difflineminus">-	0x1090, 0x1091, 0x1092, 0x1093, 0x1094, 0x1095, 0x1096, 0x1097, </span>
<a href="#l6.962"></a><span id="l6.962" class="difflineminus">-	0x1098, 0x1099, 0x109a, 0x109b, 0x109c, 0x109d, 0x109e, 0x109f, </span>
<a href="#l6.963"></a><span id="l6.963" class="difflineminus">-	0x2d00, 0x2d01, 0x2d02, 0x2d03, 0x2d04, 0x2d05, 0x2d06, 0x2d07, </span>
<a href="#l6.964"></a><span id="l6.964" class="difflineminus">-	0x2d08, 0x2d09, 0x2d0a, 0x2d0b, 0x2d0c, 0x2d0d, 0x2d0e, 0x2d0f, </span>
<a href="#l6.965"></a><span id="l6.965" class="difflineminus">-	0x2d10, 0x2d11, 0x2d12, 0x2d13, 0x2d14, 0x2d15, 0x2d16, 0x2d17, </span>
<a href="#l6.966"></a><span id="l6.966" class="difflineminus">-	0x2d18, 0x2d19, 0x2d1a, 0x2d1b, 0x2d1c, 0x2d1d, 0x2d1e, 0x2d1f, </span>
<a href="#l6.967"></a><span id="l6.967" class="difflineminus">-	};</span>
<a href="#l6.968"></a><span id="l6.968" class="difflineplus">+    /* U+1080 */</span>
<a href="#l6.969"></a><span id="l6.969" class="difflineplus">+    0x1080, 0x1081, 0x1082, 0x1083, 0x1084, 0x1085, 0x1086, 0x1087,</span>
<a href="#l6.970"></a><span id="l6.970" class="difflineplus">+    0x1088, 0x1089, 0x108a, 0x108b, 0x108c, 0x108d, 0x108e, 0x108f,</span>
<a href="#l6.971"></a><span id="l6.971" class="difflineplus">+    0x1090, 0x1091, 0x1092, 0x1093, 0x1094, 0x1095, 0x1096, 0x1097,</span>
<a href="#l6.972"></a><span id="l6.972" class="difflineplus">+    0x1098, 0x1099, 0x109a, 0x109b, 0x109c, 0x109d, 0x109e, 0x109f,</span>
<a href="#l6.973"></a><span id="l6.973" class="difflineplus">+    0x2d00, 0x2d01, 0x2d02, 0x2d03, 0x2d04, 0x2d05, 0x2d06, 0x2d07,</span>
<a href="#l6.974"></a><span id="l6.974" class="difflineplus">+    0x2d08, 0x2d09, 0x2d0a, 0x2d0b, 0x2d0c, 0x2d0d, 0x2d0e, 0x2d0f,</span>
<a href="#l6.975"></a><span id="l6.975" class="difflineplus">+    0x2d10, 0x2d11, 0x2d12, 0x2d13, 0x2d14, 0x2d15, 0x2d16, 0x2d17,</span>
<a href="#l6.976"></a><span id="l6.976" class="difflineplus">+    0x2d18, 0x2d19, 0x2d1a, 0x2d1b, 0x2d1c, 0x2d1d, 0x2d1e, 0x2d1f,</span>
<a href="#l6.977"></a><span id="l6.977" class="difflineplus">+};</span>
<a href="#l6.978"></a><span id="l6.978"> </span>
<a href="#l6.979"></a><span id="l6.979"> static const unsigned short gNormalizeTable10c0[] = {</span>
<a href="#l6.980"></a><span id="l6.980" class="difflineminus">-	/* U+10c0 */</span>
<a href="#l6.981"></a><span id="l6.981" class="difflineminus">-	0x2d20, 0x2d21, 0x2d22, 0x2d23, 0x2d24, 0x2d25, 0x10c6, 0x10c7, </span>
<a href="#l6.982"></a><span id="l6.982" class="difflineminus">-	0x10c8, 0x10c9, 0x10ca, 0x10cb, 0x10cc, 0x10cd, 0x10ce, 0x10cf, </span>
<a href="#l6.983"></a><span id="l6.983" class="difflineminus">-	0x10d0, 0x10d1, 0x10d2, 0x10d3, 0x10d4, 0x10d5, 0x10d6, 0x10d7, </span>
<a href="#l6.984"></a><span id="l6.984" class="difflineminus">-	0x10d8, 0x10d9, 0x10da, 0x10db, 0x10dc, 0x10dd, 0x10de, 0x10df, </span>
<a href="#l6.985"></a><span id="l6.985" class="difflineminus">-	0x10e0, 0x10e1, 0x10e2, 0x10e3, 0x10e4, 0x10e5, 0x10e6, 0x10e7, </span>
<a href="#l6.986"></a><span id="l6.986" class="difflineminus">-	0x10e8, 0x10e9, 0x10ea, 0x10eb, 0x10ec, 0x10ed, 0x10ee, 0x10ef, </span>
<a href="#l6.987"></a><span id="l6.987" class="difflineminus">-	0x10f0, 0x10f1, 0x10f2, 0x10f3, 0x10f4, 0x10f5, 0x10f6, 0x10f7, </span>
<a href="#l6.988"></a><span id="l6.988" class="difflineminus">-	0x10f8, 0x10f9, 0x10fa, 0x10fb, 0x10dc, 0x10fd, 0x10fe, 0x10ff, </span>
<a href="#l6.989"></a><span id="l6.989" class="difflineminus">-	};</span>
<a href="#l6.990"></a><span id="l6.990" class="difflineplus">+    /* U+10c0 */</span>
<a href="#l6.991"></a><span id="l6.991" class="difflineplus">+    0x2d20, 0x2d21, 0x2d22, 0x2d23, 0x2d24, 0x2d25, 0x10c6, 0x10c7,</span>
<a href="#l6.992"></a><span id="l6.992" class="difflineplus">+    0x10c8, 0x10c9, 0x10ca, 0x10cb, 0x10cc, 0x10cd, 0x10ce, 0x10cf,</span>
<a href="#l6.993"></a><span id="l6.993" class="difflineplus">+    0x10d0, 0x10d1, 0x10d2, 0x10d3, 0x10d4, 0x10d5, 0x10d6, 0x10d7,</span>
<a href="#l6.994"></a><span id="l6.994" class="difflineplus">+    0x10d8, 0x10d9, 0x10da, 0x10db, 0x10dc, 0x10dd, 0x10de, 0x10df,</span>
<a href="#l6.995"></a><span id="l6.995" class="difflineplus">+    0x10e0, 0x10e1, 0x10e2, 0x10e3, 0x10e4, 0x10e5, 0x10e6, 0x10e7,</span>
<a href="#l6.996"></a><span id="l6.996" class="difflineplus">+    0x10e8, 0x10e9, 0x10ea, 0x10eb, 0x10ec, 0x10ed, 0x10ee, 0x10ef,</span>
<a href="#l6.997"></a><span id="l6.997" class="difflineplus">+    0x10f0, 0x10f1, 0x10f2, 0x10f3, 0x10f4, 0x10f5, 0x10f6, 0x10f7,</span>
<a href="#l6.998"></a><span id="l6.998" class="difflineplus">+    0x10f8, 0x10f9, 0x10fa, 0x10fb, 0x10dc, 0x10fd, 0x10fe, 0x10ff,</span>
<a href="#l6.999"></a><span id="l6.999" class="difflineplus">+};</span>
<a href="#l6.1000"></a><span id="l6.1000"> </span>
<a href="#l6.1001"></a><span id="l6.1001"> static const unsigned short gNormalizeTable1140[] = {</span>
<a href="#l6.1002"></a><span id="l6.1002" class="difflineminus">-	/* U+1140 */</span>
<a href="#l6.1003"></a><span id="l6.1003" class="difflineminus">-	0x1140, 0x1141, 0x1142, 0x1143, 0x1144, 0x1145, 0x1146, 0x1147, </span>
<a href="#l6.1004"></a><span id="l6.1004" class="difflineminus">-	0x1148, 0x1149, 0x114a, 0x114b, 0x114c, 0x114d, 0x114e, 0x114f, </span>
<a href="#l6.1005"></a><span id="l6.1005" class="difflineminus">-	0x1150, 0x1151, 0x1152, 0x1153, 0x1154, 0x1155, 0x1156, 0x1157, </span>
<a href="#l6.1006"></a><span id="l6.1006" class="difflineminus">-	0x1158, 0x1159, 0x115a, 0x115b, 0x115c, 0x115d, 0x115e, 0x0020, </span>
<a href="#l6.1007"></a><span id="l6.1007" class="difflineminus">-	0x0020, 0x1161, 0x1162, 0x1163, 0x1164, 0x1165, 0x1166, 0x1167, </span>
<a href="#l6.1008"></a><span id="l6.1008" class="difflineminus">-	0x1168, 0x1169, 0x116a, 0x116b, 0x116c, 0x116d, 0x116e, 0x116f, </span>
<a href="#l6.1009"></a><span id="l6.1009" class="difflineminus">-	0x1170, 0x1171, 0x1172, 0x1173, 0x1174, 0x1175, 0x1176, 0x1177, </span>
<a href="#l6.1010"></a><span id="l6.1010" class="difflineminus">-	0x1178, 0x1179, 0x117a, 0x117b, 0x117c, 0x117d, 0x117e, 0x117f, </span>
<a href="#l6.1011"></a><span id="l6.1011" class="difflineminus">-	};</span>
<a href="#l6.1012"></a><span id="l6.1012" class="difflineplus">+    /* U+1140 */</span>
<a href="#l6.1013"></a><span id="l6.1013" class="difflineplus">+    0x1140, 0x1141, 0x1142, 0x1143, 0x1144, 0x1145, 0x1146, 0x1147,</span>
<a href="#l6.1014"></a><span id="l6.1014" class="difflineplus">+    0x1148, 0x1149, 0x114a, 0x114b, 0x114c, 0x114d, 0x114e, 0x114f,</span>
<a href="#l6.1015"></a><span id="l6.1015" class="difflineplus">+    0x1150, 0x1151, 0x1152, 0x1153, 0x1154, 0x1155, 0x1156, 0x1157,</span>
<a href="#l6.1016"></a><span id="l6.1016" class="difflineplus">+    0x1158, 0x1159, 0x115a, 0x115b, 0x115c, 0x115d, 0x115e, 0x0020,</span>
<a href="#l6.1017"></a><span id="l6.1017" class="difflineplus">+    0x0020, 0x1161, 0x1162, 0x1163, 0x1164, 0x1165, 0x1166, 0x1167,</span>
<a href="#l6.1018"></a><span id="l6.1018" class="difflineplus">+    0x1168, 0x1169, 0x116a, 0x116b, 0x116c, 0x116d, 0x116e, 0x116f,</span>
<a href="#l6.1019"></a><span id="l6.1019" class="difflineplus">+    0x1170, 0x1171, 0x1172, 0x1173, 0x1174, 0x1175, 0x1176, 0x1177,</span>
<a href="#l6.1020"></a><span id="l6.1020" class="difflineplus">+    0x1178, 0x1179, 0x117a, 0x117b, 0x117c, 0x117d, 0x117e, 0x117f,</span>
<a href="#l6.1021"></a><span id="l6.1021" class="difflineplus">+};</span>
<a href="#l6.1022"></a><span id="l6.1022"> </span>
<a href="#l6.1023"></a><span id="l6.1023"> static const unsigned short gNormalizeTable1780[] = {</span>
<a href="#l6.1024"></a><span id="l6.1024" class="difflineminus">-	/* U+1780 */</span>
<a href="#l6.1025"></a><span id="l6.1025" class="difflineminus">-	0x1780, 0x1781, 0x1782, 0x1783, 0x1784, 0x1785, 0x1786, 0x1787, </span>
<a href="#l6.1026"></a><span id="l6.1026" class="difflineminus">-	0x1788, 0x1789, 0x178a, 0x178b, 0x178c, 0x178d, 0x178e, 0x178f, </span>
<a href="#l6.1027"></a><span id="l6.1027" class="difflineminus">-	0x1790, 0x1791, 0x1792, 0x1793, 0x1794, 0x1795, 0x1796, 0x1797, </span>
<a href="#l6.1028"></a><span id="l6.1028" class="difflineminus">-	0x1798, 0x1799, 0x179a, 0x179b, 0x179c, 0x179d, 0x179e, 0x179f, </span>
<a href="#l6.1029"></a><span id="l6.1029" class="difflineminus">-	0x17a0, 0x17a1, 0x17a2, 0x17a3, 0x17a4, 0x17a5, 0x17a6, 0x17a7, </span>
<a href="#l6.1030"></a><span id="l6.1030" class="difflineminus">-	0x17a8, 0x17a9, 0x17aa, 0x17ab, 0x17ac, 0x17ad, 0x17ae, 0x17af, </span>
<a href="#l6.1031"></a><span id="l6.1031" class="difflineminus">-	0x17b0, 0x17b1, 0x17b2, 0x17b3, 0x0020, 0x0020, 0x17b6, 0x17b7, </span>
<a href="#l6.1032"></a><span id="l6.1032" class="difflineminus">-	0x17b8, 0x17b9, 0x17ba, 0x17bb, 0x17bc, 0x17bd, 0x17be, 0x17bf, </span>
<a href="#l6.1033"></a><span id="l6.1033" class="difflineminus">-	};</span>
<a href="#l6.1034"></a><span id="l6.1034" class="difflineplus">+    /* U+1780 */</span>
<a href="#l6.1035"></a><span id="l6.1035" class="difflineplus">+    0x1780, 0x1781, 0x1782, 0x1783, 0x1784, 0x1785, 0x1786, 0x1787,</span>
<a href="#l6.1036"></a><span id="l6.1036" class="difflineplus">+    0x1788, 0x1789, 0x178a, 0x178b, 0x178c, 0x178d, 0x178e, 0x178f,</span>
<a href="#l6.1037"></a><span id="l6.1037" class="difflineplus">+    0x1790, 0x1791, 0x1792, 0x1793, 0x1794, 0x1795, 0x1796, 0x1797,</span>
<a href="#l6.1038"></a><span id="l6.1038" class="difflineplus">+    0x1798, 0x1799, 0x179a, 0x179b, 0x179c, 0x179d, 0x179e, 0x179f,</span>
<a href="#l6.1039"></a><span id="l6.1039" class="difflineplus">+    0x17a0, 0x17a1, 0x17a2, 0x17a3, 0x17a4, 0x17a5, 0x17a6, 0x17a7,</span>
<a href="#l6.1040"></a><span id="l6.1040" class="difflineplus">+    0x17a8, 0x17a9, 0x17aa, 0x17ab, 0x17ac, 0x17ad, 0x17ae, 0x17af,</span>
<a href="#l6.1041"></a><span id="l6.1041" class="difflineplus">+    0x17b0, 0x17b1, 0x17b2, 0x17b3, 0x0020, 0x0020, 0x17b6, 0x17b7,</span>
<a href="#l6.1042"></a><span id="l6.1042" class="difflineplus">+    0x17b8, 0x17b9, 0x17ba, 0x17bb, 0x17bc, 0x17bd, 0x17be, 0x17bf,</span>
<a href="#l6.1043"></a><span id="l6.1043" class="difflineplus">+};</span>
<a href="#l6.1044"></a><span id="l6.1044"> </span>
<a href="#l6.1045"></a><span id="l6.1045"> static const unsigned short gNormalizeTable1800[] = {</span>
<a href="#l6.1046"></a><span id="l6.1046" class="difflineminus">-	/* U+1800 */</span>
<a href="#l6.1047"></a><span id="l6.1047" class="difflineminus">-	0x1800, 0x1801, 0x1802, 0x1803, 0x1804, 0x1805, 0x1806, 0x1807, </span>
<a href="#l6.1048"></a><span id="l6.1048" class="difflineminus">-	0x1808, 0x1809, 0x180a, 0x0020, 0x0020, 0x0020, 0x180e, 0x180f, </span>
<a href="#l6.1049"></a><span id="l6.1049" class="difflineminus">-	0x1810, 0x1811, 0x1812, 0x1813, 0x1814, 0x1815, 0x1816, 0x1817, </span>
<a href="#l6.1050"></a><span id="l6.1050" class="difflineminus">-	0x1818, 0x1819, 0x181a, 0x181b, 0x181c, 0x181d, 0x181e, 0x181f, </span>
<a href="#l6.1051"></a><span id="l6.1051" class="difflineminus">-	0x1820, 0x1821, 0x1822, 0x1823, 0x1824, 0x1825, 0x1826, 0x1827, </span>
<a href="#l6.1052"></a><span id="l6.1052" class="difflineminus">-	0x1828, 0x1829, 0x182a, 0x182b, 0x182c, 0x182d, 0x182e, 0x182f, </span>
<a href="#l6.1053"></a><span id="l6.1053" class="difflineminus">-	0x1830, 0x1831, 0x1832, 0x1833, 0x1834, 0x1835, 0x1836, 0x1837, </span>
<a href="#l6.1054"></a><span id="l6.1054" class="difflineminus">-	0x1838, 0x1839, 0x183a, 0x183b, 0x183c, 0x183d, 0x183e, 0x183f, </span>
<a href="#l6.1055"></a><span id="l6.1055" class="difflineminus">-	};</span>
<a href="#l6.1056"></a><span id="l6.1056" class="difflineplus">+    /* U+1800 */</span>
<a href="#l6.1057"></a><span id="l6.1057" class="difflineplus">+    0x1800, 0x1801, 0x1802, 0x1803, 0x1804, 0x1805, 0x1806, 0x1807,</span>
<a href="#l6.1058"></a><span id="l6.1058" class="difflineplus">+    0x1808, 0x1809, 0x180a, 0x0020, 0x0020, 0x0020, 0x180e, 0x180f,</span>
<a href="#l6.1059"></a><span id="l6.1059" class="difflineplus">+    0x1810, 0x1811, 0x1812, 0x1813, 0x1814, 0x1815, 0x1816, 0x1817,</span>
<a href="#l6.1060"></a><span id="l6.1060" class="difflineplus">+    0x1818, 0x1819, 0x181a, 0x181b, 0x181c, 0x181d, 0x181e, 0x181f,</span>
<a href="#l6.1061"></a><span id="l6.1061" class="difflineplus">+    0x1820, 0x1821, 0x1822, 0x1823, 0x1824, 0x1825, 0x1826, 0x1827,</span>
<a href="#l6.1062"></a><span id="l6.1062" class="difflineplus">+    0x1828, 0x1829, 0x182a, 0x182b, 0x182c, 0x182d, 0x182e, 0x182f,</span>
<a href="#l6.1063"></a><span id="l6.1063" class="difflineplus">+    0x1830, 0x1831, 0x1832, 0x1833, 0x1834, 0x1835, 0x1836, 0x1837,</span>
<a href="#l6.1064"></a><span id="l6.1064" class="difflineplus">+    0x1838, 0x1839, 0x183a, 0x183b, 0x183c, 0x183d, 0x183e, 0x183f,</span>
<a href="#l6.1065"></a><span id="l6.1065" class="difflineplus">+};</span>
<a href="#l6.1066"></a><span id="l6.1066"> </span>
<a href="#l6.1067"></a><span id="l6.1067"> static const unsigned short gNormalizeTable1b00[] = {</span>
<a href="#l6.1068"></a><span id="l6.1068" class="difflineminus">-	/* U+1b00 */</span>
<a href="#l6.1069"></a><span id="l6.1069" class="difflineminus">-	0x1b00, 0x1b01, 0x1b02, 0x1b03, 0x1b04, 0x1b05, 0x1b05, 0x1b07, </span>
<a href="#l6.1070"></a><span id="l6.1070" class="difflineminus">-	0x1b07, 0x1b09, 0x1b09, 0x1b0b, 0x1b0b, 0x1b0d, 0x1b0d, 0x1b0f, </span>
<a href="#l6.1071"></a><span id="l6.1071" class="difflineminus">-	0x1b10, 0x1b11, 0x1b11, 0x1b13, 0x1b14, 0x1b15, 0x1b16, 0x1b17, </span>
<a href="#l6.1072"></a><span id="l6.1072" class="difflineminus">-	0x1b18, 0x1b19, 0x1b1a, 0x1b1b, 0x1b1c, 0x1b1d, 0x1b1e, 0x1b1f, </span>
<a href="#l6.1073"></a><span id="l6.1073" class="difflineminus">-	0x1b20, 0x1b21, 0x1b22, 0x1b23, 0x1b24, 0x1b25, 0x1b26, 0x1b27, </span>
<a href="#l6.1074"></a><span id="l6.1074" class="difflineminus">-	0x1b28, 0x1b29, 0x1b2a, 0x1b2b, 0x1b2c, 0x1b2d, 0x1b2e, 0x1b2f, </span>
<a href="#l6.1075"></a><span id="l6.1075" class="difflineminus">-	0x1b30, 0x1b31, 0x1b32, 0x1b33, 0x1b34, 0x1b35, 0x1b36, 0x1b37, </span>
<a href="#l6.1076"></a><span id="l6.1076" class="difflineminus">-	0x1b38, 0x1b39, 0x1b3a, 0x1b3a, 0x1b3c, 0x1b3c, 0x1b3e, 0x1b3f, </span>
<a href="#l6.1077"></a><span id="l6.1077" class="difflineminus">-	};</span>
<a href="#l6.1078"></a><span id="l6.1078" class="difflineplus">+    /* U+1b00 */</span>
<a href="#l6.1079"></a><span id="l6.1079" class="difflineplus">+    0x1b00, 0x1b01, 0x1b02, 0x1b03, 0x1b04, 0x1b05, 0x1b05, 0x1b07,</span>
<a href="#l6.1080"></a><span id="l6.1080" class="difflineplus">+    0x1b07, 0x1b09, 0x1b09, 0x1b0b, 0x1b0b, 0x1b0d, 0x1b0d, 0x1b0f,</span>
<a href="#l6.1081"></a><span id="l6.1081" class="difflineplus">+    0x1b10, 0x1b11, 0x1b11, 0x1b13, 0x1b14, 0x1b15, 0x1b16, 0x1b17,</span>
<a href="#l6.1082"></a><span id="l6.1082" class="difflineplus">+    0x1b18, 0x1b19, 0x1b1a, 0x1b1b, 0x1b1c, 0x1b1d, 0x1b1e, 0x1b1f,</span>
<a href="#l6.1083"></a><span id="l6.1083" class="difflineplus">+    0x1b20, 0x1b21, 0x1b22, 0x1b23, 0x1b24, 0x1b25, 0x1b26, 0x1b27,</span>
<a href="#l6.1084"></a><span id="l6.1084" class="difflineplus">+    0x1b28, 0x1b29, 0x1b2a, 0x1b2b, 0x1b2c, 0x1b2d, 0x1b2e, 0x1b2f,</span>
<a href="#l6.1085"></a><span id="l6.1085" class="difflineplus">+    0x1b30, 0x1b31, 0x1b32, 0x1b33, 0x1b34, 0x1b35, 0x1b36, 0x1b37,</span>
<a href="#l6.1086"></a><span id="l6.1086" class="difflineplus">+    0x1b38, 0x1b39, 0x1b3a, 0x1b3a, 0x1b3c, 0x1b3c, 0x1b3e, 0x1b3f,</span>
<a href="#l6.1087"></a><span id="l6.1087" class="difflineplus">+};</span>
<a href="#l6.1088"></a><span id="l6.1088"> </span>
<a href="#l6.1089"></a><span id="l6.1089"> static const unsigned short gNormalizeTable1b40[] = {</span>
<a href="#l6.1090"></a><span id="l6.1090" class="difflineminus">-	/* U+1b40 */</span>
<a href="#l6.1091"></a><span id="l6.1091" class="difflineminus">-	0x1b3e, 0x1b3f, 0x1b42, 0x1b42, 0x1b44, 0x1b45, 0x1b46, 0x1b47, </span>
<a href="#l6.1092"></a><span id="l6.1092" class="difflineminus">-	0x1b48, 0x1b49, 0x1b4a, 0x1b4b, 0x1b4c, 0x1b4d, 0x1b4e, 0x1b4f, </span>
<a href="#l6.1093"></a><span id="l6.1093" class="difflineminus">-	0x1b50, 0x1b51, 0x1b52, 0x1b53, 0x1b54, 0x1b55, 0x1b56, 0x1b57, </span>
<a href="#l6.1094"></a><span id="l6.1094" class="difflineminus">-	0x1b58, 0x1b59, 0x1b5a, 0x1b5b, 0x1b5c, 0x1b5d, 0x1b5e, 0x1b5f, </span>
<a href="#l6.1095"></a><span id="l6.1095" class="difflineminus">-	0x1b60, 0x1b61, 0x1b62, 0x1b63, 0x1b64, 0x1b65, 0x1b66, 0x1b67, </span>
<a href="#l6.1096"></a><span id="l6.1096" class="difflineminus">-	0x1b68, 0x1b69, 0x1b6a, 0x1b6b, 0x1b6c, 0x1b6d, 0x1b6e, 0x1b6f, </span>
<a href="#l6.1097"></a><span id="l6.1097" class="difflineminus">-	0x1b70, 0x1b71, 0x1b72, 0x1b73, 0x1b74, 0x1b75, 0x1b76, 0x1b77, </span>
<a href="#l6.1098"></a><span id="l6.1098" class="difflineminus">-	0x1b78, 0x1b79, 0x1b7a, 0x1b7b, 0x1b7c, 0x1b7d, 0x1b7e, 0x1b7f, </span>
<a href="#l6.1099"></a><span id="l6.1099" class="difflineminus">-	};</span>
<a href="#l6.1100"></a><span id="l6.1100" class="difflineplus">+    /* U+1b40 */</span>
<a href="#l6.1101"></a><span id="l6.1101" class="difflineplus">+    0x1b3e, 0x1b3f, 0x1b42, 0x1b42, 0x1b44, 0x1b45, 0x1b46, 0x1b47,</span>
<a href="#l6.1102"></a><span id="l6.1102" class="difflineplus">+    0x1b48, 0x1b49, 0x1b4a, 0x1b4b, 0x1b4c, 0x1b4d, 0x1b4e, 0x1b4f,</span>
<a href="#l6.1103"></a><span id="l6.1103" class="difflineplus">+    0x1b50, 0x1b51, 0x1b52, 0x1b53, 0x1b54, 0x1b55, 0x1b56, 0x1b57,</span>
<a href="#l6.1104"></a><span id="l6.1104" class="difflineplus">+    0x1b58, 0x1b59, 0x1b5a, 0x1b5b, 0x1b5c, 0x1b5d, 0x1b5e, 0x1b5f,</span>
<a href="#l6.1105"></a><span id="l6.1105" class="difflineplus">+    0x1b60, 0x1b61, 0x1b62, 0x1b63, 0x1b64, 0x1b65, 0x1b66, 0x1b67,</span>
<a href="#l6.1106"></a><span id="l6.1106" class="difflineplus">+    0x1b68, 0x1b69, 0x1b6a, 0x1b6b, 0x1b6c, 0x1b6d, 0x1b6e, 0x1b6f,</span>
<a href="#l6.1107"></a><span id="l6.1107" class="difflineplus">+    0x1b70, 0x1b71, 0x1b72, 0x1b73, 0x1b74, 0x1b75, 0x1b76, 0x1b77,</span>
<a href="#l6.1108"></a><span id="l6.1108" class="difflineplus">+    0x1b78, 0x1b79, 0x1b7a, 0x1b7b, 0x1b7c, 0x1b7d, 0x1b7e, 0x1b7f,</span>
<a href="#l6.1109"></a><span id="l6.1109" class="difflineplus">+};</span>
<a href="#l6.1110"></a><span id="l6.1110"> </span>
<a href="#l6.1111"></a><span id="l6.1111"> static const unsigned short gNormalizeTable1d00[] = {</span>
<a href="#l6.1112"></a><span id="l6.1112" class="difflineminus">-	/* U+1d00 */</span>
<a href="#l6.1113"></a><span id="l6.1113" class="difflineminus">-	0x1d00, 0x1d01, 0x1d02, 0x1d03, 0x1d04, 0x1d05, 0x1d06, 0x1d07, </span>
<a href="#l6.1114"></a><span id="l6.1114" class="difflineminus">-	0x1d08, 0x1d09, 0x1d0a, 0x1d0b, 0x1d0c, 0x1d0d, 0x1d0e, 0x1d0f, </span>
<a href="#l6.1115"></a><span id="l6.1115" class="difflineminus">-	0x1d10, 0x1d11, 0x1d12, 0x1d13, 0x1d14, 0x1d15, 0x1d16, 0x1d17, </span>
<a href="#l6.1116"></a><span id="l6.1116" class="difflineminus">-	0x1d18, 0x1d19, 0x1d1a, 0x1d1b, 0x1d1c, 0x1d1d, 0x1d1e, 0x1d1f, </span>
<a href="#l6.1117"></a><span id="l6.1117" class="difflineminus">-	0x1d20, 0x1d21, 0x1d22, 0x1d23, 0x1d24, 0x1d25, 0x1d26, 0x1d27, </span>
<a href="#l6.1118"></a><span id="l6.1118" class="difflineminus">-	0x1d28, 0x1d29, 0x1d2a, 0x1d2b, 0x0061, 0x00e6, 0x0062, 0x1d2f, </span>
<a href="#l6.1119"></a><span id="l6.1119" class="difflineminus">-	0x0064, 0x0065, 0x01dd, 0x0067, 0x0068, 0x0069, 0x006a, 0x006b, </span>
<a href="#l6.1120"></a><span id="l6.1120" class="difflineminus">-	0x006c, 0x006d, 0x006e, 0x1d3b, 0x006f, 0x0223, 0x0070, 0x0072, </span>
<a href="#l6.1121"></a><span id="l6.1121" class="difflineminus">-	};</span>
<a href="#l6.1122"></a><span id="l6.1122" class="difflineplus">+    /* U+1d00 */</span>
<a href="#l6.1123"></a><span id="l6.1123" class="difflineplus">+    0x1d00, 0x1d01, 0x1d02, 0x1d03, 0x1d04, 0x1d05, 0x1d06, 0x1d07,</span>
<a href="#l6.1124"></a><span id="l6.1124" class="difflineplus">+    0x1d08, 0x1d09, 0x1d0a, 0x1d0b, 0x1d0c, 0x1d0d, 0x1d0e, 0x1d0f,</span>
<a href="#l6.1125"></a><span id="l6.1125" class="difflineplus">+    0x1d10, 0x1d11, 0x1d12, 0x1d13, 0x1d14, 0x1d15, 0x1d16, 0x1d17,</span>
<a href="#l6.1126"></a><span id="l6.1126" class="difflineplus">+    0x1d18, 0x1d19, 0x1d1a, 0x1d1b, 0x1d1c, 0x1d1d, 0x1d1e, 0x1d1f,</span>
<a href="#l6.1127"></a><span id="l6.1127" class="difflineplus">+    0x1d20, 0x1d21, 0x1d22, 0x1d23, 0x1d24, 0x1d25, 0x1d26, 0x1d27,</span>
<a href="#l6.1128"></a><span id="l6.1128" class="difflineplus">+    0x1d28, 0x1d29, 0x1d2a, 0x1d2b, 0x0061, 0x00e6, 0x0062, 0x1d2f,</span>
<a href="#l6.1129"></a><span id="l6.1129" class="difflineplus">+    0x0064, 0x0065, 0x01dd, 0x0067, 0x0068, 0x0069, 0x006a, 0x006b,</span>
<a href="#l6.1130"></a><span id="l6.1130" class="difflineplus">+    0x006c, 0x006d, 0x006e, 0x1d3b, 0x006f, 0x0223, 0x0070, 0x0072,</span>
<a href="#l6.1131"></a><span id="l6.1131" class="difflineplus">+};</span>
<a href="#l6.1132"></a><span id="l6.1132"> </span>
<a href="#l6.1133"></a><span id="l6.1133"> static const unsigned short gNormalizeTable1d40[] = {</span>
<a href="#l6.1134"></a><span id="l6.1134" class="difflineminus">-	/* U+1d40 */</span>
<a href="#l6.1135"></a><span id="l6.1135" class="difflineminus">-	0x0074, 0x0075, 0x0077, 0x0061, 0x0250, 0x0251, 0x1d02, 0x0062, </span>
<a href="#l6.1136"></a><span id="l6.1136" class="difflineminus">-	0x0064, 0x0065, 0x0259, 0x025b, 0x025c, 0x0067, 0x1d4e, 0x006b, </span>
<a href="#l6.1137"></a><span id="l6.1137" class="difflineminus">-	0x006d, 0x014b, 0x006f, 0x0254, 0x1d16, 0x1d17, 0x0070, 0x0074, </span>
<a href="#l6.1138"></a><span id="l6.1138" class="difflineminus">-	0x0075, 0x1d1d, 0x026f, 0x0076, 0x1d25, 0x03b2, 0x03b3, 0x03b4, </span>
<a href="#l6.1139"></a><span id="l6.1139" class="difflineminus">-	0x03c6, 0x03c7, 0x0069, 0x0072, 0x0075, 0x0076, 0x03b2, 0x03b3, </span>
<a href="#l6.1140"></a><span id="l6.1140" class="difflineminus">-	0x03c1, 0x03c6, 0x03c7, 0x1d6b, 0x1d6c, 0x1d6d, 0x1d6e, 0x1d6f, </span>
<a href="#l6.1141"></a><span id="l6.1141" class="difflineminus">-	0x1d70, 0x1d71, 0x1d72, 0x1d73, 0x1d74, 0x1d75, 0x1d76, 0x1d77, </span>
<a href="#l6.1142"></a><span id="l6.1142" class="difflineminus">-	0x043d, 0x1d79, 0x1d7a, 0x1d7b, 0x1d7c, 0x1d7d, 0x1d7e, 0x1d7f, </span>
<a href="#l6.1143"></a><span id="l6.1143" class="difflineminus">-	};</span>
<a href="#l6.1144"></a><span id="l6.1144" class="difflineplus">+    /* U+1d40 */</span>
<a href="#l6.1145"></a><span id="l6.1145" class="difflineplus">+    0x0074, 0x0075, 0x0077, 0x0061, 0x0250, 0x0251, 0x1d02, 0x0062,</span>
<a href="#l6.1146"></a><span id="l6.1146" class="difflineplus">+    0x0064, 0x0065, 0x0259, 0x025b, 0x025c, 0x0067, 0x1d4e, 0x006b,</span>
<a href="#l6.1147"></a><span id="l6.1147" class="difflineplus">+    0x006d, 0x014b, 0x006f, 0x0254, 0x1d16, 0x1d17, 0x0070, 0x0074,</span>
<a href="#l6.1148"></a><span id="l6.1148" class="difflineplus">+    0x0075, 0x1d1d, 0x026f, 0x0076, 0x1d25, 0x03b2, 0x03b3, 0x03b4,</span>
<a href="#l6.1149"></a><span id="l6.1149" class="difflineplus">+    0x03c6, 0x03c7, 0x0069, 0x0072, 0x0075, 0x0076, 0x03b2, 0x03b3,</span>
<a href="#l6.1150"></a><span id="l6.1150" class="difflineplus">+    0x03c1, 0x03c6, 0x03c7, 0x1d6b, 0x1d6c, 0x1d6d, 0x1d6e, 0x1d6f,</span>
<a href="#l6.1151"></a><span id="l6.1151" class="difflineplus">+    0x1d70, 0x1d71, 0x1d72, 0x1d73, 0x1d74, 0x1d75, 0x1d76, 0x1d77,</span>
<a href="#l6.1152"></a><span id="l6.1152" class="difflineplus">+    0x043d, 0x1d79, 0x1d7a, 0x1d7b, 0x1d7c, 0x1d7d, 0x1d7e, 0x1d7f,</span>
<a href="#l6.1153"></a><span id="l6.1153" class="difflineplus">+};</span>
<a href="#l6.1154"></a><span id="l6.1154"> </span>
<a href="#l6.1155"></a><span id="l6.1155"> static const unsigned short gNormalizeTable1d80[] = {</span>
<a href="#l6.1156"></a><span id="l6.1156" class="difflineminus">-	/* U+1d80 */</span>
<a href="#l6.1157"></a><span id="l6.1157" class="difflineminus">-	0x1d80, 0x1d81, 0x1d82, 0x1d83, 0x1d84, 0x1d85, 0x1d86, 0x1d87, </span>
<a href="#l6.1158"></a><span id="l6.1158" class="difflineminus">-	0x1d88, 0x1d89, 0x1d8a, 0x1d8b, 0x1d8c, 0x1d8d, 0x1d8e, 0x1d8f, </span>
<a href="#l6.1159"></a><span id="l6.1159" class="difflineminus">-	0x1d90, 0x1d91, 0x1d92, 0x1d93, 0x1d94, 0x1d95, 0x1d96, 0x1d97, </span>
<a href="#l6.1160"></a><span id="l6.1160" class="difflineminus">-	0x1d98, 0x1d99, 0x1d9a, 0x0252, 0x0063, 0x0255, 0x00f0, 0x025c, </span>
<a href="#l6.1161"></a><span id="l6.1161" class="difflineminus">-	0x0066, 0x025f, 0x0261, 0x0265, 0x0268, 0x0269, 0x026a, 0x1d7b, </span>
<a href="#l6.1162"></a><span id="l6.1162" class="difflineminus">-	0x029d, 0x026d, 0x1d85, 0x029f, 0x0271, 0x0270, 0x0272, 0x0273, </span>
<a href="#l6.1163"></a><span id="l6.1163" class="difflineminus">-	0x0274, 0x0275, 0x0278, 0x0282, 0x0283, 0x01ab, 0x0289, 0x028a, </span>
<a href="#l6.1164"></a><span id="l6.1164" class="difflineminus">-	0x1d1c, 0x028b, 0x028c, 0x007a, 0x0290, 0x0291, 0x0292, 0x03b8, </span>
<a href="#l6.1165"></a><span id="l6.1165" class="difflineminus">-	};</span>
<a href="#l6.1166"></a><span id="l6.1166" class="difflineplus">+    /* U+1d80 */</span>
<a href="#l6.1167"></a><span id="l6.1167" class="difflineplus">+    0x1d80, 0x1d81, 0x1d82, 0x1d83, 0x1d84, 0x1d85, 0x1d86, 0x1d87,</span>
<a href="#l6.1168"></a><span id="l6.1168" class="difflineplus">+    0x1d88, 0x1d89, 0x1d8a, 0x1d8b, 0x1d8c, 0x1d8d, 0x1d8e, 0x1d8f,</span>
<a href="#l6.1169"></a><span id="l6.1169" class="difflineplus">+    0x1d90, 0x1d91, 0x1d92, 0x1d93, 0x1d94, 0x1d95, 0x1d96, 0x1d97,</span>
<a href="#l6.1170"></a><span id="l6.1170" class="difflineplus">+    0x1d98, 0x1d99, 0x1d9a, 0x0252, 0x0063, 0x0255, 0x00f0, 0x025c,</span>
<a href="#l6.1171"></a><span id="l6.1171" class="difflineplus">+    0x0066, 0x025f, 0x0261, 0x0265, 0x0268, 0x0269, 0x026a, 0x1d7b,</span>
<a href="#l6.1172"></a><span id="l6.1172" class="difflineplus">+    0x029d, 0x026d, 0x1d85, 0x029f, 0x0271, 0x0270, 0x0272, 0x0273,</span>
<a href="#l6.1173"></a><span id="l6.1173" class="difflineplus">+    0x0274, 0x0275, 0x0278, 0x0282, 0x0283, 0x01ab, 0x0289, 0x028a,</span>
<a href="#l6.1174"></a><span id="l6.1174" class="difflineplus">+    0x1d1c, 0x028b, 0x028c, 0x007a, 0x0290, 0x0291, 0x0292, 0x03b8,</span>
<a href="#l6.1175"></a><span id="l6.1175" class="difflineplus">+};</span>
<a href="#l6.1176"></a><span id="l6.1176"> </span>
<a href="#l6.1177"></a><span id="l6.1177"> static const unsigned short gNormalizeTable1e00[] = {</span>
<a href="#l6.1178"></a><span id="l6.1178" class="difflineminus">-	/* U+1e00 */</span>
<a href="#l6.1179"></a><span id="l6.1179" class="difflineminus">-	0x0061, 0x0061, 0x0062, 0x0062, 0x0062, 0x0062, 0x0062, 0x0062, </span>
<a href="#l6.1180"></a><span id="l6.1180" class="difflineminus">-	0x0063, 0x0063, 0x0064, 0x0064, 0x0064, 0x0064, 0x0064, 0x0064, </span>
<a href="#l6.1181"></a><span id="l6.1181" class="difflineminus">-	0x0064, 0x0064, 0x0064, 0x0064, 0x0065, 0x0065, 0x0065, 0x0065, </span>
<a href="#l6.1182"></a><span id="l6.1182" class="difflineminus">-	0x0065, 0x0065, 0x0065, 0x0065, 0x0065, 0x0065, 0x0066, 0x0066, </span>
<a href="#l6.1183"></a><span id="l6.1183" class="difflineminus">-	0x0067, 0x0067, 0x0068, 0x0068, 0x0068, 0x0068, 0x0068, 0x0068, </span>
<a href="#l6.1184"></a><span id="l6.1184" class="difflineminus">-	0x0068, 0x0068, 0x0068, 0x0068, 0x0069, 0x0069, 0x0069, 0x0069, </span>
<a href="#l6.1185"></a><span id="l6.1185" class="difflineminus">-	0x006b, 0x006b, 0x006b, 0x006b, 0x006b, 0x006b, 0x006c, 0x006c, </span>
<a href="#l6.1186"></a><span id="l6.1186" class="difflineminus">-	0x006c, 0x006c, 0x006c, 0x006c, 0x006c, 0x006c, 0x006d, 0x006d, </span>
<a href="#l6.1187"></a><span id="l6.1187" class="difflineminus">-	};</span>
<a href="#l6.1188"></a><span id="l6.1188" class="difflineplus">+    /* U+1e00 */</span>
<a href="#l6.1189"></a><span id="l6.1189" class="difflineplus">+    0x0061, 0x0061, 0x0062, 0x0062, 0x0062, 0x0062, 0x0062, 0x0062,</span>
<a href="#l6.1190"></a><span id="l6.1190" class="difflineplus">+    0x0063, 0x0063, 0x0064, 0x0064, 0x0064, 0x0064, 0x0064, 0x0064,</span>
<a href="#l6.1191"></a><span id="l6.1191" class="difflineplus">+    0x0064, 0x0064, 0x0064, 0x0064, 0x0065, 0x0065, 0x0065, 0x0065,</span>
<a href="#l6.1192"></a><span id="l6.1192" class="difflineplus">+    0x0065, 0x0065, 0x0065, 0x0065, 0x0065, 0x0065, 0x0066, 0x0066,</span>
<a href="#l6.1193"></a><span id="l6.1193" class="difflineplus">+    0x0067, 0x0067, 0x0068, 0x0068, 0x0068, 0x0068, 0x0068, 0x0068,</span>
<a href="#l6.1194"></a><span id="l6.1194" class="difflineplus">+    0x0068, 0x0068, 0x0068, 0x0068, 0x0069, 0x0069, 0x0069, 0x0069,</span>
<a href="#l6.1195"></a><span id="l6.1195" class="difflineplus">+    0x006b, 0x006b, 0x006b, 0x006b, 0x006b, 0x006b, 0x006c, 0x006c,</span>
<a href="#l6.1196"></a><span id="l6.1196" class="difflineplus">+    0x006c, 0x006c, 0x006c, 0x006c, 0x006c, 0x006c, 0x006d, 0x006d,</span>
<a href="#l6.1197"></a><span id="l6.1197" class="difflineplus">+};</span>
<a href="#l6.1198"></a><span id="l6.1198"> </span>
<a href="#l6.1199"></a><span id="l6.1199"> static const unsigned short gNormalizeTable1e40[] = {</span>
<a href="#l6.1200"></a><span id="l6.1200" class="difflineminus">-	/* U+1e40 */</span>
<a href="#l6.1201"></a><span id="l6.1201" class="difflineminus">-	0x006d, 0x006d, 0x006d, 0x006d, 0x006e, 0x006e, 0x006e, 0x006e, </span>
<a href="#l6.1202"></a><span id="l6.1202" class="difflineminus">-	0x006e, 0x006e, 0x006e, 0x006e, 0x006f, 0x006f, 0x006f, 0x006f, </span>
<a href="#l6.1203"></a><span id="l6.1203" class="difflineminus">-	0x006f, 0x006f, 0x006f, 0x006f, 0x0070, 0x0070, 0x0070, 0x0070, </span>
<a href="#l6.1204"></a><span id="l6.1204" class="difflineminus">-	0x0072, 0x0072, 0x0072, 0x0072, 0x0072, 0x0072, 0x0072, 0x0072, </span>
<a href="#l6.1205"></a><span id="l6.1205" class="difflineminus">-	0x0073, 0x0073, 0x0073, 0x0073, 0x0073, 0x0073, 0x0073, 0x0073, </span>
<a href="#l6.1206"></a><span id="l6.1206" class="difflineminus">-	0x0073, 0x0073, 0x0074, 0x0074, 0x0074, 0x0074, 0x0074, 0x0074, </span>
<a href="#l6.1207"></a><span id="l6.1207" class="difflineminus">-	0x0074, 0x0074, 0x0075, 0x0075, 0x0075, 0x0075, 0x0075, 0x0075, </span>
<a href="#l6.1208"></a><span id="l6.1208" class="difflineminus">-	0x0075, 0x0075, 0x0075, 0x0075, 0x0076, 0x0076, 0x0076, 0x0076, </span>
<a href="#l6.1209"></a><span id="l6.1209" class="difflineminus">-	};</span>
<a href="#l6.1210"></a><span id="l6.1210" class="difflineplus">+    /* U+1e40 */</span>
<a href="#l6.1211"></a><span id="l6.1211" class="difflineplus">+    0x006d, 0x006d, 0x006d, 0x006d, 0x006e, 0x006e, 0x006e, 0x006e,</span>
<a href="#l6.1212"></a><span id="l6.1212" class="difflineplus">+    0x006e, 0x006e, 0x006e, 0x006e, 0x006f, 0x006f, 0x006f, 0x006f,</span>
<a href="#l6.1213"></a><span id="l6.1213" class="difflineplus">+    0x006f, 0x006f, 0x006f, 0x006f, 0x0070, 0x0070, 0x0070, 0x0070,</span>
<a href="#l6.1214"></a><span id="l6.1214" class="difflineplus">+    0x0072, 0x0072, 0x0072, 0x0072, 0x0072, 0x0072, 0x0072, 0x0072,</span>
<a href="#l6.1215"></a><span id="l6.1215" class="difflineplus">+    0x0073, 0x0073, 0x0073, 0x0073, 0x0073, 0x0073, 0x0073, 0x0073,</span>
<a href="#l6.1216"></a><span id="l6.1216" class="difflineplus">+    0x0073, 0x0073, 0x0074, 0x0074, 0x0074, 0x0074, 0x0074, 0x0074,</span>
<a href="#l6.1217"></a><span id="l6.1217" class="difflineplus">+    0x0074, 0x0074, 0x0075, 0x0075, 0x0075, 0x0075, 0x0075, 0x0075,</span>
<a href="#l6.1218"></a><span id="l6.1218" class="difflineplus">+    0x0075, 0x0075, 0x0075, 0x0075, 0x0076, 0x0076, 0x0076, 0x0076,</span>
<a href="#l6.1219"></a><span id="l6.1219" class="difflineplus">+};</span>
<a href="#l6.1220"></a><span id="l6.1220"> </span>
<a href="#l6.1221"></a><span id="l6.1221"> static const unsigned short gNormalizeTable1e80[] = {</span>
<a href="#l6.1222"></a><span id="l6.1222" class="difflineminus">-	/* U+1e80 */</span>
<a href="#l6.1223"></a><span id="l6.1223" class="difflineminus">-	0x0077, 0x0077, 0x0077, 0x0077, 0x0077, 0x0077, 0x0077, 0x0077, </span>
<a href="#l6.1224"></a><span id="l6.1224" class="difflineminus">-	0x0077, 0x0077, 0x0078, 0x0078, 0x0078, 0x0078, 0x0079, 0x0079, </span>
<a href="#l6.1225"></a><span id="l6.1225" class="difflineminus">-	0x007a, 0x007a, 0x007a, 0x007a, 0x007a, 0x007a, 0x0068, 0x0074, </span>
<a href="#l6.1226"></a><span id="l6.1226" class="difflineminus">-	0x0077, 0x0079, 0x0061, 0x0073, 0x1e9c, 0x1e9d, 0x0073, 0x1e9f, </span>
<a href="#l6.1227"></a><span id="l6.1227" class="difflineminus">-	0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x0061, </span>
<a href="#l6.1228"></a><span id="l6.1228" class="difflineminus">-	0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x0061, </span>
<a href="#l6.1229"></a><span id="l6.1229" class="difflineminus">-	0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x0061, </span>
<a href="#l6.1230"></a><span id="l6.1230" class="difflineminus">-	0x0065, 0x0065, 0x0065, 0x0065, 0x0065, 0x0065, 0x0065, 0x0065, </span>
<a href="#l6.1231"></a><span id="l6.1231" class="difflineminus">-	};</span>
<a href="#l6.1232"></a><span id="l6.1232" class="difflineplus">+    /* U+1e80 */</span>
<a href="#l6.1233"></a><span id="l6.1233" class="difflineplus">+    0x0077, 0x0077, 0x0077, 0x0077, 0x0077, 0x0077, 0x0077, 0x0077,</span>
<a href="#l6.1234"></a><span id="l6.1234" class="difflineplus">+    0x0077, 0x0077, 0x0078, 0x0078, 0x0078, 0x0078, 0x0079, 0x0079,</span>
<a href="#l6.1235"></a><span id="l6.1235" class="difflineplus">+    0x007a, 0x007a, 0x007a, 0x007a, 0x007a, 0x007a, 0x0068, 0x0074,</span>
<a href="#l6.1236"></a><span id="l6.1236" class="difflineplus">+    0x0077, 0x0079, 0x0061, 0x0073, 0x1e9c, 0x1e9d, 0x0073, 0x1e9f,</span>
<a href="#l6.1237"></a><span id="l6.1237" class="difflineplus">+    0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x0061,</span>
<a href="#l6.1238"></a><span id="l6.1238" class="difflineplus">+    0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x0061,</span>
<a href="#l6.1239"></a><span id="l6.1239" class="difflineplus">+    0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x0061,</span>
<a href="#l6.1240"></a><span id="l6.1240" class="difflineplus">+    0x0065, 0x0065, 0x0065, 0x0065, 0x0065, 0x0065, 0x0065, 0x0065,</span>
<a href="#l6.1241"></a><span id="l6.1241" class="difflineplus">+};</span>
<a href="#l6.1242"></a><span id="l6.1242"> </span>
<a href="#l6.1243"></a><span id="l6.1243"> static const unsigned short gNormalizeTable1ec0[] = {</span>
<a href="#l6.1244"></a><span id="l6.1244" class="difflineminus">-	/* U+1ec0 */</span>
<a href="#l6.1245"></a><span id="l6.1245" class="difflineminus">-	0x0065, 0x0065, 0x0065, 0x0065, 0x0065, 0x0065, 0x0065, 0x0065, </span>
<a href="#l6.1246"></a><span id="l6.1246" class="difflineminus">-	0x0069, 0x0069, 0x0069, 0x0069, 0x006f, 0x006f, 0x006f, 0x006f, </span>
<a href="#l6.1247"></a><span id="l6.1247" class="difflineminus">-	0x006f, 0x006f, 0x006f, 0x006f, 0x006f, 0x006f, 0x006f, 0x006f, </span>
<a href="#l6.1248"></a><span id="l6.1248" class="difflineminus">-	0x006f, 0x006f, 0x006f, 0x006f, 0x006f, 0x006f, 0x006f, 0x006f, </span>
<a href="#l6.1249"></a><span id="l6.1249" class="difflineminus">-	0x006f, 0x006f, 0x006f, 0x006f, 0x0075, 0x0075, 0x0075, 0x0075, </span>
<a href="#l6.1250"></a><span id="l6.1250" class="difflineminus">-	0x0075, 0x0075, 0x0075, 0x0075, 0x0075, 0x0075, 0x0075, 0x0075, </span>
<a href="#l6.1251"></a><span id="l6.1251" class="difflineminus">-	0x0075, 0x0075, 0x0079, 0x0079, 0x0079, 0x0079, 0x0079, 0x0079, </span>
<a href="#l6.1252"></a><span id="l6.1252" class="difflineminus">-	0x0079, 0x0079, 0x1efb, 0x1efb, 0x1efd, 0x1efd, 0x1eff, 0x1eff, </span>
<a href="#l6.1253"></a><span id="l6.1253" class="difflineminus">-	};</span>
<a href="#l6.1254"></a><span id="l6.1254" class="difflineplus">+    /* U+1ec0 */</span>
<a href="#l6.1255"></a><span id="l6.1255" class="difflineplus">+    0x0065, 0x0065, 0x0065, 0x0065, 0x0065, 0x0065, 0x0065, 0x0065,</span>
<a href="#l6.1256"></a><span id="l6.1256" class="difflineplus">+    0x0069, 0x0069, 0x0069, 0x0069, 0x006f, 0x006f, 0x006f, 0x006f,</span>
<a href="#l6.1257"></a><span id="l6.1257" class="difflineplus">+    0x006f, 0x006f, 0x006f, 0x006f, 0x006f, 0x006f, 0x006f, 0x006f,</span>
<a href="#l6.1258"></a><span id="l6.1258" class="difflineplus">+    0x006f, 0x006f, 0x006f, 0x006f, 0x006f, 0x006f, 0x006f, 0x006f,</span>
<a href="#l6.1259"></a><span id="l6.1259" class="difflineplus">+    0x006f, 0x006f, 0x006f, 0x006f, 0x0075, 0x0075, 0x0075, 0x0075,</span>
<a href="#l6.1260"></a><span id="l6.1260" class="difflineplus">+    0x0075, 0x0075, 0x0075, 0x0075, 0x0075, 0x0075, 0x0075, 0x0075,</span>
<a href="#l6.1261"></a><span id="l6.1261" class="difflineplus">+    0x0075, 0x0075, 0x0079, 0x0079, 0x0079, 0x0079, 0x0079, 0x0079,</span>
<a href="#l6.1262"></a><span id="l6.1262" class="difflineplus">+    0x0079, 0x0079, 0x1efb, 0x1efb, 0x1efd, 0x1efd, 0x1eff, 0x1eff,</span>
<a href="#l6.1263"></a><span id="l6.1263" class="difflineplus">+};</span>
<a href="#l6.1264"></a><span id="l6.1264"> </span>
<a href="#l6.1265"></a><span id="l6.1265"> static const unsigned short gNormalizeTable1f00[] = {</span>
<a href="#l6.1266"></a><span id="l6.1266" class="difflineminus">-	/* U+1f00 */</span>
<a href="#l6.1267"></a><span id="l6.1267" class="difflineminus">-	0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, </span>
<a href="#l6.1268"></a><span id="l6.1268" class="difflineminus">-	0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, </span>
<a href="#l6.1269"></a><span id="l6.1269" class="difflineminus">-	0x03b5, 0x03b5, 0x03b5, 0x03b5, 0x03b5, 0x03b5, 0x1f16, 0x1f17, </span>
<a href="#l6.1270"></a><span id="l6.1270" class="difflineminus">-	0x03b5, 0x03b5, 0x03b5, 0x03b5, 0x03b5, 0x03b5, 0x1f1e, 0x1f1f, </span>
<a href="#l6.1271"></a><span id="l6.1271" class="difflineminus">-	0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, </span>
<a href="#l6.1272"></a><span id="l6.1272" class="difflineminus">-	0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, </span>
<a href="#l6.1273"></a><span id="l6.1273" class="difflineminus">-	0x03b9, 0x03b9, 0x03b9, 0x03b9, 0x03b9, 0x03b9, 0x03b9, 0x03b9, </span>
<a href="#l6.1274"></a><span id="l6.1274" class="difflineminus">-	0x03b9, 0x03b9, 0x03b9, 0x03b9, 0x03b9, 0x03b9, 0x03b9, 0x03b9, </span>
<a href="#l6.1275"></a><span id="l6.1275" class="difflineminus">-	};</span>
<a href="#l6.1276"></a><span id="l6.1276" class="difflineplus">+    /* U+1f00 */</span>
<a href="#l6.1277"></a><span id="l6.1277" class="difflineplus">+    0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1,</span>
<a href="#l6.1278"></a><span id="l6.1278" class="difflineplus">+    0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1,</span>
<a href="#l6.1279"></a><span id="l6.1279" class="difflineplus">+    0x03b5, 0x03b5, 0x03b5, 0x03b5, 0x03b5, 0x03b5, 0x1f16, 0x1f17,</span>
<a href="#l6.1280"></a><span id="l6.1280" class="difflineplus">+    0x03b5, 0x03b5, 0x03b5, 0x03b5, 0x03b5, 0x03b5, 0x1f1e, 0x1f1f,</span>
<a href="#l6.1281"></a><span id="l6.1281" class="difflineplus">+    0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7,</span>
<a href="#l6.1282"></a><span id="l6.1282" class="difflineplus">+    0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7,</span>
<a href="#l6.1283"></a><span id="l6.1283" class="difflineplus">+    0x03b9, 0x03b9, 0x03b9, 0x03b9, 0x03b9, 0x03b9, 0x03b9, 0x03b9,</span>
<a href="#l6.1284"></a><span id="l6.1284" class="difflineplus">+    0x03b9, 0x03b9, 0x03b9, 0x03b9, 0x03b9, 0x03b9, 0x03b9, 0x03b9,</span>
<a href="#l6.1285"></a><span id="l6.1285" class="difflineplus">+};</span>
<a href="#l6.1286"></a><span id="l6.1286"> </span>
<a href="#l6.1287"></a><span id="l6.1287"> static const unsigned short gNormalizeTable1f40[] = {</span>
<a href="#l6.1288"></a><span id="l6.1288" class="difflineminus">-	/* U+1f40 */</span>
<a href="#l6.1289"></a><span id="l6.1289" class="difflineminus">-	0x03bf, 0x03bf, 0x03bf, 0x03bf, 0x03bf, 0x03bf, 0x1f46, 0x1f47, </span>
<a href="#l6.1290"></a><span id="l6.1290" class="difflineminus">-	0x03bf, 0x03bf, 0x03bf, 0x03bf, 0x03bf, 0x03bf, 0x1f4e, 0x1f4f, </span>
<a href="#l6.1291"></a><span id="l6.1291" class="difflineminus">-	0x03c5, 0x03c5, 0x03c5, 0x03c5, 0x03c5, 0x03c5, 0x03c5, 0x03c5, </span>
<a href="#l6.1292"></a><span id="l6.1292" class="difflineminus">-	0x1f58, 0x03c5, 0x1f5a, 0x03c5, 0x1f5c, 0x03c5, 0x1f5e, 0x03c5, </span>
<a href="#l6.1293"></a><span id="l6.1293" class="difflineminus">-	0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, </span>
<a href="#l6.1294"></a><span id="l6.1294" class="difflineminus">-	0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, </span>
<a href="#l6.1295"></a><span id="l6.1295" class="difflineminus">-	0x03b1, 0x03b1, 0x03b5, 0x03b5, 0x03b7, 0x03b7, 0x03b9, 0x03b9, </span>
<a href="#l6.1296"></a><span id="l6.1296" class="difflineminus">-	0x03bf, 0x03bf, 0x03c5, 0x03c5, 0x03c9, 0x03c9, 0x1f7e, 0x1f7f, </span>
<a href="#l6.1297"></a><span id="l6.1297" class="difflineminus">-	};</span>
<a href="#l6.1298"></a><span id="l6.1298" class="difflineplus">+    /* U+1f40 */</span>
<a href="#l6.1299"></a><span id="l6.1299" class="difflineplus">+    0x03bf, 0x03bf, 0x03bf, 0x03bf, 0x03bf, 0x03bf, 0x1f46, 0x1f47,</span>
<a href="#l6.1300"></a><span id="l6.1300" class="difflineplus">+    0x03bf, 0x03bf, 0x03bf, 0x03bf, 0x03bf, 0x03bf, 0x1f4e, 0x1f4f,</span>
<a href="#l6.1301"></a><span id="l6.1301" class="difflineplus">+    0x03c5, 0x03c5, 0x03c5, 0x03c5, 0x03c5, 0x03c5, 0x03c5, 0x03c5,</span>
<a href="#l6.1302"></a><span id="l6.1302" class="difflineplus">+    0x1f58, 0x03c5, 0x1f5a, 0x03c5, 0x1f5c, 0x03c5, 0x1f5e, 0x03c5,</span>
<a href="#l6.1303"></a><span id="l6.1303" class="difflineplus">+    0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9,</span>
<a href="#l6.1304"></a><span id="l6.1304" class="difflineplus">+    0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9,</span>
<a href="#l6.1305"></a><span id="l6.1305" class="difflineplus">+    0x03b1, 0x03b1, 0x03b5, 0x03b5, 0x03b7, 0x03b7, 0x03b9, 0x03b9,</span>
<a href="#l6.1306"></a><span id="l6.1306" class="difflineplus">+    0x03bf, 0x03bf, 0x03c5, 0x03c5, 0x03c9, 0x03c9, 0x1f7e, 0x1f7f,</span>
<a href="#l6.1307"></a><span id="l6.1307" class="difflineplus">+};</span>
<a href="#l6.1308"></a><span id="l6.1308"> </span>
<a href="#l6.1309"></a><span id="l6.1309"> static const unsigned short gNormalizeTable1f80[] = {</span>
<a href="#l6.1310"></a><span id="l6.1310" class="difflineminus">-	/* U+1f80 */</span>
<a href="#l6.1311"></a><span id="l6.1311" class="difflineminus">-	0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, </span>
<a href="#l6.1312"></a><span id="l6.1312" class="difflineminus">-	0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, </span>
<a href="#l6.1313"></a><span id="l6.1313" class="difflineminus">-	0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, </span>
<a href="#l6.1314"></a><span id="l6.1314" class="difflineminus">-	0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, </span>
<a href="#l6.1315"></a><span id="l6.1315" class="difflineminus">-	0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, </span>
<a href="#l6.1316"></a><span id="l6.1316" class="difflineminus">-	0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, </span>
<a href="#l6.1317"></a><span id="l6.1317" class="difflineminus">-	0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x1fb5, 0x03b1, 0x03b1, </span>
<a href="#l6.1318"></a><span id="l6.1318" class="difflineminus">-	0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x0020, 0x03b9, 0x0020, </span>
<a href="#l6.1319"></a><span id="l6.1319" class="difflineminus">-	};</span>
<a href="#l6.1320"></a><span id="l6.1320" class="difflineplus">+    /* U+1f80 */</span>
<a href="#l6.1321"></a><span id="l6.1321" class="difflineplus">+    0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1,</span>
<a href="#l6.1322"></a><span id="l6.1322" class="difflineplus">+    0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1,</span>
<a href="#l6.1323"></a><span id="l6.1323" class="difflineplus">+    0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7,</span>
<a href="#l6.1324"></a><span id="l6.1324" class="difflineplus">+    0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7,</span>
<a href="#l6.1325"></a><span id="l6.1325" class="difflineplus">+    0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9,</span>
<a href="#l6.1326"></a><span id="l6.1326" class="difflineplus">+    0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9,</span>
<a href="#l6.1327"></a><span id="l6.1327" class="difflineplus">+    0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x1fb5, 0x03b1, 0x03b1,</span>
<a href="#l6.1328"></a><span id="l6.1328" class="difflineplus">+    0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x0020, 0x03b9, 0x0020,</span>
<a href="#l6.1329"></a><span id="l6.1329" class="difflineplus">+};</span>
<a href="#l6.1330"></a><span id="l6.1330"> </span>
<a href="#l6.1331"></a><span id="l6.1331"> static const unsigned short gNormalizeTable1fc0[] = {</span>
<a href="#l6.1332"></a><span id="l6.1332" class="difflineminus">-	/* U+1fc0 */</span>
<a href="#l6.1333"></a><span id="l6.1333" class="difflineminus">-	0x0020, 0x0020, 0x03b7, 0x03b7, 0x03b7, 0x1fc5, 0x03b7, 0x03b7, </span>
<a href="#l6.1334"></a><span id="l6.1334" class="difflineminus">-	0x03b5, 0x03b5, 0x03b7, 0x03b7, 0x03b7, 0x0020, 0x0020, 0x0020, </span>
<a href="#l6.1335"></a><span id="l6.1335" class="difflineminus">-	0x03b9, 0x03b9, 0x03b9, 0x03b9, 0x1fd4, 0x1fd5, 0x03b9, 0x03b9, </span>
<a href="#l6.1336"></a><span id="l6.1336" class="difflineminus">-	0x03b9, 0x03b9, 0x03b9, 0x03b9, 0x1fdc, 0x0020, 0x0020, 0x0020, </span>
<a href="#l6.1337"></a><span id="l6.1337" class="difflineminus">-	0x03c5, 0x03c5, 0x03c5, 0x03c5, 0x03c1, 0x03c1, 0x03c5, 0x03c5, </span>
<a href="#l6.1338"></a><span id="l6.1338" class="difflineminus">-	0x03c5, 0x03c5, 0x03c5, 0x03c5, 0x03c1, 0x0020, 0x0020, 0x0060, </span>
<a href="#l6.1339"></a><span id="l6.1339" class="difflineminus">-	0x1ff0, 0x1ff1, 0x03c9, 0x03c9, 0x03c9, 0x1ff5, 0x03c9, 0x03c9, </span>
<a href="#l6.1340"></a><span id="l6.1340" class="difflineminus">-	0x03bf, 0x03bf, 0x03c9, 0x03c9, 0x03c9, 0x0020, 0x0020, 0x1fff, </span>
<a href="#l6.1341"></a><span id="l6.1341" class="difflineminus">-	};</span>
<a href="#l6.1342"></a><span id="l6.1342" class="difflineplus">+    /* U+1fc0 */</span>
<a href="#l6.1343"></a><span id="l6.1343" class="difflineplus">+    0x0020, 0x0020, 0x03b7, 0x03b7, 0x03b7, 0x1fc5, 0x03b7, 0x03b7,</span>
<a href="#l6.1344"></a><span id="l6.1344" class="difflineplus">+    0x03b5, 0x03b5, 0x03b7, 0x03b7, 0x03b7, 0x0020, 0x0020, 0x0020,</span>
<a href="#l6.1345"></a><span id="l6.1345" class="difflineplus">+    0x03b9, 0x03b9, 0x03b9, 0x03b9, 0x1fd4, 0x1fd5, 0x03b9, 0x03b9,</span>
<a href="#l6.1346"></a><span id="l6.1346" class="difflineplus">+    0x03b9, 0x03b9, 0x03b9, 0x03b9, 0x1fdc, 0x0020, 0x0020, 0x0020,</span>
<a href="#l6.1347"></a><span id="l6.1347" class="difflineplus">+    0x03c5, 0x03c5, 0x03c5, 0x03c5, 0x03c1, 0x03c1, 0x03c5, 0x03c5,</span>
<a href="#l6.1348"></a><span id="l6.1348" class="difflineplus">+    0x03c5, 0x03c5, 0x03c5, 0x03c5, 0x03c1, 0x0020, 0x0020, 0x0060,</span>
<a href="#l6.1349"></a><span id="l6.1349" class="difflineplus">+    0x1ff0, 0x1ff1, 0x03c9, 0x03c9, 0x03c9, 0x1ff5, 0x03c9, 0x03c9,</span>
<a href="#l6.1350"></a><span id="l6.1350" class="difflineplus">+    0x03bf, 0x03bf, 0x03c9, 0x03c9, 0x03c9, 0x0020, 0x0020, 0x1fff,</span>
<a href="#l6.1351"></a><span id="l6.1351" class="difflineplus">+};</span>
<a href="#l6.1352"></a><span id="l6.1352"> </span>
<a href="#l6.1353"></a><span id="l6.1353"> static const unsigned short gNormalizeTable2000[] = {</span>
<a href="#l6.1354"></a><span id="l6.1354" class="difflineminus">-	/* U+2000 */</span>
<a href="#l6.1355"></a><span id="l6.1355" class="difflineminus">-	0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, </span>
<a href="#l6.1356"></a><span id="l6.1356" class="difflineminus">-	0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, </span>
<a href="#l6.1357"></a><span id="l6.1357" class="difflineminus">-	0x2010, 0x2010, 0x2012, 0x2013, 0x2014, 0x2015, 0x2016, 0x0020, </span>
<a href="#l6.1358"></a><span id="l6.1358" class="difflineminus">-	0x2018, 0x2019, 0x201a, 0x201b, 0x201c, 0x201d, 0x201e, 0x201f, </span>
<a href="#l6.1359"></a><span id="l6.1359" class="difflineminus">-	0x2020, 0x2021, 0x2022, 0x2023, 0x002e, 0x002e, 0x002e, 0x2027, </span>
<a href="#l6.1360"></a><span id="l6.1360" class="difflineminus">-	0x2028, 0x2029, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, </span>
<a href="#l6.1361"></a><span id="l6.1361" class="difflineminus">-	0x2030, 0x2031, 0x2032, 0x2032, 0x2032, 0x2035, 0x2035, 0x2035, </span>
<a href="#l6.1362"></a><span id="l6.1362" class="difflineminus">-	0x2038, 0x2039, 0x203a, 0x203b, 0x0021, 0x203d, 0x0020, 0x203f, </span>
<a href="#l6.1363"></a><span id="l6.1363" class="difflineminus">-	};</span>
<a href="#l6.1364"></a><span id="l6.1364" class="difflineplus">+    /* U+2000 */</span>
<a href="#l6.1365"></a><span id="l6.1365" class="difflineplus">+    0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020,</span>
<a href="#l6.1366"></a><span id="l6.1366" class="difflineplus">+    0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020,</span>
<a href="#l6.1367"></a><span id="l6.1367" class="difflineplus">+    0x2010, 0x2010, 0x2012, 0x2013, 0x2014, 0x2015, 0x2016, 0x0020,</span>
<a href="#l6.1368"></a><span id="l6.1368" class="difflineplus">+    0x2018, 0x2019, 0x201a, 0x201b, 0x201c, 0x201d, 0x201e, 0x201f,</span>
<a href="#l6.1369"></a><span id="l6.1369" class="difflineplus">+    0x2020, 0x2021, 0x2022, 0x2023, 0x002e, 0x002e, 0x002e, 0x2027,</span>
<a href="#l6.1370"></a><span id="l6.1370" class="difflineplus">+    0x2028, 0x2029, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020,</span>
<a href="#l6.1371"></a><span id="l6.1371" class="difflineplus">+    0x2030, 0x2031, 0x2032, 0x2032, 0x2032, 0x2035, 0x2035, 0x2035,</span>
<a href="#l6.1372"></a><span id="l6.1372" class="difflineplus">+    0x2038, 0x2039, 0x203a, 0x203b, 0x0021, 0x203d, 0x0020, 0x203f,</span>
<a href="#l6.1373"></a><span id="l6.1373" class="difflineplus">+};</span>
<a href="#l6.1374"></a><span id="l6.1374"> </span>
<a href="#l6.1375"></a><span id="l6.1375"> static const unsigned short gNormalizeTable2040[] = {</span>
<a href="#l6.1376"></a><span id="l6.1376" class="difflineminus">-	/* U+2040 */</span>
<a href="#l6.1377"></a><span id="l6.1377" class="difflineminus">-	0x2040, 0x2041, 0x2042, 0x2043, 0x2044, 0x2045, 0x2046, 0x003f, </span>
<a href="#l6.1378"></a><span id="l6.1378" class="difflineminus">-	0x003f, 0x0021, 0x204a, 0x204b, 0x204c, 0x204d, 0x204e, 0x204f, </span>
<a href="#l6.1379"></a><span id="l6.1379" class="difflineminus">-	0x2050, 0x2051, 0x2052, 0x2053, 0x2054, 0x2055, 0x2056, 0x2032, </span>
<a href="#l6.1380"></a><span id="l6.1380" class="difflineminus">-	0x2058, 0x2059, 0x205a, 0x205b, 0x205c, 0x205d, 0x205e, 0x0020, </span>
<a href="#l6.1381"></a><span id="l6.1381" class="difflineminus">-	0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, </span>
<a href="#l6.1382"></a><span id="l6.1382" class="difflineminus">-	0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, </span>
<a href="#l6.1383"></a><span id="l6.1383" class="difflineminus">-	0x0030, 0x0069, 0x2072, 0x2073, 0x0034, 0x0035, 0x0036, 0x0037, </span>
<a href="#l6.1384"></a><span id="l6.1384" class="difflineminus">-	0x0038, 0x0039, 0x002b, 0x2212, 0x003d, 0x0028, 0x0029, 0x006e, </span>
<a href="#l6.1385"></a><span id="l6.1385" class="difflineminus">-	};</span>
<a href="#l6.1386"></a><span id="l6.1386" class="difflineplus">+    /* U+2040 */</span>
<a href="#l6.1387"></a><span id="l6.1387" class="difflineplus">+    0x2040, 0x2041, 0x2042, 0x2043, 0x2044, 0x2045, 0x2046, 0x003f,</span>
<a href="#l6.1388"></a><span id="l6.1388" class="difflineplus">+    0x003f, 0x0021, 0x204a, 0x204b, 0x204c, 0x204d, 0x204e, 0x204f,</span>
<a href="#l6.1389"></a><span id="l6.1389" class="difflineplus">+    0x2050, 0x2051, 0x2052, 0x2053, 0x2054, 0x2055, 0x2056, 0x2032,</span>
<a href="#l6.1390"></a><span id="l6.1390" class="difflineplus">+    0x2058, 0x2059, 0x205a, 0x205b, 0x205c, 0x205d, 0x205e, 0x0020,</span>
<a href="#l6.1391"></a><span id="l6.1391" class="difflineplus">+    0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020,</span>
<a href="#l6.1392"></a><span id="l6.1392" class="difflineplus">+    0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020,</span>
<a href="#l6.1393"></a><span id="l6.1393" class="difflineplus">+    0x0030, 0x0069, 0x2072, 0x2073, 0x0034, 0x0035, 0x0036, 0x0037,</span>
<a href="#l6.1394"></a><span id="l6.1394" class="difflineplus">+    0x0038, 0x0039, 0x002b, 0x2212, 0x003d, 0x0028, 0x0029, 0x006e,</span>
<a href="#l6.1395"></a><span id="l6.1395" class="difflineplus">+};</span>
<a href="#l6.1396"></a><span id="l6.1396"> </span>
<a href="#l6.1397"></a><span id="l6.1397"> static const unsigned short gNormalizeTable2080[] = {</span>
<a href="#l6.1398"></a><span id="l6.1398" class="difflineminus">-	/* U+2080 */</span>
<a href="#l6.1399"></a><span id="l6.1399" class="difflineminus">-	0x0030, 0x0031, 0x0032, 0x0033, 0x0034, 0x0035, 0x0036, 0x0037, </span>
<a href="#l6.1400"></a><span id="l6.1400" class="difflineminus">-	0x0038, 0x0039, 0x002b, 0x2212, 0x003d, 0x0028, 0x0029, 0x208f, </span>
<a href="#l6.1401"></a><span id="l6.1401" class="difflineminus">-	0x0061, 0x0065, 0x006f, 0x0078, 0x0259, 0x2095, 0x2096, 0x2097, </span>
<a href="#l6.1402"></a><span id="l6.1402" class="difflineminus">-	0x2098, 0x2099, 0x209a, 0x209b, 0x209c, 0x209d, 0x209e, 0x209f, </span>
<a href="#l6.1403"></a><span id="l6.1403" class="difflineminus">-	0x20a0, 0x20a1, 0x20a2, 0x20a3, 0x20a4, 0x20a5, 0x20a6, 0x20a7, </span>
<a href="#l6.1404"></a><span id="l6.1404" class="difflineminus">-	0x0072, 0x20a9, 0x20aa, 0x20ab, 0x20ac, 0x20ad, 0x20ae, 0x20af, </span>
<a href="#l6.1405"></a><span id="l6.1405" class="difflineminus">-	0x20b0, 0x20b1, 0x20b2, 0x20b3, 0x20b4, 0x20b5, 0x20b6, 0x20b7, </span>
<a href="#l6.1406"></a><span id="l6.1406" class="difflineminus">-	0x20b8, 0x20b9, 0x20ba, 0x20bb, 0x20bc, 0x20bd, 0x20be, 0x20bf, </span>
<a href="#l6.1407"></a><span id="l6.1407" class="difflineminus">-	};</span>
<a href="#l6.1408"></a><span id="l6.1408" class="difflineplus">+    /* U+2080 */</span>
<a href="#l6.1409"></a><span id="l6.1409" class="difflineplus">+    0x0030, 0x0031, 0x0032, 0x0033, 0x0034, 0x0035, 0x0036, 0x0037,</span>
<a href="#l6.1410"></a><span id="l6.1410" class="difflineplus">+    0x0038, 0x0039, 0x002b, 0x2212, 0x003d, 0x0028, 0x0029, 0x208f,</span>
<a href="#l6.1411"></a><span id="l6.1411" class="difflineplus">+    0x0061, 0x0065, 0x006f, 0x0078, 0x0259, 0x2095, 0x2096, 0x2097,</span>
<a href="#l6.1412"></a><span id="l6.1412" class="difflineplus">+    0x2098, 0x2099, 0x209a, 0x209b, 0x209c, 0x209d, 0x209e, 0x209f,</span>
<a href="#l6.1413"></a><span id="l6.1413" class="difflineplus">+    0x20a0, 0x20a1, 0x20a2, 0x20a3, 0x20a4, 0x20a5, 0x20a6, 0x20a7,</span>
<a href="#l6.1414"></a><span id="l6.1414" class="difflineplus">+    0x0072, 0x20a9, 0x20aa, 0x20ab, 0x20ac, 0x20ad, 0x20ae, 0x20af,</span>
<a href="#l6.1415"></a><span id="l6.1415" class="difflineplus">+    0x20b0, 0x20b1, 0x20b2, 0x20b3, 0x20b4, 0x20b5, 0x20b6, 0x20b7,</span>
<a href="#l6.1416"></a><span id="l6.1416" class="difflineplus">+    0x20b8, 0x20b9, 0x20ba, 0x20bb, 0x20bc, 0x20bd, 0x20be, 0x20bf,</span>
<a href="#l6.1417"></a><span id="l6.1417" class="difflineplus">+};</span>
<a href="#l6.1418"></a><span id="l6.1418"> </span>
<a href="#l6.1419"></a><span id="l6.1419"> static const unsigned short gNormalizeTable2100[] = {</span>
<a href="#l6.1420"></a><span id="l6.1420" class="difflineminus">-	/* U+2100 */</span>
<a href="#l6.1421"></a><span id="l6.1421" class="difflineminus">-	0x0061, 0x0061, 0x0063, 0x00b0, 0x2104, 0x0063, 0x0063, 0x025b, </span>
<a href="#l6.1422"></a><span id="l6.1422" class="difflineminus">-	0x2108, 0x00b0, 0x0067, 0x0068, 0x0068, 0x0068, 0x0068, 0x0127, </span>
<a href="#l6.1423"></a><span id="l6.1423" class="difflineminus">-	0x0069, 0x0069, 0x006c, 0x006c, 0x2114, 0x006e, 0x006e, 0x2117, </span>
<a href="#l6.1424"></a><span id="l6.1424" class="difflineminus">-	0x2118, 0x0070, 0x0071, 0x0072, 0x0072, 0x0072, 0x211e, 0x211f, </span>
<a href="#l6.1425"></a><span id="l6.1425" class="difflineminus">-	0x0073, 0x0074, 0x0074, 0x2123, 0x007a, 0x2125, 0x03c9, 0x2127, </span>
<a href="#l6.1426"></a><span id="l6.1426" class="difflineminus">-	0x007a, 0x2129, 0x006b, 0x0061, 0x0062, 0x0063, 0x212e, 0x0065, </span>
<a href="#l6.1427"></a><span id="l6.1427" class="difflineminus">-	0x0065, 0x0066, 0x214e, 0x006d, 0x006f, 0x05d0, 0x05d1, 0x05d2, </span>
<a href="#l6.1428"></a><span id="l6.1428" class="difflineminus">-	0x05d3, 0x0069, 0x213a, 0x0066, 0x03c0, 0x03b3, 0x03b3, 0x03c0, </span>
<a href="#l6.1429"></a><span id="l6.1429" class="difflineminus">-	};</span>
<a href="#l6.1430"></a><span id="l6.1430" class="difflineplus">+    /* U+2100 */</span>
<a href="#l6.1431"></a><span id="l6.1431" class="difflineplus">+    0x0061, 0x0061, 0x0063, 0x00b0, 0x2104, 0x0063, 0x0063, 0x025b,</span>
<a href="#l6.1432"></a><span id="l6.1432" class="difflineplus">+    0x2108, 0x00b0, 0x0067, 0x0068, 0x0068, 0x0068, 0x0068, 0x0127,</span>
<a href="#l6.1433"></a><span id="l6.1433" class="difflineplus">+    0x0069, 0x0069, 0x006c, 0x006c, 0x2114, 0x006e, 0x006e, 0x2117,</span>
<a href="#l6.1434"></a><span id="l6.1434" class="difflineplus">+    0x2118, 0x0070, 0x0071, 0x0072, 0x0072, 0x0072, 0x211e, 0x211f,</span>
<a href="#l6.1435"></a><span id="l6.1435" class="difflineplus">+    0x0073, 0x0074, 0x0074, 0x2123, 0x007a, 0x2125, 0x03c9, 0x2127,</span>
<a href="#l6.1436"></a><span id="l6.1436" class="difflineplus">+    0x007a, 0x2129, 0x006b, 0x0061, 0x0062, 0x0063, 0x212e, 0x0065,</span>
<a href="#l6.1437"></a><span id="l6.1437" class="difflineplus">+    0x0065, 0x0066, 0x214e, 0x006d, 0x006f, 0x05d0, 0x05d1, 0x05d2,</span>
<a href="#l6.1438"></a><span id="l6.1438" class="difflineplus">+    0x05d3, 0x0069, 0x213a, 0x0066, 0x03c0, 0x03b3, 0x03b3, 0x03c0,</span>
<a href="#l6.1439"></a><span id="l6.1439" class="difflineplus">+};</span>
<a href="#l6.1440"></a><span id="l6.1440"> </span>
<a href="#l6.1441"></a><span id="l6.1441"> static const unsigned short gNormalizeTable2140[] = {</span>
<a href="#l6.1442"></a><span id="l6.1442" class="difflineminus">-	/* U+2140 */</span>
<a href="#l6.1443"></a><span id="l6.1443" class="difflineminus">-	0x2211, 0x2141, 0x2142, 0x2143, 0x2144, 0x0064, 0x0064, 0x0065, </span>
<a href="#l6.1444"></a><span id="l6.1444" class="difflineminus">-	0x0069, 0x006a, 0x214a, 0x214b, 0x214c, 0x214d, 0x214e, 0x214f, </span>
<a href="#l6.1445"></a><span id="l6.1445" class="difflineminus">-	0x0031, 0x0031, 0x0031, 0x0031, 0x0032, 0x0031, 0x0032, 0x0033, </span>
<a href="#l6.1446"></a><span id="l6.1446" class="difflineminus">-	0x0034, 0x0031, 0x0035, 0x0031, 0x0033, 0x0035, 0x0037, 0x0031, </span>
<a href="#l6.1447"></a><span id="l6.1447" class="difflineminus">-	0x0069, 0x0069, 0x0069, 0x0069, 0x0076, 0x0076, 0x0076, 0x0076, </span>
<a href="#l6.1448"></a><span id="l6.1448" class="difflineminus">-	0x0069, 0x0078, 0x0078, 0x0078, 0x006c, 0x0063, 0x0064, 0x006d, </span>
<a href="#l6.1449"></a><span id="l6.1449" class="difflineminus">-	0x0069, 0x0069, 0x0069, 0x0069, 0x0076, 0x0076, 0x0076, 0x0076, </span>
<a href="#l6.1450"></a><span id="l6.1450" class="difflineminus">-	0x0069, 0x0078, 0x0078, 0x0078, 0x006c, 0x0063, 0x0064, 0x006d, </span>
<a href="#l6.1451"></a><span id="l6.1451" class="difflineminus">-	};</span>
<a href="#l6.1452"></a><span id="l6.1452" class="difflineplus">+    /* U+2140 */</span>
<a href="#l6.1453"></a><span id="l6.1453" class="difflineplus">+    0x2211, 0x2141, 0x2142, 0x2143, 0x2144, 0x0064, 0x0064, 0x0065,</span>
<a href="#l6.1454"></a><span id="l6.1454" class="difflineplus">+    0x0069, 0x006a, 0x214a, 0x214b, 0x214c, 0x214d, 0x214e, 0x214f,</span>
<a href="#l6.1455"></a><span id="l6.1455" class="difflineplus">+    0x0031, 0x0031, 0x0031, 0x0031, 0x0032, 0x0031, 0x0032, 0x0033,</span>
<a href="#l6.1456"></a><span id="l6.1456" class="difflineplus">+    0x0034, 0x0031, 0x0035, 0x0031, 0x0033, 0x0035, 0x0037, 0x0031,</span>
<a href="#l6.1457"></a><span id="l6.1457" class="difflineplus">+    0x0069, 0x0069, 0x0069, 0x0069, 0x0076, 0x0076, 0x0076, 0x0076,</span>
<a href="#l6.1458"></a><span id="l6.1458" class="difflineplus">+    0x0069, 0x0078, 0x0078, 0x0078, 0x006c, 0x0063, 0x0064, 0x006d,</span>
<a href="#l6.1459"></a><span id="l6.1459" class="difflineplus">+    0x0069, 0x0069, 0x0069, 0x0069, 0x0076, 0x0076, 0x0076, 0x0076,</span>
<a href="#l6.1460"></a><span id="l6.1460" class="difflineplus">+    0x0069, 0x0078, 0x0078, 0x0078, 0x006c, 0x0063, 0x0064, 0x006d,</span>
<a href="#l6.1461"></a><span id="l6.1461" class="difflineplus">+};</span>
<a href="#l6.1462"></a><span id="l6.1462"> </span>
<a href="#l6.1463"></a><span id="l6.1463"> static const unsigned short gNormalizeTable2180[] = {</span>
<a href="#l6.1464"></a><span id="l6.1464" class="difflineminus">-	/* U+2180 */</span>
<a href="#l6.1465"></a><span id="l6.1465" class="difflineminus">-	0x2180, 0x2181, 0x2182, 0x2184, 0x2184, 0x2185, 0x2186, 0x2187, </span>
<a href="#l6.1466"></a><span id="l6.1466" class="difflineminus">-	0x2188, 0x0030, 0x218a, 0x218b, 0x218c, 0x218d, 0x218e, 0x218f, </span>
<a href="#l6.1467"></a><span id="l6.1467" class="difflineminus">-	0x2190, 0x2191, 0x2192, 0x2193, 0x2194, 0x2195, 0x2196, 0x2197, </span>
<a href="#l6.1468"></a><span id="l6.1468" class="difflineminus">-	0x2198, 0x2199, 0x2190, 0x2192, 0x219c, 0x219d, 0x219e, 0x219f, </span>
<a href="#l6.1469"></a><span id="l6.1469" class="difflineminus">-	0x21a0, 0x21a1, 0x21a2, 0x21a3, 0x21a4, 0x21a5, 0x21a6, 0x21a7, </span>
<a href="#l6.1470"></a><span id="l6.1470" class="difflineminus">-	0x21a8, 0x21a9, 0x21aa, 0x21ab, 0x21ac, 0x21ad, 0x2194, 0x21af, </span>
<a href="#l6.1471"></a><span id="l6.1471" class="difflineminus">-	0x21b0, 0x21b1, 0x21b2, 0x21b3, 0x21b4, 0x21b5, 0x21b6, 0x21b7, </span>
<a href="#l6.1472"></a><span id="l6.1472" class="difflineminus">-	0x21b8, 0x21b9, 0x21ba, 0x21bb, 0x21bc, 0x21bd, 0x21be, 0x21bf, </span>
<a href="#l6.1473"></a><span id="l6.1473" class="difflineminus">-	};</span>
<a href="#l6.1474"></a><span id="l6.1474" class="difflineplus">+    /* U+2180 */</span>
<a href="#l6.1475"></a><span id="l6.1475" class="difflineplus">+    0x2180, 0x2181, 0x2182, 0x2184, 0x2184, 0x2185, 0x2186, 0x2187,</span>
<a href="#l6.1476"></a><span id="l6.1476" class="difflineplus">+    0x2188, 0x0030, 0x218a, 0x218b, 0x218c, 0x218d, 0x218e, 0x218f,</span>
<a href="#l6.1477"></a><span id="l6.1477" class="difflineplus">+    0x2190, 0x2191, 0x2192, 0x2193, 0x2194, 0x2195, 0x2196, 0x2197,</span>
<a href="#l6.1478"></a><span id="l6.1478" class="difflineplus">+    0x2198, 0x2199, 0x2190, 0x2192, 0x219c, 0x219d, 0x219e, 0x219f,</span>
<a href="#l6.1479"></a><span id="l6.1479" class="difflineplus">+    0x21a0, 0x21a1, 0x21a2, 0x21a3, 0x21a4, 0x21a5, 0x21a6, 0x21a7,</span>
<a href="#l6.1480"></a><span id="l6.1480" class="difflineplus">+    0x21a8, 0x21a9, 0x21aa, 0x21ab, 0x21ac, 0x21ad, 0x2194, 0x21af,</span>
<a href="#l6.1481"></a><span id="l6.1481" class="difflineplus">+    0x21b0, 0x21b1, 0x21b2, 0x21b3, 0x21b4, 0x21b5, 0x21b6, 0x21b7,</span>
<a href="#l6.1482"></a><span id="l6.1482" class="difflineplus">+    0x21b8, 0x21b9, 0x21ba, 0x21bb, 0x21bc, 0x21bd, 0x21be, 0x21bf,</span>
<a href="#l6.1483"></a><span id="l6.1483" class="difflineplus">+};</span>
<a href="#l6.1484"></a><span id="l6.1484"> </span>
<a href="#l6.1485"></a><span id="l6.1485"> static const unsigned short gNormalizeTable21c0[] = {</span>
<a href="#l6.1486"></a><span id="l6.1486" class="difflineminus">-	/* U+21c0 */</span>
<a href="#l6.1487"></a><span id="l6.1487" class="difflineminus">-	0x21c0, 0x21c1, 0x21c2, 0x21c3, 0x21c4, 0x21c5, 0x21c6, 0x21c7, </span>
<a href="#l6.1488"></a><span id="l6.1488" class="difflineminus">-	0x21c8, 0x21c9, 0x21ca, 0x21cb, 0x21cc, 0x21d0, 0x21d4, 0x21d2, </span>
<a href="#l6.1489"></a><span id="l6.1489" class="difflineminus">-	0x21d0, 0x21d1, 0x21d2, 0x21d3, 0x21d4, 0x21d5, 0x21d6, 0x21d7, </span>
<a href="#l6.1490"></a><span id="l6.1490" class="difflineminus">-	0x21d8, 0x21d9, 0x21da, 0x21db, 0x21dc, 0x21dd, 0x21de, 0x21df, </span>
<a href="#l6.1491"></a><span id="l6.1491" class="difflineminus">-	0x21e0, 0x21e1, 0x21e2, 0x21e3, 0x21e4, 0x21e5, 0x21e6, 0x21e7, </span>
<a href="#l6.1492"></a><span id="l6.1492" class="difflineminus">-	0x21e8, 0x21e9, 0x21ea, 0x21eb, 0x21ec, 0x21ed, 0x21ee, 0x21ef, </span>
<a href="#l6.1493"></a><span id="l6.1493" class="difflineminus">-	0x21f0, 0x21f1, 0x21f2, 0x21f3, 0x21f4, 0x21f5, 0x21f6, 0x21f7, </span>
<a href="#l6.1494"></a><span id="l6.1494" class="difflineminus">-	0x21f8, 0x21f9, 0x21fa, 0x21fb, 0x21fc, 0x21fd, 0x21fe, 0x21ff, </span>
<a href="#l6.1495"></a><span id="l6.1495" class="difflineminus">-	};</span>
<a href="#l6.1496"></a><span id="l6.1496" class="difflineplus">+    /* U+21c0 */</span>
<a href="#l6.1497"></a><span id="l6.1497" class="difflineplus">+    0x21c0, 0x21c1, 0x21c2, 0x21c3, 0x21c4, 0x21c5, 0x21c6, 0x21c7,</span>
<a href="#l6.1498"></a><span id="l6.1498" class="difflineplus">+    0x21c8, 0x21c9, 0x21ca, 0x21cb, 0x21cc, 0x21d0, 0x21d4, 0x21d2,</span>
<a href="#l6.1499"></a><span id="l6.1499" class="difflineplus">+    0x21d0, 0x21d1, 0x21d2, 0x21d3, 0x21d4, 0x21d5, 0x21d6, 0x21d7,</span>
<a href="#l6.1500"></a><span id="l6.1500" class="difflineplus">+    0x21d8, 0x21d9, 0x21da, 0x21db, 0x21dc, 0x21dd, 0x21de, 0x21df,</span>
<a href="#l6.1501"></a><span id="l6.1501" class="difflineplus">+    0x21e0, 0x21e1, 0x21e2, 0x21e3, 0x21e4, 0x21e5, 0x21e6, 0x21e7,</span>
<a href="#l6.1502"></a><span id="l6.1502" class="difflineplus">+    0x21e8, 0x21e9, 0x21ea, 0x21eb, 0x21ec, 0x21ed, 0x21ee, 0x21ef,</span>
<a href="#l6.1503"></a><span id="l6.1503" class="difflineplus">+    0x21f0, 0x21f1, 0x21f2, 0x21f3, 0x21f4, 0x21f5, 0x21f6, 0x21f7,</span>
<a href="#l6.1504"></a><span id="l6.1504" class="difflineplus">+    0x21f8, 0x21f9, 0x21fa, 0x21fb, 0x21fc, 0x21fd, 0x21fe, 0x21ff,</span>
<a href="#l6.1505"></a><span id="l6.1505" class="difflineplus">+};</span>
<a href="#l6.1506"></a><span id="l6.1506"> </span>
<a href="#l6.1507"></a><span id="l6.1507"> static const unsigned short gNormalizeTable2200[] = {</span>
<a href="#l6.1508"></a><span id="l6.1508" class="difflineminus">-	/* U+2200 */</span>
<a href="#l6.1509"></a><span id="l6.1509" class="difflineminus">-	0x2200, 0x2201, 0x2202, 0x2203, 0x2203, 0x2205, 0x2206, 0x2207, </span>
<a href="#l6.1510"></a><span id="l6.1510" class="difflineminus">-	0x2208, 0x2208, 0x220a, 0x220b, 0x220b, 0x220d, 0x220e, 0x220f, </span>
<a href="#l6.1511"></a><span id="l6.1511" class="difflineminus">-	0x2210, 0x2211, 0x2212, 0x2213, 0x2214, 0x2215, 0x2216, 0x2217, </span>
<a href="#l6.1512"></a><span id="l6.1512" class="difflineminus">-	0x2218, 0x2219, 0x221a, 0x221b, 0x221c, 0x221d, 0x221e, 0x221f, </span>
<a href="#l6.1513"></a><span id="l6.1513" class="difflineminus">-	0x2220, 0x2221, 0x2222, 0x2223, 0x2223, 0x2225, 0x2225, 0x2227, </span>
<a href="#l6.1514"></a><span id="l6.1514" class="difflineminus">-	0x2228, 0x2229, 0x222a, 0x222b, 0x222b, 0x222b, 0x222e, 0x222e, </span>
<a href="#l6.1515"></a><span id="l6.1515" class="difflineminus">-	0x222e, 0x2231, 0x2232, 0x2233, 0x2234, 0x2235, 0x2236, 0x2237, </span>
<a href="#l6.1516"></a><span id="l6.1516" class="difflineminus">-	0x2238, 0x2239, 0x223a, 0x223b, 0x223c, 0x223d, 0x223e, 0x223f, </span>
<a href="#l6.1517"></a><span id="l6.1517" class="difflineminus">-	};</span>
<a href="#l6.1518"></a><span id="l6.1518" class="difflineplus">+    /* U+2200 */</span>
<a href="#l6.1519"></a><span id="l6.1519" class="difflineplus">+    0x2200, 0x2201, 0x2202, 0x2203, 0x2203, 0x2205, 0x2206, 0x2207,</span>
<a href="#l6.1520"></a><span id="l6.1520" class="difflineplus">+    0x2208, 0x2208, 0x220a, 0x220b, 0x220b, 0x220d, 0x220e, 0x220f,</span>
<a href="#l6.1521"></a><span id="l6.1521" class="difflineplus">+    0x2210, 0x2211, 0x2212, 0x2213, 0x2214, 0x2215, 0x2216, 0x2217,</span>
<a href="#l6.1522"></a><span id="l6.1522" class="difflineplus">+    0x2218, 0x2219, 0x221a, 0x221b, 0x221c, 0x221d, 0x221e, 0x221f,</span>
<a href="#l6.1523"></a><span id="l6.1523" class="difflineplus">+    0x2220, 0x2221, 0x2222, 0x2223, 0x2223, 0x2225, 0x2225, 0x2227,</span>
<a href="#l6.1524"></a><span id="l6.1524" class="difflineplus">+    0x2228, 0x2229, 0x222a, 0x222b, 0x222b, 0x222b, 0x222e, 0x222e,</span>
<a href="#l6.1525"></a><span id="l6.1525" class="difflineplus">+    0x222e, 0x2231, 0x2232, 0x2233, 0x2234, 0x2235, 0x2236, 0x2237,</span>
<a href="#l6.1526"></a><span id="l6.1526" class="difflineplus">+    0x2238, 0x2239, 0x223a, 0x223b, 0x223c, 0x223d, 0x223e, 0x223f,</span>
<a href="#l6.1527"></a><span id="l6.1527" class="difflineplus">+};</span>
<a href="#l6.1528"></a><span id="l6.1528"> </span>
<a href="#l6.1529"></a><span id="l6.1529"> static const unsigned short gNormalizeTable2240[] = {</span>
<a href="#l6.1530"></a><span id="l6.1530" class="difflineminus">-	/* U+2240 */</span>
<a href="#l6.1531"></a><span id="l6.1531" class="difflineminus">-	0x2240, 0x223c, 0x2242, 0x2243, 0x2243, 0x2245, 0x2246, 0x2245, </span>
<a href="#l6.1532"></a><span id="l6.1532" class="difflineminus">-	0x2248, 0x2248, 0x224a, 0x224b, 0x224c, 0x224d, 0x224e, 0x224f, </span>
<a href="#l6.1533"></a><span id="l6.1533" class="difflineminus">-	0x2250, 0x2251, 0x2252, 0x2253, 0x2254, 0x2255, 0x2256, 0x2257, </span>
<a href="#l6.1534"></a><span id="l6.1534" class="difflineminus">-	0x2258, 0x2259, 0x225a, 0x225b, 0x225c, 0x225d, 0x225e, 0x225f, </span>
<a href="#l6.1535"></a><span id="l6.1535" class="difflineminus">-	0x003d, 0x2261, 0x2261, 0x2263, 0x2264, 0x2265, 0x2266, 0x2267, </span>
<a href="#l6.1536"></a><span id="l6.1536" class="difflineminus">-	0x2268, 0x2269, 0x226a, 0x226b, 0x226c, 0x224d, 0x003c, 0x003e, </span>
<a href="#l6.1537"></a><span id="l6.1537" class="difflineminus">-	0x2264, 0x2265, 0x2272, 0x2273, 0x2272, 0x2273, 0x2276, 0x2277, </span>
<a href="#l6.1538"></a><span id="l6.1538" class="difflineminus">-	0x2276, 0x2277, 0x227a, 0x227b, 0x227c, 0x227d, 0x227e, 0x227f, </span>
<a href="#l6.1539"></a><span id="l6.1539" class="difflineminus">-	};</span>
<a href="#l6.1540"></a><span id="l6.1540" class="difflineplus">+    /* U+2240 */</span>
<a href="#l6.1541"></a><span id="l6.1541" class="difflineplus">+    0x2240, 0x223c, 0x2242, 0x2243, 0x2243, 0x2245, 0x2246, 0x2245,</span>
<a href="#l6.1542"></a><span id="l6.1542" class="difflineplus">+    0x2248, 0x2248, 0x224a, 0x224b, 0x224c, 0x224d, 0x224e, 0x224f,</span>
<a href="#l6.1543"></a><span id="l6.1543" class="difflineplus">+    0x2250, 0x2251, 0x2252, 0x2253, 0x2254, 0x2255, 0x2256, 0x2257,</span>
<a href="#l6.1544"></a><span id="l6.1544" class="difflineplus">+    0x2258, 0x2259, 0x225a, 0x225b, 0x225c, 0x225d, 0x225e, 0x225f,</span>
<a href="#l6.1545"></a><span id="l6.1545" class="difflineplus">+    0x003d, 0x2261, 0x2261, 0x2263, 0x2264, 0x2265, 0x2266, 0x2267,</span>
<a href="#l6.1546"></a><span id="l6.1546" class="difflineplus">+    0x2268, 0x2269, 0x226a, 0x226b, 0x226c, 0x224d, 0x003c, 0x003e,</span>
<a href="#l6.1547"></a><span id="l6.1547" class="difflineplus">+    0x2264, 0x2265, 0x2272, 0x2273, 0x2272, 0x2273, 0x2276, 0x2277,</span>
<a href="#l6.1548"></a><span id="l6.1548" class="difflineplus">+    0x2276, 0x2277, 0x227a, 0x227b, 0x227c, 0x227d, 0x227e, 0x227f,</span>
<a href="#l6.1549"></a><span id="l6.1549" class="difflineplus">+};</span>
<a href="#l6.1550"></a><span id="l6.1550"> </span>
<a href="#l6.1551"></a><span id="l6.1551"> static const unsigned short gNormalizeTable2280[] = {</span>
<a href="#l6.1552"></a><span id="l6.1552" class="difflineminus">-	/* U+2280 */</span>
<a href="#l6.1553"></a><span id="l6.1553" class="difflineminus">-	0x227a, 0x227b, 0x2282, 0x2283, 0x2282, 0x2283, 0x2286, 0x2287, </span>
<a href="#l6.1554"></a><span id="l6.1554" class="difflineminus">-	0x2286, 0x2287, 0x228a, 0x228b, 0x228c, 0x228d, 0x228e, 0x228f, </span>
<a href="#l6.1555"></a><span id="l6.1555" class="difflineminus">-	0x2290, 0x2291, 0x2292, 0x2293, 0x2294, 0x2295, 0x2296, 0x2297, </span>
<a href="#l6.1556"></a><span id="l6.1556" class="difflineminus">-	0x2298, 0x2299, 0x229a, 0x229b, 0x229c, 0x229d, 0x229e, 0x229f, </span>
<a href="#l6.1557"></a><span id="l6.1557" class="difflineminus">-	0x22a0, 0x22a1, 0x22a2, 0x22a3, 0x22a4, 0x22a5, 0x22a6, 0x22a7, </span>
<a href="#l6.1558"></a><span id="l6.1558" class="difflineminus">-	0x22a8, 0x22a9, 0x22aa, 0x22ab, 0x22a2, 0x22a8, 0x22a9, 0x22ab, </span>
<a href="#l6.1559"></a><span id="l6.1559" class="difflineminus">-	0x22b0, 0x22b1, 0x22b2, 0x22b3, 0x22b4, 0x22b5, 0x22b6, 0x22b7, </span>
<a href="#l6.1560"></a><span id="l6.1560" class="difflineminus">-	0x22b8, 0x22b9, 0x22ba, 0x22bb, 0x22bc, 0x22bd, 0x22be, 0x22bf, </span>
<a href="#l6.1561"></a><span id="l6.1561" class="difflineminus">-	};</span>
<a href="#l6.1562"></a><span id="l6.1562" class="difflineplus">+    /* U+2280 */</span>
<a href="#l6.1563"></a><span id="l6.1563" class="difflineplus">+    0x227a, 0x227b, 0x2282, 0x2283, 0x2282, 0x2283, 0x2286, 0x2287,</span>
<a href="#l6.1564"></a><span id="l6.1564" class="difflineplus">+    0x2286, 0x2287, 0x228a, 0x228b, 0x228c, 0x228d, 0x228e, 0x228f,</span>
<a href="#l6.1565"></a><span id="l6.1565" class="difflineplus">+    0x2290, 0x2291, 0x2292, 0x2293, 0x2294, 0x2295, 0x2296, 0x2297,</span>
<a href="#l6.1566"></a><span id="l6.1566" class="difflineplus">+    0x2298, 0x2299, 0x229a, 0x229b, 0x229c, 0x229d, 0x229e, 0x229f,</span>
<a href="#l6.1567"></a><span id="l6.1567" class="difflineplus">+    0x22a0, 0x22a1, 0x22a2, 0x22a3, 0x22a4, 0x22a5, 0x22a6, 0x22a7,</span>
<a href="#l6.1568"></a><span id="l6.1568" class="difflineplus">+    0x22a8, 0x22a9, 0x22aa, 0x22ab, 0x22a2, 0x22a8, 0x22a9, 0x22ab,</span>
<a href="#l6.1569"></a><span id="l6.1569" class="difflineplus">+    0x22b0, 0x22b1, 0x22b2, 0x22b3, 0x22b4, 0x22b5, 0x22b6, 0x22b7,</span>
<a href="#l6.1570"></a><span id="l6.1570" class="difflineplus">+    0x22b8, 0x22b9, 0x22ba, 0x22bb, 0x22bc, 0x22bd, 0x22be, 0x22bf,</span>
<a href="#l6.1571"></a><span id="l6.1571" class="difflineplus">+};</span>
<a href="#l6.1572"></a><span id="l6.1572"> </span>
<a href="#l6.1573"></a><span id="l6.1573"> static const unsigned short gNormalizeTable22c0[] = {</span>
<a href="#l6.1574"></a><span id="l6.1574" class="difflineminus">-	/* U+22c0 */</span>
<a href="#l6.1575"></a><span id="l6.1575" class="difflineminus">-	0x22c0, 0x22c1, 0x22c2, 0x22c3, 0x22c4, 0x22c5, 0x22c6, 0x22c7, </span>
<a href="#l6.1576"></a><span id="l6.1576" class="difflineminus">-	0x22c8, 0x22c9, 0x22ca, 0x22cb, 0x22cc, 0x22cd, 0x22ce, 0x22cf, </span>
<a href="#l6.1577"></a><span id="l6.1577" class="difflineminus">-	0x22d0, 0x22d1, 0x22d2, 0x22d3, 0x22d4, 0x22d5, 0x22d6, 0x22d7, </span>
<a href="#l6.1578"></a><span id="l6.1578" class="difflineminus">-	0x22d8, 0x22d9, 0x22da, 0x22db, 0x22dc, 0x22dd, 0x22de, 0x22df, </span>
<a href="#l6.1579"></a><span id="l6.1579" class="difflineminus">-	0x227c, 0x227d, 0x2291, 0x2292, 0x22e4, 0x22e5, 0x22e6, 0x22e7, </span>
<a href="#l6.1580"></a><span id="l6.1580" class="difflineminus">-	0x22e8, 0x22e9, 0x22b2, 0x22b3, 0x22b4, 0x22b5, 0x22ee, 0x22ef, </span>
<a href="#l6.1581"></a><span id="l6.1581" class="difflineminus">-	0x22f0, 0x22f1, 0x22f2, 0x22f3, 0x22f4, 0x22f5, 0x22f6, 0x22f7, </span>
<a href="#l6.1582"></a><span id="l6.1582" class="difflineminus">-	0x22f8, 0x22f9, 0x22fa, 0x22fb, 0x22fc, 0x22fd, 0x22fe, 0x22ff, </span>
<a href="#l6.1583"></a><span id="l6.1583" class="difflineminus">-	};</span>
<a href="#l6.1584"></a><span id="l6.1584" class="difflineplus">+    /* U+22c0 */</span>
<a href="#l6.1585"></a><span id="l6.1585" class="difflineplus">+    0x22c0, 0x22c1, 0x22c2, 0x22c3, 0x22c4, 0x22c5, 0x22c6, 0x22c7,</span>
<a href="#l6.1586"></a><span id="l6.1586" class="difflineplus">+    0x22c8, 0x22c9, 0x22ca, 0x22cb, 0x22cc, 0x22cd, 0x22ce, 0x22cf,</span>
<a href="#l6.1587"></a><span id="l6.1587" class="difflineplus">+    0x22d0, 0x22d1, 0x22d2, 0x22d3, 0x22d4, 0x22d5, 0x22d6, 0x22d7,</span>
<a href="#l6.1588"></a><span id="l6.1588" class="difflineplus">+    0x22d8, 0x22d9, 0x22da, 0x22db, 0x22dc, 0x22dd, 0x22de, 0x22df,</span>
<a href="#l6.1589"></a><span id="l6.1589" class="difflineplus">+    0x227c, 0x227d, 0x2291, 0x2292, 0x22e4, 0x22e5, 0x22e6, 0x22e7,</span>
<a href="#l6.1590"></a><span id="l6.1590" class="difflineplus">+    0x22e8, 0x22e9, 0x22b2, 0x22b3, 0x22b4, 0x22b5, 0x22ee, 0x22ef,</span>
<a href="#l6.1591"></a><span id="l6.1591" class="difflineplus">+    0x22f0, 0x22f1, 0x22f2, 0x22f3, 0x22f4, 0x22f5, 0x22f6, 0x22f7,</span>
<a href="#l6.1592"></a><span id="l6.1592" class="difflineplus">+    0x22f8, 0x22f9, 0x22fa, 0x22fb, 0x22fc, 0x22fd, 0x22fe, 0x22ff,</span>
<a href="#l6.1593"></a><span id="l6.1593" class="difflineplus">+};</span>
<a href="#l6.1594"></a><span id="l6.1594"> </span>
<a href="#l6.1595"></a><span id="l6.1595"> static const unsigned short gNormalizeTable2300[] = {</span>
<a href="#l6.1596"></a><span id="l6.1596" class="difflineminus">-	/* U+2300 */</span>
<a href="#l6.1597"></a><span id="l6.1597" class="difflineminus">-	0x2300, 0x2301, 0x2302, 0x2303, 0x2304, 0x2305, 0x2306, 0x2307, </span>
<a href="#l6.1598"></a><span id="l6.1598" class="difflineminus">-	0x2308, 0x2309, 0x230a, 0x230b, 0x230c, 0x230d, 0x230e, 0x230f, </span>
<a href="#l6.1599"></a><span id="l6.1599" class="difflineminus">-	0x2310, 0x2311, 0x2312, 0x2313, 0x2314, 0x2315, 0x2316, 0x2317, </span>
<a href="#l6.1600"></a><span id="l6.1600" class="difflineminus">-	0x2318, 0x2319, 0x231a, 0x231b, 0x231c, 0x231d, 0x231e, 0x231f, </span>
<a href="#l6.1601"></a><span id="l6.1601" class="difflineminus">-	0x2320, 0x2321, 0x2322, 0x2323, 0x2324, 0x2325, 0x2326, 0x2327, </span>
<a href="#l6.1602"></a><span id="l6.1602" class="difflineminus">-	0x2328, 0x3008, 0x3009, 0x232b, 0x232c, 0x232d, 0x232e, 0x232f, </span>
<a href="#l6.1603"></a><span id="l6.1603" class="difflineminus">-	0x2330, 0x2331, 0x2332, 0x2333, 0x2334, 0x2335, 0x2336, 0x2337, </span>
<a href="#l6.1604"></a><span id="l6.1604" class="difflineminus">-	0x2338, 0x2339, 0x233a, 0x233b, 0x233c, 0x233d, 0x233e, 0x233f, </span>
<a href="#l6.1605"></a><span id="l6.1605" class="difflineminus">-	};</span>
<a href="#l6.1606"></a><span id="l6.1606" class="difflineplus">+    /* U+2300 */</span>
<a href="#l6.1607"></a><span id="l6.1607" class="difflineplus">+    0x2300, 0x2301, 0x2302, 0x2303, 0x2304, 0x2305, 0x2306, 0x2307,</span>
<a href="#l6.1608"></a><span id="l6.1608" class="difflineplus">+    0x2308, 0x2309, 0x230a, 0x230b, 0x230c, 0x230d, 0x230e, 0x230f,</span>
<a href="#l6.1609"></a><span id="l6.1609" class="difflineplus">+    0x2310, 0x2311, 0x2312, 0x2313, 0x2314, 0x2315, 0x2316, 0x2317,</span>
<a href="#l6.1610"></a><span id="l6.1610" class="difflineplus">+    0x2318, 0x2319, 0x231a, 0x231b, 0x231c, 0x231d, 0x231e, 0x231f,</span>
<a href="#l6.1611"></a><span id="l6.1611" class="difflineplus">+    0x2320, 0x2321, 0x2322, 0x2323, 0x2324, 0x2325, 0x2326, 0x2327,</span>
<a href="#l6.1612"></a><span id="l6.1612" class="difflineplus">+    0x2328, 0x3008, 0x3009, 0x232b, 0x232c, 0x232d, 0x232e, 0x232f,</span>
<a href="#l6.1613"></a><span id="l6.1613" class="difflineplus">+    0x2330, 0x2331, 0x2332, 0x2333, 0x2334, 0x2335, 0x2336, 0x2337,</span>
<a href="#l6.1614"></a><span id="l6.1614" class="difflineplus">+    0x2338, 0x2339, 0x233a, 0x233b, 0x233c, 0x233d, 0x233e, 0x233f,</span>
<a href="#l6.1615"></a><span id="l6.1615" class="difflineplus">+};</span>
<a href="#l6.1616"></a><span id="l6.1616"> </span>
<a href="#l6.1617"></a><span id="l6.1617"> static const unsigned short gNormalizeTable2440[] = {</span>
<a href="#l6.1618"></a><span id="l6.1618" class="difflineminus">-	/* U+2440 */</span>
<a href="#l6.1619"></a><span id="l6.1619" class="difflineminus">-	0x2440, 0x2441, 0x2442, 0x2443, 0x2444, 0x2445, 0x2446, 0x2447, </span>
<a href="#l6.1620"></a><span id="l6.1620" class="difflineminus">-	0x2448, 0x2449, 0x244a, 0x244b, 0x244c, 0x244d, 0x244e, 0x244f, </span>
<a href="#l6.1621"></a><span id="l6.1621" class="difflineminus">-	0x2450, 0x2451, 0x2452, 0x2453, 0x2454, 0x2455, 0x2456, 0x2457, </span>
<a href="#l6.1622"></a><span id="l6.1622" class="difflineminus">-	0x2458, 0x2459, 0x245a, 0x245b, 0x245c, 0x245d, 0x245e, 0x245f, </span>
<a href="#l6.1623"></a><span id="l6.1623" class="difflineminus">-	0x0031, 0x0032, 0x0033, 0x0034, 0x0035, 0x0036, 0x0037, 0x0038, </span>
<a href="#l6.1624"></a><span id="l6.1624" class="difflineminus">-	0x0039, 0x0031, 0x0031, 0x0031, 0x0031, 0x0031, 0x0031, 0x0031, </span>
<a href="#l6.1625"></a><span id="l6.1625" class="difflineminus">-	0x0031, 0x0031, 0x0031, 0x0032, 0x0028, 0x0028, 0x0028, 0x0028, </span>
<a href="#l6.1626"></a><span id="l6.1626" class="difflineminus">-	0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, </span>
<a href="#l6.1627"></a><span id="l6.1627" class="difflineminus">-	};</span>
<a href="#l6.1628"></a><span id="l6.1628" class="difflineplus">+    /* U+2440 */</span>
<a href="#l6.1629"></a><span id="l6.1629" class="difflineplus">+    0x2440, 0x2441, 0x2442, 0x2443, 0x2444, 0x2445, 0x2446, 0x2447,</span>
<a href="#l6.1630"></a><span id="l6.1630" class="difflineplus">+    0x2448, 0x2449, 0x244a, 0x244b, 0x244c, 0x244d, 0x244e, 0x244f,</span>
<a href="#l6.1631"></a><span id="l6.1631" class="difflineplus">+    0x2450, 0x2451, 0x2452, 0x2453, 0x2454, 0x2455, 0x2456, 0x2457,</span>
<a href="#l6.1632"></a><span id="l6.1632" class="difflineplus">+    0x2458, 0x2459, 0x245a, 0x245b, 0x245c, 0x245d, 0x245e, 0x245f,</span>
<a href="#l6.1633"></a><span id="l6.1633" class="difflineplus">+    0x0031, 0x0032, 0x0033, 0x0034, 0x0035, 0x0036, 0x0037, 0x0038,</span>
<a href="#l6.1634"></a><span id="l6.1634" class="difflineplus">+    0x0039, 0x0031, 0x0031, 0x0031, 0x0031, 0x0031, 0x0031, 0x0031,</span>
<a href="#l6.1635"></a><span id="l6.1635" class="difflineplus">+    0x0031, 0x0031, 0x0031, 0x0032, 0x0028, 0x0028, 0x0028, 0x0028,</span>
<a href="#l6.1636"></a><span id="l6.1636" class="difflineplus">+    0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028,</span>
<a href="#l6.1637"></a><span id="l6.1637" class="difflineplus">+};</span>
<a href="#l6.1638"></a><span id="l6.1638"> </span>
<a href="#l6.1639"></a><span id="l6.1639"> static const unsigned short gNormalizeTable2480[] = {</span>
<a href="#l6.1640"></a><span id="l6.1640" class="difflineminus">-	/* U+2480 */</span>
<a href="#l6.1641"></a><span id="l6.1641" class="difflineminus">-	0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, </span>
<a href="#l6.1642"></a><span id="l6.1642" class="difflineminus">-	0x0031, 0x0032, 0x0033, 0x0034, 0x0035, 0x0036, 0x0037, 0x0038, </span>
<a href="#l6.1643"></a><span id="l6.1643" class="difflineminus">-	0x0039, 0x0031, 0x0031, 0x0031, 0x0031, 0x0031, 0x0031, 0x0031, </span>
<a href="#l6.1644"></a><span id="l6.1644" class="difflineminus">-	0x0031, 0x0031, 0x0031, 0x0032, 0x0028, 0x0028, 0x0028, 0x0028, </span>
<a href="#l6.1645"></a><span id="l6.1645" class="difflineminus">-	0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, </span>
<a href="#l6.1646"></a><span id="l6.1646" class="difflineminus">-	0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, </span>
<a href="#l6.1647"></a><span id="l6.1647" class="difflineminus">-	0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0061, 0x0062, </span>
<a href="#l6.1648"></a><span id="l6.1648" class="difflineminus">-	0x0063, 0x0064, 0x0065, 0x0066, 0x0067, 0x0068, 0x0069, 0x006a, </span>
<a href="#l6.1649"></a><span id="l6.1649" class="difflineminus">-	};</span>
<a href="#l6.1650"></a><span id="l6.1650" class="difflineplus">+    /* U+2480 */</span>
<a href="#l6.1651"></a><span id="l6.1651" class="difflineplus">+    0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028,</span>
<a href="#l6.1652"></a><span id="l6.1652" class="difflineplus">+    0x0031, 0x0032, 0x0033, 0x0034, 0x0035, 0x0036, 0x0037, 0x0038,</span>
<a href="#l6.1653"></a><span id="l6.1653" class="difflineplus">+    0x0039, 0x0031, 0x0031, 0x0031, 0x0031, 0x0031, 0x0031, 0x0031,</span>
<a href="#l6.1654"></a><span id="l6.1654" class="difflineplus">+    0x0031, 0x0031, 0x0031, 0x0032, 0x0028, 0x0028, 0x0028, 0x0028,</span>
<a href="#l6.1655"></a><span id="l6.1655" class="difflineplus">+    0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028,</span>
<a href="#l6.1656"></a><span id="l6.1656" class="difflineplus">+    0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028,</span>
<a href="#l6.1657"></a><span id="l6.1657" class="difflineplus">+    0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0061, 0x0062,</span>
<a href="#l6.1658"></a><span id="l6.1658" class="difflineplus">+    0x0063, 0x0064, 0x0065, 0x0066, 0x0067, 0x0068, 0x0069, 0x006a,</span>
<a href="#l6.1659"></a><span id="l6.1659" class="difflineplus">+};</span>
<a href="#l6.1660"></a><span id="l6.1660"> </span>
<a href="#l6.1661"></a><span id="l6.1661"> static const unsigned short gNormalizeTable24c0[] = {</span>
<a href="#l6.1662"></a><span id="l6.1662" class="difflineminus">-	/* U+24c0 */</span>
<a href="#l6.1663"></a><span id="l6.1663" class="difflineminus">-	0x006b, 0x006c, 0x006d, 0x006e, 0x006f, 0x0070, 0x0071, 0x0072, </span>
<a href="#l6.1664"></a><span id="l6.1664" class="difflineminus">-	0x0073, 0x0074, 0x0075, 0x0076, 0x0077, 0x0078, 0x0079, 0x007a, </span>
<a href="#l6.1665"></a><span id="l6.1665" class="difflineminus">-	0x0061, 0x0062, 0x0063, 0x0064, 0x0065, 0x0066, 0x0067, 0x0068, </span>
<a href="#l6.1666"></a><span id="l6.1666" class="difflineminus">-	0x0069, 0x006a, 0x006b, 0x006c, 0x006d, 0x006e, 0x006f, 0x0070, </span>
<a href="#l6.1667"></a><span id="l6.1667" class="difflineminus">-	0x0071, 0x0072, 0x0073, 0x0074, 0x0075, 0x0076, 0x0077, 0x0078, </span>
<a href="#l6.1668"></a><span id="l6.1668" class="difflineminus">-	0x0079, 0x007a, 0x0030, 0x24eb, 0x24ec, 0x24ed, 0x24ee, 0x24ef, </span>
<a href="#l6.1669"></a><span id="l6.1669" class="difflineminus">-	0x24f0, 0x24f1, 0x24f2, 0x24f3, 0x24f4, 0x24f5, 0x24f6, 0x24f7, </span>
<a href="#l6.1670"></a><span id="l6.1670" class="difflineminus">-	0x24f8, 0x24f9, 0x24fa, 0x24fb, 0x24fc, 0x24fd, 0x24fe, 0x24ff, </span>
<a href="#l6.1671"></a><span id="l6.1671" class="difflineminus">-	};</span>
<a href="#l6.1672"></a><span id="l6.1672" class="difflineplus">+    /* U+24c0 */</span>
<a href="#l6.1673"></a><span id="l6.1673" class="difflineplus">+    0x006b, 0x006c, 0x006d, 0x006e, 0x006f, 0x0070, 0x0071, 0x0072,</span>
<a href="#l6.1674"></a><span id="l6.1674" class="difflineplus">+    0x0073, 0x0074, 0x0075, 0x0076, 0x0077, 0x0078, 0x0079, 0x007a,</span>
<a href="#l6.1675"></a><span id="l6.1675" class="difflineplus">+    0x0061, 0x0062, 0x0063, 0x0064, 0x0065, 0x0066, 0x0067, 0x0068,</span>
<a href="#l6.1676"></a><span id="l6.1676" class="difflineplus">+    0x0069, 0x006a, 0x006b, 0x006c, 0x006d, 0x006e, 0x006f, 0x0070,</span>
<a href="#l6.1677"></a><span id="l6.1677" class="difflineplus">+    0x0071, 0x0072, 0x0073, 0x0074, 0x0075, 0x0076, 0x0077, 0x0078,</span>
<a href="#l6.1678"></a><span id="l6.1678" class="difflineplus">+    0x0079, 0x007a, 0x0030, 0x24eb, 0x24ec, 0x24ed, 0x24ee, 0x24ef,</span>
<a href="#l6.1679"></a><span id="l6.1679" class="difflineplus">+    0x24f0, 0x24f1, 0x24f2, 0x24f3, 0x24f4, 0x24f5, 0x24f6, 0x24f7,</span>
<a href="#l6.1680"></a><span id="l6.1680" class="difflineplus">+    0x24f8, 0x24f9, 0x24fa, 0x24fb, 0x24fc, 0x24fd, 0x24fe, 0x24ff,</span>
<a href="#l6.1681"></a><span id="l6.1681" class="difflineplus">+};</span>
<a href="#l6.1682"></a><span id="l6.1682"> </span>
<a href="#l6.1683"></a><span id="l6.1683"> static const unsigned short gNormalizeTable2a00[] = {</span>
<a href="#l6.1684"></a><span id="l6.1684" class="difflineminus">-	/* U+2a00 */</span>
<a href="#l6.1685"></a><span id="l6.1685" class="difflineminus">-	0x2a00, 0x2a01, 0x2a02, 0x2a03, 0x2a04, 0x2a05, 0x2a06, 0x2a07, </span>
<a href="#l6.1686"></a><span id="l6.1686" class="difflineminus">-	0x2a08, 0x2a09, 0x2a0a, 0x2a0b, 0x222b, 0x2a0d, 0x2a0e, 0x2a0f, </span>
<a href="#l6.1687"></a><span id="l6.1687" class="difflineminus">-	0x2a10, 0x2a11, 0x2a12, 0x2a13, 0x2a14, 0x2a15, 0x2a16, 0x2a17, </span>
<a href="#l6.1688"></a><span id="l6.1688" class="difflineminus">-	0x2a18, 0x2a19, 0x2a1a, 0x2a1b, 0x2a1c, 0x2a1d, 0x2a1e, 0x2a1f, </span>
<a href="#l6.1689"></a><span id="l6.1689" class="difflineminus">-	0x2a20, 0x2a21, 0x2a22, 0x2a23, 0x2a24, 0x2a25, 0x2a26, 0x2a27, </span>
<a href="#l6.1690"></a><span id="l6.1690" class="difflineminus">-	0x2a28, 0x2a29, 0x2a2a, 0x2a2b, 0x2a2c, 0x2a2d, 0x2a2e, 0x2a2f, </span>
<a href="#l6.1691"></a><span id="l6.1691" class="difflineminus">-	0x2a30, 0x2a31, 0x2a32, 0x2a33, 0x2a34, 0x2a35, 0x2a36, 0x2a37, </span>
<a href="#l6.1692"></a><span id="l6.1692" class="difflineminus">-	0x2a38, 0x2a39, 0x2a3a, 0x2a3b, 0x2a3c, 0x2a3d, 0x2a3e, 0x2a3f, </span>
<a href="#l6.1693"></a><span id="l6.1693" class="difflineminus">-	};</span>
<a href="#l6.1694"></a><span id="l6.1694" class="difflineplus">+    /* U+2a00 */</span>
<a href="#l6.1695"></a><span id="l6.1695" class="difflineplus">+    0x2a00, 0x2a01, 0x2a02, 0x2a03, 0x2a04, 0x2a05, 0x2a06, 0x2a07,</span>
<a href="#l6.1696"></a><span id="l6.1696" class="difflineplus">+    0x2a08, 0x2a09, 0x2a0a, 0x2a0b, 0x222b, 0x2a0d, 0x2a0e, 0x2a0f,</span>
<a href="#l6.1697"></a><span id="l6.1697" class="difflineplus">+    0x2a10, 0x2a11, 0x2a12, 0x2a13, 0x2a14, 0x2a15, 0x2a16, 0x2a17,</span>
<a href="#l6.1698"></a><span id="l6.1698" class="difflineplus">+    0x2a18, 0x2a19, 0x2a1a, 0x2a1b, 0x2a1c, 0x2a1d, 0x2a1e, 0x2a1f,</span>
<a href="#l6.1699"></a><span id="l6.1699" class="difflineplus">+    0x2a20, 0x2a21, 0x2a22, 0x2a23, 0x2a24, 0x2a25, 0x2a26, 0x2a27,</span>
<a href="#l6.1700"></a><span id="l6.1700" class="difflineplus">+    0x2a28, 0x2a29, 0x2a2a, 0x2a2b, 0x2a2c, 0x2a2d, 0x2a2e, 0x2a2f,</span>
<a href="#l6.1701"></a><span id="l6.1701" class="difflineplus">+    0x2a30, 0x2a31, 0x2a32, 0x2a33, 0x2a34, 0x2a35, 0x2a36, 0x2a37,</span>
<a href="#l6.1702"></a><span id="l6.1702" class="difflineplus">+    0x2a38, 0x2a39, 0x2a3a, 0x2a3b, 0x2a3c, 0x2a3d, 0x2a3e, 0x2a3f,</span>
<a href="#l6.1703"></a><span id="l6.1703" class="difflineplus">+};</span>
<a href="#l6.1704"></a><span id="l6.1704"> </span>
<a href="#l6.1705"></a><span id="l6.1705"> static const unsigned short gNormalizeTable2a40[] = {</span>
<a href="#l6.1706"></a><span id="l6.1706" class="difflineminus">-	/* U+2a40 */</span>
<a href="#l6.1707"></a><span id="l6.1707" class="difflineminus">-	0x2a40, 0x2a41, 0x2a42, 0x2a43, 0x2a44, 0x2a45, 0x2a46, 0x2a47, </span>
<a href="#l6.1708"></a><span id="l6.1708" class="difflineminus">-	0x2a48, 0x2a49, 0x2a4a, 0x2a4b, 0x2a4c, 0x2a4d, 0x2a4e, 0x2a4f, </span>
<a href="#l6.1709"></a><span id="l6.1709" class="difflineminus">-	0x2a50, 0x2a51, 0x2a52, 0x2a53, 0x2a54, 0x2a55, 0x2a56, 0x2a57, </span>
<a href="#l6.1710"></a><span id="l6.1710" class="difflineminus">-	0x2a58, 0x2a59, 0x2a5a, 0x2a5b, 0x2a5c, 0x2a5d, 0x2a5e, 0x2a5f, </span>
<a href="#l6.1711"></a><span id="l6.1711" class="difflineminus">-	0x2a60, 0x2a61, 0x2a62, 0x2a63, 0x2a64, 0x2a65, 0x2a66, 0x2a67, </span>
<a href="#l6.1712"></a><span id="l6.1712" class="difflineminus">-	0x2a68, 0x2a69, 0x2a6a, 0x2a6b, 0x2a6c, 0x2a6d, 0x2a6e, 0x2a6f, </span>
<a href="#l6.1713"></a><span id="l6.1713" class="difflineminus">-	0x2a70, 0x2a71, 0x2a72, 0x2a73, 0x003a, 0x003d, 0x003d, 0x2a77, </span>
<a href="#l6.1714"></a><span id="l6.1714" class="difflineminus">-	0x2a78, 0x2a79, 0x2a7a, 0x2a7b, 0x2a7c, 0x2a7d, 0x2a7e, 0x2a7f, </span>
<a href="#l6.1715"></a><span id="l6.1715" class="difflineminus">-	};</span>
<a href="#l6.1716"></a><span id="l6.1716" class="difflineplus">+    /* U+2a40 */</span>
<a href="#l6.1717"></a><span id="l6.1717" class="difflineplus">+    0x2a40, 0x2a41, 0x2a42, 0x2a43, 0x2a44, 0x2a45, 0x2a46, 0x2a47,</span>
<a href="#l6.1718"></a><span id="l6.1718" class="difflineplus">+    0x2a48, 0x2a49, 0x2a4a, 0x2a4b, 0x2a4c, 0x2a4d, 0x2a4e, 0x2a4f,</span>
<a href="#l6.1719"></a><span id="l6.1719" class="difflineplus">+    0x2a50, 0x2a51, 0x2a52, 0x2a53, 0x2a54, 0x2a55, 0x2a56, 0x2a57,</span>
<a href="#l6.1720"></a><span id="l6.1720" class="difflineplus">+    0x2a58, 0x2a59, 0x2a5a, 0x2a5b, 0x2a5c, 0x2a5d, 0x2a5e, 0x2a5f,</span>
<a href="#l6.1721"></a><span id="l6.1721" class="difflineplus">+    0x2a60, 0x2a61, 0x2a62, 0x2a63, 0x2a64, 0x2a65, 0x2a66, 0x2a67,</span>
<a href="#l6.1722"></a><span id="l6.1722" class="difflineplus">+    0x2a68, 0x2a69, 0x2a6a, 0x2a6b, 0x2a6c, 0x2a6d, 0x2a6e, 0x2a6f,</span>
<a href="#l6.1723"></a><span id="l6.1723" class="difflineplus">+    0x2a70, 0x2a71, 0x2a72, 0x2a73, 0x003a, 0x003d, 0x003d, 0x2a77,</span>
<a href="#l6.1724"></a><span id="l6.1724" class="difflineplus">+    0x2a78, 0x2a79, 0x2a7a, 0x2a7b, 0x2a7c, 0x2a7d, 0x2a7e, 0x2a7f,</span>
<a href="#l6.1725"></a><span id="l6.1725" class="difflineplus">+};</span>
<a href="#l6.1726"></a><span id="l6.1726"> </span>
<a href="#l6.1727"></a><span id="l6.1727"> static const unsigned short gNormalizeTable2ac0[] = {</span>
<a href="#l6.1728"></a><span id="l6.1728" class="difflineminus">-	/* U+2ac0 */</span>
<a href="#l6.1729"></a><span id="l6.1729" class="difflineminus">-	0x2ac0, 0x2ac1, 0x2ac2, 0x2ac3, 0x2ac4, 0x2ac5, 0x2ac6, 0x2ac7, </span>
<a href="#l6.1730"></a><span id="l6.1730" class="difflineminus">-	0x2ac8, 0x2ac9, 0x2aca, 0x2acb, 0x2acc, 0x2acd, 0x2ace, 0x2acf, </span>
<a href="#l6.1731"></a><span id="l6.1731" class="difflineminus">-	0x2ad0, 0x2ad1, 0x2ad2, 0x2ad3, 0x2ad4, 0x2ad5, 0x2ad6, 0x2ad7, </span>
<a href="#l6.1732"></a><span id="l6.1732" class="difflineminus">-	0x2ad8, 0x2ad9, 0x2ada, 0x2adb, 0x2add, 0x2add, 0x2ade, 0x2adf, </span>
<a href="#l6.1733"></a><span id="l6.1733" class="difflineminus">-	0x2ae0, 0x2ae1, 0x2ae2, 0x2ae3, 0x2ae4, 0x2ae5, 0x2ae6, 0x2ae7, </span>
<a href="#l6.1734"></a><span id="l6.1734" class="difflineminus">-	0x2ae8, 0x2ae9, 0x2aea, 0x2aeb, 0x2aec, 0x2aed, 0x2aee, 0x2aef, </span>
<a href="#l6.1735"></a><span id="l6.1735" class="difflineminus">-	0x2af0, 0x2af1, 0x2af2, 0x2af3, 0x2af4, 0x2af5, 0x2af6, 0x2af7, </span>
<a href="#l6.1736"></a><span id="l6.1736" class="difflineminus">-	0x2af8, 0x2af9, 0x2afa, 0x2afb, 0x2afc, 0x2afd, 0x2afe, 0x2aff, </span>
<a href="#l6.1737"></a><span id="l6.1737" class="difflineminus">-	};</span>
<a href="#l6.1738"></a><span id="l6.1738" class="difflineplus">+    /* U+2ac0 */</span>
<a href="#l6.1739"></a><span id="l6.1739" class="difflineplus">+    0x2ac0, 0x2ac1, 0x2ac2, 0x2ac3, 0x2ac4, 0x2ac5, 0x2ac6, 0x2ac7,</span>
<a href="#l6.1740"></a><span id="l6.1740" class="difflineplus">+    0x2ac8, 0x2ac9, 0x2aca, 0x2acb, 0x2acc, 0x2acd, 0x2ace, 0x2acf,</span>
<a href="#l6.1741"></a><span id="l6.1741" class="difflineplus">+    0x2ad0, 0x2ad1, 0x2ad2, 0x2ad3, 0x2ad4, 0x2ad5, 0x2ad6, 0x2ad7,</span>
<a href="#l6.1742"></a><span id="l6.1742" class="difflineplus">+    0x2ad8, 0x2ad9, 0x2ada, 0x2adb, 0x2add, 0x2add, 0x2ade, 0x2adf,</span>
<a href="#l6.1743"></a><span id="l6.1743" class="difflineplus">+    0x2ae0, 0x2ae1, 0x2ae2, 0x2ae3, 0x2ae4, 0x2ae5, 0x2ae6, 0x2ae7,</span>
<a href="#l6.1744"></a><span id="l6.1744" class="difflineplus">+    0x2ae8, 0x2ae9, 0x2aea, 0x2aeb, 0x2aec, 0x2aed, 0x2aee, 0x2aef,</span>
<a href="#l6.1745"></a><span id="l6.1745" class="difflineplus">+    0x2af0, 0x2af1, 0x2af2, 0x2af3, 0x2af4, 0x2af5, 0x2af6, 0x2af7,</span>
<a href="#l6.1746"></a><span id="l6.1746" class="difflineplus">+    0x2af8, 0x2af9, 0x2afa, 0x2afb, 0x2afc, 0x2afd, 0x2afe, 0x2aff,</span>
<a href="#l6.1747"></a><span id="l6.1747" class="difflineplus">+};</span>
<a href="#l6.1748"></a><span id="l6.1748"> </span>
<a href="#l6.1749"></a><span id="l6.1749"> static const unsigned short gNormalizeTable2c00[] = {</span>
<a href="#l6.1750"></a><span id="l6.1750" class="difflineminus">-	/* U+2c00 */</span>
<a href="#l6.1751"></a><span id="l6.1751" class="difflineminus">-	0x2c30, 0x2c31, 0x2c32, 0x2c33, 0x2c34, 0x2c35, 0x2c36, 0x2c37, </span>
<a href="#l6.1752"></a><span id="l6.1752" class="difflineminus">-	0x2c38, 0x2c39, 0x2c3a, 0x2c3b, 0x2c3c, 0x2c3d, 0x2c3e, 0x2c3f, </span>
<a href="#l6.1753"></a><span id="l6.1753" class="difflineminus">-	0x2c40, 0x2c41, 0x2c42, 0x2c43, 0x2c44, 0x2c45, 0x2c46, 0x2c47, </span>
<a href="#l6.1754"></a><span id="l6.1754" class="difflineminus">-	0x2c48, 0x2c49, 0x2c4a, 0x2c4b, 0x2c4c, 0x2c4d, 0x2c4e, 0x2c4f, </span>
<a href="#l6.1755"></a><span id="l6.1755" class="difflineminus">-	0x2c50, 0x2c51, 0x2c52, 0x2c53, 0x2c54, 0x2c55, 0x2c56, 0x2c57, </span>
<a href="#l6.1756"></a><span id="l6.1756" class="difflineminus">-	0x2c58, 0x2c59, 0x2c5a, 0x2c5b, 0x2c5c, 0x2c5d, 0x2c5e, 0x2c2f, </span>
<a href="#l6.1757"></a><span id="l6.1757" class="difflineminus">-	0x2c30, 0x2c31, 0x2c32, 0x2c33, 0x2c34, 0x2c35, 0x2c36, 0x2c37, </span>
<a href="#l6.1758"></a><span id="l6.1758" class="difflineminus">-	0x2c38, 0x2c39, 0x2c3a, 0x2c3b, 0x2c3c, 0x2c3d, 0x2c3e, 0x2c3f, </span>
<a href="#l6.1759"></a><span id="l6.1759" class="difflineminus">-	};</span>
<a href="#l6.1760"></a><span id="l6.1760" class="difflineplus">+    /* U+2c00 */</span>
<a href="#l6.1761"></a><span id="l6.1761" class="difflineplus">+    0x2c30, 0x2c31, 0x2c32, 0x2c33, 0x2c34, 0x2c35, 0x2c36, 0x2c37,</span>
<a href="#l6.1762"></a><span id="l6.1762" class="difflineplus">+    0x2c38, 0x2c39, 0x2c3a, 0x2c3b, 0x2c3c, 0x2c3d, 0x2c3e, 0x2c3f,</span>
<a href="#l6.1763"></a><span id="l6.1763" class="difflineplus">+    0x2c40, 0x2c41, 0x2c42, 0x2c43, 0x2c44, 0x2c45, 0x2c46, 0x2c47,</span>
<a href="#l6.1764"></a><span id="l6.1764" class="difflineplus">+    0x2c48, 0x2c49, 0x2c4a, 0x2c4b, 0x2c4c, 0x2c4d, 0x2c4e, 0x2c4f,</span>
<a href="#l6.1765"></a><span id="l6.1765" class="difflineplus">+    0x2c50, 0x2c51, 0x2c52, 0x2c53, 0x2c54, 0x2c55, 0x2c56, 0x2c57,</span>
<a href="#l6.1766"></a><span id="l6.1766" class="difflineplus">+    0x2c58, 0x2c59, 0x2c5a, 0x2c5b, 0x2c5c, 0x2c5d, 0x2c5e, 0x2c2f,</span>
<a href="#l6.1767"></a><span id="l6.1767" class="difflineplus">+    0x2c30, 0x2c31, 0x2c32, 0x2c33, 0x2c34, 0x2c35, 0x2c36, 0x2c37,</span>
<a href="#l6.1768"></a><span id="l6.1768" class="difflineplus">+    0x2c38, 0x2c39, 0x2c3a, 0x2c3b, 0x2c3c, 0x2c3d, 0x2c3e, 0x2c3f,</span>
<a href="#l6.1769"></a><span id="l6.1769" class="difflineplus">+};</span>
<a href="#l6.1770"></a><span id="l6.1770"> </span>
<a href="#l6.1771"></a><span id="l6.1771"> static const unsigned short gNormalizeTable2c40[] = {</span>
<a href="#l6.1772"></a><span id="l6.1772" class="difflineminus">-	/* U+2c40 */</span>
<a href="#l6.1773"></a><span id="l6.1773" class="difflineminus">-	0x2c40, 0x2c41, 0x2c42, 0x2c43, 0x2c44, 0x2c45, 0x2c46, 0x2c47, </span>
<a href="#l6.1774"></a><span id="l6.1774" class="difflineminus">-	0x2c48, 0x2c49, 0x2c4a, 0x2c4b, 0x2c4c, 0x2c4d, 0x2c4e, 0x2c4f, </span>
<a href="#l6.1775"></a><span id="l6.1775" class="difflineminus">-	0x2c50, 0x2c51, 0x2c52, 0x2c53, 0x2c54, 0x2c55, 0x2c56, 0x2c57, </span>
<a href="#l6.1776"></a><span id="l6.1776" class="difflineminus">-	0x2c58, 0x2c59, 0x2c5a, 0x2c5b, 0x2c5c, 0x2c5d, 0x2c5e, 0x2c5f, </span>
<a href="#l6.1777"></a><span id="l6.1777" class="difflineminus">-	0x2c61, 0x2c61, 0x026b, 0x1d7d, 0x027d, 0x2c65, 0x2c66, 0x2c68, </span>
<a href="#l6.1778"></a><span id="l6.1778" class="difflineminus">-	0x2c68, 0x2c6a, 0x2c6a, 0x2c6c, 0x2c6c, 0x0251, 0x0271, 0x0250, </span>
<a href="#l6.1779"></a><span id="l6.1779" class="difflineminus">-	0x0252, 0x2c71, 0x2c73, 0x2c73, 0x2c74, 0x2c76, 0x2c76, 0x2c77, </span>
<a href="#l6.1780"></a><span id="l6.1780" class="difflineminus">-	0x2c78, 0x2c79, 0x2c7a, 0x2c7b, 0x006a, 0x0076, 0x023f, 0x0240, </span>
<a href="#l6.1781"></a><span id="l6.1781" class="difflineminus">-	};</span>
<a href="#l6.1782"></a><span id="l6.1782" class="difflineplus">+    /* U+2c40 */</span>
<a href="#l6.1783"></a><span id="l6.1783" class="difflineplus">+    0x2c40, 0x2c41, 0x2c42, 0x2c43, 0x2c44, 0x2c45, 0x2c46, 0x2c47,</span>
<a href="#l6.1784"></a><span id="l6.1784" class="difflineplus">+    0x2c48, 0x2c49, 0x2c4a, 0x2c4b, 0x2c4c, 0x2c4d, 0x2c4e, 0x2c4f,</span>
<a href="#l6.1785"></a><span id="l6.1785" class="difflineplus">+    0x2c50, 0x2c51, 0x2c52, 0x2c53, 0x2c54, 0x2c55, 0x2c56, 0x2c57,</span>
<a href="#l6.1786"></a><span id="l6.1786" class="difflineplus">+    0x2c58, 0x2c59, 0x2c5a, 0x2c5b, 0x2c5c, 0x2c5d, 0x2c5e, 0x2c5f,</span>
<a href="#l6.1787"></a><span id="l6.1787" class="difflineplus">+    0x2c61, 0x2c61, 0x026b, 0x1d7d, 0x027d, 0x2c65, 0x2c66, 0x2c68,</span>
<a href="#l6.1788"></a><span id="l6.1788" class="difflineplus">+    0x2c68, 0x2c6a, 0x2c6a, 0x2c6c, 0x2c6c, 0x0251, 0x0271, 0x0250,</span>
<a href="#l6.1789"></a><span id="l6.1789" class="difflineplus">+    0x0252, 0x2c71, 0x2c73, 0x2c73, 0x2c74, 0x2c76, 0x2c76, 0x2c77,</span>
<a href="#l6.1790"></a><span id="l6.1790" class="difflineplus">+    0x2c78, 0x2c79, 0x2c7a, 0x2c7b, 0x006a, 0x0076, 0x023f, 0x0240,</span>
<a href="#l6.1791"></a><span id="l6.1791" class="difflineplus">+};</span>
<a href="#l6.1792"></a><span id="l6.1792"> </span>
<a href="#l6.1793"></a><span id="l6.1793"> static const unsigned short gNormalizeTable2c80[] = {</span>
<a href="#l6.1794"></a><span id="l6.1794" class="difflineminus">-	/* U+2c80 */</span>
<a href="#l6.1795"></a><span id="l6.1795" class="difflineminus">-	0x2c81, 0x2c81, 0x2c83, 0x2c83, 0x2c85, 0x2c85, 0x2c87, 0x2c87, </span>
<a href="#l6.1796"></a><span id="l6.1796" class="difflineminus">-	0x2c89, 0x2c89, 0x2c8b, 0x2c8b, 0x2c8d, 0x2c8d, 0x2c8f, 0x2c8f, </span>
<a href="#l6.1797"></a><span id="l6.1797" class="difflineminus">-	0x2c91, 0x2c91, 0x2c93, 0x2c93, 0x2c95, 0x2c95, 0x2c97, 0x2c97, </span>
<a href="#l6.1798"></a><span id="l6.1798" class="difflineminus">-	0x2c99, 0x2c99, 0x2c9b, 0x2c9b, 0x2c9d, 0x2c9d, 0x2c9f, 0x2c9f, </span>
<a href="#l6.1799"></a><span id="l6.1799" class="difflineminus">-	0x2ca1, 0x2ca1, 0x2ca3, 0x2ca3, 0x2ca5, 0x2ca5, 0x2ca7, 0x2ca7, </span>
<a href="#l6.1800"></a><span id="l6.1800" class="difflineminus">-	0x2ca9, 0x2ca9, 0x2cab, 0x2cab, 0x2cad, 0x2cad, 0x2caf, 0x2caf, </span>
<a href="#l6.1801"></a><span id="l6.1801" class="difflineminus">-	0x2cb1, 0x2cb1, 0x2cb3, 0x2cb3, 0x2cb5, 0x2cb5, 0x2cb7, 0x2cb7, </span>
<a href="#l6.1802"></a><span id="l6.1802" class="difflineminus">-	0x2cb9, 0x2cb9, 0x2cbb, 0x2cbb, 0x2cbd, 0x2cbd, 0x2cbf, 0x2cbf, </span>
<a href="#l6.1803"></a><span id="l6.1803" class="difflineminus">-	};</span>
<a href="#l6.1804"></a><span id="l6.1804" class="difflineplus">+    /* U+2c80 */</span>
<a href="#l6.1805"></a><span id="l6.1805" class="difflineplus">+    0x2c81, 0x2c81, 0x2c83, 0x2c83, 0x2c85, 0x2c85, 0x2c87, 0x2c87,</span>
<a href="#l6.1806"></a><span id="l6.1806" class="difflineplus">+    0x2c89, 0x2c89, 0x2c8b, 0x2c8b, 0x2c8d, 0x2c8d, 0x2c8f, 0x2c8f,</span>
<a href="#l6.1807"></a><span id="l6.1807" class="difflineplus">+    0x2c91, 0x2c91, 0x2c93, 0x2c93, 0x2c95, 0x2c95, 0x2c97, 0x2c97,</span>
<a href="#l6.1808"></a><span id="l6.1808" class="difflineplus">+    0x2c99, 0x2c99, 0x2c9b, 0x2c9b, 0x2c9d, 0x2c9d, 0x2c9f, 0x2c9f,</span>
<a href="#l6.1809"></a><span id="l6.1809" class="difflineplus">+    0x2ca1, 0x2ca1, 0x2ca3, 0x2ca3, 0x2ca5, 0x2ca5, 0x2ca7, 0x2ca7,</span>
<a href="#l6.1810"></a><span id="l6.1810" class="difflineplus">+    0x2ca9, 0x2ca9, 0x2cab, 0x2cab, 0x2cad, 0x2cad, 0x2caf, 0x2caf,</span>
<a href="#l6.1811"></a><span id="l6.1811" class="difflineplus">+    0x2cb1, 0x2cb1, 0x2cb3, 0x2cb3, 0x2cb5, 0x2cb5, 0x2cb7, 0x2cb7,</span>
<a href="#l6.1812"></a><span id="l6.1812" class="difflineplus">+    0x2cb9, 0x2cb9, 0x2cbb, 0x2cbb, 0x2cbd, 0x2cbd, 0x2cbf, 0x2cbf,</span>
<a href="#l6.1813"></a><span id="l6.1813" class="difflineplus">+};</span>
<a href="#l6.1814"></a><span id="l6.1814"> </span>
<a href="#l6.1815"></a><span id="l6.1815"> static const unsigned short gNormalizeTable2cc0[] = {</span>
<a href="#l6.1816"></a><span id="l6.1816" class="difflineminus">-	/* U+2cc0 */</span>
<a href="#l6.1817"></a><span id="l6.1817" class="difflineminus">-	0x2cc1, 0x2cc1, 0x2cc3, 0x2cc3, 0x2cc5, 0x2cc5, 0x2cc7, 0x2cc7, </span>
<a href="#l6.1818"></a><span id="l6.1818" class="difflineminus">-	0x2cc9, 0x2cc9, 0x2ccb, 0x2ccb, 0x2ccd, 0x2ccd, 0x2ccf, 0x2ccf, </span>
<a href="#l6.1819"></a><span id="l6.1819" class="difflineminus">-	0x2cd1, 0x2cd1, 0x2cd3, 0x2cd3, 0x2cd5, 0x2cd5, 0x2cd7, 0x2cd7, </span>
<a href="#l6.1820"></a><span id="l6.1820" class="difflineminus">-	0x2cd9, 0x2cd9, 0x2cdb, 0x2cdb, 0x2cdd, 0x2cdd, 0x2cdf, 0x2cdf, </span>
<a href="#l6.1821"></a><span id="l6.1821" class="difflineminus">-	0x2ce1, 0x2ce1, 0x2ce3, 0x2ce3, 0x2ce4, 0x2ce5, 0x2ce6, 0x2ce7, </span>
<a href="#l6.1822"></a><span id="l6.1822" class="difflineminus">-	0x2ce8, 0x2ce9, 0x2cea, 0x2cec, 0x2cec, 0x2cee, 0x2cee, 0x2cef, </span>
<a href="#l6.1823"></a><span id="l6.1823" class="difflineminus">-	0x2cf0, 0x2cf1, 0x2cf2, 0x2cf3, 0x2cf4, 0x2cf5, 0x2cf6, 0x2cf7, </span>
<a href="#l6.1824"></a><span id="l6.1824" class="difflineminus">-	0x2cf8, 0x2cf9, 0x2cfa, 0x2cfb, 0x2cfc, 0x2cfd, 0x2cfe, 0x2cff, </span>
<a href="#l6.1825"></a><span id="l6.1825" class="difflineminus">-	};</span>
<a href="#l6.1826"></a><span id="l6.1826" class="difflineplus">+    /* U+2cc0 */</span>
<a href="#l6.1827"></a><span id="l6.1827" class="difflineplus">+    0x2cc1, 0x2cc1, 0x2cc3, 0x2cc3, 0x2cc5, 0x2cc5, 0x2cc7, 0x2cc7,</span>
<a href="#l6.1828"></a><span id="l6.1828" class="difflineplus">+    0x2cc9, 0x2cc9, 0x2ccb, 0x2ccb, 0x2ccd, 0x2ccd, 0x2ccf, 0x2ccf,</span>
<a href="#l6.1829"></a><span id="l6.1829" class="difflineplus">+    0x2cd1, 0x2cd1, 0x2cd3, 0x2cd3, 0x2cd5, 0x2cd5, 0x2cd7, 0x2cd7,</span>
<a href="#l6.1830"></a><span id="l6.1830" class="difflineplus">+    0x2cd9, 0x2cd9, 0x2cdb, 0x2cdb, 0x2cdd, 0x2cdd, 0x2cdf, 0x2cdf,</span>
<a href="#l6.1831"></a><span id="l6.1831" class="difflineplus">+    0x2ce1, 0x2ce1, 0x2ce3, 0x2ce3, 0x2ce4, 0x2ce5, 0x2ce6, 0x2ce7,</span>
<a href="#l6.1832"></a><span id="l6.1832" class="difflineplus">+    0x2ce8, 0x2ce9, 0x2cea, 0x2cec, 0x2cec, 0x2cee, 0x2cee, 0x2cef,</span>
<a href="#l6.1833"></a><span id="l6.1833" class="difflineplus">+    0x2cf0, 0x2cf1, 0x2cf2, 0x2cf3, 0x2cf4, 0x2cf5, 0x2cf6, 0x2cf7,</span>
<a href="#l6.1834"></a><span id="l6.1834" class="difflineplus">+    0x2cf8, 0x2cf9, 0x2cfa, 0x2cfb, 0x2cfc, 0x2cfd, 0x2cfe, 0x2cff,</span>
<a href="#l6.1835"></a><span id="l6.1835" class="difflineplus">+};</span>
<a href="#l6.1836"></a><span id="l6.1836"> </span>
<a href="#l6.1837"></a><span id="l6.1837"> static const unsigned short gNormalizeTable2d40[] = {</span>
<a href="#l6.1838"></a><span id="l6.1838" class="difflineminus">-	/* U+2d40 */</span>
<a href="#l6.1839"></a><span id="l6.1839" class="difflineminus">-	0x2d40, 0x2d41, 0x2d42, 0x2d43, 0x2d44, 0x2d45, 0x2d46, 0x2d47, </span>
<a href="#l6.1840"></a><span id="l6.1840" class="difflineminus">-	0x2d48, 0x2d49, 0x2d4a, 0x2d4b, 0x2d4c, 0x2d4d, 0x2d4e, 0x2d4f, </span>
<a href="#l6.1841"></a><span id="l6.1841" class="difflineminus">-	0x2d50, 0x2d51, 0x2d52, 0x2d53, 0x2d54, 0x2d55, 0x2d56, 0x2d57, </span>
<a href="#l6.1842"></a><span id="l6.1842" class="difflineminus">-	0x2d58, 0x2d59, 0x2d5a, 0x2d5b, 0x2d5c, 0x2d5d, 0x2d5e, 0x2d5f, </span>
<a href="#l6.1843"></a><span id="l6.1843" class="difflineminus">-	0x2d60, 0x2d61, 0x2d62, 0x2d63, 0x2d64, 0x2d65, 0x2d66, 0x2d67, </span>
<a href="#l6.1844"></a><span id="l6.1844" class="difflineminus">-	0x2d68, 0x2d69, 0x2d6a, 0x2d6b, 0x2d6c, 0x2d6d, 0x2d6e, 0x2d61, </span>
<a href="#l6.1845"></a><span id="l6.1845" class="difflineminus">-	0x2d70, 0x2d71, 0x2d72, 0x2d73, 0x2d74, 0x2d75, 0x2d76, 0x2d77, </span>
<a href="#l6.1846"></a><span id="l6.1846" class="difflineminus">-	0x2d78, 0x2d79, 0x2d7a, 0x2d7b, 0x2d7c, 0x2d7d, 0x2d7e, 0x2d7f, </span>
<a href="#l6.1847"></a><span id="l6.1847" class="difflineminus">-	};</span>
<a href="#l6.1848"></a><span id="l6.1848" class="difflineplus">+    /* U+2d40 */</span>
<a href="#l6.1849"></a><span id="l6.1849" class="difflineplus">+    0x2d40, 0x2d41, 0x2d42, 0x2d43, 0x2d44, 0x2d45, 0x2d46, 0x2d47,</span>
<a href="#l6.1850"></a><span id="l6.1850" class="difflineplus">+    0x2d48, 0x2d49, 0x2d4a, 0x2d4b, 0x2d4c, 0x2d4d, 0x2d4e, 0x2d4f,</span>
<a href="#l6.1851"></a><span id="l6.1851" class="difflineplus">+    0x2d50, 0x2d51, 0x2d52, 0x2d53, 0x2d54, 0x2d55, 0x2d56, 0x2d57,</span>
<a href="#l6.1852"></a><span id="l6.1852" class="difflineplus">+    0x2d58, 0x2d59, 0x2d5a, 0x2d5b, 0x2d5c, 0x2d5d, 0x2d5e, 0x2d5f,</span>
<a href="#l6.1853"></a><span id="l6.1853" class="difflineplus">+    0x2d60, 0x2d61, 0x2d62, 0x2d63, 0x2d64, 0x2d65, 0x2d66, 0x2d67,</span>
<a href="#l6.1854"></a><span id="l6.1854" class="difflineplus">+    0x2d68, 0x2d69, 0x2d6a, 0x2d6b, 0x2d6c, 0x2d6d, 0x2d6e, 0x2d61,</span>
<a href="#l6.1855"></a><span id="l6.1855" class="difflineplus">+    0x2d70, 0x2d71, 0x2d72, 0x2d73, 0x2d74, 0x2d75, 0x2d76, 0x2d77,</span>
<a href="#l6.1856"></a><span id="l6.1856" class="difflineplus">+    0x2d78, 0x2d79, 0x2d7a, 0x2d7b, 0x2d7c, 0x2d7d, 0x2d7e, 0x2d7f,</span>
<a href="#l6.1857"></a><span id="l6.1857" class="difflineplus">+};</span>
<a href="#l6.1858"></a><span id="l6.1858"> </span>
<a href="#l6.1859"></a><span id="l6.1859"> static const unsigned short gNormalizeTable2e80[] = {</span>
<a href="#l6.1860"></a><span id="l6.1860" class="difflineminus">-	/* U+2e80 */</span>
<a href="#l6.1861"></a><span id="l6.1861" class="difflineminus">-	0x2e80, 0x2e81, 0x2e82, 0x2e83, 0x2e84, 0x2e85, 0x2e86, 0x2e87, </span>
<a href="#l6.1862"></a><span id="l6.1862" class="difflineminus">-	0x2e88, 0x2e89, 0x2e8a, 0x2e8b, 0x2e8c, 0x2e8d, 0x2e8e, 0x2e8f, </span>
<a href="#l6.1863"></a><span id="l6.1863" class="difflineminus">-	0x2e90, 0x2e91, 0x2e92, 0x2e93, 0x2e94, 0x2e95, 0x2e96, 0x2e97, </span>
<a href="#l6.1864"></a><span id="l6.1864" class="difflineminus">-	0x2e98, 0x2e99, 0x2e9a, 0x2e9b, 0x2e9c, 0x2e9d, 0x2e9e, 0x6bcd, </span>
<a href="#l6.1865"></a><span id="l6.1865" class="difflineminus">-	0x2ea0, 0x2ea1, 0x2ea2, 0x2ea3, 0x2ea4, 0x2ea5, 0x2ea6, 0x2ea7, </span>
<a href="#l6.1866"></a><span id="l6.1866" class="difflineminus">-	0x2ea8, 0x2ea9, 0x2eaa, 0x2eab, 0x2eac, 0x2ead, 0x2eae, 0x2eaf, </span>
<a href="#l6.1867"></a><span id="l6.1867" class="difflineminus">-	0x2eb0, 0x2eb1, 0x2eb2, 0x2eb3, 0x2eb4, 0x2eb5, 0x2eb6, 0x2eb7, </span>
<a href="#l6.1868"></a><span id="l6.1868" class="difflineminus">-	0x2eb8, 0x2eb9, 0x2eba, 0x2ebb, 0x2ebc, 0x2ebd, 0x2ebe, 0x2ebf, </span>
<a href="#l6.1869"></a><span id="l6.1869" class="difflineminus">-	};</span>
<a href="#l6.1870"></a><span id="l6.1870" class="difflineplus">+    /* U+2e80 */</span>
<a href="#l6.1871"></a><span id="l6.1871" class="difflineplus">+    0x2e80, 0x2e81, 0x2e82, 0x2e83, 0x2e84, 0x2e85, 0x2e86, 0x2e87,</span>
<a href="#l6.1872"></a><span id="l6.1872" class="difflineplus">+    0x2e88, 0x2e89, 0x2e8a, 0x2e8b, 0x2e8c, 0x2e8d, 0x2e8e, 0x2e8f,</span>
<a href="#l6.1873"></a><span id="l6.1873" class="difflineplus">+    0x2e90, 0x2e91, 0x2e92, 0x2e93, 0x2e94, 0x2e95, 0x2e96, 0x2e97,</span>
<a href="#l6.1874"></a><span id="l6.1874" class="difflineplus">+    0x2e98, 0x2e99, 0x2e9a, 0x2e9b, 0x2e9c, 0x2e9d, 0x2e9e, 0x6bcd,</span>
<a href="#l6.1875"></a><span id="l6.1875" class="difflineplus">+    0x2ea0, 0x2ea1, 0x2ea2, 0x2ea3, 0x2ea4, 0x2ea5, 0x2ea6, 0x2ea7,</span>
<a href="#l6.1876"></a><span id="l6.1876" class="difflineplus">+    0x2ea8, 0x2ea9, 0x2eaa, 0x2eab, 0x2eac, 0x2ead, 0x2eae, 0x2eaf,</span>
<a href="#l6.1877"></a><span id="l6.1877" class="difflineplus">+    0x2eb0, 0x2eb1, 0x2eb2, 0x2eb3, 0x2eb4, 0x2eb5, 0x2eb6, 0x2eb7,</span>
<a href="#l6.1878"></a><span id="l6.1878" class="difflineplus">+    0x2eb8, 0x2eb9, 0x2eba, 0x2ebb, 0x2ebc, 0x2ebd, 0x2ebe, 0x2ebf,</span>
<a href="#l6.1879"></a><span id="l6.1879" class="difflineplus">+};</span>
<a href="#l6.1880"></a><span id="l6.1880"> </span>
<a href="#l6.1881"></a><span id="l6.1881"> static const unsigned short gNormalizeTable2ec0[] = {</span>
<a href="#l6.1882"></a><span id="l6.1882" class="difflineminus">-	/* U+2ec0 */</span>
<a href="#l6.1883"></a><span id="l6.1883" class="difflineminus">-	0x2ec0, 0x2ec1, 0x2ec2, 0x2ec3, 0x2ec4, 0x2ec5, 0x2ec6, 0x2ec7, </span>
<a href="#l6.1884"></a><span id="l6.1884" class="difflineminus">-	0x2ec8, 0x2ec9, 0x2eca, 0x2ecb, 0x2ecc, 0x2ecd, 0x2ece, 0x2ecf, </span>
<a href="#l6.1885"></a><span id="l6.1885" class="difflineminus">-	0x2ed0, 0x2ed1, 0x2ed2, 0x2ed3, 0x2ed4, 0x2ed5, 0x2ed6, 0x2ed7, </span>
<a href="#l6.1886"></a><span id="l6.1886" class="difflineminus">-	0x2ed8, 0x2ed9, 0x2eda, 0x2edb, 0x2edc, 0x2edd, 0x2ede, 0x2edf, </span>
<a href="#l6.1887"></a><span id="l6.1887" class="difflineminus">-	0x2ee0, 0x2ee1, 0x2ee2, 0x2ee3, 0x2ee4, 0x2ee5, 0x2ee6, 0x2ee7, </span>
<a href="#l6.1888"></a><span id="l6.1888" class="difflineminus">-	0x2ee8, 0x2ee9, 0x2eea, 0x2eeb, 0x2eec, 0x2eed, 0x2eee, 0x2eef, </span>
<a href="#l6.1889"></a><span id="l6.1889" class="difflineminus">-	0x2ef0, 0x2ef1, 0x2ef2, 0x9f9f, 0x2ef4, 0x2ef5, 0x2ef6, 0x2ef7, </span>
<a href="#l6.1890"></a><span id="l6.1890" class="difflineminus">-	0x2ef8, 0x2ef9, 0x2efa, 0x2efb, 0x2efc, 0x2efd, 0x2efe, 0x2eff, </span>
<a href="#l6.1891"></a><span id="l6.1891" class="difflineminus">-	};</span>
<a href="#l6.1892"></a><span id="l6.1892" class="difflineplus">+    /* U+2ec0 */</span>
<a href="#l6.1893"></a><span id="l6.1893" class="difflineplus">+    0x2ec0, 0x2ec1, 0x2ec2, 0x2ec3, 0x2ec4, 0x2ec5, 0x2ec6, 0x2ec7,</span>
<a href="#l6.1894"></a><span id="l6.1894" class="difflineplus">+    0x2ec8, 0x2ec9, 0x2eca, 0x2ecb, 0x2ecc, 0x2ecd, 0x2ece, 0x2ecf,</span>
<a href="#l6.1895"></a><span id="l6.1895" class="difflineplus">+    0x2ed0, 0x2ed1, 0x2ed2, 0x2ed3, 0x2ed4, 0x2ed5, 0x2ed6, 0x2ed7,</span>
<a href="#l6.1896"></a><span id="l6.1896" class="difflineplus">+    0x2ed8, 0x2ed9, 0x2eda, 0x2edb, 0x2edc, 0x2edd, 0x2ede, 0x2edf,</span>
<a href="#l6.1897"></a><span id="l6.1897" class="difflineplus">+    0x2ee0, 0x2ee1, 0x2ee2, 0x2ee3, 0x2ee4, 0x2ee5, 0x2ee6, 0x2ee7,</span>
<a href="#l6.1898"></a><span id="l6.1898" class="difflineplus">+    0x2ee8, 0x2ee9, 0x2eea, 0x2eeb, 0x2eec, 0x2eed, 0x2eee, 0x2eef,</span>
<a href="#l6.1899"></a><span id="l6.1899" class="difflineplus">+    0x2ef0, 0x2ef1, 0x2ef2, 0x9f9f, 0x2ef4, 0x2ef5, 0x2ef6, 0x2ef7,</span>
<a href="#l6.1900"></a><span id="l6.1900" class="difflineplus">+    0x2ef8, 0x2ef9, 0x2efa, 0x2efb, 0x2efc, 0x2efd, 0x2efe, 0x2eff,</span>
<a href="#l6.1901"></a><span id="l6.1901" class="difflineplus">+};</span>
<a href="#l6.1902"></a><span id="l6.1902"> </span>
<a href="#l6.1903"></a><span id="l6.1903"> static const unsigned short gNormalizeTable2f00[] = {</span>
<a href="#l6.1904"></a><span id="l6.1904" class="difflineminus">-	/* U+2f00 */</span>
<a href="#l6.1905"></a><span id="l6.1905" class="difflineminus">-	0x4e00, 0x4e28, 0x4e36, 0x4e3f, 0x4e59, 0x4e85, 0x4e8c, 0x4ea0, </span>
<a href="#l6.1906"></a><span id="l6.1906" class="difflineminus">-	0x4eba, 0x513f, 0x5165, 0x516b, 0x5182, 0x5196, 0x51ab, 0x51e0, </span>
<a href="#l6.1907"></a><span id="l6.1907" class="difflineminus">-	0x51f5, 0x5200, 0x529b, 0x52f9, 0x5315, 0x531a, 0x5338, 0x5341, </span>
<a href="#l6.1908"></a><span id="l6.1908" class="difflineminus">-	0x535c, 0x5369, 0x5382, 0x53b6, 0x53c8, 0x53e3, 0x56d7, 0x571f, </span>
<a href="#l6.1909"></a><span id="l6.1909" class="difflineminus">-	0x58eb, 0x5902, 0x590a, 0x5915, 0x5927, 0x5973, 0x5b50, 0x5b80, </span>
<a href="#l6.1910"></a><span id="l6.1910" class="difflineminus">-	0x5bf8, 0x5c0f, 0x5c22, 0x5c38, 0x5c6e, 0x5c71, 0x5ddb, 0x5de5, </span>
<a href="#l6.1911"></a><span id="l6.1911" class="difflineminus">-	0x5df1, 0x5dfe, 0x5e72, 0x5e7a, 0x5e7f, 0x5ef4, 0x5efe, 0x5f0b, </span>
<a href="#l6.1912"></a><span id="l6.1912" class="difflineminus">-	0x5f13, 0x5f50, 0x5f61, 0x5f73, 0x5fc3, 0x6208, 0x6236, 0x624b, </span>
<a href="#l6.1913"></a><span id="l6.1913" class="difflineminus">-	};</span>
<a href="#l6.1914"></a><span id="l6.1914" class="difflineplus">+    /* U+2f00 */</span>
<a href="#l6.1915"></a><span id="l6.1915" class="difflineplus">+    0x4e00, 0x4e28, 0x4e36, 0x4e3f, 0x4e59, 0x4e85, 0x4e8c, 0x4ea0,</span>
<a href="#l6.1916"></a><span id="l6.1916" class="difflineplus">+    0x4eba, 0x513f, 0x5165, 0x516b, 0x5182, 0x5196, 0x51ab, 0x51e0,</span>
<a href="#l6.1917"></a><span id="l6.1917" class="difflineplus">+    0x51f5, 0x5200, 0x529b, 0x52f9, 0x5315, 0x531a, 0x5338, 0x5341,</span>
<a href="#l6.1918"></a><span id="l6.1918" class="difflineplus">+    0x535c, 0x5369, 0x5382, 0x53b6, 0x53c8, 0x53e3, 0x56d7, 0x571f,</span>
<a href="#l6.1919"></a><span id="l6.1919" class="difflineplus">+    0x58eb, 0x5902, 0x590a, 0x5915, 0x5927, 0x5973, 0x5b50, 0x5b80,</span>
<a href="#l6.1920"></a><span id="l6.1920" class="difflineplus">+    0x5bf8, 0x5c0f, 0x5c22, 0x5c38, 0x5c6e, 0x5c71, 0x5ddb, 0x5de5,</span>
<a href="#l6.1921"></a><span id="l6.1921" class="difflineplus">+    0x5df1, 0x5dfe, 0x5e72, 0x5e7a, 0x5e7f, 0x5ef4, 0x5efe, 0x5f0b,</span>
<a href="#l6.1922"></a><span id="l6.1922" class="difflineplus">+    0x5f13, 0x5f50, 0x5f61, 0x5f73, 0x5fc3, 0x6208, 0x6236, 0x624b,</span>
<a href="#l6.1923"></a><span id="l6.1923" class="difflineplus">+};</span>
<a href="#l6.1924"></a><span id="l6.1924"> </span>
<a href="#l6.1925"></a><span id="l6.1925"> static const unsigned short gNormalizeTable2f40[] = {</span>
<a href="#l6.1926"></a><span id="l6.1926" class="difflineminus">-	/* U+2f40 */</span>
<a href="#l6.1927"></a><span id="l6.1927" class="difflineminus">-	0x652f, 0x6534, 0x6587, 0x6597, 0x65a4, 0x65b9, 0x65e0, 0x65e5, </span>
<a href="#l6.1928"></a><span id="l6.1928" class="difflineminus">-	0x66f0, 0x6708, 0x6728, 0x6b20, 0x6b62, 0x6b79, 0x6bb3, 0x6bcb, </span>
<a href="#l6.1929"></a><span id="l6.1929" class="difflineminus">-	0x6bd4, 0x6bdb, 0x6c0f, 0x6c14, 0x6c34, 0x706b, 0x722a, 0x7236, </span>
<a href="#l6.1930"></a><span id="l6.1930" class="difflineminus">-	0x723b, 0x723f, 0x7247, 0x7259, 0x725b, 0x72ac, 0x7384, 0x7389, </span>
<a href="#l6.1931"></a><span id="l6.1931" class="difflineminus">-	0x74dc, 0x74e6, 0x7518, 0x751f, 0x7528, 0x7530, 0x758b, 0x7592, </span>
<a href="#l6.1932"></a><span id="l6.1932" class="difflineminus">-	0x7676, 0x767d, 0x76ae, 0x76bf, 0x76ee, 0x77db, 0x77e2, 0x77f3, </span>
<a href="#l6.1933"></a><span id="l6.1933" class="difflineminus">-	0x793a, 0x79b8, 0x79be, 0x7a74, 0x7acb, 0x7af9, 0x7c73, 0x7cf8, </span>
<a href="#l6.1934"></a><span id="l6.1934" class="difflineminus">-	0x7f36, 0x7f51, 0x7f8a, 0x7fbd, 0x8001, 0x800c, 0x8012, 0x8033, </span>
<a href="#l6.1935"></a><span id="l6.1935" class="difflineminus">-	};</span>
<a href="#l6.1936"></a><span id="l6.1936" class="difflineplus">+    /* U+2f40 */</span>
<a href="#l6.1937"></a><span id="l6.1937" class="difflineplus">+    0x652f, 0x6534, 0x6587, 0x6597, 0x65a4, 0x65b9, 0x65e0, 0x65e5,</span>
<a href="#l6.1938"></a><span id="l6.1938" class="difflineplus">+    0x66f0, 0x6708, 0x6728, 0x6b20, 0x6b62, 0x6b79, 0x6bb3, 0x6bcb,</span>
<a href="#l6.1939"></a><span id="l6.1939" class="difflineplus">+    0x6bd4, 0x6bdb, 0x6c0f, 0x6c14, 0x6c34, 0x706b, 0x722a, 0x7236,</span>
<a href="#l6.1940"></a><span id="l6.1940" class="difflineplus">+    0x723b, 0x723f, 0x7247, 0x7259, 0x725b, 0x72ac, 0x7384, 0x7389,</span>
<a href="#l6.1941"></a><span id="l6.1941" class="difflineplus">+    0x74dc, 0x74e6, 0x7518, 0x751f, 0x7528, 0x7530, 0x758b, 0x7592,</span>
<a href="#l6.1942"></a><span id="l6.1942" class="difflineplus">+    0x7676, 0x767d, 0x76ae, 0x76bf, 0x76ee, 0x77db, 0x77e2, 0x77f3,</span>
<a href="#l6.1943"></a><span id="l6.1943" class="difflineplus">+    0x793a, 0x79b8, 0x79be, 0x7a74, 0x7acb, 0x7af9, 0x7c73, 0x7cf8,</span>
<a href="#l6.1944"></a><span id="l6.1944" class="difflineplus">+    0x7f36, 0x7f51, 0x7f8a, 0x7fbd, 0x8001, 0x800c, 0x8012, 0x8033,</span>
<a href="#l6.1945"></a><span id="l6.1945" class="difflineplus">+};</span>
<a href="#l6.1946"></a><span id="l6.1946"> </span>
<a href="#l6.1947"></a><span id="l6.1947"> static const unsigned short gNormalizeTable2f80[] = {</span>
<a href="#l6.1948"></a><span id="l6.1948" class="difflineminus">-	/* U+2f80 */</span>
<a href="#l6.1949"></a><span id="l6.1949" class="difflineminus">-	0x807f, 0x8089, 0x81e3, 0x81ea, 0x81f3, 0x81fc, 0x820c, 0x821b, </span>
<a href="#l6.1950"></a><span id="l6.1950" class="difflineminus">-	0x821f, 0x826e, 0x8272, 0x8278, 0x864d, 0x866b, 0x8840, 0x884c, </span>
<a href="#l6.1951"></a><span id="l6.1951" class="difflineminus">-	0x8863, 0x897e, 0x898b, 0x89d2, 0x8a00, 0x8c37, 0x8c46, 0x8c55, </span>
<a href="#l6.1952"></a><span id="l6.1952" class="difflineminus">-	0x8c78, 0x8c9d, 0x8d64, 0x8d70, 0x8db3, 0x8eab, 0x8eca, 0x8f9b, </span>
<a href="#l6.1953"></a><span id="l6.1953" class="difflineminus">-	0x8fb0, 0x8fb5, 0x9091, 0x9149, 0x91c6, 0x91cc, 0x91d1, 0x9577, </span>
<a href="#l6.1954"></a><span id="l6.1954" class="difflineminus">-	0x9580, 0x961c, 0x96b6, 0x96b9, 0x96e8, 0x9751, 0x975e, 0x9762, </span>
<a href="#l6.1955"></a><span id="l6.1955" class="difflineminus">-	0x9769, 0x97cb, 0x97ed, 0x97f3, 0x9801, 0x98a8, 0x98db, 0x98df, </span>
<a href="#l6.1956"></a><span id="l6.1956" class="difflineminus">-	0x9996, 0x9999, 0x99ac, 0x9aa8, 0x9ad8, 0x9adf, 0x9b25, 0x9b2f, </span>
<a href="#l6.1957"></a><span id="l6.1957" class="difflineminus">-	};</span>
<a href="#l6.1958"></a><span id="l6.1958" class="difflineplus">+    /* U+2f80 */</span>
<a href="#l6.1959"></a><span id="l6.1959" class="difflineplus">+    0x807f, 0x8089, 0x81e3, 0x81ea, 0x81f3, 0x81fc, 0x820c, 0x821b,</span>
<a href="#l6.1960"></a><span id="l6.1960" class="difflineplus">+    0x821f, 0x826e, 0x8272, 0x8278, 0x864d, 0x866b, 0x8840, 0x884c,</span>
<a href="#l6.1961"></a><span id="l6.1961" class="difflineplus">+    0x8863, 0x897e, 0x898b, 0x89d2, 0x8a00, 0x8c37, 0x8c46, 0x8c55,</span>
<a href="#l6.1962"></a><span id="l6.1962" class="difflineplus">+    0x8c78, 0x8c9d, 0x8d64, 0x8d70, 0x8db3, 0x8eab, 0x8eca, 0x8f9b,</span>
<a href="#l6.1963"></a><span id="l6.1963" class="difflineplus">+    0x8fb0, 0x8fb5, 0x9091, 0x9149, 0x91c6, 0x91cc, 0x91d1, 0x9577,</span>
<a href="#l6.1964"></a><span id="l6.1964" class="difflineplus">+    0x9580, 0x961c, 0x96b6, 0x96b9, 0x96e8, 0x9751, 0x975e, 0x9762,</span>
<a href="#l6.1965"></a><span id="l6.1965" class="difflineplus">+    0x9769, 0x97cb, 0x97ed, 0x97f3, 0x9801, 0x98a8, 0x98db, 0x98df,</span>
<a href="#l6.1966"></a><span id="l6.1966" class="difflineplus">+    0x9996, 0x9999, 0x99ac, 0x9aa8, 0x9ad8, 0x9adf, 0x9b25, 0x9b2f,</span>
<a href="#l6.1967"></a><span id="l6.1967" class="difflineplus">+};</span>
<a href="#l6.1968"></a><span id="l6.1968"> </span>
<a href="#l6.1969"></a><span id="l6.1969"> static const unsigned short gNormalizeTable2fc0[] = {</span>
<a href="#l6.1970"></a><span id="l6.1970" class="difflineminus">-	/* U+2fc0 */</span>
<a href="#l6.1971"></a><span id="l6.1971" class="difflineminus">-	0x9b32, 0x9b3c, 0x9b5a, 0x9ce5, 0x9e75, 0x9e7f, 0x9ea5, 0x9ebb, </span>
<a href="#l6.1972"></a><span id="l6.1972" class="difflineminus">-	0x9ec3, 0x9ecd, 0x9ed1, 0x9ef9, 0x9efd, 0x9f0e, 0x9f13, 0x9f20, </span>
<a href="#l6.1973"></a><span id="l6.1973" class="difflineminus">-	0x9f3b, 0x9f4a, 0x9f52, 0x9f8d, 0x9f9c, 0x9fa0, 0x2fd6, 0x2fd7, </span>
<a href="#l6.1974"></a><span id="l6.1974" class="difflineminus">-	0x2fd8, 0x2fd9, 0x2fda, 0x2fdb, 0x2fdc, 0x2fdd, 0x2fde, 0x2fdf, </span>
<a href="#l6.1975"></a><span id="l6.1975" class="difflineminus">-	0x2fe0, 0x2fe1, 0x2fe2, 0x2fe3, 0x2fe4, 0x2fe5, 0x2fe6, 0x2fe7, </span>
<a href="#l6.1976"></a><span id="l6.1976" class="difflineminus">-	0x2fe8, 0x2fe9, 0x2fea, 0x2feb, 0x2fec, 0x2fed, 0x2fee, 0x2fef, </span>
<a href="#l6.1977"></a><span id="l6.1977" class="difflineminus">-	0x2ff0, 0x2ff1, 0x2ff2, 0x2ff3, 0x2ff4, 0x2ff5, 0x2ff6, 0x2ff7, </span>
<a href="#l6.1978"></a><span id="l6.1978" class="difflineminus">-	0x2ff8, 0x2ff9, 0x2ffa, 0x2ffb, 0x2ffc, 0x2ffd, 0x2ffe, 0x2fff, </span>
<a href="#l6.1979"></a><span id="l6.1979" class="difflineminus">-	};</span>
<a href="#l6.1980"></a><span id="l6.1980" class="difflineplus">+    /* U+2fc0 */</span>
<a href="#l6.1981"></a><span id="l6.1981" class="difflineplus">+    0x9b32, 0x9b3c, 0x9b5a, 0x9ce5, 0x9e75, 0x9e7f, 0x9ea5, 0x9ebb,</span>
<a href="#l6.1982"></a><span id="l6.1982" class="difflineplus">+    0x9ec3, 0x9ecd, 0x9ed1, 0x9ef9, 0x9efd, 0x9f0e, 0x9f13, 0x9f20,</span>
<a href="#l6.1983"></a><span id="l6.1983" class="difflineplus">+    0x9f3b, 0x9f4a, 0x9f52, 0x9f8d, 0x9f9c, 0x9fa0, 0x2fd6, 0x2fd7,</span>
<a href="#l6.1984"></a><span id="l6.1984" class="difflineplus">+    0x2fd8, 0x2fd9, 0x2fda, 0x2fdb, 0x2fdc, 0x2fdd, 0x2fde, 0x2fdf,</span>
<a href="#l6.1985"></a><span id="l6.1985" class="difflineplus">+    0x2fe0, 0x2fe1, 0x2fe2, 0x2fe3, 0x2fe4, 0x2fe5, 0x2fe6, 0x2fe7,</span>
<a href="#l6.1986"></a><span id="l6.1986" class="difflineplus">+    0x2fe8, 0x2fe9, 0x2fea, 0x2feb, 0x2fec, 0x2fed, 0x2fee, 0x2fef,</span>
<a href="#l6.1987"></a><span id="l6.1987" class="difflineplus">+    0x2ff0, 0x2ff1, 0x2ff2, 0x2ff3, 0x2ff4, 0x2ff5, 0x2ff6, 0x2ff7,</span>
<a href="#l6.1988"></a><span id="l6.1988" class="difflineplus">+    0x2ff8, 0x2ff9, 0x2ffa, 0x2ffb, 0x2ffc, 0x2ffd, 0x2ffe, 0x2fff,</span>
<a href="#l6.1989"></a><span id="l6.1989" class="difflineplus">+};</span>
<a href="#l6.1990"></a><span id="l6.1990"> </span>
<a href="#l6.1991"></a><span id="l6.1991"> static const unsigned short gNormalizeTable3000[] = {</span>
<a href="#l6.1992"></a><span id="l6.1992" class="difflineminus">-	/* U+3000 */</span>
<a href="#l6.1993"></a><span id="l6.1993" class="difflineminus">-	0x0020, 0x3001, 0x3002, 0x3003, 0x3004, 0x3005, 0x3006, 0x3007, </span>
<a href="#l6.1994"></a><span id="l6.1994" class="difflineminus">-	0x3008, 0x3009, 0x300a, 0x300b, 0x300c, 0x300d, 0x300e, 0x300f, </span>
<a href="#l6.1995"></a><span id="l6.1995" class="difflineminus">-	0x3010, 0x3011, 0x3012, 0x3013, 0x3014, 0x3015, 0x3016, 0x3017, </span>
<a href="#l6.1996"></a><span id="l6.1996" class="difflineminus">-	0x3018, 0x3019, 0x301a, 0x301b, 0x301c, 0x301d, 0x301e, 0x301f, </span>
<a href="#l6.1997"></a><span id="l6.1997" class="difflineminus">-	0x3020, 0x3021, 0x3022, 0x3023, 0x3024, 0x3025, 0x3026, 0x3027, </span>
<a href="#l6.1998"></a><span id="l6.1998" class="difflineminus">-	0x3028, 0x3029, 0x302a, 0x302b, 0x302c, 0x302d, 0x302e, 0x302f, </span>
<a href="#l6.1999"></a><span id="l6.1999" class="difflineminus">-	0x3030, 0x3031, 0x3032, 0x3033, 0x3034, 0x3035, 0x3012, 0x3037, </span>
<a href="#l6.2000"></a><span id="l6.2000" class="difflineminus">-	0x5341, 0x5344, 0x5345, 0x303b, 0x303c, 0x303d, 0x303e, 0x303f, </span>
<a href="#l6.2001"></a><span id="l6.2001" class="difflineminus">-	};</span>
<a href="#l6.2002"></a><span id="l6.2002" class="difflineplus">+    /* U+3000 */</span>
<a href="#l6.2003"></a><span id="l6.2003" class="difflineplus">+    0x0020, 0x3001, 0x3002, 0x3003, 0x3004, 0x3005, 0x3006, 0x3007,</span>
<a href="#l6.2004"></a><span id="l6.2004" class="difflineplus">+    0x3008, 0x3009, 0x300a, 0x300b, 0x300c, 0x300d, 0x300e, 0x300f,</span>
<a href="#l6.2005"></a><span id="l6.2005" class="difflineplus">+    0x3010, 0x3011, 0x3012, 0x3013, 0x3014, 0x3015, 0x3016, 0x3017,</span>
<a href="#l6.2006"></a><span id="l6.2006" class="difflineplus">+    0x3018, 0x3019, 0x301a, 0x301b, 0x301c, 0x301d, 0x301e, 0x301f,</span>
<a href="#l6.2007"></a><span id="l6.2007" class="difflineplus">+    0x3020, 0x3021, 0x3022, 0x3023, 0x3024, 0x3025, 0x3026, 0x3027,</span>
<a href="#l6.2008"></a><span id="l6.2008" class="difflineplus">+    0x3028, 0x3029, 0x302a, 0x302b, 0x302c, 0x302d, 0x302e, 0x302f,</span>
<a href="#l6.2009"></a><span id="l6.2009" class="difflineplus">+    0x3030, 0x3031, 0x3032, 0x3033, 0x3034, 0x3035, 0x3012, 0x3037,</span>
<a href="#l6.2010"></a><span id="l6.2010" class="difflineplus">+    0x5341, 0x5344, 0x5345, 0x303b, 0x303c, 0x303d, 0x303e, 0x303f,</span>
<a href="#l6.2011"></a><span id="l6.2011" class="difflineplus">+};</span>
<a href="#l6.2012"></a><span id="l6.2012"> </span>
<a href="#l6.2013"></a><span id="l6.2013"> static const unsigned short gNormalizeTable3040[] = {</span>
<a href="#l6.2014"></a><span id="l6.2014" class="difflineminus">-	/* U+3040 */</span>
<a href="#l6.2015"></a><span id="l6.2015" class="difflineminus">-	0x3040, 0x3041, 0x3042, 0x3043, 0x3044, 0x3045, 0x3046, 0x3047, </span>
<a href="#l6.2016"></a><span id="l6.2016" class="difflineminus">-	0x3048, 0x3049, 0x304a, 0x304b, 0x304b, 0x304d, 0x304d, 0x304f, </span>
<a href="#l6.2017"></a><span id="l6.2017" class="difflineminus">-	0x304f, 0x3051, 0x3051, 0x3053, 0x3053, 0x3055, 0x3055, 0x3057, </span>
<a href="#l6.2018"></a><span id="l6.2018" class="difflineminus">-	0x3057, 0x3059, 0x3059, 0x305b, 0x305b, 0x305d, 0x305d, 0x305f, </span>
<a href="#l6.2019"></a><span id="l6.2019" class="difflineminus">-	0x305f, 0x3061, 0x3061, 0x3063, 0x3064, 0x3064, 0x3066, 0x3066, </span>
<a href="#l6.2020"></a><span id="l6.2020" class="difflineminus">-	0x3068, 0x3068, 0x306a, 0x306b, 0x306c, 0x306d, 0x306e, 0x306f, </span>
<a href="#l6.2021"></a><span id="l6.2021" class="difflineminus">-	0x306f, 0x306f, 0x3072, 0x3072, 0x3072, 0x3075, 0x3075, 0x3075, </span>
<a href="#l6.2022"></a><span id="l6.2022" class="difflineminus">-	0x3078, 0x3078, 0x3078, 0x307b, 0x307b, 0x307b, 0x307e, 0x307f, </span>
<a href="#l6.2023"></a><span id="l6.2023" class="difflineminus">-	};</span>
<a href="#l6.2024"></a><span id="l6.2024" class="difflineplus">+    /* U+3040 */</span>
<a href="#l6.2025"></a><span id="l6.2025" class="difflineplus">+    0x3040, 0x3041, 0x3042, 0x3043, 0x3044, 0x3045, 0x3046, 0x3047,</span>
<a href="#l6.2026"></a><span id="l6.2026" class="difflineplus">+    0x3048, 0x3049, 0x304a, 0x304b, 0x304b, 0x304d, 0x304d, 0x304f,</span>
<a href="#l6.2027"></a><span id="l6.2027" class="difflineplus">+    0x304f, 0x3051, 0x3051, 0x3053, 0x3053, 0x3055, 0x3055, 0x3057,</span>
<a href="#l6.2028"></a><span id="l6.2028" class="difflineplus">+    0x3057, 0x3059, 0x3059, 0x305b, 0x305b, 0x305d, 0x305d, 0x305f,</span>
<a href="#l6.2029"></a><span id="l6.2029" class="difflineplus">+    0x305f, 0x3061, 0x3061, 0x3063, 0x3064, 0x3064, 0x3066, 0x3066,</span>
<a href="#l6.2030"></a><span id="l6.2030" class="difflineplus">+    0x3068, 0x3068, 0x306a, 0x306b, 0x306c, 0x306d, 0x306e, 0x306f,</span>
<a href="#l6.2031"></a><span id="l6.2031" class="difflineplus">+    0x306f, 0x306f, 0x3072, 0x3072, 0x3072, 0x3075, 0x3075, 0x3075,</span>
<a href="#l6.2032"></a><span id="l6.2032" class="difflineplus">+    0x3078, 0x3078, 0x3078, 0x307b, 0x307b, 0x307b, 0x307e, 0x307f,</span>
<a href="#l6.2033"></a><span id="l6.2033" class="difflineplus">+};</span>
<a href="#l6.2034"></a><span id="l6.2034"> </span>
<a href="#l6.2035"></a><span id="l6.2035"> static const unsigned short gNormalizeTable3080[] = {</span>
<a href="#l6.2036"></a><span id="l6.2036" class="difflineminus">-	/* U+3080 */</span>
<a href="#l6.2037"></a><span id="l6.2037" class="difflineminus">-	0x3080, 0x3081, 0x3082, 0x3083, 0x3084, 0x3085, 0x3086, 0x3087, </span>
<a href="#l6.2038"></a><span id="l6.2038" class="difflineminus">-	0x3088, 0x3089, 0x308a, 0x308b, 0x308c, 0x308d, 0x308e, 0x308f, </span>
<a href="#l6.2039"></a><span id="l6.2039" class="difflineminus">-	0x3090, 0x3091, 0x3092, 0x3093, 0x3046, 0x3095, 0x3096, 0x3097, </span>
<a href="#l6.2040"></a><span id="l6.2040" class="difflineminus">-	0x3098, 0x3099, 0x309a, 0x0020, 0x0020, 0x309d, 0x309d, 0x3088, </span>
<a href="#l6.2041"></a><span id="l6.2041" class="difflineminus">-	0x30a0, 0x30a1, 0x30a2, 0x30a3, 0x30a4, 0x30a5, 0x30a6, 0x30a7, </span>
<a href="#l6.2042"></a><span id="l6.2042" class="difflineminus">-	0x30a8, 0x30a9, 0x30aa, 0x30ab, 0x30ab, 0x30ad, 0x30ad, 0x30af, </span>
<a href="#l6.2043"></a><span id="l6.2043" class="difflineminus">-	0x30af, 0x30b1, 0x30b1, 0x30b3, 0x30b3, 0x30b5, 0x30b5, 0x30b7, </span>
<a href="#l6.2044"></a><span id="l6.2044" class="difflineminus">-	0x30b7, 0x30b9, 0x30b9, 0x30bb, 0x30bb, 0x30bd, 0x30bd, 0x30bf, </span>
<a href="#l6.2045"></a><span id="l6.2045" class="difflineminus">-	};</span>
<a href="#l6.2046"></a><span id="l6.2046" class="difflineplus">+    /* U+3080 */</span>
<a href="#l6.2047"></a><span id="l6.2047" class="difflineplus">+    0x3080, 0x3081, 0x3082, 0x3083, 0x3084, 0x3085, 0x3086, 0x3087,</span>
<a href="#l6.2048"></a><span id="l6.2048" class="difflineplus">+    0x3088, 0x3089, 0x308a, 0x308b, 0x308c, 0x308d, 0x308e, 0x308f,</span>
<a href="#l6.2049"></a><span id="l6.2049" class="difflineplus">+    0x3090, 0x3091, 0x3092, 0x3093, 0x3046, 0x3095, 0x3096, 0x3097,</span>
<a href="#l6.2050"></a><span id="l6.2050" class="difflineplus">+    0x3098, 0x3099, 0x309a, 0x0020, 0x0020, 0x309d, 0x309d, 0x3088,</span>
<a href="#l6.2051"></a><span id="l6.2051" class="difflineplus">+    0x30a0, 0x30a1, 0x30a2, 0x30a3, 0x30a4, 0x30a5, 0x30a6, 0x30a7,</span>
<a href="#l6.2052"></a><span id="l6.2052" class="difflineplus">+    0x30a8, 0x30a9, 0x30aa, 0x30ab, 0x30ab, 0x30ad, 0x30ad, 0x30af,</span>
<a href="#l6.2053"></a><span id="l6.2053" class="difflineplus">+    0x30af, 0x30b1, 0x30b1, 0x30b3, 0x30b3, 0x30b5, 0x30b5, 0x30b7,</span>
<a href="#l6.2054"></a><span id="l6.2054" class="difflineplus">+    0x30b7, 0x30b9, 0x30b9, 0x30bb, 0x30bb, 0x30bd, 0x30bd, 0x30bf,</span>
<a href="#l6.2055"></a><span id="l6.2055" class="difflineplus">+};</span>
<a href="#l6.2056"></a><span id="l6.2056"> </span>
<a href="#l6.2057"></a><span id="l6.2057"> static const unsigned short gNormalizeTable30c0[] = {</span>
<a href="#l6.2058"></a><span id="l6.2058" class="difflineminus">-	/* U+30c0 */</span>
<a href="#l6.2059"></a><span id="l6.2059" class="difflineminus">-	0x30bf, 0x30c1, 0x30c1, 0x30c3, 0x30c4, 0x30c4, 0x30c6, 0x30c6, </span>
<a href="#l6.2060"></a><span id="l6.2060" class="difflineminus">-	0x30c8, 0x30c8, 0x30ca, 0x30cb, 0x30cc, 0x30cd, 0x30ce, 0x30cf, </span>
<a href="#l6.2061"></a><span id="l6.2061" class="difflineminus">-	0x30cf, 0x30cf, 0x30d2, 0x30d2, 0x30d2, 0x30d5, 0x30d5, 0x30d5, </span>
<a href="#l6.2062"></a><span id="l6.2062" class="difflineminus">-	0x30d8, 0x30d8, 0x30d8, 0x30db, 0x30db, 0x30db, 0x30de, 0x30df, </span>
<a href="#l6.2063"></a><span id="l6.2063" class="difflineminus">-	0x30e0, 0x30e1, 0x30e2, 0x30e3, 0x30e4, 0x30e5, 0x30e6, 0x30e7, </span>
<a href="#l6.2064"></a><span id="l6.2064" class="difflineminus">-	0x30e8, 0x30e9, 0x30ea, 0x30eb, 0x30ec, 0x30ed, 0x30ee, 0x30ef, </span>
<a href="#l6.2065"></a><span id="l6.2065" class="difflineminus">-	0x30f0, 0x30f1, 0x30f2, 0x30f3, 0x30a6, 0x30f5, 0x30f6, 0x30ef, </span>
<a href="#l6.2066"></a><span id="l6.2066" class="difflineminus">-	0x30f0, 0x30f1, 0x30f2, 0x30fb, 0x30fc, 0x30fd, 0x30fd, 0x30b3, </span>
<a href="#l6.2067"></a><span id="l6.2067" class="difflineminus">-	};</span>
<a href="#l6.2068"></a><span id="l6.2068" class="difflineplus">+    /* U+30c0 */</span>
<a href="#l6.2069"></a><span id="l6.2069" class="difflineplus">+    0x30bf, 0x30c1, 0x30c1, 0x30c3, 0x30c4, 0x30c4, 0x30c6, 0x30c6,</span>
<a href="#l6.2070"></a><span id="l6.2070" class="difflineplus">+    0x30c8, 0x30c8, 0x30ca, 0x30cb, 0x30cc, 0x30cd, 0x30ce, 0x30cf,</span>
<a href="#l6.2071"></a><span id="l6.2071" class="difflineplus">+    0x30cf, 0x30cf, 0x30d2, 0x30d2, 0x30d2, 0x30d5, 0x30d5, 0x30d5,</span>
<a href="#l6.2072"></a><span id="l6.2072" class="difflineplus">+    0x30d8, 0x30d8, 0x30d8, 0x30db, 0x30db, 0x30db, 0x30de, 0x30df,</span>
<a href="#l6.2073"></a><span id="l6.2073" class="difflineplus">+    0x30e0, 0x30e1, 0x30e2, 0x30e3, 0x30e4, 0x30e5, 0x30e6, 0x30e7,</span>
<a href="#l6.2074"></a><span id="l6.2074" class="difflineplus">+    0x30e8, 0x30e9, 0x30ea, 0x30eb, 0x30ec, 0x30ed, 0x30ee, 0x30ef,</span>
<a href="#l6.2075"></a><span id="l6.2075" class="difflineplus">+    0x30f0, 0x30f1, 0x30f2, 0x30f3, 0x30a6, 0x30f5, 0x30f6, 0x30ef,</span>
<a href="#l6.2076"></a><span id="l6.2076" class="difflineplus">+    0x30f0, 0x30f1, 0x30f2, 0x30fb, 0x30fc, 0x30fd, 0x30fd, 0x30b3,</span>
<a href="#l6.2077"></a><span id="l6.2077" class="difflineplus">+};</span>
<a href="#l6.2078"></a><span id="l6.2078"> </span>
<a href="#l6.2079"></a><span id="l6.2079"> static const unsigned short gNormalizeTable3100[] = {</span>
<a href="#l6.2080"></a><span id="l6.2080" class="difflineminus">-	/* U+3100 */</span>
<a href="#l6.2081"></a><span id="l6.2081" class="difflineminus">-	0x3100, 0x3101, 0x3102, 0x3103, 0x3104, 0x3105, 0x3106, 0x3107, </span>
<a href="#l6.2082"></a><span id="l6.2082" class="difflineminus">-	0x3108, 0x3109, 0x310a, 0x310b, 0x310c, 0x310d, 0x310e, 0x310f, </span>
<a href="#l6.2083"></a><span id="l6.2083" class="difflineminus">-	0x3110, 0x3111, 0x3112, 0x3113, 0x3114, 0x3115, 0x3116, 0x3117, </span>
<a href="#l6.2084"></a><span id="l6.2084" class="difflineminus">-	0x3118, 0x3119, 0x311a, 0x311b, 0x311c, 0x311d, 0x311e, 0x311f, </span>
<a href="#l6.2085"></a><span id="l6.2085" class="difflineminus">-	0x3120, 0x3121, 0x3122, 0x3123, 0x3124, 0x3125, 0x3126, 0x3127, </span>
<a href="#l6.2086"></a><span id="l6.2086" class="difflineminus">-	0x3128, 0x3129, 0x312a, 0x312b, 0x312c, 0x312d, 0x312e, 0x312f, </span>
<a href="#l6.2087"></a><span id="l6.2087" class="difflineminus">-	0x3130, 0x1100, 0x1101, 0x11aa, 0x1102, 0x11ac, 0x11ad, 0x1103, </span>
<a href="#l6.2088"></a><span id="l6.2088" class="difflineminus">-	0x1104, 0x1105, 0x11b0, 0x11b1, 0x11b2, 0x11b3, 0x11b4, 0x11b5, </span>
<a href="#l6.2089"></a><span id="l6.2089" class="difflineminus">-	};</span>
<a href="#l6.2090"></a><span id="l6.2090" class="difflineplus">+    /* U+3100 */</span>
<a href="#l6.2091"></a><span id="l6.2091" class="difflineplus">+    0x3100, 0x3101, 0x3102, 0x3103, 0x3104, 0x3105, 0x3106, 0x3107,</span>
<a href="#l6.2092"></a><span id="l6.2092" class="difflineplus">+    0x3108, 0x3109, 0x310a, 0x310b, 0x310c, 0x310d, 0x310e, 0x310f,</span>
<a href="#l6.2093"></a><span id="l6.2093" class="difflineplus">+    0x3110, 0x3111, 0x3112, 0x3113, 0x3114, 0x3115, 0x3116, 0x3117,</span>
<a href="#l6.2094"></a><span id="l6.2094" class="difflineplus">+    0x3118, 0x3119, 0x311a, 0x311b, 0x311c, 0x311d, 0x311e, 0x311f,</span>
<a href="#l6.2095"></a><span id="l6.2095" class="difflineplus">+    0x3120, 0x3121, 0x3122, 0x3123, 0x3124, 0x3125, 0x3126, 0x3127,</span>
<a href="#l6.2096"></a><span id="l6.2096" class="difflineplus">+    0x3128, 0x3129, 0x312a, 0x312b, 0x312c, 0x312d, 0x312e, 0x312f,</span>
<a href="#l6.2097"></a><span id="l6.2097" class="difflineplus">+    0x3130, 0x1100, 0x1101, 0x11aa, 0x1102, 0x11ac, 0x11ad, 0x1103,</span>
<a href="#l6.2098"></a><span id="l6.2098" class="difflineplus">+    0x1104, 0x1105, 0x11b0, 0x11b1, 0x11b2, 0x11b3, 0x11b4, 0x11b5,</span>
<a href="#l6.2099"></a><span id="l6.2099" class="difflineplus">+};</span>
<a href="#l6.2100"></a><span id="l6.2100"> </span>
<a href="#l6.2101"></a><span id="l6.2101"> static const unsigned short gNormalizeTable3140[] = {</span>
<a href="#l6.2102"></a><span id="l6.2102" class="difflineminus">-	/* U+3140 */</span>
<a href="#l6.2103"></a><span id="l6.2103" class="difflineminus">-	0x111a, 0x1106, 0x1107, 0x1108, 0x1121, 0x1109, 0x110a, 0x110b, </span>
<a href="#l6.2104"></a><span id="l6.2104" class="difflineminus">-	0x110c, 0x110d, 0x110e, 0x110f, 0x1110, 0x1111, 0x1112, 0x1161, </span>
<a href="#l6.2105"></a><span id="l6.2105" class="difflineminus">-	0x1162, 0x1163, 0x1164, 0x1165, 0x1166, 0x1167, 0x1168, 0x1169, </span>
<a href="#l6.2106"></a><span id="l6.2106" class="difflineminus">-	0x116a, 0x116b, 0x116c, 0x116d, 0x116e, 0x116f, 0x1170, 0x1171, </span>
<a href="#l6.2107"></a><span id="l6.2107" class="difflineminus">-	0x1172, 0x1173, 0x1174, 0x1175, 0x0020, 0x1114, 0x1115, 0x11c7, </span>
<a href="#l6.2108"></a><span id="l6.2108" class="difflineminus">-	0x11c8, 0x11cc, 0x11ce, 0x11d3, 0x11d7, 0x11d9, 0x111c, 0x11dd, </span>
<a href="#l6.2109"></a><span id="l6.2109" class="difflineminus">-	0x11df, 0x111d, 0x111e, 0x1120, 0x1122, 0x1123, 0x1127, 0x1129, </span>
<a href="#l6.2110"></a><span id="l6.2110" class="difflineminus">-	0x112b, 0x112c, 0x112d, 0x112e, 0x112f, 0x1132, 0x1136, 0x1140, </span>
<a href="#l6.2111"></a><span id="l6.2111" class="difflineminus">-	};</span>
<a href="#l6.2112"></a><span id="l6.2112" class="difflineplus">+    /* U+3140 */</span>
<a href="#l6.2113"></a><span id="l6.2113" class="difflineplus">+    0x111a, 0x1106, 0x1107, 0x1108, 0x1121, 0x1109, 0x110a, 0x110b,</span>
<a href="#l6.2114"></a><span id="l6.2114" class="difflineplus">+    0x110c, 0x110d, 0x110e, 0x110f, 0x1110, 0x1111, 0x1112, 0x1161,</span>
<a href="#l6.2115"></a><span id="l6.2115" class="difflineplus">+    0x1162, 0x1163, 0x1164, 0x1165, 0x1166, 0x1167, 0x1168, 0x1169,</span>
<a href="#l6.2116"></a><span id="l6.2116" class="difflineplus">+    0x116a, 0x116b, 0x116c, 0x116d, 0x116e, 0x116f, 0x1170, 0x1171,</span>
<a href="#l6.2117"></a><span id="l6.2117" class="difflineplus">+    0x1172, 0x1173, 0x1174, 0x1175, 0x0020, 0x1114, 0x1115, 0x11c7,</span>
<a href="#l6.2118"></a><span id="l6.2118" class="difflineplus">+    0x11c8, 0x11cc, 0x11ce, 0x11d3, 0x11d7, 0x11d9, 0x111c, 0x11dd,</span>
<a href="#l6.2119"></a><span id="l6.2119" class="difflineplus">+    0x11df, 0x111d, 0x111e, 0x1120, 0x1122, 0x1123, 0x1127, 0x1129,</span>
<a href="#l6.2120"></a><span id="l6.2120" class="difflineplus">+    0x112b, 0x112c, 0x112d, 0x112e, 0x112f, 0x1132, 0x1136, 0x1140,</span>
<a href="#l6.2121"></a><span id="l6.2121" class="difflineplus">+};</span>
<a href="#l6.2122"></a><span id="l6.2122"> </span>
<a href="#l6.2123"></a><span id="l6.2123"> static const unsigned short gNormalizeTable3180[] = {</span>
<a href="#l6.2124"></a><span id="l6.2124" class="difflineminus">-	/* U+3180 */</span>
<a href="#l6.2125"></a><span id="l6.2125" class="difflineminus">-	0x1147, 0x114c, 0x11f1, 0x11f2, 0x1157, 0x1158, 0x1159, 0x1184, </span>
<a href="#l6.2126"></a><span id="l6.2126" class="difflineminus">-	0x1185, 0x1188, 0x1191, 0x1192, 0x1194, 0x119e, 0x11a1, 0x318f, </span>
<a href="#l6.2127"></a><span id="l6.2127" class="difflineminus">-	0x3190, 0x3191, 0x4e00, 0x4e8c, 0x4e09, 0x56db, 0x4e0a, 0x4e2d, </span>
<a href="#l6.2128"></a><span id="l6.2128" class="difflineminus">-	0x4e0b, 0x7532, 0x4e59, 0x4e19, 0x4e01, 0x5929, 0x5730, 0x4eba, </span>
<a href="#l6.2129"></a><span id="l6.2129" class="difflineminus">-	0x31a0, 0x31a1, 0x31a2, 0x31a3, 0x31a4, 0x31a5, 0x31a6, 0x31a7, </span>
<a href="#l6.2130"></a><span id="l6.2130" class="difflineminus">-	0x31a8, 0x31a9, 0x31aa, 0x31ab, 0x31ac, 0x31ad, 0x31ae, 0x31af, </span>
<a href="#l6.2131"></a><span id="l6.2131" class="difflineminus">-	0x31b0, 0x31b1, 0x31b2, 0x31b3, 0x31b4, 0x31b5, 0x31b6, 0x31b7, </span>
<a href="#l6.2132"></a><span id="l6.2132" class="difflineminus">-	0x31b8, 0x31b9, 0x31ba, 0x31bb, 0x31bc, 0x31bd, 0x31be, 0x31bf, </span>
<a href="#l6.2133"></a><span id="l6.2133" class="difflineminus">-	};</span>
<a href="#l6.2134"></a><span id="l6.2134" class="difflineplus">+    /* U+3180 */</span>
<a href="#l6.2135"></a><span id="l6.2135" class="difflineplus">+    0x1147, 0x114c, 0x11f1, 0x11f2, 0x1157, 0x1158, 0x1159, 0x1184,</span>
<a href="#l6.2136"></a><span id="l6.2136" class="difflineplus">+    0x1185, 0x1188, 0x1191, 0x1192, 0x1194, 0x119e, 0x11a1, 0x318f,</span>
<a href="#l6.2137"></a><span id="l6.2137" class="difflineplus">+    0x3190, 0x3191, 0x4e00, 0x4e8c, 0x4e09, 0x56db, 0x4e0a, 0x4e2d,</span>
<a href="#l6.2138"></a><span id="l6.2138" class="difflineplus">+    0x4e0b, 0x7532, 0x4e59, 0x4e19, 0x4e01, 0x5929, 0x5730, 0x4eba,</span>
<a href="#l6.2139"></a><span id="l6.2139" class="difflineplus">+    0x31a0, 0x31a1, 0x31a2, 0x31a3, 0x31a4, 0x31a5, 0x31a6, 0x31a7,</span>
<a href="#l6.2140"></a><span id="l6.2140" class="difflineplus">+    0x31a8, 0x31a9, 0x31aa, 0x31ab, 0x31ac, 0x31ad, 0x31ae, 0x31af,</span>
<a href="#l6.2141"></a><span id="l6.2141" class="difflineplus">+    0x31b0, 0x31b1, 0x31b2, 0x31b3, 0x31b4, 0x31b5, 0x31b6, 0x31b7,</span>
<a href="#l6.2142"></a><span id="l6.2142" class="difflineplus">+    0x31b8, 0x31b9, 0x31ba, 0x31bb, 0x31bc, 0x31bd, 0x31be, 0x31bf,</span>
<a href="#l6.2143"></a><span id="l6.2143" class="difflineplus">+};</span>
<a href="#l6.2144"></a><span id="l6.2144"> </span>
<a href="#l6.2145"></a><span id="l6.2145"> static const unsigned short gNormalizeTable3200[] = {</span>
<a href="#l6.2146"></a><span id="l6.2146" class="difflineminus">-	/* U+3200 */</span>
<a href="#l6.2147"></a><span id="l6.2147" class="difflineminus">-	0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, </span>
<a href="#l6.2148"></a><span id="l6.2148" class="difflineminus">-	0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, </span>
<a href="#l6.2149"></a><span id="l6.2149" class="difflineminus">-	0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, </span>
<a href="#l6.2150"></a><span id="l6.2150" class="difflineminus">-	0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x321f, </span>
<a href="#l6.2151"></a><span id="l6.2151" class="difflineminus">-	0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, </span>
<a href="#l6.2152"></a><span id="l6.2152" class="difflineminus">-	0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, </span>
<a href="#l6.2153"></a><span id="l6.2153" class="difflineminus">-	0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, </span>
<a href="#l6.2154"></a><span id="l6.2154" class="difflineminus">-	0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, </span>
<a href="#l6.2155"></a><span id="l6.2155" class="difflineminus">-	};</span>
<a href="#l6.2156"></a><span id="l6.2156" class="difflineplus">+    /* U+3200 */</span>
<a href="#l6.2157"></a><span id="l6.2157" class="difflineplus">+    0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028,</span>
<a href="#l6.2158"></a><span id="l6.2158" class="difflineplus">+    0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028,</span>
<a href="#l6.2159"></a><span id="l6.2159" class="difflineplus">+    0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028,</span>
<a href="#l6.2160"></a><span id="l6.2160" class="difflineplus">+    0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x321f,</span>
<a href="#l6.2161"></a><span id="l6.2161" class="difflineplus">+    0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028,</span>
<a href="#l6.2162"></a><span id="l6.2162" class="difflineplus">+    0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028,</span>
<a href="#l6.2163"></a><span id="l6.2163" class="difflineplus">+    0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028,</span>
<a href="#l6.2164"></a><span id="l6.2164" class="difflineplus">+    0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028,</span>
<a href="#l6.2165"></a><span id="l6.2165" class="difflineplus">+};</span>
<a href="#l6.2166"></a><span id="l6.2166"> </span>
<a href="#l6.2167"></a><span id="l6.2167"> static const unsigned short gNormalizeTable3240[] = {</span>
<a href="#l6.2168"></a><span id="l6.2168" class="difflineminus">-	/* U+3240 */</span>
<a href="#l6.2169"></a><span id="l6.2169" class="difflineminus">-	0x0028, 0x0028, 0x0028, 0x0028, 0x554f, 0x5e7c, 0x6587, 0x7b8f, </span>
<a href="#l6.2170"></a><span id="l6.2170" class="difflineminus">-	0x3248, 0x3249, 0x324a, 0x324b, 0x324c, 0x324d, 0x324e, 0x324f, </span>
<a href="#l6.2171"></a><span id="l6.2171" class="difflineminus">-	0x0070, 0x0032, 0x0032, 0x0032, 0x0032, 0x0032, 0x0032, 0x0032, </span>
<a href="#l6.2172"></a><span id="l6.2172" class="difflineminus">-	0x0032, 0x0032, 0x0033, 0x0033, 0x0033, 0x0033, 0x0033, 0x0033, </span>
<a href="#l6.2173"></a><span id="l6.2173" class="difflineminus">-	0x1100, 0x1102, 0x1103, 0x1105, 0x1106, 0x1107, 0x1109, 0x110b, </span>
<a href="#l6.2174"></a><span id="l6.2174" class="difflineminus">-	0x110c, 0x110e, 0x110f, 0x1110, 0x1111, 0x1112, 0x1100, 0x1102, </span>
<a href="#l6.2175"></a><span id="l6.2175" class="difflineminus">-	0x1103, 0x1105, 0x1106, 0x1107, 0x1109, 0x110b, 0x110c, 0x110e, </span>
<a href="#l6.2176"></a><span id="l6.2176" class="difflineminus">-	0x110f, 0x1110, 0x1111, 0x1112, 0x110e, 0x110c, 0x110b, 0x327f, </span>
<a href="#l6.2177"></a><span id="l6.2177" class="difflineminus">-	};</span>
<a href="#l6.2178"></a><span id="l6.2178" class="difflineplus">+    /* U+3240 */</span>
<a href="#l6.2179"></a><span id="l6.2179" class="difflineplus">+    0x0028, 0x0028, 0x0028, 0x0028, 0x554f, 0x5e7c, 0x6587, 0x7b8f,</span>
<a href="#l6.2180"></a><span id="l6.2180" class="difflineplus">+    0x3248, 0x3249, 0x324a, 0x324b, 0x324c, 0x324d, 0x324e, 0x324f,</span>
<a href="#l6.2181"></a><span id="l6.2181" class="difflineplus">+    0x0070, 0x0032, 0x0032, 0x0032, 0x0032, 0x0032, 0x0032, 0x0032,</span>
<a href="#l6.2182"></a><span id="l6.2182" class="difflineplus">+    0x0032, 0x0032, 0x0033, 0x0033, 0x0033, 0x0033, 0x0033, 0x0033,</span>
<a href="#l6.2183"></a><span id="l6.2183" class="difflineplus">+    0x1100, 0x1102, 0x1103, 0x1105, 0x1106, 0x1107, 0x1109, 0x110b,</span>
<a href="#l6.2184"></a><span id="l6.2184" class="difflineplus">+    0x110c, 0x110e, 0x110f, 0x1110, 0x1111, 0x1112, 0x1100, 0x1102,</span>
<a href="#l6.2185"></a><span id="l6.2185" class="difflineplus">+    0x1103, 0x1105, 0x1106, 0x1107, 0x1109, 0x110b, 0x110c, 0x110e,</span>
<a href="#l6.2186"></a><span id="l6.2186" class="difflineplus">+    0x110f, 0x1110, 0x1111, 0x1112, 0x110e, 0x110c, 0x110b, 0x327f,</span>
<a href="#l6.2187"></a><span id="l6.2187" class="difflineplus">+};</span>
<a href="#l6.2188"></a><span id="l6.2188"> </span>
<a href="#l6.2189"></a><span id="l6.2189"> static const unsigned short gNormalizeTable3280[] = {</span>
<a href="#l6.2190"></a><span id="l6.2190" class="difflineminus">-	/* U+3280 */</span>
<a href="#l6.2191"></a><span id="l6.2191" class="difflineminus">-	0x4e00, 0x4e8c, 0x4e09, 0x56db, 0x4e94, 0x516d, 0x4e03, 0x516b, </span>
<a href="#l6.2192"></a><span id="l6.2192" class="difflineminus">-	0x4e5d, 0x5341, 0x6708, 0x706b, 0x6c34, 0x6728, 0x91d1, 0x571f, </span>
<a href="#l6.2193"></a><span id="l6.2193" class="difflineminus">-	0x65e5, 0x682a, 0x6709, 0x793e, 0x540d, 0x7279, 0x8ca1, 0x795d, </span>
<a href="#l6.2194"></a><span id="l6.2194" class="difflineminus">-	0x52b4, 0x79d8, 0x7537, 0x5973, 0x9069, 0x512a, 0x5370, 0x6ce8, </span>
<a href="#l6.2195"></a><span id="l6.2195" class="difflineminus">-	0x9805, 0x4f11, 0x5199, 0x6b63, 0x4e0a, 0x4e2d, 0x4e0b, 0x5de6, </span>
<a href="#l6.2196"></a><span id="l6.2196" class="difflineminus">-	0x53f3, 0x533b, 0x5b97, 0x5b66, 0x76e3, 0x4f01, 0x8cc7, 0x5354, </span>
<a href="#l6.2197"></a><span id="l6.2197" class="difflineminus">-	0x591c, 0x0033, 0x0033, 0x0033, 0x0033, 0x0034, 0x0034, 0x0034, </span>
<a href="#l6.2198"></a><span id="l6.2198" class="difflineminus">-	0x0034, 0x0034, 0x0034, 0x0034, 0x0034, 0x0034, 0x0034, 0x0035, </span>
<a href="#l6.2199"></a><span id="l6.2199" class="difflineminus">-	};</span>
<a href="#l6.2200"></a><span id="l6.2200" class="difflineplus">+    /* U+3280 */</span>
<a href="#l6.2201"></a><span id="l6.2201" class="difflineplus">+    0x4e00, 0x4e8c, 0x4e09, 0x56db, 0x4e94, 0x516d, 0x4e03, 0x516b,</span>
<a href="#l6.2202"></a><span id="l6.2202" class="difflineplus">+    0x4e5d, 0x5341, 0x6708, 0x706b, 0x6c34, 0x6728, 0x91d1, 0x571f,</span>
<a href="#l6.2203"></a><span id="l6.2203" class="difflineplus">+    0x65e5, 0x682a, 0x6709, 0x793e, 0x540d, 0x7279, 0x8ca1, 0x795d,</span>
<a href="#l6.2204"></a><span id="l6.2204" class="difflineplus">+    0x52b4, 0x79d8, 0x7537, 0x5973, 0x9069, 0x512a, 0x5370, 0x6ce8,</span>
<a href="#l6.2205"></a><span id="l6.2205" class="difflineplus">+    0x9805, 0x4f11, 0x5199, 0x6b63, 0x4e0a, 0x4e2d, 0x4e0b, 0x5de6,</span>
<a href="#l6.2206"></a><span id="l6.2206" class="difflineplus">+    0x53f3, 0x533b, 0x5b97, 0x5b66, 0x76e3, 0x4f01, 0x8cc7, 0x5354,</span>
<a href="#l6.2207"></a><span id="l6.2207" class="difflineplus">+    0x591c, 0x0033, 0x0033, 0x0033, 0x0033, 0x0034, 0x0034, 0x0034,</span>
<a href="#l6.2208"></a><span id="l6.2208" class="difflineplus">+    0x0034, 0x0034, 0x0034, 0x0034, 0x0034, 0x0034, 0x0034, 0x0035,</span>
<a href="#l6.2209"></a><span id="l6.2209" class="difflineplus">+};</span>
<a href="#l6.2210"></a><span id="l6.2210"> </span>
<a href="#l6.2211"></a><span id="l6.2211"> static const unsigned short gNormalizeTable32c0[] = {</span>
<a href="#l6.2212"></a><span id="l6.2212" class="difflineminus">-	/* U+32c0 */</span>
<a href="#l6.2213"></a><span id="l6.2213" class="difflineminus">-	0x0031, 0x0032, 0x0033, 0x0034, 0x0035, 0x0036, 0x0037, 0x0038, </span>
<a href="#l6.2214"></a><span id="l6.2214" class="difflineminus">-	0x0039, 0x0031, 0x0031, 0x0031, 0x0068, 0x0065, 0x0065, 0x006c, </span>
<a href="#l6.2215"></a><span id="l6.2215" class="difflineminus">-	0x30a2, 0x30a4, 0x30a6, 0x30a8, 0x30aa, 0x30ab, 0x30ad, 0x30af, </span>
<a href="#l6.2216"></a><span id="l6.2216" class="difflineminus">-	0x30b1, 0x30b3, 0x30b5, 0x30b7, 0x30b9, 0x30bb, 0x30bd, 0x30bf, </span>
<a href="#l6.2217"></a><span id="l6.2217" class="difflineminus">-	0x30c1, 0x30c4, 0x30c6, 0x30c8, 0x30ca, 0x30cb, 0x30cc, 0x30cd, </span>
<a href="#l6.2218"></a><span id="l6.2218" class="difflineminus">-	0x30ce, 0x30cf, 0x30d2, 0x30d5, 0x30d8, 0x30db, 0x30de, 0x30df, </span>
<a href="#l6.2219"></a><span id="l6.2219" class="difflineminus">-	0x30e0, 0x30e1, 0x30e2, 0x30e4, 0x30e6, 0x30e8, 0x30e9, 0x30ea, </span>
<a href="#l6.2220"></a><span id="l6.2220" class="difflineminus">-	0x30eb, 0x30ec, 0x30ed, 0x30ef, 0x30f0, 0x30f1, 0x30f2, 0x32ff, </span>
<a href="#l6.2221"></a><span id="l6.2221" class="difflineminus">-	};</span>
<a href="#l6.2222"></a><span id="l6.2222" class="difflineplus">+    /* U+32c0 */</span>
<a href="#l6.2223"></a><span id="l6.2223" class="difflineplus">+    0x0031, 0x0032, 0x0033, 0x0034, 0x0035, 0x0036, 0x0037, 0x0038,</span>
<a href="#l6.2224"></a><span id="l6.2224" class="difflineplus">+    0x0039, 0x0031, 0x0031, 0x0031, 0x0068, 0x0065, 0x0065, 0x006c,</span>
<a href="#l6.2225"></a><span id="l6.2225" class="difflineplus">+    0x30a2, 0x30a4, 0x30a6, 0x30a8, 0x30aa, 0x30ab, 0x30ad, 0x30af,</span>
<a href="#l6.2226"></a><span id="l6.2226" class="difflineplus">+    0x30b1, 0x30b3, 0x30b5, 0x30b7, 0x30b9, 0x30bb, 0x30bd, 0x30bf,</span>
<a href="#l6.2227"></a><span id="l6.2227" class="difflineplus">+    0x30c1, 0x30c4, 0x30c6, 0x30c8, 0x30ca, 0x30cb, 0x30cc, 0x30cd,</span>
<a href="#l6.2228"></a><span id="l6.2228" class="difflineplus">+    0x30ce, 0x30cf, 0x30d2, 0x30d5, 0x30d8, 0x30db, 0x30de, 0x30df,</span>
<a href="#l6.2229"></a><span id="l6.2229" class="difflineplus">+    0x30e0, 0x30e1, 0x30e2, 0x30e4, 0x30e6, 0x30e8, 0x30e9, 0x30ea,</span>
<a href="#l6.2230"></a><span id="l6.2230" class="difflineplus">+    0x30eb, 0x30ec, 0x30ed, 0x30ef, 0x30f0, 0x30f1, 0x30f2, 0x32ff,</span>
<a href="#l6.2231"></a><span id="l6.2231" class="difflineplus">+};</span>
<a href="#l6.2232"></a><span id="l6.2232"> </span>
<a href="#l6.2233"></a><span id="l6.2233"> static const unsigned short gNormalizeTable3300[] = {</span>
<a href="#l6.2234"></a><span id="l6.2234" class="difflineminus">-	/* U+3300 */</span>
<a href="#l6.2235"></a><span id="l6.2235" class="difflineminus">-	0x30a2, 0x30a2, 0x30a2, 0x30a2, 0x30a4, 0x30a4, 0x30a6, 0x30a8, </span>
<a href="#l6.2236"></a><span id="l6.2236" class="difflineminus">-	0x30a8, 0x30aa, 0x30aa, 0x30ab, 0x30ab, 0x30ab, 0x30ab, 0x30ab, </span>
<a href="#l6.2237"></a><span id="l6.2237" class="difflineminus">-	0x30ad, 0x30ad, 0x30ad, 0x30ad, 0x30ad, 0x30ad, 0x30ad, 0x30ad, </span>
<a href="#l6.2238"></a><span id="l6.2238" class="difflineminus">-	0x30af, 0x30af, 0x30af, 0x30af, 0x30b1, 0x30b3, 0x30b3, 0x30b5, </span>
<a href="#l6.2239"></a><span id="l6.2239" class="difflineminus">-	0x30b5, 0x30b7, 0x30bb, 0x30bb, 0x30bf, 0x30c6, 0x30c8, 0x30c8, </span>
<a href="#l6.2240"></a><span id="l6.2240" class="difflineminus">-	0x30ca, 0x30ce, 0x30cf, 0x30cf, 0x30cf, 0x30cf, 0x30d2, 0x30d2, </span>
<a href="#l6.2241"></a><span id="l6.2241" class="difflineminus">-	0x30d2, 0x30d2, 0x30d5, 0x30d5, 0x30d5, 0x30d5, 0x30d8, 0x30d8, </span>
<a href="#l6.2242"></a><span id="l6.2242" class="difflineminus">-	0x30d8, 0x30d8, 0x30d8, 0x30d8, 0x30d8, 0x30db, 0x30db, 0x30db, </span>
<a href="#l6.2243"></a><span id="l6.2243" class="difflineminus">-	};</span>
<a href="#l6.2244"></a><span id="l6.2244" class="difflineplus">+    /* U+3300 */</span>
<a href="#l6.2245"></a><span id="l6.2245" class="difflineplus">+    0x30a2, 0x30a2, 0x30a2, 0x30a2, 0x30a4, 0x30a4, 0x30a6, 0x30a8,</span>
<a href="#l6.2246"></a><span id="l6.2246" class="difflineplus">+    0x30a8, 0x30aa, 0x30aa, 0x30ab, 0x30ab, 0x30ab, 0x30ab, 0x30ab,</span>
<a href="#l6.2247"></a><span id="l6.2247" class="difflineplus">+    0x30ad, 0x30ad, 0x30ad, 0x30ad, 0x30ad, 0x30ad, 0x30ad, 0x30ad,</span>
<a href="#l6.2248"></a><span id="l6.2248" class="difflineplus">+    0x30af, 0x30af, 0x30af, 0x30af, 0x30b1, 0x30b3, 0x30b3, 0x30b5,</span>
<a href="#l6.2249"></a><span id="l6.2249" class="difflineplus">+    0x30b5, 0x30b7, 0x30bb, 0x30bb, 0x30bf, 0x30c6, 0x30c8, 0x30c8,</span>
<a href="#l6.2250"></a><span id="l6.2250" class="difflineplus">+    0x30ca, 0x30ce, 0x30cf, 0x30cf, 0x30cf, 0x30cf, 0x30d2, 0x30d2,</span>
<a href="#l6.2251"></a><span id="l6.2251" class="difflineplus">+    0x30d2, 0x30d2, 0x30d5, 0x30d5, 0x30d5, 0x30d5, 0x30d8, 0x30d8,</span>
<a href="#l6.2252"></a><span id="l6.2252" class="difflineplus">+    0x30d8, 0x30d8, 0x30d8, 0x30d8, 0x30d8, 0x30db, 0x30db, 0x30db,</span>
<a href="#l6.2253"></a><span id="l6.2253" class="difflineplus">+};</span>
<a href="#l6.2254"></a><span id="l6.2254"> </span>
<a href="#l6.2255"></a><span id="l6.2255"> static const unsigned short gNormalizeTable3340[] = {</span>
<a href="#l6.2256"></a><span id="l6.2256" class="difflineminus">-	/* U+3340 */</span>
<a href="#l6.2257"></a><span id="l6.2257" class="difflineminus">-	0x30db, 0x30db, 0x30db, 0x30de, 0x30de, 0x30de, 0x30de, 0x30de, </span>
<a href="#l6.2258"></a><span id="l6.2258" class="difflineminus">-	0x30df, 0x30df, 0x30df, 0x30e1, 0x30e1, 0x30e1, 0x30e4, 0x30e4, </span>
<a href="#l6.2259"></a><span id="l6.2259" class="difflineminus">-	0x30e6, 0x30ea, 0x30ea, 0x30eb, 0x30eb, 0x30ec, 0x30ec, 0x30ef, </span>
<a href="#l6.2260"></a><span id="l6.2260" class="difflineminus">-	0x0030, 0x0031, 0x0032, 0x0033, 0x0034, 0x0035, 0x0036, 0x0037, </span>
<a href="#l6.2261"></a><span id="l6.2261" class="difflineminus">-	0x0038, 0x0039, 0x0031, 0x0031, 0x0031, 0x0031, 0x0031, 0x0031, </span>
<a href="#l6.2262"></a><span id="l6.2262" class="difflineminus">-	0x0031, 0x0031, 0x0031, 0x0031, 0x0032, 0x0032, 0x0032, 0x0032, </span>
<a href="#l6.2263"></a><span id="l6.2263" class="difflineminus">-	0x0032, 0x0068, 0x0064, 0x0061, 0x0062, 0x006f, 0x0070, 0x0064, </span>
<a href="#l6.2264"></a><span id="l6.2264" class="difflineminus">-	0x0064, 0x0064, 0x0069, 0x5e73, 0x662d, 0x5927, 0x660e, 0x682a, </span>
<a href="#l6.2265"></a><span id="l6.2265" class="difflineminus">-	};</span>
<a href="#l6.2266"></a><span id="l6.2266" class="difflineplus">+    /* U+3340 */</span>
<a href="#l6.2267"></a><span id="l6.2267" class="difflineplus">+    0x30db, 0x30db, 0x30db, 0x30de, 0x30de, 0x30de, 0x30de, 0x30de,</span>
<a href="#l6.2268"></a><span id="l6.2268" class="difflineplus">+    0x30df, 0x30df, 0x30df, 0x30e1, 0x30e1, 0x30e1, 0x30e4, 0x30e4,</span>
<a href="#l6.2269"></a><span id="l6.2269" class="difflineplus">+    0x30e6, 0x30ea, 0x30ea, 0x30eb, 0x30eb, 0x30ec, 0x30ec, 0x30ef,</span>
<a href="#l6.2270"></a><span id="l6.2270" class="difflineplus">+    0x0030, 0x0031, 0x0032, 0x0033, 0x0034, 0x0035, 0x0036, 0x0037,</span>
<a href="#l6.2271"></a><span id="l6.2271" class="difflineplus">+    0x0038, 0x0039, 0x0031, 0x0031, 0x0031, 0x0031, 0x0031, 0x0031,</span>
<a href="#l6.2272"></a><span id="l6.2272" class="difflineplus">+    0x0031, 0x0031, 0x0031, 0x0031, 0x0032, 0x0032, 0x0032, 0x0032,</span>
<a href="#l6.2273"></a><span id="l6.2273" class="difflineplus">+    0x0032, 0x0068, 0x0064, 0x0061, 0x0062, 0x006f, 0x0070, 0x0064,</span>
<a href="#l6.2274"></a><span id="l6.2274" class="difflineplus">+    0x0064, 0x0064, 0x0069, 0x5e73, 0x662d, 0x5927, 0x660e, 0x682a,</span>
<a href="#l6.2275"></a><span id="l6.2275" class="difflineplus">+};</span>
<a href="#l6.2276"></a><span id="l6.2276"> </span>
<a href="#l6.2277"></a><span id="l6.2277"> static const unsigned short gNormalizeTable3380[] = {</span>
<a href="#l6.2278"></a><span id="l6.2278" class="difflineminus">-	/* U+3380 */</span>
<a href="#l6.2279"></a><span id="l6.2279" class="difflineminus">-	0x0070, 0x006e, 0x03bc, 0x006d, 0x006b, 0x006b, 0x006d, 0x0067, </span>
<a href="#l6.2280"></a><span id="l6.2280" class="difflineminus">-	0x0063, 0x006b, 0x0070, 0x006e, 0x03bc, 0x03bc, 0x006d, 0x006b, </span>
<a href="#l6.2281"></a><span id="l6.2281" class="difflineminus">-	0x0068, 0x006b, 0x006d, 0x0067, 0x0074, 0x03bc, 0x006d, 0x0064, </span>
<a href="#l6.2282"></a><span id="l6.2282" class="difflineminus">-	0x006b, 0x0066, 0x006e, 0x03bc, 0x006d, 0x0063, 0x006b, 0x006d, </span>
<a href="#l6.2283"></a><span id="l6.2283" class="difflineminus">-	0x0063, 0x006d, 0x006b, 0x006d, 0x0063, 0x006d, 0x006b, 0x006d, </span>
<a href="#l6.2284"></a><span id="l6.2284" class="difflineminus">-	0x006d, 0x0070, 0x006b, 0x006d, 0x0067, 0x0072, 0x0072, 0x0072, </span>
<a href="#l6.2285"></a><span id="l6.2285" class="difflineminus">-	0x0070, 0x006e, 0x03bc, 0x006d, 0x0070, 0x006e, 0x03bc, 0x006d, </span>
<a href="#l6.2286"></a><span id="l6.2286" class="difflineminus">-	0x006b, 0x006d, 0x0070, 0x006e, 0x03bc, 0x006d, 0x006b, 0x006d, </span>
<a href="#l6.2287"></a><span id="l6.2287" class="difflineminus">-	};</span>
<a href="#l6.2288"></a><span id="l6.2288" class="difflineplus">+    /* U+3380 */</span>
<a href="#l6.2289"></a><span id="l6.2289" class="difflineplus">+    0x0070, 0x006e, 0x03bc, 0x006d, 0x006b, 0x006b, 0x006d, 0x0067,</span>
<a href="#l6.2290"></a><span id="l6.2290" class="difflineplus">+    0x0063, 0x006b, 0x0070, 0x006e, 0x03bc, 0x03bc, 0x006d, 0x006b,</span>
<a href="#l6.2291"></a><span id="l6.2291" class="difflineplus">+    0x0068, 0x006b, 0x006d, 0x0067, 0x0074, 0x03bc, 0x006d, 0x0064,</span>
<a href="#l6.2292"></a><span id="l6.2292" class="difflineplus">+    0x006b, 0x0066, 0x006e, 0x03bc, 0x006d, 0x0063, 0x006b, 0x006d,</span>
<a href="#l6.2293"></a><span id="l6.2293" class="difflineplus">+    0x0063, 0x006d, 0x006b, 0x006d, 0x0063, 0x006d, 0x006b, 0x006d,</span>
<a href="#l6.2294"></a><span id="l6.2294" class="difflineplus">+    0x006d, 0x0070, 0x006b, 0x006d, 0x0067, 0x0072, 0x0072, 0x0072,</span>
<a href="#l6.2295"></a><span id="l6.2295" class="difflineplus">+    0x0070, 0x006e, 0x03bc, 0x006d, 0x0070, 0x006e, 0x03bc, 0x006d,</span>
<a href="#l6.2296"></a><span id="l6.2296" class="difflineplus">+    0x006b, 0x006d, 0x0070, 0x006e, 0x03bc, 0x006d, 0x006b, 0x006d,</span>
<a href="#l6.2297"></a><span id="l6.2297" class="difflineplus">+};</span>
<a href="#l6.2298"></a><span id="l6.2298"> </span>
<a href="#l6.2299"></a><span id="l6.2299"> static const unsigned short gNormalizeTable33c0[] = {</span>
<a href="#l6.2300"></a><span id="l6.2300" class="difflineminus">-	/* U+33c0 */</span>
<a href="#l6.2301"></a><span id="l6.2301" class="difflineminus">-	0x006b, 0x006d, 0x0061, 0x0062, 0x0063, 0x0063, 0x0063, 0x0063, </span>
<a href="#l6.2302"></a><span id="l6.2302" class="difflineminus">-	0x0064, 0x0067, 0x0068, 0x0068, 0x0069, 0x006b, 0x006b, 0x006b, </span>
<a href="#l6.2303"></a><span id="l6.2303" class="difflineminus">-	0x006c, 0x006c, 0x006c, 0x006c, 0x006d, 0x006d, 0x006d, 0x0070, </span>
<a href="#l6.2304"></a><span id="l6.2304" class="difflineminus">-	0x0070, 0x0070, 0x0070, 0x0073, 0x0073, 0x0077, 0x0076, 0x0061, </span>
<a href="#l6.2305"></a><span id="l6.2305" class="difflineminus">-	0x0031, 0x0032, 0x0033, 0x0034, 0x0035, 0x0036, 0x0037, 0x0038, </span>
<a href="#l6.2306"></a><span id="l6.2306" class="difflineminus">-	0x0039, 0x0031, 0x0031, 0x0031, 0x0031, 0x0031, 0x0031, 0x0031, </span>
<a href="#l6.2307"></a><span id="l6.2307" class="difflineminus">-	0x0031, 0x0031, 0x0031, 0x0032, 0x0032, 0x0032, 0x0032, 0x0032, </span>
<a href="#l6.2308"></a><span id="l6.2308" class="difflineminus">-	0x0032, 0x0032, 0x0032, 0x0032, 0x0032, 0x0033, 0x0033, 0x0067, </span>
<a href="#l6.2309"></a><span id="l6.2309" class="difflineminus">-	};</span>
<a href="#l6.2310"></a><span id="l6.2310" class="difflineplus">+    /* U+33c0 */</span>
<a href="#l6.2311"></a><span id="l6.2311" class="difflineplus">+    0x006b, 0x006d, 0x0061, 0x0062, 0x0063, 0x0063, 0x0063, 0x0063,</span>
<a href="#l6.2312"></a><span id="l6.2312" class="difflineplus">+    0x0064, 0x0067, 0x0068, 0x0068, 0x0069, 0x006b, 0x006b, 0x006b,</span>
<a href="#l6.2313"></a><span id="l6.2313" class="difflineplus">+    0x006c, 0x006c, 0x006c, 0x006c, 0x006d, 0x006d, 0x006d, 0x0070,</span>
<a href="#l6.2314"></a><span id="l6.2314" class="difflineplus">+    0x0070, 0x0070, 0x0070, 0x0073, 0x0073, 0x0077, 0x0076, 0x0061,</span>
<a href="#l6.2315"></a><span id="l6.2315" class="difflineplus">+    0x0031, 0x0032, 0x0033, 0x0034, 0x0035, 0x0036, 0x0037, 0x0038,</span>
<a href="#l6.2316"></a><span id="l6.2316" class="difflineplus">+    0x0039, 0x0031, 0x0031, 0x0031, 0x0031, 0x0031, 0x0031, 0x0031,</span>
<a href="#l6.2317"></a><span id="l6.2317" class="difflineplus">+    0x0031, 0x0031, 0x0031, 0x0032, 0x0032, 0x0032, 0x0032, 0x0032,</span>
<a href="#l6.2318"></a><span id="l6.2318" class="difflineplus">+    0x0032, 0x0032, 0x0032, 0x0032, 0x0032, 0x0033, 0x0033, 0x0067,</span>
<a href="#l6.2319"></a><span id="l6.2319" class="difflineplus">+};</span>
<a href="#l6.2320"></a><span id="l6.2320"> </span>
<a href="#l6.2321"></a><span id="l6.2321"> static const unsigned short gNormalizeTablea640[] = {</span>
<a href="#l6.2322"></a><span id="l6.2322" class="difflineminus">-	/* U+a640 */</span>
<a href="#l6.2323"></a><span id="l6.2323" class="difflineminus">-	0xa641, 0xa641, 0xa643, 0xa643, 0xa645, 0xa645, 0xa647, 0xa647, </span>
<a href="#l6.2324"></a><span id="l6.2324" class="difflineminus">-	0xa649, 0xa649, 0xa64b, 0xa64b, 0xa64d, 0xa64d, 0xa64f, 0xa64f, </span>
<a href="#l6.2325"></a><span id="l6.2325" class="difflineminus">-	0xa651, 0xa651, 0xa653, 0xa653, 0xa655, 0xa655, 0xa657, 0xa657, </span>
<a href="#l6.2326"></a><span id="l6.2326" class="difflineminus">-	0xa659, 0xa659, 0xa65b, 0xa65b, 0xa65d, 0xa65d, 0xa65f, 0xa65f, </span>
<a href="#l6.2327"></a><span id="l6.2327" class="difflineminus">-	0xa660, 0xa661, 0xa663, 0xa663, 0xa665, 0xa665, 0xa667, 0xa667, </span>
<a href="#l6.2328"></a><span id="l6.2328" class="difflineminus">-	0xa669, 0xa669, 0xa66b, 0xa66b, 0xa66d, 0xa66d, 0xa66e, 0xa66f, </span>
<a href="#l6.2329"></a><span id="l6.2329" class="difflineminus">-	0xa670, 0xa671, 0xa672, 0xa673, 0xa674, 0xa675, 0xa676, 0xa677, </span>
<a href="#l6.2330"></a><span id="l6.2330" class="difflineminus">-	0xa678, 0xa679, 0xa67a, 0xa67b, 0xa67c, 0xa67d, 0xa67e, 0xa67f, </span>
<a href="#l6.2331"></a><span id="l6.2331" class="difflineminus">-	};</span>
<a href="#l6.2332"></a><span id="l6.2332" class="difflineplus">+    /* U+a640 */</span>
<a href="#l6.2333"></a><span id="l6.2333" class="difflineplus">+    0xa641, 0xa641, 0xa643, 0xa643, 0xa645, 0xa645, 0xa647, 0xa647,</span>
<a href="#l6.2334"></a><span id="l6.2334" class="difflineplus">+    0xa649, 0xa649, 0xa64b, 0xa64b, 0xa64d, 0xa64d, 0xa64f, 0xa64f,</span>
<a href="#l6.2335"></a><span id="l6.2335" class="difflineplus">+    0xa651, 0xa651, 0xa653, 0xa653, 0xa655, 0xa655, 0xa657, 0xa657,</span>
<a href="#l6.2336"></a><span id="l6.2336" class="difflineplus">+    0xa659, 0xa659, 0xa65b, 0xa65b, 0xa65d, 0xa65d, 0xa65f, 0xa65f,</span>
<a href="#l6.2337"></a><span id="l6.2337" class="difflineplus">+    0xa660, 0xa661, 0xa663, 0xa663, 0xa665, 0xa665, 0xa667, 0xa667,</span>
<a href="#l6.2338"></a><span id="l6.2338" class="difflineplus">+    0xa669, 0xa669, 0xa66b, 0xa66b, 0xa66d, 0xa66d, 0xa66e, 0xa66f,</span>
<a href="#l6.2339"></a><span id="l6.2339" class="difflineplus">+    0xa670, 0xa671, 0xa672, 0xa673, 0xa674, 0xa675, 0xa676, 0xa677,</span>
<a href="#l6.2340"></a><span id="l6.2340" class="difflineplus">+    0xa678, 0xa679, 0xa67a, 0xa67b, 0xa67c, 0xa67d, 0xa67e, 0xa67f,</span>
<a href="#l6.2341"></a><span id="l6.2341" class="difflineplus">+};</span>
<a href="#l6.2342"></a><span id="l6.2342"> </span>
<a href="#l6.2343"></a><span id="l6.2343"> static const unsigned short gNormalizeTablea680[] = {</span>
<a href="#l6.2344"></a><span id="l6.2344" class="difflineminus">-	/* U+a680 */</span>
<a href="#l6.2345"></a><span id="l6.2345" class="difflineminus">-	0xa681, 0xa681, 0xa683, 0xa683, 0xa685, 0xa685, 0xa687, 0xa687, </span>
<a href="#l6.2346"></a><span id="l6.2346" class="difflineminus">-	0xa689, 0xa689, 0xa68b, 0xa68b, 0xa68d, 0xa68d, 0xa68f, 0xa68f, </span>
<a href="#l6.2347"></a><span id="l6.2347" class="difflineminus">-	0xa691, 0xa691, 0xa693, 0xa693, 0xa695, 0xa695, 0xa697, 0xa697, </span>
<a href="#l6.2348"></a><span id="l6.2348" class="difflineminus">-	0xa698, 0xa699, 0xa69a, 0xa69b, 0xa69c, 0xa69d, 0xa69e, 0xa69f, </span>
<a href="#l6.2349"></a><span id="l6.2349" class="difflineminus">-	0xa6a0, 0xa6a1, 0xa6a2, 0xa6a3, 0xa6a4, 0xa6a5, 0xa6a6, 0xa6a7, </span>
<a href="#l6.2350"></a><span id="l6.2350" class="difflineminus">-	0xa6a8, 0xa6a9, 0xa6aa, 0xa6ab, 0xa6ac, 0xa6ad, 0xa6ae, 0xa6af, </span>
<a href="#l6.2351"></a><span id="l6.2351" class="difflineminus">-	0xa6b0, 0xa6b1, 0xa6b2, 0xa6b3, 0xa6b4, 0xa6b5, 0xa6b6, 0xa6b7, </span>
<a href="#l6.2352"></a><span id="l6.2352" class="difflineminus">-	0xa6b8, 0xa6b9, 0xa6ba, 0xa6bb, 0xa6bc, 0xa6bd, 0xa6be, 0xa6bf, </span>
<a href="#l6.2353"></a><span id="l6.2353" class="difflineminus">-	};</span>
<a href="#l6.2354"></a><span id="l6.2354" class="difflineplus">+    /* U+a680 */</span>
<a href="#l6.2355"></a><span id="l6.2355" class="difflineplus">+    0xa681, 0xa681, 0xa683, 0xa683, 0xa685, 0xa685, 0xa687, 0xa687,</span>
<a href="#l6.2356"></a><span id="l6.2356" class="difflineplus">+    0xa689, 0xa689, 0xa68b, 0xa68b, 0xa68d, 0xa68d, 0xa68f, 0xa68f,</span>
<a href="#l6.2357"></a><span id="l6.2357" class="difflineplus">+    0xa691, 0xa691, 0xa693, 0xa693, 0xa695, 0xa695, 0xa697, 0xa697,</span>
<a href="#l6.2358"></a><span id="l6.2358" class="difflineplus">+    0xa698, 0xa699, 0xa69a, 0xa69b, 0xa69c, 0xa69d, 0xa69e, 0xa69f,</span>
<a href="#l6.2359"></a><span id="l6.2359" class="difflineplus">+    0xa6a0, 0xa6a1, 0xa6a2, 0xa6a3, 0xa6a4, 0xa6a5, 0xa6a6, 0xa6a7,</span>
<a href="#l6.2360"></a><span id="l6.2360" class="difflineplus">+    0xa6a8, 0xa6a9, 0xa6aa, 0xa6ab, 0xa6ac, 0xa6ad, 0xa6ae, 0xa6af,</span>
<a href="#l6.2361"></a><span id="l6.2361" class="difflineplus">+    0xa6b0, 0xa6b1, 0xa6b2, 0xa6b3, 0xa6b4, 0xa6b5, 0xa6b6, 0xa6b7,</span>
<a href="#l6.2362"></a><span id="l6.2362" class="difflineplus">+    0xa6b8, 0xa6b9, 0xa6ba, 0xa6bb, 0xa6bc, 0xa6bd, 0xa6be, 0xa6bf,</span>
<a href="#l6.2363"></a><span id="l6.2363" class="difflineplus">+};</span>
<a href="#l6.2364"></a><span id="l6.2364"> </span>
<a href="#l6.2365"></a><span id="l6.2365"> static const unsigned short gNormalizeTablea700[] = {</span>
<a href="#l6.2366"></a><span id="l6.2366" class="difflineminus">-	/* U+a700 */</span>
<a href="#l6.2367"></a><span id="l6.2367" class="difflineminus">-	0xa700, 0xa701, 0xa702, 0xa703, 0xa704, 0xa705, 0xa706, 0xa707, </span>
<a href="#l6.2368"></a><span id="l6.2368" class="difflineminus">-	0xa708, 0xa709, 0xa70a, 0xa70b, 0xa70c, 0xa70d, 0xa70e, 0xa70f, </span>
<a href="#l6.2369"></a><span id="l6.2369" class="difflineminus">-	0xa710, 0xa711, 0xa712, 0xa713, 0xa714, 0xa715, 0xa716, 0xa717, </span>
<a href="#l6.2370"></a><span id="l6.2370" class="difflineminus">-	0xa718, 0xa719, 0xa71a, 0xa71b, 0xa71c, 0xa71d, 0xa71e, 0xa71f, </span>
<a href="#l6.2371"></a><span id="l6.2371" class="difflineminus">-	0xa720, 0xa721, 0xa723, 0xa723, 0xa725, 0xa725, 0xa727, 0xa727, </span>
<a href="#l6.2372"></a><span id="l6.2372" class="difflineminus">-	0xa729, 0xa729, 0xa72b, 0xa72b, 0xa72d, 0xa72d, 0xa72f, 0xa72f, </span>
<a href="#l6.2373"></a><span id="l6.2373" class="difflineminus">-	0xa730, 0xa731, 0xa733, 0xa733, 0xa735, 0xa735, 0xa737, 0xa737, </span>
<a href="#l6.2374"></a><span id="l6.2374" class="difflineminus">-	0xa739, 0xa739, 0xa73b, 0xa73b, 0xa73d, 0xa73d, 0xa73f, 0xa73f, </span>
<a href="#l6.2375"></a><span id="l6.2375" class="difflineminus">-	};</span>
<a href="#l6.2376"></a><span id="l6.2376" class="difflineplus">+    /* U+a700 */</span>
<a href="#l6.2377"></a><span id="l6.2377" class="difflineplus">+    0xa700, 0xa701, 0xa702, 0xa703, 0xa704, 0xa705, 0xa706, 0xa707,</span>
<a href="#l6.2378"></a><span id="l6.2378" class="difflineplus">+    0xa708, 0xa709, 0xa70a, 0xa70b, 0xa70c, 0xa70d, 0xa70e, 0xa70f,</span>
<a href="#l6.2379"></a><span id="l6.2379" class="difflineplus">+    0xa710, 0xa711, 0xa712, 0xa713, 0xa714, 0xa715, 0xa716, 0xa717,</span>
<a href="#l6.2380"></a><span id="l6.2380" class="difflineplus">+    0xa718, 0xa719, 0xa71a, 0xa71b, 0xa71c, 0xa71d, 0xa71e, 0xa71f,</span>
<a href="#l6.2381"></a><span id="l6.2381" class="difflineplus">+    0xa720, 0xa721, 0xa723, 0xa723, 0xa725, 0xa725, 0xa727, 0xa727,</span>
<a href="#l6.2382"></a><span id="l6.2382" class="difflineplus">+    0xa729, 0xa729, 0xa72b, 0xa72b, 0xa72d, 0xa72d, 0xa72f, 0xa72f,</span>
<a href="#l6.2383"></a><span id="l6.2383" class="difflineplus">+    0xa730, 0xa731, 0xa733, 0xa733, 0xa735, 0xa735, 0xa737, 0xa737,</span>
<a href="#l6.2384"></a><span id="l6.2384" class="difflineplus">+    0xa739, 0xa739, 0xa73b, 0xa73b, 0xa73d, 0xa73d, 0xa73f, 0xa73f,</span>
<a href="#l6.2385"></a><span id="l6.2385" class="difflineplus">+};</span>
<a href="#l6.2386"></a><span id="l6.2386"> </span>
<a href="#l6.2387"></a><span id="l6.2387"> static const unsigned short gNormalizeTablea740[] = {</span>
<a href="#l6.2388"></a><span id="l6.2388" class="difflineminus">-	/* U+a740 */</span>
<a href="#l6.2389"></a><span id="l6.2389" class="difflineminus">-	0xa741, 0xa741, 0xa743, 0xa743, 0xa745, 0xa745, 0xa747, 0xa747, </span>
<a href="#l6.2390"></a><span id="l6.2390" class="difflineminus">-	0xa749, 0xa749, 0xa74b, 0xa74b, 0xa74d, 0xa74d, 0xa74f, 0xa74f, </span>
<a href="#l6.2391"></a><span id="l6.2391" class="difflineminus">-	0xa751, 0xa751, 0xa753, 0xa753, 0xa755, 0xa755, 0xa757, 0xa757, </span>
<a href="#l6.2392"></a><span id="l6.2392" class="difflineminus">-	0xa759, 0xa759, 0xa75b, 0xa75b, 0xa75d, 0xa75d, 0xa75f, 0xa75f, </span>
<a href="#l6.2393"></a><span id="l6.2393" class="difflineminus">-	0xa761, 0xa761, 0xa763, 0xa763, 0xa765, 0xa765, 0xa767, 0xa767, </span>
<a href="#l6.2394"></a><span id="l6.2394" class="difflineminus">-	0xa769, 0xa769, 0xa76b, 0xa76b, 0xa76d, 0xa76d, 0xa76f, 0xa76f, </span>
<a href="#l6.2395"></a><span id="l6.2395" class="difflineminus">-	0xa76f, 0xa771, 0xa772, 0xa773, 0xa774, 0xa775, 0xa776, 0xa777, </span>
<a href="#l6.2396"></a><span id="l6.2396" class="difflineminus">-	0xa778, 0xa77a, 0xa77a, 0xa77c, 0xa77c, 0x1d79, 0xa77f, 0xa77f, </span>
<a href="#l6.2397"></a><span id="l6.2397" class="difflineminus">-	};</span>
<a href="#l6.2398"></a><span id="l6.2398" class="difflineplus">+    /* U+a740 */</span>
<a href="#l6.2399"></a><span id="l6.2399" class="difflineplus">+    0xa741, 0xa741, 0xa743, 0xa743, 0xa745, 0xa745, 0xa747, 0xa747,</span>
<a href="#l6.2400"></a><span id="l6.2400" class="difflineplus">+    0xa749, 0xa749, 0xa74b, 0xa74b, 0xa74d, 0xa74d, 0xa74f, 0xa74f,</span>
<a href="#l6.2401"></a><span id="l6.2401" class="difflineplus">+    0xa751, 0xa751, 0xa753, 0xa753, 0xa755, 0xa755, 0xa757, 0xa757,</span>
<a href="#l6.2402"></a><span id="l6.2402" class="difflineplus">+    0xa759, 0xa759, 0xa75b, 0xa75b, 0xa75d, 0xa75d, 0xa75f, 0xa75f,</span>
<a href="#l6.2403"></a><span id="l6.2403" class="difflineplus">+    0xa761, 0xa761, 0xa763, 0xa763, 0xa765, 0xa765, 0xa767, 0xa767,</span>
<a href="#l6.2404"></a><span id="l6.2404" class="difflineplus">+    0xa769, 0xa769, 0xa76b, 0xa76b, 0xa76d, 0xa76d, 0xa76f, 0xa76f,</span>
<a href="#l6.2405"></a><span id="l6.2405" class="difflineplus">+    0xa76f, 0xa771, 0xa772, 0xa773, 0xa774, 0xa775, 0xa776, 0xa777,</span>
<a href="#l6.2406"></a><span id="l6.2406" class="difflineplus">+    0xa778, 0xa77a, 0xa77a, 0xa77c, 0xa77c, 0x1d79, 0xa77f, 0xa77f,</span>
<a href="#l6.2407"></a><span id="l6.2407" class="difflineplus">+};</span>
<a href="#l6.2408"></a><span id="l6.2408"> </span>
<a href="#l6.2409"></a><span id="l6.2409"> static const unsigned short gNormalizeTablea780[] = {</span>
<a href="#l6.2410"></a><span id="l6.2410" class="difflineminus">-	/* U+a780 */</span>
<a href="#l6.2411"></a><span id="l6.2411" class="difflineminus">-	0xa781, 0xa781, 0xa783, 0xa783, 0xa785, 0xa785, 0xa787, 0xa787, </span>
<a href="#l6.2412"></a><span id="l6.2412" class="difflineminus">-	0xa788, 0xa789, 0xa78a, 0xa78c, 0xa78c, 0xa78d, 0xa78e, 0xa78f, </span>
<a href="#l6.2413"></a><span id="l6.2413" class="difflineminus">-	0xa790, 0xa791, 0xa792, 0xa793, 0xa794, 0xa795, 0xa796, 0xa797, </span>
<a href="#l6.2414"></a><span id="l6.2414" class="difflineminus">-	0xa798, 0xa799, 0xa79a, 0xa79b, 0xa79c, 0xa79d, 0xa79e, 0xa79f, </span>
<a href="#l6.2415"></a><span id="l6.2415" class="difflineminus">-	0xa7a0, 0xa7a1, 0xa7a2, 0xa7a3, 0xa7a4, 0xa7a5, 0xa7a6, 0xa7a7, </span>
<a href="#l6.2416"></a><span id="l6.2416" class="difflineminus">-	0xa7a8, 0xa7a9, 0xa7aa, 0xa7ab, 0xa7ac, 0xa7ad, 0xa7ae, 0xa7af, </span>
<a href="#l6.2417"></a><span id="l6.2417" class="difflineminus">-	0xa7b0, 0xa7b1, 0xa7b2, 0xa7b3, 0xa7b4, 0xa7b5, 0xa7b6, 0xa7b7, </span>
<a href="#l6.2418"></a><span id="l6.2418" class="difflineminus">-	0xa7b8, 0xa7b9, 0xa7ba, 0xa7bb, 0xa7bc, 0xa7bd, 0xa7be, 0xa7bf, </span>
<a href="#l6.2419"></a><span id="l6.2419" class="difflineminus">-	};</span>
<a href="#l6.2420"></a><span id="l6.2420" class="difflineplus">+    /* U+a780 */</span>
<a href="#l6.2421"></a><span id="l6.2421" class="difflineplus">+    0xa781, 0xa781, 0xa783, 0xa783, 0xa785, 0xa785, 0xa787, 0xa787,</span>
<a href="#l6.2422"></a><span id="l6.2422" class="difflineplus">+    0xa788, 0xa789, 0xa78a, 0xa78c, 0xa78c, 0xa78d, 0xa78e, 0xa78f,</span>
<a href="#l6.2423"></a><span id="l6.2423" class="difflineplus">+    0xa790, 0xa791, 0xa792, 0xa793, 0xa794, 0xa795, 0xa796, 0xa797,</span>
<a href="#l6.2424"></a><span id="l6.2424" class="difflineplus">+    0xa798, 0xa799, 0xa79a, 0xa79b, 0xa79c, 0xa79d, 0xa79e, 0xa79f,</span>
<a href="#l6.2425"></a><span id="l6.2425" class="difflineplus">+    0xa7a0, 0xa7a1, 0xa7a2, 0xa7a3, 0xa7a4, 0xa7a5, 0xa7a6, 0xa7a7,</span>
<a href="#l6.2426"></a><span id="l6.2426" class="difflineplus">+    0xa7a8, 0xa7a9, 0xa7aa, 0xa7ab, 0xa7ac, 0xa7ad, 0xa7ae, 0xa7af,</span>
<a href="#l6.2427"></a><span id="l6.2427" class="difflineplus">+    0xa7b0, 0xa7b1, 0xa7b2, 0xa7b3, 0xa7b4, 0xa7b5, 0xa7b6, 0xa7b7,</span>
<a href="#l6.2428"></a><span id="l6.2428" class="difflineplus">+    0xa7b8, 0xa7b9, 0xa7ba, 0xa7bb, 0xa7bc, 0xa7bd, 0xa7be, 0xa7bf,</span>
<a href="#l6.2429"></a><span id="l6.2429" class="difflineplus">+};</span>
<a href="#l6.2430"></a><span id="l6.2430"> </span>
<a href="#l6.2431"></a><span id="l6.2431"> static const unsigned short gNormalizeTablef900[] = {</span>
<a href="#l6.2432"></a><span id="l6.2432" class="difflineminus">-	/* U+f900 */</span>
<a href="#l6.2433"></a><span id="l6.2433" class="difflineminus">-	0x8c48, 0x66f4, 0x8eca, 0x8cc8, 0x6ed1, 0x4e32, 0x53e5, 0x9f9c, </span>
<a href="#l6.2434"></a><span id="l6.2434" class="difflineminus">-	0x9f9c, 0x5951, 0x91d1, 0x5587, 0x5948, 0x61f6, 0x7669, 0x7f85, </span>
<a href="#l6.2435"></a><span id="l6.2435" class="difflineminus">-	0x863f, 0x87ba, 0x88f8, 0x908f, 0x6a02, 0x6d1b, 0x70d9, 0x73de, </span>
<a href="#l6.2436"></a><span id="l6.2436" class="difflineminus">-	0x843d, 0x916a, 0x99f1, 0x4e82, 0x5375, 0x6b04, 0x721b, 0x862d, </span>
<a href="#l6.2437"></a><span id="l6.2437" class="difflineminus">-	0x9e1e, 0x5d50, 0x6feb, 0x85cd, 0x8964, 0x62c9, 0x81d8, 0x881f, </span>
<a href="#l6.2438"></a><span id="l6.2438" class="difflineminus">-	0x5eca, 0x6717, 0x6d6a, 0x72fc, 0x90ce, 0x4f86, 0x51b7, 0x52de, </span>
<a href="#l6.2439"></a><span id="l6.2439" class="difflineminus">-	0x64c4, 0x6ad3, 0x7210, 0x76e7, 0x8001, 0x8606, 0x865c, 0x8def, </span>
<a href="#l6.2440"></a><span id="l6.2440" class="difflineminus">-	0x9732, 0x9b6f, 0x9dfa, 0x788c, 0x797f, 0x7da0, 0x83c9, 0x9304, </span>
<a href="#l6.2441"></a><span id="l6.2441" class="difflineminus">-	};</span>
<a href="#l6.2442"></a><span id="l6.2442" class="difflineplus">+    /* U+f900 */</span>
<a href="#l6.2443"></a><span id="l6.2443" class="difflineplus">+    0x8c48, 0x66f4, 0x8eca, 0x8cc8, 0x6ed1, 0x4e32, 0x53e5, 0x9f9c,</span>
<a href="#l6.2444"></a><span id="l6.2444" class="difflineplus">+    0x9f9c, 0x5951, 0x91d1, 0x5587, 0x5948, 0x61f6, 0x7669, 0x7f85,</span>
<a href="#l6.2445"></a><span id="l6.2445" class="difflineplus">+    0x863f, 0x87ba, 0x88f8, 0x908f, 0x6a02, 0x6d1b, 0x70d9, 0x73de,</span>
<a href="#l6.2446"></a><span id="l6.2446" class="difflineplus">+    0x843d, 0x916a, 0x99f1, 0x4e82, 0x5375, 0x6b04, 0x721b, 0x862d,</span>
<a href="#l6.2447"></a><span id="l6.2447" class="difflineplus">+    0x9e1e, 0x5d50, 0x6feb, 0x85cd, 0x8964, 0x62c9, 0x81d8, 0x881f,</span>
<a href="#l6.2448"></a><span id="l6.2448" class="difflineplus">+    0x5eca, 0x6717, 0x6d6a, 0x72fc, 0x90ce, 0x4f86, 0x51b7, 0x52de,</span>
<a href="#l6.2449"></a><span id="l6.2449" class="difflineplus">+    0x64c4, 0x6ad3, 0x7210, 0x76e7, 0x8001, 0x8606, 0x865c, 0x8def,</span>
<a href="#l6.2450"></a><span id="l6.2450" class="difflineplus">+    0x9732, 0x9b6f, 0x9dfa, 0x788c, 0x797f, 0x7da0, 0x83c9, 0x9304,</span>
<a href="#l6.2451"></a><span id="l6.2451" class="difflineplus">+};</span>
<a href="#l6.2452"></a><span id="l6.2452"> </span>
<a href="#l6.2453"></a><span id="l6.2453"> static const unsigned short gNormalizeTablef940[] = {</span>
<a href="#l6.2454"></a><span id="l6.2454" class="difflineminus">-	/* U+f940 */</span>
<a href="#l6.2455"></a><span id="l6.2455" class="difflineminus">-	0x9e7f, 0x8ad6, 0x58df, 0x5f04, 0x7c60, 0x807e, 0x7262, 0x78ca, </span>
<a href="#l6.2456"></a><span id="l6.2456" class="difflineminus">-	0x8cc2, 0x96f7, 0x58d8, 0x5c62, 0x6a13, 0x6dda, 0x6f0f, 0x7d2f, </span>
<a href="#l6.2457"></a><span id="l6.2457" class="difflineminus">-	0x7e37, 0x964b, 0x52d2, 0x808b, 0x51dc, 0x51cc, 0x7a1c, 0x7dbe, </span>
<a href="#l6.2458"></a><span id="l6.2458" class="difflineminus">-	0x83f1, 0x9675, 0x8b80, 0x62cf, 0x6a02, 0x8afe, 0x4e39, 0x5be7, </span>
<a href="#l6.2459"></a><span id="l6.2459" class="difflineminus">-	0x6012, 0x7387, 0x7570, 0x5317, 0x78fb, 0x4fbf, 0x5fa9, 0x4e0d, </span>
<a href="#l6.2460"></a><span id="l6.2460" class="difflineminus">-	0x6ccc, 0x6578, 0x7d22, 0x53c3, 0x585e, 0x7701, 0x8449, 0x8aaa, </span>
<a href="#l6.2461"></a><span id="l6.2461" class="difflineminus">-	0x6bba, 0x8fb0, 0x6c88, 0x62fe, 0x82e5, 0x63a0, 0x7565, 0x4eae, </span>
<a href="#l6.2462"></a><span id="l6.2462" class="difflineminus">-	0x5169, 0x51c9, 0x6881, 0x7ce7, 0x826f, 0x8ad2, 0x91cf, 0x52f5, </span>
<a href="#l6.2463"></a><span id="l6.2463" class="difflineminus">-	};</span>
<a href="#l6.2464"></a><span id="l6.2464" class="difflineplus">+    /* U+f940 */</span>
<a href="#l6.2465"></a><span id="l6.2465" class="difflineplus">+    0x9e7f, 0x8ad6, 0x58df, 0x5f04, 0x7c60, 0x807e, 0x7262, 0x78ca,</span>
<a href="#l6.2466"></a><span id="l6.2466" class="difflineplus">+    0x8cc2, 0x96f7, 0x58d8, 0x5c62, 0x6a13, 0x6dda, 0x6f0f, 0x7d2f,</span>
<a href="#l6.2467"></a><span id="l6.2467" class="difflineplus">+    0x7e37, 0x964b, 0x52d2, 0x808b, 0x51dc, 0x51cc, 0x7a1c, 0x7dbe,</span>
<a href="#l6.2468"></a><span id="l6.2468" class="difflineplus">+    0x83f1, 0x9675, 0x8b80, 0x62cf, 0x6a02, 0x8afe, 0x4e39, 0x5be7,</span>
<a href="#l6.2469"></a><span id="l6.2469" class="difflineplus">+    0x6012, 0x7387, 0x7570, 0x5317, 0x78fb, 0x4fbf, 0x5fa9, 0x4e0d,</span>
<a href="#l6.2470"></a><span id="l6.2470" class="difflineplus">+    0x6ccc, 0x6578, 0x7d22, 0x53c3, 0x585e, 0x7701, 0x8449, 0x8aaa,</span>
<a href="#l6.2471"></a><span id="l6.2471" class="difflineplus">+    0x6bba, 0x8fb0, 0x6c88, 0x62fe, 0x82e5, 0x63a0, 0x7565, 0x4eae,</span>
<a href="#l6.2472"></a><span id="l6.2472" class="difflineplus">+    0x5169, 0x51c9, 0x6881, 0x7ce7, 0x826f, 0x8ad2, 0x91cf, 0x52f5,</span>
<a href="#l6.2473"></a><span id="l6.2473" class="difflineplus">+};</span>
<a href="#l6.2474"></a><span id="l6.2474"> </span>
<a href="#l6.2475"></a><span id="l6.2475"> static const unsigned short gNormalizeTablef980[] = {</span>
<a href="#l6.2476"></a><span id="l6.2476" class="difflineminus">-	/* U+f980 */</span>
<a href="#l6.2477"></a><span id="l6.2477" class="difflineminus">-	0x5442, 0x5973, 0x5eec, 0x65c5, 0x6ffe, 0x792a, 0x95ad, 0x9a6a, </span>
<a href="#l6.2478"></a><span id="l6.2478" class="difflineminus">-	0x9e97, 0x9ece, 0x529b, 0x66c6, 0x6b77, 0x8f62, 0x5e74, 0x6190, </span>
<a href="#l6.2479"></a><span id="l6.2479" class="difflineminus">-	0x6200, 0x649a, 0x6f23, 0x7149, 0x7489, 0x79ca, 0x7df4, 0x806f, </span>
<a href="#l6.2480"></a><span id="l6.2480" class="difflineminus">-	0x8f26, 0x84ee, 0x9023, 0x934a, 0x5217, 0x52a3, 0x54bd, 0x70c8, </span>
<a href="#l6.2481"></a><span id="l6.2481" class="difflineminus">-	0x88c2, 0x8aaa, 0x5ec9, 0x5ff5, 0x637b, 0x6bae, 0x7c3e, 0x7375, </span>
<a href="#l6.2482"></a><span id="l6.2482" class="difflineminus">-	0x4ee4, 0x56f9, 0x5be7, 0x5dba, 0x601c, 0x73b2, 0x7469, 0x7f9a, </span>
<a href="#l6.2483"></a><span id="l6.2483" class="difflineminus">-	0x8046, 0x9234, 0x96f6, 0x9748, 0x9818, 0x4f8b, 0x79ae, 0x91b4, </span>
<a href="#l6.2484"></a><span id="l6.2484" class="difflineminus">-	0x96b8, 0x60e1, 0x4e86, 0x50da, 0x5bee, 0x5c3f, 0x6599, 0x6a02, </span>
<a href="#l6.2485"></a><span id="l6.2485" class="difflineminus">-	};</span>
<a href="#l6.2486"></a><span id="l6.2486" class="difflineplus">+    /* U+f980 */</span>
<a href="#l6.2487"></a><span id="l6.2487" class="difflineplus">+    0x5442, 0x5973, 0x5eec, 0x65c5, 0x6ffe, 0x792a, 0x95ad, 0x9a6a,</span>
<a href="#l6.2488"></a><span id="l6.2488" class="difflineplus">+    0x9e97, 0x9ece, 0x529b, 0x66c6, 0x6b77, 0x8f62, 0x5e74, 0x6190,</span>
<a href="#l6.2489"></a><span id="l6.2489" class="difflineplus">+    0x6200, 0x649a, 0x6f23, 0x7149, 0x7489, 0x79ca, 0x7df4, 0x806f,</span>
<a href="#l6.2490"></a><span id="l6.2490" class="difflineplus">+    0x8f26, 0x84ee, 0x9023, 0x934a, 0x5217, 0x52a3, 0x54bd, 0x70c8,</span>
<a href="#l6.2491"></a><span id="l6.2491" class="difflineplus">+    0x88c2, 0x8aaa, 0x5ec9, 0x5ff5, 0x637b, 0x6bae, 0x7c3e, 0x7375,</span>
<a href="#l6.2492"></a><span id="l6.2492" class="difflineplus">+    0x4ee4, 0x56f9, 0x5be7, 0x5dba, 0x601c, 0x73b2, 0x7469, 0x7f9a,</span>
<a href="#l6.2493"></a><span id="l6.2493" class="difflineplus">+    0x8046, 0x9234, 0x96f6, 0x9748, 0x9818, 0x4f8b, 0x79ae, 0x91b4,</span>
<a href="#l6.2494"></a><span id="l6.2494" class="difflineplus">+    0x96b8, 0x60e1, 0x4e86, 0x50da, 0x5bee, 0x5c3f, 0x6599, 0x6a02,</span>
<a href="#l6.2495"></a><span id="l6.2495" class="difflineplus">+};</span>
<a href="#l6.2496"></a><span id="l6.2496"> </span>
<a href="#l6.2497"></a><span id="l6.2497"> static const unsigned short gNormalizeTablef9c0[] = {</span>
<a href="#l6.2498"></a><span id="l6.2498" class="difflineminus">-	/* U+f9c0 */</span>
<a href="#l6.2499"></a><span id="l6.2499" class="difflineminus">-	0x71ce, 0x7642, 0x84fc, 0x907c, 0x9f8d, 0x6688, 0x962e, 0x5289, </span>
<a href="#l6.2500"></a><span id="l6.2500" class="difflineminus">-	0x677b, 0x67f3, 0x6d41, 0x6e9c, 0x7409, 0x7559, 0x786b, 0x7d10, </span>
<a href="#l6.2501"></a><span id="l6.2501" class="difflineminus">-	0x985e, 0x516d, 0x622e, 0x9678, 0x502b, 0x5d19, 0x6dea, 0x8f2a, </span>
<a href="#l6.2502"></a><span id="l6.2502" class="difflineminus">-	0x5f8b, 0x6144, 0x6817, 0x7387, 0x9686, 0x5229, 0x540f, 0x5c65, </span>
<a href="#l6.2503"></a><span id="l6.2503" class="difflineminus">-	0x6613, 0x674e, 0x68a8, 0x6ce5, 0x7406, 0x75e2, 0x7f79, 0x88cf, </span>
<a href="#l6.2504"></a><span id="l6.2504" class="difflineminus">-	0x88e1, 0x91cc, 0x96e2, 0x533f, 0x6eba, 0x541d, 0x71d0, 0x7498, </span>
<a href="#l6.2505"></a><span id="l6.2505" class="difflineminus">-	0x85fa, 0x96a3, 0x9c57, 0x9e9f, 0x6797, 0x6dcb, 0x81e8, 0x7acb, </span>
<a href="#l6.2506"></a><span id="l6.2506" class="difflineminus">-	0x7b20, 0x7c92, 0x72c0, 0x7099, 0x8b58, 0x4ec0, 0x8336, 0x523a, </span>
<a href="#l6.2507"></a><span id="l6.2507" class="difflineminus">-	};</span>
<a href="#l6.2508"></a><span id="l6.2508" class="difflineplus">+    /* U+f9c0 */</span>
<a href="#l6.2509"></a><span id="l6.2509" class="difflineplus">+    0x71ce, 0x7642, 0x84fc, 0x907c, 0x9f8d, 0x6688, 0x962e, 0x5289,</span>
<a href="#l6.2510"></a><span id="l6.2510" class="difflineplus">+    0x677b, 0x67f3, 0x6d41, 0x6e9c, 0x7409, 0x7559, 0x786b, 0x7d10,</span>
<a href="#l6.2511"></a><span id="l6.2511" class="difflineplus">+    0x985e, 0x516d, 0x622e, 0x9678, 0x502b, 0x5d19, 0x6dea, 0x8f2a,</span>
<a href="#l6.2512"></a><span id="l6.2512" class="difflineplus">+    0x5f8b, 0x6144, 0x6817, 0x7387, 0x9686, 0x5229, 0x540f, 0x5c65,</span>
<a href="#l6.2513"></a><span id="l6.2513" class="difflineplus">+    0x6613, 0x674e, 0x68a8, 0x6ce5, 0x7406, 0x75e2, 0x7f79, 0x88cf,</span>
<a href="#l6.2514"></a><span id="l6.2514" class="difflineplus">+    0x88e1, 0x91cc, 0x96e2, 0x533f, 0x6eba, 0x541d, 0x71d0, 0x7498,</span>
<a href="#l6.2515"></a><span id="l6.2515" class="difflineplus">+    0x85fa, 0x96a3, 0x9c57, 0x9e9f, 0x6797, 0x6dcb, 0x81e8, 0x7acb,</span>
<a href="#l6.2516"></a><span id="l6.2516" class="difflineplus">+    0x7b20, 0x7c92, 0x72c0, 0x7099, 0x8b58, 0x4ec0, 0x8336, 0x523a,</span>
<a href="#l6.2517"></a><span id="l6.2517" class="difflineplus">+};</span>
<a href="#l6.2518"></a><span id="l6.2518"> </span>
<a href="#l6.2519"></a><span id="l6.2519"> static const unsigned short gNormalizeTablefa00[] = {</span>
<a href="#l6.2520"></a><span id="l6.2520" class="difflineminus">-	/* U+fa00 */</span>
<a href="#l6.2521"></a><span id="l6.2521" class="difflineminus">-	0x5207, 0x5ea6, 0x62d3, 0x7cd6, 0x5b85, 0x6d1e, 0x66b4, 0x8f3b, </span>
<a href="#l6.2522"></a><span id="l6.2522" class="difflineminus">-	0x884c, 0x964d, 0x898b, 0x5ed3, 0x5140, 0x55c0, 0xfa0e, 0xfa0f, </span>
<a href="#l6.2523"></a><span id="l6.2523" class="difflineminus">-	0x585a, 0xfa11, 0x6674, 0xfa13, 0xfa14, 0x51de, 0x732a, 0x76ca, </span>
<a href="#l6.2524"></a><span id="l6.2524" class="difflineminus">-	0x793c, 0x795e, 0x7965, 0x798f, 0x9756, 0x7cbe, 0x7fbd, 0xfa1f, </span>
<a href="#l6.2525"></a><span id="l6.2525" class="difflineminus">-	0x8612, 0xfa21, 0x8af8, 0xfa23, 0xfa24, 0x9038, 0x90fd, 0xfa27, </span>
<a href="#l6.2526"></a><span id="l6.2526" class="difflineminus">-	0xfa28, 0xfa29, 0x98ef, 0x98fc, 0x9928, 0x9db4, 0xfa2e, 0xfa2f, </span>
<a href="#l6.2527"></a><span id="l6.2527" class="difflineminus">-	0x4fae, 0x50e7, 0x514d, 0x52c9, 0x52e4, 0x5351, 0x559d, 0x5606, </span>
<a href="#l6.2528"></a><span id="l6.2528" class="difflineminus">-	0x5668, 0x5840, 0x58a8, 0x5c64, 0x5c6e, 0x6094, 0x6168, 0x618e, </span>
<a href="#l6.2529"></a><span id="l6.2529" class="difflineminus">-	};</span>
<a href="#l6.2530"></a><span id="l6.2530" class="difflineplus">+    /* U+fa00 */</span>
<a href="#l6.2531"></a><span id="l6.2531" class="difflineplus">+    0x5207, 0x5ea6, 0x62d3, 0x7cd6, 0x5b85, 0x6d1e, 0x66b4, 0x8f3b,</span>
<a href="#l6.2532"></a><span id="l6.2532" class="difflineplus">+    0x884c, 0x964d, 0x898b, 0x5ed3, 0x5140, 0x55c0, 0xfa0e, 0xfa0f,</span>
<a href="#l6.2533"></a><span id="l6.2533" class="difflineplus">+    0x585a, 0xfa11, 0x6674, 0xfa13, 0xfa14, 0x51de, 0x732a, 0x76ca,</span>
<a href="#l6.2534"></a><span id="l6.2534" class="difflineplus">+    0x793c, 0x795e, 0x7965, 0x798f, 0x9756, 0x7cbe, 0x7fbd, 0xfa1f,</span>
<a href="#l6.2535"></a><span id="l6.2535" class="difflineplus">+    0x8612, 0xfa21, 0x8af8, 0xfa23, 0xfa24, 0x9038, 0x90fd, 0xfa27,</span>
<a href="#l6.2536"></a><span id="l6.2536" class="difflineplus">+    0xfa28, 0xfa29, 0x98ef, 0x98fc, 0x9928, 0x9db4, 0xfa2e, 0xfa2f,</span>
<a href="#l6.2537"></a><span id="l6.2537" class="difflineplus">+    0x4fae, 0x50e7, 0x514d, 0x52c9, 0x52e4, 0x5351, 0x559d, 0x5606,</span>
<a href="#l6.2538"></a><span id="l6.2538" class="difflineplus">+    0x5668, 0x5840, 0x58a8, 0x5c64, 0x5c6e, 0x6094, 0x6168, 0x618e,</span>
<a href="#l6.2539"></a><span id="l6.2539" class="difflineplus">+};</span>
<a href="#l6.2540"></a><span id="l6.2540"> </span>
<a href="#l6.2541"></a><span id="l6.2541"> static const unsigned short gNormalizeTablefa40[] = {</span>
<a href="#l6.2542"></a><span id="l6.2542" class="difflineminus">-	/* U+fa40 */</span>
<a href="#l6.2543"></a><span id="l6.2543" class="difflineminus">-	0x61f2, 0x654f, 0x65e2, 0x6691, 0x6885, 0x6d77, 0x6e1a, 0x6f22, </span>
<a href="#l6.2544"></a><span id="l6.2544" class="difflineminus">-	0x716e, 0x722b, 0x7422, 0x7891, 0x793e, 0x7949, 0x7948, 0x7950, </span>
<a href="#l6.2545"></a><span id="l6.2545" class="difflineminus">-	0x7956, 0x795d, 0x798d, 0x798e, 0x7a40, 0x7a81, 0x7bc0, 0x7df4, </span>
<a href="#l6.2546"></a><span id="l6.2546" class="difflineminus">-	0x7e09, 0x7e41, 0x7f72, 0x8005, 0x81ed, 0x8279, 0x8279, 0x8457, </span>
<a href="#l6.2547"></a><span id="l6.2547" class="difflineminus">-	0x8910, 0x8996, 0x8b01, 0x8b39, 0x8cd3, 0x8d08, 0x8fb6, 0x9038, </span>
<a href="#l6.2548"></a><span id="l6.2548" class="difflineminus">-	0x96e3, 0x97ff, 0x983b, 0x6075, 0xfa6c, 0x8218, 0xfa6e, 0xfa6f, </span>
<a href="#l6.2549"></a><span id="l6.2549" class="difflineminus">-	0x4e26, 0x51b5, 0x5168, 0x4f80, 0x5145, 0x5180, 0x52c7, 0x52fa, </span>
<a href="#l6.2550"></a><span id="l6.2550" class="difflineminus">-	0x559d, 0x5555, 0x5599, 0x55e2, 0x585a, 0x58b3, 0x5944, 0x5954, </span>
<a href="#l6.2551"></a><span id="l6.2551" class="difflineminus">-	};</span>
<a href="#l6.2552"></a><span id="l6.2552" class="difflineplus">+    /* U+fa40 */</span>
<a href="#l6.2553"></a><span id="l6.2553" class="difflineplus">+    0x61f2, 0x654f, 0x65e2, 0x6691, 0x6885, 0x6d77, 0x6e1a, 0x6f22,</span>
<a href="#l6.2554"></a><span id="l6.2554" class="difflineplus">+    0x716e, 0x722b, 0x7422, 0x7891, 0x793e, 0x7949, 0x7948, 0x7950,</span>
<a href="#l6.2555"></a><span id="l6.2555" class="difflineplus">+    0x7956, 0x795d, 0x798d, 0x798e, 0x7a40, 0x7a81, 0x7bc0, 0x7df4,</span>
<a href="#l6.2556"></a><span id="l6.2556" class="difflineplus">+    0x7e09, 0x7e41, 0x7f72, 0x8005, 0x81ed, 0x8279, 0x8279, 0x8457,</span>
<a href="#l6.2557"></a><span id="l6.2557" class="difflineplus">+    0x8910, 0x8996, 0x8b01, 0x8b39, 0x8cd3, 0x8d08, 0x8fb6, 0x9038,</span>
<a href="#l6.2558"></a><span id="l6.2558" class="difflineplus">+    0x96e3, 0x97ff, 0x983b, 0x6075, 0xfa6c, 0x8218, 0xfa6e, 0xfa6f,</span>
<a href="#l6.2559"></a><span id="l6.2559" class="difflineplus">+    0x4e26, 0x51b5, 0x5168, 0x4f80, 0x5145, 0x5180, 0x52c7, 0x52fa,</span>
<a href="#l6.2560"></a><span id="l6.2560" class="difflineplus">+    0x559d, 0x5555, 0x5599, 0x55e2, 0x585a, 0x58b3, 0x5944, 0x5954,</span>
<a href="#l6.2561"></a><span id="l6.2561" class="difflineplus">+};</span>
<a href="#l6.2562"></a><span id="l6.2562"> </span>
<a href="#l6.2563"></a><span id="l6.2563"> static const unsigned short gNormalizeTablefa80[] = {</span>
<a href="#l6.2564"></a><span id="l6.2564" class="difflineminus">-	/* U+fa80 */</span>
<a href="#l6.2565"></a><span id="l6.2565" class="difflineminus">-	0x5a62, 0x5b28, 0x5ed2, 0x5ed9, 0x5f69, 0x5fad, 0x60d8, 0x614e, </span>
<a href="#l6.2566"></a><span id="l6.2566" class="difflineminus">-	0x6108, 0x618e, 0x6160, 0x61f2, 0x6234, 0x63c4, 0x641c, 0x6452, </span>
<a href="#l6.2567"></a><span id="l6.2567" class="difflineminus">-	0x6556, 0x6674, 0x6717, 0x671b, 0x6756, 0x6b79, 0x6bba, 0x6d41, </span>
<a href="#l6.2568"></a><span id="l6.2568" class="difflineminus">-	0x6edb, 0x6ecb, 0x6f22, 0x701e, 0x716e, 0x77a7, 0x7235, 0x72af, </span>
<a href="#l6.2569"></a><span id="l6.2569" class="difflineminus">-	0x732a, 0x7471, 0x7506, 0x753b, 0x761d, 0x761f, 0x76ca, 0x76db, </span>
<a href="#l6.2570"></a><span id="l6.2570" class="difflineminus">-	0x76f4, 0x774a, 0x7740, 0x78cc, 0x7ab1, 0x7bc0, 0x7c7b, 0x7d5b, </span>
<a href="#l6.2571"></a><span id="l6.2571" class="difflineminus">-	0x7df4, 0x7f3e, 0x8005, 0x8352, 0x83ef, 0x8779, 0x8941, 0x8986, </span>
<a href="#l6.2572"></a><span id="l6.2572" class="difflineminus">-	0x8996, 0x8abf, 0x8af8, 0x8acb, 0x8b01, 0x8afe, 0x8aed, 0x8b39, </span>
<a href="#l6.2573"></a><span id="l6.2573" class="difflineminus">-	};</span>
<a href="#l6.2574"></a><span id="l6.2574" class="difflineplus">+    /* U+fa80 */</span>
<a href="#l6.2575"></a><span id="l6.2575" class="difflineplus">+    0x5a62, 0x5b28, 0x5ed2, 0x5ed9, 0x5f69, 0x5fad, 0x60d8, 0x614e,</span>
<a href="#l6.2576"></a><span id="l6.2576" class="difflineplus">+    0x6108, 0x618e, 0x6160, 0x61f2, 0x6234, 0x63c4, 0x641c, 0x6452,</span>
<a href="#l6.2577"></a><span id="l6.2577" class="difflineplus">+    0x6556, 0x6674, 0x6717, 0x671b, 0x6756, 0x6b79, 0x6bba, 0x6d41,</span>
<a href="#l6.2578"></a><span id="l6.2578" class="difflineplus">+    0x6edb, 0x6ecb, 0x6f22, 0x701e, 0x716e, 0x77a7, 0x7235, 0x72af,</span>
<a href="#l6.2579"></a><span id="l6.2579" class="difflineplus">+    0x732a, 0x7471, 0x7506, 0x753b, 0x761d, 0x761f, 0x76ca, 0x76db,</span>
<a href="#l6.2580"></a><span id="l6.2580" class="difflineplus">+    0x76f4, 0x774a, 0x7740, 0x78cc, 0x7ab1, 0x7bc0, 0x7c7b, 0x7d5b,</span>
<a href="#l6.2581"></a><span id="l6.2581" class="difflineplus">+    0x7df4, 0x7f3e, 0x8005, 0x8352, 0x83ef, 0x8779, 0x8941, 0x8986,</span>
<a href="#l6.2582"></a><span id="l6.2582" class="difflineplus">+    0x8996, 0x8abf, 0x8af8, 0x8acb, 0x8b01, 0x8afe, 0x8aed, 0x8b39,</span>
<a href="#l6.2583"></a><span id="l6.2583" class="difflineplus">+};</span>
<a href="#l6.2584"></a><span id="l6.2584"> </span>
<a href="#l6.2585"></a><span id="l6.2585"> static const unsigned short gNormalizeTablefac0[] = {</span>
<a href="#l6.2586"></a><span id="l6.2586" class="difflineminus">-	/* U+fac0 */</span>
<a href="#l6.2587"></a><span id="l6.2587" class="difflineminus">-	0x8b8a, 0x8d08, 0x8f38, 0x9072, 0x9199, 0x9276, 0x967c, 0x96e3, </span>
<a href="#l6.2588"></a><span id="l6.2588" class="difflineminus">-	0x9756, 0x97db, 0x97ff, 0x980b, 0x983b, 0x9b12, 0x9f9c, 0xfacf, </span>
<a href="#l6.2589"></a><span id="l6.2589" class="difflineminus">-	0xfad0, 0xfad1, 0x3b9d, 0x4018, 0x4039, 0xfad5, 0xfad6, 0xfad7, </span>
<a href="#l6.2590"></a><span id="l6.2590" class="difflineminus">-	0x9f43, 0x9f8e, 0xfada, 0xfadb, 0xfadc, 0xfadd, 0xfade, 0xfadf, </span>
<a href="#l6.2591"></a><span id="l6.2591" class="difflineminus">-	0xfae0, 0xfae1, 0xfae2, 0xfae3, 0xfae4, 0xfae5, 0xfae6, 0xfae7, </span>
<a href="#l6.2592"></a><span id="l6.2592" class="difflineminus">-	0xfae8, 0xfae9, 0xfaea, 0xfaeb, 0xfaec, 0xfaed, 0xfaee, 0xfaef, </span>
<a href="#l6.2593"></a><span id="l6.2593" class="difflineminus">-	0xfaf0, 0xfaf1, 0xfaf2, 0xfaf3, 0xfaf4, 0xfaf5, 0xfaf6, 0xfaf7, </span>
<a href="#l6.2594"></a><span id="l6.2594" class="difflineminus">-	0xfaf8, 0xfaf9, 0xfafa, 0xfafb, 0xfafc, 0xfafd, 0xfafe, 0xfaff, </span>
<a href="#l6.2595"></a><span id="l6.2595" class="difflineminus">-	};</span>
<a href="#l6.2596"></a><span id="l6.2596" class="difflineplus">+    /* U+fac0 */</span>
<a href="#l6.2597"></a><span id="l6.2597" class="difflineplus">+    0x8b8a, 0x8d08, 0x8f38, 0x9072, 0x9199, 0x9276, 0x967c, 0x96e3,</span>
<a href="#l6.2598"></a><span id="l6.2598" class="difflineplus">+    0x9756, 0x97db, 0x97ff, 0x980b, 0x983b, 0x9b12, 0x9f9c, 0xfacf,</span>
<a href="#l6.2599"></a><span id="l6.2599" class="difflineplus">+    0xfad0, 0xfad1, 0x3b9d, 0x4018, 0x4039, 0xfad5, 0xfad6, 0xfad7,</span>
<a href="#l6.2600"></a><span id="l6.2600" class="difflineplus">+    0x9f43, 0x9f8e, 0xfada, 0xfadb, 0xfadc, 0xfadd, 0xfade, 0xfadf,</span>
<a href="#l6.2601"></a><span id="l6.2601" class="difflineplus">+    0xfae0, 0xfae1, 0xfae2, 0xfae3, 0xfae4, 0xfae5, 0xfae6, 0xfae7,</span>
<a href="#l6.2602"></a><span id="l6.2602" class="difflineplus">+    0xfae8, 0xfae9, 0xfaea, 0xfaeb, 0xfaec, 0xfaed, 0xfaee, 0xfaef,</span>
<a href="#l6.2603"></a><span id="l6.2603" class="difflineplus">+    0xfaf0, 0xfaf1, 0xfaf2, 0xfaf3, 0xfaf4, 0xfaf5, 0xfaf6, 0xfaf7,</span>
<a href="#l6.2604"></a><span id="l6.2604" class="difflineplus">+    0xfaf8, 0xfaf9, 0xfafa, 0xfafb, 0xfafc, 0xfafd, 0xfafe, 0xfaff,</span>
<a href="#l6.2605"></a><span id="l6.2605" class="difflineplus">+};</span>
<a href="#l6.2606"></a><span id="l6.2606"> </span>
<a href="#l6.2607"></a><span id="l6.2607"> static const unsigned short gNormalizeTablefb00[] = {</span>
<a href="#l6.2608"></a><span id="l6.2608" class="difflineminus">-	/* U+fb00 */</span>
<a href="#l6.2609"></a><span id="l6.2609" class="difflineminus">-	0x0066, 0x0066, 0x0066, 0x0066, 0x0066, 0x0073, 0x0073, 0xfb07, </span>
<a href="#l6.2610"></a><span id="l6.2610" class="difflineminus">-	0xfb08, 0xfb09, 0xfb0a, 0xfb0b, 0xfb0c, 0xfb0d, 0xfb0e, 0xfb0f, </span>
<a href="#l6.2611"></a><span id="l6.2611" class="difflineminus">-	0xfb10, 0xfb11, 0xfb12, 0x0574, 0x0574, 0x0574, 0x057e, 0x0574, </span>
<a href="#l6.2612"></a><span id="l6.2612" class="difflineminus">-	0xfb18, 0xfb19, 0xfb1a, 0xfb1b, 0xfb1c, 0x05d9, 0xfb1e, 0x05f2, </span>
<a href="#l6.2613"></a><span id="l6.2613" class="difflineminus">-	0x05e2, 0x05d0, 0x05d3, 0x05d4, 0x05db, 0x05dc, 0x05dd, 0x05e8, </span>
<a href="#l6.2614"></a><span id="l6.2614" class="difflineminus">-	0x05ea, 0x002b, 0x05e9, 0x05e9, 0x05e9, 0x05e9, 0x05d0, 0x05d0, </span>
<a href="#l6.2615"></a><span id="l6.2615" class="difflineminus">-	0x05d0, 0x05d1, 0x05d2, 0x05d3, 0x05d4, 0x05d5, 0x05d6, 0xfb37, </span>
<a href="#l6.2616"></a><span id="l6.2616" class="difflineminus">-	0x05d8, 0x05d9, 0x05da, 0x05db, 0x05dc, 0xfb3d, 0x05de, 0xfb3f, </span>
<a href="#l6.2617"></a><span id="l6.2617" class="difflineminus">-	};</span>
<a href="#l6.2618"></a><span id="l6.2618" class="difflineplus">+    /* U+fb00 */</span>
<a href="#l6.2619"></a><span id="l6.2619" class="difflineplus">+    0x0066, 0x0066, 0x0066, 0x0066, 0x0066, 0x0073, 0x0073, 0xfb07,</span>
<a href="#l6.2620"></a><span id="l6.2620" class="difflineplus">+    0xfb08, 0xfb09, 0xfb0a, 0xfb0b, 0xfb0c, 0xfb0d, 0xfb0e, 0xfb0f,</span>
<a href="#l6.2621"></a><span id="l6.2621" class="difflineplus">+    0xfb10, 0xfb11, 0xfb12, 0x0574, 0x0574, 0x0574, 0x057e, 0x0574,</span>
<a href="#l6.2622"></a><span id="l6.2622" class="difflineplus">+    0xfb18, 0xfb19, 0xfb1a, 0xfb1b, 0xfb1c, 0x05d9, 0xfb1e, 0x05f2,</span>
<a href="#l6.2623"></a><span id="l6.2623" class="difflineplus">+    0x05e2, 0x05d0, 0x05d3, 0x05d4, 0x05db, 0x05dc, 0x05dd, 0x05e8,</span>
<a href="#l6.2624"></a><span id="l6.2624" class="difflineplus">+    0x05ea, 0x002b, 0x05e9, 0x05e9, 0x05e9, 0x05e9, 0x05d0, 0x05d0,</span>
<a href="#l6.2625"></a><span id="l6.2625" class="difflineplus">+    0x05d0, 0x05d1, 0x05d2, 0x05d3, 0x05d4, 0x05d5, 0x05d6, 0xfb37,</span>
<a href="#l6.2626"></a><span id="l6.2626" class="difflineplus">+    0x05d8, 0x05d9, 0x05da, 0x05db, 0x05dc, 0xfb3d, 0x05de, 0xfb3f,</span>
<a href="#l6.2627"></a><span id="l6.2627" class="difflineplus">+};</span>
<a href="#l6.2628"></a><span id="l6.2628"> </span>
<a href="#l6.2629"></a><span id="l6.2629"> static const unsigned short gNormalizeTablefb40[] = {</span>
<a href="#l6.2630"></a><span id="l6.2630" class="difflineminus">-	/* U+fb40 */</span>
<a href="#l6.2631"></a><span id="l6.2631" class="difflineminus">-	0x05e0, 0x05e1, 0xfb42, 0x05e3, 0x05e4, 0xfb45, 0x05e6, 0x05e7, </span>
<a href="#l6.2632"></a><span id="l6.2632" class="difflineminus">-	0x05e8, 0x05e9, 0x05ea, 0x05d5, 0x05d1, 0x05db, 0x05e4, 0x05d0, </span>
<a href="#l6.2633"></a><span id="l6.2633" class="difflineminus">-	0x0671, 0x0671, 0x067b, 0x067b, 0x067b, 0x067b, 0x067e, 0x067e, </span>
<a href="#l6.2634"></a><span id="l6.2634" class="difflineminus">-	0x067e, 0x067e, 0x0680, 0x0680, 0x0680, 0x0680, 0x067a, 0x067a, </span>
<a href="#l6.2635"></a><span id="l6.2635" class="difflineminus">-	0x067a, 0x067a, 0x067f, 0x067f, 0x067f, 0x067f, 0x0679, 0x0679, </span>
<a href="#l6.2636"></a><span id="l6.2636" class="difflineminus">-	0x0679, 0x0679, 0x06a4, 0x06a4, 0x06a4, 0x06a4, 0x06a6, 0x06a6, </span>
<a href="#l6.2637"></a><span id="l6.2637" class="difflineminus">-	0x06a6, 0x06a6, 0x0684, 0x0684, 0x0684, 0x0684, 0x0683, 0x0683, </span>
<a href="#l6.2638"></a><span id="l6.2638" class="difflineminus">-	0x0683, 0x0683, 0x0686, 0x0686, 0x0686, 0x0686, 0x0687, 0x0687, </span>
<a href="#l6.2639"></a><span id="l6.2639" class="difflineminus">-	};</span>
<a href="#l6.2640"></a><span id="l6.2640" class="difflineplus">+    /* U+fb40 */</span>
<a href="#l6.2641"></a><span id="l6.2641" class="difflineplus">+    0x05e0, 0x05e1, 0xfb42, 0x05e3, 0x05e4, 0xfb45, 0x05e6, 0x05e7,</span>
<a href="#l6.2642"></a><span id="l6.2642" class="difflineplus">+    0x05e8, 0x05e9, 0x05ea, 0x05d5, 0x05d1, 0x05db, 0x05e4, 0x05d0,</span>
<a href="#l6.2643"></a><span id="l6.2643" class="difflineplus">+    0x0671, 0x0671, 0x067b, 0x067b, 0x067b, 0x067b, 0x067e, 0x067e,</span>
<a href="#l6.2644"></a><span id="l6.2644" class="difflineplus">+    0x067e, 0x067e, 0x0680, 0x0680, 0x0680, 0x0680, 0x067a, 0x067a,</span>
<a href="#l6.2645"></a><span id="l6.2645" class="difflineplus">+    0x067a, 0x067a, 0x067f, 0x067f, 0x067f, 0x067f, 0x0679, 0x0679,</span>
<a href="#l6.2646"></a><span id="l6.2646" class="difflineplus">+    0x0679, 0x0679, 0x06a4, 0x06a4, 0x06a4, 0x06a4, 0x06a6, 0x06a6,</span>
<a href="#l6.2647"></a><span id="l6.2647" class="difflineplus">+    0x06a6, 0x06a6, 0x0684, 0x0684, 0x0684, 0x0684, 0x0683, 0x0683,</span>
<a href="#l6.2648"></a><span id="l6.2648" class="difflineplus">+    0x0683, 0x0683, 0x0686, 0x0686, 0x0686, 0x0686, 0x0687, 0x0687,</span>
<a href="#l6.2649"></a><span id="l6.2649" class="difflineplus">+};</span>
<a href="#l6.2650"></a><span id="l6.2650"> </span>
<a href="#l6.2651"></a><span id="l6.2651"> static const unsigned short gNormalizeTablefb80[] = {</span>
<a href="#l6.2652"></a><span id="l6.2652" class="difflineminus">-	/* U+fb80 */</span>
<a href="#l6.2653"></a><span id="l6.2653" class="difflineminus">-	0x0687, 0x0687, 0x068d, 0x068d, 0x068c, 0x068c, 0x068e, 0x068e, </span>
<a href="#l6.2654"></a><span id="l6.2654" class="difflineminus">-	0x0688, 0x0688, 0x0698, 0x0698, 0x0691, 0x0691, 0x06a9, 0x06a9, </span>
<a href="#l6.2655"></a><span id="l6.2655" class="difflineminus">-	0x06a9, 0x06a9, 0x06af, 0x06af, 0x06af, 0x06af, 0x06b3, 0x06b3, </span>
<a href="#l6.2656"></a><span id="l6.2656" class="difflineminus">-	0x06b3, 0x06b3, 0x06b1, 0x06b1, 0x06b1, 0x06b1, 0x06ba, 0x06ba, </span>
<a href="#l6.2657"></a><span id="l6.2657" class="difflineminus">-	0x06bb, 0x06bb, 0x06bb, 0x06bb, 0x06d5, 0x06d5, 0x06c1, 0x06c1, </span>
<a href="#l6.2658"></a><span id="l6.2658" class="difflineminus">-	0x06c1, 0x06c1, 0x06be, 0x06be, 0x06be, 0x06be, 0x06d2, 0x06d2, </span>
<a href="#l6.2659"></a><span id="l6.2659" class="difflineminus">-	0x06d2, 0x06d2, 0xfbb2, 0xfbb3, 0xfbb4, 0xfbb5, 0xfbb6, 0xfbb7, </span>
<a href="#l6.2660"></a><span id="l6.2660" class="difflineminus">-	0xfbb8, 0xfbb9, 0xfbba, 0xfbbb, 0xfbbc, 0xfbbd, 0xfbbe, 0xfbbf, </span>
<a href="#l6.2661"></a><span id="l6.2661" class="difflineminus">-	};</span>
<a href="#l6.2662"></a><span id="l6.2662" class="difflineplus">+    /* U+fb80 */</span>
<a href="#l6.2663"></a><span id="l6.2663" class="difflineplus">+    0x0687, 0x0687, 0x068d, 0x068d, 0x068c, 0x068c, 0x068e, 0x068e,</span>
<a href="#l6.2664"></a><span id="l6.2664" class="difflineplus">+    0x0688, 0x0688, 0x0698, 0x0698, 0x0691, 0x0691, 0x06a9, 0x06a9,</span>
<a href="#l6.2665"></a><span id="l6.2665" class="difflineplus">+    0x06a9, 0x06a9, 0x06af, 0x06af, 0x06af, 0x06af, 0x06b3, 0x06b3,</span>
<a href="#l6.2666"></a><span id="l6.2666" class="difflineplus">+    0x06b3, 0x06b3, 0x06b1, 0x06b1, 0x06b1, 0x06b1, 0x06ba, 0x06ba,</span>
<a href="#l6.2667"></a><span id="l6.2667" class="difflineplus">+    0x06bb, 0x06bb, 0x06bb, 0x06bb, 0x06d5, 0x06d5, 0x06c1, 0x06c1,</span>
<a href="#l6.2668"></a><span id="l6.2668" class="difflineplus">+    0x06c1, 0x06c1, 0x06be, 0x06be, 0x06be, 0x06be, 0x06d2, 0x06d2,</span>
<a href="#l6.2669"></a><span id="l6.2669" class="difflineplus">+    0x06d2, 0x06d2, 0xfbb2, 0xfbb3, 0xfbb4, 0xfbb5, 0xfbb6, 0xfbb7,</span>
<a href="#l6.2670"></a><span id="l6.2670" class="difflineplus">+    0xfbb8, 0xfbb9, 0xfbba, 0xfbbb, 0xfbbc, 0xfbbd, 0xfbbe, 0xfbbf,</span>
<a href="#l6.2671"></a><span id="l6.2671" class="difflineplus">+};</span>
<a href="#l6.2672"></a><span id="l6.2672"> </span>
<a href="#l6.2673"></a><span id="l6.2673"> static const unsigned short gNormalizeTablefbc0[] = {</span>
<a href="#l6.2674"></a><span id="l6.2674" class="difflineminus">-	/* U+fbc0 */</span>
<a href="#l6.2675"></a><span id="l6.2675" class="difflineminus">-	0xfbc0, 0xfbc1, 0xfbc2, 0xfbc3, 0xfbc4, 0xfbc5, 0xfbc6, 0xfbc7, </span>
<a href="#l6.2676"></a><span id="l6.2676" class="difflineminus">-	0xfbc8, 0xfbc9, 0xfbca, 0xfbcb, 0xfbcc, 0xfbcd, 0xfbce, 0xfbcf, </span>
<a href="#l6.2677"></a><span id="l6.2677" class="difflineminus">-	0xfbd0, 0xfbd1, 0xfbd2, 0x06ad, 0x06ad, 0x06ad, 0x06ad, 0x06c7, </span>
<a href="#l6.2678"></a><span id="l6.2678" class="difflineminus">-	0x06c7, 0x06c6, 0x06c6, 0x06c8, 0x06c8, 0x06c7, 0x06cb, 0x06cb, </span>
<a href="#l6.2679"></a><span id="l6.2679" class="difflineminus">-	0x06c5, 0x06c5, 0x06c9, 0x06c9, 0x06d0, 0x06d0, 0x06d0, 0x06d0, </span>
<a href="#l6.2680"></a><span id="l6.2680" class="difflineminus">-	0x0649, 0x0649, 0x064a, 0x064a, 0x064a, 0x064a, 0x064a, 0x064a, </span>
<a href="#l6.2681"></a><span id="l6.2681" class="difflineminus">-	0x064a, 0x064a, 0x064a, 0x064a, 0x064a, 0x064a, 0x064a, 0x064a, </span>
<a href="#l6.2682"></a><span id="l6.2682" class="difflineminus">-	0x064a, 0x064a, 0x064a, 0x064a, 0x06cc, 0x06cc, 0x06cc, 0x06cc, </span>
<a href="#l6.2683"></a><span id="l6.2683" class="difflineminus">-	};</span>
<a href="#l6.2684"></a><span id="l6.2684" class="difflineplus">+    /* U+fbc0 */</span>
<a href="#l6.2685"></a><span id="l6.2685" class="difflineplus">+    0xfbc0, 0xfbc1, 0xfbc2, 0xfbc3, 0xfbc4, 0xfbc5, 0xfbc6, 0xfbc7,</span>
<a href="#l6.2686"></a><span id="l6.2686" class="difflineplus">+    0xfbc8, 0xfbc9, 0xfbca, 0xfbcb, 0xfbcc, 0xfbcd, 0xfbce, 0xfbcf,</span>
<a href="#l6.2687"></a><span id="l6.2687" class="difflineplus">+    0xfbd0, 0xfbd1, 0xfbd2, 0x06ad, 0x06ad, 0x06ad, 0x06ad, 0x06c7,</span>
<a href="#l6.2688"></a><span id="l6.2688" class="difflineplus">+    0x06c7, 0x06c6, 0x06c6, 0x06c8, 0x06c8, 0x06c7, 0x06cb, 0x06cb,</span>
<a href="#l6.2689"></a><span id="l6.2689" class="difflineplus">+    0x06c5, 0x06c5, 0x06c9, 0x06c9, 0x06d0, 0x06d0, 0x06d0, 0x06d0,</span>
<a href="#l6.2690"></a><span id="l6.2690" class="difflineplus">+    0x0649, 0x0649, 0x064a, 0x064a, 0x064a, 0x064a, 0x064a, 0x064a,</span>
<a href="#l6.2691"></a><span id="l6.2691" class="difflineplus">+    0x064a, 0x064a, 0x064a, 0x064a, 0x064a, 0x064a, 0x064a, 0x064a,</span>
<a href="#l6.2692"></a><span id="l6.2692" class="difflineplus">+    0x064a, 0x064a, 0x064a, 0x064a, 0x06cc, 0x06cc, 0x06cc, 0x06cc,</span>
<a href="#l6.2693"></a><span id="l6.2693" class="difflineplus">+};</span>
<a href="#l6.2694"></a><span id="l6.2694"> </span>
<a href="#l6.2695"></a><span id="l6.2695"> static const unsigned short gNormalizeTablefc00[] = {</span>
<a href="#l6.2696"></a><span id="l6.2696" class="difflineminus">-	/* U+fc00 */</span>
<a href="#l6.2697"></a><span id="l6.2697" class="difflineminus">-	0x064a, 0x064a, 0x064a, 0x064a, 0x064a, 0x0628, 0x0628, 0x0628, </span>
<a href="#l6.2698"></a><span id="l6.2698" class="difflineminus">-	0x0628, 0x0628, 0x0628, 0x062a, 0x062a, 0x062a, 0x062a, 0x062a, </span>
<a href="#l6.2699"></a><span id="l6.2699" class="difflineminus">-	0x062a, 0x062b, 0x062b, 0x062b, 0x062b, 0x062c, 0x062c, 0x062d, </span>
<a href="#l6.2700"></a><span id="l6.2700" class="difflineminus">-	0x062d, 0x062e, 0x062e, 0x062e, 0x0633, 0x0633, 0x0633, 0x0633, </span>
<a href="#l6.2701"></a><span id="l6.2701" class="difflineminus">-	0x0635, 0x0635, 0x0636, 0x0636, 0x0636, 0x0636, 0x0637, 0x0637, </span>
<a href="#l6.2702"></a><span id="l6.2702" class="difflineminus">-	0x0638, 0x0639, 0x0639, 0x063a, 0x063a, 0x0641, 0x0641, 0x0641, </span>
<a href="#l6.2703"></a><span id="l6.2703" class="difflineminus">-	0x0641, 0x0641, 0x0641, 0x0642, 0x0642, 0x0642, 0x0642, 0x0643, </span>
<a href="#l6.2704"></a><span id="l6.2704" class="difflineminus">-	0x0643, 0x0643, 0x0643, 0x0643, 0x0643, 0x0643, 0x0643, 0x0644, </span>
<a href="#l6.2705"></a><span id="l6.2705" class="difflineminus">-	};</span>
<a href="#l6.2706"></a><span id="l6.2706" class="difflineplus">+    /* U+fc00 */</span>
<a href="#l6.2707"></a><span id="l6.2707" class="difflineplus">+    0x064a, 0x064a, 0x064a, 0x064a, 0x064a, 0x0628, 0x0628, 0x0628,</span>
<a href="#l6.2708"></a><span id="l6.2708" class="difflineplus">+    0x0628, 0x0628, 0x0628, 0x062a, 0x062a, 0x062a, 0x062a, 0x062a,</span>
<a href="#l6.2709"></a><span id="l6.2709" class="difflineplus">+    0x062a, 0x062b, 0x062b, 0x062b, 0x062b, 0x062c, 0x062c, 0x062d,</span>
<a href="#l6.2710"></a><span id="l6.2710" class="difflineplus">+    0x062d, 0x062e, 0x062e, 0x062e, 0x0633, 0x0633, 0x0633, 0x0633,</span>
<a href="#l6.2711"></a><span id="l6.2711" class="difflineplus">+    0x0635, 0x0635, 0x0636, 0x0636, 0x0636, 0x0636, 0x0637, 0x0637,</span>
<a href="#l6.2712"></a><span id="l6.2712" class="difflineplus">+    0x0638, 0x0639, 0x0639, 0x063a, 0x063a, 0x0641, 0x0641, 0x0641,</span>
<a href="#l6.2713"></a><span id="l6.2713" class="difflineplus">+    0x0641, 0x0641, 0x0641, 0x0642, 0x0642, 0x0642, 0x0642, 0x0643,</span>
<a href="#l6.2714"></a><span id="l6.2714" class="difflineplus">+    0x0643, 0x0643, 0x0643, 0x0643, 0x0643, 0x0643, 0x0643, 0x0644,</span>
<a href="#l6.2715"></a><span id="l6.2715" class="difflineplus">+};</span>
<a href="#l6.2716"></a><span id="l6.2716"> </span>
<a href="#l6.2717"></a><span id="l6.2717"> static const unsigned short gNormalizeTablefc40[] = {</span>
<a href="#l6.2718"></a><span id="l6.2718" class="difflineminus">-	/* U+fc40 */</span>
<a href="#l6.2719"></a><span id="l6.2719" class="difflineminus">-	0x0644, 0x0644, 0x0644, 0x0644, 0x0644, 0x0645, 0x0645, 0x0645, </span>
<a href="#l6.2720"></a><span id="l6.2720" class="difflineminus">-	0x0645, 0x0645, 0x0645, 0x0646, 0x0646, 0x0646, 0x0646, 0x0646, </span>
<a href="#l6.2721"></a><span id="l6.2721" class="difflineminus">-	0x0646, 0x0647, 0x0647, 0x0647, 0x0647, 0x064a, 0x064a, 0x064a, </span>
<a href="#l6.2722"></a><span id="l6.2722" class="difflineminus">-	0x064a, 0x064a, 0x064a, 0x0630, 0x0631, 0x0649, 0x0020, 0x0020, </span>
<a href="#l6.2723"></a><span id="l6.2723" class="difflineminus">-	0x0020, 0x0020, 0x0020, 0x0020, 0x064a, 0x064a, 0x064a, 0x064a, </span>
<a href="#l6.2724"></a><span id="l6.2724" class="difflineminus">-	0x064a, 0x064a, 0x0628, 0x0628, 0x0628, 0x0628, 0x0628, 0x0628, </span>
<a href="#l6.2725"></a><span id="l6.2725" class="difflineminus">-	0x062a, 0x062a, 0x062a, 0x062a, 0x062a, 0x062a, 0x062b, 0x062b, </span>
<a href="#l6.2726"></a><span id="l6.2726" class="difflineminus">-	0x062b, 0x062b, 0x062b, 0x062b, 0x0641, 0x0641, 0x0642, 0x0642, </span>
<a href="#l6.2727"></a><span id="l6.2727" class="difflineminus">-	};</span>
<a href="#l6.2728"></a><span id="l6.2728" class="difflineplus">+    /* U+fc40 */</span>
<a href="#l6.2729"></a><span id="l6.2729" class="difflineplus">+    0x0644, 0x0644, 0x0644, 0x0644, 0x0644, 0x0645, 0x0645, 0x0645,</span>
<a href="#l6.2730"></a><span id="l6.2730" class="difflineplus">+    0x0645, 0x0645, 0x0645, 0x0646, 0x0646, 0x0646, 0x0646, 0x0646,</span>
<a href="#l6.2731"></a><span id="l6.2731" class="difflineplus">+    0x0646, 0x0647, 0x0647, 0x0647, 0x0647, 0x064a, 0x064a, 0x064a,</span>
<a href="#l6.2732"></a><span id="l6.2732" class="difflineplus">+    0x064a, 0x064a, 0x064a, 0x0630, 0x0631, 0x0649, 0x0020, 0x0020,</span>
<a href="#l6.2733"></a><span id="l6.2733" class="difflineplus">+    0x0020, 0x0020, 0x0020, 0x0020, 0x064a, 0x064a, 0x064a, 0x064a,</span>
<a href="#l6.2734"></a><span id="l6.2734" class="difflineplus">+    0x064a, 0x064a, 0x0628, 0x0628, 0x0628, 0x0628, 0x0628, 0x0628,</span>
<a href="#l6.2735"></a><span id="l6.2735" class="difflineplus">+    0x062a, 0x062a, 0x062a, 0x062a, 0x062a, 0x062a, 0x062b, 0x062b,</span>
<a href="#l6.2736"></a><span id="l6.2736" class="difflineplus">+    0x062b, 0x062b, 0x062b, 0x062b, 0x0641, 0x0641, 0x0642, 0x0642,</span>
<a href="#l6.2737"></a><span id="l6.2737" class="difflineplus">+};</span>
<a href="#l6.2738"></a><span id="l6.2738"> </span>
<a href="#l6.2739"></a><span id="l6.2739"> static const unsigned short gNormalizeTablefc80[] = {</span>
<a href="#l6.2740"></a><span id="l6.2740" class="difflineminus">-	/* U+fc80 */</span>
<a href="#l6.2741"></a><span id="l6.2741" class="difflineminus">-	0x0643, 0x0643, 0x0643, 0x0643, 0x0643, 0x0644, 0x0644, 0x0644, </span>
<a href="#l6.2742"></a><span id="l6.2742" class="difflineminus">-	0x0645, 0x0645, 0x0646, 0x0646, 0x0646, 0x0646, 0x0646, 0x0646, </span>
<a href="#l6.2743"></a><span id="l6.2743" class="difflineminus">-	0x0649, 0x064a, 0x064a, 0x064a, 0x064a, 0x064a, 0x064a, 0x064a, </span>
<a href="#l6.2744"></a><span id="l6.2744" class="difflineminus">-	0x064a, 0x064a, 0x064a, 0x064a, 0x0628, 0x0628, 0x0628, 0x0628, </span>
<a href="#l6.2745"></a><span id="l6.2745" class="difflineminus">-	0x0628, 0x062a, 0x062a, 0x062a, 0x062a, 0x062a, 0x062b, 0x062c, </span>
<a href="#l6.2746"></a><span id="l6.2746" class="difflineminus">-	0x062c, 0x062d, 0x062d, 0x062e, 0x062e, 0x0633, 0x0633, 0x0633, </span>
<a href="#l6.2747"></a><span id="l6.2747" class="difflineminus">-	0x0633, 0x0635, 0x0635, 0x0635, 0x0636, 0x0636, 0x0636, 0x0636, </span>
<a href="#l6.2748"></a><span id="l6.2748" class="difflineminus">-	0x0637, 0x0638, 0x0639, 0x0639, 0x063a, 0x063a, 0x0641, 0x0641, </span>
<a href="#l6.2749"></a><span id="l6.2749" class="difflineminus">-	};</span>
<a href="#l6.2750"></a><span id="l6.2750" class="difflineplus">+    /* U+fc80 */</span>
<a href="#l6.2751"></a><span id="l6.2751" class="difflineplus">+    0x0643, 0x0643, 0x0643, 0x0643, 0x0643, 0x0644, 0x0644, 0x0644,</span>
<a href="#l6.2752"></a><span id="l6.2752" class="difflineplus">+    0x0645, 0x0645, 0x0646, 0x0646, 0x0646, 0x0646, 0x0646, 0x0646,</span>
<a href="#l6.2753"></a><span id="l6.2753" class="difflineplus">+    0x0649, 0x064a, 0x064a, 0x064a, 0x064a, 0x064a, 0x064a, 0x064a,</span>
<a href="#l6.2754"></a><span id="l6.2754" class="difflineplus">+    0x064a, 0x064a, 0x064a, 0x064a, 0x0628, 0x0628, 0x0628, 0x0628,</span>
<a href="#l6.2755"></a><span id="l6.2755" class="difflineplus">+    0x0628, 0x062a, 0x062a, 0x062a, 0x062a, 0x062a, 0x062b, 0x062c,</span>
<a href="#l6.2756"></a><span id="l6.2756" class="difflineplus">+    0x062c, 0x062d, 0x062d, 0x062e, 0x062e, 0x0633, 0x0633, 0x0633,</span>
<a href="#l6.2757"></a><span id="l6.2757" class="difflineplus">+    0x0633, 0x0635, 0x0635, 0x0635, 0x0636, 0x0636, 0x0636, 0x0636,</span>
<a href="#l6.2758"></a><span id="l6.2758" class="difflineplus">+    0x0637, 0x0638, 0x0639, 0x0639, 0x063a, 0x063a, 0x0641, 0x0641,</span>
<a href="#l6.2759"></a><span id="l6.2759" class="difflineplus">+};</span>
<a href="#l6.2760"></a><span id="l6.2760"> </span>
<a href="#l6.2761"></a><span id="l6.2761"> static const unsigned short gNormalizeTablefcc0[] = {</span>
<a href="#l6.2762"></a><span id="l6.2762" class="difflineminus">-	/* U+fcc0 */</span>
<a href="#l6.2763"></a><span id="l6.2763" class="difflineminus">-	0x0641, 0x0641, 0x0642, 0x0642, 0x0643, 0x0643, 0x0643, 0x0643, </span>
<a href="#l6.2764"></a><span id="l6.2764" class="difflineminus">-	0x0643, 0x0644, 0x0644, 0x0644, 0x0644, 0x0644, 0x0645, 0x0645, </span>
<a href="#l6.2765"></a><span id="l6.2765" class="difflineminus">-	0x0645, 0x0645, 0x0646, 0x0646, 0x0646, 0x0646, 0x0646, 0x0647, </span>
<a href="#l6.2766"></a><span id="l6.2766" class="difflineminus">-	0x0647, 0x0647, 0x064a, 0x064a, 0x064a, 0x064a, 0x064a, 0x064a, </span>
<a href="#l6.2767"></a><span id="l6.2767" class="difflineminus">-	0x064a, 0x0628, 0x0628, 0x062a, 0x062a, 0x062b, 0x062b, 0x0633, </span>
<a href="#l6.2768"></a><span id="l6.2768" class="difflineminus">-	0x0633, 0x0634, 0x0634, 0x0643, 0x0643, 0x0644, 0x0646, 0x0646, </span>
<a href="#l6.2769"></a><span id="l6.2769" class="difflineminus">-	0x064a, 0x064a, 0x0640, 0x0640, 0x0640, 0x0637, 0x0637, 0x0639, </span>
<a href="#l6.2770"></a><span id="l6.2770" class="difflineminus">-	0x0639, 0x063a, 0x063a, 0x0633, 0x0633, 0x0634, 0x0634, 0x062d, </span>
<a href="#l6.2771"></a><span id="l6.2771" class="difflineminus">-	};</span>
<a href="#l6.2772"></a><span id="l6.2772" class="difflineplus">+    /* U+fcc0 */</span>
<a href="#l6.2773"></a><span id="l6.2773" class="difflineplus">+    0x0641, 0x0641, 0x0642, 0x0642, 0x0643, 0x0643, 0x0643, 0x0643,</span>
<a href="#l6.2774"></a><span id="l6.2774" class="difflineplus">+    0x0643, 0x0644, 0x0644, 0x0644, 0x0644, 0x0644, 0x0645, 0x0645,</span>
<a href="#l6.2775"></a><span id="l6.2775" class="difflineplus">+    0x0645, 0x0645, 0x0646, 0x0646, 0x0646, 0x0646, 0x0646, 0x0647,</span>
<a href="#l6.2776"></a><span id="l6.2776" class="difflineplus">+    0x0647, 0x0647, 0x064a, 0x064a, 0x064a, 0x064a, 0x064a, 0x064a,</span>
<a href="#l6.2777"></a><span id="l6.2777" class="difflineplus">+    0x064a, 0x0628, 0x0628, 0x062a, 0x062a, 0x062b, 0x062b, 0x0633,</span>
<a href="#l6.2778"></a><span id="l6.2778" class="difflineplus">+    0x0633, 0x0634, 0x0634, 0x0643, 0x0643, 0x0644, 0x0646, 0x0646,</span>
<a href="#l6.2779"></a><span id="l6.2779" class="difflineplus">+    0x064a, 0x064a, 0x0640, 0x0640, 0x0640, 0x0637, 0x0637, 0x0639,</span>
<a href="#l6.2780"></a><span id="l6.2780" class="difflineplus">+    0x0639, 0x063a, 0x063a, 0x0633, 0x0633, 0x0634, 0x0634, 0x062d,</span>
<a href="#l6.2781"></a><span id="l6.2781" class="difflineplus">+};</span>
<a href="#l6.2782"></a><span id="l6.2782"> </span>
<a href="#l6.2783"></a><span id="l6.2783"> static const unsigned short gNormalizeTablefd00[] = {</span>
<a href="#l6.2784"></a><span id="l6.2784" class="difflineminus">-	/* U+fd00 */</span>
<a href="#l6.2785"></a><span id="l6.2785" class="difflineminus">-	0x062d, 0x062c, 0x062c, 0x062e, 0x062e, 0x0635, 0x0635, 0x0636, </span>
<a href="#l6.2786"></a><span id="l6.2786" class="difflineminus">-	0x0636, 0x0634, 0x0634, 0x0634, 0x0634, 0x0634, 0x0633, 0x0635, </span>
<a href="#l6.2787"></a><span id="l6.2787" class="difflineminus">-	0x0636, 0x0637, 0x0637, 0x0639, 0x0639, 0x063a, 0x063a, 0x0633, </span>
<a href="#l6.2788"></a><span id="l6.2788" class="difflineminus">-	0x0633, 0x0634, 0x0634, 0x062d, 0x062d, 0x062c, 0x062c, 0x062e, </span>
<a href="#l6.2789"></a><span id="l6.2789" class="difflineminus">-	0x062e, 0x0635, 0x0635, 0x0636, 0x0636, 0x0634, 0x0634, 0x0634, </span>
<a href="#l6.2790"></a><span id="l6.2790" class="difflineminus">-	0x0634, 0x0634, 0x0633, 0x0635, 0x0636, 0x0634, 0x0634, 0x0634, </span>
<a href="#l6.2791"></a><span id="l6.2791" class="difflineminus">-	0x0634, 0x0633, 0x0634, 0x0637, 0x0633, 0x0633, 0x0633, 0x0634, </span>
<a href="#l6.2792"></a><span id="l6.2792" class="difflineminus">-	0x0634, 0x0634, 0x0637, 0x0638, 0x0627, 0x0627, 0xfd3e, 0xfd3f, </span>
<a href="#l6.2793"></a><span id="l6.2793" class="difflineminus">-	};</span>
<a href="#l6.2794"></a><span id="l6.2794" class="difflineplus">+    /* U+fd00 */</span>
<a href="#l6.2795"></a><span id="l6.2795" class="difflineplus">+    0x062d, 0x062c, 0x062c, 0x062e, 0x062e, 0x0635, 0x0635, 0x0636,</span>
<a href="#l6.2796"></a><span id="l6.2796" class="difflineplus">+    0x0636, 0x0634, 0x0634, 0x0634, 0x0634, 0x0634, 0x0633, 0x0635,</span>
<a href="#l6.2797"></a><span id="l6.2797" class="difflineplus">+    0x0636, 0x0637, 0x0637, 0x0639, 0x0639, 0x063a, 0x063a, 0x0633,</span>
<a href="#l6.2798"></a><span id="l6.2798" class="difflineplus">+    0x0633, 0x0634, 0x0634, 0x062d, 0x062d, 0x062c, 0x062c, 0x062e,</span>
<a href="#l6.2799"></a><span id="l6.2799" class="difflineplus">+    0x062e, 0x0635, 0x0635, 0x0636, 0x0636, 0x0634, 0x0634, 0x0634,</span>
<a href="#l6.2800"></a><span id="l6.2800" class="difflineplus">+    0x0634, 0x0634, 0x0633, 0x0635, 0x0636, 0x0634, 0x0634, 0x0634,</span>
<a href="#l6.2801"></a><span id="l6.2801" class="difflineplus">+    0x0634, 0x0633, 0x0634, 0x0637, 0x0633, 0x0633, 0x0633, 0x0634,</span>
<a href="#l6.2802"></a><span id="l6.2802" class="difflineplus">+    0x0634, 0x0634, 0x0637, 0x0638, 0x0627, 0x0627, 0xfd3e, 0xfd3f,</span>
<a href="#l6.2803"></a><span id="l6.2803" class="difflineplus">+};</span>
<a href="#l6.2804"></a><span id="l6.2804"> </span>
<a href="#l6.2805"></a><span id="l6.2805"> static const unsigned short gNormalizeTablefd40[] = {</span>
<a href="#l6.2806"></a><span id="l6.2806" class="difflineminus">-	/* U+fd40 */</span>
<a href="#l6.2807"></a><span id="l6.2807" class="difflineminus">-	0xfd40, 0xfd41, 0xfd42, 0xfd43, 0xfd44, 0xfd45, 0xfd46, 0xfd47, </span>
<a href="#l6.2808"></a><span id="l6.2808" class="difflineminus">-	0xfd48, 0xfd49, 0xfd4a, 0xfd4b, 0xfd4c, 0xfd4d, 0xfd4e, 0xfd4f, </span>
<a href="#l6.2809"></a><span id="l6.2809" class="difflineminus">-	0x062a, 0x062a, 0x062a, 0x062a, 0x062a, 0x062a, 0x062a, 0x062a, </span>
<a href="#l6.2810"></a><span id="l6.2810" class="difflineminus">-	0x062c, 0x062c, 0x062d, 0x062d, 0x0633, 0x0633, 0x0633, 0x0633, </span>
<a href="#l6.2811"></a><span id="l6.2811" class="difflineminus">-	0x0633, 0x0633, 0x0633, 0x0633, 0x0635, 0x0635, 0x0635, 0x0634, </span>
<a href="#l6.2812"></a><span id="l6.2812" class="difflineminus">-	0x0634, 0x0634, 0x0634, 0x0634, 0x0634, 0x0634, 0x0636, 0x0636, </span>
<a href="#l6.2813"></a><span id="l6.2813" class="difflineminus">-	0x0636, 0x0637, 0x0637, 0x0637, 0x0637, 0x0639, 0x0639, 0x0639, </span>
<a href="#l6.2814"></a><span id="l6.2814" class="difflineminus">-	0x0639, 0x063a, 0x063a, 0x063a, 0x0641, 0x0641, 0x0642, 0x0642, </span>
<a href="#l6.2815"></a><span id="l6.2815" class="difflineminus">-	};</span>
<a href="#l6.2816"></a><span id="l6.2816" class="difflineplus">+    /* U+fd40 */</span>
<a href="#l6.2817"></a><span id="l6.2817" class="difflineplus">+    0xfd40, 0xfd41, 0xfd42, 0xfd43, 0xfd44, 0xfd45, 0xfd46, 0xfd47,</span>
<a href="#l6.2818"></a><span id="l6.2818" class="difflineplus">+    0xfd48, 0xfd49, 0xfd4a, 0xfd4b, 0xfd4c, 0xfd4d, 0xfd4e, 0xfd4f,</span>
<a href="#l6.2819"></a><span id="l6.2819" class="difflineplus">+    0x062a, 0x062a, 0x062a, 0x062a, 0x062a, 0x062a, 0x062a, 0x062a,</span>
<a href="#l6.2820"></a><span id="l6.2820" class="difflineplus">+    0x062c, 0x062c, 0x062d, 0x062d, 0x0633, 0x0633, 0x0633, 0x0633,</span>
<a href="#l6.2821"></a><span id="l6.2821" class="difflineplus">+    0x0633, 0x0633, 0x0633, 0x0633, 0x0635, 0x0635, 0x0635, 0x0634,</span>
<a href="#l6.2822"></a><span id="l6.2822" class="difflineplus">+    0x0634, 0x0634, 0x0634, 0x0634, 0x0634, 0x0634, 0x0636, 0x0636,</span>
<a href="#l6.2823"></a><span id="l6.2823" class="difflineplus">+    0x0636, 0x0637, 0x0637, 0x0637, 0x0637, 0x0639, 0x0639, 0x0639,</span>
<a href="#l6.2824"></a><span id="l6.2824" class="difflineplus">+    0x0639, 0x063a, 0x063a, 0x063a, 0x0641, 0x0641, 0x0642, 0x0642,</span>
<a href="#l6.2825"></a><span id="l6.2825" class="difflineplus">+};</span>
<a href="#l6.2826"></a><span id="l6.2826"> </span>
<a href="#l6.2827"></a><span id="l6.2827"> static const unsigned short gNormalizeTablefd80[] = {</span>
<a href="#l6.2828"></a><span id="l6.2828" class="difflineminus">-	/* U+fd80 */</span>
<a href="#l6.2829"></a><span id="l6.2829" class="difflineminus">-	0x0644, 0x0644, 0x0644, 0x0644, 0x0644, 0x0644, 0x0644, 0x0644, </span>
<a href="#l6.2830"></a><span id="l6.2830" class="difflineminus">-	0x0644, 0x0645, 0x0645, 0x0645, 0x0645, 0x0645, 0x0645, 0x0645, </span>
<a href="#l6.2831"></a><span id="l6.2831" class="difflineminus">-	0xfd90, 0xfd91, 0x0645, 0x0647, 0x0647, 0x0646, 0x0646, 0x0646, </span>
<a href="#l6.2832"></a><span id="l6.2832" class="difflineminus">-	0x0646, 0x0646, 0x0646, 0x0646, 0x064a, 0x064a, 0x0628, 0x062a, </span>
<a href="#l6.2833"></a><span id="l6.2833" class="difflineminus">-	0x062a, 0x062a, 0x062a, 0x062a, 0x062a, 0x062c, 0x062c, 0x062c, </span>
<a href="#l6.2834"></a><span id="l6.2834" class="difflineminus">-	0x0633, 0x0635, 0x0634, 0x0636, 0x0644, 0x0644, 0x064a, 0x064a, </span>
<a href="#l6.2835"></a><span id="l6.2835" class="difflineminus">-	0x064a, 0x0645, 0x0642, 0x0646, 0x0642, 0x0644, 0x0639, 0x0643, </span>
<a href="#l6.2836"></a><span id="l6.2836" class="difflineminus">-	0x0646, 0x0645, 0x0644, 0x0643, 0x0644, 0x0646, 0x062c, 0x062d, </span>
<a href="#l6.2837"></a><span id="l6.2837" class="difflineminus">-	};</span>
<a href="#l6.2838"></a><span id="l6.2838" class="difflineplus">+    /* U+fd80 */</span>
<a href="#l6.2839"></a><span id="l6.2839" class="difflineplus">+    0x0644, 0x0644, 0x0644, 0x0644, 0x0644, 0x0644, 0x0644, 0x0644,</span>
<a href="#l6.2840"></a><span id="l6.2840" class="difflineplus">+    0x0644, 0x0645, 0x0645, 0x0645, 0x0645, 0x0645, 0x0645, 0x0645,</span>
<a href="#l6.2841"></a><span id="l6.2841" class="difflineplus">+    0xfd90, 0xfd91, 0x0645, 0x0647, 0x0647, 0x0646, 0x0646, 0x0646,</span>
<a href="#l6.2842"></a><span id="l6.2842" class="difflineplus">+    0x0646, 0x0646, 0x0646, 0x0646, 0x064a, 0x064a, 0x0628, 0x062a,</span>
<a href="#l6.2843"></a><span id="l6.2843" class="difflineplus">+    0x062a, 0x062a, 0x062a, 0x062a, 0x062a, 0x062c, 0x062c, 0x062c,</span>
<a href="#l6.2844"></a><span id="l6.2844" class="difflineplus">+    0x0633, 0x0635, 0x0634, 0x0636, 0x0644, 0x0644, 0x064a, 0x064a,</span>
<a href="#l6.2845"></a><span id="l6.2845" class="difflineplus">+    0x064a, 0x0645, 0x0642, 0x0646, 0x0642, 0x0644, 0x0639, 0x0643,</span>
<a href="#l6.2846"></a><span id="l6.2846" class="difflineplus">+    0x0646, 0x0645, 0x0644, 0x0643, 0x0644, 0x0646, 0x062c, 0x062d,</span>
<a href="#l6.2847"></a><span id="l6.2847" class="difflineplus">+};</span>
<a href="#l6.2848"></a><span id="l6.2848"> </span>
<a href="#l6.2849"></a><span id="l6.2849"> static const unsigned short gNormalizeTablefdc0[] = {</span>
<a href="#l6.2850"></a><span id="l6.2850" class="difflineminus">-	/* U+fdc0 */</span>
<a href="#l6.2851"></a><span id="l6.2851" class="difflineminus">-	0x0645, 0x0641, 0x0628, 0x0643, 0x0639, 0x0635, 0x0633, 0x0646, </span>
<a href="#l6.2852"></a><span id="l6.2852" class="difflineminus">-	0xfdc8, 0xfdc9, 0xfdca, 0xfdcb, 0xfdcc, 0xfdcd, 0xfdce, 0xfdcf, </span>
<a href="#l6.2853"></a><span id="l6.2853" class="difflineminus">-	0xfdd0, 0xfdd1, 0xfdd2, 0xfdd3, 0xfdd4, 0xfdd5, 0xfdd6, 0xfdd7, </span>
<a href="#l6.2854"></a><span id="l6.2854" class="difflineminus">-	0xfdd8, 0xfdd9, 0xfdda, 0xfddb, 0xfddc, 0xfddd, 0xfdde, 0xfddf, </span>
<a href="#l6.2855"></a><span id="l6.2855" class="difflineminus">-	0xfde0, 0xfde1, 0xfde2, 0xfde3, 0xfde4, 0xfde5, 0xfde6, 0xfde7, </span>
<a href="#l6.2856"></a><span id="l6.2856" class="difflineminus">-	0xfde8, 0xfde9, 0xfdea, 0xfdeb, 0xfdec, 0xfded, 0xfdee, 0xfdef, </span>
<a href="#l6.2857"></a><span id="l6.2857" class="difflineminus">-	0x0635, 0x0642, 0x0627, 0x0627, 0x0645, 0x0635, 0x0631, 0x0639, </span>
<a href="#l6.2858"></a><span id="l6.2858" class="difflineminus">-	0x0648, 0x0635, 0x0635, 0x062c, 0x0631, 0xfdfd, 0xfdfe, 0xfdff, </span>
<a href="#l6.2859"></a><span id="l6.2859" class="difflineminus">-	};</span>
<a href="#l6.2860"></a><span id="l6.2860" class="difflineplus">+    /* U+fdc0 */</span>
<a href="#l6.2861"></a><span id="l6.2861" class="difflineplus">+    0x0645, 0x0641, 0x0628, 0x0643, 0x0639, 0x0635, 0x0633, 0x0646,</span>
<a href="#l6.2862"></a><span id="l6.2862" class="difflineplus">+    0xfdc8, 0xfdc9, 0xfdca, 0xfdcb, 0xfdcc, 0xfdcd, 0xfdce, 0xfdcf,</span>
<a href="#l6.2863"></a><span id="l6.2863" class="difflineplus">+    0xfdd0, 0xfdd1, 0xfdd2, 0xfdd3, 0xfdd4, 0xfdd5, 0xfdd6, 0xfdd7,</span>
<a href="#l6.2864"></a><span id="l6.2864" class="difflineplus">+    0xfdd8, 0xfdd9, 0xfdda, 0xfddb, 0xfddc, 0xfddd, 0xfdde, 0xfddf,</span>
<a href="#l6.2865"></a><span id="l6.2865" class="difflineplus">+    0xfde0, 0xfde1, 0xfde2, 0xfde3, 0xfde4, 0xfde5, 0xfde6, 0xfde7,</span>
<a href="#l6.2866"></a><span id="l6.2866" class="difflineplus">+    0xfde8, 0xfde9, 0xfdea, 0xfdeb, 0xfdec, 0xfded, 0xfdee, 0xfdef,</span>
<a href="#l6.2867"></a><span id="l6.2867" class="difflineplus">+    0x0635, 0x0642, 0x0627, 0x0627, 0x0645, 0x0635, 0x0631, 0x0639,</span>
<a href="#l6.2868"></a><span id="l6.2868" class="difflineplus">+    0x0648, 0x0635, 0x0635, 0x062c, 0x0631, 0xfdfd, 0xfdfe, 0xfdff,</span>
<a href="#l6.2869"></a><span id="l6.2869" class="difflineplus">+};</span>
<a href="#l6.2870"></a><span id="l6.2870"> </span>
<a href="#l6.2871"></a><span id="l6.2871"> static const unsigned short gNormalizeTablefe00[] = {</span>
<a href="#l6.2872"></a><span id="l6.2872" class="difflineminus">-	/* U+fe00 */</span>
<a href="#l6.2873"></a><span id="l6.2873" class="difflineminus">-	0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, </span>
<a href="#l6.2874"></a><span id="l6.2874" class="difflineminus">-	0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, </span>
<a href="#l6.2875"></a><span id="l6.2875" class="difflineminus">-	0x002c, 0x3001, 0x3002, 0x003a, 0x003b, 0x0021, 0x003f, 0x3016, </span>
<a href="#l6.2876"></a><span id="l6.2876" class="difflineminus">-	0x3017, 0x002e, 0xfe1a, 0xfe1b, 0xfe1c, 0xfe1d, 0xfe1e, 0xfe1f, </span>
<a href="#l6.2877"></a><span id="l6.2877" class="difflineminus">-	0xfe20, 0xfe21, 0xfe22, 0xfe23, 0xfe24, 0xfe25, 0xfe26, 0xfe27, </span>
<a href="#l6.2878"></a><span id="l6.2878" class="difflineminus">-	0xfe28, 0xfe29, 0xfe2a, 0xfe2b, 0xfe2c, 0xfe2d, 0xfe2e, 0xfe2f, </span>
<a href="#l6.2879"></a><span id="l6.2879" class="difflineminus">-	0x002e, 0x2014, 0x2013, 0x005f, 0x005f, 0x0028, 0x0029, 0x007b, </span>
<a href="#l6.2880"></a><span id="l6.2880" class="difflineminus">-	0x007d, 0x3014, 0x3015, 0x3010, 0x3011, 0x300a, 0x300b, 0x3008, </span>
<a href="#l6.2881"></a><span id="l6.2881" class="difflineminus">-	};</span>
<a href="#l6.2882"></a><span id="l6.2882" class="difflineplus">+    /* U+fe00 */</span>
<a href="#l6.2883"></a><span id="l6.2883" class="difflineplus">+    0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020,</span>
<a href="#l6.2884"></a><span id="l6.2884" class="difflineplus">+    0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020,</span>
<a href="#l6.2885"></a><span id="l6.2885" class="difflineplus">+    0x002c, 0x3001, 0x3002, 0x003a, 0x003b, 0x0021, 0x003f, 0x3016,</span>
<a href="#l6.2886"></a><span id="l6.2886" class="difflineplus">+    0x3017, 0x002e, 0xfe1a, 0xfe1b, 0xfe1c, 0xfe1d, 0xfe1e, 0xfe1f,</span>
<a href="#l6.2887"></a><span id="l6.2887" class="difflineplus">+    0xfe20, 0xfe21, 0xfe22, 0xfe23, 0xfe24, 0xfe25, 0xfe26, 0xfe27,</span>
<a href="#l6.2888"></a><span id="l6.2888" class="difflineplus">+    0xfe28, 0xfe29, 0xfe2a, 0xfe2b, 0xfe2c, 0xfe2d, 0xfe2e, 0xfe2f,</span>
<a href="#l6.2889"></a><span id="l6.2889" class="difflineplus">+    0x002e, 0x2014, 0x2013, 0x005f, 0x005f, 0x0028, 0x0029, 0x007b,</span>
<a href="#l6.2890"></a><span id="l6.2890" class="difflineplus">+    0x007d, 0x3014, 0x3015, 0x3010, 0x3011, 0x300a, 0x300b, 0x3008,</span>
<a href="#l6.2891"></a><span id="l6.2891" class="difflineplus">+};</span>
<a href="#l6.2892"></a><span id="l6.2892"> </span>
<a href="#l6.2893"></a><span id="l6.2893"> static const unsigned short gNormalizeTablefe40[] = {</span>
<a href="#l6.2894"></a><span id="l6.2894" class="difflineminus">-	/* U+fe40 */</span>
<a href="#l6.2895"></a><span id="l6.2895" class="difflineminus">-	0x3009, 0x300c, 0x300d, 0x300e, 0x300f, 0xfe45, 0xfe46, 0x005b, </span>
<a href="#l6.2896"></a><span id="l6.2896" class="difflineminus">-	0x005d, 0x0020, 0x0020, 0x0020, 0x0020, 0x005f, 0x005f, 0x005f, </span>
<a href="#l6.2897"></a><span id="l6.2897" class="difflineminus">-	0x002c, 0x3001, 0x002e, 0xfe53, 0x003b, 0x003a, 0x003f, 0x0021, </span>
<a href="#l6.2898"></a><span id="l6.2898" class="difflineminus">-	0x2014, 0x0028, 0x0029, 0x007b, 0x007d, 0x3014, 0x3015, 0x0023, </span>
<a href="#l6.2899"></a><span id="l6.2899" class="difflineminus">-	0x0026, 0x002a, 0x002b, 0x002d, 0x003c, 0x003e, 0x003d, 0xfe67, </span>
<a href="#l6.2900"></a><span id="l6.2900" class="difflineminus">-	0x005c, 0x0024, 0x0025, 0x0040, 0xfe6c, 0xfe6d, 0xfe6e, 0xfe6f, </span>
<a href="#l6.2901"></a><span id="l6.2901" class="difflineminus">-	0x0020, 0x0640, 0x0020, 0xfe73, 0x0020, 0xfe75, 0x0020, 0x0640, </span>
<a href="#l6.2902"></a><span id="l6.2902" class="difflineminus">-	0x0020, 0x0640, 0x0020, 0x0640, 0x0020, 0x0640, 0x0020, 0x0640, </span>
<a href="#l6.2903"></a><span id="l6.2903" class="difflineminus">-	};</span>
<a href="#l6.2904"></a><span id="l6.2904" class="difflineplus">+    /* U+fe40 */</span>
<a href="#l6.2905"></a><span id="l6.2905" class="difflineplus">+    0x3009, 0x300c, 0x300d, 0x300e, 0x300f, 0xfe45, 0xfe46, 0x005b,</span>
<a href="#l6.2906"></a><span id="l6.2906" class="difflineplus">+    0x005d, 0x0020, 0x0020, 0x0020, 0x0020, 0x005f, 0x005f, 0x005f,</span>
<a href="#l6.2907"></a><span id="l6.2907" class="difflineplus">+    0x002c, 0x3001, 0x002e, 0xfe53, 0x003b, 0x003a, 0x003f, 0x0021,</span>
<a href="#l6.2908"></a><span id="l6.2908" class="difflineplus">+    0x2014, 0x0028, 0x0029, 0x007b, 0x007d, 0x3014, 0x3015, 0x0023,</span>
<a href="#l6.2909"></a><span id="l6.2909" class="difflineplus">+    0x0026, 0x002a, 0x002b, 0x002d, 0x003c, 0x003e, 0x003d, 0xfe67,</span>
<a href="#l6.2910"></a><span id="l6.2910" class="difflineplus">+    0x005c, 0x0024, 0x0025, 0x0040, 0xfe6c, 0xfe6d, 0xfe6e, 0xfe6f,</span>
<a href="#l6.2911"></a><span id="l6.2911" class="difflineplus">+    0x0020, 0x0640, 0x0020, 0xfe73, 0x0020, 0xfe75, 0x0020, 0x0640,</span>
<a href="#l6.2912"></a><span id="l6.2912" class="difflineplus">+    0x0020, 0x0640, 0x0020, 0x0640, 0x0020, 0x0640, 0x0020, 0x0640,</span>
<a href="#l6.2913"></a><span id="l6.2913" class="difflineplus">+};</span>
<a href="#l6.2914"></a><span id="l6.2914"> </span>
<a href="#l6.2915"></a><span id="l6.2915"> static const unsigned short gNormalizeTablefe80[] = {</span>
<a href="#l6.2916"></a><span id="l6.2916" class="difflineminus">-	/* U+fe80 */</span>
<a href="#l6.2917"></a><span id="l6.2917" class="difflineminus">-	0x0621, 0x0627, 0x0627, 0x0627, 0x0627, 0x0648, 0x0648, 0x0627, </span>
<a href="#l6.2918"></a><span id="l6.2918" class="difflineminus">-	0x0627, 0x064a, 0x064a, 0x064a, 0x064a, 0x0627, 0x0627, 0x0628, </span>
<a href="#l6.2919"></a><span id="l6.2919" class="difflineminus">-	0x0628, 0x0628, 0x0628, 0x0629, 0x0629, 0x062a, 0x062a, 0x062a, </span>
<a href="#l6.2920"></a><span id="l6.2920" class="difflineminus">-	0x062a, 0x062b, 0x062b, 0x062b, 0x062b, 0x062c, 0x062c, 0x062c, </span>
<a href="#l6.2921"></a><span id="l6.2921" class="difflineminus">-	0x062c, 0x062d, 0x062d, 0x062d, 0x062d, 0x062e, 0x062e, 0x062e, </span>
<a href="#l6.2922"></a><span id="l6.2922" class="difflineminus">-	0x062e, 0x062f, 0x062f, 0x0630, 0x0630, 0x0631, 0x0631, 0x0632, </span>
<a href="#l6.2923"></a><span id="l6.2923" class="difflineminus">-	0x0632, 0x0633, 0x0633, 0x0633, 0x0633, 0x0634, 0x0634, 0x0634, </span>
<a href="#l6.2924"></a><span id="l6.2924" class="difflineminus">-	0x0634, 0x0635, 0x0635, 0x0635, 0x0635, 0x0636, 0x0636, 0x0636, </span>
<a href="#l6.2925"></a><span id="l6.2925" class="difflineminus">-	};</span>
<a href="#l6.2926"></a><span id="l6.2926" class="difflineplus">+    /* U+fe80 */</span>
<a href="#l6.2927"></a><span id="l6.2927" class="difflineplus">+    0x0621, 0x0627, 0x0627, 0x0627, 0x0627, 0x0648, 0x0648, 0x0627,</span>
<a href="#l6.2928"></a><span id="l6.2928" class="difflineplus">+    0x0627, 0x064a, 0x064a, 0x064a, 0x064a, 0x0627, 0x0627, 0x0628,</span>
<a href="#l6.2929"></a><span id="l6.2929" class="difflineplus">+    0x0628, 0x0628, 0x0628, 0x0629, 0x0629, 0x062a, 0x062a, 0x062a,</span>
<a href="#l6.2930"></a><span id="l6.2930" class="difflineplus">+    0x062a, 0x062b, 0x062b, 0x062b, 0x062b, 0x062c, 0x062c, 0x062c,</span>
<a href="#l6.2931"></a><span id="l6.2931" class="difflineplus">+    0x062c, 0x062d, 0x062d, 0x062d, 0x062d, 0x062e, 0x062e, 0x062e,</span>
<a href="#l6.2932"></a><span id="l6.2932" class="difflineplus">+    0x062e, 0x062f, 0x062f, 0x0630, 0x0630, 0x0631, 0x0631, 0x0632,</span>
<a href="#l6.2933"></a><span id="l6.2933" class="difflineplus">+    0x0632, 0x0633, 0x0633, 0x0633, 0x0633, 0x0634, 0x0634, 0x0634,</span>
<a href="#l6.2934"></a><span id="l6.2934" class="difflineplus">+    0x0634, 0x0635, 0x0635, 0x0635, 0x0635, 0x0636, 0x0636, 0x0636,</span>
<a href="#l6.2935"></a><span id="l6.2935" class="difflineplus">+};</span>
<a href="#l6.2936"></a><span id="l6.2936"> </span>
<a href="#l6.2937"></a><span id="l6.2937"> static const unsigned short gNormalizeTablefec0[] = {</span>
<a href="#l6.2938"></a><span id="l6.2938" class="difflineminus">-	/* U+fec0 */</span>
<a href="#l6.2939"></a><span id="l6.2939" class="difflineminus">-	0x0636, 0x0637, 0x0637, 0x0637, 0x0637, 0x0638, 0x0638, 0x0638, </span>
<a href="#l6.2940"></a><span id="l6.2940" class="difflineminus">-	0x0638, 0x0639, 0x0639, 0x0639, 0x0639, 0x063a, 0x063a, 0x063a, </span>
<a href="#l6.2941"></a><span id="l6.2941" class="difflineminus">-	0x063a, 0x0641, 0x0641, 0x0641, 0x0641, 0x0642, 0x0642, 0x0642, </span>
<a href="#l6.2942"></a><span id="l6.2942" class="difflineminus">-	0x0642, 0x0643, 0x0643, 0x0643, 0x0643, 0x0644, 0x0644, 0x0644, </span>
<a href="#l6.2943"></a><span id="l6.2943" class="difflineminus">-	0x0644, 0x0645, 0x0645, 0x0645, 0x0645, 0x0646, 0x0646, 0x0646, </span>
<a href="#l6.2944"></a><span id="l6.2944" class="difflineminus">-	0x0646, 0x0647, 0x0647, 0x0647, 0x0647, 0x0648, 0x0648, 0x0649, </span>
<a href="#l6.2945"></a><span id="l6.2945" class="difflineminus">-	0x0649, 0x064a, 0x064a, 0x064a, 0x064a, 0x0644, 0x0644, 0x0644, </span>
<a href="#l6.2946"></a><span id="l6.2946" class="difflineminus">-	0x0644, 0x0644, 0x0644, 0x0644, 0x0644, 0xfefd, 0xfefe, 0x0020, </span>
<a href="#l6.2947"></a><span id="l6.2947" class="difflineminus">-	};</span>
<a href="#l6.2948"></a><span id="l6.2948" class="difflineplus">+    /* U+fec0 */</span>
<a href="#l6.2949"></a><span id="l6.2949" class="difflineplus">+    0x0636, 0x0637, 0x0637, 0x0637, 0x0637, 0x0638, 0x0638, 0x0638,</span>
<a href="#l6.2950"></a><span id="l6.2950" class="difflineplus">+    0x0638, 0x0639, 0x0639, 0x0639, 0x0639, 0x063a, 0x063a, 0x063a,</span>
<a href="#l6.2951"></a><span id="l6.2951" class="difflineplus">+    0x063a, 0x0641, 0x0641, 0x0641, 0x0641, 0x0642, 0x0642, 0x0642,</span>
<a href="#l6.2952"></a><span id="l6.2952" class="difflineplus">+    0x0642, 0x0643, 0x0643, 0x0643, 0x0643, 0x0644, 0x0644, 0x0644,</span>
<a href="#l6.2953"></a><span id="l6.2953" class="difflineplus">+    0x0644, 0x0645, 0x0645, 0x0645, 0x0645, 0x0646, 0x0646, 0x0646,</span>
<a href="#l6.2954"></a><span id="l6.2954" class="difflineplus">+    0x0646, 0x0647, 0x0647, 0x0647, 0x0647, 0x0648, 0x0648, 0x0649,</span>
<a href="#l6.2955"></a><span id="l6.2955" class="difflineplus">+    0x0649, 0x064a, 0x064a, 0x064a, 0x064a, 0x0644, 0x0644, 0x0644,</span>
<a href="#l6.2956"></a><span id="l6.2956" class="difflineplus">+    0x0644, 0x0644, 0x0644, 0x0644, 0x0644, 0xfefd, 0xfefe, 0x0020,</span>
<a href="#l6.2957"></a><span id="l6.2957" class="difflineplus">+};</span>
<a href="#l6.2958"></a><span id="l6.2958"> </span>
<a href="#l6.2959"></a><span id="l6.2959"> static const unsigned short gNormalizeTableff00[] = {</span>
<a href="#l6.2960"></a><span id="l6.2960" class="difflineminus">-	/* U+ff00 */</span>
<a href="#l6.2961"></a><span id="l6.2961" class="difflineminus">-	0xff00, 0x0021, 0x0022, 0x0023, 0x0024, 0x0025, 0x0026, 0x0027, </span>
<a href="#l6.2962"></a><span id="l6.2962" class="difflineminus">-	0x0028, 0x0029, 0x002a, 0x002b, 0x002c, 0x002d, 0x002e, 0x002f, </span>
<a href="#l6.2963"></a><span id="l6.2963" class="difflineminus">-	0x0030, 0x0031, 0x0032, 0x0033, 0x0034, 0x0035, 0x0036, 0x0037, </span>
<a href="#l6.2964"></a><span id="l6.2964" class="difflineminus">-	0x0038, 0x0039, 0x003a, 0x003b, 0x003c, 0x003d, 0x003e, 0x003f, </span>
<a href="#l6.2965"></a><span id="l6.2965" class="difflineminus">-	0x0040, 0x0061, 0x0062, 0x0063, 0x0064, 0x0065, 0x0066, 0x0067, </span>
<a href="#l6.2966"></a><span id="l6.2966" class="difflineminus">-	0x0068, 0x0069, 0x006a, 0x006b, 0x006c, 0x006d, 0x006e, 0x006f, </span>
<a href="#l6.2967"></a><span id="l6.2967" class="difflineminus">-	0x0070, 0x0071, 0x0072, 0x0073, 0x0074, 0x0075, 0x0076, 0x0077, </span>
<a href="#l6.2968"></a><span id="l6.2968" class="difflineminus">-	0x0078, 0x0079, 0x007a, 0x005b, 0x005c, 0x005d, 0x005e, 0x005f, </span>
<a href="#l6.2969"></a><span id="l6.2969" class="difflineminus">-	};</span>
<a href="#l6.2970"></a><span id="l6.2970" class="difflineplus">+    /* U+ff00 */</span>
<a href="#l6.2971"></a><span id="l6.2971" class="difflineplus">+    0xff00, 0x0021, 0x0022, 0x0023, 0x0024, 0x0025, 0x0026, 0x0027,</span>
<a href="#l6.2972"></a><span id="l6.2972" class="difflineplus">+    0x0028, 0x0029, 0x002a, 0x002b, 0x002c, 0x002d, 0x002e, 0x002f,</span>
<a href="#l6.2973"></a><span id="l6.2973" class="difflineplus">+    0x0030, 0x0031, 0x0032, 0x0033, 0x0034, 0x0035, 0x0036, 0x0037,</span>
<a href="#l6.2974"></a><span id="l6.2974" class="difflineplus">+    0x0038, 0x0039, 0x003a, 0x003b, 0x003c, 0x003d, 0x003e, 0x003f,</span>
<a href="#l6.2975"></a><span id="l6.2975" class="difflineplus">+    0x0040, 0x0061, 0x0062, 0x0063, 0x0064, 0x0065, 0x0066, 0x0067,</span>
<a href="#l6.2976"></a><span id="l6.2976" class="difflineplus">+    0x0068, 0x0069, 0x006a, 0x006b, 0x006c, 0x006d, 0x006e, 0x006f,</span>
<a href="#l6.2977"></a><span id="l6.2977" class="difflineplus">+    0x0070, 0x0071, 0x0072, 0x0073, 0x0074, 0x0075, 0x0076, 0x0077,</span>
<a href="#l6.2978"></a><span id="l6.2978" class="difflineplus">+    0x0078, 0x0079, 0x007a, 0x005b, 0x005c, 0x005d, 0x005e, 0x005f,</span>
<a href="#l6.2979"></a><span id="l6.2979" class="difflineplus">+};</span>
<a href="#l6.2980"></a><span id="l6.2980"> </span>
<a href="#l6.2981"></a><span id="l6.2981"> static const unsigned short gNormalizeTableff40[] = {</span>
<a href="#l6.2982"></a><span id="l6.2982" class="difflineminus">-	/* U+ff40 */</span>
<a href="#l6.2983"></a><span id="l6.2983" class="difflineminus">-	0x0060, 0x0061, 0x0062, 0x0063, 0x0064, 0x0065, 0x0066, 0x0067, </span>
<a href="#l6.2984"></a><span id="l6.2984" class="difflineminus">-	0x0068, 0x0069, 0x006a, 0x006b, 0x006c, 0x006d, 0x006e, 0x006f, </span>
<a href="#l6.2985"></a><span id="l6.2985" class="difflineminus">-	0x0070, 0x0071, 0x0072, 0x0073, 0x0074, 0x0075, 0x0076, 0x0077, </span>
<a href="#l6.2986"></a><span id="l6.2986" class="difflineminus">-	0x0078, 0x0079, 0x007a, 0x007b, 0x007c, 0x007d, 0x007e, 0x2985, </span>
<a href="#l6.2987"></a><span id="l6.2987" class="difflineminus">-	0x2986, 0x3002, 0x300c, 0x300d, 0x3001, 0x30fb, 0x30f2, 0x30a1, </span>
<a href="#l6.2988"></a><span id="l6.2988" class="difflineminus">-	0x30a3, 0x30a5, 0x30a7, 0x30a9, 0x30e3, 0x30e5, 0x30e7, 0x30c3, </span>
<a href="#l6.2989"></a><span id="l6.2989" class="difflineminus">-	0x30fc, 0x30a2, 0x30a4, 0x30a6, 0x30a8, 0x30aa, 0x30ab, 0x30ad, </span>
<a href="#l6.2990"></a><span id="l6.2990" class="difflineminus">-	0x30af, 0x30b1, 0x30b3, 0x30b5, 0x30b7, 0x30b9, 0x30bb, 0x30bd, </span>
<a href="#l6.2991"></a><span id="l6.2991" class="difflineminus">-	};</span>
<a href="#l6.2992"></a><span id="l6.2992" class="difflineplus">+    /* U+ff40 */</span>
<a href="#l6.2993"></a><span id="l6.2993" class="difflineplus">+    0x0060, 0x0061, 0x0062, 0x0063, 0x0064, 0x0065, 0x0066, 0x0067,</span>
<a href="#l6.2994"></a><span id="l6.2994" class="difflineplus">+    0x0068, 0x0069, 0x006a, 0x006b, 0x006c, 0x006d, 0x006e, 0x006f,</span>
<a href="#l6.2995"></a><span id="l6.2995" class="difflineplus">+    0x0070, 0x0071, 0x0072, 0x0073, 0x0074, 0x0075, 0x0076, 0x0077,</span>
<a href="#l6.2996"></a><span id="l6.2996" class="difflineplus">+    0x0078, 0x0079, 0x007a, 0x007b, 0x007c, 0x007d, 0x007e, 0x2985,</span>
<a href="#l6.2997"></a><span id="l6.2997" class="difflineplus">+    0x2986, 0x3002, 0x300c, 0x300d, 0x3001, 0x30fb, 0x30f2, 0x30a1,</span>
<a href="#l6.2998"></a><span id="l6.2998" class="difflineplus">+    0x30a3, 0x30a5, 0x30a7, 0x30a9, 0x30e3, 0x30e5, 0x30e7, 0x30c3,</span>
<a href="#l6.2999"></a><span id="l6.2999" class="difflineplus">+    0x30fc, 0x30a2, 0x30a4, 0x30a6, 0x30a8, 0x30aa, 0x30ab, 0x30ad,</span>
<a href="#l6.3000"></a><span id="l6.3000" class="difflineplus">+    0x30af, 0x30b1, 0x30b3, 0x30b5, 0x30b7, 0x30b9, 0x30bb, 0x30bd,</span>
<a href="#l6.3001"></a><span id="l6.3001" class="difflineplus">+};</span>
<a href="#l6.3002"></a><span id="l6.3002"> </span>
<a href="#l6.3003"></a><span id="l6.3003"> static const unsigned short gNormalizeTableff80[] = {</span>
<a href="#l6.3004"></a><span id="l6.3004" class="difflineminus">-	/* U+ff80 */</span>
<a href="#l6.3005"></a><span id="l6.3005" class="difflineminus">-	0x30bf, 0x30c1, 0x30c4, 0x30c6, 0x30c8, 0x30ca, 0x30cb, 0x30cc, </span>
<a href="#l6.3006"></a><span id="l6.3006" class="difflineminus">-	0x30cd, 0x30ce, 0x30cf, 0x30d2, 0x30d5, 0x30d8, 0x30db, 0x30de, </span>
<a href="#l6.3007"></a><span id="l6.3007" class="difflineminus">-	0x30df, 0x30e0, 0x30e1, 0x30e2, 0x30e4, 0x30e6, 0x30e8, 0x30e9, </span>
<a href="#l6.3008"></a><span id="l6.3008" class="difflineminus">-	0x30ea, 0x30eb, 0x30ec, 0x30ed, 0x30ef, 0x30f3, 0x3099, 0x309a, </span>
<a href="#l6.3009"></a><span id="l6.3009" class="difflineminus">-	0x0020, 0x1100, 0x1101, 0x11aa, 0x1102, 0x11ac, 0x11ad, 0x1103, </span>
<a href="#l6.3010"></a><span id="l6.3010" class="difflineminus">-	0x1104, 0x1105, 0x11b0, 0x11b1, 0x11b2, 0x11b3, 0x11b4, 0x11b5, </span>
<a href="#l6.3011"></a><span id="l6.3011" class="difflineminus">-	0x111a, 0x1106, 0x1107, 0x1108, 0x1121, 0x1109, 0x110a, 0x110b, </span>
<a href="#l6.3012"></a><span id="l6.3012" class="difflineminus">-	0x110c, 0x110d, 0x110e, 0x110f, 0x1110, 0x1111, 0x1112, 0xffbf, </span>
<a href="#l6.3013"></a><span id="l6.3013" class="difflineminus">-	};</span>
<a href="#l6.3014"></a><span id="l6.3014" class="difflineplus">+    /* U+ff80 */</span>
<a href="#l6.3015"></a><span id="l6.3015" class="difflineplus">+    0x30bf, 0x30c1, 0x30c4, 0x30c6, 0x30c8, 0x30ca, 0x30cb, 0x30cc,</span>
<a href="#l6.3016"></a><span id="l6.3016" class="difflineplus">+    0x30cd, 0x30ce, 0x30cf, 0x30d2, 0x30d5, 0x30d8, 0x30db, 0x30de,</span>
<a href="#l6.3017"></a><span id="l6.3017" class="difflineplus">+    0x30df, 0x30e0, 0x30e1, 0x30e2, 0x30e4, 0x30e6, 0x30e8, 0x30e9,</span>
<a href="#l6.3018"></a><span id="l6.3018" class="difflineplus">+    0x30ea, 0x30eb, 0x30ec, 0x30ed, 0x30ef, 0x30f3, 0x3099, 0x309a,</span>
<a href="#l6.3019"></a><span id="l6.3019" class="difflineplus">+    0x0020, 0x1100, 0x1101, 0x11aa, 0x1102, 0x11ac, 0x11ad, 0x1103,</span>
<a href="#l6.3020"></a><span id="l6.3020" class="difflineplus">+    0x1104, 0x1105, 0x11b0, 0x11b1, 0x11b2, 0x11b3, 0x11b4, 0x11b5,</span>
<a href="#l6.3021"></a><span id="l6.3021" class="difflineplus">+    0x111a, 0x1106, 0x1107, 0x1108, 0x1121, 0x1109, 0x110a, 0x110b,</span>
<a href="#l6.3022"></a><span id="l6.3022" class="difflineplus">+    0x110c, 0x110d, 0x110e, 0x110f, 0x1110, 0x1111, 0x1112, 0xffbf,</span>
<a href="#l6.3023"></a><span id="l6.3023" class="difflineplus">+};</span>
<a href="#l6.3024"></a><span id="l6.3024"> </span>
<a href="#l6.3025"></a><span id="l6.3025"> static const unsigned short gNormalizeTableffc0[] = {</span>
<a href="#l6.3026"></a><span id="l6.3026" class="difflineminus">-	/* U+ffc0 */</span>
<a href="#l6.3027"></a><span id="l6.3027" class="difflineminus">-	0xffc0, 0xffc1, 0x1161, 0x1162, 0x1163, 0x1164, 0x1165, 0x1166, </span>
<a href="#l6.3028"></a><span id="l6.3028" class="difflineminus">-	0xffc8, 0xffc9, 0x1167, 0x1168, 0x1169, 0x116a, 0x116b, 0x116c, </span>
<a href="#l6.3029"></a><span id="l6.3029" class="difflineminus">-	0xffd0, 0xffd1, 0x116d, 0x116e, 0x116f, 0x1170, 0x1171, 0x1172, </span>
<a href="#l6.3030"></a><span id="l6.3030" class="difflineminus">-	0xffd8, 0xffd9, 0x1173, 0x1174, 0x1175, 0xffdd, 0xffde, 0xffdf, </span>
<a href="#l6.3031"></a><span id="l6.3031" class="difflineminus">-	0x00a2, 0x00a3, 0x00ac, 0x0020, 0x00a6, 0x00a5, 0x20a9, 0xffe7, </span>
<a href="#l6.3032"></a><span id="l6.3032" class="difflineminus">-	0x2502, 0x2190, 0x2191, 0x2192, 0x2193, 0x25a0, 0x25cb, 0xffef, </span>
<a href="#l6.3033"></a><span id="l6.3033" class="difflineminus">-	0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, </span>
<a href="#l6.3034"></a><span id="l6.3034" class="difflineminus">-	0x0020, 0xfff9, 0xfffa, 0xfffb, 0xfffc, 0xfffd, 0xfffe, 0xffff, </span>
<a href="#l6.3035"></a><span id="l6.3035" class="difflineminus">-	};</span>
<a href="#l6.3036"></a><span id="l6.3036" class="difflineminus">-</span>
<a href="#l6.3037"></a><span id="l6.3037" class="difflineminus">-static const unsigned short* gNormalizeTable[] = { </span>
<a href="#l6.3038"></a><span id="l6.3038" class="difflineminus">-	0, gNormalizeTable0040, gNormalizeTable0080, gNormalizeTable00c0, </span>
<a href="#l6.3039"></a><span id="l6.3039" class="difflineminus">-	gNormalizeTable0100, gNormalizeTable0140, gNormalizeTable0180, gNormalizeTable01c0, </span>
<a href="#l6.3040"></a><span id="l6.3040" class="difflineminus">-	gNormalizeTable0200, gNormalizeTable0240, gNormalizeTable0280, gNormalizeTable02c0, </span>
<a href="#l6.3041"></a><span id="l6.3041" class="difflineminus">-	0, gNormalizeTable0340, gNormalizeTable0380, gNormalizeTable03c0, </span>
<a href="#l6.3042"></a><span id="l6.3042" class="difflineminus">-	gNormalizeTable0400, gNormalizeTable0440, gNormalizeTable0480, gNormalizeTable04c0, </span>
<a href="#l6.3043"></a><span id="l6.3043" class="difflineminus">-	gNormalizeTable0500, gNormalizeTable0540, gNormalizeTable0580, 0, </span>
<a href="#l6.3044"></a><span id="l6.3044" class="difflineminus">-	gNormalizeTable0600, gNormalizeTable0640, 0, gNormalizeTable06c0, </span>
<a href="#l6.3045"></a><span id="l6.3045" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3046"></a><span id="l6.3046" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3047"></a><span id="l6.3047" class="difflineminus">-	gNormalizeTable0900, gNormalizeTable0940, 0, gNormalizeTable09c0, </span>
<a href="#l6.3048"></a><span id="l6.3048" class="difflineminus">-	gNormalizeTable0a00, gNormalizeTable0a40, 0, 0, </span>
<a href="#l6.3049"></a><span id="l6.3049" class="difflineminus">-	0, gNormalizeTable0b40, gNormalizeTable0b80, gNormalizeTable0bc0, </span>
<a href="#l6.3050"></a><span id="l6.3050" class="difflineminus">-	0, gNormalizeTable0c40, 0, gNormalizeTable0cc0, </span>
<a href="#l6.3051"></a><span id="l6.3051" class="difflineminus">-	0, gNormalizeTable0d40, 0, gNormalizeTable0dc0, </span>
<a href="#l6.3052"></a><span id="l6.3052" class="difflineminus">-	gNormalizeTable0e00, 0, gNormalizeTable0e80, gNormalizeTable0ec0, </span>
<a href="#l6.3053"></a><span id="l6.3053" class="difflineminus">-	gNormalizeTable0f00, gNormalizeTable0f40, gNormalizeTable0f80, 0, </span>
<a href="#l6.3054"></a><span id="l6.3054" class="difflineminus">-	gNormalizeTable1000, 0, gNormalizeTable1080, gNormalizeTable10c0, </span>
<a href="#l6.3055"></a><span id="l6.3055" class="difflineminus">-	0, gNormalizeTable1140, 0, 0, </span>
<a href="#l6.3056"></a><span id="l6.3056" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3057"></a><span id="l6.3057" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3058"></a><span id="l6.3058" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3059"></a><span id="l6.3059" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3060"></a><span id="l6.3060" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3061"></a><span id="l6.3061" class="difflineminus">-	0, 0, gNormalizeTable1780, 0, </span>
<a href="#l6.3062"></a><span id="l6.3062" class="difflineminus">-	gNormalizeTable1800, 0, 0, 0, </span>
<a href="#l6.3063"></a><span id="l6.3063" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3064"></a><span id="l6.3064" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3065"></a><span id="l6.3065" class="difflineminus">-	gNormalizeTable1b00, gNormalizeTable1b40, 0, 0, </span>
<a href="#l6.3066"></a><span id="l6.3066" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3067"></a><span id="l6.3067" class="difflineminus">-	gNormalizeTable1d00, gNormalizeTable1d40, gNormalizeTable1d80, 0, </span>
<a href="#l6.3068"></a><span id="l6.3068" class="difflineminus">-	gNormalizeTable1e00, gNormalizeTable1e40, gNormalizeTable1e80, gNormalizeTable1ec0, </span>
<a href="#l6.3069"></a><span id="l6.3069" class="difflineminus">-	gNormalizeTable1f00, gNormalizeTable1f40, gNormalizeTable1f80, gNormalizeTable1fc0, </span>
<a href="#l6.3070"></a><span id="l6.3070" class="difflineminus">-	gNormalizeTable2000, gNormalizeTable2040, gNormalizeTable2080, 0, </span>
<a href="#l6.3071"></a><span id="l6.3071" class="difflineminus">-	gNormalizeTable2100, gNormalizeTable2140, gNormalizeTable2180, gNormalizeTable21c0, </span>
<a href="#l6.3072"></a><span id="l6.3072" class="difflineminus">-	gNormalizeTable2200, gNormalizeTable2240, gNormalizeTable2280, gNormalizeTable22c0, </span>
<a href="#l6.3073"></a><span id="l6.3073" class="difflineminus">-	gNormalizeTable2300, 0, 0, 0, </span>
<a href="#l6.3074"></a><span id="l6.3074" class="difflineminus">-	0, gNormalizeTable2440, gNormalizeTable2480, gNormalizeTable24c0, </span>
<a href="#l6.3075"></a><span id="l6.3075" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3076"></a><span id="l6.3076" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3077"></a><span id="l6.3077" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3078"></a><span id="l6.3078" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3079"></a><span id="l6.3079" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3080"></a><span id="l6.3080" class="difflineminus">-	gNormalizeTable2a00, gNormalizeTable2a40, 0, gNormalizeTable2ac0, </span>
<a href="#l6.3081"></a><span id="l6.3081" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3082"></a><span id="l6.3082" class="difflineminus">-	gNormalizeTable2c00, gNormalizeTable2c40, gNormalizeTable2c80, gNormalizeTable2cc0, </span>
<a href="#l6.3083"></a><span id="l6.3083" class="difflineminus">-	0, gNormalizeTable2d40, 0, 0, </span>
<a href="#l6.3084"></a><span id="l6.3084" class="difflineminus">-	0, 0, gNormalizeTable2e80, gNormalizeTable2ec0, </span>
<a href="#l6.3085"></a><span id="l6.3085" class="difflineminus">-	gNormalizeTable2f00, gNormalizeTable2f40, gNormalizeTable2f80, gNormalizeTable2fc0, </span>
<a href="#l6.3086"></a><span id="l6.3086" class="difflineminus">-	gNormalizeTable3000, gNormalizeTable3040, gNormalizeTable3080, gNormalizeTable30c0, </span>
<a href="#l6.3087"></a><span id="l6.3087" class="difflineminus">-	gNormalizeTable3100, gNormalizeTable3140, gNormalizeTable3180, 0, </span>
<a href="#l6.3088"></a><span id="l6.3088" class="difflineminus">-	gNormalizeTable3200, gNormalizeTable3240, gNormalizeTable3280, gNormalizeTable32c0, </span>
<a href="#l6.3089"></a><span id="l6.3089" class="difflineminus">-	gNormalizeTable3300, gNormalizeTable3340, gNormalizeTable3380, gNormalizeTable33c0, </span>
<a href="#l6.3090"></a><span id="l6.3090" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3091"></a><span id="l6.3091" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3092"></a><span id="l6.3092" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3093"></a><span id="l6.3093" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3094"></a><span id="l6.3094" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3095"></a><span id="l6.3095" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3096"></a><span id="l6.3096" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3097"></a><span id="l6.3097" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3098"></a><span id="l6.3098" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3099"></a><span id="l6.3099" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3100"></a><span id="l6.3100" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3101"></a><span id="l6.3101" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3102"></a><span id="l6.3102" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3103"></a><span id="l6.3103" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3104"></a><span id="l6.3104" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3105"></a><span id="l6.3105" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3106"></a><span id="l6.3106" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3107"></a><span id="l6.3107" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3108"></a><span id="l6.3108" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3109"></a><span id="l6.3109" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3110"></a><span id="l6.3110" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3111"></a><span id="l6.3111" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3112"></a><span id="l6.3112" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3113"></a><span id="l6.3113" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3114"></a><span id="l6.3114" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3115"></a><span id="l6.3115" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3116"></a><span id="l6.3116" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3117"></a><span id="l6.3117" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3118"></a><span id="l6.3118" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3119"></a><span id="l6.3119" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3120"></a><span id="l6.3120" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3121"></a><span id="l6.3121" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3122"></a><span id="l6.3122" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3123"></a><span id="l6.3123" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3124"></a><span id="l6.3124" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3125"></a><span id="l6.3125" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3126"></a><span id="l6.3126" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3127"></a><span id="l6.3127" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3128"></a><span id="l6.3128" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3129"></a><span id="l6.3129" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3130"></a><span id="l6.3130" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3131"></a><span id="l6.3131" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3132"></a><span id="l6.3132" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3133"></a><span id="l6.3133" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3134"></a><span id="l6.3134" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3135"></a><span id="l6.3135" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3136"></a><span id="l6.3136" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3137"></a><span id="l6.3137" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3138"></a><span id="l6.3138" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3139"></a><span id="l6.3139" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3140"></a><span id="l6.3140" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3141"></a><span id="l6.3141" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3142"></a><span id="l6.3142" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3143"></a><span id="l6.3143" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3144"></a><span id="l6.3144" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3145"></a><span id="l6.3145" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3146"></a><span id="l6.3146" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3147"></a><span id="l6.3147" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3148"></a><span id="l6.3148" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3149"></a><span id="l6.3149" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3150"></a><span id="l6.3150" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3151"></a><span id="l6.3151" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3152"></a><span id="l6.3152" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3153"></a><span id="l6.3153" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3154"></a><span id="l6.3154" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3155"></a><span id="l6.3155" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3156"></a><span id="l6.3156" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3157"></a><span id="l6.3157" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3158"></a><span id="l6.3158" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3159"></a><span id="l6.3159" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3160"></a><span id="l6.3160" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3161"></a><span id="l6.3161" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3162"></a><span id="l6.3162" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3163"></a><span id="l6.3163" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3164"></a><span id="l6.3164" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3165"></a><span id="l6.3165" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3166"></a><span id="l6.3166" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3167"></a><span id="l6.3167" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3168"></a><span id="l6.3168" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3169"></a><span id="l6.3169" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3170"></a><span id="l6.3170" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3171"></a><span id="l6.3171" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3172"></a><span id="l6.3172" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3173"></a><span id="l6.3173" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3174"></a><span id="l6.3174" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3175"></a><span id="l6.3175" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3176"></a><span id="l6.3176" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3177"></a><span id="l6.3177" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3178"></a><span id="l6.3178" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3179"></a><span id="l6.3179" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3180"></a><span id="l6.3180" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3181"></a><span id="l6.3181" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3182"></a><span id="l6.3182" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3183"></a><span id="l6.3183" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3184"></a><span id="l6.3184" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3185"></a><span id="l6.3185" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3186"></a><span id="l6.3186" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3187"></a><span id="l6.3187" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3188"></a><span id="l6.3188" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3189"></a><span id="l6.3189" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3190"></a><span id="l6.3190" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3191"></a><span id="l6.3191" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3192"></a><span id="l6.3192" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3193"></a><span id="l6.3193" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3194"></a><span id="l6.3194" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3195"></a><span id="l6.3195" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3196"></a><span id="l6.3196" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3197"></a><span id="l6.3197" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3198"></a><span id="l6.3198" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3199"></a><span id="l6.3199" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3200"></a><span id="l6.3200" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3201"></a><span id="l6.3201" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3202"></a><span id="l6.3202" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3203"></a><span id="l6.3203" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3204"></a><span id="l6.3204" class="difflineminus">-	0, gNormalizeTablea640, gNormalizeTablea680, 0, </span>
<a href="#l6.3205"></a><span id="l6.3205" class="difflineminus">-	gNormalizeTablea700, gNormalizeTablea740, gNormalizeTablea780, 0, </span>
<a href="#l6.3206"></a><span id="l6.3206" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3207"></a><span id="l6.3207" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3208"></a><span id="l6.3208" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3209"></a><span id="l6.3209" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3210"></a><span id="l6.3210" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3211"></a><span id="l6.3211" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3212"></a><span id="l6.3212" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3213"></a><span id="l6.3213" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3214"></a><span id="l6.3214" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3215"></a><span id="l6.3215" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3216"></a><span id="l6.3216" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3217"></a><span id="l6.3217" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3218"></a><span id="l6.3218" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3219"></a><span id="l6.3219" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3220"></a><span id="l6.3220" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3221"></a><span id="l6.3221" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3222"></a><span id="l6.3222" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3223"></a><span id="l6.3223" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3224"></a><span id="l6.3224" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3225"></a><span id="l6.3225" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3226"></a><span id="l6.3226" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3227"></a><span id="l6.3227" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3228"></a><span id="l6.3228" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3229"></a><span id="l6.3229" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3230"></a><span id="l6.3230" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3231"></a><span id="l6.3231" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3232"></a><span id="l6.3232" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3233"></a><span id="l6.3233" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3234"></a><span id="l6.3234" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3235"></a><span id="l6.3235" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3236"></a><span id="l6.3236" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3237"></a><span id="l6.3237" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3238"></a><span id="l6.3238" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3239"></a><span id="l6.3239" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3240"></a><span id="l6.3240" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3241"></a><span id="l6.3241" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3242"></a><span id="l6.3242" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3243"></a><span id="l6.3243" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3244"></a><span id="l6.3244" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3245"></a><span id="l6.3245" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3246"></a><span id="l6.3246" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3247"></a><span id="l6.3247" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3248"></a><span id="l6.3248" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3249"></a><span id="l6.3249" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3250"></a><span id="l6.3250" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3251"></a><span id="l6.3251" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3252"></a><span id="l6.3252" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3253"></a><span id="l6.3253" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3254"></a><span id="l6.3254" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3255"></a><span id="l6.3255" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3256"></a><span id="l6.3256" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3257"></a><span id="l6.3257" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3258"></a><span id="l6.3258" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3259"></a><span id="l6.3259" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3260"></a><span id="l6.3260" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3261"></a><span id="l6.3261" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3262"></a><span id="l6.3262" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3263"></a><span id="l6.3263" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3264"></a><span id="l6.3264" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3265"></a><span id="l6.3265" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3266"></a><span id="l6.3266" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3267"></a><span id="l6.3267" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3268"></a><span id="l6.3268" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3269"></a><span id="l6.3269" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3270"></a><span id="l6.3270" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3271"></a><span id="l6.3271" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3272"></a><span id="l6.3272" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3273"></a><span id="l6.3273" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3274"></a><span id="l6.3274" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3275"></a><span id="l6.3275" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3276"></a><span id="l6.3276" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3277"></a><span id="l6.3277" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3278"></a><span id="l6.3278" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3279"></a><span id="l6.3279" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3280"></a><span id="l6.3280" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3281"></a><span id="l6.3281" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3282"></a><span id="l6.3282" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3283"></a><span id="l6.3283" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3284"></a><span id="l6.3284" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3285"></a><span id="l6.3285" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3286"></a><span id="l6.3286" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l6.3287"></a><span id="l6.3287" class="difflineminus">-	gNormalizeTablef900, gNormalizeTablef940, gNormalizeTablef980, gNormalizeTablef9c0, </span>
<a href="#l6.3288"></a><span id="l6.3288" class="difflineminus">-	gNormalizeTablefa00, gNormalizeTablefa40, gNormalizeTablefa80, gNormalizeTablefac0, </span>
<a href="#l6.3289"></a><span id="l6.3289" class="difflineminus">-	gNormalizeTablefb00, gNormalizeTablefb40, gNormalizeTablefb80, gNormalizeTablefbc0, </span>
<a href="#l6.3290"></a><span id="l6.3290" class="difflineminus">-	gNormalizeTablefc00, gNormalizeTablefc40, gNormalizeTablefc80, gNormalizeTablefcc0, </span>
<a href="#l6.3291"></a><span id="l6.3291" class="difflineminus">-	gNormalizeTablefd00, gNormalizeTablefd40, gNormalizeTablefd80, gNormalizeTablefdc0, </span>
<a href="#l6.3292"></a><span id="l6.3292" class="difflineminus">-	gNormalizeTablefe00, gNormalizeTablefe40, gNormalizeTablefe80, gNormalizeTablefec0, </span>
<a href="#l6.3293"></a><span id="l6.3293" class="difflineminus">-	gNormalizeTableff00, gNormalizeTableff40, gNormalizeTableff80, gNormalizeTableffc0, </span>
<a href="#l6.3294"></a><span id="l6.3294" class="difflineplus">+    /* U+ffc0 */</span>
<a href="#l6.3295"></a><span id="l6.3295" class="difflineplus">+    0xffc0, 0xffc1, 0x1161, 0x1162, 0x1163, 0x1164, 0x1165, 0x1166,</span>
<a href="#l6.3296"></a><span id="l6.3296" class="difflineplus">+    0xffc8, 0xffc9, 0x1167, 0x1168, 0x1169, 0x116a, 0x116b, 0x116c,</span>
<a href="#l6.3297"></a><span id="l6.3297" class="difflineplus">+    0xffd0, 0xffd1, 0x116d, 0x116e, 0x116f, 0x1170, 0x1171, 0x1172,</span>
<a href="#l6.3298"></a><span id="l6.3298" class="difflineplus">+    0xffd8, 0xffd9, 0x1173, 0x1174, 0x1175, 0xffdd, 0xffde, 0xffdf,</span>
<a href="#l6.3299"></a><span id="l6.3299" class="difflineplus">+    0x00a2, 0x00a3, 0x00ac, 0x0020, 0x00a6, 0x00a5, 0x20a9, 0xffe7,</span>
<a href="#l6.3300"></a><span id="l6.3300" class="difflineplus">+    0x2502, 0x2190, 0x2191, 0x2192, 0x2193, 0x25a0, 0x25cb, 0xffef,</span>
<a href="#l6.3301"></a><span id="l6.3301" class="difflineplus">+    0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020,</span>
<a href="#l6.3302"></a><span id="l6.3302" class="difflineplus">+    0x0020, 0xfff9, 0xfffa, 0xfffb, 0xfffc, 0xfffd, 0xfffe, 0xffff,</span>
<a href="#l6.3303"></a><span id="l6.3303"> };</span>
<a href="#l6.3304"></a><span id="l6.3304"> </span>
<a href="#l6.3305"></a><span id="l6.3305" class="difflineminus">-unsigned int normalize_character(const unsigned int c)</span>
<a href="#l6.3306"></a><span id="l6.3306" class="difflineminus">-{</span>
<a href="#l6.3307"></a><span id="l6.3307" class="difflineminus">-  if (c &gt;= 0x10000 || !gNormalizeTable[c &gt;&gt; 6])</span>
<a href="#l6.3308"></a><span id="l6.3308" class="difflineminus">-    return c;</span>
<a href="#l6.3309"></a><span id="l6.3309" class="difflineplus">+static const unsigned short* gNormalizeTable[] = {</span>
<a href="#l6.3310"></a><span id="l6.3310" class="difflineplus">+    0,</span>
<a href="#l6.3311"></a><span id="l6.3311" class="difflineplus">+    gNormalizeTable0040,</span>
<a href="#l6.3312"></a><span id="l6.3312" class="difflineplus">+    gNormalizeTable0080,</span>
<a href="#l6.3313"></a><span id="l6.3313" class="difflineplus">+    gNormalizeTable00c0,</span>
<a href="#l6.3314"></a><span id="l6.3314" class="difflineplus">+    gNormalizeTable0100,</span>
<a href="#l6.3315"></a><span id="l6.3315" class="difflineplus">+    gNormalizeTable0140,</span>
<a href="#l6.3316"></a><span id="l6.3316" class="difflineplus">+    gNormalizeTable0180,</span>
<a href="#l6.3317"></a><span id="l6.3317" class="difflineplus">+    gNormalizeTable01c0,</span>
<a href="#l6.3318"></a><span id="l6.3318" class="difflineplus">+    gNormalizeTable0200,</span>
<a href="#l6.3319"></a><span id="l6.3319" class="difflineplus">+    gNormalizeTable0240,</span>
<a href="#l6.3320"></a><span id="l6.3320" class="difflineplus">+    gNormalizeTable0280,</span>
<a href="#l6.3321"></a><span id="l6.3321" class="difflineplus">+    gNormalizeTable02c0,</span>
<a href="#l6.3322"></a><span id="l6.3322" class="difflineplus">+    0,</span>
<a href="#l6.3323"></a><span id="l6.3323" class="difflineplus">+    gNormalizeTable0340,</span>
<a href="#l6.3324"></a><span id="l6.3324" class="difflineplus">+    gNormalizeTable0380,</span>
<a href="#l6.3325"></a><span id="l6.3325" class="difflineplus">+    gNormalizeTable03c0,</span>
<a href="#l6.3326"></a><span id="l6.3326" class="difflineplus">+    gNormalizeTable0400,</span>
<a href="#l6.3327"></a><span id="l6.3327" class="difflineplus">+    gNormalizeTable0440,</span>
<a href="#l6.3328"></a><span id="l6.3328" class="difflineplus">+    gNormalizeTable0480,</span>
<a href="#l6.3329"></a><span id="l6.3329" class="difflineplus">+    gNormalizeTable04c0,</span>
<a href="#l6.3330"></a><span id="l6.3330" class="difflineplus">+    gNormalizeTable0500,</span>
<a href="#l6.3331"></a><span id="l6.3331" class="difflineplus">+    gNormalizeTable0540,</span>
<a href="#l6.3332"></a><span id="l6.3332" class="difflineplus">+    gNormalizeTable0580,</span>
<a href="#l6.3333"></a><span id="l6.3333" class="difflineplus">+    0,</span>
<a href="#l6.3334"></a><span id="l6.3334" class="difflineplus">+    gNormalizeTable0600,</span>
<a href="#l6.3335"></a><span id="l6.3335" class="difflineplus">+    gNormalizeTable0640,</span>
<a href="#l6.3336"></a><span id="l6.3336" class="difflineplus">+    0,</span>
<a href="#l6.3337"></a><span id="l6.3337" class="difflineplus">+    gNormalizeTable06c0,</span>
<a href="#l6.3338"></a><span id="l6.3338" class="difflineplus">+    0,</span>
<a href="#l6.3339"></a><span id="l6.3339" class="difflineplus">+    0,</span>
<a href="#l6.3340"></a><span id="l6.3340" class="difflineplus">+    0,</span>
<a href="#l6.3341"></a><span id="l6.3341" class="difflineplus">+    0,</span>
<a href="#l6.3342"></a><span id="l6.3342" class="difflineplus">+    0,</span>
<a href="#l6.3343"></a><span id="l6.3343" class="difflineplus">+    0,</span>
<a href="#l6.3344"></a><span id="l6.3344" class="difflineplus">+    0,</span>
<a href="#l6.3345"></a><span id="l6.3345" class="difflineplus">+    0,</span>
<a href="#l6.3346"></a><span id="l6.3346" class="difflineplus">+    gNormalizeTable0900,</span>
<a href="#l6.3347"></a><span id="l6.3347" class="difflineplus">+    gNormalizeTable0940,</span>
<a href="#l6.3348"></a><span id="l6.3348" class="difflineplus">+    0,</span>
<a href="#l6.3349"></a><span id="l6.3349" class="difflineplus">+    gNormalizeTable09c0,</span>
<a href="#l6.3350"></a><span id="l6.3350" class="difflineplus">+    gNormalizeTable0a00,</span>
<a href="#l6.3351"></a><span id="l6.3351" class="difflineplus">+    gNormalizeTable0a40,</span>
<a href="#l6.3352"></a><span id="l6.3352" class="difflineplus">+    0,</span>
<a href="#l6.3353"></a><span id="l6.3353" class="difflineplus">+    0,</span>
<a href="#l6.3354"></a><span id="l6.3354" class="difflineplus">+    0,</span>
<a href="#l6.3355"></a><span id="l6.3355" class="difflineplus">+    gNormalizeTable0b40,</span>
<a href="#l6.3356"></a><span id="l6.3356" class="difflineplus">+    gNormalizeTable0b80,</span>
<a href="#l6.3357"></a><span id="l6.3357" class="difflineplus">+    gNormalizeTable0bc0,</span>
<a href="#l6.3358"></a><span id="l6.3358" class="difflineplus">+    0,</span>
<a href="#l6.3359"></a><span id="l6.3359" class="difflineplus">+    gNormalizeTable0c40,</span>
<a href="#l6.3360"></a><span id="l6.3360" class="difflineplus">+    0,</span>
<a href="#l6.3361"></a><span id="l6.3361" class="difflineplus">+    gNormalizeTable0cc0,</span>
<a href="#l6.3362"></a><span id="l6.3362" class="difflineplus">+    0,</span>
<a href="#l6.3363"></a><span id="l6.3363" class="difflineplus">+    gNormalizeTable0d40,</span>
<a href="#l6.3364"></a><span id="l6.3364" class="difflineplus">+    0,</span>
<a href="#l6.3365"></a><span id="l6.3365" class="difflineplus">+    gNormalizeTable0dc0,</span>
<a href="#l6.3366"></a><span id="l6.3366" class="difflineplus">+    gNormalizeTable0e00,</span>
<a href="#l6.3367"></a><span id="l6.3367" class="difflineplus">+    0,</span>
<a href="#l6.3368"></a><span id="l6.3368" class="difflineplus">+    gNormalizeTable0e80,</span>
<a href="#l6.3369"></a><span id="l6.3369" class="difflineplus">+    gNormalizeTable0ec0,</span>
<a href="#l6.3370"></a><span id="l6.3370" class="difflineplus">+    gNormalizeTable0f00,</span>
<a href="#l6.3371"></a><span id="l6.3371" class="difflineplus">+    gNormalizeTable0f40,</span>
<a href="#l6.3372"></a><span id="l6.3372" class="difflineplus">+    gNormalizeTable0f80,</span>
<a href="#l6.3373"></a><span id="l6.3373" class="difflineplus">+    0,</span>
<a href="#l6.3374"></a><span id="l6.3374" class="difflineplus">+    gNormalizeTable1000,</span>
<a href="#l6.3375"></a><span id="l6.3375" class="difflineplus">+    0,</span>
<a href="#l6.3376"></a><span id="l6.3376" class="difflineplus">+    gNormalizeTable1080,</span>
<a href="#l6.3377"></a><span id="l6.3377" class="difflineplus">+    gNormalizeTable10c0,</span>
<a href="#l6.3378"></a><span id="l6.3378" class="difflineplus">+    0,</span>
<a href="#l6.3379"></a><span id="l6.3379" class="difflineplus">+    gNormalizeTable1140,</span>
<a href="#l6.3380"></a><span id="l6.3380" class="difflineplus">+    0,</span>
<a href="#l6.3381"></a><span id="l6.3381" class="difflineplus">+    0,</span>
<a href="#l6.3382"></a><span id="l6.3382" class="difflineplus">+    0,</span>
<a href="#l6.3383"></a><span id="l6.3383" class="difflineplus">+    0,</span>
<a href="#l6.3384"></a><span id="l6.3384" class="difflineplus">+    0,</span>
<a href="#l6.3385"></a><span id="l6.3385" class="difflineplus">+    0,</span>
<a href="#l6.3386"></a><span id="l6.3386" class="difflineplus">+    0,</span>
<a href="#l6.3387"></a><span id="l6.3387" class="difflineplus">+    0,</span>
<a href="#l6.3388"></a><span id="l6.3388" class="difflineplus">+    0,</span>
<a href="#l6.3389"></a><span id="l6.3389" class="difflineplus">+    0,</span>
<a href="#l6.3390"></a><span id="l6.3390" class="difflineplus">+    0,</span>
<a href="#l6.3391"></a><span id="l6.3391" class="difflineplus">+    0,</span>
<a href="#l6.3392"></a><span id="l6.3392" class="difflineplus">+    0,</span>
<a href="#l6.3393"></a><span id="l6.3393" class="difflineplus">+    0,</span>
<a href="#l6.3394"></a><span id="l6.3394" class="difflineplus">+    0,</span>
<a href="#l6.3395"></a><span id="l6.3395" class="difflineplus">+    0,</span>
<a href="#l6.3396"></a><span id="l6.3396" class="difflineplus">+    0,</span>
<a href="#l6.3397"></a><span id="l6.3397" class="difflineplus">+    0,</span>
<a href="#l6.3398"></a><span id="l6.3398" class="difflineplus">+    0,</span>
<a href="#l6.3399"></a><span id="l6.3399" class="difflineplus">+    0,</span>
<a href="#l6.3400"></a><span id="l6.3400" class="difflineplus">+    0,</span>
<a href="#l6.3401"></a><span id="l6.3401" class="difflineplus">+    0,</span>
<a href="#l6.3402"></a><span id="l6.3402" class="difflineplus">+    0,</span>
<a href="#l6.3403"></a><span id="l6.3403" class="difflineplus">+    0,</span>
<a href="#l6.3404"></a><span id="l6.3404" class="difflineplus">+    gNormalizeTable1780,</span>
<a href="#l6.3405"></a><span id="l6.3405" class="difflineplus">+    0,</span>
<a href="#l6.3406"></a><span id="l6.3406" class="difflineplus">+    gNormalizeTable1800,</span>
<a href="#l6.3407"></a><span id="l6.3407" class="difflineplus">+    0,</span>
<a href="#l6.3408"></a><span id="l6.3408" class="difflineplus">+    0,</span>
<a href="#l6.3409"></a><span id="l6.3409" class="difflineplus">+    0,</span>
<a href="#l6.3410"></a><span id="l6.3410" class="difflineplus">+    0,</span>
<a href="#l6.3411"></a><span id="l6.3411" class="difflineplus">+    0,</span>
<a href="#l6.3412"></a><span id="l6.3412" class="difflineplus">+    0,</span>
<a href="#l6.3413"></a><span id="l6.3413" class="difflineplus">+    0,</span>
<a href="#l6.3414"></a><span id="l6.3414" class="difflineplus">+    0,</span>
<a href="#l6.3415"></a><span id="l6.3415" class="difflineplus">+    0,</span>
<a href="#l6.3416"></a><span id="l6.3416" class="difflineplus">+    0,</span>
<a href="#l6.3417"></a><span id="l6.3417" class="difflineplus">+    0,</span>
<a href="#l6.3418"></a><span id="l6.3418" class="difflineplus">+    gNormalizeTable1b00,</span>
<a href="#l6.3419"></a><span id="l6.3419" class="difflineplus">+    gNormalizeTable1b40,</span>
<a href="#l6.3420"></a><span id="l6.3420" class="difflineplus">+    0,</span>
<a href="#l6.3421"></a><span id="l6.3421" class="difflineplus">+    0,</span>
<a href="#l6.3422"></a><span id="l6.3422" class="difflineplus">+    0,</span>
<a href="#l6.3423"></a><span id="l6.3423" class="difflineplus">+    0,</span>
<a href="#l6.3424"></a><span id="l6.3424" class="difflineplus">+    0,</span>
<a href="#l6.3425"></a><span id="l6.3425" class="difflineplus">+    0,</span>
<a href="#l6.3426"></a><span id="l6.3426" class="difflineplus">+    gNormalizeTable1d00,</span>
<a href="#l6.3427"></a><span id="l6.3427" class="difflineplus">+    gNormalizeTable1d40,</span>
<a href="#l6.3428"></a><span id="l6.3428" class="difflineplus">+    gNormalizeTable1d80,</span>
<a href="#l6.3429"></a><span id="l6.3429" class="difflineplus">+    0,</span>
<a href="#l6.3430"></a><span id="l6.3430" class="difflineplus">+    gNormalizeTable1e00,</span>
<a href="#l6.3431"></a><span id="l6.3431" class="difflineplus">+    gNormalizeTable1e40,</span>
<a href="#l6.3432"></a><span id="l6.3432" class="difflineplus">+    gNormalizeTable1e80,</span>
<a href="#l6.3433"></a><span id="l6.3433" class="difflineplus">+    gNormalizeTable1ec0,</span>
<a href="#l6.3434"></a><span id="l6.3434" class="difflineplus">+    gNormalizeTable1f00,</span>
<a href="#l6.3435"></a><span id="l6.3435" class="difflineplus">+    gNormalizeTable1f40,</span>
<a href="#l6.3436"></a><span id="l6.3436" class="difflineplus">+    gNormalizeTable1f80,</span>
<a href="#l6.3437"></a><span id="l6.3437" class="difflineplus">+    gNormalizeTable1fc0,</span>
<a href="#l6.3438"></a><span id="l6.3438" class="difflineplus">+    gNormalizeTable2000,</span>
<a href="#l6.3439"></a><span id="l6.3439" class="difflineplus">+    gNormalizeTable2040,</span>
<a href="#l6.3440"></a><span id="l6.3440" class="difflineplus">+    gNormalizeTable2080,</span>
<a href="#l6.3441"></a><span id="l6.3441" class="difflineplus">+    0,</span>
<a href="#l6.3442"></a><span id="l6.3442" class="difflineplus">+    gNormalizeTable2100,</span>
<a href="#l6.3443"></a><span id="l6.3443" class="difflineplus">+    gNormalizeTable2140,</span>
<a href="#l6.3444"></a><span id="l6.3444" class="difflineplus">+    gNormalizeTable2180,</span>
<a href="#l6.3445"></a><span id="l6.3445" class="difflineplus">+    gNormalizeTable21c0,</span>
<a href="#l6.3446"></a><span id="l6.3446" class="difflineplus">+    gNormalizeTable2200,</span>
<a href="#l6.3447"></a><span id="l6.3447" class="difflineplus">+    gNormalizeTable2240,</span>
<a href="#l6.3448"></a><span id="l6.3448" class="difflineplus">+    gNormalizeTable2280,</span>
<a href="#l6.3449"></a><span id="l6.3449" class="difflineplus">+    gNormalizeTable22c0,</span>
<a href="#l6.3450"></a><span id="l6.3450" class="difflineplus">+    gNormalizeTable2300,</span>
<a href="#l6.3451"></a><span id="l6.3451" class="difflineplus">+    0,</span>
<a href="#l6.3452"></a><span id="l6.3452" class="difflineplus">+    0,</span>
<a href="#l6.3453"></a><span id="l6.3453" class="difflineplus">+    0,</span>
<a href="#l6.3454"></a><span id="l6.3454" class="difflineplus">+    0,</span>
<a href="#l6.3455"></a><span id="l6.3455" class="difflineplus">+    gNormalizeTable2440,</span>
<a href="#l6.3456"></a><span id="l6.3456" class="difflineplus">+    gNormalizeTable2480,</span>
<a href="#l6.3457"></a><span id="l6.3457" class="difflineplus">+    gNormalizeTable24c0,</span>
<a href="#l6.3458"></a><span id="l6.3458" class="difflineplus">+    0,</span>
<a href="#l6.3459"></a><span id="l6.3459" class="difflineplus">+    0,</span>
<a href="#l6.3460"></a><span id="l6.3460" class="difflineplus">+    0,</span>
<a href="#l6.3461"></a><span id="l6.3461" class="difflineplus">+    0,</span>
<a href="#l6.3462"></a><span id="l6.3462" class="difflineplus">+    0,</span>
<a href="#l6.3463"></a><span id="l6.3463" class="difflineplus">+    0,</span>
<a href="#l6.3464"></a><span id="l6.3464" class="difflineplus">+    0,</span>
<a href="#l6.3465"></a><span id="l6.3465" class="difflineplus">+    0,</span>
<a href="#l6.3466"></a><span id="l6.3466" class="difflineplus">+    0,</span>
<a href="#l6.3467"></a><span id="l6.3467" class="difflineplus">+    0,</span>
<a href="#l6.3468"></a><span id="l6.3468" class="difflineplus">+    0,</span>
<a href="#l6.3469"></a><span id="l6.3469" class="difflineplus">+    0,</span>
<a href="#l6.3470"></a><span id="l6.3470" class="difflineplus">+    0,</span>
<a href="#l6.3471"></a><span id="l6.3471" class="difflineplus">+    0,</span>
<a href="#l6.3472"></a><span id="l6.3472" class="difflineplus">+    0,</span>
<a href="#l6.3473"></a><span id="l6.3473" class="difflineplus">+    0,</span>
<a href="#l6.3474"></a><span id="l6.3474" class="difflineplus">+    0,</span>
<a href="#l6.3475"></a><span id="l6.3475" class="difflineplus">+    0,</span>
<a href="#l6.3476"></a><span id="l6.3476" class="difflineplus">+    0,</span>
<a href="#l6.3477"></a><span id="l6.3477" class="difflineplus">+    0,</span>
<a href="#l6.3478"></a><span id="l6.3478" class="difflineplus">+    gNormalizeTable2a00,</span>
<a href="#l6.3479"></a><span id="l6.3479" class="difflineplus">+    gNormalizeTable2a40,</span>
<a href="#l6.3480"></a><span id="l6.3480" class="difflineplus">+    0,</span>
<a href="#l6.3481"></a><span id="l6.3481" class="difflineplus">+    gNormalizeTable2ac0,</span>
<a href="#l6.3482"></a><span id="l6.3482" class="difflineplus">+    0,</span>
<a href="#l6.3483"></a><span id="l6.3483" class="difflineplus">+    0,</span>
<a href="#l6.3484"></a><span id="l6.3484" class="difflineplus">+    0,</span>
<a href="#l6.3485"></a><span id="l6.3485" class="difflineplus">+    0,</span>
<a href="#l6.3486"></a><span id="l6.3486" class="difflineplus">+    gNormalizeTable2c00,</span>
<a href="#l6.3487"></a><span id="l6.3487" class="difflineplus">+    gNormalizeTable2c40,</span>
<a href="#l6.3488"></a><span id="l6.3488" class="difflineplus">+    gNormalizeTable2c80,</span>
<a href="#l6.3489"></a><span id="l6.3489" class="difflineplus">+    gNormalizeTable2cc0,</span>
<a href="#l6.3490"></a><span id="l6.3490" class="difflineplus">+    0,</span>
<a href="#l6.3491"></a><span id="l6.3491" class="difflineplus">+    gNormalizeTable2d40,</span>
<a href="#l6.3492"></a><span id="l6.3492" class="difflineplus">+    0,</span>
<a href="#l6.3493"></a><span id="l6.3493" class="difflineplus">+    0,</span>
<a href="#l6.3494"></a><span id="l6.3494" class="difflineplus">+    0,</span>
<a href="#l6.3495"></a><span id="l6.3495" class="difflineplus">+    0,</span>
<a href="#l6.3496"></a><span id="l6.3496" class="difflineplus">+    gNormalizeTable2e80,</span>
<a href="#l6.3497"></a><span id="l6.3497" class="difflineplus">+    gNormalizeTable2ec0,</span>
<a href="#l6.3498"></a><span id="l6.3498" class="difflineplus">+    gNormalizeTable2f00,</span>
<a href="#l6.3499"></a><span id="l6.3499" class="difflineplus">+    gNormalizeTable2f40,</span>
<a href="#l6.3500"></a><span id="l6.3500" class="difflineplus">+    gNormalizeTable2f80,</span>
<a href="#l6.3501"></a><span id="l6.3501" class="difflineplus">+    gNormalizeTable2fc0,</span>
<a href="#l6.3502"></a><span id="l6.3502" class="difflineplus">+    gNormalizeTable3000,</span>
<a href="#l6.3503"></a><span id="l6.3503" class="difflineplus">+    gNormalizeTable3040,</span>
<a href="#l6.3504"></a><span id="l6.3504" class="difflineplus">+    gNormalizeTable3080,</span>
<a href="#l6.3505"></a><span id="l6.3505" class="difflineplus">+    gNormalizeTable30c0,</span>
<a href="#l6.3506"></a><span id="l6.3506" class="difflineplus">+    gNormalizeTable3100,</span>
<a href="#l6.3507"></a><span id="l6.3507" class="difflineplus">+    gNormalizeTable3140,</span>
<a href="#l6.3508"></a><span id="l6.3508" class="difflineplus">+    gNormalizeTable3180,</span>
<a href="#l6.3509"></a><span id="l6.3509" class="difflineplus">+    0,</span>
<a href="#l6.3510"></a><span id="l6.3510" class="difflineplus">+    gNormalizeTable3200,</span>
<a href="#l6.3511"></a><span id="l6.3511" class="difflineplus">+    gNormalizeTable3240,</span>
<a href="#l6.3512"></a><span id="l6.3512" class="difflineplus">+    gNormalizeTable3280,</span>
<a href="#l6.3513"></a><span id="l6.3513" class="difflineplus">+    gNormalizeTable32c0,</span>
<a href="#l6.3514"></a><span id="l6.3514" class="difflineplus">+    gNormalizeTable3300,</span>
<a href="#l6.3515"></a><span id="l6.3515" class="difflineplus">+    gNormalizeTable3340,</span>
<a href="#l6.3516"></a><span id="l6.3516" class="difflineplus">+    gNormalizeTable3380,</span>
<a href="#l6.3517"></a><span id="l6.3517" class="difflineplus">+    gNormalizeTable33c0,</span>
<a href="#l6.3518"></a><span id="l6.3518" class="difflineplus">+    0,</span>
<a href="#l6.3519"></a><span id="l6.3519" class="difflineplus">+    0,</span>
<a href="#l6.3520"></a><span id="l6.3520" class="difflineplus">+    0,</span>
<a href="#l6.3521"></a><span id="l6.3521" class="difflineplus">+    0,</span>
<a href="#l6.3522"></a><span id="l6.3522" class="difflineplus">+    0,</span>
<a href="#l6.3523"></a><span id="l6.3523" class="difflineplus">+    0,</span>
<a href="#l6.3524"></a><span id="l6.3524" class="difflineplus">+    0,</span>
<a href="#l6.3525"></a><span id="l6.3525" class="difflineplus">+    0,</span>
<a href="#l6.3526"></a><span id="l6.3526" class="difflineplus">+    0,</span>
<a href="#l6.3527"></a><span id="l6.3527" class="difflineplus">+    0,</span>
<a href="#l6.3528"></a><span id="l6.3528" class="difflineplus">+    0,</span>
<a href="#l6.3529"></a><span id="l6.3529" class="difflineplus">+    0,</span>
<a href="#l6.3530"></a><span id="l6.3530" class="difflineplus">+    0,</span>
<a href="#l6.3531"></a><span id="l6.3531" class="difflineplus">+    0,</span>
<a href="#l6.3532"></a><span id="l6.3532" class="difflineplus">+    0,</span>
<a href="#l6.3533"></a><span id="l6.3533" class="difflineplus">+    0,</span>
<a href="#l6.3534"></a><span id="l6.3534" class="difflineplus">+    0,</span>
<a href="#l6.3535"></a><span id="l6.3535" class="difflineplus">+    0,</span>
<a href="#l6.3536"></a><span id="l6.3536" class="difflineplus">+    0,</span>
<a href="#l6.3537"></a><span id="l6.3537" class="difflineplus">+    0,</span>
<a href="#l6.3538"></a><span id="l6.3538" class="difflineplus">+    0,</span>
<a href="#l6.3539"></a><span id="l6.3539" class="difflineplus">+    0,</span>
<a href="#l6.3540"></a><span id="l6.3540" class="difflineplus">+    0,</span>
<a href="#l6.3541"></a><span id="l6.3541" class="difflineplus">+    0,</span>
<a href="#l6.3542"></a><span id="l6.3542" class="difflineplus">+    0,</span>
<a href="#l6.3543"></a><span id="l6.3543" class="difflineplus">+    0,</span>
<a href="#l6.3544"></a><span id="l6.3544" class="difflineplus">+    0,</span>
<a href="#l6.3545"></a><span id="l6.3545" class="difflineplus">+    0,</span>
<a href="#l6.3546"></a><span id="l6.3546" class="difflineplus">+    0,</span>
<a href="#l6.3547"></a><span id="l6.3547" class="difflineplus">+    0,</span>
<a href="#l6.3548"></a><span id="l6.3548" class="difflineplus">+    0,</span>
<a href="#l6.3549"></a><span id="l6.3549" class="difflineplus">+    0,</span>
<a href="#l6.3550"></a><span id="l6.3550" class="difflineplus">+    0,</span>
<a href="#l6.3551"></a><span id="l6.3551" class="difflineplus">+    0,</span>
<a href="#l6.3552"></a><span id="l6.3552" class="difflineplus">+    0,</span>
<a href="#l6.3553"></a><span id="l6.3553" class="difflineplus">+    0,</span>
<a href="#l6.3554"></a><span id="l6.3554" class="difflineplus">+    0,</span>
<a href="#l6.3555"></a><span id="l6.3555" class="difflineplus">+    0,</span>
<a href="#l6.3556"></a><span id="l6.3556" class="difflineplus">+    0,</span>
<a href="#l6.3557"></a><span id="l6.3557" class="difflineplus">+    0,</span>
<a href="#l6.3558"></a><span id="l6.3558" class="difflineplus">+    0,</span>
<a href="#l6.3559"></a><span id="l6.3559" class="difflineplus">+    0,</span>
<a href="#l6.3560"></a><span id="l6.3560" class="difflineplus">+    0,</span>
<a href="#l6.3561"></a><span id="l6.3561" class="difflineplus">+    0,</span>
<a href="#l6.3562"></a><span id="l6.3562" class="difflineplus">+    0,</span>
<a href="#l6.3563"></a><span id="l6.3563" class="difflineplus">+    0,</span>
<a href="#l6.3564"></a><span id="l6.3564" class="difflineplus">+    0,</span>
<a href="#l6.3565"></a><span id="l6.3565" class="difflineplus">+    0,</span>
<a href="#l6.3566"></a><span id="l6.3566" class="difflineplus">+    0,</span>
<a href="#l6.3567"></a><span id="l6.3567" class="difflineplus">+    0,</span>
<a href="#l6.3568"></a><span id="l6.3568" class="difflineplus">+    0,</span>
<a href="#l6.3569"></a><span id="l6.3569" class="difflineplus">+    0,</span>
<a href="#l6.3570"></a><span id="l6.3570" class="difflineplus">+    0,</span>
<a href="#l6.3571"></a><span id="l6.3571" class="difflineplus">+    0,</span>
<a href="#l6.3572"></a><span id="l6.3572" class="difflineplus">+    0,</span>
<a href="#l6.3573"></a><span id="l6.3573" class="difflineplus">+    0,</span>
<a href="#l6.3574"></a><span id="l6.3574" class="difflineplus">+    0,</span>
<a href="#l6.3575"></a><span id="l6.3575" class="difflineplus">+    0,</span>
<a href="#l6.3576"></a><span id="l6.3576" class="difflineplus">+    0,</span>
<a href="#l6.3577"></a><span id="l6.3577" class="difflineplus">+    0,</span>
<a href="#l6.3578"></a><span id="l6.3578" class="difflineplus">+    0,</span>
<a href="#l6.3579"></a><span id="l6.3579" class="difflineplus">+    0,</span>
<a href="#l6.3580"></a><span id="l6.3580" class="difflineplus">+    0,</span>
<a href="#l6.3581"></a><span id="l6.3581" class="difflineplus">+    0,</span>
<a href="#l6.3582"></a><span id="l6.3582" class="difflineplus">+    0,</span>
<a href="#l6.3583"></a><span id="l6.3583" class="difflineplus">+    0,</span>
<a href="#l6.3584"></a><span id="l6.3584" class="difflineplus">+    0,</span>
<a href="#l6.3585"></a><span id="l6.3585" class="difflineplus">+    0,</span>
<a href="#l6.3586"></a><span id="l6.3586" class="difflineplus">+    0,</span>
<a href="#l6.3587"></a><span id="l6.3587" class="difflineplus">+    0,</span>
<a href="#l6.3588"></a><span id="l6.3588" class="difflineplus">+    0,</span>
<a href="#l6.3589"></a><span id="l6.3589" class="difflineplus">+    0,</span>
<a href="#l6.3590"></a><span id="l6.3590" class="difflineplus">+    0,</span>
<a href="#l6.3591"></a><span id="l6.3591" class="difflineplus">+    0,</span>
<a href="#l6.3592"></a><span id="l6.3592" class="difflineplus">+    0,</span>
<a href="#l6.3593"></a><span id="l6.3593" class="difflineplus">+    0,</span>
<a href="#l6.3594"></a><span id="l6.3594" class="difflineplus">+    0,</span>
<a href="#l6.3595"></a><span id="l6.3595" class="difflineplus">+    0,</span>
<a href="#l6.3596"></a><span id="l6.3596" class="difflineplus">+    0,</span>
<a href="#l6.3597"></a><span id="l6.3597" class="difflineplus">+    0,</span>
<a href="#l6.3598"></a><span id="l6.3598" class="difflineplus">+    0,</span>
<a href="#l6.3599"></a><span id="l6.3599" class="difflineplus">+    0,</span>
<a href="#l6.3600"></a><span id="l6.3600" class="difflineplus">+    0,</span>
<a href="#l6.3601"></a><span id="l6.3601" class="difflineplus">+    0,</span>
<a href="#l6.3602"></a><span id="l6.3602" class="difflineplus">+    0,</span>
<a href="#l6.3603"></a><span id="l6.3603" class="difflineplus">+    0,</span>
<a href="#l6.3604"></a><span id="l6.3604" class="difflineplus">+    0,</span>
<a href="#l6.3605"></a><span id="l6.3605" class="difflineplus">+    0,</span>
<a href="#l6.3606"></a><span id="l6.3606" class="difflineplus">+    0,</span>
<a href="#l6.3607"></a><span id="l6.3607" class="difflineplus">+    0,</span>
<a href="#l6.3608"></a><span id="l6.3608" class="difflineplus">+    0,</span>
<a href="#l6.3609"></a><span id="l6.3609" class="difflineplus">+    0,</span>
<a href="#l6.3610"></a><span id="l6.3610" class="difflineplus">+    0,</span>
<a href="#l6.3611"></a><span id="l6.3611" class="difflineplus">+    0,</span>
<a href="#l6.3612"></a><span id="l6.3612" class="difflineplus">+    0,</span>
<a href="#l6.3613"></a><span id="l6.3613" class="difflineplus">+    0,</span>
<a href="#l6.3614"></a><span id="l6.3614" class="difflineplus">+    0,</span>
<a href="#l6.3615"></a><span id="l6.3615" class="difflineplus">+    0,</span>
<a href="#l6.3616"></a><span id="l6.3616" class="difflineplus">+    0,</span>
<a href="#l6.3617"></a><span id="l6.3617" class="difflineplus">+    0,</span>
<a href="#l6.3618"></a><span id="l6.3618" class="difflineplus">+    0,</span>
<a href="#l6.3619"></a><span id="l6.3619" class="difflineplus">+    0,</span>
<a href="#l6.3620"></a><span id="l6.3620" class="difflineplus">+    0,</span>
<a href="#l6.3621"></a><span id="l6.3621" class="difflineplus">+    0,</span>
<a href="#l6.3622"></a><span id="l6.3622" class="difflineplus">+    0,</span>
<a href="#l6.3623"></a><span id="l6.3623" class="difflineplus">+    0,</span>
<a href="#l6.3624"></a><span id="l6.3624" class="difflineplus">+    0,</span>
<a href="#l6.3625"></a><span id="l6.3625" class="difflineplus">+    0,</span>
<a href="#l6.3626"></a><span id="l6.3626" class="difflineplus">+    0,</span>
<a href="#l6.3627"></a><span id="l6.3627" class="difflineplus">+    0,</span>
<a href="#l6.3628"></a><span id="l6.3628" class="difflineplus">+    0,</span>
<a href="#l6.3629"></a><span id="l6.3629" class="difflineplus">+    0,</span>
<a href="#l6.3630"></a><span id="l6.3630" class="difflineplus">+    0,</span>
<a href="#l6.3631"></a><span id="l6.3631" class="difflineplus">+    0,</span>
<a href="#l6.3632"></a><span id="l6.3632" class="difflineplus">+    0,</span>
<a href="#l6.3633"></a><span id="l6.3633" class="difflineplus">+    0,</span>
<a href="#l6.3634"></a><span id="l6.3634" class="difflineplus">+    0,</span>
<a href="#l6.3635"></a><span id="l6.3635" class="difflineplus">+    0,</span>
<a href="#l6.3636"></a><span id="l6.3636" class="difflineplus">+    0,</span>
<a href="#l6.3637"></a><span id="l6.3637" class="difflineplus">+    0,</span>
<a href="#l6.3638"></a><span id="l6.3638" class="difflineplus">+    0,</span>
<a href="#l6.3639"></a><span id="l6.3639" class="difflineplus">+    0,</span>
<a href="#l6.3640"></a><span id="l6.3640" class="difflineplus">+    0,</span>
<a href="#l6.3641"></a><span id="l6.3641" class="difflineplus">+    0,</span>
<a href="#l6.3642"></a><span id="l6.3642" class="difflineplus">+    0,</span>
<a href="#l6.3643"></a><span id="l6.3643" class="difflineplus">+    0,</span>
<a href="#l6.3644"></a><span id="l6.3644" class="difflineplus">+    0,</span>
<a href="#l6.3645"></a><span id="l6.3645" class="difflineplus">+    0,</span>
<a href="#l6.3646"></a><span id="l6.3646" class="difflineplus">+    0,</span>
<a href="#l6.3647"></a><span id="l6.3647" class="difflineplus">+    0,</span>
<a href="#l6.3648"></a><span id="l6.3648" class="difflineplus">+    0,</span>
<a href="#l6.3649"></a><span id="l6.3649" class="difflineplus">+    0,</span>
<a href="#l6.3650"></a><span id="l6.3650" class="difflineplus">+    0,</span>
<a href="#l6.3651"></a><span id="l6.3651" class="difflineplus">+    0,</span>
<a href="#l6.3652"></a><span id="l6.3652" class="difflineplus">+    0,</span>
<a href="#l6.3653"></a><span id="l6.3653" class="difflineplus">+    0,</span>
<a href="#l6.3654"></a><span id="l6.3654" class="difflineplus">+    0,</span>
<a href="#l6.3655"></a><span id="l6.3655" class="difflineplus">+    0,</span>
<a href="#l6.3656"></a><span id="l6.3656" class="difflineplus">+    0,</span>
<a href="#l6.3657"></a><span id="l6.3657" class="difflineplus">+    0,</span>
<a href="#l6.3658"></a><span id="l6.3658" class="difflineplus">+    0,</span>
<a href="#l6.3659"></a><span id="l6.3659" class="difflineplus">+    0,</span>
<a href="#l6.3660"></a><span id="l6.3660" class="difflineplus">+    0,</span>
<a href="#l6.3661"></a><span id="l6.3661" class="difflineplus">+    0,</span>
<a href="#l6.3662"></a><span id="l6.3662" class="difflineplus">+    0,</span>
<a href="#l6.3663"></a><span id="l6.3663" class="difflineplus">+    0,</span>
<a href="#l6.3664"></a><span id="l6.3664" class="difflineplus">+    0,</span>
<a href="#l6.3665"></a><span id="l6.3665" class="difflineplus">+    0,</span>
<a href="#l6.3666"></a><span id="l6.3666" class="difflineplus">+    0,</span>
<a href="#l6.3667"></a><span id="l6.3667" class="difflineplus">+    0,</span>
<a href="#l6.3668"></a><span id="l6.3668" class="difflineplus">+    0,</span>
<a href="#l6.3669"></a><span id="l6.3669" class="difflineplus">+    0,</span>
<a href="#l6.3670"></a><span id="l6.3670" class="difflineplus">+    0,</span>
<a href="#l6.3671"></a><span id="l6.3671" class="difflineplus">+    0,</span>
<a href="#l6.3672"></a><span id="l6.3672" class="difflineplus">+    0,</span>
<a href="#l6.3673"></a><span id="l6.3673" class="difflineplus">+    0,</span>
<a href="#l6.3674"></a><span id="l6.3674" class="difflineplus">+    0,</span>
<a href="#l6.3675"></a><span id="l6.3675" class="difflineplus">+    0,</span>
<a href="#l6.3676"></a><span id="l6.3676" class="difflineplus">+    0,</span>
<a href="#l6.3677"></a><span id="l6.3677" class="difflineplus">+    0,</span>
<a href="#l6.3678"></a><span id="l6.3678" class="difflineplus">+    0,</span>
<a href="#l6.3679"></a><span id="l6.3679" class="difflineplus">+    0,</span>
<a href="#l6.3680"></a><span id="l6.3680" class="difflineplus">+    0,</span>
<a href="#l6.3681"></a><span id="l6.3681" class="difflineplus">+    0,</span>
<a href="#l6.3682"></a><span id="l6.3682" class="difflineplus">+    0,</span>
<a href="#l6.3683"></a><span id="l6.3683" class="difflineplus">+    0,</span>
<a href="#l6.3684"></a><span id="l6.3684" class="difflineplus">+    0,</span>
<a href="#l6.3685"></a><span id="l6.3685" class="difflineplus">+    0,</span>
<a href="#l6.3686"></a><span id="l6.3686" class="difflineplus">+    0,</span>
<a href="#l6.3687"></a><span id="l6.3687" class="difflineplus">+    0,</span>
<a href="#l6.3688"></a><span id="l6.3688" class="difflineplus">+    0,</span>
<a href="#l6.3689"></a><span id="l6.3689" class="difflineplus">+    0,</span>
<a href="#l6.3690"></a><span id="l6.3690" class="difflineplus">+    0,</span>
<a href="#l6.3691"></a><span id="l6.3691" class="difflineplus">+    0,</span>
<a href="#l6.3692"></a><span id="l6.3692" class="difflineplus">+    0,</span>
<a href="#l6.3693"></a><span id="l6.3693" class="difflineplus">+    0,</span>
<a href="#l6.3694"></a><span id="l6.3694" class="difflineplus">+    0,</span>
<a href="#l6.3695"></a><span id="l6.3695" class="difflineplus">+    0,</span>
<a href="#l6.3696"></a><span id="l6.3696" class="difflineplus">+    0,</span>
<a href="#l6.3697"></a><span id="l6.3697" class="difflineplus">+    0,</span>
<a href="#l6.3698"></a><span id="l6.3698" class="difflineplus">+    0,</span>
<a href="#l6.3699"></a><span id="l6.3699" class="difflineplus">+    0,</span>
<a href="#l6.3700"></a><span id="l6.3700" class="difflineplus">+    0,</span>
<a href="#l6.3701"></a><span id="l6.3701" class="difflineplus">+    0,</span>
<a href="#l6.3702"></a><span id="l6.3702" class="difflineplus">+    0,</span>
<a href="#l6.3703"></a><span id="l6.3703" class="difflineplus">+    0,</span>
<a href="#l6.3704"></a><span id="l6.3704" class="difflineplus">+    0,</span>
<a href="#l6.3705"></a><span id="l6.3705" class="difflineplus">+    0,</span>
<a href="#l6.3706"></a><span id="l6.3706" class="difflineplus">+    0,</span>
<a href="#l6.3707"></a><span id="l6.3707" class="difflineplus">+    0,</span>
<a href="#l6.3708"></a><span id="l6.3708" class="difflineplus">+    0,</span>
<a href="#l6.3709"></a><span id="l6.3709" class="difflineplus">+    0,</span>
<a href="#l6.3710"></a><span id="l6.3710" class="difflineplus">+    0,</span>
<a href="#l6.3711"></a><span id="l6.3711" class="difflineplus">+    0,</span>
<a href="#l6.3712"></a><span id="l6.3712" class="difflineplus">+    0,</span>
<a href="#l6.3713"></a><span id="l6.3713" class="difflineplus">+    0,</span>
<a href="#l6.3714"></a><span id="l6.3714" class="difflineplus">+    0,</span>
<a href="#l6.3715"></a><span id="l6.3715" class="difflineplus">+    0,</span>
<a href="#l6.3716"></a><span id="l6.3716" class="difflineplus">+    0,</span>
<a href="#l6.3717"></a><span id="l6.3717" class="difflineplus">+    0,</span>
<a href="#l6.3718"></a><span id="l6.3718" class="difflineplus">+    0,</span>
<a href="#l6.3719"></a><span id="l6.3719" class="difflineplus">+    0,</span>
<a href="#l6.3720"></a><span id="l6.3720" class="difflineplus">+    0,</span>
<a href="#l6.3721"></a><span id="l6.3721" class="difflineplus">+    0,</span>
<a href="#l6.3722"></a><span id="l6.3722" class="difflineplus">+    0,</span>
<a href="#l6.3723"></a><span id="l6.3723" class="difflineplus">+    0,</span>
<a href="#l6.3724"></a><span id="l6.3724" class="difflineplus">+    0,</span>
<a href="#l6.3725"></a><span id="l6.3725" class="difflineplus">+    0,</span>
<a href="#l6.3726"></a><span id="l6.3726" class="difflineplus">+    0,</span>
<a href="#l6.3727"></a><span id="l6.3727" class="difflineplus">+    0,</span>
<a href="#l6.3728"></a><span id="l6.3728" class="difflineplus">+    0,</span>
<a href="#l6.3729"></a><span id="l6.3729" class="difflineplus">+    0,</span>
<a href="#l6.3730"></a><span id="l6.3730" class="difflineplus">+    0,</span>
<a href="#l6.3731"></a><span id="l6.3731" class="difflineplus">+    0,</span>
<a href="#l6.3732"></a><span id="l6.3732" class="difflineplus">+    0,</span>
<a href="#l6.3733"></a><span id="l6.3733" class="difflineplus">+    0,</span>
<a href="#l6.3734"></a><span id="l6.3734" class="difflineplus">+    0,</span>
<a href="#l6.3735"></a><span id="l6.3735" class="difflineplus">+    0,</span>
<a href="#l6.3736"></a><span id="l6.3736" class="difflineplus">+    0,</span>
<a href="#l6.3737"></a><span id="l6.3737" class="difflineplus">+    0,</span>
<a href="#l6.3738"></a><span id="l6.3738" class="difflineplus">+    0,</span>
<a href="#l6.3739"></a><span id="l6.3739" class="difflineplus">+    0,</span>
<a href="#l6.3740"></a><span id="l6.3740" class="difflineplus">+    0,</span>
<a href="#l6.3741"></a><span id="l6.3741" class="difflineplus">+    0,</span>
<a href="#l6.3742"></a><span id="l6.3742" class="difflineplus">+    0,</span>
<a href="#l6.3743"></a><span id="l6.3743" class="difflineplus">+    0,</span>
<a href="#l6.3744"></a><span id="l6.3744" class="difflineplus">+    0,</span>
<a href="#l6.3745"></a><span id="l6.3745" class="difflineplus">+    0,</span>
<a href="#l6.3746"></a><span id="l6.3746" class="difflineplus">+    0,</span>
<a href="#l6.3747"></a><span id="l6.3747" class="difflineplus">+    0,</span>
<a href="#l6.3748"></a><span id="l6.3748" class="difflineplus">+    0,</span>
<a href="#l6.3749"></a><span id="l6.3749" class="difflineplus">+    0,</span>
<a href="#l6.3750"></a><span id="l6.3750" class="difflineplus">+    0,</span>
<a href="#l6.3751"></a><span id="l6.3751" class="difflineplus">+    0,</span>
<a href="#l6.3752"></a><span id="l6.3752" class="difflineplus">+    0,</span>
<a href="#l6.3753"></a><span id="l6.3753" class="difflineplus">+    0,</span>
<a href="#l6.3754"></a><span id="l6.3754" class="difflineplus">+    0,</span>
<a href="#l6.3755"></a><span id="l6.3755" class="difflineplus">+    0,</span>
<a href="#l6.3756"></a><span id="l6.3756" class="difflineplus">+    0,</span>
<a href="#l6.3757"></a><span id="l6.3757" class="difflineplus">+    0,</span>
<a href="#l6.3758"></a><span id="l6.3758" class="difflineplus">+    0,</span>
<a href="#l6.3759"></a><span id="l6.3759" class="difflineplus">+    0,</span>
<a href="#l6.3760"></a><span id="l6.3760" class="difflineplus">+    0,</span>
<a href="#l6.3761"></a><span id="l6.3761" class="difflineplus">+    0,</span>
<a href="#l6.3762"></a><span id="l6.3762" class="difflineplus">+    0,</span>
<a href="#l6.3763"></a><span id="l6.3763" class="difflineplus">+    0,</span>
<a href="#l6.3764"></a><span id="l6.3764" class="difflineplus">+    0,</span>
<a href="#l6.3765"></a><span id="l6.3765" class="difflineplus">+    0,</span>
<a href="#l6.3766"></a><span id="l6.3766" class="difflineplus">+    0,</span>
<a href="#l6.3767"></a><span id="l6.3767" class="difflineplus">+    0,</span>
<a href="#l6.3768"></a><span id="l6.3768" class="difflineplus">+    0,</span>
<a href="#l6.3769"></a><span id="l6.3769" class="difflineplus">+    0,</span>
<a href="#l6.3770"></a><span id="l6.3770" class="difflineplus">+    0,</span>
<a href="#l6.3771"></a><span id="l6.3771" class="difflineplus">+    0,</span>
<a href="#l6.3772"></a><span id="l6.3772" class="difflineplus">+    0,</span>
<a href="#l6.3773"></a><span id="l6.3773" class="difflineplus">+    0,</span>
<a href="#l6.3774"></a><span id="l6.3774" class="difflineplus">+    0,</span>
<a href="#l6.3775"></a><span id="l6.3775" class="difflineplus">+    0,</span>
<a href="#l6.3776"></a><span id="l6.3776" class="difflineplus">+    0,</span>
<a href="#l6.3777"></a><span id="l6.3777" class="difflineplus">+    0,</span>
<a href="#l6.3778"></a><span id="l6.3778" class="difflineplus">+    0,</span>
<a href="#l6.3779"></a><span id="l6.3779" class="difflineplus">+    0,</span>
<a href="#l6.3780"></a><span id="l6.3780" class="difflineplus">+    0,</span>
<a href="#l6.3781"></a><span id="l6.3781" class="difflineplus">+    0,</span>
<a href="#l6.3782"></a><span id="l6.3782" class="difflineplus">+    0,</span>
<a href="#l6.3783"></a><span id="l6.3783" class="difflineplus">+    0,</span>
<a href="#l6.3784"></a><span id="l6.3784" class="difflineplus">+    0,</span>
<a href="#l6.3785"></a><span id="l6.3785" class="difflineplus">+    0,</span>
<a href="#l6.3786"></a><span id="l6.3786" class="difflineplus">+    0,</span>
<a href="#l6.3787"></a><span id="l6.3787" class="difflineplus">+    0,</span>
<a href="#l6.3788"></a><span id="l6.3788" class="difflineplus">+    0,</span>
<a href="#l6.3789"></a><span id="l6.3789" class="difflineplus">+    0,</span>
<a href="#l6.3790"></a><span id="l6.3790" class="difflineplus">+    0,</span>
<a href="#l6.3791"></a><span id="l6.3791" class="difflineplus">+    0,</span>
<a href="#l6.3792"></a><span id="l6.3792" class="difflineplus">+    0,</span>
<a href="#l6.3793"></a><span id="l6.3793" class="difflineplus">+    0,</span>
<a href="#l6.3794"></a><span id="l6.3794" class="difflineplus">+    0,</span>
<a href="#l6.3795"></a><span id="l6.3795" class="difflineplus">+    0,</span>
<a href="#l6.3796"></a><span id="l6.3796" class="difflineplus">+    0,</span>
<a href="#l6.3797"></a><span id="l6.3797" class="difflineplus">+    0,</span>
<a href="#l6.3798"></a><span id="l6.3798" class="difflineplus">+    0,</span>
<a href="#l6.3799"></a><span id="l6.3799" class="difflineplus">+    0,</span>
<a href="#l6.3800"></a><span id="l6.3800" class="difflineplus">+    0,</span>
<a href="#l6.3801"></a><span id="l6.3801" class="difflineplus">+    0,</span>
<a href="#l6.3802"></a><span id="l6.3802" class="difflineplus">+    0,</span>
<a href="#l6.3803"></a><span id="l6.3803" class="difflineplus">+    0,</span>
<a href="#l6.3804"></a><span id="l6.3804" class="difflineplus">+    0,</span>
<a href="#l6.3805"></a><span id="l6.3805" class="difflineplus">+    0,</span>
<a href="#l6.3806"></a><span id="l6.3806" class="difflineplus">+    0,</span>
<a href="#l6.3807"></a><span id="l6.3807" class="difflineplus">+    0,</span>
<a href="#l6.3808"></a><span id="l6.3808" class="difflineplus">+    0,</span>
<a href="#l6.3809"></a><span id="l6.3809" class="difflineplus">+    0,</span>
<a href="#l6.3810"></a><span id="l6.3810" class="difflineplus">+    0,</span>
<a href="#l6.3811"></a><span id="l6.3811" class="difflineplus">+    0,</span>
<a href="#l6.3812"></a><span id="l6.3812" class="difflineplus">+    0,</span>
<a href="#l6.3813"></a><span id="l6.3813" class="difflineplus">+    0,</span>
<a href="#l6.3814"></a><span id="l6.3814" class="difflineplus">+    0,</span>
<a href="#l6.3815"></a><span id="l6.3815" class="difflineplus">+    0,</span>
<a href="#l6.3816"></a><span id="l6.3816" class="difflineplus">+    0,</span>
<a href="#l6.3817"></a><span id="l6.3817" class="difflineplus">+    0,</span>
<a href="#l6.3818"></a><span id="l6.3818" class="difflineplus">+    0,</span>
<a href="#l6.3819"></a><span id="l6.3819" class="difflineplus">+    0,</span>
<a href="#l6.3820"></a><span id="l6.3820" class="difflineplus">+    0,</span>
<a href="#l6.3821"></a><span id="l6.3821" class="difflineplus">+    0,</span>
<a href="#l6.3822"></a><span id="l6.3822" class="difflineplus">+    0,</span>
<a href="#l6.3823"></a><span id="l6.3823" class="difflineplus">+    0,</span>
<a href="#l6.3824"></a><span id="l6.3824" class="difflineplus">+    0,</span>
<a href="#l6.3825"></a><span id="l6.3825" class="difflineplus">+    0,</span>
<a href="#l6.3826"></a><span id="l6.3826" class="difflineplus">+    0,</span>
<a href="#l6.3827"></a><span id="l6.3827" class="difflineplus">+    0,</span>
<a href="#l6.3828"></a><span id="l6.3828" class="difflineplus">+    0,</span>
<a href="#l6.3829"></a><span id="l6.3829" class="difflineplus">+    0,</span>
<a href="#l6.3830"></a><span id="l6.3830" class="difflineplus">+    0,</span>
<a href="#l6.3831"></a><span id="l6.3831" class="difflineplus">+    0,</span>
<a href="#l6.3832"></a><span id="l6.3832" class="difflineplus">+    0,</span>
<a href="#l6.3833"></a><span id="l6.3833" class="difflineplus">+    0,</span>
<a href="#l6.3834"></a><span id="l6.3834" class="difflineplus">+    0,</span>
<a href="#l6.3835"></a><span id="l6.3835" class="difflineplus">+    0,</span>
<a href="#l6.3836"></a><span id="l6.3836" class="difflineplus">+    0,</span>
<a href="#l6.3837"></a><span id="l6.3837" class="difflineplus">+    0,</span>
<a href="#l6.3838"></a><span id="l6.3838" class="difflineplus">+    0,</span>
<a href="#l6.3839"></a><span id="l6.3839" class="difflineplus">+    0,</span>
<a href="#l6.3840"></a><span id="l6.3840" class="difflineplus">+    0,</span>
<a href="#l6.3841"></a><span id="l6.3841" class="difflineplus">+    0,</span>
<a href="#l6.3842"></a><span id="l6.3842" class="difflineplus">+    0,</span>
<a href="#l6.3843"></a><span id="l6.3843" class="difflineplus">+    0,</span>
<a href="#l6.3844"></a><span id="l6.3844" class="difflineplus">+    0,</span>
<a href="#l6.3845"></a><span id="l6.3845" class="difflineplus">+    0,</span>
<a href="#l6.3846"></a><span id="l6.3846" class="difflineplus">+    0,</span>
<a href="#l6.3847"></a><span id="l6.3847" class="difflineplus">+    0,</span>
<a href="#l6.3848"></a><span id="l6.3848" class="difflineplus">+    0,</span>
<a href="#l6.3849"></a><span id="l6.3849" class="difflineplus">+    0,</span>
<a href="#l6.3850"></a><span id="l6.3850" class="difflineplus">+    0,</span>
<a href="#l6.3851"></a><span id="l6.3851" class="difflineplus">+    0,</span>
<a href="#l6.3852"></a><span id="l6.3852" class="difflineplus">+    0,</span>
<a href="#l6.3853"></a><span id="l6.3853" class="difflineplus">+    0,</span>
<a href="#l6.3854"></a><span id="l6.3854" class="difflineplus">+    0,</span>
<a href="#l6.3855"></a><span id="l6.3855" class="difflineplus">+    0,</span>
<a href="#l6.3856"></a><span id="l6.3856" class="difflineplus">+    0,</span>
<a href="#l6.3857"></a><span id="l6.3857" class="difflineplus">+    0,</span>
<a href="#l6.3858"></a><span id="l6.3858" class="difflineplus">+    0,</span>
<a href="#l6.3859"></a><span id="l6.3859" class="difflineplus">+    0,</span>
<a href="#l6.3860"></a><span id="l6.3860" class="difflineplus">+    0,</span>
<a href="#l6.3861"></a><span id="l6.3861" class="difflineplus">+    0,</span>
<a href="#l6.3862"></a><span id="l6.3862" class="difflineplus">+    0,</span>
<a href="#l6.3863"></a><span id="l6.3863" class="difflineplus">+    0,</span>
<a href="#l6.3864"></a><span id="l6.3864" class="difflineplus">+    0,</span>
<a href="#l6.3865"></a><span id="l6.3865" class="difflineplus">+    0,</span>
<a href="#l6.3866"></a><span id="l6.3866" class="difflineplus">+    0,</span>
<a href="#l6.3867"></a><span id="l6.3867" class="difflineplus">+    0,</span>
<a href="#l6.3868"></a><span id="l6.3868" class="difflineplus">+    0,</span>
<a href="#l6.3869"></a><span id="l6.3869" class="difflineplus">+    0,</span>
<a href="#l6.3870"></a><span id="l6.3870" class="difflineplus">+    0,</span>
<a href="#l6.3871"></a><span id="l6.3871" class="difflineplus">+    0,</span>
<a href="#l6.3872"></a><span id="l6.3872" class="difflineplus">+    0,</span>
<a href="#l6.3873"></a><span id="l6.3873" class="difflineplus">+    0,</span>
<a href="#l6.3874"></a><span id="l6.3874" class="difflineplus">+    0,</span>
<a href="#l6.3875"></a><span id="l6.3875" class="difflineplus">+    0,</span>
<a href="#l6.3876"></a><span id="l6.3876" class="difflineplus">+    0,</span>
<a href="#l6.3877"></a><span id="l6.3877" class="difflineplus">+    0,</span>
<a href="#l6.3878"></a><span id="l6.3878" class="difflineplus">+    0,</span>
<a href="#l6.3879"></a><span id="l6.3879" class="difflineplus">+    0,</span>
<a href="#l6.3880"></a><span id="l6.3880" class="difflineplus">+    0,</span>
<a href="#l6.3881"></a><span id="l6.3881" class="difflineplus">+    0,</span>
<a href="#l6.3882"></a><span id="l6.3882" class="difflineplus">+    0,</span>
<a href="#l6.3883"></a><span id="l6.3883" class="difflineplus">+    0,</span>
<a href="#l6.3884"></a><span id="l6.3884" class="difflineplus">+    0,</span>
<a href="#l6.3885"></a><span id="l6.3885" class="difflineplus">+    0,</span>
<a href="#l6.3886"></a><span id="l6.3886" class="difflineplus">+    0,</span>
<a href="#l6.3887"></a><span id="l6.3887" class="difflineplus">+    0,</span>
<a href="#l6.3888"></a><span id="l6.3888" class="difflineplus">+    0,</span>
<a href="#l6.3889"></a><span id="l6.3889" class="difflineplus">+    0,</span>
<a href="#l6.3890"></a><span id="l6.3890" class="difflineplus">+    0,</span>
<a href="#l6.3891"></a><span id="l6.3891" class="difflineplus">+    0,</span>
<a href="#l6.3892"></a><span id="l6.3892" class="difflineplus">+    0,</span>
<a href="#l6.3893"></a><span id="l6.3893" class="difflineplus">+    0,</span>
<a href="#l6.3894"></a><span id="l6.3894" class="difflineplus">+    0,</span>
<a href="#l6.3895"></a><span id="l6.3895" class="difflineplus">+    0,</span>
<a href="#l6.3896"></a><span id="l6.3896" class="difflineplus">+    0,</span>
<a href="#l6.3897"></a><span id="l6.3897" class="difflineplus">+    0,</span>
<a href="#l6.3898"></a><span id="l6.3898" class="difflineplus">+    0,</span>
<a href="#l6.3899"></a><span id="l6.3899" class="difflineplus">+    0,</span>
<a href="#l6.3900"></a><span id="l6.3900" class="difflineplus">+    0,</span>
<a href="#l6.3901"></a><span id="l6.3901" class="difflineplus">+    0,</span>
<a href="#l6.3902"></a><span id="l6.3902" class="difflineplus">+    0,</span>
<a href="#l6.3903"></a><span id="l6.3903" class="difflineplus">+    0,</span>
<a href="#l6.3904"></a><span id="l6.3904" class="difflineplus">+    0,</span>
<a href="#l6.3905"></a><span id="l6.3905" class="difflineplus">+    0,</span>
<a href="#l6.3906"></a><span id="l6.3906" class="difflineplus">+    0,</span>
<a href="#l6.3907"></a><span id="l6.3907" class="difflineplus">+    0,</span>
<a href="#l6.3908"></a><span id="l6.3908" class="difflineplus">+    0,</span>
<a href="#l6.3909"></a><span id="l6.3909" class="difflineplus">+    0,</span>
<a href="#l6.3910"></a><span id="l6.3910" class="difflineplus">+    0,</span>
<a href="#l6.3911"></a><span id="l6.3911" class="difflineplus">+    0,</span>
<a href="#l6.3912"></a><span id="l6.3912" class="difflineplus">+    0,</span>
<a href="#l6.3913"></a><span id="l6.3913" class="difflineplus">+    0,</span>
<a href="#l6.3914"></a><span id="l6.3914" class="difflineplus">+    0,</span>
<a href="#l6.3915"></a><span id="l6.3915" class="difflineplus">+    0,</span>
<a href="#l6.3916"></a><span id="l6.3916" class="difflineplus">+    0,</span>
<a href="#l6.3917"></a><span id="l6.3917" class="difflineplus">+    0,</span>
<a href="#l6.3918"></a><span id="l6.3918" class="difflineplus">+    0,</span>
<a href="#l6.3919"></a><span id="l6.3919" class="difflineplus">+    0,</span>
<a href="#l6.3920"></a><span id="l6.3920" class="difflineplus">+    0,</span>
<a href="#l6.3921"></a><span id="l6.3921" class="difflineplus">+    0,</span>
<a href="#l6.3922"></a><span id="l6.3922" class="difflineplus">+    0,</span>
<a href="#l6.3923"></a><span id="l6.3923" class="difflineplus">+    0,</span>
<a href="#l6.3924"></a><span id="l6.3924" class="difflineplus">+    0,</span>
<a href="#l6.3925"></a><span id="l6.3925" class="difflineplus">+    0,</span>
<a href="#l6.3926"></a><span id="l6.3926" class="difflineplus">+    0,</span>
<a href="#l6.3927"></a><span id="l6.3927" class="difflineplus">+    0,</span>
<a href="#l6.3928"></a><span id="l6.3928" class="difflineplus">+    0,</span>
<a href="#l6.3929"></a><span id="l6.3929" class="difflineplus">+    0,</span>
<a href="#l6.3930"></a><span id="l6.3930" class="difflineplus">+    0,</span>
<a href="#l6.3931"></a><span id="l6.3931" class="difflineplus">+    0,</span>
<a href="#l6.3932"></a><span id="l6.3932" class="difflineplus">+    0,</span>
<a href="#l6.3933"></a><span id="l6.3933" class="difflineplus">+    0,</span>
<a href="#l6.3934"></a><span id="l6.3934" class="difflineplus">+    0,</span>
<a href="#l6.3935"></a><span id="l6.3935" class="difflineplus">+    0,</span>
<a href="#l6.3936"></a><span id="l6.3936" class="difflineplus">+    0,</span>
<a href="#l6.3937"></a><span id="l6.3937" class="difflineplus">+    0,</span>
<a href="#l6.3938"></a><span id="l6.3938" class="difflineplus">+    0,</span>
<a href="#l6.3939"></a><span id="l6.3939" class="difflineplus">+    0,</span>
<a href="#l6.3940"></a><span id="l6.3940" class="difflineplus">+    0,</span>
<a href="#l6.3941"></a><span id="l6.3941" class="difflineplus">+    0,</span>
<a href="#l6.3942"></a><span id="l6.3942" class="difflineplus">+    0,</span>
<a href="#l6.3943"></a><span id="l6.3943" class="difflineplus">+    0,</span>
<a href="#l6.3944"></a><span id="l6.3944" class="difflineplus">+    0,</span>
<a href="#l6.3945"></a><span id="l6.3945" class="difflineplus">+    0,</span>
<a href="#l6.3946"></a><span id="l6.3946" class="difflineplus">+    0,</span>
<a href="#l6.3947"></a><span id="l6.3947" class="difflineplus">+    0,</span>
<a href="#l6.3948"></a><span id="l6.3948" class="difflineplus">+    0,</span>
<a href="#l6.3949"></a><span id="l6.3949" class="difflineplus">+    0,</span>
<a href="#l6.3950"></a><span id="l6.3950" class="difflineplus">+    0,</span>
<a href="#l6.3951"></a><span id="l6.3951" class="difflineplus">+    0,</span>
<a href="#l6.3952"></a><span id="l6.3952" class="difflineplus">+    0,</span>
<a href="#l6.3953"></a><span id="l6.3953" class="difflineplus">+    0,</span>
<a href="#l6.3954"></a><span id="l6.3954" class="difflineplus">+    0,</span>
<a href="#l6.3955"></a><span id="l6.3955" class="difflineplus">+    0,</span>
<a href="#l6.3956"></a><span id="l6.3956" class="difflineplus">+    0,</span>
<a href="#l6.3957"></a><span id="l6.3957" class="difflineplus">+    0,</span>
<a href="#l6.3958"></a><span id="l6.3958" class="difflineplus">+    0,</span>
<a href="#l6.3959"></a><span id="l6.3959" class="difflineplus">+    0,</span>
<a href="#l6.3960"></a><span id="l6.3960" class="difflineplus">+    0,</span>
<a href="#l6.3961"></a><span id="l6.3961" class="difflineplus">+    0,</span>
<a href="#l6.3962"></a><span id="l6.3962" class="difflineplus">+    0,</span>
<a href="#l6.3963"></a><span id="l6.3963" class="difflineplus">+    0,</span>
<a href="#l6.3964"></a><span id="l6.3964" class="difflineplus">+    0,</span>
<a href="#l6.3965"></a><span id="l6.3965" class="difflineplus">+    0,</span>
<a href="#l6.3966"></a><span id="l6.3966" class="difflineplus">+    0,</span>
<a href="#l6.3967"></a><span id="l6.3967" class="difflineplus">+    0,</span>
<a href="#l6.3968"></a><span id="l6.3968" class="difflineplus">+    0,</span>
<a href="#l6.3969"></a><span id="l6.3969" class="difflineplus">+    0,</span>
<a href="#l6.3970"></a><span id="l6.3970" class="difflineplus">+    0,</span>
<a href="#l6.3971"></a><span id="l6.3971" class="difflineplus">+    0,</span>
<a href="#l6.3972"></a><span id="l6.3972" class="difflineplus">+    0,</span>
<a href="#l6.3973"></a><span id="l6.3973" class="difflineplus">+    0,</span>
<a href="#l6.3974"></a><span id="l6.3974" class="difflineplus">+    0,</span>
<a href="#l6.3975"></a><span id="l6.3975" class="difflineplus">+    gNormalizeTablea640,</span>
<a href="#l6.3976"></a><span id="l6.3976" class="difflineplus">+    gNormalizeTablea680,</span>
<a href="#l6.3977"></a><span id="l6.3977" class="difflineplus">+    0,</span>
<a href="#l6.3978"></a><span id="l6.3978" class="difflineplus">+    gNormalizeTablea700,</span>
<a href="#l6.3979"></a><span id="l6.3979" class="difflineplus">+    gNormalizeTablea740,</span>
<a href="#l6.3980"></a><span id="l6.3980" class="difflineplus">+    gNormalizeTablea780,</span>
<a href="#l6.3981"></a><span id="l6.3981" class="difflineplus">+    0,</span>
<a href="#l6.3982"></a><span id="l6.3982" class="difflineplus">+    0,</span>
<a href="#l6.3983"></a><span id="l6.3983" class="difflineplus">+    0,</span>
<a href="#l6.3984"></a><span id="l6.3984" class="difflineplus">+    0,</span>
<a href="#l6.3985"></a><span id="l6.3985" class="difflineplus">+    0,</span>
<a href="#l6.3986"></a><span id="l6.3986" class="difflineplus">+    0,</span>
<a href="#l6.3987"></a><span id="l6.3987" class="difflineplus">+    0,</span>
<a href="#l6.3988"></a><span id="l6.3988" class="difflineplus">+    0,</span>
<a href="#l6.3989"></a><span id="l6.3989" class="difflineplus">+    0,</span>
<a href="#l6.3990"></a><span id="l6.3990" class="difflineplus">+    0,</span>
<a href="#l6.3991"></a><span id="l6.3991" class="difflineplus">+    0,</span>
<a href="#l6.3992"></a><span id="l6.3992" class="difflineplus">+    0,</span>
<a href="#l6.3993"></a><span id="l6.3993" class="difflineplus">+    0,</span>
<a href="#l6.3994"></a><span id="l6.3994" class="difflineplus">+    0,</span>
<a href="#l6.3995"></a><span id="l6.3995" class="difflineplus">+    0,</span>
<a href="#l6.3996"></a><span id="l6.3996" class="difflineplus">+    0,</span>
<a href="#l6.3997"></a><span id="l6.3997" class="difflineplus">+    0,</span>
<a href="#l6.3998"></a><span id="l6.3998" class="difflineplus">+    0,</span>
<a href="#l6.3999"></a><span id="l6.3999" class="difflineplus">+    0,</span>
<a href="#l6.4000"></a><span id="l6.4000" class="difflineplus">+    0,</span>
<a href="#l6.4001"></a><span id="l6.4001" class="difflineplus">+    0,</span>
<a href="#l6.4002"></a><span id="l6.4002" class="difflineplus">+    0,</span>
<a href="#l6.4003"></a><span id="l6.4003" class="difflineplus">+    0,</span>
<a href="#l6.4004"></a><span id="l6.4004" class="difflineplus">+    0,</span>
<a href="#l6.4005"></a><span id="l6.4005" class="difflineplus">+    0,</span>
<a href="#l6.4006"></a><span id="l6.4006" class="difflineplus">+    0,</span>
<a href="#l6.4007"></a><span id="l6.4007" class="difflineplus">+    0,</span>
<a href="#l6.4008"></a><span id="l6.4008" class="difflineplus">+    0,</span>
<a href="#l6.4009"></a><span id="l6.4009" class="difflineplus">+    0,</span>
<a href="#l6.4010"></a><span id="l6.4010" class="difflineplus">+    0,</span>
<a href="#l6.4011"></a><span id="l6.4011" class="difflineplus">+    0,</span>
<a href="#l6.4012"></a><span id="l6.4012" class="difflineplus">+    0,</span>
<a href="#l6.4013"></a><span id="l6.4013" class="difflineplus">+    0,</span>
<a href="#l6.4014"></a><span id="l6.4014" class="difflineplus">+    0,</span>
<a href="#l6.4015"></a><span id="l6.4015" class="difflineplus">+    0,</span>
<a href="#l6.4016"></a><span id="l6.4016" class="difflineplus">+    0,</span>
<a href="#l6.4017"></a><span id="l6.4017" class="difflineplus">+    0,</span>
<a href="#l6.4018"></a><span id="l6.4018" class="difflineplus">+    0,</span>
<a href="#l6.4019"></a><span id="l6.4019" class="difflineplus">+    0,</span>
<a href="#l6.4020"></a><span id="l6.4020" class="difflineplus">+    0,</span>
<a href="#l6.4021"></a><span id="l6.4021" class="difflineplus">+    0,</span>
<a href="#l6.4022"></a><span id="l6.4022" class="difflineplus">+    0,</span>
<a href="#l6.4023"></a><span id="l6.4023" class="difflineplus">+    0,</span>
<a href="#l6.4024"></a><span id="l6.4024" class="difflineplus">+    0,</span>
<a href="#l6.4025"></a><span id="l6.4025" class="difflineplus">+    0,</span>
<a href="#l6.4026"></a><span id="l6.4026" class="difflineplus">+    0,</span>
<a href="#l6.4027"></a><span id="l6.4027" class="difflineplus">+    0,</span>
<a href="#l6.4028"></a><span id="l6.4028" class="difflineplus">+    0,</span>
<a href="#l6.4029"></a><span id="l6.4029" class="difflineplus">+    0,</span>
<a href="#l6.4030"></a><span id="l6.4030" class="difflineplus">+    0,</span>
<a href="#l6.4031"></a><span id="l6.4031" class="difflineplus">+    0,</span>
<a href="#l6.4032"></a><span id="l6.4032" class="difflineplus">+    0,</span>
<a href="#l6.4033"></a><span id="l6.4033" class="difflineplus">+    0,</span>
<a href="#l6.4034"></a><span id="l6.4034" class="difflineplus">+    0,</span>
<a href="#l6.4035"></a><span id="l6.4035" class="difflineplus">+    0,</span>
<a href="#l6.4036"></a><span id="l6.4036" class="difflineplus">+    0,</span>
<a href="#l6.4037"></a><span id="l6.4037" class="difflineplus">+    0,</span>
<a href="#l6.4038"></a><span id="l6.4038" class="difflineplus">+    0,</span>
<a href="#l6.4039"></a><span id="l6.4039" class="difflineplus">+    0,</span>
<a href="#l6.4040"></a><span id="l6.4040" class="difflineplus">+    0,</span>
<a href="#l6.4041"></a><span id="l6.4041" class="difflineplus">+    0,</span>
<a href="#l6.4042"></a><span id="l6.4042" class="difflineplus">+    0,</span>
<a href="#l6.4043"></a><span id="l6.4043" class="difflineplus">+    0,</span>
<a href="#l6.4044"></a><span id="l6.4044" class="difflineplus">+    0,</span>
<a href="#l6.4045"></a><span id="l6.4045" class="difflineplus">+    0,</span>
<a href="#l6.4046"></a><span id="l6.4046" class="difflineplus">+    0,</span>
<a href="#l6.4047"></a><span id="l6.4047" class="difflineplus">+    0,</span>
<a href="#l6.4048"></a><span id="l6.4048" class="difflineplus">+    0,</span>
<a href="#l6.4049"></a><span id="l6.4049" class="difflineplus">+    0,</span>
<a href="#l6.4050"></a><span id="l6.4050" class="difflineplus">+    0,</span>
<a href="#l6.4051"></a><span id="l6.4051" class="difflineplus">+    0,</span>
<a href="#l6.4052"></a><span id="l6.4052" class="difflineplus">+    0,</span>
<a href="#l6.4053"></a><span id="l6.4053" class="difflineplus">+    0,</span>
<a href="#l6.4054"></a><span id="l6.4054" class="difflineplus">+    0,</span>
<a href="#l6.4055"></a><span id="l6.4055" class="difflineplus">+    0,</span>
<a href="#l6.4056"></a><span id="l6.4056" class="difflineplus">+    0,</span>
<a href="#l6.4057"></a><span id="l6.4057" class="difflineplus">+    0,</span>
<a href="#l6.4058"></a><span id="l6.4058" class="difflineplus">+    0,</span>
<a href="#l6.4059"></a><span id="l6.4059" class="difflineplus">+    0,</span>
<a href="#l6.4060"></a><span id="l6.4060" class="difflineplus">+    0,</span>
<a href="#l6.4061"></a><span id="l6.4061" class="difflineplus">+    0,</span>
<a href="#l6.4062"></a><span id="l6.4062" class="difflineplus">+    0,</span>
<a href="#l6.4063"></a><span id="l6.4063" class="difflineplus">+    0,</span>
<a href="#l6.4064"></a><span id="l6.4064" class="difflineplus">+    0,</span>
<a href="#l6.4065"></a><span id="l6.4065" class="difflineplus">+    0,</span>
<a href="#l6.4066"></a><span id="l6.4066" class="difflineplus">+    0,</span>
<a href="#l6.4067"></a><span id="l6.4067" class="difflineplus">+    0,</span>
<a href="#l6.4068"></a><span id="l6.4068" class="difflineplus">+    0,</span>
<a href="#l6.4069"></a><span id="l6.4069" class="difflineplus">+    0,</span>
<a href="#l6.4070"></a><span id="l6.4070" class="difflineplus">+    0,</span>
<a href="#l6.4071"></a><span id="l6.4071" class="difflineplus">+    0,</span>
<a href="#l6.4072"></a><span id="l6.4072" class="difflineplus">+    0,</span>
<a href="#l6.4073"></a><span id="l6.4073" class="difflineplus">+    0,</span>
<a href="#l6.4074"></a><span id="l6.4074" class="difflineplus">+    0,</span>
<a href="#l6.4075"></a><span id="l6.4075" class="difflineplus">+    0,</span>
<a href="#l6.4076"></a><span id="l6.4076" class="difflineplus">+    0,</span>
<a href="#l6.4077"></a><span id="l6.4077" class="difflineplus">+    0,</span>
<a href="#l6.4078"></a><span id="l6.4078" class="difflineplus">+    0,</span>
<a href="#l6.4079"></a><span id="l6.4079" class="difflineplus">+    0,</span>
<a href="#l6.4080"></a><span id="l6.4080" class="difflineplus">+    0,</span>
<a href="#l6.4081"></a><span id="l6.4081" class="difflineplus">+    0,</span>
<a href="#l6.4082"></a><span id="l6.4082" class="difflineplus">+    0,</span>
<a href="#l6.4083"></a><span id="l6.4083" class="difflineplus">+    0,</span>
<a href="#l6.4084"></a><span id="l6.4084" class="difflineplus">+    0,</span>
<a href="#l6.4085"></a><span id="l6.4085" class="difflineplus">+    0,</span>
<a href="#l6.4086"></a><span id="l6.4086" class="difflineplus">+    0,</span>
<a href="#l6.4087"></a><span id="l6.4087" class="difflineplus">+    0,</span>
<a href="#l6.4088"></a><span id="l6.4088" class="difflineplus">+    0,</span>
<a href="#l6.4089"></a><span id="l6.4089" class="difflineplus">+    0,</span>
<a href="#l6.4090"></a><span id="l6.4090" class="difflineplus">+    0,</span>
<a href="#l6.4091"></a><span id="l6.4091" class="difflineplus">+    0,</span>
<a href="#l6.4092"></a><span id="l6.4092" class="difflineplus">+    0,</span>
<a href="#l6.4093"></a><span id="l6.4093" class="difflineplus">+    0,</span>
<a href="#l6.4094"></a><span id="l6.4094" class="difflineplus">+    0,</span>
<a href="#l6.4095"></a><span id="l6.4095" class="difflineplus">+    0,</span>
<a href="#l6.4096"></a><span id="l6.4096" class="difflineplus">+    0,</span>
<a href="#l6.4097"></a><span id="l6.4097" class="difflineplus">+    0,</span>
<a href="#l6.4098"></a><span id="l6.4098" class="difflineplus">+    0,</span>
<a href="#l6.4099"></a><span id="l6.4099" class="difflineplus">+    0,</span>
<a href="#l6.4100"></a><span id="l6.4100" class="difflineplus">+    0,</span>
<a href="#l6.4101"></a><span id="l6.4101" class="difflineplus">+    0,</span>
<a href="#l6.4102"></a><span id="l6.4102" class="difflineplus">+    0,</span>
<a href="#l6.4103"></a><span id="l6.4103" class="difflineplus">+    0,</span>
<a href="#l6.4104"></a><span id="l6.4104" class="difflineplus">+    0,</span>
<a href="#l6.4105"></a><span id="l6.4105" class="difflineplus">+    0,</span>
<a href="#l6.4106"></a><span id="l6.4106" class="difflineplus">+    0,</span>
<a href="#l6.4107"></a><span id="l6.4107" class="difflineplus">+    0,</span>
<a href="#l6.4108"></a><span id="l6.4108" class="difflineplus">+    0,</span>
<a href="#l6.4109"></a><span id="l6.4109" class="difflineplus">+    0,</span>
<a href="#l6.4110"></a><span id="l6.4110" class="difflineplus">+    0,</span>
<a href="#l6.4111"></a><span id="l6.4111" class="difflineplus">+    0,</span>
<a href="#l6.4112"></a><span id="l6.4112" class="difflineplus">+    0,</span>
<a href="#l6.4113"></a><span id="l6.4113" class="difflineplus">+    0,</span>
<a href="#l6.4114"></a><span id="l6.4114" class="difflineplus">+    0,</span>
<a href="#l6.4115"></a><span id="l6.4115" class="difflineplus">+    0,</span>
<a href="#l6.4116"></a><span id="l6.4116" class="difflineplus">+    0,</span>
<a href="#l6.4117"></a><span id="l6.4117" class="difflineplus">+    0,</span>
<a href="#l6.4118"></a><span id="l6.4118" class="difflineplus">+    0,</span>
<a href="#l6.4119"></a><span id="l6.4119" class="difflineplus">+    0,</span>
<a href="#l6.4120"></a><span id="l6.4120" class="difflineplus">+    0,</span>
<a href="#l6.4121"></a><span id="l6.4121" class="difflineplus">+    0,</span>
<a href="#l6.4122"></a><span id="l6.4122" class="difflineplus">+    0,</span>
<a href="#l6.4123"></a><span id="l6.4123" class="difflineplus">+    0,</span>
<a href="#l6.4124"></a><span id="l6.4124" class="difflineplus">+    0,</span>
<a href="#l6.4125"></a><span id="l6.4125" class="difflineplus">+    0,</span>
<a href="#l6.4126"></a><span id="l6.4126" class="difflineplus">+    0,</span>
<a href="#l6.4127"></a><span id="l6.4127" class="difflineplus">+    0,</span>
<a href="#l6.4128"></a><span id="l6.4128" class="difflineplus">+    0,</span>
<a href="#l6.4129"></a><span id="l6.4129" class="difflineplus">+    0,</span>
<a href="#l6.4130"></a><span id="l6.4130" class="difflineplus">+    0,</span>
<a href="#l6.4131"></a><span id="l6.4131" class="difflineplus">+    0,</span>
<a href="#l6.4132"></a><span id="l6.4132" class="difflineplus">+    0,</span>
<a href="#l6.4133"></a><span id="l6.4133" class="difflineplus">+    0,</span>
<a href="#l6.4134"></a><span id="l6.4134" class="difflineplus">+    0,</span>
<a href="#l6.4135"></a><span id="l6.4135" class="difflineplus">+    0,</span>
<a href="#l6.4136"></a><span id="l6.4136" class="difflineplus">+    0,</span>
<a href="#l6.4137"></a><span id="l6.4137" class="difflineplus">+    0,</span>
<a href="#l6.4138"></a><span id="l6.4138" class="difflineplus">+    0,</span>
<a href="#l6.4139"></a><span id="l6.4139" class="difflineplus">+    0,</span>
<a href="#l6.4140"></a><span id="l6.4140" class="difflineplus">+    0,</span>
<a href="#l6.4141"></a><span id="l6.4141" class="difflineplus">+    0,</span>
<a href="#l6.4142"></a><span id="l6.4142" class="difflineplus">+    0,</span>
<a href="#l6.4143"></a><span id="l6.4143" class="difflineplus">+    0,</span>
<a href="#l6.4144"></a><span id="l6.4144" class="difflineplus">+    0,</span>
<a href="#l6.4145"></a><span id="l6.4145" class="difflineplus">+    0,</span>
<a href="#l6.4146"></a><span id="l6.4146" class="difflineplus">+    0,</span>
<a href="#l6.4147"></a><span id="l6.4147" class="difflineplus">+    0,</span>
<a href="#l6.4148"></a><span id="l6.4148" class="difflineplus">+    0,</span>
<a href="#l6.4149"></a><span id="l6.4149" class="difflineplus">+    0,</span>
<a href="#l6.4150"></a><span id="l6.4150" class="difflineplus">+    0,</span>
<a href="#l6.4151"></a><span id="l6.4151" class="difflineplus">+    0,</span>
<a href="#l6.4152"></a><span id="l6.4152" class="difflineplus">+    0,</span>
<a href="#l6.4153"></a><span id="l6.4153" class="difflineplus">+    0,</span>
<a href="#l6.4154"></a><span id="l6.4154" class="difflineplus">+    0,</span>
<a href="#l6.4155"></a><span id="l6.4155" class="difflineplus">+    0,</span>
<a href="#l6.4156"></a><span id="l6.4156" class="difflineplus">+    0,</span>
<a href="#l6.4157"></a><span id="l6.4157" class="difflineplus">+    0,</span>
<a href="#l6.4158"></a><span id="l6.4158" class="difflineplus">+    0,</span>
<a href="#l6.4159"></a><span id="l6.4159" class="difflineplus">+    0,</span>
<a href="#l6.4160"></a><span id="l6.4160" class="difflineplus">+    0,</span>
<a href="#l6.4161"></a><span id="l6.4161" class="difflineplus">+    0,</span>
<a href="#l6.4162"></a><span id="l6.4162" class="difflineplus">+    0,</span>
<a href="#l6.4163"></a><span id="l6.4163" class="difflineplus">+    0,</span>
<a href="#l6.4164"></a><span id="l6.4164" class="difflineplus">+    0,</span>
<a href="#l6.4165"></a><span id="l6.4165" class="difflineplus">+    0,</span>
<a href="#l6.4166"></a><span id="l6.4166" class="difflineplus">+    0,</span>
<a href="#l6.4167"></a><span id="l6.4167" class="difflineplus">+    0,</span>
<a href="#l6.4168"></a><span id="l6.4168" class="difflineplus">+    0,</span>
<a href="#l6.4169"></a><span id="l6.4169" class="difflineplus">+    0,</span>
<a href="#l6.4170"></a><span id="l6.4170" class="difflineplus">+    0,</span>
<a href="#l6.4171"></a><span id="l6.4171" class="difflineplus">+    0,</span>
<a href="#l6.4172"></a><span id="l6.4172" class="difflineplus">+    0,</span>
<a href="#l6.4173"></a><span id="l6.4173" class="difflineplus">+    0,</span>
<a href="#l6.4174"></a><span id="l6.4174" class="difflineplus">+    0,</span>
<a href="#l6.4175"></a><span id="l6.4175" class="difflineplus">+    0,</span>
<a href="#l6.4176"></a><span id="l6.4176" class="difflineplus">+    0,</span>
<a href="#l6.4177"></a><span id="l6.4177" class="difflineplus">+    0,</span>
<a href="#l6.4178"></a><span id="l6.4178" class="difflineplus">+    0,</span>
<a href="#l6.4179"></a><span id="l6.4179" class="difflineplus">+    0,</span>
<a href="#l6.4180"></a><span id="l6.4180" class="difflineplus">+    0,</span>
<a href="#l6.4181"></a><span id="l6.4181" class="difflineplus">+    0,</span>
<a href="#l6.4182"></a><span id="l6.4182" class="difflineplus">+    0,</span>
<a href="#l6.4183"></a><span id="l6.4183" class="difflineplus">+    0,</span>
<a href="#l6.4184"></a><span id="l6.4184" class="difflineplus">+    0,</span>
<a href="#l6.4185"></a><span id="l6.4185" class="difflineplus">+    0,</span>
<a href="#l6.4186"></a><span id="l6.4186" class="difflineplus">+    0,</span>
<a href="#l6.4187"></a><span id="l6.4187" class="difflineplus">+    0,</span>
<a href="#l6.4188"></a><span id="l6.4188" class="difflineplus">+    0,</span>
<a href="#l6.4189"></a><span id="l6.4189" class="difflineplus">+    0,</span>
<a href="#l6.4190"></a><span id="l6.4190" class="difflineplus">+    0,</span>
<a href="#l6.4191"></a><span id="l6.4191" class="difflineplus">+    0,</span>
<a href="#l6.4192"></a><span id="l6.4192" class="difflineplus">+    0,</span>
<a href="#l6.4193"></a><span id="l6.4193" class="difflineplus">+    0,</span>
<a href="#l6.4194"></a><span id="l6.4194" class="difflineplus">+    0,</span>
<a href="#l6.4195"></a><span id="l6.4195" class="difflineplus">+    0,</span>
<a href="#l6.4196"></a><span id="l6.4196" class="difflineplus">+    0,</span>
<a href="#l6.4197"></a><span id="l6.4197" class="difflineplus">+    0,</span>
<a href="#l6.4198"></a><span id="l6.4198" class="difflineplus">+    0,</span>
<a href="#l6.4199"></a><span id="l6.4199" class="difflineplus">+    0,</span>
<a href="#l6.4200"></a><span id="l6.4200" class="difflineplus">+    0,</span>
<a href="#l6.4201"></a><span id="l6.4201" class="difflineplus">+    0,</span>
<a href="#l6.4202"></a><span id="l6.4202" class="difflineplus">+    0,</span>
<a href="#l6.4203"></a><span id="l6.4203" class="difflineplus">+    0,</span>
<a href="#l6.4204"></a><span id="l6.4204" class="difflineplus">+    0,</span>
<a href="#l6.4205"></a><span id="l6.4205" class="difflineplus">+    0,</span>
<a href="#l6.4206"></a><span id="l6.4206" class="difflineplus">+    0,</span>
<a href="#l6.4207"></a><span id="l6.4207" class="difflineplus">+    0,</span>
<a href="#l6.4208"></a><span id="l6.4208" class="difflineplus">+    0,</span>
<a href="#l6.4209"></a><span id="l6.4209" class="difflineplus">+    0,</span>
<a href="#l6.4210"></a><span id="l6.4210" class="difflineplus">+    0,</span>
<a href="#l6.4211"></a><span id="l6.4211" class="difflineplus">+    0,</span>
<a href="#l6.4212"></a><span id="l6.4212" class="difflineplus">+    0,</span>
<a href="#l6.4213"></a><span id="l6.4213" class="difflineplus">+    0,</span>
<a href="#l6.4214"></a><span id="l6.4214" class="difflineplus">+    0,</span>
<a href="#l6.4215"></a><span id="l6.4215" class="difflineplus">+    0,</span>
<a href="#l6.4216"></a><span id="l6.4216" class="difflineplus">+    0,</span>
<a href="#l6.4217"></a><span id="l6.4217" class="difflineplus">+    0,</span>
<a href="#l6.4218"></a><span id="l6.4218" class="difflineplus">+    0,</span>
<a href="#l6.4219"></a><span id="l6.4219" class="difflineplus">+    0,</span>
<a href="#l6.4220"></a><span id="l6.4220" class="difflineplus">+    0,</span>
<a href="#l6.4221"></a><span id="l6.4221" class="difflineplus">+    0,</span>
<a href="#l6.4222"></a><span id="l6.4222" class="difflineplus">+    0,</span>
<a href="#l6.4223"></a><span id="l6.4223" class="difflineplus">+    0,</span>
<a href="#l6.4224"></a><span id="l6.4224" class="difflineplus">+    0,</span>
<a href="#l6.4225"></a><span id="l6.4225" class="difflineplus">+    0,</span>
<a href="#l6.4226"></a><span id="l6.4226" class="difflineplus">+    0,</span>
<a href="#l6.4227"></a><span id="l6.4227" class="difflineplus">+    0,</span>
<a href="#l6.4228"></a><span id="l6.4228" class="difflineplus">+    0,</span>
<a href="#l6.4229"></a><span id="l6.4229" class="difflineplus">+    0,</span>
<a href="#l6.4230"></a><span id="l6.4230" class="difflineplus">+    0,</span>
<a href="#l6.4231"></a><span id="l6.4231" class="difflineplus">+    0,</span>
<a href="#l6.4232"></a><span id="l6.4232" class="difflineplus">+    0,</span>
<a href="#l6.4233"></a><span id="l6.4233" class="difflineplus">+    0,</span>
<a href="#l6.4234"></a><span id="l6.4234" class="difflineplus">+    0,</span>
<a href="#l6.4235"></a><span id="l6.4235" class="difflineplus">+    0,</span>
<a href="#l6.4236"></a><span id="l6.4236" class="difflineplus">+    0,</span>
<a href="#l6.4237"></a><span id="l6.4237" class="difflineplus">+    0,</span>
<a href="#l6.4238"></a><span id="l6.4238" class="difflineplus">+    0,</span>
<a href="#l6.4239"></a><span id="l6.4239" class="difflineplus">+    0,</span>
<a href="#l6.4240"></a><span id="l6.4240" class="difflineplus">+    0,</span>
<a href="#l6.4241"></a><span id="l6.4241" class="difflineplus">+    0,</span>
<a href="#l6.4242"></a><span id="l6.4242" class="difflineplus">+    0,</span>
<a href="#l6.4243"></a><span id="l6.4243" class="difflineplus">+    0,</span>
<a href="#l6.4244"></a><span id="l6.4244" class="difflineplus">+    0,</span>
<a href="#l6.4245"></a><span id="l6.4245" class="difflineplus">+    0,</span>
<a href="#l6.4246"></a><span id="l6.4246" class="difflineplus">+    0,</span>
<a href="#l6.4247"></a><span id="l6.4247" class="difflineplus">+    0,</span>
<a href="#l6.4248"></a><span id="l6.4248" class="difflineplus">+    0,</span>
<a href="#l6.4249"></a><span id="l6.4249" class="difflineplus">+    0,</span>
<a href="#l6.4250"></a><span id="l6.4250" class="difflineplus">+    0,</span>
<a href="#l6.4251"></a><span id="l6.4251" class="difflineplus">+    0,</span>
<a href="#l6.4252"></a><span id="l6.4252" class="difflineplus">+    0,</span>
<a href="#l6.4253"></a><span id="l6.4253" class="difflineplus">+    0,</span>
<a href="#l6.4254"></a><span id="l6.4254" class="difflineplus">+    0,</span>
<a href="#l6.4255"></a><span id="l6.4255" class="difflineplus">+    0,</span>
<a href="#l6.4256"></a><span id="l6.4256" class="difflineplus">+    0,</span>
<a href="#l6.4257"></a><span id="l6.4257" class="difflineplus">+    0,</span>
<a href="#l6.4258"></a><span id="l6.4258" class="difflineplus">+    0,</span>
<a href="#l6.4259"></a><span id="l6.4259" class="difflineplus">+    0,</span>
<a href="#l6.4260"></a><span id="l6.4260" class="difflineplus">+    0,</span>
<a href="#l6.4261"></a><span id="l6.4261" class="difflineplus">+    0,</span>
<a href="#l6.4262"></a><span id="l6.4262" class="difflineplus">+    0,</span>
<a href="#l6.4263"></a><span id="l6.4263" class="difflineplus">+    0,</span>
<a href="#l6.4264"></a><span id="l6.4264" class="difflineplus">+    0,</span>
<a href="#l6.4265"></a><span id="l6.4265" class="difflineplus">+    0,</span>
<a href="#l6.4266"></a><span id="l6.4266" class="difflineplus">+    0,</span>
<a href="#l6.4267"></a><span id="l6.4267" class="difflineplus">+    0,</span>
<a href="#l6.4268"></a><span id="l6.4268" class="difflineplus">+    0,</span>
<a href="#l6.4269"></a><span id="l6.4269" class="difflineplus">+    0,</span>
<a href="#l6.4270"></a><span id="l6.4270" class="difflineplus">+    0,</span>
<a href="#l6.4271"></a><span id="l6.4271" class="difflineplus">+    0,</span>
<a href="#l6.4272"></a><span id="l6.4272" class="difflineplus">+    0,</span>
<a href="#l6.4273"></a><span id="l6.4273" class="difflineplus">+    0,</span>
<a href="#l6.4274"></a><span id="l6.4274" class="difflineplus">+    0,</span>
<a href="#l6.4275"></a><span id="l6.4275" class="difflineplus">+    0,</span>
<a href="#l6.4276"></a><span id="l6.4276" class="difflineplus">+    0,</span>
<a href="#l6.4277"></a><span id="l6.4277" class="difflineplus">+    0,</span>
<a href="#l6.4278"></a><span id="l6.4278" class="difflineplus">+    0,</span>
<a href="#l6.4279"></a><span id="l6.4279" class="difflineplus">+    0,</span>
<a href="#l6.4280"></a><span id="l6.4280" class="difflineplus">+    0,</span>
<a href="#l6.4281"></a><span id="l6.4281" class="difflineplus">+    0,</span>
<a href="#l6.4282"></a><span id="l6.4282" class="difflineplus">+    0,</span>
<a href="#l6.4283"></a><span id="l6.4283" class="difflineplus">+    0,</span>
<a href="#l6.4284"></a><span id="l6.4284" class="difflineplus">+    0,</span>
<a href="#l6.4285"></a><span id="l6.4285" class="difflineplus">+    0,</span>
<a href="#l6.4286"></a><span id="l6.4286" class="difflineplus">+    0,</span>
<a href="#l6.4287"></a><span id="l6.4287" class="difflineplus">+    0,</span>
<a href="#l6.4288"></a><span id="l6.4288" class="difflineplus">+    0,</span>
<a href="#l6.4289"></a><span id="l6.4289" class="difflineplus">+    0,</span>
<a href="#l6.4290"></a><span id="l6.4290" class="difflineplus">+    0,</span>
<a href="#l6.4291"></a><span id="l6.4291" class="difflineplus">+    0,</span>
<a href="#l6.4292"></a><span id="l6.4292" class="difflineplus">+    0,</span>
<a href="#l6.4293"></a><span id="l6.4293" class="difflineplus">+    0,</span>
<a href="#l6.4294"></a><span id="l6.4294" class="difflineplus">+    0,</span>
<a href="#l6.4295"></a><span id="l6.4295" class="difflineplus">+    0,</span>
<a href="#l6.4296"></a><span id="l6.4296" class="difflineplus">+    0,</span>
<a href="#l6.4297"></a><span id="l6.4297" class="difflineplus">+    0,</span>
<a href="#l6.4298"></a><span id="l6.4298" class="difflineplus">+    0,</span>
<a href="#l6.4299"></a><span id="l6.4299" class="difflineplus">+    0,</span>
<a href="#l6.4300"></a><span id="l6.4300" class="difflineplus">+    0,</span>
<a href="#l6.4301"></a><span id="l6.4301" class="difflineplus">+    0,</span>
<a href="#l6.4302"></a><span id="l6.4302" class="difflineplus">+    0,</span>
<a href="#l6.4303"></a><span id="l6.4303" class="difflineplus">+    0,</span>
<a href="#l6.4304"></a><span id="l6.4304" class="difflineplus">+    0,</span>
<a href="#l6.4305"></a><span id="l6.4305" class="difflineplus">+    0,</span>
<a href="#l6.4306"></a><span id="l6.4306" class="difflineplus">+    gNormalizeTablef900,</span>
<a href="#l6.4307"></a><span id="l6.4307" class="difflineplus">+    gNormalizeTablef940,</span>
<a href="#l6.4308"></a><span id="l6.4308" class="difflineplus">+    gNormalizeTablef980,</span>
<a href="#l6.4309"></a><span id="l6.4309" class="difflineplus">+    gNormalizeTablef9c0,</span>
<a href="#l6.4310"></a><span id="l6.4310" class="difflineplus">+    gNormalizeTablefa00,</span>
<a href="#l6.4311"></a><span id="l6.4311" class="difflineplus">+    gNormalizeTablefa40,</span>
<a href="#l6.4312"></a><span id="l6.4312" class="difflineplus">+    gNormalizeTablefa80,</span>
<a href="#l6.4313"></a><span id="l6.4313" class="difflineplus">+    gNormalizeTablefac0,</span>
<a href="#l6.4314"></a><span id="l6.4314" class="difflineplus">+    gNormalizeTablefb00,</span>
<a href="#l6.4315"></a><span id="l6.4315" class="difflineplus">+    gNormalizeTablefb40,</span>
<a href="#l6.4316"></a><span id="l6.4316" class="difflineplus">+    gNormalizeTablefb80,</span>
<a href="#l6.4317"></a><span id="l6.4317" class="difflineplus">+    gNormalizeTablefbc0,</span>
<a href="#l6.4318"></a><span id="l6.4318" class="difflineplus">+    gNormalizeTablefc00,</span>
<a href="#l6.4319"></a><span id="l6.4319" class="difflineplus">+    gNormalizeTablefc40,</span>
<a href="#l6.4320"></a><span id="l6.4320" class="difflineplus">+    gNormalizeTablefc80,</span>
<a href="#l6.4321"></a><span id="l6.4321" class="difflineplus">+    gNormalizeTablefcc0,</span>
<a href="#l6.4322"></a><span id="l6.4322" class="difflineplus">+    gNormalizeTablefd00,</span>
<a href="#l6.4323"></a><span id="l6.4323" class="difflineplus">+    gNormalizeTablefd40,</span>
<a href="#l6.4324"></a><span id="l6.4324" class="difflineplus">+    gNormalizeTablefd80,</span>
<a href="#l6.4325"></a><span id="l6.4325" class="difflineplus">+    gNormalizeTablefdc0,</span>
<a href="#l6.4326"></a><span id="l6.4326" class="difflineplus">+    gNormalizeTablefe00,</span>
<a href="#l6.4327"></a><span id="l6.4327" class="difflineplus">+    gNormalizeTablefe40,</span>
<a href="#l6.4328"></a><span id="l6.4328" class="difflineplus">+    gNormalizeTablefe80,</span>
<a href="#l6.4329"></a><span id="l6.4329" class="difflineplus">+    gNormalizeTablefec0,</span>
<a href="#l6.4330"></a><span id="l6.4330" class="difflineplus">+    gNormalizeTableff00,</span>
<a href="#l6.4331"></a><span id="l6.4331" class="difflineplus">+    gNormalizeTableff40,</span>
<a href="#l6.4332"></a><span id="l6.4332" class="difflineplus">+    gNormalizeTableff80,</span>
<a href="#l6.4333"></a><span id="l6.4333" class="difflineplus">+    gNormalizeTableffc0,</span>
<a href="#l6.4334"></a><span id="l6.4334" class="difflineplus">+};</span>
<a href="#l6.4335"></a><span id="l6.4335" class="difflineplus">+</span>
<a href="#l6.4336"></a><span id="l6.4336" class="difflineplus">+unsigned int normalize_character(const unsigned int c) {</span>
<a href="#l6.4337"></a><span id="l6.4337" class="difflineplus">+  if (c &gt;= 0x10000 || !gNormalizeTable[c &gt;&gt; 6]) return c;</span>
<a href="#l6.4338"></a><span id="l6.4338">   return gNormalizeTable[c &gt;&gt; 6][c &amp; 0x3f];</span>
<a href="#l6.4339"></a><span id="l6.4339"> }</span>
<a href="#l6.4340"></a><span id="l6.4340" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/extensions/fts3/src/fts3_porter.c</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/extensions/fts3/src/fts3_porter.c</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -50,87 +50,83 @@</span>
<a href="#l7.4"></a><span id="l7.4"> **     * The FTS3 module is being built as an extension</span>
<a href="#l7.5"></a><span id="l7.5"> **       (in which case SQLITE_CORE is not defined), or</span>
<a href="#l7.6"></a><span id="l7.6"> **</span>
<a href="#l7.7"></a><span id="l7.7"> **     * The FTS3 module is being built into the core of</span>
<a href="#l7.8"></a><span id="l7.8"> **       SQLite (in which case SQLITE_ENABLE_FTS3 is defined).</span>
<a href="#l7.9"></a><span id="l7.9"> */</span>
<a href="#l7.10"></a><span id="l7.10"> #if !defined(SQLITE_CORE) || defined(SQLITE_ENABLE_FTS3)</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+#  include &lt;assert.h&gt;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+#  include &lt;stdlib.h&gt;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+#  include &lt;stdio.h&gt;</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+#  include &lt;string.h&gt;</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+#  include &lt;ctype.h&gt;</span>
<a href="#l7.17"></a><span id="l7.17"> </span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-#include &lt;assert.h&gt;</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-#include &lt;stdlib.h&gt;</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-#include &lt;stdio.h&gt;</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-#include &lt;string.h&gt;</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-#include &lt;ctype.h&gt;</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-#include &quot;fts3_tokenizer.h&quot;</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+#  include &quot;fts3_tokenizer.h&quot;</span>
<a href="#l7.26"></a><span id="l7.26"> </span>
<a href="#l7.27"></a><span id="l7.27"> /* need some defined to compile without sqlite3 code */</span>
<a href="#l7.28"></a><span id="l7.28"> </span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-#define sqlite3_malloc malloc</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-#define sqlite3_free free</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-#define sqlite3_realloc realloc</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+#  define sqlite3_malloc malloc</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+#  define sqlite3_free free</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+#  define sqlite3_realloc realloc</span>
<a href="#l7.35"></a><span id="l7.35"> </span>
<a href="#l7.36"></a><span id="l7.36"> static const unsigned char sqlite3Utf8Trans1[] = {</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">-  0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-  0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f,</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-  0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17,</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-  0x18, 0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f,</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-  0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-  0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f,</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-  0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-  0x00, 0x01, 0x02, 0x03, 0x00, 0x01, 0x00, 0x00,</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+    0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0a,</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+    0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15,</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+    0x16, 0x17, 0x18, 0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f, 0x00,</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+    0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0a, 0x0b,</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+    0x0c, 0x0d, 0x0e, 0x0f, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06,</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+    0x07, 0x00, 0x01, 0x02, 0x03, 0x00, 0x01, 0x00, 0x00,</span>
<a href="#l7.51"></a><span id="l7.51"> };</span>
<a href="#l7.52"></a><span id="l7.52"> </span>
<a href="#l7.53"></a><span id="l7.53"> typedef unsigned char u8;</span>
<a href="#l7.54"></a><span id="l7.54"> </span>
<a href="#l7.55"></a><span id="l7.55"> /**</span>
<a href="#l7.56"></a><span id="l7.56">  * SQLite helper macro from sqlite3.c (really utf.c) to encode a unicode</span>
<a href="#l7.57"></a><span id="l7.57">  * character into utf8.</span>
<a href="#l7.58"></a><span id="l7.58">  *</span>
<a href="#l7.59"></a><span id="l7.59">  * @param zOut A pointer to the current write position that is updated by</span>
<a href="#l7.60"></a><span id="l7.60">  *     the routine.  At entry it should point to one-past the last valid</span>
<a href="#l7.61"></a><span id="l7.61">  *     encoded byte.  The same holds true at exit.</span>
<a href="#l7.62"></a><span id="l7.62">  * @param c The character to encode; this should be an unsigned int.</span>
<a href="#l7.63"></a><span id="l7.63">  */</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-#define WRITE_UTF8(zOut, c) {                          \</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineminus">-  if( c&lt;0x0080 ){                                      \</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-    *zOut++ = (u8)(c&amp;0xff);                            \</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-  }                                                    \</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineminus">-  else if( c&lt;0x0800 ){                                 \</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-    *zOut++ = 0xC0 + (u8)((c&gt;&gt;6) &amp; 0x1F);              \</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineminus">-    *zOut++ = 0x80 + (u8)(c &amp; 0x3F);                   \</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineminus">-  }                                                    \</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-  else if( c&lt;0x10000 ){                                \</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineminus">-    *zOut++ = 0xE0 + (u8)((c&gt;&gt;12) &amp; 0x0F);             \</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineminus">-    *zOut++ = 0x80 + (u8)((c&gt;&gt;6) &amp; 0x3F);              \</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-    *zOut++ = 0x80 + (u8)(c &amp; 0x3F);                   \</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineminus">-  }else{                                               \</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineminus">-    *zOut++ = 0xf0 + (u8)((c&gt;&gt;18) &amp; 0x07);             \</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineminus">-    *zOut++ = 0x80 + (u8)((c&gt;&gt;12) &amp; 0x3F);             \</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-    *zOut++ = 0x80 + (u8)((c&gt;&gt;6) &amp; 0x3F);              \</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-    *zOut++ = 0x80 + (u8)(c &amp; 0x3F);                   \</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineminus">-  }                                                    \</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-}</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+#  define WRITE_UTF8(zOut, c)                    \</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+    {                                            \</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+      if (c &lt; 0x0080) {                          \</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+        *zOut++ = (u8)(c &amp; 0xff);                \</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+      } else if (c &lt; 0x0800) {                   \</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+        *zOut++ = 0xC0 + (u8)((c &gt;&gt; 6) &amp; 0x1F);  \</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+        *zOut++ = 0x80 + (u8)(c &amp; 0x3F);         \</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+      } else if (c &lt; 0x10000) {                  \</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+        *zOut++ = 0xE0 + (u8)((c &gt;&gt; 12) &amp; 0x0F); \</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+        *zOut++ = 0x80 + (u8)((c &gt;&gt; 6) &amp; 0x3F);  \</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+        *zOut++ = 0x80 + (u8)(c &amp; 0x3F);         \</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+      } else {                                   \</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+        *zOut++ = 0xf0 + (u8)((c &gt;&gt; 18) &amp; 0x07); \</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+        *zOut++ = 0x80 + (u8)((c &gt;&gt; 12) &amp; 0x3F); \</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+        *zOut++ = 0x80 + (u8)((c &gt;&gt; 6) &amp; 0x3F);  \</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+        *zOut++ = 0x80 + (u8)(c &amp; 0x3F);         \</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+      }                                          \</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+    }</span>
<a href="#l7.101"></a><span id="l7.101"> </span>
<a href="#l7.102"></a><span id="l7.102"> /**</span>
<a href="#l7.103"></a><span id="l7.103">  * Fudge factor to avoid buffer overwrites when WRITE_UTF8 is involved.</span>
<a href="#l7.104"></a><span id="l7.104">  *</span>
<a href="#l7.105"></a><span id="l7.105">  * Our normalization table includes entries that may result in a larger</span>
<a href="#l7.106"></a><span id="l7.106">  *  utf-8 encoding.  Namely, 023a maps to 2c65.  This is a growth from 2 bytes</span>
<a href="#l7.107"></a><span id="l7.107">  *  as utf-8 encoded to 3 bytes.  This is currently the only transition possible</span>
<a href="#l7.108"></a><span id="l7.108">  *  because 1-byte encodings are known to stay 1-byte and our normalization</span>
<a href="#l7.109"></a><span id="l7.109">  *  table is 16-bit and so can't generate a 4-byte encoded output.</span>
<a href="#l7.110"></a><span id="l7.110">  *</span>
<a href="#l7.111"></a><span id="l7.111">  * For simplicity, we just multiple by 2 which covers the current case and</span>
<a href="#l7.112"></a><span id="l7.112">  *  potential growth for 2-byte to 4-byte growth.  We can afford to do this</span>
<a href="#l7.113"></a><span id="l7.113">  *  because we're not talking about a lot of memory here as a rule.</span>
<a href="#l7.114"></a><span id="l7.114">  */</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineminus">-#define MAX_UTF8_GROWTH_FACTOR 2</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+#  define MAX_UTF8_GROWTH_FACTOR 2</span>
<a href="#l7.117"></a><span id="l7.117"> </span>
<a href="#l7.118"></a><span id="l7.118"> /**</span>
<a href="#l7.119"></a><span id="l7.119">  * Helper from sqlite3.c to read a single UTF8 character.</span>
<a href="#l7.120"></a><span id="l7.120">  *</span>
<a href="#l7.121"></a><span id="l7.121">  * The clever bit with multi-byte reading is that you keep going until you find</span>
<a href="#l7.122"></a><span id="l7.122">  *  a byte whose top bits are not '10'.  A single-byte UTF8 character will have</span>
<a href="#l7.123"></a><span id="l7.123">  *  '00' or '01', and a multi-byte UTF8 character must start with '11'.</span>
<a href="#l7.124"></a><span id="l7.124">  *</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineat">@@ -140,183 +136,180 @@ typedef unsigned char u8;</span>
<a href="#l7.126"></a><span id="l7.126">  *  illegal character (0xfffd) for UTF-16 surrogates.</span>
<a href="#l7.127"></a><span id="l7.127">  *</span>
<a href="#l7.128"></a><span id="l7.128">  * @param zIn A pointer to the current position that is updated by the routine,</span>
<a href="#l7.129"></a><span id="l7.129">  *     pointing at the start of the next character when the routine returns.</span>
<a href="#l7.130"></a><span id="l7.130">  * @param zTerm A pointer one past the end of the buffer.</span>
<a href="#l7.131"></a><span id="l7.131">  * @param c The 'unsigned int' to hold the resulting character value.  Do not</span>
<a href="#l7.132"></a><span id="l7.132">  *      use a short or a char.</span>
<a href="#l7.133"></a><span id="l7.133">  */</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineminus">-#define READ_UTF8(zIn, zTerm, c) {                         \</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineminus">-  c = *(zIn++);                                            \</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineminus">-  if( c&gt;=0xc0 ){                                           \</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineminus">-    c = sqlite3Utf8Trans1[c-0xc0];                         \</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineminus">-    while( zIn!=zTerm &amp;&amp; (*zIn &amp; 0xc0)==0x80 ){            \</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineminus">-      c = (c&lt;&lt;6) + (0x3f &amp; *(zIn++));                      \</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineminus">-    }                                                      \</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineminus">-    if( c&lt;0x80                                             \</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineminus">-        || (c&amp;0xFFFFF800)==0xD800                          \</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineminus">-        || (c&amp;0xFFFFFFFE)==0xFFFE ){  c = 0xFFFD; }        \</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineminus">-  }                                                        \</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineminus">-}</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineplus">+#  define READ_UTF8(zIn, zTerm, c)                      \</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineplus">+    {                                                   \</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineplus">+      c = *(zIn++);                                     \</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineplus">+      if (c &gt;= 0xc0) {                                  \</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineplus">+        c = sqlite3Utf8Trans1[c - 0xc0];                \</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineplus">+        while (zIn != zTerm &amp;&amp; (*zIn &amp; 0xc0) == 0x80) { \</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineplus">+          c = (c &lt;&lt; 6) + (0x3f &amp; *(zIn++));             \</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineplus">+        }                                               \</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineplus">+        if (c &lt; 0x80 || (c &amp; 0xFFFFF800) == 0xD800 ||   \</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineplus">+            (c &amp; 0xFFFFFFFE) == 0xFFFE) {               \</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineplus">+          c = 0xFFFD;                                   \</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+        }                                               \</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineplus">+      }                                                 \</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineplus">+    }</span>
<a href="#l7.160"></a><span id="l7.160"> </span>
<a href="#l7.161"></a><span id="l7.161"> /* end of compatible block to complie codes */</span>
<a href="#l7.162"></a><span id="l7.162"> </span>
<a href="#l7.163"></a><span id="l7.163"> /*</span>
<a href="#l7.164"></a><span id="l7.164"> ** Class derived from sqlite3_tokenizer</span>
<a href="#l7.165"></a><span id="l7.165"> */</span>
<a href="#l7.166"></a><span id="l7.166"> typedef struct porter_tokenizer {</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineminus">-  sqlite3_tokenizer base;      /* Base class */</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineplus">+  sqlite3_tokenizer base; /* Base class */</span>
<a href="#l7.169"></a><span id="l7.169"> } porter_tokenizer;</span>
<a href="#l7.170"></a><span id="l7.170"> </span>
<a href="#l7.171"></a><span id="l7.171"> /*</span>
<a href="#l7.172"></a><span id="l7.172"> ** Class derived from sqlit3_tokenizer_cursor</span>
<a href="#l7.173"></a><span id="l7.173"> */</span>
<a href="#l7.174"></a><span id="l7.174"> typedef struct porter_tokenizer_cursor {</span>
<a href="#l7.175"></a><span id="l7.175">   sqlite3_tokenizer_cursor base;</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineminus">-  const char *zInput;          /* input we are tokenizing */</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineminus">-  int nInput;                  /* size of the input */</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineminus">-  int iOffset;                 /* current position in zInput */</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineminus">-  int iToken;                  /* index of next token to be returned */</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineminus">-  unsigned char *zToken;       /* storage for current token */</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineminus">-  int nAllocated;              /* space allocated to zToken buffer */</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineplus">+  const char *zInput;    /* input we are tokenizing */</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineplus">+  int nInput;            /* size of the input */</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineplus">+  int iOffset;           /* current position in zInput */</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineplus">+  int iToken;            /* index of next token to be returned */</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineplus">+  unsigned char *zToken; /* storage for current token */</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineplus">+  int nAllocated;        /* space allocated to zToken buffer */</span>
<a href="#l7.188"></a><span id="l7.188">   /**</span>
<a href="#l7.189"></a><span id="l7.189">    * Store the offset of the second character in the bi-gram pair that we just</span>
<a href="#l7.190"></a><span id="l7.190">    *  emitted so that we can consider it being the first character in a bi-gram</span>
<a href="#l7.191"></a><span id="l7.191">    *  pair.</span>
<a href="#l7.192"></a><span id="l7.192">    * The value 0 indicates that there is no previous such character.  This is</span>
<a href="#l7.193"></a><span id="l7.193">    *  an acceptable sentinel value because the 0th offset can never be the</span>
<a href="#l7.194"></a><span id="l7.194">    *  offset of the second in a bi-gram pair.</span>
<a href="#l7.195"></a><span id="l7.195">    *</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineminus">-   * For example, let us say we are tokenizing a string of 4 CJK characters </span>
<a href="#l7.197"></a><span id="l7.197" class="difflineplus">+   * For example, let us say we are tokenizing a string of 4 CJK characters</span>
<a href="#l7.198"></a><span id="l7.198">    *  represented by the byte-string &quot;11223344&quot; where each repeated digit</span>
<a href="#l7.199"></a><span id="l7.199">    *  indicates 2-bytes of storage used to encode the character in UTF-8.</span>
<a href="#l7.200"></a><span id="l7.200">    *  (It actually takes 3, btw.)  Then on the passes to emit each token,</span>
<a href="#l7.201"></a><span id="l7.201">    *  the iOffset and iPrevGigramOffset values at entry will be:</span>
<a href="#l7.202"></a><span id="l7.202">    *</span>
<a href="#l7.203"></a><span id="l7.203">    * 1122: iOffset = 0, iPrevBigramOffset = 0</span>
<a href="#l7.204"></a><span id="l7.204">    * 2233: iOffset = 4, iPrevBigramOffset = 2</span>
<a href="#l7.205"></a><span id="l7.205">    * 3344: iOffset = 6, iPrevBigramOffset = 4</span>
<a href="#l7.206"></a><span id="l7.206">    * (nothing will be emitted): iOffset = 8, iPrevBigramOffset = 6</span>
<a href="#l7.207"></a><span id="l7.207">    */</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineminus">-  int iPrevBigramOffset;       /* previous result was bi-gram */</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineplus">+  int iPrevBigramOffset; /* previous result was bi-gram */</span>
<a href="#l7.210"></a><span id="l7.210"> } porter_tokenizer_cursor;</span>
<a href="#l7.211"></a><span id="l7.211"> </span>
<a href="#l7.212"></a><span id="l7.212" class="difflineminus">-</span>
<a href="#l7.213"></a><span id="l7.213"> /* Forward declaration */</span>
<a href="#l7.214"></a><span id="l7.214"> static const sqlite3_tokenizer_module porterTokenizerModule;</span>
<a href="#l7.215"></a><span id="l7.215"> </span>
<a href="#l7.216"></a><span id="l7.216"> /* from normalize.c */</span>
<a href="#l7.217"></a><span id="l7.217"> extern unsigned int normalize_character(const unsigned int c);</span>
<a href="#l7.218"></a><span id="l7.218"> </span>
<a href="#l7.219"></a><span id="l7.219"> /*</span>
<a href="#l7.220"></a><span id="l7.220"> ** Create a new tokenizer instance.</span>
<a href="#l7.221"></a><span id="l7.221"> */</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineminus">-static int porterCreate(</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineminus">-  int argc, const char * const *argv,</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineminus">-  sqlite3_tokenizer **ppTokenizer</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineminus">-){</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineplus">+static int porterCreate(int argc, const char *const *argv,</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineplus">+                        sqlite3_tokenizer **ppTokenizer) {</span>
<a href="#l7.228"></a><span id="l7.228">   porter_tokenizer *t;</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineminus">-  t = (porter_tokenizer *) sqlite3_malloc(sizeof(*t));</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineminus">-  if( t==NULL ) return SQLITE_NOMEM;</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineplus">+  t = (porter_tokenizer *)sqlite3_malloc(sizeof(*t));</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineplus">+  if (t == NULL) return SQLITE_NOMEM;</span>
<a href="#l7.233"></a><span id="l7.233">   memset(t, 0, sizeof(*t));</span>
<a href="#l7.234"></a><span id="l7.234">   *ppTokenizer = &amp;t-&gt;base;</span>
<a href="#l7.235"></a><span id="l7.235">   return SQLITE_OK;</span>
<a href="#l7.236"></a><span id="l7.236"> }</span>
<a href="#l7.237"></a><span id="l7.237"> </span>
<a href="#l7.238"></a><span id="l7.238"> /*</span>
<a href="#l7.239"></a><span id="l7.239"> ** Destroy a tokenizer</span>
<a href="#l7.240"></a><span id="l7.240"> */</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineminus">-static int porterDestroy(sqlite3_tokenizer *pTokenizer){</span>
<a href="#l7.242"></a><span id="l7.242" class="difflineplus">+static int porterDestroy(sqlite3_tokenizer *pTokenizer) {</span>
<a href="#l7.243"></a><span id="l7.243">   sqlite3_free(pTokenizer);</span>
<a href="#l7.244"></a><span id="l7.244">   return SQLITE_OK;</span>
<a href="#l7.245"></a><span id="l7.245"> }</span>
<a href="#l7.246"></a><span id="l7.246"> </span>
<a href="#l7.247"></a><span id="l7.247"> /*</span>
<a href="#l7.248"></a><span id="l7.248"> ** Prepare to begin tokenizing a particular string.  The input</span>
<a href="#l7.249"></a><span id="l7.249"> ** string to be tokenized is zInput[0..nInput-1].  A cursor</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineminus">-** used to incrementally tokenize this string is returned in </span>
<a href="#l7.251"></a><span id="l7.251" class="difflineplus">+** used to incrementally tokenize this string is returned in</span>
<a href="#l7.252"></a><span id="l7.252"> ** *ppCursor.</span>
<a href="#l7.253"></a><span id="l7.253"> */</span>
<a href="#l7.254"></a><span id="l7.254"> static int porterOpen(</span>
<a href="#l7.255"></a><span id="l7.255" class="difflineminus">-  sqlite3_tokenizer *pTokenizer,         /* The tokenizer */</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineminus">-  const char *zInput, int nInput,        /* String to be tokenized */</span>
<a href="#l7.257"></a><span id="l7.257" class="difflineminus">-  sqlite3_tokenizer_cursor **ppCursor    /* OUT: Tokenization cursor */</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineminus">-){</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineplus">+    sqlite3_tokenizer *pTokenizer,      /* The tokenizer */</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineplus">+    const char *zInput, int nInput,     /* String to be tokenized */</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineplus">+    sqlite3_tokenizer_cursor **ppCursor /* OUT: Tokenization cursor */</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineplus">+) {</span>
<a href="#l7.263"></a><span id="l7.263">   porter_tokenizer_cursor *c;</span>
<a href="#l7.264"></a><span id="l7.264"> </span>
<a href="#l7.265"></a><span id="l7.265" class="difflineminus">-  c = (porter_tokenizer_cursor *) sqlite3_malloc(sizeof(*c));</span>
<a href="#l7.266"></a><span id="l7.266" class="difflineminus">-  if( c==NULL ) return SQLITE_NOMEM;</span>
<a href="#l7.267"></a><span id="l7.267" class="difflineplus">+  c = (porter_tokenizer_cursor *)sqlite3_malloc(sizeof(*c));</span>
<a href="#l7.268"></a><span id="l7.268" class="difflineplus">+  if (c == NULL) return SQLITE_NOMEM;</span>
<a href="#l7.269"></a><span id="l7.269"> </span>
<a href="#l7.270"></a><span id="l7.270">   c-&gt;zInput = zInput;</span>
<a href="#l7.271"></a><span id="l7.271" class="difflineminus">-  if( zInput==0 ){</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineplus">+  if (zInput == 0) {</span>
<a href="#l7.273"></a><span id="l7.273">     c-&gt;nInput = 0;</span>
<a href="#l7.274"></a><span id="l7.274" class="difflineminus">-  }else if( nInput&lt;0 ){</span>
<a href="#l7.275"></a><span id="l7.275" class="difflineplus">+  } else if (nInput &lt; 0) {</span>
<a href="#l7.276"></a><span id="l7.276">     c-&gt;nInput = (int)strlen(zInput);</span>
<a href="#l7.277"></a><span id="l7.277" class="difflineminus">-  }else{</span>
<a href="#l7.278"></a><span id="l7.278" class="difflineplus">+  } else {</span>
<a href="#l7.279"></a><span id="l7.279">     c-&gt;nInput = nInput;</span>
<a href="#l7.280"></a><span id="l7.280">   }</span>
<a href="#l7.281"></a><span id="l7.281" class="difflineminus">-  c-&gt;iOffset = 0;                 /* start tokenizing at the beginning */</span>
<a href="#l7.282"></a><span id="l7.282" class="difflineplus">+  c-&gt;iOffset = 0; /* start tokenizing at the beginning */</span>
<a href="#l7.283"></a><span id="l7.283">   c-&gt;iToken = 0;</span>
<a href="#l7.284"></a><span id="l7.284" class="difflineminus">-  c-&gt;zToken = NULL;               /* no space allocated, yet. */</span>
<a href="#l7.285"></a><span id="l7.285" class="difflineplus">+  c-&gt;zToken = NULL; /* no space allocated, yet. */</span>
<a href="#l7.286"></a><span id="l7.286">   c-&gt;nAllocated = 0;</span>
<a href="#l7.287"></a><span id="l7.287">   c-&gt;iPrevBigramOffset = 0;</span>
<a href="#l7.288"></a><span id="l7.288"> </span>
<a href="#l7.289"></a><span id="l7.289">   *ppCursor = &amp;c-&gt;base;</span>
<a href="#l7.290"></a><span id="l7.290">   return SQLITE_OK;</span>
<a href="#l7.291"></a><span id="l7.291"> }</span>
<a href="#l7.292"></a><span id="l7.292"> </span>
<a href="#l7.293"></a><span id="l7.293"> /*</span>
<a href="#l7.294"></a><span id="l7.294"> ** Close a tokenization cursor previously opened by a call to</span>
<a href="#l7.295"></a><span id="l7.295"> ** porterOpen() above.</span>
<a href="#l7.296"></a><span id="l7.296"> */</span>
<a href="#l7.297"></a><span id="l7.297" class="difflineminus">-static int porterClose(sqlite3_tokenizer_cursor *pCursor){</span>
<a href="#l7.298"></a><span id="l7.298" class="difflineminus">-  porter_tokenizer_cursor *c = (porter_tokenizer_cursor *) pCursor;</span>
<a href="#l7.299"></a><span id="l7.299" class="difflineplus">+static int porterClose(sqlite3_tokenizer_cursor *pCursor) {</span>
<a href="#l7.300"></a><span id="l7.300" class="difflineplus">+  porter_tokenizer_cursor *c = (porter_tokenizer_cursor *)pCursor;</span>
<a href="#l7.301"></a><span id="l7.301">   sqlite3_free(c-&gt;zToken);</span>
<a href="#l7.302"></a><span id="l7.302">   sqlite3_free(c);</span>
<a href="#l7.303"></a><span id="l7.303">   return SQLITE_OK;</span>
<a href="#l7.304"></a><span id="l7.304"> }</span>
<a href="#l7.305"></a><span id="l7.305"> /*</span>
<a href="#l7.306"></a><span id="l7.306"> ** Vowel or consonant</span>
<a href="#l7.307"></a><span id="l7.307"> */</span>
<a href="#l7.308"></a><span id="l7.308" class="difflineminus">-static const char cType[] = {</span>
<a href="#l7.309"></a><span id="l7.309" class="difflineminus">-   0, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0,</span>
<a href="#l7.310"></a><span id="l7.310" class="difflineminus">-   1, 1, 1, 2, 1</span>
<a href="#l7.311"></a><span id="l7.311" class="difflineminus">-};</span>
<a href="#l7.312"></a><span id="l7.312" class="difflineplus">+static const char cType[] = {0, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 1,</span>
<a href="#l7.313"></a><span id="l7.313" class="difflineplus">+                             1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 2, 1};</span>
<a href="#l7.314"></a><span id="l7.314"> </span>
<a href="#l7.315"></a><span id="l7.315"> /*</span>
<a href="#l7.316"></a><span id="l7.316"> ** isConsonant() and isVowel() determine if their first character in</span>
<a href="#l7.317"></a><span id="l7.317"> ** the string they point to is a consonant or a vowel, according</span>
<a href="#l7.318"></a><span id="l7.318" class="difflineminus">-** to Porter ruls.  </span>
<a href="#l7.319"></a><span id="l7.319" class="difflineplus">+** to Porter ruls.</span>
<a href="#l7.320"></a><span id="l7.320"> **</span>
<a href="#l7.321"></a><span id="l7.321"> ** A consonate is any letter other than 'a', 'e', 'i', 'o', or 'u'.</span>
<a href="#l7.322"></a><span id="l7.322"> ** 'Y' is a consonant unless it follows another consonant,</span>
<a href="#l7.323"></a><span id="l7.323"> ** in which case it is a vowel.</span>
<a href="#l7.324"></a><span id="l7.324"> **</span>
<a href="#l7.325"></a><span id="l7.325"> ** In these routine, the letters are in reverse order.  So the 'y' rule</span>
<a href="#l7.326"></a><span id="l7.326"> ** is that 'y' is a consonant unless it is followed by another</span>
<a href="#l7.327"></a><span id="l7.327"> ** consonant.</span>
<a href="#l7.328"></a><span id="l7.328"> */</span>
<a href="#l7.329"></a><span id="l7.329" class="difflineminus">-static int isVowel(const char*);</span>
<a href="#l7.330"></a><span id="l7.330" class="difflineminus">-static int isConsonant(const char *z){</span>
<a href="#l7.331"></a><span id="l7.331" class="difflineplus">+static int isVowel(const char *);</span>
<a href="#l7.332"></a><span id="l7.332" class="difflineplus">+static int isConsonant(const char *z) {</span>
<a href="#l7.333"></a><span id="l7.333">   int j;</span>
<a href="#l7.334"></a><span id="l7.334">   char x = *z;</span>
<a href="#l7.335"></a><span id="l7.335" class="difflineminus">-  if( x==0 ) return 0;</span>
<a href="#l7.336"></a><span id="l7.336" class="difflineminus">-  assert( x&gt;='a' &amp;&amp; x&lt;='z' );</span>
<a href="#l7.337"></a><span id="l7.337" class="difflineminus">-  j = cType[x-'a'];</span>
<a href="#l7.338"></a><span id="l7.338" class="difflineminus">-  if( j&lt;2 ) return j;</span>
<a href="#l7.339"></a><span id="l7.339" class="difflineminus">-  return z[1]==0 || isVowel(z + 1);</span>
<a href="#l7.340"></a><span id="l7.340" class="difflineplus">+  if (x == 0) return 0;</span>
<a href="#l7.341"></a><span id="l7.341" class="difflineplus">+  assert(x &gt;= 'a' &amp;&amp; x &lt;= 'z');</span>
<a href="#l7.342"></a><span id="l7.342" class="difflineplus">+  j = cType[x - 'a'];</span>
<a href="#l7.343"></a><span id="l7.343" class="difflineplus">+  if (j &lt; 2) return j;</span>
<a href="#l7.344"></a><span id="l7.344" class="difflineplus">+  return z[1] == 0 || isVowel(z + 1);</span>
<a href="#l7.345"></a><span id="l7.345"> }</span>
<a href="#l7.346"></a><span id="l7.346" class="difflineminus">-static int isVowel(const char *z){</span>
<a href="#l7.347"></a><span id="l7.347" class="difflineplus">+static int isVowel(const char *z) {</span>
<a href="#l7.348"></a><span id="l7.348">   int j;</span>
<a href="#l7.349"></a><span id="l7.349">   char x = *z;</span>
<a href="#l7.350"></a><span id="l7.350" class="difflineminus">-  if( x==0 ) return 0;</span>
<a href="#l7.351"></a><span id="l7.351" class="difflineminus">-  assert( x&gt;='a' &amp;&amp; x&lt;='z' );</span>
<a href="#l7.352"></a><span id="l7.352" class="difflineminus">-  j = cType[x-'a'];</span>
<a href="#l7.353"></a><span id="l7.353" class="difflineminus">-  if( j&lt;2 ) return 1-j;</span>
<a href="#l7.354"></a><span id="l7.354" class="difflineplus">+  if (x == 0) return 0;</span>
<a href="#l7.355"></a><span id="l7.355" class="difflineplus">+  assert(x &gt;= 'a' &amp;&amp; x &lt;= 'z');</span>
<a href="#l7.356"></a><span id="l7.356" class="difflineplus">+  j = cType[x - 'a'];</span>
<a href="#l7.357"></a><span id="l7.357" class="difflineplus">+  if (j &lt; 2) return 1 - j;</span>
<a href="#l7.358"></a><span id="l7.358">   return isConsonant(z + 1);</span>
<a href="#l7.359"></a><span id="l7.359"> }</span>
<a href="#l7.360"></a><span id="l7.360"> </span>
<a href="#l7.361"></a><span id="l7.361"> /*</span>
<a href="#l7.362"></a><span id="l7.362"> ** Let any sequence of one or more vowels be represented by V and let</span>
<a href="#l7.363"></a><span id="l7.363"> ** C be sequence of one or more consonants.  Then every word can be</span>
<a href="#l7.364"></a><span id="l7.364"> ** represented as:</span>
<a href="#l7.365"></a><span id="l7.365"> **</span>
<a href="#l7.366"></a><span id="l7.366" class="difflineat">@@ -329,132 +322,154 @@ static int isVowel(const char *z){</span>
<a href="#l7.367"></a><span id="l7.367"> **</span>
<a href="#l7.368"></a><span id="l7.368"> ** Return true if the m-value for z is 1 or more.  In other words,</span>
<a href="#l7.369"></a><span id="l7.369"> ** return true if z contains at least one vowel that is followed</span>
<a href="#l7.370"></a><span id="l7.370"> ** by a consonant.</span>
<a href="#l7.371"></a><span id="l7.371"> **</span>
<a href="#l7.372"></a><span id="l7.372"> ** In this routine z[] is in reverse order.  So we are really looking</span>
<a href="#l7.373"></a><span id="l7.373"> ** for an instance of of a consonant followed by a vowel.</span>
<a href="#l7.374"></a><span id="l7.374"> */</span>
<a href="#l7.375"></a><span id="l7.375" class="difflineminus">-static int m_gt_0(const char *z){</span>
<a href="#l7.376"></a><span id="l7.376" class="difflineminus">-  while( isVowel(z) ){ z++; }</span>
<a href="#l7.377"></a><span id="l7.377" class="difflineminus">-  if( *z==0 ) return 0;</span>
<a href="#l7.378"></a><span id="l7.378" class="difflineminus">-  while( isConsonant(z) ){ z++; }</span>
<a href="#l7.379"></a><span id="l7.379" class="difflineminus">-  return *z!=0;</span>
<a href="#l7.380"></a><span id="l7.380" class="difflineplus">+static int m_gt_0(const char *z) {</span>
<a href="#l7.381"></a><span id="l7.381" class="difflineplus">+  while (isVowel(z)) {</span>
<a href="#l7.382"></a><span id="l7.382" class="difflineplus">+    z++;</span>
<a href="#l7.383"></a><span id="l7.383" class="difflineplus">+  }</span>
<a href="#l7.384"></a><span id="l7.384" class="difflineplus">+  if (*z == 0) return 0;</span>
<a href="#l7.385"></a><span id="l7.385" class="difflineplus">+  while (isConsonant(z)) {</span>
<a href="#l7.386"></a><span id="l7.386" class="difflineplus">+    z++;</span>
<a href="#l7.387"></a><span id="l7.387" class="difflineplus">+  }</span>
<a href="#l7.388"></a><span id="l7.388" class="difflineplus">+  return *z != 0;</span>
<a href="#l7.389"></a><span id="l7.389"> }</span>
<a href="#l7.390"></a><span id="l7.390"> </span>
<a href="#l7.391"></a><span id="l7.391"> /* Like mgt0 above except we are looking for a value of m which is</span>
<a href="#l7.392"></a><span id="l7.392"> ** exactly 1</span>
<a href="#l7.393"></a><span id="l7.393"> */</span>
<a href="#l7.394"></a><span id="l7.394" class="difflineminus">-static int m_eq_1(const char *z){</span>
<a href="#l7.395"></a><span id="l7.395" class="difflineminus">-  while( isVowel(z) ){ z++; }</span>
<a href="#l7.396"></a><span id="l7.396" class="difflineminus">-  if( *z==0 ) return 0;</span>
<a href="#l7.397"></a><span id="l7.397" class="difflineminus">-  while( isConsonant(z) ){ z++; }</span>
<a href="#l7.398"></a><span id="l7.398" class="difflineminus">-  if( *z==0 ) return 0;</span>
<a href="#l7.399"></a><span id="l7.399" class="difflineminus">-  while( isVowel(z) ){ z++; }</span>
<a href="#l7.400"></a><span id="l7.400" class="difflineminus">-  if( *z==0 ) return 1;</span>
<a href="#l7.401"></a><span id="l7.401" class="difflineminus">-  while( isConsonant(z) ){ z++; }</span>
<a href="#l7.402"></a><span id="l7.402" class="difflineminus">-  return *z==0;</span>
<a href="#l7.403"></a><span id="l7.403" class="difflineplus">+static int m_eq_1(const char *z) {</span>
<a href="#l7.404"></a><span id="l7.404" class="difflineplus">+  while (isVowel(z)) {</span>
<a href="#l7.405"></a><span id="l7.405" class="difflineplus">+    z++;</span>
<a href="#l7.406"></a><span id="l7.406" class="difflineplus">+  }</span>
<a href="#l7.407"></a><span id="l7.407" class="difflineplus">+  if (*z == 0) return 0;</span>
<a href="#l7.408"></a><span id="l7.408" class="difflineplus">+  while (isConsonant(z)) {</span>
<a href="#l7.409"></a><span id="l7.409" class="difflineplus">+    z++;</span>
<a href="#l7.410"></a><span id="l7.410" class="difflineplus">+  }</span>
<a href="#l7.411"></a><span id="l7.411" class="difflineplus">+  if (*z == 0) return 0;</span>
<a href="#l7.412"></a><span id="l7.412" class="difflineplus">+  while (isVowel(z)) {</span>
<a href="#l7.413"></a><span id="l7.413" class="difflineplus">+    z++;</span>
<a href="#l7.414"></a><span id="l7.414" class="difflineplus">+  }</span>
<a href="#l7.415"></a><span id="l7.415" class="difflineplus">+  if (*z == 0) return 1;</span>
<a href="#l7.416"></a><span id="l7.416" class="difflineplus">+  while (isConsonant(z)) {</span>
<a href="#l7.417"></a><span id="l7.417" class="difflineplus">+    z++;</span>
<a href="#l7.418"></a><span id="l7.418" class="difflineplus">+  }</span>
<a href="#l7.419"></a><span id="l7.419" class="difflineplus">+  return *z == 0;</span>
<a href="#l7.420"></a><span id="l7.420"> }</span>
<a href="#l7.421"></a><span id="l7.421"> </span>
<a href="#l7.422"></a><span id="l7.422"> /* Like mgt0 above except we are looking for a value of m&gt;1 instead</span>
<a href="#l7.423"></a><span id="l7.423"> ** or m&gt;0</span>
<a href="#l7.424"></a><span id="l7.424"> */</span>
<a href="#l7.425"></a><span id="l7.425" class="difflineminus">-static int m_gt_1(const char *z){</span>
<a href="#l7.426"></a><span id="l7.426" class="difflineminus">-  while( isVowel(z) ){ z++; }</span>
<a href="#l7.427"></a><span id="l7.427" class="difflineminus">-  if( *z==0 ) return 0;</span>
<a href="#l7.428"></a><span id="l7.428" class="difflineminus">-  while( isConsonant(z) ){ z++; }</span>
<a href="#l7.429"></a><span id="l7.429" class="difflineminus">-  if( *z==0 ) return 0;</span>
<a href="#l7.430"></a><span id="l7.430" class="difflineminus">-  while( isVowel(z) ){ z++; }</span>
<a href="#l7.431"></a><span id="l7.431" class="difflineminus">-  if( *z==0 ) return 0;</span>
<a href="#l7.432"></a><span id="l7.432" class="difflineminus">-  while( isConsonant(z) ){ z++; }</span>
<a href="#l7.433"></a><span id="l7.433" class="difflineminus">-  return *z!=0;</span>
<a href="#l7.434"></a><span id="l7.434" class="difflineplus">+static int m_gt_1(const char *z) {</span>
<a href="#l7.435"></a><span id="l7.435" class="difflineplus">+  while (isVowel(z)) {</span>
<a href="#l7.436"></a><span id="l7.436" class="difflineplus">+    z++;</span>
<a href="#l7.437"></a><span id="l7.437" class="difflineplus">+  }</span>
<a href="#l7.438"></a><span id="l7.438" class="difflineplus">+  if (*z == 0) return 0;</span>
<a href="#l7.439"></a><span id="l7.439" class="difflineplus">+  while (isConsonant(z)) {</span>
<a href="#l7.440"></a><span id="l7.440" class="difflineplus">+    z++;</span>
<a href="#l7.441"></a><span id="l7.441" class="difflineplus">+  }</span>
<a href="#l7.442"></a><span id="l7.442" class="difflineplus">+  if (*z == 0) return 0;</span>
<a href="#l7.443"></a><span id="l7.443" class="difflineplus">+  while (isVowel(z)) {</span>
<a href="#l7.444"></a><span id="l7.444" class="difflineplus">+    z++;</span>
<a href="#l7.445"></a><span id="l7.445" class="difflineplus">+  }</span>
<a href="#l7.446"></a><span id="l7.446" class="difflineplus">+  if (*z == 0) return 0;</span>
<a href="#l7.447"></a><span id="l7.447" class="difflineplus">+  while (isConsonant(z)) {</span>
<a href="#l7.448"></a><span id="l7.448" class="difflineplus">+    z++;</span>
<a href="#l7.449"></a><span id="l7.449" class="difflineplus">+  }</span>
<a href="#l7.450"></a><span id="l7.450" class="difflineplus">+  return *z != 0;</span>
<a href="#l7.451"></a><span id="l7.451"> }</span>
<a href="#l7.452"></a><span id="l7.452"> </span>
<a href="#l7.453"></a><span id="l7.453"> /*</span>
<a href="#l7.454"></a><span id="l7.454"> ** Return TRUE if there is a vowel anywhere within z[0..n-1]</span>
<a href="#l7.455"></a><span id="l7.455"> */</span>
<a href="#l7.456"></a><span id="l7.456" class="difflineminus">-static int hasVowel(const char *z){</span>
<a href="#l7.457"></a><span id="l7.457" class="difflineminus">-  while( isConsonant(z) ){ z++; }</span>
<a href="#l7.458"></a><span id="l7.458" class="difflineminus">-  return *z!=0;</span>
<a href="#l7.459"></a><span id="l7.459" class="difflineplus">+static int hasVowel(const char *z) {</span>
<a href="#l7.460"></a><span id="l7.460" class="difflineplus">+  while (isConsonant(z)) {</span>
<a href="#l7.461"></a><span id="l7.461" class="difflineplus">+    z++;</span>
<a href="#l7.462"></a><span id="l7.462" class="difflineplus">+  }</span>
<a href="#l7.463"></a><span id="l7.463" class="difflineplus">+  return *z != 0;</span>
<a href="#l7.464"></a><span id="l7.464"> }</span>
<a href="#l7.465"></a><span id="l7.465"> </span>
<a href="#l7.466"></a><span id="l7.466"> /*</span>
<a href="#l7.467"></a><span id="l7.467"> ** Return TRUE if the word ends in a double consonant.</span>
<a href="#l7.468"></a><span id="l7.468"> **</span>
<a href="#l7.469"></a><span id="l7.469"> ** The text is reversed here. So we are really looking at</span>
<a href="#l7.470"></a><span id="l7.470"> ** the first two characters of z[].</span>
<a href="#l7.471"></a><span id="l7.471"> */</span>
<a href="#l7.472"></a><span id="l7.472" class="difflineminus">-static int doubleConsonant(const char *z){</span>
<a href="#l7.473"></a><span id="l7.473" class="difflineminus">-  return isConsonant(z) &amp;&amp; z[0]==z[1] &amp;&amp; isConsonant(z+1);</span>
<a href="#l7.474"></a><span id="l7.474" class="difflineplus">+static int doubleConsonant(const char *z) {</span>
<a href="#l7.475"></a><span id="l7.475" class="difflineplus">+  return isConsonant(z) &amp;&amp; z[0] == z[1] &amp;&amp; isConsonant(z + 1);</span>
<a href="#l7.476"></a><span id="l7.476"> }</span>
<a href="#l7.477"></a><span id="l7.477"> </span>
<a href="#l7.478"></a><span id="l7.478"> /*</span>
<a href="#l7.479"></a><span id="l7.479"> ** Return TRUE if the word ends with three letters which</span>
<a href="#l7.480"></a><span id="l7.480"> ** are consonant-vowel-consonent and where the final consonant</span>
<a href="#l7.481"></a><span id="l7.481"> ** is not 'w', 'x', or 'y'.</span>
<a href="#l7.482"></a><span id="l7.482"> **</span>
<a href="#l7.483"></a><span id="l7.483"> ** The word is reversed here.  So we are really checking the</span>
<a href="#l7.484"></a><span id="l7.484"> ** first three letters and the first one cannot be in [wxy].</span>
<a href="#l7.485"></a><span id="l7.485"> */</span>
<a href="#l7.486"></a><span id="l7.486" class="difflineminus">-static int star_oh(const char *z){</span>
<a href="#l7.487"></a><span id="l7.487" class="difflineminus">-  return</span>
<a href="#l7.488"></a><span id="l7.488" class="difflineminus">-    z[0]!=0 &amp;&amp; isConsonant(z) &amp;&amp;</span>
<a href="#l7.489"></a><span id="l7.489" class="difflineminus">-    z[0]!='w' &amp;&amp; z[0]!='x' &amp;&amp; z[0]!='y' &amp;&amp;</span>
<a href="#l7.490"></a><span id="l7.490" class="difflineminus">-    z[1]!=0 &amp;&amp; isVowel(z+1) &amp;&amp;</span>
<a href="#l7.491"></a><span id="l7.491" class="difflineminus">-    z[2]!=0 &amp;&amp; isConsonant(z+2);</span>
<a href="#l7.492"></a><span id="l7.492" class="difflineplus">+static int star_oh(const char *z) {</span>
<a href="#l7.493"></a><span id="l7.493" class="difflineplus">+  return z[0] != 0 &amp;&amp; isConsonant(z) &amp;&amp; z[0] != 'w' &amp;&amp; z[0] != 'x' &amp;&amp;</span>
<a href="#l7.494"></a><span id="l7.494" class="difflineplus">+         z[0] != 'y' &amp;&amp; z[1] != 0 &amp;&amp; isVowel(z + 1) &amp;&amp; z[2] != 0 &amp;&amp;</span>
<a href="#l7.495"></a><span id="l7.495" class="difflineplus">+         isConsonant(z + 2);</span>
<a href="#l7.496"></a><span id="l7.496"> }</span>
<a href="#l7.497"></a><span id="l7.497"> </span>
<a href="#l7.498"></a><span id="l7.498"> /*</span>
<a href="#l7.499"></a><span id="l7.499"> ** If the word ends with zFrom and xCond() is true for the stem</span>
<a href="#l7.500"></a><span id="l7.500" class="difflineminus">-** of the word that precedes the zFrom ending, then change the </span>
<a href="#l7.501"></a><span id="l7.501" class="difflineplus">+** of the word that precedes the zFrom ending, then change the</span>
<a href="#l7.502"></a><span id="l7.502"> ** ending to zTo.</span>
<a href="#l7.503"></a><span id="l7.503"> **</span>
<a href="#l7.504"></a><span id="l7.504"> ** The input word *pz and zFrom are both in reverse order.  zTo</span>
<a href="#l7.505"></a><span id="l7.505" class="difflineminus">-** is in normal order. </span>
<a href="#l7.506"></a><span id="l7.506" class="difflineplus">+** is in normal order.</span>
<a href="#l7.507"></a><span id="l7.507"> **</span>
<a href="#l7.508"></a><span id="l7.508"> ** Return TRUE if zFrom matches.  Return FALSE if zFrom does not</span>
<a href="#l7.509"></a><span id="l7.509"> ** match.  Not that TRUE is returned even if xCond() fails and</span>
<a href="#l7.510"></a><span id="l7.510"> ** no substitution occurs.</span>
<a href="#l7.511"></a><span id="l7.511"> */</span>
<a href="#l7.512"></a><span id="l7.512"> static int stem(</span>
<a href="#l7.513"></a><span id="l7.513" class="difflineminus">-  char **pz,             /* The word being stemmed (Reversed) */</span>
<a href="#l7.514"></a><span id="l7.514" class="difflineminus">-  const char *zFrom,     /* If the ending matches this... (Reversed) */</span>
<a href="#l7.515"></a><span id="l7.515" class="difflineminus">-  const char *zTo,       /* ... change the ending to this (not reversed) */</span>
<a href="#l7.516"></a><span id="l7.516" class="difflineminus">-  int (*xCond)(const char*)   /* Condition that must be true */</span>
<a href="#l7.517"></a><span id="l7.517" class="difflineminus">-){</span>
<a href="#l7.518"></a><span id="l7.518" class="difflineplus">+    char **pz,         /* The word being stemmed (Reversed) */</span>
<a href="#l7.519"></a><span id="l7.519" class="difflineplus">+    const char *zFrom, /* If the ending matches this... (Reversed) */</span>
<a href="#l7.520"></a><span id="l7.520" class="difflineplus">+    const char *zTo,   /* ... change the ending to this (not reversed) */</span>
<a href="#l7.521"></a><span id="l7.521" class="difflineplus">+    int (*xCond)(const char *) /* Condition that must be true */</span>
<a href="#l7.522"></a><span id="l7.522" class="difflineplus">+) {</span>
<a href="#l7.523"></a><span id="l7.523">   char *z = *pz;</span>
<a href="#l7.524"></a><span id="l7.524" class="difflineminus">-  while( *zFrom &amp;&amp; *zFrom==*z ){ z++; zFrom++; }</span>
<a href="#l7.525"></a><span id="l7.525" class="difflineminus">-  if( *zFrom!=0 ) return 0;</span>
<a href="#l7.526"></a><span id="l7.526" class="difflineminus">-  if( xCond &amp;&amp; !xCond(z) ) return 1;</span>
<a href="#l7.527"></a><span id="l7.527" class="difflineminus">-  while( *zTo ){</span>
<a href="#l7.528"></a><span id="l7.528" class="difflineplus">+  while (*zFrom &amp;&amp; *zFrom == *z) {</span>
<a href="#l7.529"></a><span id="l7.529" class="difflineplus">+    z++;</span>
<a href="#l7.530"></a><span id="l7.530" class="difflineplus">+    zFrom++;</span>
<a href="#l7.531"></a><span id="l7.531" class="difflineplus">+  }</span>
<a href="#l7.532"></a><span id="l7.532" class="difflineplus">+  if (*zFrom != 0) return 0;</span>
<a href="#l7.533"></a><span id="l7.533" class="difflineplus">+  if (xCond &amp;&amp; !xCond(z)) return 1;</span>
<a href="#l7.534"></a><span id="l7.534" class="difflineplus">+  while (*zTo) {</span>
<a href="#l7.535"></a><span id="l7.535">     *(--z) = *(zTo++);</span>
<a href="#l7.536"></a><span id="l7.536">   }</span>
<a href="#l7.537"></a><span id="l7.537">   *pz = z;</span>
<a href="#l7.538"></a><span id="l7.538">   return 1;</span>
<a href="#l7.539"></a><span id="l7.539"> }</span>
<a href="#l7.540"></a><span id="l7.540"> </span>
<a href="#l7.541"></a><span id="l7.541"> /**</span>
<a href="#l7.542"></a><span id="l7.542">  * Voiced sound mark is only on Japanese.  It is like accent.  It combines with</span>
<a href="#l7.543"></a><span id="l7.543" class="difflineminus">- * previous character.  Example, &quot;サ&quot; (Katakana) with &quot;゛&quot; (voiced sound mark) is</span>
<a href="#l7.544"></a><span id="l7.544" class="difflineminus">- * &quot;ザ&quot;.  Although full-width character mapping has combined character like &quot;ザ&quot;,</span>
<a href="#l7.545"></a><span id="l7.545" class="difflineminus">- * there is no combined character on half-width Katanaka character mapping.</span>
<a href="#l7.546"></a><span id="l7.546" class="difflineplus">+ * previous character.  Example, &quot;サ&quot; (Katakana) with &quot;゛&quot; (voiced sound mark)</span>
<a href="#l7.547"></a><span id="l7.547" class="difflineplus">+ * is &quot;ザ&quot;.  Although full-width character mapping has combined character like</span>
<a href="#l7.548"></a><span id="l7.548" class="difflineplus">+ * &quot;ザ&quot;, there is no combined character on half-width Katanaka character</span>
<a href="#l7.549"></a><span id="l7.549" class="difflineplus">+ * mapping.</span>
<a href="#l7.550"></a><span id="l7.550">  */</span>
<a href="#l7.551"></a><span id="l7.551" class="difflineminus">-static int isVoicedSoundMark(const unsigned int c)</span>
<a href="#l7.552"></a><span id="l7.552" class="difflineminus">-{</span>
<a href="#l7.553"></a><span id="l7.553" class="difflineminus">-  if (c == 0xff9e || c == 0xff9f || c == 0x3099 || c == 0x309a)</span>
<a href="#l7.554"></a><span id="l7.554" class="difflineminus">-    return 1;</span>
<a href="#l7.555"></a><span id="l7.555" class="difflineplus">+static int isVoicedSoundMark(const unsigned int c) {</span>
<a href="#l7.556"></a><span id="l7.556" class="difflineplus">+  if (c == 0xff9e || c == 0xff9f || c == 0x3099 || c == 0x309a) return 1;</span>
<a href="#l7.557"></a><span id="l7.557">   return 0;</span>
<a href="#l7.558"></a><span id="l7.558"> }</span>
<a href="#l7.559"></a><span id="l7.559"> </span>
<a href="#l7.560"></a><span id="l7.560"> /**</span>
<a href="#l7.561"></a><span id="l7.561">  * How many unicode characters to take from the front and back of a term in</span>
<a href="#l7.562"></a><span id="l7.562">  * |copy_stemmer|.</span>
<a href="#l7.563"></a><span id="l7.563">  */</span>
<a href="#l7.564"></a><span id="l7.564" class="difflineminus">-#define COPY_STEMMER_COPY_HALF_LEN 10</span>
<a href="#l7.565"></a><span id="l7.565" class="difflineplus">+#  define COPY_STEMMER_COPY_HALF_LEN 10</span>
<a href="#l7.566"></a><span id="l7.566"> </span>
<a href="#l7.567"></a><span id="l7.567"> /**</span>
<a href="#l7.568"></a><span id="l7.568">  * Normalizing but non-stemming term copying.</span>
<a href="#l7.569"></a><span id="l7.569">  *</span>
<a href="#l7.570"></a><span id="l7.570">  * The original function would take 10 bytes from the front and 10 bytes from</span>
<a href="#l7.571"></a><span id="l7.571">  * the back if there were no digits in the string and it was more than 20</span>
<a href="#l7.572"></a><span id="l7.572">  * bytes long.  If there were digits involved that would decrease to 3 bytes</span>
<a href="#l7.573"></a><span id="l7.573">  * from the front and 3 from the back.  This would potentially corrupt utf-8</span>
<a href="#l7.574"></a><span id="l7.574" class="difflineat">@@ -487,34 +502,33 @@ static int isVoicedSoundMark(const unsig</span>
<a href="#l7.575"></a><span id="l7.575">  * @param nBytesIn The number of bytes in zIn, distinct from the number of</span>
<a href="#l7.576"></a><span id="l7.576">  *     unicode characters encoded in zIn.</span>
<a href="#l7.577"></a><span id="l7.577">  * @param zOut The string to write our output into.  This must have at least</span>
<a href="#l7.578"></a><span id="l7.578">  *     nBytesIn * MAX_UTF8_GROWTH_FACTOR in order to compensate for</span>
<a href="#l7.579"></a><span id="l7.579">  *     normalization that results in a larger utf-8 encoding.</span>
<a href="#l7.580"></a><span id="l7.580">  * @param pnBytesOut Integer to write the number of bytes in zOut into.</span>
<a href="#l7.581"></a><span id="l7.581">  */</span>
<a href="#l7.582"></a><span id="l7.582"> static void copy_stemmer(const unsigned char *zIn, const int nBytesIn,</span>
<a href="#l7.583"></a><span id="l7.583" class="difflineminus">-                         unsigned char *zOut, int *pnBytesOut){</span>
<a href="#l7.584"></a><span id="l7.584" class="difflineplus">+                         unsigned char *zOut, int *pnBytesOut) {</span>
<a href="#l7.585"></a><span id="l7.585">   const unsigned char *zInTerm = zIn + nBytesIn;</span>
<a href="#l7.586"></a><span id="l7.586">   unsigned char *zOutStart = zOut;</span>
<a href="#l7.587"></a><span id="l7.587">   unsigned int c;</span>
<a href="#l7.588"></a><span id="l7.588">   unsigned int charCount = 0;</span>
<a href="#l7.589"></a><span id="l7.589">   unsigned char *zFrontEnd = NULL, *zBackStart = NULL;</span>
<a href="#l7.590"></a><span id="l7.590">   unsigned int trashC;</span>
<a href="#l7.591"></a><span id="l7.591"> </span>
<a href="#l7.592"></a><span id="l7.592">   /* copy normalized character */</span>
<a href="#l7.593"></a><span id="l7.593">   while (zIn &lt; zInTerm) {</span>
<a href="#l7.594"></a><span id="l7.594">     READ_UTF8(zIn, zInTerm, c);</span>
<a href="#l7.595"></a><span id="l7.595">     c = normalize_character(c);</span>
<a href="#l7.596"></a><span id="l7.596"> </span>
<a href="#l7.597"></a><span id="l7.597">     /* ignore voiced/semi-voiced sound mark */</span>
<a href="#l7.598"></a><span id="l7.598">     if (!isVoicedSoundMark(c)) {</span>
<a href="#l7.599"></a><span id="l7.599">       /* advance one non-voiced sound mark character. */</span>
<a href="#l7.600"></a><span id="l7.600" class="difflineminus">-      if (zBackStart)</span>
<a href="#l7.601"></a><span id="l7.601" class="difflineminus">-        READ_UTF8(zBackStart, zOut, trashC);</span>
<a href="#l7.602"></a><span id="l7.602" class="difflineplus">+      if (zBackStart) READ_UTF8(zBackStart, zOut, trashC);</span>
<a href="#l7.603"></a><span id="l7.603"> </span>
<a href="#l7.604"></a><span id="l7.604">       WRITE_UTF8(zOut, c);</span>
<a href="#l7.605"></a><span id="l7.605">       charCount++;</span>
<a href="#l7.606"></a><span id="l7.606">       if (charCount == COPY_STEMMER_COPY_HALF_LEN) {</span>
<a href="#l7.607"></a><span id="l7.607">         zFrontEnd = zOut;</span>
<a href="#l7.608"></a><span id="l7.608">         zBackStart = zOutStart;</span>
<a href="#l7.609"></a><span id="l7.609">       }</span>
<a href="#l7.610"></a><span id="l7.610">     }</span>
<a href="#l7.611"></a><span id="l7.611" class="difflineat">@@ -525,417 +539,402 @@ static void copy_stemmer(const unsigned </span>
<a href="#l7.612"></a><span id="l7.612">     size_t backBytes = zOut - zBackStart;</span>
<a href="#l7.613"></a><span id="l7.613">     memmove(zFrontEnd, zBackStart, backBytes);</span>
<a href="#l7.614"></a><span id="l7.614">     zOut = zFrontEnd + backBytes;</span>
<a href="#l7.615"></a><span id="l7.615">   }</span>
<a href="#l7.616"></a><span id="l7.616">   *zOut = 0;</span>
<a href="#l7.617"></a><span id="l7.617">   *pnBytesOut = zOut - zOutStart;</span>
<a href="#l7.618"></a><span id="l7.618"> }</span>
<a href="#l7.619"></a><span id="l7.619"> </span>
<a href="#l7.620"></a><span id="l7.620" class="difflineminus">-</span>
<a href="#l7.621"></a><span id="l7.621"> /*</span>
<a href="#l7.622"></a><span id="l7.622"> ** Stem the input word zIn[0..nIn-1].  Store the output in zOut.</span>
<a href="#l7.623"></a><span id="l7.623"> ** zOut is at least big enough to hold nIn bytes.  Write the actual</span>
<a href="#l7.624"></a><span id="l7.624"> ** size of the output word (exclusive of the '\0' terminator) into *pnOut.</span>
<a href="#l7.625"></a><span id="l7.625"> **</span>
<a href="#l7.626"></a><span id="l7.626"> ** Any upper-case characters in the US-ASCII character set ([A-Z])</span>
<a href="#l7.627"></a><span id="l7.627"> ** are converted to lower case.  Upper-case UTF characters are</span>
<a href="#l7.628"></a><span id="l7.628"> ** unchanged.</span>
<a href="#l7.629"></a><span id="l7.629"> **</span>
<a href="#l7.630"></a><span id="l7.630"> ** Words that are longer than about 20 bytes are stemmed by retaining</span>
<a href="#l7.631"></a><span id="l7.631"> ** a few bytes from the beginning and the end of the word.  If the</span>
<a href="#l7.632"></a><span id="l7.632"> ** word contains digits, 3 bytes are taken from the beginning and</span>
<a href="#l7.633"></a><span id="l7.633"> ** 3 bytes from the end.  For long words without digits, 10 bytes</span>
<a href="#l7.634"></a><span id="l7.634"> ** are taken from each end.  US-ASCII case folding still applies.</span>
<a href="#l7.635"></a><span id="l7.635" class="difflineminus">-** </span>
<a href="#l7.636"></a><span id="l7.636" class="difflineminus">-** If the input word contains not digits but does characters not </span>
<a href="#l7.637"></a><span id="l7.637" class="difflineminus">-** in [a-zA-Z] then no stemming is attempted and this routine just </span>
<a href="#l7.638"></a><span id="l7.638" class="difflineplus">+**</span>
<a href="#l7.639"></a><span id="l7.639" class="difflineplus">+** If the input word contains not digits but does characters not</span>
<a href="#l7.640"></a><span id="l7.640" class="difflineplus">+** in [a-zA-Z] then no stemming is attempted and this routine just</span>
<a href="#l7.641"></a><span id="l7.641"> ** copies the input into the input into the output with US-ASCII</span>
<a href="#l7.642"></a><span id="l7.642"> ** case folding.</span>
<a href="#l7.643"></a><span id="l7.643"> **</span>
<a href="#l7.644"></a><span id="l7.644"> ** Stemming never increases the length of the word.  So there is</span>
<a href="#l7.645"></a><span id="l7.645"> ** no chance of overflowing the zOut buffer.</span>
<a href="#l7.646"></a><span id="l7.646"> */</span>
<a href="#l7.647"></a><span id="l7.647" class="difflineminus">-static void porter_stemmer(</span>
<a href="#l7.648"></a><span id="l7.648" class="difflineminus">-  const unsigned char *zIn,</span>
<a href="#l7.649"></a><span id="l7.649" class="difflineminus">-  unsigned int nIn,</span>
<a href="#l7.650"></a><span id="l7.650" class="difflineminus">-  unsigned char *zOut,</span>
<a href="#l7.651"></a><span id="l7.651" class="difflineminus">-  int *pnOut</span>
<a href="#l7.652"></a><span id="l7.652" class="difflineminus">-){</span>
<a href="#l7.653"></a><span id="l7.653" class="difflineplus">+static void porter_stemmer(const unsigned char *zIn, unsigned int nIn,</span>
<a href="#l7.654"></a><span id="l7.654" class="difflineplus">+                           unsigned char *zOut, int *pnOut) {</span>
<a href="#l7.655"></a><span id="l7.655">   unsigned int i, j, c;</span>
<a href="#l7.656"></a><span id="l7.656">   char zReverse[28];</span>
<a href="#l7.657"></a><span id="l7.657">   char *z, *z2;</span>
<a href="#l7.658"></a><span id="l7.658">   const unsigned char *zTerm = zIn + nIn;</span>
<a href="#l7.659"></a><span id="l7.659">   const unsigned char *zTmp = zIn;</span>
<a href="#l7.660"></a><span id="l7.660"> </span>
<a href="#l7.661"></a><span id="l7.661" class="difflineminus">-  if( nIn&lt;3 || nIn&gt;=sizeof(zReverse)-7 ){</span>
<a href="#l7.662"></a><span id="l7.662" class="difflineplus">+  if (nIn &lt; 3 || nIn &gt;= sizeof(zReverse) - 7) {</span>
<a href="#l7.663"></a><span id="l7.663">     /* The word is too big or too small for the porter stemmer.</span>
<a href="#l7.664"></a><span id="l7.664">     ** Fallback to the copy stemmer */</span>
<a href="#l7.665"></a><span id="l7.665">     copy_stemmer(zIn, nIn, zOut, pnOut);</span>
<a href="#l7.666"></a><span id="l7.666">     return;</span>
<a href="#l7.667"></a><span id="l7.667">   }</span>
<a href="#l7.668"></a><span id="l7.668">   for (j = sizeof(zReverse) - 6; zTmp &lt; zTerm; j--) {</span>
<a href="#l7.669"></a><span id="l7.669">     READ_UTF8(zTmp, zTerm, c);</span>
<a href="#l7.670"></a><span id="l7.670">     c = normalize_character(c);</span>
<a href="#l7.671"></a><span id="l7.671" class="difflineminus">-    if( c&gt;='a' &amp;&amp; c&lt;='z' ){</span>
<a href="#l7.672"></a><span id="l7.672" class="difflineplus">+    if (c &gt;= 'a' &amp;&amp; c &lt;= 'z') {</span>
<a href="#l7.673"></a><span id="l7.673">       zReverse[j] = c;</span>
<a href="#l7.674"></a><span id="l7.674" class="difflineminus">-    }else{</span>
<a href="#l7.675"></a><span id="l7.675" class="difflineplus">+    } else {</span>
<a href="#l7.676"></a><span id="l7.676">       /* The use of a character not in [a-zA-Z] means that we fallback</span>
<a href="#l7.677"></a><span id="l7.677">       ** to the copy stemmer */</span>
<a href="#l7.678"></a><span id="l7.678">       copy_stemmer(zIn, nIn, zOut, pnOut);</span>
<a href="#l7.679"></a><span id="l7.679">       return;</span>
<a href="#l7.680"></a><span id="l7.680">     }</span>
<a href="#l7.681"></a><span id="l7.681">   }</span>
<a href="#l7.682"></a><span id="l7.682" class="difflineminus">-  memset(&amp;zReverse[sizeof(zReverse)-5], 0, 5);</span>
<a href="#l7.683"></a><span id="l7.683" class="difflineminus">-  z = &amp;zReverse[j+1];</span>
<a href="#l7.684"></a><span id="l7.684" class="difflineminus">-</span>
<a href="#l7.685"></a><span id="l7.685" class="difflineplus">+  memset(&amp;zReverse[sizeof(zReverse) - 5], 0, 5);</span>
<a href="#l7.686"></a><span id="l7.686" class="difflineplus">+  z = &amp;zReverse[j + 1];</span>
<a href="#l7.687"></a><span id="l7.687"> </span>
<a href="#l7.688"></a><span id="l7.688">   /* Step 1a */</span>
<a href="#l7.689"></a><span id="l7.689" class="difflineminus">-  if( z[0]=='s' ){</span>
<a href="#l7.690"></a><span id="l7.690" class="difflineminus">-    if(</span>
<a href="#l7.691"></a><span id="l7.691" class="difflineminus">-     !stem(&amp;z, &quot;sess&quot;, &quot;ss&quot;, 0) &amp;&amp;</span>
<a href="#l7.692"></a><span id="l7.692" class="difflineminus">-     !stem(&amp;z, &quot;sei&quot;, &quot;i&quot;, 0)  &amp;&amp;</span>
<a href="#l7.693"></a><span id="l7.693" class="difflineminus">-     !stem(&amp;z, &quot;ss&quot;, &quot;ss&quot;, 0)</span>
<a href="#l7.694"></a><span id="l7.694" class="difflineminus">-    ){</span>
<a href="#l7.695"></a><span id="l7.695" class="difflineplus">+  if (z[0] == 's') {</span>
<a href="#l7.696"></a><span id="l7.696" class="difflineplus">+    if (!stem(&amp;z, &quot;sess&quot;, &quot;ss&quot;, 0) &amp;&amp; !stem(&amp;z, &quot;sei&quot;, &quot;i&quot;, 0) &amp;&amp;</span>
<a href="#l7.697"></a><span id="l7.697" class="difflineplus">+        !stem(&amp;z, &quot;ss&quot;, &quot;ss&quot;, 0)) {</span>
<a href="#l7.698"></a><span id="l7.698">       z++;</span>
<a href="#l7.699"></a><span id="l7.699">     }</span>
<a href="#l7.700"></a><span id="l7.700">   }</span>
<a href="#l7.701"></a><span id="l7.701"> </span>
<a href="#l7.702"></a><span id="l7.702" class="difflineminus">-  /* Step 1b */  </span>
<a href="#l7.703"></a><span id="l7.703" class="difflineplus">+  /* Step 1b */</span>
<a href="#l7.704"></a><span id="l7.704">   z2 = z;</span>
<a href="#l7.705"></a><span id="l7.705" class="difflineminus">-  if( stem(&amp;z, &quot;dee&quot;, &quot;ee&quot;, m_gt_0) ){</span>
<a href="#l7.706"></a><span id="l7.706" class="difflineplus">+  if (stem(&amp;z, &quot;dee&quot;, &quot;ee&quot;, m_gt_0)) {</span>
<a href="#l7.707"></a><span id="l7.707">     /* Do nothing.  The work was all in the test */</span>
<a href="#l7.708"></a><span id="l7.708" class="difflineminus">-  }else if( </span>
<a href="#l7.709"></a><span id="l7.709" class="difflineminus">-     (stem(&amp;z, &quot;gni&quot;, &quot;&quot;, hasVowel) || stem(&amp;z, &quot;de&quot;, &quot;&quot;, hasVowel))</span>
<a href="#l7.710"></a><span id="l7.710" class="difflineminus">-      &amp;&amp; z!=z2</span>
<a href="#l7.711"></a><span id="l7.711" class="difflineminus">-  ){</span>
<a href="#l7.712"></a><span id="l7.712" class="difflineminus">-     if( stem(&amp;z, &quot;ta&quot;, &quot;ate&quot;, 0) ||</span>
<a href="#l7.713"></a><span id="l7.713" class="difflineminus">-         stem(&amp;z, &quot;lb&quot;, &quot;ble&quot;, 0) ||</span>
<a href="#l7.714"></a><span id="l7.714" class="difflineminus">-         stem(&amp;z, &quot;zi&quot;, &quot;ize&quot;, 0) ){</span>
<a href="#l7.715"></a><span id="l7.715" class="difflineminus">-       /* Do nothing.  The work was all in the test */</span>
<a href="#l7.716"></a><span id="l7.716" class="difflineminus">-     }else if( doubleConsonant(z) &amp;&amp; (*z!='l' &amp;&amp; *z!='s' &amp;&amp; *z!='z') ){</span>
<a href="#l7.717"></a><span id="l7.717" class="difflineminus">-       z++;</span>
<a href="#l7.718"></a><span id="l7.718" class="difflineminus">-     }else if( m_eq_1(z) &amp;&amp; star_oh(z) ){</span>
<a href="#l7.719"></a><span id="l7.719" class="difflineminus">-       *(--z) = 'e';</span>
<a href="#l7.720"></a><span id="l7.720" class="difflineminus">-     }</span>
<a href="#l7.721"></a><span id="l7.721" class="difflineplus">+  } else if ((stem(&amp;z, &quot;gni&quot;, &quot;&quot;, hasVowel) || stem(&amp;z, &quot;de&quot;, &quot;&quot;, hasVowel)) &amp;&amp;</span>
<a href="#l7.722"></a><span id="l7.722" class="difflineplus">+             z != z2) {</span>
<a href="#l7.723"></a><span id="l7.723" class="difflineplus">+    if (stem(&amp;z, &quot;ta&quot;, &quot;ate&quot;, 0) || stem(&amp;z, &quot;lb&quot;, &quot;ble&quot;, 0) ||</span>
<a href="#l7.724"></a><span id="l7.724" class="difflineplus">+        stem(&amp;z, &quot;zi&quot;, &quot;ize&quot;, 0)) {</span>
<a href="#l7.725"></a><span id="l7.725" class="difflineplus">+      /* Do nothing.  The work was all in the test */</span>
<a href="#l7.726"></a><span id="l7.726" class="difflineplus">+    } else if (doubleConsonant(z) &amp;&amp; (*z != 'l' &amp;&amp; *z != 's' &amp;&amp; *z != 'z')) {</span>
<a href="#l7.727"></a><span id="l7.727" class="difflineplus">+      z++;</span>
<a href="#l7.728"></a><span id="l7.728" class="difflineplus">+    } else if (m_eq_1(z) &amp;&amp; star_oh(z)) {</span>
<a href="#l7.729"></a><span id="l7.729" class="difflineplus">+      *(--z) = 'e';</span>
<a href="#l7.730"></a><span id="l7.730" class="difflineplus">+    }</span>
<a href="#l7.731"></a><span id="l7.731">   }</span>
<a href="#l7.732"></a><span id="l7.732"> </span>
<a href="#l7.733"></a><span id="l7.733">   /* Step 1c */</span>
<a href="#l7.734"></a><span id="l7.734" class="difflineminus">-  if( z[0]=='y' &amp;&amp; hasVowel(z+1) ){</span>
<a href="#l7.735"></a><span id="l7.735" class="difflineplus">+  if (z[0] == 'y' &amp;&amp; hasVowel(z + 1)) {</span>
<a href="#l7.736"></a><span id="l7.736">     z[0] = 'i';</span>
<a href="#l7.737"></a><span id="l7.737">   }</span>
<a href="#l7.738"></a><span id="l7.738"> </span>
<a href="#l7.739"></a><span id="l7.739">   /* Step 2 */</span>
<a href="#l7.740"></a><span id="l7.740" class="difflineminus">-  switch( z[1] ){</span>
<a href="#l7.741"></a><span id="l7.741" class="difflineminus">-   case 'a':</span>
<a href="#l7.742"></a><span id="l7.742" class="difflineminus">-     (void) (stem(&amp;z, &quot;lanoita&quot;, &quot;ate&quot;, m_gt_0) ||</span>
<a href="#l7.743"></a><span id="l7.743" class="difflineplus">+  switch (z[1]) {</span>
<a href="#l7.744"></a><span id="l7.744" class="difflineplus">+    case 'a':</span>
<a href="#l7.745"></a><span id="l7.745" class="difflineplus">+      (void)(stem(&amp;z, &quot;lanoita&quot;, &quot;ate&quot;, m_gt_0) ||</span>
<a href="#l7.746"></a><span id="l7.746">              stem(&amp;z, &quot;lanoit&quot;, &quot;tion&quot;, m_gt_0));</span>
<a href="#l7.747"></a><span id="l7.747" class="difflineminus">-     break;</span>
<a href="#l7.748"></a><span id="l7.748" class="difflineminus">-   case 'c':</span>
<a href="#l7.749"></a><span id="l7.749" class="difflineminus">-     (void) (stem(&amp;z, &quot;icne&quot;, &quot;ence&quot;, m_gt_0) ||</span>
<a href="#l7.750"></a><span id="l7.750" class="difflineplus">+      break;</span>
<a href="#l7.751"></a><span id="l7.751" class="difflineplus">+    case 'c':</span>
<a href="#l7.752"></a><span id="l7.752" class="difflineplus">+      (void)(stem(&amp;z, &quot;icne&quot;, &quot;ence&quot;, m_gt_0) ||</span>
<a href="#l7.753"></a><span id="l7.753">              stem(&amp;z, &quot;icna&quot;, &quot;ance&quot;, m_gt_0));</span>
<a href="#l7.754"></a><span id="l7.754" class="difflineminus">-     break;</span>
<a href="#l7.755"></a><span id="l7.755" class="difflineminus">-   case 'e':</span>
<a href="#l7.756"></a><span id="l7.756" class="difflineminus">-     (void) (stem(&amp;z, &quot;rezi&quot;, &quot;ize&quot;, m_gt_0));</span>
<a href="#l7.757"></a><span id="l7.757" class="difflineminus">-     break;</span>
<a href="#l7.758"></a><span id="l7.758" class="difflineminus">-   case 'g':</span>
<a href="#l7.759"></a><span id="l7.759" class="difflineminus">-     (void) (stem(&amp;z, &quot;igol&quot;, &quot;log&quot;, m_gt_0));</span>
<a href="#l7.760"></a><span id="l7.760" class="difflineminus">-     break;</span>
<a href="#l7.761"></a><span id="l7.761" class="difflineminus">-   case 'l':</span>
<a href="#l7.762"></a><span id="l7.762" class="difflineminus">-     (void) (stem(&amp;z, &quot;ilb&quot;, &quot;ble&quot;, m_gt_0) ||</span>
<a href="#l7.763"></a><span id="l7.763" class="difflineminus">-             stem(&amp;z, &quot;illa&quot;, &quot;al&quot;, m_gt_0) ||</span>
<a href="#l7.764"></a><span id="l7.764" class="difflineminus">-             stem(&amp;z, &quot;iltne&quot;, &quot;ent&quot;, m_gt_0) ||</span>
<a href="#l7.765"></a><span id="l7.765" class="difflineminus">-             stem(&amp;z, &quot;ile&quot;, &quot;e&quot;, m_gt_0) ||</span>
<a href="#l7.766"></a><span id="l7.766" class="difflineplus">+      break;</span>
<a href="#l7.767"></a><span id="l7.767" class="difflineplus">+    case 'e':</span>
<a href="#l7.768"></a><span id="l7.768" class="difflineplus">+      (void)(stem(&amp;z, &quot;rezi&quot;, &quot;ize&quot;, m_gt_0));</span>
<a href="#l7.769"></a><span id="l7.769" class="difflineplus">+      break;</span>
<a href="#l7.770"></a><span id="l7.770" class="difflineplus">+    case 'g':</span>
<a href="#l7.771"></a><span id="l7.771" class="difflineplus">+      (void)(stem(&amp;z, &quot;igol&quot;, &quot;log&quot;, m_gt_0));</span>
<a href="#l7.772"></a><span id="l7.772" class="difflineplus">+      break;</span>
<a href="#l7.773"></a><span id="l7.773" class="difflineplus">+    case 'l':</span>
<a href="#l7.774"></a><span id="l7.774" class="difflineplus">+      (void)(stem(&amp;z, &quot;ilb&quot;, &quot;ble&quot;, m_gt_0) || stem(&amp;z, &quot;illa&quot;, &quot;al&quot;, m_gt_0) ||</span>
<a href="#l7.775"></a><span id="l7.775" class="difflineplus">+             stem(&amp;z, &quot;iltne&quot;, &quot;ent&quot;, m_gt_0) || stem(&amp;z, &quot;ile&quot;, &quot;e&quot;, m_gt_0) ||</span>
<a href="#l7.776"></a><span id="l7.776">              stem(&amp;z, &quot;ilsuo&quot;, &quot;ous&quot;, m_gt_0));</span>
<a href="#l7.777"></a><span id="l7.777" class="difflineminus">-     break;</span>
<a href="#l7.778"></a><span id="l7.778" class="difflineminus">-   case 'o':</span>
<a href="#l7.779"></a><span id="l7.779" class="difflineminus">-     (void) (stem(&amp;z, &quot;noitazi&quot;, &quot;ize&quot;, m_gt_0) ||</span>
<a href="#l7.780"></a><span id="l7.780" class="difflineplus">+      break;</span>
<a href="#l7.781"></a><span id="l7.781" class="difflineplus">+    case 'o':</span>
<a href="#l7.782"></a><span id="l7.782" class="difflineplus">+      (void)(stem(&amp;z, &quot;noitazi&quot;, &quot;ize&quot;, m_gt_0) ||</span>
<a href="#l7.783"></a><span id="l7.783">              stem(&amp;z, &quot;noita&quot;, &quot;ate&quot;, m_gt_0) ||</span>
<a href="#l7.784"></a><span id="l7.784">              stem(&amp;z, &quot;rota&quot;, &quot;ate&quot;, m_gt_0));</span>
<a href="#l7.785"></a><span id="l7.785" class="difflineminus">-     break;</span>
<a href="#l7.786"></a><span id="l7.786" class="difflineminus">-   case 's':</span>
<a href="#l7.787"></a><span id="l7.787" class="difflineminus">-     (void) (stem(&amp;z, &quot;msila&quot;, &quot;al&quot;, m_gt_0) ||</span>
<a href="#l7.788"></a><span id="l7.788" class="difflineplus">+      break;</span>
<a href="#l7.789"></a><span id="l7.789" class="difflineplus">+    case 's':</span>
<a href="#l7.790"></a><span id="l7.790" class="difflineplus">+      (void)(stem(&amp;z, &quot;msila&quot;, &quot;al&quot;, m_gt_0) ||</span>
<a href="#l7.791"></a><span id="l7.791">              stem(&amp;z, &quot;ssenevi&quot;, &quot;ive&quot;, m_gt_0) ||</span>
<a href="#l7.792"></a><span id="l7.792">              stem(&amp;z, &quot;ssenluf&quot;, &quot;ful&quot;, m_gt_0) ||</span>
<a href="#l7.793"></a><span id="l7.793">              stem(&amp;z, &quot;ssensuo&quot;, &quot;ous&quot;, m_gt_0));</span>
<a href="#l7.794"></a><span id="l7.794" class="difflineminus">-     break;</span>
<a href="#l7.795"></a><span id="l7.795" class="difflineminus">-   case 't':</span>
<a href="#l7.796"></a><span id="l7.796" class="difflineminus">-     (void) (stem(&amp;z, &quot;itila&quot;, &quot;al&quot;, m_gt_0) ||</span>
<a href="#l7.797"></a><span id="l7.797" class="difflineplus">+      break;</span>
<a href="#l7.798"></a><span id="l7.798" class="difflineplus">+    case 't':</span>
<a href="#l7.799"></a><span id="l7.799" class="difflineplus">+      (void)(stem(&amp;z, &quot;itila&quot;, &quot;al&quot;, m_gt_0) ||</span>
<a href="#l7.800"></a><span id="l7.800">              stem(&amp;z, &quot;itivi&quot;, &quot;ive&quot;, m_gt_0) ||</span>
<a href="#l7.801"></a><span id="l7.801">              stem(&amp;z, &quot;itilib&quot;, &quot;ble&quot;, m_gt_0));</span>
<a href="#l7.802"></a><span id="l7.802" class="difflineminus">-     break;</span>
<a href="#l7.803"></a><span id="l7.803" class="difflineplus">+      break;</span>
<a href="#l7.804"></a><span id="l7.804">   }</span>
<a href="#l7.805"></a><span id="l7.805"> </span>
<a href="#l7.806"></a><span id="l7.806">   /* Step 3 */</span>
<a href="#l7.807"></a><span id="l7.807" class="difflineminus">-  switch( z[0] ){</span>
<a href="#l7.808"></a><span id="l7.808" class="difflineminus">-   case 'e':</span>
<a href="#l7.809"></a><span id="l7.809" class="difflineminus">-     (void) (stem(&amp;z, &quot;etaci&quot;, &quot;ic&quot;, m_gt_0) ||</span>
<a href="#l7.810"></a><span id="l7.810" class="difflineminus">-             stem(&amp;z, &quot;evita&quot;, &quot;&quot;, m_gt_0)   ||</span>
<a href="#l7.811"></a><span id="l7.811" class="difflineplus">+  switch (z[0]) {</span>
<a href="#l7.812"></a><span id="l7.812" class="difflineplus">+    case 'e':</span>
<a href="#l7.813"></a><span id="l7.813" class="difflineplus">+      (void)(stem(&amp;z, &quot;etaci&quot;, &quot;ic&quot;, m_gt_0) || stem(&amp;z, &quot;evita&quot;, &quot;&quot;, m_gt_0) ||</span>
<a href="#l7.814"></a><span id="l7.814">              stem(&amp;z, &quot;ezila&quot;, &quot;al&quot;, m_gt_0));</span>
<a href="#l7.815"></a><span id="l7.815" class="difflineminus">-     break;</span>
<a href="#l7.816"></a><span id="l7.816" class="difflineminus">-   case 'i':</span>
<a href="#l7.817"></a><span id="l7.817" class="difflineminus">-     (void) (stem(&amp;z, &quot;itici&quot;, &quot;ic&quot;, m_gt_0));</span>
<a href="#l7.818"></a><span id="l7.818" class="difflineminus">-     break;</span>
<a href="#l7.819"></a><span id="l7.819" class="difflineminus">-   case 'l':</span>
<a href="#l7.820"></a><span id="l7.820" class="difflineminus">-     (void) (stem(&amp;z, &quot;laci&quot;, &quot;ic&quot;, m_gt_0) ||</span>
<a href="#l7.821"></a><span id="l7.821" class="difflineminus">-             stem(&amp;z, &quot;luf&quot;, &quot;&quot;, m_gt_0));</span>
<a href="#l7.822"></a><span id="l7.822" class="difflineminus">-     break;</span>
<a href="#l7.823"></a><span id="l7.823" class="difflineminus">-   case 's':</span>
<a href="#l7.824"></a><span id="l7.824" class="difflineminus">-     (void) (stem(&amp;z, &quot;ssen&quot;, &quot;&quot;, m_gt_0));</span>
<a href="#l7.825"></a><span id="l7.825" class="difflineminus">-     break;</span>
<a href="#l7.826"></a><span id="l7.826" class="difflineplus">+      break;</span>
<a href="#l7.827"></a><span id="l7.827" class="difflineplus">+    case 'i':</span>
<a href="#l7.828"></a><span id="l7.828" class="difflineplus">+      (void)(stem(&amp;z, &quot;itici&quot;, &quot;ic&quot;, m_gt_0));</span>
<a href="#l7.829"></a><span id="l7.829" class="difflineplus">+      break;</span>
<a href="#l7.830"></a><span id="l7.830" class="difflineplus">+    case 'l':</span>
<a href="#l7.831"></a><span id="l7.831" class="difflineplus">+      (void)(stem(&amp;z, &quot;laci&quot;, &quot;ic&quot;, m_gt_0) || stem(&amp;z, &quot;luf&quot;, &quot;&quot;, m_gt_0));</span>
<a href="#l7.832"></a><span id="l7.832" class="difflineplus">+      break;</span>
<a href="#l7.833"></a><span id="l7.833" class="difflineplus">+    case 's':</span>
<a href="#l7.834"></a><span id="l7.834" class="difflineplus">+      (void)(stem(&amp;z, &quot;ssen&quot;, &quot;&quot;, m_gt_0));</span>
<a href="#l7.835"></a><span id="l7.835" class="difflineplus">+      break;</span>
<a href="#l7.836"></a><span id="l7.836">   }</span>
<a href="#l7.837"></a><span id="l7.837"> </span>
<a href="#l7.838"></a><span id="l7.838">   /* Step 4 */</span>
<a href="#l7.839"></a><span id="l7.839" class="difflineminus">-  switch( z[1] ){</span>
<a href="#l7.840"></a><span id="l7.840" class="difflineminus">-   case 'a':</span>
<a href="#l7.841"></a><span id="l7.841" class="difflineminus">-     if( z[0]=='l' &amp;&amp; m_gt_1(z+2) ){</span>
<a href="#l7.842"></a><span id="l7.842" class="difflineminus">-       z += 2;</span>
<a href="#l7.843"></a><span id="l7.843" class="difflineminus">-     }</span>
<a href="#l7.844"></a><span id="l7.844" class="difflineminus">-     break;</span>
<a href="#l7.845"></a><span id="l7.845" class="difflineminus">-   case 'c':</span>
<a href="#l7.846"></a><span id="l7.846" class="difflineminus">-     if( z[0]=='e' &amp;&amp; z[2]=='n' &amp;&amp; (z[3]=='a' || z[3]=='e')  &amp;&amp; m_gt_1(z+4)  ){</span>
<a href="#l7.847"></a><span id="l7.847" class="difflineminus">-       z += 4;</span>
<a href="#l7.848"></a><span id="l7.848" class="difflineminus">-     }</span>
<a href="#l7.849"></a><span id="l7.849" class="difflineminus">-     break;</span>
<a href="#l7.850"></a><span id="l7.850" class="difflineminus">-   case 'e':</span>
<a href="#l7.851"></a><span id="l7.851" class="difflineminus">-     if( z[0]=='r' &amp;&amp; m_gt_1(z+2) ){</span>
<a href="#l7.852"></a><span id="l7.852" class="difflineminus">-       z += 2;</span>
<a href="#l7.853"></a><span id="l7.853" class="difflineminus">-     }</span>
<a href="#l7.854"></a><span id="l7.854" class="difflineminus">-     break;</span>
<a href="#l7.855"></a><span id="l7.855" class="difflineminus">-   case 'i':</span>
<a href="#l7.856"></a><span id="l7.856" class="difflineminus">-     if( z[0]=='c' &amp;&amp; m_gt_1(z+2) ){</span>
<a href="#l7.857"></a><span id="l7.857" class="difflineminus">-       z += 2;</span>
<a href="#l7.858"></a><span id="l7.858" class="difflineminus">-     }</span>
<a href="#l7.859"></a><span id="l7.859" class="difflineminus">-     break;</span>
<a href="#l7.860"></a><span id="l7.860" class="difflineminus">-   case 'l':</span>
<a href="#l7.861"></a><span id="l7.861" class="difflineminus">-     if( z[0]=='e' &amp;&amp; z[2]=='b' &amp;&amp; (z[3]=='a' || z[3]=='i') &amp;&amp; m_gt_1(z+4) ){</span>
<a href="#l7.862"></a><span id="l7.862" class="difflineminus">-       z += 4;</span>
<a href="#l7.863"></a><span id="l7.863" class="difflineminus">-     }</span>
<a href="#l7.864"></a><span id="l7.864" class="difflineminus">-     break;</span>
<a href="#l7.865"></a><span id="l7.865" class="difflineminus">-   case 'n':</span>
<a href="#l7.866"></a><span id="l7.866" class="difflineminus">-     if( z[0]=='t' ){</span>
<a href="#l7.867"></a><span id="l7.867" class="difflineminus">-       if( z[2]=='a' ){</span>
<a href="#l7.868"></a><span id="l7.868" class="difflineminus">-         if( m_gt_1(z+3) ){</span>
<a href="#l7.869"></a><span id="l7.869" class="difflineminus">-           z += 3;</span>
<a href="#l7.870"></a><span id="l7.870" class="difflineminus">-         }</span>
<a href="#l7.871"></a><span id="l7.871" class="difflineminus">-       }else if( z[2]=='e' ){</span>
<a href="#l7.872"></a><span id="l7.872" class="difflineminus">-         (void) (stem(&amp;z, &quot;tneme&quot;, &quot;&quot;, m_gt_1) ||</span>
<a href="#l7.873"></a><span id="l7.873" class="difflineminus">-                 stem(&amp;z, &quot;tnem&quot;, &quot;&quot;, m_gt_1) ||</span>
<a href="#l7.874"></a><span id="l7.874" class="difflineminus">-                 stem(&amp;z, &quot;tne&quot;, &quot;&quot;, m_gt_1));</span>
<a href="#l7.875"></a><span id="l7.875" class="difflineminus">-       }</span>
<a href="#l7.876"></a><span id="l7.876" class="difflineminus">-     }</span>
<a href="#l7.877"></a><span id="l7.877" class="difflineminus">-     break;</span>
<a href="#l7.878"></a><span id="l7.878" class="difflineminus">-   case 'o':</span>
<a href="#l7.879"></a><span id="l7.879" class="difflineminus">-     if( z[0]=='u' ){</span>
<a href="#l7.880"></a><span id="l7.880" class="difflineminus">-       if( m_gt_1(z+2) ){</span>
<a href="#l7.881"></a><span id="l7.881" class="difflineminus">-         z += 2;</span>
<a href="#l7.882"></a><span id="l7.882" class="difflineminus">-       }</span>
<a href="#l7.883"></a><span id="l7.883" class="difflineminus">-     }else if( z[3]=='s' || z[3]=='t' ){</span>
<a href="#l7.884"></a><span id="l7.884" class="difflineminus">-       (void) (stem(&amp;z, &quot;noi&quot;, &quot;&quot;, m_gt_1));</span>
<a href="#l7.885"></a><span id="l7.885" class="difflineminus">-     }</span>
<a href="#l7.886"></a><span id="l7.886" class="difflineminus">-     break;</span>
<a href="#l7.887"></a><span id="l7.887" class="difflineminus">-   case 's':</span>
<a href="#l7.888"></a><span id="l7.888" class="difflineminus">-     if( z[0]=='m' &amp;&amp; z[2]=='i' &amp;&amp; m_gt_1(z+3) ){</span>
<a href="#l7.889"></a><span id="l7.889" class="difflineminus">-       z += 3;</span>
<a href="#l7.890"></a><span id="l7.890" class="difflineminus">-     }</span>
<a href="#l7.891"></a><span id="l7.891" class="difflineminus">-     break;</span>
<a href="#l7.892"></a><span id="l7.892" class="difflineminus">-   case 't':</span>
<a href="#l7.893"></a><span id="l7.893" class="difflineminus">-     (void) (stem(&amp;z, &quot;eta&quot;, &quot;&quot;, m_gt_1) ||</span>
<a href="#l7.894"></a><span id="l7.894" class="difflineminus">-             stem(&amp;z, &quot;iti&quot;, &quot;&quot;, m_gt_1));</span>
<a href="#l7.895"></a><span id="l7.895" class="difflineminus">-     break;</span>
<a href="#l7.896"></a><span id="l7.896" class="difflineminus">-   case 'u':</span>
<a href="#l7.897"></a><span id="l7.897" class="difflineminus">-     if( z[0]=='s' &amp;&amp; z[2]=='o' &amp;&amp; m_gt_1(z+3) ){</span>
<a href="#l7.898"></a><span id="l7.898" class="difflineminus">-       z += 3;</span>
<a href="#l7.899"></a><span id="l7.899" class="difflineminus">-     }</span>
<a href="#l7.900"></a><span id="l7.900" class="difflineminus">-     break;</span>
<a href="#l7.901"></a><span id="l7.901" class="difflineminus">-   case 'v':</span>
<a href="#l7.902"></a><span id="l7.902" class="difflineminus">-   case 'z':</span>
<a href="#l7.903"></a><span id="l7.903" class="difflineminus">-     if( z[0]=='e' &amp;&amp; z[2]=='i' &amp;&amp; m_gt_1(z+3) ){</span>
<a href="#l7.904"></a><span id="l7.904" class="difflineminus">-       z += 3;</span>
<a href="#l7.905"></a><span id="l7.905" class="difflineminus">-     }</span>
<a href="#l7.906"></a><span id="l7.906" class="difflineminus">-     break;</span>
<a href="#l7.907"></a><span id="l7.907" class="difflineplus">+  switch (z[1]) {</span>
<a href="#l7.908"></a><span id="l7.908" class="difflineplus">+    case 'a':</span>
<a href="#l7.909"></a><span id="l7.909" class="difflineplus">+      if (z[0] == 'l' &amp;&amp; m_gt_1(z + 2)) {</span>
<a href="#l7.910"></a><span id="l7.910" class="difflineplus">+        z += 2;</span>
<a href="#l7.911"></a><span id="l7.911" class="difflineplus">+      }</span>
<a href="#l7.912"></a><span id="l7.912" class="difflineplus">+      break;</span>
<a href="#l7.913"></a><span id="l7.913" class="difflineplus">+    case 'c':</span>
<a href="#l7.914"></a><span id="l7.914" class="difflineplus">+      if (z[0] == 'e' &amp;&amp; z[2] == 'n' &amp;&amp; (z[3] == 'a' || z[3] == 'e') &amp;&amp;</span>
<a href="#l7.915"></a><span id="l7.915" class="difflineplus">+          m_gt_1(z + 4)) {</span>
<a href="#l7.916"></a><span id="l7.916" class="difflineplus">+        z += 4;</span>
<a href="#l7.917"></a><span id="l7.917" class="difflineplus">+      }</span>
<a href="#l7.918"></a><span id="l7.918" class="difflineplus">+      break;</span>
<a href="#l7.919"></a><span id="l7.919" class="difflineplus">+    case 'e':</span>
<a href="#l7.920"></a><span id="l7.920" class="difflineplus">+      if (z[0] == 'r' &amp;&amp; m_gt_1(z + 2)) {</span>
<a href="#l7.921"></a><span id="l7.921" class="difflineplus">+        z += 2;</span>
<a href="#l7.922"></a><span id="l7.922" class="difflineplus">+      }</span>
<a href="#l7.923"></a><span id="l7.923" class="difflineplus">+      break;</span>
<a href="#l7.924"></a><span id="l7.924" class="difflineplus">+    case 'i':</span>
<a href="#l7.925"></a><span id="l7.925" class="difflineplus">+      if (z[0] == 'c' &amp;&amp; m_gt_1(z + 2)) {</span>
<a href="#l7.926"></a><span id="l7.926" class="difflineplus">+        z += 2;</span>
<a href="#l7.927"></a><span id="l7.927" class="difflineplus">+      }</span>
<a href="#l7.928"></a><span id="l7.928" class="difflineplus">+      break;</span>
<a href="#l7.929"></a><span id="l7.929" class="difflineplus">+    case 'l':</span>
<a href="#l7.930"></a><span id="l7.930" class="difflineplus">+      if (z[0] == 'e' &amp;&amp; z[2] == 'b' &amp;&amp; (z[3] == 'a' || z[3] == 'i') &amp;&amp;</span>
<a href="#l7.931"></a><span id="l7.931" class="difflineplus">+          m_gt_1(z + 4)) {</span>
<a href="#l7.932"></a><span id="l7.932" class="difflineplus">+        z += 4;</span>
<a href="#l7.933"></a><span id="l7.933" class="difflineplus">+      }</span>
<a href="#l7.934"></a><span id="l7.934" class="difflineplus">+      break;</span>
<a href="#l7.935"></a><span id="l7.935" class="difflineplus">+    case 'n':</span>
<a href="#l7.936"></a><span id="l7.936" class="difflineplus">+      if (z[0] == 't') {</span>
<a href="#l7.937"></a><span id="l7.937" class="difflineplus">+        if (z[2] == 'a') {</span>
<a href="#l7.938"></a><span id="l7.938" class="difflineplus">+          if (m_gt_1(z + 3)) {</span>
<a href="#l7.939"></a><span id="l7.939" class="difflineplus">+            z += 3;</span>
<a href="#l7.940"></a><span id="l7.940" class="difflineplus">+          }</span>
<a href="#l7.941"></a><span id="l7.941" class="difflineplus">+        } else if (z[2] == 'e') {</span>
<a href="#l7.942"></a><span id="l7.942" class="difflineplus">+          (void)(stem(&amp;z, &quot;tneme&quot;, &quot;&quot;, m_gt_1) ||</span>
<a href="#l7.943"></a><span id="l7.943" class="difflineplus">+                 stem(&amp;z, &quot;tnem&quot;, &quot;&quot;, m_gt_1) || stem(&amp;z, &quot;tne&quot;, &quot;&quot;, m_gt_1));</span>
<a href="#l7.944"></a><span id="l7.944" class="difflineplus">+        }</span>
<a href="#l7.945"></a><span id="l7.945" class="difflineplus">+      }</span>
<a href="#l7.946"></a><span id="l7.946" class="difflineplus">+      break;</span>
<a href="#l7.947"></a><span id="l7.947" class="difflineplus">+    case 'o':</span>
<a href="#l7.948"></a><span id="l7.948" class="difflineplus">+      if (z[0] == 'u') {</span>
<a href="#l7.949"></a><span id="l7.949" class="difflineplus">+        if (m_gt_1(z + 2)) {</span>
<a href="#l7.950"></a><span id="l7.950" class="difflineplus">+          z += 2;</span>
<a href="#l7.951"></a><span id="l7.951" class="difflineplus">+        }</span>
<a href="#l7.952"></a><span id="l7.952" class="difflineplus">+      } else if (z[3] == 's' || z[3] == 't') {</span>
<a href="#l7.953"></a><span id="l7.953" class="difflineplus">+        (void)(stem(&amp;z, &quot;noi&quot;, &quot;&quot;, m_gt_1));</span>
<a href="#l7.954"></a><span id="l7.954" class="difflineplus">+      }</span>
<a href="#l7.955"></a><span id="l7.955" class="difflineplus">+      break;</span>
<a href="#l7.956"></a><span id="l7.956" class="difflineplus">+    case 's':</span>
<a href="#l7.957"></a><span id="l7.957" class="difflineplus">+      if (z[0] == 'm' &amp;&amp; z[2] == 'i' &amp;&amp; m_gt_1(z + 3)) {</span>
<a href="#l7.958"></a><span id="l7.958" class="difflineplus">+        z += 3;</span>
<a href="#l7.959"></a><span id="l7.959" class="difflineplus">+      }</span>
<a href="#l7.960"></a><span id="l7.960" class="difflineplus">+      break;</span>
<a href="#l7.961"></a><span id="l7.961" class="difflineplus">+    case 't':</span>
<a href="#l7.962"></a><span id="l7.962" class="difflineplus">+      (void)(stem(&amp;z, &quot;eta&quot;, &quot;&quot;, m_gt_1) || stem(&amp;z, &quot;iti&quot;, &quot;&quot;, m_gt_1));</span>
<a href="#l7.963"></a><span id="l7.963" class="difflineplus">+      break;</span>
<a href="#l7.964"></a><span id="l7.964" class="difflineplus">+    case 'u':</span>
<a href="#l7.965"></a><span id="l7.965" class="difflineplus">+      if (z[0] == 's' &amp;&amp; z[2] == 'o' &amp;&amp; m_gt_1(z + 3)) {</span>
<a href="#l7.966"></a><span id="l7.966" class="difflineplus">+        z += 3;</span>
<a href="#l7.967"></a><span id="l7.967" class="difflineplus">+      }</span>
<a href="#l7.968"></a><span id="l7.968" class="difflineplus">+      break;</span>
<a href="#l7.969"></a><span id="l7.969" class="difflineplus">+    case 'v':</span>
<a href="#l7.970"></a><span id="l7.970" class="difflineplus">+    case 'z':</span>
<a href="#l7.971"></a><span id="l7.971" class="difflineplus">+      if (z[0] == 'e' &amp;&amp; z[2] == 'i' &amp;&amp; m_gt_1(z + 3)) {</span>
<a href="#l7.972"></a><span id="l7.972" class="difflineplus">+        z += 3;</span>
<a href="#l7.973"></a><span id="l7.973" class="difflineplus">+      }</span>
<a href="#l7.974"></a><span id="l7.974" class="difflineplus">+      break;</span>
<a href="#l7.975"></a><span id="l7.975">   }</span>
<a href="#l7.976"></a><span id="l7.976"> </span>
<a href="#l7.977"></a><span id="l7.977">   /* Step 5a */</span>
<a href="#l7.978"></a><span id="l7.978" class="difflineminus">-  if( z[0]=='e' ){</span>
<a href="#l7.979"></a><span id="l7.979" class="difflineminus">-    if( m_gt_1(z+1) ){</span>
<a href="#l7.980"></a><span id="l7.980" class="difflineplus">+  if (z[0] == 'e') {</span>
<a href="#l7.981"></a><span id="l7.981" class="difflineplus">+    if (m_gt_1(z + 1)) {</span>
<a href="#l7.982"></a><span id="l7.982">       z++;</span>
<a href="#l7.983"></a><span id="l7.983" class="difflineminus">-    }else if( m_eq_1(z+1) &amp;&amp; !star_oh(z+1) ){</span>
<a href="#l7.984"></a><span id="l7.984" class="difflineplus">+    } else if (m_eq_1(z + 1) &amp;&amp; !star_oh(z + 1)) {</span>
<a href="#l7.985"></a><span id="l7.985">       z++;</span>
<a href="#l7.986"></a><span id="l7.986">     }</span>
<a href="#l7.987"></a><span id="l7.987">   }</span>
<a href="#l7.988"></a><span id="l7.988"> </span>
<a href="#l7.989"></a><span id="l7.989">   /* Step 5b */</span>
<a href="#l7.990"></a><span id="l7.990" class="difflineminus">-  if( m_gt_1(z) &amp;&amp; z[0]=='l' &amp;&amp; z[1]=='l' ){</span>
<a href="#l7.991"></a><span id="l7.991" class="difflineplus">+  if (m_gt_1(z) &amp;&amp; z[0] == 'l' &amp;&amp; z[1] == 'l') {</span>
<a href="#l7.992"></a><span id="l7.992">     z++;</span>
<a href="#l7.993"></a><span id="l7.993">   }</span>
<a href="#l7.994"></a><span id="l7.994"> </span>
<a href="#l7.995"></a><span id="l7.995">   /* z[] is now the stemmed word in reverse order.  Flip it back</span>
<a href="#l7.996"></a><span id="l7.996">   ** around into forward order and return.</span>
<a href="#l7.997"></a><span id="l7.997">   */</span>
<a href="#l7.998"></a><span id="l7.998">   *pnOut = i = strlen(z);</span>
<a href="#l7.999"></a><span id="l7.999">   zOut[i] = 0;</span>
<a href="#l7.1000"></a><span id="l7.1000" class="difflineminus">-  while( *z ){</span>
<a href="#l7.1001"></a><span id="l7.1001" class="difflineplus">+  while (*z) {</span>
<a href="#l7.1002"></a><span id="l7.1002">     zOut[--i] = *(z++);</span>
<a href="#l7.1003"></a><span id="l7.1003">   }</span>
<a href="#l7.1004"></a><span id="l7.1004"> }</span>
<a href="#l7.1005"></a><span id="l7.1005"> </span>
<a href="#l7.1006"></a><span id="l7.1006"> /**</span>
<a href="#l7.1007"></a><span id="l7.1007">  * Indicate whether characters in the 0x30 - 0x7f region can be part of a token.</span>
<a href="#l7.1008"></a><span id="l7.1008">  * Letters and numbers can; punctuation (and 'del') can't.</span>
<a href="#l7.1009"></a><span id="l7.1009">  */</span>
<a href="#l7.1010"></a><span id="l7.1010"> static const char porterIdChar[] = {</span>
<a href="#l7.1011"></a><span id="l7.1011" class="difflineminus">-/* x0 x1 x2 x3 x4 x5 x6 x7 x8 x9 xA xB xC xD xE xF */</span>
<a href="#l7.1012"></a><span id="l7.1012" class="difflineminus">-    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0,  /* 3x */</span>
<a href="#l7.1013"></a><span id="l7.1013" class="difflineminus">-    0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,  /* 4x */</span>
<a href="#l7.1014"></a><span id="l7.1014" class="difflineminus">-    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1,  /* 5x */</span>
<a href="#l7.1015"></a><span id="l7.1015" class="difflineminus">-    0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,  /* 6x */</span>
<a href="#l7.1016"></a><span id="l7.1016" class="difflineminus">-    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0,  /* 7x */</span>
<a href="#l7.1017"></a><span id="l7.1017" class="difflineplus">+    /* x0 x1 x2 x3 x4 x5 x6 x7 x8 x9 xA xB xC xD xE xF */</span>
<a href="#l7.1018"></a><span id="l7.1018" class="difflineplus">+    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, /* 3x */</span>
<a href="#l7.1019"></a><span id="l7.1019" class="difflineplus">+    0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, /* 4x */</span>
<a href="#l7.1020"></a><span id="l7.1020" class="difflineplus">+    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, /* 5x */</span>
<a href="#l7.1021"></a><span id="l7.1021" class="difflineplus">+    0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, /* 6x */</span>
<a href="#l7.1022"></a><span id="l7.1022" class="difflineplus">+    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, /* 7x */</span>
<a href="#l7.1023"></a><span id="l7.1023"> };</span>
<a href="#l7.1024"></a><span id="l7.1024"> </span>
<a href="#l7.1025"></a><span id="l7.1025"> /**</span>
<a href="#l7.1026"></a><span id="l7.1026">  * Test whether a character is a (non-ascii) space character or not.  isDelim</span>
<a href="#l7.1027"></a><span id="l7.1027">  *  uses the existing porter stemmer logic for anything in the ASCII (&lt; 0x80)</span>
<a href="#l7.1028"></a><span id="l7.1028">  *  space which covers 0x20.</span>
<a href="#l7.1029"></a><span id="l7.1029">  *</span>
<a href="#l7.1030"></a><span id="l7.1030">  * 0x2000-0x206F is the general punctuation table.  0x2000 - 0x200b are spaces.</span>
<a href="#l7.1031"></a><span id="l7.1031">  *  The spaces 0x2000 - 0x200a are all defined as roughly equivalent to a</span>
<a href="#l7.1032"></a><span id="l7.1032">  *  standard 0x20 space.  0x200b is a &quot;zero width space&quot; (ZWSP) and not like an</span>
<a href="#l7.1033"></a><span id="l7.1033">  *  0x20 space.  0x202f is a narrow no-break space and roughly equivalent to an</span>
<a href="#l7.1034"></a><span id="l7.1034">  *  0x20 space.  0x205f is a &quot;medium mathematical space&quot; and defined as roughly</span>
<a href="#l7.1035"></a><span id="l7.1035">  *  equivalent to an 0x20 space.</span>
<a href="#l7.1036"></a><span id="l7.1036">  */</span>
<a href="#l7.1037"></a><span id="l7.1037" class="difflineminus">-#define IS_UNI_SPACE(x) (((x)&gt;=0x2000&amp;&amp;(x)&lt;=0x200a) || (x)==0x202f || (x)==0x205f)</span>
<a href="#l7.1038"></a><span id="l7.1038" class="difflineplus">+#  define IS_UNI_SPACE(x) \</span>
<a href="#l7.1039"></a><span id="l7.1039" class="difflineplus">+    (((x) &gt;= 0x2000 &amp;&amp; (x) &lt;= 0x200a) || (x) == 0x202f || (x) == 0x205f)</span>
<a href="#l7.1040"></a><span id="l7.1040"> /**</span>
<a href="#l7.1041"></a><span id="l7.1041">  * What we are checking for:</span>
<a href="#l7.1042"></a><span id="l7.1042">  * - 0x3001: Ideographic comma (-&gt; 0x2c ',')</span>
<a href="#l7.1043"></a><span id="l7.1043">  * - 0x3002: Ideographic full stop (-&gt; 0x2e '.')</span>
<a href="#l7.1044"></a><span id="l7.1044">  * - 0xff0c: fullwidth comma (~ wide 0x2c ',')</span>
<a href="#l7.1045"></a><span id="l7.1045">  * - 0xff0e: fullwidth full stop (~ wide 0x2e '.')</span>
<a href="#l7.1046"></a><span id="l7.1046">  * - 0xff61: halfwidth ideographic full stop (~ narrow 0x3002)</span>
<a href="#l7.1047"></a><span id="l7.1047">  * - 0xff64: halfwidth ideographic comma (~ narrow 0x3001)</span>
<a href="#l7.1048"></a><span id="l7.1048">  *</span>
<a href="#l7.1049"></a><span id="l7.1049">  * It is possible we should be treating other things as delimiters!</span>
<a href="#l7.1050"></a><span id="l7.1050">  */</span>
<a href="#l7.1051"></a><span id="l7.1051" class="difflineminus">-#define IS_JA_DELIM(x) (((x)==0x3001)||((x)==0xFF64)||((x)==0xFF0E)||((x)==0x3002)||((x)==0xFF61)||((x)==0xFF0C))</span>
<a href="#l7.1052"></a><span id="l7.1052" class="difflineplus">+#  define IS_JA_DELIM(x)                                      \</span>
<a href="#l7.1053"></a><span id="l7.1053" class="difflineplus">+    (((x) == 0x3001) || ((x) == 0xFF64) || ((x) == 0xFF0E) || \</span>
<a href="#l7.1054"></a><span id="l7.1054" class="difflineplus">+     ((x) == 0x3002) || ((x) == 0xFF61) || ((x) == 0xFF0C))</span>
<a href="#l7.1055"></a><span id="l7.1055"> </span>
<a href="#l7.1056"></a><span id="l7.1056"> /**</span>
<a href="#l7.1057"></a><span id="l7.1057">  * The previous character was a delimiter (which includes the start of the</span>
<a href="#l7.1058"></a><span id="l7.1058">  *  string).</span>
<a href="#l7.1059"></a><span id="l7.1059">  */</span>
<a href="#l7.1060"></a><span id="l7.1060" class="difflineminus">-#define BIGRAM_RESET   0</span>
<a href="#l7.1061"></a><span id="l7.1061" class="difflineplus">+#  define BIGRAM_RESET 0</span>
<a href="#l7.1062"></a><span id="l7.1062"> /**</span>
<a href="#l7.1063"></a><span id="l7.1063">  * The previous character was a CJK character and we have only seen one of them.</span>
<a href="#l7.1064"></a><span id="l7.1064">  *  If we had seen more than one in a row it would be the BIGRAM_USE state.</span>
<a href="#l7.1065"></a><span id="l7.1065">  */</span>
<a href="#l7.1066"></a><span id="l7.1066" class="difflineminus">-#define BIGRAM_UNKNOWN 1</span>
<a href="#l7.1067"></a><span id="l7.1067" class="difflineplus">+#  define BIGRAM_UNKNOWN 1</span>
<a href="#l7.1068"></a><span id="l7.1068"> /**</span>
<a href="#l7.1069"></a><span id="l7.1069">  * We have seen two or more CJK characters in a row.</span>
<a href="#l7.1070"></a><span id="l7.1070">  */</span>
<a href="#l7.1071"></a><span id="l7.1071" class="difflineminus">-#define BIGRAM_USE     2</span>
<a href="#l7.1072"></a><span id="l7.1072" class="difflineplus">+#  define BIGRAM_USE 2</span>
<a href="#l7.1073"></a><span id="l7.1073"> /**</span>
<a href="#l7.1074"></a><span id="l7.1074">  * The previous character was ASCII or something in the unicode general scripts</span>
<a href="#l7.1075"></a><span id="l7.1075">  *  area that we do not believe is a delimiter.  We call it 'alpha' as in</span>
<a href="#l7.1076"></a><span id="l7.1076">  *  alphabetic/alphanumeric and something that should be tokenized based on</span>
<a href="#l7.1077"></a><span id="l7.1077">  *  delimiters rather than on a bi-gram basis.</span>
<a href="#l7.1078"></a><span id="l7.1078">  */</span>
<a href="#l7.1079"></a><span id="l7.1079" class="difflineminus">-#define BIGRAM_ALPHA   3</span>
<a href="#l7.1080"></a><span id="l7.1080" class="difflineplus">+#  define BIGRAM_ALPHA 3</span>
<a href="#l7.1081"></a><span id="l7.1081"> </span>
<a href="#l7.1082"></a><span id="l7.1082"> static int isDelim(</span>
<a href="#l7.1083"></a><span id="l7.1083" class="difflineminus">-  const unsigned char *zCur,    /* IN: current pointer of token */</span>
<a href="#l7.1084"></a><span id="l7.1084" class="difflineminus">-  const unsigned char *zTerm,   /* IN: one character beyond end of token */</span>
<a href="#l7.1085"></a><span id="l7.1085" class="difflineminus">-  int *len,                     /* OUT: analyzed bytes in this token */</span>
<a href="#l7.1086"></a><span id="l7.1086" class="difflineminus">-  int *state                    /* IN/OUT: analyze state */</span>
<a href="#l7.1087"></a><span id="l7.1087" class="difflineminus">-){</span>
<a href="#l7.1088"></a><span id="l7.1088" class="difflineplus">+    const unsigned char *zCur,  /* IN: current pointer of token */</span>
<a href="#l7.1089"></a><span id="l7.1089" class="difflineplus">+    const unsigned char *zTerm, /* IN: one character beyond end of token */</span>
<a href="#l7.1090"></a><span id="l7.1090" class="difflineplus">+    int *len,                   /* OUT: analyzed bytes in this token */</span>
<a href="#l7.1091"></a><span id="l7.1091" class="difflineplus">+    int *state                  /* IN/OUT: analyze state */</span>
<a href="#l7.1092"></a><span id="l7.1092" class="difflineplus">+) {</span>
<a href="#l7.1093"></a><span id="l7.1093">   const unsigned char *zIn = zCur;</span>
<a href="#l7.1094"></a><span id="l7.1094">   unsigned int c;</span>
<a href="#l7.1095"></a><span id="l7.1095">   int delim;</span>
<a href="#l7.1096"></a><span id="l7.1096"> </span>
<a href="#l7.1097"></a><span id="l7.1097">   /* get the unicode character to analyze */</span>
<a href="#l7.1098"></a><span id="l7.1098">   READ_UTF8(zIn, zTerm, c);</span>
<a href="#l7.1099"></a><span id="l7.1099">   c = normalize_character(c);</span>
<a href="#l7.1100"></a><span id="l7.1100">   *len = zIn - zCur;</span>
<a href="#l7.1101"></a><span id="l7.1101"> </span>
<a href="#l7.1102"></a><span id="l7.1102">   /* ASCII character range has rule */</span>
<a href="#l7.1103"></a><span id="l7.1103" class="difflineminus">-  if( c &lt; 0x80 ){</span>
<a href="#l7.1104"></a><span id="l7.1104" class="difflineplus">+  if (c &lt; 0x80) {</span>
<a href="#l7.1105"></a><span id="l7.1105">     // This is original porter stemmer isDelim logic.</span>
<a href="#l7.1106"></a><span id="l7.1106">     // 0x0 - 0x1f are all control characters, 0x20 is space, 0x21-0x2f are</span>
<a href="#l7.1107"></a><span id="l7.1107">     //  punctuation.</span>
<a href="#l7.1108"></a><span id="l7.1108">     delim = (c &lt; 0x30 || !porterIdChar[c - 0x30]);</span>
<a href="#l7.1109"></a><span id="l7.1109">     // cases: &quot;&amp;a&quot;, &quot;&amp;.&quot;</span>
<a href="#l7.1110"></a><span id="l7.1110" class="difflineminus">-    if (*state == BIGRAM_USE || *state == BIGRAM_UNKNOWN ){</span>
<a href="#l7.1111"></a><span id="l7.1111" class="difflineplus">+    if (*state == BIGRAM_USE || *state == BIGRAM_UNKNOWN) {</span>
<a href="#l7.1112"></a><span id="l7.1112">       /* previous maybe CJK and current is ascii */</span>
<a href="#l7.1113"></a><span id="l7.1113">       *state = BIGRAM_ALPHA; /*ascii*/</span>
<a href="#l7.1114"></a><span id="l7.1114" class="difflineminus">-      delim = 1; /* must break */</span>
<a href="#l7.1115"></a><span id="l7.1115" class="difflineplus">+      delim = 1;             /* must break */</span>
<a href="#l7.1116"></a><span id="l7.1116">     } else if (delim == 1) {</span>
<a href="#l7.1117"></a><span id="l7.1117">       // cases: &quot;a.&quot;, &quot;..&quot;</span>
<a href="#l7.1118"></a><span id="l7.1118">       /* this is delimiter character */</span>
<a href="#l7.1119"></a><span id="l7.1119">       *state = BIGRAM_RESET; /*reset*/</span>
<a href="#l7.1120"></a><span id="l7.1120">     } else {</span>
<a href="#l7.1121"></a><span id="l7.1121">       // cases: &quot;aa&quot;, &quot;.a&quot;</span>
<a href="#l7.1122"></a><span id="l7.1122">       *state = BIGRAM_ALPHA; /*ascii*/</span>
<a href="#l7.1123"></a><span id="l7.1123">     }</span>
<a href="#l7.1124"></a><span id="l7.1124">     return delim;</span>
<a href="#l7.1125"></a><span id="l7.1125">   }</span>
<a href="#l7.1126"></a><span id="l7.1126"> </span>
<a href="#l7.1127"></a><span id="l7.1127">   // (at this point we must be a non-ASCII character)</span>
<a href="#l7.1128"></a><span id="l7.1128"> </span>
<a href="#l7.1129"></a><span id="l7.1129">   /* voiced/semi-voiced sound mark is ignore */</span>
<a href="#l7.1130"></a><span id="l7.1130">   if (isVoicedSoundMark(c) &amp;&amp; *state != BIGRAM_ALPHA) {</span>
<a href="#l7.1131"></a><span id="l7.1131">     /* ignore this because it is combined with previous char */</span>
<a href="#l7.1132"></a><span id="l7.1132" class="difflineminus">-   return 0;</span>
<a href="#l7.1133"></a><span id="l7.1133" class="difflineplus">+    return 0;</span>
<a href="#l7.1134"></a><span id="l7.1134">   }</span>
<a href="#l7.1135"></a><span id="l7.1135"> </span>
<a href="#l7.1136"></a><span id="l7.1136">   /* this isn't CJK range, so return as no delim */</span>
<a href="#l7.1137"></a><span id="l7.1137" class="difflineminus">-  // Anything less than 0x2000 (except to U+0E00-U+0EFF and  U+1780-U+17FF) </span>
<a href="#l7.1138"></a><span id="l7.1138" class="difflineplus">+  // Anything less than 0x2000 (except to U+0E00-U+0EFF and  U+1780-U+17FF)</span>
<a href="#l7.1139"></a><span id="l7.1139">   // is the general scripts area and should not be bi-gram indexed.</span>
<a href="#l7.1140"></a><span id="l7.1140">   // 0xa000 - 0a4cf is the Yi area.  It is apparently a phonetic language whose</span>
<a href="#l7.1141"></a><span id="l7.1141">   //  usage does not appear to have simple delimiter rules, so we're leaving it</span>
<a href="#l7.1142"></a><span id="l7.1142">   //  as bigram processed.  This is a guess, if you know better, let us know.</span>
<a href="#l7.1143"></a><span id="l7.1143">   //  (We previously bailed on this range too.)</span>
<a href="#l7.1144"></a><span id="l7.1144">   // Addition, U+0E00-U+0E7F is Thai, U+0E80-U+0EFF is Laos,</span>
<a href="#l7.1145"></a><span id="l7.1145">   // and U+1780-U+17FF is Khmer.  It is no easy way to break each word.</span>
<a href="#l7.1146"></a><span id="l7.1146" class="difflineminus">-  // So these should use bi-gram too. </span>
<a href="#l7.1147"></a><span id="l7.1147" class="difflineplus">+  // So these should use bi-gram too.</span>
<a href="#l7.1148"></a><span id="l7.1148">   // cases: &quot;aa&quot;, &quot;.a&quot;, &quot;&amp;a&quot;</span>
<a href="#l7.1149"></a><span id="l7.1149" class="difflineminus">-  if (c &lt; 0xe00 ||</span>
<a href="#l7.1150"></a><span id="l7.1150" class="difflineminus">-     (c &gt;= 0xf00 &amp;&amp; c &lt; 0x1780) ||</span>
<a href="#l7.1151"></a><span id="l7.1151" class="difflineminus">-     (c &gt;= 0x1800 &amp;&amp; c &lt; 0x2000)) {</span>
<a href="#l7.1152"></a><span id="l7.1152" class="difflineplus">+  if (c &lt; 0xe00 || (c &gt;= 0xf00 &amp;&amp; c &lt; 0x1780) || (c &gt;= 0x1800 &amp;&amp; c &lt; 0x2000)) {</span>
<a href="#l7.1153"></a><span id="l7.1153">     *state = BIGRAM_ALPHA; /* not really ASCII but same idea; tokenize it */</span>
<a href="#l7.1154"></a><span id="l7.1154">     return 0;</span>
<a href="#l7.1155"></a><span id="l7.1155">   }</span>
<a href="#l7.1156"></a><span id="l7.1156"> </span>
<a href="#l7.1157"></a><span id="l7.1157">   // (at this point we must be a bi-grammable char or delimiter)</span>
<a href="#l7.1158"></a><span id="l7.1158"> </span>
<a href="#l7.1159"></a><span id="l7.1159">   /* this is space character or delim character */</span>
<a href="#l7.1160"></a><span id="l7.1160">   // cases: &quot;a.&quot;, &quot;..&quot;, &quot;&amp;.&quot;</span>
<a href="#l7.1161"></a><span id="l7.1161" class="difflineminus">-  if( IS_UNI_SPACE(c) || IS_JA_DELIM(c) ){</span>
<a href="#l7.1162"></a><span id="l7.1162" class="difflineplus">+  if (IS_UNI_SPACE(c) || IS_JA_DELIM(c)) {</span>
<a href="#l7.1163"></a><span id="l7.1163">     *state = BIGRAM_RESET; /* reset */</span>
<a href="#l7.1164"></a><span id="l7.1164" class="difflineminus">-    return 1; /* it actually is a delimiter; report as such */</span>
<a href="#l7.1165"></a><span id="l7.1165" class="difflineplus">+    return 1;              /* it actually is a delimiter; report as such */</span>
<a href="#l7.1166"></a><span id="l7.1166">   }</span>
<a href="#l7.1167"></a><span id="l7.1167"> </span>
<a href="#l7.1168"></a><span id="l7.1168">   // (at this point we must be a bi-grammable char)</span>
<a href="#l7.1169"></a><span id="l7.1169"> </span>
<a href="#l7.1170"></a><span id="l7.1170">   // cases: &quot;a&amp;&quot;</span>
<a href="#l7.1171"></a><span id="l7.1171" class="difflineminus">-  if( *state==BIGRAM_ALPHA ){</span>
<a href="#l7.1172"></a><span id="l7.1172" class="difflineplus">+  if (*state == BIGRAM_ALPHA) {</span>
<a href="#l7.1173"></a><span id="l7.1173">     /* Previous is ascii and current maybe CJK */</span>
<a href="#l7.1174"></a><span id="l7.1174">     *state = BIGRAM_UNKNOWN; /* mark as unknown */</span>
<a href="#l7.1175"></a><span id="l7.1175" class="difflineminus">-    return 1; /* break to emit the ASCII token*/</span>
<a href="#l7.1176"></a><span id="l7.1176" class="difflineplus">+    return 1;                /* break to emit the ASCII token*/</span>
<a href="#l7.1177"></a><span id="l7.1177">   }</span>
<a href="#l7.1178"></a><span id="l7.1178"> </span>
<a href="#l7.1179"></a><span id="l7.1179">   /* We have no rule for CJK!. use bi-gram */</span>
<a href="#l7.1180"></a><span id="l7.1180">   // cases: &quot;&amp;&amp;&quot;</span>
<a href="#l7.1181"></a><span id="l7.1181" class="difflineminus">-  if( *state==BIGRAM_UNKNOWN || *state==BIGRAM_USE ){</span>
<a href="#l7.1182"></a><span id="l7.1182" class="difflineplus">+  if (*state == BIGRAM_UNKNOWN || *state == BIGRAM_USE) {</span>
<a href="#l7.1183"></a><span id="l7.1183">     /* previous state is unknown.  mark as bi-gram */</span>
<a href="#l7.1184"></a><span id="l7.1184">     *state = BIGRAM_USE;</span>
<a href="#l7.1185"></a><span id="l7.1185">     return 1; /* break to emit the digram */</span>
<a href="#l7.1186"></a><span id="l7.1186">   }</span>
<a href="#l7.1187"></a><span id="l7.1187"> </span>
<a href="#l7.1188"></a><span id="l7.1188">   // cases: &quot;.&amp;&quot; (*state == BIGRAM_RESET)</span>
<a href="#l7.1189"></a><span id="l7.1189">   *state = BIGRAM_UNKNOWN; /* mark as unknown */</span>
<a href="#l7.1190"></a><span id="l7.1190" class="difflineminus">-  return 0; /* no need to break; nothing to emit */</span>
<a href="#l7.1191"></a><span id="l7.1191" class="difflineplus">+  return 0;                /* no need to break; nothing to emit */</span>
<a href="#l7.1192"></a><span id="l7.1192"> }</span>
<a href="#l7.1193"></a><span id="l7.1193"> </span>
<a href="#l7.1194"></a><span id="l7.1194"> /**</span>
<a href="#l7.1195"></a><span id="l7.1195">  * Generate a new token.  There are basically three types of token we can</span>
<a href="#l7.1196"></a><span id="l7.1196">  *  generate:</span>
<a href="#l7.1197"></a><span id="l7.1197">  * - A porter stemmed token.  This is a word entirely comprised of ASCII</span>
<a href="#l7.1198"></a><span id="l7.1198">  *    characters.  We run the porter stemmer algorithm against the word.</span>
<a href="#l7.1199"></a><span id="l7.1199">  *    Because we have no way to know what is and is not an English word</span>
<a href="#l7.1200"></a><span id="l7.1200" class="difflineat">@@ -975,29 +974,29 @@ static int isDelim(</span>
<a href="#l7.1201"></a><span id="l7.1201">  * - &amp;a: If the state was BIGRAM_USE, we generate a bi-gram token.  If the state</span>
<a href="#l7.1202"></a><span id="l7.1202">  *        was BIGRAM_UNKNOWN we had only seen one CJK character and so don't do</span>
<a href="#l7.1203"></a><span id="l7.1203">  *        anything.  State is set to BIGRAM_ALPHA.</span>
<a href="#l7.1204"></a><span id="l7.1204">  * - &amp;.: Same as the &quot;&amp;a&quot; case, but state is set to BIGRAM_RESET.</span>
<a href="#l7.1205"></a><span id="l7.1205">  * - &amp;&amp;: We will generate a bi-gram token.  State was either BIGRAM_UNKNOWN or</span>
<a href="#l7.1206"></a><span id="l7.1206">  *        BIGRAM_USE, gets set to BIGRAM_USE.</span>
<a href="#l7.1207"></a><span id="l7.1207">  */</span>
<a href="#l7.1208"></a><span id="l7.1208"> static int porterNext(</span>
<a href="#l7.1209"></a><span id="l7.1209" class="difflineminus">-  sqlite3_tokenizer_cursor *pCursor,  /* Cursor returned by porterOpen */</span>
<a href="#l7.1210"></a><span id="l7.1210" class="difflineminus">-  const char **pzToken,               /* OUT: *pzToken is the token text */</span>
<a href="#l7.1211"></a><span id="l7.1211" class="difflineminus">-  int *pnBytes,                       /* OUT: Number of bytes in token */</span>
<a href="#l7.1212"></a><span id="l7.1212" class="difflineminus">-  int *piStartOffset,                 /* OUT: Starting offset of token */</span>
<a href="#l7.1213"></a><span id="l7.1213" class="difflineminus">-  int *piEndOffset,                   /* OUT: Ending offset of token */</span>
<a href="#l7.1214"></a><span id="l7.1214" class="difflineminus">-  int *piPosition                     /* OUT: Position integer of token */</span>
<a href="#l7.1215"></a><span id="l7.1215" class="difflineminus">-){</span>
<a href="#l7.1216"></a><span id="l7.1216" class="difflineminus">-  porter_tokenizer_cursor *c = (porter_tokenizer_cursor *) pCursor;</span>
<a href="#l7.1217"></a><span id="l7.1217" class="difflineminus">-  const unsigned char *z = (unsigned char *) c-&gt;zInput;</span>
<a href="#l7.1218"></a><span id="l7.1218" class="difflineplus">+    sqlite3_tokenizer_cursor *pCursor, /* Cursor returned by porterOpen */</span>
<a href="#l7.1219"></a><span id="l7.1219" class="difflineplus">+    const char **pzToken,              /* OUT: *pzToken is the token text */</span>
<a href="#l7.1220"></a><span id="l7.1220" class="difflineplus">+    int *pnBytes,                      /* OUT: Number of bytes in token */</span>
<a href="#l7.1221"></a><span id="l7.1221" class="difflineplus">+    int *piStartOffset,                /* OUT: Starting offset of token */</span>
<a href="#l7.1222"></a><span id="l7.1222" class="difflineplus">+    int *piEndOffset,                  /* OUT: Ending offset of token */</span>
<a href="#l7.1223"></a><span id="l7.1223" class="difflineplus">+    int *piPosition                    /* OUT: Position integer of token */</span>
<a href="#l7.1224"></a><span id="l7.1224" class="difflineplus">+) {</span>
<a href="#l7.1225"></a><span id="l7.1225" class="difflineplus">+  porter_tokenizer_cursor *c = (porter_tokenizer_cursor *)pCursor;</span>
<a href="#l7.1226"></a><span id="l7.1226" class="difflineplus">+  const unsigned char *z = (unsigned char *)c-&gt;zInput;</span>
<a href="#l7.1227"></a><span id="l7.1227">   int len = 0;</span>
<a href="#l7.1228"></a><span id="l7.1228">   int state;</span>
<a href="#l7.1229"></a><span id="l7.1229"> </span>
<a href="#l7.1230"></a><span id="l7.1230" class="difflineminus">-  while( c-&gt;iOffset &lt; c-&gt;nInput ){</span>
<a href="#l7.1231"></a><span id="l7.1231" class="difflineplus">+  while (c-&gt;iOffset &lt; c-&gt;nInput) {</span>
<a href="#l7.1232"></a><span id="l7.1232">     int iStartOffset, numChars;</span>
<a href="#l7.1233"></a><span id="l7.1233"> </span>
<a href="#l7.1234"></a><span id="l7.1234">     /*</span>
<a href="#l7.1235"></a><span id="l7.1235">      * This loop basically has two modes of operation:</span>
<a href="#l7.1236"></a><span id="l7.1236">      * - general processing (iPrevBigramOffset == 0 here)</span>
<a href="#l7.1237"></a><span id="l7.1237">      * - CJK processing (iPrevBigramOffset != 0 here)</span>
<a href="#l7.1238"></a><span id="l7.1238">      *</span>
<a href="#l7.1239"></a><span id="l7.1239">      * In an general processing pass we skip over all the delimiters, leaving us</span>
<a href="#l7.1240"></a><span id="l7.1240" class="difflineat">@@ -1005,23 +1004,23 @@ static int porterNext(</span>
<a href="#l7.1241"></a><span id="l7.1241">      *  token (state == BIGRAM_USE) or an ALPHA token (state == BIGRAM_ALPHA).</span>
<a href="#l7.1242"></a><span id="l7.1242">      * If it was a CJK token, we transition into CJK state for the next loop.</span>
<a href="#l7.1243"></a><span id="l7.1243">      * If it was an alpha token, our current offset is pointing at a delimiter</span>
<a href="#l7.1244"></a><span id="l7.1244">      *  (which could be a CJK character), so it is good that our next pass</span>
<a href="#l7.1245"></a><span id="l7.1245">      *  through the function and loop will skip over any delimiters.  If the</span>
<a href="#l7.1246"></a><span id="l7.1246">      *  delimiter we hit was a CJK character, the next time through we will</span>
<a href="#l7.1247"></a><span id="l7.1247">      *  not treat it as a delimiter though; the entry state for that scan is</span>
<a href="#l7.1248"></a><span id="l7.1248">      *  BIGRAM_RESET so the transition is not treated as a delimiter!</span>
<a href="#l7.1249"></a><span id="l7.1249" class="difflineminus">-     * </span>
<a href="#l7.1250"></a><span id="l7.1250" class="difflineplus">+     *</span>
<a href="#l7.1251"></a><span id="l7.1251">      * The CJK pass always starts with the second character in a bi-gram emitted</span>
<a href="#l7.1252"></a><span id="l7.1252">      *  as a token in the previous step.  No delimiter skipping is required</span>
<a href="#l7.1253"></a><span id="l7.1253">      *  because we know that first character might produce a token for us.  It</span>
<a href="#l7.1254"></a><span id="l7.1254">      *  only 'might' produce a token because the previous pass performed no</span>
<a href="#l7.1255"></a><span id="l7.1255">      *  lookahead and cannot be sure it is followed by another CJK character.</span>
<a href="#l7.1256"></a><span id="l7.1256" class="difflineminus">-     *  This is why </span>
<a href="#l7.1257"></a><span id="l7.1257" class="difflineplus">+     *  This is why</span>
<a href="#l7.1258"></a><span id="l7.1258">      */</span>
<a href="#l7.1259"></a><span id="l7.1259"> </span>
<a href="#l7.1260"></a><span id="l7.1260">     // If we have a previous bigram offset</span>
<a href="#l7.1261"></a><span id="l7.1261">     if (c-&gt;iPrevBigramOffset == 0) {</span>
<a href="#l7.1262"></a><span id="l7.1262">       /* Scan past delimiter characters */</span>
<a href="#l7.1263"></a><span id="l7.1263">       state = BIGRAM_RESET; /* reset */</span>
<a href="#l7.1264"></a><span id="l7.1264">       while (c-&gt;iOffset &lt; c-&gt;nInput &amp;&amp;</span>
<a href="#l7.1265"></a><span id="l7.1265">              isDelim(z + c-&gt;iOffset, z + c-&gt;nInput, &amp;len, &amp;state)) {</span>
<a href="#l7.1266"></a><span id="l7.1266" class="difflineat">@@ -1085,66 +1084,57 @@ static int porterNext(</span>
<a href="#l7.1267"></a><span id="l7.1267">      *  nInput and the character at iOffset is '*'.  Because the state gets</span>
<a href="#l7.1268"></a><span id="l7.1268">      *  clobbered by the incidence of '*' our requirement for CJK is that the</span>
<a href="#l7.1269"></a><span id="l7.1269">      *  implied character length is at least 3 given that it takes at least 3</span>
<a href="#l7.1270"></a><span id="l7.1270">      *  bytes to encode to 0x2000.</span>
<a href="#l7.1271"></a><span id="l7.1271">      */</span>
<a href="#l7.1272"></a><span id="l7.1272">     // It is possible we have no token to emit here if iPrevBigramOffset was not</span>
<a href="#l7.1273"></a><span id="l7.1273">     //  0 on entry and there was no second CJK character.  iPrevBigramOffset</span>
<a href="#l7.1274"></a><span id="l7.1274">     //  will now be 0 if that is the case (and c-&gt;iOffset == iStartOffset).</span>
<a href="#l7.1275"></a><span id="l7.1275" class="difflineminus">-    if (// allow two-character words only if in bigram</span>
<a href="#l7.1276"></a><span id="l7.1276" class="difflineplus">+    if (  // allow two-character words only if in bigram</span>
<a href="#l7.1277"></a><span id="l7.1277">         (numChars == 2 &amp;&amp; state == BIGRAM_USE) ||</span>
<a href="#l7.1278"></a><span id="l7.1278">         // otherwise, drop two-letter words (considered stop-words)</span>
<a href="#l7.1279"></a><span id="l7.1279" class="difflineminus">-        (numChars &gt;=3) ||</span>
<a href="#l7.1280"></a><span id="l7.1280" class="difflineplus">+        (numChars &gt;= 3) ||</span>
<a href="#l7.1281"></a><span id="l7.1281">         // wildcard case:</span>
<a href="#l7.1282"></a><span id="l7.1282" class="difflineminus">-        (numChars == 1 &amp;&amp; iStartOffset == 0 &amp;&amp;</span>
<a href="#l7.1283"></a><span id="l7.1283" class="difflineminus">-         (c-&gt;iOffset &gt;= 3) &amp;&amp;</span>
<a href="#l7.1284"></a><span id="l7.1284" class="difflineminus">-         (c-&gt;iOffset == c-&gt;nInput - 1) &amp;&amp;</span>
<a href="#l7.1285"></a><span id="l7.1285" class="difflineminus">-         (z[c-&gt;iOffset] == '*'))) {</span>
<a href="#l7.1286"></a><span id="l7.1286" class="difflineplus">+        (numChars == 1 &amp;&amp; iStartOffset == 0 &amp;&amp; (c-&gt;iOffset &gt;= 3) &amp;&amp;</span>
<a href="#l7.1287"></a><span id="l7.1287" class="difflineplus">+         (c-&gt;iOffset == c-&gt;nInput - 1) &amp;&amp; (z[c-&gt;iOffset] == '*'))) {</span>
<a href="#l7.1288"></a><span id="l7.1288">       /* figure out the number of bytes to copy/stem */</span>
<a href="#l7.1289"></a><span id="l7.1289">       int n = c-&gt;iOffset - iStartOffset;</span>
<a href="#l7.1290"></a><span id="l7.1290">       /* make sure there is enough buffer space */</span>
<a href="#l7.1291"></a><span id="l7.1291">       if (n * MAX_UTF8_GROWTH_FACTOR &gt; c-&gt;nAllocated) {</span>
<a href="#l7.1292"></a><span id="l7.1292">         c-&gt;nAllocated = n * MAX_UTF8_GROWTH_FACTOR + 20;</span>
<a href="#l7.1293"></a><span id="l7.1293">         c-&gt;zToken = sqlite3_realloc(c-&gt;zToken, c-&gt;nAllocated);</span>
<a href="#l7.1294"></a><span id="l7.1294" class="difflineminus">-        if (c-&gt;zToken == NULL)</span>
<a href="#l7.1295"></a><span id="l7.1295" class="difflineminus">-          return SQLITE_NOMEM;</span>
<a href="#l7.1296"></a><span id="l7.1296" class="difflineplus">+        if (c-&gt;zToken == NULL) return SQLITE_NOMEM;</span>
<a href="#l7.1297"></a><span id="l7.1297">       }</span>
<a href="#l7.1298"></a><span id="l7.1298"> </span>
<a href="#l7.1299"></a><span id="l7.1299">       if (state == BIGRAM_USE) {</span>
<a href="#l7.1300"></a><span id="l7.1300">         /* This is by bigram. So it is unnecessary to convert word */</span>
<a href="#l7.1301"></a><span id="l7.1301">         copy_stemmer(&amp;z[iStartOffset], n, c-&gt;zToken, pnBytes);</span>
<a href="#l7.1302"></a><span id="l7.1302">       } else {</span>
<a href="#l7.1303"></a><span id="l7.1303">         porter_stemmer(&amp;z[iStartOffset], n, c-&gt;zToken, pnBytes);</span>
<a href="#l7.1304"></a><span id="l7.1304">       }</span>
<a href="#l7.1305"></a><span id="l7.1305" class="difflineminus">-      *pzToken = (const char*)c-&gt;zToken;</span>
<a href="#l7.1306"></a><span id="l7.1306" class="difflineplus">+      *pzToken = (const char *)c-&gt;zToken;</span>
<a href="#l7.1307"></a><span id="l7.1307">       *piStartOffset = iStartOffset;</span>
<a href="#l7.1308"></a><span id="l7.1308">       *piEndOffset = c-&gt;iOffset;</span>
<a href="#l7.1309"></a><span id="l7.1309">       *piPosition = c-&gt;iToken++;</span>
<a href="#l7.1310"></a><span id="l7.1310">       return SQLITE_OK;</span>
<a href="#l7.1311"></a><span id="l7.1311">     }</span>
<a href="#l7.1312"></a><span id="l7.1312">   }</span>
<a href="#l7.1313"></a><span id="l7.1313">   return SQLITE_DONE;</span>
<a href="#l7.1314"></a><span id="l7.1314"> }</span>
<a href="#l7.1315"></a><span id="l7.1315"> </span>
<a href="#l7.1316"></a><span id="l7.1316"> /*</span>
<a href="#l7.1317"></a><span id="l7.1317"> ** The set of routines that implement the porter-stemmer tokenizer</span>
<a href="#l7.1318"></a><span id="l7.1318"> */</span>
<a href="#l7.1319"></a><span id="l7.1319"> static const sqlite3_tokenizer_module porterTokenizerModule = {</span>
<a href="#l7.1320"></a><span id="l7.1320" class="difflineminus">-  0,</span>
<a href="#l7.1321"></a><span id="l7.1321" class="difflineminus">-  porterCreate,</span>
<a href="#l7.1322"></a><span id="l7.1322" class="difflineminus">-  porterDestroy,</span>
<a href="#l7.1323"></a><span id="l7.1323" class="difflineminus">-  porterOpen,</span>
<a href="#l7.1324"></a><span id="l7.1324" class="difflineminus">-  porterClose,</span>
<a href="#l7.1325"></a><span id="l7.1325" class="difflineminus">-  porterNext,</span>
<a href="#l7.1326"></a><span id="l7.1326" class="difflineplus">+    0, porterCreate, porterDestroy, porterOpen, porterClose, porterNext,</span>
<a href="#l7.1327"></a><span id="l7.1327"> };</span>
<a href="#l7.1328"></a><span id="l7.1328"> </span>
<a href="#l7.1329"></a><span id="l7.1329"> /*</span>
<a href="#l7.1330"></a><span id="l7.1330"> ** Allocate a new porter tokenizer.  Return a pointer to the new</span>
<a href="#l7.1331"></a><span id="l7.1331"> ** tokenizer in *ppModule</span>
<a href="#l7.1332"></a><span id="l7.1332"> */</span>
<a href="#l7.1333"></a><span id="l7.1333"> void sqlite3Fts3PorterTokenizerModule(</span>
<a href="#l7.1334"></a><span id="l7.1334" class="difflineminus">-  sqlite3_tokenizer_module const**ppModule</span>
<a href="#l7.1335"></a><span id="l7.1335" class="difflineminus">-){</span>
<a href="#l7.1336"></a><span id="l7.1336" class="difflineplus">+    sqlite3_tokenizer_module const **ppModule) {</span>
<a href="#l7.1337"></a><span id="l7.1337">   *ppModule = &amp;porterTokenizerModule;</span>
<a href="#l7.1338"></a><span id="l7.1338"> }</span>
<a href="#l7.1339"></a><span id="l7.1339"> </span>
<a href="#l7.1340"></a><span id="l7.1340"> #endif /* !defined(SQLITE_CORE) || defined(SQLITE_ENABLE_FTS3) */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/extensions/fts3/src/fts3_tokenizer.h</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/extensions/fts3/src/fts3_tokenizer.h</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -45,17 +45,16 @@</span>
<a href="#l8.4"></a><span id="l8.4"> ** the tokenization rules supplied by a specific sqlite3_tokenizer</span>
<a href="#l8.5"></a><span id="l8.5"> ** object.</span>
<a href="#l8.6"></a><span id="l8.6"> */</span>
<a href="#l8.7"></a><span id="l8.7"> typedef struct sqlite3_tokenizer_module sqlite3_tokenizer_module;</span>
<a href="#l8.8"></a><span id="l8.8"> typedef struct sqlite3_tokenizer sqlite3_tokenizer;</span>
<a href="#l8.9"></a><span id="l8.9"> typedef struct sqlite3_tokenizer_cursor sqlite3_tokenizer_cursor;</span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11"> struct sqlite3_tokenizer_module {</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-</span>
<a href="#l8.13"></a><span id="l8.13">   /*</span>
<a href="#l8.14"></a><span id="l8.14">   ** Structure version. Should always be set to 0.</span>
<a href="#l8.15"></a><span id="l8.15">   */</span>
<a href="#l8.16"></a><span id="l8.16">   int iVersion;</span>
<a href="#l8.17"></a><span id="l8.17"> </span>
<a href="#l8.18"></a><span id="l8.18">   /*</span>
<a href="#l8.19"></a><span id="l8.19">   ** Create a new tokenizer. The values in the argv[] array are the</span>
<a href="#l8.20"></a><span id="l8.20">   ** arguments passed to the &quot;tokenizer&quot; clause of the CREATE VIRTUAL</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineat">@@ -68,37 +67,36 @@ struct sqlite3_tokenizer_module {</span>
<a href="#l8.22"></a><span id="l8.22">   ** to the strings &quot;arg1&quot; and &quot;arg2&quot;.</span>
<a href="#l8.23"></a><span id="l8.23">   **</span>
<a href="#l8.24"></a><span id="l8.24">   ** This method should return either SQLITE_OK (0), or an SQLite error</span>
<a href="#l8.25"></a><span id="l8.25">   ** code. If SQLITE_OK is returned, then *ppTokenizer should be set</span>
<a href="#l8.26"></a><span id="l8.26">   ** to point at the newly created tokenizer structure. The generic</span>
<a href="#l8.27"></a><span id="l8.27">   ** sqlite3_tokenizer.pModule variable should not be initialised by</span>
<a href="#l8.28"></a><span id="l8.28">   ** this callback. The caller will do so.</span>
<a href="#l8.29"></a><span id="l8.29">   */</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-  int (*xCreate)(</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-    int argc,                           /* Size of argv array */</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-    const char *const*argv,             /* Tokenizer argument strings */</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-    sqlite3_tokenizer **ppTokenizer     /* OUT: Created tokenizer */</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+  int (*xCreate)(int argc,                /* Size of argv array */</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+                 const char *const *argv, /* Tokenizer argument strings */</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+                 sqlite3_tokenizer **ppTokenizer /* OUT: Created tokenizer */</span>
<a href="#l8.37"></a><span id="l8.37">   );</span>
<a href="#l8.38"></a><span id="l8.38"> </span>
<a href="#l8.39"></a><span id="l8.39">   /*</span>
<a href="#l8.40"></a><span id="l8.40">   ** Destroy an existing tokenizer. The fts3 module calls this method</span>
<a href="#l8.41"></a><span id="l8.41">   ** exactly once for each successful call to xCreate().</span>
<a href="#l8.42"></a><span id="l8.42">   */</span>
<a href="#l8.43"></a><span id="l8.43">   int (*xDestroy)(sqlite3_tokenizer *pTokenizer);</span>
<a href="#l8.44"></a><span id="l8.44"> </span>
<a href="#l8.45"></a><span id="l8.45">   /*</span>
<a href="#l8.46"></a><span id="l8.46">   ** Create a tokenizer cursor to tokenize an input buffer. The caller</span>
<a href="#l8.47"></a><span id="l8.47">   ** is responsible for ensuring that the input buffer remains valid</span>
<a href="#l8.48"></a><span id="l8.48">   ** until the cursor is closed (using the xClose() method).</span>
<a href="#l8.49"></a><span id="l8.49">   */</span>
<a href="#l8.50"></a><span id="l8.50">   int (*xOpen)(</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-    sqlite3_tokenizer *pTokenizer,       /* Tokenizer object */</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-    const char *pInput, int nBytes,      /* Input buffer */</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-    sqlite3_tokenizer_cursor **ppCursor  /* OUT: Created tokenizer cursor */</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+      sqlite3_tokenizer *pTokenizer,      /* Tokenizer object */</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+      const char *pInput, int nBytes,     /* Input buffer */</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+      sqlite3_tokenizer_cursor **ppCursor /* OUT: Created tokenizer cursor */</span>
<a href="#l8.57"></a><span id="l8.57">   );</span>
<a href="#l8.58"></a><span id="l8.58"> </span>
<a href="#l8.59"></a><span id="l8.59">   /*</span>
<a href="#l8.60"></a><span id="l8.60">   ** Destroy an existing tokenizer cursor. The fts3 module calls this</span>
<a href="#l8.61"></a><span id="l8.61">   ** method exactly once for each successful call to xOpen().</span>
<a href="#l8.62"></a><span id="l8.62">   */</span>
<a href="#l8.63"></a><span id="l8.63">   int (*xClose)(sqlite3_tokenizer_cursor *pCursor);</span>
<a href="#l8.64"></a><span id="l8.64"> </span>
<a href="#l8.65"></a><span id="l8.65" class="difflineat">@@ -122,27 +120,27 @@ struct sqlite3_tokenizer_module {</span>
<a href="#l8.66"></a><span id="l8.66">   ** implementation. It is only required to be valid until the next call</span>
<a href="#l8.67"></a><span id="l8.67">   ** to xNext() or xClose().</span>
<a href="#l8.68"></a><span id="l8.68">   */</span>
<a href="#l8.69"></a><span id="l8.69">   /* TODO(shess) current implementation requires pInput to be</span>
<a href="#l8.70"></a><span id="l8.70">   ** nul-terminated.  This should either be fixed, or pInput/nBytes</span>
<a href="#l8.71"></a><span id="l8.71">   ** should be converted to zInput.</span>
<a href="#l8.72"></a><span id="l8.72">   */</span>
<a href="#l8.73"></a><span id="l8.73">   int (*xNext)(</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineminus">-    sqlite3_tokenizer_cursor *pCursor,   /* Tokenizer cursor */</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineminus">-    const char **ppToken, int *pnBytes,  /* OUT: Normalized text for token */</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineminus">-    int *piStartOffset,  /* OUT: Byte offset of token in input buffer */</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineminus">-    int *piEndOffset,    /* OUT: Byte offset of end of token in input buffer */</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineminus">-    int *piPosition      /* OUT: Number of tokens returned before this one */</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+      sqlite3_tokenizer_cursor *pCursor,  /* Tokenizer cursor */</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+      const char **ppToken, int *pnBytes, /* OUT: Normalized text for token */</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+      int *piStartOffset, /* OUT: Byte offset of token in input buffer */</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+      int *piEndOffset,   /* OUT: Byte offset of end of token in input buffer */</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+      int *piPosition     /* OUT: Number of tokens returned before this one */</span>
<a href="#l8.84"></a><span id="l8.84">   );</span>
<a href="#l8.85"></a><span id="l8.85"> };</span>
<a href="#l8.86"></a><span id="l8.86"> </span>
<a href="#l8.87"></a><span id="l8.87"> struct sqlite3_tokenizer {</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-  const sqlite3_tokenizer_module *pModule;  /* The module for this tokenizer */</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+  const sqlite3_tokenizer_module *pModule; /* The module for this tokenizer */</span>
<a href="#l8.90"></a><span id="l8.90">   /* Tokenizer implementations will typically add additional fields */</span>
<a href="#l8.91"></a><span id="l8.91"> };</span>
<a href="#l8.92"></a><span id="l8.92"> </span>
<a href="#l8.93"></a><span id="l8.93"> struct sqlite3_tokenizer_cursor {</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineminus">-  sqlite3_tokenizer *pTokenizer;       /* Tokenizer for this cursor. */</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+  sqlite3_tokenizer *pTokenizer; /* Tokenizer for this cursor. */</span>
<a href="#l8.96"></a><span id="l8.96">   /* Tokenizer implementations will typically add additional fields */</span>
<a href="#l8.97"></a><span id="l8.97"> };</span>
<a href="#l8.98"></a><span id="l8.98"> </span>
<a href="#l8.99"></a><span id="l8.99"> #endif /* _FTS3_TOKENIZER_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/extensions/fts3/src/nsFts3Tokenizer.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/extensions/fts3/src/nsFts3Tokenizer.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -8,65 +8,54 @@</span>
<a href="#l9.4"></a><span id="l9.4"> #include &quot;nsGlodaRankerFunction.h&quot;</span>
<a href="#l9.5"></a><span id="l9.5"> </span>
<a href="#l9.6"></a><span id="l9.6"> #include &quot;nsIFts3Tokenizer.h&quot;</span>
<a href="#l9.7"></a><span id="l9.7"> #include &quot;mozIStorageConnection.h&quot;</span>
<a href="#l9.8"></a><span id="l9.8"> #include &quot;mozIStorageStatement.h&quot;</span>
<a href="#l9.9"></a><span id="l9.9"> #include &quot;nsString.h&quot;</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11"> extern &quot;C&quot; void sqlite3Fts3PorterTokenizerModule(</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  sqlite3_tokenizer_module const**ppModule);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+    sqlite3_tokenizer_module const **ppModule);</span>
<a href="#l9.14"></a><span id="l9.14"> </span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-extern &quot;C&quot; void glodaRankFunc(sqlite3_context *pCtx,</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-                              int nVal,</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+extern &quot;C&quot; void glodaRankFunc(sqlite3_context *pCtx, int nVal,</span>
<a href="#l9.18"></a><span id="l9.18">                               sqlite3_value **apVal);</span>
<a href="#l9.19"></a><span id="l9.19"> </span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-NS_IMPL_ISUPPORTS(nsFts3Tokenizer,nsIFts3Tokenizer)</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+NS_IMPL_ISUPPORTS(nsFts3Tokenizer, nsIFts3Tokenizer)</span>
<a href="#l9.22"></a><span id="l9.22"> </span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">-nsFts3Tokenizer::nsFts3Tokenizer()</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">-{</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-}</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+nsFts3Tokenizer::nsFts3Tokenizer() {}</span>
<a href="#l9.27"></a><span id="l9.27"> </span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-nsFts3Tokenizer::~nsFts3Tokenizer()</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-{</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-}</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+nsFts3Tokenizer::~nsFts3Tokenizer() {}</span>
<a href="#l9.32"></a><span id="l9.32"> </span>
<a href="#l9.33"></a><span id="l9.33"> NS_IMETHODIMP</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-nsFts3Tokenizer::RegisterTokenizer(mozIStorageConnection *connection)</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-{</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+nsFts3Tokenizer::RegisterTokenizer(mozIStorageConnection *connection) {</span>
<a href="#l9.37"></a><span id="l9.37">   nsresult rv;</span>
<a href="#l9.38"></a><span id="l9.38">   nsCOMPtr&lt;mozIStorageStatement&gt; selectStatement;</span>
<a href="#l9.39"></a><span id="l9.39"> </span>
<a href="#l9.40"></a><span id="l9.40">   // -- register the tokenizer</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">-  rv = connection-&gt;CreateStatement(NS_LITERAL_CSTRING(</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineminus">-    &quot;SELECT fts3_tokenizer(?1, ?2)&quot;),</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineminus">-    getter_AddRefs(selectStatement));</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+  rv = connection-&gt;CreateStatement(</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+      NS_LITERAL_CSTRING(&quot;SELECT fts3_tokenizer(?1, ?2)&quot;),</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+      getter_AddRefs(selectStatement));</span>
<a href="#l9.47"></a><span id="l9.47">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.48"></a><span id="l9.48"> </span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">-  const sqlite3_tokenizer_module* module = nullptr;</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+  const sqlite3_tokenizer_module *module = nullptr;</span>
<a href="#l9.51"></a><span id="l9.51">   sqlite3Fts3PorterTokenizerModule(&amp;module);</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineminus">-  if (!module)</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+  if (!module) return NS_ERROR_FAILURE;</span>
<a href="#l9.55"></a><span id="l9.55"> </span>
<a href="#l9.56"></a><span id="l9.56" class="difflineminus">-  rv = selectStatement-&gt;BindUTF8StringByIndex(</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineminus">-         0, NS_LITERAL_CSTRING(&quot;mozporter&quot;));</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+  rv = selectStatement-&gt;BindUTF8StringByIndex(0,</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+                                              NS_LITERAL_CSTRING(&quot;mozporter&quot;));</span>
<a href="#l9.60"></a><span id="l9.60">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineminus">-  rv = selectStatement-&gt;BindBlobByIndex(1,</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-                                        (uint8_t*)&amp;module,</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-                                        sizeof(module));</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+  rv = selectStatement-&gt;BindBlobByIndex(1, (uint8_t *)&amp;module, sizeof(module));</span>
<a href="#l9.65"></a><span id="l9.65">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.66"></a><span id="l9.66"> </span>
<a href="#l9.67"></a><span id="l9.67">   bool hasMore;</span>
<a href="#l9.68"></a><span id="l9.68">   rv = selectStatement-&gt;ExecuteStep(&amp;hasMore);</span>
<a href="#l9.69"></a><span id="l9.69">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.70"></a><span id="l9.70"> </span>
<a href="#l9.71"></a><span id="l9.71">   // -- register the ranking function</span>
<a href="#l9.72"></a><span id="l9.72">   nsCOMPtr&lt;mozIStorageFunction&gt; func = new nsGlodaRankerFunction();</span>
<a href="#l9.73"></a><span id="l9.73">   NS_ENSURE_TRUE(func, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineminus">-  rv = connection-&gt;CreateFunction(</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineminus">-         NS_LITERAL_CSTRING(&quot;glodaRank&quot;),</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-         -1, // variable argument support</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineminus">-         func</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineminus">-       );</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineplus">+  rv = connection-&gt;CreateFunction(NS_LITERAL_CSTRING(&quot;glodaRank&quot;),</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineplus">+                                  -1,  // variable argument support</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineplus">+                                  func);</span>
<a href="#l9.82"></a><span id="l9.82">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.83"></a><span id="l9.83"> </span>
<a href="#l9.84"></a><span id="l9.84">   return rv;</span>
<a href="#l9.85"></a><span id="l9.85"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/extensions/fts3/src/nsFts3Tokenizer.h</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/extensions/fts3/src/nsFts3Tokenizer.h</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -8,19 +8,19 @@</span>
<a href="#l10.4"></a><span id="l10.4"> </span>
<a href="#l10.5"></a><span id="l10.5"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l10.6"></a><span id="l10.6"> #include &quot;nsIFts3Tokenizer.h&quot;</span>
<a href="#l10.7"></a><span id="l10.7"> #include &quot;fts3_tokenizer.h&quot;</span>
<a href="#l10.8"></a><span id="l10.8"> </span>
<a href="#l10.9"></a><span id="l10.9"> extern const sqlite3_tokenizer_module* getWindowsTokenizer();</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11"> class nsFts3Tokenizer final : public nsIFts3Tokenizer {</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-public:</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-    NS_DECL_NSIFTS3TOKENIZER</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+ public:</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+  NS_DECL_NSIFTS3TOKENIZER</span>
<a href="#l10.18"></a><span id="l10.18"> </span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-    nsFts3Tokenizer();</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+  nsFts3Tokenizer();</span>
<a href="#l10.21"></a><span id="l10.21"> </span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-private:</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+ private:</span>
<a href="#l10.24"></a><span id="l10.24">   ~nsFts3Tokenizer();</span>
<a href="#l10.25"></a><span id="l10.25"> };</span>
<a href="#l10.26"></a><span id="l10.26"> </span>
<a href="#l10.27"></a><span id="l10.27"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/extensions/fts3/src/nsFts3TokenizerCID.h</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/extensions/fts3/src/nsFts3TokenizerCID.h</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1,15 +1,17 @@</span>
<a href="#l11.4"></a><span id="l11.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l11.5"></a><span id="l11.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.6"></a><span id="l11.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.7"></a><span id="l11.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.8"></a><span id="l11.8"> </span>
<a href="#l11.9"></a><span id="l11.9"> #ifndef nsFts3TokenizerCID_h__</span>
<a href="#l11.10"></a><span id="l11.10"> #define nsFts3TokenizerCID_h__</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-#define NS_FTS3TOKENIZER_CONTRACTID \</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-  &quot;@mozilla.org/messenger/fts3tokenizer;1&quot;</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-#define NS_FTS3TOKENIZER_CID  \</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-{ 0xa67d724d, 0x0015, 0x4e2e, \</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-{ 0x8c, 0xad, 0xb8, 0x47, 0x75, 0x33, 0x09, 0x24 }}</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+#define NS_FTS3TOKENIZER_CONTRACTID &quot;@mozilla.org/messenger/fts3tokenizer;1&quot;</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+#define NS_FTS3TOKENIZER_CID                         \</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+  {                                                  \</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+    0xa67d724d, 0x0015, 0x4e2e, {                    \</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+      0x8c, 0xad, 0xb8, 0x47, 0x75, 0x33, 0x09, 0x24 \</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+    }                                                \</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+  }</span>
<a href="#l11.24"></a><span id="l11.24"> </span>
<a href="#l11.25"></a><span id="l11.25"> #endif /* nsFts3TokenizerCID_h__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/extensions/fts3/src/nsGlodaRankerFunction.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/extensions/fts3/src/nsGlodaRankerFunction.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -7,102 +7,95 @@</span>
<a href="#l12.4"></a><span id="l12.4"> </span>
<a href="#l12.5"></a><span id="l12.5"> #include &quot;sqlite3.h&quot;</span>
<a href="#l12.6"></a><span id="l12.6"> </span>
<a href="#l12.7"></a><span id="l12.7"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l12.8"></a><span id="l12.8"> #include &quot;nsVariant.h&quot;</span>
<a href="#l12.9"></a><span id="l12.9"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l12.10"></a><span id="l12.10"> </span>
<a href="#l12.11"></a><span id="l12.11"> #ifndef SQLITE_VERSION_NUMBER</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-#error &quot;We need SQLITE_VERSION_NUMBER defined!&quot;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+#  error &quot;We need SQLITE_VERSION_NUMBER defined!&quot;</span>
<a href="#l12.14"></a><span id="l12.14"> #endif</span>
<a href="#l12.15"></a><span id="l12.15"> </span>
<a href="#l12.16"></a><span id="l12.16"> NS_IMPL_ISUPPORTS(nsGlodaRankerFunction, mozIStorageFunction)</span>
<a href="#l12.17"></a><span id="l12.17"> </span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-nsGlodaRankerFunction::nsGlodaRankerFunction()</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-{</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineminus">-}</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+nsGlodaRankerFunction::nsGlodaRankerFunction() {}</span>
<a href="#l12.22"></a><span id="l12.22"> </span>
<a href="#l12.23"></a><span id="l12.23" class="difflineminus">-nsGlodaRankerFunction::~nsGlodaRankerFunction()</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineminus">-{</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineminus">-}</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+nsGlodaRankerFunction::~nsGlodaRankerFunction() {}</span>
<a href="#l12.27"></a><span id="l12.27"> </span>
<a href="#l12.28"></a><span id="l12.28"> static uint32_t COLUMN_SATURATION[] = {10, 1, 1, 1, 1};</span>
<a href="#l12.29"></a><span id="l12.29"> </span>
<a href="#l12.30"></a><span id="l12.30"> /**</span>
<a href="#l12.31"></a><span id="l12.31">  * Our ranking function basically just multiplies the weight of the column</span>
<a href="#l12.32"></a><span id="l12.32">  * against the number of (saturating) matches.</span>
<a href="#l12.33"></a><span id="l12.33">  *</span>
<a href="#l12.34"></a><span id="l12.34">  * The original code is a SQLite example ranking function, although somewhat</span>
<a href="#l12.35"></a><span id="l12.35">  * rather modified at this point.  All SQLite code is public domain, so we are</span>
<a href="#l12.36"></a><span id="l12.36">  * subsuming it to MPL1.1/LGPL2/GPL2.</span>
<a href="#l12.37"></a><span id="l12.37">  */</span>
<a href="#l12.38"></a><span id="l12.38"> NS_IMETHODIMP</span>
<a href="#l12.39"></a><span id="l12.39"> nsGlodaRankerFunction::OnFunctionCall(mozIStorageValueArray *aArguments,</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineminus">-                                      nsIVariant **_result)</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineminus">-{</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+                                      nsIVariant **_result) {</span>
<a href="#l12.43"></a><span id="l12.43">   // all argument names are maintained from the original SQLite code.</span>
<a href="#l12.44"></a><span id="l12.44">   uint32_t nVal;</span>
<a href="#l12.45"></a><span id="l12.45">   nsresult rv = aArguments-&gt;GetNumEntries(&amp;nVal);</span>
<a href="#l12.46"></a><span id="l12.46">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.47"></a><span id="l12.47"> </span>
<a href="#l12.48"></a><span id="l12.48">   /* Check that the number of arguments passed to this function is correct.</span>
<a href="#l12.49"></a><span id="l12.49">    * If not, return an error. Set aArgsData to point to the array</span>
<a href="#l12.50"></a><span id="l12.50">    * of unsigned integer values returned by FTS3 function. Set nPhrase</span>
<a href="#l12.51"></a><span id="l12.51">    * to contain the number of reportable phrases in the users full-text</span>
<a href="#l12.52"></a><span id="l12.52">    * query, and nCol to the number of columns in the table.</span>
<a href="#l12.53"></a><span id="l12.53">    */</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineminus">-  if (nVal &lt; 1)</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineminus">-    return NS_ERROR_INVALID_ARG;</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+  if (nVal &lt; 1) return NS_ERROR_INVALID_ARG;</span>
<a href="#l12.57"></a><span id="l12.57"> </span>
<a href="#l12.58"></a><span id="l12.58">   uint32_t lenArgsData;</span>
<a href="#l12.59"></a><span id="l12.59">   uint32_t *aArgsData = (uint32_t *)aArguments-&gt;AsSharedBlob(0, &amp;lenArgsData);</span>
<a href="#l12.60"></a><span id="l12.60"> </span>
<a href="#l12.61"></a><span id="l12.61">   uint32_t nPhrase = aArgsData[0];</span>
<a href="#l12.62"></a><span id="l12.62">   uint32_t nCol = aArgsData[1];</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineminus">-  if (nVal != (1 + nCol))</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineminus">-    return NS_ERROR_INVALID_ARG;</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+  if (nVal != (1 + nCol)) return NS_ERROR_INVALID_ARG;</span>
<a href="#l12.66"></a><span id="l12.66"> </span>
<a href="#l12.67"></a><span id="l12.67">   double score = 0.0;</span>
<a href="#l12.68"></a><span id="l12.68"> </span>
<a href="#l12.69"></a><span id="l12.69">   // SQLite 3.6.22 has a different matchinfo layout than SQLite 3.6.23+</span>
<a href="#l12.70"></a><span id="l12.70"> #if SQLITE_VERSION_NUMBER &lt;= 3006022</span>
<a href="#l12.71"></a><span id="l12.71">   /* Iterate through each phrase in the users query. */</span>
<a href="#l12.72"></a><span id="l12.72">   for (uint32_t iPhrase = 0; iPhrase &lt; nPhrase; iPhrase++) {</span>
<a href="#l12.73"></a><span id="l12.73">     // in SQ</span>
<a href="#l12.74"></a><span id="l12.74">     for (uint32_t iCol = 0; iCol &lt; nCol; iCol++) {</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineminus">-      uint32_t nHitCount = aArgsData[2 + (iPhrase+1)*nCol + iCol];</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineminus">-      double weight = aArguments-&gt;AsDouble(iCol+1);</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineplus">+      uint32_t nHitCount = aArgsData[2 + (iPhrase + 1) * nCol + iCol];</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+      double weight = aArguments-&gt;AsDouble(iCol + 1);</span>
<a href="#l12.79"></a><span id="l12.79">       if (nHitCount &gt; 0) {</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineminus">-        score += (nHitCount &gt; COLUMN_SATURATION[iCol]) ?</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineminus">-          (COLUMN_SATURATION[iCol] * weight) :</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineminus">-          (nHitCount * weight);</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineplus">+        score += (nHitCount &gt; COLUMN_SATURATION[iCol])</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineplus">+                     ? (COLUMN_SATURATION[iCol] * weight)</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineplus">+                     : (nHitCount * weight);</span>
<a href="#l12.86"></a><span id="l12.86">       }</span>
<a href="#l12.87"></a><span id="l12.87">     }</span>
<a href="#l12.88"></a><span id="l12.88">   }</span>
<a href="#l12.89"></a><span id="l12.89"> #else</span>
<a href="#l12.90"></a><span id="l12.90">   /* Iterate through each phrase in the users query. */</span>
<a href="#l12.91"></a><span id="l12.91">   for (uint32_t iPhrase = 0; iPhrase &lt; nPhrase; iPhrase++) {</span>
<a href="#l12.92"></a><span id="l12.92">     /* Now iterate through each column in the users query. For each column,</span>
<a href="#l12.93"></a><span id="l12.93">     ** increment the relevancy score by:</span>
<a href="#l12.94"></a><span id="l12.94">     **</span>
<a href="#l12.95"></a><span id="l12.95">     **   (&lt;hit count&gt; / &lt;global hit count&gt;) * &lt;column weight&gt;</span>
<a href="#l12.96"></a><span id="l12.96">     **</span>
<a href="#l12.97"></a><span id="l12.97">     ** aPhraseinfo[] points to the start of the data for phrase iPhrase. So</span>
<a href="#l12.98"></a><span id="l12.98">     ** the hit count and global hit counts for each column are found in</span>
<a href="#l12.99"></a><span id="l12.99">     ** aPhraseinfo[iCol*3] and aPhraseinfo[iCol*3+1], respectively.</span>
<a href="#l12.100"></a><span id="l12.100">     */</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineminus">-    uint32_t *aPhraseinfo = &amp;aArgsData[2 + iPhrase*nCol*3];</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineplus">+    uint32_t *aPhraseinfo = &amp;aArgsData[2 + iPhrase * nCol * 3];</span>
<a href="#l12.103"></a><span id="l12.103">     for (uint32_t iCol = 0; iCol &lt; nCol; iCol++) {</span>
<a href="#l12.104"></a><span id="l12.104">       uint32_t nHitCount = aPhraseinfo[3 * iCol];</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineminus">-      double weight = aArguments-&gt;AsDouble(iCol+1);</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineplus">+      double weight = aArguments-&gt;AsDouble(iCol + 1);</span>
<a href="#l12.107"></a><span id="l12.107">       if (nHitCount &gt; 0) {</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineminus">-        score += (nHitCount &gt; COLUMN_SATURATION[iCol]) ?</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineminus">-          (COLUMN_SATURATION[iCol] * weight) :</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineminus">-          (nHitCount * weight);</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineplus">+        score += (nHitCount &gt; COLUMN_SATURATION[iCol])</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineplus">+                     ? (COLUMN_SATURATION[iCol] * weight)</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineplus">+                     : (nHitCount * weight);</span>
<a href="#l12.114"></a><span id="l12.114">       }</span>
<a href="#l12.115"></a><span id="l12.115">     }</span>
<a href="#l12.116"></a><span id="l12.116">   }</span>
<a href="#l12.117"></a><span id="l12.117"> #endif</span>
<a href="#l12.118"></a><span id="l12.118"> </span>
<a href="#l12.119"></a><span id="l12.119">   nsCOMPtr&lt;nsIWritableVariant&gt; result = new nsVariant();</span>
<a href="#l12.120"></a><span id="l12.120"> </span>
<a href="#l12.121"></a><span id="l12.121">   rv = result-&gt;SetAsDouble(score);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/extensions/fts3/src/nsGlodaRankerFunction.h</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/extensions/fts3/src/nsGlodaRankerFunction.h</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -6,20 +6,20 @@</span>
<a href="#l13.4"></a><span id="l13.4"> #define _nsGlodaRankerFunction_h_</span>
<a href="#l13.5"></a><span id="l13.5"> </span>
<a href="#l13.6"></a><span id="l13.6"> #include &quot;mozIStorageFunction.h&quot;</span>
<a href="#l13.7"></a><span id="l13.7"> </span>
<a href="#l13.8"></a><span id="l13.8"> /**</span>
<a href="#l13.9"></a><span id="l13.9">  * Basically a port of the example FTS3 ranking function to mozStorage's</span>
<a href="#l13.10"></a><span id="l13.10">  * view of the universe.  This might get fancier at some point.</span>
<a href="#l13.11"></a><span id="l13.11">  */</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-class nsGlodaRankerFunction final : public mozIStorageFunction</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-{</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-public:</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+class nsGlodaRankerFunction final : public mozIStorageFunction {</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+ public:</span>
<a href="#l13.17"></a><span id="l13.17">   NS_DECL_ISUPPORTS</span>
<a href="#l13.18"></a><span id="l13.18">   NS_DECL_MOZISTORAGEFUNCTION</span>
<a href="#l13.19"></a><span id="l13.19"> </span>
<a href="#l13.20"></a><span id="l13.20">   nsGlodaRankerFunction();</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineminus">-private:</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+ private:</span>
<a href="#l13.24"></a><span id="l13.24">   ~nsGlodaRankerFunction();</span>
<a href="#l13.25"></a><span id="l13.25"> };</span>
<a href="#l13.26"></a><span id="l13.26"> </span>
<a href="#l13.27"></a><span id="l13.27" class="difflineminus">-#endif // _nsGlodaRankerFunction_h_</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+#endif  // _nsGlodaRankerFunction_h_</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/extensions/mailviews/src/nsMsgMailViewList.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/extensions/mailviews/src/nsMsgMailViewList.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -19,292 +19,270 @@</span>
<a href="#l14.4"></a><span id="l14.4"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l14.5"></a><span id="l14.5"> </span>
<a href="#l14.6"></a><span id="l14.6"> #define kDefaultViewPeopleIKnow &quot;People I Know&quot;</span>
<a href="#l14.7"></a><span id="l14.7"> #define kDefaultViewRecent &quot;Recent Mail&quot;</span>
<a href="#l14.8"></a><span id="l14.8"> #define kDefaultViewFiveDays &quot;Last 5 Days&quot;</span>
<a href="#l14.9"></a><span id="l14.9"> #define kDefaultViewNotJunk &quot;Not Junk&quot;</span>
<a href="#l14.10"></a><span id="l14.10"> #define kDefaultViewHasAttachments &quot;Has Attachments&quot;</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-nsMsgMailView::nsMsgMailView()</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-{</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-    mViewSearchTerms = nsArray::Create();</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">-    NS_ASSERTION(mViewSearchTerms, &quot;Failed to allocate a nsIMutableArray for mViewSearchTerms&quot;);</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+nsMsgMailView::nsMsgMailView() {</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+  mViewSearchTerms = nsArray::Create();</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+  NS_ASSERTION(mViewSearchTerms,</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+               &quot;Failed to allocate a nsIMutableArray for mViewSearchTerms&quot;);</span>
<a href="#l14.20"></a><span id="l14.20"> }</span>
<a href="#l14.21"></a><span id="l14.21"> </span>
<a href="#l14.22"></a><span id="l14.22"> NS_IMPL_ADDREF(nsMsgMailView)</span>
<a href="#l14.23"></a><span id="l14.23"> NS_IMPL_RELEASE(nsMsgMailView)</span>
<a href="#l14.24"></a><span id="l14.24"> NS_IMPL_QUERY_INTERFACE(nsMsgMailView, nsIMsgMailView)</span>
<a href="#l14.25"></a><span id="l14.25"> </span>
<a href="#l14.26"></a><span id="l14.26" class="difflineminus">-nsMsgMailView::~nsMsgMailView()</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineminus">-{</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">-    if (mViewSearchTerms)</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineminus">-        mViewSearchTerms-&gt;Clear();</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+nsMsgMailView::~nsMsgMailView() {</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+  if (mViewSearchTerms) mViewSearchTerms-&gt;Clear();</span>
<a href="#l14.32"></a><span id="l14.32"> }</span>
<a href="#l14.33"></a><span id="l14.33"> </span>
<a href="#l14.34"></a><span id="l14.34" class="difflineminus">-NS_IMETHODIMP nsMsgMailView::GetMailViewName(char16_t ** aMailViewName)</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineminus">-{</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aMailViewName);</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+NS_IMETHODIMP nsMsgMailView::GetMailViewName(char16_t **aMailViewName) {</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aMailViewName);</span>
<a href="#l14.39"></a><span id="l14.39"> </span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">-    *aMailViewName = ToNewUnicode(mName);</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineminus">-    return NS_OK;</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+  *aMailViewName = ToNewUnicode(mName);</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+  return NS_OK;</span>
<a href="#l14.44"></a><span id="l14.44"> }</span>
<a href="#l14.45"></a><span id="l14.45"> </span>
<a href="#l14.46"></a><span id="l14.46" class="difflineminus">-NS_IMETHODIMP nsMsgMailView::SetMailViewName(const char16_t * aMailViewName)</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineminus">-{</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineminus">-    mName = aMailViewName;</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineminus">-    return NS_OK;</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+NS_IMETHODIMP nsMsgMailView::SetMailViewName(const char16_t *aMailViewName) {</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+  mName = aMailViewName;</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+  return NS_OK;</span>
<a href="#l14.53"></a><span id="l14.53"> }</span>
<a href="#l14.54"></a><span id="l14.54"> </span>
<a href="#l14.55"></a><span id="l14.55" class="difflineminus">-NS_IMETHODIMP nsMsgMailView::GetPrettyName(char16_t ** aMailViewName)</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineminus">-{</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aMailViewName);</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+NS_IMETHODIMP nsMsgMailView::GetPrettyName(char16_t **aMailViewName) {</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aMailViewName);</span>
<a href="#l14.60"></a><span id="l14.60"> </span>
<a href="#l14.61"></a><span id="l14.61" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineminus">-    if (!mBundle)</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineminus">-    {</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineminus">-        nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineminus">-          mozilla::services::GetStringBundleService();</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineminus">-        NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineminus">-        bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/mailviews.properties&quot;,</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineminus">-                                    getter_AddRefs(mBundle));</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineminus">-    }</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+  if (!mBundle) {</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+    nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+        mozilla::services::GetStringBundleService();</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+    NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+    bundleService-&gt;CreateBundle(</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineplus">+        &quot;chrome://messenger/locale/mailviews.properties&quot;,</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineplus">+        getter_AddRefs(mBundle));</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineplus">+  }</span>
<a href="#l14.79"></a><span id="l14.79"> </span>
<a href="#l14.80"></a><span id="l14.80" class="difflineminus">-    NS_ENSURE_TRUE(mBundle, NS_ERROR_FAILURE);</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineplus">+  NS_ENSURE_TRUE(mBundle, NS_ERROR_FAILURE);</span>
<a href="#l14.82"></a><span id="l14.82"> </span>
<a href="#l14.83"></a><span id="l14.83" class="difflineminus">-    // see if mName has an associated pretty name inside our string bundle and if so, use that as the pretty name</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineminus">-    // otherwise just return mName</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineminus">-    nsAutoString mailViewName;</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineminus">-    if (mName.EqualsLiteral(kDefaultViewPeopleIKnow)) {</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineminus">-        rv = mBundle-&gt;GetStringFromName(&quot;mailViewPeopleIKnow&quot;, mailViewName);</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineminus">-        *aMailViewName = ToNewUnicode(mailViewName);</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineminus">-    } else if (mName.EqualsLiteral(kDefaultViewRecent)) {</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineminus">-        rv = mBundle-&gt;GetStringFromName(&quot;mailViewRecentMail&quot;, mailViewName);</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineminus">-        *aMailViewName = ToNewUnicode(mailViewName);</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineminus">-    } else if (mName.EqualsLiteral(kDefaultViewFiveDays)) {</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineminus">-        rv = mBundle-&gt;GetStringFromName(&quot;mailViewLastFiveDays&quot;, mailViewName);</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineminus">-        *aMailViewName = ToNewUnicode(mailViewName);</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineminus">-    } else if (mName.EqualsLiteral(kDefaultViewNotJunk)) {</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineminus">-        rv = mBundle-&gt;GetStringFromName(&quot;mailViewNotJunk&quot;, mailViewName);</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineminus">-        *aMailViewName = ToNewUnicode(mailViewName);</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineminus">-    } else if (mName.EqualsLiteral(kDefaultViewHasAttachments)) {</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineminus">-        rv = mBundle-&gt;GetStringFromName(&quot;mailViewHasAttachments&quot;, mailViewName);</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineminus">-        *aMailViewName = ToNewUnicode(mailViewName);</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineminus">-    } else {</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineminus">-        *aMailViewName = ToNewUnicode(mName);</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineminus">-    }</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineplus">+  // see if mName has an associated pretty name inside our string bundle and if</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineplus">+  // so, use that as the pretty name otherwise just return mName</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineplus">+  nsAutoString mailViewName;</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineplus">+  if (mName.EqualsLiteral(kDefaultViewPeopleIKnow)) {</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineplus">+    rv = mBundle-&gt;GetStringFromName(&quot;mailViewPeopleIKnow&quot;, mailViewName);</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineplus">+    *aMailViewName = ToNewUnicode(mailViewName);</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineplus">+  } else if (mName.EqualsLiteral(kDefaultViewRecent)) {</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineplus">+    rv = mBundle-&gt;GetStringFromName(&quot;mailViewRecentMail&quot;, mailViewName);</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineplus">+    *aMailViewName = ToNewUnicode(mailViewName);</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineplus">+  } else if (mName.EqualsLiteral(kDefaultViewFiveDays)) {</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineplus">+    rv = mBundle-&gt;GetStringFromName(&quot;mailViewLastFiveDays&quot;, mailViewName);</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineplus">+    *aMailViewName = ToNewUnicode(mailViewName);</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineplus">+  } else if (mName.EqualsLiteral(kDefaultViewNotJunk)) {</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineplus">+    rv = mBundle-&gt;GetStringFromName(&quot;mailViewNotJunk&quot;, mailViewName);</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineplus">+    *aMailViewName = ToNewUnicode(mailViewName);</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineplus">+  } else if (mName.EqualsLiteral(kDefaultViewHasAttachments)) {</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineplus">+    rv = mBundle-&gt;GetStringFromName(&quot;mailViewHasAttachments&quot;, mailViewName);</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineplus">+    *aMailViewName = ToNewUnicode(mailViewName);</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineplus">+  } else {</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineplus">+    *aMailViewName = ToNewUnicode(mName);</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineplus">+  }</span>
<a href="#l14.125"></a><span id="l14.125"> </span>
<a href="#l14.126"></a><span id="l14.126" class="difflineminus">-    return rv;</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineplus">+  return rv;</span>
<a href="#l14.128"></a><span id="l14.128"> }</span>
<a href="#l14.129"></a><span id="l14.129"> </span>
<a href="#l14.130"></a><span id="l14.130" class="difflineminus">-NS_IMETHODIMP nsMsgMailView::GetSearchTerms(nsIMutableArray **aSearchTerms)</span>
<a href="#l14.131"></a><span id="l14.131" class="difflineminus">-{</span>
<a href="#l14.132"></a><span id="l14.132" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aSearchTerms);</span>
<a href="#l14.133"></a><span id="l14.133" class="difflineminus">-    NS_IF_ADDREF(*aSearchTerms = mViewSearchTerms);</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineminus">-    return NS_OK;</span>
<a href="#l14.135"></a><span id="l14.135" class="difflineplus">+NS_IMETHODIMP nsMsgMailView::GetSearchTerms(nsIMutableArray **aSearchTerms) {</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aSearchTerms);</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineplus">+  NS_IF_ADDREF(*aSearchTerms = mViewSearchTerms);</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineplus">+  return NS_OK;</span>
<a href="#l14.139"></a><span id="l14.139"> }</span>
<a href="#l14.140"></a><span id="l14.140"> </span>
<a href="#l14.141"></a><span id="l14.141" class="difflineminus">-NS_IMETHODIMP nsMsgMailView::SetSearchTerms(nsIMutableArray *aSearchTerms)</span>
<a href="#l14.142"></a><span id="l14.142" class="difflineminus">-{</span>
<a href="#l14.143"></a><span id="l14.143" class="difflineminus">-    mViewSearchTerms = aSearchTerms;</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineminus">-    return NS_OK;</span>
<a href="#l14.145"></a><span id="l14.145" class="difflineplus">+NS_IMETHODIMP nsMsgMailView::SetSearchTerms(nsIMutableArray *aSearchTerms) {</span>
<a href="#l14.146"></a><span id="l14.146" class="difflineplus">+  mViewSearchTerms = aSearchTerms;</span>
<a href="#l14.147"></a><span id="l14.147" class="difflineplus">+  return NS_OK;</span>
<a href="#l14.148"></a><span id="l14.148"> }</span>
<a href="#l14.149"></a><span id="l14.149"> </span>
<a href="#l14.150"></a><span id="l14.150" class="difflineminus">-NS_IMETHODIMP nsMsgMailView::AppendTerm(nsIMsgSearchTerm *aTerm)</span>
<a href="#l14.151"></a><span id="l14.151" class="difflineminus">-{</span>
<a href="#l14.152"></a><span id="l14.152" class="difflineminus">-    NS_ENSURE_TRUE(aTerm, NS_ERROR_NULL_POINTER);</span>
<a href="#l14.153"></a><span id="l14.153" class="difflineplus">+NS_IMETHODIMP nsMsgMailView::AppendTerm(nsIMsgSearchTerm *aTerm) {</span>
<a href="#l14.154"></a><span id="l14.154" class="difflineplus">+  NS_ENSURE_TRUE(aTerm, NS_ERROR_NULL_POINTER);</span>
<a href="#l14.155"></a><span id="l14.155"> </span>
<a href="#l14.156"></a><span id="l14.156" class="difflineminus">-    return mViewSearchTerms-&gt;AppendElement(aTerm);</span>
<a href="#l14.157"></a><span id="l14.157" class="difflineplus">+  return mViewSearchTerms-&gt;AppendElement(aTerm);</span>
<a href="#l14.158"></a><span id="l14.158"> }</span>
<a href="#l14.159"></a><span id="l14.159"> </span>
<a href="#l14.160"></a><span id="l14.160" class="difflineminus">-NS_IMETHODIMP nsMsgMailView::CreateTerm(nsIMsgSearchTerm **aResult)</span>
<a href="#l14.161"></a><span id="l14.161" class="difflineminus">-{</span>
<a href="#l14.162"></a><span id="l14.162" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l14.163"></a><span id="l14.163" class="difflineminus">-    nsCOMPtr&lt;nsIMsgSearchTerm&gt; searchTerm = do_CreateInstance(&quot;@mozilla.org/messenger/searchTerm;1&quot;);</span>
<a href="#l14.164"></a><span id="l14.164" class="difflineminus">-    searchTerm.forget(aResult);</span>
<a href="#l14.165"></a><span id="l14.165" class="difflineminus">-    return NS_OK;</span>
<a href="#l14.166"></a><span id="l14.166" class="difflineplus">+NS_IMETHODIMP nsMsgMailView::CreateTerm(nsIMsgSearchTerm **aResult) {</span>
<a href="#l14.167"></a><span id="l14.167" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l14.168"></a><span id="l14.168" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSearchTerm&gt; searchTerm =</span>
<a href="#l14.169"></a><span id="l14.169" class="difflineplus">+      do_CreateInstance(&quot;@mozilla.org/messenger/searchTerm;1&quot;);</span>
<a href="#l14.170"></a><span id="l14.170" class="difflineplus">+  searchTerm.forget(aResult);</span>
<a href="#l14.171"></a><span id="l14.171" class="difflineplus">+  return NS_OK;</span>
<a href="#l14.172"></a><span id="l14.172"> }</span>
<a href="#l14.173"></a><span id="l14.173"> </span>
<a href="#l14.174"></a><span id="l14.174"> /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l14.175"></a><span id="l14.175"> // nsMsgMailViewList implementation</span>
<a href="#l14.176"></a><span id="l14.176"> /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l14.177"></a><span id="l14.177" class="difflineminus">-nsMsgMailViewList::nsMsgMailViewList()</span>
<a href="#l14.178"></a><span id="l14.178" class="difflineminus">-{</span>
<a href="#l14.179"></a><span id="l14.179" class="difflineminus">-    LoadMailViews();</span>
<a href="#l14.180"></a><span id="l14.180" class="difflineminus">-}</span>
<a href="#l14.181"></a><span id="l14.181" class="difflineplus">+nsMsgMailViewList::nsMsgMailViewList() { LoadMailViews(); }</span>
<a href="#l14.182"></a><span id="l14.182"> </span>
<a href="#l14.183"></a><span id="l14.183"> NS_IMPL_ADDREF(nsMsgMailViewList)</span>
<a href="#l14.184"></a><span id="l14.184"> NS_IMPL_RELEASE(nsMsgMailViewList)</span>
<a href="#l14.185"></a><span id="l14.185"> NS_IMPL_QUERY_INTERFACE(nsMsgMailViewList, nsIMsgMailViewList)</span>
<a href="#l14.186"></a><span id="l14.186"> </span>
<a href="#l14.187"></a><span id="l14.187" class="difflineminus">-nsMsgMailViewList::~nsMsgMailViewList()</span>
<a href="#l14.188"></a><span id="l14.188" class="difflineminus">-{</span>
<a href="#l14.189"></a><span id="l14.189" class="difflineminus">-</span>
<a href="#l14.190"></a><span id="l14.190" class="difflineminus">-}</span>
<a href="#l14.191"></a><span id="l14.191" class="difflineplus">+nsMsgMailViewList::~nsMsgMailViewList() {}</span>
<a href="#l14.192"></a><span id="l14.192"> </span>
<a href="#l14.193"></a><span id="l14.193" class="difflineminus">-NS_IMETHODIMP nsMsgMailViewList::GetMailViewCount(uint32_t * aCount)</span>
<a href="#l14.194"></a><span id="l14.194" class="difflineminus">-{</span>
<a href="#l14.195"></a><span id="l14.195" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aCount);</span>
<a href="#l14.196"></a><span id="l14.196" class="difflineplus">+NS_IMETHODIMP nsMsgMailViewList::GetMailViewCount(uint32_t *aCount) {</span>
<a href="#l14.197"></a><span id="l14.197" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aCount);</span>
<a href="#l14.198"></a><span id="l14.198"> </span>
<a href="#l14.199"></a><span id="l14.199" class="difflineminus">-    *aCount = m_mailViews.Length();</span>
<a href="#l14.200"></a><span id="l14.200" class="difflineminus">-    return NS_OK;</span>
<a href="#l14.201"></a><span id="l14.201" class="difflineplus">+  *aCount = m_mailViews.Length();</span>
<a href="#l14.202"></a><span id="l14.202" class="difflineplus">+  return NS_OK;</span>
<a href="#l14.203"></a><span id="l14.203"> }</span>
<a href="#l14.204"></a><span id="l14.204"> </span>
<a href="#l14.205"></a><span id="l14.205" class="difflineminus">-NS_IMETHODIMP nsMsgMailViewList::GetMailViewAt(uint32_t aMailViewIndex, nsIMsgMailView ** aMailView)</span>
<a href="#l14.206"></a><span id="l14.206" class="difflineminus">-{</span>
<a href="#l14.207"></a><span id="l14.207" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aMailView);</span>
<a href="#l14.208"></a><span id="l14.208" class="difflineplus">+NS_IMETHODIMP nsMsgMailViewList::GetMailViewAt(uint32_t aMailViewIndex,</span>
<a href="#l14.209"></a><span id="l14.209" class="difflineplus">+                                               nsIMsgMailView **aMailView) {</span>
<a href="#l14.210"></a><span id="l14.210" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aMailView);</span>
<a href="#l14.211"></a><span id="l14.211"> </span>
<a href="#l14.212"></a><span id="l14.212" class="difflineminus">-    uint32_t mailViewCount = m_mailViews.Length();</span>
<a href="#l14.213"></a><span id="l14.213" class="difflineplus">+  uint32_t mailViewCount = m_mailViews.Length();</span>
<a href="#l14.214"></a><span id="l14.214"> </span>
<a href="#l14.215"></a><span id="l14.215" class="difflineminus">-    NS_ENSURE_ARG(mailViewCount &gt; aMailViewIndex);</span>
<a href="#l14.216"></a><span id="l14.216" class="difflineplus">+  NS_ENSURE_ARG(mailViewCount &gt; aMailViewIndex);</span>
<a href="#l14.217"></a><span id="l14.217"> </span>
<a href="#l14.218"></a><span id="l14.218" class="difflineminus">-    NS_IF_ADDREF(*aMailView = m_mailViews[aMailViewIndex]);</span>
<a href="#l14.219"></a><span id="l14.219" class="difflineminus">-    return NS_OK;</span>
<a href="#l14.220"></a><span id="l14.220" class="difflineplus">+  NS_IF_ADDREF(*aMailView = m_mailViews[aMailViewIndex]);</span>
<a href="#l14.221"></a><span id="l14.221" class="difflineplus">+  return NS_OK;</span>
<a href="#l14.222"></a><span id="l14.222"> }</span>
<a href="#l14.223"></a><span id="l14.223"> </span>
<a href="#l14.224"></a><span id="l14.224" class="difflineminus">-NS_IMETHODIMP nsMsgMailViewList::AddMailView(nsIMsgMailView * aMailView)</span>
<a href="#l14.225"></a><span id="l14.225" class="difflineminus">-{</span>
<a href="#l14.226"></a><span id="l14.226" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aMailView);</span>
<a href="#l14.227"></a><span id="l14.227" class="difflineplus">+NS_IMETHODIMP nsMsgMailViewList::AddMailView(nsIMsgMailView *aMailView) {</span>
<a href="#l14.228"></a><span id="l14.228" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aMailView);</span>
<a href="#l14.229"></a><span id="l14.229"> </span>
<a href="#l14.230"></a><span id="l14.230" class="difflineminus">-    m_mailViews.AppendElement(aMailView);</span>
<a href="#l14.231"></a><span id="l14.231" class="difflineminus">-    return NS_OK;</span>
<a href="#l14.232"></a><span id="l14.232" class="difflineplus">+  m_mailViews.AppendElement(aMailView);</span>
<a href="#l14.233"></a><span id="l14.233" class="difflineplus">+  return NS_OK;</span>
<a href="#l14.234"></a><span id="l14.234"> }</span>
<a href="#l14.235"></a><span id="l14.235"> </span>
<a href="#l14.236"></a><span id="l14.236" class="difflineminus">-NS_IMETHODIMP nsMsgMailViewList::RemoveMailView(nsIMsgMailView * aMailView)</span>
<a href="#l14.237"></a><span id="l14.237" class="difflineminus">-{</span>
<a href="#l14.238"></a><span id="l14.238" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aMailView);</span>
<a href="#l14.239"></a><span id="l14.239" class="difflineplus">+NS_IMETHODIMP nsMsgMailViewList::RemoveMailView(nsIMsgMailView *aMailView) {</span>
<a href="#l14.240"></a><span id="l14.240" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aMailView);</span>
<a href="#l14.241"></a><span id="l14.241"> </span>
<a href="#l14.242"></a><span id="l14.242" class="difflineminus">-    m_mailViews.RemoveElement(aMailView);</span>
<a href="#l14.243"></a><span id="l14.243" class="difflineminus">-    return NS_OK;</span>
<a href="#l14.244"></a><span id="l14.244" class="difflineplus">+  m_mailViews.RemoveElement(aMailView);</span>
<a href="#l14.245"></a><span id="l14.245" class="difflineplus">+  return NS_OK;</span>
<a href="#l14.246"></a><span id="l14.246"> }</span>
<a href="#l14.247"></a><span id="l14.247"> </span>
<a href="#l14.248"></a><span id="l14.248" class="difflineminus">-NS_IMETHODIMP nsMsgMailViewList::CreateMailView(nsIMsgMailView ** aMailView)</span>
<a href="#l14.249"></a><span id="l14.249" class="difflineminus">-{</span>
<a href="#l14.250"></a><span id="l14.250" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aMailView);</span>
<a href="#l14.251"></a><span id="l14.251" class="difflineminus">-    NS_ADDREF(*aMailView = new nsMsgMailView);</span>
<a href="#l14.252"></a><span id="l14.252" class="difflineminus">-    return NS_OK;</span>
<a href="#l14.253"></a><span id="l14.253" class="difflineplus">+NS_IMETHODIMP nsMsgMailViewList::CreateMailView(nsIMsgMailView **aMailView) {</span>
<a href="#l14.254"></a><span id="l14.254" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aMailView);</span>
<a href="#l14.255"></a><span id="l14.255" class="difflineplus">+  NS_ADDREF(*aMailView = new nsMsgMailView);</span>
<a href="#l14.256"></a><span id="l14.256" class="difflineplus">+  return NS_OK;</span>
<a href="#l14.257"></a><span id="l14.257"> }</span>
<a href="#l14.258"></a><span id="l14.258"> </span>
<a href="#l14.259"></a><span id="l14.259" class="difflineminus">-NS_IMETHODIMP nsMsgMailViewList::Save()</span>
<a href="#l14.260"></a><span id="l14.260" class="difflineminus">-{</span>
<a href="#l14.261"></a><span id="l14.261" class="difflineminus">-    // brute force...remove all the old filters in our filter list, then we'll re-add our current</span>
<a href="#l14.262"></a><span id="l14.262" class="difflineminus">-    // list</span>
<a href="#l14.263"></a><span id="l14.263" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFilter&gt; msgFilter;</span>
<a href="#l14.264"></a><span id="l14.264" class="difflineminus">-    uint32_t numFilters = 0;</span>
<a href="#l14.265"></a><span id="l14.265" class="difflineminus">-    if (mFilterList)</span>
<a href="#l14.266"></a><span id="l14.266" class="difflineminus">-      mFilterList-&gt;GetFilterCount(&amp;numFilters);</span>
<a href="#l14.267"></a><span id="l14.267" class="difflineminus">-    while (numFilters)</span>
<a href="#l14.268"></a><span id="l14.268" class="difflineminus">-    {</span>
<a href="#l14.269"></a><span id="l14.269" class="difflineminus">-        mFilterList-&gt;RemoveFilterAt(numFilters - 1);</span>
<a href="#l14.270"></a><span id="l14.270" class="difflineminus">-        numFilters--;</span>
<a href="#l14.271"></a><span id="l14.271" class="difflineminus">-    }</span>
<a href="#l14.272"></a><span id="l14.272" class="difflineplus">+NS_IMETHODIMP nsMsgMailViewList::Save() {</span>
<a href="#l14.273"></a><span id="l14.273" class="difflineplus">+  // brute force...remove all the old filters in our filter list, then we'll</span>
<a href="#l14.274"></a><span id="l14.274" class="difflineplus">+  // re-add our current list</span>
<a href="#l14.275"></a><span id="l14.275" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFilter&gt; msgFilter;</span>
<a href="#l14.276"></a><span id="l14.276" class="difflineplus">+  uint32_t numFilters = 0;</span>
<a href="#l14.277"></a><span id="l14.277" class="difflineplus">+  if (mFilterList) mFilterList-&gt;GetFilterCount(&amp;numFilters);</span>
<a href="#l14.278"></a><span id="l14.278" class="difflineplus">+  while (numFilters) {</span>
<a href="#l14.279"></a><span id="l14.279" class="difflineplus">+    mFilterList-&gt;RemoveFilterAt(numFilters - 1);</span>
<a href="#l14.280"></a><span id="l14.280" class="difflineplus">+    numFilters--;</span>
<a href="#l14.281"></a><span id="l14.281" class="difflineplus">+  }</span>
<a href="#l14.282"></a><span id="l14.282"> </span>
<a href="#l14.283"></a><span id="l14.283" class="difflineminus">-    // now convert our mail view list into a filter list and save it</span>
<a href="#l14.284"></a><span id="l14.284" class="difflineminus">-    ConvertMailViewListToFilterList();</span>
<a href="#l14.285"></a><span id="l14.285" class="difflineplus">+  // now convert our mail view list into a filter list and save it</span>
<a href="#l14.286"></a><span id="l14.286" class="difflineplus">+  ConvertMailViewListToFilterList();</span>
<a href="#l14.287"></a><span id="l14.287"> </span>
<a href="#l14.288"></a><span id="l14.288" class="difflineminus">-    // now save the filters to our file</span>
<a href="#l14.289"></a><span id="l14.289" class="difflineminus">-    return mFilterList ? mFilterList-&gt;SaveToDefaultFile() : NS_ERROR_FAILURE;</span>
<a href="#l14.290"></a><span id="l14.290" class="difflineplus">+  // now save the filters to our file</span>
<a href="#l14.291"></a><span id="l14.291" class="difflineplus">+  return mFilterList ? mFilterList-&gt;SaveToDefaultFile() : NS_ERROR_FAILURE;</span>
<a href="#l14.292"></a><span id="l14.292"> }</span>
<a href="#l14.293"></a><span id="l14.293"> </span>
<a href="#l14.294"></a><span id="l14.294" class="difflineminus">-nsresult nsMsgMailViewList::ConvertMailViewListToFilterList()</span>
<a href="#l14.295"></a><span id="l14.295" class="difflineminus">-{</span>
<a href="#l14.296"></a><span id="l14.296" class="difflineplus">+nsresult nsMsgMailViewList::ConvertMailViewListToFilterList() {</span>
<a href="#l14.297"></a><span id="l14.297">   uint32_t mailViewCount = m_mailViews.Length();</span>
<a href="#l14.298"></a><span id="l14.298">   nsCOMPtr&lt;nsIMsgMailView&gt; mailView;</span>
<a href="#l14.299"></a><span id="l14.299">   nsCOMPtr&lt;nsIMsgFilter&gt; newMailFilter;</span>
<a href="#l14.300"></a><span id="l14.300">   nsString mailViewName;</span>
<a href="#l14.301"></a><span id="l14.301" class="difflineminus">-  for (uint32_t index = 0; index &lt; mailViewCount; index++)</span>
<a href="#l14.302"></a><span id="l14.302" class="difflineminus">-  {</span>
<a href="#l14.303"></a><span id="l14.303" class="difflineminus">-      GetMailViewAt(index, getter_AddRefs(mailView));</span>
<a href="#l14.304"></a><span id="l14.304" class="difflineminus">-      if (!mailView)</span>
<a href="#l14.305"></a><span id="l14.305" class="difflineminus">-          continue;</span>
<a href="#l14.306"></a><span id="l14.306" class="difflineminus">-      mailView-&gt;GetMailViewName(getter_Copies(mailViewName));</span>
<a href="#l14.307"></a><span id="l14.307" class="difflineminus">-      mFilterList-&gt;CreateFilter(mailViewName, getter_AddRefs(newMailFilter));</span>
<a href="#l14.308"></a><span id="l14.308" class="difflineminus">-      if (!newMailFilter)</span>
<a href="#l14.309"></a><span id="l14.309" class="difflineminus">-          continue;</span>
<a href="#l14.310"></a><span id="l14.310" class="difflineplus">+  for (uint32_t index = 0; index &lt; mailViewCount; index++) {</span>
<a href="#l14.311"></a><span id="l14.311" class="difflineplus">+    GetMailViewAt(index, getter_AddRefs(mailView));</span>
<a href="#l14.312"></a><span id="l14.312" class="difflineplus">+    if (!mailView) continue;</span>
<a href="#l14.313"></a><span id="l14.313" class="difflineplus">+    mailView-&gt;GetMailViewName(getter_Copies(mailViewName));</span>
<a href="#l14.314"></a><span id="l14.314" class="difflineplus">+    mFilterList-&gt;CreateFilter(mailViewName, getter_AddRefs(newMailFilter));</span>
<a href="#l14.315"></a><span id="l14.315" class="difflineplus">+    if (!newMailFilter) continue;</span>
<a href="#l14.316"></a><span id="l14.316"> </span>
<a href="#l14.317"></a><span id="l14.317" class="difflineminus">-      nsCOMPtr&lt;nsIMutableArray&gt; searchTerms;</span>
<a href="#l14.318"></a><span id="l14.318" class="difflineminus">-      mailView-&gt;GetSearchTerms(getter_AddRefs(searchTerms));</span>
<a href="#l14.319"></a><span id="l14.319" class="difflineminus">-      newMailFilter-&gt;SetSearchTerms(searchTerms);</span>
<a href="#l14.320"></a><span id="l14.320" class="difflineminus">-      mFilterList-&gt;InsertFilterAt(index, newMailFilter);</span>
<a href="#l14.321"></a><span id="l14.321" class="difflineplus">+    nsCOMPtr&lt;nsIMutableArray&gt; searchTerms;</span>
<a href="#l14.322"></a><span id="l14.322" class="difflineplus">+    mailView-&gt;GetSearchTerms(getter_AddRefs(searchTerms));</span>
<a href="#l14.323"></a><span id="l14.323" class="difflineplus">+    newMailFilter-&gt;SetSearchTerms(searchTerms);</span>
<a href="#l14.324"></a><span id="l14.324" class="difflineplus">+    mFilterList-&gt;InsertFilterAt(index, newMailFilter);</span>
<a href="#l14.325"></a><span id="l14.325">   }</span>
<a href="#l14.326"></a><span id="l14.326"> </span>
<a href="#l14.327"></a><span id="l14.327">   return NS_OK;</span>
<a href="#l14.328"></a><span id="l14.328"> }</span>
<a href="#l14.329"></a><span id="l14.329"> </span>
<a href="#l14.330"></a><span id="l14.330" class="difflineminus">-nsresult nsMsgMailViewList::LoadMailViews()</span>
<a href="#l14.331"></a><span id="l14.331" class="difflineminus">-{</span>
<a href="#l14.332"></a><span id="l14.332" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l14.333"></a><span id="l14.333" class="difflineminus">-    nsresult rv = NS_GetSpecialDirectory(NS_APP_USER_PROFILE_50_DIR, getter_AddRefs(file));</span>
<a href="#l14.334"></a><span id="l14.334" class="difflineplus">+nsresult nsMsgMailViewList::LoadMailViews() {</span>
<a href="#l14.335"></a><span id="l14.335" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l14.336"></a><span id="l14.336" class="difflineplus">+  nsresult rv =</span>
<a href="#l14.337"></a><span id="l14.337" class="difflineplus">+      NS_GetSpecialDirectory(NS_APP_USER_PROFILE_50_DIR, getter_AddRefs(file));</span>
<a href="#l14.338"></a><span id="l14.338" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.339"></a><span id="l14.339" class="difflineplus">+</span>
<a href="#l14.340"></a><span id="l14.340" class="difflineplus">+  rv = file-&gt;AppendNative(nsDependentCString(&quot;mailViews.dat&quot;));</span>
<a href="#l14.341"></a><span id="l14.341" class="difflineplus">+</span>
<a href="#l14.342"></a><span id="l14.342" class="difflineplus">+  // if the file doesn't exist, we should try to get it from the defaults</span>
<a href="#l14.343"></a><span id="l14.343" class="difflineplus">+  // directory and copy it over</span>
<a href="#l14.344"></a><span id="l14.344" class="difflineplus">+  bool exists = false;</span>
<a href="#l14.345"></a><span id="l14.345" class="difflineplus">+  file-&gt;Exists(&amp;exists);</span>
<a href="#l14.346"></a><span id="l14.346" class="difflineplus">+  if (!exists) {</span>
<a href="#l14.347"></a><span id="l14.347" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession =</span>
<a href="#l14.348"></a><span id="l14.348" class="difflineplus">+        do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l14.349"></a><span id="l14.349">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.350"></a><span id="l14.350" class="difflineminus">-</span>
<a href="#l14.351"></a><span id="l14.351" class="difflineminus">-    rv = file-&gt;AppendNative(nsDependentCString(&quot;mailViews.dat&quot;));</span>
<a href="#l14.352"></a><span id="l14.352" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; defaultMessagesFile;</span>
<a href="#l14.353"></a><span id="l14.353" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; profileDir;</span>
<a href="#l14.354"></a><span id="l14.354" class="difflineplus">+    rv = mailSession-&gt;GetDataFilesDir(&quot;messenger&quot;,</span>
<a href="#l14.355"></a><span id="l14.355" class="difflineplus">+                                      getter_AddRefs(defaultMessagesFile));</span>
<a href="#l14.356"></a><span id="l14.356" class="difflineplus">+    rv = defaultMessagesFile-&gt;AppendNative(nsDependentCString(&quot;mailViews.dat&quot;));</span>
<a href="#l14.357"></a><span id="l14.357"> </span>
<a href="#l14.358"></a><span id="l14.358" class="difflineminus">-    // if the file doesn't exist, we should try to get it from the defaults directory and copy it over</span>
<a href="#l14.359"></a><span id="l14.359" class="difflineminus">-    bool exists = false;</span>
<a href="#l14.360"></a><span id="l14.360" class="difflineminus">-    file-&gt;Exists(&amp;exists);</span>
<a href="#l14.361"></a><span id="l14.361" class="difflineminus">-    if (!exists)</span>
<a href="#l14.362"></a><span id="l14.362" class="difflineminus">-    {</span>
<a href="#l14.363"></a><span id="l14.363" class="difflineminus">-        nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession = do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l14.364"></a><span id="l14.364" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.365"></a><span id="l14.365" class="difflineminus">-        nsCOMPtr&lt;nsIFile&gt; defaultMessagesFile;</span>
<a href="#l14.366"></a><span id="l14.366" class="difflineminus">-        nsCOMPtr&lt;nsIFile&gt; profileDir;</span>
<a href="#l14.367"></a><span id="l14.367" class="difflineminus">-        rv = mailSession-&gt;GetDataFilesDir(&quot;messenger&quot;, getter_AddRefs(defaultMessagesFile));</span>
<a href="#l14.368"></a><span id="l14.368" class="difflineminus">-        rv = defaultMessagesFile-&gt;AppendNative(nsDependentCString(&quot;mailViews.dat&quot;));</span>
<a href="#l14.369"></a><span id="l14.369" class="difflineminus">-</span>
<a href="#l14.370"></a><span id="l14.370" class="difflineminus">-         // get the profile directory</span>
<a href="#l14.371"></a><span id="l14.371" class="difflineminus">-        rv = NS_GetSpecialDirectory(NS_APP_USER_PROFILE_50_DIR, getter_AddRefs(profileDir));</span>
<a href="#l14.372"></a><span id="l14.372" class="difflineplus">+    // get the profile directory</span>
<a href="#l14.373"></a><span id="l14.373" class="difflineplus">+    rv = NS_GetSpecialDirectory(NS_APP_USER_PROFILE_50_DIR,</span>
<a href="#l14.374"></a><span id="l14.374" class="difflineplus">+                                getter_AddRefs(profileDir));</span>
<a href="#l14.375"></a><span id="l14.375"> </span>
<a href="#l14.376"></a><span id="l14.376" class="difflineminus">-        // now copy the file over to the profile directory</span>
<a href="#l14.377"></a><span id="l14.377" class="difflineminus">-        defaultMessagesFile-&gt;CopyToNative(profileDir, EmptyCString());</span>
<a href="#l14.378"></a><span id="l14.378" class="difflineminus">-    }</span>
<a href="#l14.379"></a><span id="l14.379" class="difflineminus">-    // this is kind of a hack but I think it will be an effective hack. The filter service already knows how to</span>
<a href="#l14.380"></a><span id="l14.380" class="difflineminus">-    // take a nsIFile and parse the contents into filters which are very similar to mail views. Instead of</span>
<a href="#l14.381"></a><span id="l14.381" class="difflineminus">-    // re-writing all of that dirty parsing code, let's just re-use it then convert the results into a data strcuture</span>
<a href="#l14.382"></a><span id="l14.382" class="difflineminus">-    // we wish to give to our consumers.</span>
<a href="#l14.383"></a><span id="l14.383" class="difflineplus">+    // now copy the file over to the profile directory</span>
<a href="#l14.384"></a><span id="l14.384" class="difflineplus">+    defaultMessagesFile-&gt;CopyToNative(profileDir, EmptyCString());</span>
<a href="#l14.385"></a><span id="l14.385" class="difflineplus">+  }</span>
<a href="#l14.386"></a><span id="l14.386" class="difflineplus">+  // this is kind of a hack but I think it will be an effective hack. The filter</span>
<a href="#l14.387"></a><span id="l14.387" class="difflineplus">+  // service already knows how to take a nsIFile and parse the contents into</span>
<a href="#l14.388"></a><span id="l14.388" class="difflineplus">+  // filters which are very similar to mail views. Instead of re-writing all of</span>
<a href="#l14.389"></a><span id="l14.389" class="difflineplus">+  // that dirty parsing code, let's just re-use it then convert the results into</span>
<a href="#l14.390"></a><span id="l14.390" class="difflineplus">+  // a data strcuture we wish to give to our consumers.</span>
<a href="#l14.391"></a><span id="l14.391"> </span>
<a href="#l14.392"></a><span id="l14.392" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFilterService&gt; filterService = do_GetService(NS_MSGFILTERSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l14.393"></a><span id="l14.393" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFilterList&gt; mfilterList;</span>
<a href="#l14.394"></a><span id="l14.394" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFilterService&gt; filterService =</span>
<a href="#l14.395"></a><span id="l14.395" class="difflineplus">+      do_GetService(NS_MSGFILTERSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l14.396"></a><span id="l14.396" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFilterList&gt; mfilterList;</span>
<a href="#l14.397"></a><span id="l14.397"> </span>
<a href="#l14.398"></a><span id="l14.398" class="difflineminus">-    rv = filterService-&gt;OpenFilterList(file, nullptr, nullptr, getter_AddRefs(mFilterList));</span>
<a href="#l14.399"></a><span id="l14.399" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.400"></a><span id="l14.400" class="difflineplus">+  rv = filterService-&gt;OpenFilterList(file, nullptr, nullptr,</span>
<a href="#l14.401"></a><span id="l14.401" class="difflineplus">+                                     getter_AddRefs(mFilterList));</span>
<a href="#l14.402"></a><span id="l14.402" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.403"></a><span id="l14.403"> </span>
<a href="#l14.404"></a><span id="l14.404" class="difflineminus">-    return ConvertFilterListToMailViews();</span>
<a href="#l14.405"></a><span id="l14.405" class="difflineplus">+  return ConvertFilterListToMailViews();</span>
<a href="#l14.406"></a><span id="l14.406"> }</span>
<a href="#l14.407"></a><span id="l14.407"> /**</span>
<a href="#l14.408"></a><span id="l14.408">  * Converts the filter list into our mail view objects,</span>
<a href="#l14.409"></a><span id="l14.409">  * stripping out just the info we need.</span>
<a href="#l14.410"></a><span id="l14.410">  */</span>
<a href="#l14.411"></a><span id="l14.411" class="difflineminus">-nsresult nsMsgMailViewList::ConvertFilterListToMailViews()</span>
<a href="#l14.412"></a><span id="l14.412" class="difflineminus">-{</span>
<a href="#l14.413"></a><span id="l14.413" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l14.414"></a><span id="l14.414" class="difflineminus">-    m_mailViews.Clear();</span>
<a href="#l14.415"></a><span id="l14.415" class="difflineplus">+nsresult nsMsgMailViewList::ConvertFilterListToMailViews() {</span>
<a href="#l14.416"></a><span id="l14.416" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l14.417"></a><span id="l14.417" class="difflineplus">+  m_mailViews.Clear();</span>
<a href="#l14.418"></a><span id="l14.418"> </span>
<a href="#l14.419"></a><span id="l14.419" class="difflineminus">-    // iterate over each filter in the list</span>
<a href="#l14.420"></a><span id="l14.420" class="difflineminus">-    uint32_t numFilters = 0;</span>
<a href="#l14.421"></a><span id="l14.421" class="difflineminus">-    mFilterList-&gt;GetFilterCount(&amp;numFilters);</span>
<a href="#l14.422"></a><span id="l14.422" class="difflineminus">-    for (uint32_t index = 0; index &lt; numFilters; index++)</span>
<a href="#l14.423"></a><span id="l14.423" class="difflineminus">-    {</span>
<a href="#l14.424"></a><span id="l14.424" class="difflineminus">-        nsCOMPtr&lt;nsIMsgFilter&gt; msgFilter;</span>
<a href="#l14.425"></a><span id="l14.425" class="difflineminus">-        rv = mFilterList-&gt;GetFilterAt(index, getter_AddRefs(msgFilter));</span>
<a href="#l14.426"></a><span id="l14.426" class="difflineminus">-        if (NS_FAILED(rv) || !msgFilter)</span>
<a href="#l14.427"></a><span id="l14.427" class="difflineminus">-            continue;</span>
<a href="#l14.428"></a><span id="l14.428" class="difflineplus">+  // iterate over each filter in the list</span>
<a href="#l14.429"></a><span id="l14.429" class="difflineplus">+  uint32_t numFilters = 0;</span>
<a href="#l14.430"></a><span id="l14.430" class="difflineplus">+  mFilterList-&gt;GetFilterCount(&amp;numFilters);</span>
<a href="#l14.431"></a><span id="l14.431" class="difflineplus">+  for (uint32_t index = 0; index &lt; numFilters; index++) {</span>
<a href="#l14.432"></a><span id="l14.432" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFilter&gt; msgFilter;</span>
<a href="#l14.433"></a><span id="l14.433" class="difflineplus">+    rv = mFilterList-&gt;GetFilterAt(index, getter_AddRefs(msgFilter));</span>
<a href="#l14.434"></a><span id="l14.434" class="difflineplus">+    if (NS_FAILED(rv) || !msgFilter) continue;</span>
<a href="#l14.435"></a><span id="l14.435" class="difflineplus">+</span>
<a href="#l14.436"></a><span id="l14.436" class="difflineplus">+    // create a new nsIMsgMailView for this item</span>
<a href="#l14.437"></a><span id="l14.437" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailView&gt; newMailView;</span>
<a href="#l14.438"></a><span id="l14.438" class="difflineplus">+    rv = CreateMailView(getter_AddRefs(newMailView));</span>
<a href="#l14.439"></a><span id="l14.439" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.440"></a><span id="l14.440"> </span>
<a href="#l14.441"></a><span id="l14.441" class="difflineminus">-        // create a new nsIMsgMailView for this item</span>
<a href="#l14.442"></a><span id="l14.442" class="difflineminus">-        nsCOMPtr&lt;nsIMsgMailView&gt; newMailView;</span>
<a href="#l14.443"></a><span id="l14.443" class="difflineminus">-        rv = CreateMailView(getter_AddRefs(newMailView));</span>
<a href="#l14.444"></a><span id="l14.444" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.445"></a><span id="l14.445" class="difflineminus">-</span>
<a href="#l14.446"></a><span id="l14.446" class="difflineminus">-        nsString filterName;</span>
<a href="#l14.447"></a><span id="l14.447" class="difflineminus">-        msgFilter-&gt;GetFilterName(filterName);</span>
<a href="#l14.448"></a><span id="l14.448" class="difflineminus">-        newMailView-&gt;SetMailViewName(filterName.get());</span>
<a href="#l14.449"></a><span id="l14.449" class="difflineplus">+    nsString filterName;</span>
<a href="#l14.450"></a><span id="l14.450" class="difflineplus">+    msgFilter-&gt;GetFilterName(filterName);</span>
<a href="#l14.451"></a><span id="l14.451" class="difflineplus">+    newMailView-&gt;SetMailViewName(filterName.get());</span>
<a href="#l14.452"></a><span id="l14.452"> </span>
<a href="#l14.453"></a><span id="l14.453" class="difflineminus">-        nsCOMPtr&lt;nsIMutableArray&gt; filterSearchTerms;</span>
<a href="#l14.454"></a><span id="l14.454" class="difflineminus">-        rv = msgFilter-&gt;GetSearchTerms(getter_AddRefs(filterSearchTerms));</span>
<a href="#l14.455"></a><span id="l14.455" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.456"></a><span id="l14.456" class="difflineminus">-        rv = newMailView-&gt;SetSearchTerms(filterSearchTerms);</span>
<a href="#l14.457"></a><span id="l14.457" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.458"></a><span id="l14.458" class="difflineplus">+    nsCOMPtr&lt;nsIMutableArray&gt; filterSearchTerms;</span>
<a href="#l14.459"></a><span id="l14.459" class="difflineplus">+    rv = msgFilter-&gt;GetSearchTerms(getter_AddRefs(filterSearchTerms));</span>
<a href="#l14.460"></a><span id="l14.460" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.461"></a><span id="l14.461" class="difflineplus">+    rv = newMailView-&gt;SetSearchTerms(filterSearchTerms);</span>
<a href="#l14.462"></a><span id="l14.462" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.463"></a><span id="l14.463"> </span>
<a href="#l14.464"></a><span id="l14.464" class="difflineminus">-        // now append this new mail view to our global list view</span>
<a href="#l14.465"></a><span id="l14.465" class="difflineminus">-        m_mailViews.AppendElement(newMailView);</span>
<a href="#l14.466"></a><span id="l14.466" class="difflineminus">-    }</span>
<a href="#l14.467"></a><span id="l14.467" class="difflineplus">+    // now append this new mail view to our global list view</span>
<a href="#l14.468"></a><span id="l14.468" class="difflineplus">+    m_mailViews.AppendElement(newMailView);</span>
<a href="#l14.469"></a><span id="l14.469" class="difflineplus">+  }</span>
<a href="#l14.470"></a><span id="l14.470"> </span>
<a href="#l14.471"></a><span id="l14.471" class="difflineminus">-    return rv;</span>
<a href="#l14.472"></a><span id="l14.472" class="difflineplus">+  return rv;</span>
<a href="#l14.473"></a><span id="l14.473"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/extensions/mailviews/src/nsMsgMailViewList.h</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/extensions/mailviews/src/nsMsgMailViewList.h</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -1,54 +1,52 @@</span>
<a href="#l15.4"></a><span id="l15.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l15.5"></a><span id="l15.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.6"></a><span id="l15.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.7"></a><span id="l15.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l15.8"></a><span id="l15.8"> </span>
<a href="#l15.9"></a><span id="l15.9" class="difflineminus">-</span>
<a href="#l15.10"></a><span id="l15.10"> #ifndef _nsMsgMailViewList_H_</span>
<a href="#l15.11"></a><span id="l15.11"> #define _nsMsgMailViewList_H_</span>
<a href="#l15.12"></a><span id="l15.12"> </span>
<a href="#l15.13"></a><span id="l15.13"> #include &quot;nscore.h&quot;</span>
<a href="#l15.14"></a><span id="l15.14"> #include &quot;nsIMsgMailViewList.h&quot;</span>
<a href="#l15.15"></a><span id="l15.15"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l15.16"></a><span id="l15.16"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l15.17"></a><span id="l15.17"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l15.18"></a><span id="l15.18"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l15.19"></a><span id="l15.19"> #include &quot;nsString.h&quot;</span>
<a href="#l15.20"></a><span id="l15.20"> #include &quot;nsIMsgFilterList.h&quot;</span>
<a href="#l15.21"></a><span id="l15.21"> </span>
<a href="#l15.22"></a><span id="l15.22"> // a mail View is just a name and an array of search terms</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineminus">-class nsMsgMailView : public nsIMsgMailView</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineminus">-{</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineminus">-public:</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineplus">+class nsMsgMailView : public nsIMsgMailView {</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineplus">+ public:</span>
<a href="#l15.28"></a><span id="l15.28">   NS_DECL_ISUPPORTS</span>
<a href="#l15.29"></a><span id="l15.29">   NS_DECL_NSIMSGMAILVIEW</span>
<a href="#l15.30"></a><span id="l15.30"> </span>
<a href="#l15.31"></a><span id="l15.31">   nsMsgMailView();</span>
<a href="#l15.32"></a><span id="l15.32"> </span>
<a href="#l15.33"></a><span id="l15.33" class="difflineminus">-protected:</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+ protected:</span>
<a href="#l15.35"></a><span id="l15.35">   virtual ~nsMsgMailView();</span>
<a href="#l15.36"></a><span id="l15.36">   nsString mName;</span>
<a href="#l15.37"></a><span id="l15.37">   nsCOMPtr&lt;nsIStringBundle&gt; mBundle;</span>
<a href="#l15.38"></a><span id="l15.38">   nsCOMPtr&lt;nsIMutableArray&gt; mViewSearchTerms;</span>
<a href="#l15.39"></a><span id="l15.39"> };</span>
<a href="#l15.40"></a><span id="l15.40"> </span>
<a href="#l15.41"></a><span id="l15.41" class="difflineminus">-</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineminus">-class nsMsgMailViewList : public nsIMsgMailViewList</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineminus">-{</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineminus">-public:</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+class nsMsgMailViewList : public nsIMsgMailViewList {</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineplus">+ public:</span>
<a href="#l15.47"></a><span id="l15.47">   NS_DECL_ISUPPORTS</span>
<a href="#l15.48"></a><span id="l15.48">   NS_DECL_NSIMSGMAILVIEWLIST</span>
<a href="#l15.49"></a><span id="l15.49"> </span>
<a href="#l15.50"></a><span id="l15.50">   nsMsgMailViewList();</span>
<a href="#l15.51"></a><span id="l15.51"> </span>
<a href="#l15.52"></a><span id="l15.52" class="difflineminus">-protected:</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineplus">+ protected:</span>
<a href="#l15.54"></a><span id="l15.54">   virtual ~nsMsgMailViewList();</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineminus">-  nsresult LoadMailViews(); // reads in user defined mail views from our default file</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineplus">+  nsresult</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineplus">+  LoadMailViews();  // reads in user defined mail views from our default file</span>
<a href="#l15.58"></a><span id="l15.58">   nsresult ConvertFilterListToMailViews();</span>
<a href="#l15.59"></a><span id="l15.59">   nsresult ConvertMailViewListToFilterList();</span>
<a href="#l15.60"></a><span id="l15.60"> </span>
<a href="#l15.61"></a><span id="l15.61">   nsCOMArray&lt;nsIMsgMailView&gt; m_mailViews;</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFilterList&gt; mFilterList; // our internal filter list representation</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFilterList&gt;</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineplus">+      mFilterList;  // our internal filter list representation</span>
<a href="#l15.65"></a><span id="l15.65"> };</span>
<a href="#l15.66"></a><span id="l15.66"> </span>
<a href="#l15.67"></a><span id="l15.67"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/extensions/mailviews/src/nsMsgMailViewsCID.h</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/extensions/mailviews/src/nsMsgMailViewsCID.h</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -1,17 +1,18 @@</span>
<a href="#l16.4"></a><span id="l16.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l16.5"></a><span id="l16.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l16.6"></a><span id="l16.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.7"></a><span id="l16.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.8"></a><span id="l16.8"> </span>
<a href="#l16.9"></a><span id="l16.9"> #ifndef nsMsgMailViewsCID_h__</span>
<a href="#l16.10"></a><span id="l16.10"> #define nsMsgMailViewsCID_h__</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-#define NS_MSGMAILVIEWLIST_CONTRACTID \</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-  &quot;@mozilla.org/messenger/mailviewlist;1&quot;</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+#define NS_MSGMAILVIEWLIST_CONTRACTID &quot;@mozilla.org/messenger/mailviewlist;1&quot;</span>
<a href="#l16.15"></a><span id="l16.15"> </span>
<a href="#l16.16"></a><span id="l16.16" class="difflineminus">-#define NS_MSGMAILVIEWLIST_CID                    \</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineminus">-{ /* A0258267-44FD-4886-A858-8192615178EC */      \</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineminus">- 0xa0258267, 0x44fd, 0x4886,                     \</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineminus">- { 0xa8, 0x58, 0x81, 0x92, 0x61, 0x51, 0x78, 0xec }}</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineplus">+#define NS_MSGMAILVIEWLIST_CID                       \</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineplus">+  { /* A0258267-44FD-4886-A858-8192615178EC */       \</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineplus">+    0xa0258267, 0x44fd, 0x4886, {                    \</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineplus">+      0xa8, 0x58, 0x81, 0x92, 0x61, 0x51, 0x78, 0xec \</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineplus">+    }                                                \</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineplus">+  }</span>
<a href="#l16.26"></a><span id="l16.26"> </span>
<a href="#l16.27"></a><span id="l16.27"> #endif /* nsMsgMailViewsCID_h__*/</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/extensions/mdn/src/nsMsgMdnCID.h</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/extensions/mdn/src/nsMsgMdnCID.h</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -1,16 +1,17 @@</span>
<a href="#l17.4"></a><span id="l17.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l17.5"></a><span id="l17.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l17.6"></a><span id="l17.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l17.7"></a><span id="l17.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l17.8"></a><span id="l17.8"> </span>
<a href="#l17.9"></a><span id="l17.9"> #ifndef nsMsgMdnCID_h__</span>
<a href="#l17.10"></a><span id="l17.10"> #define nsMsgMdnCID_h__</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-#define NS_MSGMDNGENERATOR_CONTRACTID \</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-  &quot;@mozilla.org/messenger-mdn/generator;1&quot;</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-#define NS_MSGMDNGENERATOR_CID                    \</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">-{ /* ec917b13-8f73-4d4d-9146-d7f7aafe9076 */      \</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineminus">- 0xec917b13, 0x8f73, 0x4d4d,                      \</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineminus">- { 0x91, 0x46, 0xd7, 0xf7, 0xaa, 0xfe, 0x90, 0x76 }}</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+#define NS_MSGMDNGENERATOR_CONTRACTID &quot;@mozilla.org/messenger-mdn/generator;1&quot;</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineplus">+#define NS_MSGMDNGENERATOR_CID                       \</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineplus">+  { /* ec917b13-8f73-4d4d-9146-d7f7aafe9076 */       \</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineplus">+    0xec917b13, 0x8f73, 0x4d4d, {                    \</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineplus">+      0x91, 0x46, 0xd7, 0xf7, 0xaa, 0xfe, 0x90, 0x76 \</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineplus">+    }                                                \</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineplus">+  }</span>
<a href="#l17.25"></a><span id="l17.25"> </span>
<a href="#l17.26"></a><span id="l17.26"> #endif /* nsMsgMdnCID_h__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -32,1112 +32,974 @@</span>
<a href="#l18.4"></a><span id="l18.4"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l18.5"></a><span id="l18.5"> #include &quot;nsIArray.h&quot;</span>
<a href="#l18.6"></a><span id="l18.6"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l18.7"></a><span id="l18.7"> #include &quot;mozilla/mailnews/MimeHeaderParser.h&quot;</span>
<a href="#l18.8"></a><span id="l18.8"> #include &quot;mozilla/Unused.h&quot;</span>
<a href="#l18.9"></a><span id="l18.9"> </span>
<a href="#l18.10"></a><span id="l18.10"> using namespace mozilla::mailnews;</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-#define MDN_NOT_IN_TO_CC          ((int) 0x0001)</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-#define MDN_OUTSIDE_DOMAIN        ((int) 0x0002)</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+#define MDN_NOT_IN_TO_CC ((int)0x0001)</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+#define MDN_OUTSIDE_DOMAIN ((int)0x0002)</span>
<a href="#l18.16"></a><span id="l18.16"> </span>
<a href="#l18.17"></a><span id="l18.17" class="difflineminus">-#define HEADER_RETURN_PATH          &quot;Return-Path&quot;</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineminus">-#define HEADER_DISPOSITION_NOTIFICATION_TO  &quot;Disposition-Notification-To&quot;</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineminus">-#define HEADER_APPARENTLY_TO        &quot;Apparently-To&quot;</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineminus">-#define HEADER_ORIGINAL_RECIPIENT     &quot;Original-Recipient&quot;</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineminus">-#define HEADER_REPORTING_UA                 &quot;Reporting-UA&quot;</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineminus">-#define HEADER_MDN_GATEWAY                  &quot;MDN-Gateway&quot;</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineminus">-#define HEADER_FINAL_RECIPIENT              &quot;Final-Recipient&quot;</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineminus">-#define HEADER_DISPOSITION                  &quot;Disposition&quot;</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineminus">-#define HEADER_ORIGINAL_MESSAGE_ID          &quot;Original-Message-ID&quot;</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineminus">-#define HEADER_FAILURE                      &quot;Failure&quot;</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineminus">-#define HEADER_ERROR                        &quot;Error&quot;</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineminus">-#define HEADER_WARNING                      &quot;Warning&quot;</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineminus">-#define HEADER_RETURN_RECEIPT_TO            &quot;Return-Receipt-To&quot;</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineminus">-#define HEADER_X_ACCEPT_LANGUAGE      &quot;X-Accept-Language&quot;</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+#define HEADER_RETURN_PATH &quot;Return-Path&quot;</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+#define HEADER_DISPOSITION_NOTIFICATION_TO &quot;Disposition-Notification-To&quot;</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineplus">+#define HEADER_APPARENTLY_TO &quot;Apparently-To&quot;</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+#define HEADER_ORIGINAL_RECIPIENT &quot;Original-Recipient&quot;</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineplus">+#define HEADER_REPORTING_UA &quot;Reporting-UA&quot;</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineplus">+#define HEADER_MDN_GATEWAY &quot;MDN-Gateway&quot;</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineplus">+#define HEADER_FINAL_RECIPIENT &quot;Final-Recipient&quot;</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineplus">+#define HEADER_DISPOSITION &quot;Disposition&quot;</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineplus">+#define HEADER_ORIGINAL_MESSAGE_ID &quot;Original-Message-ID&quot;</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineplus">+#define HEADER_FAILURE &quot;Failure&quot;</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineplus">+#define HEADER_ERROR &quot;Error&quot;</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineplus">+#define HEADER_WARNING &quot;Warning&quot;</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineplus">+#define HEADER_RETURN_RECEIPT_TO &quot;Return-Receipt-To&quot;</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineplus">+#define HEADER_X_ACCEPT_LANGUAGE &quot;X-Accept-Language&quot;</span>
<a href="#l18.45"></a><span id="l18.45"> </span>
<a href="#l18.46"></a><span id="l18.46" class="difflineminus">-#define PUSH_N_FREE_STRING(p) \</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineminus">-  do { if (p) { rv = WriteString(p); PR_smprintf_free(p); p=0; \</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineminus">-           if (NS_FAILED(rv)) return rv; } \</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineminus">-     else { return NS_ERROR_OUT_OF_MEMORY; } } while (0)</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineplus">+#define PUSH_N_FREE_STRING(p)        \</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+  do {                               \</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineplus">+    if (p) {                         \</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineplus">+      rv = WriteString(p);           \</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineplus">+      PR_smprintf_free(p);           \</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineplus">+      p = 0;                         \</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineplus">+      if (NS_FAILED(rv)) return rv;  \</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineplus">+    } else {                         \</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineplus">+      return NS_ERROR_OUT_OF_MEMORY; \</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineplus">+    }                                \</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineplus">+  } while (0)</span>
<a href="#l18.61"></a><span id="l18.61"> </span>
<a href="#l18.62"></a><span id="l18.62"> // String bundle for mdn. Class static.</span>
<a href="#l18.63"></a><span id="l18.63"> #define MDN_STRINGBUNDLE_URL &quot;chrome://messenger/locale/msgmdn.properties&quot;</span>
<a href="#l18.64"></a><span id="l18.64"> </span>
<a href="#l18.65"></a><span id="l18.65"> #if defined(DEBUG_jefft)</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineminus">-#define DEBUG_MDN(s) printf(&quot;%s\n&quot;, s)</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineplus">+#  define DEBUG_MDN(s) printf(&quot;%s\n&quot;, s)</span>
<a href="#l18.68"></a><span id="l18.68"> #else</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineminus">-#define DEBUG_MDN(s)</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineplus">+#  define DEBUG_MDN(s)</span>
<a href="#l18.71"></a><span id="l18.71"> #endif</span>
<a href="#l18.72"></a><span id="l18.72"> </span>
<a href="#l18.73"></a><span id="l18.73"> // machine parsible string; should not be localized</span>
<a href="#l18.74"></a><span id="l18.74"> char DispositionTypes[7][16] = {</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineminus">-    &quot;displayed&quot;,</span>
<a href="#l18.76"></a><span id="l18.76" class="difflineminus">-    &quot;dispatched&quot;,</span>
<a href="#l18.77"></a><span id="l18.77" class="difflineminus">-    &quot;processed&quot;,</span>
<a href="#l18.78"></a><span id="l18.78" class="difflineminus">-    &quot;deleted&quot;,</span>
<a href="#l18.79"></a><span id="l18.79" class="difflineminus">-    &quot;denied&quot;,</span>
<a href="#l18.80"></a><span id="l18.80" class="difflineminus">-    &quot;failed&quot;,</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineminus">-    &quot;&quot;</span>
<a href="#l18.82"></a><span id="l18.82" class="difflineminus">-};</span>
<a href="#l18.83"></a><span id="l18.83" class="difflineplus">+    &quot;displayed&quot;, &quot;dispatched&quot;, &quot;processed&quot;, &quot;deleted&quot;, &quot;denied&quot;, &quot;failed&quot;, &quot;&quot;};</span>
<a href="#l18.84"></a><span id="l18.84"> </span>
<a href="#l18.85"></a><span id="l18.85"> NS_IMPL_ISUPPORTS(nsMsgMdnGenerator, nsIMsgMdnGenerator, nsIUrlListener)</span>
<a href="#l18.86"></a><span id="l18.86"> </span>
<a href="#l18.87"></a><span id="l18.87" class="difflineminus">-nsMsgMdnGenerator::nsMsgMdnGenerator()</span>
<a href="#l18.88"></a><span id="l18.88" class="difflineminus">-{</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineminus">-    m_disposeType = eDisplayed;</span>
<a href="#l18.90"></a><span id="l18.90" class="difflineminus">-    m_outputStream = nullptr;</span>
<a href="#l18.91"></a><span id="l18.91" class="difflineminus">-    m_reallySendMdn = false;</span>
<a href="#l18.92"></a><span id="l18.92" class="difflineminus">-    m_autoSend = false;</span>
<a href="#l18.93"></a><span id="l18.93" class="difflineminus">-    m_autoAction = false;</span>
<a href="#l18.94"></a><span id="l18.94" class="difflineminus">-    m_mdnEnabled = false;</span>
<a href="#l18.95"></a><span id="l18.95" class="difflineminus">-    m_notInToCcOp = eNeverSendOp;</span>
<a href="#l18.96"></a><span id="l18.96" class="difflineminus">-    m_outsideDomainOp = eNeverSendOp;</span>
<a href="#l18.97"></a><span id="l18.97" class="difflineminus">-    m_otherOp = eNeverSendOp;</span>
<a href="#l18.98"></a><span id="l18.98" class="difflineplus">+nsMsgMdnGenerator::nsMsgMdnGenerator() {</span>
<a href="#l18.99"></a><span id="l18.99" class="difflineplus">+  m_disposeType = eDisplayed;</span>
<a href="#l18.100"></a><span id="l18.100" class="difflineplus">+  m_outputStream = nullptr;</span>
<a href="#l18.101"></a><span id="l18.101" class="difflineplus">+  m_reallySendMdn = false;</span>
<a href="#l18.102"></a><span id="l18.102" class="difflineplus">+  m_autoSend = false;</span>
<a href="#l18.103"></a><span id="l18.103" class="difflineplus">+  m_autoAction = false;</span>
<a href="#l18.104"></a><span id="l18.104" class="difflineplus">+  m_mdnEnabled = false;</span>
<a href="#l18.105"></a><span id="l18.105" class="difflineplus">+  m_notInToCcOp = eNeverSendOp;</span>
<a href="#l18.106"></a><span id="l18.106" class="difflineplus">+  m_outsideDomainOp = eNeverSendOp;</span>
<a href="#l18.107"></a><span id="l18.107" class="difflineplus">+  m_otherOp = eNeverSendOp;</span>
<a href="#l18.108"></a><span id="l18.108"> }</span>
<a href="#l18.109"></a><span id="l18.109"> </span>
<a href="#l18.110"></a><span id="l18.110" class="difflineminus">-nsMsgMdnGenerator::~nsMsgMdnGenerator()</span>
<a href="#l18.111"></a><span id="l18.111" class="difflineminus">-{</span>
<a href="#l18.112"></a><span id="l18.112" class="difflineminus">-}</span>
<a href="#l18.113"></a><span id="l18.113" class="difflineplus">+nsMsgMdnGenerator::~nsMsgMdnGenerator() {}</span>
<a href="#l18.114"></a><span id="l18.114"> </span>
<a href="#l18.115"></a><span id="l18.115"> nsresult nsMsgMdnGenerator::FormatStringFromName(const char *aName,</span>
<a href="#l18.116"></a><span id="l18.116">                                                  const char16_t *aString,</span>
<a href="#l18.117"></a><span id="l18.117" class="difflineminus">-                                                 nsAString&amp; aResultString)</span>
<a href="#l18.118"></a><span id="l18.118" class="difflineminus">-{</span>
<a href="#l18.119"></a><span id="l18.119" class="difflineminus">-    DEBUG_MDN(&quot;nsMsgMdnGenerator::FormatStringFromName&quot;);</span>
<a href="#l18.120"></a><span id="l18.120" class="difflineplus">+                                                 nsAString &amp;aResultString) {</span>
<a href="#l18.121"></a><span id="l18.121" class="difflineplus">+  DEBUG_MDN(&quot;nsMsgMdnGenerator::FormatStringFromName&quot;);</span>
<a href="#l18.122"></a><span id="l18.122"> </span>
<a href="#l18.123"></a><span id="l18.123" class="difflineminus">-    nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l18.124"></a><span id="l18.124" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l18.125"></a><span id="l18.125">       mozilla::services::GetStringBundleService();</span>
<a href="#l18.126"></a><span id="l18.126" class="difflineminus">-    NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l18.127"></a><span id="l18.127" class="difflineplus">+  NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l18.128"></a><span id="l18.128"> </span>
<a href="#l18.129"></a><span id="l18.129" class="difflineminus">-    nsCOMPtr &lt;nsIStringBundle&gt; bundle;</span>
<a href="#l18.130"></a><span id="l18.130" class="difflineminus">-    nsresult rv = bundleService-&gt;CreateBundle(MDN_STRINGBUNDLE_URL,</span>
<a href="#l18.131"></a><span id="l18.131" class="difflineminus">-                                              getter_AddRefs(bundle));</span>
<a href="#l18.132"></a><span id="l18.132" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.133"></a><span id="l18.133" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l18.134"></a><span id="l18.134" class="difflineplus">+  nsresult rv =</span>
<a href="#l18.135"></a><span id="l18.135" class="difflineplus">+      bundleService-&gt;CreateBundle(MDN_STRINGBUNDLE_URL, getter_AddRefs(bundle));</span>
<a href="#l18.136"></a><span id="l18.136" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.137"></a><span id="l18.137"> </span>
<a href="#l18.138"></a><span id="l18.138" class="difflineminus">-    const char16_t *formatStrings[1] = { aString };</span>
<a href="#l18.139"></a><span id="l18.139" class="difflineminus">-    rv = bundle-&gt;FormatStringFromName(aName,</span>
<a href="#l18.140"></a><span id="l18.140" class="difflineminus">-                    formatStrings, 1, aResultString);</span>
<a href="#l18.141"></a><span id="l18.141" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.142"></a><span id="l18.142" class="difflineminus">-    return rv;</span>
<a href="#l18.143"></a><span id="l18.143" class="difflineplus">+  const char16_t *formatStrings[1] = {aString};</span>
<a href="#l18.144"></a><span id="l18.144" class="difflineplus">+  rv = bundle-&gt;FormatStringFromName(aName, formatStrings, 1, aResultString);</span>
<a href="#l18.145"></a><span id="l18.145" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.146"></a><span id="l18.146" class="difflineplus">+  return rv;</span>
<a href="#l18.147"></a><span id="l18.147"> }</span>
<a href="#l18.148"></a><span id="l18.148"> </span>
<a href="#l18.149"></a><span id="l18.149"> nsresult nsMsgMdnGenerator::GetStringFromName(const char *aName,</span>
<a href="#l18.150"></a><span id="l18.150" class="difflineminus">-                                              nsAString&amp; aResultString)</span>
<a href="#l18.151"></a><span id="l18.151" class="difflineminus">-{</span>
<a href="#l18.152"></a><span id="l18.152" class="difflineminus">-    DEBUG_MDN(&quot;nsMsgMdnGenerator::GetStringFromName&quot;);</span>
<a href="#l18.153"></a><span id="l18.153" class="difflineplus">+                                              nsAString &amp;aResultString) {</span>
<a href="#l18.154"></a><span id="l18.154" class="difflineplus">+  DEBUG_MDN(&quot;nsMsgMdnGenerator::GetStringFromName&quot;);</span>
<a href="#l18.155"></a><span id="l18.155"> </span>
<a href="#l18.156"></a><span id="l18.156" class="difflineminus">-    nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l18.157"></a><span id="l18.157" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l18.158"></a><span id="l18.158">       mozilla::services::GetStringBundleService();</span>
<a href="#l18.159"></a><span id="l18.159" class="difflineminus">-    NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l18.160"></a><span id="l18.160" class="difflineplus">+  NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l18.161"></a><span id="l18.161"> </span>
<a href="#l18.162"></a><span id="l18.162" class="difflineminus">-    nsCOMPtr &lt;nsIStringBundle&gt; bundle;</span>
<a href="#l18.163"></a><span id="l18.163" class="difflineminus">-    nsresult rv = bundleService-&gt;CreateBundle(MDN_STRINGBUNDLE_URL,</span>
<a href="#l18.164"></a><span id="l18.164" class="difflineminus">-                                              getter_AddRefs(bundle));</span>
<a href="#l18.165"></a><span id="l18.165" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.166"></a><span id="l18.166" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l18.167"></a><span id="l18.167" class="difflineplus">+  nsresult rv =</span>
<a href="#l18.168"></a><span id="l18.168" class="difflineplus">+      bundleService-&gt;CreateBundle(MDN_STRINGBUNDLE_URL, getter_AddRefs(bundle));</span>
<a href="#l18.169"></a><span id="l18.169" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.170"></a><span id="l18.170"> </span>
<a href="#l18.171"></a><span id="l18.171" class="difflineminus">-    rv = bundle-&gt;GetStringFromName(aName, aResultString);</span>
<a href="#l18.172"></a><span id="l18.172" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.173"></a><span id="l18.173" class="difflineminus">-    return rv;</span>
<a href="#l18.174"></a><span id="l18.174" class="difflineplus">+  rv = bundle-&gt;GetStringFromName(aName, aResultString);</span>
<a href="#l18.175"></a><span id="l18.175" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.176"></a><span id="l18.176" class="difflineplus">+  return rv;</span>
<a href="#l18.177"></a><span id="l18.177"> }</span>
<a href="#l18.178"></a><span id="l18.178"> </span>
<a href="#l18.179"></a><span id="l18.179"> nsresult nsMsgMdnGenerator::StoreMDNSentFlag(nsIMsgFolder *folder,</span>
<a href="#l18.180"></a><span id="l18.180" class="difflineminus">-                                             nsMsgKey key)</span>
<a href="#l18.181"></a><span id="l18.181" class="difflineminus">-{</span>
<a href="#l18.182"></a><span id="l18.182" class="difflineminus">-    DEBUG_MDN(&quot;nsMsgMdnGenerator::StoreMDNSentFlag&quot;);</span>
<a href="#l18.183"></a><span id="l18.183" class="difflineplus">+                                             nsMsgKey key) {</span>
<a href="#l18.184"></a><span id="l18.184" class="difflineplus">+  DEBUG_MDN(&quot;nsMsgMdnGenerator::StoreMDNSentFlag&quot;);</span>
<a href="#l18.185"></a><span id="l18.185"> </span>
<a href="#l18.186"></a><span id="l18.186" class="difflineminus">-    nsCOMPtr&lt;nsIMsgDatabase&gt; msgDB;</span>
<a href="#l18.187"></a><span id="l18.187" class="difflineminus">-    nsresult rv = folder-&gt;GetMsgDatabase(getter_AddRefs(msgDB));</span>
<a href="#l18.188"></a><span id="l18.188" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.189"></a><span id="l18.189" class="difflineminus">-    rv = msgDB-&gt;MarkMDNSent(key, true, nullptr);</span>
<a href="#l18.190"></a><span id="l18.190" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; msgDB;</span>
<a href="#l18.191"></a><span id="l18.191" class="difflineplus">+  nsresult rv = folder-&gt;GetMsgDatabase(getter_AddRefs(msgDB));</span>
<a href="#l18.192"></a><span id="l18.192" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.193"></a><span id="l18.193" class="difflineplus">+  rv = msgDB-&gt;MarkMDNSent(key, true, nullptr);</span>
<a href="#l18.194"></a><span id="l18.194"> </span>
<a href="#l18.195"></a><span id="l18.195" class="difflineminus">-    nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(folder);</span>
<a href="#l18.196"></a><span id="l18.196" class="difflineminus">-    // Store the $MDNSent flag if the folder is an Imap Mail Folder</span>
<a href="#l18.197"></a><span id="l18.197" class="difflineminus">-    if (imapFolder)</span>
<a href="#l18.198"></a><span id="l18.198" class="difflineminus">-      return imapFolder-&gt;StoreImapFlags(kImapMsgMDNSentFlag, true, &amp;key, 1, nullptr);</span>
<a href="#l18.199"></a><span id="l18.199" class="difflineminus">-    return rv;</span>
<a href="#l18.200"></a><span id="l18.200" class="difflineplus">+  nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(folder);</span>
<a href="#l18.201"></a><span id="l18.201" class="difflineplus">+  // Store the $MDNSent flag if the folder is an Imap Mail Folder</span>
<a href="#l18.202"></a><span id="l18.202" class="difflineplus">+  if (imapFolder)</span>
<a href="#l18.203"></a><span id="l18.203" class="difflineplus">+    return imapFolder-&gt;StoreImapFlags(kImapMsgMDNSentFlag, true, &amp;key, 1,</span>
<a href="#l18.204"></a><span id="l18.204" class="difflineplus">+                                      nullptr);</span>
<a href="#l18.205"></a><span id="l18.205" class="difflineplus">+  return rv;</span>
<a href="#l18.206"></a><span id="l18.206"> }</span>
<a href="#l18.207"></a><span id="l18.207"> </span>
<a href="#l18.208"></a><span id="l18.208"> nsresult nsMsgMdnGenerator::ClearMDNNeededFlag(nsIMsgFolder *folder,</span>
<a href="#l18.209"></a><span id="l18.209" class="difflineminus">-                                               nsMsgKey key)</span>
<a href="#l18.210"></a><span id="l18.210" class="difflineminus">-{</span>
<a href="#l18.211"></a><span id="l18.211" class="difflineplus">+                                               nsMsgKey key) {</span>
<a href="#l18.212"></a><span id="l18.212">   DEBUG_MDN(&quot;nsMsgMdnGenerator::ClearMDNNeededFlag&quot;);</span>
<a href="#l18.213"></a><span id="l18.213"> </span>
<a href="#l18.214"></a><span id="l18.214">   nsCOMPtr&lt;nsIMsgDatabase&gt; msgDB;</span>
<a href="#l18.215"></a><span id="l18.215">   nsresult rv = folder-&gt;GetMsgDatabase(getter_AddRefs(msgDB));</span>
<a href="#l18.216"></a><span id="l18.216">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.217"></a><span id="l18.217">   return msgDB-&gt;MarkMDNNeeded(key, false, nullptr);</span>
<a href="#l18.218"></a><span id="l18.218"> }</span>
<a href="#l18.219"></a><span id="l18.219"> </span>
<a href="#l18.220"></a><span id="l18.220" class="difflineminus">-bool nsMsgMdnGenerator::ProcessSendMode()</span>
<a href="#l18.221"></a><span id="l18.221" class="difflineminus">-{</span>
<a href="#l18.222"></a><span id="l18.222" class="difflineminus">-    DEBUG_MDN(&quot;nsMsgMdnGenerator::ProcessSendMode&quot;);</span>
<a href="#l18.223"></a><span id="l18.223" class="difflineminus">-    int32_t miscState = 0;</span>
<a href="#l18.224"></a><span id="l18.224" class="difflineplus">+bool nsMsgMdnGenerator::ProcessSendMode() {</span>
<a href="#l18.225"></a><span id="l18.225" class="difflineplus">+  DEBUG_MDN(&quot;nsMsgMdnGenerator::ProcessSendMode&quot;);</span>
<a href="#l18.226"></a><span id="l18.226" class="difflineplus">+  int32_t miscState = 0;</span>
<a href="#l18.227"></a><span id="l18.227"> </span>
<a href="#l18.228"></a><span id="l18.228" class="difflineminus">-    if (m_identity)</span>
<a href="#l18.229"></a><span id="l18.229" class="difflineminus">-    {</span>
<a href="#l18.230"></a><span id="l18.230" class="difflineminus">-        m_identity-&gt;GetEmail(m_email);</span>
<a href="#l18.231"></a><span id="l18.231" class="difflineminus">-        if (m_email.IsEmpty())</span>
<a href="#l18.232"></a><span id="l18.232" class="difflineminus">-            return m_reallySendMdn;</span>
<a href="#l18.233"></a><span id="l18.233" class="difflineplus">+  if (m_identity) {</span>
<a href="#l18.234"></a><span id="l18.234" class="difflineplus">+    m_identity-&gt;GetEmail(m_email);</span>
<a href="#l18.235"></a><span id="l18.235" class="difflineplus">+    if (m_email.IsEmpty()) return m_reallySendMdn;</span>
<a href="#l18.236"></a><span id="l18.236"> </span>
<a href="#l18.237"></a><span id="l18.237" class="difflineminus">-        const char *accountDomain = strchr(m_email.get(), '@');</span>
<a href="#l18.238"></a><span id="l18.238" class="difflineminus">-        if (!accountDomain)</span>
<a href="#l18.239"></a><span id="l18.239" class="difflineminus">-            return m_reallySendMdn;</span>
<a href="#l18.240"></a><span id="l18.240" class="difflineplus">+    const char *accountDomain = strchr(m_email.get(), '@');</span>
<a href="#l18.241"></a><span id="l18.241" class="difflineplus">+    if (!accountDomain) return m_reallySendMdn;</span>
<a href="#l18.242"></a><span id="l18.242"> </span>
<a href="#l18.243"></a><span id="l18.243" class="difflineminus">-        if (MailAddrMatch(m_email.get(), m_dntRrt.get())) // return address is self, don't send</span>
<a href="#l18.244"></a><span id="l18.244" class="difflineminus">-          return false;</span>
<a href="#l18.245"></a><span id="l18.245" class="difflineplus">+    if (MailAddrMatch(m_email.get(),</span>
<a href="#l18.246"></a><span id="l18.246" class="difflineplus">+                      m_dntRrt.get()))  // return address is self, don't send</span>
<a href="#l18.247"></a><span id="l18.247" class="difflineplus">+      return false;</span>
<a href="#l18.248"></a><span id="l18.248"> </span>
<a href="#l18.249"></a><span id="l18.249" class="difflineminus">-        // *** fix me see Bug 132504 for more information</span>
<a href="#l18.250"></a><span id="l18.250" class="difflineminus">-        // *** what if the message has been filtered to different account</span>
<a href="#l18.251"></a><span id="l18.251" class="difflineminus">-        if (!PL_strcasestr(m_dntRrt.get(), accountDomain))</span>
<a href="#l18.252"></a><span id="l18.252" class="difflineminus">-            miscState |= MDN_OUTSIDE_DOMAIN;</span>
<a href="#l18.253"></a><span id="l18.253" class="difflineminus">-        if (NotInToOrCc())</span>
<a href="#l18.254"></a><span id="l18.254" class="difflineminus">-            miscState |= MDN_NOT_IN_TO_CC;</span>
<a href="#l18.255"></a><span id="l18.255" class="difflineminus">-        m_reallySendMdn = true;</span>
<a href="#l18.256"></a><span id="l18.256" class="difflineminus">-        // *********</span>
<a href="#l18.257"></a><span id="l18.257" class="difflineminus">-        // How are we gona deal with the auto forwarding issues? Some server</span>
<a href="#l18.258"></a><span id="l18.258" class="difflineminus">-        // didn't bother to add addition header or modify existing header to</span>
<a href="#l18.259"></a><span id="l18.259" class="difflineminus">-        // the message when forwarding. They simply copy the exact same</span>
<a href="#l18.260"></a><span id="l18.260" class="difflineminus">-        // message to another user's mailbox. Some change To: to</span>
<a href="#l18.261"></a><span id="l18.261" class="difflineminus">-        // Apparently-To:</span>
<a href="#l18.262"></a><span id="l18.262" class="difflineminus">-        // Unfortunately, there is nothing we can do. It's out of our control.</span>
<a href="#l18.263"></a><span id="l18.263" class="difflineminus">-        // *********</span>
<a href="#l18.264"></a><span id="l18.264" class="difflineminus">-        // starting from lowest denominator to highest</span>
<a href="#l18.265"></a><span id="l18.265" class="difflineminus">-        if (!miscState)</span>
<a href="#l18.266"></a><span id="l18.266" class="difflineminus">-        {   // under normal situation: recipent is in to and cc list,</span>
<a href="#l18.267"></a><span id="l18.267" class="difflineminus">-            // and the sender is from the same domain</span>
<a href="#l18.268"></a><span id="l18.268" class="difflineminus">-            switch (m_otherOp)</span>
<a href="#l18.269"></a><span id="l18.269" class="difflineminus">-            {</span>
<a href="#l18.270"></a><span id="l18.270" class="difflineminus">-            default:</span>
<a href="#l18.271"></a><span id="l18.271" class="difflineminus">-            case eNeverSendOp:</span>
<a href="#l18.272"></a><span id="l18.272" class="difflineminus">-                m_reallySendMdn = false;</span>
<a href="#l18.273"></a><span id="l18.273" class="difflineminus">-                break;</span>
<a href="#l18.274"></a><span id="l18.274" class="difflineminus">-            case eAutoSendOp:</span>
<a href="#l18.275"></a><span id="l18.275" class="difflineminus">-                m_autoSend = true;</span>
<a href="#l18.276"></a><span id="l18.276" class="difflineminus">-                break;</span>
<a href="#l18.277"></a><span id="l18.277" class="difflineminus">-            case eAskMeOp:</span>
<a href="#l18.278"></a><span id="l18.278" class="difflineminus">-                m_autoSend = false;</span>
<a href="#l18.279"></a><span id="l18.279" class="difflineminus">-                break;</span>
<a href="#l18.280"></a><span id="l18.280" class="difflineminus">-            case eDeniedOp:</span>
<a href="#l18.281"></a><span id="l18.281" class="difflineminus">-                m_autoSend = true;</span>
<a href="#l18.282"></a><span id="l18.282" class="difflineminus">-                m_disposeType = eDenied;</span>
<a href="#l18.283"></a><span id="l18.283" class="difflineminus">-                break;</span>
<a href="#l18.284"></a><span id="l18.284" class="difflineminus">-            }</span>
<a href="#l18.285"></a><span id="l18.285" class="difflineplus">+    // *** fix me see Bug 132504 for more information</span>
<a href="#l18.286"></a><span id="l18.286" class="difflineplus">+    // *** what if the message has been filtered to different account</span>
<a href="#l18.287"></a><span id="l18.287" class="difflineplus">+    if (!PL_strcasestr(m_dntRrt.get(), accountDomain))</span>
<a href="#l18.288"></a><span id="l18.288" class="difflineplus">+      miscState |= MDN_OUTSIDE_DOMAIN;</span>
<a href="#l18.289"></a><span id="l18.289" class="difflineplus">+    if (NotInToOrCc()) miscState |= MDN_NOT_IN_TO_CC;</span>
<a href="#l18.290"></a><span id="l18.290" class="difflineplus">+    m_reallySendMdn = true;</span>
<a href="#l18.291"></a><span id="l18.291" class="difflineplus">+    // *********</span>
<a href="#l18.292"></a><span id="l18.292" class="difflineplus">+    // How are we gona deal with the auto forwarding issues? Some server</span>
<a href="#l18.293"></a><span id="l18.293" class="difflineplus">+    // didn't bother to add addition header or modify existing header to</span>
<a href="#l18.294"></a><span id="l18.294" class="difflineplus">+    // the message when forwarding. They simply copy the exact same</span>
<a href="#l18.295"></a><span id="l18.295" class="difflineplus">+    // message to another user's mailbox. Some change To: to</span>
<a href="#l18.296"></a><span id="l18.296" class="difflineplus">+    // Apparently-To:</span>
<a href="#l18.297"></a><span id="l18.297" class="difflineplus">+    // Unfortunately, there is nothing we can do. It's out of our control.</span>
<a href="#l18.298"></a><span id="l18.298" class="difflineplus">+    // *********</span>
<a href="#l18.299"></a><span id="l18.299" class="difflineplus">+    // starting from lowest denominator to highest</span>
<a href="#l18.300"></a><span id="l18.300" class="difflineplus">+    if (!miscState) {  // under normal situation: recipent is in to and cc list,</span>
<a href="#l18.301"></a><span id="l18.301" class="difflineplus">+      // and the sender is from the same domain</span>
<a href="#l18.302"></a><span id="l18.302" class="difflineplus">+      switch (m_otherOp) {</span>
<a href="#l18.303"></a><span id="l18.303" class="difflineplus">+        default:</span>
<a href="#l18.304"></a><span id="l18.304" class="difflineplus">+        case eNeverSendOp:</span>
<a href="#l18.305"></a><span id="l18.305" class="difflineplus">+          m_reallySendMdn = false;</span>
<a href="#l18.306"></a><span id="l18.306" class="difflineplus">+          break;</span>
<a href="#l18.307"></a><span id="l18.307" class="difflineplus">+        case eAutoSendOp:</span>
<a href="#l18.308"></a><span id="l18.308" class="difflineplus">+          m_autoSend = true;</span>
<a href="#l18.309"></a><span id="l18.309" class="difflineplus">+          break;</span>
<a href="#l18.310"></a><span id="l18.310" class="difflineplus">+        case eAskMeOp:</span>
<a href="#l18.311"></a><span id="l18.311" class="difflineplus">+          m_autoSend = false;</span>
<a href="#l18.312"></a><span id="l18.312" class="difflineplus">+          break;</span>
<a href="#l18.313"></a><span id="l18.313" class="difflineplus">+        case eDeniedOp:</span>
<a href="#l18.314"></a><span id="l18.314" class="difflineplus">+          m_autoSend = true;</span>
<a href="#l18.315"></a><span id="l18.315" class="difflineplus">+          m_disposeType = eDenied;</span>
<a href="#l18.316"></a><span id="l18.316" class="difflineplus">+          break;</span>
<a href="#l18.317"></a><span id="l18.317" class="difflineplus">+      }</span>
<a href="#l18.318"></a><span id="l18.318" class="difflineplus">+    } else if (miscState == (MDN_OUTSIDE_DOMAIN | MDN_NOT_IN_TO_CC)) {</span>
<a href="#l18.319"></a><span id="l18.319" class="difflineplus">+      if (m_outsideDomainOp != m_notInToCcOp) {</span>
<a href="#l18.320"></a><span id="l18.320" class="difflineplus">+        m_autoSend = false;  // ambiguous; always ask user</span>
<a href="#l18.321"></a><span id="l18.321" class="difflineplus">+      } else {</span>
<a href="#l18.322"></a><span id="l18.322" class="difflineplus">+        switch (m_outsideDomainOp) {</span>
<a href="#l18.323"></a><span id="l18.323" class="difflineplus">+          default:</span>
<a href="#l18.324"></a><span id="l18.324" class="difflineplus">+          case eNeverSendOp:</span>
<a href="#l18.325"></a><span id="l18.325" class="difflineplus">+            m_reallySendMdn = false;</span>
<a href="#l18.326"></a><span id="l18.326" class="difflineplus">+            break;</span>
<a href="#l18.327"></a><span id="l18.327" class="difflineplus">+          case eAutoSendOp:</span>
<a href="#l18.328"></a><span id="l18.328" class="difflineplus">+            m_autoSend = true;</span>
<a href="#l18.329"></a><span id="l18.329" class="difflineplus">+            break;</span>
<a href="#l18.330"></a><span id="l18.330" class="difflineplus">+          case eAskMeOp:</span>
<a href="#l18.331"></a><span id="l18.331" class="difflineplus">+            m_autoSend = false;</span>
<a href="#l18.332"></a><span id="l18.332" class="difflineplus">+            break;</span>
<a href="#l18.333"></a><span id="l18.333">         }</span>
<a href="#l18.334"></a><span id="l18.334" class="difflineminus">-        else if (miscState == (MDN_OUTSIDE_DOMAIN | MDN_NOT_IN_TO_CC))</span>
<a href="#l18.335"></a><span id="l18.335" class="difflineminus">-        {</span>
<a href="#l18.336"></a><span id="l18.336" class="difflineminus">-            if (m_outsideDomainOp != m_notInToCcOp)</span>
<a href="#l18.337"></a><span id="l18.337" class="difflineminus">-            {</span>
<a href="#l18.338"></a><span id="l18.338" class="difflineminus">-                m_autoSend = false; // ambiguous; always ask user</span>
<a href="#l18.339"></a><span id="l18.339" class="difflineminus">-            }</span>
<a href="#l18.340"></a><span id="l18.340" class="difflineminus">-            else</span>
<a href="#l18.341"></a><span id="l18.341" class="difflineminus">-            {</span>
<a href="#l18.342"></a><span id="l18.342" class="difflineminus">-                switch (m_outsideDomainOp)</span>
<a href="#l18.343"></a><span id="l18.343" class="difflineminus">-                {</span>
<a href="#l18.344"></a><span id="l18.344" class="difflineminus">-                default:</span>
<a href="#l18.345"></a><span id="l18.345" class="difflineminus">-                case eNeverSendOp:</span>
<a href="#l18.346"></a><span id="l18.346" class="difflineminus">-                    m_reallySendMdn = false;</span>
<a href="#l18.347"></a><span id="l18.347" class="difflineminus">-                    break;</span>
<a href="#l18.348"></a><span id="l18.348" class="difflineminus">-                case eAutoSendOp:</span>
<a href="#l18.349"></a><span id="l18.349" class="difflineminus">-                    m_autoSend = true;</span>
<a href="#l18.350"></a><span id="l18.350" class="difflineminus">-                    break;</span>
<a href="#l18.351"></a><span id="l18.351" class="difflineminus">-                case eAskMeOp:</span>
<a href="#l18.352"></a><span id="l18.352" class="difflineminus">-                    m_autoSend = false;</span>
<a href="#l18.353"></a><span id="l18.353" class="difflineminus">-                    break;</span>
<a href="#l18.354"></a><span id="l18.354" class="difflineminus">-                }</span>
<a href="#l18.355"></a><span id="l18.355" class="difflineminus">-            }</span>
<a href="#l18.356"></a><span id="l18.356" class="difflineminus">-        }</span>
<a href="#l18.357"></a><span id="l18.357" class="difflineminus">-        else if (miscState &amp; MDN_OUTSIDE_DOMAIN)</span>
<a href="#l18.358"></a><span id="l18.358" class="difflineminus">-        {</span>
<a href="#l18.359"></a><span id="l18.359" class="difflineminus">-            switch (m_outsideDomainOp)</span>
<a href="#l18.360"></a><span id="l18.360" class="difflineminus">-            {</span>
<a href="#l18.361"></a><span id="l18.361" class="difflineminus">-            default:</span>
<a href="#l18.362"></a><span id="l18.362" class="difflineminus">-            case eNeverSendOp:</span>
<a href="#l18.363"></a><span id="l18.363" class="difflineminus">-                m_reallySendMdn = false;</span>
<a href="#l18.364"></a><span id="l18.364" class="difflineminus">-                break;</span>
<a href="#l18.365"></a><span id="l18.365" class="difflineminus">-            case eAutoSendOp:</span>
<a href="#l18.366"></a><span id="l18.366" class="difflineminus">-                m_autoSend = true;</span>
<a href="#l18.367"></a><span id="l18.367" class="difflineminus">-                break;</span>
<a href="#l18.368"></a><span id="l18.368" class="difflineminus">-            case eAskMeOp:</span>
<a href="#l18.369"></a><span id="l18.369" class="difflineminus">-                m_autoSend = false;</span>
<a href="#l18.370"></a><span id="l18.370" class="difflineminus">-                break;</span>
<a href="#l18.371"></a><span id="l18.371" class="difflineminus">-            }</span>
<a href="#l18.372"></a><span id="l18.372" class="difflineminus">-        }</span>
<a href="#l18.373"></a><span id="l18.373" class="difflineminus">-        else if (miscState &amp; MDN_NOT_IN_TO_CC)</span>
<a href="#l18.374"></a><span id="l18.374" class="difflineminus">-        {</span>
<a href="#l18.375"></a><span id="l18.375" class="difflineminus">-            switch (m_notInToCcOp)</span>
<a href="#l18.376"></a><span id="l18.376" class="difflineminus">-            {</span>
<a href="#l18.377"></a><span id="l18.377" class="difflineminus">-            default:</span>
<a href="#l18.378"></a><span id="l18.378" class="difflineminus">-            case eNeverSendOp:</span>
<a href="#l18.379"></a><span id="l18.379" class="difflineminus">-                m_reallySendMdn = false;</span>
<a href="#l18.380"></a><span id="l18.380" class="difflineminus">-                break;</span>
<a href="#l18.381"></a><span id="l18.381" class="difflineminus">-            case eAutoSendOp:</span>
<a href="#l18.382"></a><span id="l18.382" class="difflineminus">-                m_autoSend = true;</span>
<a href="#l18.383"></a><span id="l18.383" class="difflineminus">-                break;</span>
<a href="#l18.384"></a><span id="l18.384" class="difflineminus">-            case eAskMeOp:</span>
<a href="#l18.385"></a><span id="l18.385" class="difflineminus">-                m_autoSend = false;</span>
<a href="#l18.386"></a><span id="l18.386" class="difflineminus">-                break;</span>
<a href="#l18.387"></a><span id="l18.387" class="difflineminus">-            }</span>
<a href="#l18.388"></a><span id="l18.388" class="difflineminus">-        }</span>
<a href="#l18.389"></a><span id="l18.389" class="difflineplus">+      }</span>
<a href="#l18.390"></a><span id="l18.390" class="difflineplus">+    } else if (miscState &amp; MDN_OUTSIDE_DOMAIN) {</span>
<a href="#l18.391"></a><span id="l18.391" class="difflineplus">+      switch (m_outsideDomainOp) {</span>
<a href="#l18.392"></a><span id="l18.392" class="difflineplus">+        default:</span>
<a href="#l18.393"></a><span id="l18.393" class="difflineplus">+        case eNeverSendOp:</span>
<a href="#l18.394"></a><span id="l18.394" class="difflineplus">+          m_reallySendMdn = false;</span>
<a href="#l18.395"></a><span id="l18.395" class="difflineplus">+          break;</span>
<a href="#l18.396"></a><span id="l18.396" class="difflineplus">+        case eAutoSendOp:</span>
<a href="#l18.397"></a><span id="l18.397" class="difflineplus">+          m_autoSend = true;</span>
<a href="#l18.398"></a><span id="l18.398" class="difflineplus">+          break;</span>
<a href="#l18.399"></a><span id="l18.399" class="difflineplus">+        case eAskMeOp:</span>
<a href="#l18.400"></a><span id="l18.400" class="difflineplus">+          m_autoSend = false;</span>
<a href="#l18.401"></a><span id="l18.401" class="difflineplus">+          break;</span>
<a href="#l18.402"></a><span id="l18.402" class="difflineplus">+      }</span>
<a href="#l18.403"></a><span id="l18.403" class="difflineplus">+    } else if (miscState &amp; MDN_NOT_IN_TO_CC) {</span>
<a href="#l18.404"></a><span id="l18.404" class="difflineplus">+      switch (m_notInToCcOp) {</span>
<a href="#l18.405"></a><span id="l18.405" class="difflineplus">+        default:</span>
<a href="#l18.406"></a><span id="l18.406" class="difflineplus">+        case eNeverSendOp:</span>
<a href="#l18.407"></a><span id="l18.407" class="difflineplus">+          m_reallySendMdn = false;</span>
<a href="#l18.408"></a><span id="l18.408" class="difflineplus">+          break;</span>
<a href="#l18.409"></a><span id="l18.409" class="difflineplus">+        case eAutoSendOp:</span>
<a href="#l18.410"></a><span id="l18.410" class="difflineplus">+          m_autoSend = true;</span>
<a href="#l18.411"></a><span id="l18.411" class="difflineplus">+          break;</span>
<a href="#l18.412"></a><span id="l18.412" class="difflineplus">+        case eAskMeOp:</span>
<a href="#l18.413"></a><span id="l18.413" class="difflineplus">+          m_autoSend = false;</span>
<a href="#l18.414"></a><span id="l18.414" class="difflineplus">+          break;</span>
<a href="#l18.415"></a><span id="l18.415" class="difflineplus">+      }</span>
<a href="#l18.416"></a><span id="l18.416">     }</span>
<a href="#l18.417"></a><span id="l18.417" class="difflineminus">-    return m_reallySendMdn;</span>
<a href="#l18.418"></a><span id="l18.418" class="difflineplus">+  }</span>
<a href="#l18.419"></a><span id="l18.419" class="difflineplus">+  return m_reallySendMdn;</span>
<a href="#l18.420"></a><span id="l18.420"> }</span>
<a href="#l18.421"></a><span id="l18.421"> </span>
<a href="#l18.422"></a><span id="l18.422" class="difflineminus">-bool nsMsgMdnGenerator::MailAddrMatch(const char *addr1, const char *addr2)</span>
<a href="#l18.423"></a><span id="l18.423" class="difflineminus">-{</span>
<a href="#l18.424"></a><span id="l18.424" class="difflineminus">-    // Comparing two email addresses returns true if matched; local/account</span>
<a href="#l18.425"></a><span id="l18.425" class="difflineminus">-    // part comparison is case sensitive; domain part comparison is case</span>
<a href="#l18.426"></a><span id="l18.426" class="difflineminus">-    // insensitive</span>
<a href="#l18.427"></a><span id="l18.427" class="difflineminus">-    DEBUG_MDN(&quot;nsMsgMdnGenerator::MailAddrMatch&quot;);</span>
<a href="#l18.428"></a><span id="l18.428" class="difflineminus">-    bool isMatched = true;</span>
<a href="#l18.429"></a><span id="l18.429" class="difflineminus">-    const char *atSign1 = nullptr, *atSign2 = nullptr;</span>
<a href="#l18.430"></a><span id="l18.430" class="difflineminus">-    const char *lt = nullptr, *local1 = nullptr, *local2 = nullptr;</span>
<a href="#l18.431"></a><span id="l18.431" class="difflineminus">-    const char *end1 = nullptr, *end2 = nullptr;</span>
<a href="#l18.432"></a><span id="l18.432" class="difflineplus">+bool nsMsgMdnGenerator::MailAddrMatch(const char *addr1, const char *addr2) {</span>
<a href="#l18.433"></a><span id="l18.433" class="difflineplus">+  // Comparing two email addresses returns true if matched; local/account</span>
<a href="#l18.434"></a><span id="l18.434" class="difflineplus">+  // part comparison is case sensitive; domain part comparison is case</span>
<a href="#l18.435"></a><span id="l18.435" class="difflineplus">+  // insensitive</span>
<a href="#l18.436"></a><span id="l18.436" class="difflineplus">+  DEBUG_MDN(&quot;nsMsgMdnGenerator::MailAddrMatch&quot;);</span>
<a href="#l18.437"></a><span id="l18.437" class="difflineplus">+  bool isMatched = true;</span>
<a href="#l18.438"></a><span id="l18.438" class="difflineplus">+  const char *atSign1 = nullptr, *atSign2 = nullptr;</span>
<a href="#l18.439"></a><span id="l18.439" class="difflineplus">+  const char *lt = nullptr, *local1 = nullptr, *local2 = nullptr;</span>
<a href="#l18.440"></a><span id="l18.440" class="difflineplus">+  const char *end1 = nullptr, *end2 = nullptr;</span>
<a href="#l18.441"></a><span id="l18.441"> </span>
<a href="#l18.442"></a><span id="l18.442" class="difflineminus">-    if (!addr1 || !addr2)</span>
<a href="#l18.443"></a><span id="l18.443" class="difflineminus">-        return false;</span>
<a href="#l18.444"></a><span id="l18.444" class="difflineplus">+  if (!addr1 || !addr2) return false;</span>
<a href="#l18.445"></a><span id="l18.445"> </span>
<a href="#l18.446"></a><span id="l18.446" class="difflineminus">-    lt = strchr(addr1, '&lt;');</span>
<a href="#l18.447"></a><span id="l18.447" class="difflineminus">-    local1 = !lt ? addr1 : lt+1;</span>
<a href="#l18.448"></a><span id="l18.448" class="difflineminus">-    lt = strchr(addr2, '&lt;');</span>
<a href="#l18.449"></a><span id="l18.449" class="difflineminus">-    local2 = !lt ? addr2 : lt+1;</span>
<a href="#l18.450"></a><span id="l18.450" class="difflineminus">-    end1 = strchr(local1, '&gt;');</span>
<a href="#l18.451"></a><span id="l18.451" class="difflineminus">-    if (!end1)</span>
<a href="#l18.452"></a><span id="l18.452" class="difflineminus">-        end1 = addr1 + strlen(addr1);</span>
<a href="#l18.453"></a><span id="l18.453" class="difflineminus">-    end2 = strchr(local2, '&gt;');</span>
<a href="#l18.454"></a><span id="l18.454" class="difflineminus">-    if (!end2)</span>
<a href="#l18.455"></a><span id="l18.455" class="difflineminus">-        end2 = addr2 + strlen(addr2);</span>
<a href="#l18.456"></a><span id="l18.456" class="difflineminus">-    atSign1 = strchr(local1, '@');</span>
<a href="#l18.457"></a><span id="l18.457" class="difflineminus">-    atSign2 = strchr(local2, '@');</span>
<a href="#l18.458"></a><span id="l18.458" class="difflineminus">-    if (!atSign1 || !atSign2 // ill formed addr spec</span>
<a href="#l18.459"></a><span id="l18.459" class="difflineminus">-        || (atSign1 - local1) != (atSign2 - local2))</span>
<a href="#l18.460"></a><span id="l18.460" class="difflineminus">-        isMatched = false;</span>
<a href="#l18.461"></a><span id="l18.461" class="difflineminus">-    else if (strncmp(local1, local2, (atSign1-local1))) // case sensitive</span>
<a href="#l18.462"></a><span id="l18.462" class="difflineminus">-        // compare for local part</span>
<a href="#l18.463"></a><span id="l18.463" class="difflineminus">-        isMatched = false;</span>
<a href="#l18.464"></a><span id="l18.464" class="difflineminus">-    else if ((end1 - atSign1) != (end2 - atSign2) ||</span>
<a href="#l18.465"></a><span id="l18.465" class="difflineminus">-             PL_strncasecmp(atSign1, atSign2, (end1-atSign1))) // case</span>
<a href="#l18.466"></a><span id="l18.466" class="difflineminus">-        // insensitive compare for domain part</span>
<a href="#l18.467"></a><span id="l18.467" class="difflineminus">-        isMatched = false;</span>
<a href="#l18.468"></a><span id="l18.468" class="difflineminus">-    return isMatched;</span>
<a href="#l18.469"></a><span id="l18.469" class="difflineplus">+  lt = strchr(addr1, '&lt;');</span>
<a href="#l18.470"></a><span id="l18.470" class="difflineplus">+  local1 = !lt ? addr1 : lt + 1;</span>
<a href="#l18.471"></a><span id="l18.471" class="difflineplus">+  lt = strchr(addr2, '&lt;');</span>
<a href="#l18.472"></a><span id="l18.472" class="difflineplus">+  local2 = !lt ? addr2 : lt + 1;</span>
<a href="#l18.473"></a><span id="l18.473" class="difflineplus">+  end1 = strchr(local1, '&gt;');</span>
<a href="#l18.474"></a><span id="l18.474" class="difflineplus">+  if (!end1) end1 = addr1 + strlen(addr1);</span>
<a href="#l18.475"></a><span id="l18.475" class="difflineplus">+  end2 = strchr(local2, '&gt;');</span>
<a href="#l18.476"></a><span id="l18.476" class="difflineplus">+  if (!end2) end2 = addr2 + strlen(addr2);</span>
<a href="#l18.477"></a><span id="l18.477" class="difflineplus">+  atSign1 = strchr(local1, '@');</span>
<a href="#l18.478"></a><span id="l18.478" class="difflineplus">+  atSign2 = strchr(local2, '@');</span>
<a href="#l18.479"></a><span id="l18.479" class="difflineplus">+  if (!atSign1 || !atSign2  // ill formed addr spec</span>
<a href="#l18.480"></a><span id="l18.480" class="difflineplus">+      || (atSign1 - local1) != (atSign2 - local2))</span>
<a href="#l18.481"></a><span id="l18.481" class="difflineplus">+    isMatched = false;</span>
<a href="#l18.482"></a><span id="l18.482" class="difflineplus">+  else if (strncmp(local1, local2, (atSign1 - local1)))  // case sensitive</span>
<a href="#l18.483"></a><span id="l18.483" class="difflineplus">+    // compare for local part</span>
<a href="#l18.484"></a><span id="l18.484" class="difflineplus">+    isMatched = false;</span>
<a href="#l18.485"></a><span id="l18.485" class="difflineplus">+  else if ((end1 - atSign1) != (end2 - atSign2) ||</span>
<a href="#l18.486"></a><span id="l18.486" class="difflineplus">+           PL_strncasecmp(atSign1, atSign2, (end1 - atSign1)))  // case</span>
<a href="#l18.487"></a><span id="l18.487" class="difflineplus">+    // insensitive compare for domain part</span>
<a href="#l18.488"></a><span id="l18.488" class="difflineplus">+    isMatched = false;</span>
<a href="#l18.489"></a><span id="l18.489" class="difflineplus">+  return isMatched;</span>
<a href="#l18.490"></a><span id="l18.490"> }</span>
<a href="#l18.491"></a><span id="l18.491"> </span>
<a href="#l18.492"></a><span id="l18.492" class="difflineminus">-bool nsMsgMdnGenerator::NotInToOrCc()</span>
<a href="#l18.493"></a><span id="l18.493" class="difflineminus">-{</span>
<a href="#l18.494"></a><span id="l18.494" class="difflineminus">-    DEBUG_MDN(&quot;nsMsgMdnGenerator::NotInToOrCc&quot;);</span>
<a href="#l18.495"></a><span id="l18.495" class="difflineminus">-    nsCString reply_to;</span>
<a href="#l18.496"></a><span id="l18.496" class="difflineminus">-    nsCString to;</span>
<a href="#l18.497"></a><span id="l18.497" class="difflineminus">-    nsCString cc;</span>
<a href="#l18.498"></a><span id="l18.498" class="difflineplus">+bool nsMsgMdnGenerator::NotInToOrCc() {</span>
<a href="#l18.499"></a><span id="l18.499" class="difflineplus">+  DEBUG_MDN(&quot;nsMsgMdnGenerator::NotInToOrCc&quot;);</span>
<a href="#l18.500"></a><span id="l18.500" class="difflineplus">+  nsCString reply_to;</span>
<a href="#l18.501"></a><span id="l18.501" class="difflineplus">+  nsCString to;</span>
<a href="#l18.502"></a><span id="l18.502" class="difflineplus">+  nsCString cc;</span>
<a href="#l18.503"></a><span id="l18.503"> </span>
<a href="#l18.504"></a><span id="l18.504" class="difflineminus">-    m_identity-&gt;GetReplyTo(reply_to);</span>
<a href="#l18.505"></a><span id="l18.505" class="difflineminus">-    m_headers-&gt;ExtractHeader(HEADER_TO, true, to);</span>
<a href="#l18.506"></a><span id="l18.506" class="difflineminus">-    m_headers-&gt;ExtractHeader(HEADER_CC, true, cc);</span>
<a href="#l18.507"></a><span id="l18.507" class="difflineplus">+  m_identity-&gt;GetReplyTo(reply_to);</span>
<a href="#l18.508"></a><span id="l18.508" class="difflineplus">+  m_headers-&gt;ExtractHeader(HEADER_TO, true, to);</span>
<a href="#l18.509"></a><span id="l18.509" class="difflineplus">+  m_headers-&gt;ExtractHeader(HEADER_CC, true, cc);</span>
<a href="#l18.510"></a><span id="l18.510"> </span>
<a href="#l18.511"></a><span id="l18.511">   // start with a simple check</span>
<a href="#l18.512"></a><span id="l18.512">   if ((!to.IsEmpty() &amp;&amp; PL_strcasestr(to.get(), m_email.get())) ||</span>
<a href="#l18.513"></a><span id="l18.513">       (!cc.IsEmpty() &amp;&amp; PL_strcasestr(cc.get(), m_email.get()))) {</span>
<a href="#l18.514"></a><span id="l18.514" class="difflineminus">-      return false;</span>
<a href="#l18.515"></a><span id="l18.515" class="difflineplus">+    return false;</span>
<a href="#l18.516"></a><span id="l18.516">   }</span>
<a href="#l18.517"></a><span id="l18.517"> </span>
<a href="#l18.518"></a><span id="l18.518" class="difflineminus">-  if ((!reply_to.IsEmpty() &amp;&amp; !to.IsEmpty() &amp;&amp; PL_strcasestr(to.get(), reply_to.get())) ||</span>
<a href="#l18.519"></a><span id="l18.519" class="difflineminus">-      (!reply_to.IsEmpty() &amp;&amp; !cc.IsEmpty() &amp;&amp; PL_strcasestr(cc.get(), reply_to.get()))) {</span>
<a href="#l18.520"></a><span id="l18.520" class="difflineminus">-      return false;</span>
<a href="#l18.521"></a><span id="l18.521" class="difflineplus">+  if ((!reply_to.IsEmpty() &amp;&amp; !to.IsEmpty() &amp;&amp;</span>
<a href="#l18.522"></a><span id="l18.522" class="difflineplus">+       PL_strcasestr(to.get(), reply_to.get())) ||</span>
<a href="#l18.523"></a><span id="l18.523" class="difflineplus">+      (!reply_to.IsEmpty() &amp;&amp; !cc.IsEmpty() &amp;&amp;</span>
<a href="#l18.524"></a><span id="l18.524" class="difflineplus">+       PL_strcasestr(cc.get(), reply_to.get()))) {</span>
<a href="#l18.525"></a><span id="l18.525" class="difflineplus">+    return false;</span>
<a href="#l18.526"></a><span id="l18.526">   }</span>
<a href="#l18.527"></a><span id="l18.527">   return true;</span>
<a href="#l18.528"></a><span id="l18.528"> }</span>
<a href="#l18.529"></a><span id="l18.529"> </span>
<a href="#l18.530"></a><span id="l18.530" class="difflineminus">-bool nsMsgMdnGenerator::ValidateReturnPath()</span>
<a href="#l18.531"></a><span id="l18.531" class="difflineminus">-{</span>
<a href="#l18.532"></a><span id="l18.532" class="difflineminus">-    DEBUG_MDN(&quot;nsMsgMdnGenerator::ValidateReturnPath&quot;);</span>
<a href="#l18.533"></a><span id="l18.533" class="difflineminus">-    // ValidateReturnPath applies to Automatic Send Mode only. If we were not</span>
<a href="#l18.534"></a><span id="l18.534" class="difflineminus">-    // in auto send mode we simply by passing the check</span>
<a href="#l18.535"></a><span id="l18.535" class="difflineminus">-    if (!m_autoSend)</span>
<a href="#l18.536"></a><span id="l18.536" class="difflineminus">-        return m_reallySendMdn;</span>
<a href="#l18.537"></a><span id="l18.537" class="difflineplus">+bool nsMsgMdnGenerator::ValidateReturnPath() {</span>
<a href="#l18.538"></a><span id="l18.538" class="difflineplus">+  DEBUG_MDN(&quot;nsMsgMdnGenerator::ValidateReturnPath&quot;);</span>
<a href="#l18.539"></a><span id="l18.539" class="difflineplus">+  // ValidateReturnPath applies to Automatic Send Mode only. If we were not</span>
<a href="#l18.540"></a><span id="l18.540" class="difflineplus">+  // in auto send mode we simply by passing the check</span>
<a href="#l18.541"></a><span id="l18.541" class="difflineplus">+  if (!m_autoSend) return m_reallySendMdn;</span>
<a href="#l18.542"></a><span id="l18.542"> </span>
<a href="#l18.543"></a><span id="l18.543" class="difflineminus">-    nsCString returnPath;</span>
<a href="#l18.544"></a><span id="l18.544" class="difflineminus">-    m_headers-&gt;ExtractHeader(HEADER_RETURN_PATH, false, returnPath);</span>
<a href="#l18.545"></a><span id="l18.545" class="difflineminus">-    if (returnPath.IsEmpty())</span>
<a href="#l18.546"></a><span id="l18.546" class="difflineminus">-    {</span>
<a href="#l18.547"></a><span id="l18.547" class="difflineminus">-      m_autoSend = false;</span>
<a href="#l18.548"></a><span id="l18.548" class="difflineminus">-      return m_reallySendMdn;</span>
<a href="#l18.549"></a><span id="l18.549" class="difflineminus">-    }</span>
<a href="#l18.550"></a><span id="l18.550" class="difflineminus">-    m_autoSend = MailAddrMatch(returnPath.get(), m_dntRrt.get());</span>
<a href="#l18.551"></a><span id="l18.551" class="difflineplus">+  nsCString returnPath;</span>
<a href="#l18.552"></a><span id="l18.552" class="difflineplus">+  m_headers-&gt;ExtractHeader(HEADER_RETURN_PATH, false, returnPath);</span>
<a href="#l18.553"></a><span id="l18.553" class="difflineplus">+  if (returnPath.IsEmpty()) {</span>
<a href="#l18.554"></a><span id="l18.554" class="difflineplus">+    m_autoSend = false;</span>
<a href="#l18.555"></a><span id="l18.555">     return m_reallySendMdn;</span>
<a href="#l18.556"></a><span id="l18.556" class="difflineplus">+  }</span>
<a href="#l18.557"></a><span id="l18.557" class="difflineplus">+  m_autoSend = MailAddrMatch(returnPath.get(), m_dntRrt.get());</span>
<a href="#l18.558"></a><span id="l18.558" class="difflineplus">+  return m_reallySendMdn;</span>
<a href="#l18.559"></a><span id="l18.559"> }</span>
<a href="#l18.560"></a><span id="l18.560"> </span>
<a href="#l18.561"></a><span id="l18.561" class="difflineminus">-nsresult nsMsgMdnGenerator::CreateMdnMsg()</span>
<a href="#l18.562"></a><span id="l18.562" class="difflineminus">-{</span>
<a href="#l18.563"></a><span id="l18.563" class="difflineminus">-    DEBUG_MDN(&quot;nsMsgMdnGenerator::CreateMdnMsg&quot;);</span>
<a href="#l18.564"></a><span id="l18.564" class="difflineminus">-    nsresult rv;</span>
<a href="#l18.565"></a><span id="l18.565" class="difflineplus">+nsresult nsMsgMdnGenerator::CreateMdnMsg() {</span>
<a href="#l18.566"></a><span id="l18.566" class="difflineplus">+  DEBUG_MDN(&quot;nsMsgMdnGenerator::CreateMdnMsg&quot;);</span>
<a href="#l18.567"></a><span id="l18.567" class="difflineplus">+  nsresult rv;</span>
<a href="#l18.568"></a><span id="l18.568"> </span>
<a href="#l18.569"></a><span id="l18.569" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; tmpFile;</span>
<a href="#l18.570"></a><span id="l18.570" class="difflineminus">-    rv = GetSpecialDirectoryWithFileName(NS_OS_TEMP_DIR,</span>
<a href="#l18.571"></a><span id="l18.571" class="difflineminus">-                                         &quot;mdnmsg&quot;,</span>
<a href="#l18.572"></a><span id="l18.572" class="difflineminus">-                                         getter_AddRefs(m_file));</span>
<a href="#l18.573"></a><span id="l18.573" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.574"></a><span id="l18.574" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; tmpFile;</span>
<a href="#l18.575"></a><span id="l18.575" class="difflineplus">+  rv = GetSpecialDirectoryWithFileName(NS_OS_TEMP_DIR, &quot;mdnmsg&quot;,</span>
<a href="#l18.576"></a><span id="l18.576" class="difflineplus">+                                       getter_AddRefs(m_file));</span>
<a href="#l18.577"></a><span id="l18.577" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.578"></a><span id="l18.578" class="difflineplus">+</span>
<a href="#l18.579"></a><span id="l18.579" class="difflineplus">+  rv = m_file-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 00600);</span>
<a href="#l18.580"></a><span id="l18.580" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.581"></a><span id="l18.581" class="difflineplus">+  rv = MsgNewBufferedFileOutputStream(getter_AddRefs(m_outputStream), m_file,</span>
<a href="#l18.582"></a><span id="l18.582" class="difflineplus">+                                      PR_CREATE_FILE | PR_WRONLY | PR_TRUNCATE,</span>
<a href="#l18.583"></a><span id="l18.583" class="difflineplus">+                                      0664);</span>
<a href="#l18.584"></a><span id="l18.584" class="difflineplus">+  NS_ASSERTION(NS_SUCCEEDED(rv), &quot;creating mdn: failed to output stream&quot;);</span>
<a href="#l18.585"></a><span id="l18.585" class="difflineplus">+  if (NS_FAILED(rv)) return NS_OK;</span>
<a href="#l18.586"></a><span id="l18.586"> </span>
<a href="#l18.587"></a><span id="l18.587" class="difflineminus">-    rv = m_file-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 00600);</span>
<a href="#l18.588"></a><span id="l18.588" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.589"></a><span id="l18.589" class="difflineminus">-    rv = MsgNewBufferedFileOutputStream(getter_AddRefs(m_outputStream),</span>
<a href="#l18.590"></a><span id="l18.590" class="difflineminus">-                                        m_file,</span>
<a href="#l18.591"></a><span id="l18.591" class="difflineminus">-                                        PR_CREATE_FILE | PR_WRONLY | PR_TRUNCATE,</span>
<a href="#l18.592"></a><span id="l18.592" class="difflineminus">-                                        0664);</span>
<a href="#l18.593"></a><span id="l18.593" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv),&quot;creating mdn: failed to output stream&quot;);</span>
<a href="#l18.594"></a><span id="l18.594" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l18.595"></a><span id="l18.595" class="difflineminus">-        return NS_OK;</span>
<a href="#l18.596"></a><span id="l18.596" class="difflineplus">+  rv = CreateFirstPart();</span>
<a href="#l18.597"></a><span id="l18.597" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l18.598"></a><span id="l18.598" class="difflineplus">+    rv = CreateSecondPart();</span>
<a href="#l18.599"></a><span id="l18.599" class="difflineplus">+    if (NS_SUCCEEDED(rv)) rv = CreateThirdPart();</span>
<a href="#l18.600"></a><span id="l18.600" class="difflineplus">+  }</span>
<a href="#l18.601"></a><span id="l18.601"> </span>
<a href="#l18.602"></a><span id="l18.602" class="difflineminus">-    rv = CreateFirstPart();</span>
<a href="#l18.603"></a><span id="l18.603" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l18.604"></a><span id="l18.604" class="difflineminus">-    {</span>
<a href="#l18.605"></a><span id="l18.605" class="difflineminus">-        rv = CreateSecondPart();</span>
<a href="#l18.606"></a><span id="l18.606" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l18.607"></a><span id="l18.607" class="difflineminus">-            rv = CreateThirdPart();</span>
<a href="#l18.608"></a><span id="l18.608" class="difflineminus">-    }</span>
<a href="#l18.609"></a><span id="l18.609" class="difflineplus">+  if (m_outputStream) {</span>
<a href="#l18.610"></a><span id="l18.610" class="difflineplus">+    m_outputStream-&gt;Flush();</span>
<a href="#l18.611"></a><span id="l18.611" class="difflineplus">+    m_outputStream-&gt;Close();</span>
<a href="#l18.612"></a><span id="l18.612" class="difflineplus">+  }</span>
<a href="#l18.613"></a><span id="l18.613" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l18.614"></a><span id="l18.614" class="difflineplus">+    m_file-&gt;Remove(false);</span>
<a href="#l18.615"></a><span id="l18.615" class="difflineplus">+  else</span>
<a href="#l18.616"></a><span id="l18.616" class="difflineplus">+    rv = SendMdnMsg();</span>
<a href="#l18.617"></a><span id="l18.617"> </span>
<a href="#l18.618"></a><span id="l18.618" class="difflineminus">-    if (m_outputStream)</span>
<a href="#l18.619"></a><span id="l18.619" class="difflineminus">-    {</span>
<a href="#l18.620"></a><span id="l18.620" class="difflineminus">-        m_outputStream-&gt;Flush();</span>
<a href="#l18.621"></a><span id="l18.621" class="difflineminus">-        m_outputStream-&gt;Close();</span>
<a href="#l18.622"></a><span id="l18.622" class="difflineminus">-    }</span>
<a href="#l18.623"></a><span id="l18.623" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l18.624"></a><span id="l18.624" class="difflineminus">-        m_file-&gt;Remove(false);</span>
<a href="#l18.625"></a><span id="l18.625" class="difflineminus">-    else</span>
<a href="#l18.626"></a><span id="l18.626" class="difflineminus">-        rv = SendMdnMsg();</span>
<a href="#l18.627"></a><span id="l18.627" class="difflineminus">-</span>
<a href="#l18.628"></a><span id="l18.628" class="difflineminus">-    return NS_OK;</span>
<a href="#l18.629"></a><span id="l18.629" class="difflineplus">+  return NS_OK;</span>
<a href="#l18.630"></a><span id="l18.630"> }</span>
<a href="#l18.631"></a><span id="l18.631"> </span>
<a href="#l18.632"></a><span id="l18.632" class="difflineminus">-nsresult nsMsgMdnGenerator::CreateFirstPart()</span>
<a href="#l18.633"></a><span id="l18.633" class="difflineminus">-{</span>
<a href="#l18.634"></a><span id="l18.634" class="difflineminus">-    DEBUG_MDN(&quot;nsMsgMdnGenerator::CreateFirstPart&quot;);</span>
<a href="#l18.635"></a><span id="l18.635" class="difflineminus">-    char *convbuf = nullptr, *tmpBuffer = nullptr;</span>
<a href="#l18.636"></a><span id="l18.636" class="difflineminus">-    char *parm = nullptr;</span>
<a href="#l18.637"></a><span id="l18.637" class="difflineminus">-    nsString firstPart1;</span>
<a href="#l18.638"></a><span id="l18.638" class="difflineminus">-    nsString firstPart2;</span>
<a href="#l18.639"></a><span id="l18.639" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l18.640"></a><span id="l18.640" class="difflineminus">-    nsCOMPtr &lt;nsIMsgCompUtils&gt; compUtils;</span>
<a href="#l18.641"></a><span id="l18.641" class="difflineplus">+nsresult nsMsgMdnGenerator::CreateFirstPart() {</span>
<a href="#l18.642"></a><span id="l18.642" class="difflineplus">+  DEBUG_MDN(&quot;nsMsgMdnGenerator::CreateFirstPart&quot;);</span>
<a href="#l18.643"></a><span id="l18.643" class="difflineplus">+  char *convbuf = nullptr, *tmpBuffer = nullptr;</span>
<a href="#l18.644"></a><span id="l18.644" class="difflineplus">+  char *parm = nullptr;</span>
<a href="#l18.645"></a><span id="l18.645" class="difflineplus">+  nsString firstPart1;</span>
<a href="#l18.646"></a><span id="l18.646" class="difflineplus">+  nsString firstPart2;</span>
<a href="#l18.647"></a><span id="l18.647" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l18.648"></a><span id="l18.648" class="difflineplus">+  nsCOMPtr&lt;nsIMsgCompUtils&gt; compUtils;</span>
<a href="#l18.649"></a><span id="l18.649"> </span>
<a href="#l18.650"></a><span id="l18.650" class="difflineminus">-    if (m_mimeSeparator.IsEmpty())</span>
<a href="#l18.651"></a><span id="l18.651" class="difflineminus">-    {</span>
<a href="#l18.652"></a><span id="l18.652" class="difflineminus">-      compUtils = do_GetService(NS_MSGCOMPUTILS_CONTRACTID, &amp;rv);</span>
<a href="#l18.653"></a><span id="l18.653" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.654"></a><span id="l18.654" class="difflineminus">-      rv = compUtils-&gt;MimeMakeSeparator(&quot;mdn&quot;, getter_Copies(m_mimeSeparator));</span>
<a href="#l18.655"></a><span id="l18.655" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.656"></a><span id="l18.656" class="difflineminus">-    }</span>
<a href="#l18.657"></a><span id="l18.657" class="difflineminus">-    if (m_mimeSeparator.IsEmpty())</span>
<a href="#l18.658"></a><span id="l18.658" class="difflineminus">-      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l18.659"></a><span id="l18.659" class="difflineplus">+  if (m_mimeSeparator.IsEmpty()) {</span>
<a href="#l18.660"></a><span id="l18.660" class="difflineplus">+    compUtils = do_GetService(NS_MSGCOMPUTILS_CONTRACTID, &amp;rv);</span>
<a href="#l18.661"></a><span id="l18.661" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.662"></a><span id="l18.662" class="difflineplus">+    rv = compUtils-&gt;MimeMakeSeparator(&quot;mdn&quot;, getter_Copies(m_mimeSeparator));</span>
<a href="#l18.663"></a><span id="l18.663" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.664"></a><span id="l18.664" class="difflineplus">+  }</span>
<a href="#l18.665"></a><span id="l18.665" class="difflineplus">+  if (m_mimeSeparator.IsEmpty()) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l18.666"></a><span id="l18.666"> </span>
<a href="#l18.667"></a><span id="l18.667" class="difflineminus">-    tmpBuffer = (char *) PR_CALLOC(256);</span>
<a href="#l18.668"></a><span id="l18.668" class="difflineplus">+  tmpBuffer = (char *)PR_CALLOC(256);</span>
<a href="#l18.669"></a><span id="l18.669"> </span>
<a href="#l18.670"></a><span id="l18.670" class="difflineminus">-    if (!tmpBuffer)</span>
<a href="#l18.671"></a><span id="l18.671" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l18.672"></a><span id="l18.672" class="difflineplus">+  if (!tmpBuffer) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l18.673"></a><span id="l18.673"> </span>
<a href="#l18.674"></a><span id="l18.674" class="difflineminus">-    PRExplodedTime now;</span>
<a href="#l18.675"></a><span id="l18.675" class="difflineminus">-    PR_ExplodeTime(PR_Now(), PR_LocalTimeParameters, &amp;now);</span>
<a href="#l18.676"></a><span id="l18.676" class="difflineplus">+  PRExplodedTime now;</span>
<a href="#l18.677"></a><span id="l18.677" class="difflineplus">+  PR_ExplodeTime(PR_Now(), PR_LocalTimeParameters, &amp;now);</span>
<a href="#l18.678"></a><span id="l18.678"> </span>
<a href="#l18.679"></a><span id="l18.679" class="difflineminus">-    int gmtoffset = (now.tm_params.tp_gmt_offset + now.tm_params.tp_dst_offset)</span>
<a href="#l18.680"></a><span id="l18.680" class="difflineminus">-        / 60;</span>
<a href="#l18.681"></a><span id="l18.681" class="difflineplus">+  int gmtoffset =</span>
<a href="#l18.682"></a><span id="l18.682" class="difflineplus">+      (now.tm_params.tp_gmt_offset + now.tm_params.tp_dst_offset) / 60;</span>
<a href="#l18.683"></a><span id="l18.683">   /* Use PR_FormatTimeUSEnglish() to format the date in US English format,</span>
<a href="#l18.684"></a><span id="l18.684">      then figure out what our local GMT offset is, and append it (since</span>
<a href="#l18.685"></a><span id="l18.685">      PR_FormatTimeUSEnglish() can't do that.) Generate four digit years as</span>
<a href="#l18.686"></a><span id="l18.686">      per RFC 1123 (superseding RFC 822.)</span>
<a href="#l18.687"></a><span id="l18.687">   */</span>
<a href="#l18.688"></a><span id="l18.688" class="difflineminus">-    PR_FormatTimeUSEnglish(tmpBuffer, 100,</span>
<a href="#l18.689"></a><span id="l18.689" class="difflineminus">-                           &quot;Date: %a, %d %b %Y %H:%M:%S &quot;,</span>
<a href="#l18.690"></a><span id="l18.690" class="difflineminus">-                           &amp;now);</span>
<a href="#l18.691"></a><span id="l18.691" class="difflineplus">+  PR_FormatTimeUSEnglish(tmpBuffer, 100, &quot;Date: %a, %d %b %Y %H:%M:%S &quot;, &amp;now);</span>
<a href="#l18.692"></a><span id="l18.692"> </span>
<a href="#l18.693"></a><span id="l18.693" class="difflineminus">-    PR_snprintf(tmpBuffer + strlen(tmpBuffer), 100,</span>
<a href="#l18.694"></a><span id="l18.694" class="difflineminus">-                &quot;%c%02d%02d&quot; CRLF,</span>
<a href="#l18.695"></a><span id="l18.695" class="difflineminus">-                (gmtoffset &gt;= 0 ? '+' : '-'),</span>
<a href="#l18.696"></a><span id="l18.696" class="difflineminus">-                ((gmtoffset &gt;= 0 ? gmtoffset : -gmtoffset) / 60),</span>
<a href="#l18.697"></a><span id="l18.697" class="difflineminus">-                ((gmtoffset &gt;= 0 ? gmtoffset : -gmtoffset) % 60));</span>
<a href="#l18.698"></a><span id="l18.698" class="difflineplus">+  PR_snprintf(tmpBuffer + strlen(tmpBuffer), 100, &quot;%c%02d%02d&quot; CRLF,</span>
<a href="#l18.699"></a><span id="l18.699" class="difflineplus">+              (gmtoffset &gt;= 0 ? '+' : '-'),</span>
<a href="#l18.700"></a><span id="l18.700" class="difflineplus">+              ((gmtoffset &gt;= 0 ? gmtoffset : -gmtoffset) / 60),</span>
<a href="#l18.701"></a><span id="l18.701" class="difflineplus">+              ((gmtoffset &gt;= 0 ? gmtoffset : -gmtoffset) % 60));</span>
<a href="#l18.702"></a><span id="l18.702"> </span>
<a href="#l18.703"></a><span id="l18.703" class="difflineminus">-    rv = WriteString(tmpBuffer);</span>
<a href="#l18.704"></a><span id="l18.704" class="difflineminus">-    PR_Free(tmpBuffer);</span>
<a href="#l18.705"></a><span id="l18.705" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l18.706"></a><span id="l18.706" class="difflineminus">-        return rv;</span>
<a href="#l18.707"></a><span id="l18.707" class="difflineplus">+  rv = WriteString(tmpBuffer);</span>
<a href="#l18.708"></a><span id="l18.708" class="difflineplus">+  PR_Free(tmpBuffer);</span>
<a href="#l18.709"></a><span id="l18.709" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l18.710"></a><span id="l18.710" class="difflineplus">+</span>
<a href="#l18.711"></a><span id="l18.711" class="difflineplus">+  bool conformToStandard = false;</span>
<a href="#l18.712"></a><span id="l18.712" class="difflineplus">+  if (compUtils) compUtils-&gt;GetMsgMimeConformToStandard(&amp;conformToStandard);</span>
<a href="#l18.713"></a><span id="l18.713"> </span>
<a href="#l18.714"></a><span id="l18.714" class="difflineminus">-    bool conformToStandard = false;</span>
<a href="#l18.715"></a><span id="l18.715" class="difflineminus">-    if (compUtils)</span>
<a href="#l18.716"></a><span id="l18.716" class="difflineminus">-      compUtils-&gt;GetMsgMimeConformToStandard(&amp;conformToStandard);</span>
<a href="#l18.717"></a><span id="l18.717" class="difflineplus">+  nsString fullName;</span>
<a href="#l18.718"></a><span id="l18.718" class="difflineplus">+  m_identity-&gt;GetFullName(fullName);</span>
<a href="#l18.719"></a><span id="l18.719"> </span>
<a href="#l18.720"></a><span id="l18.720" class="difflineminus">-    nsString fullName;</span>
<a href="#l18.721"></a><span id="l18.721" class="difflineminus">-    m_identity-&gt;GetFullName(fullName);</span>
<a href="#l18.722"></a><span id="l18.722" class="difflineminus">-</span>
<a href="#l18.723"></a><span id="l18.723" class="difflineminus">-    nsCString fullAddress;</span>
<a href="#l18.724"></a><span id="l18.724" class="difflineminus">-    // convert fullName to UTF8 before passing it to MakeMimeAddress</span>
<a href="#l18.725"></a><span id="l18.725" class="difflineminus">-    MakeMimeAddress(NS_ConvertUTF16toUTF8(fullName), m_email, fullAddress);</span>
<a href="#l18.726"></a><span id="l18.726" class="difflineplus">+  nsCString fullAddress;</span>
<a href="#l18.727"></a><span id="l18.727" class="difflineplus">+  // convert fullName to UTF8 before passing it to MakeMimeAddress</span>
<a href="#l18.728"></a><span id="l18.728" class="difflineplus">+  MakeMimeAddress(NS_ConvertUTF16toUTF8(fullName), m_email, fullAddress);</span>
<a href="#l18.729"></a><span id="l18.729"> </span>
<a href="#l18.730"></a><span id="l18.730" class="difflineminus">-    convbuf = nsMsgI18NEncodeMimePartIIStr(fullAddress.get(),</span>
<a href="#l18.731"></a><span id="l18.731" class="difflineminus">-        true, m_charset.get(), 0, conformToStandard);</span>
<a href="#l18.732"></a><span id="l18.732" class="difflineplus">+  convbuf = nsMsgI18NEncodeMimePartIIStr(fullAddress.get(), true,</span>
<a href="#l18.733"></a><span id="l18.733" class="difflineplus">+                                         m_charset.get(), 0, conformToStandard);</span>
<a href="#l18.734"></a><span id="l18.734"> </span>
<a href="#l18.735"></a><span id="l18.735" class="difflineminus">-    parm = PR_smprintf(&quot;From: %s&quot; CRLF, convbuf ? convbuf : m_email.get());</span>
<a href="#l18.736"></a><span id="l18.736" class="difflineplus">+  parm = PR_smprintf(&quot;From: %s&quot; CRLF, convbuf ? convbuf : m_email.get());</span>
<a href="#l18.737"></a><span id="l18.737"> </span>
<a href="#l18.738"></a><span id="l18.738" class="difflineminus">-    rv = FormatStringFromName(&quot;MsgMdnMsgSentTo&quot;, NS_ConvertASCIItoUTF16(m_email).get(),</span>
<a href="#l18.739"></a><span id="l18.739" class="difflineminus">-                            firstPart1);</span>
<a href="#l18.740"></a><span id="l18.740" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l18.741"></a><span id="l18.741" class="difflineminus">-        return rv;</span>
<a href="#l18.742"></a><span id="l18.742" class="difflineplus">+  rv = FormatStringFromName(&quot;MsgMdnMsgSentTo&quot;,</span>
<a href="#l18.743"></a><span id="l18.743" class="difflineplus">+                            NS_ConvertASCIItoUTF16(m_email).get(), firstPart1);</span>
<a href="#l18.744"></a><span id="l18.744" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l18.745"></a><span id="l18.745"> </span>
<a href="#l18.746"></a><span id="l18.746" class="difflineminus">-    PUSH_N_FREE_STRING (parm);</span>
<a href="#l18.747"></a><span id="l18.747" class="difflineplus">+  PUSH_N_FREE_STRING(parm);</span>
<a href="#l18.748"></a><span id="l18.748"> </span>
<a href="#l18.749"></a><span id="l18.749" class="difflineminus">-    PR_Free(convbuf);</span>
<a href="#l18.750"></a><span id="l18.750" class="difflineplus">+  PR_Free(convbuf);</span>
<a href="#l18.751"></a><span id="l18.751"> </span>
<a href="#l18.752"></a><span id="l18.752" class="difflineminus">-    if (compUtils)</span>
<a href="#l18.753"></a><span id="l18.753" class="difflineminus">-    {</span>
<a href="#l18.754"></a><span id="l18.754" class="difflineminus">-      nsCString msgId;</span>
<a href="#l18.755"></a><span id="l18.755" class="difflineminus">-      rv = compUtils-&gt;MsgGenerateMessageId(m_identity, getter_Copies(msgId));</span>
<a href="#l18.756"></a><span id="l18.756" class="difflineminus">-      tmpBuffer = PR_smprintf(&quot;Message-ID: %s&quot; CRLF, msgId.get());</span>
<a href="#l18.757"></a><span id="l18.757" class="difflineminus">-      PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.758"></a><span id="l18.758" class="difflineminus">-    }</span>
<a href="#l18.759"></a><span id="l18.759" class="difflineplus">+  if (compUtils) {</span>
<a href="#l18.760"></a><span id="l18.760" class="difflineplus">+    nsCString msgId;</span>
<a href="#l18.761"></a><span id="l18.761" class="difflineplus">+    rv = compUtils-&gt;MsgGenerateMessageId(m_identity, getter_Copies(msgId));</span>
<a href="#l18.762"></a><span id="l18.762" class="difflineplus">+    tmpBuffer = PR_smprintf(&quot;Message-ID: %s&quot; CRLF, msgId.get());</span>
<a href="#l18.763"></a><span id="l18.763" class="difflineplus">+    PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.764"></a><span id="l18.764" class="difflineplus">+  }</span>
<a href="#l18.765"></a><span id="l18.765"> </span>
<a href="#l18.766"></a><span id="l18.766" class="difflineminus">-    nsString receipt_string;</span>
<a href="#l18.767"></a><span id="l18.767" class="difflineminus">-    switch (m_disposeType)</span>
<a href="#l18.768"></a><span id="l18.768" class="difflineminus">-    {</span>
<a href="#l18.769"></a><span id="l18.769" class="difflineplus">+  nsString receipt_string;</span>
<a href="#l18.770"></a><span id="l18.770" class="difflineplus">+  switch (m_disposeType) {</span>
<a href="#l18.771"></a><span id="l18.771">     case nsIMsgMdnGenerator::eDisplayed:</span>
<a href="#l18.772"></a><span id="l18.772" class="difflineminus">-        rv = GetStringFromName(</span>
<a href="#l18.773"></a><span id="l18.773" class="difflineminus">-            &quot;MdnDisplayedReceipt&quot;,</span>
<a href="#l18.774"></a><span id="l18.774" class="difflineminus">-            receipt_string);</span>
<a href="#l18.775"></a><span id="l18.775" class="difflineminus">-        break;</span>
<a href="#l18.776"></a><span id="l18.776" class="difflineplus">+      rv = GetStringFromName(&quot;MdnDisplayedReceipt&quot;, receipt_string);</span>
<a href="#l18.777"></a><span id="l18.777" class="difflineplus">+      break;</span>
<a href="#l18.778"></a><span id="l18.778">     case nsIMsgMdnGenerator::eDispatched:</span>
<a href="#l18.779"></a><span id="l18.779" class="difflineminus">-        rv = GetStringFromName(</span>
<a href="#l18.780"></a><span id="l18.780" class="difflineminus">-            &quot;MdnDispatchedReceipt&quot;,</span>
<a href="#l18.781"></a><span id="l18.781" class="difflineminus">-            receipt_string);</span>
<a href="#l18.782"></a><span id="l18.782" class="difflineminus">-        break;</span>
<a href="#l18.783"></a><span id="l18.783" class="difflineplus">+      rv = GetStringFromName(&quot;MdnDispatchedReceipt&quot;, receipt_string);</span>
<a href="#l18.784"></a><span id="l18.784" class="difflineplus">+      break;</span>
<a href="#l18.785"></a><span id="l18.785">     case nsIMsgMdnGenerator::eProcessed:</span>
<a href="#l18.786"></a><span id="l18.786" class="difflineminus">-        rv = GetStringFromName(</span>
<a href="#l18.787"></a><span id="l18.787" class="difflineminus">-            &quot;MdnProcessedReceipt&quot;,</span>
<a href="#l18.788"></a><span id="l18.788" class="difflineminus">-            receipt_string);</span>
<a href="#l18.789"></a><span id="l18.789" class="difflineminus">-        break;</span>
<a href="#l18.790"></a><span id="l18.790" class="difflineplus">+      rv = GetStringFromName(&quot;MdnProcessedReceipt&quot;, receipt_string);</span>
<a href="#l18.791"></a><span id="l18.791" class="difflineplus">+      break;</span>
<a href="#l18.792"></a><span id="l18.792">     case nsIMsgMdnGenerator::eDeleted:</span>
<a href="#l18.793"></a><span id="l18.793" class="difflineminus">-        rv = GetStringFromName(</span>
<a href="#l18.794"></a><span id="l18.794" class="difflineminus">-            &quot;MdnDeletedReceipt&quot;,</span>
<a href="#l18.795"></a><span id="l18.795" class="difflineminus">-            receipt_string);</span>
<a href="#l18.796"></a><span id="l18.796" class="difflineminus">-        break;</span>
<a href="#l18.797"></a><span id="l18.797" class="difflineplus">+      rv = GetStringFromName(&quot;MdnDeletedReceipt&quot;, receipt_string);</span>
<a href="#l18.798"></a><span id="l18.798" class="difflineplus">+      break;</span>
<a href="#l18.799"></a><span id="l18.799">     case nsIMsgMdnGenerator::eDenied:</span>
<a href="#l18.800"></a><span id="l18.800" class="difflineminus">-        rv = GetStringFromName(</span>
<a href="#l18.801"></a><span id="l18.801" class="difflineminus">-            &quot;MdnDeniedReceipt&quot;,</span>
<a href="#l18.802"></a><span id="l18.802" class="difflineminus">-            receipt_string);</span>
<a href="#l18.803"></a><span id="l18.803" class="difflineminus">-        break;</span>
<a href="#l18.804"></a><span id="l18.804" class="difflineplus">+      rv = GetStringFromName(&quot;MdnDeniedReceipt&quot;, receipt_string);</span>
<a href="#l18.805"></a><span id="l18.805" class="difflineplus">+      break;</span>
<a href="#l18.806"></a><span id="l18.806">     case nsIMsgMdnGenerator::eFailed:</span>
<a href="#l18.807"></a><span id="l18.807" class="difflineminus">-        rv = GetStringFromName(</span>
<a href="#l18.808"></a><span id="l18.808" class="difflineminus">-            &quot;MdnFailedReceipt&quot;,</span>
<a href="#l18.809"></a><span id="l18.809" class="difflineminus">-            receipt_string);</span>
<a href="#l18.810"></a><span id="l18.810" class="difflineminus">-        break;</span>
<a href="#l18.811"></a><span id="l18.811" class="difflineplus">+      rv = GetStringFromName(&quot;MdnFailedReceipt&quot;, receipt_string);</span>
<a href="#l18.812"></a><span id="l18.812" class="difflineplus">+      break;</span>
<a href="#l18.813"></a><span id="l18.813">     default:</span>
<a href="#l18.814"></a><span id="l18.814" class="difflineminus">-        rv = NS_ERROR_INVALID_ARG;</span>
<a href="#l18.815"></a><span id="l18.815" class="difflineminus">-        break;</span>
<a href="#l18.816"></a><span id="l18.816" class="difflineminus">-    }</span>
<a href="#l18.817"></a><span id="l18.817" class="difflineplus">+      rv = NS_ERROR_INVALID_ARG;</span>
<a href="#l18.818"></a><span id="l18.818" class="difflineplus">+      break;</span>
<a href="#l18.819"></a><span id="l18.819" class="difflineplus">+  }</span>
<a href="#l18.820"></a><span id="l18.820" class="difflineplus">+</span>
<a href="#l18.821"></a><span id="l18.821" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l18.822"></a><span id="l18.822"> </span>
<a href="#l18.823"></a><span id="l18.823" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l18.824"></a><span id="l18.824" class="difflineminus">-        return rv;</span>
<a href="#l18.825"></a><span id="l18.825" class="difflineplus">+  receipt_string.AppendLiteral(&quot; - &quot;);</span>
<a href="#l18.826"></a><span id="l18.826"> </span>
<a href="#l18.827"></a><span id="l18.827" class="difflineminus">-    receipt_string.AppendLiteral(&quot; - &quot;);</span>
<a href="#l18.828"></a><span id="l18.828" class="difflineminus">-</span>
<a href="#l18.829"></a><span id="l18.829" class="difflineminus">-    char * encodedReceiptString = nsMsgI18NEncodeMimePartIIStr(NS_ConvertUTF16toUTF8(receipt_string).get(), false,</span>
<a href="#l18.830"></a><span id="l18.830" class="difflineminus">-                                                               &quot;UTF-8&quot;, 0, conformToStandard);</span>
<a href="#l18.831"></a><span id="l18.831" class="difflineplus">+  char *encodedReceiptString =</span>
<a href="#l18.832"></a><span id="l18.832" class="difflineplus">+      nsMsgI18NEncodeMimePartIIStr(NS_ConvertUTF16toUTF8(receipt_string).get(),</span>
<a href="#l18.833"></a><span id="l18.833" class="difflineplus">+                                   false, &quot;UTF-8&quot;, 0, conformToStandard);</span>
<a href="#l18.834"></a><span id="l18.834"> </span>
<a href="#l18.835"></a><span id="l18.835" class="difflineminus">-    nsCString subject;</span>
<a href="#l18.836"></a><span id="l18.836" class="difflineminus">-    m_headers-&gt;ExtractHeader(HEADER_SUBJECT, false, subject);</span>
<a href="#l18.837"></a><span id="l18.837" class="difflineminus">-    convbuf = nsMsgI18NEncodeMimePartIIStr(subject.Length() ? subject.get() : &quot;[no subject]&quot;,</span>
<a href="#l18.838"></a><span id="l18.838" class="difflineminus">-                                           false, m_charset.get(), 0, conformToStandard);</span>
<a href="#l18.839"></a><span id="l18.839" class="difflineminus">-    tmpBuffer = PR_smprintf(&quot;Subject: %s%s&quot; CRLF,</span>
<a href="#l18.840"></a><span id="l18.840" class="difflineminus">-                             encodedReceiptString,</span>
<a href="#l18.841"></a><span id="l18.841" class="difflineminus">-                            (convbuf ? convbuf : (subject.Length() ? subject.get() :</span>
<a href="#l18.842"></a><span id="l18.842" class="difflineminus">-                              &quot;[no subject]&quot;)));</span>
<a href="#l18.843"></a><span id="l18.843" class="difflineplus">+  nsCString subject;</span>
<a href="#l18.844"></a><span id="l18.844" class="difflineplus">+  m_headers-&gt;ExtractHeader(HEADER_SUBJECT, false, subject);</span>
<a href="#l18.845"></a><span id="l18.845" class="difflineplus">+  convbuf = nsMsgI18NEncodeMimePartIIStr(</span>
<a href="#l18.846"></a><span id="l18.846" class="difflineplus">+      subject.Length() ? subject.get() : &quot;[no subject]&quot;, false, m_charset.get(),</span>
<a href="#l18.847"></a><span id="l18.847" class="difflineplus">+      0, conformToStandard);</span>
<a href="#l18.848"></a><span id="l18.848" class="difflineplus">+  tmpBuffer = PR_smprintf(</span>
<a href="#l18.849"></a><span id="l18.849" class="difflineplus">+      &quot;Subject: %s%s&quot; CRLF, encodedReceiptString,</span>
<a href="#l18.850"></a><span id="l18.850" class="difflineplus">+      (convbuf ? convbuf</span>
<a href="#l18.851"></a><span id="l18.851" class="difflineplus">+               : (subject.Length() ? subject.get() : &quot;[no subject]&quot;)));</span>
<a href="#l18.852"></a><span id="l18.852"> </span>
<a href="#l18.853"></a><span id="l18.853" class="difflineminus">-    PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.854"></a><span id="l18.854" class="difflineminus">-    PR_Free(convbuf);</span>
<a href="#l18.855"></a><span id="l18.855" class="difflineminus">-    PR_Free(encodedReceiptString);</span>
<a href="#l18.856"></a><span id="l18.856" class="difflineplus">+  PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.857"></a><span id="l18.857" class="difflineplus">+  PR_Free(convbuf);</span>
<a href="#l18.858"></a><span id="l18.858" class="difflineplus">+  PR_Free(encodedReceiptString);</span>
<a href="#l18.859"></a><span id="l18.859"> </span>
<a href="#l18.860"></a><span id="l18.860" class="difflineminus">-    convbuf = nsMsgI18NEncodeMimePartIIStr(m_dntRrt.get(), true, m_charset.get(), 0, conformToStandard);</span>
<a href="#l18.861"></a><span id="l18.861" class="difflineminus">-    tmpBuffer = PR_smprintf(&quot;To: %s&quot; CRLF, convbuf ? convbuf :</span>
<a href="#l18.862"></a><span id="l18.862" class="difflineminus">-                            m_dntRrt.get());</span>
<a href="#l18.863"></a><span id="l18.863" class="difflineminus">-    PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.864"></a><span id="l18.864" class="difflineplus">+  convbuf = nsMsgI18NEncodeMimePartIIStr(m_dntRrt.get(), true, m_charset.get(),</span>
<a href="#l18.865"></a><span id="l18.865" class="difflineplus">+                                         0, conformToStandard);</span>
<a href="#l18.866"></a><span id="l18.866" class="difflineplus">+  tmpBuffer = PR_smprintf(&quot;To: %s&quot; CRLF, convbuf ? convbuf : m_dntRrt.get());</span>
<a href="#l18.867"></a><span id="l18.867" class="difflineplus">+  PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.868"></a><span id="l18.868"> </span>
<a href="#l18.869"></a><span id="l18.869" class="difflineminus">-    PR_Free(convbuf);</span>
<a href="#l18.870"></a><span id="l18.870" class="difflineplus">+  PR_Free(convbuf);</span>
<a href="#l18.871"></a><span id="l18.871"> </span>
<a href="#l18.872"></a><span id="l18.872">   // *** This is not in the spec. I am adding this so we could do</span>
<a href="#l18.873"></a><span id="l18.873">   // threading</span>
<a href="#l18.874"></a><span id="l18.874" class="difflineminus">-    m_headers-&gt;ExtractHeader(HEADER_MESSAGE_ID, false, m_messageId);</span>
<a href="#l18.875"></a><span id="l18.875" class="difflineplus">+  m_headers-&gt;ExtractHeader(HEADER_MESSAGE_ID, false, m_messageId);</span>
<a href="#l18.876"></a><span id="l18.876"> </span>
<a href="#l18.877"></a><span id="l18.877" class="difflineminus">-    if (!m_messageId.IsEmpty())</span>
<a href="#l18.878"></a><span id="l18.878" class="difflineminus">-    {</span>
<a href="#l18.879"></a><span id="l18.879" class="difflineminus">-      if (*m_messageId.get() == '&lt;')</span>
<a href="#l18.880"></a><span id="l18.880" class="difflineminus">-          tmpBuffer = PR_smprintf(&quot;References: %s&quot; CRLF, m_messageId.get());</span>
<a href="#l18.881"></a><span id="l18.881" class="difflineminus">-      else</span>
<a href="#l18.882"></a><span id="l18.882" class="difflineminus">-          tmpBuffer = PR_smprintf(&quot;References: &lt;%s&gt;&quot; CRLF, m_messageId.get());</span>
<a href="#l18.883"></a><span id="l18.883" class="difflineminus">-      PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.884"></a><span id="l18.884" class="difflineminus">-    }</span>
<a href="#l18.885"></a><span id="l18.885" class="difflineminus">-    tmpBuffer = PR_smprintf(&quot;%s&quot; CRLF, &quot;MIME-Version: 1.0&quot;);</span>
<a href="#l18.886"></a><span id="l18.886" class="difflineplus">+  if (!m_messageId.IsEmpty()) {</span>
<a href="#l18.887"></a><span id="l18.887" class="difflineplus">+    if (*m_messageId.get() == '&lt;')</span>
<a href="#l18.888"></a><span id="l18.888" class="difflineplus">+      tmpBuffer = PR_smprintf(&quot;References: %s&quot; CRLF, m_messageId.get());</span>
<a href="#l18.889"></a><span id="l18.889" class="difflineplus">+    else</span>
<a href="#l18.890"></a><span id="l18.890" class="difflineplus">+      tmpBuffer = PR_smprintf(&quot;References: &lt;%s&gt;&quot; CRLF, m_messageId.get());</span>
<a href="#l18.891"></a><span id="l18.891">     PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.892"></a><span id="l18.892" class="difflineplus">+  }</span>
<a href="#l18.893"></a><span id="l18.893" class="difflineplus">+  tmpBuffer = PR_smprintf(&quot;%s&quot; CRLF, &quot;MIME-Version: 1.0&quot;);</span>
<a href="#l18.894"></a><span id="l18.894" class="difflineplus">+  PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.895"></a><span id="l18.895"> </span>
<a href="#l18.896"></a><span id="l18.896" class="difflineminus">-    tmpBuffer = PR_smprintf(&quot;Content-Type: multipart/report; \</span>
<a href="#l18.897"></a><span id="l18.897" class="difflineplus">+  tmpBuffer = PR_smprintf(</span>
<a href="#l18.898"></a><span id="l18.898" class="difflineplus">+      &quot;Content-Type: multipart/report; \</span>
<a href="#l18.899"></a><span id="l18.899"> report-type=disposition-notification;\r\n\tboundary=\&quot;%s\&quot;&quot; CRLF CRLF,</span>
<a href="#l18.900"></a><span id="l18.900" class="difflineminus">-                            m_mimeSeparator.get());</span>
<a href="#l18.901"></a><span id="l18.901" class="difflineminus">-    PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.902"></a><span id="l18.902" class="difflineminus">-</span>
<a href="#l18.903"></a><span id="l18.903" class="difflineminus">-    tmpBuffer = PR_smprintf(&quot;--%s&quot; CRLF, m_mimeSeparator.get());</span>
<a href="#l18.904"></a><span id="l18.904" class="difflineminus">-    PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.905"></a><span id="l18.905" class="difflineplus">+      m_mimeSeparator.get());</span>
<a href="#l18.906"></a><span id="l18.906" class="difflineplus">+  PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.907"></a><span id="l18.907"> </span>
<a href="#l18.908"></a><span id="l18.908" class="difflineminus">-    tmpBuffer = PR_smprintf(&quot;Content-Type: text/plain; charset=UTF-8&quot; CRLF);</span>
<a href="#l18.909"></a><span id="l18.909" class="difflineminus">-    PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.910"></a><span id="l18.910" class="difflineplus">+  tmpBuffer = PR_smprintf(&quot;--%s&quot; CRLF, m_mimeSeparator.get());</span>
<a href="#l18.911"></a><span id="l18.911" class="difflineplus">+  PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.912"></a><span id="l18.912"> </span>
<a href="#l18.913"></a><span id="l18.913" class="difflineminus">-    tmpBuffer = PR_smprintf(&quot;Content-Transfer-Encoding: %s&quot; CRLF CRLF,</span>
<a href="#l18.914"></a><span id="l18.914" class="difflineminus">-                            ENCODING_8BIT);</span>
<a href="#l18.915"></a><span id="l18.915" class="difflineminus">-    PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.916"></a><span id="l18.916" class="difflineplus">+  tmpBuffer = PR_smprintf(&quot;Content-Type: text/plain; charset=UTF-8&quot; CRLF);</span>
<a href="#l18.917"></a><span id="l18.917" class="difflineplus">+  PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.918"></a><span id="l18.918" class="difflineplus">+</span>
<a href="#l18.919"></a><span id="l18.919" class="difflineplus">+  tmpBuffer =</span>
<a href="#l18.920"></a><span id="l18.920" class="difflineplus">+      PR_smprintf(&quot;Content-Transfer-Encoding: %s&quot; CRLF CRLF, ENCODING_8BIT);</span>
<a href="#l18.921"></a><span id="l18.921" class="difflineplus">+  PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.922"></a><span id="l18.922"> </span>
<a href="#l18.923"></a><span id="l18.923" class="difflineminus">-    if (!firstPart1.IsEmpty())</span>
<a href="#l18.924"></a><span id="l18.924" class="difflineminus">-    {</span>
<a href="#l18.925"></a><span id="l18.925" class="difflineminus">-        tmpBuffer = PR_smprintf(&quot;%s&quot; CRLF CRLF, NS_ConvertUTF16toUTF8(firstPart1).get());</span>
<a href="#l18.926"></a><span id="l18.926" class="difflineminus">-        PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.927"></a><span id="l18.927" class="difflineminus">-    }</span>
<a href="#l18.928"></a><span id="l18.928" class="difflineplus">+  if (!firstPart1.IsEmpty()) {</span>
<a href="#l18.929"></a><span id="l18.929" class="difflineplus">+    tmpBuffer =</span>
<a href="#l18.930"></a><span id="l18.930" class="difflineplus">+        PR_smprintf(&quot;%s&quot; CRLF CRLF, NS_ConvertUTF16toUTF8(firstPart1).get());</span>
<a href="#l18.931"></a><span id="l18.931" class="difflineplus">+    PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.932"></a><span id="l18.932" class="difflineplus">+  }</span>
<a href="#l18.933"></a><span id="l18.933"> </span>
<a href="#l18.934"></a><span id="l18.934" class="difflineminus">-    switch (m_disposeType)</span>
<a href="#l18.935"></a><span id="l18.935" class="difflineminus">-    {</span>
<a href="#l18.936"></a><span id="l18.936" class="difflineplus">+  switch (m_disposeType) {</span>
<a href="#l18.937"></a><span id="l18.937">     case nsIMsgMdnGenerator::eDisplayed:</span>
<a href="#l18.938"></a><span id="l18.938" class="difflineminus">-        rv = GetStringFromName(</span>
<a href="#l18.939"></a><span id="l18.939" class="difflineminus">-            &quot;MsgMdnDisplayed&quot;,</span>
<a href="#l18.940"></a><span id="l18.940" class="difflineminus">-            firstPart2);</span>
<a href="#l18.941"></a><span id="l18.941" class="difflineminus">-        break;</span>
<a href="#l18.942"></a><span id="l18.942" class="difflineplus">+      rv = GetStringFromName(&quot;MsgMdnDisplayed&quot;, firstPart2);</span>
<a href="#l18.943"></a><span id="l18.943" class="difflineplus">+      break;</span>
<a href="#l18.944"></a><span id="l18.944">     case nsIMsgMdnGenerator::eDispatched:</span>
<a href="#l18.945"></a><span id="l18.945" class="difflineminus">-        rv = GetStringFromName(</span>
<a href="#l18.946"></a><span id="l18.946" class="difflineminus">-            &quot;MsgMdnDispatched&quot;,</span>
<a href="#l18.947"></a><span id="l18.947" class="difflineminus">-            firstPart2);</span>
<a href="#l18.948"></a><span id="l18.948" class="difflineminus">-        break;</span>
<a href="#l18.949"></a><span id="l18.949" class="difflineplus">+      rv = GetStringFromName(&quot;MsgMdnDispatched&quot;, firstPart2);</span>
<a href="#l18.950"></a><span id="l18.950" class="difflineplus">+      break;</span>
<a href="#l18.951"></a><span id="l18.951">     case nsIMsgMdnGenerator::eProcessed:</span>
<a href="#l18.952"></a><span id="l18.952" class="difflineminus">-        rv = GetStringFromName(</span>
<a href="#l18.953"></a><span id="l18.953" class="difflineminus">-            &quot;MsgMdnProcessed&quot;,</span>
<a href="#l18.954"></a><span id="l18.954" class="difflineminus">-            firstPart2);</span>
<a href="#l18.955"></a><span id="l18.955" class="difflineminus">-        break;</span>
<a href="#l18.956"></a><span id="l18.956" class="difflineplus">+      rv = GetStringFromName(&quot;MsgMdnProcessed&quot;, firstPart2);</span>
<a href="#l18.957"></a><span id="l18.957" class="difflineplus">+      break;</span>
<a href="#l18.958"></a><span id="l18.958">     case nsIMsgMdnGenerator::eDeleted:</span>
<a href="#l18.959"></a><span id="l18.959" class="difflineminus">-        rv = GetStringFromName(</span>
<a href="#l18.960"></a><span id="l18.960" class="difflineminus">-            &quot;MsgMdnDeleted&quot;,</span>
<a href="#l18.961"></a><span id="l18.961" class="difflineminus">-            firstPart2);</span>
<a href="#l18.962"></a><span id="l18.962" class="difflineminus">-        break;</span>
<a href="#l18.963"></a><span id="l18.963" class="difflineplus">+      rv = GetStringFromName(&quot;MsgMdnDeleted&quot;, firstPart2);</span>
<a href="#l18.964"></a><span id="l18.964" class="difflineplus">+      break;</span>
<a href="#l18.965"></a><span id="l18.965">     case nsIMsgMdnGenerator::eDenied:</span>
<a href="#l18.966"></a><span id="l18.966" class="difflineminus">-        rv = GetStringFromName(</span>
<a href="#l18.967"></a><span id="l18.967" class="difflineminus">-            &quot;MsgMdnDenied&quot;,</span>
<a href="#l18.968"></a><span id="l18.968" class="difflineminus">-            firstPart2);</span>
<a href="#l18.969"></a><span id="l18.969" class="difflineminus">-        break;</span>
<a href="#l18.970"></a><span id="l18.970" class="difflineplus">+      rv = GetStringFromName(&quot;MsgMdnDenied&quot;, firstPart2);</span>
<a href="#l18.971"></a><span id="l18.971" class="difflineplus">+      break;</span>
<a href="#l18.972"></a><span id="l18.972">     case nsIMsgMdnGenerator::eFailed:</span>
<a href="#l18.973"></a><span id="l18.973" class="difflineminus">-        rv = GetStringFromName(</span>
<a href="#l18.974"></a><span id="l18.974" class="difflineminus">-            &quot;MsgMdnFailed&quot;,</span>
<a href="#l18.975"></a><span id="l18.975" class="difflineminus">-            firstPart2);</span>
<a href="#l18.976"></a><span id="l18.976" class="difflineminus">-        break;</span>
<a href="#l18.977"></a><span id="l18.977" class="difflineplus">+      rv = GetStringFromName(&quot;MsgMdnFailed&quot;, firstPart2);</span>
<a href="#l18.978"></a><span id="l18.978" class="difflineplus">+      break;</span>
<a href="#l18.979"></a><span id="l18.979">     default:</span>
<a href="#l18.980"></a><span id="l18.980" class="difflineminus">-        rv = NS_ERROR_INVALID_ARG;</span>
<a href="#l18.981"></a><span id="l18.981" class="difflineminus">-        break;</span>
<a href="#l18.982"></a><span id="l18.982" class="difflineminus">-    }</span>
<a href="#l18.983"></a><span id="l18.983" class="difflineplus">+      rv = NS_ERROR_INVALID_ARG;</span>
<a href="#l18.984"></a><span id="l18.984" class="difflineplus">+      break;</span>
<a href="#l18.985"></a><span id="l18.985" class="difflineplus">+  }</span>
<a href="#l18.986"></a><span id="l18.986"> </span>
<a href="#l18.987"></a><span id="l18.987" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l18.988"></a><span id="l18.988" class="difflineminus">-        return rv;</span>
<a href="#l18.989"></a><span id="l18.989" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l18.990"></a><span id="l18.990"> </span>
<a href="#l18.991"></a><span id="l18.991" class="difflineminus">-    if (!firstPart2.IsEmpty())</span>
<a href="#l18.992"></a><span id="l18.992" class="difflineminus">-    {</span>
<a href="#l18.993"></a><span id="l18.993" class="difflineminus">-        tmpBuffer =</span>
<a href="#l18.994"></a><span id="l18.994" class="difflineminus">-            PR_smprintf(&quot;%s&quot; CRLF CRLF,</span>
<a href="#l18.995"></a><span id="l18.995" class="difflineminus">-                        NS_ConvertUTF16toUTF8(firstPart2).get());</span>
<a href="#l18.996"></a><span id="l18.996" class="difflineminus">-        PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.997"></a><span id="l18.997" class="difflineminus">-    }</span>
<a href="#l18.998"></a><span id="l18.998" class="difflineplus">+  if (!firstPart2.IsEmpty()) {</span>
<a href="#l18.999"></a><span id="l18.999" class="difflineplus">+    tmpBuffer =</span>
<a href="#l18.1000"></a><span id="l18.1000" class="difflineplus">+        PR_smprintf(&quot;%s&quot; CRLF CRLF, NS_ConvertUTF16toUTF8(firstPart2).get());</span>
<a href="#l18.1001"></a><span id="l18.1001" class="difflineplus">+    PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.1002"></a><span id="l18.1002" class="difflineplus">+  }</span>
<a href="#l18.1003"></a><span id="l18.1003"> </span>
<a href="#l18.1004"></a><span id="l18.1004" class="difflineminus">-    return rv;</span>
<a href="#l18.1005"></a><span id="l18.1005" class="difflineplus">+  return rv;</span>
<a href="#l18.1006"></a><span id="l18.1006"> }</span>
<a href="#l18.1007"></a><span id="l18.1007"> </span>
<a href="#l18.1008"></a><span id="l18.1008" class="difflineminus">-nsresult nsMsgMdnGenerator::CreateSecondPart()</span>
<a href="#l18.1009"></a><span id="l18.1009" class="difflineminus">-{</span>
<a href="#l18.1010"></a><span id="l18.1010" class="difflineminus">-    DEBUG_MDN(&quot;nsMsgMdnGenerator::CreateSecondPart&quot;);</span>
<a href="#l18.1011"></a><span id="l18.1011" class="difflineminus">-    char *tmpBuffer = nullptr;</span>
<a href="#l18.1012"></a><span id="l18.1012" class="difflineminus">-    char *convbuf = nullptr;</span>
<a href="#l18.1013"></a><span id="l18.1013" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l18.1014"></a><span id="l18.1014" class="difflineminus">-    nsCOMPtr &lt;nsIMsgCompUtils&gt; compUtils;</span>
<a href="#l18.1015"></a><span id="l18.1015" class="difflineminus">-    bool conformToStandard = false;</span>
<a href="#l18.1016"></a><span id="l18.1016" class="difflineplus">+nsresult nsMsgMdnGenerator::CreateSecondPart() {</span>
<a href="#l18.1017"></a><span id="l18.1017" class="difflineplus">+  DEBUG_MDN(&quot;nsMsgMdnGenerator::CreateSecondPart&quot;);</span>
<a href="#l18.1018"></a><span id="l18.1018" class="difflineplus">+  char *tmpBuffer = nullptr;</span>
<a href="#l18.1019"></a><span id="l18.1019" class="difflineplus">+  char *convbuf = nullptr;</span>
<a href="#l18.1020"></a><span id="l18.1020" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l18.1021"></a><span id="l18.1021" class="difflineplus">+  nsCOMPtr&lt;nsIMsgCompUtils&gt; compUtils;</span>
<a href="#l18.1022"></a><span id="l18.1022" class="difflineplus">+  bool conformToStandard = false;</span>
<a href="#l18.1023"></a><span id="l18.1023"> </span>
<a href="#l18.1024"></a><span id="l18.1024" class="difflineminus">-    tmpBuffer = PR_smprintf(&quot;--%s&quot; CRLF, m_mimeSeparator.get());</span>
<a href="#l18.1025"></a><span id="l18.1025" class="difflineminus">-    PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.1026"></a><span id="l18.1026" class="difflineplus">+  tmpBuffer = PR_smprintf(&quot;--%s&quot; CRLF, m_mimeSeparator.get());</span>
<a href="#l18.1027"></a><span id="l18.1027" class="difflineplus">+  PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.1028"></a><span id="l18.1028"> </span>
<a href="#l18.1029"></a><span id="l18.1029" class="difflineminus">-    tmpBuffer = PR_smprintf(&quot;%s&quot; CRLF, &quot;Content-Type: message/disposition-notification; name=\042MDNPart2.txt\042&quot;);</span>
<a href="#l18.1030"></a><span id="l18.1030" class="difflineminus">-    PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.1031"></a><span id="l18.1031" class="difflineplus">+  tmpBuffer = PR_smprintf(&quot;%s&quot; CRLF,</span>
<a href="#l18.1032"></a><span id="l18.1032" class="difflineplus">+                          &quot;Content-Type: message/disposition-notification; &quot;</span>
<a href="#l18.1033"></a><span id="l18.1033" class="difflineplus">+                          &quot;name=\042MDNPart2.txt\042&quot;);</span>
<a href="#l18.1034"></a><span id="l18.1034" class="difflineplus">+  PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.1035"></a><span id="l18.1035"> </span>
<a href="#l18.1036"></a><span id="l18.1036" class="difflineminus">-    tmpBuffer = PR_smprintf(&quot;%s&quot; CRLF, &quot;Content-Disposition: inline&quot;);</span>
<a href="#l18.1037"></a><span id="l18.1037" class="difflineminus">-    PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.1038"></a><span id="l18.1038" class="difflineplus">+  tmpBuffer = PR_smprintf(&quot;%s&quot; CRLF, &quot;Content-Disposition: inline&quot;);</span>
<a href="#l18.1039"></a><span id="l18.1039" class="difflineplus">+  PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.1040"></a><span id="l18.1040"> </span>
<a href="#l18.1041"></a><span id="l18.1041" class="difflineminus">-    tmpBuffer = PR_smprintf(&quot;Content-Transfer-Encoding: %s&quot; CRLF CRLF,</span>
<a href="#l18.1042"></a><span id="l18.1042" class="difflineminus">-                            ENCODING_7BIT);</span>
<a href="#l18.1043"></a><span id="l18.1043" class="difflineminus">-    PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.1044"></a><span id="l18.1044" class="difflineplus">+  tmpBuffer =</span>
<a href="#l18.1045"></a><span id="l18.1045" class="difflineplus">+      PR_smprintf(&quot;Content-Transfer-Encoding: %s&quot; CRLF CRLF, ENCODING_7BIT);</span>
<a href="#l18.1046"></a><span id="l18.1046" class="difflineplus">+  PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.1047"></a><span id="l18.1047"> </span>
<a href="#l18.1048"></a><span id="l18.1048" class="difflineminus">-    nsCOMPtr&lt;nsIHttpProtocolHandler&gt; pHTTPHandler =</span>
<a href="#l18.1049"></a><span id="l18.1049" class="difflineminus">-        do_GetService(NS_NETWORK_PROTOCOL_CONTRACTID_PREFIX &quot;http&quot;, &amp;rv);</span>
<a href="#l18.1050"></a><span id="l18.1050" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; pHTTPHandler)</span>
<a href="#l18.1051"></a><span id="l18.1051" class="difflineminus">-    {</span>
<a href="#l18.1052"></a><span id="l18.1052" class="difflineminus">-      nsAutoCString userAgentString;</span>
<a href="#l18.1053"></a><span id="l18.1053" class="difflineminus">-      // Ignore error since we're testing the return value.</span>
<a href="#l18.1054"></a><span id="l18.1054" class="difflineminus">-      mozilla::Unused &lt;&lt; pHTTPHandler-&gt;GetUserAgent(userAgentString);</span>
<a href="#l18.1055"></a><span id="l18.1055" class="difflineplus">+  nsCOMPtr&lt;nsIHttpProtocolHandler&gt; pHTTPHandler =</span>
<a href="#l18.1056"></a><span id="l18.1056" class="difflineplus">+      do_GetService(NS_NETWORK_PROTOCOL_CONTRACTID_PREFIX &quot;http&quot;, &amp;rv);</span>
<a href="#l18.1057"></a><span id="l18.1057" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; pHTTPHandler) {</span>
<a href="#l18.1058"></a><span id="l18.1058" class="difflineplus">+    nsAutoCString userAgentString;</span>
<a href="#l18.1059"></a><span id="l18.1059" class="difflineplus">+    // Ignore error since we're testing the return value.</span>
<a href="#l18.1060"></a><span id="l18.1060" class="difflineplus">+    mozilla::Unused &lt;&lt; pHTTPHandler-&gt;GetUserAgent(userAgentString);</span>
<a href="#l18.1061"></a><span id="l18.1061"> </span>
<a href="#l18.1062"></a><span id="l18.1062" class="difflineminus">-      if (!userAgentString.IsEmpty())</span>
<a href="#l18.1063"></a><span id="l18.1063" class="difflineminus">-      {</span>
<a href="#l18.1064"></a><span id="l18.1064" class="difflineminus">-        // Prepend the product name with the dns name according to RFC 3798.</span>
<a href="#l18.1065"></a><span id="l18.1065" class="difflineminus">-        char hostName[256];</span>
<a href="#l18.1066"></a><span id="l18.1066" class="difflineminus">-        PR_GetSystemInfo(PR_SI_HOSTNAME_UNTRUNCATED, hostName, sizeof hostName);</span>
<a href="#l18.1067"></a><span id="l18.1067" class="difflineminus">-        if ((hostName[0] != '\0') &amp;&amp; (strchr(hostName, '.') != NULL))</span>
<a href="#l18.1068"></a><span id="l18.1068" class="difflineminus">-        {</span>
<a href="#l18.1069"></a><span id="l18.1069" class="difflineminus">-          userAgentString.InsertLiteral(&quot;; &quot;, 0);</span>
<a href="#l18.1070"></a><span id="l18.1070" class="difflineminus">-          userAgentString.Insert(nsDependentCString(hostName), 0);</span>
<a href="#l18.1071"></a><span id="l18.1071" class="difflineminus">-        }</span>
<a href="#l18.1072"></a><span id="l18.1072" class="difflineplus">+    if (!userAgentString.IsEmpty()) {</span>
<a href="#l18.1073"></a><span id="l18.1073" class="difflineplus">+      // Prepend the product name with the dns name according to RFC 3798.</span>
<a href="#l18.1074"></a><span id="l18.1074" class="difflineplus">+      char hostName[256];</span>
<a href="#l18.1075"></a><span id="l18.1075" class="difflineplus">+      PR_GetSystemInfo(PR_SI_HOSTNAME_UNTRUNCATED, hostName, sizeof hostName);</span>
<a href="#l18.1076"></a><span id="l18.1076" class="difflineplus">+      if ((hostName[0] != '\0') &amp;&amp; (strchr(hostName, '.') != NULL)) {</span>
<a href="#l18.1077"></a><span id="l18.1077" class="difflineplus">+        userAgentString.InsertLiteral(&quot;; &quot;, 0);</span>
<a href="#l18.1078"></a><span id="l18.1078" class="difflineplus">+        userAgentString.Insert(nsDependentCString(hostName), 0);</span>
<a href="#l18.1079"></a><span id="l18.1079" class="difflineplus">+      }</span>
<a href="#l18.1080"></a><span id="l18.1080"> </span>
<a href="#l18.1081"></a><span id="l18.1081" class="difflineminus">-        tmpBuffer = PR_smprintf(&quot;Reporting-UA: %s&quot; CRLF,</span>
<a href="#l18.1082"></a><span id="l18.1082" class="difflineminus">-                                userAgentString.get());</span>
<a href="#l18.1083"></a><span id="l18.1083" class="difflineminus">-        PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.1084"></a><span id="l18.1084" class="difflineminus">-      }</span>
<a href="#l18.1085"></a><span id="l18.1085" class="difflineplus">+      tmpBuffer = PR_smprintf(&quot;Reporting-UA: %s&quot; CRLF, userAgentString.get());</span>
<a href="#l18.1086"></a><span id="l18.1086" class="difflineplus">+      PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.1087"></a><span id="l18.1087">     }</span>
<a href="#l18.1088"></a><span id="l18.1088" class="difflineplus">+  }</span>
<a href="#l18.1089"></a><span id="l18.1089"> </span>
<a href="#l18.1090"></a><span id="l18.1090" class="difflineminus">-    nsCString originalRecipient;</span>
<a href="#l18.1091"></a><span id="l18.1091" class="difflineminus">-    m_headers-&gt;ExtractHeader(HEADER_ORIGINAL_RECIPIENT, false,</span>
<a href="#l18.1092"></a><span id="l18.1092" class="difflineminus">-                             originalRecipient);</span>
<a href="#l18.1093"></a><span id="l18.1093" class="difflineplus">+  nsCString originalRecipient;</span>
<a href="#l18.1094"></a><span id="l18.1094" class="difflineplus">+  m_headers-&gt;ExtractHeader(HEADER_ORIGINAL_RECIPIENT, false, originalRecipient);</span>
<a href="#l18.1095"></a><span id="l18.1095"> </span>
<a href="#l18.1096"></a><span id="l18.1096" class="difflineminus">-    if (!originalRecipient.IsEmpty())</span>
<a href="#l18.1097"></a><span id="l18.1097" class="difflineminus">-    {</span>
<a href="#l18.1098"></a><span id="l18.1098" class="difflineminus">-        tmpBuffer = PR_smprintf(&quot;Original-Recipient: %s&quot; CRLF,</span>
<a href="#l18.1099"></a><span id="l18.1099" class="difflineminus">-                                originalRecipient.get());</span>
<a href="#l18.1100"></a><span id="l18.1100" class="difflineminus">-        PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.1101"></a><span id="l18.1101" class="difflineminus">-    }</span>
<a href="#l18.1102"></a><span id="l18.1102" class="difflineplus">+  if (!originalRecipient.IsEmpty()) {</span>
<a href="#l18.1103"></a><span id="l18.1103" class="difflineplus">+    tmpBuffer =</span>
<a href="#l18.1104"></a><span id="l18.1104" class="difflineplus">+        PR_smprintf(&quot;Original-Recipient: %s&quot; CRLF, originalRecipient.get());</span>
<a href="#l18.1105"></a><span id="l18.1105" class="difflineplus">+    PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.1106"></a><span id="l18.1106" class="difflineplus">+  }</span>
<a href="#l18.1107"></a><span id="l18.1107"> </span>
<a href="#l18.1108"></a><span id="l18.1108" class="difflineminus">-    compUtils = do_GetService(NS_MSGCOMPUTILS_CONTRACTID, &amp;rv);</span>
<a href="#l18.1109"></a><span id="l18.1109" class="difflineminus">-    if (compUtils)</span>
<a href="#l18.1110"></a><span id="l18.1110" class="difflineminus">-      compUtils-&gt;GetMsgMimeConformToStandard(&amp;conformToStandard);</span>
<a href="#l18.1111"></a><span id="l18.1111" class="difflineplus">+  compUtils = do_GetService(NS_MSGCOMPUTILS_CONTRACTID, &amp;rv);</span>
<a href="#l18.1112"></a><span id="l18.1112" class="difflineplus">+  if (compUtils) compUtils-&gt;GetMsgMimeConformToStandard(&amp;conformToStandard);</span>
<a href="#l18.1113"></a><span id="l18.1113"> </span>
<a href="#l18.1114"></a><span id="l18.1114" class="difflineminus">-    convbuf = nsMsgI18NEncodeMimePartIIStr(</span>
<a href="#l18.1115"></a><span id="l18.1115" class="difflineminus">-        m_email.get(), true, m_charset.get(), 0,</span>
<a href="#l18.1116"></a><span id="l18.1116" class="difflineminus">-        conformToStandard);</span>
<a href="#l18.1117"></a><span id="l18.1117" class="difflineminus">-    tmpBuffer = PR_smprintf(&quot;Final-Recipient: rfc822;%s&quot; CRLF, convbuf ?</span>
<a href="#l18.1118"></a><span id="l18.1118" class="difflineminus">-                            convbuf : m_email.get());</span>
<a href="#l18.1119"></a><span id="l18.1119" class="difflineminus">-    PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.1120"></a><span id="l18.1120" class="difflineplus">+  convbuf = nsMsgI18NEncodeMimePartIIStr(m_email.get(), true, m_charset.get(),</span>
<a href="#l18.1121"></a><span id="l18.1121" class="difflineplus">+                                         0, conformToStandard);</span>
<a href="#l18.1122"></a><span id="l18.1122" class="difflineplus">+  tmpBuffer = PR_smprintf(&quot;Final-Recipient: rfc822;%s&quot; CRLF,</span>
<a href="#l18.1123"></a><span id="l18.1123" class="difflineplus">+                          convbuf ? convbuf : m_email.get());</span>
<a href="#l18.1124"></a><span id="l18.1124" class="difflineplus">+  PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.1125"></a><span id="l18.1125"> </span>
<a href="#l18.1126"></a><span id="l18.1126" class="difflineminus">-    PR_Free (convbuf);</span>
<a href="#l18.1127"></a><span id="l18.1127" class="difflineplus">+  PR_Free(convbuf);</span>
<a href="#l18.1128"></a><span id="l18.1128"> </span>
<a href="#l18.1129"></a><span id="l18.1129" class="difflineminus">-    if (*m_messageId.get() == '&lt;')</span>
<a href="#l18.1130"></a><span id="l18.1130" class="difflineminus">-        tmpBuffer = PR_smprintf(&quot;Original-Message-ID: %s&quot; CRLF, m_messageId.get());</span>
<a href="#l18.1131"></a><span id="l18.1131" class="difflineminus">-    else</span>
<a href="#l18.1132"></a><span id="l18.1132" class="difflineminus">-        tmpBuffer = PR_smprintf(&quot;Original-Message-ID: &lt;%s&gt;&quot; CRLF, m_messageId.get());</span>
<a href="#l18.1133"></a><span id="l18.1133" class="difflineminus">-    PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.1134"></a><span id="l18.1134" class="difflineplus">+  if (*m_messageId.get() == '&lt;')</span>
<a href="#l18.1135"></a><span id="l18.1135" class="difflineplus">+    tmpBuffer = PR_smprintf(&quot;Original-Message-ID: %s&quot; CRLF, m_messageId.get());</span>
<a href="#l18.1136"></a><span id="l18.1136" class="difflineplus">+  else</span>
<a href="#l18.1137"></a><span id="l18.1137" class="difflineplus">+    tmpBuffer =</span>
<a href="#l18.1138"></a><span id="l18.1138" class="difflineplus">+        PR_smprintf(&quot;Original-Message-ID: &lt;%s&gt;&quot; CRLF, m_messageId.get());</span>
<a href="#l18.1139"></a><span id="l18.1139" class="difflineplus">+  PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.1140"></a><span id="l18.1140"> </span>
<a href="#l18.1141"></a><span id="l18.1141" class="difflineminus">-    tmpBuffer = PR_smprintf(&quot;Disposition: %s/%s; %s&quot; CRLF CRLF,</span>
<a href="#l18.1142"></a><span id="l18.1142" class="difflineminus">-                            (m_autoAction ? &quot;automatic-action&quot; :</span>
<a href="#l18.1143"></a><span id="l18.1143" class="difflineminus">-                             &quot;manual-action&quot;),</span>
<a href="#l18.1144"></a><span id="l18.1144" class="difflineminus">-                            (m_autoSend ? &quot;MDN-sent-automatically&quot; :</span>
<a href="#l18.1145"></a><span id="l18.1145" class="difflineminus">-                             &quot;MDN-sent-manually&quot;),</span>
<a href="#l18.1146"></a><span id="l18.1146" class="difflineminus">-                            DispositionTypes[(int) m_disposeType]);</span>
<a href="#l18.1147"></a><span id="l18.1147" class="difflineminus">-    PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.1148"></a><span id="l18.1148" class="difflineplus">+  tmpBuffer =</span>
<a href="#l18.1149"></a><span id="l18.1149" class="difflineplus">+      PR_smprintf(&quot;Disposition: %s/%s; %s&quot; CRLF CRLF,</span>
<a href="#l18.1150"></a><span id="l18.1150" class="difflineplus">+                  (m_autoAction ? &quot;automatic-action&quot; : &quot;manual-action&quot;),</span>
<a href="#l18.1151"></a><span id="l18.1151" class="difflineplus">+                  (m_autoSend ? &quot;MDN-sent-automatically&quot; : &quot;MDN-sent-manually&quot;),</span>
<a href="#l18.1152"></a><span id="l18.1152" class="difflineplus">+                  DispositionTypes[(int)m_disposeType]);</span>
<a href="#l18.1153"></a><span id="l18.1153" class="difflineplus">+  PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.1154"></a><span id="l18.1154"> </span>
<a href="#l18.1155"></a><span id="l18.1155" class="difflineminus">-    return rv;</span>
<a href="#l18.1156"></a><span id="l18.1156" class="difflineplus">+  return rv;</span>
<a href="#l18.1157"></a><span id="l18.1157"> }</span>
<a href="#l18.1158"></a><span id="l18.1158"> </span>
<a href="#l18.1159"></a><span id="l18.1159" class="difflineminus">-nsresult nsMsgMdnGenerator::CreateThirdPart()</span>
<a href="#l18.1160"></a><span id="l18.1160" class="difflineminus">-{</span>
<a href="#l18.1161"></a><span id="l18.1161" class="difflineminus">-    DEBUG_MDN(&quot;nsMsgMdnGenerator::CreateThirdPart&quot;);</span>
<a href="#l18.1162"></a><span id="l18.1162" class="difflineminus">-    char *tmpBuffer = nullptr;</span>
<a href="#l18.1163"></a><span id="l18.1163" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l18.1164"></a><span id="l18.1164" class="difflineplus">+nsresult nsMsgMdnGenerator::CreateThirdPart() {</span>
<a href="#l18.1165"></a><span id="l18.1165" class="difflineplus">+  DEBUG_MDN(&quot;nsMsgMdnGenerator::CreateThirdPart&quot;);</span>
<a href="#l18.1166"></a><span id="l18.1166" class="difflineplus">+  char *tmpBuffer = nullptr;</span>
<a href="#l18.1167"></a><span id="l18.1167" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l18.1168"></a><span id="l18.1168"> </span>
<a href="#l18.1169"></a><span id="l18.1169" class="difflineminus">-    tmpBuffer = PR_smprintf(&quot;--%s&quot; CRLF, m_mimeSeparator.get());</span>
<a href="#l18.1170"></a><span id="l18.1170" class="difflineminus">-    PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.1171"></a><span id="l18.1171" class="difflineplus">+  tmpBuffer = PR_smprintf(&quot;--%s&quot; CRLF, m_mimeSeparator.get());</span>
<a href="#l18.1172"></a><span id="l18.1172" class="difflineplus">+  PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.1173"></a><span id="l18.1173"> </span>
<a href="#l18.1174"></a><span id="l18.1174" class="difflineminus">-    tmpBuffer = PR_smprintf(&quot;%s&quot; CRLF, &quot;Content-Type: text/rfc822-headers; name=\042MDNPart3.txt\042&quot;);</span>
<a href="#l18.1175"></a><span id="l18.1175" class="difflineminus">-    PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.1176"></a><span id="l18.1176" class="difflineminus">-</span>
<a href="#l18.1177"></a><span id="l18.1177" class="difflineminus">-    tmpBuffer = PR_smprintf(&quot;%s&quot; CRLF, &quot;Content-Transfer-Encoding: 7bit&quot;);</span>
<a href="#l18.1178"></a><span id="l18.1178" class="difflineminus">-    PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.1179"></a><span id="l18.1179" class="difflineplus">+  tmpBuffer = PR_smprintf(</span>
<a href="#l18.1180"></a><span id="l18.1180" class="difflineplus">+      &quot;%s&quot; CRLF,</span>
<a href="#l18.1181"></a><span id="l18.1181" class="difflineplus">+      &quot;Content-Type: text/rfc822-headers; name=\042MDNPart3.txt\042&quot;);</span>
<a href="#l18.1182"></a><span id="l18.1182" class="difflineplus">+  PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.1183"></a><span id="l18.1183"> </span>
<a href="#l18.1184"></a><span id="l18.1184" class="difflineminus">-    tmpBuffer = PR_smprintf(&quot;%s&quot; CRLF CRLF, &quot;Content-Disposition: inline&quot;);</span>
<a href="#l18.1185"></a><span id="l18.1185" class="difflineminus">-    PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.1186"></a><span id="l18.1186" class="difflineplus">+  tmpBuffer = PR_smprintf(&quot;%s&quot; CRLF, &quot;Content-Transfer-Encoding: 7bit&quot;);</span>
<a href="#l18.1187"></a><span id="l18.1187" class="difflineplus">+  PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.1188"></a><span id="l18.1188"> </span>
<a href="#l18.1189"></a><span id="l18.1189" class="difflineminus">-    rv = OutputAllHeaders();</span>
<a href="#l18.1190"></a><span id="l18.1190" class="difflineplus">+  tmpBuffer = PR_smprintf(&quot;%s&quot; CRLF CRLF, &quot;Content-Disposition: inline&quot;);</span>
<a href="#l18.1191"></a><span id="l18.1191" class="difflineplus">+  PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.1192"></a><span id="l18.1192"> </span>
<a href="#l18.1193"></a><span id="l18.1193" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l18.1194"></a><span id="l18.1194" class="difflineminus">-        return rv;</span>
<a href="#l18.1195"></a><span id="l18.1195" class="difflineplus">+  rv = OutputAllHeaders();</span>
<a href="#l18.1196"></a><span id="l18.1196"> </span>
<a href="#l18.1197"></a><span id="l18.1197" class="difflineminus">-    rv = WriteString(CRLF);</span>
<a href="#l18.1198"></a><span id="l18.1198" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l18.1199"></a><span id="l18.1199" class="difflineminus">-        return rv;</span>
<a href="#l18.1200"></a><span id="l18.1200" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l18.1201"></a><span id="l18.1201" class="difflineplus">+</span>
<a href="#l18.1202"></a><span id="l18.1202" class="difflineplus">+  rv = WriteString(CRLF);</span>
<a href="#l18.1203"></a><span id="l18.1203" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l18.1204"></a><span id="l18.1204"> </span>
<a href="#l18.1205"></a><span id="l18.1205" class="difflineminus">-    tmpBuffer = PR_smprintf(&quot;--%s--&quot; CRLF, m_mimeSeparator.get());</span>
<a href="#l18.1206"></a><span id="l18.1206" class="difflineminus">-    PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.1207"></a><span id="l18.1207" class="difflineplus">+  tmpBuffer = PR_smprintf(&quot;--%s--&quot; CRLF, m_mimeSeparator.get());</span>
<a href="#l18.1208"></a><span id="l18.1208" class="difflineplus">+  PUSH_N_FREE_STRING(tmpBuffer);</span>
<a href="#l18.1209"></a><span id="l18.1209"> </span>
<a href="#l18.1210"></a><span id="l18.1210" class="difflineminus">-    return rv;</span>
<a href="#l18.1211"></a><span id="l18.1211" class="difflineplus">+  return rv;</span>
<a href="#l18.1212"></a><span id="l18.1212"> }</span>
<a href="#l18.1213"></a><span id="l18.1213"> </span>
<a href="#l18.1214"></a><span id="l18.1214" class="difflineminus">-</span>
<a href="#l18.1215"></a><span id="l18.1215" class="difflineminus">-nsresult nsMsgMdnGenerator::OutputAllHeaders()</span>
<a href="#l18.1216"></a><span id="l18.1216" class="difflineminus">-{</span>
<a href="#l18.1217"></a><span id="l18.1217" class="difflineminus">-    DEBUG_MDN(&quot;nsMsgMdnGenerator::OutputAllHeaders&quot;);</span>
<a href="#l18.1218"></a><span id="l18.1218" class="difflineminus">-    nsCString all_headers;</span>
<a href="#l18.1219"></a><span id="l18.1219" class="difflineminus">-    int32_t all_headers_size = 0;</span>
<a href="#l18.1220"></a><span id="l18.1220" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l18.1221"></a><span id="l18.1221" class="difflineplus">+nsresult nsMsgMdnGenerator::OutputAllHeaders() {</span>
<a href="#l18.1222"></a><span id="l18.1222" class="difflineplus">+  DEBUG_MDN(&quot;nsMsgMdnGenerator::OutputAllHeaders&quot;);</span>
<a href="#l18.1223"></a><span id="l18.1223" class="difflineplus">+  nsCString all_headers;</span>
<a href="#l18.1224"></a><span id="l18.1224" class="difflineplus">+  int32_t all_headers_size = 0;</span>
<a href="#l18.1225"></a><span id="l18.1225" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l18.1226"></a><span id="l18.1226"> </span>
<a href="#l18.1227"></a><span id="l18.1227" class="difflineminus">-    rv = m_headers-&gt;GetAllHeaders(all_headers);</span>
<a href="#l18.1228"></a><span id="l18.1228" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l18.1229"></a><span id="l18.1229" class="difflineminus">-        return rv;</span>
<a href="#l18.1230"></a><span id="l18.1230" class="difflineminus">-    all_headers_size = all_headers.Length();</span>
<a href="#l18.1231"></a><span id="l18.1231" class="difflineminus">-    char *buf = (char *) all_headers.get(),</span>
<a href="#l18.1232"></a><span id="l18.1232" class="difflineminus">-        *buf_end = (char *) all_headers.get()+all_headers_size;</span>
<a href="#l18.1233"></a><span id="l18.1233" class="difflineminus">-    char *start = buf, *end = buf;</span>
<a href="#l18.1234"></a><span id="l18.1234" class="difflineplus">+  rv = m_headers-&gt;GetAllHeaders(all_headers);</span>
<a href="#l18.1235"></a><span id="l18.1235" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l18.1236"></a><span id="l18.1236" class="difflineplus">+  all_headers_size = all_headers.Length();</span>
<a href="#l18.1237"></a><span id="l18.1237" class="difflineplus">+  char *buf = (char *)all_headers.get(),</span>
<a href="#l18.1238"></a><span id="l18.1238" class="difflineplus">+       *buf_end = (char *)all_headers.get() + all_headers_size;</span>
<a href="#l18.1239"></a><span id="l18.1239" class="difflineplus">+  char *start = buf, *end = buf;</span>
<a href="#l18.1240"></a><span id="l18.1240"> </span>
<a href="#l18.1241"></a><span id="l18.1241" class="difflineminus">-    while (buf &lt; buf_end)</span>
<a href="#l18.1242"></a><span id="l18.1242" class="difflineminus">-    {</span>
<a href="#l18.1243"></a><span id="l18.1243" class="difflineminus">-        switch (*buf)</span>
<a href="#l18.1244"></a><span id="l18.1244" class="difflineminus">-        {</span>
<a href="#l18.1245"></a><span id="l18.1245" class="difflineminus">-        case 0:</span>
<a href="#l18.1246"></a><span id="l18.1246" class="difflineminus">-            if (*(buf+1) == '\n')</span>
<a href="#l18.1247"></a><span id="l18.1247" class="difflineminus">-            {</span>
<a href="#l18.1248"></a><span id="l18.1248" class="difflineminus">-                // *buf = '\r';</span>
<a href="#l18.1249"></a><span id="l18.1249" class="difflineminus">-                end = buf;</span>
<a href="#l18.1250"></a><span id="l18.1250" class="difflineminus">-            }</span>
<a href="#l18.1251"></a><span id="l18.1251" class="difflineminus">-            else if (*(buf+1) == 0)</span>
<a href="#l18.1252"></a><span id="l18.1252" class="difflineminus">-            {</span>
<a href="#l18.1253"></a><span id="l18.1253" class="difflineminus">-                // the case of message id</span>
<a href="#l18.1254"></a><span id="l18.1254" class="difflineminus">-                *buf = '&gt;';</span>
<a href="#l18.1255"></a><span id="l18.1255" class="difflineminus">-            }</span>
<a href="#l18.1256"></a><span id="l18.1256" class="difflineminus">-            break;</span>
<a href="#l18.1257"></a><span id="l18.1257" class="difflineminus">-        case '\r':</span>
<a href="#l18.1258"></a><span id="l18.1258" class="difflineminus">-            end = buf;</span>
<a href="#l18.1259"></a><span id="l18.1259" class="difflineminus">-            *buf = 0;</span>
<a href="#l18.1260"></a><span id="l18.1260" class="difflineminus">-            break;</span>
<a href="#l18.1261"></a><span id="l18.1261" class="difflineminus">-        case '\n':</span>
<a href="#l18.1262"></a><span id="l18.1262" class="difflineminus">-            if (buf &gt; start &amp;&amp; *(buf-1) == 0)</span>
<a href="#l18.1263"></a><span id="l18.1263" class="difflineminus">-            {</span>
<a href="#l18.1264"></a><span id="l18.1264" class="difflineminus">-                start = buf + 1;</span>
<a href="#l18.1265"></a><span id="l18.1265" class="difflineminus">-                end = start;</span>
<a href="#l18.1266"></a><span id="l18.1266" class="difflineminus">-            }</span>
<a href="#l18.1267"></a><span id="l18.1267" class="difflineminus">-            else</span>
<a href="#l18.1268"></a><span id="l18.1268" class="difflineminus">-            {</span>
<a href="#l18.1269"></a><span id="l18.1269" class="difflineminus">-                end = buf;</span>
<a href="#l18.1270"></a><span id="l18.1270" class="difflineminus">-            }</span>
<a href="#l18.1271"></a><span id="l18.1271" class="difflineminus">-            *buf = 0;</span>
<a href="#l18.1272"></a><span id="l18.1272" class="difflineminus">-            break;</span>
<a href="#l18.1273"></a><span id="l18.1273" class="difflineminus">-        default:</span>
<a href="#l18.1274"></a><span id="l18.1274" class="difflineminus">-            break;</span>
<a href="#l18.1275"></a><span id="l18.1275" class="difflineplus">+  while (buf &lt; buf_end) {</span>
<a href="#l18.1276"></a><span id="l18.1276" class="difflineplus">+    switch (*buf) {</span>
<a href="#l18.1277"></a><span id="l18.1277" class="difflineplus">+      case 0:</span>
<a href="#l18.1278"></a><span id="l18.1278" class="difflineplus">+        if (*(buf + 1) == '\n') {</span>
<a href="#l18.1279"></a><span id="l18.1279" class="difflineplus">+          // *buf = '\r';</span>
<a href="#l18.1280"></a><span id="l18.1280" class="difflineplus">+          end = buf;</span>
<a href="#l18.1281"></a><span id="l18.1281" class="difflineplus">+        } else if (*(buf + 1) == 0) {</span>
<a href="#l18.1282"></a><span id="l18.1282" class="difflineplus">+          // the case of message id</span>
<a href="#l18.1283"></a><span id="l18.1283" class="difflineplus">+          *buf = '&gt;';</span>
<a href="#l18.1284"></a><span id="l18.1284" class="difflineplus">+        }</span>
<a href="#l18.1285"></a><span id="l18.1285" class="difflineplus">+        break;</span>
<a href="#l18.1286"></a><span id="l18.1286" class="difflineplus">+      case '\r':</span>
<a href="#l18.1287"></a><span id="l18.1287" class="difflineplus">+        end = buf;</span>
<a href="#l18.1288"></a><span id="l18.1288" class="difflineplus">+        *buf = 0;</span>
<a href="#l18.1289"></a><span id="l18.1289" class="difflineplus">+        break;</span>
<a href="#l18.1290"></a><span id="l18.1290" class="difflineplus">+      case '\n':</span>
<a href="#l18.1291"></a><span id="l18.1291" class="difflineplus">+        if (buf &gt; start &amp;&amp; *(buf - 1) == 0) {</span>
<a href="#l18.1292"></a><span id="l18.1292" class="difflineplus">+          start = buf + 1;</span>
<a href="#l18.1293"></a><span id="l18.1293" class="difflineplus">+          end = start;</span>
<a href="#l18.1294"></a><span id="l18.1294" class="difflineplus">+        } else {</span>
<a href="#l18.1295"></a><span id="l18.1295" class="difflineplus">+          end = buf;</span>
<a href="#l18.1296"></a><span id="l18.1296">         }</span>
<a href="#l18.1297"></a><span id="l18.1297" class="difflineminus">-        buf++;</span>
<a href="#l18.1298"></a><span id="l18.1298" class="difflineplus">+        *buf = 0;</span>
<a href="#l18.1299"></a><span id="l18.1299" class="difflineplus">+        break;</span>
<a href="#l18.1300"></a><span id="l18.1300" class="difflineplus">+      default:</span>
<a href="#l18.1301"></a><span id="l18.1301" class="difflineplus">+        break;</span>
<a href="#l18.1302"></a><span id="l18.1302" class="difflineplus">+    }</span>
<a href="#l18.1303"></a><span id="l18.1303" class="difflineplus">+    buf++;</span>
<a href="#l18.1304"></a><span id="l18.1304"> </span>
<a href="#l18.1305"></a><span id="l18.1305" class="difflineminus">-        if (end &gt; start &amp;&amp; *end == 0)</span>
<a href="#l18.1306"></a><span id="l18.1306" class="difflineminus">-        {</span>
<a href="#l18.1307"></a><span id="l18.1307" class="difflineminus">-            // strip out private X-Mozilla-Status header &amp; X-Mozilla-Draft-Info &amp;&amp; envelope header</span>
<a href="#l18.1308"></a><span id="l18.1308" class="difflineminus">-            if (!PL_strncasecmp(start, X_MOZILLA_STATUS, X_MOZILLA_STATUS_LEN)</span>
<a href="#l18.1309"></a><span id="l18.1309" class="difflineminus">-                || !PL_strncasecmp(start, X_MOZILLA_DRAFT_INFO, X_MOZILLA_DRAFT_INFO_LEN)</span>
<a href="#l18.1310"></a><span id="l18.1310" class="difflineminus">-                || !PL_strncasecmp(start, &quot;From &quot;, 5))</span>
<a href="#l18.1311"></a><span id="l18.1311" class="difflineminus">-            {</span>
<a href="#l18.1312"></a><span id="l18.1312" class="difflineminus">-                while ( end &lt; buf_end &amp;&amp;</span>
<a href="#l18.1313"></a><span id="l18.1313" class="difflineminus">-                        (*end == '\n' || *end == '\r' || *end == 0))</span>
<a href="#l18.1314"></a><span id="l18.1314" class="difflineminus">-                    end++;</span>
<a href="#l18.1315"></a><span id="l18.1315" class="difflineminus">-                start = end;</span>
<a href="#l18.1316"></a><span id="l18.1316" class="difflineminus">-            }</span>
<a href="#l18.1317"></a><span id="l18.1317" class="difflineminus">-            else</span>
<a href="#l18.1318"></a><span id="l18.1318" class="difflineminus">-            {</span>
<a href="#l18.1319"></a><span id="l18.1319" class="difflineminus">-                NS_ASSERTION (*end == 0, &quot;content of end should be null&quot;);</span>
<a href="#l18.1320"></a><span id="l18.1320" class="difflineminus">-                rv = WriteString(start);</span>
<a href="#l18.1321"></a><span id="l18.1321" class="difflineminus">-                if (NS_FAILED(rv))</span>
<a href="#l18.1322"></a><span id="l18.1322" class="difflineminus">-                    return rv;</span>
<a href="#l18.1323"></a><span id="l18.1323" class="difflineminus">-                rv = WriteString(CRLF);</span>
<a href="#l18.1324"></a><span id="l18.1324" class="difflineminus">-                while ( end &lt; buf_end &amp;&amp;</span>
<a href="#l18.1325"></a><span id="l18.1325" class="difflineminus">-                        (*end == '\n' || *end == '\r' || *end == 0))</span>
<a href="#l18.1326"></a><span id="l18.1326" class="difflineminus">-                    end++;</span>
<a href="#l18.1327"></a><span id="l18.1327" class="difflineminus">-                start = end;</span>
<a href="#l18.1328"></a><span id="l18.1328" class="difflineminus">-            }</span>
<a href="#l18.1329"></a><span id="l18.1329" class="difflineminus">-            buf = start;</span>
<a href="#l18.1330"></a><span id="l18.1330" class="difflineminus">-        }</span>
<a href="#l18.1331"></a><span id="l18.1331" class="difflineplus">+    if (end &gt; start &amp;&amp; *end == 0) {</span>
<a href="#l18.1332"></a><span id="l18.1332" class="difflineplus">+      // strip out private X-Mozilla-Status header &amp; X-Mozilla-Draft-Info &amp;&amp;</span>
<a href="#l18.1333"></a><span id="l18.1333" class="difflineplus">+      // envelope header</span>
<a href="#l18.1334"></a><span id="l18.1334" class="difflineplus">+      if (!PL_strncasecmp(start, X_MOZILLA_STATUS, X_MOZILLA_STATUS_LEN) ||</span>
<a href="#l18.1335"></a><span id="l18.1335" class="difflineplus">+          !PL_strncasecmp(start, X_MOZILLA_DRAFT_INFO,</span>
<a href="#l18.1336"></a><span id="l18.1336" class="difflineplus">+                          X_MOZILLA_DRAFT_INFO_LEN) ||</span>
<a href="#l18.1337"></a><span id="l18.1337" class="difflineplus">+          !PL_strncasecmp(start, &quot;From &quot;, 5)) {</span>
<a href="#l18.1338"></a><span id="l18.1338" class="difflineplus">+        while (end &lt; buf_end &amp;&amp; (*end == '\n' || *end == '\r' || *end == 0))</span>
<a href="#l18.1339"></a><span id="l18.1339" class="difflineplus">+          end++;</span>
<a href="#l18.1340"></a><span id="l18.1340" class="difflineplus">+        start = end;</span>
<a href="#l18.1341"></a><span id="l18.1341" class="difflineplus">+      } else {</span>
<a href="#l18.1342"></a><span id="l18.1342" class="difflineplus">+        NS_ASSERTION(*end == 0, &quot;content of end should be null&quot;);</span>
<a href="#l18.1343"></a><span id="l18.1343" class="difflineplus">+        rv = WriteString(start);</span>
<a href="#l18.1344"></a><span id="l18.1344" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l18.1345"></a><span id="l18.1345" class="difflineplus">+        rv = WriteString(CRLF);</span>
<a href="#l18.1346"></a><span id="l18.1346" class="difflineplus">+        while (end &lt; buf_end &amp;&amp; (*end == '\n' || *end == '\r' || *end == 0))</span>
<a href="#l18.1347"></a><span id="l18.1347" class="difflineplus">+          end++;</span>
<a href="#l18.1348"></a><span id="l18.1348" class="difflineplus">+        start = end;</span>
<a href="#l18.1349"></a><span id="l18.1349" class="difflineplus">+      }</span>
<a href="#l18.1350"></a><span id="l18.1350" class="difflineplus">+      buf = start;</span>
<a href="#l18.1351"></a><span id="l18.1351">     }</span>
<a href="#l18.1352"></a><span id="l18.1352" class="difflineminus">-    return NS_OK;</span>
<a href="#l18.1353"></a><span id="l18.1353" class="difflineplus">+  }</span>
<a href="#l18.1354"></a><span id="l18.1354" class="difflineplus">+  return NS_OK;</span>
<a href="#l18.1355"></a><span id="l18.1355"> }</span>
<a href="#l18.1356"></a><span id="l18.1356"> </span>
<a href="#l18.1357"></a><span id="l18.1357" class="difflineminus">-nsresult nsMsgMdnGenerator::SendMdnMsg()</span>
<a href="#l18.1358"></a><span id="l18.1358" class="difflineminus">-{</span>
<a href="#l18.1359"></a><span id="l18.1359" class="difflineminus">-    DEBUG_MDN(&quot;nsMsgMdnGenerator::SendMdnMsg&quot;);</span>
<a href="#l18.1360"></a><span id="l18.1360" class="difflineminus">-    nsresult rv;</span>
<a href="#l18.1361"></a><span id="l18.1361" class="difflineminus">-    nsCOMPtr&lt;nsISmtpService&gt; smtpService = do_GetService(NS_SMTPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l18.1362"></a><span id="l18.1362" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.1363"></a><span id="l18.1363" class="difflineplus">+nsresult nsMsgMdnGenerator::SendMdnMsg() {</span>
<a href="#l18.1364"></a><span id="l18.1364" class="difflineplus">+  DEBUG_MDN(&quot;nsMsgMdnGenerator::SendMdnMsg&quot;);</span>
<a href="#l18.1365"></a><span id="l18.1365" class="difflineplus">+  nsresult rv;</span>
<a href="#l18.1366"></a><span id="l18.1366" class="difflineplus">+  nsCOMPtr&lt;nsISmtpService&gt; smtpService =</span>
<a href="#l18.1367"></a><span id="l18.1367" class="difflineplus">+      do_GetService(NS_SMTPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l18.1368"></a><span id="l18.1368" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1369"></a><span id="l18.1369"> </span>
<a href="#l18.1370"></a><span id="l18.1370" class="difflineminus">-    nsCOMPtr&lt;nsIRequest&gt; aRequest;</span>
<a href="#l18.1371"></a><span id="l18.1371" class="difflineminus">-    nsCString identEmail;</span>
<a href="#l18.1372"></a><span id="l18.1372" class="difflineminus">-    m_identity-&gt;GetEmail(identEmail);</span>
<a href="#l18.1373"></a><span id="l18.1373" class="difflineminus">-    smtpService-&gt;SendMailMessage(m_file, m_dntRrt.get(), m_identity, identEmail.get(),</span>
<a href="#l18.1374"></a><span id="l18.1374" class="difflineminus">-                                 EmptyString(), this, nullptr, nullptr, false,</span>
<a href="#l18.1375"></a><span id="l18.1375" class="difflineminus">-                                 nullptr, getter_AddRefs(aRequest));</span>
<a href="#l18.1376"></a><span id="l18.1376" class="difflineplus">+  nsCOMPtr&lt;nsIRequest&gt; aRequest;</span>
<a href="#l18.1377"></a><span id="l18.1377" class="difflineplus">+  nsCString identEmail;</span>
<a href="#l18.1378"></a><span id="l18.1378" class="difflineplus">+  m_identity-&gt;GetEmail(identEmail);</span>
<a href="#l18.1379"></a><span id="l18.1379" class="difflineplus">+  smtpService-&gt;SendMailMessage(</span>
<a href="#l18.1380"></a><span id="l18.1380" class="difflineplus">+      m_file, m_dntRrt.get(), m_identity, identEmail.get(), EmptyString(), this,</span>
<a href="#l18.1381"></a><span id="l18.1381" class="difflineplus">+      nullptr, nullptr, false, nullptr, getter_AddRefs(aRequest));</span>
<a href="#l18.1382"></a><span id="l18.1382"> </span>
<a href="#l18.1383"></a><span id="l18.1383" class="difflineminus">-    return NS_OK;</span>
<a href="#l18.1384"></a><span id="l18.1384" class="difflineplus">+  return NS_OK;</span>
<a href="#l18.1385"></a><span id="l18.1385"> }</span>
<a href="#l18.1386"></a><span id="l18.1386"> </span>
<a href="#l18.1387"></a><span id="l18.1387" class="difflineminus">-nsresult nsMsgMdnGenerator::WriteString( const char *str )</span>
<a href="#l18.1388"></a><span id="l18.1388" class="difflineminus">-{</span>
<a href="#l18.1389"></a><span id="l18.1389" class="difflineminus">-  NS_ENSURE_ARG (str);</span>
<a href="#l18.1390"></a><span id="l18.1390" class="difflineplus">+nsresult nsMsgMdnGenerator::WriteString(const char *str) {</span>
<a href="#l18.1391"></a><span id="l18.1391" class="difflineplus">+  NS_ENSURE_ARG(str);</span>
<a href="#l18.1392"></a><span id="l18.1392">   uint32_t len = strlen(str);</span>
<a href="#l18.1393"></a><span id="l18.1393">   uint32_t wLen = 0;</span>
<a href="#l18.1394"></a><span id="l18.1394"> </span>
<a href="#l18.1395"></a><span id="l18.1395">   return m_outputStream-&gt;Write(str, len, &amp;wLen);</span>
<a href="#l18.1396"></a><span id="l18.1396"> }</span>
<a href="#l18.1397"></a><span id="l18.1397"> </span>
<a href="#l18.1398"></a><span id="l18.1398" class="difflineminus">-nsresult nsMsgMdnGenerator::InitAndProcess(bool *needToAskUser)</span>
<a href="#l18.1399"></a><span id="l18.1399" class="difflineminus">-{</span>
<a href="#l18.1400"></a><span id="l18.1400" class="difflineminus">-    DEBUG_MDN(&quot;nsMsgMdnGenerator::InitAndProcess&quot;);</span>
<a href="#l18.1401"></a><span id="l18.1401" class="difflineminus">-    nsresult rv = m_folder-&gt;GetServer(getter_AddRefs(m_server));</span>
<a href="#l18.1402"></a><span id="l18.1402" class="difflineminus">-    nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l18.1403"></a><span id="l18.1403" class="difflineminus">-        do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l18.1404"></a><span id="l18.1404" class="difflineminus">-    if (accountManager &amp;&amp; m_server)</span>
<a href="#l18.1405"></a><span id="l18.1405" class="difflineminus">-    {</span>
<a href="#l18.1406"></a><span id="l18.1406" class="difflineminus">-        if (!m_identity)</span>
<a href="#l18.1407"></a><span id="l18.1407" class="difflineminus">-        {</span>
<a href="#l18.1408"></a><span id="l18.1408" class="difflineminus">-          // check if this is a message delivered to the global inbox,</span>
<a href="#l18.1409"></a><span id="l18.1409" class="difflineminus">-          // in which case we find the originating account's identity.</span>
<a href="#l18.1410"></a><span id="l18.1410" class="difflineminus">-          nsCString accountKey;</span>
<a href="#l18.1411"></a><span id="l18.1411" class="difflineminus">-          m_headers-&gt;ExtractHeader(HEADER_X_MOZILLA_ACCOUNT_KEY, false,</span>
<a href="#l18.1412"></a><span id="l18.1412" class="difflineminus">-                                   accountKey);</span>
<a href="#l18.1413"></a><span id="l18.1413" class="difflineminus">-          nsCOMPtr &lt;nsIMsgAccount&gt; account;</span>
<a href="#l18.1414"></a><span id="l18.1414" class="difflineminus">-          if (!accountKey.IsEmpty())</span>
<a href="#l18.1415"></a><span id="l18.1415" class="difflineminus">-            accountManager-&gt;GetAccount(accountKey, getter_AddRefs(account));</span>
<a href="#l18.1416"></a><span id="l18.1416" class="difflineminus">-          if (account)</span>
<a href="#l18.1417"></a><span id="l18.1417" class="difflineminus">-            account-&gt;GetIncomingServer(getter_AddRefs(m_server));</span>
<a href="#l18.1418"></a><span id="l18.1418" class="difflineplus">+nsresult nsMsgMdnGenerator::InitAndProcess(bool *needToAskUser) {</span>
<a href="#l18.1419"></a><span id="l18.1419" class="difflineplus">+  DEBUG_MDN(&quot;nsMsgMdnGenerator::InitAndProcess&quot;);</span>
<a href="#l18.1420"></a><span id="l18.1420" class="difflineplus">+  nsresult rv = m_folder-&gt;GetServer(getter_AddRefs(m_server));</span>
<a href="#l18.1421"></a><span id="l18.1421" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l18.1422"></a><span id="l18.1422" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l18.1423"></a><span id="l18.1423" class="difflineplus">+  if (accountManager &amp;&amp; m_server) {</span>
<a href="#l18.1424"></a><span id="l18.1424" class="difflineplus">+    if (!m_identity) {</span>
<a href="#l18.1425"></a><span id="l18.1425" class="difflineplus">+      // check if this is a message delivered to the global inbox,</span>
<a href="#l18.1426"></a><span id="l18.1426" class="difflineplus">+      // in which case we find the originating account's identity.</span>
<a href="#l18.1427"></a><span id="l18.1427" class="difflineplus">+      nsCString accountKey;</span>
<a href="#l18.1428"></a><span id="l18.1428" class="difflineplus">+      m_headers-&gt;ExtractHeader(HEADER_X_MOZILLA_ACCOUNT_KEY, false, accountKey);</span>
<a href="#l18.1429"></a><span id="l18.1429" class="difflineplus">+      nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l18.1430"></a><span id="l18.1430" class="difflineplus">+      if (!accountKey.IsEmpty())</span>
<a href="#l18.1431"></a><span id="l18.1431" class="difflineplus">+        accountManager-&gt;GetAccount(accountKey, getter_AddRefs(account));</span>
<a href="#l18.1432"></a><span id="l18.1432" class="difflineplus">+      if (account) account-&gt;GetIncomingServer(getter_AddRefs(m_server));</span>
<a href="#l18.1433"></a><span id="l18.1433"> </span>
<a href="#l18.1434"></a><span id="l18.1434" class="difflineminus">-          if (m_server)</span>
<a href="#l18.1435"></a><span id="l18.1435" class="difflineminus">-          {</span>
<a href="#l18.1436"></a><span id="l18.1436" class="difflineminus">-            // Find the correct identity based on the &quot;To:&quot; and &quot;Cc:&quot; header</span>
<a href="#l18.1437"></a><span id="l18.1437" class="difflineminus">-            nsCString mailTo;</span>
<a href="#l18.1438"></a><span id="l18.1438" class="difflineminus">-            nsCString mailCC;</span>
<a href="#l18.1439"></a><span id="l18.1439" class="difflineminus">-            m_headers-&gt;ExtractHeader(HEADER_TO, true, mailTo);</span>
<a href="#l18.1440"></a><span id="l18.1440" class="difflineminus">-            m_headers-&gt;ExtractHeader(HEADER_CC, true, mailCC);</span>
<a href="#l18.1441"></a><span id="l18.1441" class="difflineminus">-            nsCOMPtr&lt;nsIArray&gt; servIdentities;</span>
<a href="#l18.1442"></a><span id="l18.1442" class="difflineminus">-            accountManager-&gt;GetIdentitiesForServer(m_server, getter_AddRefs(servIdentities));</span>
<a href="#l18.1443"></a><span id="l18.1443" class="difflineminus">-            if (servIdentities)</span>
<a href="#l18.1444"></a><span id="l18.1444" class="difflineminus">-            {</span>
<a href="#l18.1445"></a><span id="l18.1445" class="difflineminus">-              nsCOMPtr&lt;nsIMsgIdentity&gt; ident;</span>
<a href="#l18.1446"></a><span id="l18.1446" class="difflineminus">-              nsCString identEmail;</span>
<a href="#l18.1447"></a><span id="l18.1447" class="difflineminus">-              uint32_t count = 0;</span>
<a href="#l18.1448"></a><span id="l18.1448" class="difflineminus">-              servIdentities-&gt;GetLength(&amp;count);</span>
<a href="#l18.1449"></a><span id="l18.1449" class="difflineminus">-              // First check in the &quot;To:&quot; header</span>
<a href="#l18.1450"></a><span id="l18.1450" class="difflineminus">-              for (uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l18.1451"></a><span id="l18.1451" class="difflineminus">-              {</span>
<a href="#l18.1452"></a><span id="l18.1452" class="difflineminus">-                ident = do_QueryElementAt(servIdentities, i, &amp;rv);</span>
<a href="#l18.1453"></a><span id="l18.1453" class="difflineminus">-                if (NS_FAILED(rv))</span>
<a href="#l18.1454"></a><span id="l18.1454" class="difflineminus">-                  continue;</span>
<a href="#l18.1455"></a><span id="l18.1455" class="difflineminus">-                ident-&gt;GetEmail(identEmail);</span>
<a href="#l18.1456"></a><span id="l18.1456" class="difflineminus">-                if (!mailTo.IsEmpty() &amp;&amp; !identEmail.IsEmpty() &amp;&amp;</span>
<a href="#l18.1457"></a><span id="l18.1457" class="difflineminus">-                    mailTo.Find(identEmail, /* ignoreCase = */ true) != kNotFound)</span>
<a href="#l18.1458"></a><span id="l18.1458" class="difflineminus">-                {</span>
<a href="#l18.1459"></a><span id="l18.1459" class="difflineminus">-                  m_identity = ident;</span>
<a href="#l18.1460"></a><span id="l18.1460" class="difflineminus">-                  break;</span>
<a href="#l18.1461"></a><span id="l18.1461" class="difflineminus">-                }</span>
<a href="#l18.1462"></a><span id="l18.1462" class="difflineminus">-              }</span>
<a href="#l18.1463"></a><span id="l18.1463" class="difflineminus">-              // If no match, check the &quot;Cc:&quot; header</span>
<a href="#l18.1464"></a><span id="l18.1464" class="difflineminus">-              if (!m_identity)</span>
<a href="#l18.1465"></a><span id="l18.1465" class="difflineminus">-              {</span>
<a href="#l18.1466"></a><span id="l18.1466" class="difflineminus">-                for (uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l18.1467"></a><span id="l18.1467" class="difflineminus">-                {</span>
<a href="#l18.1468"></a><span id="l18.1468" class="difflineminus">-                  ident = do_QueryElementAt(servIdentities, i, &amp;rv);</span>
<a href="#l18.1469"></a><span id="l18.1469" class="difflineminus">-                  if (NS_FAILED(rv))</span>
<a href="#l18.1470"></a><span id="l18.1470" class="difflineminus">-                    continue;</span>
<a href="#l18.1471"></a><span id="l18.1471" class="difflineminus">-                  ident-&gt;GetEmail(identEmail);</span>
<a href="#l18.1472"></a><span id="l18.1472" class="difflineminus">-                  if (!mailCC.IsEmpty() &amp;&amp; !identEmail.IsEmpty() &amp;&amp;</span>
<a href="#l18.1473"></a><span id="l18.1473" class="difflineminus">-                      mailCC.Find(identEmail, /* ignoreCase = */ true) != kNotFound)</span>
<a href="#l18.1474"></a><span id="l18.1474" class="difflineminus">-                  {</span>
<a href="#l18.1475"></a><span id="l18.1475" class="difflineminus">-                    m_identity = ident;</span>
<a href="#l18.1476"></a><span id="l18.1476" class="difflineminus">-                    break;</span>
<a href="#l18.1477"></a><span id="l18.1477" class="difflineminus">-                  }</span>
<a href="#l18.1478"></a><span id="l18.1478" class="difflineminus">-                }</span>
<a href="#l18.1479"></a><span id="l18.1479" class="difflineplus">+      if (m_server) {</span>
<a href="#l18.1480"></a><span id="l18.1480" class="difflineplus">+        // Find the correct identity based on the &quot;To:&quot; and &quot;Cc:&quot; header</span>
<a href="#l18.1481"></a><span id="l18.1481" class="difflineplus">+        nsCString mailTo;</span>
<a href="#l18.1482"></a><span id="l18.1482" class="difflineplus">+        nsCString mailCC;</span>
<a href="#l18.1483"></a><span id="l18.1483" class="difflineplus">+        m_headers-&gt;ExtractHeader(HEADER_TO, true, mailTo);</span>
<a href="#l18.1484"></a><span id="l18.1484" class="difflineplus">+        m_headers-&gt;ExtractHeader(HEADER_CC, true, mailCC);</span>
<a href="#l18.1485"></a><span id="l18.1485" class="difflineplus">+        nsCOMPtr&lt;nsIArray&gt; servIdentities;</span>
<a href="#l18.1486"></a><span id="l18.1486" class="difflineplus">+        accountManager-&gt;GetIdentitiesForServer(m_server,</span>
<a href="#l18.1487"></a><span id="l18.1487" class="difflineplus">+                                               getter_AddRefs(servIdentities));</span>
<a href="#l18.1488"></a><span id="l18.1488" class="difflineplus">+        if (servIdentities) {</span>
<a href="#l18.1489"></a><span id="l18.1489" class="difflineplus">+          nsCOMPtr&lt;nsIMsgIdentity&gt; ident;</span>
<a href="#l18.1490"></a><span id="l18.1490" class="difflineplus">+          nsCString identEmail;</span>
<a href="#l18.1491"></a><span id="l18.1491" class="difflineplus">+          uint32_t count = 0;</span>
<a href="#l18.1492"></a><span id="l18.1492" class="difflineplus">+          servIdentities-&gt;GetLength(&amp;count);</span>
<a href="#l18.1493"></a><span id="l18.1493" class="difflineplus">+          // First check in the &quot;To:&quot; header</span>
<a href="#l18.1494"></a><span id="l18.1494" class="difflineplus">+          for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l18.1495"></a><span id="l18.1495" class="difflineplus">+            ident = do_QueryElementAt(servIdentities, i, &amp;rv);</span>
<a href="#l18.1496"></a><span id="l18.1496" class="difflineplus">+            if (NS_FAILED(rv)) continue;</span>
<a href="#l18.1497"></a><span id="l18.1497" class="difflineplus">+            ident-&gt;GetEmail(identEmail);</span>
<a href="#l18.1498"></a><span id="l18.1498" class="difflineplus">+            if (!mailTo.IsEmpty() &amp;&amp; !identEmail.IsEmpty() &amp;&amp;</span>
<a href="#l18.1499"></a><span id="l18.1499" class="difflineplus">+                mailTo.Find(identEmail, /* ignoreCase = */ true) != kNotFound) {</span>
<a href="#l18.1500"></a><span id="l18.1500" class="difflineplus">+              m_identity = ident;</span>
<a href="#l18.1501"></a><span id="l18.1501" class="difflineplus">+              break;</span>
<a href="#l18.1502"></a><span id="l18.1502" class="difflineplus">+            }</span>
<a href="#l18.1503"></a><span id="l18.1503" class="difflineplus">+          }</span>
<a href="#l18.1504"></a><span id="l18.1504" class="difflineplus">+          // If no match, check the &quot;Cc:&quot; header</span>
<a href="#l18.1505"></a><span id="l18.1505" class="difflineplus">+          if (!m_identity) {</span>
<a href="#l18.1506"></a><span id="l18.1506" class="difflineplus">+            for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l18.1507"></a><span id="l18.1507" class="difflineplus">+              ident = do_QueryElementAt(servIdentities, i, &amp;rv);</span>
<a href="#l18.1508"></a><span id="l18.1508" class="difflineplus">+              if (NS_FAILED(rv)) continue;</span>
<a href="#l18.1509"></a><span id="l18.1509" class="difflineplus">+              ident-&gt;GetEmail(identEmail);</span>
<a href="#l18.1510"></a><span id="l18.1510" class="difflineplus">+              if (!mailCC.IsEmpty() &amp;&amp; !identEmail.IsEmpty() &amp;&amp;</span>
<a href="#l18.1511"></a><span id="l18.1511" class="difflineplus">+                  mailCC.Find(identEmail, /* ignoreCase = */ true) !=</span>
<a href="#l18.1512"></a><span id="l18.1512" class="difflineplus">+                      kNotFound) {</span>
<a href="#l18.1513"></a><span id="l18.1513" class="difflineplus">+                m_identity = ident;</span>
<a href="#l18.1514"></a><span id="l18.1514" class="difflineplus">+                break;</span>
<a href="#l18.1515"></a><span id="l18.1515">               }</span>
<a href="#l18.1516"></a><span id="l18.1516">             }</span>
<a href="#l18.1517"></a><span id="l18.1517" class="difflineminus">-</span>
<a href="#l18.1518"></a><span id="l18.1518" class="difflineminus">-            // If no match again, use the first identity</span>
<a href="#l18.1519"></a><span id="l18.1519" class="difflineminus">-            if (!m_identity)</span>
<a href="#l18.1520"></a><span id="l18.1520" class="difflineminus">-              rv = accountManager-&gt;GetFirstIdentityForServer(m_server, getter_AddRefs(m_identity));</span>
<a href="#l18.1521"></a><span id="l18.1521">           }</span>
<a href="#l18.1522"></a><span id="l18.1522">         }</span>
<a href="#l18.1523"></a><span id="l18.1523" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.1524"></a><span id="l18.1524" class="difflineplus">+</span>
<a href="#l18.1525"></a><span id="l18.1525" class="difflineplus">+        // If no match again, use the first identity</span>
<a href="#l18.1526"></a><span id="l18.1526" class="difflineplus">+        if (!m_identity)</span>
<a href="#l18.1527"></a><span id="l18.1527" class="difflineplus">+          rv = accountManager-&gt;GetFirstIdentityForServer(</span>
<a href="#l18.1528"></a><span id="l18.1528" class="difflineplus">+              m_server, getter_AddRefs(m_identity));</span>
<a href="#l18.1529"></a><span id="l18.1529" class="difflineplus">+      }</span>
<a href="#l18.1530"></a><span id="l18.1530" class="difflineplus">+    }</span>
<a href="#l18.1531"></a><span id="l18.1531" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1532"></a><span id="l18.1532"> </span>
<a href="#l18.1533"></a><span id="l18.1533" class="difflineminus">-        if (m_identity)</span>
<a href="#l18.1534"></a><span id="l18.1534" class="difflineminus">-        {</span>
<a href="#l18.1535"></a><span id="l18.1535" class="difflineminus">-            bool useCustomPrefs = false;</span>
<a href="#l18.1536"></a><span id="l18.1536" class="difflineminus">-            m_identity-&gt;GetBoolAttribute(&quot;use_custom_prefs&quot;, &amp;useCustomPrefs);</span>
<a href="#l18.1537"></a><span id="l18.1537" class="difflineminus">-            if (useCustomPrefs)</span>
<a href="#l18.1538"></a><span id="l18.1538" class="difflineminus">-            {</span>
<a href="#l18.1539"></a><span id="l18.1539" class="difflineminus">-                bool bVal = false;</span>
<a href="#l18.1540"></a><span id="l18.1540" class="difflineminus">-                m_server-&gt;GetBoolValue(&quot;mdn_report_enabled&quot;, &amp;bVal);</span>
<a href="#l18.1541"></a><span id="l18.1541" class="difflineminus">-                m_mdnEnabled = bVal;</span>
<a href="#l18.1542"></a><span id="l18.1542" class="difflineminus">-                m_server-&gt;GetIntValue(&quot;mdn_not_in_to_cc&quot;, &amp;m_notInToCcOp);</span>
<a href="#l18.1543"></a><span id="l18.1543" class="difflineminus">-                m_server-&gt;GetIntValue(&quot;mdn_outside_domain&quot;,</span>
<a href="#l18.1544"></a><span id="l18.1544" class="difflineminus">-                                      &amp;m_outsideDomainOp);</span>
<a href="#l18.1545"></a><span id="l18.1545" class="difflineminus">-                m_server-&gt;GetIntValue(&quot;mdn_other&quot;, &amp;m_otherOp);</span>
<a href="#l18.1546"></a><span id="l18.1546" class="difflineminus">-            }</span>
<a href="#l18.1547"></a><span id="l18.1547" class="difflineminus">-            else</span>
<a href="#l18.1548"></a><span id="l18.1548" class="difflineminus">-            {</span>
<a href="#l18.1549"></a><span id="l18.1549" class="difflineminus">-                bool bVal = false;</span>
<a href="#l18.1550"></a><span id="l18.1550" class="difflineplus">+    if (m_identity) {</span>
<a href="#l18.1551"></a><span id="l18.1551" class="difflineplus">+      bool useCustomPrefs = false;</span>
<a href="#l18.1552"></a><span id="l18.1552" class="difflineplus">+      m_identity-&gt;GetBoolAttribute(&quot;use_custom_prefs&quot;, &amp;useCustomPrefs);</span>
<a href="#l18.1553"></a><span id="l18.1553" class="difflineplus">+      if (useCustomPrefs) {</span>
<a href="#l18.1554"></a><span id="l18.1554" class="difflineplus">+        bool bVal = false;</span>
<a href="#l18.1555"></a><span id="l18.1555" class="difflineplus">+        m_server-&gt;GetBoolValue(&quot;mdn_report_enabled&quot;, &amp;bVal);</span>
<a href="#l18.1556"></a><span id="l18.1556" class="difflineplus">+        m_mdnEnabled = bVal;</span>
<a href="#l18.1557"></a><span id="l18.1557" class="difflineplus">+        m_server-&gt;GetIntValue(&quot;mdn_not_in_to_cc&quot;, &amp;m_notInToCcOp);</span>
<a href="#l18.1558"></a><span id="l18.1558" class="difflineplus">+        m_server-&gt;GetIntValue(&quot;mdn_outside_domain&quot;, &amp;m_outsideDomainOp);</span>
<a href="#l18.1559"></a><span id="l18.1559" class="difflineplus">+        m_server-&gt;GetIntValue(&quot;mdn_other&quot;, &amp;m_otherOp);</span>
<a href="#l18.1560"></a><span id="l18.1560" class="difflineplus">+      } else {</span>
<a href="#l18.1561"></a><span id="l18.1561" class="difflineplus">+        bool bVal = false;</span>
<a href="#l18.1562"></a><span id="l18.1562"> </span>
<a href="#l18.1563"></a><span id="l18.1563" class="difflineminus">-                nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l18.1564"></a><span id="l18.1564" class="difflineminus">-                if (NS_FAILED(rv))</span>
<a href="#l18.1565"></a><span id="l18.1565" class="difflineminus">-                    return rv;</span>
<a href="#l18.1566"></a><span id="l18.1566" class="difflineplus">+        nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l18.1567"></a><span id="l18.1567" class="difflineplus">+            do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l18.1568"></a><span id="l18.1568" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l18.1569"></a><span id="l18.1569"> </span>
<a href="#l18.1570"></a><span id="l18.1570" class="difflineminus">-                if(prefBranch)</span>
<a href="#l18.1571"></a><span id="l18.1571" class="difflineminus">-                {</span>
<a href="#l18.1572"></a><span id="l18.1572" class="difflineminus">-                    prefBranch-&gt;GetBoolPref(&quot;mail.mdn.report.enabled&quot;,</span>
<a href="#l18.1573"></a><span id="l18.1573" class="difflineminus">-                                           &amp;bVal);</span>
<a href="#l18.1574"></a><span id="l18.1574" class="difflineminus">-                    m_mdnEnabled = bVal;</span>
<a href="#l18.1575"></a><span id="l18.1575" class="difflineminus">-                    prefBranch-&gt;GetIntPref(&quot;mail.mdn.report.not_in_to_cc&quot;,</span>
<a href="#l18.1576"></a><span id="l18.1576" class="difflineminus">-                                           &amp;m_notInToCcOp);</span>
<a href="#l18.1577"></a><span id="l18.1577" class="difflineminus">-                    prefBranch-&gt;GetIntPref(&quot;mail.mdn.report.outside_domain&quot;,</span>
<a href="#l18.1578"></a><span id="l18.1578" class="difflineminus">-                                           &amp;m_outsideDomainOp);</span>
<a href="#l18.1579"></a><span id="l18.1579" class="difflineminus">-                    prefBranch-&gt;GetIntPref(&quot;mail.mdn.report.other&quot;,</span>
<a href="#l18.1580"></a><span id="l18.1580" class="difflineminus">-                                           &amp;m_otherOp);</span>
<a href="#l18.1581"></a><span id="l18.1581" class="difflineminus">-                }</span>
<a href="#l18.1582"></a><span id="l18.1582" class="difflineminus">-            }</span>
<a href="#l18.1583"></a><span id="l18.1583" class="difflineplus">+        if (prefBranch) {</span>
<a href="#l18.1584"></a><span id="l18.1584" class="difflineplus">+          prefBranch-&gt;GetBoolPref(&quot;mail.mdn.report.enabled&quot;, &amp;bVal);</span>
<a href="#l18.1585"></a><span id="l18.1585" class="difflineplus">+          m_mdnEnabled = bVal;</span>
<a href="#l18.1586"></a><span id="l18.1586" class="difflineplus">+          prefBranch-&gt;GetIntPref(&quot;mail.mdn.report.not_in_to_cc&quot;,</span>
<a href="#l18.1587"></a><span id="l18.1587" class="difflineplus">+                                 &amp;m_notInToCcOp);</span>
<a href="#l18.1588"></a><span id="l18.1588" class="difflineplus">+          prefBranch-&gt;GetIntPref(&quot;mail.mdn.report.outside_domain&quot;,</span>
<a href="#l18.1589"></a><span id="l18.1589" class="difflineplus">+                                 &amp;m_outsideDomainOp);</span>
<a href="#l18.1590"></a><span id="l18.1590" class="difflineplus">+          prefBranch-&gt;GetIntPref(&quot;mail.mdn.report.other&quot;, &amp;m_otherOp);</span>
<a href="#l18.1591"></a><span id="l18.1591">         }</span>
<a href="#l18.1592"></a><span id="l18.1592" class="difflineplus">+      }</span>
<a href="#l18.1593"></a><span id="l18.1593">     }</span>
<a href="#l18.1594"></a><span id="l18.1594" class="difflineplus">+  }</span>
<a href="#l18.1595"></a><span id="l18.1595"> </span>
<a href="#l18.1596"></a><span id="l18.1596" class="difflineminus">-    rv = m_folder-&gt;GetCharset(m_charset);</span>
<a href="#l18.1597"></a><span id="l18.1597" class="difflineminus">-    if (m_mdnEnabled)</span>
<a href="#l18.1598"></a><span id="l18.1598" class="difflineminus">-    {</span>
<a href="#l18.1599"></a><span id="l18.1599" class="difflineminus">-        m_headers-&gt;ExtractHeader(HEADER_DISPOSITION_NOTIFICATION_TO, false,</span>
<a href="#l18.1600"></a><span id="l18.1600" class="difflineminus">-                                 m_dntRrt);</span>
<a href="#l18.1601"></a><span id="l18.1601" class="difflineminus">-        if (m_dntRrt.IsEmpty())</span>
<a href="#l18.1602"></a><span id="l18.1602" class="difflineminus">-            m_headers-&gt;ExtractHeader(HEADER_RETURN_RECEIPT_TO, false,</span>
<a href="#l18.1603"></a><span id="l18.1603" class="difflineminus">-                                     m_dntRrt);</span>
<a href="#l18.1604"></a><span id="l18.1604" class="difflineminus">-        if (!m_dntRrt.IsEmpty() &amp;&amp; ProcessSendMode() &amp;&amp; ValidateReturnPath())</span>
<a href="#l18.1605"></a><span id="l18.1605" class="difflineminus">-        {</span>
<a href="#l18.1606"></a><span id="l18.1606" class="difflineminus">-            if (!m_autoSend)</span>
<a href="#l18.1607"></a><span id="l18.1607" class="difflineminus">-            {</span>
<a href="#l18.1608"></a><span id="l18.1608" class="difflineminus">-                *needToAskUser = true;</span>
<a href="#l18.1609"></a><span id="l18.1609" class="difflineminus">-                rv = NS_OK;</span>
<a href="#l18.1610"></a><span id="l18.1610" class="difflineminus">-            }</span>
<a href="#l18.1611"></a><span id="l18.1611" class="difflineminus">-            else</span>
<a href="#l18.1612"></a><span id="l18.1612" class="difflineminus">-            {</span>
<a href="#l18.1613"></a><span id="l18.1613" class="difflineminus">-                *needToAskUser = false;</span>
<a href="#l18.1614"></a><span id="l18.1614" class="difflineminus">-                rv = UserAgreed();</span>
<a href="#l18.1615"></a><span id="l18.1615" class="difflineminus">-            }</span>
<a href="#l18.1616"></a><span id="l18.1616" class="difflineminus">-        }</span>
<a href="#l18.1617"></a><span id="l18.1617" class="difflineplus">+  rv = m_folder-&gt;GetCharset(m_charset);</span>
<a href="#l18.1618"></a><span id="l18.1618" class="difflineplus">+  if (m_mdnEnabled) {</span>
<a href="#l18.1619"></a><span id="l18.1619" class="difflineplus">+    m_headers-&gt;ExtractHeader(HEADER_DISPOSITION_NOTIFICATION_TO, false,</span>
<a href="#l18.1620"></a><span id="l18.1620" class="difflineplus">+                             m_dntRrt);</span>
<a href="#l18.1621"></a><span id="l18.1621" class="difflineplus">+    if (m_dntRrt.IsEmpty())</span>
<a href="#l18.1622"></a><span id="l18.1622" class="difflineplus">+      m_headers-&gt;ExtractHeader(HEADER_RETURN_RECEIPT_TO, false, m_dntRrt);</span>
<a href="#l18.1623"></a><span id="l18.1623" class="difflineplus">+    if (!m_dntRrt.IsEmpty() &amp;&amp; ProcessSendMode() &amp;&amp; ValidateReturnPath()) {</span>
<a href="#l18.1624"></a><span id="l18.1624" class="difflineplus">+      if (!m_autoSend) {</span>
<a href="#l18.1625"></a><span id="l18.1625" class="difflineplus">+        *needToAskUser = true;</span>
<a href="#l18.1626"></a><span id="l18.1626" class="difflineplus">+        rv = NS_OK;</span>
<a href="#l18.1627"></a><span id="l18.1627" class="difflineplus">+      } else {</span>
<a href="#l18.1628"></a><span id="l18.1628" class="difflineplus">+        *needToAskUser = false;</span>
<a href="#l18.1629"></a><span id="l18.1629" class="difflineplus">+        rv = UserAgreed();</span>
<a href="#l18.1630"></a><span id="l18.1630" class="difflineplus">+      }</span>
<a href="#l18.1631"></a><span id="l18.1631">     }</span>
<a href="#l18.1632"></a><span id="l18.1632" class="difflineminus">-    return rv;</span>
<a href="#l18.1633"></a><span id="l18.1633" class="difflineplus">+  }</span>
<a href="#l18.1634"></a><span id="l18.1634" class="difflineplus">+  return rv;</span>
<a href="#l18.1635"></a><span id="l18.1635"> }</span>
<a href="#l18.1636"></a><span id="l18.1636"> </span>
<a href="#l18.1637"></a><span id="l18.1637"> NS_IMETHODIMP nsMsgMdnGenerator::Process(EDisposeType type,</span>
<a href="#l18.1638"></a><span id="l18.1638">                                          nsIMsgWindow *aWindow,</span>
<a href="#l18.1639"></a><span id="l18.1639" class="difflineminus">-                                         nsIMsgFolder *folder,</span>
<a href="#l18.1640"></a><span id="l18.1640" class="difflineminus">-                                         nsMsgKey key,</span>
<a href="#l18.1641"></a><span id="l18.1641" class="difflineplus">+                                         nsIMsgFolder *folder, nsMsgKey key,</span>
<a href="#l18.1642"></a><span id="l18.1642">                                          nsIMimeHeaders *headers,</span>
<a href="#l18.1643"></a><span id="l18.1643" class="difflineminus">-                                         bool autoAction,</span>
<a href="#l18.1644"></a><span id="l18.1644" class="difflineminus">-                                         bool *_retval)</span>
<a href="#l18.1645"></a><span id="l18.1645" class="difflineminus">-{</span>
<a href="#l18.1646"></a><span id="l18.1646" class="difflineminus">-    DEBUG_MDN(&quot;nsMsgMdnGenerator::Process&quot;);</span>
<a href="#l18.1647"></a><span id="l18.1647" class="difflineminus">-    NS_ENSURE_ARG_POINTER(folder);</span>
<a href="#l18.1648"></a><span id="l18.1648" class="difflineminus">-    NS_ENSURE_ARG_POINTER(headers);</span>
<a href="#l18.1649"></a><span id="l18.1649" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aWindow);</span>
<a href="#l18.1650"></a><span id="l18.1650" class="difflineminus">-    NS_ENSURE_TRUE(key != nsMsgKey_None, NS_ERROR_INVALID_ARG);</span>
<a href="#l18.1651"></a><span id="l18.1651" class="difflineminus">-    m_disposeType = type;</span>
<a href="#l18.1652"></a><span id="l18.1652" class="difflineminus">-    m_autoAction = autoAction;</span>
<a href="#l18.1653"></a><span id="l18.1653" class="difflineminus">-    m_window = aWindow;</span>
<a href="#l18.1654"></a><span id="l18.1654" class="difflineminus">-    m_folder = folder;</span>
<a href="#l18.1655"></a><span id="l18.1655" class="difflineminus">-    m_headers = headers;</span>
<a href="#l18.1656"></a><span id="l18.1656" class="difflineminus">-    m_key = key;</span>
<a href="#l18.1657"></a><span id="l18.1657" class="difflineplus">+                                         bool autoAction, bool *_retval) {</span>
<a href="#l18.1658"></a><span id="l18.1658" class="difflineplus">+  DEBUG_MDN(&quot;nsMsgMdnGenerator::Process&quot;);</span>
<a href="#l18.1659"></a><span id="l18.1659" class="difflineplus">+  NS_ENSURE_ARG_POINTER(folder);</span>
<a href="#l18.1660"></a><span id="l18.1660" class="difflineplus">+  NS_ENSURE_ARG_POINTER(headers);</span>
<a href="#l18.1661"></a><span id="l18.1661" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aWindow);</span>
<a href="#l18.1662"></a><span id="l18.1662" class="difflineplus">+  NS_ENSURE_TRUE(key != nsMsgKey_None, NS_ERROR_INVALID_ARG);</span>
<a href="#l18.1663"></a><span id="l18.1663" class="difflineplus">+  m_disposeType = type;</span>
<a href="#l18.1664"></a><span id="l18.1664" class="difflineplus">+  m_autoAction = autoAction;</span>
<a href="#l18.1665"></a><span id="l18.1665" class="difflineplus">+  m_window = aWindow;</span>
<a href="#l18.1666"></a><span id="l18.1666" class="difflineplus">+  m_folder = folder;</span>
<a href="#l18.1667"></a><span id="l18.1667" class="difflineplus">+  m_headers = headers;</span>
<a href="#l18.1668"></a><span id="l18.1668" class="difflineplus">+  m_key = key;</span>
<a href="#l18.1669"></a><span id="l18.1669"> </span>
<a href="#l18.1670"></a><span id="l18.1670" class="difflineminus">-    mozilla::DebugOnly&lt;nsresult&gt; rv = InitAndProcess(_retval);</span>
<a href="#l18.1671"></a><span id="l18.1671" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;InitAndProcess failed&quot;);</span>
<a href="#l18.1672"></a><span id="l18.1672" class="difflineminus">-    return NS_OK;</span>
<a href="#l18.1673"></a><span id="l18.1673" class="difflineplus">+  mozilla::DebugOnly&lt;nsresult&gt; rv = InitAndProcess(_retval);</span>
<a href="#l18.1674"></a><span id="l18.1674" class="difflineplus">+  NS_ASSERTION(NS_SUCCEEDED(rv), &quot;InitAndProcess failed&quot;);</span>
<a href="#l18.1675"></a><span id="l18.1675" class="difflineplus">+  return NS_OK;</span>
<a href="#l18.1676"></a><span id="l18.1676"> }</span>
<a href="#l18.1677"></a><span id="l18.1677"> </span>
<a href="#l18.1678"></a><span id="l18.1678" class="difflineminus">-NS_IMETHODIMP nsMsgMdnGenerator::UserAgreed()</span>
<a href="#l18.1679"></a><span id="l18.1679" class="difflineminus">-{</span>
<a href="#l18.1680"></a><span id="l18.1680" class="difflineplus">+NS_IMETHODIMP nsMsgMdnGenerator::UserAgreed() {</span>
<a href="#l18.1681"></a><span id="l18.1681">   DEBUG_MDN(&quot;nsMsgMdnGenerator::UserAgreed&quot;);</span>
<a href="#l18.1682"></a><span id="l18.1682" class="difflineminus">-  (void) NoteMDNRequestHandled();</span>
<a href="#l18.1683"></a><span id="l18.1683" class="difflineplus">+  (void)NoteMDNRequestHandled();</span>
<a href="#l18.1684"></a><span id="l18.1684">   return CreateMdnMsg();</span>
<a href="#l18.1685"></a><span id="l18.1685"> }</span>
<a href="#l18.1686"></a><span id="l18.1686"> </span>
<a href="#l18.1687"></a><span id="l18.1687" class="difflineminus">-NS_IMETHODIMP nsMsgMdnGenerator::UserDeclined()</span>
<a href="#l18.1688"></a><span id="l18.1688" class="difflineminus">-{</span>
<a href="#l18.1689"></a><span id="l18.1689" class="difflineplus">+NS_IMETHODIMP nsMsgMdnGenerator::UserDeclined() {</span>
<a href="#l18.1690"></a><span id="l18.1690">   DEBUG_MDN(&quot;nsMsgMdnGenerator::UserDeclined&quot;);</span>
<a href="#l18.1691"></a><span id="l18.1691">   return NoteMDNRequestHandled();</span>
<a href="#l18.1692"></a><span id="l18.1692"> }</span>
<a href="#l18.1693"></a><span id="l18.1693"> </span>
<a href="#l18.1694"></a><span id="l18.1694"> /**</span>
<a href="#l18.1695"></a><span id="l18.1695">  * Set/clear flags appropriately so we won't ask user again about MDN</span>
<a href="#l18.1696"></a><span id="l18.1696">  * request for this message.</span>
<a href="#l18.1697"></a><span id="l18.1697">  */</span>
<a href="#l18.1698"></a><span id="l18.1698" class="difflineminus">-nsresult nsMsgMdnGenerator::NoteMDNRequestHandled()</span>
<a href="#l18.1699"></a><span id="l18.1699" class="difflineminus">-{</span>
<a href="#l18.1700"></a><span id="l18.1700" class="difflineplus">+nsresult nsMsgMdnGenerator::NoteMDNRequestHandled() {</span>
<a href="#l18.1701"></a><span id="l18.1701">   nsresult rv = StoreMDNSentFlag(m_folder, m_key);</span>
<a href="#l18.1702"></a><span id="l18.1702">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;StoreMDNSentFlag failed&quot;);</span>
<a href="#l18.1703"></a><span id="l18.1703">   rv = ClearMDNNeededFlag(m_folder, m_key);</span>
<a href="#l18.1704"></a><span id="l18.1704">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;ClearMDNNeededFlag failed&quot;);</span>
<a href="#l18.1705"></a><span id="l18.1705">   return rv;</span>
<a href="#l18.1706"></a><span id="l18.1706"> }</span>
<a href="#l18.1707"></a><span id="l18.1707"> </span>
<a href="#l18.1708"></a><span id="l18.1708" class="difflineminus">-NS_IMETHODIMP nsMsgMdnGenerator::OnStartRunningUrl(nsIURI *url)</span>
<a href="#l18.1709"></a><span id="l18.1709" class="difflineminus">-{</span>
<a href="#l18.1710"></a><span id="l18.1710" class="difflineminus">-    DEBUG_MDN(&quot;nsMsgMdnGenerator::OnStartRunningUrl&quot;);</span>
<a href="#l18.1711"></a><span id="l18.1711" class="difflineminus">-    return NS_OK;</span>
<a href="#l18.1712"></a><span id="l18.1712" class="difflineplus">+NS_IMETHODIMP nsMsgMdnGenerator::OnStartRunningUrl(nsIURI *url) {</span>
<a href="#l18.1713"></a><span id="l18.1713" class="difflineplus">+  DEBUG_MDN(&quot;nsMsgMdnGenerator::OnStartRunningUrl&quot;);</span>
<a href="#l18.1714"></a><span id="l18.1714" class="difflineplus">+  return NS_OK;</span>
<a href="#l18.1715"></a><span id="l18.1715"> }</span>
<a href="#l18.1716"></a><span id="l18.1716"> </span>
<a href="#l18.1717"></a><span id="l18.1717"> NS_IMETHODIMP nsMsgMdnGenerator::OnStopRunningUrl(nsIURI *url,</span>
<a href="#l18.1718"></a><span id="l18.1718" class="difflineminus">-                                                  nsresult aExitCode)</span>
<a href="#l18.1719"></a><span id="l18.1719" class="difflineminus">-{</span>
<a href="#l18.1720"></a><span id="l18.1720" class="difflineminus">-    nsresult rv;</span>
<a href="#l18.1721"></a><span id="l18.1721" class="difflineplus">+                                                  nsresult aExitCode) {</span>
<a href="#l18.1722"></a><span id="l18.1722" class="difflineplus">+  nsresult rv;</span>
<a href="#l18.1723"></a><span id="l18.1723"> </span>
<a href="#l18.1724"></a><span id="l18.1724" class="difflineminus">-    DEBUG_MDN(&quot;nsMsgMdnGenerator::OnStopRunningUrl&quot;);</span>
<a href="#l18.1725"></a><span id="l18.1725" class="difflineminus">-    if (m_file)</span>
<a href="#l18.1726"></a><span id="l18.1726" class="difflineminus">-      m_file-&gt;Remove(false);</span>
<a href="#l18.1727"></a><span id="l18.1727" class="difflineplus">+  DEBUG_MDN(&quot;nsMsgMdnGenerator::OnStopRunningUrl&quot;);</span>
<a href="#l18.1728"></a><span id="l18.1728" class="difflineplus">+  if (m_file) m_file-&gt;Remove(false);</span>
<a href="#l18.1729"></a><span id="l18.1729"> </span>
<a href="#l18.1730"></a><span id="l18.1730" class="difflineminus">-    if (NS_SUCCEEDED(aExitCode))</span>
<a href="#l18.1731"></a><span id="l18.1731" class="difflineminus">-      return NS_OK;</span>
<a href="#l18.1732"></a><span id="l18.1732" class="difflineplus">+  if (NS_SUCCEEDED(aExitCode)) return NS_OK;</span>
<a href="#l18.1733"></a><span id="l18.1733"> </span>
<a href="#l18.1734"></a><span id="l18.1734" class="difflineminus">-    const char* exitString;</span>
<a href="#l18.1735"></a><span id="l18.1735" class="difflineplus">+  const char *exitString;</span>
<a href="#l18.1736"></a><span id="l18.1736"> </span>
<a href="#l18.1737"></a><span id="l18.1737" class="difflineminus">-    switch (aExitCode)</span>
<a href="#l18.1738"></a><span id="l18.1738" class="difflineminus">-    {</span>
<a href="#l18.1739"></a><span id="l18.1739" class="difflineminus">-      case NS_ERROR_UNKNOWN_HOST:</span>
<a href="#l18.1740"></a><span id="l18.1740" class="difflineminus">-      case NS_ERROR_UNKNOWN_PROXY_HOST:</span>
<a href="#l18.1741"></a><span id="l18.1741" class="difflineminus">-        exitString = &quot;smtpSendFailedUnknownServer&quot;;</span>
<a href="#l18.1742"></a><span id="l18.1742" class="difflineminus">-        break;</span>
<a href="#l18.1743"></a><span id="l18.1743" class="difflineminus">-      case NS_ERROR_CONNECTION_REFUSED:</span>
<a href="#l18.1744"></a><span id="l18.1744" class="difflineminus">-      case NS_ERROR_PROXY_CONNECTION_REFUSED:</span>
<a href="#l18.1745"></a><span id="l18.1745" class="difflineminus">-        exitString = &quot;smtpSendRequestRefused&quot;;</span>
<a href="#l18.1746"></a><span id="l18.1746" class="difflineminus">-        break;</span>
<a href="#l18.1747"></a><span id="l18.1747" class="difflineminus">-      case NS_ERROR_NET_INTERRUPT:</span>
<a href="#l18.1748"></a><span id="l18.1748" class="difflineminus">-      case NS_ERROR_ABORT: // we have no proper string for error code NS_ERROR_ABORT in compose bundle</span>
<a href="#l18.1749"></a><span id="l18.1749" class="difflineminus">-        exitString = &quot;smtpSendInterrupted&quot;;</span>
<a href="#l18.1750"></a><span id="l18.1750" class="difflineminus">-        break;</span>
<a href="#l18.1751"></a><span id="l18.1751" class="difflineminus">-      case NS_ERROR_NET_TIMEOUT:</span>
<a href="#l18.1752"></a><span id="l18.1752" class="difflineminus">-      case NS_ERROR_NET_RESET:</span>
<a href="#l18.1753"></a><span id="l18.1753" class="difflineminus">-        exitString = &quot;smtpSendTimeout&quot;;</span>
<a href="#l18.1754"></a><span id="l18.1754" class="difflineminus">-        break;</span>
<a href="#l18.1755"></a><span id="l18.1755" class="difflineminus">-      default:</span>
<a href="#l18.1756"></a><span id="l18.1756" class="difflineminus">-        exitString = errorStringNameForErrorCode(aExitCode);</span>
<a href="#l18.1757"></a><span id="l18.1757" class="difflineminus">-        break;</span>
<a href="#l18.1758"></a><span id="l18.1758" class="difflineminus">-    }</span>
<a href="#l18.1759"></a><span id="l18.1759" class="difflineplus">+  switch (aExitCode) {</span>
<a href="#l18.1760"></a><span id="l18.1760" class="difflineplus">+    case NS_ERROR_UNKNOWN_HOST:</span>
<a href="#l18.1761"></a><span id="l18.1761" class="difflineplus">+    case NS_ERROR_UNKNOWN_PROXY_HOST:</span>
<a href="#l18.1762"></a><span id="l18.1762" class="difflineplus">+      exitString = &quot;smtpSendFailedUnknownServer&quot;;</span>
<a href="#l18.1763"></a><span id="l18.1763" class="difflineplus">+      break;</span>
<a href="#l18.1764"></a><span id="l18.1764" class="difflineplus">+    case NS_ERROR_CONNECTION_REFUSED:</span>
<a href="#l18.1765"></a><span id="l18.1765" class="difflineplus">+    case NS_ERROR_PROXY_CONNECTION_REFUSED:</span>
<a href="#l18.1766"></a><span id="l18.1766" class="difflineplus">+      exitString = &quot;smtpSendRequestRefused&quot;;</span>
<a href="#l18.1767"></a><span id="l18.1767" class="difflineplus">+      break;</span>
<a href="#l18.1768"></a><span id="l18.1768" class="difflineplus">+    case NS_ERROR_NET_INTERRUPT:</span>
<a href="#l18.1769"></a><span id="l18.1769" class="difflineplus">+    case NS_ERROR_ABORT:  // we have no proper string for error code</span>
<a href="#l18.1770"></a><span id="l18.1770" class="difflineplus">+                          // NS_ERROR_ABORT in compose bundle</span>
<a href="#l18.1771"></a><span id="l18.1771" class="difflineplus">+      exitString = &quot;smtpSendInterrupted&quot;;</span>
<a href="#l18.1772"></a><span id="l18.1772" class="difflineplus">+      break;</span>
<a href="#l18.1773"></a><span id="l18.1773" class="difflineplus">+    case NS_ERROR_NET_TIMEOUT:</span>
<a href="#l18.1774"></a><span id="l18.1774" class="difflineplus">+    case NS_ERROR_NET_RESET:</span>
<a href="#l18.1775"></a><span id="l18.1775" class="difflineplus">+      exitString = &quot;smtpSendTimeout&quot;;</span>
<a href="#l18.1776"></a><span id="l18.1776" class="difflineplus">+      break;</span>
<a href="#l18.1777"></a><span id="l18.1777" class="difflineplus">+    default:</span>
<a href="#l18.1778"></a><span id="l18.1778" class="difflineplus">+      exitString = errorStringNameForErrorCode(aExitCode);</span>
<a href="#l18.1779"></a><span id="l18.1779" class="difflineplus">+      break;</span>
<a href="#l18.1780"></a><span id="l18.1780" class="difflineplus">+  }</span>
<a href="#l18.1781"></a><span id="l18.1781"> </span>
<a href="#l18.1782"></a><span id="l18.1782" class="difflineminus">-    nsCOMPtr&lt;nsISmtpService&gt; smtpService(do_GetService(NS_SMTPSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l18.1783"></a><span id="l18.1783" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.1784"></a><span id="l18.1784" class="difflineplus">+  nsCOMPtr&lt;nsISmtpService&gt; smtpService(</span>
<a href="#l18.1785"></a><span id="l18.1785" class="difflineplus">+      do_GetService(NS_SMTPSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l18.1786"></a><span id="l18.1786" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1787"></a><span id="l18.1787"> </span>
<a href="#l18.1788"></a><span id="l18.1788" class="difflineminus">-    // Get the smtp hostname and format the string.</span>
<a href="#l18.1789"></a><span id="l18.1789" class="difflineminus">-    nsCString smtpHostName;</span>
<a href="#l18.1790"></a><span id="l18.1790" class="difflineminus">-    nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l18.1791"></a><span id="l18.1791" class="difflineminus">-    rv = smtpService-&gt;GetServerByIdentity(m_identity, getter_AddRefs(smtpServer));</span>
<a href="#l18.1792"></a><span id="l18.1792" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l18.1793"></a><span id="l18.1793" class="difflineminus">-      smtpServer-&gt;GetHostname(smtpHostName);</span>
<a href="#l18.1794"></a><span id="l18.1794" class="difflineplus">+  // Get the smtp hostname and format the string.</span>
<a href="#l18.1795"></a><span id="l18.1795" class="difflineplus">+  nsCString smtpHostName;</span>
<a href="#l18.1796"></a><span id="l18.1796" class="difflineplus">+  nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l18.1797"></a><span id="l18.1797" class="difflineplus">+  rv = smtpService-&gt;GetServerByIdentity(m_identity, getter_AddRefs(smtpServer));</span>
<a href="#l18.1798"></a><span id="l18.1798" class="difflineplus">+  if (NS_SUCCEEDED(rv)) smtpServer-&gt;GetHostname(smtpHostName);</span>
<a href="#l18.1799"></a><span id="l18.1799"> </span>
<a href="#l18.1800"></a><span id="l18.1800" class="difflineminus">-    nsAutoString hostStr;</span>
<a href="#l18.1801"></a><span id="l18.1801" class="difflineminus">-    CopyASCIItoUTF16(smtpHostName, hostStr);</span>
<a href="#l18.1802"></a><span id="l18.1802" class="difflineminus">-    const char16_t *params[] = { hostStr.get() };</span>
<a href="#l18.1803"></a><span id="l18.1803" class="difflineplus">+  nsAutoString hostStr;</span>
<a href="#l18.1804"></a><span id="l18.1804" class="difflineplus">+  CopyASCIItoUTF16(smtpHostName, hostStr);</span>
<a href="#l18.1805"></a><span id="l18.1805" class="difflineplus">+  const char16_t *params[] = {hostStr.get()};</span>
<a href="#l18.1806"></a><span id="l18.1806"> </span>
<a href="#l18.1807"></a><span id="l18.1807" class="difflineminus">-    nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l18.1808"></a><span id="l18.1808" class="difflineminus">-    nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l18.1809"></a><span id="l18.1809" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l18.1810"></a><span id="l18.1810" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l18.1811"></a><span id="l18.1811">       mozilla::services::GetStringBundleService();</span>
<a href="#l18.1812"></a><span id="l18.1812" class="difflineminus">-    NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l18.1813"></a><span id="l18.1813" class="difflineplus">+  NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l18.1814"></a><span id="l18.1814"> </span>
<a href="#l18.1815"></a><span id="l18.1815" class="difflineminus">-    rv = bundleService-&gt;CreateBundle(</span>
<a href="#l18.1816"></a><span id="l18.1816" class="difflineplus">+  rv = bundleService-&gt;CreateBundle(</span>
<a href="#l18.1817"></a><span id="l18.1817">       &quot;chrome://messenger/locale/messengercompose/composeMsgs.properties&quot;,</span>
<a href="#l18.1818"></a><span id="l18.1818">       getter_AddRefs(bundle));</span>
<a href="#l18.1819"></a><span id="l18.1819" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1820"></a><span id="l18.1820" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.1821"></a><span id="l18.1821"> </span>
<a href="#l18.1822"></a><span id="l18.1822" class="difflineminus">-    nsString failed_msg, dialogTitle;</span>
<a href="#l18.1823"></a><span id="l18.1823" class="difflineplus">+  nsString failed_msg, dialogTitle;</span>
<a href="#l18.1824"></a><span id="l18.1824"> </span>
<a href="#l18.1825"></a><span id="l18.1825" class="difflineminus">-    bundle-&gt;FormatStringFromName(exitString, params, 1, failed_msg);</span>
<a href="#l18.1826"></a><span id="l18.1826" class="difflineminus">-    bundle-&gt;GetStringFromName(&quot;sendMessageErrorTitle&quot;, dialogTitle);</span>
<a href="#l18.1827"></a><span id="l18.1827" class="difflineplus">+  bundle-&gt;FormatStringFromName(exitString, params, 1, failed_msg);</span>
<a href="#l18.1828"></a><span id="l18.1828" class="difflineplus">+  bundle-&gt;GetStringFromName(&quot;sendMessageErrorTitle&quot;, dialogTitle);</span>
<a href="#l18.1829"></a><span id="l18.1829"> </span>
<a href="#l18.1830"></a><span id="l18.1830" class="difflineminus">-    nsCOMPtr&lt;nsIPrompt&gt; dialog;</span>
<a href="#l18.1831"></a><span id="l18.1831" class="difflineminus">-    rv = m_window-&gt;GetPromptDialog(getter_AddRefs(dialog));</span>
<a href="#l18.1832"></a><span id="l18.1832" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l18.1833"></a><span id="l18.1833" class="difflineminus">-      dialog-&gt;Alert(dialogTitle.get(),failed_msg.get());</span>
<a href="#l18.1834"></a><span id="l18.1834" class="difflineplus">+  nsCOMPtr&lt;nsIPrompt&gt; dialog;</span>
<a href="#l18.1835"></a><span id="l18.1835" class="difflineplus">+  rv = m_window-&gt;GetPromptDialog(getter_AddRefs(dialog));</span>
<a href="#l18.1836"></a><span id="l18.1836" class="difflineplus">+  if (NS_SUCCEEDED(rv)) dialog-&gt;Alert(dialogTitle.get(), failed_msg.get());</span>
<a href="#l18.1837"></a><span id="l18.1837"> </span>
<a href="#l18.1838"></a><span id="l18.1838" class="difflineminus">-    return NS_OK;</span>
<a href="#l18.1839"></a><span id="l18.1839" class="difflineplus">+  return NS_OK;</span>
<a href="#l18.1840"></a><span id="l18.1840"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/extensions/mdn/src/nsMsgMdnGenerator.h</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/extensions/mdn/src/nsMsgMdnGenerator.h</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -13,61 +13,59 @@</span>
<a href="#l19.4"></a><span id="l19.4"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l19.5"></a><span id="l19.5"> #include &quot;nsIFile.h&quot;</span>
<a href="#l19.6"></a><span id="l19.6"> #include &quot;nsIMsgIdentity.h&quot;</span>
<a href="#l19.7"></a><span id="l19.7"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l19.8"></a><span id="l19.8"> #include &quot;nsIMimeHeaders.h&quot;</span>
<a href="#l19.9"></a><span id="l19.9"> #include &quot;nsString.h&quot;</span>
<a href="#l19.10"></a><span id="l19.10"> #include &quot;MailNewsTypes2.h&quot;</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-#define eNeverSendOp ((int32_t) 0)</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-#define eAutoSendOp ((int32_t) 1)</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineminus">-#define eAskMeOp ((int32_t) 2)</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineminus">-#define eDeniedOp ((int32_t) 3)</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineplus">+#define eNeverSendOp ((int32_t)0)</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineplus">+#define eAutoSendOp ((int32_t)1)</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineplus">+#define eAskMeOp ((int32_t)2)</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+#define eDeniedOp ((int32_t)3)</span>
<a href="#l19.20"></a><span id="l19.20"> </span>
<a href="#l19.21"></a><span id="l19.21" class="difflineminus">-class nsMsgMdnGenerator : public nsIMsgMdnGenerator, public nsIUrlListener</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineminus">-{</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineminus">-public:</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineplus">+class nsMsgMdnGenerator : public nsIMsgMdnGenerator, public nsIUrlListener {</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineplus">+ public:</span>
<a href="#l19.26"></a><span id="l19.26">   NS_DECL_ISUPPORTS</span>
<a href="#l19.27"></a><span id="l19.27">   NS_DECL_NSIMSGMDNGENERATOR</span>
<a href="#l19.28"></a><span id="l19.28">   NS_DECL_NSIURLLISTENER</span>
<a href="#l19.29"></a><span id="l19.29"> </span>
<a href="#l19.30"></a><span id="l19.30">   nsMsgMdnGenerator();</span>
<a href="#l19.31"></a><span id="l19.31"> </span>
<a href="#l19.32"></a><span id="l19.32" class="difflineminus">-private:</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineplus">+ private:</span>
<a href="#l19.34"></a><span id="l19.34">   virtual ~nsMsgMdnGenerator();</span>
<a href="#l19.35"></a><span id="l19.35"> </span>
<a href="#l19.36"></a><span id="l19.36">   // Sanity Check methods</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineminus">-  bool ProcessSendMode(); // must called prior ValidateReturnPath</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineplus">+  bool ProcessSendMode();  // must called prior ValidateReturnPath</span>
<a href="#l19.39"></a><span id="l19.39">   bool ValidateReturnPath();</span>
<a href="#l19.40"></a><span id="l19.40">   bool NotInToOrCc();</span>
<a href="#l19.41"></a><span id="l19.41">   bool MailAddrMatch(const char *addr1, const char *addr2);</span>
<a href="#l19.42"></a><span id="l19.42"> </span>
<a href="#l19.43"></a><span id="l19.43">   nsresult StoreMDNSentFlag(nsIMsgFolder *folder, nsMsgKey key);</span>
<a href="#l19.44"></a><span id="l19.44">   nsresult ClearMDNNeededFlag(nsIMsgFolder *folder, nsMsgKey key);</span>
<a href="#l19.45"></a><span id="l19.45">   nsresult NoteMDNRequestHandled();</span>
<a href="#l19.46"></a><span id="l19.46"> </span>
<a href="#l19.47"></a><span id="l19.47">   nsresult CreateMdnMsg();</span>
<a href="#l19.48"></a><span id="l19.48">   nsresult CreateFirstPart();</span>
<a href="#l19.49"></a><span id="l19.49">   nsresult CreateSecondPart();</span>
<a href="#l19.50"></a><span id="l19.50">   nsresult CreateThirdPart();</span>
<a href="#l19.51"></a><span id="l19.51">   nsresult SendMdnMsg();</span>
<a href="#l19.52"></a><span id="l19.52"> </span>
<a href="#l19.53"></a><span id="l19.53">   // string bundle helper methods</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineminus">-  nsresult GetStringFromName(const char *aName, nsAString&amp; aResultString);</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineminus">-  nsresult FormatStringFromName(const char *aName,</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineminus">-                                const char16_t *aString,</span>
<a href="#l19.57"></a><span id="l19.57" class="difflineminus">-                                nsAString&amp; aResultString);</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineplus">+  nsresult GetStringFromName(const char *aName, nsAString &amp;aResultString);</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineplus">+  nsresult FormatStringFromName(const char *aName, const char16_t *aString,</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineplus">+                                nsAString &amp;aResultString);</span>
<a href="#l19.61"></a><span id="l19.61"> </span>
<a href="#l19.62"></a><span id="l19.62">   // other helper methods</span>
<a href="#l19.63"></a><span id="l19.63">   nsresult InitAndProcess(bool *needToAskUser);</span>
<a href="#l19.64"></a><span id="l19.64">   nsresult OutputAllHeaders();</span>
<a href="#l19.65"></a><span id="l19.65">   nsresult WriteString(const char *str);</span>
<a href="#l19.66"></a><span id="l19.66"> </span>
<a href="#l19.67"></a><span id="l19.67" class="difflineminus">-private:</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineplus">+ private:</span>
<a href="#l19.69"></a><span id="l19.69">   EDisposeType m_disposeType;</span>
<a href="#l19.70"></a><span id="l19.70">   nsCOMPtr&lt;nsIMsgWindow&gt; m_window;</span>
<a href="#l19.71"></a><span id="l19.71">   nsCOMPtr&lt;nsIOutputStream&gt; m_outputStream;</span>
<a href="#l19.72"></a><span id="l19.72">   nsCOMPtr&lt;nsIFile&gt; m_file;</span>
<a href="#l19.73"></a><span id="l19.73">   nsCOMPtr&lt;nsIMsgIdentity&gt; m_identity;</span>
<a href="#l19.74"></a><span id="l19.74">   nsMsgKey m_key;</span>
<a href="#l19.75"></a><span id="l19.75">   nsCString m_charset;</span>
<a href="#l19.76"></a><span id="l19.76">   nsCString m_email;</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineat">@@ -81,10 +79,9 @@ private:</span>
<a href="#l19.78"></a><span id="l19.78">   int32_t m_outsideDomainOp;</span>
<a href="#l19.79"></a><span id="l19.79">   int32_t m_otherOp;</span>
<a href="#l19.80"></a><span id="l19.80">   bool m_reallySendMdn;</span>
<a href="#l19.81"></a><span id="l19.81">   bool m_autoSend;</span>
<a href="#l19.82"></a><span id="l19.82">   bool m_autoAction;</span>
<a href="#l19.83"></a><span id="l19.83">   bool m_mdnEnabled;</span>
<a href="#l19.84"></a><span id="l19.84"> };</span>
<a href="#l19.85"></a><span id="l19.85"> </span>
<a href="#l19.86"></a><span id="l19.86" class="difflineminus">-#endif // _nsMsgMdnGenerator_H_</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineminus">-</span>
<a href="#l19.88"></a><span id="l19.88" class="difflineplus">+#endif  // _nsMsgMdnGenerator_H_</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/extensions/smime/src/nsCertPicker.cpp</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/extensions/smime/src/nsCertPicker.cpp</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -23,46 +23,42 @@</span>
<a href="#l20.4"></a><span id="l20.4"> #include &quot;nsNSSCertHelper.h&quot;</span>
<a href="#l20.5"></a><span id="l20.5"> #include &quot;nsReadableUtils.h&quot;</span>
<a href="#l20.6"></a><span id="l20.6"> #include &quot;nsString.h&quot;</span>
<a href="#l20.7"></a><span id="l20.7"> #include &quot;mozpkix/pkixtypes.h&quot;</span>
<a href="#l20.8"></a><span id="l20.8"> </span>
<a href="#l20.9"></a><span id="l20.9"> using namespace mozilla;</span>
<a href="#l20.10"></a><span id="l20.10"> </span>
<a href="#l20.11"></a><span id="l20.11"> MOZ_TYPE_SPECIFIC_UNIQUE_PTR_TEMPLATE(UniqueCERTCertNicknames,</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-                                      CERTCertNicknames,</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-                                      CERT_FreeNicknames)</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+                                      CERTCertNicknames, CERT_FreeNicknames)</span>
<a href="#l20.15"></a><span id="l20.15"> </span>
<a href="#l20.16"></a><span id="l20.16" class="difflineminus">-CERTCertNicknames*</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineminus">-getNSSCertNicknamesFromCertList(const UniqueCERTCertList&amp; certList)</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineminus">-{</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineplus">+CERTCertNicknames *getNSSCertNicknamesFromCertList(</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineplus">+    const UniqueCERTCertList &amp;certList) {</span>
<a href="#l20.21"></a><span id="l20.21">   nsAutoString expiredString, notYetValidString;</span>
<a href="#l20.22"></a><span id="l20.22">   nsAutoString expiredStringLeadingSpace, notYetValidStringLeadingSpace;</span>
<a href="#l20.23"></a><span id="l20.23"> </span>
<a href="#l20.24"></a><span id="l20.24">   GetPIPNSSBundleString(&quot;NicknameExpired&quot;, expiredString);</span>
<a href="#l20.25"></a><span id="l20.25">   GetPIPNSSBundleString(&quot;NicknameNotYetValid&quot;, notYetValidString);</span>
<a href="#l20.26"></a><span id="l20.26"> </span>
<a href="#l20.27"></a><span id="l20.27">   expiredStringLeadingSpace.Append(' ');</span>
<a href="#l20.28"></a><span id="l20.28">   expiredStringLeadingSpace.Append(expiredString);</span>
<a href="#l20.29"></a><span id="l20.29"> </span>
<a href="#l20.30"></a><span id="l20.30">   notYetValidStringLeadingSpace.Append(' ');</span>
<a href="#l20.31"></a><span id="l20.31">   notYetValidStringLeadingSpace.Append(notYetValidString);</span>
<a href="#l20.32"></a><span id="l20.32"> </span>
<a href="#l20.33"></a><span id="l20.33">   NS_ConvertUTF16toUTF8 aUtf8ExpiredString(expiredStringLeadingSpace);</span>
<a href="#l20.34"></a><span id="l20.34">   NS_ConvertUTF16toUTF8 aUtf8NotYetValidString(notYetValidStringLeadingSpace);</span>
<a href="#l20.35"></a><span id="l20.35"> </span>
<a href="#l20.36"></a><span id="l20.36" class="difflineminus">-  return CERT_NicknameStringsFromCertList(certList.get(),</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineminus">-                                          const_cast&lt;char*&gt;(aUtf8ExpiredString.get()),</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineminus">-                                          const_cast&lt;char*&gt;(aUtf8NotYetValidString.get()));</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineplus">+  return CERT_NicknameStringsFromCertList(</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineplus">+      certList.get(), const_cast&lt;char *&gt;(aUtf8ExpiredString.get()),</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineplus">+      const_cast&lt;char *&gt;(aUtf8NotYetValidString.get()));</span>
<a href="#l20.42"></a><span id="l20.42"> }</span>
<a href="#l20.43"></a><span id="l20.43"> </span>
<a href="#l20.44"></a><span id="l20.44" class="difflineminus">-nsresult</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineminus">-FormatUIStrings(nsIX509Cert* cert, const nsAutoString&amp; nickname,</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineminus">-                nsAutoString&amp; nickWithSerial, nsAutoString&amp; details)</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineminus">-{</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineplus">+nsresult FormatUIStrings(nsIX509Cert *cert, const nsAutoString &amp;nickname,</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineplus">+                         nsAutoString &amp;nickWithSerial, nsAutoString &amp;details) {</span>
<a href="#l20.50"></a><span id="l20.50">   if (!NS_IsMainThread()) {</span>
<a href="#l20.51"></a><span id="l20.51">     NS_ERROR(&quot;nsNSSCertificate::FormatUIStrings called off the main thread&quot;);</span>
<a href="#l20.52"></a><span id="l20.52">     return NS_ERROR_NOT_SAME_THREAD;</span>
<a href="#l20.53"></a><span id="l20.53">   }</span>
<a href="#l20.54"></a><span id="l20.54"> </span>
<a href="#l20.55"></a><span id="l20.55">   RefPtr&lt;nsMsgComposeSecure&gt; mcs = new nsMsgComposeSecure;</span>
<a href="#l20.56"></a><span id="l20.56">   if (!mcs) {</span>
<a href="#l20.57"></a><span id="l20.57">     return NS_ERROR_FAILURE;</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineat">@@ -100,26 +96,28 @@ FormatUIStrings(nsIX509Cert* cert, const</span>
<a href="#l20.59"></a><span id="l20.59">   nsCOMPtr&lt;nsIX509CertValidity&gt; validity;</span>
<a href="#l20.60"></a><span id="l20.60">   nsresult rv = cert-&gt;GetValidity(getter_AddRefs(validity));</span>
<a href="#l20.61"></a><span id="l20.61">   if (NS_SUCCEEDED(rv) &amp;&amp; validity) {</span>
<a href="#l20.62"></a><span id="l20.62">     details.AppendLiteral(&quot;  &quot;);</span>
<a href="#l20.63"></a><span id="l20.63">     if (NS_SUCCEEDED(mcs-&gt;GetSMIMEBundleString(u&quot;CertInfoValid&quot;, info))) {</span>
<a href="#l20.64"></a><span id="l20.64">       details.Append(info);</span>
<a href="#l20.65"></a><span id="l20.65">     }</span>
<a href="#l20.66"></a><span id="l20.66"> </span>
<a href="#l20.67"></a><span id="l20.67" class="difflineminus">-    if (NS_SUCCEEDED(validity-&gt;GetNotBeforeLocalTime(temp1)) &amp;&amp; !temp1.IsEmpty()) {</span>
<a href="#l20.68"></a><span id="l20.68" class="difflineplus">+    if (NS_SUCCEEDED(validity-&gt;GetNotBeforeLocalTime(temp1)) &amp;&amp;</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineplus">+        !temp1.IsEmpty()) {</span>
<a href="#l20.70"></a><span id="l20.70">       details.Append(char16_t(' '));</span>
<a href="#l20.71"></a><span id="l20.71">       if (NS_SUCCEEDED(mcs-&gt;GetSMIMEBundleString(u&quot;CertInfoFrom&quot;, info))) {</span>
<a href="#l20.72"></a><span id="l20.72">         details.Append(info);</span>
<a href="#l20.73"></a><span id="l20.73">         details.Append(char16_t(' '));</span>
<a href="#l20.74"></a><span id="l20.74">       }</span>
<a href="#l20.75"></a><span id="l20.75">       details.Append(temp1);</span>
<a href="#l20.76"></a><span id="l20.76">     }</span>
<a href="#l20.77"></a><span id="l20.77"> </span>
<a href="#l20.78"></a><span id="l20.78" class="difflineminus">-    if (NS_SUCCEEDED(validity-&gt;GetNotAfterLocalTime(temp1)) &amp;&amp; !temp1.IsEmpty()) {</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineplus">+    if (NS_SUCCEEDED(validity-&gt;GetNotAfterLocalTime(temp1)) &amp;&amp;</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineplus">+        !temp1.IsEmpty()) {</span>
<a href="#l20.81"></a><span id="l20.81">       details.Append(char16_t(' '));</span>
<a href="#l20.82"></a><span id="l20.82">       if (NS_SUCCEEDED(mcs-&gt;GetSMIMEBundleString(u&quot;CertInfoTo&quot;, info))) {</span>
<a href="#l20.83"></a><span id="l20.83">         details.Append(info);</span>
<a href="#l20.84"></a><span id="l20.84">         details.Append(char16_t(' '));</span>
<a href="#l20.85"></a><span id="l20.85">       }</span>
<a href="#l20.86"></a><span id="l20.86">       details.Append(temp1);</span>
<a href="#l20.87"></a><span id="l20.87">     }</span>
<a href="#l20.88"></a><span id="l20.88"> </span>
<a href="#l20.89"></a><span id="l20.89" class="difflineat">@@ -137,42 +135,36 @@ FormatUIStrings(nsIX509Cert* cert, const</span>
<a href="#l20.90"></a><span id="l20.90">   }</span>
<a href="#l20.91"></a><span id="l20.91"> </span>
<a href="#l20.92"></a><span id="l20.92">   UniqueCERTCertificate nssCert(cert-&gt;GetCert());</span>
<a href="#l20.93"></a><span id="l20.93">   if (!nssCert) {</span>
<a href="#l20.94"></a><span id="l20.94">     return NS_ERROR_FAILURE;</span>
<a href="#l20.95"></a><span id="l20.95">   }</span>
<a href="#l20.96"></a><span id="l20.96"> </span>
<a href="#l20.97"></a><span id="l20.97">   nsAutoString firstEmail;</span>
<a href="#l20.98"></a><span id="l20.98" class="difflineminus">-  const char* aWalkAddr;</span>
<a href="#l20.99"></a><span id="l20.99" class="difflineminus">-  for (aWalkAddr = CERT_GetFirstEmailAddress(nssCert.get())</span>
<a href="#l20.100"></a><span id="l20.100" class="difflineminus">-        ;</span>
<a href="#l20.101"></a><span id="l20.101" class="difflineminus">-        aWalkAddr</span>
<a href="#l20.102"></a><span id="l20.102" class="difflineminus">-        ;</span>
<a href="#l20.103"></a><span id="l20.103" class="difflineminus">-        aWalkAddr = CERT_GetNextEmailAddress(nssCert.get(), aWalkAddr))</span>
<a href="#l20.104"></a><span id="l20.104" class="difflineminus">-  {</span>
<a href="#l20.105"></a><span id="l20.105" class="difflineplus">+  const char *aWalkAddr;</span>
<a href="#l20.106"></a><span id="l20.106" class="difflineplus">+  for (aWalkAddr = CERT_GetFirstEmailAddress(nssCert.get()); aWalkAddr;</span>
<a href="#l20.107"></a><span id="l20.107" class="difflineplus">+       aWalkAddr = CERT_GetNextEmailAddress(nssCert.get(), aWalkAddr)) {</span>
<a href="#l20.108"></a><span id="l20.108">     NS_ConvertUTF8toUTF16 email(aWalkAddr);</span>
<a href="#l20.109"></a><span id="l20.109" class="difflineminus">-    if (email.IsEmpty())</span>
<a href="#l20.110"></a><span id="l20.110" class="difflineminus">-      continue;</span>
<a href="#l20.111"></a><span id="l20.111" class="difflineplus">+    if (email.IsEmpty()) continue;</span>
<a href="#l20.112"></a><span id="l20.112"> </span>
<a href="#l20.113"></a><span id="l20.113">     if (firstEmail.IsEmpty()) {</span>
<a href="#l20.114"></a><span id="l20.114">       // If the first email address from the subject DN is also present</span>
<a href="#l20.115"></a><span id="l20.115">       // in the subjectAltName extension, GetEmailAddresses() will return</span>
<a href="#l20.116"></a><span id="l20.116">       // it twice (as received from NSS). Remember the first address so that</span>
<a href="#l20.117"></a><span id="l20.117">       // we can filter out duplicates later on.</span>
<a href="#l20.118"></a><span id="l20.118">       firstEmail = email;</span>
<a href="#l20.119"></a><span id="l20.119"> </span>
<a href="#l20.120"></a><span id="l20.120">       details.AppendLiteral(&quot;  &quot;);</span>
<a href="#l20.121"></a><span id="l20.121">       if (NS_SUCCEEDED(mcs-&gt;GetSMIMEBundleString(u&quot;CertInfoEmail&quot;, info))) {</span>
<a href="#l20.122"></a><span id="l20.122">         details.Append(info);</span>
<a href="#l20.123"></a><span id="l20.123">         details.AppendLiteral(&quot;: &quot;);</span>
<a href="#l20.124"></a><span id="l20.124">       }</span>
<a href="#l20.125"></a><span id="l20.125">       details.Append(email);</span>
<a href="#l20.126"></a><span id="l20.126" class="difflineminus">-    }</span>
<a href="#l20.127"></a><span id="l20.127" class="difflineminus">-    else {</span>
<a href="#l20.128"></a><span id="l20.128" class="difflineplus">+    } else {</span>
<a href="#l20.129"></a><span id="l20.129">       // Append current address if it's different from the first one.</span>
<a href="#l20.130"></a><span id="l20.130">       if (!firstEmail.Equals(email)) {</span>
<a href="#l20.131"></a><span id="l20.131">         details.AppendLiteral(&quot;, &quot;);</span>
<a href="#l20.132"></a><span id="l20.132">         details.Append(email);</span>
<a href="#l20.133"></a><span id="l20.133">       }</span>
<a href="#l20.134"></a><span id="l20.134">     }</span>
<a href="#l20.135"></a><span id="l20.135">   }</span>
<a href="#l20.136"></a><span id="l20.136"> </span>
<a href="#l20.137"></a><span id="l20.137" class="difflineat">@@ -211,114 +203,99 @@ FormatUIStrings(nsIX509Cert* cert, const</span>
<a href="#l20.138"></a><span id="l20.138">   //   Issued by: $issuerName</span>
<a href="#l20.139"></a><span id="l20.139">   //   Stored in: $token</span>
<a href="#l20.140"></a><span id="l20.140"> </span>
<a href="#l20.141"></a><span id="l20.141">   return rv;</span>
<a href="#l20.142"></a><span id="l20.142"> }</span>
<a href="#l20.143"></a><span id="l20.143"> </span>
<a href="#l20.144"></a><span id="l20.144"> NS_IMPL_ISUPPORTS(nsCertPicker, nsICertPickDialogs, nsIUserCertPicker)</span>
<a href="#l20.145"></a><span id="l20.145"> </span>
<a href="#l20.146"></a><span id="l20.146" class="difflineminus">-nsCertPicker::nsCertPicker()</span>
<a href="#l20.147"></a><span id="l20.147" class="difflineminus">-{</span>
<a href="#l20.148"></a><span id="l20.148" class="difflineminus">-}</span>
<a href="#l20.149"></a><span id="l20.149" class="difflineplus">+nsCertPicker::nsCertPicker() {}</span>
<a href="#l20.150"></a><span id="l20.150"> </span>
<a href="#l20.151"></a><span id="l20.151" class="difflineminus">-nsCertPicker::~nsCertPicker()</span>
<a href="#l20.152"></a><span id="l20.152" class="difflineminus">-{</span>
<a href="#l20.153"></a><span id="l20.153" class="difflineminus">-}</span>
<a href="#l20.154"></a><span id="l20.154" class="difflineplus">+nsCertPicker::~nsCertPicker() {}</span>
<a href="#l20.155"></a><span id="l20.155"> </span>
<a href="#l20.156"></a><span id="l20.156" class="difflineminus">-nsresult</span>
<a href="#l20.157"></a><span id="l20.157" class="difflineminus">-nsCertPicker::Init()</span>
<a href="#l20.158"></a><span id="l20.158" class="difflineminus">-{</span>
<a href="#l20.159"></a><span id="l20.159" class="difflineplus">+nsresult nsCertPicker::Init() {</span>
<a href="#l20.160"></a><span id="l20.160">   nsresult rv;</span>
<a href="#l20.161"></a><span id="l20.161">   nsCOMPtr&lt;nsISupports&gt; psm = do_GetService(&quot;@mozilla.org/psm;1&quot;, &amp;rv);</span>
<a href="#l20.162"></a><span id="l20.162">   return rv;</span>
<a href="#l20.163"></a><span id="l20.163"> }</span>
<a href="#l20.164"></a><span id="l20.164"> </span>
<a href="#l20.165"></a><span id="l20.165"> NS_IMETHODIMP</span>
<a href="#l20.166"></a><span id="l20.166"> nsCertPicker::PickCertificate(nsIInterfaceRequestor *ctx,</span>
<a href="#l20.167"></a><span id="l20.167">                               const char16_t **certNickList,</span>
<a href="#l20.168"></a><span id="l20.168" class="difflineminus">-                              const char16_t **certDetailsList,</span>
<a href="#l20.169"></a><span id="l20.169" class="difflineminus">-                              uint32_t count,</span>
<a href="#l20.170"></a><span id="l20.170" class="difflineminus">-                              int32_t *selectedIndex,</span>
<a href="#l20.171"></a><span id="l20.171" class="difflineminus">-                              bool *canceled)</span>
<a href="#l20.172"></a><span id="l20.172" class="difflineminus">-{</span>
<a href="#l20.173"></a><span id="l20.173" class="difflineplus">+                              const char16_t **certDetailsList, uint32_t count,</span>
<a href="#l20.174"></a><span id="l20.174" class="difflineplus">+                              int32_t *selectedIndex, bool *canceled) {</span>
<a href="#l20.175"></a><span id="l20.175">   nsresult rv;</span>
<a href="#l20.176"></a><span id="l20.176">   uint32_t i;</span>
<a href="#l20.177"></a><span id="l20.177"> </span>
<a href="#l20.178"></a><span id="l20.178">   *canceled = false;</span>
<a href="#l20.179"></a><span id="l20.179"> </span>
<a href="#l20.180"></a><span id="l20.180">   nsCOMPtr&lt;nsIDialogParamBlock&gt; block =</span>
<a href="#l20.181"></a><span id="l20.181" class="difflineminus">-           do_CreateInstance(NS_DIALOGPARAMBLOCK_CONTRACTID);</span>
<a href="#l20.182"></a><span id="l20.182" class="difflineplus">+      do_CreateInstance(NS_DIALOGPARAMBLOCK_CONTRACTID);</span>
<a href="#l20.183"></a><span id="l20.183">   if (!block) return NS_ERROR_FAILURE;</span>
<a href="#l20.184"></a><span id="l20.184"> </span>
<a href="#l20.185"></a><span id="l20.185" class="difflineminus">-  block-&gt;SetNumberStrings(1+count*2);</span>
<a href="#l20.186"></a><span id="l20.186" class="difflineplus">+  block-&gt;SetNumberStrings(1 + count * 2);</span>
<a href="#l20.187"></a><span id="l20.187"> </span>
<a href="#l20.188"></a><span id="l20.188">   for (i = 0; i &lt; count; i++) {</span>
<a href="#l20.189"></a><span id="l20.189">     rv = block-&gt;SetString(i, certNickList[i]);</span>
<a href="#l20.190"></a><span id="l20.190">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l20.191"></a><span id="l20.191">   }</span>
<a href="#l20.192"></a><span id="l20.192"> </span>
<a href="#l20.193"></a><span id="l20.193">   for (i = 0; i &lt; count; i++) {</span>
<a href="#l20.194"></a><span id="l20.194" class="difflineminus">-    rv = block-&gt;SetString(i+count, certDetailsList[i]);</span>
<a href="#l20.195"></a><span id="l20.195" class="difflineplus">+    rv = block-&gt;SetString(i + count, certDetailsList[i]);</span>
<a href="#l20.196"></a><span id="l20.196">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l20.197"></a><span id="l20.197">   }</span>
<a href="#l20.198"></a><span id="l20.198"> </span>
<a href="#l20.199"></a><span id="l20.199">   rv = block-&gt;SetInt(0, count);</span>
<a href="#l20.200"></a><span id="l20.200">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l20.201"></a><span id="l20.201"> </span>
<a href="#l20.202"></a><span id="l20.202">   rv = block-&gt;SetInt(1, *selectedIndex);</span>
<a href="#l20.203"></a><span id="l20.203">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l20.204"></a><span id="l20.204"> </span>
<a href="#l20.205"></a><span id="l20.205" class="difflineminus">-  rv = nsNSSDialogHelper::openDialog(nullptr,</span>
<a href="#l20.206"></a><span id="l20.206" class="difflineminus">-                                     &quot;chrome://messenger/content/certpicker.xul&quot;,</span>
<a href="#l20.207"></a><span id="l20.207" class="difflineminus">-                                     block);</span>
<a href="#l20.208"></a><span id="l20.208" class="difflineplus">+  rv = nsNSSDialogHelper::openDialog(</span>
<a href="#l20.209"></a><span id="l20.209" class="difflineplus">+      nullptr, &quot;chrome://messenger/content/certpicker.xul&quot;, block);</span>
<a href="#l20.210"></a><span id="l20.210">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l20.211"></a><span id="l20.211"> </span>
<a href="#l20.212"></a><span id="l20.212">   int32_t status;</span>
<a href="#l20.213"></a><span id="l20.213"> </span>
<a href="#l20.214"></a><span id="l20.214">   rv = block-&gt;GetInt(0, &amp;status);</span>
<a href="#l20.215"></a><span id="l20.215">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l20.216"></a><span id="l20.216"> </span>
<a href="#l20.217"></a><span id="l20.217" class="difflineminus">-  *canceled = (status == 0)?true:false;</span>
<a href="#l20.218"></a><span id="l20.218" class="difflineplus">+  *canceled = (status == 0) ? true : false;</span>
<a href="#l20.219"></a><span id="l20.219">   if (!*canceled) {</span>
<a href="#l20.220"></a><span id="l20.220">     rv = block-&gt;GetInt(1, selectedIndex);</span>
<a href="#l20.221"></a><span id="l20.221">   }</span>
<a href="#l20.222"></a><span id="l20.222">   return rv;</span>
<a href="#l20.223"></a><span id="l20.223"> }</span>
<a href="#l20.224"></a><span id="l20.224"> </span>
<a href="#l20.225"></a><span id="l20.225"> NS_IMETHODIMP nsCertPicker::PickByUsage(nsIInterfaceRequestor *ctx,</span>
<a href="#l20.226"></a><span id="l20.226">                                         const char16_t *selectedNickname,</span>
<a href="#l20.227"></a><span id="l20.227" class="difflineminus">-                                        int32_t certUsage,</span>
<a href="#l20.228"></a><span id="l20.228" class="difflineminus">-                                        bool allowInvalid,</span>
<a href="#l20.229"></a><span id="l20.229" class="difflineplus">+                                        int32_t certUsage, bool allowInvalid,</span>
<a href="#l20.230"></a><span id="l20.230">                                         bool allowDuplicateNicknames,</span>
<a href="#l20.231"></a><span id="l20.231">                                         const nsAString &amp;emailAddress,</span>
<a href="#l20.232"></a><span id="l20.232" class="difflineminus">-                                        bool *canceled,</span>
<a href="#l20.233"></a><span id="l20.233" class="difflineminus">-                                        nsIX509Cert **_retval)</span>
<a href="#l20.234"></a><span id="l20.234" class="difflineminus">-{</span>
<a href="#l20.235"></a><span id="l20.235" class="difflineplus">+                                        bool *canceled, nsIX509Cert **_retval) {</span>
<a href="#l20.236"></a><span id="l20.236">   int32_t selectedIndex = -1;</span>
<a href="#l20.237"></a><span id="l20.237">   bool selectionFound = false;</span>
<a href="#l20.238"></a><span id="l20.238">   char16_t **certNicknameList = nullptr;</span>
<a href="#l20.239"></a><span id="l20.239">   char16_t **certDetailsList = nullptr;</span>
<a href="#l20.240"></a><span id="l20.240" class="difflineminus">-  CERTCertListNode* node = nullptr;</span>
<a href="#l20.241"></a><span id="l20.241" class="difflineplus">+  CERTCertListNode *node = nullptr;</span>
<a href="#l20.242"></a><span id="l20.242">   nsresult rv = NS_OK;</span>
<a href="#l20.243"></a><span id="l20.243"> </span>
<a href="#l20.244"></a><span id="l20.244">   {</span>
<a href="#l20.245"></a><span id="l20.245" class="difflineminus">-    // Iterate over all certs. This assures that user is logged in to all hardware tokens.</span>
<a href="#l20.246"></a><span id="l20.246" class="difflineplus">+    // Iterate over all certs. This assures that user is logged in to all</span>
<a href="#l20.247"></a><span id="l20.247" class="difflineplus">+    // hardware tokens.</span>
<a href="#l20.248"></a><span id="l20.248">     nsCOMPtr&lt;nsIInterfaceRequestor&gt; ctx = new PipUIContext();</span>
<a href="#l20.249"></a><span id="l20.249">     UniqueCERTCertList allcerts(PK11_ListCerts(PK11CertListUnique, ctx));</span>
<a href="#l20.250"></a><span id="l20.250">   }</span>
<a href="#l20.251"></a><span id="l20.251"> </span>
<a href="#l20.252"></a><span id="l20.252">   /* find all user certs that are valid for the specified usage */</span>
<a href="#l20.253"></a><span id="l20.253">   /* note that we are allowing expired certs in this list */</span>
<a href="#l20.254"></a><span id="l20.254" class="difflineminus">-  UniqueCERTCertList certList(</span>
<a href="#l20.255"></a><span id="l20.255" class="difflineminus">-    CERT_FindUserCertsByUsage(CERT_GetDefaultCertDB(),</span>
<a href="#l20.256"></a><span id="l20.256" class="difflineminus">-                              (SECCertUsage)certUsage,</span>
<a href="#l20.257"></a><span id="l20.257" class="difflineminus">-                              !allowDuplicateNicknames,</span>
<a href="#l20.258"></a><span id="l20.258" class="difflineminus">-                              !allowInvalid,</span>
<a href="#l20.259"></a><span id="l20.259" class="difflineminus">-                              ctx));</span>
<a href="#l20.260"></a><span id="l20.260" class="difflineplus">+  UniqueCERTCertList certList(CERT_FindUserCertsByUsage(</span>
<a href="#l20.261"></a><span id="l20.261" class="difflineplus">+      CERT_GetDefaultCertDB(), (SECCertUsage)certUsage,</span>
<a href="#l20.262"></a><span id="l20.262" class="difflineplus">+      !allowDuplicateNicknames, !allowInvalid, ctx));</span>
<a href="#l20.263"></a><span id="l20.263">   if (!certList) {</span>
<a href="#l20.264"></a><span id="l20.264">     return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l20.265"></a><span id="l20.265">   }</span>
<a href="#l20.266"></a><span id="l20.266"> </span>
<a href="#l20.267"></a><span id="l20.267">   /* if a (non-empty) emailAddress argument is supplied to PickByUsage, */</span>
<a href="#l20.268"></a><span id="l20.268">   /* remove non-matching certificates from the candidate list */</span>
<a href="#l20.269"></a><span id="l20.269"> </span>
<a href="#l20.270"></a><span id="l20.270">   if (!emailAddress.IsEmpty()) {</span>
<a href="#l20.271"></a><span id="l20.271" class="difflineat">@@ -329,94 +306,93 @@ NS_IMETHODIMP nsCertPicker::PickByUsage(</span>
<a href="#l20.272"></a><span id="l20.272">         RefPtr&lt;nsNSSCertificate&gt; tempCert(nsNSSCertificate::Create(node-&gt;cert));</span>
<a href="#l20.273"></a><span id="l20.273">         bool match = false;</span>
<a href="#l20.274"></a><span id="l20.274">         rv = tempCert-&gt;ContainsEmailAddress(emailAddress, &amp;match);</span>
<a href="#l20.275"></a><span id="l20.275">         if (NS_FAILED(rv)) {</span>
<a href="#l20.276"></a><span id="l20.276">           return rv;</span>
<a href="#l20.277"></a><span id="l20.277">         }</span>
<a href="#l20.278"></a><span id="l20.278">         if (!match) {</span>
<a href="#l20.279"></a><span id="l20.279">           /* doesn't contain the specified address, so remove from the list */</span>
<a href="#l20.280"></a><span id="l20.280" class="difflineminus">-          CERTCertListNode* freenode = node;</span>
<a href="#l20.281"></a><span id="l20.281" class="difflineplus">+          CERTCertListNode *freenode = node;</span>
<a href="#l20.282"></a><span id="l20.282">           node = CERT_LIST_NEXT(node);</span>
<a href="#l20.283"></a><span id="l20.283">           CERT_RemoveCertListNode(freenode);</span>
<a href="#l20.284"></a><span id="l20.284">           continue;</span>
<a href="#l20.285"></a><span id="l20.285">         }</span>
<a href="#l20.286"></a><span id="l20.286">       }</span>
<a href="#l20.287"></a><span id="l20.287">       node = CERT_LIST_NEXT(node);</span>
<a href="#l20.288"></a><span id="l20.288">     }</span>
<a href="#l20.289"></a><span id="l20.289">   }</span>
<a href="#l20.290"></a><span id="l20.290"> </span>
<a href="#l20.291"></a><span id="l20.291">   UniqueCERTCertNicknames nicknames(getNSSCertNicknamesFromCertList(certList));</span>
<a href="#l20.292"></a><span id="l20.292">   if (!nicknames) {</span>
<a href="#l20.293"></a><span id="l20.293">     return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l20.294"></a><span id="l20.294">   }</span>
<a href="#l20.295"></a><span id="l20.295"> </span>
<a href="#l20.296"></a><span id="l20.296" class="difflineminus">-  certNicknameList = (char16_t **)moz_xmalloc(sizeof(char16_t *) * nicknames-&gt;numnicknames);</span>
<a href="#l20.297"></a><span id="l20.297" class="difflineminus">-  certDetailsList = (char16_t **)moz_xmalloc(sizeof(char16_t *) * nicknames-&gt;numnicknames);</span>
<a href="#l20.298"></a><span id="l20.298" class="difflineplus">+  certNicknameList =</span>
<a href="#l20.299"></a><span id="l20.299" class="difflineplus">+      (char16_t **)moz_xmalloc(sizeof(char16_t *) * nicknames-&gt;numnicknames);</span>
<a href="#l20.300"></a><span id="l20.300" class="difflineplus">+  certDetailsList =</span>
<a href="#l20.301"></a><span id="l20.301" class="difflineplus">+      (char16_t **)moz_xmalloc(sizeof(char16_t *) * nicknames-&gt;numnicknames);</span>
<a href="#l20.302"></a><span id="l20.302"> </span>
<a href="#l20.303"></a><span id="l20.303">   if (!certNicknameList || !certDetailsList) {</span>
<a href="#l20.304"></a><span id="l20.304">     free(certNicknameList);</span>
<a href="#l20.305"></a><span id="l20.305">     free(certDetailsList);</span>
<a href="#l20.306"></a><span id="l20.306">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l20.307"></a><span id="l20.307">   }</span>
<a href="#l20.308"></a><span id="l20.308"> </span>
<a href="#l20.309"></a><span id="l20.309">   int32_t CertsToUse;</span>
<a href="#l20.310"></a><span id="l20.310"> </span>
<a href="#l20.311"></a><span id="l20.311">   for (CertsToUse = 0, node = CERT_LIST_HEAD(certList.get());</span>
<a href="#l20.312"></a><span id="l20.312">        !CERT_LIST_END(node, certList.get()) &amp;&amp;</span>
<a href="#l20.313"></a><span id="l20.313" class="difflineminus">-         CertsToUse &lt; nicknames-&gt;numnicknames;</span>
<a href="#l20.314"></a><span id="l20.314" class="difflineminus">-       node = CERT_LIST_NEXT(node)</span>
<a href="#l20.315"></a><span id="l20.315" class="difflineminus">-      )</span>
<a href="#l20.316"></a><span id="l20.316" class="difflineminus">-  {</span>
<a href="#l20.317"></a><span id="l20.317" class="difflineplus">+       CertsToUse &lt; nicknames-&gt;numnicknames;</span>
<a href="#l20.318"></a><span id="l20.318" class="difflineplus">+       node = CERT_LIST_NEXT(node)) {</span>
<a href="#l20.319"></a><span id="l20.319">     RefPtr&lt;nsNSSCertificate&gt; tempCert(nsNSSCertificate::Create(node-&gt;cert));</span>
<a href="#l20.320"></a><span id="l20.320"> </span>
<a href="#l20.321"></a><span id="l20.321">     if (tempCert) {</span>
<a href="#l20.322"></a><span id="l20.322" class="difflineminus">-</span>
<a href="#l20.323"></a><span id="l20.323" class="difflineminus">-      nsAutoString i_nickname(NS_ConvertUTF8toUTF16(nicknames-&gt;nicknames[CertsToUse]));</span>
<a href="#l20.324"></a><span id="l20.324" class="difflineplus">+      nsAutoString i_nickname(</span>
<a href="#l20.325"></a><span id="l20.325" class="difflineplus">+          NS_ConvertUTF8toUTF16(nicknames-&gt;nicknames[CertsToUse]));</span>
<a href="#l20.326"></a><span id="l20.326">       nsAutoString nickWithSerial;</span>
<a href="#l20.327"></a><span id="l20.327">       nsAutoString details;</span>
<a href="#l20.328"></a><span id="l20.328"> </span>
<a href="#l20.329"></a><span id="l20.329">       if (!selectionFound) {</span>
<a href="#l20.330"></a><span id="l20.330">         /* for the case when selectedNickname refers to a bare nickname */</span>
<a href="#l20.331"></a><span id="l20.331">         if (i_nickname == nsDependentString(selectedNickname)) {</span>
<a href="#l20.332"></a><span id="l20.332">           selectedIndex = CertsToUse;</span>
<a href="#l20.333"></a><span id="l20.333">           selectionFound = true;</span>
<a href="#l20.334"></a><span id="l20.334">         }</span>
<a href="#l20.335"></a><span id="l20.335">       }</span>
<a href="#l20.336"></a><span id="l20.336"> </span>
<a href="#l20.337"></a><span id="l20.337" class="difflineminus">-      if (NS_SUCCEEDED(FormatUIStrings(tempCert, i_nickname, nickWithSerial,</span>
<a href="#l20.338"></a><span id="l20.338" class="difflineminus">-                                       details))) {</span>
<a href="#l20.339"></a><span id="l20.339" class="difflineplus">+      if (NS_SUCCEEDED(</span>
<a href="#l20.340"></a><span id="l20.340" class="difflineplus">+              FormatUIStrings(tempCert, i_nickname, nickWithSerial, details))) {</span>
<a href="#l20.341"></a><span id="l20.341">         certNicknameList[CertsToUse] = ToNewUnicode(nickWithSerial);</span>
<a href="#l20.342"></a><span id="l20.342">         certDetailsList[CertsToUse] = ToNewUnicode(details);</span>
<a href="#l20.343"></a><span id="l20.343">         if (!selectionFound) {</span>
<a href="#l20.344"></a><span id="l20.344">           /* for the case when selectedNickname refers to nickname + serial */</span>
<a href="#l20.345"></a><span id="l20.345">           if (nickWithSerial == nsDependentString(selectedNickname)) {</span>
<a href="#l20.346"></a><span id="l20.346">             selectedIndex = CertsToUse;</span>
<a href="#l20.347"></a><span id="l20.347">             selectionFound = true;</span>
<a href="#l20.348"></a><span id="l20.348">           }</span>
<a href="#l20.349"></a><span id="l20.349">         }</span>
<a href="#l20.350"></a><span id="l20.350" class="difflineminus">-      }</span>
<a href="#l20.351"></a><span id="l20.351" class="difflineminus">-      else {</span>
<a href="#l20.352"></a><span id="l20.352" class="difflineplus">+      } else {</span>
<a href="#l20.353"></a><span id="l20.353">         certNicknameList[CertsToUse] = nullptr;</span>
<a href="#l20.354"></a><span id="l20.354">         certDetailsList[CertsToUse] = nullptr;</span>
<a href="#l20.355"></a><span id="l20.355">       }</span>
<a href="#l20.356"></a><span id="l20.356"> </span>
<a href="#l20.357"></a><span id="l20.357">       ++CertsToUse;</span>
<a href="#l20.358"></a><span id="l20.358">     }</span>
<a href="#l20.359"></a><span id="l20.359">   }</span>
<a href="#l20.360"></a><span id="l20.360"> </span>
<a href="#l20.361"></a><span id="l20.361">   if (CertsToUse) {</span>
<a href="#l20.362"></a><span id="l20.362">     nsCOMPtr&lt;nsICertPickDialogs&gt; dialogs;</span>
<a href="#l20.363"></a><span id="l20.363">     rv = getNSSDialogs(getter_AddRefs(dialogs), NS_GET_IID(nsICertPickDialogs),</span>
<a href="#l20.364"></a><span id="l20.364">                        NS_CERTPICKDIALOGS_CONTRACTID);</span>
<a href="#l20.365"></a><span id="l20.365"> </span>
<a href="#l20.366"></a><span id="l20.366">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l20.367"></a><span id="l20.367">       // Show the cert picker dialog and get the index of the selected cert.</span>
<a href="#l20.368"></a><span id="l20.368" class="difflineminus">-      rv = dialogs-&gt;PickCertificate(ctx, (const char16_t**)certNicknameList,</span>
<a href="#l20.369"></a><span id="l20.369" class="difflineminus">-                                    (const char16_t**)certDetailsList,</span>
<a href="#l20.370"></a><span id="l20.370" class="difflineplus">+      rv = dialogs-&gt;PickCertificate(ctx, (const char16_t **)certNicknameList,</span>
<a href="#l20.371"></a><span id="l20.371" class="difflineplus">+                                    (const char16_t **)certDetailsList,</span>
<a href="#l20.372"></a><span id="l20.372">                                     CertsToUse, &amp;selectedIndex, canceled);</span>
<a href="#l20.373"></a><span id="l20.373">     }</span>
<a href="#l20.374"></a><span id="l20.374">   }</span>
<a href="#l20.375"></a><span id="l20.375"> </span>
<a href="#l20.376"></a><span id="l20.376">   int32_t i;</span>
<a href="#l20.377"></a><span id="l20.377">   for (i = 0; i &lt; CertsToUse; ++i) {</span>
<a href="#l20.378"></a><span id="l20.378">     free(certNicknameList[i]);</span>
<a href="#l20.379"></a><span id="l20.379">     free(certDetailsList[i]);</span>
<a href="#l20.380"></a><span id="l20.380" class="difflineat">@@ -424,20 +400,18 @@ NS_IMETHODIMP nsCertPicker::PickByUsage(</span>
<a href="#l20.381"></a><span id="l20.381">   free(certNicknameList);</span>
<a href="#l20.382"></a><span id="l20.382">   free(certDetailsList);</span>
<a href="#l20.383"></a><span id="l20.383"> </span>
<a href="#l20.384"></a><span id="l20.384">   if (!CertsToUse) {</span>
<a href="#l20.385"></a><span id="l20.385">     return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l20.386"></a><span id="l20.386">   }</span>
<a href="#l20.387"></a><span id="l20.387"> </span>
<a href="#l20.388"></a><span id="l20.388">   if (NS_SUCCEEDED(rv) &amp;&amp; !*canceled) {</span>
<a href="#l20.389"></a><span id="l20.389" class="difflineminus">-    for (i = 0, node = CERT_LIST_HEAD(certList);</span>
<a href="#l20.390"></a><span id="l20.390" class="difflineminus">-         !CERT_LIST_END(node, certList);</span>
<a href="#l20.391"></a><span id="l20.391" class="difflineplus">+    for (i = 0, node = CERT_LIST_HEAD(certList); !CERT_LIST_END(node, certList);</span>
<a href="#l20.392"></a><span id="l20.392">          ++i, node = CERT_LIST_NEXT(node)) {</span>
<a href="#l20.393"></a><span id="l20.393" class="difflineminus">-</span>
<a href="#l20.394"></a><span id="l20.394">       if (i == selectedIndex) {</span>
<a href="#l20.395"></a><span id="l20.395">         RefPtr&lt;nsNSSCertificate&gt; cert = nsNSSCertificate::Create(node-&gt;cert);</span>
<a href="#l20.396"></a><span id="l20.396">         if (!cert) {</span>
<a href="#l20.397"></a><span id="l20.397">           rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l20.398"></a><span id="l20.398">           break;</span>
<a href="#l20.399"></a><span id="l20.399">         }</span>
<a href="#l20.400"></a><span id="l20.400"> </span>
<a href="#l20.401"></a><span id="l20.401">         cert.forget(_retval);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/extensions/smime/src/nsCertPicker.h</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/extensions/smime/src/nsCertPicker.h</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -4,27 +4,29 @@</span>
<a href="#l21.4"></a><span id="l21.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l21.5"></a><span id="l21.5"> </span>
<a href="#l21.6"></a><span id="l21.6"> #ifndef nsCertPicker_h</span>
<a href="#l21.7"></a><span id="l21.7"> #define nsCertPicker_h</span>
<a href="#l21.8"></a><span id="l21.8"> </span>
<a href="#l21.9"></a><span id="l21.9"> #include &quot;nsICertPickDialogs.h&quot;</span>
<a href="#l21.10"></a><span id="l21.10"> #include &quot;nsIUserCertPicker.h&quot;</span>
<a href="#l21.11"></a><span id="l21.11"> </span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-#define NS_CERT_PICKER_CID \</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-  { 0x735959a1, 0xaf01, 0x447e, { 0xb0, 0x2d, 0x56, 0xe9, 0x68, 0xfa, 0x52, 0xb4 } }</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+#define NS_CERT_PICKER_CID                           \</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineplus">+  {                                                  \</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineplus">+    0x735959a1, 0xaf01, 0x447e, {                    \</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineplus">+      0xb0, 0x2d, 0x56, 0xe9, 0x68, 0xfa, 0x52, 0xb4 \</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineplus">+    }                                                \</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineplus">+  }</span>
<a href="#l21.20"></a><span id="l21.20"> </span>
<a href="#l21.21"></a><span id="l21.21" class="difflineminus">-class nsCertPicker : public nsICertPickDialogs</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineminus">-                   , public nsIUserCertPicker</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineminus">-{</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineminus">-public:</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineplus">+class nsCertPicker : public nsICertPickDialogs, public nsIUserCertPicker {</span>
<a href="#l21.26"></a><span id="l21.26" class="difflineplus">+ public:</span>
<a href="#l21.27"></a><span id="l21.27">   NS_DECL_ISUPPORTS</span>
<a href="#l21.28"></a><span id="l21.28">   NS_DECL_NSICERTPICKDIALOGS</span>
<a href="#l21.29"></a><span id="l21.29">   NS_DECL_NSIUSERCERTPICKER</span>
<a href="#l21.30"></a><span id="l21.30"> </span>
<a href="#l21.31"></a><span id="l21.31">   nsCertPicker();</span>
<a href="#l21.32"></a><span id="l21.32">   nsresult Init();</span>
<a href="#l21.33"></a><span id="l21.33"> </span>
<a href="#l21.34"></a><span id="l21.34" class="difflineminus">-protected:</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineplus">+ protected:</span>
<a href="#l21.36"></a><span id="l21.36">   virtual ~nsCertPicker();</span>
<a href="#l21.37"></a><span id="l21.37"> };</span>
<a href="#l21.38"></a><span id="l21.38"> </span>
<a href="#l21.39"></a><span id="l21.39" class="difflineminus">-#endif // nsCertPicker_h</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineplus">+#endif  // nsCertPicker_h</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/extensions/smime/src/nsEncryptedSMIMEURIsService.cpp</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/extensions/smime/src/nsEncryptedSMIMEURIsService.cpp</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -1,36 +1,32 @@</span>
<a href="#l22.4"></a><span id="l22.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l22.5"></a><span id="l22.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l22.6"></a><span id="l22.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l22.7"></a><span id="l22.7"> </span>
<a href="#l22.8"></a><span id="l22.8"> #include &quot;nsEncryptedSMIMEURIsService.h&quot;</span>
<a href="#l22.9"></a><span id="l22.9"> </span>
<a href="#l22.10"></a><span id="l22.10"> NS_IMPL_ISUPPORTS(nsEncryptedSMIMEURIsService, nsIEncryptedSMIMEURIsService)</span>
<a href="#l22.11"></a><span id="l22.11"> </span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-nsEncryptedSMIMEURIsService::nsEncryptedSMIMEURIsService()</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-{</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineminus">-}</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineplus">+nsEncryptedSMIMEURIsService::nsEncryptedSMIMEURIsService() {}</span>
<a href="#l22.16"></a><span id="l22.16"> </span>
<a href="#l22.17"></a><span id="l22.17" class="difflineminus">-nsEncryptedSMIMEURIsService::~nsEncryptedSMIMEURIsService()</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineminus">-{</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineminus">-}</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineplus">+nsEncryptedSMIMEURIsService::~nsEncryptedSMIMEURIsService() {}</span>
<a href="#l22.21"></a><span id="l22.21"> </span>
<a href="#l22.22"></a><span id="l22.22" class="difflineminus">-NS_IMETHODIMP nsEncryptedSMIMEURIsService::RememberEncrypted(const nsACString &amp; uri)</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineminus">-{</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineplus">+NS_IMETHODIMP nsEncryptedSMIMEURIsService::RememberEncrypted(</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineplus">+    const nsACString &amp;uri) {</span>
<a href="#l22.26"></a><span id="l22.26">   // Assuming duplicates are allowed.</span>
<a href="#l22.27"></a><span id="l22.27">   mEncryptedURIs.AppendElement(uri);</span>
<a href="#l22.28"></a><span id="l22.28">   return NS_OK;</span>
<a href="#l22.29"></a><span id="l22.29"> }</span>
<a href="#l22.30"></a><span id="l22.30"> </span>
<a href="#l22.31"></a><span id="l22.31" class="difflineminus">-NS_IMETHODIMP nsEncryptedSMIMEURIsService::ForgetEncrypted(const nsACString &amp; uri)</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineminus">-{</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineplus">+NS_IMETHODIMP nsEncryptedSMIMEURIsService::ForgetEncrypted(</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineplus">+    const nsACString &amp;uri) {</span>
<a href="#l22.35"></a><span id="l22.35">   // Assuming, this will only remove one copy of the string, if the array</span>
<a href="#l22.36"></a><span id="l22.36">   // contains multiple copies of the same string.</span>
<a href="#l22.37"></a><span id="l22.37">   mEncryptedURIs.RemoveElement(uri);</span>
<a href="#l22.38"></a><span id="l22.38">   return NS_OK;</span>
<a href="#l22.39"></a><span id="l22.39"> }</span>
<a href="#l22.40"></a><span id="l22.40"> </span>
<a href="#l22.41"></a><span id="l22.41" class="difflineminus">-NS_IMETHODIMP nsEncryptedSMIMEURIsService::IsEncrypted(const nsACString &amp; uri, bool *_retval)</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineminus">-{</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineplus">+NS_IMETHODIMP nsEncryptedSMIMEURIsService::IsEncrypted(const nsACString &amp;uri,</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineplus">+                                                       bool *_retval) {</span>
<a href="#l22.45"></a><span id="l22.45">   *_retval = mEncryptedURIs.Contains(uri);</span>
<a href="#l22.46"></a><span id="l22.46">   return NS_OK;</span>
<a href="#l22.47"></a><span id="l22.47"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/extensions/smime/src/nsEncryptedSMIMEURIsService.h</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/extensions/smime/src/nsEncryptedSMIMEURIsService.h</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -4,22 +4,21 @@</span>
<a href="#l23.4"></a><span id="l23.4"> </span>
<a href="#l23.5"></a><span id="l23.5"> #ifndef _nsEncryptedSMIMEURIsService_H_</span>
<a href="#l23.6"></a><span id="l23.6"> #define _nsEncryptedSMIMEURIsService_H_</span>
<a href="#l23.7"></a><span id="l23.7"> </span>
<a href="#l23.8"></a><span id="l23.8"> #include &quot;nsIEncryptedSMIMEURIsSrvc.h&quot;</span>
<a href="#l23.9"></a><span id="l23.9"> #include &quot;nsTArray.h&quot;</span>
<a href="#l23.10"></a><span id="l23.10"> #include &quot;nsString.h&quot;</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-class nsEncryptedSMIMEURIsService : public nsIEncryptedSMIMEURIsService</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-{</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineminus">-public:</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineplus">+class nsEncryptedSMIMEURIsService : public nsIEncryptedSMIMEURIsService {</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineplus">+ public:</span>
<a href="#l23.17"></a><span id="l23.17">   NS_DECL_ISUPPORTS</span>
<a href="#l23.18"></a><span id="l23.18">   NS_DECL_NSIENCRYPTEDSMIMEURISSERVICE</span>
<a href="#l23.19"></a><span id="l23.19"> </span>
<a href="#l23.20"></a><span id="l23.20">   nsEncryptedSMIMEURIsService();</span>
<a href="#l23.21"></a><span id="l23.21"> </span>
<a href="#l23.22"></a><span id="l23.22" class="difflineminus">-protected:</span>
<a href="#l23.23"></a><span id="l23.23" class="difflineplus">+ protected:</span>
<a href="#l23.24"></a><span id="l23.24">   virtual ~nsEncryptedSMIMEURIsService();</span>
<a href="#l23.25"></a><span id="l23.25">   nsTArray&lt;nsCString&gt; mEncryptedURIs;</span>
<a href="#l23.26"></a><span id="l23.26"> };</span>
<a href="#l23.27"></a><span id="l23.27"> </span>
<a href="#l23.28"></a><span id="l23.28"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/extensions/smime/src/nsMsgComposeSecure.cpp</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/extensions/smime/src/nsMsgComposeSecure.cpp</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -36,252 +36,221 @@ using namespace mozilla::psm;</span>
<a href="#l24.4"></a><span id="l24.4"> #define MK_MIME_ERROR_WRITING_FILE -1</span>
<a href="#l24.5"></a><span id="l24.5"> </span>
<a href="#l24.6"></a><span id="l24.6"> #define SMIME_STRBUNDLE_URL &quot;chrome://messenger/locale/am-smime.properties&quot;</span>
<a href="#l24.7"></a><span id="l24.7"> </span>
<a href="#l24.8"></a><span id="l24.8"> // It doesn't make sense to encode the message because the message will be</span>
<a href="#l24.9"></a><span id="l24.9"> // displayed only if the MUA doesn't support MIME.</span>
<a href="#l24.10"></a><span id="l24.10"> // We need to consider what to do in case the server doesn't support 8BITMIME.</span>
<a href="#l24.11"></a><span id="l24.11"> // In short, we can't use non-ASCII characters here.</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-static const char crypto_multipart_blurb[] = &quot;This is a cryptographically signed message in MIME format.&quot;;</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+static const char crypto_multipart_blurb[] =</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineplus">+    &quot;This is a cryptographically signed message in MIME format.&quot;;</span>
<a href="#l24.15"></a><span id="l24.15"> </span>
<a href="#l24.16"></a><span id="l24.16" class="difflineminus">-static void mime_crypto_write_base64 (void *closure, const char *buf,</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineminus">-                                      unsigned long size);</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineplus">+static void mime_crypto_write_base64(void *closure, const char *buf,</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineplus">+                                     unsigned long size);</span>
<a href="#l24.20"></a><span id="l24.20"> static nsresult mime_encoder_output_fn(const char *buf, int32_t size,</span>
<a href="#l24.21"></a><span id="l24.21">                                        void *closure);</span>
<a href="#l24.22"></a><span id="l24.22"> static nsresult mime_nested_encoder_output_fn(const char *buf, int32_t size,</span>
<a href="#l24.23"></a><span id="l24.23">                                               void *closure);</span>
<a href="#l24.24"></a><span id="l24.24"> static nsresult make_multipart_signed_header_string(bool outer_p,</span>
<a href="#l24.25"></a><span id="l24.25">                                                     char **header_return,</span>
<a href="#l24.26"></a><span id="l24.26">                                                     char **boundary_return,</span>
<a href="#l24.27"></a><span id="l24.27">                                                     int16_t hash_type);</span>
<a href="#l24.28"></a><span id="l24.28"> static char *mime_make_separator(const char *prefix);</span>
<a href="#l24.29"></a><span id="l24.29"> </span>
<a href="#l24.30"></a><span id="l24.30" class="difflineplus">+static void GenerateGlobalRandomBytes(unsigned char *buf, int32_t len) {</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineplus">+  static bool firstTime = true;</span>
<a href="#l24.32"></a><span id="l24.32"> </span>
<a href="#l24.33"></a><span id="l24.33" class="difflineminus">-static void</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineminus">-GenerateGlobalRandomBytes(unsigned char *buf, int32_t len)</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineminus">-{</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineminus">-  static bool      firstTime = true;</span>
<a href="#l24.37"></a><span id="l24.37" class="difflineminus">-</span>
<a href="#l24.38"></a><span id="l24.38" class="difflineminus">-  if (firstTime)</span>
<a href="#l24.39"></a><span id="l24.39" class="difflineminus">-  {</span>
<a href="#l24.40"></a><span id="l24.40" class="difflineplus">+  if (firstTime) {</span>
<a href="#l24.41"></a><span id="l24.41">     // Seed the random-number generator with current time so that</span>
<a href="#l24.42"></a><span id="l24.42">     // the numbers will be different every time we run.</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineminus">-    srand( (unsigned)PR_Now() );</span>
<a href="#l24.44"></a><span id="l24.44" class="difflineplus">+    srand((unsigned)PR_Now());</span>
<a href="#l24.45"></a><span id="l24.45">     firstTime = false;</span>
<a href="#l24.46"></a><span id="l24.46">   }</span>
<a href="#l24.47"></a><span id="l24.47"> </span>
<a href="#l24.48"></a><span id="l24.48" class="difflineminus">-  for( int32_t i = 0; i &lt; len; i++ )</span>
<a href="#l24.49"></a><span id="l24.49" class="difflineminus">-    buf[i] = rand() % 10;</span>
<a href="#l24.50"></a><span id="l24.50" class="difflineplus">+  for (int32_t i = 0; i &lt; len; i++) buf[i] = rand() % 10;</span>
<a href="#l24.51"></a><span id="l24.51"> }</span>
<a href="#l24.52"></a><span id="l24.52"> </span>
<a href="#l24.53"></a><span id="l24.53" class="difflineminus">-char</span>
<a href="#l24.54"></a><span id="l24.54" class="difflineminus">-*mime_make_separator(const char *prefix)</span>
<a href="#l24.55"></a><span id="l24.55" class="difflineminus">-{</span>
<a href="#l24.56"></a><span id="l24.56" class="difflineplus">+char *mime_make_separator(const char *prefix) {</span>
<a href="#l24.57"></a><span id="l24.57">   unsigned char rand_buf[13];</span>
<a href="#l24.58"></a><span id="l24.58">   GenerateGlobalRandomBytes(rand_buf, 12);</span>
<a href="#l24.59"></a><span id="l24.59"> </span>
<a href="#l24.60"></a><span id="l24.60" class="difflineminus">-  return PR_smprintf(&quot;------------%s&quot;</span>
<a href="#l24.61"></a><span id="l24.61" class="difflineminus">-           &quot;%02X%02X%02X%02X&quot;</span>
<a href="#l24.62"></a><span id="l24.62" class="difflineminus">-           &quot;%02X%02X%02X%02X&quot;</span>
<a href="#l24.63"></a><span id="l24.63" class="difflineminus">-           &quot;%02X%02X%02X%02X&quot;,</span>
<a href="#l24.64"></a><span id="l24.64" class="difflineminus">-           prefix,</span>
<a href="#l24.65"></a><span id="l24.65" class="difflineminus">-           rand_buf[0], rand_buf[1], rand_buf[2], rand_buf[3],</span>
<a href="#l24.66"></a><span id="l24.66" class="difflineminus">-           rand_buf[4], rand_buf[5], rand_buf[6], rand_buf[7],</span>
<a href="#l24.67"></a><span id="l24.67" class="difflineminus">-           rand_buf[8], rand_buf[9], rand_buf[10], rand_buf[11]);</span>
<a href="#l24.68"></a><span id="l24.68" class="difflineplus">+  return PR_smprintf(</span>
<a href="#l24.69"></a><span id="l24.69" class="difflineplus">+      &quot;------------%s&quot;</span>
<a href="#l24.70"></a><span id="l24.70" class="difflineplus">+      &quot;%02X%02X%02X%02X&quot;</span>
<a href="#l24.71"></a><span id="l24.71" class="difflineplus">+      &quot;%02X%02X%02X%02X&quot;</span>
<a href="#l24.72"></a><span id="l24.72" class="difflineplus">+      &quot;%02X%02X%02X%02X&quot;,</span>
<a href="#l24.73"></a><span id="l24.73" class="difflineplus">+      prefix, rand_buf[0], rand_buf[1], rand_buf[2], rand_buf[3], rand_buf[4],</span>
<a href="#l24.74"></a><span id="l24.74" class="difflineplus">+      rand_buf[5], rand_buf[6], rand_buf[7], rand_buf[8], rand_buf[9],</span>
<a href="#l24.75"></a><span id="l24.75" class="difflineplus">+      rand_buf[10], rand_buf[11]);</span>
<a href="#l24.76"></a><span id="l24.76"> }</span>
<a href="#l24.77"></a><span id="l24.77"> </span>
<a href="#l24.78"></a><span id="l24.78"> // end of copied code which needs fixed....</span>
<a href="#l24.79"></a><span id="l24.79"> </span>
<a href="#l24.80"></a><span id="l24.80" class="difflineminus">-</span>
<a href="#l24.81"></a><span id="l24.81"> /////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l24.82"></a><span id="l24.82"> // Implementation of nsMsgComposeSecure</span>
<a href="#l24.83"></a><span id="l24.83"> /////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l24.84"></a><span id="l24.84"> </span>
<a href="#l24.85"></a><span id="l24.85"> NS_IMPL_ISUPPORTS(nsMsgComposeSecure, nsIMsgComposeSecure)</span>
<a href="#l24.86"></a><span id="l24.86"> </span>
<a href="#l24.87"></a><span id="l24.87"> nsMsgComposeSecure::nsMsgComposeSecure()</span>
<a href="#l24.88"></a><span id="l24.88" class="difflineminus">-:mSignMessage(false), mAlwaysEncryptMessage(false)</span>
<a href="#l24.89"></a><span id="l24.89" class="difflineminus">-{</span>
<a href="#l24.90"></a><span id="l24.90" class="difflineplus">+    : mSignMessage(false), mAlwaysEncryptMessage(false) {</span>
<a href="#l24.91"></a><span id="l24.91">   /* member initializers and constructor code */</span>
<a href="#l24.92"></a><span id="l24.92" class="difflineminus">-  mMultipartSignedBoundary  = 0;</span>
<a href="#l24.93"></a><span id="l24.93" class="difflineplus">+  mMultipartSignedBoundary = 0;</span>
<a href="#l24.94"></a><span id="l24.94">   mBuffer = 0;</span>
<a href="#l24.95"></a><span id="l24.95">   mBufferedBytes = 0;</span>
<a href="#l24.96"></a><span id="l24.96">   mHashType = 0;</span>
<a href="#l24.97"></a><span id="l24.97"> }</span>
<a href="#l24.98"></a><span id="l24.98"> </span>
<a href="#l24.99"></a><span id="l24.99" class="difflineminus">-nsMsgComposeSecure::~nsMsgComposeSecure()</span>
<a href="#l24.100"></a><span id="l24.100" class="difflineminus">-{</span>
<a href="#l24.101"></a><span id="l24.101" class="difflineplus">+nsMsgComposeSecure::~nsMsgComposeSecure() {</span>
<a href="#l24.102"></a><span id="l24.102">   /* destructor code */</span>
<a href="#l24.103"></a><span id="l24.103">   if (mEncryptionContext) {</span>
<a href="#l24.104"></a><span id="l24.104">     if (mBufferedBytes) {</span>
<a href="#l24.105"></a><span id="l24.105">       mEncryptionContext-&gt;Update(mBuffer, mBufferedBytes);</span>
<a href="#l24.106"></a><span id="l24.106">       mBufferedBytes = 0;</span>
<a href="#l24.107"></a><span id="l24.107">     }</span>
<a href="#l24.108"></a><span id="l24.108">     mEncryptionContext-&gt;Finish();</span>
<a href="#l24.109"></a><span id="l24.109">   }</span>
<a href="#l24.110"></a><span id="l24.110"> </span>
<a href="#l24.111"></a><span id="l24.111" class="difflineminus">-  delete [] mBuffer;</span>
<a href="#l24.112"></a><span id="l24.112" class="difflineplus">+  delete[] mBuffer;</span>
<a href="#l24.113"></a><span id="l24.113"> </span>
<a href="#l24.114"></a><span id="l24.114">   PR_FREEIF(mMultipartSignedBoundary);</span>
<a href="#l24.115"></a><span id="l24.115"> }</span>
<a href="#l24.116"></a><span id="l24.116"> </span>
<a href="#l24.117"></a><span id="l24.117" class="difflineminus">-NS_IMETHODIMP nsMsgComposeSecure::SetSignMessage(bool value)</span>
<a href="#l24.118"></a><span id="l24.118" class="difflineminus">-{</span>
<a href="#l24.119"></a><span id="l24.119" class="difflineplus">+NS_IMETHODIMP nsMsgComposeSecure::SetSignMessage(bool value) {</span>
<a href="#l24.120"></a><span id="l24.120">   mSignMessage = value;</span>
<a href="#l24.121"></a><span id="l24.121">   return NS_OK;</span>
<a href="#l24.122"></a><span id="l24.122"> }</span>
<a href="#l24.123"></a><span id="l24.123"> </span>
<a href="#l24.124"></a><span id="l24.124" class="difflineminus">-NS_IMETHODIMP nsMsgComposeSecure::GetSignMessage(bool *_retval)</span>
<a href="#l24.125"></a><span id="l24.125" class="difflineminus">-{</span>
<a href="#l24.126"></a><span id="l24.126" class="difflineplus">+NS_IMETHODIMP nsMsgComposeSecure::GetSignMessage(bool *_retval) {</span>
<a href="#l24.127"></a><span id="l24.127">   *_retval = mSignMessage;</span>
<a href="#l24.128"></a><span id="l24.128">   return NS_OK;</span>
<a href="#l24.129"></a><span id="l24.129"> }</span>
<a href="#l24.130"></a><span id="l24.130"> </span>
<a href="#l24.131"></a><span id="l24.131" class="difflineminus">-NS_IMETHODIMP nsMsgComposeSecure::SetRequireEncryptMessage(bool value)</span>
<a href="#l24.132"></a><span id="l24.132" class="difflineminus">-{</span>
<a href="#l24.133"></a><span id="l24.133" class="difflineplus">+NS_IMETHODIMP nsMsgComposeSecure::SetRequireEncryptMessage(bool value) {</span>
<a href="#l24.134"></a><span id="l24.134">   mAlwaysEncryptMessage = value;</span>
<a href="#l24.135"></a><span id="l24.135">   return NS_OK;</span>
<a href="#l24.136"></a><span id="l24.136"> }</span>
<a href="#l24.137"></a><span id="l24.137"> </span>
<a href="#l24.138"></a><span id="l24.138" class="difflineminus">-NS_IMETHODIMP nsMsgComposeSecure::GetRequireEncryptMessage(bool *_retval)</span>
<a href="#l24.139"></a><span id="l24.139" class="difflineminus">-{</span>
<a href="#l24.140"></a><span id="l24.140" class="difflineplus">+NS_IMETHODIMP nsMsgComposeSecure::GetRequireEncryptMessage(bool *_retval) {</span>
<a href="#l24.141"></a><span id="l24.141">   *_retval = mAlwaysEncryptMessage;</span>
<a href="#l24.142"></a><span id="l24.142">   return NS_OK;</span>
<a href="#l24.143"></a><span id="l24.143"> }</span>
<a href="#l24.144"></a><span id="l24.144"> </span>
<a href="#l24.145"></a><span id="l24.145" class="difflineminus">-</span>
<a href="#l24.146"></a><span id="l24.146" class="difflineminus">-NS_IMETHODIMP nsMsgComposeSecure::RequiresCryptoEncapsulation(nsIMsgIdentity * aIdentity, nsIMsgCompFields * aCompFields, bool * aRequiresEncryptionWork)</span>
<a href="#l24.147"></a><span id="l24.147" class="difflineminus">-{</span>
<a href="#l24.148"></a><span id="l24.148" class="difflineplus">+NS_IMETHODIMP nsMsgComposeSecure::RequiresCryptoEncapsulation(</span>
<a href="#l24.149"></a><span id="l24.149" class="difflineplus">+    nsIMsgIdentity *aIdentity, nsIMsgCompFields *aCompFields,</span>
<a href="#l24.150"></a><span id="l24.150" class="difflineplus">+    bool *aRequiresEncryptionWork) {</span>
<a href="#l24.151"></a><span id="l24.151">   NS_ENSURE_ARG_POINTER(aRequiresEncryptionWork);</span>
<a href="#l24.152"></a><span id="l24.152"> </span>
<a href="#l24.153"></a><span id="l24.153">   *aRequiresEncryptionWork = false;</span>
<a href="#l24.154"></a><span id="l24.154"> </span>
<a href="#l24.155"></a><span id="l24.155">   bool alwaysEncryptMessages = false;</span>
<a href="#l24.156"></a><span id="l24.156">   bool signMessage = false;</span>
<a href="#l24.157"></a><span id="l24.157" class="difflineminus">-  nsresult rv = ExtractEncryptionState(aIdentity, aCompFields, &amp;signMessage, &amp;alwaysEncryptMessages);</span>
<a href="#l24.158"></a><span id="l24.158" class="difflineplus">+  nsresult rv = ExtractEncryptionState(aIdentity, aCompFields, &amp;signMessage,</span>
<a href="#l24.159"></a><span id="l24.159" class="difflineplus">+                                       &amp;alwaysEncryptMessages);</span>
<a href="#l24.160"></a><span id="l24.160">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.161"></a><span id="l24.161"> </span>
<a href="#l24.162"></a><span id="l24.162" class="difflineminus">-  if (alwaysEncryptMessages || signMessage)</span>
<a href="#l24.163"></a><span id="l24.163" class="difflineminus">-    *aRequiresEncryptionWork = true;</span>
<a href="#l24.164"></a><span id="l24.164" class="difflineplus">+  if (alwaysEncryptMessages || signMessage) *aRequiresEncryptionWork = true;</span>
<a href="#l24.165"></a><span id="l24.165"> </span>
<a href="#l24.166"></a><span id="l24.166">   return NS_OK;</span>
<a href="#l24.167"></a><span id="l24.167"> }</span>
<a href="#l24.168"></a><span id="l24.168"> </span>
<a href="#l24.169"></a><span id="l24.169" class="difflineminus">-</span>
<a href="#l24.170"></a><span id="l24.170"> nsresult nsMsgComposeSecure::GetSMIMEBundleString(const char16_t *name,</span>
<a href="#l24.171"></a><span id="l24.171" class="difflineminus">-                                                  nsString &amp;outString)</span>
<a href="#l24.172"></a><span id="l24.172" class="difflineminus">-{</span>
<a href="#l24.173"></a><span id="l24.173" class="difflineplus">+                                                  nsString &amp;outString) {</span>
<a href="#l24.174"></a><span id="l24.174">   outString.Truncate();</span>
<a href="#l24.175"></a><span id="l24.175"> </span>
<a href="#l24.176"></a><span id="l24.176">   NS_ENSURE_ARG_POINTER(name);</span>
<a href="#l24.177"></a><span id="l24.177"> </span>
<a href="#l24.178"></a><span id="l24.178">   NS_ENSURE_TRUE(InitializeSMIMEBundle(), NS_ERROR_FAILURE);</span>
<a href="#l24.179"></a><span id="l24.179"> </span>
<a href="#l24.180"></a><span id="l24.180" class="difflineminus">-  return mSMIMEBundle-&gt;GetStringFromName(NS_ConvertUTF16toUTF8(name).get(), outString);</span>
<a href="#l24.181"></a><span id="l24.181" class="difflineplus">+  return mSMIMEBundle-&gt;GetStringFromName(NS_ConvertUTF16toUTF8(name).get(),</span>
<a href="#l24.182"></a><span id="l24.182" class="difflineplus">+                                         outString);</span>
<a href="#l24.183"></a><span id="l24.183"> }</span>
<a href="#l24.184"></a><span id="l24.184"> </span>
<a href="#l24.185"></a><span id="l24.185" class="difflineminus">-nsresult</span>
<a href="#l24.186"></a><span id="l24.186" class="difflineminus">-nsMsgComposeSecure::</span>
<a href="#l24.187"></a><span id="l24.187" class="difflineminus">-SMIMEBundleFormatStringFromName(const char *name,</span>
<a href="#l24.188"></a><span id="l24.188" class="difflineminus">-                                const char16_t **params,</span>
<a href="#l24.189"></a><span id="l24.189" class="difflineminus">-                                uint32_t numParams,</span>
<a href="#l24.190"></a><span id="l24.190" class="difflineminus">-                                nsAString&amp; outString)</span>
<a href="#l24.191"></a><span id="l24.191" class="difflineminus">-{</span>
<a href="#l24.192"></a><span id="l24.192" class="difflineplus">+nsresult nsMsgComposeSecure::SMIMEBundleFormatStringFromName(</span>
<a href="#l24.193"></a><span id="l24.193" class="difflineplus">+    const char *name, const char16_t **params, uint32_t numParams,</span>
<a href="#l24.194"></a><span id="l24.194" class="difflineplus">+    nsAString &amp;outString) {</span>
<a href="#l24.195"></a><span id="l24.195">   NS_ENSURE_ARG_POINTER(name);</span>
<a href="#l24.196"></a><span id="l24.196"> </span>
<a href="#l24.197"></a><span id="l24.197" class="difflineminus">-  if (!InitializeSMIMEBundle())</span>
<a href="#l24.198"></a><span id="l24.198" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l24.199"></a><span id="l24.199" class="difflineplus">+  if (!InitializeSMIMEBundle()) return NS_ERROR_FAILURE;</span>
<a href="#l24.200"></a><span id="l24.200"> </span>
<a href="#l24.201"></a><span id="l24.201">   return mSMIMEBundle-&gt;FormatStringFromName(name, params, numParams, outString);</span>
<a href="#l24.202"></a><span id="l24.202"> }</span>
<a href="#l24.203"></a><span id="l24.203"> </span>
<a href="#l24.204"></a><span id="l24.204" class="difflineminus">-bool nsMsgComposeSecure::InitializeSMIMEBundle()</span>
<a href="#l24.205"></a><span id="l24.205" class="difflineminus">-{</span>
<a href="#l24.206"></a><span id="l24.206" class="difflineminus">-  if (mSMIMEBundle)</span>
<a href="#l24.207"></a><span id="l24.207" class="difflineminus">-    return true;</span>
<a href="#l24.208"></a><span id="l24.208" class="difflineplus">+bool nsMsgComposeSecure::InitializeSMIMEBundle() {</span>
<a href="#l24.209"></a><span id="l24.209" class="difflineplus">+  if (mSMIMEBundle) return true;</span>
<a href="#l24.210"></a><span id="l24.210"> </span>
<a href="#l24.211"></a><span id="l24.211">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l24.212"></a><span id="l24.212" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l24.213"></a><span id="l24.213" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l24.214"></a><span id="l24.214">   nsresult rv = bundleService-&gt;CreateBundle(SMIME_STRBUNDLE_URL,</span>
<a href="#l24.215"></a><span id="l24.215">                                             getter_AddRefs(mSMIMEBundle));</span>
<a href="#l24.216"></a><span id="l24.216">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l24.217"></a><span id="l24.217"> </span>
<a href="#l24.218"></a><span id="l24.218">   return true;</span>
<a href="#l24.219"></a><span id="l24.219"> }</span>
<a href="#l24.220"></a><span id="l24.220"> </span>
<a href="#l24.221"></a><span id="l24.221" class="difflineminus">-void nsMsgComposeSecure::SetError(nsIMsgSendReport *sendReport, const char16_t *bundle_string)</span>
<a href="#l24.222"></a><span id="l24.222" class="difflineminus">-{</span>
<a href="#l24.223"></a><span id="l24.223" class="difflineminus">-  if (!sendReport || !bundle_string)</span>
<a href="#l24.224"></a><span id="l24.224" class="difflineminus">-    return;</span>
<a href="#l24.225"></a><span id="l24.225" class="difflineplus">+void nsMsgComposeSecure::SetError(nsIMsgSendReport *sendReport,</span>
<a href="#l24.226"></a><span id="l24.226" class="difflineplus">+                                  const char16_t *bundle_string) {</span>
<a href="#l24.227"></a><span id="l24.227" class="difflineplus">+  if (!sendReport || !bundle_string) return;</span>
<a href="#l24.228"></a><span id="l24.228"> </span>
<a href="#l24.229"></a><span id="l24.229" class="difflineminus">-  if (mErrorAlreadyReported)</span>
<a href="#l24.230"></a><span id="l24.230" class="difflineminus">-    return;</span>
<a href="#l24.231"></a><span id="l24.231" class="difflineplus">+  if (mErrorAlreadyReported) return;</span>
<a href="#l24.232"></a><span id="l24.232"> </span>
<a href="#l24.233"></a><span id="l24.233">   mErrorAlreadyReported = true;</span>
<a href="#l24.234"></a><span id="l24.234"> </span>
<a href="#l24.235"></a><span id="l24.235">   nsString errorString;</span>
<a href="#l24.236"></a><span id="l24.236">   nsresult res = GetSMIMEBundleString(bundle_string, errorString);</span>
<a href="#l24.237"></a><span id="l24.237" class="difflineminus">-  if (NS_SUCCEEDED(res) &amp;&amp; !errorString.IsEmpty())</span>
<a href="#l24.238"></a><span id="l24.238" class="difflineminus">-  {</span>
<a href="#l24.239"></a><span id="l24.239" class="difflineminus">-    sendReport-&gt;SetMessage(nsIMsgSendReport::process_Current,</span>
<a href="#l24.240"></a><span id="l24.240" class="difflineminus">-                           errorString.get(),</span>
<a href="#l24.241"></a><span id="l24.241" class="difflineplus">+  if (NS_SUCCEEDED(res) &amp;&amp; !errorString.IsEmpty()) {</span>
<a href="#l24.242"></a><span id="l24.242" class="difflineplus">+    sendReport-&gt;SetMessage(nsIMsgSendReport::process_Current, errorString.get(),</span>
<a href="#l24.243"></a><span id="l24.243">                            true);</span>
<a href="#l24.244"></a><span id="l24.244">   }</span>
<a href="#l24.245"></a><span id="l24.245"> }</span>
<a href="#l24.246"></a><span id="l24.246"> </span>
<a href="#l24.247"></a><span id="l24.247" class="difflineminus">-void nsMsgComposeSecure::SetErrorWithParam(nsIMsgSendReport *sendReport, const char *bundle_string, const char *param)</span>
<a href="#l24.248"></a><span id="l24.248" class="difflineminus">-{</span>
<a href="#l24.249"></a><span id="l24.249" class="difflineminus">-  if (!sendReport || !bundle_string || !param)</span>
<a href="#l24.250"></a><span id="l24.250" class="difflineminus">-    return;</span>
<a href="#l24.251"></a><span id="l24.251" class="difflineplus">+void nsMsgComposeSecure::SetErrorWithParam(nsIMsgSendReport *sendReport,</span>
<a href="#l24.252"></a><span id="l24.252" class="difflineplus">+                                           const char *bundle_string,</span>
<a href="#l24.253"></a><span id="l24.253" class="difflineplus">+                                           const char *param) {</span>
<a href="#l24.254"></a><span id="l24.254" class="difflineplus">+  if (!sendReport || !bundle_string || !param) return;</span>
<a href="#l24.255"></a><span id="l24.255"> </span>
<a href="#l24.256"></a><span id="l24.256" class="difflineminus">-  if (mErrorAlreadyReported)</span>
<a href="#l24.257"></a><span id="l24.257" class="difflineminus">-    return;</span>
<a href="#l24.258"></a><span id="l24.258" class="difflineplus">+  if (mErrorAlreadyReported) return;</span>
<a href="#l24.259"></a><span id="l24.259"> </span>
<a href="#l24.260"></a><span id="l24.260">   mErrorAlreadyReported = true;</span>
<a href="#l24.261"></a><span id="l24.261"> </span>
<a href="#l24.262"></a><span id="l24.262">   nsString errorString;</span>
<a href="#l24.263"></a><span id="l24.263">   nsresult res;</span>
<a href="#l24.264"></a><span id="l24.264">   const char16_t *params[1];</span>
<a href="#l24.265"></a><span id="l24.265"> </span>
<a href="#l24.266"></a><span id="l24.266">   NS_ConvertASCIItoUTF16 ucs2(param);</span>
<a href="#l24.267"></a><span id="l24.267" class="difflineminus">-  params[0]= ucs2.get();</span>
<a href="#l24.268"></a><span id="l24.268" class="difflineplus">+  params[0] = ucs2.get();</span>
<a href="#l24.269"></a><span id="l24.269"> </span>
<a href="#l24.270"></a><span id="l24.270" class="difflineminus">-  res = SMIMEBundleFormatStringFromName(bundle_string,</span>
<a href="#l24.271"></a><span id="l24.271" class="difflineminus">-                                        params,</span>
<a href="#l24.272"></a><span id="l24.272" class="difflineminus">-                                        1,</span>
<a href="#l24.273"></a><span id="l24.273" class="difflineminus">-                                        errorString);</span>
<a href="#l24.274"></a><span id="l24.274" class="difflineplus">+  res = SMIMEBundleFormatStringFromName(bundle_string, params, 1, errorString);</span>
<a href="#l24.275"></a><span id="l24.275"> </span>
<a href="#l24.276"></a><span id="l24.276" class="difflineminus">-  if (NS_SUCCEEDED(res) &amp;&amp; !errorString.IsEmpty())</span>
<a href="#l24.277"></a><span id="l24.277" class="difflineminus">-  {</span>
<a href="#l24.278"></a><span id="l24.278" class="difflineminus">-    sendReport-&gt;SetMessage(nsIMsgSendReport::process_Current,</span>
<a href="#l24.279"></a><span id="l24.279" class="difflineminus">-                           errorString.get(),</span>
<a href="#l24.280"></a><span id="l24.280" class="difflineplus">+  if (NS_SUCCEEDED(res) &amp;&amp; !errorString.IsEmpty()) {</span>
<a href="#l24.281"></a><span id="l24.281" class="difflineplus">+    sendReport-&gt;SetMessage(nsIMsgSendReport::process_Current, errorString.get(),</span>
<a href="#l24.282"></a><span id="l24.282">                            true);</span>
<a href="#l24.283"></a><span id="l24.283">   }</span>
<a href="#l24.284"></a><span id="l24.284"> }</span>
<a href="#l24.285"></a><span id="l24.285"> </span>
<a href="#l24.286"></a><span id="l24.286" class="difflineminus">-nsresult nsMsgComposeSecure::ExtractEncryptionState(nsIMsgIdentity * aIdentity, nsIMsgCompFields * aComposeFields, bool * aSignMessage, bool * aEncrypt)</span>
<a href="#l24.287"></a><span id="l24.287" class="difflineminus">-{</span>
<a href="#l24.288"></a><span id="l24.288" class="difflineplus">+nsresult nsMsgComposeSecure::ExtractEncryptionState(</span>
<a href="#l24.289"></a><span id="l24.289" class="difflineplus">+    nsIMsgIdentity *aIdentity, nsIMsgCompFields *aComposeFields,</span>
<a href="#l24.290"></a><span id="l24.290" class="difflineplus">+    bool *aSignMessage, bool *aEncrypt) {</span>
<a href="#l24.291"></a><span id="l24.291">   if (!aComposeFields &amp;&amp; !aIdentity)</span>
<a href="#l24.292"></a><span id="l24.292" class="difflineminus">-    return NS_ERROR_FAILURE; // kick out...invalid args....</span>
<a href="#l24.293"></a><span id="l24.293" class="difflineplus">+    return NS_ERROR_FAILURE;  // kick out...invalid args....</span>
<a href="#l24.294"></a><span id="l24.294"> </span>
<a href="#l24.295"></a><span id="l24.295">   NS_ENSURE_ARG_POINTER(aSignMessage);</span>
<a href="#l24.296"></a><span id="l24.296">   NS_ENSURE_ARG_POINTER(aEncrypt);</span>
<a href="#l24.297"></a><span id="l24.297"> </span>
<a href="#l24.298"></a><span id="l24.298">   this-&gt;GetSignMessage(aSignMessage);</span>
<a href="#l24.299"></a><span id="l24.299">   this-&gt;GetRequireEncryptMessage(aEncrypt);</span>
<a href="#l24.300"></a><span id="l24.300"> </span>
<a href="#l24.301"></a><span id="l24.301">   return NS_OK;</span>
<a href="#l24.302"></a><span id="l24.302"> }</span>
<a href="#l24.303"></a><span id="l24.303"> </span>
<a href="#l24.304"></a><span id="l24.304"> // Select a hash algorithm to sign message</span>
<a href="#l24.305"></a><span id="l24.305"> // based on subject public key type and size.</span>
<a href="#l24.306"></a><span id="l24.306" class="difflineminus">-static nsresult</span>
<a href="#l24.307"></a><span id="l24.307" class="difflineminus">-GetSigningHashFunction(nsIX509Cert *aSigningCert, int16_t *hashType)</span>
<a href="#l24.308"></a><span id="l24.308" class="difflineminus">-{</span>
<a href="#l24.309"></a><span id="l24.309" class="difflineplus">+static nsresult GetSigningHashFunction(nsIX509Cert *aSigningCert,</span>
<a href="#l24.310"></a><span id="l24.310" class="difflineplus">+                                       int16_t *hashType) {</span>
<a href="#l24.311"></a><span id="l24.311">   // Get the signing certificate</span>
<a href="#l24.312"></a><span id="l24.312">   CERTCertificate *scert = nullptr;</span>
<a href="#l24.313"></a><span id="l24.313">   if (aSigningCert) {</span>
<a href="#l24.314"></a><span id="l24.314">     scert = aSigningCert-&gt;GetCert();</span>
<a href="#l24.315"></a><span id="l24.315">   }</span>
<a href="#l24.316"></a><span id="l24.316">   if (!scert) {</span>
<a href="#l24.317"></a><span id="l24.317">     return NS_ERROR_FAILURE;</span>
<a href="#l24.318"></a><span id="l24.318">   }</span>
<a href="#l24.319"></a><span id="l24.319" class="difflineat">@@ -322,56 +291,55 @@ GetSigningHashFunction(nsIX509Cert *aSig</span>
<a href="#l24.320"></a><span id="l24.320">   } else if (subjectPublicKeyType == dsaKey) {</span>
<a href="#l24.321"></a><span id="l24.321">     // For DSA, siglen is twice the length of the q parameter of the key.</span>
<a href="#l24.322"></a><span id="l24.322">     // The security strength of the key is half the length (in bits) of</span>
<a href="#l24.323"></a><span id="l24.323">     // the q parameter of the key.</span>
<a href="#l24.324"></a><span id="l24.324"> </span>
<a href="#l24.325"></a><span id="l24.325">     // NSS only supports SHA-1, SHA-224, and SHA-256 for DSA signatures.</span>
<a href="#l24.326"></a><span id="l24.326">     // The S/MIME code does not support SHA-224.</span>
<a href="#l24.327"></a><span id="l24.327"> </span>
<a href="#l24.328"></a><span id="l24.328" class="difflineminus">-    if (siglen &gt;= 512) { // 512-bit signature = 256-bit q parameter</span>
<a href="#l24.329"></a><span id="l24.329" class="difflineplus">+    if (siglen &gt;= 512) {  // 512-bit signature = 256-bit q parameter</span>
<a href="#l24.330"></a><span id="l24.330">       *hashType = nsICryptoHash::SHA256;</span>
<a href="#l24.331"></a><span id="l24.331">     } else {</span>
<a href="#l24.332"></a><span id="l24.332">       *hashType = nsICryptoHash::SHA1;</span>
<a href="#l24.333"></a><span id="l24.333">     }</span>
<a href="#l24.334"></a><span id="l24.334">   } else if (subjectPublicKeyType == ecKey) {</span>
<a href="#l24.335"></a><span id="l24.335">     // For ECDSA, siglen is twice the length of the field size. The security</span>
<a href="#l24.336"></a><span id="l24.336">     // strength of the key is half the length (in bits) of the field size.</span>
<a href="#l24.337"></a><span id="l24.337"> </span>
<a href="#l24.338"></a><span id="l24.338" class="difflineminus">-    if (siglen &gt;= 1024) { // 1024-bit signature = 512-bit field size</span>
<a href="#l24.339"></a><span id="l24.339" class="difflineplus">+    if (siglen &gt;= 1024) {  // 1024-bit signature = 512-bit field size</span>
<a href="#l24.340"></a><span id="l24.340">       *hashType = nsICryptoHash::SHA512;</span>
<a href="#l24.341"></a><span id="l24.341" class="difflineminus">-    } else if (siglen &gt;= 768) { // 768-bit signature = 384-bit field size</span>
<a href="#l24.342"></a><span id="l24.342" class="difflineplus">+    } else if (siglen &gt;= 768) {  // 768-bit signature = 384-bit field size</span>
<a href="#l24.343"></a><span id="l24.343">       *hashType = nsICryptoHash::SHA384;</span>
<a href="#l24.344"></a><span id="l24.344" class="difflineminus">-    } else if (siglen &gt;= 512) { // 512-bit signature = 256-bit field size</span>
<a href="#l24.345"></a><span id="l24.345" class="difflineplus">+    } else if (siglen &gt;= 512) {  // 512-bit signature = 256-bit field size</span>
<a href="#l24.346"></a><span id="l24.346">       *hashType = nsICryptoHash::SHA256;</span>
<a href="#l24.347"></a><span id="l24.347">     } else {</span>
<a href="#l24.348"></a><span id="l24.348">       *hashType = nsICryptoHash::SHA1;</span>
<a href="#l24.349"></a><span id="l24.349">     }</span>
<a href="#l24.350"></a><span id="l24.350">   } else {</span>
<a href="#l24.351"></a><span id="l24.351">     // Unknown key type</span>
<a href="#l24.352"></a><span id="l24.352">     *hashType = nsICryptoHash::SHA256;</span>
<a href="#l24.353"></a><span id="l24.353">     NS_WARNING(&quot;GetSigningHashFunction: Subject public key type unknown.&quot;);</span>
<a href="#l24.354"></a><span id="l24.354">   }</span>
<a href="#l24.355"></a><span id="l24.355">   return NS_OK;</span>
<a href="#l24.356"></a><span id="l24.356"> }</span>
<a href="#l24.357"></a><span id="l24.357"> </span>
<a href="#l24.358"></a><span id="l24.358" class="difflineminus">-/* void beginCryptoEncapsulation (in nsOutputFileStream aStream, in boolean aEncrypt, in boolean aSign, in string aRecipeints, in boolean aIsDraft); */</span>
<a href="#l24.359"></a><span id="l24.359" class="difflineminus">-NS_IMETHODIMP nsMsgComposeSecure::BeginCryptoEncapsulation(nsIOutputStream * aStream,</span>
<a href="#l24.360"></a><span id="l24.360" class="difflineminus">-                                                           const char * aRecipients,</span>
<a href="#l24.361"></a><span id="l24.361" class="difflineminus">-                                                           nsIMsgCompFields * aCompFields,</span>
<a href="#l24.362"></a><span id="l24.362" class="difflineminus">-                                                           nsIMsgIdentity * aIdentity,</span>
<a href="#l24.363"></a><span id="l24.363" class="difflineminus">-                                                           nsIMsgSendReport *sendReport,</span>
<a href="#l24.364"></a><span id="l24.364" class="difflineminus">-                                                           bool aIsDraft)</span>
<a href="#l24.365"></a><span id="l24.365" class="difflineminus">-{</span>
<a href="#l24.366"></a><span id="l24.366" class="difflineplus">+/* void beginCryptoEncapsulation (in nsOutputFileStream aStream, in boolean</span>
<a href="#l24.367"></a><span id="l24.367" class="difflineplus">+ * aEncrypt, in boolean aSign, in string aRecipeints, in boolean aIsDraft); */</span>
<a href="#l24.368"></a><span id="l24.368" class="difflineplus">+NS_IMETHODIMP nsMsgComposeSecure::BeginCryptoEncapsulation(</span>
<a href="#l24.369"></a><span id="l24.369" class="difflineplus">+    nsIOutputStream *aStream, const char *aRecipients,</span>
<a href="#l24.370"></a><span id="l24.370" class="difflineplus">+    nsIMsgCompFields *aCompFields, nsIMsgIdentity *aIdentity,</span>
<a href="#l24.371"></a><span id="l24.371" class="difflineplus">+    nsIMsgSendReport *sendReport, bool aIsDraft) {</span>
<a href="#l24.372"></a><span id="l24.372">   mErrorAlreadyReported = false;</span>
<a href="#l24.373"></a><span id="l24.373">   nsresult rv = NS_OK;</span>
<a href="#l24.374"></a><span id="l24.374"> </span>
<a href="#l24.375"></a><span id="l24.375">   bool encryptMessages = false;</span>
<a href="#l24.376"></a><span id="l24.376">   bool signMessage = false;</span>
<a href="#l24.377"></a><span id="l24.377" class="difflineminus">-  ExtractEncryptionState(aIdentity, aCompFields, &amp;signMessage, &amp;encryptMessages);</span>
<a href="#l24.378"></a><span id="l24.378" class="difflineplus">+  ExtractEncryptionState(aIdentity, aCompFields, &amp;signMessage,</span>
<a href="#l24.379"></a><span id="l24.379" class="difflineplus">+                         &amp;encryptMessages);</span>
<a href="#l24.380"></a><span id="l24.380"> </span>
<a href="#l24.381"></a><span id="l24.381">   if (!signMessage &amp;&amp; !encryptMessages) return NS_ERROR_FAILURE;</span>
<a href="#l24.382"></a><span id="l24.382"> </span>
<a href="#l24.383"></a><span id="l24.383">   mStream = aStream;</span>
<a href="#l24.384"></a><span id="l24.384">   mIsDraft = aIsDraft;</span>
<a href="#l24.385"></a><span id="l24.385"> </span>
<a href="#l24.386"></a><span id="l24.386">   if (encryptMessages &amp;&amp; signMessage)</span>
<a href="#l24.387"></a><span id="l24.387">     mCryptoState = mime_crypto_signed_encrypted;</span>
<a href="#l24.388"></a><span id="l24.388" class="difflineat">@@ -382,171 +350,167 @@ NS_IMETHODIMP nsMsgComposeSecure::BeginC</span>
<a href="#l24.389"></a><span id="l24.389">   else</span>
<a href="#l24.390"></a><span id="l24.390">     PR_ASSERT(0);</span>
<a href="#l24.391"></a><span id="l24.391"> </span>
<a href="#l24.392"></a><span id="l24.392">   aIdentity-&gt;GetUnicharAttribute(&quot;signing_cert_name&quot;, mSigningCertName);</span>
<a href="#l24.393"></a><span id="l24.393">   aIdentity-&gt;GetCharAttribute(&quot;signing_cert_dbkey&quot;, mSigningCertDBKey);</span>
<a href="#l24.394"></a><span id="l24.394">   aIdentity-&gt;GetUnicharAttribute(&quot;encryption_cert_name&quot;, mEncryptionCertName);</span>
<a href="#l24.395"></a><span id="l24.395">   aIdentity-&gt;GetCharAttribute(&quot;encryption_cert_dbkey&quot;, mEncryptionCertDBKey);</span>
<a href="#l24.396"></a><span id="l24.396"> </span>
<a href="#l24.397"></a><span id="l24.397" class="difflineminus">-  rv = MimeCryptoHackCerts(aRecipients, sendReport, encryptMessages, signMessage, aIdentity);</span>
<a href="#l24.398"></a><span id="l24.398" class="difflineplus">+  rv = MimeCryptoHackCerts(aRecipients, sendReport, encryptMessages,</span>
<a href="#l24.399"></a><span id="l24.399" class="difflineplus">+                           signMessage, aIdentity);</span>
<a href="#l24.400"></a><span id="l24.400">   if (NS_FAILED(rv)) {</span>
<a href="#l24.401"></a><span id="l24.401">     goto FAIL;</span>
<a href="#l24.402"></a><span id="l24.402">   }</span>
<a href="#l24.403"></a><span id="l24.403"> </span>
<a href="#l24.404"></a><span id="l24.404">   if (signMessage &amp;&amp; mSelfSigningCert) {</span>
<a href="#l24.405"></a><span id="l24.405">     rv = GetSigningHashFunction(mSelfSigningCert, &amp;mHashType);</span>
<a href="#l24.406"></a><span id="l24.406">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.407"></a><span id="l24.407">   }</span>
<a href="#l24.408"></a><span id="l24.408"> </span>
<a href="#l24.409"></a><span id="l24.409" class="difflineminus">-  switch (mCryptoState)</span>
<a href="#l24.410"></a><span id="l24.410" class="difflineminus">-  {</span>
<a href="#l24.411"></a><span id="l24.411" class="difflineminus">-  case mime_crypto_clear_signed:</span>
<a href="#l24.412"></a><span id="l24.412" class="difflineminus">-    rv = MimeInitMultipartSigned(true, sendReport);</span>
<a href="#l24.413"></a><span id="l24.413" class="difflineminus">-    break;</span>
<a href="#l24.414"></a><span id="l24.414" class="difflineminus">-  case mime_crypto_opaque_signed:</span>
<a href="#l24.415"></a><span id="l24.415" class="difflineminus">-    PR_ASSERT(0);    /* #### no api for this yet */</span>
<a href="#l24.416"></a><span id="l24.416" class="difflineminus">-    rv = NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l24.417"></a><span id="l24.417" class="difflineminus">-    break;</span>
<a href="#l24.418"></a><span id="l24.418" class="difflineminus">-  case mime_crypto_signed_encrypted:</span>
<a href="#l24.419"></a><span id="l24.419" class="difflineminus">-    rv = MimeInitEncryption(true, sendReport);</span>
<a href="#l24.420"></a><span id="l24.420" class="difflineminus">-    break;</span>
<a href="#l24.421"></a><span id="l24.421" class="difflineminus">-  case mime_crypto_encrypted:</span>
<a href="#l24.422"></a><span id="l24.422" class="difflineminus">-    rv = MimeInitEncryption(false, sendReport);</span>
<a href="#l24.423"></a><span id="l24.423" class="difflineminus">-    break;</span>
<a href="#l24.424"></a><span id="l24.424" class="difflineminus">-  case mime_crypto_none:</span>
<a href="#l24.425"></a><span id="l24.425" class="difflineminus">-    /* This can happen if mime_crypto_hack_certs() decided to turn off</span>
<a href="#l24.426"></a><span id="l24.426" class="difflineminus">-     encryption (by asking the user.) */</span>
<a href="#l24.427"></a><span id="l24.427" class="difflineminus">-    // XXX 1 is not a valid nsresult</span>
<a href="#l24.428"></a><span id="l24.428" class="difflineminus">-    rv = static_cast&lt;nsresult&gt;(1);</span>
<a href="#l24.429"></a><span id="l24.429" class="difflineminus">-    break;</span>
<a href="#l24.430"></a><span id="l24.430" class="difflineminus">-  default:</span>
<a href="#l24.431"></a><span id="l24.431" class="difflineminus">-    PR_ASSERT(0);</span>
<a href="#l24.432"></a><span id="l24.432" class="difflineminus">-    break;</span>
<a href="#l24.433"></a><span id="l24.433" class="difflineplus">+  switch (mCryptoState) {</span>
<a href="#l24.434"></a><span id="l24.434" class="difflineplus">+    case mime_crypto_clear_signed:</span>
<a href="#l24.435"></a><span id="l24.435" class="difflineplus">+      rv = MimeInitMultipartSigned(true, sendReport);</span>
<a href="#l24.436"></a><span id="l24.436" class="difflineplus">+      break;</span>
<a href="#l24.437"></a><span id="l24.437" class="difflineplus">+    case mime_crypto_opaque_signed:</span>
<a href="#l24.438"></a><span id="l24.438" class="difflineplus">+      PR_ASSERT(0); /* #### no api for this yet */</span>
<a href="#l24.439"></a><span id="l24.439" class="difflineplus">+      rv = NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l24.440"></a><span id="l24.440" class="difflineplus">+      break;</span>
<a href="#l24.441"></a><span id="l24.441" class="difflineplus">+    case mime_crypto_signed_encrypted:</span>
<a href="#l24.442"></a><span id="l24.442" class="difflineplus">+      rv = MimeInitEncryption(true, sendReport);</span>
<a href="#l24.443"></a><span id="l24.443" class="difflineplus">+      break;</span>
<a href="#l24.444"></a><span id="l24.444" class="difflineplus">+    case mime_crypto_encrypted:</span>
<a href="#l24.445"></a><span id="l24.445" class="difflineplus">+      rv = MimeInitEncryption(false, sendReport);</span>
<a href="#l24.446"></a><span id="l24.446" class="difflineplus">+      break;</span>
<a href="#l24.447"></a><span id="l24.447" class="difflineplus">+    case mime_crypto_none:</span>
<a href="#l24.448"></a><span id="l24.448" class="difflineplus">+      /* This can happen if mime_crypto_hack_certs() decided to turn off</span>
<a href="#l24.449"></a><span id="l24.449" class="difflineplus">+       encryption (by asking the user.) */</span>
<a href="#l24.450"></a><span id="l24.450" class="difflineplus">+      // XXX 1 is not a valid nsresult</span>
<a href="#l24.451"></a><span id="l24.451" class="difflineplus">+      rv = static_cast&lt;nsresult&gt;(1);</span>
<a href="#l24.452"></a><span id="l24.452" class="difflineplus">+      break;</span>
<a href="#l24.453"></a><span id="l24.453" class="difflineplus">+    default:</span>
<a href="#l24.454"></a><span id="l24.454" class="difflineplus">+      PR_ASSERT(0);</span>
<a href="#l24.455"></a><span id="l24.455" class="difflineplus">+      break;</span>
<a href="#l24.456"></a><span id="l24.456">   }</span>
<a href="#l24.457"></a><span id="l24.457"> </span>
<a href="#l24.458"></a><span id="l24.458"> FAIL:</span>
<a href="#l24.459"></a><span id="l24.459">   return rv;</span>
<a href="#l24.460"></a><span id="l24.460"> }</span>
<a href="#l24.461"></a><span id="l24.461"> </span>
<a href="#l24.462"></a><span id="l24.462"> /* void finishCryptoEncapsulation (in boolean aAbort); */</span>
<a href="#l24.463"></a><span id="l24.463" class="difflineminus">-NS_IMETHODIMP nsMsgComposeSecure::FinishCryptoEncapsulation(bool aAbort, nsIMsgSendReport *sendReport)</span>
<a href="#l24.464"></a><span id="l24.464" class="difflineminus">-{</span>
<a href="#l24.465"></a><span id="l24.465" class="difflineplus">+NS_IMETHODIMP nsMsgComposeSecure::FinishCryptoEncapsulation(</span>
<a href="#l24.466"></a><span id="l24.466" class="difflineplus">+    bool aAbort, nsIMsgSendReport *sendReport) {</span>
<a href="#l24.467"></a><span id="l24.467">   nsresult rv = NS_OK;</span>
<a href="#l24.468"></a><span id="l24.468"> </span>
<a href="#l24.469"></a><span id="l24.469">   if (!aAbort) {</span>
<a href="#l24.470"></a><span id="l24.470">     switch (mCryptoState) {</span>
<a href="#l24.471"></a><span id="l24.471" class="difflineminus">-    case mime_crypto_clear_signed:</span>
<a href="#l24.472"></a><span id="l24.472" class="difflineminus">-      rv = MimeFinishMultipartSigned (true, sendReport);</span>
<a href="#l24.473"></a><span id="l24.473" class="difflineminus">-      break;</span>
<a href="#l24.474"></a><span id="l24.474" class="difflineminus">-    case mime_crypto_opaque_signed:</span>
<a href="#l24.475"></a><span id="l24.475" class="difflineminus">-      PR_ASSERT(0);    /* #### no api for this yet */</span>
<a href="#l24.476"></a><span id="l24.476" class="difflineminus">-      rv = NS_ERROR_FAILURE;</span>
<a href="#l24.477"></a><span id="l24.477" class="difflineminus">-      break;</span>
<a href="#l24.478"></a><span id="l24.478" class="difflineminus">-    case mime_crypto_signed_encrypted:</span>
<a href="#l24.479"></a><span id="l24.479" class="difflineminus">-      rv = MimeFinishEncryption (true, sendReport);</span>
<a href="#l24.480"></a><span id="l24.480" class="difflineminus">-      break;</span>
<a href="#l24.481"></a><span id="l24.481" class="difflineminus">-    case mime_crypto_encrypted:</span>
<a href="#l24.482"></a><span id="l24.482" class="difflineminus">-      rv = MimeFinishEncryption (false, sendReport);</span>
<a href="#l24.483"></a><span id="l24.483" class="difflineminus">-      break;</span>
<a href="#l24.484"></a><span id="l24.484" class="difflineminus">-    default:</span>
<a href="#l24.485"></a><span id="l24.485" class="difflineminus">-      PR_ASSERT(0);</span>
<a href="#l24.486"></a><span id="l24.486" class="difflineminus">-      rv = NS_ERROR_FAILURE;</span>
<a href="#l24.487"></a><span id="l24.487" class="difflineminus">-      break;</span>
<a href="#l24.488"></a><span id="l24.488" class="difflineplus">+      case mime_crypto_clear_signed:</span>
<a href="#l24.489"></a><span id="l24.489" class="difflineplus">+        rv = MimeFinishMultipartSigned(true, sendReport);</span>
<a href="#l24.490"></a><span id="l24.490" class="difflineplus">+        break;</span>
<a href="#l24.491"></a><span id="l24.491" class="difflineplus">+      case mime_crypto_opaque_signed:</span>
<a href="#l24.492"></a><span id="l24.492" class="difflineplus">+        PR_ASSERT(0); /* #### no api for this yet */</span>
<a href="#l24.493"></a><span id="l24.493" class="difflineplus">+        rv = NS_ERROR_FAILURE;</span>
<a href="#l24.494"></a><span id="l24.494" class="difflineplus">+        break;</span>
<a href="#l24.495"></a><span id="l24.495" class="difflineplus">+      case mime_crypto_signed_encrypted:</span>
<a href="#l24.496"></a><span id="l24.496" class="difflineplus">+        rv = MimeFinishEncryption(true, sendReport);</span>
<a href="#l24.497"></a><span id="l24.497" class="difflineplus">+        break;</span>
<a href="#l24.498"></a><span id="l24.498" class="difflineplus">+      case mime_crypto_encrypted:</span>
<a href="#l24.499"></a><span id="l24.499" class="difflineplus">+        rv = MimeFinishEncryption(false, sendReport);</span>
<a href="#l24.500"></a><span id="l24.500" class="difflineplus">+        break;</span>
<a href="#l24.501"></a><span id="l24.501" class="difflineplus">+      default:</span>
<a href="#l24.502"></a><span id="l24.502" class="difflineplus">+        PR_ASSERT(0);</span>
<a href="#l24.503"></a><span id="l24.503" class="difflineplus">+        rv = NS_ERROR_FAILURE;</span>
<a href="#l24.504"></a><span id="l24.504" class="difflineplus">+        break;</span>
<a href="#l24.505"></a><span id="l24.505">     }</span>
<a href="#l24.506"></a><span id="l24.506">   }</span>
<a href="#l24.507"></a><span id="l24.507">   return rv;</span>
<a href="#l24.508"></a><span id="l24.508"> }</span>
<a href="#l24.509"></a><span id="l24.509"> </span>
<a href="#l24.510"></a><span id="l24.510" class="difflineminus">-nsresult nsMsgComposeSecure::MimeInitMultipartSigned(bool aOuter, nsIMsgSendReport *sendReport)</span>
<a href="#l24.511"></a><span id="l24.511" class="difflineminus">-{</span>
<a href="#l24.512"></a><span id="l24.512" class="difflineplus">+nsresult nsMsgComposeSecure::MimeInitMultipartSigned(</span>
<a href="#l24.513"></a><span id="l24.513" class="difflineplus">+    bool aOuter, nsIMsgSendReport *sendReport) {</span>
<a href="#l24.514"></a><span id="l24.514">   /* First, construct and write out the multipart/signed MIME header data.</span>
<a href="#l24.515"></a><span id="l24.515">    */</span>
<a href="#l24.516"></a><span id="l24.516">   nsresult rv = NS_OK;</span>
<a href="#l24.517"></a><span id="l24.517">   char *header = 0;</span>
<a href="#l24.518"></a><span id="l24.518">   uint32_t L;</span>
<a href="#l24.519"></a><span id="l24.519"> </span>
<a href="#l24.520"></a><span id="l24.520" class="difflineminus">-  rv = make_multipart_signed_header_string(aOuter, &amp;header,</span>
<a href="#l24.521"></a><span id="l24.521" class="difflineminus">-    &amp;mMultipartSignedBoundary, mHashType);</span>
<a href="#l24.522"></a><span id="l24.522" class="difflineplus">+  rv = make_multipart_signed_header_string(</span>
<a href="#l24.523"></a><span id="l24.523" class="difflineplus">+      aOuter, &amp;header, &amp;mMultipartSignedBoundary, mHashType);</span>
<a href="#l24.524"></a><span id="l24.524"> </span>
<a href="#l24.525"></a><span id="l24.525">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.526"></a><span id="l24.526"> </span>
<a href="#l24.527"></a><span id="l24.527">   L = strlen(header);</span>
<a href="#l24.528"></a><span id="l24.528"> </span>
<a href="#l24.529"></a><span id="l24.529" class="difflineminus">-  if (aOuter){</span>
<a href="#l24.530"></a><span id="l24.530" class="difflineplus">+  if (aOuter) {</span>
<a href="#l24.531"></a><span id="l24.531">     /* If this is the outer block, write it to the file. */</span>
<a href="#l24.532"></a><span id="l24.532">     uint32_t n;</span>
<a href="#l24.533"></a><span id="l24.533">     rv = mStream-&gt;Write(header, L, &amp;n);</span>
<a href="#l24.534"></a><span id="l24.534">     if (NS_FAILED(rv) || n &lt; L) {</span>
<a href="#l24.535"></a><span id="l24.535">       // XXX This is -1, not an nsresult</span>
<a href="#l24.536"></a><span id="l24.536">       rv = static_cast&lt;nsresult&gt;(MK_MIME_ERROR_WRITING_FILE);</span>
<a href="#l24.537"></a><span id="l24.537">     }</span>
<a href="#l24.538"></a><span id="l24.538">   } else {</span>
<a href="#l24.539"></a><span id="l24.539">     /* If this is an inner block, feed it through the crypto stream. */</span>
<a href="#l24.540"></a><span id="l24.540" class="difflineminus">-    rv = MimeCryptoWriteBlock (header, L);</span>
<a href="#l24.541"></a><span id="l24.541" class="difflineplus">+    rv = MimeCryptoWriteBlock(header, L);</span>
<a href="#l24.542"></a><span id="l24.542">   }</span>
<a href="#l24.543"></a><span id="l24.543"> </span>
<a href="#l24.544"></a><span id="l24.544">   PR_Free(header);</span>
<a href="#l24.545"></a><span id="l24.545">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.546"></a><span id="l24.546"> </span>
<a href="#l24.547"></a><span id="l24.547">   /* Now initialize the crypto library, so that we can compute a hash</span>
<a href="#l24.548"></a><span id="l24.548">    on the object which we are signing.</span>
<a href="#l24.549"></a><span id="l24.549">    */</span>
<a href="#l24.550"></a><span id="l24.550"> </span>
<a href="#l24.551"></a><span id="l24.551" class="difflineminus">-  PR_SetError(0,0);</span>
<a href="#l24.552"></a><span id="l24.552" class="difflineplus">+  PR_SetError(0, 0);</span>
<a href="#l24.553"></a><span id="l24.553">   mDataHash = do_CreateInstance(&quot;@mozilla.org/security/hash;1&quot;, &amp;rv);</span>
<a href="#l24.554"></a><span id="l24.554">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.555"></a><span id="l24.555"> </span>
<a href="#l24.556"></a><span id="l24.556">   rv = mDataHash-&gt;Init(mHashType);</span>
<a href="#l24.557"></a><span id="l24.557">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.558"></a><span id="l24.558"> </span>
<a href="#l24.559"></a><span id="l24.559" class="difflineminus">-  PR_SetError(0,0);</span>
<a href="#l24.560"></a><span id="l24.560" class="difflineplus">+  PR_SetError(0, 0);</span>
<a href="#l24.561"></a><span id="l24.561">   return rv;</span>
<a href="#l24.562"></a><span id="l24.562"> }</span>
<a href="#l24.563"></a><span id="l24.563"> </span>
<a href="#l24.564"></a><span id="l24.564" class="difflineminus">-nsresult nsMsgComposeSecure::MimeInitEncryption(bool aSign, nsIMsgSendReport *sendReport)</span>
<a href="#l24.565"></a><span id="l24.565" class="difflineminus">-{</span>
<a href="#l24.566"></a><span id="l24.566" class="difflineplus">+nsresult nsMsgComposeSecure::MimeInitEncryption(bool aSign,</span>
<a href="#l24.567"></a><span id="l24.567" class="difflineplus">+                                                nsIMsgSendReport *sendReport) {</span>
<a href="#l24.568"></a><span id="l24.568">   nsresult rv;</span>
<a href="#l24.569"></a><span id="l24.569">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleSvc =</span>
<a href="#l24.570"></a><span id="l24.570" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l24.571"></a><span id="l24.571" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l24.572"></a><span id="l24.572">   NS_ENSURE_TRUE(bundleSvc, NS_ERROR_UNEXPECTED);</span>
<a href="#l24.573"></a><span id="l24.573"> </span>
<a href="#l24.574"></a><span id="l24.574">   nsCOMPtr&lt;nsIStringBundle&gt; sMIMEBundle;</span>
<a href="#l24.575"></a><span id="l24.575">   nsString mime_smime_enc_content_desc;</span>
<a href="#l24.576"></a><span id="l24.576"> </span>
<a href="#l24.577"></a><span id="l24.577">   bundleSvc-&gt;CreateBundle(SMIME_STRBUNDLE_URL, getter_AddRefs(sMIMEBundle));</span>
<a href="#l24.578"></a><span id="l24.578"> </span>
<a href="#l24.579"></a><span id="l24.579" class="difflineminus">-  if (!sMIMEBundle)</span>
<a href="#l24.580"></a><span id="l24.580" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l24.581"></a><span id="l24.581" class="difflineplus">+  if (!sMIMEBundle) return NS_ERROR_FAILURE;</span>
<a href="#l24.582"></a><span id="l24.582"> </span>
<a href="#l24.583"></a><span id="l24.583">   sMIMEBundle-&gt;GetStringFromName(&quot;mime_smimeEncryptedContentDesc&quot;,</span>
<a href="#l24.584"></a><span id="l24.584">                                  mime_smime_enc_content_desc);</span>
<a href="#l24.585"></a><span id="l24.585">   NS_ConvertUTF16toUTF8 enc_content_desc_utf8(mime_smime_enc_content_desc);</span>
<a href="#l24.586"></a><span id="l24.586"> </span>
<a href="#l24.587"></a><span id="l24.587">   nsCOMPtr&lt;nsIMimeConverter&gt; mimeConverter =</span>
<a href="#l24.588"></a><span id="l24.588" class="difflineminus">-     do_GetService(NS_MIME_CONVERTER_CONTRACTID, &amp;rv);</span>
<a href="#l24.589"></a><span id="l24.589" class="difflineplus">+      do_GetService(NS_MIME_CONVERTER_CONTRACTID, &amp;rv);</span>
<a href="#l24.590"></a><span id="l24.590">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.591"></a><span id="l24.591">   nsCString encodedContentDescription;</span>
<a href="#l24.592"></a><span id="l24.592" class="difflineminus">-  mimeConverter-&gt;EncodeMimePartIIStr_UTF8(enc_content_desc_utf8, false,</span>
<a href="#l24.593"></a><span id="l24.593" class="difflineminus">-      sizeof(&quot;Content-Description: &quot;),</span>
<a href="#l24.594"></a><span id="l24.594" class="difflineminus">-      nsIMimeConverter::MIME_ENCODED_WORD_SIZE,</span>
<a href="#l24.595"></a><span id="l24.595" class="difflineminus">-      encodedContentDescription);</span>
<a href="#l24.596"></a><span id="l24.596" class="difflineplus">+  mimeConverter-&gt;EncodeMimePartIIStr_UTF8(</span>
<a href="#l24.597"></a><span id="l24.597" class="difflineplus">+      enc_content_desc_utf8, false, sizeof(&quot;Content-Description: &quot;),</span>
<a href="#l24.598"></a><span id="l24.598" class="difflineplus">+      nsIMimeConverter::MIME_ENCODED_WORD_SIZE, encodedContentDescription);</span>
<a href="#l24.599"></a><span id="l24.599"> </span>
<a href="#l24.600"></a><span id="l24.600">   /* First, construct and write out the opaque-crypto-blob MIME header data.</span>
<a href="#l24.601"></a><span id="l24.601">    */</span>
<a href="#l24.602"></a><span id="l24.602"> </span>
<a href="#l24.603"></a><span id="l24.603" class="difflineminus">-  char *s =</span>
<a href="#l24.604"></a><span id="l24.604" class="difflineminus">-  PR_smprintf(&quot;Content-Type: &quot; APPLICATION_PKCS7_MIME</span>
<a href="#l24.605"></a><span id="l24.605" class="difflineminus">-          &quot;; name=\&quot;smime.p7m\&quot;; smime-type=enveloped-data&quot; CRLF</span>
<a href="#l24.606"></a><span id="l24.606" class="difflineminus">-        &quot;Content-Transfer-Encoding: &quot; ENCODING_BASE64 CRLF</span>
<a href="#l24.607"></a><span id="l24.607" class="difflineminus">-        &quot;Content-Disposition: attachment&quot;</span>
<a href="#l24.608"></a><span id="l24.608" class="difflineminus">-          &quot;; filename=\&quot;smime.p7m\&quot;&quot; CRLF</span>
<a href="#l24.609"></a><span id="l24.609" class="difflineminus">-        &quot;Content-Description: %s&quot; CRLF</span>
<a href="#l24.610"></a><span id="l24.610" class="difflineminus">-        CRLF,</span>
<a href="#l24.611"></a><span id="l24.611" class="difflineminus">-        encodedContentDescription.get());</span>
<a href="#l24.612"></a><span id="l24.612" class="difflineplus">+  char *s = PR_smprintf(&quot;Content-Type: &quot; APPLICATION_PKCS7_MIME</span>
<a href="#l24.613"></a><span id="l24.613" class="difflineplus">+                        &quot;; name=\&quot;smime.p7m\&quot;; smime-type=enveloped-data&quot; CRLF</span>
<a href="#l24.614"></a><span id="l24.614" class="difflineplus">+                        &quot;Content-Transfer-Encoding: &quot; ENCODING_BASE64 CRLF</span>
<a href="#l24.615"></a><span id="l24.615" class="difflineplus">+                        &quot;Content-Disposition: attachment&quot;</span>
<a href="#l24.616"></a><span id="l24.616" class="difflineplus">+                        &quot;; filename=\&quot;smime.p7m\&quot;&quot; CRLF</span>
<a href="#l24.617"></a><span id="l24.617" class="difflineplus">+                        &quot;Content-Description: %s&quot; CRLF CRLF,</span>
<a href="#l24.618"></a><span id="l24.618" class="difflineplus">+                        encodedContentDescription.get());</span>
<a href="#l24.619"></a><span id="l24.619"> </span>
<a href="#l24.620"></a><span id="l24.620">   uint32_t L;</span>
<a href="#l24.621"></a><span id="l24.621">   if (!s) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l24.622"></a><span id="l24.622">   L = strlen(s);</span>
<a href="#l24.623"></a><span id="l24.623">   uint32_t n;</span>
<a href="#l24.624"></a><span id="l24.624">   rv = mStream-&gt;Write(s, L, &amp;n);</span>
<a href="#l24.625"></a><span id="l24.625">   if (NS_FAILED(rv) || n &lt; L) {</span>
<a href="#l24.626"></a><span id="l24.626">     return NS_ERROR_FAILURE;</span>
<a href="#l24.627"></a><span id="l24.627" class="difflineat">@@ -562,81 +526,81 @@ nsresult nsMsgComposeSecure::MimeInitEnc</span>
<a href="#l24.628"></a><span id="l24.628">     uint32_t numCerts;</span>
<a href="#l24.629"></a><span id="l24.629">     mCerts-&gt;GetLength(&amp;numCerts);</span>
<a href="#l24.630"></a><span id="l24.630">     PR_ASSERT(numCerts &gt; 0);</span>
<a href="#l24.631"></a><span id="l24.631">     if (numCerts == 0) return NS_ERROR_FAILURE;</span>
<a href="#l24.632"></a><span id="l24.632">   }</span>
<a href="#l24.633"></a><span id="l24.633"> </span>
<a href="#l24.634"></a><span id="l24.634">   // Initialize the base64 encoder</span>
<a href="#l24.635"></a><span id="l24.635">   MOZ_ASSERT(!mCryptoEncoder, &quot;Shouldn't have an encoder already&quot;);</span>
<a href="#l24.636"></a><span id="l24.636" class="difflineminus">-  mCryptoEncoder = MimeEncoder::GetBase64Encoder(mime_encoder_output_fn,</span>
<a href="#l24.637"></a><span id="l24.637" class="difflineminus">-                          this);</span>
<a href="#l24.638"></a><span id="l24.638" class="difflineplus">+  mCryptoEncoder = MimeEncoder::GetBase64Encoder(mime_encoder_output_fn, this);</span>
<a href="#l24.639"></a><span id="l24.639"> </span>
<a href="#l24.640"></a><span id="l24.640">   /* Initialize the encrypter (and add the sender's cert.) */</span>
<a href="#l24.641"></a><span id="l24.641">   PR_ASSERT(mSelfEncryptionCert);</span>
<a href="#l24.642"></a><span id="l24.642" class="difflineminus">-  PR_SetError(0,0);</span>
<a href="#l24.643"></a><span id="l24.643" class="difflineplus">+  PR_SetError(0, 0);</span>
<a href="#l24.644"></a><span id="l24.644">   mEncryptionCinfo = do_CreateInstance(NS_CMSMESSAGE_CONTRACTID, &amp;rv);</span>
<a href="#l24.645"></a><span id="l24.645">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l24.646"></a><span id="l24.646">   rv = mEncryptionCinfo-&gt;CreateEncrypted(mCerts);</span>
<a href="#l24.647"></a><span id="l24.647">   if (NS_FAILED(rv)) {</span>
<a href="#l24.648"></a><span id="l24.648">     SetError(sendReport, u&quot;ErrorEncryptMail&quot;);</span>
<a href="#l24.649"></a><span id="l24.649">     goto FAIL;</span>
<a href="#l24.650"></a><span id="l24.650">   }</span>
<a href="#l24.651"></a><span id="l24.651"> </span>
<a href="#l24.652"></a><span id="l24.652">   mEncryptionContext = do_CreateInstance(NS_CMSENCODER_CONTRACTID, &amp;rv);</span>
<a href="#l24.653"></a><span id="l24.653">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l24.654"></a><span id="l24.654"> </span>
<a href="#l24.655"></a><span id="l24.655">   if (!mBuffer) {</span>
<a href="#l24.656"></a><span id="l24.656">     mBuffer = new char[eBufferSize];</span>
<a href="#l24.657"></a><span id="l24.657" class="difflineminus">-    if (!mBuffer)</span>
<a href="#l24.658"></a><span id="l24.658" class="difflineminus">-      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l24.659"></a><span id="l24.659" class="difflineplus">+    if (!mBuffer) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l24.660"></a><span id="l24.660">   }</span>
<a href="#l24.661"></a><span id="l24.661"> </span>
<a href="#l24.662"></a><span id="l24.662">   mBufferedBytes = 0;</span>
<a href="#l24.663"></a><span id="l24.663"> </span>
<a href="#l24.664"></a><span id="l24.664" class="difflineminus">-  rv = mEncryptionContext-&gt;Start(mEncryptionCinfo, mime_crypto_write_base64, mCryptoEncoder);</span>
<a href="#l24.665"></a><span id="l24.665" class="difflineplus">+  rv = mEncryptionContext-&gt;Start(mEncryptionCinfo, mime_crypto_write_base64,</span>
<a href="#l24.666"></a><span id="l24.666" class="difflineplus">+                                 mCryptoEncoder);</span>
<a href="#l24.667"></a><span id="l24.667">   if (NS_FAILED(rv)) {</span>
<a href="#l24.668"></a><span id="l24.668">     SetError(sendReport, u&quot;ErrorEncryptMail&quot;);</span>
<a href="#l24.669"></a><span id="l24.669">     goto FAIL;</span>
<a href="#l24.670"></a><span id="l24.670">   }</span>
<a href="#l24.671"></a><span id="l24.671"> </span>
<a href="#l24.672"></a><span id="l24.672">   /* If we're signing, tack a multipart/signed header onto the front of</span>
<a href="#l24.673"></a><span id="l24.673">    the data to be encrypted, and initialize the sign-hashing code too.</span>
<a href="#l24.674"></a><span id="l24.674">    */</span>
<a href="#l24.675"></a><span id="l24.675">   if (aSign) {</span>
<a href="#l24.676"></a><span id="l24.676">     rv = MimeInitMultipartSigned(false, sendReport);</span>
<a href="#l24.677"></a><span id="l24.677">     if (NS_FAILED(rv)) goto FAIL;</span>
<a href="#l24.678"></a><span id="l24.678">   }</span>
<a href="#l24.679"></a><span id="l24.679"> </span>
<a href="#l24.680"></a><span id="l24.680" class="difflineminus">- FAIL:</span>
<a href="#l24.681"></a><span id="l24.681" class="difflineplus">+FAIL:</span>
<a href="#l24.682"></a><span id="l24.682">   return rv;</span>
<a href="#l24.683"></a><span id="l24.683"> }</span>
<a href="#l24.684"></a><span id="l24.684"> </span>
<a href="#l24.685"></a><span id="l24.685" class="difflineminus">-nsresult nsMsgComposeSecure::MimeFinishMultipartSigned (bool aOuter, nsIMsgSendReport *sendReport)</span>
<a href="#l24.686"></a><span id="l24.686" class="difflineminus">-{</span>
<a href="#l24.687"></a><span id="l24.687" class="difflineplus">+nsresult nsMsgComposeSecure::MimeFinishMultipartSigned(</span>
<a href="#l24.688"></a><span id="l24.688" class="difflineplus">+    bool aOuter, nsIMsgSendReport *sendReport) {</span>
<a href="#l24.689"></a><span id="l24.689">   int status;</span>
<a href="#l24.690"></a><span id="l24.690">   nsresult rv;</span>
<a href="#l24.691"></a><span id="l24.691" class="difflineminus">-  nsCOMPtr&lt;nsICMSMessage&gt; cinfo = do_CreateInstance(NS_CMSMESSAGE_CONTRACTID, &amp;rv);</span>
<a href="#l24.692"></a><span id="l24.692" class="difflineplus">+  nsCOMPtr&lt;nsICMSMessage&gt; cinfo =</span>
<a href="#l24.693"></a><span id="l24.693" class="difflineplus">+      do_CreateInstance(NS_CMSMESSAGE_CONTRACTID, &amp;rv);</span>
<a href="#l24.694"></a><span id="l24.694">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.695"></a><span id="l24.695"> </span>
<a href="#l24.696"></a><span id="l24.696" class="difflineminus">-  nsCOMPtr&lt;nsICMSEncoder&gt; encoder = do_CreateInstance(NS_CMSENCODER_CONTRACTID, &amp;rv);</span>
<a href="#l24.697"></a><span id="l24.697" class="difflineplus">+  nsCOMPtr&lt;nsICMSEncoder&gt; encoder =</span>
<a href="#l24.698"></a><span id="l24.698" class="difflineplus">+      do_CreateInstance(NS_CMSENCODER_CONTRACTID, &amp;rv);</span>
<a href="#l24.699"></a><span id="l24.699">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.700"></a><span id="l24.700"> </span>
<a href="#l24.701"></a><span id="l24.701" class="difflineminus">-  char * header = nullptr;</span>
<a href="#l24.702"></a><span id="l24.702" class="difflineplus">+  char *header = nullptr;</span>
<a href="#l24.703"></a><span id="l24.703">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleSvc =</span>
<a href="#l24.704"></a><span id="l24.704" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l24.705"></a><span id="l24.705" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l24.706"></a><span id="l24.706">   NS_ENSURE_TRUE(bundleSvc, NS_ERROR_UNEXPECTED);</span>
<a href="#l24.707"></a><span id="l24.707"> </span>
<a href="#l24.708"></a><span id="l24.708">   nsCOMPtr&lt;nsIStringBundle&gt; sMIMEBundle;</span>
<a href="#l24.709"></a><span id="l24.709">   nsString mime_smime_sig_content_desc;</span>
<a href="#l24.710"></a><span id="l24.710"> </span>
<a href="#l24.711"></a><span id="l24.711">   bundleSvc-&gt;CreateBundle(SMIME_STRBUNDLE_URL, getter_AddRefs(sMIMEBundle));</span>
<a href="#l24.712"></a><span id="l24.712"> </span>
<a href="#l24.713"></a><span id="l24.713" class="difflineminus">-  if (!sMIMEBundle)</span>
<a href="#l24.714"></a><span id="l24.714" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l24.715"></a><span id="l24.715" class="difflineplus">+  if (!sMIMEBundle) return NS_ERROR_FAILURE;</span>
<a href="#l24.716"></a><span id="l24.716"> </span>
<a href="#l24.717"></a><span id="l24.717">   sMIMEBundle-&gt;GetStringFromName(&quot;mime_smimeSignatureContentDesc&quot;,</span>
<a href="#l24.718"></a><span id="l24.718">                                  mime_smime_sig_content_desc);</span>
<a href="#l24.719"></a><span id="l24.719"> </span>
<a href="#l24.720"></a><span id="l24.720">   NS_ConvertUTF16toUTF8 sig_content_desc_utf8(mime_smime_sig_content_desc);</span>
<a href="#l24.721"></a><span id="l24.721"> </span>
<a href="#l24.722"></a><span id="l24.722">   /* Compute the hash...</span>
<a href="#l24.723"></a><span id="l24.723">    */</span>
<a href="#l24.724"></a><span id="l24.724" class="difflineat">@@ -647,28 +611,23 @@ nsresult nsMsgComposeSecure::MimeFinishM</span>
<a href="#l24.725"></a><span id="l24.725">   mDataHash = nullptr;</span>
<a href="#l24.726"></a><span id="l24.726"> </span>
<a href="#l24.727"></a><span id="l24.727">   status = PR_GetError();</span>
<a href="#l24.728"></a><span id="l24.728">   if (status &lt; 0) goto FAIL;</span>
<a href="#l24.729"></a><span id="l24.729"> </span>
<a href="#l24.730"></a><span id="l24.730">   /* Write out the headers for the signature.</span>
<a href="#l24.731"></a><span id="l24.731">    */</span>
<a href="#l24.732"></a><span id="l24.732">   uint32_t L;</span>
<a href="#l24.733"></a><span id="l24.733" class="difflineminus">-  header =</span>
<a href="#l24.734"></a><span id="l24.734" class="difflineminus">-    PR_smprintf(CRLF</span>
<a href="#l24.735"></a><span id="l24.735" class="difflineminus">-          &quot;--%s&quot; CRLF</span>
<a href="#l24.736"></a><span id="l24.736" class="difflineminus">-          &quot;Content-Type: &quot; APPLICATION_PKCS7_SIGNATURE</span>
<a href="#l24.737"></a><span id="l24.737" class="difflineminus">-            &quot;; name=\&quot;smime.p7s\&quot;&quot; CRLF</span>
<a href="#l24.738"></a><span id="l24.738" class="difflineminus">-          &quot;Content-Transfer-Encoding: &quot; ENCODING_BASE64 CRLF</span>
<a href="#l24.739"></a><span id="l24.739" class="difflineminus">-          &quot;Content-Disposition: attachment; &quot;</span>
<a href="#l24.740"></a><span id="l24.740" class="difflineminus">-            &quot;filename=\&quot;smime.p7s\&quot;&quot; CRLF</span>
<a href="#l24.741"></a><span id="l24.741" class="difflineminus">-          &quot;Content-Description: %s&quot; CRLF</span>
<a href="#l24.742"></a><span id="l24.742" class="difflineminus">-          CRLF,</span>
<a href="#l24.743"></a><span id="l24.743" class="difflineminus">-          mMultipartSignedBoundary,</span>
<a href="#l24.744"></a><span id="l24.744" class="difflineminus">-          sig_content_desc_utf8.get());</span>
<a href="#l24.745"></a><span id="l24.745" class="difflineplus">+  header = PR_smprintf(</span>
<a href="#l24.746"></a><span id="l24.746" class="difflineplus">+      CRLF &quot;--%s&quot; CRLF &quot;Content-Type: &quot; APPLICATION_PKCS7_SIGNATURE</span>
<a href="#l24.747"></a><span id="l24.747" class="difflineplus">+           &quot;; name=\&quot;smime.p7s\&quot;&quot; CRLF</span>
<a href="#l24.748"></a><span id="l24.748" class="difflineplus">+           &quot;Content-Transfer-Encoding: &quot; ENCODING_BASE64 CRLF</span>
<a href="#l24.749"></a><span id="l24.749" class="difflineplus">+           &quot;Content-Disposition: attachment; &quot;</span>
<a href="#l24.750"></a><span id="l24.750" class="difflineplus">+           &quot;filename=\&quot;smime.p7s\&quot;&quot; CRLF &quot;Content-Description: %s&quot; CRLF CRLF,</span>
<a href="#l24.751"></a><span id="l24.751" class="difflineplus">+      mMultipartSignedBoundary, sig_content_desc_utf8.get());</span>
<a href="#l24.752"></a><span id="l24.752"> </span>
<a href="#l24.753"></a><span id="l24.753">   if (!header) {</span>
<a href="#l24.754"></a><span id="l24.754">     rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l24.755"></a><span id="l24.755">     goto FAIL;</span>
<a href="#l24.756"></a><span id="l24.756">   }</span>
<a href="#l24.757"></a><span id="l24.757"> </span>
<a href="#l24.758"></a><span id="l24.758">   L = strlen(header);</span>
<a href="#l24.759"></a><span id="l24.759">   if (aOuter) {</span>
<a href="#l24.760"></a><span id="l24.760" class="difflineat">@@ -676,44 +635,45 @@ nsresult nsMsgComposeSecure::MimeFinishM</span>
<a href="#l24.761"></a><span id="l24.761">     uint32_t n;</span>
<a href="#l24.762"></a><span id="l24.762">     rv = mStream-&gt;Write(header, L, &amp;n);</span>
<a href="#l24.763"></a><span id="l24.763">     if (NS_FAILED(rv) || n &lt; L) {</span>
<a href="#l24.764"></a><span id="l24.764">       // XXX This is -1, not an nsresult</span>
<a href="#l24.765"></a><span id="l24.765">       rv = static_cast&lt;nsresult&gt;(MK_MIME_ERROR_WRITING_FILE);</span>
<a href="#l24.766"></a><span id="l24.766">     }</span>
<a href="#l24.767"></a><span id="l24.767">   } else {</span>
<a href="#l24.768"></a><span id="l24.768">     /* If this is an inner block, feed it through the crypto stream. */</span>
<a href="#l24.769"></a><span id="l24.769" class="difflineminus">-    rv = MimeCryptoWriteBlock (header, L);</span>
<a href="#l24.770"></a><span id="l24.770" class="difflineplus">+    rv = MimeCryptoWriteBlock(header, L);</span>
<a href="#l24.771"></a><span id="l24.771">   }</span>
<a href="#l24.772"></a><span id="l24.772"> </span>
<a href="#l24.773"></a><span id="l24.773">   PR_Free(header);</span>
<a href="#l24.774"></a><span id="l24.774"> </span>
<a href="#l24.775"></a><span id="l24.775">   /* Create the signature...</span>
<a href="#l24.776"></a><span id="l24.776">    */</span>
<a href="#l24.777"></a><span id="l24.777"> </span>
<a href="#l24.778"></a><span id="l24.778">   NS_ASSERTION(mHashType, &quot;Hash function for signature has not been set.&quot;);</span>
<a href="#l24.779"></a><span id="l24.779"> </span>
<a href="#l24.780"></a><span id="l24.780" class="difflineminus">-  PR_ASSERT (mSelfSigningCert);</span>
<a href="#l24.781"></a><span id="l24.781" class="difflineminus">-  PR_SetError(0,0);</span>
<a href="#l24.782"></a><span id="l24.782" class="difflineplus">+  PR_ASSERT(mSelfSigningCert);</span>
<a href="#l24.783"></a><span id="l24.783" class="difflineplus">+  PR_SetError(0, 0);</span>
<a href="#l24.784"></a><span id="l24.784"> </span>
<a href="#l24.785"></a><span id="l24.785">   rv = cinfo-&gt;CreateSigned(mSelfSigningCert, mSelfEncryptionCert,</span>
<a href="#l24.786"></a><span id="l24.786" class="difflineminus">-    (unsigned char*)hashString.get(), hashString.Length(), mHashType);</span>
<a href="#l24.787"></a><span id="l24.787" class="difflineminus">-  if (NS_FAILED(rv))  {</span>
<a href="#l24.788"></a><span id="l24.788" class="difflineplus">+                           (unsigned char *)hashString.get(),</span>
<a href="#l24.789"></a><span id="l24.789" class="difflineplus">+                           hashString.Length(), mHashType);</span>
<a href="#l24.790"></a><span id="l24.790" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l24.791"></a><span id="l24.791">     SetError(sendReport, u&quot;ErrorCanNotSignMail&quot;);</span>
<a href="#l24.792"></a><span id="l24.792">     goto FAIL;</span>
<a href="#l24.793"></a><span id="l24.793">   }</span>
<a href="#l24.794"></a><span id="l24.794"> </span>
<a href="#l24.795"></a><span id="l24.795">   // Initialize the base64 encoder for the signature data.</span>
<a href="#l24.796"></a><span id="l24.796">   MOZ_ASSERT(!mSigEncoder, &quot;Shouldn't already have a mSigEncoder&quot;);</span>
<a href="#l24.797"></a><span id="l24.797">   mSigEncoder = MimeEncoder::GetBase64Encoder(</span>
<a href="#l24.798"></a><span id="l24.798" class="difflineminus">-    (aOuter ? mime_encoder_output_fn : mime_nested_encoder_output_fn), this);</span>
<a href="#l24.799"></a><span id="l24.799" class="difflineplus">+      (aOuter ? mime_encoder_output_fn : mime_nested_encoder_output_fn), this);</span>
<a href="#l24.800"></a><span id="l24.800"> </span>
<a href="#l24.801"></a><span id="l24.801">   /* Write out the signature.</span>
<a href="#l24.802"></a><span id="l24.802">    */</span>
<a href="#l24.803"></a><span id="l24.803" class="difflineminus">-  PR_SetError(0,0);</span>
<a href="#l24.804"></a><span id="l24.804" class="difflineplus">+  PR_SetError(0, 0);</span>
<a href="#l24.805"></a><span id="l24.805">   rv = encoder-&gt;Start(cinfo, mime_crypto_write_base64, mSigEncoder);</span>
<a href="#l24.806"></a><span id="l24.806">   if (NS_FAILED(rv)) {</span>
<a href="#l24.807"></a><span id="l24.807">     SetError(sendReport, u&quot;ErrorCanNotSignMail&quot;);</span>
<a href="#l24.808"></a><span id="l24.808">     goto FAIL;</span>
<a href="#l24.809"></a><span id="l24.809">   }</span>
<a href="#l24.810"></a><span id="l24.810"> </span>
<a href="#l24.811"></a><span id="l24.811">   // We're not passing in any data, so no update needed.</span>
<a href="#l24.812"></a><span id="l24.812">   rv = encoder-&gt;Finish();</span>
<a href="#l24.813"></a><span id="l24.813" class="difflineat">@@ -727,56 +687,54 @@ nsresult nsMsgComposeSecure::MimeFinishM</span>
<a href="#l24.814"></a><span id="l24.814">   mSigEncoder = nullptr;</span>
<a href="#l24.815"></a><span id="l24.815">   if (NS_FAILED(rv)) {</span>
<a href="#l24.816"></a><span id="l24.816">     goto FAIL;</span>
<a href="#l24.817"></a><span id="l24.817">   }</span>
<a href="#l24.818"></a><span id="l24.818"> </span>
<a href="#l24.819"></a><span id="l24.819">   /* Now write out the terminating boundary.</span>
<a href="#l24.820"></a><span id="l24.820">    */</span>
<a href="#l24.821"></a><span id="l24.821">   {</span>
<a href="#l24.822"></a><span id="l24.822" class="difflineminus">-  uint32_t L;</span>
<a href="#l24.823"></a><span id="l24.823" class="difflineminus">-  char *header = PR_smprintf(CRLF &quot;--%s--&quot; CRLF,</span>
<a href="#l24.824"></a><span id="l24.824" class="difflineminus">-                 mMultipartSignedBoundary);</span>
<a href="#l24.825"></a><span id="l24.825" class="difflineminus">-  PR_Free(mMultipartSignedBoundary);</span>
<a href="#l24.826"></a><span id="l24.826" class="difflineminus">-  mMultipartSignedBoundary = 0;</span>
<a href="#l24.827"></a><span id="l24.827" class="difflineplus">+    uint32_t L;</span>
<a href="#l24.828"></a><span id="l24.828" class="difflineplus">+    char *header = PR_smprintf(CRLF &quot;--%s--&quot; CRLF, mMultipartSignedBoundary);</span>
<a href="#l24.829"></a><span id="l24.829" class="difflineplus">+    PR_Free(mMultipartSignedBoundary);</span>
<a href="#l24.830"></a><span id="l24.830" class="difflineplus">+    mMultipartSignedBoundary = 0;</span>
<a href="#l24.831"></a><span id="l24.831"> </span>
<a href="#l24.832"></a><span id="l24.832" class="difflineminus">-  if (!header) {</span>
<a href="#l24.833"></a><span id="l24.833" class="difflineminus">-    rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l24.834"></a><span id="l24.834" class="difflineminus">-    goto FAIL;</span>
<a href="#l24.835"></a><span id="l24.835" class="difflineminus">-  }</span>
<a href="#l24.836"></a><span id="l24.836" class="difflineminus">-  L = strlen(header);</span>
<a href="#l24.837"></a><span id="l24.837" class="difflineminus">-  if (aOuter) {</span>
<a href="#l24.838"></a><span id="l24.838" class="difflineminus">-    /* If this is the outer block, write it to the file. */</span>
<a href="#l24.839"></a><span id="l24.839" class="difflineminus">-    uint32_t n;</span>
<a href="#l24.840"></a><span id="l24.840" class="difflineminus">-    rv = mStream-&gt;Write(header, L, &amp;n);</span>
<a href="#l24.841"></a><span id="l24.841" class="difflineminus">-    if (NS_FAILED(rv) || n &lt; L)</span>
<a href="#l24.842"></a><span id="l24.842" class="difflineminus">-      // XXX This is -1, not an nsresult</span>
<a href="#l24.843"></a><span id="l24.843" class="difflineminus">-      rv = static_cast&lt;nsresult&gt;(MK_MIME_ERROR_WRITING_FILE);</span>
<a href="#l24.844"></a><span id="l24.844" class="difflineminus">-  } else {</span>
<a href="#l24.845"></a><span id="l24.845" class="difflineminus">-    /* If this is an inner block, feed it through the crypto stream. */</span>
<a href="#l24.846"></a><span id="l24.846" class="difflineminus">-    rv = MimeCryptoWriteBlock (header, L);</span>
<a href="#l24.847"></a><span id="l24.847" class="difflineminus">-  }</span>
<a href="#l24.848"></a><span id="l24.848" class="difflineplus">+    if (!header) {</span>
<a href="#l24.849"></a><span id="l24.849" class="difflineplus">+      rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l24.850"></a><span id="l24.850" class="difflineplus">+      goto FAIL;</span>
<a href="#l24.851"></a><span id="l24.851" class="difflineplus">+    }</span>
<a href="#l24.852"></a><span id="l24.852" class="difflineplus">+    L = strlen(header);</span>
<a href="#l24.853"></a><span id="l24.853" class="difflineplus">+    if (aOuter) {</span>
<a href="#l24.854"></a><span id="l24.854" class="difflineplus">+      /* If this is the outer block, write it to the file. */</span>
<a href="#l24.855"></a><span id="l24.855" class="difflineplus">+      uint32_t n;</span>
<a href="#l24.856"></a><span id="l24.856" class="difflineplus">+      rv = mStream-&gt;Write(header, L, &amp;n);</span>
<a href="#l24.857"></a><span id="l24.857" class="difflineplus">+      if (NS_FAILED(rv) || n &lt; L)</span>
<a href="#l24.858"></a><span id="l24.858" class="difflineplus">+        // XXX This is -1, not an nsresult</span>
<a href="#l24.859"></a><span id="l24.859" class="difflineplus">+        rv = static_cast&lt;nsresult&gt;(MK_MIME_ERROR_WRITING_FILE);</span>
<a href="#l24.860"></a><span id="l24.860" class="difflineplus">+    } else {</span>
<a href="#l24.861"></a><span id="l24.861" class="difflineplus">+      /* If this is an inner block, feed it through the crypto stream. */</span>
<a href="#l24.862"></a><span id="l24.862" class="difflineplus">+      rv = MimeCryptoWriteBlock(header, L);</span>
<a href="#l24.863"></a><span id="l24.863" class="difflineplus">+    }</span>
<a href="#l24.864"></a><span id="l24.864">   }</span>
<a href="#l24.865"></a><span id="l24.865"> </span>
<a href="#l24.866"></a><span id="l24.866"> FAIL:</span>
<a href="#l24.867"></a><span id="l24.867">   return rv;</span>
<a href="#l24.868"></a><span id="l24.868"> }</span>
<a href="#l24.869"></a><span id="l24.869"> </span>
<a href="#l24.870"></a><span id="l24.870" class="difflineminus">-</span>
<a href="#l24.871"></a><span id="l24.871"> /* Helper function for mime_finish_crypto_encapsulation() to close off</span>
<a href="#l24.872"></a><span id="l24.872">    an opaque crypto object (for encrypted or signed-and-encrypted messages.)</span>
<a href="#l24.873"></a><span id="l24.873">  */</span>
<a href="#l24.874"></a><span id="l24.874" class="difflineminus">-nsresult nsMsgComposeSecure::MimeFinishEncryption (bool aSign, nsIMsgSendReport *sendReport)</span>
<a href="#l24.875"></a><span id="l24.875" class="difflineminus">-{</span>
<a href="#l24.876"></a><span id="l24.876" class="difflineplus">+nsresult nsMsgComposeSecure::MimeFinishEncryption(</span>
<a href="#l24.877"></a><span id="l24.877" class="difflineplus">+    bool aSign, nsIMsgSendReport *sendReport) {</span>
<a href="#l24.878"></a><span id="l24.878">   nsresult rv;</span>
<a href="#l24.879"></a><span id="l24.879"> </span>
<a href="#l24.880"></a><span id="l24.880">   /* If this object is both encrypted and signed, close off the</span>
<a href="#l24.881"></a><span id="l24.881">    signature first (since it's inside.) */</span>
<a href="#l24.882"></a><span id="l24.882">   if (aSign) {</span>
<a href="#l24.883"></a><span id="l24.883" class="difflineminus">-    rv = MimeFinishMultipartSigned (false, sendReport);</span>
<a href="#l24.884"></a><span id="l24.884" class="difflineplus">+    rv = MimeFinishMultipartSigned(false, sendReport);</span>
<a href="#l24.885"></a><span id="l24.885">     if (NS_FAILED(rv)) {</span>
<a href="#l24.886"></a><span id="l24.886">       goto FAIL;</span>
<a href="#l24.887"></a><span id="l24.887">     }</span>
<a href="#l24.888"></a><span id="l24.888">   }</span>
<a href="#l24.889"></a><span id="l24.889"> </span>
<a href="#l24.890"></a><span id="l24.890">   /* Close off the opaque encrypted blob.</span>
<a href="#l24.891"></a><span id="l24.891">    */</span>
<a href="#l24.892"></a><span id="l24.892">   PR_ASSERT(mEncryptionContext);</span>
<a href="#l24.893"></a><span id="l24.893" class="difflineat">@@ -807,31 +765,28 @@ nsresult nsMsgComposeSecure::MimeFinishE</span>
<a href="#l24.894"></a><span id="l24.894">   }</span>
<a href="#l24.895"></a><span id="l24.895"> </span>
<a href="#l24.896"></a><span id="l24.896">   // Shut down the base64 encoder.</span>
<a href="#l24.897"></a><span id="l24.897">   mCryptoEncoder-&gt;Flush();</span>
<a href="#l24.898"></a><span id="l24.898">   mCryptoEncoder = nullptr;</span>
<a href="#l24.899"></a><span id="l24.899"> </span>
<a href="#l24.900"></a><span id="l24.900">   uint32_t n;</span>
<a href="#l24.901"></a><span id="l24.901">   rv = mStream-&gt;Write(CRLF, 2, &amp;n);</span>
<a href="#l24.902"></a><span id="l24.902" class="difflineminus">-  if (NS_FAILED(rv) || n &lt; 2)</span>
<a href="#l24.903"></a><span id="l24.903" class="difflineminus">-    rv = NS_ERROR_FAILURE;</span>
<a href="#l24.904"></a><span id="l24.904" class="difflineplus">+  if (NS_FAILED(rv) || n &lt; 2) rv = NS_ERROR_FAILURE;</span>
<a href="#l24.905"></a><span id="l24.905"> </span>
<a href="#l24.906"></a><span id="l24.906" class="difflineminus">- FAIL:</span>
<a href="#l24.907"></a><span id="l24.907" class="difflineplus">+FAIL:</span>
<a href="#l24.908"></a><span id="l24.908">   return rv;</span>
<a href="#l24.909"></a><span id="l24.909"> }</span>
<a href="#l24.910"></a><span id="l24.910"> </span>
<a href="#l24.911"></a><span id="l24.911"> /* Used to figure out what certs should be used when encrypting this message.</span>
<a href="#l24.912"></a><span id="l24.912">  */</span>
<a href="#l24.913"></a><span id="l24.913"> nsresult nsMsgComposeSecure::MimeCryptoHackCerts(const char *aRecipients,</span>
<a href="#l24.914"></a><span id="l24.914">                                                  nsIMsgSendReport *sendReport,</span>
<a href="#l24.915"></a><span id="l24.915" class="difflineminus">-                                                 bool aEncrypt,</span>
<a href="#l24.916"></a><span id="l24.916" class="difflineminus">-                                                 bool aSign,</span>
<a href="#l24.917"></a><span id="l24.917" class="difflineminus">-                                                 nsIMsgIdentity *aIdentity)</span>
<a href="#l24.918"></a><span id="l24.918" class="difflineminus">-{</span>
<a href="#l24.919"></a><span id="l24.919" class="difflineplus">+                                                 bool aEncrypt, bool aSign,</span>
<a href="#l24.920"></a><span id="l24.920" class="difflineplus">+                                                 nsIMsgIdentity *aIdentity) {</span>
<a href="#l24.921"></a><span id="l24.921">   nsCOMPtr&lt;nsIX509CertDB&gt; certdb = do_GetService(NS_X509CERTDB_CONTRACTID);</span>
<a href="#l24.922"></a><span id="l24.922">   nsresult res;</span>
<a href="#l24.923"></a><span id="l24.923"> </span>
<a href="#l24.924"></a><span id="l24.924">   mCerts = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;res);</span>
<a href="#l24.925"></a><span id="l24.925">   if (NS_FAILED(res)) {</span>
<a href="#l24.926"></a><span id="l24.926">     return res;</span>
<a href="#l24.927"></a><span id="l24.927">   }</span>
<a href="#l24.928"></a><span id="l24.928"> </span>
<a href="#l24.929"></a><span id="l24.929" class="difflineat">@@ -849,45 +804,39 @@ nsresult nsMsgComposeSecure::MimeCryptoH</span>
<a href="#l24.930"></a><span id="l24.930">   RefPtr&lt;SharedCertVerifier&gt; certVerifier(GetDefaultCertVerifier());</span>
<a href="#l24.931"></a><span id="l24.931">   NS_ENSURE_TRUE(certVerifier, NS_ERROR_UNEXPECTED);</span>
<a href="#l24.932"></a><span id="l24.932"> </span>
<a href="#l24.933"></a><span id="l24.933">   UniqueCERTCertList builtChain;</span>
<a href="#l24.934"></a><span id="l24.934">   if (!mEncryptionCertDBKey.IsEmpty()) {</span>
<a href="#l24.935"></a><span id="l24.935">     res = certdb-&gt;FindCertByDBKey(mEncryptionCertDBKey,</span>
<a href="#l24.936"></a><span id="l24.936">                                   getter_AddRefs(mSelfEncryptionCert));</span>
<a href="#l24.937"></a><span id="l24.937">     if (NS_SUCCEEDED(res) &amp;&amp; mSelfEncryptionCert &amp;&amp;</span>
<a href="#l24.938"></a><span id="l24.938" class="difflineminus">-        (certVerifier-&gt;VerifyCert(mSelfEncryptionCert-&gt;GetCert(),</span>
<a href="#l24.939"></a><span id="l24.939" class="difflineminus">-                                  certificateUsageEmailRecipient,</span>
<a href="#l24.940"></a><span id="l24.940" class="difflineminus">-                                  mozilla::pkix::Now(),</span>
<a href="#l24.941"></a><span id="l24.941" class="difflineminus">-                                  nullptr, nullptr,</span>
<a href="#l24.942"></a><span id="l24.942" class="difflineminus">-                                  builtChain,</span>
<a href="#l24.943"></a><span id="l24.943" class="difflineminus">-                                  // Only local checks can run on the main thread.</span>
<a href="#l24.944"></a><span id="l24.944" class="difflineminus">-                                  CertVerifier::FLAG_LOCAL_ONLY)</span>
<a href="#l24.945"></a><span id="l24.945" class="difflineminus">-                       != mozilla::pkix::Success)) {</span>
<a href="#l24.946"></a><span id="l24.946" class="difflineplus">+        (certVerifier-&gt;VerifyCert(</span>
<a href="#l24.947"></a><span id="l24.947" class="difflineplus">+             mSelfEncryptionCert-&gt;GetCert(), certificateUsageEmailRecipient,</span>
<a href="#l24.948"></a><span id="l24.948" class="difflineplus">+             mozilla::pkix::Now(), nullptr, nullptr, builtChain,</span>
<a href="#l24.949"></a><span id="l24.949" class="difflineplus">+             // Only local checks can run on the main thread.</span>
<a href="#l24.950"></a><span id="l24.950" class="difflineplus">+             CertVerifier::FLAG_LOCAL_ONLY) != mozilla::pkix::Success)) {</span>
<a href="#l24.951"></a><span id="l24.951">       // not suitable for encryption, so unset cert and clear pref</span>
<a href="#l24.952"></a><span id="l24.952">       mSelfEncryptionCert = nullptr;</span>
<a href="#l24.953"></a><span id="l24.953">       mEncryptionCertDBKey.Truncate();</span>
<a href="#l24.954"></a><span id="l24.954">       aIdentity-&gt;SetCharAttribute(&quot;encryption_cert_dbkey&quot;,</span>
<a href="#l24.955"></a><span id="l24.955" class="difflineminus">-                                   mEncryptionCertDBKey);</span>
<a href="#l24.956"></a><span id="l24.956" class="difflineplus">+                                  mEncryptionCertDBKey);</span>
<a href="#l24.957"></a><span id="l24.957">     }</span>
<a href="#l24.958"></a><span id="l24.958">   }</span>
<a href="#l24.959"></a><span id="l24.959"> </span>
<a href="#l24.960"></a><span id="l24.960">   // same procedure for the signing cert</span>
<a href="#l24.961"></a><span id="l24.961">   if (!mSigningCertDBKey.IsEmpty()) {</span>
<a href="#l24.962"></a><span id="l24.962">     res = certdb-&gt;FindCertByDBKey(mSigningCertDBKey,</span>
<a href="#l24.963"></a><span id="l24.963">                                   getter_AddRefs(mSelfSigningCert));</span>
<a href="#l24.964"></a><span id="l24.964">     if (NS_SUCCEEDED(res) &amp;&amp; mSelfSigningCert &amp;&amp;</span>
<a href="#l24.965"></a><span id="l24.965" class="difflineminus">-        (certVerifier-&gt;VerifyCert(mSelfSigningCert-&gt;GetCert(),</span>
<a href="#l24.966"></a><span id="l24.966" class="difflineminus">-                                  certificateUsageEmailSigner,</span>
<a href="#l24.967"></a><span id="l24.967" class="difflineminus">-                                  mozilla::pkix::Now(),</span>
<a href="#l24.968"></a><span id="l24.968" class="difflineminus">-                                  nullptr, nullptr,</span>
<a href="#l24.969"></a><span id="l24.969" class="difflineminus">-                                  builtChain,</span>
<a href="#l24.970"></a><span id="l24.970" class="difflineminus">-                                  // Only local checks can run on the main thread.</span>
<a href="#l24.971"></a><span id="l24.971" class="difflineminus">-                                  CertVerifier::FLAG_LOCAL_ONLY)</span>
<a href="#l24.972"></a><span id="l24.972" class="difflineminus">-                       != mozilla::pkix::Success)) {</span>
<a href="#l24.973"></a><span id="l24.973" class="difflineplus">+        (certVerifier-&gt;VerifyCert(</span>
<a href="#l24.974"></a><span id="l24.974" class="difflineplus">+             mSelfSigningCert-&gt;GetCert(), certificateUsageEmailSigner,</span>
<a href="#l24.975"></a><span id="l24.975" class="difflineplus">+             mozilla::pkix::Now(), nullptr, nullptr, builtChain,</span>
<a href="#l24.976"></a><span id="l24.976" class="difflineplus">+             // Only local checks can run on the main thread.</span>
<a href="#l24.977"></a><span id="l24.977" class="difflineplus">+             CertVerifier::FLAG_LOCAL_ONLY) != mozilla::pkix::Success)) {</span>
<a href="#l24.978"></a><span id="l24.978">       // not suitable for signing, so unset cert and clear pref</span>
<a href="#l24.979"></a><span id="l24.979">       mSelfSigningCert = nullptr;</span>
<a href="#l24.980"></a><span id="l24.980">       mSigningCertDBKey.Truncate();</span>
<a href="#l24.981"></a><span id="l24.981">       aIdentity-&gt;SetCharAttribute(&quot;signing_cert_dbkey&quot;, mSigningCertDBKey);</span>
<a href="#l24.982"></a><span id="l24.982">     }</span>
<a href="#l24.983"></a><span id="l24.983">   }</span>
<a href="#l24.984"></a><span id="l24.984"> </span>
<a href="#l24.985"></a><span id="l24.985">   // must have both the signing and encryption certs to sign</span>
<a href="#l24.986"></a><span id="l24.986" class="difflineat">@@ -896,17 +845,16 @@ nsresult nsMsgComposeSecure::MimeCryptoH</span>
<a href="#l24.987"></a><span id="l24.987">     return NS_ERROR_FAILURE;</span>
<a href="#l24.988"></a><span id="l24.988">   }</span>
<a href="#l24.989"></a><span id="l24.989"> </span>
<a href="#l24.990"></a><span id="l24.990">   if (!mSelfEncryptionCert &amp;&amp; aEncrypt) {</span>
<a href="#l24.991"></a><span id="l24.991">     SetError(sendReport, u&quot;NoSenderEncryptionCert&quot;);</span>
<a href="#l24.992"></a><span id="l24.992">     return NS_ERROR_FAILURE;</span>
<a href="#l24.993"></a><span id="l24.993">   }</span>
<a href="#l24.994"></a><span id="l24.994"> </span>
<a href="#l24.995"></a><span id="l24.995" class="difflineminus">-</span>
<a href="#l24.996"></a><span id="l24.996">   if (aEncrypt &amp;&amp; mSelfEncryptionCert) {</span>
<a href="#l24.997"></a><span id="l24.997">     // Make sure self's configured cert is prepared for being used</span>
<a href="#l24.998"></a><span id="l24.998">     // as an email recipient cert.</span>
<a href="#l24.999"></a><span id="l24.999">     UniqueCERTCertificate nsscert(mSelfEncryptionCert-&gt;GetCert());</span>
<a href="#l24.1000"></a><span id="l24.1000">     if (!nsscert) {</span>
<a href="#l24.1001"></a><span id="l24.1001">       return NS_ERROR_FAILURE;</span>
<a href="#l24.1002"></a><span id="l24.1002">     }</span>
<a href="#l24.1003"></a><span id="l24.1003">     // XXX: This does not respect the nsNSSShutDownObject protocol.</span>
<a href="#l24.1004"></a><span id="l24.1004" class="difflineat">@@ -914,106 +862,105 @@ nsresult nsMsgComposeSecure::MimeCryptoH</span>
<a href="#l24.1005"></a><span id="l24.1005">       return NS_ERROR_FAILURE;</span>
<a href="#l24.1006"></a><span id="l24.1006">     }</span>
<a href="#l24.1007"></a><span id="l24.1007">   }</span>
<a href="#l24.1008"></a><span id="l24.1008"> </span>
<a href="#l24.1009"></a><span id="l24.1009">   /* If the message is to be encrypted, then get the recipient certs */</span>
<a href="#l24.1010"></a><span id="l24.1010">   if (aEncrypt) {</span>
<a href="#l24.1011"></a><span id="l24.1011">     nsTArray&lt;nsCString&gt; mailboxes;</span>
<a href="#l24.1012"></a><span id="l24.1012">     ExtractEmails(EncodedHeader(nsDependentCString(aRecipients)),</span>
<a href="#l24.1013"></a><span id="l24.1013" class="difflineminus">-      UTF16ArrayAdapter&lt;&gt;(mailboxes));</span>
<a href="#l24.1014"></a><span id="l24.1014" class="difflineplus">+                  UTF16ArrayAdapter&lt;&gt;(mailboxes));</span>
<a href="#l24.1015"></a><span id="l24.1015">     uint32_t count = mailboxes.Length();</span>
<a href="#l24.1016"></a><span id="l24.1016"> </span>
<a href="#l24.1017"></a><span id="l24.1017">     bool already_added_self_cert = false;</span>
<a href="#l24.1018"></a><span id="l24.1018"> </span>
<a href="#l24.1019"></a><span id="l24.1019">     for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l24.1020"></a><span id="l24.1020">       nsCString mailbox_lowercase;</span>
<a href="#l24.1021"></a><span id="l24.1021">       ToLowerCase(mailboxes[i], mailbox_lowercase);</span>
<a href="#l24.1022"></a><span id="l24.1022">       nsCOMPtr&lt;nsIX509Cert&gt; cert;</span>
<a href="#l24.1023"></a><span id="l24.1023">       // TODO: allow user to override and go ahead with an invalid certificate</span>
<a href="#l24.1024"></a><span id="l24.1024" class="difflineminus">-      res = FindCertByEmailAddress(mailbox_lowercase, true, getter_AddRefs(cert));</span>
<a href="#l24.1025"></a><span id="l24.1025" class="difflineplus">+      res =</span>
<a href="#l24.1026"></a><span id="l24.1026" class="difflineplus">+          FindCertByEmailAddress(mailbox_lowercase, true, getter_AddRefs(cert));</span>
<a href="#l24.1027"></a><span id="l24.1027">       if (NS_FAILED(res)) {</span>
<a href="#l24.1028"></a><span id="l24.1028">         // Failure to find a valid encryption cert is fatal.</span>
<a href="#l24.1029"></a><span id="l24.1029">         // Here I assume that mailbox is ascii rather than utf8.</span>
<a href="#l24.1030"></a><span id="l24.1030" class="difflineminus">-        SetErrorWithParam(sendReport,</span>
<a href="#l24.1031"></a><span id="l24.1031" class="difflineminus">-                          &quot;MissingRecipientEncryptionCert&quot;,</span>
<a href="#l24.1032"></a><span id="l24.1032" class="difflineplus">+        SetErrorWithParam(sendReport, &quot;MissingRecipientEncryptionCert&quot;,</span>
<a href="#l24.1033"></a><span id="l24.1033">                           mailboxes[i].get());</span>
<a href="#l24.1034"></a><span id="l24.1034"> </span>
<a href="#l24.1035"></a><span id="l24.1035">         return res;</span>
<a href="#l24.1036"></a><span id="l24.1036">       }</span>
<a href="#l24.1037"></a><span id="l24.1037"> </span>
<a href="#l24.1038"></a><span id="l24.1038" class="difflineminus">-    /* #### see if recipient requests `signedData'.</span>
<a href="#l24.1039"></a><span id="l24.1039" class="difflineminus">-     if (...) no_clearsigning_p = true;</span>
<a href="#l24.1040"></a><span id="l24.1040" class="difflineminus">-     (This is the only reason we even bother looking up the certs</span>
<a href="#l24.1041"></a><span id="l24.1041" class="difflineminus">-     of the recipients if we're sending a signed-but-not-encrypted</span>
<a href="#l24.1042"></a><span id="l24.1042" class="difflineminus">-     message.)</span>
<a href="#l24.1043"></a><span id="l24.1043" class="difflineminus">-     */</span>
<a href="#l24.1044"></a><span id="l24.1044" class="difflineplus">+      /* #### see if recipient requests `signedData'.</span>
<a href="#l24.1045"></a><span id="l24.1045" class="difflineplus">+       if (...) no_clearsigning_p = true;</span>
<a href="#l24.1046"></a><span id="l24.1046" class="difflineplus">+       (This is the only reason we even bother looking up the certs</span>
<a href="#l24.1047"></a><span id="l24.1047" class="difflineplus">+       of the recipients if we're sending a signed-but-not-encrypted</span>
<a href="#l24.1048"></a><span id="l24.1048" class="difflineplus">+       message.)</span>
<a href="#l24.1049"></a><span id="l24.1049" class="difflineplus">+       */</span>
<a href="#l24.1050"></a><span id="l24.1050"> </span>
<a href="#l24.1051"></a><span id="l24.1051">       bool isSame;</span>
<a href="#l24.1052"></a><span id="l24.1052" class="difflineminus">-      if (NS_SUCCEEDED(cert-&gt;Equals(mSelfEncryptionCert, &amp;isSame))</span>
<a href="#l24.1053"></a><span id="l24.1053" class="difflineminus">-          &amp;&amp; isSame) {</span>
<a href="#l24.1054"></a><span id="l24.1054" class="difflineplus">+      if (NS_SUCCEEDED(cert-&gt;Equals(mSelfEncryptionCert, &amp;isSame)) &amp;&amp; isSame) {</span>
<a href="#l24.1055"></a><span id="l24.1055">         already_added_self_cert = true;</span>
<a href="#l24.1056"></a><span id="l24.1056">       }</span>
<a href="#l24.1057"></a><span id="l24.1057"> </span>
<a href="#l24.1058"></a><span id="l24.1058">       mCerts-&gt;AppendElement(cert);</span>
<a href="#l24.1059"></a><span id="l24.1059">     }</span>
<a href="#l24.1060"></a><span id="l24.1060"> </span>
<a href="#l24.1061"></a><span id="l24.1061">     if (!already_added_self_cert) {</span>
<a href="#l24.1062"></a><span id="l24.1062">       mCerts-&gt;AppendElement(mSelfEncryptionCert);</span>
<a href="#l24.1063"></a><span id="l24.1063">     }</span>
<a href="#l24.1064"></a><span id="l24.1064">   }</span>
<a href="#l24.1065"></a><span id="l24.1065">   return res;</span>
<a href="#l24.1066"></a><span id="l24.1066"> }</span>
<a href="#l24.1067"></a><span id="l24.1067"> </span>
<a href="#l24.1068"></a><span id="l24.1068" class="difflineminus">-NS_IMETHODIMP nsMsgComposeSecure::MimeCryptoWriteBlock (const char *buf, int32_t size)</span>
<a href="#l24.1069"></a><span id="l24.1069" class="difflineminus">-{</span>
<a href="#l24.1070"></a><span id="l24.1070" class="difflineplus">+NS_IMETHODIMP nsMsgComposeSecure::MimeCryptoWriteBlock(const char *buf,</span>
<a href="#l24.1071"></a><span id="l24.1071" class="difflineplus">+                                                       int32_t size) {</span>
<a href="#l24.1072"></a><span id="l24.1072">   int status = 0;</span>
<a href="#l24.1073"></a><span id="l24.1073">   nsresult rv;</span>
<a href="#l24.1074"></a><span id="l24.1074"> </span>
<a href="#l24.1075"></a><span id="l24.1075">   /* If this is a From line, mangle it before signing it.  You just know</span>
<a href="#l24.1076"></a><span id="l24.1076">    that something somewhere is going to mangle it later, and that's</span>
<a href="#l24.1077"></a><span id="l24.1077">    going to cause the signature check to fail.</span>
<a href="#l24.1078"></a><span id="l24.1078"> </span>
<a href="#l24.1079"></a><span id="l24.1079">    (This assumes that, in the cases where From-mangling must happen,</span>
<a href="#l24.1080"></a><span id="l24.1080">    this function is called a line at a time.  That happens to be the</span>
<a href="#l24.1081"></a><span id="l24.1081">    case.)</span>
<a href="#l24.1082"></a><span id="l24.1082">   */</span>
<a href="#l24.1083"></a><span id="l24.1083">   if (size &gt;= 5 &amp;&amp; buf[0] == 'F' &amp;&amp; !strncmp(buf, &quot;From &quot;, 5)) {</span>
<a href="#l24.1084"></a><span id="l24.1084">     char mangle[] = &quot;&gt;&quot;;</span>
<a href="#l24.1085"></a><span id="l24.1085" class="difflineminus">-    nsresult res = MimeCryptoWriteBlock (mangle, 1);</span>
<a href="#l24.1086"></a><span id="l24.1086" class="difflineminus">-    if (NS_FAILED(res))</span>
<a href="#l24.1087"></a><span id="l24.1087" class="difflineminus">-      return res;</span>
<a href="#l24.1088"></a><span id="l24.1088" class="difflineplus">+    nsresult res = MimeCryptoWriteBlock(mangle, 1);</span>
<a href="#l24.1089"></a><span id="l24.1089" class="difflineplus">+    if (NS_FAILED(res)) return res;</span>
<a href="#l24.1090"></a><span id="l24.1090">     // This value will actually be cast back to an nsresult before use, so this</span>
<a href="#l24.1091"></a><span id="l24.1091">     // cast is reasonable under the circumstances.</span>
<a href="#l24.1092"></a><span id="l24.1092">     status = static_cast&lt;int&gt;(res);</span>
<a href="#l24.1093"></a><span id="l24.1093">   }</span>
<a href="#l24.1094"></a><span id="l24.1094"> </span>
<a href="#l24.1095"></a><span id="l24.1095">   /* If we're signing, or signing-and-encrypting, feed this data into</span>
<a href="#l24.1096"></a><span id="l24.1096">    the computation of the hash. */</span>
<a href="#l24.1097"></a><span id="l24.1097">   if (mDataHash) {</span>
<a href="#l24.1098"></a><span id="l24.1098" class="difflineminus">-    PR_SetError(0,0);</span>
<a href="#l24.1099"></a><span id="l24.1099" class="difflineminus">-    mDataHash-&gt;Update((const uint8_t*) buf, size);</span>
<a href="#l24.1100"></a><span id="l24.1100" class="difflineplus">+    PR_SetError(0, 0);</span>
<a href="#l24.1101"></a><span id="l24.1101" class="difflineplus">+    mDataHash-&gt;Update((const uint8_t *)buf, size);</span>
<a href="#l24.1102"></a><span id="l24.1102">     status = PR_GetError();</span>
<a href="#l24.1103"></a><span id="l24.1103">     if (status &lt; 0) goto FAIL;</span>
<a href="#l24.1104"></a><span id="l24.1104">   }</span>
<a href="#l24.1105"></a><span id="l24.1105"> </span>
<a href="#l24.1106"></a><span id="l24.1106" class="difflineminus">-  PR_SetError(0,0);</span>
<a href="#l24.1107"></a><span id="l24.1107" class="difflineplus">+  PR_SetError(0, 0);</span>
<a href="#l24.1108"></a><span id="l24.1108">   if (mEncryptionContext) {</span>
<a href="#l24.1109"></a><span id="l24.1109">     /* If we're encrypting, or signing-and-encrypting, write this data</span>
<a href="#l24.1110"></a><span id="l24.1110">        by filtering it through the crypto library. */</span>
<a href="#l24.1111"></a><span id="l24.1111"> </span>
<a href="#l24.1112"></a><span id="l24.1112">     /* We want to create equally sized encryption strings */</span>
<a href="#l24.1113"></a><span id="l24.1113">     const char *inputBytesIterator = buf;</span>
<a href="#l24.1114"></a><span id="l24.1114">     uint32_t inputBytesLeft = size;</span>
<a href="#l24.1115"></a><span id="l24.1115"> </span>
<a href="#l24.1116"></a><span id="l24.1116">     while (inputBytesLeft) {</span>
<a href="#l24.1117"></a><span id="l24.1117">       const uint32_t spaceLeftInBuffer = eBufferSize - mBufferedBytes;</span>
<a href="#l24.1118"></a><span id="l24.1118" class="difflineminus">-      const uint32_t bytesToAppend = std::min(inputBytesLeft, spaceLeftInBuffer);</span>
<a href="#l24.1119"></a><span id="l24.1119" class="difflineplus">+      const uint32_t bytesToAppend =</span>
<a href="#l24.1120"></a><span id="l24.1120" class="difflineplus">+          std::min(inputBytesLeft, spaceLeftInBuffer);</span>
<a href="#l24.1121"></a><span id="l24.1121"> </span>
<a href="#l24.1122"></a><span id="l24.1122" class="difflineminus">-      memcpy(mBuffer+mBufferedBytes, inputBytesIterator, bytesToAppend);</span>
<a href="#l24.1123"></a><span id="l24.1123" class="difflineplus">+      memcpy(mBuffer + mBufferedBytes, inputBytesIterator, bytesToAppend);</span>
<a href="#l24.1124"></a><span id="l24.1124">       mBufferedBytes += bytesToAppend;</span>
<a href="#l24.1125"></a><span id="l24.1125"> </span>
<a href="#l24.1126"></a><span id="l24.1126">       inputBytesIterator += bytesToAppend;</span>
<a href="#l24.1127"></a><span id="l24.1127">       inputBytesLeft -= bytesToAppend;</span>
<a href="#l24.1128"></a><span id="l24.1128"> </span>
<a href="#l24.1129"></a><span id="l24.1129">       if (eBufferSize == mBufferedBytes) {</span>
<a href="#l24.1130"></a><span id="l24.1130">         rv = mEncryptionContext-&gt;Update(mBuffer, mBufferedBytes);</span>
<a href="#l24.1131"></a><span id="l24.1131">         mBufferedBytes = 0;</span>
<a href="#l24.1132"></a><span id="l24.1132" class="difflineat">@@ -1031,70 +978,65 @@ NS_IMETHODIMP nsMsgComposeSecure::MimeCr</span>
<a href="#l24.1133"></a><span id="l24.1133"> </span>
<a href="#l24.1134"></a><span id="l24.1134">     uint32_t n;</span>
<a href="#l24.1135"></a><span id="l24.1135">     rv = mStream-&gt;Write(buf, size, &amp;n);</span>
<a href="#l24.1136"></a><span id="l24.1136">     if (NS_FAILED(rv) || n &lt; (uint32_t)size) {</span>
<a href="#l24.1137"></a><span id="l24.1137">       // XXX MK_MIME_ERROR_WRITING_FILE is -1, which is not a valid nsresult</span>
<a href="#l24.1138"></a><span id="l24.1138">       return static_cast&lt;nsresult&gt;(MK_MIME_ERROR_WRITING_FILE);</span>
<a href="#l24.1139"></a><span id="l24.1139">     }</span>
<a href="#l24.1140"></a><span id="l24.1140">   }</span>
<a href="#l24.1141"></a><span id="l24.1141" class="difflineminus">- FAIL:</span>
<a href="#l24.1142"></a><span id="l24.1142" class="difflineplus">+FAIL:</span>
<a href="#l24.1143"></a><span id="l24.1143">   // XXX status sometimes has invalid nsresults like -1 or PR_GetError()</span>
<a href="#l24.1144"></a><span id="l24.1144">   // assigned to it</span>
<a href="#l24.1145"></a><span id="l24.1145">   return static_cast&lt;nsresult&gt;(status);</span>
<a href="#l24.1146"></a><span id="l24.1146"> }</span>
<a href="#l24.1147"></a><span id="l24.1147"> </span>
<a href="#l24.1148"></a><span id="l24.1148"> /* Returns a string consisting of a Content-Type header, and a boundary</span>
<a href="#l24.1149"></a><span id="l24.1149">    string, suitable for moving from the header block, down into the body</span>
<a href="#l24.1150"></a><span id="l24.1150">    of a multipart object.  The boundary itself is also returned (so that</span>
<a href="#l24.1151"></a><span id="l24.1151">    the caller knows what to write to close it off.)</span>
<a href="#l24.1152"></a><span id="l24.1152">  */</span>
<a href="#l24.1153"></a><span id="l24.1153" class="difflineminus">-static nsresult</span>
<a href="#l24.1154"></a><span id="l24.1154" class="difflineminus">-make_multipart_signed_header_string(bool outer_p,</span>
<a href="#l24.1155"></a><span id="l24.1155" class="difflineminus">-                                    char **header_return,</span>
<a href="#l24.1156"></a><span id="l24.1156" class="difflineminus">-                                    char **boundary_return,</span>
<a href="#l24.1157"></a><span id="l24.1157" class="difflineminus">-                                    int16_t hash_type)</span>
<a href="#l24.1158"></a><span id="l24.1158" class="difflineminus">-{</span>
<a href="#l24.1159"></a><span id="l24.1159" class="difflineplus">+static nsresult make_multipart_signed_header_string(bool outer_p,</span>
<a href="#l24.1160"></a><span id="l24.1160" class="difflineplus">+                                                    char **header_return,</span>
<a href="#l24.1161"></a><span id="l24.1161" class="difflineplus">+                                                    char **boundary_return,</span>
<a href="#l24.1162"></a><span id="l24.1162" class="difflineplus">+                                                    int16_t hash_type) {</span>
<a href="#l24.1163"></a><span id="l24.1163">   const char *hashStr;</span>
<a href="#l24.1164"></a><span id="l24.1164">   *header_return = 0;</span>
<a href="#l24.1165"></a><span id="l24.1165">   *boundary_return = mime_make_separator(&quot;ms&quot;);</span>
<a href="#l24.1166"></a><span id="l24.1166"> </span>
<a href="#l24.1167"></a><span id="l24.1167" class="difflineminus">-  if (!*boundary_return)</span>
<a href="#l24.1168"></a><span id="l24.1168" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l24.1169"></a><span id="l24.1169" class="difflineplus">+  if (!*boundary_return) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l24.1170"></a><span id="l24.1170"> </span>
<a href="#l24.1171"></a><span id="l24.1171">   switch (hash_type) {</span>
<a href="#l24.1172"></a><span id="l24.1172" class="difflineminus">-  case nsICryptoHash::SHA1:</span>
<a href="#l24.1173"></a><span id="l24.1173" class="difflineminus">-    hashStr = PARAM_MICALG_SHA1;</span>
<a href="#l24.1174"></a><span id="l24.1174" class="difflineminus">-    break;</span>
<a href="#l24.1175"></a><span id="l24.1175" class="difflineminus">-  case nsICryptoHash::SHA256:</span>
<a href="#l24.1176"></a><span id="l24.1176" class="difflineminus">-    hashStr = PARAM_MICALG_SHA256;</span>
<a href="#l24.1177"></a><span id="l24.1177" class="difflineminus">-    break;</span>
<a href="#l24.1178"></a><span id="l24.1178" class="difflineminus">-  case nsICryptoHash::SHA384:</span>
<a href="#l24.1179"></a><span id="l24.1179" class="difflineminus">-    hashStr = PARAM_MICALG_SHA384;</span>
<a href="#l24.1180"></a><span id="l24.1180" class="difflineminus">-    break;</span>
<a href="#l24.1181"></a><span id="l24.1181" class="difflineminus">-  case nsICryptoHash::SHA512:</span>
<a href="#l24.1182"></a><span id="l24.1182" class="difflineminus">-    hashStr = PARAM_MICALG_SHA512;</span>
<a href="#l24.1183"></a><span id="l24.1183" class="difflineminus">-    break;</span>
<a href="#l24.1184"></a><span id="l24.1184" class="difflineminus">-  default:</span>
<a href="#l24.1185"></a><span id="l24.1185" class="difflineminus">-    return NS_ERROR_INVALID_ARG;</span>
<a href="#l24.1186"></a><span id="l24.1186" class="difflineplus">+    case nsICryptoHash::SHA1:</span>
<a href="#l24.1187"></a><span id="l24.1187" class="difflineplus">+      hashStr = PARAM_MICALG_SHA1;</span>
<a href="#l24.1188"></a><span id="l24.1188" class="difflineplus">+      break;</span>
<a href="#l24.1189"></a><span id="l24.1189" class="difflineplus">+    case nsICryptoHash::SHA256:</span>
<a href="#l24.1190"></a><span id="l24.1190" class="difflineplus">+      hashStr = PARAM_MICALG_SHA256;</span>
<a href="#l24.1191"></a><span id="l24.1191" class="difflineplus">+      break;</span>
<a href="#l24.1192"></a><span id="l24.1192" class="difflineplus">+    case nsICryptoHash::SHA384:</span>
<a href="#l24.1193"></a><span id="l24.1193" class="difflineplus">+      hashStr = PARAM_MICALG_SHA384;</span>
<a href="#l24.1194"></a><span id="l24.1194" class="difflineplus">+      break;</span>
<a href="#l24.1195"></a><span id="l24.1195" class="difflineplus">+    case nsICryptoHash::SHA512:</span>
<a href="#l24.1196"></a><span id="l24.1196" class="difflineplus">+      hashStr = PARAM_MICALG_SHA512;</span>
<a href="#l24.1197"></a><span id="l24.1197" class="difflineplus">+      break;</span>
<a href="#l24.1198"></a><span id="l24.1198" class="difflineplus">+    default:</span>
<a href="#l24.1199"></a><span id="l24.1199" class="difflineplus">+      return NS_ERROR_INVALID_ARG;</span>
<a href="#l24.1200"></a><span id="l24.1200">   }</span>
<a href="#l24.1201"></a><span id="l24.1201"> </span>
<a href="#l24.1202"></a><span id="l24.1202" class="difflineminus">-  *header_return = PR_smprintf(</span>
<a href="#l24.1203"></a><span id="l24.1203" class="difflineminus">-        &quot;Content-Type: &quot; MULTIPART_SIGNED &quot;; &quot;</span>
<a href="#l24.1204"></a><span id="l24.1204" class="difflineminus">-        &quot;protocol=\&quot;&quot; APPLICATION_PKCS7_SIGNATURE &quot;\&quot;; &quot;</span>
<a href="#l24.1205"></a><span id="l24.1205" class="difflineminus">-        &quot;micalg=%s; &quot;</span>
<a href="#l24.1206"></a><span id="l24.1206" class="difflineminus">-        &quot;boundary=\&quot;%s\&quot;&quot; CRLF</span>
<a href="#l24.1207"></a><span id="l24.1207" class="difflineminus">-        CRLF</span>
<a href="#l24.1208"></a><span id="l24.1208" class="difflineminus">-        &quot;%s%s&quot;</span>
<a href="#l24.1209"></a><span id="l24.1209" class="difflineminus">-        &quot;--%s&quot; CRLF,</span>
<a href="#l24.1210"></a><span id="l24.1210" class="difflineminus">-        hashStr,</span>
<a href="#l24.1211"></a><span id="l24.1211" class="difflineminus">-        *boundary_return,</span>
<a href="#l24.1212"></a><span id="l24.1212" class="difflineminus">-        (outer_p ? crypto_multipart_blurb : &quot;&quot;),</span>
<a href="#l24.1213"></a><span id="l24.1213" class="difflineminus">-        (outer_p ? CRLF CRLF : &quot;&quot;),</span>
<a href="#l24.1214"></a><span id="l24.1214" class="difflineminus">-        *boundary_return);</span>
<a href="#l24.1215"></a><span id="l24.1215" class="difflineplus">+  *header_return = PR_smprintf(&quot;Content-Type: &quot; MULTIPART_SIGNED</span>
<a href="#l24.1216"></a><span id="l24.1216" class="difflineplus">+                               &quot;; &quot;</span>
<a href="#l24.1217"></a><span id="l24.1217" class="difflineplus">+                               &quot;protocol=\&quot;&quot; APPLICATION_PKCS7_SIGNATURE</span>
<a href="#l24.1218"></a><span id="l24.1218" class="difflineplus">+                               &quot;\&quot;; &quot;</span>
<a href="#l24.1219"></a><span id="l24.1219" class="difflineplus">+                               &quot;micalg=%s; &quot;</span>
<a href="#l24.1220"></a><span id="l24.1220" class="difflineplus">+                               &quot;boundary=\&quot;%s\&quot;&quot; CRLF CRLF</span>
<a href="#l24.1221"></a><span id="l24.1221" class="difflineplus">+                               &quot;%s%s&quot;</span>
<a href="#l24.1222"></a><span id="l24.1222" class="difflineplus">+                               &quot;--%s&quot; CRLF,</span>
<a href="#l24.1223"></a><span id="l24.1223" class="difflineplus">+                               hashStr, *boundary_return,</span>
<a href="#l24.1224"></a><span id="l24.1224" class="difflineplus">+                               (outer_p ? crypto_multipart_blurb : &quot;&quot;),</span>
<a href="#l24.1225"></a><span id="l24.1225" class="difflineplus">+                               (outer_p ? CRLF CRLF : &quot;&quot;), *boundary_return);</span>
<a href="#l24.1226"></a><span id="l24.1226"> </span>
<a href="#l24.1227"></a><span id="l24.1227">   if (!*header_return) {</span>
<a href="#l24.1228"></a><span id="l24.1228">     PR_Free(*boundary_return);</span>
<a href="#l24.1229"></a><span id="l24.1229">     *boundary_return = 0;</span>
<a href="#l24.1230"></a><span id="l24.1230">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l24.1231"></a><span id="l24.1231">   }</span>
<a href="#l24.1232"></a><span id="l24.1232"> </span>
<a href="#l24.1233"></a><span id="l24.1233">   return NS_OK;</span>
<a href="#l24.1234"></a><span id="l24.1234" class="difflineat">@@ -1104,113 +1046,101 @@ make_multipart_signed_header_string(bool</span>
<a href="#l24.1235"></a><span id="l24.1235">    plaintext into the crypto engine, and it calls this function with encrypted</span>
<a href="#l24.1236"></a><span id="l24.1236">    data; then this function writes a base64-encoded representation of that</span>
<a href="#l24.1237"></a><span id="l24.1237">    data to the file (by filtering it through the given MimeEncoder object.)</span>
<a href="#l24.1238"></a><span id="l24.1238"> </span>
<a href="#l24.1239"></a><span id="l24.1239">    Also used as the output function of SEC_PKCS7Encode() -- but in that case,</span>
<a href="#l24.1240"></a><span id="l24.1240">    it's used to write the encoded representation of the signature.  The only</span>
<a href="#l24.1241"></a><span id="l24.1241">    difference is which MimeEncoder object is used.</span>
<a href="#l24.1242"></a><span id="l24.1242">  */</span>
<a href="#l24.1243"></a><span id="l24.1243" class="difflineminus">-static void</span>
<a href="#l24.1244"></a><span id="l24.1244" class="difflineminus">-mime_crypto_write_base64 (void *closure, const char *buf, unsigned long size)</span>
<a href="#l24.1245"></a><span id="l24.1245" class="difflineminus">-{</span>
<a href="#l24.1246"></a><span id="l24.1246" class="difflineminus">-  MimeEncoder *encoder = (MimeEncoder *) closure;</span>
<a href="#l24.1247"></a><span id="l24.1247" class="difflineplus">+static void mime_crypto_write_base64(void *closure, const char *buf,</span>
<a href="#l24.1248"></a><span id="l24.1248" class="difflineplus">+                                     unsigned long size) {</span>
<a href="#l24.1249"></a><span id="l24.1249" class="difflineplus">+  MimeEncoder *encoder = (MimeEncoder *)closure;</span>
<a href="#l24.1250"></a><span id="l24.1250">   nsresult rv = encoder-&gt;Write(buf, size);</span>
<a href="#l24.1251"></a><span id="l24.1251">   PR_SetError(NS_FAILED(rv) ? static_cast&lt;uint32_t&gt;(rv) : 0, 0);</span>
<a href="#l24.1252"></a><span id="l24.1252"> }</span>
<a href="#l24.1253"></a><span id="l24.1253"> </span>
<a href="#l24.1254"></a><span id="l24.1254" class="difflineminus">-</span>
<a href="#l24.1255"></a><span id="l24.1255"> /* Used as the output function of MimeEncoder -- when we have generated</span>
<a href="#l24.1256"></a><span id="l24.1256">    the signature for a multipart/signed object, this is used to write the</span>
<a href="#l24.1257"></a><span id="l24.1257">    base64-encoded representation of the signature to the file.</span>
<a href="#l24.1258"></a><span id="l24.1258">  */</span>
<a href="#l24.1259"></a><span id="l24.1259"> // TODO: size should probably be converted to uint32_t</span>
<a href="#l24.1260"></a><span id="l24.1260" class="difflineminus">-nsresult mime_encoder_output_fn(const char *buf, int32_t size, void *closure)</span>
<a href="#l24.1261"></a><span id="l24.1261" class="difflineminus">-{</span>
<a href="#l24.1262"></a><span id="l24.1262" class="difflineminus">-  nsMsgComposeSecure *state = (nsMsgComposeSecure *) closure;</span>
<a href="#l24.1263"></a><span id="l24.1263" class="difflineplus">+nsresult mime_encoder_output_fn(const char *buf, int32_t size, void *closure) {</span>
<a href="#l24.1264"></a><span id="l24.1264" class="difflineplus">+  nsMsgComposeSecure *state = (nsMsgComposeSecure *)closure;</span>
<a href="#l24.1265"></a><span id="l24.1265">   nsCOMPtr&lt;nsIOutputStream&gt; stream;</span>
<a href="#l24.1266"></a><span id="l24.1266">   state-&gt;GetOutputStream(getter_AddRefs(stream));</span>
<a href="#l24.1267"></a><span id="l24.1267">   uint32_t n;</span>
<a href="#l24.1268"></a><span id="l24.1268" class="difflineminus">-  nsresult rv = stream-&gt;Write((char *) buf, size, &amp;n);</span>
<a href="#l24.1269"></a><span id="l24.1269" class="difflineplus">+  nsresult rv = stream-&gt;Write((char *)buf, size, &amp;n);</span>
<a href="#l24.1270"></a><span id="l24.1270">   if (NS_FAILED(rv) || n &lt; (uint32_t)size)</span>
<a href="#l24.1271"></a><span id="l24.1271">     return NS_ERROR_FAILURE;</span>
<a href="#l24.1272"></a><span id="l24.1272">   else</span>
<a href="#l24.1273"></a><span id="l24.1273">     return NS_OK;</span>
<a href="#l24.1274"></a><span id="l24.1274"> }</span>
<a href="#l24.1275"></a><span id="l24.1275"> </span>
<a href="#l24.1276"></a><span id="l24.1276"> /* Like mime_encoder_output_fn, except this is used for the case where we</span>
<a href="#l24.1277"></a><span id="l24.1277">    are both signing and encrypting -- the base64-encoded output of the</span>
<a href="#l24.1278"></a><span id="l24.1278">    signature should be fed into the crypto engine, rather than being written</span>
<a href="#l24.1279"></a><span id="l24.1279">    directly to the file.</span>
<a href="#l24.1280"></a><span id="l24.1280">  */</span>
<a href="#l24.1281"></a><span id="l24.1281" class="difflineminus">-static nsresult</span>
<a href="#l24.1282"></a><span id="l24.1282" class="difflineminus">-mime_nested_encoder_output_fn (const char *buf, int32_t size, void *closure)</span>
<a href="#l24.1283"></a><span id="l24.1283" class="difflineminus">-{</span>
<a href="#l24.1284"></a><span id="l24.1284" class="difflineminus">-  nsMsgComposeSecure *state = (nsMsgComposeSecure *) closure;</span>
<a href="#l24.1285"></a><span id="l24.1285" class="difflineplus">+static nsresult mime_nested_encoder_output_fn(const char *buf, int32_t size,</span>
<a href="#l24.1286"></a><span id="l24.1286" class="difflineplus">+                                              void *closure) {</span>
<a href="#l24.1287"></a><span id="l24.1287" class="difflineplus">+  nsMsgComposeSecure *state = (nsMsgComposeSecure *)closure;</span>
<a href="#l24.1288"></a><span id="l24.1288"> </span>
<a href="#l24.1289"></a><span id="l24.1289">   // Copy to new null-terminated string so JS glue doesn't crash when</span>
<a href="#l24.1290"></a><span id="l24.1290">   // MimeCryptoWriteBlock() is implemented in JS.</span>
<a href="#l24.1291"></a><span id="l24.1291">   nsCString bufWithNull;</span>
<a href="#l24.1292"></a><span id="l24.1292">   bufWithNull.Assign(buf, size);</span>
<a href="#l24.1293"></a><span id="l24.1293">   return state-&gt;MimeCryptoWriteBlock(bufWithNull.get(), size);</span>
<a href="#l24.1294"></a><span id="l24.1294"> }</span>
<a href="#l24.1295"></a><span id="l24.1295"> </span>
<a href="#l24.1296"></a><span id="l24.1296"> NS_IMETHODIMP</span>
<a href="#l24.1297"></a><span id="l24.1297" class="difflineminus">-nsMsgComposeSecure::FindCertByEmailAddress(const nsACString&amp; aEmailAddress,</span>
<a href="#l24.1298"></a><span id="l24.1298" class="difflineplus">+nsMsgComposeSecure::FindCertByEmailAddress(const nsACString &amp;aEmailAddress,</span>
<a href="#l24.1299"></a><span id="l24.1299">                                            bool aRequireValidCert,</span>
<a href="#l24.1300"></a><span id="l24.1300" class="difflineminus">-                                           nsIX509Cert** _retval)</span>
<a href="#l24.1301"></a><span id="l24.1301" class="difflineminus">-{</span>
<a href="#l24.1302"></a><span id="l24.1302" class="difflineplus">+                                           nsIX509Cert **_retval) {</span>
<a href="#l24.1303"></a><span id="l24.1303">   nsresult rv = BlockUntilLoadableRootsLoaded();</span>
<a href="#l24.1304"></a><span id="l24.1304">   if (NS_FAILED(rv)) {</span>
<a href="#l24.1305"></a><span id="l24.1305">     return rv;</span>
<a href="#l24.1306"></a><span id="l24.1306">   }</span>
<a href="#l24.1307"></a><span id="l24.1307"> </span>
<a href="#l24.1308"></a><span id="l24.1308">   RefPtr&lt;SharedCertVerifier&gt; certVerifier(GetDefaultCertVerifier());</span>
<a href="#l24.1309"></a><span id="l24.1309">   NS_ENSURE_TRUE(certVerifier, NS_ERROR_UNEXPECTED);</span>
<a href="#l24.1310"></a><span id="l24.1310"> </span>
<a href="#l24.1311"></a><span id="l24.1311" class="difflineminus">-  const nsCString&amp; flatEmailAddress = PromiseFlatCString(aEmailAddress);</span>
<a href="#l24.1312"></a><span id="l24.1312" class="difflineplus">+  const nsCString &amp;flatEmailAddress = PromiseFlatCString(aEmailAddress);</span>
<a href="#l24.1313"></a><span id="l24.1313">   UniqueCERTCertList certlist(</span>
<a href="#l24.1314"></a><span id="l24.1314" class="difflineminus">-    PK11_FindCertsFromEmailAddress(flatEmailAddress.get(), nullptr));</span>
<a href="#l24.1315"></a><span id="l24.1315" class="difflineminus">-  if (!certlist)</span>
<a href="#l24.1316"></a><span id="l24.1316" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l24.1317"></a><span id="l24.1317" class="difflineplus">+      PK11_FindCertsFromEmailAddress(flatEmailAddress.get(), nullptr));</span>
<a href="#l24.1318"></a><span id="l24.1318" class="difflineplus">+  if (!certlist) return NS_ERROR_FAILURE;</span>
<a href="#l24.1319"></a><span id="l24.1319"> </span>
<a href="#l24.1320"></a><span id="l24.1320">   // certlist now contains certificates with the right email address,</span>
<a href="#l24.1321"></a><span id="l24.1321">   // but they might not have the correct usage or might even be invalid</span>
<a href="#l24.1322"></a><span id="l24.1322"> </span>
<a href="#l24.1323"></a><span id="l24.1323">   if (CERT_LIST_END(CERT_LIST_HEAD(certlist), certlist))</span>
<a href="#l24.1324"></a><span id="l24.1324" class="difflineminus">-    return NS_ERROR_FAILURE; // no certs found</span>
<a href="#l24.1325"></a><span id="l24.1325" class="difflineplus">+    return NS_ERROR_FAILURE;  // no certs found</span>
<a href="#l24.1326"></a><span id="l24.1326"> </span>
<a href="#l24.1327"></a><span id="l24.1327">   CERTCertListNode *node;</span>
<a href="#l24.1328"></a><span id="l24.1328">   // search for a valid certificate</span>
<a href="#l24.1329"></a><span id="l24.1329" class="difflineminus">-  for (node = CERT_LIST_HEAD(certlist);</span>
<a href="#l24.1330"></a><span id="l24.1330" class="difflineminus">-       !CERT_LIST_END(node, certlist);</span>
<a href="#l24.1331"></a><span id="l24.1331" class="difflineplus">+  for (node = CERT_LIST_HEAD(certlist); !CERT_LIST_END(node, certlist);</span>
<a href="#l24.1332"></a><span id="l24.1332">        node = CERT_LIST_NEXT(node)) {</span>
<a href="#l24.1333"></a><span id="l24.1333">     UniqueCERTCertList unusedCertChain;</span>
<a href="#l24.1334"></a><span id="l24.1334" class="difflineminus">-    mozilla::pkix::Result result =</span>
<a href="#l24.1335"></a><span id="l24.1335" class="difflineminus">-      certVerifier-&gt;VerifyCert(node-&gt;cert, certificateUsageEmailRecipient,</span>
<a href="#l24.1336"></a><span id="l24.1336" class="difflineminus">-                               mozilla::pkix::Now(),</span>
<a href="#l24.1337"></a><span id="l24.1337" class="difflineminus">-                               nullptr /*XXX pinarg*/,</span>
<a href="#l24.1338"></a><span id="l24.1338" class="difflineminus">-                               nullptr /*hostname*/,</span>
<a href="#l24.1339"></a><span id="l24.1339" class="difflineminus">-                               unusedCertChain,</span>
<a href="#l24.1340"></a><span id="l24.1340" class="difflineminus">-                               // Only local checks can run on the main thread.</span>
<a href="#l24.1341"></a><span id="l24.1341" class="difflineminus">-                               CertVerifier::FLAG_LOCAL_ONLY);</span>
<a href="#l24.1342"></a><span id="l24.1342" class="difflineplus">+    mozilla::pkix::Result result = certVerifier-&gt;VerifyCert(</span>
<a href="#l24.1343"></a><span id="l24.1343" class="difflineplus">+        node-&gt;cert, certificateUsageEmailRecipient, mozilla::pkix::Now(),</span>
<a href="#l24.1344"></a><span id="l24.1344" class="difflineplus">+        nullptr /*XXX pinarg*/, nullptr /*hostname*/, unusedCertChain,</span>
<a href="#l24.1345"></a><span id="l24.1345" class="difflineplus">+        // Only local checks can run on the main thread.</span>
<a href="#l24.1346"></a><span id="l24.1346" class="difflineplus">+        CertVerifier::FLAG_LOCAL_ONLY);</span>
<a href="#l24.1347"></a><span id="l24.1347">     if (result == mozilla::pkix::Success) {</span>
<a href="#l24.1348"></a><span id="l24.1348">       break;</span>
<a href="#l24.1349"></a><span id="l24.1349">     }</span>
<a href="#l24.1350"></a><span id="l24.1350">   }</span>
<a href="#l24.1351"></a><span id="l24.1351"> </span>
<a href="#l24.1352"></a><span id="l24.1352" class="difflineminus">-  if (CERT_LIST_END(node, certlist)) { // no valid cert found</span>
<a href="#l24.1353"></a><span id="l24.1353" class="difflineminus">-    if (aRequireValidCert)</span>
<a href="#l24.1354"></a><span id="l24.1354" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l24.1355"></a><span id="l24.1355" class="difflineplus">+  if (CERT_LIST_END(node, certlist)) {  // no valid cert found</span>
<a href="#l24.1356"></a><span id="l24.1356" class="difflineplus">+    if (aRequireValidCert) return NS_ERROR_FAILURE;</span>
<a href="#l24.1357"></a><span id="l24.1357"> </span>
<a href="#l24.1358"></a><span id="l24.1358">     // Get the first non-valid then.</span>
<a href="#l24.1359"></a><span id="l24.1359">     node = CERT_LIST_HEAD(certlist);</span>
<a href="#l24.1360"></a><span id="l24.1360">   }</span>
<a href="#l24.1361"></a><span id="l24.1361"> </span>
<a href="#l24.1362"></a><span id="l24.1362">   // |node| now contains the first valid (if aRequireValidCert true)</span>
<a href="#l24.1363"></a><span id="l24.1363">   // certificate with correct usage.</span>
<a href="#l24.1364"></a><span id="l24.1364">   RefPtr&lt;nsNSSCertificate&gt; nssCert = nsNSSCertificate::Create(node-&gt;cert);</span>
<a href="#l24.1365"></a><span id="l24.1365" class="difflineminus">-  if (!nssCert)</span>
<a href="#l24.1366"></a><span id="l24.1366" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l24.1367"></a><span id="l24.1367" class="difflineplus">+  if (!nssCert) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l24.1368"></a><span id="l24.1368"> </span>
<a href="#l24.1369"></a><span id="l24.1369">   nssCert.forget(_retval);</span>
<a href="#l24.1370"></a><span id="l24.1370">   return NS_OK;</span>
<a href="#l24.1371"></a><span id="l24.1371"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/extensions/smime/src/nsMsgComposeSecure.h</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/extensions/smime/src/nsMsgComposeSecure.h</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -18,51 +18,56 @@</span>
<a href="#l25.4"></a><span id="l25.4"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l25.5"></a><span id="l25.5"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l25.6"></a><span id="l25.6"> </span>
<a href="#l25.7"></a><span id="l25.7"> class nsIMsgCompFields;</span>
<a href="#l25.8"></a><span id="l25.8"> namespace mozilla {</span>
<a href="#l25.9"></a><span id="l25.9"> namespace mailnews {</span>
<a href="#l25.10"></a><span id="l25.10"> class MimeEncoder;</span>
<a href="#l25.11"></a><span id="l25.11"> }</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-}</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+}  // namespace mozilla</span>
<a href="#l25.14"></a><span id="l25.14"> </span>
<a href="#l25.15"></a><span id="l25.15"> typedef enum {</span>
<a href="#l25.16"></a><span id="l25.16">   mime_crypto_none,            /* normal unencapsulated MIME message */</span>
<a href="#l25.17"></a><span id="l25.17">   mime_crypto_clear_signed,    /* multipart/signed encapsulation */</span>
<a href="#l25.18"></a><span id="l25.18">   mime_crypto_opaque_signed,   /* application/x-pkcs7-mime (signedData) */</span>
<a href="#l25.19"></a><span id="l25.19">   mime_crypto_encrypted,       /* application/x-pkcs7-mime */</span>
<a href="#l25.20"></a><span id="l25.20">   mime_crypto_signed_encrypted /* application/x-pkcs7-mime */</span>
<a href="#l25.21"></a><span id="l25.21"> } mimeDeliveryCryptoState;</span>
<a href="#l25.22"></a><span id="l25.22"> </span>
<a href="#l25.23"></a><span id="l25.23" class="difflineminus">-class nsMsgComposeSecure : public nsIMsgComposeSecure</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineminus">-{</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineminus">-public:</span>
<a href="#l25.26"></a><span id="l25.26" class="difflineplus">+class nsMsgComposeSecure : public nsIMsgComposeSecure {</span>
<a href="#l25.27"></a><span id="l25.27" class="difflineplus">+ public:</span>
<a href="#l25.28"></a><span id="l25.28">   NS_DECL_ISUPPORTS</span>
<a href="#l25.29"></a><span id="l25.29">   NS_DECL_NSIMSGCOMPOSESECURE</span>
<a href="#l25.30"></a><span id="l25.30"> </span>
<a href="#l25.31"></a><span id="l25.31">   nsMsgComposeSecure();</span>
<a href="#l25.32"></a><span id="l25.32"> </span>
<a href="#l25.33"></a><span id="l25.33" class="difflineminus">-  void GetOutputStream(nsIOutputStream **stream) { NS_IF_ADDREF(*stream = mStream);}</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineplus">+  void GetOutputStream(nsIOutputStream **stream) {</span>
<a href="#l25.35"></a><span id="l25.35" class="difflineplus">+    NS_IF_ADDREF(*stream = mStream);</span>
<a href="#l25.36"></a><span id="l25.36" class="difflineplus">+  }</span>
<a href="#l25.37"></a><span id="l25.37">   nsresult GetSMIMEBundleString(const char16_t *name, nsString &amp;outString);</span>
<a href="#l25.38"></a><span id="l25.38"> </span>
<a href="#l25.39"></a><span id="l25.39" class="difflineminus">-private:</span>
<a href="#l25.40"></a><span id="l25.40" class="difflineplus">+ private:</span>
<a href="#l25.41"></a><span id="l25.41">   virtual ~nsMsgComposeSecure();</span>
<a href="#l25.42"></a><span id="l25.42">   typedef mozilla::mailnews::MimeEncoder MimeEncoder;</span>
<a href="#l25.43"></a><span id="l25.43">   nsresult MimeInitMultipartSigned(bool aOuter, nsIMsgSendReport *sendReport);</span>
<a href="#l25.44"></a><span id="l25.44">   nsresult MimeInitEncryption(bool aSign, nsIMsgSendReport *sendReport);</span>
<a href="#l25.45"></a><span id="l25.45" class="difflineminus">-  nsresult MimeFinishMultipartSigned (bool aOuter, nsIMsgSendReport *sendReport);</span>
<a href="#l25.46"></a><span id="l25.46" class="difflineminus">-  nsresult MimeFinishEncryption (bool aSign, nsIMsgSendReport *sendReport);</span>
<a href="#l25.47"></a><span id="l25.47" class="difflineminus">-  nsresult MimeCryptoHackCerts(const char *aRecipients, nsIMsgSendReport *sendReport, bool aEncrypt, bool aSign, nsIMsgIdentity *aIdentity);</span>
<a href="#l25.48"></a><span id="l25.48" class="difflineplus">+  nsresult MimeFinishMultipartSigned(bool aOuter, nsIMsgSendReport *sendReport);</span>
<a href="#l25.49"></a><span id="l25.49" class="difflineplus">+  nsresult MimeFinishEncryption(bool aSign, nsIMsgSendReport *sendReport);</span>
<a href="#l25.50"></a><span id="l25.50" class="difflineplus">+  nsresult MimeCryptoHackCerts(const char *aRecipients,</span>
<a href="#l25.51"></a><span id="l25.51" class="difflineplus">+                               nsIMsgSendReport *sendReport, bool aEncrypt,</span>
<a href="#l25.52"></a><span id="l25.52" class="difflineplus">+                               bool aSign, nsIMsgIdentity *aIdentity);</span>
<a href="#l25.53"></a><span id="l25.53">   bool InitializeSMIMEBundle();</span>
<a href="#l25.54"></a><span id="l25.54">   nsresult SMIMEBundleFormatStringFromName(const char *name,</span>
<a href="#l25.55"></a><span id="l25.55">                                            const char16_t **params,</span>
<a href="#l25.56"></a><span id="l25.56">                                            uint32_t numParams,</span>
<a href="#l25.57"></a><span id="l25.57" class="difflineminus">-                                           nsAString&amp; outString);</span>
<a href="#l25.58"></a><span id="l25.58" class="difflineminus">-  nsresult ExtractEncryptionState(nsIMsgIdentity * aIdentity, nsIMsgCompFields * aComposeFields, bool * aSignMessage, bool * aEncrypt);</span>
<a href="#l25.59"></a><span id="l25.59" class="difflineplus">+                                           nsAString &amp;outString);</span>
<a href="#l25.60"></a><span id="l25.60" class="difflineplus">+  nsresult ExtractEncryptionState(nsIMsgIdentity *aIdentity,</span>
<a href="#l25.61"></a><span id="l25.61" class="difflineplus">+                                  nsIMsgCompFields *aComposeFields,</span>
<a href="#l25.62"></a><span id="l25.62" class="difflineplus">+                                  bool *aSignMessage, bool *aEncrypt);</span>
<a href="#l25.63"></a><span id="l25.63"> </span>
<a href="#l25.64"></a><span id="l25.64">   bool mSignMessage;</span>
<a href="#l25.65"></a><span id="l25.65">   bool mAlwaysEncryptMessage;</span>
<a href="#l25.66"></a><span id="l25.66">   mimeDeliveryCryptoState mCryptoState;</span>
<a href="#l25.67"></a><span id="l25.67">   nsCOMPtr&lt;nsIOutputStream&gt; mStream;</span>
<a href="#l25.68"></a><span id="l25.68">   int16_t mHashType;</span>
<a href="#l25.69"></a><span id="l25.69">   nsCOMPtr&lt;nsICryptoHash&gt; mDataHash;</span>
<a href="#l25.70"></a><span id="l25.70">   nsAutoPtr&lt;MimeEncoder&gt; mSigEncoder;</span>
<a href="#l25.71"></a><span id="l25.71" class="difflineat">@@ -76,18 +81,19 @@ private:</span>
<a href="#l25.72"></a><span id="l25.72">   nsCOMPtr&lt;nsIMutableArray&gt; mCerts;</span>
<a href="#l25.73"></a><span id="l25.73">   nsCOMPtr&lt;nsICMSMessage&gt; mEncryptionCinfo;</span>
<a href="#l25.74"></a><span id="l25.74">   nsCOMPtr&lt;nsICMSEncoder&gt; mEncryptionContext;</span>
<a href="#l25.75"></a><span id="l25.75">   nsCOMPtr&lt;nsIStringBundle&gt; mSMIMEBundle;</span>
<a href="#l25.76"></a><span id="l25.76"> </span>
<a href="#l25.77"></a><span id="l25.77">   nsAutoPtr&lt;MimeEncoder&gt; mCryptoEncoder;</span>
<a href="#l25.78"></a><span id="l25.78">   bool mIsDraft;</span>
<a href="#l25.79"></a><span id="l25.79"> </span>
<a href="#l25.80"></a><span id="l25.80" class="difflineminus">-  enum {eBufferSize = 8192};</span>
<a href="#l25.81"></a><span id="l25.81" class="difflineplus">+  enum { eBufferSize = 8192 };</span>
<a href="#l25.82"></a><span id="l25.82">   char *mBuffer;</span>
<a href="#l25.83"></a><span id="l25.83">   uint32_t mBufferedBytes;</span>
<a href="#l25.84"></a><span id="l25.84"> </span>
<a href="#l25.85"></a><span id="l25.85">   bool mErrorAlreadyReported;</span>
<a href="#l25.86"></a><span id="l25.86">   void SetError(nsIMsgSendReport *sendReport, const char16_t *bundle_string);</span>
<a href="#l25.87"></a><span id="l25.87" class="difflineminus">-  void SetErrorWithParam(nsIMsgSendReport *sendReport, const char *bundle_string, const char *param);</span>
<a href="#l25.88"></a><span id="l25.88" class="difflineplus">+  void SetErrorWithParam(nsIMsgSendReport *sendReport,</span>
<a href="#l25.89"></a><span id="l25.89" class="difflineplus">+                         const char *bundle_string, const char *param);</span>
<a href="#l25.90"></a><span id="l25.90"> };</span>
<a href="#l25.91"></a><span id="l25.91"> </span>
<a href="#l25.92"></a><span id="l25.92"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/extensions/smime/src/nsMsgSMIMECID.h</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/extensions/smime/src/nsMsgSMIMECID.h</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -1,30 +1,36 @@</span>
<a href="#l26.4"></a><span id="l26.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l26.5"></a><span id="l26.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l26.6"></a><span id="l26.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l26.7"></a><span id="l26.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l26.8"></a><span id="l26.8"> </span>
<a href="#l26.9"></a><span id="l26.9"> #ifndef nsMsgSMIMECID_h__</span>
<a href="#l26.10"></a><span id="l26.10"> #define nsMsgSMIMECID_h__</span>
<a href="#l26.11"></a><span id="l26.11"> </span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-#define NS_MSGCOMPOSESECURE_CID                  \</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-{ /* 54976882-7421-4286-8ecc-46373f15d7b5 */     \</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineminus">- 0x54976882, 0x7421, 0x4286,                     \</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineminus">- {0x8e, 0xcc, 0x46, 0x37, 0x3f, 0x15, 0xd7, 0xb5 }}</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineplus">+#define NS_MSGCOMPOSESECURE_CID                      \</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineplus">+  { /* 54976882-7421-4286-8ecc-46373f15d7b5 */       \</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineplus">+    0x54976882, 0x7421, 0x4286, {                    \</span>
<a href="#l26.19"></a><span id="l26.19" class="difflineplus">+      0x8e, 0xcc, 0x46, 0x37, 0x3f, 0x15, 0xd7, 0xb5 \</span>
<a href="#l26.20"></a><span id="l26.20" class="difflineplus">+    }                                                \</span>
<a href="#l26.21"></a><span id="l26.21" class="difflineplus">+  }</span>
<a href="#l26.22"></a><span id="l26.22"> </span>
<a href="#l26.23"></a><span id="l26.23"> #define NS_SMIMEJSHELPER_CONTRACTID \</span>
<a href="#l26.24"></a><span id="l26.24">   &quot;@mozilla.org/messenger-smime/smimejshelper;1&quot;</span>
<a href="#l26.25"></a><span id="l26.25"> </span>
<a href="#l26.26"></a><span id="l26.26" class="difflineminus">-#define NS_SMIMEJSJELPER_CID                     \</span>
<a href="#l26.27"></a><span id="l26.27" class="difflineminus">-{ /* d57d928c-60e4-4f81-999d-5c762e611205 */     \</span>
<a href="#l26.28"></a><span id="l26.28" class="difflineminus">- 0xd57d928c, 0x60e4, 0x4f81,                     \</span>
<a href="#l26.29"></a><span id="l26.29" class="difflineminus">- {0x99, 0x9d, 0x5c, 0x76, 0x2e, 0x61, 0x12, 0x05 }}</span>
<a href="#l26.30"></a><span id="l26.30" class="difflineplus">+#define NS_SMIMEJSJELPER_CID                         \</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineplus">+  { /* d57d928c-60e4-4f81-999d-5c762e611205 */       \</span>
<a href="#l26.32"></a><span id="l26.32" class="difflineplus">+    0xd57d928c, 0x60e4, 0x4f81, {                    \</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineplus">+      0x99, 0x9d, 0x5c, 0x76, 0x2e, 0x61, 0x12, 0x05 \</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineplus">+    }                                                \</span>
<a href="#l26.35"></a><span id="l26.35" class="difflineplus">+  }</span>
<a href="#l26.36"></a><span id="l26.36"> </span>
<a href="#l26.37"></a><span id="l26.37" class="difflineminus">-#define NS_SMIMEENCRYPTURISERVICE_CONTRACTID     \</span>
<a href="#l26.38"></a><span id="l26.38" class="difflineplus">+#define NS_SMIMEENCRYPTURISERVICE_CONTRACTID \</span>
<a href="#l26.39"></a><span id="l26.39">   &quot;@mozilla.org/messenger-smime/smime-encrypted-uris-service;1&quot;</span>
<a href="#l26.40"></a><span id="l26.40"> </span>
<a href="#l26.41"></a><span id="l26.41" class="difflineminus">-#define NS_SMIMEENCRYPTURISERVICE_CID            \</span>
<a href="#l26.42"></a><span id="l26.42" class="difflineminus">-{ /* a0134d58-018f-4d40-a099-fa079e5024a6 */     \</span>
<a href="#l26.43"></a><span id="l26.43" class="difflineminus">- 0xa0134d58, 0x018f, 0x4d40,                     \</span>
<a href="#l26.44"></a><span id="l26.44" class="difflineminus">- {0xa0, 0x99, 0xfa, 0x07, 0x9e, 0x50, 0x24, 0xa6 }}</span>
<a href="#l26.45"></a><span id="l26.45" class="difflineplus">+#define NS_SMIMEENCRYPTURISERVICE_CID                \</span>
<a href="#l26.46"></a><span id="l26.46" class="difflineplus">+  { /* a0134d58-018f-4d40-a099-fa079e5024a6 */       \</span>
<a href="#l26.47"></a><span id="l26.47" class="difflineplus">+    0xa0134d58, 0x018f, 0x4d40, {                    \</span>
<a href="#l26.48"></a><span id="l26.48" class="difflineplus">+      0xa0, 0x99, 0xfa, 0x07, 0x9e, 0x50, 0x24, 0xa6 \</span>
<a href="#l26.49"></a><span id="l26.49" class="difflineplus">+    }                                                \</span>
<a href="#l26.50"></a><span id="l26.50" class="difflineplus">+  }</span>
<a href="#l26.51"></a><span id="l26.51"> </span>
<a href="#l26.52"></a><span id="l26.52" class="difflineminus">-#endif // nsMsgSMIMECID_h__</span>
<a href="#l26.53"></a><span id="l26.53" class="difflineplus">+#endif  // nsMsgSMIMECID_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/extensions/smime/src/nsSMimeJSHelper.cpp</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/extensions/smime/src/nsSMimeJSHelper.cpp</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -15,34 +15,24 @@</span>
<a href="#l27.4"></a><span id="l27.4"> #include &quot;nsIX509CertValidity.h&quot;</span>
<a href="#l27.5"></a><span id="l27.5"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l27.6"></a><span id="l27.6"> #include &quot;nsCRTGlue.h&quot;</span>
<a href="#l27.7"></a><span id="l27.7"> </span>
<a href="#l27.8"></a><span id="l27.8"> using namespace mozilla::mailnews;</span>
<a href="#l27.9"></a><span id="l27.9"> </span>
<a href="#l27.10"></a><span id="l27.10"> NS_IMPL_ISUPPORTS(nsSMimeJSHelper, nsISMimeJSHelper)</span>
<a href="#l27.11"></a><span id="l27.11"> </span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-nsSMimeJSHelper::nsSMimeJSHelper()</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-{</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineminus">-}</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineplus">+nsSMimeJSHelper::nsSMimeJSHelper() {}</span>
<a href="#l27.16"></a><span id="l27.16"> </span>
<a href="#l27.17"></a><span id="l27.17" class="difflineminus">-nsSMimeJSHelper::~nsSMimeJSHelper()</span>
<a href="#l27.18"></a><span id="l27.18" class="difflineminus">-{</span>
<a href="#l27.19"></a><span id="l27.19" class="difflineminus">-}</span>
<a href="#l27.20"></a><span id="l27.20" class="difflineplus">+nsSMimeJSHelper::~nsSMimeJSHelper() {}</span>
<a href="#l27.21"></a><span id="l27.21"> </span>
<a href="#l27.22"></a><span id="l27.22"> NS_IMETHODIMP nsSMimeJSHelper::GetRecipientCertsInfo(</span>
<a href="#l27.23"></a><span id="l27.23" class="difflineminus">-    nsIMsgCompFields *compFields,</span>
<a href="#l27.24"></a><span id="l27.24" class="difflineminus">-    uint32_t *count,</span>
<a href="#l27.25"></a><span id="l27.25" class="difflineminus">-    char16_t ***emailAddresses,</span>
<a href="#l27.26"></a><span id="l27.26" class="difflineminus">-    int32_t **certVerification,</span>
<a href="#l27.27"></a><span id="l27.27" class="difflineminus">-    char16_t ***certIssuedInfos,</span>
<a href="#l27.28"></a><span id="l27.28" class="difflineminus">-    char16_t ***certExpiresInfos,</span>
<a href="#l27.29"></a><span id="l27.29" class="difflineminus">-    nsIX509Cert ***certs,</span>
<a href="#l27.30"></a><span id="l27.30" class="difflineminus">-    bool *canEncrypt)</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineminus">-{</span>
<a href="#l27.32"></a><span id="l27.32" class="difflineplus">+    nsIMsgCompFields *compFields, uint32_t *count, char16_t ***emailAddresses,</span>
<a href="#l27.33"></a><span id="l27.33" class="difflineplus">+    int32_t **certVerification, char16_t ***certIssuedInfos,</span>
<a href="#l27.34"></a><span id="l27.34" class="difflineplus">+    char16_t ***certExpiresInfos, nsIX509Cert ***certs, bool *canEncrypt) {</span>
<a href="#l27.35"></a><span id="l27.35">   NS_ENSURE_ARG_POINTER(count);</span>
<a href="#l27.36"></a><span id="l27.36">   *count = 0;</span>
<a href="#l27.37"></a><span id="l27.37"> </span>
<a href="#l27.38"></a><span id="l27.38">   NS_ENSURE_ARG_POINTER(emailAddresses);</span>
<a href="#l27.39"></a><span id="l27.39">   NS_ENSURE_ARG_POINTER(certVerification);</span>
<a href="#l27.40"></a><span id="l27.40">   NS_ENSURE_ARG_POINTER(certIssuedInfos);</span>
<a href="#l27.41"></a><span id="l27.41">   NS_ENSURE_ARG_POINTER(certExpiresInfos);</span>
<a href="#l27.42"></a><span id="l27.42">   NS_ENSURE_ARG_POINTER(certs);</span>
<a href="#l27.43"></a><span id="l27.43" class="difflineat">@@ -57,52 +47,51 @@ NS_IMETHODIMP nsSMimeJSHelper::GetRecipi</span>
<a href="#l27.44"></a><span id="l27.44">   uint32_t mailbox_count = mailboxes.Length();</span>
<a href="#l27.45"></a><span id="l27.45"> </span>
<a href="#l27.46"></a><span id="l27.46">   nsCOMPtr&lt;nsIX509CertDB&gt; certdb = do_GetService(NS_X509CERTDB_CONTRACTID);</span>
<a href="#l27.47"></a><span id="l27.47"> </span>
<a href="#l27.48"></a><span id="l27.48">   *count = mailbox_count;</span>
<a href="#l27.49"></a><span id="l27.49">   *canEncrypt = false;</span>
<a href="#l27.50"></a><span id="l27.50">   rv = NS_OK;</span>
<a href="#l27.51"></a><span id="l27.51"> </span>
<a href="#l27.52"></a><span id="l27.52" class="difflineminus">-  if (mailbox_count)</span>
<a href="#l27.53"></a><span id="l27.53" class="difflineminus">-  {</span>
<a href="#l27.54"></a><span id="l27.54" class="difflineplus">+  if (mailbox_count) {</span>
<a href="#l27.55"></a><span id="l27.55">     nsCOMPtr&lt;nsIMsgComposeSecure&gt; composeSecure =</span>
<a href="#l27.56"></a><span id="l27.56" class="difflineminus">-      do_CreateInstance(NS_MSGCOMPOSESECURE_CONTRACTID, &amp;rv);</span>
<a href="#l27.57"></a><span id="l27.57" class="difflineplus">+        do_CreateInstance(NS_MSGCOMPOSESECURE_CONTRACTID, &amp;rv);</span>
<a href="#l27.58"></a><span id="l27.58">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.59"></a><span id="l27.59"> </span>
<a href="#l27.60"></a><span id="l27.60" class="difflineminus">-    char16_t **outEA = static_cast&lt;char16_t **&gt;(moz_xmalloc(mailbox_count * sizeof(char16_t *)));</span>
<a href="#l27.61"></a><span id="l27.61" class="difflineminus">-    int32_t *outCV = static_cast&lt;int32_t *&gt;(moz_xmalloc(mailbox_count * sizeof(int32_t)));</span>
<a href="#l27.62"></a><span id="l27.62" class="difflineminus">-    char16_t **outCII = static_cast&lt;char16_t **&gt;(moz_xmalloc(mailbox_count * sizeof(char16_t *)));</span>
<a href="#l27.63"></a><span id="l27.63" class="difflineminus">-    char16_t **outCEI = static_cast&lt;char16_t **&gt;(moz_xmalloc(mailbox_count * sizeof(char16_t *)));</span>
<a href="#l27.64"></a><span id="l27.64" class="difflineminus">-    nsIX509Cert **outCerts = static_cast&lt;nsIX509Cert **&gt;(moz_xmalloc(mailbox_count * sizeof(nsIX509Cert *)));</span>
<a href="#l27.65"></a><span id="l27.65" class="difflineplus">+    char16_t **outEA = static_cast&lt;char16_t **&gt;(</span>
<a href="#l27.66"></a><span id="l27.66" class="difflineplus">+        moz_xmalloc(mailbox_count * sizeof(char16_t *)));</span>
<a href="#l27.67"></a><span id="l27.67" class="difflineplus">+    int32_t *outCV =</span>
<a href="#l27.68"></a><span id="l27.68" class="difflineplus">+        static_cast&lt;int32_t *&gt;(moz_xmalloc(mailbox_count * sizeof(int32_t)));</span>
<a href="#l27.69"></a><span id="l27.69" class="difflineplus">+    char16_t **outCII = static_cast&lt;char16_t **&gt;(</span>
<a href="#l27.70"></a><span id="l27.70" class="difflineplus">+        moz_xmalloc(mailbox_count * sizeof(char16_t *)));</span>
<a href="#l27.71"></a><span id="l27.71" class="difflineplus">+    char16_t **outCEI = static_cast&lt;char16_t **&gt;(</span>
<a href="#l27.72"></a><span id="l27.72" class="difflineplus">+        moz_xmalloc(mailbox_count * sizeof(char16_t *)));</span>
<a href="#l27.73"></a><span id="l27.73" class="difflineplus">+    nsIX509Cert **outCerts = static_cast&lt;nsIX509Cert **&gt;(</span>
<a href="#l27.74"></a><span id="l27.74" class="difflineplus">+        moz_xmalloc(mailbox_count * sizeof(nsIX509Cert *)));</span>
<a href="#l27.75"></a><span id="l27.75"> </span>
<a href="#l27.76"></a><span id="l27.76" class="difflineminus">-    if (!outEA || !outCV || !outCII || !outCEI || !outCerts)</span>
<a href="#l27.77"></a><span id="l27.77" class="difflineminus">-    {</span>
<a href="#l27.78"></a><span id="l27.78" class="difflineplus">+    if (!outEA || !outCV || !outCII || !outCEI || !outCerts) {</span>
<a href="#l27.79"></a><span id="l27.79">       free(outEA);</span>
<a href="#l27.80"></a><span id="l27.80">       free(outCV);</span>
<a href="#l27.81"></a><span id="l27.81">       free(outCII);</span>
<a href="#l27.82"></a><span id="l27.82">       free(outCEI);</span>
<a href="#l27.83"></a><span id="l27.83">       free(outCerts);</span>
<a href="#l27.84"></a><span id="l27.84">       rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l27.85"></a><span id="l27.85" class="difflineminus">-    }</span>
<a href="#l27.86"></a><span id="l27.86" class="difflineminus">-    else</span>
<a href="#l27.87"></a><span id="l27.87" class="difflineminus">-    {</span>
<a href="#l27.88"></a><span id="l27.88" class="difflineplus">+    } else {</span>
<a href="#l27.89"></a><span id="l27.89">       char16_t **iEA = outEA;</span>
<a href="#l27.90"></a><span id="l27.90">       int32_t *iCV = outCV;</span>
<a href="#l27.91"></a><span id="l27.91">       char16_t **iCII = outCII;</span>
<a href="#l27.92"></a><span id="l27.92">       char16_t **iCEI = outCEI;</span>
<a href="#l27.93"></a><span id="l27.93">       nsIX509Cert **iCert = outCerts;</span>
<a href="#l27.94"></a><span id="l27.94"> </span>
<a href="#l27.95"></a><span id="l27.95">       bool found_blocker = false;</span>
<a href="#l27.96"></a><span id="l27.96">       bool memory_failure = false;</span>
<a href="#l27.97"></a><span id="l27.97"> </span>
<a href="#l27.98"></a><span id="l27.98" class="difflineminus">-      for (uint32_t i = 0;</span>
<a href="#l27.99"></a><span id="l27.99" class="difflineminus">-          i &lt; mailbox_count;</span>
<a href="#l27.100"></a><span id="l27.100" class="difflineminus">-          ++i, ++iEA, ++iCV, ++iCII, ++iCEI, ++iCert)</span>
<a href="#l27.101"></a><span id="l27.101" class="difflineminus">-      {</span>
<a href="#l27.102"></a><span id="l27.102" class="difflineplus">+      for (uint32_t i = 0; i &lt; mailbox_count;</span>
<a href="#l27.103"></a><span id="l27.103" class="difflineplus">+           ++i, ++iEA, ++iCV, ++iCII, ++iCEI, ++iCert) {</span>
<a href="#l27.104"></a><span id="l27.104">         *iCert = nullptr;</span>
<a href="#l27.105"></a><span id="l27.105">         *iCV = 0;</span>
<a href="#l27.106"></a><span id="l27.106">         *iCII = nullptr;</span>
<a href="#l27.107"></a><span id="l27.107">         *iCEI = nullptr;</span>
<a href="#l27.108"></a><span id="l27.108"> </span>
<a href="#l27.109"></a><span id="l27.109">         if (memory_failure) {</span>
<a href="#l27.110"></a><span id="l27.110">           *iEA = nullptr;</span>
<a href="#l27.111"></a><span id="l27.111">           continue;</span>
<a href="#l27.112"></a><span id="l27.112" class="difflineat">@@ -115,207 +104,178 @@ NS_IMETHODIMP nsSMimeJSHelper::GetRecipi</span>
<a href="#l27.113"></a><span id="l27.113">           continue;</span>
<a href="#l27.114"></a><span id="l27.114">         }</span>
<a href="#l27.115"></a><span id="l27.115"> </span>
<a href="#l27.116"></a><span id="l27.116">         nsCString email_lowercase;</span>
<a href="#l27.117"></a><span id="l27.117">         ToLowerCase(email, email_lowercase);</span>
<a href="#l27.118"></a><span id="l27.118"> </span>
<a href="#l27.119"></a><span id="l27.119">         nsCOMPtr&lt;nsIX509Cert&gt; cert;</span>
<a href="#l27.120"></a><span id="l27.120">         if (NS_SUCCEEDED(composeSecure-&gt;FindCertByEmailAddress(</span>
<a href="#l27.121"></a><span id="l27.121" class="difflineminus">-                         email_lowercase, false, getter_AddRefs(cert))))</span>
<a href="#l27.122"></a><span id="l27.122" class="difflineminus">-        {</span>
<a href="#l27.123"></a><span id="l27.123" class="difflineplus">+                email_lowercase, false, getter_AddRefs(cert)))) {</span>
<a href="#l27.124"></a><span id="l27.124">           cert.forget(iCert);</span>
<a href="#l27.125"></a><span id="l27.125"> </span>
<a href="#l27.126"></a><span id="l27.126">           nsCOMPtr&lt;nsIX509CertValidity&gt; validity;</span>
<a href="#l27.127"></a><span id="l27.127">           rv = (*iCert)-&gt;GetValidity(getter_AddRefs(validity));</span>
<a href="#l27.128"></a><span id="l27.128"> </span>
<a href="#l27.129"></a><span id="l27.129">           if (NS_SUCCEEDED(rv)) {</span>
<a href="#l27.130"></a><span id="l27.130">             nsString id, ed;</span>
<a href="#l27.131"></a><span id="l27.131"> </span>
<a href="#l27.132"></a><span id="l27.132" class="difflineminus">-            if (NS_SUCCEEDED(validity-&gt;GetNotBeforeLocalDay(id)))</span>
<a href="#l27.133"></a><span id="l27.133" class="difflineminus">-            {</span>
<a href="#l27.134"></a><span id="l27.134" class="difflineplus">+            if (NS_SUCCEEDED(validity-&gt;GetNotBeforeLocalDay(id))) {</span>
<a href="#l27.135"></a><span id="l27.135">               *iCII = ToNewUnicode(id);</span>
<a href="#l27.136"></a><span id="l27.136">               if (!*iCII) {</span>
<a href="#l27.137"></a><span id="l27.137">                 memory_failure = true;</span>
<a href="#l27.138"></a><span id="l27.138">                 continue;</span>
<a href="#l27.139"></a><span id="l27.139">               }</span>
<a href="#l27.140"></a><span id="l27.140">             }</span>
<a href="#l27.141"></a><span id="l27.141"> </span>
<a href="#l27.142"></a><span id="l27.142" class="difflineminus">-            if (NS_SUCCEEDED(validity-&gt;GetNotAfterLocalDay(ed)))</span>
<a href="#l27.143"></a><span id="l27.143" class="difflineminus">-            {</span>
<a href="#l27.144"></a><span id="l27.144" class="difflineplus">+            if (NS_SUCCEEDED(validity-&gt;GetNotAfterLocalDay(ed))) {</span>
<a href="#l27.145"></a><span id="l27.145">               *iCEI = ToNewUnicode(ed);</span>
<a href="#l27.146"></a><span id="l27.146">               if (!*iCEI) {</span>
<a href="#l27.147"></a><span id="l27.147">                 memory_failure = true;</span>
<a href="#l27.148"></a><span id="l27.148">                 continue;</span>
<a href="#l27.149"></a><span id="l27.149">               }</span>
<a href="#l27.150"></a><span id="l27.150">             }</span>
<a href="#l27.151"></a><span id="l27.151">           }</span>
<a href="#l27.152"></a><span id="l27.152" class="difflineminus">-        }</span>
<a href="#l27.153"></a><span id="l27.153" class="difflineminus">-        else</span>
<a href="#l27.154"></a><span id="l27.154" class="difflineminus">-        {</span>
<a href="#l27.155"></a><span id="l27.155" class="difflineplus">+        } else {</span>
<a href="#l27.156"></a><span id="l27.156">           found_blocker = true;</span>
<a href="#l27.157"></a><span id="l27.157">         }</span>
<a href="#l27.158"></a><span id="l27.158">       }</span>
<a href="#l27.159"></a><span id="l27.159"> </span>
<a href="#l27.160"></a><span id="l27.160">       if (memory_failure) {</span>
<a href="#l27.161"></a><span id="l27.161">         NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(mailbox_count, outEA);</span>
<a href="#l27.162"></a><span id="l27.162">         NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(mailbox_count, outCII);</span>
<a href="#l27.163"></a><span id="l27.163">         NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(mailbox_count, outCEI);</span>
<a href="#l27.164"></a><span id="l27.164">         NS_FREE_XPCOM_ISUPPORTS_POINTER_ARRAY(mailbox_count, outCerts);</span>
<a href="#l27.165"></a><span id="l27.165">         free(outCV);</span>
<a href="#l27.166"></a><span id="l27.166">         rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l27.167"></a><span id="l27.167" class="difflineminus">-      }</span>
<a href="#l27.168"></a><span id="l27.168" class="difflineminus">-      else {</span>
<a href="#l27.169"></a><span id="l27.169" class="difflineminus">-        if (mailbox_count &gt; 0 &amp;&amp; !found_blocker)</span>
<a href="#l27.170"></a><span id="l27.170" class="difflineminus">-        {</span>
<a href="#l27.171"></a><span id="l27.171" class="difflineplus">+      } else {</span>
<a href="#l27.172"></a><span id="l27.172" class="difflineplus">+        if (mailbox_count &gt; 0 &amp;&amp; !found_blocker) {</span>
<a href="#l27.173"></a><span id="l27.173">           *canEncrypt = true;</span>
<a href="#l27.174"></a><span id="l27.174">         }</span>
<a href="#l27.175"></a><span id="l27.175"> </span>
<a href="#l27.176"></a><span id="l27.176">         *emailAddresses = outEA;</span>
<a href="#l27.177"></a><span id="l27.177">         *certVerification = outCV;</span>
<a href="#l27.178"></a><span id="l27.178">         *certIssuedInfos = outCII;</span>
<a href="#l27.179"></a><span id="l27.179">         *certExpiresInfos = outCEI;</span>
<a href="#l27.180"></a><span id="l27.180">         *certs = outCerts;</span>
<a href="#l27.181"></a><span id="l27.181">       }</span>
<a href="#l27.182"></a><span id="l27.182">     }</span>
<a href="#l27.183"></a><span id="l27.183">   }</span>
<a href="#l27.184"></a><span id="l27.184">   return rv;</span>
<a href="#l27.185"></a><span id="l27.185"> }</span>
<a href="#l27.186"></a><span id="l27.186"> </span>
<a href="#l27.187"></a><span id="l27.187" class="difflineminus">-NS_IMETHODIMP nsSMimeJSHelper::GetNoCertAddresses(</span>
<a href="#l27.188"></a><span id="l27.188" class="difflineminus">-    nsIMsgCompFields *compFields,</span>
<a href="#l27.189"></a><span id="l27.189" class="difflineminus">-    uint32_t *count,</span>
<a href="#l27.190"></a><span id="l27.190" class="difflineminus">-    char16_t ***emailAddresses)</span>
<a href="#l27.191"></a><span id="l27.191" class="difflineminus">-{</span>
<a href="#l27.192"></a><span id="l27.192" class="difflineplus">+NS_IMETHODIMP nsSMimeJSHelper::GetNoCertAddresses(nsIMsgCompFields *compFields,</span>
<a href="#l27.193"></a><span id="l27.193" class="difflineplus">+                                                  uint32_t *count,</span>
<a href="#l27.194"></a><span id="l27.194" class="difflineplus">+                                                  char16_t ***emailAddresses) {</span>
<a href="#l27.195"></a><span id="l27.195">   NS_ENSURE_ARG_POINTER(count);</span>
<a href="#l27.196"></a><span id="l27.196">   *count = 0;</span>
<a href="#l27.197"></a><span id="l27.197"> </span>
<a href="#l27.198"></a><span id="l27.198">   NS_ENSURE_ARG_POINTER(emailAddresses);</span>
<a href="#l27.199"></a><span id="l27.199"> </span>
<a href="#l27.200"></a><span id="l27.200">   NS_ENSURE_ARG_POINTER(compFields);</span>
<a href="#l27.201"></a><span id="l27.201"> </span>
<a href="#l27.202"></a><span id="l27.202">   nsTArray&lt;nsCString&gt; mailboxes;</span>
<a href="#l27.203"></a><span id="l27.203">   nsresult rv = getMailboxList(compFields, mailboxes);</span>
<a href="#l27.204"></a><span id="l27.204">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.205"></a><span id="l27.205"> </span>
<a href="#l27.206"></a><span id="l27.206">   uint32_t mailbox_count = mailboxes.Length();</span>
<a href="#l27.207"></a><span id="l27.207"> </span>
<a href="#l27.208"></a><span id="l27.208" class="difflineminus">-  if (!mailbox_count)</span>
<a href="#l27.209"></a><span id="l27.209" class="difflineminus">-  {</span>
<a href="#l27.210"></a><span id="l27.210" class="difflineplus">+  if (!mailbox_count) {</span>
<a href="#l27.211"></a><span id="l27.211">     *count = 0;</span>
<a href="#l27.212"></a><span id="l27.212">     *emailAddresses = nullptr;</span>
<a href="#l27.213"></a><span id="l27.213">     return NS_OK;</span>
<a href="#l27.214"></a><span id="l27.214">   }</span>
<a href="#l27.215"></a><span id="l27.215"> </span>
<a href="#l27.216"></a><span id="l27.216">   nsCOMPtr&lt;nsIMsgComposeSecure&gt; composeSecure =</span>
<a href="#l27.217"></a><span id="l27.217" class="difflineminus">-    do_CreateInstance(NS_MSGCOMPOSESECURE_CONTRACTID, &amp;rv);</span>
<a href="#l27.218"></a><span id="l27.218" class="difflineplus">+      do_CreateInstance(NS_MSGCOMPOSESECURE_CONTRACTID, &amp;rv);</span>
<a href="#l27.219"></a><span id="l27.219">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.220"></a><span id="l27.220"> </span>
<a href="#l27.221"></a><span id="l27.221">   uint32_t missing_count = 0;</span>
<a href="#l27.222"></a><span id="l27.222">   bool *haveCert = new bool[mailbox_count];</span>
<a href="#l27.223"></a><span id="l27.223" class="difflineminus">-  if (!haveCert)</span>
<a href="#l27.224"></a><span id="l27.224" class="difflineminus">-  {</span>
<a href="#l27.225"></a><span id="l27.225" class="difflineplus">+  if (!haveCert) {</span>
<a href="#l27.226"></a><span id="l27.226">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l27.227"></a><span id="l27.227">   }</span>
<a href="#l27.228"></a><span id="l27.228"> </span>
<a href="#l27.229"></a><span id="l27.229">   rv = NS_OK;</span>
<a href="#l27.230"></a><span id="l27.230"> </span>
<a href="#l27.231"></a><span id="l27.231" class="difflineminus">-  if (mailbox_count)</span>
<a href="#l27.232"></a><span id="l27.232" class="difflineminus">-  {</span>
<a href="#l27.233"></a><span id="l27.233" class="difflineminus">-    for (uint32_t i = 0; i &lt; mailbox_count; ++i)</span>
<a href="#l27.234"></a><span id="l27.234" class="difflineminus">-    {</span>
<a href="#l27.235"></a><span id="l27.235" class="difflineplus">+  if (mailbox_count) {</span>
<a href="#l27.236"></a><span id="l27.236" class="difflineplus">+    for (uint32_t i = 0; i &lt; mailbox_count; ++i) {</span>
<a href="#l27.237"></a><span id="l27.237">       haveCert[i] = false;</span>
<a href="#l27.238"></a><span id="l27.238"> </span>
<a href="#l27.239"></a><span id="l27.239">       nsCString email_lowercase;</span>
<a href="#l27.240"></a><span id="l27.240">       ToLowerCase(mailboxes[i], email_lowercase);</span>
<a href="#l27.241"></a><span id="l27.241"> </span>
<a href="#l27.242"></a><span id="l27.242">       nsCOMPtr&lt;nsIX509Cert&gt; cert;</span>
<a href="#l27.243"></a><span id="l27.243">       if (NS_SUCCEEDED(composeSecure-&gt;FindCertByEmailAddress(</span>
<a href="#l27.244"></a><span id="l27.244" class="difflineminus">-                       email_lowercase, true, getter_AddRefs(cert))))</span>
<a href="#l27.245"></a><span id="l27.245" class="difflineplus">+              email_lowercase, true, getter_AddRefs(cert))))</span>
<a href="#l27.246"></a><span id="l27.246">         haveCert[i] = true;</span>
<a href="#l27.247"></a><span id="l27.247"> </span>
<a href="#l27.248"></a><span id="l27.248" class="difflineminus">-      if (!haveCert[i])</span>
<a href="#l27.249"></a><span id="l27.249" class="difflineminus">-        ++missing_count;</span>
<a href="#l27.250"></a><span id="l27.250" class="difflineplus">+      if (!haveCert[i]) ++missing_count;</span>
<a href="#l27.251"></a><span id="l27.251">     }</span>
<a href="#l27.252"></a><span id="l27.252">   }</span>
<a href="#l27.253"></a><span id="l27.253"> </span>
<a href="#l27.254"></a><span id="l27.254">   *count = missing_count;</span>
<a href="#l27.255"></a><span id="l27.255"> </span>
<a href="#l27.256"></a><span id="l27.256" class="difflineminus">-  if (missing_count)</span>
<a href="#l27.257"></a><span id="l27.257" class="difflineminus">-  {</span>
<a href="#l27.258"></a><span id="l27.258" class="difflineminus">-    char16_t **outEA = static_cast&lt;char16_t **&gt;(moz_xmalloc(missing_count * sizeof(char16_t *)));</span>
<a href="#l27.259"></a><span id="l27.259" class="difflineminus">-    if (!outEA )</span>
<a href="#l27.260"></a><span id="l27.260" class="difflineminus">-    {</span>
<a href="#l27.261"></a><span id="l27.261" class="difflineplus">+  if (missing_count) {</span>
<a href="#l27.262"></a><span id="l27.262" class="difflineplus">+    char16_t **outEA = static_cast&lt;char16_t **&gt;(</span>
<a href="#l27.263"></a><span id="l27.263" class="difflineplus">+        moz_xmalloc(missing_count * sizeof(char16_t *)));</span>
<a href="#l27.264"></a><span id="l27.264" class="difflineplus">+    if (!outEA) {</span>
<a href="#l27.265"></a><span id="l27.265">       rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l27.266"></a><span id="l27.266" class="difflineminus">-    }</span>
<a href="#l27.267"></a><span id="l27.267" class="difflineminus">-    else</span>
<a href="#l27.268"></a><span id="l27.268" class="difflineminus">-    {</span>
<a href="#l27.269"></a><span id="l27.269" class="difflineplus">+    } else {</span>
<a href="#l27.270"></a><span id="l27.270">       char16_t **iEA = outEA;</span>
<a href="#l27.271"></a><span id="l27.271"> </span>
<a href="#l27.272"></a><span id="l27.272">       bool memory_failure = false;</span>
<a href="#l27.273"></a><span id="l27.273"> </span>
<a href="#l27.274"></a><span id="l27.274" class="difflineminus">-      for (uint32_t i = 0; i &lt; mailbox_count; ++i)</span>
<a href="#l27.275"></a><span id="l27.275" class="difflineminus">-      {</span>
<a href="#l27.276"></a><span id="l27.276" class="difflineminus">-        if (!haveCert[i])</span>
<a href="#l27.277"></a><span id="l27.277" class="difflineminus">-        {</span>
<a href="#l27.278"></a><span id="l27.278" class="difflineplus">+      for (uint32_t i = 0; i &lt; mailbox_count; ++i) {</span>
<a href="#l27.279"></a><span id="l27.279" class="difflineplus">+        if (!haveCert[i]) {</span>
<a href="#l27.280"></a><span id="l27.280">           if (memory_failure) {</span>
<a href="#l27.281"></a><span id="l27.281">             *iEA = nullptr;</span>
<a href="#l27.282"></a><span id="l27.282" class="difflineminus">-          }</span>
<a href="#l27.283"></a><span id="l27.283" class="difflineminus">-          else {</span>
<a href="#l27.284"></a><span id="l27.284" class="difflineplus">+          } else {</span>
<a href="#l27.285"></a><span id="l27.285">             *iEA = ToNewUnicode(NS_ConvertUTF8toUTF16(mailboxes[i]));</span>
<a href="#l27.286"></a><span id="l27.286">             if (!*iEA) {</span>
<a href="#l27.287"></a><span id="l27.287">               memory_failure = true;</span>
<a href="#l27.288"></a><span id="l27.288">             }</span>
<a href="#l27.289"></a><span id="l27.289">           }</span>
<a href="#l27.290"></a><span id="l27.290">           ++iEA;</span>
<a href="#l27.291"></a><span id="l27.291">         }</span>
<a href="#l27.292"></a><span id="l27.292">       }</span>
<a href="#l27.293"></a><span id="l27.293"> </span>
<a href="#l27.294"></a><span id="l27.294">       if (memory_failure) {</span>
<a href="#l27.295"></a><span id="l27.295">         NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(missing_count, outEA);</span>
<a href="#l27.296"></a><span id="l27.296">         rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l27.297"></a><span id="l27.297" class="difflineminus">-      }</span>
<a href="#l27.298"></a><span id="l27.298" class="difflineminus">-      else {</span>
<a href="#l27.299"></a><span id="l27.299" class="difflineplus">+      } else {</span>
<a href="#l27.300"></a><span id="l27.300">         *emailAddresses = outEA;</span>
<a href="#l27.301"></a><span id="l27.301">       }</span>
<a href="#l27.302"></a><span id="l27.302">     }</span>
<a href="#l27.303"></a><span id="l27.303" class="difflineminus">-  }</span>
<a href="#l27.304"></a><span id="l27.304" class="difflineminus">-  else</span>
<a href="#l27.305"></a><span id="l27.305" class="difflineminus">-  {</span>
<a href="#l27.306"></a><span id="l27.306" class="difflineplus">+  } else {</span>
<a href="#l27.307"></a><span id="l27.307">     *emailAddresses = nullptr;</span>
<a href="#l27.308"></a><span id="l27.308">   }</span>
<a href="#l27.309"></a><span id="l27.309"> </span>
<a href="#l27.310"></a><span id="l27.310" class="difflineminus">-  delete [] haveCert;</span>
<a href="#l27.311"></a><span id="l27.311" class="difflineplus">+  delete[] haveCert;</span>
<a href="#l27.312"></a><span id="l27.312">   return rv;</span>
<a href="#l27.313"></a><span id="l27.313"> }</span>
<a href="#l27.314"></a><span id="l27.314"> </span>
<a href="#l27.315"></a><span id="l27.315"> nsresult nsSMimeJSHelper::getMailboxList(nsIMsgCompFields *compFields,</span>
<a href="#l27.316"></a><span id="l27.316" class="difflineminus">-    nsTArray&lt;nsCString&gt; &amp;mailboxes)</span>
<a href="#l27.317"></a><span id="l27.317" class="difflineminus">-{</span>
<a href="#l27.318"></a><span id="l27.318" class="difflineminus">-  if (!compFields)</span>
<a href="#l27.319"></a><span id="l27.319" class="difflineminus">-    return NS_ERROR_INVALID_ARG;</span>
<a href="#l27.320"></a><span id="l27.320" class="difflineplus">+                                         nsTArray&lt;nsCString&gt; &amp;mailboxes) {</span>
<a href="#l27.321"></a><span id="l27.321" class="difflineplus">+  if (!compFields) return NS_ERROR_INVALID_ARG;</span>
<a href="#l27.322"></a><span id="l27.322"> </span>
<a href="#l27.323"></a><span id="l27.323">   nsresult res;</span>
<a href="#l27.324"></a><span id="l27.324">   nsString to, cc, bcc, ng;</span>
<a href="#l27.325"></a><span id="l27.325"> </span>
<a href="#l27.326"></a><span id="l27.326">   res = compFields-&gt;GetTo(to);</span>
<a href="#l27.327"></a><span id="l27.327" class="difflineminus">-  if (NS_FAILED(res))</span>
<a href="#l27.328"></a><span id="l27.328" class="difflineminus">-    return res;</span>
<a href="#l27.329"></a><span id="l27.329" class="difflineplus">+  if (NS_FAILED(res)) return res;</span>
<a href="#l27.330"></a><span id="l27.330"> </span>
<a href="#l27.331"></a><span id="l27.331">   res = compFields-&gt;GetCc(cc);</span>
<a href="#l27.332"></a><span id="l27.332" class="difflineminus">-  if (NS_FAILED(res))</span>
<a href="#l27.333"></a><span id="l27.333" class="difflineminus">-    return res;</span>
<a href="#l27.334"></a><span id="l27.334" class="difflineplus">+  if (NS_FAILED(res)) return res;</span>
<a href="#l27.335"></a><span id="l27.335"> </span>
<a href="#l27.336"></a><span id="l27.336">   res = compFields-&gt;GetBcc(bcc);</span>
<a href="#l27.337"></a><span id="l27.337" class="difflineminus">-  if (NS_FAILED(res))</span>
<a href="#l27.338"></a><span id="l27.338" class="difflineminus">-    return res;</span>
<a href="#l27.339"></a><span id="l27.339" class="difflineplus">+  if (NS_FAILED(res)) return res;</span>
<a href="#l27.340"></a><span id="l27.340"> </span>
<a href="#l27.341"></a><span id="l27.341">   res = compFields-&gt;GetNewsgroups(ng);</span>
<a href="#l27.342"></a><span id="l27.342" class="difflineminus">-  if (NS_FAILED(res))</span>
<a href="#l27.343"></a><span id="l27.343" class="difflineminus">-    return res;</span>
<a href="#l27.344"></a><span id="l27.344" class="difflineplus">+  if (NS_FAILED(res)) return res;</span>
<a href="#l27.345"></a><span id="l27.345"> </span>
<a href="#l27.346"></a><span id="l27.346">   {</span>
<a href="#l27.347"></a><span id="l27.347">     nsCString all_recipients;</span>
<a href="#l27.348"></a><span id="l27.348"> </span>
<a href="#l27.349"></a><span id="l27.349">     if (!to.IsEmpty()) {</span>
<a href="#l27.350"></a><span id="l27.350">       all_recipients.Append(NS_ConvertUTF16toUTF8(to));</span>
<a href="#l27.351"></a><span id="l27.351">       all_recipients.Append(',');</span>
<a href="#l27.352"></a><span id="l27.352">     }</span>
<a href="#l27.353"></a><span id="l27.353" class="difflineat">@@ -325,17 +285,16 @@ nsresult nsSMimeJSHelper::getMailboxList</span>
<a href="#l27.354"></a><span id="l27.354">       all_recipients.Append(',');</span>
<a href="#l27.355"></a><span id="l27.355">     }</span>
<a href="#l27.356"></a><span id="l27.356"> </span>
<a href="#l27.357"></a><span id="l27.357">     if (!bcc.IsEmpty()) {</span>
<a href="#l27.358"></a><span id="l27.358">       all_recipients.Append(NS_ConvertUTF16toUTF8(bcc));</span>
<a href="#l27.359"></a><span id="l27.359">       all_recipients.Append(',');</span>
<a href="#l27.360"></a><span id="l27.360">     }</span>
<a href="#l27.361"></a><span id="l27.361"> </span>
<a href="#l27.362"></a><span id="l27.362" class="difflineminus">-    if (!ng.IsEmpty())</span>
<a href="#l27.363"></a><span id="l27.363" class="difflineminus">-      all_recipients.Append(NS_ConvertUTF16toUTF8(ng));</span>
<a href="#l27.364"></a><span id="l27.364" class="difflineplus">+    if (!ng.IsEmpty()) all_recipients.Append(NS_ConvertUTF16toUTF8(ng));</span>
<a href="#l27.365"></a><span id="l27.365"> </span>
<a href="#l27.366"></a><span id="l27.366">     ExtractEmails(EncodedHeader(all_recipients),</span>
<a href="#l27.367"></a><span id="l27.367" class="difflineminus">-      UTF16ArrayAdapter&lt;&gt;(mailboxes));</span>
<a href="#l27.368"></a><span id="l27.368" class="difflineplus">+                  UTF16ArrayAdapter&lt;&gt;(mailboxes));</span>
<a href="#l27.369"></a><span id="l27.369">   }</span>
<a href="#l27.370"></a><span id="l27.370"> </span>
<a href="#l27.371"></a><span id="l27.371">   return NS_OK;</span>
<a href="#l27.372"></a><span id="l27.372"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/extensions/smime/src/nsSMimeJSHelper.h</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/extensions/smime/src/nsSMimeJSHelper.h</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -3,23 +3,22 @@</span>
<a href="#l28.4"></a><span id="l28.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l28.5"></a><span id="l28.5"> </span>
<a href="#l28.6"></a><span id="l28.6"> #ifndef _nsSMimeJSHelper_H_</span>
<a href="#l28.7"></a><span id="l28.7"> #define _nsSMimeJSHelper_H_</span>
<a href="#l28.8"></a><span id="l28.8"> </span>
<a href="#l28.9"></a><span id="l28.9"> #include &quot;nsISMimeJSHelper.h&quot;</span>
<a href="#l28.10"></a><span id="l28.10"> #include &quot;nsIMsgCompFields.h&quot;</span>
<a href="#l28.11"></a><span id="l28.11"> </span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-class nsSMimeJSHelper : public nsISMimeJSHelper</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineminus">-{</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineminus">-public:</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineplus">+class nsSMimeJSHelper : public nsISMimeJSHelper {</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineplus">+ public:</span>
<a href="#l28.17"></a><span id="l28.17">   NS_DECL_ISUPPORTS</span>
<a href="#l28.18"></a><span id="l28.18">   NS_DECL_NSISMIMEJSHELPER</span>
<a href="#l28.19"></a><span id="l28.19"> </span>
<a href="#l28.20"></a><span id="l28.20">   nsSMimeJSHelper();</span>
<a href="#l28.21"></a><span id="l28.21"> </span>
<a href="#l28.22"></a><span id="l28.22" class="difflineminus">-private:</span>
<a href="#l28.23"></a><span id="l28.23" class="difflineplus">+ private:</span>
<a href="#l28.24"></a><span id="l28.24">   virtual ~nsSMimeJSHelper();</span>
<a href="#l28.25"></a><span id="l28.25">   nsresult getMailboxList(nsIMsgCompFields *compFields,</span>
<a href="#l28.26"></a><span id="l28.26" class="difflineminus">-    nsTArray&lt;nsCString&gt; &amp;mailboxes);</span>
<a href="#l28.27"></a><span id="l28.27" class="difflineplus">+                          nsTArray&lt;nsCString&gt; &amp;mailboxes);</span>
<a href="#l28.28"></a><span id="l28.28"> };</span>
<a href="#l28.29"></a><span id="l28.29"> </span>
<a href="#l28.30"></a><span id="l28.30"> #endif</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

